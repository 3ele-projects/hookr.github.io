<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.6.1" data-type="file" data-id="4824"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-includes-user | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.6.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.9"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=591451bf4a2733a41861b93d34b496d3' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.9' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-includes-user/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-user%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-user%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.6.1-file-wp-includes-user","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-includes-user" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.6.1." href="http://hookr.io/4.6.1/" class="H_VERSION"><span property="name">4.6.1</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-includes-user</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6118"><a href="http://hookr.io/4.6.1/all/" title="All">All <span class="count badge">6118</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/4.6.1/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2420"><a href="http://hookr.io/4.6.1/hooks/" title="Hooks">Hooks <span class="count badge">2420</span></a></li><li class="" data-id="action" data-count="835"><a href="http://hookr.io/4.6.1/actions/" title="Actions">Actions <span class="count badge">835</span></a></li><li class="" data-id="filter" data-count="1585"><a href="http://hookr.io/4.6.1/filters/" title="Filters">Filters <span class="count badge">1585</span></a></li><li class="" data-id="class" data-count="329"><a href="http://hookr.io/4.6.1/classes/" title="Classes">Classes <span class="count badge">329</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.6.1/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2795"><a href="http://hookr.io/4.6.1/functions/" title="Functions">Functions <span class="count badge">2795</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.6.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-includes/user.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Core User API</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Users</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Authenticates and logs a user in with 'remember' capability.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The credentials is an array that has 'user_login', 'user_password', and</span>&nbsp;</div></li><li><div><span class="comment"> * 'remember' indices. If the credentials is not given, then the log in form</span>&nbsp;</div></li><li><div><span class="comment"> * will be assumed and used if set.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The various authentication cookies will be set by this function and will be</span>&nbsp;</div></li><li><div><span class="comment"> * set for a longer period depending on if the 'remember' credential is set to</span>&nbsp;</div></li><li><div><span class="comment"> * true.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $auth_secure_cookie</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array       $credentials   Optional. User info in order to sign on.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|bool $secure_cookie Optional. Whether to use secure cookie.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error WP_User on success, WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_signon( $credentials = array(), $secure_cookie = '' ) {&nbsp;</div></li><li><div>  if ( empty($credentials) ) {&nbsp;</div></li><li><div>      $credentials = array(); <span class="comment">// Back-compat for plugins passing an empty string.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty($_POST['log']) )&nbsp;</div></li><li><div>          $credentials['user_login'] = $_POST['log'];&nbsp;</div></li><li><div>      if ( ! empty($_POST['pwd']) )&nbsp;</div></li><li><div>          $credentials['user_password'] = $_POST['pwd'];&nbsp;</div></li><li><div>      if ( ! empty($_POST['rememberme']) )&nbsp;</div></li><li><div>          $credentials['remember'] = $_POST['rememberme'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($credentials['remember']) )&nbsp;</div></li><li><div>      $credentials['remember'] = true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $credentials['remember'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before the user is authenticated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The variables passed to the callbacks are passed by reference, </span>&nbsp;</div></li><li><div><span class="comment">   * and can be modified by callback functions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo Decide whether to deprecate the wp_authenticate action.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_login    Username, passed by reference.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_password User password, passed by reference.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action_ref_array( 'wp_authenticate', array( &$credentials['user_login'], &$credentials['user_password'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( '' === $secure_cookie )&nbsp;</div></li><li><div>      $secure_cookie = is_ssl();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to use a secure sign-on cookie.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool  $secure_cookie Whether to use a secure sign-on cookie.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $credentials {</span>&nbsp;</div></li><li><div><span class="comment">    *     Array of entered sign-on data.</span>&nbsp;</div></li><li><div><span class="comment">    *</span>&nbsp;</div></li><li><div><span class="comment">    *     @type string $user_login    Username.</span>&nbsp;</div></li><li><div><span class="comment">    *     @type string $user_password Password entered.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool   $remember      Whether to 'remember' the user. Increases the time</span>&nbsp;</div></li><li><div><span class="comment">   *                                 that the cookie will be kept. Default false.</span>&nbsp;</div></li><li><div><span class="comment">    * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $secure_cookie = apply_filters( 'secure_signon_cookie', $secure_cookie, $credentials );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $auth_secure_cookie; <span class="comment">// XXX ugly hack to pass this to wp_authenticate_cookie</span>&nbsp;</div></li><li><div>  $auth_secure_cookie = $secure_cookie;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter('authenticate', 'wp_authenticate_cookie', 30, 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = wp_authenticate($credentials['user_login'], $credentials['user_password']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error($user) ) {&nbsp;</div></li><li><div>      if ( $user-&gt;get_error_codes() == array('empty_username', 'empty_password') ) {&nbsp;</div></li><li><div>          $user = new WP_Error('', '');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_auth_cookie($user-&gt;ID, $credentials['remember'], $secure_cookie);&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the user has successfully logged in.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $user_login Username.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User $user       WP_User object of the logged-in user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wp_login', $user-&gt;user_login, $user );&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Authenticate a user, confirming the username and password are valid.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|WP_Error|null $user     WP_User or WP_Error object from a previous callback. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $username Username for authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $password Password for authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error WP_User on success, WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_authenticate_username_password($user, $username, $password) {&nbsp;</div></li><li><div>  if ( $user instanceof WP_User ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($username) || empty($password) ) {&nbsp;</div></li><li><div>      if ( is_wp_error( $user ) )&nbsp;</div></li><li><div>          return $user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty($username) )&nbsp;</div></li><li><div>          $error-&gt;add('empty_username', __('&lt;strong&gt;ERROR&lt;/strong&gt;: The username field is empty.'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty($password) )&nbsp;</div></li><li><div>          $error-&gt;add('empty_password', __('&lt;strong&gt;ERROR&lt;/strong&gt;: The password field is empty.'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_user_by('login', $username);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$user ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_username', &nbsp;</div></li><li><div>          __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Invalid username.' ) .&nbsp;</div></li><li><div>          ' &lt;a href=&quot;' . wp_lostpassword_url() . '&quot;&gt;' .&nbsp;</div></li><li><div>          __( 'Lost your password?' ) .&nbsp;</div></li><li><div>          '&lt;/a&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether the given user can be authenticated with the provided $password.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User|WP_Error $user     WP_User or WP_Error object if a previous</span>&nbsp;</div></li><li><div><span class="comment">   *                                   callback failed authentication.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string           $password Password to check against the user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user = apply_filters( 'wp_authenticate_user', $user, $password );&nbsp;</div></li><li><div>  if ( is_wp_error($user) )&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_check_password( $password, $user-&gt;user_pass, $user-&gt;ID ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'incorrect_password', &nbsp;</div></li><li><div>          sprintf(&nbsp;</div></li><li><div>              <span class="comment">/** translators: %s: user name */</span>&nbsp;</div></li><li><div>              __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The password you entered for the username %s is incorrect.' ), &nbsp;</div></li><li><div>              '&lt;strong&gt;' . $username . '&lt;/strong&gt;'&nbsp;</div></li><li><div> ) .&nbsp;</div></li><li><div>          ' &lt;a href=&quot;' . wp_lostpassword_url() . '&quot;&gt;' .&nbsp;</div></li><li><div>          __( 'Lost your password?' ) .&nbsp;</div></li><li><div>          '&lt;/a&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Authenticates a user using the email and password.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|WP_Error|null $user     WP_User or WP_Error object if a previous</span>&nbsp;</div></li><li><div><span class="comment"> *                                        callback failed authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $email    Email address for authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $password Password for authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error WP_User on success, WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_authenticate_email_password( $user, $email, $password ) {&nbsp;</div></li><li><div>  if ( $user instanceof WP_User ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $email ) || empty( $password ) ) {&nbsp;</div></li><li><div>      if ( is_wp_error( $user ) ) {&nbsp;</div></li><li><div>          return $user;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $email ) ) {&nbsp;</div></li><li><div>          $error-&gt;add( 'empty_username', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The email field is empty.' ) ); <span class="comment">// Uses 'empty_username' for back-compat with wp_signon()</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $password ) ) {&nbsp;</div></li><li><div>          $error-&gt;add( 'empty_password', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The password field is empty.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $error;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_email( $email ) ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_user_by( 'email', $email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_email', &nbsp;</div></li><li><div>          __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Invalid email address.' ) .&nbsp;</div></li><li><div>          ' &lt;a href=&quot;' . wp_lostpassword_url() . '&quot;&gt;' .&nbsp;</div></li><li><div>          __( 'Lost your password?' ) .&nbsp;</div></li><li><div>          '&lt;/a&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in wp-includes/user.php */</span></span>&nbsp;</div></li><li><div>  $user = apply_filters( 'wp_authenticate_user', $user, $password );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $user ) ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_check_password( $password, $user-&gt;user_pass, $user-&gt;ID ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'incorrect_password', &nbsp;</div></li><li><div>          sprintf(&nbsp;</div></li><li><div>              <span class="comment">/** translators: %s: email address */</span>&nbsp;</div></li><li><div>              __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The password you entered for the email address %s is incorrect.' ), &nbsp;</div></li><li><div>              '&lt;strong&gt;' . $email . '&lt;/strong&gt;'&nbsp;</div></li><li><div> ) .&nbsp;</div></li><li><div>          ' &lt;a href=&quot;' . wp_lostpassword_url() . '&quot;&gt;' .&nbsp;</div></li><li><div>          __( 'Lost your password?' ) .&nbsp;</div></li><li><div>          '&lt;/a&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Authenticate the user using the WordPress auth cookie.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $auth_secure_cookie</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|WP_Error|null $user     WP_User or WP_Error object from a previous callback. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $username Username. If not empty, cancels the cookie authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string                $password Password. If not empty, cancels the cookie authentication.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error WP_User on success, WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_authenticate_cookie($user, $username, $password) {&nbsp;</div></li><li><div>  if ( $user instanceof WP_User ) {&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($username) && empty($password) ) {&nbsp;</div></li><li><div>      $user_id = wp_validate_auth_cookie();&nbsp;</div></li><li><div>      if ( $user_id )&nbsp;</div></li><li><div>          return new WP_User($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $auth_secure_cookie;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $auth_secure_cookie )&nbsp;</div></li><li><div>          $auth_cookie = SECURE_AUTH_COOKIE;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $auth_cookie = AUTH_COOKIE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty($_COOKIE[$auth_cookie]) )&nbsp;</div></li><li><div>          return new WP_Error('expired_session', __('Please log in again.'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the cookie is not set, be silent.</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * For Multisite blogs, check if the authenticated user has been marked as a</span>&nbsp;</div></li><li><div><span class="comment"> * spammer, or if the user's primary blog has been marked as spam.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|WP_Error|null $user WP_User or WP_Error object from a previous callback. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error WP_User on success, WP_Error if the user is considered a spammer.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_authenticate_spam_check( $user ) {&nbsp;</div></li><li><div>  if ( $user instanceof WP_User && is_multisite() ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters whether the user has been marked as a spammer.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool    $spammed Whether the user is considered a spammer.</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_User $user    User to check against.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $spammed = apply_filters( 'check_is_user_spammed', is_user_spammy( $user ), $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $spammed )&nbsp;</div></li><li><div>          return new WP_Error( 'spammer_account', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Your account has been marked as a spammer.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validates the logged-in cookie.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks the logged-in cookie if the previous auth cookie could not be</span>&nbsp;</div></li><li><div><span class="comment"> * validated and parsed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is a callback for the {@see 'determine_current_user'} filter, rather than API.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|bool $user_id The user ID (or false) as received from the</span>&nbsp;</div></li><li><div><span class="comment"> *                       determine_current_user filter.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false User ID if validated, false otherwise. If a user ID from</span>&nbsp;</div></li><li><div><span class="comment"> *                   an earlier filter callback is received, that value is returned.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_validate_logged_in_cookie( $user_id ) {&nbsp;</div></li><li><div>  if ( $user_id ) {&nbsp;</div></li><li><div>      return $user_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_blog_admin() || is_network_admin() || empty( $_COOKIE[LOGGED_IN_COOKIE] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return wp_validate_auth_cookie( $_COOKIE[LOGGED_IN_COOKIE], 'logged_in' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Number of posts user has written.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.1.0 Added `$post_type` argument.</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.0 Added `$public_only` argument. Added the ability to pass an array</span>&nbsp;</div></li><li><div><span class="comment"> *              of post types to `$post_type`.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int          $userid      User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $post_type   Optional. Single post type or array of post types to count the number of posts for. Default 'post'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool         $public_only Optional. Whether to only return counts for public posts. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Number of posts the user has written in this post type.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function count_user_posts( $userid, $post_type = 'post', $public_only = false ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $where = get_posts_by_author_sql( $post_type, true, $userid, $public_only );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = $wpdb-&gt;get_var( &quot;SELECT COUNT(*) FROM $wpdb-&gt;posts $where&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the number of posts a user has written.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.1.0 Added `$post_type` argument.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.3.1 Added `$public_only` argument.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int          $count       The user's post count.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int          $userid      User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $post_type   Single post type or array of post types to count the number of posts for.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool         $public_only Whether to limit counted posts to public posts.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'get_usernumposts', $count, $userid, $post_type, $public_only );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Number of posts written by a list of users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array        $users       Array of user IDs.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $post_type   Optional. Single post type or array of post types to check. Defaults to 'post'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool         $public_only Optional. Only return counts for public posts.  Defaults to false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Amount of posts each user has written.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function count_many_users_posts( $users, $post_type = 'post', $public_only = false ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = array();&nbsp;</div></li><li><div>  if ( empty( $users ) || ! is_array( $users ) )&nbsp;</div></li><li><div>      return $count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $userlist = implode( ', ', array_map( 'absint', $users ) );&nbsp;</div></li><li><div>  $where = get_posts_by_author_sql( $post_type, true, null, $public_only );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = $wpdb-&gt;get_results( &quot;SELECT post_author, COUNT(*) FROM $wpdb-&gt;posts $where AND post_author IN ($userlist) GROUP BY post_author&quot;, ARRAY_N );&nbsp;</div></li><li><div>  foreach ( $result as $row ) {&nbsp;</div></li><li><div>      $count[ $row[0] ] = $row[1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $users as $id ) {&nbsp;</div></li><li><div>      if ( ! isset( $count[ $id ] ) )&nbsp;</div></li><li><div>          $count[ $id ] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $count;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// User option functions</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the current user's ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The current user's ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_current_user_id() {&nbsp;</div></li><li><div>  if ( ! function_exists( 'wp_get_current_user' ) )&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  $user = wp_get_current_user();&nbsp;</div></li><li><div>  return ( isset( $user-&gt;ID ) ? (int) $user-&gt;ID : 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve user option that can be either per Site or per Network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the user ID is not given, then the current user will be used instead. If</span>&nbsp;</div></li><li><div><span class="comment"> * the user ID is given, then the user data will be retrieved. The filter for</span>&nbsp;</div></li><li><div><span class="comment"> * the result, will also pass the original option name and finally the user data</span>&nbsp;</div></li><li><div><span class="comment"> * object as the third parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The option will first check for the per site name and then the per Network name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option     User option name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user       Optional. User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $deprecated Use get_option() to check for an option in the options table.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed User option value on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_user_option( $option, $user = 0, $deprecated = '' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $deprecated ) )&nbsp;</div></li><li><div>      _deprecated_argument( __FUNCTION__, '3.0.0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user ) )&nbsp;</div></li><li><div>      $user = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user = get_userdata( $user ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $prefix = $wpdb-&gt;get_blog_prefix();&nbsp;</div></li><li><div>  if ( $user-&gt;has_prop( $prefix . $option ) ) <span class="comment">// Blog specific</span>&nbsp;</div></li><li><div>      $result = $user-&gt;get( $prefix . $option );&nbsp;</div></li><li><div>  elseif ( $user-&gt;has_prop( $option ) ) <span class="comment">// User specific and cross-blog</span>&nbsp;</div></li><li><div>      $result = $user-&gt;get( $option );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $result = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a specific user option value.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portion of the hook name, `$option`, refers to the user option name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed   $result Value for the user's option.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $option Name of the option being retrieved.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User $user   WP_User object of the user whose option is being retrieved.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( &quot;get_user_option_{$option}&quot;, $result, $option, $user );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update user option with global blog capability.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * User options are just like user metadata except that they have support for</span>&nbsp;</div></li><li><div><span class="comment"> * global blog options. If the 'global' parameter is false, which it is by default</span>&nbsp;</div></li><li><div><span class="comment"> * it will prepend the WordPress table prefix to the option name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Deletes the user option if $newvalue is empty.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id     User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option_name User option name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $newvalue    User option value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $global      Optional. Whether option name is global or blog specific.</span>&nbsp;</div></li><li><div><span class="comment"> *                            Default false (blog specific).</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool User meta ID if the option didn't exist, true on successful update, </span>&nbsp;</div></li><li><div><span class="comment"> *                  false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_user_option( $user_id, $option_name, $newvalue, $global = false ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$global )&nbsp;</div></li><li><div>      $option_name = $wpdb-&gt;get_blog_prefix() . $option_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return update_user_meta( $user_id, $option_name, $newvalue );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete user option with global blog capability.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * User options are just like user metadata except that they have support for</span>&nbsp;</div></li><li><div><span class="comment"> * global blog options. If the 'global' parameter is false, which it is by default</span>&nbsp;</div></li><li><div><span class="comment"> * it will prepend the WordPress table prefix to the option name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id     User ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option_name User option name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $global      Optional. Whether option name is global or blog specific.</span>&nbsp;</div></li><li><div><span class="comment"> *                            Default false (blog specific).</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function delete_user_option( $user_id, $option_name, $global = false ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$global )&nbsp;</div></li><li><div>      $option_name = $wpdb-&gt;get_blog_prefix() . $option_name;&nbsp;</div></li><li><div>  return delete_user_meta( $user_id, $option_name );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve list of users matching criteria.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see WP_User_Query</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args Optional. Arguments to retrieve users. See WP_User_Query::prepare_query().</span>&nbsp;</div></li><li><div><span class="comment"> *                    for more information on accepted arguments.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of users.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_users( $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args );&nbsp;</div></li><li><div>  $args['count_total'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_search = new WP_User_Query($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (array) $user_search-&gt;get_results();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the blogs a user belongs to.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int  $user_id User ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $all     Whether to retrieve all blogs, or only blogs that are not</span>&nbsp;</div></li><li><div><span class="comment"> *                      marked as deleted, archived, or spam.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array A list of the user's blogs. An empty array if the user doesn't exist</span>&nbsp;</div></li><li><div><span class="comment"> *               or belongs to no blogs.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blogs_of_user( $user_id, $all = false ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Logged out users can't have blogs</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) )&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the list of a user's sites before it is populated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Passing a non-null value to the filter will effectively short circuit</span>&nbsp;</div></li><li><div><span class="comment">   * get_blogs_of_user(), returning that value instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param null|array $blogs   An array of WP_Site objects of which the user is a member.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int        $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool       $all     Whether the returned array should contain all sites, including</span>&nbsp;</div></li><li><div><span class="comment">   *                            those marked 'deleted', 'archived', or 'spam'. Default false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $blogs = apply_filters( 'pre_get_blogs_of_user', null, $user_id, $all );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( null !== $blogs ) {&nbsp;</div></li><li><div>      return $blogs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $keys = get_user_meta( $user_id );&nbsp;</div></li><li><div>  if ( empty( $keys ) )&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_multisite() ) {&nbsp;</div></li><li><div>      $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>      $blogs = array( $blog_id =&gt; new stdClass );&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;userblog_id = $blog_id;&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;blogname = get_option('blogname');&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;domain = '';&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;path = '';&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;site_id = 1;&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;siteurl = get_option('siteurl');&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;archived = 0;&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;spam = 0;&nbsp;</div></li><li><div>      $blogs[ $blog_id ]-&gt;deleted = 0;&nbsp;</div></li><li><div>      return $blogs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blogs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $keys[ $wpdb-&gt;base_prefix . 'capabilities' ] ) && defined( 'MULTISITE' ) ) {&nbsp;</div></li><li><div>      $blog = get_blog_details( 1 );&nbsp;</div></li><li><div>      if ( $blog && isset( $blog-&gt;domain ) && ( $all || ( ! $blog-&gt;archived && ! $blog-&gt;spam && ! $blog-&gt;deleted ) ) ) {&nbsp;</div></li><li><div>          $blogs[ 1 ] = (object) array(&nbsp;</div></li><li><div>              'userblog_id' =&gt; 1, &nbsp;</div></li><li><div>              'blogname' =&gt; $blog-&gt;blogname, &nbsp;</div></li><li><div>              'domain' =&gt; $blog-&gt;domain, &nbsp;</div></li><li><div>              'path' =&gt; $blog-&gt;path, &nbsp;</div></li><li><div>              'site_id' =&gt; $blog-&gt;site_id, &nbsp;</div></li><li><div>              'siteurl' =&gt; $blog-&gt;siteurl, &nbsp;</div></li><li><div>              'archived' =&gt; $blog-&gt;archived, &nbsp;</div></li><li><div>              'mature' =&gt; $blog-&gt;mature, &nbsp;</div></li><li><div>              'spam' =&gt; $blog-&gt;spam, &nbsp;</div></li><li><div>              'deleted' =&gt; $blog-&gt;deleted, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      unset( $keys[ $wpdb-&gt;base_prefix . 'capabilities' ] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $keys = array_keys( $keys );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $keys as $key ) {&nbsp;</div></li><li><div>      if ( 'capabilities' !== substr( $key, -12 ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( $wpdb-&gt;base_prefix && 0 !== strpos( $key, $wpdb-&gt;base_prefix ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      $blog_id = str_replace( array( $wpdb-&gt;base_prefix, '_capabilities' ), '', $key );&nbsp;</div></li><li><div>      if ( ! is_numeric( $blog_id ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $blog_id = (int) $blog_id;&nbsp;</div></li><li><div>      $blog = get_blog_details( $blog_id );&nbsp;</div></li><li><div>      if ( $blog && isset( $blog-&gt;domain ) && ( $all || ( ! $blog-&gt;archived && ! $blog-&gt;spam && ! $blog-&gt;deleted ) ) ) {&nbsp;</div></li><li><div>          $blogs[ $blog_id ] = (object) array(&nbsp;</div></li><li><div>              'userblog_id' =&gt; $blog_id, &nbsp;</div></li><li><div>              'blogname' =&gt; $blog-&gt;blogname, &nbsp;</div></li><li><div>              'domain' =&gt; $blog-&gt;domain, &nbsp;</div></li><li><div>              'path' =&gt; $blog-&gt;path, &nbsp;</div></li><li><div>              'site_id' =&gt; $blog-&gt;site_id, &nbsp;</div></li><li><div>              'siteurl' =&gt; $blog-&gt;siteurl, &nbsp;</div></li><li><div>              'archived' =&gt; $blog-&gt;archived, &nbsp;</div></li><li><div>              'mature' =&gt; $blog-&gt;mature, &nbsp;</div></li><li><div>              'spam' =&gt; $blog-&gt;spam, &nbsp;</div></li><li><div>              'deleted' =&gt; $blog-&gt;deleted, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the list of blogs a user belongs to.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $blogs   An array of blog objects belonging to the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int   $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool  $all     Whether the returned blogs array should contain all blogs, including</span>&nbsp;</div></li><li><div><span class="comment">   *                       those marked 'deleted', 'archived', or 'spam'. Default false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'get_blogs_of_user', $blogs, $user_id, $all );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Find out whether a user is a member of a given blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id Optional. The unique ID of the user. Defaults to the current user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id Optional. ID of the blog to check. Defaults to the current site.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_user_member_of_blog( $user_id = 0, $blog_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>  $blog_id = (int) $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Technically not needed, but does save calls to get_blog_details and get_user_meta</span>&nbsp;</div></li><li><div>  <span class="comment">// in the event that the function is called when a user isn't logged in</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user = get_userdata( $user_id );&nbsp;</div></li><li><div>      if ( ! $user instanceof WP_User ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_multisite() ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $blog_id ) ) {&nbsp;</div></li><li><div>      $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog = get_blog_details( $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $blog || ! isset( $blog-&gt;domain ) || $blog-&gt;archived || $blog-&gt;spam || $blog-&gt;deleted ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $keys = get_user_meta( $user_id );&nbsp;</div></li><li><div>  if ( empty( $keys ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// no underscore before capabilities in $base_capabilities_key</span>&nbsp;</div></li><li><div>  $base_capabilities_key = $wpdb-&gt;base_prefix . 'capabilities';&nbsp;</div></li><li><div>  $site_capabilities_key = $wpdb-&gt;base_prefix . $blog_id . '_capabilities';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $keys[ $base_capabilities_key ] ) && $blog_id == 1 ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $keys[ $site_capabilities_key ] ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add meta data field to a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Post meta data is called &quot;Custom Fields&quot; on the Administration Screens.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://codex.wordpress.org/Function_Reference/add_user_meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id    User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key   Metadata name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $meta_value Metadata value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $unique     Optional, default is false. Whether the same key should not be added.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false Meta ID on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_user_meta($user_id, $meta_key, $meta_value, $unique = false) {&nbsp;</div></li><li><div>  return add_metadata('user', $user_id, $meta_key, $meta_value, $unique);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove metadata matching criteria from a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You can match based on the key, or key and value. Removing based on key and</span>&nbsp;</div></li><li><div><span class="comment"> * value, will keep from removing duplicate metadata with the same key. It also</span>&nbsp;</div></li><li><div><span class="comment"> * allows removing all metadata matching key, if needed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://codex.wordpress.org/Function_Reference/delete_user_meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id    User ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key   Metadata name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $meta_value Optional. Metadata value.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function delete_user_meta($user_id, $meta_key, $meta_value = '') {&nbsp;</div></li><li><div>  return delete_metadata('user', $user_id, $meta_key, $meta_value);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve user meta field for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://codex.wordpress.org/Function_Reference/get_user_meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key     Optional. The meta key to retrieve. By default, returns data for all keys.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $single  Whether to return a single value.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed Will be an array if $single is false. Will be value of meta data field if $single is true.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_user_meta($user_id, $key = '', $single = false) {&nbsp;</div></li><li><div>  return get_metadata('user', $user_id, $key, $single);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update user meta field based on user ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Use the $prev_value parameter to differentiate between meta fields with the</span>&nbsp;</div></li><li><div><span class="comment"> * same key and user ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the meta field for the user does not exist, it will be added.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @link https://codex.wordpress.org/Function_Reference/update_user_meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id    User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key   Metadata key.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $meta_value Metadata value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $prev_value Optional. Previous value to check before removing.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool Meta ID if the key didn't exist, true on successful update, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_user_meta($user_id, $meta_key, $meta_value, $prev_value = '') {&nbsp;</div></li><li><div>  return update_metadata('user', $user_id, $meta_key, $meta_value, $prev_value);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Count number of users who have each of the user roles.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Assumes there are neither duplicated nor orphaned capabilities meta_values.</span>&nbsp;</div></li><li><div><span class="comment"> * Assumes role names are unique phrases. Same assumption made by WP_User_Query::prepare_query()</span>&nbsp;</div></li><li><div><span class="comment"> * Using $strategy = 'time' this is CPU-intensive and should handle around 10^7 users.</span>&nbsp;</div></li><li><div><span class="comment"> * Using $strategy = 'memory' this is memory-intensive and should handle around 10^5 users, but see WP Bug #12257.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0 The number of users with no role is now included in the `none` element.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $strategy 'time' or 'memory'</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Includes a grand total and an array of counts indexed by role strings.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function count_users($strategy = 'time') {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Initialize</span>&nbsp;</div></li><li><div>  $id = get_current_blog_id();&nbsp;</div></li><li><div>  $blog_prefix = $wpdb-&gt;get_blog_prefix($id);&nbsp;</div></li><li><div>  $result = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'time' == $strategy ) {&nbsp;</div></li><li><div>      $avail_roles = wp_roles()-&gt;get_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Build a CPU-intensive query that will return concise information.</span>&nbsp;</div></li><li><div>      $select_count = array();&nbsp;</div></li><li><div>      foreach ( $avail_roles as $this_role =&gt; $name ) {&nbsp;</div></li><li><div>          $select_count[] = $wpdb-&gt;prepare( &quot;COUNT(NULLIF(`meta_value` LIKE %s, false))&quot;, '%' . $wpdb-&gt;esc_like( '&quot;' . $this_role . '&quot;' ) . '%');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $select_count[] = &quot;COUNT(NULLIF(`meta_value` = 'a:0:{}', false))&quot;;&nbsp;</div></li><li><div>      $select_count = implode(', ', $select_count);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the meta_value index to the selection list, then run the query.</span>&nbsp;</div></li><li><div>      $row = $wpdb-&gt;get_row( &quot;SELECT $select_count, COUNT(*) FROM $wpdb-&gt;usermeta WHERE meta_key = '{$blog_prefix}capabilities'&quot;, ARRAY_N );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Run the previous loop again to associate results with role names.</span>&nbsp;</div></li><li><div>      $col = 0;&nbsp;</div></li><li><div>      $role_counts = array();&nbsp;</div></li><li><div>      foreach ( $avail_roles as $this_role =&gt; $name ) {&nbsp;</div></li><li><div>          $count = (int) $row[$col++];&nbsp;</div></li><li><div>          if ($count &gt; 0) {&nbsp;</div></li><li><div>              $role_counts[$this_role] = $count;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $role_counts['none'] = (int) $row[$col++];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the meta_value index from the end of the result set.</span>&nbsp;</div></li><li><div>      $total_users = (int) $row[$col];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result['total_users'] = $total_users;&nbsp;</div></li><li><div>      $result['avail_roles'] =& $role_counts;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $avail_roles = array(&nbsp;</div></li><li><div>          'none' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $users_of_blog = $wpdb-&gt;get_col( &quot;SELECT meta_value FROM $wpdb-&gt;usermeta WHERE meta_key = '{$blog_prefix}capabilities'&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $users_of_blog as $caps_meta ) {&nbsp;</div></li><li><div>          $b_roles = maybe_unserialize($caps_meta);&nbsp;</div></li><li><div>          if ( ! is_array( $b_roles ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( empty( $b_roles ) ) {&nbsp;</div></li><li><div>              $avail_roles['none']++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          foreach ( $b_roles as $b_role =&gt; $val ) {&nbsp;</div></li><li><div>              if ( isset($avail_roles[$b_role]) ) {&nbsp;</div></li><li><div>                  $avail_roles[$b_role]++;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $avail_roles[$b_role] = 1;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result['total_users'] = count( $users_of_blog );&nbsp;</div></li><li><div>      $result['avail_roles'] =& $avail_roles;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $result['avail_roles']['none'] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>// Private helper functions&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set up global user vars.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used by wp_set_current_user() for back compat. Might be deprecated in the future.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $user_login    The user username for logging in</span>&nbsp;</div></li><li><div><span class="comment"> * @global object $userdata      User data.</span>&nbsp;</div></li><li><div><span class="comment"> * @global int    $user_level    The level of the user</span>&nbsp;</div></li><li><div><span class="comment"> * @global int    $user_ID       The ID of the user</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $user_email    The email address of the user</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $user_url      The url in the user's profile</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $user_identity The display name of the user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $for_user_id Optional. User ID to set up global data.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function setup_userdata($for_user_id = '') {&nbsp;</div></li><li><div>  global $user_login, $userdata, $user_level, $user_ID, $user_email, $user_url, $user_identity;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( '' == $for_user_id )&nbsp;</div></li><li><div>      $for_user_id = get_current_user_id();&nbsp;</div></li><li><div>  $user = get_userdata( $for_user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user ) {&nbsp;</div></li><li><div>      $user_ID = 0;&nbsp;</div></li><li><div>      $user_level = 0;&nbsp;</div></li><li><div>      $userdata = null;&nbsp;</div></li><li><div>      $user_login = $user_email = $user_url = $user_identity = '';&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_ID = (int) $user-&gt;ID;&nbsp;</div></li><li><div>  $user_level = (int) $user-&gt;user_level;&nbsp;</div></li><li><div>  $userdata = $user;&nbsp;</div></li><li><div>  $user_login = $user-&gt;user_login;&nbsp;</div></li><li><div>  $user_email = $user-&gt;user_email;&nbsp;</div></li><li><div>  $user_url = $user-&gt;user_url;&nbsp;</div></li><li><div>  $user_identity = $user-&gt;display_name;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create dropdown HTML content of users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The content can either be displayed, which it is by default or retrieved by</span>&nbsp;</div></li><li><div><span class="comment"> * setting the 'echo' argument. The 'include' and 'exclude' arguments do not</span>&nbsp;</div></li><li><div><span class="comment"> * need to be used; all users will be displayed in that case. Only one can be</span>&nbsp;</div></li><li><div><span class="comment"> * used, either 'include' or 'exclude', but not both.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The available arguments are as follows:</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.5.0 Added the 'display_name_with_login' value for 'show'.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $blog_id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Optional. Array or string of arguments to generate a drop-down of users.</span>&nbsp;</div></li><li><div><span class="comment"> *     See WP_User_Query::prepare_query() for additional available arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $show_option_all         Text to show as the drop-down default (all).</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $show_option_none        Text to show as the drop-down default when no</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 users were found. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|string   $option_none_value       Value to use for $show_option_non when no users</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 were found. Default -1.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $hide_if_only_one_author Whether to skip generating the drop-down</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 if only one user was found. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $orderby                 Field to order found users by. Accepts user fields.</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Default 'display_name'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $order                   Whether to order users in ascending or descending</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 order. Accepts 'ASC' (ascending) or 'DESC' (descending).</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Default 'ASC'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array|string $include                 Array or comma-separated list of user IDs to include.</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array|string $exclude                 Array or comma-separated list of user IDs to exclude.</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool|int     $multi                   Whether to skip the ID attribute on the 'select' element.</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Accepts 1|true or 0|false. Default 0|false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $show                    User data to display. If the selected item is empty</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 then the 'user_login' will be displayed in parentheses.</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Accepts any user field, or 'display_name_with_login' to show</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 the display name with user_login in parentheses.</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 Default 'display_name'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int|bool     $echo                    Whether to echo or return the drop-down. Accepts 1|true (echo)</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 or 0|false (return). Default 1|true.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $selected                Which user ID should be selected. Default 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool         $include_selected        Whether to always include the selected user ID in the drop-</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 down. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $name                    Name attribute of select element. Default 'user'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $id                      ID attribute of the select element. Default is the value of $name.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $class                   Class attribute of the select element. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $blog_id                 ID of blog (Multisite only). Default is ID of the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $who                     Which type of users to query. Accepts only an empty string or</span>&nbsp;</div></li><li><div><span class="comment"> *                                                 'authors'. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return string String of HTML content.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_dropdown_users( $args = '' ) {&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'show_option_all' =&gt; '', 'show_option_none' =&gt; '', 'hide_if_only_one_author' =&gt; '', &nbsp;</div></li><li><div>      'orderby' =&gt; 'display_name', 'order' =&gt; 'ASC', &nbsp;</div></li><li><div>      'include' =&gt; '', 'exclude' =&gt; '', 'multi' =&gt; 0, &nbsp;</div></li><li><div>      'show' =&gt; 'display_name', 'echo' =&gt; 1, &nbsp;</div></li><li><div>      'selected' =&gt; 0, 'name' =&gt; 'user', 'class' =&gt; '', 'id' =&gt; '', &nbsp;</div></li><li><div>      'blog_id' =&gt; $GLOBALS['blog_id'], 'who' =&gt; '', 'include_selected' =&gt; false, &nbsp;</div></li><li><div>      'option_none_value' =&gt; -1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults['selected'] = is_author() ? get_query_var( 'author' ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query_args = wp_array_slice_assoc( $r, array( 'blog_id', 'include', 'exclude', 'orderby', 'order', 'who' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $fields = array( 'ID', 'user_login' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $show = ! empty( $r['show'] ) ? $r['show'] : 'display_name';&nbsp;</div></li><li><div>  if ( 'display_name_with_login' === $show ) {&nbsp;</div></li><li><div>      $fields[] = 'display_name';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $fields[] = $show;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query_args['fields'] = $fields;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $show_option_all = $r['show_option_all'];&nbsp;</div></li><li><div>  $show_option_none = $r['show_option_none'];&nbsp;</div></li><li><div>  $option_none_value = $r['option_none_value'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the query arguments for the user drop-down.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $query_args The query arguments for wp_dropdown_users().</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $r          The default arguments for wp_dropdown_users().</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $query_args = apply_filters( 'wp_dropdown_users_args', $query_args, $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $users = get_users( $query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  if ( ! empty( $users ) && ( empty( $r['hide_if_only_one_author'] ) || count( $users ) &gt; 1 ) ) {&nbsp;</div></li><li><div>      $name = esc_attr( $r['name'] );&nbsp;</div></li><li><div>      if ( $r['multi'] && ! $r['id'] ) {&nbsp;</div></li><li><div>          $id = '';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $id = $r['id'] ? &quot; id='&quot; . esc_attr( $r['id'] ) . &quot;'&quot; : &quot; id='$name'&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $output = &quot;&lt;select name='{$name}'{$id} class='&quot; . $r['class'] . &quot;'&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $show_option_all ) {&nbsp;</div></li><li><div>          $output .= &quot;\t&lt;option value='0'&gt;$show_option_all&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $show_option_none ) {&nbsp;</div></li><li><div>          $_selected = selected( $option_none_value, $r['selected'], false );&nbsp;</div></li><li><div>          $output .= &quot;\t&lt;option value='&quot; . esc_attr( $option_none_value ) . &quot;'$_selected&gt;$show_option_none&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $r['include_selected'] && ( $r['selected'] &gt; 0 ) ) {&nbsp;</div></li><li><div>          $found_selected = false;&nbsp;</div></li><li><div>          $r['selected'] = (int) $r['selected'];&nbsp;</div></li><li><div>          foreach ( (array) $users as $user ) {&nbsp;</div></li><li><div>              $user-&gt;ID = (int) $user-&gt;ID;&nbsp;</div></li><li><div>              if ( $user-&gt;ID === $r['selected'] ) {&nbsp;</div></li><li><div>                  $found_selected = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $found_selected ) {&nbsp;</div></li><li><div>              $users[] = get_userdata( $r['selected'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( (array) $users as $user ) {&nbsp;</div></li><li><div>          if ( 'display_name_with_login' === $show ) {&nbsp;</div></li><li><div>              <span class="comment">/** translators: 1: display name, 2: user_login */</span>&nbsp;</div></li><li><div>              $display = sprintf( _x( '%1$s (%2$s)', 'user dropdown' ), $user-&gt;display_name, $user-&gt;user_login );&nbsp;</div></li><li><div>          } elseif ( ! empty( $user-&gt;$show ) ) {&nbsp;</div></li><li><div>              $display = $user-&gt;$show;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $display = '(' . $user-&gt;user_login . ')';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $_selected = selected( $user-&gt;ID, $r['selected'], false );&nbsp;</div></li><li><div>          $output .= &quot;\t&lt;option value='$user-&gt;ID'$_selected&gt;&quot; . esc_html( $display ) . &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output .= &quot;&lt;/select&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the wp_dropdown_users() HTML output.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $output HTML output generated by wp_dropdown_users().</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $html = apply_filters( 'wp_dropdown_users', $output );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $r['echo'] ) {&nbsp;</div></li><li><div>      echo $html;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $html;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sanitize user field based on context.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Possible context values are:  'raw', 'edit', 'db', 'display', 'attribute' and 'js'. The</span>&nbsp;</div></li><li><div><span class="comment"> * 'display' context is used by default. 'attribute' and 'js' contexts are treated like 'display'</span>&nbsp;</div></li><li><div><span class="comment"> * when calling filters.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $field   The user Object field name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $value   The user Object value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $context How to sanitize user fields. Looks for 'raw', 'edit', 'db', 'display', </span>&nbsp;</div></li><li><div><span class="comment"> *                        'attribute' and 'js'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed Sanitized value.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function sanitize_user_field($field, $value, $user_id, $context) {&nbsp;</div></li><li><div>  $int_fields = array('ID');&nbsp;</div></li><li><div>  if ( in_array($field, $int_fields) )&nbsp;</div></li><li><div>      $value = (int) $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'raw' == $context )&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_string($value) && !is_numeric($value) )&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $prefixed = false !== strpos( $field, 'user_' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'edit' == $context ) {&nbsp;</div></li><li><div>      if ( $prefixed ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/post.php */</span></span></span>&nbsp;</div></li><li><div>          $value = apply_filters( &quot;edit_{$field}&quot;, $value, $user_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters a user field value in the 'edit' context.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * The dynamic portion of the hook name, `$field`, refers to the prefixed user</span>&nbsp;</div></li><li><div><span class="comment">           * field being filtered, such as 'user_login', 'user_email', 'first_name', etc.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param mixed $value   Value of the prefixed user field.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int   $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $value = apply_filters( &quot;edit_user_{$field}&quot;, $value, $user_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'description' == $field )&nbsp;</div></li><li><div>          $value = esc_html( $value ); <span class="comment">// textarea_escaped?</span>&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $value = esc_attr($value);&nbsp;</div></li><li><div>  } elseif ( 'db' == $context ) {&nbsp;</div></li><li><div>      if ( $prefixed ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/post.php */</span></span></span>&nbsp;</div></li><li><div>          $value = apply_filters( &quot;pre_{$field}&quot;, $value );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the value of a user field in the 'db' context.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * The dynamic portion of the hook name, `$field`, refers to the prefixed user</span>&nbsp;</div></li><li><div><span class="comment">           * field being filtered, such as 'user_login', 'user_email', 'first_name', etc.</span>&nbsp;</div></li><li><div><span class="comment">            *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param mixed $value Value of the prefixed user field.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $value = apply_filters( &quot;pre_user_{$field}&quot;, $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Use display filters by default.</span>&nbsp;</div></li><li><div>      if ( $prefixed ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/post.php */</span></span></span>&nbsp;</div></li><li><div>          $value = apply_filters( $field, $value, $user_id, $context );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the value of a user field in a standard context.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * The dynamic portion of the hook name, `$field`, refers to the prefixed user</span>&nbsp;</div></li><li><div><span class="comment">           * field being filtered, such as 'user_login', 'user_email', 'first_name', etc.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param mixed  $value   The user object value to sanitize.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $context The context to filter within.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $value = apply_filters( &quot;user_{$field}&quot;, $value, $user_id, $context );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'user_url' == $field )&nbsp;</div></li><li><div>      $value = esc_url($value);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'attribute' == $context ) {&nbsp;</div></li><li><div>      $value = esc_attr( $value );&nbsp;</div></li><li><div>  } elseif ( 'js' == $context ) {&nbsp;</div></li><li><div>      $value = esc_js( $value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $value;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update all user caches</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object|WP_User $user User object to be cached</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|null Returns false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_user_caches( $user ) {&nbsp;</div></li><li><div>  if ( $user instanceof WP_User ) {&nbsp;</div></li><li><div>      if ( ! $user-&gt;exists() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user = $user-&gt;data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_add($user-&gt;ID, $user, 'users');&nbsp;</div></li><li><div>  wp_cache_add($user-&gt;user_login, $user-&gt;ID, 'userlogins');&nbsp;</div></li><li><div>  wp_cache_add($user-&gt;user_email, $user-&gt;ID, 'useremail');&nbsp;</div></li><li><div>  wp_cache_add($user-&gt;user_nicename, $user-&gt;ID, 'userslugs');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean all user caches</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0 'clean_user_cache' action was added.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|int $user User object or ID to be cleaned from the cache</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function clean_user_cache( $user ) {&nbsp;</div></li><li><div>  if ( is_numeric( $user ) )&nbsp;</div></li><li><div>      $user = new WP_User( $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user-&gt;exists() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( $user-&gt;ID, 'users' );&nbsp;</div></li><li><div>  wp_cache_delete( $user-&gt;user_login, 'userlogins' );&nbsp;</div></li><li><div>  wp_cache_delete( $user-&gt;user_email, 'useremail' );&nbsp;</div></li><li><div>  wp_cache_delete( $user-&gt;user_nicename, 'userslugs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires immediately after the given user's cache is cleaned.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User $user    User object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'clean_user_cache', $user-&gt;ID, $user );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether the given username exists.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $username Username.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false The user's ID on success, and false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function username_exists( $username ) {&nbsp;</div></li><li><div>  if ( $user = get_user_by( 'login', $username ) ) {&nbsp;</div></li><li><div>      return $user-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether the given email exists.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $email Email.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false The user's ID on success, and false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function email_exists( $email ) {&nbsp;</div></li><li><div>  if ( $user = get_user_by( 'email', $email) ) {&nbsp;</div></li><li><div>      return $user-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether a username is valid.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.1</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0 Empty sanitized usernames are now considered invalid</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $username Username.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether username given is valid</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function validate_username( $username ) {&nbsp;</div></li><li><div>  $sanitized = sanitize_user( $username, true );&nbsp;</div></li><li><div>  $valid = ( $sanitized == $username && ! empty( $sanitized ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether the provided username is valid or not.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $valid    Whether given username is valid.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $username Username to check.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'validate_username', $valid, $username );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Insert a user into the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Most of the `$userdata` array fields have filters associated with the values. Exceptions are</span>&nbsp;</div></li><li><div><span class="comment"> * 'ID', 'rich_editing', 'comment_shortcuts', 'admin_color', 'use_ssl', </span>&nbsp;</div></li><li><div><span class="comment"> * 'user_registered', and 'role'. The filters have the prefix 'pre_user_' followed by the field</span>&nbsp;</div></li><li><div><span class="comment"> * name. An example using 'description' would have the filter called, 'pre_user_description' that</span>&nbsp;</div></li><li><div><span class="comment"> * can be hooked into.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0 The `aim`, `jabber`, and `yim` fields were removed as default user contact</span>&nbsp;</div></li><li><div><span class="comment"> *              methods for new installs. See wp_get_user_contact_methods().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|object|WP_User $userdata {</span>&nbsp;</div></li><li><div><span class="comment"> *     An array, object, or WP_User object of user data arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int         $ID                   User ID. If supplied, the user will be updated.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $user_pass            The plain-text user password.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $user_login           The user's login username.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $user_nicename        The URL-friendly user name.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $user_url             The user URL.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $user_email           The user email address.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $display_name         The user's display name.</span>&nbsp;</div></li><li><div><span class="comment"> *                                             Default is the user's username.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $nickname             The user's nickname.</span>&nbsp;</div></li><li><div><span class="comment"> *                                             Default is the user's username.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $first_name           The user's first name. For new users, will be used</span>&nbsp;</div></li><li><div><span class="comment"> *                                             to build the first part of the user's display name</span>&nbsp;</div></li><li><div><span class="comment"> *                                             if `$display_name` is not specified.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $last_name            The user's last name. For new users, will be used</span>&nbsp;</div></li><li><div><span class="comment"> *                                             to build the second part of the user's display name</span>&nbsp;</div></li><li><div><span class="comment"> *                                             if `$display_name` is not specified.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $description          The user's biographical description.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool $rich_editing         Whether to enable the rich-editor for the user.</span>&nbsp;</div></li><li><div><span class="comment"> *                                             False if not empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool $comment_shortcuts    Whether to enable comment moderation keyboard</span>&nbsp;</div></li><li><div><span class="comment"> *                                             shortcuts for the user. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $admin_color          Admin color scheme for the user. Default 'fresh'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool        $use_ssl              Whether the user should always access the admin over</span>&nbsp;</div></li><li><div><span class="comment"> *                                             https. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $user_registered      Date the user registered. Format is 'Y-m-d H:i:s'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|bool $show_admin_bar_front Whether to display the Admin Bar for the user on the</span>&nbsp;</div></li><li><div><span class="comment"> *                                             site's front end. Default true.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string      $role                 User's role.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error The newly created user's ID or a WP_Error object if the user could not</span>&nbsp;</div></li><li><div><span class="comment"> *                      be created.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_insert_user( $userdata ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $userdata instanceof stdClass ) {&nbsp;</div></li><li><div>      $userdata = get_object_vars( $userdata );&nbsp;</div></li><li><div>  } elseif ( $userdata instanceof WP_User ) {&nbsp;</div></li><li><div>      $userdata = $userdata-&gt;to_array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Are we updating or creating?</span>&nbsp;</div></li><li><div>  if ( ! empty( $userdata['ID'] ) ) {&nbsp;</div></li><li><div>      $ID = (int) $userdata['ID'];&nbsp;</div></li><li><div>      $update = true;&nbsp;</div></li><li><div>      $old_user_data = get_userdata( $ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $old_user_data ) {&nbsp;</div></li><li><div>          return new WP_Error( 'invalid_user_id', __( 'Invalid user ID.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// hashed in wp_update_user(), plaintext if called directly</span>&nbsp;</div></li><li><div>      $user_pass = ! empty( $userdata['user_pass'] ) ? $userdata['user_pass'] : $old_user_data-&gt;user_pass;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $update = false;&nbsp;</div></li><li><div>      <span class="comment">// Hash the password</span>&nbsp;</div></li><li><div>      $user_pass = wp_hash_password( $userdata['user_pass'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sanitized_user_login = sanitize_user( $userdata['user_login'], true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a username after it has been sanitized.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This filter is called before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $sanitized_user_login Username after it has been sanitized.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $pre_user_login = apply_filters( 'pre_user_login', $sanitized_user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Remove any non-printable chars from the login string to see if we have ended up with an empty username</span>&nbsp;</div></li><li><div>  $user_login = trim( $pre_user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// user_login must be between 0 and 60 characters.</span>&nbsp;</div></li><li><div>  if ( empty( $user_login ) ) {&nbsp;</div></li><li><div>      return new WP_Error('empty_user_login', __('Cannot create a user with an empty login name.') );&nbsp;</div></li><li><div>  } elseif ( mb_strlen( $user_login ) &gt; 60 ) {&nbsp;</div></li><li><div>      return new WP_Error( 'user_login_too_long', __( 'Username may not be longer than 60 characters.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $update && username_exists( $user_login ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'existing_user_login', __( 'Sorry, that username already exists!' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the list of blacklisted usernames.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $usernames Array of blacklisted usernames.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $illegal_logins = (array) apply_filters( 'illegal_user_logins', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( in_array( strtolower( $user_login ), array_map( 'strtolower', $illegal_logins ) ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_username', __( 'Sorry, that username is not allowed.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If a nicename is provided, remove unsafe user characters before using it.</span>&nbsp;</div></li><li><div><span class="comment">   * Otherwise build a nicename from the user_login.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! empty( $userdata['user_nicename'] ) ) {&nbsp;</div></li><li><div>      $user_nicename = sanitize_user( $userdata['user_nicename'], true );&nbsp;</div></li><li><div>      if ( mb_strlen( $user_nicename ) &gt; 50 ) {&nbsp;</div></li><li><div>          return new WP_Error( 'user_nicename_too_long', __( 'Nicename may not be longer than 50 characters.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user_nicename = mb_substr( $user_login, 0, 50 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_nicename = sanitize_title( $user_nicename );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Store values to save in user meta.</span>&nbsp;</div></li><li><div>  $meta = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's nicename before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_nicename The user's nicename.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_nicename = apply_filters( 'pre_user_nicename', $user_nicename );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $raw_user_url = empty( $userdata['user_url'] ) ? '' : $userdata['user_url'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's URL before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $raw_user_url The user's URL.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_url = apply_filters( 'pre_user_url', $raw_user_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $raw_user_email = empty( $userdata['user_email'] ) ? '' : $userdata['user_email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's email before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $raw_user_email The user's email.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_email = apply_filters( 'pre_user_email', $raw_user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If there is no update, just check for `email_exists`. If there is an update, </span>&nbsp;</div></li><li><div><span class="comment">   * check if current email and new email are the same, or not, and check `email_exists`</span>&nbsp;</div></li><li><div><span class="comment">   * accordingly.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ( ! $update || ( ! empty( $old_user_data ) && 0 !== strcasecmp( $user_email, $old_user_data-&gt;user_email ) ) )&nbsp;</div></li><li><div>      && ! defined( 'WP_IMPORTING' )&nbsp;</div></li><li><div>      && email_exists( $user_email )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>      return new WP_Error( 'existing_user_email', __( 'Sorry, that email address is already used!' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $nickname = empty( $userdata['nickname'] ) ? $user_login : $userdata['nickname'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's nickname before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $nickname The user's nickname.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $meta['nickname'] = apply_filters( 'pre_user_nickname', $nickname );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $first_name = empty( $userdata['first_name'] ) ? '' : $userdata['first_name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's first name before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $first_name The user's first name.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $meta['first_name'] = apply_filters( 'pre_user_first_name', $first_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $last_name = empty( $userdata['last_name'] ) ? '' : $userdata['last_name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's last name before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $last_name The user's last name.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $meta['last_name'] = apply_filters( 'pre_user_last_name', $last_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $userdata['display_name'] ) ) {&nbsp;</div></li><li><div>      if ( $update ) {&nbsp;</div></li><li><div>          $display_name = $user_login;&nbsp;</div></li><li><div>      } elseif ( $meta['first_name'] && $meta['last_name'] ) {&nbsp;</div></li><li><div>          <span class="comment">/** translators: 1: first name, 2: last name */</span>&nbsp;</div></li><li><div>          $display_name = sprintf( _x( '%1$s %2$s', 'Display name based on first name and last name' ), $meta['first_name'], $meta['last_name'] );&nbsp;</div></li><li><div>      } elseif ( $meta['first_name'] ) {&nbsp;</div></li><li><div>          $display_name = $meta['first_name'];&nbsp;</div></li><li><div>      } elseif ( $meta['last_name'] ) {&nbsp;</div></li><li><div>          $display_name = $meta['last_name'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $display_name = $user_login;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $display_name = $userdata['display_name'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's display name before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $display_name The user's display name.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $display_name = apply_filters( 'pre_user_display_name', $display_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $description = empty( $userdata['description'] ) ? '' : $userdata['description'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a user's description before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $description The user's description.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $meta['description'] = apply_filters( 'pre_user_description', $description );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta['rich_editing'] = empty( $userdata['rich_editing'] ) ? 'true' : $userdata['rich_editing'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta['comment_shortcuts'] = empty( $userdata['comment_shortcuts'] ) || 'false' === $userdata['comment_shortcuts'] ? 'false' : 'true';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $admin_color = empty( $userdata['admin_color'] ) ? 'fresh' : $userdata['admin_color'];&nbsp;</div></li><li><div>  $meta['admin_color'] = preg_replace( '|[^a-z0-9 _.\-@]|i', '', $admin_color );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta['use_ssl'] = empty( $userdata['use_ssl'] ) ? 0 : $userdata['use_ssl'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_registered = empty( $userdata['user_registered'] ) ? gmdate( 'Y-m-d H:i:s' ) : $userdata['user_registered'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta['show_admin_bar_front'] = empty( $userdata['show_admin_bar_front'] ) ? 'true' : $userdata['show_admin_bar_front'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_nicename_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_nicename = %s AND user_login != %s LIMIT 1&quot; , $user_nicename, $user_login));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $user_nicename_check ) {&nbsp;</div></li><li><div>      $suffix = 2;&nbsp;</div></li><li><div>      while ($user_nicename_check) {&nbsp;</div></li><li><div>          <span class="comment">// user_nicename allows 50 chars. Subtract one for a hyphen, plus the length of the suffix.</span>&nbsp;</div></li><li><div>          $base_length = 49 - mb_strlen( $suffix );&nbsp;</div></li><li><div>          $alt_user_nicename = mb_substr( $user_nicename, 0, $base_length ) . &quot;-$suffix&quot;;&nbsp;</div></li><li><div>          $user_nicename_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_nicename = %s AND user_login != %s LIMIT 1&quot; , $alt_user_nicename, $user_login));&nbsp;</div></li><li><div>          $suffix++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $user_nicename = $alt_user_nicename;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $compacted = compact( 'user_pass', 'user_email', 'user_url', 'user_nicename', 'display_name', 'user_registered' );&nbsp;</div></li><li><div>  $data = wp_unslash( $compacted );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $update ) {&nbsp;</div></li><li><div>      if ( $user_email !== $old_user_data-&gt;user_email ) {&nbsp;</div></li><li><div>          $data['user_activation_key'] = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;users, $data, compact( 'ID' ) );&nbsp;</div></li><li><div>      $user_id = (int) $ID;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $wpdb-&gt;insert( $wpdb-&gt;users, $data + compact( 'user_login' ) );&nbsp;</div></li><li><div>      $user_id = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = new WP_User( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">    * Filters a user's meta values and keys before the user is created or updated.</span>&nbsp;</div></li><li><div><span class="comment">    *</span>&nbsp;</div></li><li><div><span class="comment">    * Does not include contact methods. These are added using `wp_get_user_contact_methods( $user )`.</span>&nbsp;</div></li><li><div><span class="comment">    *</span>&nbsp;</div></li><li><div><span class="comment">    * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">    *</span>&nbsp;</div></li><li><div><span class="comment">    * @param array $meta {</span>&nbsp;</div></li><li><div><span class="comment">    *     Default meta values and keys for the user.</span>&nbsp;</div></li><li><div><span class="comment">    *</span>&nbsp;</div></li><li><div><span class="comment">    *     @type string   $nickname             The user's nickname. Default is the user's username.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $first_name           The user's first name.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $last_name            The user's last name.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $description          The user's description.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool     $rich_editing         Whether to enable the rich-editor for the user. False if not empty.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool     $comment_shortcuts    Whether to enable keyboard shortcuts for the user. Default false.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $admin_color          The color scheme for a user's admin screen. Default 'fresh'.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type int|bool $use_ssl              Whether to force SSL on the user's admin area. 0|false if SSL is</span>&nbsp;</div></li><li><div><span class="comment">   *                                          not forced.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type bool     $show_admin_bar_front Whether to show the admin bar on the front end for the user.</span>&nbsp;</div></li><li><div><span class="comment">   *                                          Default true.</span>&nbsp;</div></li><li><div><span class="comment">    * }</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User $user   User object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool    $update Whether the user is being updated rather than created.</span>&nbsp;</div></li><li><div><span class="comment">    */</span>&nbsp;</div></li><li><div>  $meta = apply_filters( 'insert_user_meta', $meta, $user, $update );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update user meta.</span>&nbsp;</div></li><li><div>  foreach ( $meta as $key =&gt; $value ) {&nbsp;</div></li><li><div>      update_user_meta( $user_id, $key, $value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( wp_get_user_contact_methods( $user ) as $key =&gt; $value ) {&nbsp;</div></li><li><div>      if ( isset( $userdata[ $key ] ) ) {&nbsp;</div></li><li><div>          update_user_meta( $user_id, $key, $userdata[ $key ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $userdata['role'] ) ) {&nbsp;</div></li><li><div>      $user-&gt;set_role( $userdata['role'] );&nbsp;</div></li><li><div>  } elseif ( ! $update ) {&nbsp;</div></li><li><div>      $user-&gt;set_role(get_option('default_role'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  wp_cache_delete( $user_id, 'users' );&nbsp;</div></li><li><div>  wp_cache_delete( $user_login, 'userlogins' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $update ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires immediately after an existing user is updated.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $user_id       User ID.</span>&nbsp;</div></li><li><div><span class="comment">       * @param object $old_user_data Object containing user's data prior to update.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'profile_update', $user_id, $old_user_data );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires immediately after a new user is registered.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'user_register', $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update a user in the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * It is possible to update a user's password by specifying the 'user_pass'</span>&nbsp;</div></li><li><div><span class="comment"> * value in the $userdata parameter array.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If current user's password is being updated, then the cookies will be</span>&nbsp;</div></li><li><div><span class="comment"> * cleared.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see wp_insert_user() For what fields can be set in $userdata.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $userdata An array of user data or a user object of type stdClass or WP_User.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error The updated user's ID or a WP_Error object if the user could not be updated.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_update_user($userdata) {&nbsp;</div></li><li><div>  if ( $userdata instanceof stdClass ) {&nbsp;</div></li><li><div>      $userdata = get_object_vars( $userdata );&nbsp;</div></li><li><div>  } elseif ( $userdata instanceof WP_User ) {&nbsp;</div></li><li><div>      $userdata = $userdata-&gt;to_array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ID = isset( $userdata['ID'] ) ? (int) $userdata['ID'] : 0;&nbsp;</div></li><li><div>  if ( ! $ID ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_user_id', __( 'Invalid user ID.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// First, get all of the original fields</span>&nbsp;</div></li><li><div>  $user_obj = get_userdata( $ID );&nbsp;</div></li><li><div>  if ( ! $user_obj ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_user_id', __( 'Invalid user ID.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = $user_obj-&gt;to_array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add additional custom fields</span>&nbsp;</div></li><li><div>  foreach ( _get_additional_user_keys( $user_obj ) as $key ) {&nbsp;</div></li><li><div>      $user[ $key ] = get_user_meta( $ID, $key, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Escape data pulled from DB.</span>&nbsp;</div></li><li><div>  $user = add_magic_quotes( $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $userdata['user_pass'] ) && $userdata['user_pass'] !== $user_obj-&gt;user_pass ) {&nbsp;</div></li><li><div>      <span class="comment">// If password is changing, hash it now</span>&nbsp;</div></li><li><div>      $plaintext_pass = $userdata['user_pass'];&nbsp;</div></li><li><div>      $userdata['user_pass'] = wp_hash_password( $userdata['user_pass'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters whether to send the password change email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see wp_insert_user() For `$user` and `$userdata` fields.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool  $send     Whether to send the email.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $user     The original user array.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $userdata The updated user array.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $send_password_change_email = apply_filters( 'send_password_change_email', true, $user, $userdata );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $userdata['user_email'] ) && $user['user_email'] !== $userdata['user_email'] ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters whether to send the email change email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see wp_insert_user() For `$user` and `$userdata` fields.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool  $send     Whether to send the email.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $user     The original user array.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $userdata The updated user array.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $send_email_change_email = apply_filters( 'send_email_change_email', true, $user, $userdata );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( $user['user_email'], 'useremail' );&nbsp;</div></li><li><div>  wp_cache_delete( $user['user_nicename'], 'userslugs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Merge old and new fields with new fields overwriting old ones.</span>&nbsp;</div></li><li><div>  $userdata = array_merge( $user, $userdata );&nbsp;</div></li><li><div>  $user_id = wp_insert_user( $userdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $blog_name = wp_specialchars_decode( get_option( 'blogname' ), ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $send_password_change_email ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** translators: Do not translate USERNAME, ADMIN_EMAIL, EMAIL, SITENAME, SITEURL: those are placeholders. */</span></span>&nbsp;</div></li><li><div>          $pass_change_text = __( 'Hi ###USERNAME###, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>This notice confirms that your password was changed on ###SITENAME###.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>If you did not change your password, please contact the Site Administrator at&nbsp;</div></li><li><div>###ADMIN_EMAIL###&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>This email has been sent to ###EMAIL###&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Regards, &nbsp;</div></li><li><div>All at ###SITENAME###&nbsp;</div></li><li><div>###SITEURL###' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $pass_change_email = array(&nbsp;</div></li><li><div>              'to' =&gt; $user['user_email'], &nbsp;</div></li><li><div>              'subject' =&gt; __( '[%s] Notice of Password Change' ), &nbsp;</div></li><li><div>              'message' =&gt; $pass_change_text, &nbsp;</div></li><li><div>              'headers' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the contents of the email sent when the user's password is changed.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $pass_change_email {</span>&nbsp;</div></li><li><div><span class="comment">           *            Used to build wp_mail().</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $to      The intended recipients. Add emails in a comma separated string.</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $subject The subject of the email.</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $message The content of the email.</span>&nbsp;</div></li><li><div><span class="comment">           *                The following strings have a special meaning and will get replaced dynamically:</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###USERNAME###    The current user's username.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###ADMIN_EMAIL### The admin email in case this was unexpected.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###EMAIL###       The old email.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###SITENAME###    The name of the site.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###SITEURL###     The URL to the site.</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $headers Headers. Add headers in a newline (\r\n) separated string.</span>&nbsp;</div></li><li><div><span class="comment">           *        }</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $user     The original user array.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $userdata The updated user array.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $pass_change_email = apply_filters( 'password_change_email', $pass_change_email, $user, $userdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $pass_change_email['message'] = str_replace( '###USERNAME###', $user['user_login'], $pass_change_email['message'] );&nbsp;</div></li><li><div>          $pass_change_email['message'] = str_replace( '###ADMIN_EMAIL###', get_option( 'admin_email' ), $pass_change_email['message'] );&nbsp;</div></li><li><div>          $pass_change_email['message'] = str_replace( '###EMAIL###', $user['user_email'], $pass_change_email['message'] );&nbsp;</div></li><li><div>          $pass_change_email['message'] = str_replace( '###SITENAME###', $blog_name, $pass_change_email['message'] );&nbsp;</div></li><li><div>          $pass_change_email['message'] = str_replace( '###SITEURL###', home_url(), $pass_change_email['message'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_mail( $pass_change_email['to'], sprintf( $pass_change_email['subject'], $blog_name ), $pass_change_email['message'], $pass_change_email['headers'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $send_email_change_email ) ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** translators: Do not translate USERNAME, ADMIN_EMAIL, EMAIL, SITENAME, SITEURL: those are placeholders. */</span></span>&nbsp;</div></li><li><div>          $email_change_text = __( 'Hi ###USERNAME###, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>This notice confirms that your email was changed on ###SITENAME###.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>If you did not change your email, please contact the Site Administrator at&nbsp;</div></li><li><div>###ADMIN_EMAIL###&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>This email has been sent to ###EMAIL###&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Regards, &nbsp;</div></li><li><div>All at ###SITENAME###&nbsp;</div></li><li><div>###SITEURL###' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $email_change_email = array(&nbsp;</div></li><li><div>              'to' =&gt; $user['user_email'], &nbsp;</div></li><li><div>              'subject' =&gt; __( '[%s] Notice of Email Change' ), &nbsp;</div></li><li><div>              'message' =&gt; $email_change_text, &nbsp;</div></li><li><div>              'headers' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the contents of the email sent when the user's email is changed.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $email_change_email {</span>&nbsp;</div></li><li><div><span class="comment">           *            Used to build wp_mail().</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $to      The intended recipients.</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $subject The subject of the email.</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $message The content of the email.</span>&nbsp;</div></li><li><div><span class="comment">           *                The following strings have a special meaning and will get replaced dynamically:</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###USERNAME###    The current user's username.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###ADMIN_EMAIL### The admin email in case this was unexpected.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###EMAIL###       The old email.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###SITENAME###    The name of the site.</span>&nbsp;</div></li><li><div><span class="comment">           *                - ###SITEURL###     The URL to the site.</span>&nbsp;</div></li><li><div><span class="comment">           *            @type string $headers Headers.</span>&nbsp;</div></li><li><div><span class="comment">           *        }</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $user The original user array.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $userdata The updated user array.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $email_change_email = apply_filters( 'email_change_email', $email_change_email, $user, $userdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $email_change_email['message'] = str_replace( '###USERNAME###', $user['user_login'], $email_change_email['message'] );&nbsp;</div></li><li><div>          $email_change_email['message'] = str_replace( '###ADMIN_EMAIL###', get_option( 'admin_email' ), $email_change_email['message'] );&nbsp;</div></li><li><div>          $email_change_email['message'] = str_replace( '###EMAIL###', $user['user_email'], $email_change_email['message'] );&nbsp;</div></li><li><div>          $email_change_email['message'] = str_replace( '###SITENAME###', $blog_name, $email_change_email['message'] );&nbsp;</div></li><li><div>          $email_change_email['message'] = str_replace( '###SITEURL###', home_url(), $email_change_email['message'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_mail( $email_change_email['to'], sprintf( $email_change_email['subject'], $blog_name ), $email_change_email['message'], $email_change_email['headers'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the cookies if the password changed.</span>&nbsp;</div></li><li><div>  $current_user = wp_get_current_user();&nbsp;</div></li><li><div>  if ( $current_user-&gt;ID == $ID ) {&nbsp;</div></li><li><div>      if ( isset($plaintext_pass) ) {&nbsp;</div></li><li><div>          wp_clear_auth_cookie();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Here we calculate the expiration length of the current auth cookie and compare it to the default expiration.</span>&nbsp;</div></li><li><div>          <span class="comment">// If it's greater than this, then we know the user checked 'Remember Me' when they logged in.</span>&nbsp;</div></li><li><div>          $logged_in_cookie = wp_parse_auth_cookie( '', 'logged_in' );&nbsp;</div></li><li><div>          <span class="comment">/** This filter is documented in wp-includes/pluggable.php */</span>&nbsp;</div></li><li><div>          $default_cookie_life = apply_filters( 'auth_cookie_expiration', ( 2 * DAY_IN_SECONDS ), $ID, false );&nbsp;</div></li><li><div>          $remember = ( ( $logged_in_cookie['expiration'] - time() ) &gt; $default_cookie_life );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_set_auth_cookie( $ID, $remember );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A simpler way of inserting a user into the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a new user with just the username, password, and email. For more</span>&nbsp;</div></li><li><div><span class="comment"> * complex user creation use wp_insert_user() to specify more information.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @see wp_insert_user() More complete way to create a new user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $username The user's username.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $password The user's password.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $email    Optional. The user's email. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error The newly created user's ID or a WP_Error object if the user could not</span>&nbsp;</div></li><li><div><span class="comment"> *                      be created.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_create_user($username, $password, $email = '') {&nbsp;</div></li><li><div>  $user_login = wp_slash( $username );&nbsp;</div></li><li><div>  $user_email = wp_slash( $email );&nbsp;</div></li><li><div>  $user_pass = $password;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $userdata = compact('user_login', 'user_email', 'user_pass');&nbsp;</div></li><li><div>  return wp_insert_user($userdata);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns a list of meta keys to be (maybe) populated in wp_update_user().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The list of keys returned via this function are dependent on the presence</span>&nbsp;</div></li><li><div><span class="comment"> * of those keys in the user meta data to be set.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User $user WP_User instance.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of user keys to be populated in wp_update_user().</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _get_additional_user_keys( $user ) {&nbsp;</div></li><li><div>  $keys = array( 'first_name', 'last_name', 'nickname', 'description', 'rich_editing', 'comment_shortcuts', 'admin_color', 'use_ssl', 'show_admin_bar_front' );&nbsp;</div></li><li><div>  return array_merge( $keys, array_keys( wp_get_user_contact_methods( $user ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set up the user contact methods.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Default contact methods were removed in 3.6. A filter dictates contact methods.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User $user Optional. WP_User object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array of contact methods and their labels.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_get_user_contact_methods( $user = null ) {&nbsp;</div></li><li><div>  $methods = array();&nbsp;</div></li><li><div>  if ( get_site_option( 'initial_db_version' ) &lt; 23588 ) {&nbsp;</div></li><li><div>      $methods = array(&nbsp;</div></li><li><div>          'aim' =&gt; __( 'AIM' ), &nbsp;</div></li><li><div>          'yim' =&gt; __( 'Yahoo IM' ), &nbsp;</div></li><li><div>          'jabber' =&gt; __( 'Jabber / Google Talk' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the user contact methods.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $methods Array of contact methods and their labels.</span>&nbsp;</div></li><li><div><span class="comment">    * @param WP_User $user    WP_User object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'user_contactmethods', $methods, $user );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The old private function for setting up user contact methods.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Use wp_get_user_contact_methods() instead.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User $user Optional. WP_User object. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array of contact methods and their labels.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wp_get_user_contactmethods( $user = null ) {&nbsp;</div></li><li><div>  return wp_get_user_contact_methods( $user );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the text suggesting how to create strong passwords.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The password hint text.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_get_password_hint() {&nbsp;</div></li><li><div>  $hint = __( 'Hint: The password should be at least twelve characters long. To make it stronger, use upper and lower case letters, numbers, and symbols like ! &quot; ? $ % ^ &amp; ).' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the text describing the site's password complexity policy.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $hint The password hint text.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'password_hint', $hint );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates, stores, then returns a password reset key for user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb         $wpdb      WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> * @global PasswordHash $wp_hasher Portable PHP password hashing framework.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User $user User to retrieve password reset key for.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|WP_Error Password reset key on success. WP_Error on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_password_reset_key( $user ) {&nbsp;</div></li><li><div>  global $wpdb, $wp_hasher;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before a new password is retrieved.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Use the {@see 'retrieve_password'} hook instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 1.5.1 Misspelled. Use 'retrieve_password' hook instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_login The user login name.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'retreive_password', $user-&gt;user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before a new password is retrieved.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_login The user login name.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'retrieve_password', $user-&gt;user_login );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $allow = true;&nbsp;</div></li><li><div>  if ( is_multisite() && is_user_spammy( $user ) ) {&nbsp;</div></li><li><div>      $allow = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to allow a password to be reset.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $allow         Whether to allow the password to be reset. Default true.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $user_data-&gt;ID The ID of the user attempting to reset a password.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $allow = apply_filters( 'allow_password_reset', $allow, $user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $allow ) {&nbsp;</div></li><li><div>      return new WP_Error( 'no_password_reset', __( 'Password reset is not allowed for this user' ) );&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $allow ) ) {&nbsp;</div></li><li><div>      return $allow;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Generate something random for a password reset key.</span>&nbsp;</div></li><li><div>  $key = wp_generate_password( 20, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when a password reset key is generated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_login The username for the user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key        The generated password reset key.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'retrieve_password_key', $user-&gt;user_login, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Now insert the key, hashed, into the DB.</span>&nbsp;</div></li><li><div>  if ( empty( $wp_hasher ) ) {&nbsp;</div></li><li><div>      require_once ABSPATH . WPINC . '/class-phpass.php';&nbsp;</div></li><li><div>      $wp_hasher = new PasswordHash( 8, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $hashed = time() . ':' . $wp_hasher-&gt;HashPassword( $key );&nbsp;</div></li><li><div>  $key_saved = $wpdb-&gt;update( $wpdb-&gt;users, array( 'user_activation_key' =&gt; $hashed ), array( 'user_login' =&gt; $user-&gt;user_login ) );&nbsp;</div></li><li><div>  if ( false === $key_saved ) {&nbsp;</div></li><li><div>      return new WP_Error( 'no_password_key_update', __( 'Could not save password reset key to database.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $key;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves a user row based on password reset key and login</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * A key is considered 'expired' if it exactly matches the value of the</span>&nbsp;</div></li><li><div><span class="comment"> * user_activation_key field, rather than being matched after going through the</span>&nbsp;</div></li><li><div><span class="comment"> * hashing process. This field is now hashed; old values are no longer accepted</span>&nbsp;</div></li><li><div><span class="comment"> * but have a different WP_Error code so good user feedback can be provided.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb         $wpdb      WordPress database object for queries.</span>&nbsp;</div></li><li><div><span class="comment"> * @global PasswordHash $wp_hasher Portable PHP password hashing framework instance.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key       Hash to validate sending user's password.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $login     The user login.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User|WP_Error WP_User object on success, WP_Error object for invalid or expired keys.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function check_password_reset_key($key, $login) {&nbsp;</div></li><li><div>  global $wpdb, $wp_hasher;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $key = preg_replace('/[^a-z0-9]/i', '', $key);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $key ) || !is_string( $key ) )&nbsp;</div></li><li><div>      return new WP_Error('invalid_key', __('Invalid key'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($login) || !is_string($login) )&nbsp;</div></li><li><div>      return new WP_Error('invalid_key', __('Invalid key'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $row = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT ID, user_activation_key FROM $wpdb-&gt;users WHERE user_login = %s&quot;, $login ) );&nbsp;</div></li><li><div>  if ( ! $row )&nbsp;</div></li><li><div>      return new WP_Error('invalid_key', __('Invalid key'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $wp_hasher ) ) {&nbsp;</div></li><li><div>      require_once ABSPATH . WPINC . '/class-phpass.php';&nbsp;</div></li><li><div>      $wp_hasher = new PasswordHash( 8, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the expiration time of password reset keys.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $expiration The expiration time in seconds.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $expiration_duration = apply_filters( 'password_reset_expiration', DAY_IN_SECONDS );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== strpos( $row-&gt;user_activation_key, ':' ) ) {&nbsp;</div></li><li><div>      list( $pass_request_time, $pass_key ) = explode( ':', $row-&gt;user_activation_key, 2 );&nbsp;</div></li><li><div>      $expiration_time = $pass_request_time + $expiration_duration;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $pass_key = $row-&gt;user_activation_key;&nbsp;</div></li><li><div>      $expiration_time = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $pass_key ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_key', __( 'Invalid key' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $hash_is_correct = $wp_hasher-&gt;CheckPassword( $key, $pass_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $hash_is_correct && $expiration_time && time() &lt; $expiration_time ) {&nbsp;</div></li><li><div>      return get_userdata( $row-&gt;ID );&nbsp;</div></li><li><div>  } elseif ( $hash_is_correct && $expiration_time ) {&nbsp;</div></li><li><div>      <span class="comment">// Key has an expiration time that's passed</span>&nbsp;</div></li><li><div>      return new WP_Error( 'expired_key', __( 'Invalid key' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( hash_equals( $row-&gt;user_activation_key, $key ) || ( $hash_is_correct && ! $expiration_time ) ) {&nbsp;</div></li><li><div>      $return = new WP_Error( 'expired_key', __( 'Invalid key' ) );&nbsp;</div></li><li><div>      $user_id = $row-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the return value of check_password_reset_key() when an</span>&nbsp;</div></li><li><div><span class="comment">       * old-style key is used.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0 Previously plain-text keys were stored in the database.</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.3.0 Previously key hashes were stored without an expiration time.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_Error $return  A WP_Error object denoting an expired key.</span>&nbsp;</div></li><li><div><span class="comment">       *                          Return a WP_User object to validate the key.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int      $user_id The matched user ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters( 'password_reset_key_expired', $return, $user_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return new WP_Error( 'invalid_key', __( 'Invalid key' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles resetting the user's password.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $user     The user</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $new_pass New password for the user in plaintext</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function reset_password( $user, $new_pass ) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before the user's password is reset.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $user     The user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $new_pass New user password.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'password_reset', $user, $new_pass );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_password( $new_pass, $user-&gt;ID );&nbsp;</div></li><li><div>  update_user_option( $user-&gt;ID, 'default_password_nag', false, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the user's password is reset.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $user     The user.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $new_pass New user password.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'after_password_reset', $user, $new_pass );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles registering a new user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_login User's username for logging in</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email User's email address to send password and add</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error Either user's ID or error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function register_new_user( $user_login, $user_email ) {&nbsp;</div></li><li><div>  $errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sanitized_user_login = sanitize_user( $user_login );&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the email address of a user being registered.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_email The email address of the new user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_email = apply_filters( 'user_registration_email', $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the username</span>&nbsp;</div></li><li><div>  if ( $sanitized_user_login == '' ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'empty_username', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Please enter a username.' ) );&nbsp;</div></li><li><div>  } elseif ( ! validate_username( $user_login ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'invalid_username', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This username is invalid because it uses illegal characters. Please enter a valid username.' ) );&nbsp;</div></li><li><div>      $sanitized_user_login = '';&nbsp;</div></li><li><div>  } elseif ( username_exists( $sanitized_user_login ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'username_exists', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This username is already registered. Please choose another one.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** This filter is documented in wp-includes/user.php */</span></span>&nbsp;</div></li><li><div>      $illegal_user_logins = array_map( 'strtolower', (array) apply_filters( 'illegal_user_logins', array() ) );&nbsp;</div></li><li><div>      if ( in_array( strtolower( $sanitized_user_login ), $illegal_user_logins ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add( 'invalid_username', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Sorry, that username is not allowed.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the email address</span>&nbsp;</div></li><li><div>  if ( $user_email == '' ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'empty_email', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Please type your email address.' ) );&nbsp;</div></li><li><div>  } elseif ( ! is_email( $user_email ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'invalid_email', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: The email address isn&#8217;t correct.' ) );&nbsp;</div></li><li><div>      $user_email = '';&nbsp;</div></li><li><div>  } elseif ( email_exists( $user_email ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'email_exists', __( '&lt;strong&gt;ERROR&lt;/strong&gt;: This email is already registered, please choose another one.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when submitting registration form data, before the user is created.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $sanitized_user_login The submitted username after being sanitized.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $user_email           The submitted email.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Error $errors               Contains any errors with submitted username and email, </span>&nbsp;</div></li><li><div><span class="comment">   *                                       e.g., an empty field, an invalid username or email, </span>&nbsp;</div></li><li><div><span class="comment">   *                                       or an existing username or email.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'register_post', $sanitized_user_login, $user_email, $errors );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the errors encountered when a new user is being registered.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The filtered WP_Error object may, for example, contain errors for an invalid</span>&nbsp;</div></li><li><div><span class="comment">   * or existing username or email address. A WP_Error object should always returned, </span>&nbsp;</div></li><li><div><span class="comment">   * but may or may not contain errors.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If any errors are present in $errors, this will abort the user's registration.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Error $errors               A WP_Error object containing any errors encountered</span>&nbsp;</div></li><li><div><span class="comment">   *                                       during registration.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $sanitized_user_login User's username after it has been sanitized.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $user_email           User's email.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $errors = apply_filters( 'registration_errors', $errors, $sanitized_user_login, $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $errors-&gt;get_error_code() )&nbsp;</div></li><li><div>      return $errors;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_pass = wp_generate_password( 12, false );&nbsp;</div></li><li><div>  $user_id = wp_create_user( $sanitized_user_login, $user_pass, $user_email );&nbsp;</div></li><li><div>  if ( ! $user_id || is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'registerfail', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: Couldn&#8217;t register you&hellip; please contact the &lt;a href=&quot;mailto:%s&quot;&gt;webmaster&lt;/a&gt; !' ), get_option( 'admin_email' ) ) );&nbsp;</div></li><li><div>      return $errors;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_user_option( $user_id, 'default_password_nag', true, true ); <span class="comment">//Set up the Password change nag.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a new user registration has been recorded.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id ID of the newly registered user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'register_new_user', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Initiates email notifications related to the creation of new users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Notifications are sent both to the site admin and to the newly created user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0 Converted the `$notify` parameter to accept 'user' for sending</span>&nbsp;</div></li><li><div><span class="comment"> *              notifications only to the user created.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id ID of the newly created user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $notify  Optional. Type of notification that should happen. Accepts 'admin'</span>&nbsp;</div></li><li><div><span class="comment"> *                        or an empty string (admin only), 'user', or 'both' (admin and user).</span>&nbsp;</div></li><li><div><span class="comment"> *                        Default 'both'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_send_new_user_notifications( $user_id, $notify = 'both' ) {&nbsp;</div></li><li><div>  wp_new_user_notification( $user_id, null, $notify );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the current session token from the logged_in cookie.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Token.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_get_session_token() {&nbsp;</div></li><li><div>  $cookie = wp_parse_auth_cookie( '', 'logged_in' );&nbsp;</div></li><li><div>  return ! empty( $cookie['token'] ) ? $cookie['token'] : '';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve a list of sessions for the current user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array of sessions.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_get_all_sessions() {&nbsp;</div></li><li><div>  $manager = WP_Session_Tokens::get_instance( get_current_user_id() );&nbsp;</div></li><li><div>  return $manager-&gt;get_all();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove the current session token from the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_destroy_current_session() {&nbsp;</div></li><li><div>  $token = wp_get_session_token();&nbsp;</div></li><li><div>  if ( $token ) {&nbsp;</div></li><li><div>      $manager = WP_Session_Tokens::get_instance( get_current_user_id() );&nbsp;</div></li><li><div>      $manager-&gt;destroy( $token );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove all but the current session token for the current user for the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_destroy_other_sessions() {&nbsp;</div></li><li><div>  $token = wp_get_session_token();&nbsp;</div></li><li><div>  if ( $token ) {&nbsp;</div></li><li><div>      $manager = WP_Session_Tokens::get_instance( get_current_user_id() );&nbsp;</div></li><li><div>      $manager-&gt;destroy_others( $token );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove all session tokens for the current user from the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_destroy_all_sessions() {&nbsp;</div></li><li><div>  $manager = WP_Session_Tokens::get_instance( get_current_user_id() );&nbsp;</div></li><li><div>  $manager-&gt;destroy_all();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the user IDs of all users with no role on this site.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function returns an empty array when used on Multisite.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array of user IDs.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_get_users_with_no_role() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $prefix = $wpdb-&gt;get_blog_prefix();&nbsp;</div></li><li><div>  $regex = implode( '|', wp_roles()-&gt;get_names() );&nbsp;</div></li><li><div>  $regex = preg_replace( '/[^a-zA-Z_\|-]/', '', $regex );&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>      SELECT user_id&nbsp;</div></li><li><div>      FROM $wpdb-&gt;usermeta&nbsp;</div></li><li><div>      WHERE meta_key = '{$prefix}capabilities'&nbsp;</div></li><li><div>      AND meta_value NOT REGEXP %s&nbsp;</div></li><li><div>  &quot;, $regex ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $users;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the current user object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Will set the current user, if the current user is not set. The current user</span>&nbsp;</div></li><li><div><span class="comment"> * will be set to the logged-in person. If no user is logged-in, then it will</span>&nbsp;</div></li><li><div><span class="comment"> * set the current user to 0, which is invalid and won't have any permissions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is used by the pluggable functions wp_get_current_user() and</span>&nbsp;</div></li><li><div><span class="comment"> * get_currentuserinfo(), the latter of which is deprecated but used for backward</span>&nbsp;</div></li><li><div><span class="comment"> * compatibility.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.5.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see wp_get_current_user()</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_User $current_user Checks if the current user is set.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_User Current WP_User instance.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wp_get_current_user() {&nbsp;</div></li><li><div>  global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $current_user ) ) {&nbsp;</div></li><li><div>      if ( $current_user instanceof WP_User ) {&nbsp;</div></li><li><div>          return $current_user;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Upgrade stdClass to WP_User</span>&nbsp;</div></li><li><div>      if ( is_object( $current_user ) && isset( $current_user-&gt;ID ) ) {&nbsp;</div></li><li><div>          $cur_id = $current_user-&gt;ID;&nbsp;</div></li><li><div>          $current_user = null;&nbsp;</div></li><li><div>          wp_set_current_user( $cur_id );&nbsp;</div></li><li><div>          return $current_user;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $current_user has a junk value. Force to WP_User with ID 0.</span>&nbsp;</div></li><li><div>      $current_user = null;&nbsp;</div></li><li><div>      wp_set_current_user( 0 );&nbsp;</div></li><li><div>      return $current_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( defined('XMLRPC_REQUEST') && XMLRPC_REQUEST ) {&nbsp;</div></li><li><div>      wp_set_current_user( 0 );&nbsp;</div></li><li><div>      return $current_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the current user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The default filters use this to determine the current user from the</span>&nbsp;</div></li><li><div><span class="comment">   * request's cookies, if available.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Returning a value of false will effectively short-circuit setting</span>&nbsp;</div></li><li><div><span class="comment">   * the current user.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|bool $user_id User ID if one has been determined, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_id = apply_filters( 'determine_current_user', false );&nbsp;</div></li><li><div>  if ( ! $user_id ) {&nbsp;</div></li><li><div>      wp_set_current_user( 0 );&nbsp;</div></li><li><div>      return $current_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_current_user( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $current_user;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-include</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>