<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="wordpress" data-id="72792"><head xmlns="http://www.w3.org/1999/xhtml"><title> gfcommon | class | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="GFCommon, class, plugin, gravity-forms, 1.9.14.22" /><meta name="description" content="The WordPress Core GFCommon class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=fc9bdcc59a963103b4fb5332b7b27ab8' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/gfcommon/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfcommon%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfcommon%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-1.9.14.22-class-gfcommon","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gfcommon" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms." href="http://hookr.io/plugins/gravity-forms/" class="plugin"><span property="name">gravity-forms</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.14.22." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/" class="H_VERSION"><span property="name">1.9.14.22</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gfcommon</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="0"><a href="http://hookr.io/1.9.14.22/all/" title="All">All <span class="count badge">0</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/1.9.14.22/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="0"><a href="http://hookr.io/1.9.14.22/hooks/" title="Hooks">Hooks <span class="count badge">0</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/1.9.14.22/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="0"><a href="http://hookr.io/1.9.14.22/filters/" title="Filters">Filters <span class="count badge">0</span></a></li><li class="active" data-id="class" data-count="0"><a href="http://hookr.io/1.9.14.22/classes/" title="Classes">Classes <span class="count badge">0</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/1.9.14.22/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/1.9.14.22/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/1.9.14.22/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>GFCommon</strong></h1><p>The WordPress Core <strong>GFCommon</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/files/common/" class="file">/common.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="6" class="block" start="6"><li><div>class GFCommon {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // deprecated; set to GFForms::$version in GFForms::init() for backwards compat&nbsp;</div></li><li><div>    public static $version = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static $tab_index = 1;&nbsp;</div></li><li><div>    public static $errors = array();&nbsp;</div></li><li><div>    public static $messages = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_selection_fields( $form, $selected_field_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $str = '';&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>            $field_label = RGFormsModel::get_label( $field );&nbsp;</div></li><li><div>            if ( $input_type == 'checkbox' || $input_type == 'radio' || $input_type == 'select' ) {&nbsp;</div></li><li><div>                $selected = $field-&gt;id == $selected_field_id ? &quot;selected='selected'&quot; : '';&nbsp;</div></li><li><div>                $str .= &quot;&lt;option value='&quot; . $field-&gt;id . &quot;' &quot; . $selected . '&gt;' . $field_label . '&lt;/option&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_numeric( $value, $number_format = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $number_format == 'currency' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $number_format = self::is_currency_decimal_dot() ? 'decimal_dot' : 'decimal_comma';&nbsp;</div></li><li><div>            $value = self::remove_currency_symbol( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $number_format ) {&nbsp;</div></li><li><div>            case 'decimal_dot' :&nbsp;</div></li><li><div>                return preg_match( &quot;/^(-?[0-9]{1, 3}(?:, ?[0-9]{3})*(?:\.[0-9]+)?)$/&quot;, $value );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'decimal_comma' :&nbsp;</div></li><li><div>                return preg_match( &quot;/^(-?[0-9]{1, 3}(?:\.?[0-9]{3})*(?:, [0-9]+)?)$/&quot;, $value );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                return preg_match( &quot;/^(-?[0-9]{1, 3}(?:, ?[0-9]{3})*(?:\.[0-9]{2})?)$/&quot;, $value ) || preg_match( &quot;/^(-?[0-9]{1, 3}(?:\.?[0-9]{3})*(?:, [0-9]{2})?)$/&quot;, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function remove_currency_symbol( $value, $currency = null ) {&nbsp;</div></li><li><div>        if ( $currency == null ) {&nbsp;</div></li><li><div>            $code = GFCommon::get_currency();&nbsp;</div></li><li><div>            if ( empty( $code ) ) {&nbsp;</div></li><li><div>                $code = 'USD';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $currency = RGCurrency::get_currency( $code );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = str_replace( $currency['symbol_left'], '', $value );&nbsp;</div></li><li><div>        $value = str_replace( $currency['symbol_right'], '', $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //some symbols can't be easily matched up, so this will catch any of them&nbsp;</div></li><li><div>        $value = preg_replace( '/[^, .\d]/', '', $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_currency_decimal_dot( $currency = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $currency == null ) {&nbsp;</div></li><li><div>            $code = GFCommon::get_currency();&nbsp;</div></li><li><div>            if ( empty( $code ) ) {&nbsp;</div></li><li><div>                $code = 'USD';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $currency = RGCurrency::get_currency( $code );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return rgar( $currency, 'decimal_separator' ) == '.';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function trim_all( $text ) {&nbsp;</div></li><li><div>        $text = trim( $text );&nbsp;</div></li><li><div>        do {&nbsp;</div></li><li><div>            $prev_text = $text;&nbsp;</div></li><li><div>            $text = str_replace( '  ', ' ', $text );&nbsp;</div></li><li><div>        } while ( $text != $prev_text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function format_number( $number, $number_format, $currency = '', $include_thousands_sep = false ) {&nbsp;</div></li><li><div>        if ( ! is_numeric( $number ) ) {&nbsp;</div></li><li><div>            return $number;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //replacing commas with dots and dots with commas&nbsp;</div></li><li><div>        if ( $number_format == 'currency' ) {&nbsp;</div></li><li><div>            if ( empty( $currency ) ) {&nbsp;</div></li><li><div>                $currency = GFCommon::get_currency();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( false === class_exists( 'RGCurrency' ) ) {&nbsp;</div></li><li><div>                require_once( GFCommon::get_base_path() . '/currency.php' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $currency = new RGCurrency( $currency );&nbsp;</div></li><li><div>            $number = $currency-&gt;to_money( $number );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( $number_format == 'decimal_comma' ) {&nbsp;</div></li><li><div>                $dec_point = ', ';&nbsp;</div></li><li><div>                $thousands_sep = $include_thousands_sep ? '.' : '';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $dec_point = '.';&nbsp;</div></li><li><div>                $thousands_sep = $include_thousands_sep ? ', ' : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_negative = $number &lt; 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $number = explode( '.', $number );&nbsp;</div></li><li><div>            $number[0] = number_format( absint( $number[0] ), 0, '', $thousands_sep );&nbsp;</div></li><li><div>            $number = implode( $dec_point, $number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $is_negative ) {&nbsp;</div></li><li><div>                $number = '-' . $number;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function recursive_add_index_file( $dir ) {&nbsp;</div></li><li><div>        if ( ! is_dir( $dir ) || is_link( $dir ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! ( $dp = opendir( $dir ) ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //ignores all errors&nbsp;</div></li><li><div>        set_error_handler( create_function( '', 'return 0;' ), E_ALL );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creates an empty index.html file&nbsp;</div></li><li><div>        if ( $f = fopen( $dir . '/index.html', 'w' ) ) {&nbsp;</div></li><li><div>            fclose( $f );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //restores error handler&nbsp;</div></li><li><div>        restore_error_handler();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        while ( ( false !== $file = readdir( $dp ) ) ) {&nbsp;</div></li><li><div>            if ( is_dir( &quot;$dir/$file&quot; ) && $file != '.' && $file != '..' ) {&nbsp;</div></li><li><div>                self::recursive_add_index_file( &quot;$dir/$file&quot; );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        closedir( $dp );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_htaccess_file() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $upload_root = GFFormsModel::get_upload_root();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_dir( $upload_root ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $htaccess_file = $upload_root . '/.htaccess';&nbsp;</div></li><li><div>        if ( file_exists( $htaccess_file ) ) {&nbsp;</div></li><li><div>            unlink($htaccess_file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $txt= '# Disable parsing of PHP for some server configurations. This file may be removed or modified on certain server configurations by using by the gform_upload_root_htaccess_rules filter. Please consult your system administrator before removing this file.&nbsp;</div></li><li><div>&lt;Files *&gt;&nbsp;</div></li><li><div>  SetHandler none&nbsp;</div></li><li><div>  SetHandler default-handler&nbsp;</div></li><li><div>  Options -ExecCGI&nbsp;</div></li><li><div>  RemoveHandler .cgi .php .php3 .php4 .php5 .phtml .pl .py .pyc .pyo&nbsp;</div></li><li><div>&lt;/Files&gt;&nbsp;</div></li><li><div>&lt;IfModule mod_php5.c&gt;&nbsp;</div></li><li><div>  php_flag engine off&nbsp;</div></li><li><div>&lt;/IfModule&gt;';&nbsp;</div></li><li><div>        $rules = explode( &quot;\n&quot;, $txt );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * A filter to allow the modification/disabling of parsing certain PHP within Gravity Forms&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param mixed $rules The Rules of what to parse or not to parse&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $rules = apply_filters( 'gform_upload_root_htaccess_rules', $rules );&nbsp;</div></li><li><div>        if ( ! empty( $rules ) ) {&nbsp;</div></li><li><div>            if ( ! function_exists( 'insert_with_markers' ) ) {&nbsp;</div></li><li><div>                require_once( ABSPATH . 'wp-admin/includes/misc.php' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            insert_with_markers( $htaccess_file, 'Gravity Forms', $rules );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function clean_number( $number, $number_format = '' ) {&nbsp;</div></li><li><div>        if ( rgblank( $number ) ) {&nbsp;</div></li><li><div>            return $number;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $decimal_char = '';&nbsp;</div></li><li><div>        if ( $number_format == 'decimal_dot' ) {&nbsp;</div></li><li><div>            $decimal_char = '.';&nbsp;</div></li><li><div>        } else if ( $number_format == 'decimal_comma' ) {&nbsp;</div></li><li><div>            $decimal_char = ', ';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $float_number = '';&nbsp;</div></li><li><div>        $clean_number = '';&nbsp;</div></li><li><div>        $is_negative = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Removing all non-numeric characters&nbsp;</div></li><li><div>        $array = str_split( $number );&nbsp;</div></li><li><div>        foreach ( $array as $char ) {&nbsp;</div></li><li><div>            if ( ( $char &gt;= '0' && $char &lt;= '9' ) || $char == ', ' || $char == '.' ) {&nbsp;</div></li><li><div>                $clean_number .= $char;&nbsp;</div></li><li><div>            } else if ( $char == '-' ) {&nbsp;</div></li><li><div>                $is_negative = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Removing thousand separators but keeping decimal point&nbsp;</div></li><li><div>        $array = str_split( $clean_number );&nbsp;</div></li><li><div>        for ( $i = 0, $count = sizeof( $array ); $i &lt; $count; $i ++ ) {&nbsp;</div></li><li><div>            $char = $array[ $i ];&nbsp;</div></li><li><div>            if ( $char &gt;= '0' && $char &lt;= '9' ) {&nbsp;</div></li><li><div>                $float_number .= $char;&nbsp;</div></li><li><div>            } else if ( empty( $decimal_char ) && ( $char == '.' || $char == ', ' ) && strlen( $clean_number ) - $i &lt;= 3 ) {&nbsp;</div></li><li><div>                $float_number .= '.';&nbsp;</div></li><li><div>            } else if ( $decimal_char == $char ) {&nbsp;</div></li><li><div>                $float_number .= '.';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_negative ) {&nbsp;</div></li><li><div>            $float_number = '-' . $float_number;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $float_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function json_encode( $value ) {&nbsp;</div></li><li><div>        return json_encode( $value );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function json_decode( $str, $is_assoc = true ) {&nbsp;</div></li><li><div>        return json_decode( $str, $is_assoc );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //Returns the url of the plugin's root folder&nbsp;</div></li><li><div>    public static function get_base_url() {&nbsp;</div></li><li><div>        return plugins_url( '', __FILE__ );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //Returns the physical path of the plugin's root folder&nbsp;</div></li><li><div>    public static function get_base_path() {&nbsp;</div></li><li><div>        return dirname( __FILE__ );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_email_fields( $form ) {&nbsp;</div></li><li><div>        $fields = array();&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'email' || $field-&gt;inputType == 'email' ) {&nbsp;</div></li><li><div>                $fields[] = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function truncate_middle( $text, $max_length ) {&nbsp;</div></li><li><div>        if ( strlen( $text ) &lt;= $max_length ) {&nbsp;</div></li><li><div>            return $text;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $middle = intval( $max_length / 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::safe_substr( $text, 0, $middle ) . '...' . self::safe_substr( $text, strlen( $text ) - $middle, $middle );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_invalid_or_empty_email( $email ) {&nbsp;</div></li><li><div>        return empty( $email ) || ! self::is_valid_email( $email );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_valid_url( $url ) {&nbsp;</div></li><li><div>        $url = trim( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ( ( strpos( $url, 'http://' ) === 0 || strpos( $url, 'https://' ) === 0 ) &&&nbsp;</div></li><li><div>            filter_var( $url, FILTER_VALIDATE_URL ) !== false );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_valid_email( $email ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return filter_var( $email, FILTER_VALIDATE_EMAIL );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_valid_email_list( $email_list ) {&nbsp;</div></li><li><div>        $emails = explode( ', ', $email_list );&nbsp;</div></li><li><div>        if ( ! is_array( $emails ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach( $emails as $email ) {&nbsp;</div></li><li><div>            if ( ! filter_var( $email, FILTER_VALIDATE_EMAIL ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_label( $field, $input_id = 0, $input_only = false, $allow_admin_label = true ) {&nbsp;</div></li><li><div>        return RGFormsModel::get_label( $field, $input_id, $input_only, $allow_admin_label );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_input( $field, $id ) {&nbsp;</div></li><li><div>        return RGFormsModel::get_input( $field, $id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function insert_variables( $fields, $element_id, $hide_all_fields = false, $callback = '', $onchange = '', $max_label_size = 40, $exclude = null, $args = '', $class_name = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $fields == null ) {&nbsp;</div></li><li><div>            $fields = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $exclude == null ) {&nbsp;</div></li><li><div>            $exclude = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $exclude = apply_filters( 'gform_merge_tag_list_exclude', $exclude, $element_id, $fields );&nbsp;</div></li><li><div>        $merge_tags = self::get_merge_tags( $fields, $element_id, $hide_all_fields, $exclude, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $onchange = empty( $onchange ) ? &quot;InsertVariable('{$element_id}', '{$callback}');&quot; : $onchange;&nbsp;</div></li><li><div>        $class = trim( $class_name . ' gform_merge_tags' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;select id=&quot;&lt;?php echo esc_attr( $element_id ); ?&gt;_variable_select&quot; onchange=&quot;&lt;?php echo $onchange ?&gt;&quot; class=&quot;&lt;?php echo esc_attr( $class ) ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;option value=''&gt;&lt;?php esc_html_e( 'Insert Merge Tag' , 'gravityforms' ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php foreach ( $merge_tags as $group =&gt; $group_tags ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $group_label = rgar( $group_tags, 'label' );&nbsp;</div></li><li><div>                $tags = rgar( $group_tags, 'tags' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( empty( $group_tags['tags'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $group_label ) {&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;optgroup label=&quot;&lt;?php echo $group_label; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php foreach ( $tags as $tag ) { ?&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;&lt;?php echo $tag['tag']; ?&gt;&quot;&gt;&lt;?php echo $tag['label']; ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $group_label ) {&nbsp;</div></li><li><div>                    ?&gt;&nbsp;</div></li><li><div>                    &lt;/optgroup&gt;&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This function is used by the gfMergeTags JS object to get the localized label for non-field merge tags as well as&nbsp;</div></li><li><div>     * for backwards compatibility with the gform_custom_merge_tags hook. Lastly, this plugin is used by the soon-to-be&nbsp;</div></li><li><div>     * deprecated insert_variables() function as the new gfMergeTags object has not yet been applied to the Post Content&nbsp;</div></li><li><div>     * Template setting.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param GF_Field[] $fields&nbsp;</div></li><li><div>     * @param            $element_id&nbsp;</div></li><li><div>     * @param bool       $hide_all_fields&nbsp;</div></li><li><div>     * @param array      $exclude_field_types&nbsp;</div></li><li><div>     * @param string     $option&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_merge_tags( $fields, $element_id, $hide_all_fields = false, $exclude_field_types = array(), $option = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $fields == null ) {&nbsp;</div></li><li><div>            $fields = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $exclude_field_types == null ) {&nbsp;</div></li><li><div>            $exclude_field_types = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $required_fields = $optional_fields = $pricing_fields = array();&nbsp;</div></li><li><div>        $ungrouped = $required_group = $optional_group = $pricing_group = $other_group = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $hide_all_fields ) {&nbsp;</div></li><li><div>            $ungrouped[] = array( 'tag' =&gt; '{all_fields}', 'label' =&gt; esc_html__( 'All Submitted Fields', 'gravityforms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // group fields by required, optional, and pricing&nbsp;</div></li><li><div>        foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;displayOnly ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // skip field types that should be excluded&nbsp;</div></li><li><div>            if ( is_array( $exclude_field_types ) && in_array( $input_type, $exclude_field_types ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;isRequired ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( $input_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'name' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $field-&gt;nameFormat == 'extended' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $prefix = GFCommon::get_input( $field, $field-&gt;id . '.2' );&nbsp;</div></li><li><div>                            $suffix = GFCommon::get_input( $field, $field-&gt;id . '.8' );&nbsp;</div></li><li><div>                            $optional_field = $field;&nbsp;</div></li><li><div>                            $optional_field['inputs'] = array( $prefix, $suffix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            //Add optional name fields to the optional list&nbsp;</div></li><li><div>                            $optional_fields[] = $optional_field;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            //Remove optional name field from required list&nbsp;</div></li><li><div>                            unset( $field-&gt;inputs[0] );&nbsp;</div></li><li><div>                            unset( $field-&gt;inputs[3] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $required_fields[] = $field;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $required_fields[] = $field;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $optional_fields[] = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( self::is_pricing_field( $field-&gt;type ) ) {&nbsp;</div></li><li><div>                $pricing_fields[] = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $required_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $required_fields as $field ) {&nbsp;</div></li><li><div>                $required_group = array_merge( $required_group, self::get_field_merge_tags( $field, $option ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $optional_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $optional_fields as $field ) {&nbsp;</div></li><li><div>                $optional_group = array_merge( $optional_group, self::get_field_merge_tags( $field, $option ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $pricing_fields ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $hide_all_fields ) {&nbsp;</div></li><li><div>                $pricing_group[] = array( 'tag' =&gt; '{pricing_fields}', 'label' =&gt; esc_html__( 'All Pricing Fields', 'gravityforms' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $pricing_fields as $field ) {&nbsp;</div></li><li><div>                $pricing_group = array_merge( $pricing_group, self::get_field_merge_tags( $field, $option ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{ip}', 'label' =&gt; esc_html__( 'User IP Address', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{date_mdy}', 'label' =&gt; esc_html__( 'Date', 'gravityforms' ) . ' (mm/dd/yyyy)' );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{date_dmy}', 'label' =&gt; esc_html__( 'Date', 'gravityforms' ) . ' (dd/mm/yyyy)' );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{embed_post:ID}', 'label' =&gt; esc_html__( 'Embed Post/Page Id', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{embed_post:post_title}', 'label' =&gt; esc_html__( 'Embed Post/Page Title', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{embed_url}', 'label' =&gt; esc_html__( 'Embed URL', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{entry_id}', 'label' =&gt; esc_html__( 'Entry Id', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{entry_url}', 'label' =&gt; esc_html__( 'Entry URL', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{form_id}', 'label' =&gt; esc_html__( 'Form Id', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{form_title}', 'label' =&gt; esc_html__( 'Form Title', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{user_agent}', 'label' =&gt; esc_html__( 'HTTP User Agent', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{referer}', 'label' =&gt; esc_html__( 'HTTP Referer URL', 'gravityforms' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_post_field( $fields ) ) {&nbsp;</div></li><li><div>            $other_group[] = array( 'tag' =&gt; '{post_id}', 'label' =&gt; esc_html__( 'Post Id', 'gravityforms' ) );&nbsp;</div></li><li><div>            $other_group[] = array( 'tag' =&gt; '{post_edit_url}', 'label' =&gt; esc_html__( 'Post Edit URL', 'gravityforms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{user:display_name}', 'label' =&gt; esc_html__( 'User Display Name', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{user:user_email}', 'label' =&gt; esc_html__( 'User Email', 'gravityforms' ) );&nbsp;</div></li><li><div>        $other_group[] = array( 'tag' =&gt; '{user:user_login}', 'label' =&gt; esc_html__( 'User Login', 'gravityforms' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = isset($fields[0]) ? $fields[0]-&gt;formId : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $custom_group = apply_filters( 'gform_custom_merge_tags', array(), $form_id, $fields, $element_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $merge_tags = array(&nbsp;</div></li><li><div>            'ungrouped' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; false, &nbsp;</div></li><li><div>                'tags' =&gt; $ungrouped, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'required' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; esc_html__( 'Required form fields', 'gravityforms' ), &nbsp;</div></li><li><div>                'tags' =&gt; $required_group, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'optional' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; esc_html__( 'Optional form fields', 'gravityforms' ), &nbsp;</div></li><li><div>                'tags' =&gt; $optional_group, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'pricing' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; esc_html__( 'Pricing form fields', 'gravityforms' ), &nbsp;</div></li><li><div>                'tags' =&gt; $pricing_group, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'other' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; esc_html__( 'Other', 'gravityforms' ), &nbsp;</div></li><li><div>                'tags' =&gt; $other_group, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'custom' =&gt; array(&nbsp;</div></li><li><div>                'label' =&gt; esc_html__( 'Custom', 'gravityforms' ), &nbsp;</div></li><li><div>                'tags' =&gt; $custom_group, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $merge_tags;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param string $option&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_field_merge_tags( $field, $option = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $merge_tags = array();&nbsp;</div></li><li><div>        $tag_args = RGFormsModel::get_input_type( $field ) == 'list' ? &quot;:{$option}&quot; : ''; //args currently only supported by list field&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( RGFormsModel::get_input_type( $field ) == 'checkbox' ) {&nbsp;</div></li><li><div>                $value = '{' . esc_html( GFCommon::get_label( $field, $field-&gt;id ) ) . ':' . $field-&gt;id . &quot;{$tag_args}}&quot;;&nbsp;</div></li><li><div>                $merge_tags[] = array(&nbsp;</div></li><li><div>                    'tag' =&gt; $value, &nbsp;</div></li><li><div>                    'label' =&gt; esc_html( GFCommon::get_label( $field, $field-&gt;id ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                if ( RGFormsModel::get_input_type( $field ) == 'creditcard' ) {&nbsp;</div></li><li><div>                    //only include the credit card type (field_id.4) and number (field_id.1)&nbsp;</div></li><li><div>                    if ( $input['id'] == $field['id'] . '.1' || $input['id'] == $field['id'] . '.4' ) {&nbsp;</div></li><li><div>                        $value = '{' . esc_html( GFCommon::get_label( $field, $input['id'] ) ) . ':' . $input['id'] . &quot;{$tag_args}}&quot;;&nbsp;</div></li><li><div>                        $merge_tags[] = array(&nbsp;</div></li><li><div>                            'tag' =&gt; $value, &nbsp;</div></li><li><div>                            'label' =&gt; esc_html( GFCommon::get_label( $field, $input['id'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $value = '{' . esc_html( GFCommon::get_label( $field, $input['id'] ) ) . ':' . $input['id'] . &quot;{$tag_args}}&quot;;&nbsp;</div></li><li><div>                    $merge_tags[] = array(&nbsp;</div></li><li><div>                        'tag' =&gt; $value, &nbsp;</div></li><li><div>                        'label' =&gt; esc_html( GFCommon::get_label( $field, $input['id'] ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $value = '{' . esc_html( GFCommon::get_label( $field ) ) . ':' . $field-&gt;id . &quot;{$tag_args}}&quot;;&nbsp;</div></li><li><div>            $merge_tags[] = array(&nbsp;</div></li><li><div>                'tag' =&gt; $value, &nbsp;</div></li><li><div>                'label' =&gt; esc_html( GFCommon::get_label( $field ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $merge_tags;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function insert_field_variable( $field, $max_label_size = 40, $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tag_args = RGFormsModel::get_input_type( $field ) == 'list' ? &quot;:{$args}&quot; : ''; //args currently only supported by list field&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>            if ( RGFormsModel::get_input_type( $field ) == 'checkbox' ) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;option value='&lt;?php echo '{' . esc_html( GFCommon::get_label( $field, $field-&gt;id ) ) . ':' . $field-&gt;id . &quot;{$tag_args}}&quot; ?&gt;'&gt;&lt;?php echo esc_html( GFCommon::get_label( $field, $field-&gt;id ) ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>                &lt;option value='&lt;?php echo '{' . esc_html( GFCommon::get_label( $field, $input['id'] ) ) . ':' . $input['id'] . &quot;{$tag_args}}&quot; ?&gt;'&gt;&lt;?php echo esc_html( GFCommon::get_label( $field, $input['id'] ) ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;option value='&lt;?php echo '{' . esc_html( GFCommon::get_label( $field ) ) . ':' . $field-&gt;id . &quot;{$tag_args}}&quot; ?&gt;'&gt;&lt;?php echo esc_html( GFCommon::get_label( $field ) ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function insert_post_content_variables( $fields, $element_id, $callback, $max_label_size = 25 ) {&nbsp;</div></li><li><div>        // TODO: replace with class-powered merge tags&nbsp;</div></li><li><div>        $insert_variables_onchange = sprintf( &quot;InsertPostContentVariable('%s', '%s');&quot;, esc_js( $element_id ), esc_js( $callback ) );&nbsp;</div></li><li><div>        self::insert_variables( $fields, $element_id, true, '', $insert_variables_onchange, $max_label_size, null, '', 'gform_content_template_merge_tags' );&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &nbsp;&nbsp;&nbsp;</div></li><li><div>        &lt;select id=&quot;&lt;?php echo $element_id ?&gt;_image_size_select&quot; onchange=&quot;InsertPostImageVariable('&lt;?php echo esc_js( $element_id ); ?&gt;', '&lt;?php echo esc_js( $element_id ); ?&gt;'); SetCustomFieldTemplate();&quot; style=&quot;display:none;&quot;&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;&quot;&gt;&lt;?php esc_html_e( 'Select image size' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;thumbnail&quot;&gt;&lt;?php esc_html_e( 'Thumbnail' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;thumbnail:left&quot;&gt;&lt;?php esc_html_e( 'Thumbnail - Left Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;thumbnail:center&quot;&gt;&lt;?php esc_html_e( 'Thumbnail - Centered' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;thumbnail:right&quot;&gt;&lt;?php esc_html_e( 'Thumbnail - Right Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;option value=&quot;medium&quot;&gt;&lt;?php esc_html_e( 'Medium' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;medium:left&quot;&gt;&lt;?php esc_html_e( 'Medium - Left Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;medium:center&quot;&gt;&lt;?php esc_html_e( 'Medium - Centered' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;medium:right&quot;&gt;&lt;?php esc_html_e( 'Medium - Right Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;option value=&quot;large&quot;&gt;&lt;?php esc_html_e( 'Large' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;large:left&quot;&gt;&lt;?php esc_html_e( 'Large - Left Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;large:center&quot;&gt;&lt;?php esc_html_e( 'Large - Centered' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;large:right&quot;&gt;&lt;?php esc_html_e( 'Large - Right Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;option value=&quot;full&quot;&gt;&lt;?php esc_html_e( 'Full Size' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;full:left&quot;&gt;&lt;?php esc_html_e( 'Full Size - Left Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;full:center&quot;&gt;&lt;?php esc_html_e( 'Full Size - Centered' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;option value=&quot;full:right&quot;&gt;&lt;?php esc_html_e( 'Full Size - Right Aligned' , 'gravityforms' ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>        &lt;/select&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function insert_calculation_variables( $fields, $element_id, $onchange = '', $callback = '', $max_label_size = 40 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $fields == null ) {&nbsp;</div></li><li><div>            $fields = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $onchange = empty( $onchange ) ? sprintf( &quot;InsertVariable('%s', '%s');&quot;, esc_js( $element_id ), esc_js( $callback ) ): $onchange;&nbsp;</div></li><li><div>        $class = 'gform_merge_tags';&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;select id=&quot;&lt;?php echo esc_attr( $element_id ); ?&gt;_variable_select&quot; onchange=&quot;&lt;?php echo $onchange ?&gt;&quot; class=&quot;&lt;?php echo esc_attr( $class ) ?&gt;&quot;&gt;&nbsp;</div></li><li><div>            &lt;option value=''&gt;&lt;?php esc_html_e( 'Insert Merge Tag' , 'gravityforms' ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>            &lt;optgroup label=&quot;&lt;?php esc_attr_e( 'Allowable form fields', 'gravityforms' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;?php&nbsp;</div></li><li><div>                foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! self::is_valid_for_calcuation( $field ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( RGFormsModel::get_input_type( $field ) == 'checkbox' ) {&nbsp;</div></li><li><div>                        foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;option value='&lt;?php echo esc_attr( '{' . esc_html( GFCommon::get_label( $field, $input['id'] ) ) . ':' . $input['id'] . '}' ); ?&gt;'&gt;&lt;?php echo esc_html( GFCommon::get_label( $field, $input['id'] ) ) ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        self::insert_field_variable( $field, $max_label_size );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/optgroup&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            $form_id = isset($forms[0]) ? $fields[0]-&gt;formId : 0;&nbsp;</div></li><li><div>            $custom_merge_tags = apply_filters( 'gform_custom_merge_tags', array(), $form_id, $fields, $element_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $custom_merge_tags ) && ! empty( $custom_merge_tags ) ) {&nbsp;</div></li><li><div>                ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;optgroup label=&quot;&lt;?php esc_attr_e( 'Custom' , 'gravityforms' ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;?php foreach ( $custom_merge_tags as $custom_merge_tag ) { ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        &lt;option value='&lt;?php echo esc_attr( rgar( $custom_merge_tag, 'tag' ) ); ?&gt;'&gt;&lt;?php echo esc_html( rgar( $custom_merge_tag, 'label' ) ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    &lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;/optgroup&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_post_image_variable( $media_id, $arg1, $arg2, $is_url = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_url ) {&nbsp;</div></li><li><div>            $image = wp_get_attachment_image_src( $media_id, $arg1 );&nbsp;</div></li><li><div>            if ( $image ) {&nbsp;</div></li><li><div>                list( $src, $width, $height ) = $image;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $src;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $arg1 ) {&nbsp;</div></li><li><div>            case 'title' :&nbsp;</div></li><li><div>                $media = get_post( $media_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $media-&gt;post_title;&nbsp;</div></li><li><div>            case 'caption' :&nbsp;</div></li><li><div>                $media = get_post( $media_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $media-&gt;post_excerpt;&nbsp;</div></li><li><div>            case 'description' :&nbsp;</div></li><li><div>                $media = get_post( $media_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $media-&gt;post_content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $img = wp_get_attachment_image( $media_id, $arg1, false, array( 'class' =&gt; &quot;size-{$arg1} align{$arg2} wp-image-{$media_id}&quot; ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $img;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function replace_variables_post_image( $text, $post_images, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        preg_match_all( '/{[^{]*?:(\d+)(:([^:]*?))?(:([^:]*?))?(:url)?}/mi', $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        if ( is_array( $matches ) ) {&nbsp;</div></li><li><div>            foreach ( $matches as $match ) {&nbsp;</div></li><li><div>                $input_id = $match[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //ignore fields that are not post images&nbsp;</div></li><li><div>                if ( ! isset( $post_images[ $input_id ] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //Reading alignment and 'url' parameters.&nbsp;</div></li><li><div>                //Format could be {image:5:medium:left:url} or {image:5:medium:url}&nbsp;</div></li><li><div>                $size_meta = empty( $match[3] ) ? 'full' : $match[3];&nbsp;</div></li><li><div>                $align = empty( $match[5] ) ? 'none' : $match[5];&nbsp;</div></li><li><div>                if ( $align == 'url' ) {&nbsp;</div></li><li><div>                    $align = 'none';&nbsp;</div></li><li><div>                    $is_url = true;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $is_url = rgar( $match, 6 ) == ':url';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $media_id = $post_images[ $input_id ];&nbsp;</div></li><li><div>                $value = is_wp_error( $media_id ) ? '' : self::get_post_image_variable( $media_id, $size_meta, $align, $is_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $text = str_replace( $match[0], $value, $text );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function implode_non_blank( $separator, $array ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $array ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ary = array();&nbsp;</div></li><li><div>        foreach ( $array as $item ) {&nbsp;</div></li><li><div>            if ( ! rgblank( $item ) ) {&nbsp;</div></li><li><div>                $ary[] = $item;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return implode( $separator, $ary );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function format_variable_value( $value, $url_encode, $esc_html, $format, $nl2br = true ) {&nbsp;</div></li><li><div>        if ( $esc_html ) {&nbsp;</div></li><li><div>            $value = esc_html( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $format == 'html' && $nl2br ) {&nbsp;</div></li><li><div>            $value = nl2br( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $url_encode ) {&nbsp;</div></li><li><div>            $value = urlencode( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function replace_variables( $text, $form, $lead, $url_encode = false, $esc_html = true, $nl2br = true, $format = 'html' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = $nl2br ? nl2br( $text ) : $text;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = apply_filters( 'gform_pre_replace_merge_tags', $text, $form, $lead, $url_encode, $esc_html, $nl2br, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strpos( $text, '{' ) === false ) {&nbsp;</div></li><li><div>            return $text;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Replacing conditional merge tag variables: [gravityforms action=&quot;conditional&quot; merge_tag=&quot;{Other Services:4}&quot; ....&nbsp;</div></li><li><div>        preg_match_all( '/merge_tag\s*=\s*[&quot;|\']({[^{]*?:(\d+(\.\d+)?)(:(.*?))?})[&quot;|\']/mi', $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        if ( is_array( $matches ) ) {&nbsp;</div></li><li><div>            foreach ( $matches as $match ) {&nbsp;</div></li><li><div>                $input_id = $match[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $text = self::replace_field_variable( $text, $form, $lead, $url_encode, $esc_html, $nl2br, $format, $input_id, $match, true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Replacing field variables: {FIELD_LABEL:FIELD_ID} {My Field:2}&nbsp;</div></li><li><div>        preg_match_all( '/{[^{]*?:(\d+(\.\d+)?)(:(.*?))?}/mi', $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        if ( is_array( $matches ) ) {&nbsp;</div></li><li><div>            foreach ( $matches as $match ) {&nbsp;</div></li><li><div>                $input_id = $match[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $text = self::replace_field_variable( $text, $form, $lead, $url_encode, $esc_html, $nl2br, $format, $input_id, $match );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //replacing global variables&nbsp;</div></li><li><div>        //form title&nbsp;</div></li><li><div>        $text = str_replace( '{form_title}', $url_encode ? urlencode( $form['title'] ) : $form['title'], $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $matches = array();&nbsp;</div></li><li><div>        preg_match_all( &quot;/{all_fields(:(.*?))?}/&quot;, $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        foreach ( $matches as $match ) {&nbsp;</div></li><li><div>            $options = explode( ', ', rgar( $match, 2 ) );&nbsp;</div></li><li><div>            $use_value = in_array( 'value', $options );&nbsp;</div></li><li><div>            $display_empty = in_array( 'empty', $options );&nbsp;</div></li><li><div>            $use_admin_label = in_array( 'admin', $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //all submitted fields using text&nbsp;</div></li><li><div>            if ( strpos( $text, $match[0] ) !== false ) {&nbsp;</div></li><li><div>                $text = str_replace( $match[0], self::get_submitted_fields( $form, $lead, $display_empty, ! $use_value, $format, $use_admin_label, 'all_fields', rgar( $match, 2 ) ), $text );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //all submitted fields including empty fields&nbsp;</div></li><li><div>        if ( strpos( $text, '{all_fields_display_empty}' ) !== false ) {&nbsp;</div></li><li><div>            $text = str_replace( '{all_fields_display_empty}', self::get_submitted_fields( $form, $lead, true, true, $format, false, 'all_fields_display_empty' ), $text );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //pricing fields&nbsp;</div></li><li><div>        $pricing_matches = array();&nbsp;</div></li><li><div>        preg_match_all( &quot;/{pricing_fields(:(.*?))?}/&quot;, $text, $pricing_matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        foreach ( $pricing_matches as $match ) {&nbsp;</div></li><li><div>            $options = explode( ', ', rgar( $match, 2 ) );&nbsp;</div></li><li><div>            $use_value = in_array( 'value', $options );&nbsp;</div></li><li><div>            $use_admin_label = in_array( 'admin', $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //all submitted pricing fields using text&nbsp;</div></li><li><div>            if ( strpos( $text, $match[0] ) !== false ) {&nbsp;</div></li><li><div>                $pricing_fields = self::get_submitted_pricing_fields( $form, $lead, $format, ! $use_value, $use_admin_label );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $format == 'html' ) {&nbsp;</div></li><li><div>                    $text = str_replace(&nbsp;</div></li><li><div>                        $match[0], '&lt;table width=&quot;99%&quot; border=&quot;0&quot; cellpadding=&quot;1&quot; cellspacing=&quot;0&quot; bgcolor=&quot;#EAEAEA&quot;&gt;&nbsp;</div></li><li><div>                                                               &lt;tr&gt;&lt;td&gt;&nbsp;</div></li><li><div>                                                                    &lt;table width=&quot;100%&quot; border=&quot;0&quot; cellpadding=&quot;5&quot; cellspacing=&quot;0&quot; bgcolor=&quot;#FFFFFF&quot;&gt;' .&nbsp;</div></li><li><div>                                            $pricing_fields .&nbsp;</div></li><li><div>                                            '&lt;/table&gt;&nbsp;</div></li><li><div>                                                               &lt;/tr&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                                         &lt;/table&gt;', &nbsp;</div></li><li><div>                        $text&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                else {&nbsp;</div></li><li><div>                    $text = str_replace( $match[0], $pricing_fields, $text );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //form id&nbsp;</div></li><li><div>        $text = str_replace( '{form_id}', $url_encode ? urlencode( $form['id'] ) : $form['id'], $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //entry id&nbsp;</div></li><li><div>        $text = str_replace( '{entry_id}', $url_encode ? urlencode( rgar( $lead, 'id' ) ) : rgar( $lead, 'id' ), $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //entry url&nbsp;</div></li><li><div>        $entry_url = get_bloginfo( 'wpurl' ) . '/wp-admin/admin.php?page=gf_entries&view=entry&id=' . $form['id'] . '&lid=' . rgar( $lead, 'id' );&nbsp;</div></li><li><div>        $text = str_replace( '{entry_url}', $url_encode ? urlencode( $entry_url ) : $entry_url, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //post id&nbsp;</div></li><li><div>        $text = str_replace( '{post_id}', $url_encode ? urlencode( rgar( $lead, 'post_id' ) ) : rgar( $lead, 'post_id' ), $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //admin email&nbsp;</div></li><li><div>        $wp_email = get_bloginfo( 'admin_email' );&nbsp;</div></li><li><div>        $text = str_replace( '{admin_email}', $url_encode ? urlencode( $wp_email ) : $wp_email, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //post edit url&nbsp;</div></li><li><div>        $post_url = get_bloginfo( 'wpurl' ) . '/wp-admin/post.php?action=edit&post=' . rgar( $lead, 'post_id' );&nbsp;</div></li><li><div>        $text = str_replace( '{post_edit_url}', $url_encode ? urlencode( $post_url ) : $post_url, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = self::replace_variables_prepopulate( $text, $url_encode, $lead, $esc_html, $form, $nl2br, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // TODO: Deprecate the 'gform_replace_merge_tags' and replace it with a call to the 'gform_merge_tag_filter'&nbsp;</div></li><li><div>        //$text = apply_filters('gform_merge_tag_filter', $text, false, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = self::decode_merge_tag( $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function encode_merge_tag( $text ) {&nbsp;</div></li><li><div>        return str_replace( '{', '&#x7b;', $text );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function decode_merge_tag( $text ) {&nbsp;</div></li><li><div>        return str_replace( '&#x7b;', '{', $text );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function format_post_category( $value, $use_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list( $item_value, $item_id ) = rgexplode( ':', $value, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_id && ! empty( $item_id ) ) {&nbsp;</div></li><li><div>            $item_value = $item_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $item_value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_embed_post() {&nbsp;</div></li><li><div>        global $embed_post, $post, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $embed_post ) {&nbsp;</div></li><li><div>            return $embed_post;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! rgempty( 'gform_embed_post' ) ) {&nbsp;</div></li><li><div>            $post_id = absint( rgpost( 'gform_embed_post' ) );&nbsp;</div></li><li><div>            $embed_post = get_post( $post_id );&nbsp;</div></li><li><div>        } else if ( $wp_query-&gt;is_in_loop ) {&nbsp;</div></li><li><div>            $embed_post = $post;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $embed_post = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_ul_classes( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $description_class = rgar( $form, 'descriptionPlacement' ) == 'above' ? 'description_above' : 'description_below';&nbsp;</div></li><li><div>        $sublabel_class = rgar( $form, 'subLabelPlacement' ) == 'above' ? 'form_sublabel_above' : 'form_sublabel_below';&nbsp;</div></li><li><div>        $label_class = rgempty( 'labelPlacement', $form ) ? 'top_label' : rgar( $form, 'labelPlacement' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $css_class = preg_replace( '/\s+/', ' ', &quot;gform_fields {$label_class} {$sublabel_class} {$description_class}&quot; ); //removing extra spaces&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $css_class;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function replace_variables_prepopulate( $text, $url_encode = false, $entry = false, $esc_html = false, $form = false, $nl2br = false, $format = 'html' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //embed url&nbsp;</div></li><li><div>        $current_page_url = RGFormsModel::get_current_page_url();&nbsp;</div></li><li><div>        if ( $esc_html ) {&nbsp;</div></li><li><div>            $current_page_url = esc_html( $current_page_url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $url_encode ) {&nbsp;</div></li><li><div>            $current_page_url = urlencode( $current_page_url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $text = str_replace( '{embed_url}', $current_page_url, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $local_timestamp = self::get_local_timestamp( time() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //date (mm/dd/yyyy)&nbsp;</div></li><li><div>        $local_date_mdy = date_i18n( 'm/d/Y', $local_timestamp, true );&nbsp;</div></li><li><div>        $text = str_replace( '{date_mdy}', $url_encode ? urlencode( $local_date_mdy ) : $local_date_mdy, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //date (dd/mm/yyyy)&nbsp;</div></li><li><div>        $local_date_dmy = date_i18n( 'd/m/Y', $local_timestamp, true );&nbsp;</div></li><li><div>        $text = str_replace( '{date_dmy}', $url_encode ? urlencode( $local_date_dmy ) : $local_date_dmy, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ip&nbsp;</div></li><li><div>        $ip = isset( $entry['ip'] ) ? $entry['ip'] : GFFormsModel::get_ip();&nbsp;</div></li><li><div>        $text = str_replace( '{ip}', $url_encode ? urlencode( $ip ) : $ip, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>        $post_array = self::object_to_array( $post );&nbsp;</div></li><li><div>        preg_match_all( &quot;/\{embed_post:(.*?)\}/&quot;, $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        foreach ( $matches as $match ) {&nbsp;</div></li><li><div>            $full_tag = $match[0];&nbsp;</div></li><li><div>            $property = $match[1];&nbsp;</div></li><li><div>            $text = str_replace( $full_tag, $url_encode ? urlencode( $post_array[ $property ] ) : $post_array[ $property ], $text );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //embed post custom fields&nbsp;</div></li><li><div>        preg_match_all( &quot;/\{custom_field:(.*?)\}/&quot;, $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        foreach ( $matches as $match ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $full_tag = $match[0];&nbsp;</div></li><li><div>            $custom_field_name = $match[1];&nbsp;</div></li><li><div>            $custom_field_value = ! empty( $post_array['ID'] ) ? get_post_meta( $post_array['ID'], $custom_field_name, true ) : '';&nbsp;</div></li><li><div>            $text = str_replace( $full_tag, $url_encode ? urlencode( $custom_field_value ) : $custom_field_value, $text );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //user agent&nbsp;</div></li><li><div>        $user_agent = RGForms::get( 'HTTP_USER_AGENT', $_SERVER );&nbsp;</div></li><li><div>        if ( $esc_html ) {&nbsp;</div></li><li><div>            $user_agent = esc_html( $user_agent );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $url_encode ) {&nbsp;</div></li><li><div>            $user_agent = urlencode( $user_agent );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $text = str_replace( '{user_agent}', $user_agent, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //referrer&nbsp;</div></li><li><div>        $referer = RGForms::get( 'HTTP_REFERER', $_SERVER );&nbsp;</div></li><li><div>        if ( $esc_html ) {&nbsp;</div></li><li><div>            $referer = esc_html( $referer );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $url_encode ) {&nbsp;</div></li><li><div>            $referer = urlencode( $referer );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $text = str_replace( '{referer}', $referer, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //logged in user info&nbsp;</div></li><li><div>        global $userdata, $wp_version, $current_user;&nbsp;</div></li><li><div>        $user_array = self::object_to_array( $userdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        preg_match_all( &quot;/\{user:(.*?)\}/&quot;, $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>        foreach ( $matches as $match ) {&nbsp;</div></li><li><div>            $full_tag = $match[0];&nbsp;</div></li><li><div>            $property = $match[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = version_compare( $wp_version, '3.3', '&gt;=' ) ? $current_user-&gt;get( $property ) : $user_array[ $property ];&nbsp;</div></li><li><div>            $value = $url_encode ? urlencode( $value ) : $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $text = str_replace( $full_tag, $value, $text );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allow the text to be filtered so custom merge tags can be replaced.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $text The text in which merge tags are being processed.&nbsp;</div></li><li><div>         * @param false|array $form The Form object if available or false.&nbsp;</div></li><li><div>         * @param false|array $entry The Entry object if available or false.&nbsp;</div></li><li><div>         * @param bool $url_encode Indicates if the urlencode function should be applied.&nbsp;</div></li><li><div>         * @param bool $esc_html Indicates if the esc_html function should be applied.&nbsp;</div></li><li><div>         * @param bool $nl2br Indicates if the nl2br function should be applied.&nbsp;</div></li><li><div>         * @param string $format The format requested for the location the merge is being used. Possible values: html, text or url.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $text = apply_filters( 'gform_replace_merge_tags', $text, $form, $entry, $url_encode, $esc_html, $nl2br, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function object_to_array( $object ) {&nbsp;</div></li><li><div>        $array = array();&nbsp;</div></li><li><div>        if ( ! empty( $object ) ) {&nbsp;</div></li><li><div>            foreach ( $object as $member =&gt; $data ) {&nbsp;</div></li><li><div>                $array[ $member ] = $data;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $array;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_empty_array( $val ) {&nbsp;</div></li><li><div>        if ( ! is_array( $val ) ) {&nbsp;</div></li><li><div>            $val = array( $val );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ary = array_values( $val );&nbsp;</div></li><li><div>        foreach ( $ary as $item ) {&nbsp;</div></li><li><div>            if ( ! rgblank( $item ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_submitted_fields( $form, $lead, $display_empty = false, $use_text = false, $format = 'html', $use_admin_label = false, $merge_tag = '', $options = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_data = '';&nbsp;</div></li><li><div>        if ( $format == 'html' ) {&nbsp;</div></li><li><div>            $field_data = '&lt;table width=&quot;99%&quot; border=&quot;0&quot; cellpadding=&quot;1&quot; cellspacing=&quot;0&quot; bgcolor=&quot;#EAEAEA&quot;&gt;&lt;tr&gt;&lt;td&gt;&nbsp;</div></li><li><div>                            &lt;table width=&quot;100%&quot; border=&quot;0&quot; cellpadding=&quot;5&quot; cellspacing=&quot;0&quot; bgcolor=&quot;#FFFFFF&quot;&gt;&nbsp;</div></li><li><div>                            ';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options_array = explode( ', ', $options );&nbsp;</div></li><li><div>        $no_admin = in_array( 'noadmin', $options_array );&nbsp;</div></li><li><div>        $no_hidden = in_array( 'nohidden', $options_array );&nbsp;</div></li><li><div>        $display_product_summary = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var GF_Field $field */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_value = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_label = $use_admin_label && ! empty( $field-&gt;adminLabel ) ? $field-&gt;adminLabel : esc_html( GFCommon::get_label( $field, 0, false, $use_admin_label ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $field-&gt;type ) {&nbsp;</div></li><li><div>                case 'captcha' :&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'section' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( GFFormsModel::is_field_hidden( $form, $field, array(), $lead ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ( ! GFCommon::is_section_empty( $field, $form, $lead ) || $display_empty ) && ! $field-&gt;adminOnly ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        switch ( $format ) {&nbsp;</div></li><li><div>                            case 'text' :&nbsp;</div></li><li><div>                                $field_value = &quot;--------------------------------\n{$field_label}\n\n&quot;;&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                                $field_value = sprintf(&nbsp;</div></li><li><div>                                    '&lt;tr&gt;&nbsp;</div></li><li><div>                                            &lt;td colspan=&quot;2&quot; style=&quot;font-size:14px; font-weight:bold; background-color:#EEE; border-bottom:1px solid #DFDFDF; padding:7px 7px&quot;&gt;%s&lt;/td&gt;&nbsp;</div></li><li><div>                                       &lt;/tr&gt;&nbsp;</div></li><li><div>                                       ', $field_label&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_value = apply_filters( 'gform_merge_tag_filter', $field_value, $merge_tag, $options, $field, $field_label );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_data .= $field_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'password' :&nbsp;</div></li><li><div>                    //ignore password fields&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( self::is_product_field( $field-&gt;type ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // ignore product fields as they will be grouped together at the end of the grid&nbsp;</div></li><li><div>                        $display_product_summary = apply_filters( 'gform_display_product_summary', true, $field, $form, $lead );&nbsp;</div></li><li><div>                        if ( $display_product_summary ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else if ( GFFormsModel::is_field_hidden( $form, $field, array(), $lead ) ) {&nbsp;</div></li><li><div>                        // ignore fields hidden by conditional logic&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $raw_field_value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>                    $field_value = GFCommon::get_lead_field_display( $field, $raw_field_value, rgar( $lead, 'currency' ), $use_text, $format, 'email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $display_field = true;&nbsp;</div></li><li><div>                    //depending on parameters, don't display adminOnly or hidden fields&nbsp;</div></li><li><div>                    if ( $no_admin && $field-&gt;adminOnly ) {&nbsp;</div></li><li><div>                        $display_field = false;&nbsp;</div></li><li><div>                    } else if ( $no_hidden && RGFormsModel::get_input_type( $field ) == 'hidden' ) {&nbsp;</div></li><li><div>                        $display_field = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //if field is not supposed to be displayed, pass false to filter. otherwise, pass field's value&nbsp;</div></li><li><div>                    if ( ! $display_field ) {&nbsp;</div></li><li><div>                        $field_value = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_value = apply_filters( 'gform_merge_tag_filter', $field_value, $merge_tag, $options, $field, $raw_field_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $field_value === false ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! empty( $field_value ) || strlen( $field_value ) &gt; 0 || $display_empty ) {&nbsp;</div></li><li><div>                        switch ( $format ) {&nbsp;</div></li><li><div>                            case 'text' :&nbsp;</div></li><li><div>                                $field_data .= &quot;{$field_label}: {$field_value}\n\n&quot;;&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $field_data .= sprintf(&nbsp;</div></li><li><div>                                        '&lt;tr bgcolor=&quot;%3$s&quot;&gt;&nbsp;</div></li><li><div>                                            &lt;td colspan=&quot;2&quot;&gt;&nbsp;</div></li><li><div>                                                &lt;font style=&quot;font-family: sans-serif; font-size:12px;&quot;&gt;&lt;strong&gt;%1$s&lt;/strong&gt;&lt;/font&gt;&nbsp;</div></li><li><div>                                            &lt;/td&gt;&nbsp;</div></li><li><div>                                       &lt;/tr&gt;&nbsp;</div></li><li><div>                                       &lt;tr bgcolor=&quot;%4$s&quot;&gt;&nbsp;</div></li><li><div>                                            &lt;td width=&quot;20&quot;&gt;&nbsp;&lt;/td&gt;&nbsp;</div></li><li><div>                                            &lt;td&gt;&nbsp;</div></li><li><div>                                                &lt;font style=&quot;font-family: sans-serif; font-size:12px;&quot;&gt;%2$s&lt;/font&gt;&nbsp;</div></li><li><div>                                            &lt;/td&gt;&nbsp;</div></li><li><div>                                       &lt;/tr&gt;&nbsp;</div></li><li><div>                                       ', $field_label, empty( $field_value ) && strlen( $field_value ) == 0 ? '&nbsp;' : $field_value, esc_attr( apply_filters( 'gform_email_background_color_label', '#EAF2FA', $field, $lead ) ), esc_attr( apply_filters( 'gform_email_background_color_data', '#FFFFFF', $field, $lead ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $display_product_summary ) {&nbsp;</div></li><li><div>            $field_data .= self::get_submitted_pricing_fields( $form, $lead, $format, $use_text, $use_admin_label );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $format == 'html' ) {&nbsp;</div></li><li><div>            $field_data .= '&lt;/table&gt;&nbsp;</div></li><li><div>                        &lt;/td&gt;&nbsp;</div></li><li><div>                   &lt;/tr&gt;&nbsp;</div></li><li><div>               &lt;/table&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_submitted_pricing_fields( $form, $lead, $format, $use_text = true, $use_admin_label = false ) {&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        $order_label = gf_apply_filters( array( 'gform_order_label', $form_id ), esc_html__( 'Order' , 'gravityforms' ), $form['id'] );&nbsp;</div></li><li><div>        $products = GFCommon::get_product_fields( $form, $lead, $use_text, $use_admin_label );&nbsp;</div></li><li><div>        $total = 0;&nbsp;</div></li><li><div>        $field_data = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $format ) {&nbsp;</div></li><li><div>            case 'text' :&nbsp;</div></li><li><div>                if ( ! empty( $products['products'] ) ) {&nbsp;</div></li><li><div>                    $field_data = &quot;--------------------------------\n&quot; . $order_label . &quot;\n\n&quot;;&nbsp;</div></li><li><div>                    foreach ( $products['products'] as $product ) {&nbsp;</div></li><li><div>                        $product_name = $product['quantity'] . ' ' . $product['name'];&nbsp;</div></li><li><div>                        $price = self::to_number( $product['price'] );&nbsp;</div></li><li><div>                        if ( ! empty( $product['options'] ) ) {&nbsp;</div></li><li><div>                            $product_name .= ' (';&nbsp;</div></li><li><div>                            $options = array();&nbsp;</div></li><li><div>                            foreach ( $product['options'] as $option ) {&nbsp;</div></li><li><div>                                $price += self::to_number( $option['price'] );&nbsp;</div></li><li><div>                                $options[] = $option['option_name'];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $product_name .= implode( ', ', $options ) . ')';&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $subtotal = floatval( $product['quantity'] ) * $price;&nbsp;</div></li><li><div>                        $total += $subtotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $field_data .= &quot;{$product_name}: &quot; . self::to_money( $subtotal, $lead['currency'] ) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $total += floatval( $products['shipping']['price'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! empty( $products['shipping']['name'] ) ) {&nbsp;</div></li><li><div>                        $field_data .= $products['shipping']['name'] . ': ' . self::to_money( $products['shipping']['price'], $lead['currency'] ) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_data .= esc_html__( 'Total' , 'gravityforms' ) . ': ' . self::to_money( $total, $lead['currency'] ) . &quot;\n\n&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                if ( ! empty( $products['products'] ) ) {&nbsp;</div></li><li><div>                    $field_data = '&lt;tr bgcolor=&quot;#EAF2FA&quot;&gt;&nbsp;</div></li><li><div>                            &lt;td colspan=&quot;2&quot;&gt;&nbsp;</div></li><li><div>                                &lt;font style=&quot;font-family: sans-serif; font-size:12px;&quot;&gt;&lt;strong&gt;' . $order_label . '&lt;/strong&gt;&lt;/font&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                       &lt;/tr&gt;&nbsp;</div></li><li><div>                       &lt;tr bgcolor=&quot;#FFFFFF&quot;&gt;&nbsp;</div></li><li><div>                            &lt;td width=&quot;20&quot;&gt;&nbsp;&lt;/td&gt;&nbsp;</div></li><li><div>                            &lt;td&gt;&nbsp;</div></li><li><div>                                &lt;table cellspacing=&quot;0&quot; width=&quot;97%&quot; style=&quot;border-left:1px solid #DFDFDF; border-top:1px solid #DFDFDF&quot;&gt;&nbsp;</div></li><li><div>                                &lt;thead&gt;&nbsp;</div></li><li><div>                                    &lt;th style=&quot;background-color:#F4F4F4; border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; font-family: sans-serif; font-size:12px; text-align:left&quot;&gt;' . gf_apply_filters( array( 'gform_product', $form_id ), esc_html__( 'Product' , 'gravityforms' ), $form_id ) . '&lt;/th&gt;&nbsp;</div></li><li><div>                                    &lt;th style=&quot;background-color:#F4F4F4; border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:50px; font-family: sans-serif; font-size:12px; text-align:center&quot;&gt;' . gf_apply_filters( array( 'gform_product_qty', $form_id ), esc_html__( 'Qty' , 'gravityforms' ), $form_id ) . '&lt;/th&gt;&nbsp;</div></li><li><div>                                    &lt;th style=&quot;background-color:#F4F4F4; border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:155px; font-family: sans-serif; font-size:12px; text-align:left&quot;&gt;' . gf_apply_filters( array( 'gform_product_unitprice', $form_id ), esc_html__( 'Unit Price' , 'gravityforms' ), $form_id ) . '&lt;/th&gt;&nbsp;</div></li><li><div>                                    &lt;th style=&quot;background-color:#F4F4F4; border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:155px; font-family: sans-serif; font-size:12px; text-align:left&quot;&gt;' . gf_apply_filters( array( 'gform_product_price', $form_id ), esc_html__( 'Price' , 'gravityforms' ), $form_id ) . '&lt;/th&gt;&nbsp;</div></li><li><div>                                &lt;/thead&gt;&nbsp;</div></li><li><div>                                &lt;tbody&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $products['products'] as $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $field_data .= '&lt;tr&gt;&nbsp;</div></li><li><div>                                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; font-family: sans-serif; font-size:11px;&quot; &gt;&nbsp;</div></li><li><div>                                                            &lt;strong style=&quot;color:#BF461E; font-size:12px; margin-bottom:5px&quot;&gt;' . $product['name'] . '&lt;/strong&gt;&nbsp;</div></li><li><div>                                                            &lt;ul style=&quot;margin:0&quot;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $price = self::to_number( $product['price'] );&nbsp;</div></li><li><div>                        if ( is_array( rgar( $product, 'options' ) ) ) {&nbsp;</div></li><li><div>                            foreach ( $product['options'] as $option ) {&nbsp;</div></li><li><div>                                $price += self::to_number( $option['price'] );&nbsp;</div></li><li><div>                                $field_data .= '&lt;li style=&quot;padding:4px 0 4px 0&quot;&gt;' . $option['option_label'] . '&lt;/li&gt;';&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $subtotal = floatval( $product['quantity'] ) * $price;&nbsp;</div></li><li><div>                        $total += $subtotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $field_data .= '&lt;/ul&gt;&nbsp;</div></li><li><div>                                                        &lt;/td&gt;&nbsp;</div></li><li><div>                                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; text-align:center; width:50px; font-family: sans-serif; font-size:11px;&quot; &gt;' . $product['quantity'] . '&lt;/td&gt;&nbsp;</div></li><li><div>                                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:155px; font-family: sans-serif; font-size:11px;&quot; &gt;' . self::to_money( $price, $lead['currency'] ) . '&lt;/td&gt;&nbsp;</div></li><li><div>                                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:155px; font-family: sans-serif; font-size:11px;&quot; &gt;' . self::to_money( $subtotal, $lead['currency'] ) . '&lt;/td&gt;&nbsp;</div></li><li><div>                                                    &lt;/tr&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $total += floatval( $products['shipping']['price'] );&nbsp;</div></li><li><div>                    $field_data .= '&lt;/tbody&gt;&nbsp;</div></li><li><div>                                &lt;tfoot&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! empty( $products['shipping']['name'] ) ) {&nbsp;</div></li><li><div>                        $field_data .= '&nbsp;</div></li><li><div>                                    &lt;tr&gt;&nbsp;</div></li><li><div>                                        &lt;td colspan=&quot;2&quot; rowspan=&quot;2&quot; style=&quot;background-color:#F4F4F4; border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; font-size:11px;&quot;&gt;&nbsp;&lt;/td&gt;&nbsp;</div></li><li><div>                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; text-align:right; width:155px; font-family: sans-serif;&quot;&gt;&lt;strong style=&quot;font-size:12px;&quot;&gt;' . $products['shipping']['name'] . '&lt;/strong&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:155px; font-family: sans-serif;&quot;&gt;&lt;strong style=&quot;font-size:12px;&quot;&gt;' . self::to_money( $products['shipping']['price'], $lead['currency'] ) . '&lt;/strong&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                    &lt;/tr&gt;&nbsp;</div></li><li><div>                                    ';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_data .= '&nbsp;</div></li><li><div>                                    &lt;tr&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( empty( $products['shipping']['name'] ) ) {&nbsp;</div></li><li><div>                        $field_data .= '&nbsp;</div></li><li><div>                                        &lt;td colspan=&quot;2&quot; style=&quot;background-color:#F4F4F4; border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; font-size:11px;&quot;&gt;&nbsp;&lt;/td&gt;';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $field_data .= '&nbsp;</div></li><li><div>                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; text-align:right; width:155px; font-family: sans-serif;&quot;&gt;&lt;strong style=&quot;font-size:12px;&quot;&gt;' . esc_html__( 'Total:' , 'gravityforms' ) . '&lt;/strong&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                        &lt;td style=&quot;border-bottom:1px solid #DFDFDF; border-right:1px solid #DFDFDF; padding:7px; width:155px; font-family: sans-serif;&quot;&gt;&lt;strong style=&quot;font-size:12px;&quot;&gt;' . self::to_money( $total, $lead['currency'] ) . '&lt;/strong&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                                    &lt;/tr&gt;&nbsp;</div></li><li><div>                                &lt;/tfoot&gt;&nbsp;</div></li><li><div>                               &lt;/table&gt;&nbsp;</div></li><li><div>                            &lt;/td&gt;&nbsp;</div></li><li><div>                        &lt;/tr&gt;';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function send_user_notification( $form, $lead, $override_options = false ) {&nbsp;</div></li><li><div>        _deprecated_function( 'send_user_notification', '1.7', 'send_notification' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notification = self::prepare_user_notification( $form, $lead, $override_options );&nbsp;</div></li><li><div>        self::send_email( $notification['from'], $notification['to'], $notification['bcc'], $notification['reply_to'], $notification['subject'], $notification['message'], $notification['from_name'], $notification['message_format'], $notification['attachments'], $lead );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function send_admin_notification( $form, $lead, $override_options = false ) {&nbsp;</div></li><li><div>        _deprecated_function( 'send_admin_notification', '1.7', 'send_notification' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notification = self::prepare_admin_notification( $form, $lead, $override_options );&nbsp;</div></li><li><div>        self::send_email( $notification['from'], $notification['to'], $notification['bcc'], $notification['replyTo'], $notification['subject'], $notification['message'], $notification['from_name'], $notification['message_format'], $notification['attachments'], $lead );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function prepare_user_notification( $form, $lead, $override_options = false ) {&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $form['autoResponder'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //handling autoresponder email&nbsp;</div></li><li><div>        $to_field = isset( $form['autoResponder']['toField'] ) ? rgget( $form['autoResponder']['toField'], $lead ) : '';&nbsp;</div></li><li><div>        $to = gf_apply_filters( array( 'gform_autoresponder_email', $form_id ), $to_field, $form );&nbsp;</div></li><li><div>        $subject = GFCommon::replace_variables( rgget( 'subject', $form['autoResponder'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message_format = gf_apply_filters( array( 'gform_notification_format', $form_id ), 'html', 'user', $form, $lead );&nbsp;</div></li><li><div>        $message = GFCommon::replace_variables( rgget( 'message', $form['autoResponder'] ), $form, $lead, false, false, ! rgget( 'disableAutoformat', $form['autoResponder'] ), $message_format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( apply_filters( 'gform_enable_shortcode_notification_message', true, $form, $lead ) ) {&nbsp;</div></li><li><div>            $message = do_shortcode( $message );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Running trough variable replacement&nbsp;</div></li><li><div>        $to = GFCommon::replace_variables( $to, $form, $lead, false, false );&nbsp;</div></li><li><div>        $from = GFCommon::replace_variables( rgget( 'from', $form['autoResponder'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>        $bcc = GFCommon::replace_variables( rgget( 'bcc', $form['autoResponder'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>        $reply_to = GFCommon::replace_variables( rgget( 'replyTo', $form['autoResponder'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>        $from_name = GFCommon::replace_variables( rgget( 'fromName', $form['autoResponder'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // override default values if override options provided&nbsp;</div></li><li><div>        if ( $override_options && is_array( $override_options ) ) {&nbsp;</div></li><li><div>            foreach ( $override_options as $override_key =&gt; $override_value ) {&nbsp;</div></li><li><div>                ${$override_key} = $override_value;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachments = gf_apply_filters( array( 'gform_user_notification_attachments', $form_id ), array(), $lead, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Disabling autoformat to prevent double autoformatting of messages&nbsp;</div></li><li><div>        $disableAutoformat = '1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return compact( 'to', 'from', 'bcc', 'reply_to', 'subject', 'message', 'from_name', 'message_format', 'attachments', 'disableAutoformat' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function prepare_admin_notification( $form, $lead, $override_options = false ) {&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //handling admin notification email&nbsp;</div></li><li><div>        $subject = GFCommon::replace_variables( rgget( 'subject', $form['notification'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message_format = gf_apply_filters( array( 'gform_notification_format', $form_id ), 'html', 'admin', $form, $lead );&nbsp;</div></li><li><div>        $message = GFCommon::replace_variables( rgget( 'message', $form['notification'] ), $form, $lead, false, false, ! rgget( 'disableAutoformat', $form['notification'] ), $message_format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( apply_filters( 'gform_enable_shortcode_notification_message', true, $form, $lead ) ) {&nbsp;</div></li><li><div>            $message = do_shortcode( $message );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version_info = self::get_version_info();&nbsp;</div></li><li><div>        $is_expired = ! rgempty( 'expiration_time', $version_info ) && $version_info['expiration_time'] &lt; time();&nbsp;</div></li><li><div>        if ( ! rgar( $version_info, 'is_valid_key' ) && $is_expired ) {&nbsp;</div></li><li><div>            $message .= &quot;&lt;br/&gt;&lt;br/&gt;Your Gravity Forms License Key has expired. In order to continue receiving support and software updates you must renew your license key. You can do so by following the renewal instructions on the Gravity Forms Settings page in your WordPress Dashboard or by &lt;a href='http://www.gravityhelp.com/renew-license/?key=&quot; . self::get_key() . &quot;'&gt;clicking here&lt;/a&gt;.&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $from = rgempty( 'fromField', $form['notification'] ) ? rgget( 'from', $form['notification'] ) : rgget( $form['notification']['fromField'], $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgempty( 'fromNameField', $form['notification'] ) ) {&nbsp;</div></li><li><div>            $from_name = rgget( 'fromName', $form['notification'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $field = RGFormsModel::get_field( $form, rgget( 'fromNameField', $form['notification'] ) );&nbsp;</div></li><li><div>            $value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>            $from_name = GFCommon::get_lead_field_display( $field, $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $replyTo = rgempty( 'replyToField', $form['notification'] ) ? rgget( 'replyTo', $form['notification'] ) : rgget( $form['notification']['replyToField'], $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgempty( 'routing', $form['notification'] ) ) {&nbsp;</div></li><li><div>            $email_to = rgempty( 'toField', $form['notification'] ) ? rgget( 'to', $form['notification'] ) : rgget( 'toField', $form['notification'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $email_to = array();&nbsp;</div></li><li><div>            foreach ( $form['notification']['routing'] as $routing ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $source_field = RGFormsModel::get_field( $form, $routing['fieldId'] );&nbsp;</div></li><li><div>                $field_value = RGFormsModel::get_lead_field_value( $lead, $source_field );&nbsp;</div></li><li><div>                $is_value_match = RGFormsModel::is_value_match( $field_value, $routing['value'], $routing['operator'], $source_field, $routing, $form ) && ! RGFormsModel::is_field_hidden( $form, $source_field, array(), $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $is_value_match ) {&nbsp;</div></li><li><div>                    $email_to[] = $routing['email'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $email_to = join( ', ', $email_to );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Running through variable replacement&nbsp;</div></li><li><div>        $email_to = GFCommon::replace_variables( $email_to, $form, $lead, false, false );&nbsp;</div></li><li><div>        $from = GFCommon::replace_variables( $from, $form, $lead, false, false );&nbsp;</div></li><li><div>        $bcc = GFCommon::replace_variables( rgget( 'bcc', $form['notification'] ), $form, $lead, false, false );&nbsp;</div></li><li><div>        $reply_to = GFCommon::replace_variables( $replyTo, $form, $lead, false, false );&nbsp;</div></li><li><div>        $from_name = GFCommon::replace_variables( $from_name, $form, $lead, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Filters the admin notification email to address. Allows users to change email address before notification is sent&nbsp;</div></li><li><div>        $to = gf_apply_filters( array( 'gform_notification_email', $form_id ), $email_to, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // override default values if override options provided&nbsp;</div></li><li><div>        if ( $override_options && is_array( $override_options ) ) {&nbsp;</div></li><li><div>            foreach ( $override_options as $override_key =&gt; $override_value ) {&nbsp;</div></li><li><div>                ${$override_key} = $override_value;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachments = gf_apply_filters( array( 'gform_admin_notification_attachments', $form_id ), array(), $lead, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Disabling autoformat to prevent double autoformatting of messages&nbsp;</div></li><li><div>        $disableAutoformat = '1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return compact( 'to', 'from', 'bcc', 'replyTo', 'subject', 'message', 'from_name', 'message_format', 'attachments', 'disableAutoformat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function send_notification( $notification, $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFCommon::send_notification(): Starting to process notification (#{$notification['id']} - {$notification['name']}).&quot; );&nbsp;</div></li><li><div>        $notification = gf_apply_filters( array( 'gform_notification', $form['id'] ), $notification, $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $to_field = '';&nbsp;</div></li><li><div>        if ( rgar( $notification, 'toType' ) == 'field' ) {&nbsp;</div></li><li><div>            $to_field = rgar( $notification, 'toField' );&nbsp;</div></li><li><div>            if ( rgempty( 'toField', $notification ) ) {&nbsp;</div></li><li><div>                $to_field = rgar( $notification, 'to' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $email_to = rgar( $notification, 'to' );&nbsp;</div></li><li><div>        //do routing logic if &quot;to&quot; field doesn't have a value (to support legacy notifications that will run routing prior to this method)&nbsp;</div></li><li><div>        if ( empty( $email_to ) && rgar( $notification, 'toType' ) == 'routing' ) {&nbsp;</div></li><li><div>            $email_to = array();&nbsp;</div></li><li><div>            foreach ( $notification['routing'] as $routing ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( __METHOD__ . '(): Evaluating Routing - rule =&gt; ' . print_r( $routing, 1 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $source_field = RGFormsModel::get_field( $form, $routing['fieldId'] );&nbsp;</div></li><li><div>                $field_value = RGFormsModel::get_lead_field_value( $lead, $source_field );&nbsp;</div></li><li><div>                $is_value_match = RGFormsModel::is_value_match( $field_value, $routing['value'], $routing['operator'], $source_field, $routing, $form ) && ! RGFormsModel::is_field_hidden( $form, $source_field, array(), $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $is_value_match ) {&nbsp;</div></li><li><div>                    $email_to[] = $routing['email'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                GFCommon::log_debug( __METHOD__ . '(): Evaluating Routing - field value =&gt; ' . print_r( $field_value, 1 ) );&nbsp;</div></li><li><div>                $is_value_match = $is_value_match ? 'Yes' : 'No';&nbsp;</div></li><li><div>                GFCommon::log_debug( __METHOD__ . '(): Evaluating Routing - is value match? ' . $is_value_match );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $email_to = join( ', ', $email_to );&nbsp;</div></li><li><div>        } else if ( ! empty( $to_field ) ) {&nbsp;</div></li><li><div>            $source_field = RGFormsModel::get_field( $form, $to_field );&nbsp;</div></li><li><div>            $email_to = RGFormsModel::get_lead_field_value( $lead, $source_field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Running through variable replacement&nbsp;</div></li><li><div>        $to = GFCommon::replace_variables( $email_to, $form, $lead, false, false );&nbsp;</div></li><li><div>        $subject = GFCommon::replace_variables( rgar( $notification, 'subject' ), $form, $lead, false, false, true, 'text' );&nbsp;</div></li><li><div>        $from = GFCommon::replace_variables( rgar( $notification, 'from' ), $form, $lead, false, false );&nbsp;</div></li><li><div>        $from_name = GFCommon::replace_variables( rgar( $notification, 'fromName' ), $form, $lead, false, false, true, 'text' );&nbsp;</div></li><li><div>        $bcc = GFCommon::replace_variables( rgar( $notification, 'bcc' ), $form, $lead, false, false );&nbsp;</div></li><li><div>        $replyTo = GFCommon::replace_variables( rgar( $notification, 'replyTo' ), $form, $lead, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message_format = rgempty( 'message_format', $notification ) ? 'html' : rgar( $notification, 'message_format' );&nbsp;</div></li><li><div>        $message = GFCommon::replace_variables( rgar( $notification, 'message' ), $form, $lead, false, false, ! rgar( $notification, 'disableAutoformat' ), $message_format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( apply_filters( 'gform_enable_shortcode_notification_message', true, $form, $lead ) ) {&nbsp;</div></li><li><div>            $message = do_shortcode( $message );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // allow attachments to be passed as a single path (string) or an array of paths, if string provided, add to array&nbsp;</div></li><li><div>        $attachments = rgar( $notification, 'attachments' );&nbsp;</div></li><li><div>        if ( ! empty( $attachments ) ) {&nbsp;</div></li><li><div>            $attachments = is_array( $attachments ) ? $attachments : array( $attachments );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $attachments = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::send_email( $from, $to, $bcc, $replyTo, $subject, $message, $from_name, $message_format, $attachments, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return compact( 'to', 'from', 'bcc', 'replyTo', 'subject', 'message', 'from_name', 'message_format', 'attachments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function send_notifications( $notification_ids, $form, $lead, $do_conditional_logic = true, $event = 'form_submission' ) {&nbsp;</div></li><li><div>        $entry_id = rgar( $lead, 'id' );&nbsp;</div></li><li><div>        if ( ! is_array( $notification_ids ) || empty( $notification_ids ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( &quot;GFCommon::send_notifications(): Aborting. No notifications to process for {$event} event for entry #{$entry_id}.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFCommon::send_notifications(): Processing notifications for {$event} event for entry #{$entry_id}: &quot; . print_r( $notification_ids, true ) . &quot;\n(only active/applicable notifications are sent)&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $notification_ids as $notification_id ) {&nbsp;</div></li><li><div>            if ( ! isset( $form['notifications'][ $notification_id ] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( isset( $form['notifications'][ $notification_id ]['isActive'] ) && ! $form['notifications'][ $notification_id ]['isActive'] ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( &quot;GFCommon::send_notifications(): Notification is inactive, not processing notification (#{$notification_id} - {$form['notifications'][$notification_id]['name']}).&quot; );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $notification = $form['notifications'][ $notification_id ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //check conditional logic when appropriate&nbsp;</div></li><li><div>            if ( $do_conditional_logic && ! GFCommon::evaluate_conditional_logic( rgar( $notification, 'conditionalLogic' ), $form, $lead ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( &quot;GFCommon::send_notifications(): Notification conditional logic not met, not processing notification (#{$notification_id} - {$notification['name']}).&quot; );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( rgar( $notification, 'type' ) == 'user' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //Getting user notification from legacy structure (for backwards compatibility)&nbsp;</div></li><li><div>                $legacy_notification = GFCommon::prepare_user_notification( $form, $lead );&nbsp;</div></li><li><div>                $notification = self::merge_legacy_notification( $notification, $legacy_notification );&nbsp;</div></li><li><div>            } else if ( rgar( $notification, 'type' ) == 'admin' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //Getting admin notification from legacy structure (for backwards compatibility)&nbsp;</div></li><li><div>                $legacy_notification = GFCommon::prepare_admin_notification( $form, $lead );&nbsp;</div></li><li><div>                $notification = self::merge_legacy_notification( $notification, $legacy_notification );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //sending notification&nbsp;</div></li><li><div>            self::send_notification( $notification, $form, $lead );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function send_form_submission_notifications( $form, $lead ) {&nbsp;</div></li><li><div>        GFAPI::send_notifications( $form, $lead );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function merge_legacy_notification( $notification, $notification_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $keys = array( 'to', 'from', 'bcc', 'replyTo', 'subject', 'message', 'from_name', 'message_format', 'attachments', 'disableAutoformat' );&nbsp;</div></li><li><div>        foreach ( $keys as $key ) {&nbsp;</div></li><li><div>            $notification[ $key ] = rgar( $notification_data, $key );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $notification;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_notifications_to_send( $event, $form, $lead ) {&nbsp;</div></li><li><div>        $notifications = self::get_notifications( $event, $form );&nbsp;</div></li><li><div>        $notifications_to_send = array();&nbsp;</div></li><li><div>        foreach ( $notifications as $notification ) {&nbsp;</div></li><li><div>            if ( GFCommon::evaluate_conditional_logic( rgar( $notification, 'conditionalLogic' ), $form, $lead ) ) {&nbsp;</div></li><li><div>                $notifications_to_send[] = $notification;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $notifications_to_send;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_notifications( $event, $form ) {&nbsp;</div></li><li><div>        if ( rgempty( 'notifications', $form ) ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notifications = array();&nbsp;</div></li><li><div>        foreach ( $form['notifications'] as $notification ) {&nbsp;</div></li><li><div>            $notification_event = rgar( $notification, 'event' );&nbsp;</div></li><li><div>            $omit_from_resend = array( 'form_saved', 'form_save_email_requested' );&nbsp;</div></li><li><div>            if ( $notification_event == $event || ( $event == 'resend_notifications' && ! in_array( $notification_event, $omit_from_resend ) ) ) {&nbsp;</div></li><li><div>                $notifications[] = $notification;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $notifications;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_admin_notification( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ( ! empty( $form['notification']['to'] ) || ! empty( $form['notification']['routing'] ) ) && ( ! empty( $form['notification']['subject'] ) || ! empty( $form['notification']['message'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_user_notification( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ! empty( $form['autoResponder']['toField'] ) && ( ! empty( $form['autoResponder']['subject'] ) || ! empty( $form['autoResponder']['message'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function send_email( $from, $to, $bcc, $reply_to, $subject, $message, $from_name = '', $message_format = 'html', $attachments = '', $entry = false ) {&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        global $phpmailer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $to = str_replace( ' ', '', $to );&nbsp;</div></li><li><div>        $bcc = str_replace( ' ', '', $bcc );&nbsp;</div></li><li><div>        $error = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! GFCommon::is_valid_email( $from ) ) {&nbsp;</div></li><li><div>            $from = get_bloginfo( 'admin_email' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! GFCommon::is_valid_email_list( $to ) ) {&nbsp;</div></li><li><div>            $error = new WP_Error( 'invalid_to', 'Cannot send email because the TO address is invalid.' );&nbsp;</div></li><li><div>        } else if ( empty( $subject ) && empty( $message ) ) {&nbsp;</div></li><li><div>            $error = new WP_Error( 'missing_subject_and_message', 'Cannot send email because there is no SUBJECT and no MESSAGE.' );&nbsp;</div></li><li><div>        } else if ( ! GFCommon::is_valid_email( $from ) ) {&nbsp;</div></li><li><div>            $error = new WP_Error( 'invalid_from', 'Cannot send email because the FROM address is invalid.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $error ) ) {&nbsp;</div></li><li><div>            GFCommon::log_error( 'GFCommon::send_email(): ' . $error-&gt;get_error_message() );&nbsp;</div></li><li><div>            GFCommon::log_error( print_r( compact( 'to', 'subject', 'message' ), true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires when an email from Gravity Forms has failed to send&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string $error The Error message returned after the email fails to send&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'gform_send_email_failed', $error, compact( 'from', 'to', 'bcc', 'reply_to', 'subject', 'message', 'from_name', 'message_format', 'attachments' ), $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content_type = $message_format == 'html' ? 'text/html' : 'text/plain';&nbsp;</div></li><li><div>        $name = empty( $from_name ) ? $from : $from_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $headers = array();&nbsp;</div></li><li><div>        $headers['From'] = &quot;From: \&quot;&quot; . wp_strip_all_tags( $name, true ) . &quot;\&quot; &lt;{$from}&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( GFCommon::is_valid_email_list( $reply_to ) ) {&nbsp;</div></li><li><div>            $headers['Reply-To'] = &quot;Reply-To: {$reply_to}&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( GFCommon::is_valid_email_list( $bcc ) ) {&nbsp;</div></li><li><div>            $headers['Bcc'] = &quot;Bcc: $bcc&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $headers['Content-type'] = &quot;Content-type: {$content_type}; charset=&quot; . get_option( 'blog_charset' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $abort_email = false;&nbsp;</div></li><li><div>        extract( apply_filters( 'gform_pre_send_email', compact( 'to', 'subject', 'message', 'headers', 'attachments', 'abort_email' ), $message_format ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_success = false;&nbsp;</div></li><li><div>        if ( ! $abort_email ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFCommon::send_email(): Sending email via wp_mail().' );&nbsp;</div></li><li><div>            GFCommon::log_debug( print_r( compact( 'to', 'subject', 'message', 'headers', 'attachments', 'abort_email' ), true ) );&nbsp;</div></li><li><div>            $is_success = wp_mail( $to, $subject, $message, $headers, $attachments );&nbsp;</div></li><li><div>            $result = is_wp_error( $is_success ) ? $is_success-&gt;get_error_message() : $is_success;&nbsp;</div></li><li><div>            GFCommon::log_debug( &quot;GFCommon::send_email(): Result from wp_mail(): {$result}&quot; );&nbsp;</div></li><li><div>            if ( ! is_wp_error( $is_success ) && $is_success ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFCommon::send_email(): Mail was passed from WordPress to the mail server.' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                GFCommon::log_error( 'GFCommon::send_email(): The mail message was passed off to WordPress for processing, but WordPress was unable to send the message.' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( has_filter( 'phpmailer_init' ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( __METHOD__ . '(): The WordPress phpmailer_init hook has been detected, usually used by SMTP plugins, it can impact mail delivery.' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $phpmailer-&gt;ErrorInfo ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( __METHOD__ . '(): PHPMailer class returned an error message: ' . $phpmailer-&gt;ErrorInfo );&nbsp;</div></li><li><div>            }            &nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFCommon::send_email(): Aborting. The gform_pre_send_email hook was used to set the abort_email parameter to true.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::add_emails_sent();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_after_email', $is_success, $to, $subject, $message, $headers, $attachments, $message_format, $from, $from_name, $bcc, $reply_to, $entry );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_emails_sent() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = self::get_emails_sent();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_option( 'gform_email_count', ++$count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_emails_sent() {&nbsp;</div></li><li><div>        $count = get_option( 'gform_email_count' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $count ) {&nbsp;</div></li><li><div>            $count = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $count;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_api_calls() {&nbsp;</div></li><li><div>        $count = get_option( 'gform_api_count' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $count ) {&nbsp;</div></li><li><div>            $count = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $count;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_api_call() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = self::get_api_calls();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_option( 'gform_api_count', ++$count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_post_field( $fields ) {&nbsp;</div></li><li><div>        foreach ( $fields as $field ) {&nbsp;</div></li><li><div>            if ( in_array( $field-&gt;type, array( 'post_title', 'post_content', 'post_excerpt', 'post_category', 'post_image', 'post_tags', 'post_custom_field' ) ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_list_field( $form ) {&nbsp;</div></li><li><div>        return self::has_field_by_type( $form, 'list' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_credit_card_field( $form ) {&nbsp;</div></li><li><div>        return self::has_field_by_type( $form, 'creditcard' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_field_by_type( $form, $type ) {&nbsp;</div></li><li><div>        if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( RGFormsModel::get_input_type( $field ) == $type ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function current_user_can_any( $caps ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $caps ) ) {&nbsp;</div></li><li><div>            $has_cap = current_user_can( $caps ) || current_user_can( 'gform_full_access' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $has_cap;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $caps as $cap ) {&nbsp;</div></li><li><div>            if ( current_user_can( $cap ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_full_access = current_user_can( 'gform_full_access' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $has_full_access;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function current_user_can_which( $caps ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $caps as $cap ) {&nbsp;</div></li><li><div>            if ( current_user_can( $cap ) ) {&nbsp;</div></li><li><div>                return $cap;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_pricing_field( $field_type ) {&nbsp;</div></li><li><div>        return self::is_product_field( $field_type ) || $field_type == 'donation';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_product_field( $field_type ) {&nbsp;</div></li><li><div>        $product_fields = apply_filters( 'gform_product_field_types', array( 'option', 'quantity', 'product', 'total', 'shipping', 'calculation', 'price' ) );&nbsp;</div></li><li><div>        return in_array( $field_type, $product_fields );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function all_caps() {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'gravityforms_edit_forms', &nbsp;</div></li><li><div>            'gravityforms_delete_forms', &nbsp;</div></li><li><div>            'gravityforms_create_form', &nbsp;</div></li><li><div>            'gravityforms_view_entries', &nbsp;</div></li><li><div>            'gravityforms_edit_entries', &nbsp;</div></li><li><div>            'gravityforms_delete_entries', &nbsp;</div></li><li><div>            'gravityforms_view_settings', &nbsp;</div></li><li><div>            'gravityforms_edit_settings', &nbsp;</div></li><li><div>            'gravityforms_export_entries', &nbsp;</div></li><li><div>            'gravityforms_uninstall', &nbsp;</div></li><li><div>            'gravityforms_view_entry_notes', &nbsp;</div></li><li><div>            'gravityforms_edit_entry_notes', &nbsp;</div></li><li><div>            'gravityforms_view_updates', &nbsp;</div></li><li><div>            'gravityforms_view_addons', &nbsp;</div></li><li><div>            'gravityforms_preview_forms', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_directory( $dir ) {&nbsp;</div></li><li><div>        if ( ! file_exists( $dir ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $handle = opendir( $dir ) ) {&nbsp;</div></li><li><div>            $array = array();&nbsp;</div></li><li><div>            while ( false !== ( $file = readdir( $handle ) ) ) {&nbsp;</div></li><li><div>                if ( $file != '.' && $file != '..' ) {&nbsp;</div></li><li><div>                    if ( is_dir( $dir . $file ) ) {&nbsp;</div></li><li><div>                        if ( ! @rmdir( $dir . $file ) ) {&nbsp;</div></li><li><div>                            // Empty directory? Remove it&nbsp;</div></li><li><div>                            self::delete_directory( $dir . $file . '/' );&nbsp;</div></li><li><div>                        } // Not empty? Delete the files inside it&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        @unlink( $dir . $file );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            closedir( $handle );&nbsp;</div></li><li><div>            @rmdir( $dir );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_remote_message() {&nbsp;</div></li><li><div>        return stripslashes( get_option( 'rg_gforms_message' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_key() {&nbsp;</div></li><li><div>        return get_option( 'rg_gforms_key' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_update( $use_cache = true ) {&nbsp;</div></li><li><div>        $version_info = GFCommon::get_version_info( $use_cache );&nbsp;</div></li><li><div>        $version = rgar( $version_info, 'version' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return empty( $version ) ? false : version_compare( GFCommon::$version, $version, '&lt;' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_key_info( $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options = array( 'method' =&gt; 'POST', 'timeout' =&gt; 3 );&nbsp;</div></li><li><div>        $options['headers'] = array(&nbsp;</div></li><li><div>            'Content-Type' =&gt; 'application/x-www-form-urlencoded; charset=' . get_option( 'blog_charset' ), &nbsp;</div></li><li><div>            'User-Agent' =&gt; 'WordPress/' . get_bloginfo( 'version' ), &nbsp;</div></li><li><div>            'Referer' =&gt; get_bloginfo( 'url' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $raw_response = self::post_to_manager( 'api.php', &quot;op=get_key&key={$key}&quot;, $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $raw_response ) || $raw_response['response']['code'] != 200 ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key_info = unserialize( trim( $raw_response['body'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $key_info ? $key_info : array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_version_info( $cache = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $raw_response = get_transient( 'gform_update_info' );&nbsp;</div></li><li><div>        if ( ! $cache ) {&nbsp;</div></li><li><div>            $raw_response = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $raw_response ) {&nbsp;</div></li><li><div>            //Getting version number&nbsp;</div></li><li><div>            $options = array( 'method' =&gt; 'POST', 'timeout' =&gt; 20 );&nbsp;</div></li><li><div>            $options['headers'] = array(&nbsp;</div></li><li><div>                'Content-Type' =&gt; 'application/x-www-form-urlencoded; charset=' . get_option( 'blog_charset' ), &nbsp;</div></li><li><div>                'User-Agent' =&gt; 'WordPress/' . get_bloginfo( 'version' ), &nbsp;</div></li><li><div>                'Referer' =&gt; get_bloginfo( 'url' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $options['body'] = self::get_remote_post_params();&nbsp;</div></li><li><div>            $options['timeout'] = 15;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $nocache = $cache ? '' : 'nocache=1'; //disabling server side caching&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $raw_response = self::post_to_manager( 'version.php', $nocache, $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //caching responses.&nbsp;</div></li><li><div>            set_transient( 'gform_update_info', $raw_response, 86400 ); //caching for 24 hours&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $raw_response ) || rgars( $raw_response, 'response/code' ) != 200 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'is_valid_key' =&gt; '1', 'version' =&gt; '', 'url' =&gt; '', 'is_error' =&gt; '1' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version_info = json_decode( $raw_response['body'], true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $version_info ) ) {&nbsp;</div></li><li><div>            return array( 'is_valid_key' =&gt; '1', 'version' =&gt; '', 'url' =&gt; '', 'is_error' =&gt; '1' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $version_info;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_remote_request_params() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return sprintf( 'of=GravityForms&key=%s&v=%s&wp=%s&php=%s&mysql=%s&version=2', urlencode( self::get_key() ), urlencode( self::$version ), urlencode( get_bloginfo( 'version' ) ), urlencode( phpversion() ), urlencode( $wpdb-&gt;db_version() ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_remote_post_params() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! function_exists( 'get_plugins' ) ) {&nbsp;</div></li><li><div>            require_once( ABSPATH . 'wp-admin/includes/plugin.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $plugin_list = get_plugins();&nbsp;</div></li><li><div>        $site_url = get_bloginfo( 'url' );&nbsp;</div></li><li><div>        $plugins = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active_plugins = get_option( 'active_plugins' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $plugin_list as $key =&gt; $plugin ) {&nbsp;</div></li><li><div>            $is_active = in_array( $key, $active_plugins );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //filter for only gravityforms ones, may get some others if using our naming convention&nbsp;</div></li><li><div>            if ( strpos( strtolower( $plugin['Title'] ), 'gravity forms' ) !== false ) {&nbsp;</div></li><li><div>                $name = substr( $key, 0, strpos( $key, '/' ) );&nbsp;</div></li><li><div>                $plugins[] = array( 'name' =&gt; $name, 'version' =&gt; $plugin['Version'], 'is_active' =&gt; $is_active );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $plugins = json_encode( $plugins );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get theme info&nbsp;</div></li><li><div>        $theme = wp_get_theme();&nbsp;</div></li><li><div>        $theme_name = $theme-&gt;get( 'Name' );&nbsp;</div></li><li><div>        $theme_uri = $theme-&gt;get( 'ThemeURI' );&nbsp;</div></li><li><div>        $theme_version = $theme-&gt;get( 'Version' );&nbsp;</div></li><li><div>        $theme_author = $theme-&gt;get( 'Author' );&nbsp;</div></li><li><div>        $theme_author_uri = $theme-&gt;get( 'AuthorURI' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_counts = GFFormsModel::get_form_count();&nbsp;</div></li><li><div>        $active_count = $form_counts['active'];&nbsp;</div></li><li><div>        $inactive_count = $form_counts['inactive'];&nbsp;</div></li><li><div>        $fc = abs( $active_count ) + abs( $inactive_count );&nbsp;</div></li><li><div>        $entry_count = GFFormsModel::get_lead_count_all_forms( 'active' );&nbsp;</div></li><li><div>        $im = is_multisite();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post = array( 'of' =&gt; 'gravityforms', 'key' =&gt; self::get_key(), 'v' =&gt; self::$version, 'wp' =&gt; get_bloginfo( 'version' ), 'php' =&gt; phpversion(), 'mysql' =&gt; $wpdb-&gt;db_version(), 'version' =&gt; '2', 'plugins' =&gt; $plugins, 'tn' =&gt; $theme_name, 'tu' =&gt; $theme_uri, 'tv' =&gt; $theme_version, 'ta' =&gt; $theme_author, 'tau' =&gt; $theme_author_uri, 'im' =&gt; $im, 'fc' =&gt; $fc, 'ec' =&gt; $entry_count, 'emc' =&gt; self::get_emails_sent(), 'api' =&gt; self::get_api_calls() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $post;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function ensure_wp_version() {&nbsp;</div></li><li><div>        if ( ! GF_SUPPORTED_WP_VERSION ) {&nbsp;</div></li><li><div>            echo &quot;&lt;div class='error' style='padding:10px;'&gt;&quot; . sprintf( esc_html__( 'Gravity Forms require WordPress %s or greater. You must upgrade WordPress in order to use Gravity Forms' , 'gravityforms' ), GF_MIN_WP_VERSION ) . '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function check_update( $option, $cache = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_object( $option ) ) {&nbsp;</div></li><li><div>            return $option;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version_info = self::get_version_info( $cache );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $version_info ) {&nbsp;</div></li><li><div>            return $option;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plugin_path = 'gravityforms/gravityforms.php';&nbsp;</div></li><li><div>        if ( empty( $option-&gt;response[ $plugin_path ] ) ) {&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ] = new stdClass();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version = rgar( $version_info, 'version' );&nbsp;</div></li><li><div>        //Empty response means that the key is invalid. Do not queue for upgrade&nbsp;</div></li><li><div>        if ( ! rgar( $version_info, 'is_valid_key' ) || version_compare( GFCommon::$version, $version, '&gt;=' ) ) {&nbsp;</div></li><li><div>            unset( $option-&gt;response[ $plugin_path ] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $url = rgar( $version_info, 'url' );&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ]-&gt;url = 'http://www.gravityforms.com';&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ]-&gt;slug = 'gravityforms';&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ]-&gt;plugin = $plugin_path;&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ]-&gt;package = str_replace( '{KEY}', GFCommon::get_key(), $url );&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ]-&gt;new_version = $version;&nbsp;</div></li><li><div>            $option-&gt;response[ $plugin_path ]-&gt;id = '0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $option;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function cache_remote_message() {&nbsp;</div></li><li><div>        //Getting version number&nbsp;</div></li><li><div>        $key = GFCommon::get_key();&nbsp;</div></li><li><div>        $body = &quot;key=$key&quot;;&nbsp;</div></li><li><div>        $options = array( 'method' =&gt; 'POST', 'timeout' =&gt; 3, 'body' =&gt; $body );&nbsp;</div></li><li><div>        $options['headers'] = array(&nbsp;</div></li><li><div>            'Content-Type' =&gt; 'application/x-www-form-urlencoded; charset=' . get_option( 'blog_charset' ), &nbsp;</div></li><li><div>            'Content-Length' =&gt; strlen( $body ), &nbsp;</div></li><li><div>            'User-Agent' =&gt; 'WordPress/' . get_bloginfo( 'version' ), &nbsp;</div></li><li><div>            'Referer' =&gt; get_bloginfo( 'url' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $raw_response = self::post_to_manager( 'message.php', GFCommon::get_remote_request_params(), $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $raw_response ) || 200 != $raw_response['response']['code'] ) {&nbsp;</div></li><li><div>            $message = '';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $message = $raw_response['body'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //validating that message is a valid Gravity Form message. If message is invalid, don't display anything&nbsp;</div></li><li><div>        if ( substr( $message, 0, 10 ) != '&lt;!--GFM--&gt;' ) {&nbsp;</div></li><li><div>            $message = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_option( 'rg_gforms_message', $message );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function post_to_manager( $file, $query, $options ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $request_url = GRAVITY_MANAGER_URL . '/' . $file . '?' . $query;&nbsp;</div></li><li><div>        self::log_debug( 'Posting to manager: ' . $request_url );&nbsp;</div></li><li><div>        $raw_response = wp_remote_post( $request_url, $options );&nbsp;</div></li><li><div>        self::log_debug( print_r( $raw_response, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $raw_response ) || 200 != $raw_response['response']['code'] ) {&nbsp;</div></li><li><div>            self::log_error( 'Error from manager. Sending to proxy...' );&nbsp;</div></li><li><div>            $request_url = GRAVITY_MANAGER_PROXY_URL . '/proxy.php?f=' . $file . '&' . $query;&nbsp;</div></li><li><div>            $raw_response = wp_remote_post( $request_url, $options );&nbsp;</div></li><li><div>            self::log_debug( print_r( $raw_response, true ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $raw_response;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_local_timestamp( $timestamp = null ) {&nbsp;</div></li><li><div>        if ( $timestamp == null ) {&nbsp;</div></li><li><div>            $timestamp = time();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $timestamp + ( get_option( 'gmt_offset' ) * 3600 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_gmt_timestamp( $local_timestamp ) {&nbsp;</div></li><li><div>        return $local_timestamp - ( get_option( 'gmt_offset' ) * 3600 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function format_date( $gmt_datetime, $is_human = true, $date_format = '', $include_time = true ) {&nbsp;</div></li><li><div>        if ( empty( $gmt_datetime ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adjusting date to local configured Time Zone&nbsp;</div></li><li><div>        $lead_gmt_time = mysql2date( 'G', $gmt_datetime );&nbsp;</div></li><li><div>        $lead_local_time = self::get_local_timestamp( $lead_gmt_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $date_format ) ) {&nbsp;</div></li><li><div>            $date_format = get_option( 'date_format' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_human ) {&nbsp;</div></li><li><div>            $time_diff = time() - $lead_gmt_time;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $time_diff &gt; 0 && $time_diff &lt; 24 * 60 * 60 ) {&nbsp;</div></li><li><div>                $date_display = sprintf( esc_html__( '%s ago', 'gravityforms' ), human_time_diff( $lead_gmt_time ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $date_display = $include_time ? sprintf( esc_html__( '%1$s at %2$s', 'gravityforms' ), date_i18n( $date_format, $lead_local_time, true ), date_i18n( get_option( 'time_format' ), $lead_local_time, true ) ) : date_i18n( $date_format, $lead_local_time, true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $date_display = $include_time ? sprintf( esc_html__( '%1$s at %2$s', 'gravityforms' ), date_i18n( $date_format, $lead_local_time, true ), date_i18n( get_option( 'time_format' ), $lead_local_time, true ) ) : date_i18n( $date_format, $lead_local_time, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $date_display;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_selection_value( $value ) {&nbsp;</div></li><li><div>        $ary = explode( '|', $value );&nbsp;</div></li><li><div>        $val = $ary[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $val;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function selection_display( $value, $field, $currency = '', $use_text = false ) {&nbsp;</div></li><li><div>        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field !== null && $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>            $ary = explode( '|', $value );&nbsp;</div></li><li><div>            $val = $ary[0];&nbsp;</div></li><li><div>            $price = count( $ary ) &gt; 1 ? $ary[1] : '';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $val = $value;&nbsp;</div></li><li><div>            $price = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_text ) {&nbsp;</div></li><li><div>            $val = RGFormsModel::get_choice_text( $field, $val );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $price ) ) {&nbsp;</div></li><li><div>            return &quot;$val (&quot; . self::to_money( $price, $currency ) . ')';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $val;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function date_display( $value, $input_format = 'mdy', $output_format = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $output_format ) {&nbsp;</div></li><li><div>            $output_format = $input_format;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $date = self::parse_date( $value, $input_format );&nbsp;</div></li><li><div>        if ( empty( $date ) ) {&nbsp;</div></li><li><div>            return $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list( $position, $separator ) = rgexplode( '_', $output_format, 2 );&nbsp;</div></li><li><div>        switch ( $separator ) {&nbsp;</div></li><li><div>            case 'dash' :&nbsp;</div></li><li><div>                $separator = '-';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'dot' :&nbsp;</div></li><li><div>                $separator = '.';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $separator = '/';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $position ) {&nbsp;</div></li><li><div>            case 'year' :&nbsp;</div></li><li><div>            case 'month' :&nbsp;</div></li><li><div>            case 'day' :&nbsp;</div></li><li><div>                return $date[ $position ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'ymd' :&nbsp;</div></li><li><div>                return $date['year'] . $separator . $date['month'] . $separator . $date['day'];&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'dmy' :&nbsp;</div></li><li><div>                return $date['day'] . $separator . $date['month'] . $separator . $date['year'];&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                return $date['month'] . $separator . $date['day'] . $separator . $date['year'];&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function parse_date( $date, $format = 'mdy' ) {&nbsp;</div></li><li><div>        $date_info = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $position = substr( $format, 0, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $date ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $position ) {&nbsp;</div></li><li><div>                case 'mdy' :&nbsp;</div></li><li><div>                    $date_info['month'] = rgar( $date, 0 );&nbsp;</div></li><li><div>                    $date_info['day'] = rgar( $date, 1 );&nbsp;</div></li><li><div>                    $date_info['year'] = rgar( $date, 2 );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'dmy' :&nbsp;</div></li><li><div>                    $date_info['day'] = rgar( $date, 0 );&nbsp;</div></li><li><div>                    $date_info['month'] = rgar( $date, 1 );&nbsp;</div></li><li><div>                    $date_info['year'] = rgar( $date, 2 );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'ymd' :&nbsp;</div></li><li><div>                    $date_info['year'] = rgar( $date, 0 );&nbsp;</div></li><li><div>                    $date_info['month'] = rgar( $date, 1 );&nbsp;</div></li><li><div>                    $date_info['day'] = rgar( $date, 2 );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $date_info;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $date = preg_replace( &quot;|[/\.]|&quot;, '-', $date );&nbsp;</div></li><li><div>        if ( preg_match( '/^(\d{1, 4})-(\d{1, 2})-(\d{1, 4})$/', $date, $matches ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( strlen( $matches[1] ) == 4 ) {&nbsp;</div></li><li><div>                //format yyyy-mm-dd&nbsp;</div></li><li><div>                $date_info['year'] = $matches[1];&nbsp;</div></li><li><div>                $date_info['month'] = $matches[2];&nbsp;</div></li><li><div>                $date_info['day'] = $matches[3];&nbsp;</div></li><li><div>            } else if ( $position == 'mdy' ) {&nbsp;</div></li><li><div>                //format mm-dd-yyyy&nbsp;</div></li><li><div>                $date_info['month'] = $matches[1];&nbsp;</div></li><li><div>                $date_info['day'] = $matches[2];&nbsp;</div></li><li><div>                $date_info['year'] = $matches[3];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                //format dd-mm-yyyy&nbsp;</div></li><li><div>                $date_info['day'] = $matches[1];&nbsp;</div></li><li><div>                $date_info['month'] = $matches[2];&nbsp;</div></li><li><div>                $date_info['year'] = $matches[3];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $date_info;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function truncate_url( $url ) {&nbsp;</div></li><li><div>        $truncated_url = basename( $url );&nbsp;</div></li><li><div>        if ( empty( $truncated_url ) ) {&nbsp;</div></li><li><div>            $truncated_url = dirname( $url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ary = explode( '?', $truncated_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $ary[0];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_field_placeholder_attribute( $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $placeholder_value = GFCommon::replace_variables_prepopulate( $field-&gt;placeholder );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ! empty( $placeholder_value ) ? sprintf( &quot;placeholder='%s'&quot;, esc_attr( $placeholder_value ) ) : '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_input_placeholder_attribute( $input ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $placeholder_value = self::get_input_placeholder_value( $input );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ! empty( $placeholder_value ) ? sprintf( &quot;placeholder='%s'&quot;, esc_attr( $placeholder_value ) ) : '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_input_placeholder_value( $input ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $placeholder = rgar( $input, 'placeholder' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return empty( $placeholder ) ? '' : GFCommon::replace_variables_prepopulate( $placeholder );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_tabindex() {&nbsp;</div></li><li><div>        return GFCommon::$tab_index &gt; 0 ? &quot;tabindex='&quot; . GFCommon::$tab_index ++ . &quot;'&quot; : '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @deprecated&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param GF_Field_Checkbox $field&nbsp;</div></li><li><div>     * @param                   $value&nbsp;</div></li><li><div>     * @param                   $disabled_text&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_checkbox_choices( $field, $value, $disabled_text ) {&nbsp;</div></li><li><div>        _deprecated_function( 'get_checkbox_choices', '1.9', 'GF_Field_Checkbox::get_checkbox_choices' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;get_checkbox_choices( $value, $disabled_text );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @deprecated Deprecated since 1.9. Use GF_Field_Checkbox::get_radio_choices() instead.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param GF_Field_Radio $field&nbsp;</div></li><li><div>     * @param string         $value&nbsp;</div></li><li><div>     * @param                $disabled_text&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_radio_choices( $field, $value = '', $disabled_text ) {&nbsp;</div></li><li><div>        _deprecated_function( 'get_radio_choices', '1.9', 'GF_Field_Checkbox::get_radio_choices' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;get_radio_choices( $value, $disabled_text );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_field_type_title( $type ) {&nbsp;</div></li><li><div>        $gf_field = GF_Fields::get( $type );&nbsp;</div></li><li><div>        if ( ! empty( $gf_field ) ) {&nbsp;</div></li><li><div>            return $gf_field-&gt;get_form_editor_field_title();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'gform_field_type_title', $type, $type );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_select_choices( $field, $value = '', $support_placeholders = true ) {&nbsp;</div></li><li><div>        $choices = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( RG_CURRENT_VIEW == 'entry' && empty( $value ) && empty( $field-&gt;placeholder ) ) {&nbsp;</div></li><li><div>            $choices .= &quot;&lt;option value=''&gt;&lt;/option&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $support_placeholders && ! empty( $field-&gt;placeholder ) ) {&nbsp;</div></li><li><div>                $selected = empty( $value ) ? &quot;selected='selected'&quot; : '';&nbsp;</div></li><li><div>                $choices .= sprintf( &quot;&lt;option value='' %s class='gf_placeholder'&gt;%s&lt;/option&gt;&quot;, $selected, esc_html( $field-&gt;placeholder ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //needed for users upgrading from 1.0&nbsp;</div></li><li><div>                $field_value = ! empty( $choice['value'] ) || $field-&gt;enableChoiceValue || $field-&gt;type == 'post_category' ? $choice['value'] : $choice['text'];&nbsp;</div></li><li><div>                if ( $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>                    $price = rgempty( 'price', $choice ) ? 0 : GFCommon::to_number( rgar( $choice, 'price' ) );&nbsp;</div></li><li><div>                    $field_value .= '|' . $price;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! isset( $_GET['gf_token'] ) && empty( $_POST ) && rgblank( $value ) && RG_CURRENT_VIEW != 'entry' ) {&nbsp;</div></li><li><div>                    $selected = rgar( $choice, 'isSelected' ) ? &quot;selected='selected'&quot; : '';&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                        $is_match = false;&nbsp;</div></li><li><div>                        foreach ( $value as $item ) {&nbsp;</div></li><li><div>                            if ( RGFormsModel::choice_value_match( $field, $choice, $item ) ) {&nbsp;</div></li><li><div>                                $is_match = true;&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $selected = $is_match ? &quot;selected='selected'&quot; : '';&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $selected = RGFormsModel::choice_value_match( $field, $choice, $value ) ? &quot;selected='selected'&quot; : '';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $choice_markup = sprintf( &quot;&lt;option value='%s' %s&gt;%s&lt;/option&gt;&quot;, esc_attr( $field_value ), $selected, esc_html( $choice['text'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $choices .= gf_apply_filters( array( 'gform_field_choice_markup_pre_render', $field-&gt;formId, $field-&gt;id ), $choice_markup, $choice, $field, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $choices;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_section_empty( $section_field, $form, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_key = &quot;GFCommon::is_section_empty_{$form['id']}_{$section_field['id']}&quot;;&nbsp;</div></li><li><div>        $value = GFCache::get( $cache_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $value !== false ) {&nbsp;</div></li><li><div>            return $value == true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = self::get_section_fields( $form, $section_field['id'] );&nbsp;</div></li><li><div>        if ( ! is_array( $fields ) ) {&nbsp;</div></li><li><div>            GFCache::set( $cache_key, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = GFFormsModel::get_lead_field_value( $entry, $field );&nbsp;</div></li><li><div>            $value = GFCommon::get_lead_field_display( $field, $value, rgar( $entry, 'currency' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( rgblank( $value ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // most fields are displayed in the section by default, exceptions are handled below&nbsp;</div></li><li><div>            $is_field_displayed_in_section = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // by default, product fields are not displayed in their containing section (displayed in a product summary table)&nbsp;</div></li><li><div>            // if the filter is used to disable this, product fields are displayed in the section like other fields&nbsp;</div></li><li><div>            if ( self::is_product_field( $field['type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * By default, product fields are not displayed in their containing section (displayed in a product summary table). If the filter is used to disable this, product fields are displayed in the section like other fields&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param array $field The Form Fields Object&nbsp;</div></li><li><div>                 * @param array $form The Form Object&nbsp;</div></li><li><div>                 * @param array $entry The Entry object&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $display_product_summary = apply_filters( 'gform_display_product_summary', true, $field, $form, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $is_field_displayed_in_section = ! $display_product_summary;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $is_field_displayed_in_section ) {&nbsp;</div></li><li><div>                GFCache::set( $cache_key, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCache::set( $cache_key, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_section_fields( $form, $section_field_id ) {&nbsp;</div></li><li><div>        $fields = array();&nbsp;</div></li><li><div>        $in_section = false;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( in_array( $field-&gt;type, array( 'section', 'page' ) ) && $in_section ) {&nbsp;</div></li><li><div>                return $fields;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;id == $section_field_id ) {&nbsp;</div></li><li><div>                $in_section = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $in_section ) {&nbsp;</div></li><li><div>                $fields[] = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_us_state_code( $state_name ) {&nbsp;</div></li><li><div>        return GF_Fields::get( 'address' )-&gt;get_us_state_code( $state_name );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_country_code( $country_name ) {&nbsp;</div></li><li><div>        return GF_Fields::get( 'address' )-&gt;get_country_code( $country_name );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_us_states() {&nbsp;</div></li><li><div>        return GF_Fields::get( 'address' )-&gt;get_us_states();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_canadian_provinces() {&nbsp;</div></li><li><div>        return GF_Fields::get( 'address' )-&gt;get_canadian_provinces();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_post_field( $field ) {&nbsp;</div></li><li><div>        return in_array( $field-&gt;type, array( 'post_title', 'post_tags', 'post_category', 'post_custom_field', 'post_content', 'post_excerpt', 'post_image' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_fields_by_type( $form, $types ) {&nbsp;</div></li><li><div>        return GFAPI::get_fields_by_type( $form, $types );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_pages( $form ) {&nbsp;</div></li><li><div>        return sizeof( GFAPI::get_fields_by_type( $form, array( 'page' ) ) ) &gt; 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_product_fields_by_type( $form, $types, $product_id ) {&nbsp;</div></li><li><div>        global $_product_fields;&nbsp;</div></li><li><div>        $key = json_encode( $types ) . '_' . $product_id . '_' . $form['id'];&nbsp;</div></li><li><div>        if ( ! isset( $_product_fields[ $key ] ) ) {&nbsp;</div></li><li><div>            $fields = array();&nbsp;</div></li><li><div>            for ( $i = 0, $count = sizeof( $form['fields'] ); $i &lt; $count; $i ++ ) {&nbsp;</div></li><li><div>                $field = $form['fields'][ $i ];&nbsp;</div></li><li><div>                if ( in_array( $field-&gt;type, $types ) && $field-&gt;productField == $product_id ) {&nbsp;</div></li><li><div>                    $fields[] = $field;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $_product_fields[ $key ] = $fields;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $_product_fields[ $key ];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @deprecated&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function has_field_calculation( $field ) {&nbsp;</div></li><li><div>        _deprecated_function( 'has_field_calculation', '1.7', 'GF_Field::has_calculation' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;has_calculation();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param string   $value&nbsp;</div></li><li><div>     * @param int      $lead_id&nbsp;</div></li><li><div>     * @param int      $form_id&nbsp;</div></li><li><div>     * @param null     $form&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed|string|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_field_input( $field, $value = '', $lead_id = 0, $form_id = 0, $form = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $field instanceof GF_Field ) {&nbsp;</div></li><li><div>            $field = GF_Fields::create( $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = intval( $field-&gt;id );&nbsp;</div></li><li><div>        $field_id = $is_admin || $form_id == 0 ? &quot;input_$id&quot; : 'input_' . $form_id . &quot;_$id&quot;;&nbsp;</div></li><li><div>        $form_id = $is_admin && empty( $form_id ) ? rgget( 'id' ) : $form_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( RG_CURRENT_VIEW == 'entry' ) {&nbsp;</div></li><li><div>            $lead = RGFormsModel::get_lead( $lead_id );&nbsp;</div></li><li><div>            $post_id = $lead['post_id'];&nbsp;</div></li><li><div>            $post_link = '';&nbsp;</div></li><li><div>            if ( is_numeric( $post_id ) && self::is_post_field( $field ) ) {&nbsp;</div></li><li><div>                $post_link = &quot;&lt;div&gt;You can &lt;a href='post.php?action=edit&post=$post_id'&gt;edit this post&lt;/a&gt; from the post page.&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_input = apply_filters( 'gform_field_input', '', $field, $value, $lead_id, $form_id );&nbsp;</div></li><li><div>        if ( $field_input ) {&nbsp;</div></li><li><div>            return $field_input;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //product fields are not editable&nbsp;</div></li><li><div>        if ( RG_CURRENT_VIEW == 'entry' && self::is_product_field( $field-&gt;type ) ) {&nbsp;</div></li><li><div>            return &quot;&lt;div class='ginput_container'&gt;&quot; . esc_html__( 'Product fields are not editable' , 'gravityforms' ) . '&lt;/div&gt;';&nbsp;</div></li><li><div>        } else if ( RG_CURRENT_VIEW == 'entry' && $field-&gt;type == 'donation' ) {&nbsp;</div></li><li><div>            return &quot;&lt;div class='ginput_container'&gt;&quot; . esc_html__( 'Donations are not editable' , 'gravityforms' ) . '&lt;/div&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add categories as choices for Post Category field&nbsp;</div></li><li><div>        if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>            $field = self::add_categories_as_choices( $field, $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>        switch ( $type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'honeypot':&nbsp;</div></li><li><div>                $autocomplete = RGFormsModel::is_html5_enabled() ? &quot;autocomplete='off'&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return &quot;&lt;div class='ginput_container'&gt;&lt;input name='input_{$id}' id='{$field_id}' type='text' value='' {$autocomplete}/&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'adminonly_hidden' :&nbsp;</div></li><li><div>                if ( ! is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>                    if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                        $value = json_encode( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return sprintf( &quot;&lt;input name='input_%d' id='%s' class='gform_hidden' type='hidden' value='%s'/&gt;&quot;, $id, esc_attr( $field_id ), esc_attr( $value ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $fields = '';&nbsp;</div></li><li><div>                foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                    $fields .= sprintf( &quot;&lt;input name='input_%s' class='gform_hidden' type='hidden' value='%s'/&gt;&quot;, $input['id'], esc_attr( rgar( $value, strval( $input['id'] ) ) ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $fields;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $post_link ) ) {&nbsp;</div></li><li><div>                    return $post_link;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! isset( $lead ) ) {&nbsp;</div></li><li><div>                    $lead = null;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $field-&gt;get_field_input( $form, $value, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_ssl() {&nbsp;</div></li><li><div>        global $wordpress_https;&nbsp;</div></li><li><div>        $is_ssl = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_https_plugin = class_exists( 'WordPressHTTPS' ) && isset( $wordpress_https );&nbsp;</div></li><li><div>        $has_is_ssl_method = $has_https_plugin && method_exists( 'WordPressHTTPS', 'is_ssl' );&nbsp;</div></li><li><div>        $has_isSsl_method = $has_https_plugin && method_exists( 'WordPressHTTPS', 'isSsl' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Use the WordPress HTTPs plugin if installed&nbsp;</div></li><li><div>        if ( $has_https_plugin && $has_is_ssl_method ) {&nbsp;</div></li><li><div>            $is_ssl = $wordpress_https-&gt;is_ssl();&nbsp;</div></li><li><div>        } else if ( $has_https_plugin && $has_isSsl_method ) {&nbsp;</div></li><li><div>            $is_ssl = $wordpress_https-&gt;isSsl();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $is_ssl = is_ssl();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $is_ssl && isset( $_SERVER['HTTP_CF_VISITOR'] ) && strpos( $_SERVER['HTTP_CF_VISITOR'], 'https' ) ) {&nbsp;</div></li><li><div>            $is_ssl = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'gform_is_ssl', $is_ssl );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_preview() {&nbsp;</div></li><li><div>        $url_info = parse_url( RGFormsModel::get_current_page_url() );&nbsp;</div></li><li><div>        $file_name = basename( $url_info['path'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $file_name == 'preview.php' || rgget( 'gf_page', $_GET ) == 'preview';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function clean_extensions( $extensions ) {&nbsp;</div></li><li><div>        $count = sizeof( $extensions );&nbsp;</div></li><li><div>        for ( $i = 0; $i &lt; $count; $i ++ ) {&nbsp;</div></li><li><div>            $extensions[ $i ] = str_replace( '.', '', str_replace( ' ', '', $extensions[ $i ] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $extensions;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_disallowed_file_extensions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $extensions = array( 'php', 'asp', 'aspx', 'cmd', 'csh', 'bat', 'html', 'hta', 'jar', 'exe', 'com', 'js', 'lnk', 'htaccess', 'phtml', 'ps1', 'ps2', 'php3', 'php4', 'php5', 'php6', 'py', 'rb', 'tmp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Intended for internal use - not to be included in the documentation.&nbsp;</div></li><li><div>        $extensions = apply_filters( 'gform_disallowed_file_extensions', $extensions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $extensions;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function match_file_extension( $file_name, $extensions ) {&nbsp;</div></li><li><div>        if ( empty ( $extensions ) || ! is_array( $extensions ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ext = strtolower( pathinfo( $file_name, PATHINFO_EXTENSION ) );&nbsp;</div></li><li><div>        if ( in_array( $ext, $extensions ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function file_name_has_disallowed_extension( $file_name ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::match_file_extension( $file_name, self::get_disallowed_file_extensions() ) || strpos( strtolower( $file_name ), '.php.' ) !== false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function check_type_and_ext( $file, $file_name = '') {&nbsp;</div></li><li><div>        if ( empty( $file_name ) ) {&nbsp;</div></li><li><div>            $file_name = $file['name'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $tmp_name = $file['tmp_name'];&nbsp;</div></li><li><div>        // Whitelist the mime type and extension&nbsp;</div></li><li><div>        $wp_filetype = wp_check_filetype_and_ext( $tmp_name, $file_name );&nbsp;</div></li><li><div>        $ext = empty( $wp_filetype['ext'] ) ? '' : $wp_filetype['ext'];&nbsp;</div></li><li><div>        $type = empty( $wp_filetype['type'] ) ? '' : $wp_filetype['type'];&nbsp;</div></li><li><div>        $proper_filename = empty( $wp_filetype['proper_filename'] ) ? '' : $wp_filetype['proper_filename'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $proper_filename ) {&nbsp;</div></li><li><div>            return new WP_Error( 'invalid_file', esc_html__( 'There was an problem while verifying your file.' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! $ext ) {&nbsp;</div></li><li><div>            return new WP_Error( 'illegal_extension', esc_html__( 'Sorry, this file extension is not permitted for security reasons.' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! $type ) {&nbsp;</div></li><li><div>            return new WP_Error( 'illegal_type', esc_html__( 'Sorry, this file type is not permitted for security reasons.' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function to_money( $number, $currency_code = '' ) {&nbsp;</div></li><li><div>        if ( ! class_exists( 'RGCurrency' ) ) {&nbsp;</div></li><li><div>            require_once( 'currency.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $currency_code ) ) {&nbsp;</div></li><li><div>            $currency_code = self::get_currency();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $currency = new RGCurrency( $currency_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $currency-&gt;to_money( $number );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function to_number( $text, $currency_code = '' ) {&nbsp;</div></li><li><div>        if ( ! class_exists( 'RGCurrency' ) ) {&nbsp;</div></li><li><div>            require_once( 'currency.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $currency_code ) ) {&nbsp;</div></li><li><div>            $currency_code = self::get_currency();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $currency = new RGCurrency( $currency_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $currency-&gt;to_number( $text );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_currency() {&nbsp;</div></li><li><div>        $currency = get_option( 'rg_gforms_currency' );&nbsp;</div></li><li><div>        $currency = empty( $currency ) ? 'USD' : $currency;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'gform_currency', $currency );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_simple_captcha() {&nbsp;</div></li><li><div>        _deprecated_function( 'GFCommon::get_simple_captcha', '1.9', 'GFField_CAPTCHA::get_simple_captcha' );&nbsp;</div></li><li><div>        $captcha = new ReallySimpleCaptcha();&nbsp;</div></li><li><div>        $captcha-&gt;tmp_dir = RGFormsModel::get_upload_path( 'captcha' ) . '/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $captcha;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @deprecated&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param GF_Field_CAPTCH $field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_captcha( $field ) {&nbsp;</div></li><li><div>        _deprecated_function( 'GFCommon::get_captcha', '1.9', 'GFField_CAPTCHA::get_captcha' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;get_captcha();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @deprecated&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $field&nbsp;</div></li><li><div>     * @param $pos&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_math_captcha( $field, $pos ) {&nbsp;</div></li><li><div>        _deprecated_function( 'GFCommon::get_math_captcha', '1.9', 'GFField_CAPTCHA::get_math_captcha' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;get_math_captcha( $pos );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param          $value&nbsp;</div></li><li><div>     * @param string   $currency&nbsp;</div></li><li><div>     * @param bool     $use_text&nbsp;</div></li><li><div>     * @param string   $format&nbsp;</div></li><li><div>     * @param string   $media&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|mixed|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_lead_field_display( $field, $value, $currency = '', $use_text = false, $format = 'html', $media = 'screen' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $field instanceof GF_Field ) {&nbsp;</div></li><li><div>            $field = GF_Fields::create( $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>            $value = self::prepare_post_category_value( $value, $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;get_value_entry_detail( $value, $currency, $use_text, $format, $media );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_product_fields( $form, $lead, $use_choice_text = false, $use_admin_label = false ) {&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_info = null;&nbsp;</div></li><li><div>        // retrieve static copy of product info (only for 'real' entries)&nbsp;</div></li><li><div>        if ( ! rgempty( 'id', $lead ) ) {&nbsp;</div></li><li><div>            $product_info = gform_get_meta( rgar( $lead, 'id' ), &quot;gform_product_info_{$use_choice_text}_{$use_admin_label}&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if no static copy, generate from form/lead info&nbsp;</div></li><li><div>        if ( ! $product_info ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                $id = $field-&gt;id;&nbsp;</div></li><li><div>                $lead_value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $quantity_field = self::get_product_fields_by_type( $form, array( 'quantity' ), $id );&nbsp;</div></li><li><div>                $quantity = sizeof( $quantity_field ) &gt; 0 && ! RGFormsModel::is_field_hidden( $form, $quantity_field[0], array(), $lead ) ? RGFormsModel::get_lead_field_value( $lead, $quantity_field[0] ) : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( $field-&gt;type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'product' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        //ignore products that have been hidden by conditional logic&nbsp;</div></li><li><div>                        $is_hidden = RGFormsModel::is_field_hidden( $form, $field, array(), $lead );&nbsp;</div></li><li><div>                        if ( $is_hidden ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        //if single product, get values from the multiple inputs&nbsp;</div></li><li><div>                        if ( is_array( $lead_value ) ) {&nbsp;</div></li><li><div>                            $product_quantity = sizeof( $quantity_field ) == 0 && ! $field-&gt;disableQuantity ? rgget( $id . '.3', $lead_value ) : $quantity;&nbsp;</div></li><li><div>                            if ( empty( $product_quantity ) ) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( ! rgget( $id, $products ) ) {&nbsp;</div></li><li><div>                                $products[ $id ] = array();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $products[ $id ]['name'] = $use_admin_label && ! rgempty( 'adminLabel', $field ) ? $field-&gt;adminLabel : $lead_value[ $id . '.1' ];&nbsp;</div></li><li><div>                            $products[ $id ]['price'] = rgar( $lead_value, $id . '.2' );&nbsp;</div></li><li><div>                            $products[ $id ]['quantity'] = $product_quantity;&nbsp;</div></li><li><div>                        } elseif ( ! empty( $lead_value ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( empty( $quantity ) ) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( ! rgar( $products, $id ) ) {&nbsp;</div></li><li><div>                                $products[ $id ] = array();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( $field-&gt;inputType == 'price' ) {&nbsp;</div></li><li><div>                                $name = $field-&gt;label;&nbsp;</div></li><li><div>                                $price = $lead_value;&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                list( $name, $price ) = explode( '|', $lead_value );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $products[ $id ]['name'] = ! $use_choice_text ? $name : RGFormsModel::get_choice_text( $field, $name );&nbsp;</div></li><li><div>                            $include_field_label = apply_filters( 'gform_product_info_name_include_field_label', false );&nbsp;</div></li><li><div>                            if ( $field-&gt;inputType == ( 'radio' || 'select' ) && $include_field_label ) {&nbsp;</div></li><li><div>                                $products[ $id ]['name'] = $field-&gt;label . &quot; ({$products[$id]['name']})&quot;;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $products[ $id ]['price'] = $price;&nbsp;</div></li><li><div>                            $products[ $id ]['quantity'] = $quantity;&nbsp;</div></li><li><div>                            $products[ $id ]['options'] = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( isset( $products[ $id ] ) ) {&nbsp;</div></li><li><div>                            $options = self::get_product_fields_by_type( $form, array( 'option' ), $id );&nbsp;</div></li><li><div>                            foreach ( $options as $option ) {&nbsp;</div></li><li><div>                                $option_value = RGFormsModel::get_lead_field_value( $lead, $option );&nbsp;</div></li><li><div>                                $option_label = empty( $option['adminLabel'] ) ? $option['label'] : $option['adminLabel'];&nbsp;</div></li><li><div>                                if ( is_array( $option_value ) ) {&nbsp;</div></li><li><div>                                    foreach ( $option_value as $value ) {&nbsp;</div></li><li><div>                                        $option_info = self::get_option_info( $value, $option, $use_choice_text );&nbsp;</div></li><li><div>                                        if ( ! empty( $option_info ) ) {&nbsp;</div></li><li><div>                                            $products[ $id ]['options'][] = array( 'field_label' =&gt; rgar( $option, 'label' ), &nbsp;</div></li><li><div>                                                                                   'option_name' =&gt; rgar( $option_info, 'name' ), &nbsp;</div></li><li><div>                                                                                   'option_label' =&gt; $option_label . ': ' . rgar( $option_info, 'name' ), &nbsp;</div></li><li><div>                                                                                   'price' =&gt; rgar( $option_info, 'price' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } elseif ( ! empty( $option_value ) ) {&nbsp;</div></li><li><div>                                    $option_info = self::get_option_info( $option_value, $option, $use_choice_text );&nbsp;</div></li><li><div>                                    $products[ $id ]['options'][] = array( 'field_label' =&gt; rgar( $option, 'label' ), &nbsp;</div></li><li><div>                                                                           'option_name' =&gt; rgar( $option_info, 'name' ), &nbsp;</div></li><li><div>                                                                           'option_label' =&gt; $option_label . ': ' . rgar( $option_info, 'name' ), &nbsp;</div></li><li><div>                                                                           'price' =&gt; rgar( $option_info, 'price' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $shipping_field = GFAPI::get_fields_by_type( $form, array( 'shipping' ) );&nbsp;</div></li><li><div>            $shipping_price = $shipping_name = '';&nbsp;</div></li><li><div>            $shipping_field_id = '';&nbsp;</div></li><li><div>            if ( ! empty( $shipping_field ) && ! RGFormsModel::is_field_hidden( $form, $shipping_field[0], array(), $lead ) ) {&nbsp;</div></li><li><div>                $shipping_price = RGFormsModel::get_lead_field_value( $lead, $shipping_field[0] );&nbsp;</div></li><li><div>                $shipping_name = $shipping_field[0]['label'];&nbsp;</div></li><li><div>                $shipping_field_id = $shipping_field[0]['id'];&nbsp;</div></li><li><div>                if ( $shipping_field[0]['inputType'] != 'singleshipping' && ! empty( $shipping_price ) ) {&nbsp;</div></li><li><div>                    list( $shipping_method, $shipping_price ) = explode( '|', $shipping_price );&nbsp;</div></li><li><div>                    $shipping_name = $shipping_field[0]['label'] . &quot; ($shipping_method)&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $shipping_price = self::to_number( $shipping_price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_info = array( 'products' =&gt; $products, 'shipping' =&gt; array( 'id' =&gt; $shipping_field_id, 'name' =&gt; $shipping_name, 'price' =&gt; $shipping_price ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_info = gf_apply_filters( array( 'gform_product_info', $form['id'] ), $product_info, $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // save static copy of product info (only for 'real' entries)&nbsp;</div></li><li><div>            if ( ! rgempty( 'id', $lead ) && ! empty( $product_info['products'] ) ) {&nbsp;</div></li><li><div>                gform_update_meta( $lead['id'], &quot;gform_product_info_{$use_choice_text}_{$use_admin_label}&quot;, $product_info );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product_info;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_order_total( $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $products = self::get_product_fields( $form, $lead, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::get_total( $products );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_total( $products ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $total = 0;&nbsp;</div></li><li><div>        foreach ( $products['products'] as $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $price = self::to_number( $product['price'] );&nbsp;</div></li><li><div>            if ( is_array( rgar( $product, 'options' ) ) ) {&nbsp;</div></li><li><div>                foreach ( $product['options'] as $option ) {&nbsp;</div></li><li><div>                    $price += self::to_number( $option['price'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $subtotal = floatval( $product['quantity'] ) * $price;&nbsp;</div></li><li><div>            $total += $subtotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $total += floatval( $products['shipping']['price'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_option_info( $value, $option, $use_choice_text ) {&nbsp;</div></li><li><div>        if ( empty( $value ) ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list( $name, $price ) = explode( '|', $value );&nbsp;</div></li><li><div>        if ( $use_choice_text ) {&nbsp;</div></li><li><div>            $name = RGFormsModel::get_choice_text( $option, $name );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'name' =&gt; $name, 'price' =&gt; $price );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function gform_do_shortcode( $content ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_ajax = false;&nbsp;</div></li><li><div>        $forms = GFFormDisplay::get_embedded_forms( $content, $is_ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $forms as $form ) {&nbsp;</div></li><li><div>            if ( headers_sent() ) {&nbsp;</div></li><li><div>                GFFormDisplay::print_form_scripts( $form, $is_ajax );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                GFFormDisplay::enqueue_form_scripts( $form, $is_ajax );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return do_shortcode( $content );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function spam_enabled( $form_id ) {&nbsp;</div></li><li><div>        $spam_enabled = self::akismet_enabled( $form_id ) || has_filter( 'gform_entry_is_spam' ) || has_filter( &quot;gform_entry_is_spam_{$form_id}&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $spam_enabled;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_akismet() {&nbsp;</div></li><li><div>        $akismet_exists = function_exists( 'akismet_http_post' ) || function_exists( 'Akismet::http_post' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $akismet_exists;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function akismet_enabled( $form_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! self::has_akismet() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if no option is set, leave akismet enabled; otherwise, use option value true/false&nbsp;</div></li><li><div>        $enabled_by_setting = get_option( 'rg_gforms_enable_akismet' ) === false ? true : get_option( 'rg_gforms_enable_akismet' ) == true;&nbsp;</div></li><li><div>        $enabled_by_filter = gf_apply_filters( array( 'gform_akismet_enabled', $form_id ), $enabled_by_setting );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $enabled_by_filter;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_akismet_spam( $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $akismet_api_host, $akismet_api_port;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = self::get_akismet_fields( $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Submitting info to Akismet&nbsp;</div></li><li><div>        if ( defined( 'AKISMET_VERSION' ) && AKISMET_VERSION &lt; 3.0 ) {&nbsp;</div></li><li><div>            //Akismet versions before 3.0&nbsp;</div></li><li><div>            $response = akismet_http_post( $fields, $akismet_api_host, '/1.1/comment-check', $akismet_api_port );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $response = Akismet::http_post( $fields, 'comment-check' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $is_spam = trim( rgar( $response, 1 ) ) == 'true';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_spam;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function mark_akismet_spam( $form, $lead, $is_spam ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $akismet_api_host, $akismet_api_port;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = self::get_akismet_fields( $form, $lead );&nbsp;</div></li><li><div>        $as = $is_spam ? 'spam' : 'ham';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Submitting info to Akismet&nbsp;</div></li><li><div>        if ( defined( 'AKISMET_VERSION' ) && AKISMET_VERSION &lt; 3.0 ) {&nbsp;</div></li><li><div>            //Akismet versions before 3.0&nbsp;</div></li><li><div>            akismet_http_post( $fields, $akismet_api_host, '/1.1/submit-' . $as, $akismet_api_port );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            Akismet::http_post( $fields, 'submit-' . $as );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_akismet_fields( $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Gathering Akismet information&nbsp;</div></li><li><div>        $akismet_info = array();&nbsp;</div></li><li><div>        $akismet_info['comment_type'] = 'gravity_form';&nbsp;</div></li><li><div>        $akismet_info['comment_author'] = self::get_akismet_field( 'name', $form, $lead );&nbsp;</div></li><li><div>        $akismet_info['comment_author_email'] = self::get_akismet_field( 'email', $form, $lead );&nbsp;</div></li><li><div>        $akismet_info['comment_author_url'] = self::get_akismet_field( 'website', $form, $lead );&nbsp;</div></li><li><div>        $akismet_info['comment_content'] = self::get_akismet_field( 'textarea', $form, $lead );&nbsp;</div></li><li><div>        $akismet_info['contact_form_subject'] = $form['title'];&nbsp;</div></li><li><div>        $akismet_info['comment_author_IP'] = $lead['ip'];&nbsp;</div></li><li><div>        $akismet_info['permalink'] = $lead['source_url'];&nbsp;</div></li><li><div>        $akismet_info['user_ip'] = preg_replace( '/[^0-9., ]/', '', $lead['ip'] );&nbsp;</div></li><li><div>        $akismet_info['user_agent'] = $lead['user_agent'];&nbsp;</div></li><li><div>        $akismet_info['referrer'] = $is_admin ? '' : $_SERVER['HTTP_REFERER'];&nbsp;</div></li><li><div>        $akismet_info['blog'] = get_option( 'home' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $akismet_info = gf_apply_filters( array( 'gform_akismet_fields', $form['id'] ), $akismet_info, $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return http_build_query( $akismet_info );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_akismet_field( $field_type, $form, $lead ) {&nbsp;</div></li><li><div>        $fields = GFAPI::get_fields_by_type( $form, array( $field_type ) );&nbsp;</div></li><li><div>        if ( empty( $fields ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = RGFormsModel::get_lead_field_value( $lead, $fields[0] );&nbsp;</div></li><li><div>        switch ( $field_type ) {&nbsp;</div></li><li><div>            case 'name' :&nbsp;</div></li><li><div>                $value = GFCommon::get_lead_field_display( $fields[0], $value );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_other_choice_value() {&nbsp;</div></li><li><div>        $value = apply_filters( 'gform_other_choice_value', esc_html__( 'Other' , 'gravityforms' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_browser_class() {&nbsp;</div></li><li><div>        global $is_lynx, $is_gecko, $is_IE, $is_opera, $is_NS4, $is_safari, $is_chrome, $is_iphone, $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $classes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding browser related class&nbsp;</div></li><li><div>        if ( $is_lynx ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_lynx';&nbsp;</div></li><li><div>        } else if ( $is_gecko ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_gecko';&nbsp;</div></li><li><div>        } else if ( $is_opera ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_opera';&nbsp;</div></li><li><div>        } else if ( $is_NS4 ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_ns4';&nbsp;</div></li><li><div>        } else if ( $is_safari ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_safari';&nbsp;</div></li><li><div>        } else if ( $is_chrome ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_chrome';&nbsp;</div></li><li><div>        } else if ( $is_IE ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_ie';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_unknown';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding IE version&nbsp;</div></li><li><div>        if ( $is_IE ) {&nbsp;</div></li><li><div>            if ( strpos( $_SERVER['HTTP_USER_AGENT'], 'MSIE 6' ) !== false ) {&nbsp;</div></li><li><div>                $classes[] = 'gf_browser_ie6';&nbsp;</div></li><li><div>            } else if ( strpos( $_SERVER['HTTP_USER_AGENT'], 'MSIE 7' ) !== false ) {&nbsp;</div></li><li><div>                $classes[] = 'gf_browser_ie7';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( strpos( $_SERVER['HTTP_USER_AGENT'], 'MSIE 8' ) !== false ) {&nbsp;</div></li><li><div>                $classes[] = 'gf_browser_ie8';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( strpos( $_SERVER['HTTP_USER_AGENT'], 'MSIE 9' ) !== false ) {&nbsp;</div></li><li><div>                $classes[] = 'gf_browser_ie9';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_iphone ) {&nbsp;</div></li><li><div>            $classes[] = 'gf_browser_iphone';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return implode( ' ', $classes );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function create_post( $form, &$lead ) {&nbsp;</div></li><li><div>        $disable_post = gf_apply_filters( array( 'gform_disable_post_creation', $form['id'] ), false, $form, $lead );&nbsp;</div></li><li><div>        $post_id = 0;&nbsp;</div></li><li><div>        if ( ! $disable_post ) {&nbsp;</div></li><li><div>            //creates post if the form has any post fields&nbsp;</div></li><li><div>            $post_id = RGFormsModel::create_post( $form, $lead );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $post_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function evaluate_conditional_logic( $logic, $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $logic || ! is_array( rgar( $logic, 'rules' ) ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry_meta_keys = array_keys( GFFormsModel::get_entry_meta( $form['id'] ) );&nbsp;</div></li><li><div>        $match_count = 0;&nbsp;</div></li><li><div>        if ( is_array( $logic['rules'] ) ) {&nbsp;</div></li><li><div>            foreach ( $logic['rules'] as $rule ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( in_array( $rule['fieldId'], $entry_meta_keys ) ) {&nbsp;</div></li><li><div>                    $is_value_match = GFFormsModel::is_value_match( rgar( $lead, $rule['fieldId'] ), $rule['value'], $rule['operator'], $rule, $form );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $source_field = GFFormsModel::get_field( $form, $rule['fieldId'] );&nbsp;</div></li><li><div>                    $field_value = empty( $lead ) ? GFFormsModel::get_field_value( $source_field, array() ) : GFFormsModel::get_lead_field_value( $lead, $source_field );&nbsp;</div></li><li><div>                    $is_value_match = GFFormsModel::is_value_match( $field_value, $rule['value'], $rule['operator'], $source_field, $rule, $form );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $is_value_match ) {&nbsp;</div></li><li><div>                    $match_count ++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $do_action = ( $logic['logicType'] == 'all' && $match_count == sizeof( $logic['rules'] ) ) || ( $logic['logicType'] == 'any' && $match_count &gt; 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $do_action;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_card_types() {&nbsp;</div></li><li><div>        $cards = array(&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'name' =&gt; 'American Express', &nbsp;</div></li><li><div>                'slug' =&gt; 'amex', &nbsp;</div></li><li><div>                'lengths' =&gt; '15', &nbsp;</div></li><li><div>                'prefixes' =&gt; '34, 37', &nbsp;</div></li><li><div>                'checksum' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'name' =&gt; 'Discover', &nbsp;</div></li><li><div>                'slug' =&gt; 'discover', &nbsp;</div></li><li><div>                'lengths' =&gt; '16', &nbsp;</div></li><li><div>                'prefixes' =&gt; '6011, 622, 64, 65', &nbsp;</div></li><li><div>                'checksum' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'name' =&gt; 'MasterCard', &nbsp;</div></li><li><div>                'slug' =&gt; 'mastercard', &nbsp;</div></li><li><div>                'lengths' =&gt; '16', &nbsp;</div></li><li><div>                'prefixes' =&gt; '51, 52, 53, 54, 55', &nbsp;</div></li><li><div>                'checksum' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'name' =&gt; 'Visa', &nbsp;</div></li><li><div>                'slug' =&gt; 'visa', &nbsp;</div></li><li><div>                'lengths' =&gt; '13, 16', &nbsp;</div></li><li><div>                'prefixes' =&gt; '4, 417500, 4917, 4913, 4508, 4844', &nbsp;</div></li><li><div>                'checksum' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'name' =&gt; 'JCB', &nbsp;</div></li><li><div>                'slug' =&gt; 'jcb', &nbsp;</div></li><li><div>                'lengths' =&gt; '16', &nbsp;</div></li><li><div>                'prefixes' =&gt; '35', &nbsp;</div></li><li><div>                'checksum' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'name' =&gt; 'Maestro', &nbsp;</div></li><li><div>                'slug' =&gt; 'maestro', &nbsp;</div></li><li><div>                'lengths' =&gt; '12, 13, 14, 15, 16, 18, 19', &nbsp;</div></li><li><div>                'prefixes' =&gt; '5018, 5020, 5038, 6304, 6759, 6761', &nbsp;</div></li><li><div>                'checksum' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cards = apply_filters( 'gform_creditcard_types', $cards );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $cards;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_card_type( $number ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //removing spaces from number&nbsp;</div></li><li><div>        $number = str_replace( ' ', '', $number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $number ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cards = self::get_card_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $matched_card = false;&nbsp;</div></li><li><div>        foreach ( $cards as $card ) {&nbsp;</div></li><li><div>            if ( self::matches_card_type( $number, $card ) ) {&nbsp;</div></li><li><div>                $matched_card = $card;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $matched_card && $matched_card['checksum'] && ! self::is_valid_card_checksum( $number ) ) {&nbsp;</div></li><li><div>            $matched_card = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $matched_card ? $matched_card : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function matches_card_type( $number, $card ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //checking prefix&nbsp;</div></li><li><div>        $prefixes = explode( ', ', $card['prefixes'] );&nbsp;</div></li><li><div>        $matches_prefix = false;&nbsp;</div></li><li><div>        foreach ( $prefixes as $prefix ) {&nbsp;</div></li><li><div>            if ( preg_match( &quot;|^{$prefix}|&quot;, $number ) ) {&nbsp;</div></li><li><div>                $matches_prefix = true;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //checking length&nbsp;</div></li><li><div>        $lengths = explode( ', ', $card['lengths'] );&nbsp;</div></li><li><div>        $matches_length = false;&nbsp;</div></li><li><div>        foreach ( $lengths as $length ) {&nbsp;</div></li><li><div>            if ( strlen( $number ) == absint( $length ) ) {&nbsp;</div></li><li><div>                $matches_length = true;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $matches_prefix && $matches_length;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function is_valid_card_checksum( $number ) {&nbsp;</div></li><li><div>        $checksum = 0;&nbsp;</div></li><li><div>        $num = 0;&nbsp;</div></li><li><div>        $multiplier = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Process each character starting at the right&nbsp;</div></li><li><div>        for ( $i = strlen( $number ) - 1; $i &gt;= 0; $i -- ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Multiply current digit by multiplier (1 or 2)&nbsp;</div></li><li><div>            $num = $number{$i} * $multiplier;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If the result is in greater than 9, add 1 to the checksum total&nbsp;</div></li><li><div>            if ( $num &gt;= 10 ) {&nbsp;</div></li><li><div>                $checksum ++;&nbsp;</div></li><li><div>                $num -= 10;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Update checksum&nbsp;</div></li><li><div>            $checksum += $num;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Update multiplier&nbsp;</div></li><li><div>            $multiplier = $multiplier == 1 ? 2 : 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $checksum % 10 == 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_wp_version( $min_version ) {&nbsp;</div></li><li><div>        return ! version_compare( get_bloginfo( 'version' ), &quot;{$min_version}.dev1&quot;, '&lt;' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_categories_as_choices( $field, $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $choices = $inputs = array();&nbsp;</div></li><li><div>        $is_post = isset( $_POST['gform_submit'] );&nbsp;</div></li><li><div>        $has_placeholder = $field-&gt;categoryInitialItemEnabled && RGFormsModel::get_input_type( $field ) == 'select';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $has_placeholder ) {&nbsp;</div></li><li><div>            $choices[] = array( 'text' =&gt; $field-&gt;categoryInitialItem, 'value' =&gt; '', 'isSelected' =&gt; true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $display_all = $field-&gt;displayAllCategories;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array( 'hide_empty' =&gt; false, 'orderby' =&gt; 'name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $display_all ) {&nbsp;</div></li><li><div>            foreach ( $field-&gt;choices as $field_choice_to_include ) {&nbsp;</div></li><li><div>                $args['include'][] = $field_choice_to_include['value'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = gf_apply_filters( array( 'gform_post_category_args', $field-&gt;id ), $args, $field );&nbsp;</div></li><li><div>        $terms = get_terms( 'category', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $terms_copy = unserialize( serialize( $terms ) ); // deep copy the terms to avoid repeating GFCategoryWalker on previously cached terms.&nbsp;</div></li><li><div>        $walker = new GFCategoryWalker();&nbsp;</div></li><li><div>        $categories = $walker-&gt;walk( $terms_copy, 0, array( 0 ) ); // 3rd parameter prevents notices triggered by $walker::display_element() function which checks $args[0]&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $categories as $category ) {&nbsp;</div></li><li><div>            if ( $display_all ) {&nbsp;</div></li><li><div>                $selected = $value == $category-&gt;term_id ||&nbsp;</div></li><li><div>                    (&nbsp;</div></li><li><div>                        empty( $value ) &&&nbsp;</div></li><li><div>                        get_option( 'default_category' ) == $category-&gt;term_id &&&nbsp;</div></li><li><div>                        RGFormsModel::get_input_type( $field ) == 'select' && // only preselect default category on select fields&nbsp;</div></li><li><div>                        ! $is_post &&&nbsp;</div></li><li><div>                        ! $has_placeholder&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $choices[] = array( 'text' =&gt; $category-&gt;name, 'value' =&gt; $category-&gt;term_id, 'isSelected' =&gt; $selected );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                foreach ( $field-&gt;choices as $field_choice ) {&nbsp;</div></li><li><div>                    if ( $field_choice['value'] == $category-&gt;term_id ) {&nbsp;</div></li><li><div>                        $choices[] = array( 'text' =&gt; $category-&gt;name, 'value' =&gt; $category-&gt;term_id );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $choices ) ) {&nbsp;</div></li><li><div>            $choices[] = array( 'text' =&gt; 'You must select at least one category.', 'value' =&gt; '' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $choice_number = 1;&nbsp;</div></li><li><div>        foreach ( $choices as $choice ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $choice_number % 10 == 0 ) {&nbsp;</div></li><li><div>                //hack to skip numbers ending in 0. so that 5.1 doesn't conflict with 5.10&nbsp;</div></li><li><div>                $choice_number ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $input_id = $field-&gt;id . '.' . $choice_number;&nbsp;</div></li><li><div>            $inputs[] = array( 'id' =&gt; $input_id, 'label' =&gt; $choice['text'], 'name' =&gt; '' );&nbsp;</div></li><li><div>            $choice_number ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field-&gt;choices = $choices;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = $is_admin ? rgget( 'id' ) : $field-&gt;formId;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allows you to filter (modify) the post cateogry choices when using post fields&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $field The Cateogry choices field&nbsp;</div></li><li><div>         * @param int $form_id The CUrrent form ID&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $field-&gt;choices = gf_apply_filters( array( 'gform_post_category_choices', $form_id, $field-&gt;id ), $field-&gt;choices, $field, $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( RGFormsModel::get_input_type( $field ) == 'checkbox' ) {&nbsp;</div></li><li><div>            $field-&gt;inputs = $inputs;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function prepare_post_category_value( $value, $field, $mode = 'entry_detail' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $value ) ) {&nbsp;</div></li><li><div>            $value = explode( ', ', $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cat_names = array();&nbsp;</div></li><li><div>        $cat_ids = array();&nbsp;</div></li><li><div>        foreach ( $value as $cat_string ) {&nbsp;</div></li><li><div>            $ary = explode( ':', $cat_string );&nbsp;</div></li><li><div>            $cat_name = count( $ary ) &gt; 0 ? $ary[0] : '';&nbsp;</div></li><li><div>            $cat_id = count( $ary ) &gt; 1 ? $ary[1] : $ary[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $cat_name ) ) {&nbsp;</div></li><li><div>                $cat_names[] = $cat_name;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $cat_id ) ) {&nbsp;</div></li><li><div>                $cat_ids[] = $cat_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        sort( $cat_names );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $mode ) {&nbsp;</div></li><li><div>            case 'entry_list':&nbsp;</div></li><li><div>                $value = self::implode_non_blank( ', ', $cat_names );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'entry_detail':&nbsp;</div></li><li><div>                $value = RGFormsModel::get_input_type( $field ) == 'checkbox' ? $cat_names : self::implode_non_blank( ', ', $cat_names );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'conditional_logic':&nbsp;</div></li><li><div>                $value = array_values( $cat_ids );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function calculate( $field, $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $formula = (string) apply_filters( 'gform_calculation_formula', $field-&gt;calculationFormula, $field, $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // replace multiple spaces and new lines with single space&nbsp;</div></li><li><div>        // @props: http://stackoverflow.com/questions/3760816/remove-new-lines-from-string&nbsp;</div></li><li><div>        $formula = trim( preg_replace( '/\s+/', ' ', $formula ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        preg_match_all( '/{[^{]*?:(\d+(\.\d+)?)(:(.*?))?}/mi', $formula, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $matches ) ) {&nbsp;</div></li><li><div>            foreach ( $matches as $match ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                list( $text, $input_id ) = $match;&nbsp;</div></li><li><div>                $value = self::get_calculation_value( $input_id, $form, $lead );&nbsp;</div></li><li><div>                $value = apply_filters( 'gform_merge_tag_value_pre_calculation', $value, $input_id, rgar( $match, 4 ), $field, $form, $lead );&nbsp;</div></li><li><div>                $formula = str_replace( $text, $value, $formula );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = preg_match( '/^[0-9 -\/*\(\)]+$/', $formula ) ? eval( &quot;return {$formula};&quot; ) : false;&nbsp;</div></li><li><div>        $result = apply_filters( 'gform_calculation_result', $result, $formula, $field, $form, $lead );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function round_number( $number, $rounding ) {&nbsp;</div></li><li><div>        if ( is_numeric( $rounding ) && $rounding &gt;= 0 ) {&nbsp;</div></li><li><div>            $number = round( $number, $rounding );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function get_calculation_value( $field_id, $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $filters = array( 'price', 'value', '' );&nbsp;</div></li><li><div>        $value = false;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        foreach ( $filters as $filter ) {&nbsp;</div></li><li><div>            if ( is_numeric( $value ) ) {&nbsp;</div></li><li><div>                //value found, exit loop&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $field = RGFormsModel::get_field( $form, $field_id );&nbsp;</div></li><li><div>            $is_pricing_field = self::has_currency_value( $field );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>            $replaced_value = GFCommon::replace_variables( &quot;{:{$field_id}:$filter}&quot;, $form, $lead );&nbsp;</div></li><li><div>            if ( $is_pricing_field ) {&nbsp;</div></li><li><div>                $value = self::to_number( $replaced_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            else{&nbsp;</div></li><li><div>                $number_format = rgobj( $field, 'numberFormat' );&nbsp;</div></li><li><div>                $value = self::clean_number( $replaced_value, $number_format );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( ! $value || ! is_numeric( $value ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( &quot;GFCommon::get_calculation_value(): No value or non-numeric value available for field #{$field_id}. Returning zero instead.&quot; );&nbsp;</div></li><li><div>            $value = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function has_currency_value( $field ) {&nbsp;</div></li><li><div>        $has_currency = self::is_pricing_field( $field-&gt;type ) || rgobj( $field, 'numberFormat' ) == 'currency';&nbsp;</div></li><li><div>        return $has_currency;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function conditional_shortcode( $attributes, $content = null ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        extract(&nbsp;</div></li><li><div>            shortcode_atts(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'merge_tag' =&gt; '', &nbsp;</div></li><li><div>                    'condition' =&gt; '', &nbsp;</div></li><li><div>                    'value' =&gt; '', &nbsp;</div></li><li><div> ), $attributes&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return RGFormsModel::matches_operation( $merge_tag, $value, $condition ) ? do_shortcode( $content ) : '';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function is_valid_for_calcuation( $field ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $supported_input_types = array( 'text', 'select', 'number', 'checkbox', 'radio', 'hidden', 'singleproduct', 'price', 'hiddenproduct', 'calculation', 'singleshipping' );&nbsp;</div></li><li><div>        $unsupported_field_types = array( 'category' );&nbsp;</div></li><li><div>        $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return in_array( $input_type, $supported_input_types ) && ! in_array( $input_type, $unsupported_field_types );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function log_error( $message ) {&nbsp;</div></li><li><div>        if ( class_exists( 'GFLogging' ) ) {&nbsp;</div></li><li><div>            GFLogging::include_logger();&nbsp;</div></li><li><div>            GFLogging::log_message( 'gravityforms', $message, KLogger::ERROR );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function log_debug( $message ) {&nbsp;</div></li><li><div>        if ( class_exists( 'GFLogging' ) ) {&nbsp;</div></li><li><div>            GFLogging::include_logger();&nbsp;</div></li><li><div>            GFLogging::log_message( 'gravityforms', $message, KLogger::DEBUG );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function echo_if( $condition, $text ) {&nbsp;</div></li><li><div>        _deprecated_function( 'GFCommon::echo_if() is deprecated', '1.9.9', 'Use checked() or selected() instead.' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        switch ( $text ) {&nbsp;</div></li><li><div>            case 'checked':&nbsp;</div></li><li><div>                $text = 'checked=&quot;checked&quot;';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'selected':&nbsp;</div></li><li><div>                $text = 'selected=&quot;selected&quot;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        echo $condition ? $text : '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function gf_global( $echo = true ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        require_once( GFCommon::get_base_path() . '/currency.php' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_global = array();&nbsp;</div></li><li><div>        $gf_global['gf_currency_config'] = RGCurrency::get_currency( GFCommon::get_currency() );&nbsp;</div></li><li><div>        $gf_global['base_url'] = GFCommon::get_base_url();&nbsp;</div></li><li><div>        $gf_global['number_formats'] = array();&nbsp;</div></li><li><div>        $gf_global['spinnerUrl'] = GFCommon::get_base_url() . '/images/spinner.gif';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_global_json = 'var gf_global = ' . json_encode( $gf_global ) . ';';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( ! $echo ) {&nbsp;</div></li><li><div>            return $gf_global_json;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        echo $gf_global_json;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function gf_vars( $echo = true ) {&nbsp;</div></li><li><div>        if ( ! class_exists( 'RGCurrency' ) ) {&nbsp;</div></li><li><div>            require_once( 'currency.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars = array();&nbsp;</div></li><li><div>        $gf_vars['active'] = esc_attr__( 'Active', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['inactive'] = esc_attr__( 'Inactive', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['save'] = esc_html__( 'Save', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['update'] = esc_html__( 'Update', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['previousLabel'] = esc_html__( 'Previous', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['selectFormat'] = esc_html__( 'Select a format', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['editToViewAll'] = esc_html__( '5 of %d items shown. Edit field to view all', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['enterValue'] = esc_html__( 'Enter a value', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['formTitle'] = esc_html__( 'Untitled Form', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['formDescription'] = esc_html__( 'We would love to hear from you! Please fill out this form and we will get in touch with you shortly.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['formConfirmationMessage'] = esc_html__( 'Thanks for contacting us! We will get in touch with you shortly.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['buttonText'] = esc_html__( 'Submit', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['loading'] = esc_html__( 'Loading...', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['thisFieldIf'] = esc_html__( 'this field if', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['thisSectionIf'] = esc_html__( 'this section if', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['thisPage'] = esc_html__( 'this page', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['thisFormButton'] = esc_html__( 'this form button if', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['show'] = esc_html__( 'Show', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['hide'] = esc_html__( 'Hide', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['all'] = esc_html( _x( 'All', 'Conditional Logic', 'gravityforms' ) );&nbsp;</div></li><li><div>        $gf_vars['any'] = esc_html( _x( 'Any', 'Conditional Logic', 'gravityforms' ) );&nbsp;</div></li><li><div>        $gf_vars['ofTheFollowingMatch'] = esc_html__( 'of the following match:', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['is'] = esc_html__( 'is', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['isNot'] = esc_html__( 'is not', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['greaterThan'] = esc_html__( 'greater than', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['lessThan'] = esc_html__( 'less than', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['contains'] = esc_html__( 'contains', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['startsWith'] = esc_html__( 'starts with', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['endsWith'] = esc_html__( 'ends with', 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars['thisConfirmation'] = esc_html__( 'Use this confirmation if', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['thisNotification'] = esc_html__( 'Send this notification if', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationSave'] = esc_html__( 'Save', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationSaving'] = esc_html__( 'Saving...', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationAreYouSure'] = __( 'Are you sure you wish to cancel these changes?', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationIssueSaving'] = __( 'There was an issue saving this confirmation.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationConfirmDelete'] = __( 'Are you sure you wish to delete this confirmation?', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationIssueDeleting'] = __( 'There was an issue deleting this confirmation.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationConfirmDiscard'] = __( 'There are unsaved changes to the current confirmation. Would you like to discard these changes?', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationDefaultName'] = __( 'Untitled Confirmation', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationDefaultMessage'] = __( 'Thanks for contacting us! We will get in touch with you shortly.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationInvalidPageSelection'] = __( 'Please select a page.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationInvalidRedirect'] = __( 'Please enter a URL.', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['confirmationInvalidName'] = __( 'Please enter a confirmation name.', 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars['conditionalLogicDependency'] = __( &quot;This form contains conditional logic dependent upon this field. Are you sure you want to delete this field? 'OK' to delete, 'Cancel' to abort.&quot;, 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['conditionalLogicDependencyChoice'] = __( &quot;This form contains conditional logic dependent upon this choice. Are you sure you want to delete this choice? 'OK' to delete, 'Cancel' to abort.&quot;, 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['conditionalLogicDependencyChoiceEdit'] = __( &quot;This form contains conditional logic dependent upon this choice. Are you sure you want to modify this choice? 'OK' to delete, 'Cancel' to abort.&quot;, 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars['mergeTagsTooltip'] = '&lt;h6&gt;' . esc_html__( 'Merge Tags', 'gravityforms' ) . '&lt;/h6&gt;' . esc_html__( 'Merge tags allow you to dynamically populate submitted field values in your form content wherever this merge tag icon is present.', 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars['baseUrl'] = GFCommon::get_base_url();&nbsp;</div></li><li><div>        $gf_vars['gf_currency_config'] = RGCurrency::get_currency( GFCommon::get_currency() );&nbsp;</div></li><li><div>        $gf_vars['otherChoiceValue'] = GFCommon::get_other_choice_value();&nbsp;</div></li><li><div>        $gf_vars['isFormTrash'] = false;&nbsp;</div></li><li><div>        $gf_vars['currentlyAddingField'] = false;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars['addFieldFilter'] = esc_html__( 'Add a condition' , 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['removeFieldFilter'] = esc_html__( 'Remove a condition' , 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['filterAndAny'] = esc_html__( 'Include results if {0} match:' , 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars['customChoices'] = esc_html__( 'Custom Choices', 'gravityforms' );&nbsp;</div></li><li><div>        $gf_vars['predefinedChoices'] = esc_html__( 'Predefined Choices', 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( is_admin() && rgget( 'id' ) ) {&nbsp;</div></li><li><div>            $form = RGFormsModel::get_form_meta( rgget( 'id' ) );&nbsp;</div></li><li><div>            $gf_vars['mergeTags'] = GFCommon::get_merge_tags( $form['fields'], '', false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $gf_vars_json = 'var gf_vars = ' . json_encode( $gf_vars ) . ';';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( ! $echo ) {&nbsp;</div></li><li><div>            return $gf_vars_json;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            echo $gf_vars_json;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function is_bp_active() {&nbsp;</div></li><li><div>        return defined( 'BP_VERSION' ) ? true : false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function add_message( $message, $is_error = false ) {&nbsp;</div></li><li><div>        if ( $is_error ) {&nbsp;</div></li><li><div>            self::$errors[] = $message;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            self::$messages[] = $message;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function add_error_message( $message ) {&nbsp;</div></li><li><div>        self::add_message( $message, true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function display_admin_message( $errors = false, $messages = false ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( ! $errors ) {&nbsp;</div></li><li><div>            $errors = self::$errors;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( ! $messages ) {&nbsp;</div></li><li><div>            $messages = self::$messages;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $errors = apply_filters( 'gform_admin_error_messages', $errors );&nbsp;</div></li><li><div>        $messages = apply_filters( 'gform_admin_messages', $messages );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( ! empty( $errors ) ) {&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;error below-h2&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php if ( count( $errors ) &gt; 1 ) { ?&gt;&nbsp;</div></li><li><div>                    &lt;ul style=&quot;margin: 0.5em 0 0; padding: 2px;&quot;&gt;&nbsp;</div></li><li><div>                        &lt;li&gt;&lt;?php echo implode( '&lt;/li&gt;&lt;li&gt;', $errors ); ?&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                    &lt;/ul&gt;&nbsp;</div></li><li><div>                &lt;?php } else { ?&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;?php echo $errors[0]; ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;?php } ?&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        } else if ( ! empty( $messages ) ) {&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;div id=&quot;message&quot; class=&quot;updated below-h2&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php if ( count( $messages ) &gt; 1 ) { ?&gt;&nbsp;</div></li><li><div>                    &lt;ul style=&quot;margin: 0.5em 0 0; padding: 2px;&quot;&gt;&nbsp;</div></li><li><div>                        &lt;li&gt;&lt;?php echo implode( '&lt;/li&gt;&lt;li&gt;', $messages ); ?&gt;&lt;/li&gt;&nbsp;</div></li><li><div>                    &lt;/ul&gt;&nbsp;</div></li><li><div>                &lt;?php } else { ?&gt;&nbsp;</div></li><li><div>                    &lt;p&gt;&lt;strong&gt;&lt;?php echo $messages[0]; ?&gt;&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;?php } ?&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    private static function requires_gf_vars() {&nbsp;</div></li><li><div>        $dependent_scripts = array( 'gform_form_admin', 'gform_gravityforms', 'gform_form_editor', 'gform_field_filter' );&nbsp;</div></li><li><div>        foreach ( $dependent_scripts as $script ) {&nbsp;</div></li><li><div>            if ( wp_script_is( $script ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function maybe_output_gf_vars() {&nbsp;</div></li><li><div>        if ( self::requires_gf_vars() ) {&nbsp;</div></li><li><div>            echo '&lt;script type=&quot;text/javascript&quot;&gt;' . self::gf_vars( false ) . '&lt;/script&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function maybe_add_leading_zero( $value ) {&nbsp;</div></li><li><div>        $first_char = GFCommon::safe_substr( $value, 0, 1, 'utf-8' );&nbsp;</div></li><li><div>        if ( in_array( $first_char, array( '.', ', ' ) ) ) {&nbsp;</div></li><li><div>            $value = '0' . $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    // used by the gfFieldFilterUI() jQuery plugin&nbsp;</div></li><li><div>    public static function get_field_filter_settings( $form ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $all_fields = $form['fields'];&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        // set up filters&nbsp;</div></li><li><div>        $fields = $all_fields;&nbsp;</div></li><li><div>        $exclude_types = array( 'rank', 'page', 'html' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $operators_by_input_type = array(&nbsp;</div></li><li><div>            'default' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', ), &nbsp;</div></li><li><div>            'name' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' ), &nbsp;</div></li><li><div>            'address' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' ), &nbsp;</div></li><li><div>            'text' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' ), &nbsp;</div></li><li><div>            'textarea' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' ), &nbsp;</div></li><li><div>            'checkbox' =&gt; array( 'is' ), &nbsp;</div></li><li><div>            'multiselect' =&gt; array( 'contains' ), &nbsp;</div></li><li><div>            'number' =&gt; array( 'is', 'isnot', '&gt;', '&lt;' ), &nbsp;</div></li><li><div>            'select' =&gt; array( 'is', 'isnot', '&gt;', '&lt;' ), &nbsp;</div></li><li><div>            'likert' =&gt; array( 'is', 'isnot' ), &nbsp;</div></li><li><div>            'list' =&gt; array( 'contains' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        for ( $i = 0; $i &lt; count( $all_fields ); $i ++ ) {&nbsp;</div></li><li><div>            $input_type = GFFormsmodel::get_input_type( $all_fields[ $i ] );&nbsp;</div></li><li><div>            if ( in_array( $input_type, $exclude_types ) ) {&nbsp;</div></li><li><div>                unset( $fields[ $i ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $fields = array_values( $fields );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $field_filters = array(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'key' =&gt; '0', &nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Any form field' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'contains', 'is' ), &nbsp;</div></li><li><div>                'preventMultiple' =&gt; false, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>            $input_type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>            $operators = isset( $operators_by_input_type[ $input_type ] ) ? $operators_by_input_type[ $input_type ] : $operators_by_input_type['default'];&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'product' && in_array( $input_type, array( 'radio', 'select' ) ) ) {&nbsp;</div></li><li><div>                $operators = array( 'is' );&nbsp;</div></li><li><div>            } elseif ( ! isset( $field-&gt;choices ) && ! in_array( 'contains', $operators ) ) {&nbsp;</div></li><li><div>                $operators[] = 'contains';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>            $field_filter = array();&nbsp;</div></li><li><div>            $key = $field-&gt;id;&nbsp;</div></li><li><div>            if ( $input_type == 'likert' && $field-&gt;gsurveyLikertEnableMultipleRows ) {&nbsp;</div></li><li><div>                // multi-row likert fields&nbsp;</div></li><li><div>                $field_filter['key'] = $key;&nbsp;</div></li><li><div>                $field_filter['group'] = true;&nbsp;</div></li><li><div>                $field_filter['text'] = GFFormsModel::get_label( $field );&nbsp;</div></li><li><div>                $sub_filters = array();&nbsp;</div></li><li><div>                $rows = $field-&gt;gsurveyLikertRows;&nbsp;</div></li><li><div>                foreach ( $rows as $row ) {&nbsp;</div></li><li><div>                    $sub_filter = array();&nbsp;</div></li><li><div>                    $sub_filter['key'] = $key . '|' . rgar( $row, 'value' );&nbsp;</div></li><li><div>                    $sub_filter['text'] = rgar( $row, 'text' );&nbsp;</div></li><li><div>                    $sub_filter['type'] = 'field';&nbsp;</div></li><li><div>                    $sub_filter['preventMultiple'] = false;&nbsp;</div></li><li><div>                    $sub_filter['operators'] = $operators;&nbsp;</div></li><li><div>                    $sub_filter['values'] = $field-&gt;choices;&nbsp;</div></li><li><div>                    $sub_filters[] = $sub_filter;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $field_filter['filters'] = $sub_filters;&nbsp;</div></li><li><div>            } elseif ( ( $input_type == 'name' && $field-&gt;nameFormat !== '' && $field-&gt;nameFormat !== 'simple') || $input_type == 'address' ) {&nbsp;</div></li><li><div>                // standard two input name field&nbsp;</div></li><li><div>                $field_filter['key'] = $key;&nbsp;</div></li><li><div>                $field_filter['group'] = true;&nbsp;</div></li><li><div>                $field_filter['text'] = GFFormsModel::get_label( $field );&nbsp;</div></li><li><div>                $sub_filters = array();&nbsp;</div></li><li><div>                $inputs = $field-&gt;inputs;&nbsp;</div></li><li><div>                foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                    $sub_filter = array();&nbsp;</div></li><li><div>                    $sub_filter['key'] = rgar( $input, 'id' );&nbsp;</div></li><li><div>                    $sub_filter['text'] = rgar( $input, 'label' );&nbsp;</div></li><li><div>                    $sub_filter['preventMultiple'] = false;&nbsp;</div></li><li><div>                    $sub_filter['operators'] = $operators;&nbsp;</div></li><li><div>                    $sub_filters[] = $sub_filter;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $field_filter['filters'] = $sub_filters;&nbsp;</div></li><li><div>            } elseif( $input_type == 'date') {&nbsp;</div></li><li><div>                $field_filter['key'] = $key;&nbsp;</div></li><li><div>                $field_filter['preventMultiple'] = false;&nbsp;</div></li><li><div>                $field_filter['text'] = GFFormsModel::get_label( $field );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                $field_filter['operators'] = $operators;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                $field_filter['placeholder'] = esc_html__('yyyy-mm-dd', 'gravityforms' );&nbsp;</div></li><li><div>                $field_filter['cssClass'] = 'datepicker ymd_dash';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $field_filter['key'] = $key;&nbsp;</div></li><li><div>                $field_filter['preventMultiple'] = false;&nbsp;</div></li><li><div>                $field_filter['text'] = GFFormsModel::get_label( $field );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                $field_filter['operators'] = $operators;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                if ( isset( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>                    $field_filter['values'] = $field-&gt;choices;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $field_filters[] = $field_filter;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        $entry_meta_filters = self::get_entry_meta_filter_settings( $form_id );&nbsp;</div></li><li><div>        $field_filters = array_merge( $field_filters, $entry_meta_filters );&nbsp;</div></li><li><div>        $field_filters = array_values( $field_filters ); // reset the numeric keys in case some filters have been unset&nbsp;</div></li><li><div>        $info_filters = self::get_entry_info_filter_settings();&nbsp;</div></li><li><div>        $field_filters = array_merge( $field_filters, $info_filters );&nbsp;</div></li><li><div>        $field_filters = array_values( $field_filters );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $field_filters;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function get_entry_info_filter_settings() {&nbsp;</div></li><li><div>        $settings = array();&nbsp;</div></li><li><div>        $info_columns = self::get_entry_info_filter_columns();&nbsp;</div></li><li><div>        foreach ( $info_columns as $key =&gt; $info_column ) {&nbsp;</div></li><li><div>            $info_column['key'] = $key;&nbsp;</div></li><li><div>            $info_column['preventMultiple'] = false;&nbsp;</div></li><li><div>            $settings[] = $info_column;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $settings;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function get_entry_info_filter_columns( $get_users = true ) {&nbsp;</div></li><li><div>        $account_choices = array();&nbsp;</div></li><li><div>        if ( $get_users ) {&nbsp;</div></li><li><div>            $args = apply_filters( 'gform_filters_get_users', array( 'number' =&gt; 200 ) );&nbsp;</div></li><li><div>            $accounts = get_users( $args );&nbsp;</div></li><li><div>            $account_choices = array();&nbsp;</div></li><li><div>            foreach ( $accounts as $account ) {&nbsp;</div></li><li><div>                $account_choices[] = array( 'text' =&gt; $account-&gt;user_login, 'value' =&gt; $account-&gt;ID );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'entry_id' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Entry ID' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot', '&gt;', '&lt;' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'date_created' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Entry Date' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', '&gt;', '&lt;' ), &nbsp;</div></li><li><div>                'placeholder' =&gt; __( 'yyyy-mm-dd' , 'gravityforms' ), &nbsp;</div></li><li><div>                'cssClass' =&gt; 'datepicker ymd_dash', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'is_starred' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Starred' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot' ), &nbsp;</div></li><li><div>                'values' =&gt; array(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'Yes', &nbsp;</div></li><li><div>                        'value' =&gt; '1', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'No', &nbsp;</div></li><li><div>                        'value' =&gt; '0', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'ip' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'IP Address' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'source_url' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Source URL' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'payment_status' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Payment Status' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot' ), &nbsp;</div></li><li><div>                'values' =&gt; array(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'Paid', &nbsp;</div></li><li><div>                        'value' =&gt; 'Paid', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'Processing', &nbsp;</div></li><li><div>                        'value' =&gt; 'Processing', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'Failed', &nbsp;</div></li><li><div>                        'value' =&gt; 'Failed', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'Active', &nbsp;</div></li><li><div>                        'value' =&gt; 'Active', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'text' =&gt; 'Cancelled', &nbsp;</div></li><li><div>                        'value' =&gt; 'Cancelled', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'payment_date' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Payment Date' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot', '&gt;', '&lt;' ), &nbsp;</div></li><li><div>                'placeholder' =&gt; __( 'yyyy-mm-dd' , 'gravityforms' ), &nbsp;</div></li><li><div>                'cssClass' =&gt; 'datepicker ymd_dash', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'payment_amount' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Payment Amount' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'transaction_id' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'Transaction ID' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot', '&gt;', '&lt;', 'contains' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'created_by' =&gt; array(&nbsp;</div></li><li><div>                'text' =&gt; esc_html__( 'User' , 'gravityforms' ), &nbsp;</div></li><li><div>                'operators' =&gt; array( 'is', 'isnot' ), &nbsp;</div></li><li><div>                'values' =&gt; $account_choices, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function get_entry_meta_filter_settings( $form_id ) {&nbsp;</div></li><li><div>        $filters = array();&nbsp;</div></li><li><div>        $entry_meta = GFFormsModel::get_entry_meta( $form_id );&nbsp;</div></li><li><div>        if ( empty( $entry_meta ) ) {&nbsp;</div></li><li><div>            return $filters;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        foreach ( $entry_meta as $key =&gt; $meta ) {&nbsp;</div></li><li><div>            if ( isset( $meta['filter'] ) ) {&nbsp;</div></li><li><div>                $filter = array();&nbsp;</div></li><li><div>                $filter['key'] = $key;&nbsp;</div></li><li><div>                $filter['preventMultiple'] = isset( $meta['filter']['preventMultiple'] ) ? $meta['filter']['preventMultiple'] : false;&nbsp;</div></li><li><div>                $filter['text'] = rgar( $meta, 'label' );&nbsp;</div></li><li><div>                $filter['operators'] = isset( $meta['filter']['operators'] ) ? $meta['filter']['operators'] : array( 'is', 'isnot' );&nbsp;</div></li><li><div>                if ( isset( $meta['filter']['choices'] ) ) {&nbsp;</div></li><li><div>                    $filter['values'] = $meta['filter']['choices'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $filters[] = $filter;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $filters;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function get_field_filters_from_post( $form ) {&nbsp;</div></li><li><div>        $field_filters = array();&nbsp;</div></li><li><div>        $filter_fields = rgpost( 'f' );&nbsp;</div></li><li><div>        if ( is_array( $filter_fields ) ) {&nbsp;</div></li><li><div>            $filter_operators = rgpost( 'o' );&nbsp;</div></li><li><div>            $filter_values = rgpost( 'v' );&nbsp;</div></li><li><div>            for ( $i = 0; $i &lt; count( $filter_fields ); $i ++ ) {&nbsp;</div></li><li><div>                $field_filter = array();&nbsp;</div></li><li><div>                $key = $filter_fields[ $i ];&nbsp;</div></li><li><div>                if ( 'entry_id' == $key ) {&nbsp;</div></li><li><div>                    $key = 'id';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $operator = $filter_operators[ $i ];&nbsp;</div></li><li><div>                $val = $filter_values[ $i ];&nbsp;</div></li><li><div>                $strpos_row_key = strpos( $key, '|' );&nbsp;</div></li><li><div>                if ( $strpos_row_key !== false ) { //multi-row likert&nbsp;</div></li><li><div>                    $key_array = explode( '|', $key );&nbsp;</div></li><li><div>                    $key = $key_array[0];&nbsp;</div></li><li><div>                    $val = $key_array[1] . ':' . $val;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $field_filter['key'] = $key;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                $field = GFFormsModel::get_field( $form, $key );&nbsp;</div></li><li><div>                if ( $field ) {&nbsp;</div></li><li><div>                    $input_type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>                    if ( $field-&gt;type == 'product' && in_array( $input_type, array( 'radio', 'select' ) ) ) {&nbsp;</div></li><li><div>                        $operator = 'contains';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>                $field_filter['operator'] = $operator;&nbsp;</div></li><li><div>                $field_filter['value'] = $val;&nbsp;</div></li><li><div>                $field_filters[] = $field_filter;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $field_filters['mode'] = rgpost( 'mode' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return $field_filters;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function has_multifile_fileupload_field( $form ) {&nbsp;</div></li><li><div>        $fileupload_fields = GFAPI::get_fields_by_type( $form, array( 'fileupload', 'post_custom_field' ) );&nbsp;</div></li><li><div>        if ( is_array( $fileupload_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $fileupload_fields as $field ) {&nbsp;</div></li><li><div>                if ( $field-&gt;multipleFiles ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function localize_gform_gravityforms_multifile() {&nbsp;</div></li><li><div>        wp_localize_script(&nbsp;</div></li><li><div>            'gform_gravityforms', 'gform_gravityforms', array(&nbsp;</div></li><li><div>                'strings' =&gt; array(&nbsp;</div></li><li><div>                    'invalid_file_extension' =&gt; esc_html__( 'This type of file is not allowed. Must be one of the following: ' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'delete_file' =&gt; esc_html__( 'Delete this file' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'in_progress' =&gt; esc_html__( 'in progress' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'file_exceeds_limit' =&gt; esc_html__( 'File exceeds size limit' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'illegal_extension' =&gt; esc_html__( 'This type of file is not allowed.' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'max_reached' =&gt; esc_html__( 'Maximum number of files reached' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'unknown_error' =&gt; esc_html__( 'There was a problem while saving the file on the server' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'currently_uploading' =&gt; esc_html__( 'Please wait for the uploading to complete' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'cancel' =&gt; esc_html__( 'Cancel' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'cancel_upload' =&gt; esc_html__( 'Cancel this upload' , 'gravityforms' ), &nbsp;</div></li><li><div>                    'cancelled' =&gt; esc_html__( 'Cancelled' , 'gravityforms' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'vars' =&gt; array(&nbsp;</div></li><li><div>                    'images_url' =&gt; GFCommon::get_base_url() . '/images'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function send_resume_link( $message, $subject, $email, $embed_url, $resume_token ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $from = get_bloginfo( 'admin_email' );&nbsp;</div></li><li><div>        $from_name = get_bloginfo( 'name' );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $message_format = 'html';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $resume_url = add_query_arg( array( 'gf_token' =&gt; $resume_token ), $embed_url );&nbsp;</div></li><li><div>        $resume_url = esc_url( $resume_url );&nbsp;</div></li><li><div>        $resume_link = &quot;&lt;a href='{$resume_url}'&gt;{$resume_url}&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>        $message .= $resume_link;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        self::send_email( $from, $email, '', $from, $subject, $message, $from_name, $message_format );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function safe_strlen( $string ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( is_array( $string ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( function_exists( 'mb_strlen' ) ) {&nbsp;</div></li><li><div>            return mb_strlen( $string );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return strlen( $string );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    public static function safe_substr( $string, $start, $length = null ) {&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( is_array( $string ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( function_exists( 'mb_substr' ) ) {&nbsp;</div></li><li><div>            return mb_substr( $string, $start, $length );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return substr( $string, $start, $length );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $string&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function safe_strtoupper( $string ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( function_exists( 'mb_strtoupper' ) ) {&nbsp;</div></li><li><div>            return mb_strtoupper( $string );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return strtoupper( $string );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Trims a string or an array recursively.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array|string $array&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function trim_deep( $array ) {&nbsp;</div></li><li><div>        if ( ! is_array( $array ) ) {&nbsp;</div></li><li><div>            return trim( $array );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_map( array( 'GFCommon', 'trim_deep' ), $array );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Reliably compare floats.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  float  $float1&nbsp;</div></li><li><div>     * @param  float  $float2&nbsp;</div></li><li><div>     * @param  string $operator Supports: '&lt;', '&lt;=', '&gt;', '&gt;=', '==', '=', '!='&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function compare_floats( $float1, $float2, $operator ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $epsilon = 0.00001;&nbsp;</div></li><li><div>        $is_equal = abs( floatval( $float1 ) - floatval( $float2 ) ) &lt; $epsilon;&nbsp;</div></li><li><div>        $is_greater = floatval( $float1 ) &gt; floatval( $float2 );&nbsp;</div></li><li><div>        $is_less = floatval( $float1 ) &lt; floatval( $float2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $operator ) {&nbsp;</div></li><li><div>            case '&lt;':&nbsp;</div></li><li><div>                return $is_less;&nbsp;</div></li><li><div>            case '&lt;=':&nbsp;</div></li><li><div>                return $is_less || $is_equal;&nbsp;</div></li><li><div>            case '&gt;' :&nbsp;</div></li><li><div>                return $is_greater;&nbsp;</div></li><li><div>            case '&gt;=':&nbsp;</div></li><li><div>                return $is_greater || $is_equal;&nbsp;</div></li><li><div>            case '==':&nbsp;</div></li><li><div>            case '=':&nbsp;</div></li><li><div>                return $is_equal;&nbsp;</div></li><li><div>            case '!=':&nbsp;</div></li><li><div>                return ! $is_equal;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function encrypt( $text ) {&nbsp;</div></li><li><div>        $use_mcrypt = apply_filters('gform_use_mcrypt', function_exists( 'mcrypt_encrypt' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_mcrypt ) {&nbsp;</div></li><li><div>            $iv_size = mcrypt_get_iv_size( MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB );&nbsp;</div></li><li><div>            $key = substr( md5( wp_salt( 'nonce' ) ), 0, $iv_size );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $encrypted_value = trim( base64_encode( mcrypt_encrypt( MCRYPT_RIJNDAEL_256, $key, $text, MCRYPT_MODE_ECB, mcrypt_create_iv( $iv_size, MCRYPT_RAND ) ) ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else{&nbsp;</div></li><li><div>            $encrypted_value = EncryptDB::encrypt( $text, wp_salt( 'nonce' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //$encrypted_value = base64_encode( $wpdb-&gt;get_var( $wpdb-&gt;prepare('SELECT AES_ENCRYPT(%s, %s) AS data', $text, wp_salt( 'nonce' ) ) ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $encrypted_value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function decrypt( $text ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $use_mcrypt = apply_filters('gform_use_mcrypt', function_exists( 'mcrypt_decrypt' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_mcrypt ) {&nbsp;</div></li><li><div>            $iv_size = mcrypt_get_iv_size( MCRYPT_RIJNDAEL_256, MCRYPT_MODE_ECB );&nbsp;</div></li><li><div>            $key = substr( md5( wp_salt( 'nonce' ) ), 0, $iv_size );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $decrypted_value = trim( mcrypt_decrypt( MCRYPT_RIJNDAEL_256, $key, base64_decode( $text ), MCRYPT_MODE_ECB, mcrypt_create_iv( $iv_size, MCRYPT_RAND ) ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else{&nbsp;</div></li><li><div>            $decrypted_value = EncryptDB::decrypt( $text, wp_salt( 'nonce' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $decrypted_value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function esc_like( $value ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_callable( array( $wpdb, 'esc_like' ) ) ) {&nbsp;</div></li><li><div>            $value = $wpdb-&gt;esc_like( $value );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $value = like_escape( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_form_editor() {&nbsp;</div></li><li><div>        $is_form_editor = GFForms::get_page() == 'form_editor' || ( defined( 'DOING_AJAX' ) && DOING_AJAX && in_array( rgpost( 'action' ), array( 'rg_add_field', 'rg_refresh_field_preview', 'rg_duplicate_field', 'rg_delete_field', 'rg_change_input_type' ) ) );&nbsp;</div></li><li><div>        return apply_filters( 'gform_is_form_editor', $is_form_editor );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_entry_detail() {&nbsp;</div></li><li><div>        $is_entry_detail = GFForms::get_page() == 'entry_detail_edit' || GFForms::get_page() == 'entry_detail' ;&nbsp;</div></li><li><div>        return apply_filters( 'gform_is_entry_detail', $is_entry_detail );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_entry_detail_view() {&nbsp;</div></li><li><div>        $is_entry_detail_view = GFForms::get_page() == 'entry_detail' ;&nbsp;</div></li><li><div>        return apply_filters( 'gform_is_entry_detail_view', $is_entry_detail_view );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_entry_detail_edit() {&nbsp;</div></li><li><div>        $is_entry_detail_edit = GFForms::get_page() == 'entry_detail_edit';&nbsp;</div></li><li><div>        return apply_filters( 'gform_is_entry_detail_edit', $is_entry_detail_edit );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_merge_tag( $string ) {&nbsp;</div></li><li><div>        return preg_match( '/{.+}/', $string );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_upload_page_slug() {&nbsp;</div></li><li><div>        $slug = get_option( 'gform_upload_page_slug' );&nbsp;</div></li><li><div>        if ( empty( $slug ) ) {&nbsp;</div></li><li><div>            $slug = substr( str_shuffle( wp_hash( microtime() ) ), 0, 15 );&nbsp;</div></li><li><div>            update_option( 'gform_upload_page_slug', $slug );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $slug;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whitelists a value. Returns the value or the first value in the array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $value&nbsp;</div></li><li><div>     * @param $whitelist&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function whitelist( $value, $whitelist ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! in_array( $value, $whitelist ) ) {&nbsp;</div></li><li><div>            $value = $whitelist[0];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Forces an integer into a range of integers. Returns the value or the minimum if it's outside the range.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $value&nbsp;</div></li><li><div>     * @param $min&nbsp;</div></li><li><div>     * @param $max&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function int_range( $value, $min, $max ) {&nbsp;</div></li><li><div>        $value = (int) $value;&nbsp;</div></li><li><div>        $min = (int) $min;&nbsp;</div></li><li><div>        $max = (int) $max;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return filter_var( $value, FILTER_VALIDATE_INT, array(&nbsp;</div></li><li><div>            'min_range' =&gt; $min, &nbsp;</div></li><li><div>            'max_range' =&gt; $max&nbsp;</div></li><li><div> ) ) ? $value : $min;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function load_gf_text_domain( $domain ) {&nbsp;</div></li><li><div>        // Initializing translations. Translation files in the WP_LANG_DIR folder have a higher priority.&nbsp;</div></li><li><div>        global $l10n;&nbsp;</div></li><li><div>        $locale = apply_filters( 'plugin_locale', get_locale(), 'gravityforms' );&nbsp;</div></li><li><div>        if ( ! isset( $l10n[$domain] ) ) {&nbsp;</div></li><li><div>            load_textdomain( 'gravityforms', WP_LANG_DIR . '/gravityforms/gravityforms-' . $locale . '.mo' );&nbsp;</div></li><li><div>            load_plugin_textdomain( 'gravityforms', false, '/gravityforms/languages' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function replace_field_variable( $text, $form, $lead, $url_encode, $esc_html, $nl2br, $format, $input_id, $match, $esc_attr = false ) {&nbsp;</div></li><li><div>        $field = RGFormsModel::get_field( $form, $input_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $field instanceof GF_Field ) {&nbsp;</div></li><li><div>            $field = GF_Fields::create( $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = RGFormsModel::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>        $raw_value = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>            $value = rgar( $value, $input_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = self::format_variable_value( $value, $url_encode, $esc_html, $format, $nl2br );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // modifier will be at index 4 unless used in a conditional shortcode in which case it would be at index 5&nbsp;</div></li><li><div>        $i = $match[0][0] == '{' ? 4 : 5;&nbsp;</div></li><li><div>        $modifier = strtolower( rgar( $match, $i ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = $field-&gt;get_value_merge_tag( $value, $input_id, $lead, $form, $modifier, $raw_value, $url_encode, $esc_html, $format, $nl2br );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $esc_attr ) {&nbsp;</div></li><li><div>            $value = esc_attr( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $modifier == 'label' ) {&nbsp;</div></li><li><div>            $value = empty( $value ) ? '' : $field-&gt;label;&nbsp;</div></li><li><div>        } else if ( $modifier == 'qty' && $field-&gt;type == 'product' ) {&nbsp;</div></li><li><div>            //getting quantity associated with product field&nbsp;</div></li><li><div>            $products = self::get_product_fields( $form, $lead, false, false );&nbsp;</div></li><li><div>            $value = 0;&nbsp;</div></li><li><div>            foreach ( $products['products'] as $product_id =&gt; $product ) {&nbsp;</div></li><li><div>                if ( $product_id == $field-&gt;id ) {&nbsp;</div></li><li><div>                    $value = $product['quantity'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Encoding left curly bracket so that merge tags entered in the front end are displayed as is and not parsed&nbsp;</div></li><li><div>        $value = self::encode_merge_tag( $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //filter can change merge tag value&nbsp;</div></li><li><div>        $value = apply_filters( 'gform_merge_tag_filter', $value, $input_id, $modifier, $field, $raw_value );&nbsp;</div></li><li><div>        if ( $value === false ) {&nbsp;</div></li><li><div>            $value = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $match[0][0] != '{' ) {&nbsp;</div></li><li><div>            // replace the merge tag in the conditional shortcode merge_tag attr&nbsp;</div></li><li><div>            $value = str_replace( $match[1], $value, $match[0] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = str_replace( $match[0], $value, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.3.9.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/gfcommon/" class="active">1.9.14.22</a></li><li><a href="http://hookr.io/plugins/gravity-forms/1.3.9.1/classes/gfcommon/" class="">1.3.9.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>GFCommon</li><li><span></span>wp-plugin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>