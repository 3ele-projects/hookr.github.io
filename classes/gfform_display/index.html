<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="wordpress" data-id="72802"><head xmlns="http://www.w3.org/1999/xhtml"><title> gfformdisplay | class | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="GFFormDisplay, class, plugin, gravity-forms, 1.9.14.22" /><meta name="description" content="The WordPress Core GFFormDisplay class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=daf9a257ae5d6196ca9e4240d39b3f64' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/gfform_display/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfform_display%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfform_display%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-1.9.14.22-class-gfform_display","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gfform_display" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms." href="http://hookr.io/plugins/gravity-forms/" class="plugin"><span property="name">gravity-forms</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.14.22." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/" class="H_VERSION"><span property="name">1.9.14.22</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gfform_display</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="0"><a href="http://hookr.io/1.9.14.22/all/" title="All">All <span class="count badge">0</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/1.9.14.22/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="0"><a href="http://hookr.io/1.9.14.22/hooks/" title="Hooks">Hooks <span class="count badge">0</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/1.9.14.22/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="0"><a href="http://hookr.io/1.9.14.22/filters/" title="Filters">Filters <span class="count badge">0</span></a></li><li class="active" data-id="class" data-count="0"><a href="http://hookr.io/1.9.14.22/classes/" title="Classes">Classes <span class="count badge">0</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/1.9.14.22/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/1.9.14.22/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/1.9.14.22/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>GFFormDisplay</strong></h1><p>The WordPress Core <strong>GFFormDisplay</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/files/form-display/" class="file">/form_display.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="7" class="block" start="7"><li><div>class GFFormDisplay {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static $submission = array();&nbsp;</div></li><li><div>    private static $init_scripts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    const ON_PAGE_RENDER = 1;&nbsp;</div></li><li><div>    const ON_CONDITIONAL_LOGIC = 2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function process_form( $form_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFFormDisplay::process_form(): Starting to process form (#{$form_id}) submission.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the form before GF begins to process the submission.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form The Form Object&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $filtered_form = gf_apply_filters( array( 'gform_pre_process', $form['id'] ), $form );&nbsp;</div></li><li><div>        if( $filtered_form !== null ) {&nbsp;</div></li><li><div>            $form = $filtered_form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //reading form metadata&nbsp;</div></li><li><div>        $form = self::maybe_add_review_page( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $form['is_active'] || $form['is_trash'] ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $form, 'requireLogin' ) ) {&nbsp;</div></li><li><div>            if ( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            check_admin_referer( 'gform_submit_' . $form_id, '_gform_submit_nonce_' . $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_values = RGForms::post( 'gform_field_values' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmation_message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $source_page_number = self::get_source_page( $form_id );&nbsp;</div></li><li><div>        $page_number = $source_page_number;&nbsp;</div></li><li><div>        $target_page = self::get_target_page( $form, $page_number, $field_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFFormDisplay::process_form(): Source page number: {$source_page_number}. Target page number: {$target_page}.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Loading files that have been uploaded to temp folder&nbsp;</div></li><li><div>        $files = GFCommon::json_decode( stripslashes( RGForms::post( 'gform_uploaded_files' ) ) );&nbsp;</div></li><li><div>        if ( ! is_array( $files ) ) {&nbsp;</div></li><li><div>            $files = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        RGFormsModel::$uploaded_files[ $form_id ] = $files;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $saving_for_later = rgpost( 'gform_save' ) ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_valid = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $failed_validation_page = $page_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //don't validate when going to previous page or saving for later&nbsp;</div></li><li><div>        if ( ! $saving_for_later && ( empty( $target_page ) || $target_page &gt;= $page_number ) ) {&nbsp;</div></li><li><div>            $is_valid = self::validate( $form, $field_values, $page_number, $failed_validation_page );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $log_is_valid = $is_valid ? 'Yes' : 'No';&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFFormDisplay::process_form(): After validation. Is submission valid? {$log_is_valid}.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Upload files to temp folder when saving for later, going to the next page or when submitting the form and it failed validation&nbsp;</div></li><li><div>        if ( $saving_for_later || $target_page &gt;= $page_number || ( $target_page == 0 && ! $is_valid ) ) {&nbsp;</div></li><li><div>            if ( ! empty( $_FILES ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormDisplay::process_form(): Uploading files...' );&nbsp;</div></li><li><div>                //Uploading files to temporary folder&nbsp;</div></li><li><div>                $files = self::upload_files( $form, $files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                RGFormsModel::$uploaded_files[ $form_id ] = $files;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load target page if it did not fail validation or if going to the previous page&nbsp;</div></li><li><div>        if ( ! $saving_for_later && $is_valid ) {&nbsp;</div></li><li><div>            $page_number = $target_page;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $page_number = $failed_validation_page;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmation = '';&nbsp;</div></li><li><div>        if ( ( $is_valid && $page_number == 0 ) || $saving_for_later ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $ajax = isset( $_POST['gform_ajax'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //adds honeypot field if configured&nbsp;</div></li><li><div>            if ( rgar( $form, 'enableHoneypot' ) ) {&nbsp;</div></li><li><div>                $form['fields'][] = self::get_honeypot_field( $form );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $failed_honeypot = rgar( $form, 'enableHoneypot' ) && ! self::validate_honeypot( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $failed_honeypot ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormDisplay::process_form(): Failed Honeypot validation. Displaying confirmation and aborting.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //display confirmation but doesn't process the form when honeypot fails&nbsp;</div></li><li><div>                $confirmation = self::handle_confirmation( $form, $lead, $ajax );&nbsp;</div></li><li><div>                $is_valid = false;&nbsp;</div></li><li><div>            } elseif ( ! $saving_for_later ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormDisplay::process_form(): Submission is valid. Moving forward.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $form = self::update_confirmation( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //pre submission action&nbsp;</div></li><li><div>                gf_do_action( array( 'gform_pre_submission', $form['id'] ), $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //pre submission filter&nbsp;</div></li><li><div>                $form = gf_apply_filters( array( 'gform_pre_submission_filter', $form_id ), $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //handle submission&nbsp;</div></li><li><div>                $confirmation = self::handle_submission( $form, $lead, $ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //after submission hook&nbsp;</div></li><li><div>                gf_do_action( array( 'gform_after_submission', $form['id'] ), $lead, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } elseif ( $saving_for_later ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormDisplay::process_form(): Saving for later.' );&nbsp;</div></li><li><div>                $lead = GFFormsModel::get_current_lead();&nbsp;</div></li><li><div>                $form = self::update_confirmation( $form, $lead, 'form_saved' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $confirmation = rgar( $form['confirmation'], 'message' );&nbsp;</div></li><li><div>                $nl2br = rgar( $form['confirmation'], 'disableAutoformat' ) ? false : true;&nbsp;</div></li><li><div>                $confirmation = GFCommon::replace_variables( $confirmation, $form, $lead, false, true, $nl2br );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $form_unique_id = GFFormsModel::get_form_unique_id( $form_id );&nbsp;</div></li><li><div>                $ip = GFFormsModel::get_ip();&nbsp;</div></li><li><div>                $source_url = GFFormsModel::get_current_page_url();&nbsp;</div></li><li><div>                $source_url = esc_url_raw( $source_url );&nbsp;</div></li><li><div>                $resume_token = rgpost( 'gform_resume_token' );&nbsp;</div></li><li><div>                $resume_token = sanitize_key( $resume_token );&nbsp;</div></li><li><div>                $resume_token = GFFormsModel::save_incomplete_submission( $form, $lead, $field_values, $page_number, $files, $form_unique_id, $ip, $source_url, $resume_token );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $notifications_to_send = GFCommon::get_notifications_to_send( 'form_saved', $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $log_notification_event = empty( $notifications_to_send ) ? 'No notifications to process' : 'Processing notifications';&nbsp;</div></li><li><div>                GFCommon::log_debug( &quot;GFFormDisplay::process_form(): {$log_notification_event} for form_saved event.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $notifications_to_send as $notification ) {&nbsp;</div></li><li><div>                    if ( isset( $notification['isActive'] ) && ! $notification['isActive'] ) {&nbsp;</div></li><li><div>                        GFCommon::log_debug( &quot;GFFormDisplay::process_form(): Notification is inactive, not processing notification (#{$notification['id']} - {$notification['name']}).&quot; );&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $notification['message'] = self::replace_save_variables( $notification['message'], $form, $resume_token );&nbsp;</div></li><li><div>                    GFCommon::send_notification( $notification, $form, $lead );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                self::set_submission_if_null( $form_id, 'saved_for_later', true );&nbsp;</div></li><li><div>                self::set_submission_if_null( $form_id, 'resume_token', $resume_token );&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormDisplay::process_form(): Saved incomplete submission.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $confirmation ) && isset( $confirmation['redirect'] ) ) {&nbsp;</div></li><li><div>                header( &quot;Location: {$confirmation[&quot;redirect&quot;]}&quot; );&nbsp;</div></li><li><div>                gf_do_action( array( 'gform_post_submission', $form['id'] ), $lead, $form );&nbsp;</div></li><li><div>                exit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( self::$submission[ $form_id ] ) ) {&nbsp;</div></li><li><div>            self::$submission[ $form_id ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::set_submission_if_null( $form_id, 'is_valid', $is_valid );&nbsp;</div></li><li><div>        self::set_submission_if_null( $form_id, 'form', $form );&nbsp;</div></li><li><div>        self::set_submission_if_null( $form_id, 'lead', $lead );&nbsp;</div></li><li><div>        self::set_submission_if_null( $form_id, 'confirmation_message', $confirmation );&nbsp;</div></li><li><div>        self::set_submission_if_null( $form_id, 'page_number', $page_number );&nbsp;</div></li><li><div>        self::set_submission_if_null( $form_id, 'source_page_number', $source_page_number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires after the form processing is completed. Form processing happens when submitting a page on a multi-page form (i.e. going to the &quot;Next&quot; or &quot;Previous&quot; page), or&nbsp;</div></li><li><div>         * when submitting a single page form.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form The Form Object&nbsp;</div></li><li><div>         * @param int $page_number In a multi-page form, this variable contains the current page number.&nbsp;</div></li><li><div>         * @param int $source_page_number In a multi-page form, this parameters contains the number of the page that the submission came from.&nbsp;</div></li><li><div>         *                                For example, when clicking &quot;Next&quot; on page 1, this parameter will be set to 1. When clicking &quot;Previous&quot; on page 2, this parameter will be set to 2.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        gf_do_action( array( 'gform_post_process', $form['id'] ), $form, $page_number, $source_page_number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get form object and insert review page, if necessary.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $form The current Form object&nbsp;</div></li><li><div>     * @return mixed The form meta array or false&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function maybe_add_review_page( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Setup default review page parameters. */&nbsp;</div></li><li><div>        $review_page = array(&nbsp;</div></li><li><div>                'button_text' =&gt; __( 'Review Form', 'gravityforms' ), &nbsp;</div></li><li><div>                'content' =&gt; '', &nbsp;</div></li><li><div>                'is_enabled' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( has_filter( 'gform_review_page' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Prepare partial entry for review page.&nbsp;</div></li><li><div>            $partial_entry = GFFormsModel::create_lead( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * GFFormsModel::create_lead() caches the field value and conditional logic visibliltiy which can create&nbsp;</div></li><li><div>             * issues when 3rd parties use hooks later in the process to modify the form. Let's flush the cache avoid&nbsp;</div></li><li><div>             * any weirdness.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            GFCache::flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * A filter for setting up the review page&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param array $review_page The review page parameters&nbsp;</div></li><li><div>             * @param array $form The current form object&nbsp;</div></li><li><div>             * @param array $partial_entry The partial entry for the form&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $review_page = gf_apply_filters( array( 'gform_review_page', $form['id'] ), $review_page, $form, $partial_entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $review_page, 'is_enabled' ) ) {&nbsp;</div></li><li><div>            $form = self::insert_review_page( $form, $review_page );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function set_submission_if_null( $form_id, $key, $val ) {&nbsp;</div></li><li><div>        if ( ! isset( self::$submission[ $form_id ][ $key ] ) ) {&nbsp;</div></li><li><div>            self::$submission[ $form_id ][ $key ] = $val;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function upload_files( $form, $files ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_upload_path = GFFormsModel::get_upload_path( $form['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Creating temp folder if it does not exist&nbsp;</div></li><li><div>        $target_path = $form_upload_path . '/tmp/';&nbsp;</div></li><li><div>        wp_mkdir_p( $target_path );&nbsp;</div></li><li><div>        GFCommon::recursive_add_index_file( $form_upload_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            $input_name = &quot;input_{$field-&gt;id}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //skip fields that are not file upload fields or that don't have a file to be uploaded or that have failed validation&nbsp;</div></li><li><div>            $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>            if ( ! in_array( $input_type, array( 'fileupload', 'post_image' ) ) || $field-&gt;multipleFiles ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;failed_validation || empty( $_FILES[ $input_name ]['name'] ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( &quot;GFFormDisplay::upload_files(): Skipping field: {$field-&gt;label}({$field-&gt;id} - {$field-&gt;type}).&quot; );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $file_info = RGFormsModel::get_temp_filename( $form['id'], $input_name );&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormDisplay::upload_files(): Temp file info: ' . print_r( $file_info, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $file_info && move_uploaded_file( $_FILES[ $input_name ]['tmp_name'], $target_path . $file_info['temp_filename'] ) ) {&nbsp;</div></li><li><div>                GFFormsModel::set_permissions( $target_path . $file_info['temp_filename'] );&nbsp;</div></li><li><div>                $files[ $input_name ] = $file_info['uploaded_filename'];&nbsp;</div></li><li><div>                GFCommon::log_debug( &quot;GFFormDisplay::upload_files(): File uploaded successfully: {$file_info['uploaded_filename']}&quot; );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                GFCommon::log_error( &quot;GFFormDisplay::upload_files(): File could not be uploaded: tmp_name: {$_FILES[ $input_name ]['tmp_name']} - target location: &quot; . $target_path . $file_info['temp_filename'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $files;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_state( $form, $field_values ) {&nbsp;</div></li><li><div>        $product_fields = array();&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var GF_Field $field */&nbsp;</div></li><li><div>            if ( GFCommon::is_product_field( $field-&gt;type ) || $field-&gt;type == 'donation' ) {&nbsp;</div></li><li><div>                $value = RGFormsModel::get_field_value( $field, $field_values, false );&nbsp;</div></li><li><div>                $value = $field-&gt;get_value_default_if_empty( $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( $field-&gt;inputType ) {&nbsp;</div></li><li><div>                    case 'calculation' :&nbsp;</div></li><li><div>                    case 'singleproduct' :&nbsp;</div></li><li><div>                    case 'hiddenproduct' :&nbsp;</div></li><li><div>                        $price = ! is_array( $value ) || empty( $value[ $field-&gt;id . '.2' ] ) ? $field-&gt;basePrice : $value[ $field-&gt;id . '.2' ];&nbsp;</div></li><li><div>                        if ( empty( $price ) ) {&nbsp;</div></li><li><div>                            $price = 0;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $price = GFCommon::to_number( $price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $product_name = ! is_array( $value ) || empty( $value[ $field-&gt;id . '.1' ] ) ? $field-&gt;label : $value[ $field-&gt;id . '.1' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $product_fields[ $field-&gt;id . '.1' ] = wp_hash( GFFormsModel::maybe_trim_input( $product_name, $form['id'], $field ) );&nbsp;</div></li><li><div>                        $product_fields[ $field-&gt;id . '.2' ] = wp_hash( GFFormsModel::maybe_trim_input( $price, $form['id'], $field ) );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'singleshipping' :&nbsp;</div></li><li><div>                        $price = ! empty( $value ) ? $value : $field-&gt;basePrice;&nbsp;</div></li><li><div>                        $price = ! empty( $price ) ? GFCommon::to_number( $price ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $product_fields[ $field-&gt;id ] = wp_hash( GFFormsModel::maybe_trim_input( $price, $form['id'], $field ) );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'radio' :&nbsp;</div></li><li><div>                    case 'select' :&nbsp;</div></li><li><div>                        $product_fields[ $field-&gt;id ] = array();&nbsp;</div></li><li><div>                        foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                            $field_value = ! empty( $choice['value'] ) || $field-&gt;enableChoiceValue ? $choice['value'] : $choice['text'];&nbsp;</div></li><li><div>                            if ( $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>                                $price = rgempty( 'price', $choice ) ? 0 : GFCommon::to_number( rgar( $choice, 'price' ) );&nbsp;</div></li><li><div>                                $field_value .= '|' . $price;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $product_fields[ $field-&gt;id ][] = wp_hash( GFFormsModel::maybe_trim_input( $field_value, $form['id'], $field ) );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'checkbox' :&nbsp;</div></li><li><div>                        $index = 1;&nbsp;</div></li><li><div>                        foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                            $field_value = ! empty( $choice['value'] ) || $field-&gt;enableChoiceValue ? $choice['value'] : $choice['text'];&nbsp;</div></li><li><div>                            if ( $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>                                $price = rgempty( 'price', $choice ) ? 0 : GFCommon::to_number( rgar( $choice, 'price' ) );&nbsp;</div></li><li><div>                                $field_value .= '|' . $price;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( $index % 10 == 0 ) { //hack to skip numbers ending in 0. so that 5.1 doesn't conflict with 5.10&nbsp;</div></li><li><div>                                $index ++;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $product_fields[ $field-&gt;id . '.' . $index ++ ] = wp_hash( GFFormsModel::maybe_trim_input( $field_value, $form['id'], $field ) );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $hash = json_encode( $product_fields );&nbsp;</div></li><li><div>        $checksum = wp_hash( crc32( $hash ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return base64_encode( json_encode( array( $hash, $checksum ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determine if form has any pages.&nbsp;</div></li><li><div>     * &nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     * @param array $form - The form object&nbsp;</div></li><li><div>     * @return bool - If form object has any pages&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function has_pages( $form ) {&nbsp;</div></li><li><div>        return GFCommon::has_pages( $form );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_character_counter( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;maxLength && ! $field-&gt;inputMask ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_placeholder( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;placeholder != '' ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>                foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                    if ( rgar( $input, 'placeholder' ) != '' ) {&nbsp;</div></li><li><div>                        return true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_enhanced_dropdown( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( in_array( RGFormsModel::get_input_type( $field ), array( 'select', 'multiselect' ) ) && $field-&gt;enableEnhancedUI ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_password_strength( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'password' && $field-&gt;passwordStrengthEnabled ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_other_choice( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'radio' && $field-&gt;enableOtherChoice ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_target_page( $form, $current_page, $field_values ) {&nbsp;</div></li><li><div>        $page_number = RGForms::post( &quot;gform_target_page_number_{$form['id']}&quot; );&nbsp;</div></li><li><div>        $page_number = ! is_numeric( $page_number ) ? 1 : $page_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $direction = $page_number &gt;= $current_page ? 1 : - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Finding next page that is not hidden by conditional logic&nbsp;</div></li><li><div>        while ( RGFormsModel::is_page_hidden( $form, $page_number, $field_values ) ) {&nbsp;</div></li><li><div>            $page_number += $direction;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //If all following pages are hidden, submit the form&nbsp;</div></li><li><div>        if ( $page_number &gt; self::get_max_page_number( $form ) ) {&nbsp;</div></li><li><div>            $page_number = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $page_number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_source_page( $form_id ) {&nbsp;</div></li><li><div>        $page_number = RGForms::post( &quot;gform_source_page_number_{$form_id}&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return ! is_numeric( $page_number ) ? 1 : $page_number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function set_current_page( $form_id, $page_number ) {&nbsp;</div></li><li><div>        self::$submission[ $form_id ]['page_number'] = $page_number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_current_page( $form_id ) {&nbsp;</div></li><li><div>        $page_number = isset( self::$submission[ $form_id ] ) ? intval( self::$submission[ $form_id ]['page_number'] ) : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $page_number;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function is_page_active( $form_id, $page_number ) {&nbsp;</div></li><li><div>        return intval( self::get_current_page( $form_id ) ) == intval( $page_number );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determine if the last page for the current form object is being submitted or rendered (depending on the provided $mode).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  array  $form A Gravity Forms form object.&nbsp;</div></li><li><div>     * @param  string $mode Mode to check for: 'submit' or 'render'&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_last_page( $form, $mode = 'submit' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $page_number = self::get_source_page( $form['id'] );&nbsp;</div></li><li><div>        $field_values = GFForms::post( 'gform_field_values' );&nbsp;</div></li><li><div>        $target_page = self::get_target_page( $form, $page_number, $field_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $mode == 'render' ) {&nbsp;</div></li><li><div>            $is_valid = rgars( self::$submission, &quot;{$form['id']}/is_valid&quot; );&nbsp;</div></li><li><div>            $is_last_page = $is_valid && $target_page == self::get_max_page_number( $form );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $is_last_page = (string) $target_page === '0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_last_page;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_limit_period_dates( $period ) {&nbsp;</div></li><li><div>        if ( empty( $period ) ) {&nbsp;</div></li><li><div>            return array( 'start_date' =&gt; null, 'end_date' =&gt; null );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $period ) {&nbsp;</div></li><li><div>            case 'day' :&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'start_date' =&gt; gmdate( 'Y-m-d' ), &nbsp;</div></li><li><div>                    'end_date' =&gt; gmdate( 'Y-m-d 23:59:59' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'week' :&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'start_date' =&gt; gmdate( 'Y-m-d', strtotime( 'Monday this week' ) ), &nbsp;</div></li><li><div>                    'end_date' =&gt; gmdate( 'Y-m-d 23:59:59', strtotime( 'next Sunday' ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'month' :&nbsp;</div></li><li><div>                $month_start = gmdate( 'Y-m-1' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'start_date' =&gt; $month_start, &nbsp;</div></li><li><div>                    'end_date' =&gt; gmdate( 'Y-m-d H:i:s', strtotime( &quot;{$month_start} +1 month -1 second&quot; ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'year' :&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'start_date' =&gt; gmdate( 'Y-1-1' ), &nbsp;</div></li><li><div>                    'end_date' =&gt; gmdate( 'Y-12-31 23:59:59' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form( $form_id, $display_title = true, $display_description = true, $force_display = false, $field_values = null, $ajax = false, $tabindex = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Provides the ability to modify the options used to display the form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array An array of Form Arguments when adding it to a page/post (Like the ID, Title, AJAX or not, etc)&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $form_args = apply_filters( 'gform_form_args', compact( 'form_id', 'display_title', 'display_description', 'force_display', 'field_values', 'ajax', 'tabindex' ) );&nbsp;</div></li><li><div>        extract( $form_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //looking up form id by form name&nbsp;</div></li><li><div>        if ( ! is_numeric( $form_id ) ) {&nbsp;</div></li><li><div>            $form_id = RGFormsModel::get_form_id( $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //reading form metadata&nbsp;</div></li><li><div>        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = self::maybe_add_review_page( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $action = remove_query_arg( 'gf_token' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //disable ajax if form has a reCAPTCHA field (not supported).&nbsp;</div></li><li><div>        if ( $ajax && self::has_recaptcha_field( $form ) ) {&nbsp;</div></li><li><div>            $ajax = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_POST['gform_send_resume_link'] ) ) {&nbsp;</div></li><li><div>            $save_email_confirmation = self::handle_save_email_confirmation( $form, $ajax );&nbsp;</div></li><li><div>            if ( is_wp_error( $save_email_confirmation ) ) { // Failed email validation&nbsp;</div></li><li><div>                $resume_token = rgpost( 'gform_resume_token' );&nbsp;</div></li><li><div>                $resume_token = sanitize_key( $resume_token );&nbsp;</div></li><li><div>                $incomplete_submission_info = GFFormsModel::get_incomplete_submission_values( $resume_token );&nbsp;</div></li><li><div>                if ( $incomplete_submission_info['form_id'] == $form_id ) {&nbsp;</div></li><li><div>                    $submission_details_json = $incomplete_submission_info['submission'];&nbsp;</div></li><li><div>                    $submission_details = json_decode( $submission_details_json, true );&nbsp;</div></li><li><div>                    $partial_entry = $submission_details['partial_entry'];&nbsp;</div></li><li><div>                    $form = self::update_confirmation( $form, $partial_entry, 'form_saved' );&nbsp;</div></li><li><div>                    $confirmation_message = rgar( $form['confirmation'], 'message' );&nbsp;</div></li><li><div>                    $nl2br = rgar( $form['confirmation'], 'disableAutoformat' ) ? false : true;&nbsp;</div></li><li><div>                    $confirmation_message = GFCommon::replace_variables( $confirmation_message, $form, $partial_entry, false, true, $nl2br );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return self::handle_save_confirmation( $form, $resume_token, $confirmation_message, $ajax );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return $save_email_confirmation;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_postback = false;&nbsp;</div></li><li><div>        $is_valid = true;&nbsp;</div></li><li><div>        $confirmation_message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //If form was submitted, read variables set during form submission procedure&nbsp;</div></li><li><div>        $submission_info = isset( self::$submission[ $form_id ] ) ? self::$submission[ $form_id ] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $submission_info, 'saved_for_later' ) == true ) {&nbsp;</div></li><li><div>            $resume_token = $submission_info['resume_token'];&nbsp;</div></li><li><div>            $confirmation_message = rgar( $submission_info, 'confirmation_message' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return self::handle_save_confirmation( $form, $resume_token, $confirmation_message, $ajax );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $partial_entry = $submitted_values = false;&nbsp;</div></li><li><div>        if ( isset( $_GET['gf_token'] ) ) {&nbsp;</div></li><li><div>            $incomplete_submission_info = GFFormsModel::get_incomplete_submission_values( $_GET['gf_token'] );&nbsp;</div></li><li><div>            if ( $incomplete_submission_info['form_id'] == $form_id ) {&nbsp;</div></li><li><div>                $submission_details_json = $incomplete_submission_info['submission'];&nbsp;</div></li><li><div>                $submission_details = json_decode( $submission_details_json, true );&nbsp;</div></li><li><div>                $partial_entry = $submission_details['partial_entry'];&nbsp;</div></li><li><div>                $submitted_values = $submission_details['submitted_values'];&nbsp;</div></li><li><div>                $field_values = $submission_details['field_values'];&nbsp;</div></li><li><div>                GFFormsModel::$unique_ids[ $form_id ]     = $submission_details['gform_unique_id'];&nbsp;</div></li><li><div>                GFFormsModel::$uploaded_files[ $form_id ] = $submission_details['files'];&nbsp;</div></li><li><div>                self::set_submission_if_null( $form_id, 'resuming_incomplete_submission', true );&nbsp;</div></li><li><div>                self::set_submission_if_null( $form_id, 'form_id', $form_id );&nbsp;</div></li><li><div>                self::set_submission_if_null( $form_id, 'page_number', $submission_details['page_number'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $partial_entry ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * A filter that allows disabling of the form view counter&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param int $form_id The Form ID to filter when disabling the form view counter&nbsp;</div></li><li><div>             * @param bool Default set to false (view counter enabled), can be set to true to disable the counter&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $view_counter_disabled = gf_apply_filters( array( 'gform_disable_view_counter', $form_id ), false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $submission_info ) {&nbsp;</div></li><li><div>                $is_postback = true;&nbsp;</div></li><li><div>                $is_valid = rgar( $submission_info, 'is_valid' ) || rgar( $submission_info, 'is_confirmation' );&nbsp;</div></li><li><div>                $form = $submission_info['form'];&nbsp;</div></li><li><div>                $lead = $submission_info['lead'];&nbsp;</div></li><li><div>                $confirmation_message = rgget( 'confirmation_message', $submission_info );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $is_valid && ! RGForms::get( 'is_confirmation', $submission_info ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $submission_info['page_number'] == 0 ) {&nbsp;</div></li><li><div>                        //post submission hook&nbsp;</div></li><li><div>                        gf_do_action( array( 'gform_post_submission', $form['id'] ), $lead, $form );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        //change page hook&nbsp;</div></li><li><div>                        gf_do_action( array( 'gform_post_paging', $form['id'] ), $form, $submission_info['source_page_number'], $submission_info['page_number'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( ! current_user_can( 'administrator' ) && ! $view_counter_disabled ) {&nbsp;</div></li><li><div>                RGFormsModel::insert_form_view( $form_id, $_SERVER['REMOTE_ADDR'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $form, 'enableHoneypot' ) ) {&nbsp;</div></li><li><div>            $form['fields'][] = self::get_honeypot_field( $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Fired right before the form rendering process. Allow users to manipulate the form object before it gets displayed in the front end&nbsp;</div></li><li><div>        $form = gf_apply_filters( array( 'gform_pre_render', $form_id ), $form, $ajax, $field_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $form == null ) {&nbsp;</div></li><li><div>            return '&lt;p&gt;' . esc_html__( 'Oops! We could not locate your form.', 'gravityforms' ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_pages = self::has_pages( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //calling tab index filter&nbsp;</div></li><li><div>        GFCommon::$tab_index = gf_apply_filters( array( 'gform_tabindex', $form_id ), $tabindex, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Don't display inactive forms&nbsp;</div></li><li><div>        if ( ! $force_display && ! $is_postback ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_info = RGFormsModel::get_form( $form_id );&nbsp;</div></li><li><div>            if ( empty( $form_info ) || ! $form_info-&gt;is_active ) {&nbsp;</div></li><li><div>                return '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If form requires login, check if user is logged in&nbsp;</div></li><li><div>            if ( rgar( $form, 'requireLogin' ) ) {&nbsp;</div></li><li><div>                if ( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>                    return empty( $form['requireLoginMessage'] ) ? '&lt;p&gt;' . esc_html__( 'Sorry. You must be logged in to view this form.', 'gravityforms' ) . '&lt;/p&gt;' : '&lt;p&gt;' . GFCommon::gform_do_shortcode( $form['requireLoginMessage'] ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // show the form regardless of the following validations when force display is set to true&nbsp;</div></li><li><div>        if ( ! $force_display || $is_postback ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_schedule_validation = self::validate_form_schedule( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if form schedule validation fails AND this is not a postback, display the validation error&nbsp;</div></li><li><div>            // if form schedule validation fails AND this is a postback, make sure is not a valid submission (enables display of confirmation message)&nbsp;</div></li><li><div>            if ( ( $form_schedule_validation && ! $is_postback ) || ( $form_schedule_validation && $is_postback && ! $is_valid ) ) {&nbsp;</div></li><li><div>                return $form_schedule_validation;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $entry_limit_validation = self::validate_entry_limit( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // refer to form schedule condition notes above&nbsp;</div></li><li><div>            if ( ( $entry_limit_validation && ! $is_postback ) || ( $entry_limit_validation && $is_postback && ! $is_valid ) ) {&nbsp;</div></li><li><div>                return $entry_limit_validation;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_string = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //When called via a template, this will enqueue the proper scripts&nbsp;</div></li><li><div>        //When called via a shortcode, this will be ignored (too late to enqueue), but the scripts will be enqueued via the enqueue_scripts event&nbsp;</div></li><li><div>        self::enqueue_form_scripts( $form, $ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $confirmation_message ) ) {&nbsp;</div></li><li><div>            $wrapper_css_class = GFCommon::get_browser_class() . ' gform_wrapper';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $is_valid ) {&nbsp;</div></li><li><div>                $wrapper_css_class .= ' gform_validation_error';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Hiding entire form if conditional logic is on to prevent 'hidden' fields from blinking. Form will be set to visible in the conditional_logic.php after the rules have been applied.&nbsp;</div></li><li><div>            $style = self::has_conditional_logic( $form ) ? &quot;style='display:none'&quot; : '';&nbsp;</div></li><li><div>            $custom_wrapper_css_class = ! empty( $form['cssClass'] ) ? &quot; {$form['cssClass']}_wrapper&quot; : '';&nbsp;</div></li><li><div>            $form_string .= &quot;&nbsp;</div></li><li><div>                &lt;div class='{$wrapper_css_class}{$custom_wrapper_css_class}' id='gform_wrapper_$form_id' &quot; . $style . '&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $default_anchor = $has_pages || $ajax ? true : false;&nbsp;</div></li><li><div>            $use_anchor = gf_apply_filters( array( 'gform_confirmation_anchor', $form_id ), $default_anchor );&nbsp;</div></li><li><div>            if ( $use_anchor !== false ) {&nbsp;</div></li><li><div>                $form_string .= &quot;&lt;a id='gf_$form_id' class='gform_anchor' &gt;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>                $action .= &quot;#gf_$form_id&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $target = $ajax ? &quot;target='gform_ajax_frame_{$form_id}'&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_css_class = ! empty( $form['cssClass'] ) ? &quot;class='{$form['cssClass']}'&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $action = esc_url( $action );&nbsp;</div></li><li><div>            $form_string .= gf_apply_filters( array( 'gform_form_tag', $form_id ), &quot;&lt;form method='post' enctype='multipart/form-data' {$target} id='gform_{$form_id}' {$form_css_class} action='{$action}'&gt;&quot;, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $display_title || $display_description ) {&nbsp;</div></li><li><div>                $form_string .= &quot;&nbsp;</div></li><li><div>                        &lt;div class='gform_heading'&gt;&quot;;&nbsp;</div></li><li><div>                if ( $display_title ) {&nbsp;</div></li><li><div>                    $form_string .= &quot;&nbsp;</div></li><li><div>                            &lt;h3 class='gform_title'&gt;&quot; . $form['title'] . '&lt;/h3&gt;';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $display_description ) {&nbsp;</div></li><li><div>                    $form_string .= &quot;&nbsp;</div></li><li><div>                            &lt;span class='gform_description'&gt;&quot; . rgar( $form, 'description' ) . '&lt;/span&gt;';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $form_string .= '&nbsp;</div></li><li><div>                        &lt;/div&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $current_page = self::get_current_page( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $has_pages && ! $is_admin ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $form['pagination']['type'] == 'percentage' ) {&nbsp;</div></li><li><div>                    $form_string .= self::get_progress_bar( $form, $form_id, $confirmation_message );&nbsp;</div></li><li><div>                } else if ( $form['pagination']['type'] == 'steps' ) {&nbsp;</div></li><li><div>                    $form_string .= &quot;&nbsp;</div></li><li><div>                    &lt;div id='gf_page_steps_{$form_id}' class='gf_page_steps'&gt;&quot;;&nbsp;</div></li><li><div>                    $pages = isset( $form['pagination']['pages'] ) ? $form['pagination']['pages'] : array();&nbsp;</div></li><li><div>                    for ( $i = 0, $count = sizeof( $pages ); $i &lt; $count; $i ++ ) {&nbsp;</div></li><li><div>                        $step_number = $i + 1;&nbsp;</div></li><li><div>                        $active_class = $step_number == $current_page ? ' gf_step_active' : '';&nbsp;</div></li><li><div>                        $first_class = $i == 0 ? ' gf_step_first' : '';&nbsp;</div></li><li><div>                        $last_class = $i + 1 == $count ? ' gf_step_last' : '';&nbsp;</div></li><li><div>                        $complete_class = $step_number &lt; $current_page ? ' gf_step_completed' : '';&nbsp;</div></li><li><div>                        $previous_class = $step_number + 1 == $current_page ? ' gf_step_previous' : '';&nbsp;</div></li><li><div>                        $next_class = $step_number - 1 == $current_page ? ' gf_step_next' : '';&nbsp;</div></li><li><div>                        $pending_class = $step_number &gt; $current_page ? ' gf_step_pending' : '';&nbsp;</div></li><li><div>                        $classes = 'gf_step' . $active_class . $first_class . $last_class . $complete_class . $previous_class . $next_class . $pending_class;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $classes = GFCommon::trim_all( $classes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $form_string .= &quot;&nbsp;</div></li><li><div>                        &lt;div id='gf_step_{$form_id}_{$step_number}' class='{$classes}'&gt;&lt;span class='gf_step_number'&gt;{$step_number}&lt;/span&gt;&nbsp;&lt;span class='gf_step_label'&gt;{$pages[ $i ]}&lt;/span&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $form_string .= &quot;&nbsp;</div></li><li><div>                        &lt;div class='gf_step_clear'&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $is_postback && ! $is_valid ) {&nbsp;</div></li><li><div>                $validation_message = &quot;&lt;div class='validation_error'&gt;&quot; . esc_html__( 'There was a problem with your submission.', 'gravityforms' ) . ' ' . esc_html__( 'Errors have been highlighted below.', 'gravityforms' ) . '&lt;/div&gt;';&nbsp;</div></li><li><div>                $form_string .= gf_apply_filters( array( 'gform_validation_message', $form_id ), $validation_message, $form );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_string .= &quot;&nbsp;</div></li><li><div>                        &lt;div class='gform_body'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //add first page if this form has any page fields&nbsp;</div></li><li><div>            if ( $has_pages ) {&nbsp;</div></li><li><div>                $style = self::is_page_active( $form_id, 1 ) ? '' : &quot;style='display:none;'&quot;;&nbsp;</div></li><li><div>                $class = ! empty( $form['firstPageCssClass'] ) ? &quot; {$form['firstPageCssClass']}&quot; : '';&nbsp;</div></li><li><div>                $form_string .= &quot;&lt;div id='gform_page_{$form_id}_1' class='gform_page{$class}' {$style}&gt;&nbsp;</div></li><li><div>                                    &lt;div class='gform_page_fields'&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $description_class = rgar( $form, 'descriptionPlacement' ) == 'above' ? 'description_above' : 'description_below';&nbsp;</div></li><li><div>            $sublabel_class = rgar( $form, 'subLabelPlacement' ) == 'above' ? 'form_sublabel_above' : 'form_sublabel_below';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_string .= &quot;&lt;ul id='gform_fields_{$form_id}' class='&quot; . GFCommon::get_ul_classes( $form ) . &quot;'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>                foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                    /** @var GF_Field $field */&nbsp;</div></li><li><div>                    $field-&gt;conditionalLogicFields = self::get_conditional_logic_fields( $form, $field-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_array( $submitted_values ) ) {&nbsp;</div></li><li><div>                        $field_value = rgar( $submitted_values, $field-&gt;id );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $field_value = GFFormsModel::get_field_value( $field, $field_values );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $form_string .= self::get_field( $field, $field_value, false, $form, $field_values );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $form_string .= '&nbsp;</div></li><li><div>                            &lt;/ul&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $has_pages ) {&nbsp;</div></li><li><div>                $previous_button = self::get_form_button( $form['id'], &quot;gform_previous_button_{$form['id']}&quot;, $form['lastPageButton'], __( 'Previous', 'gravityforms' ), 'gform_previous_button', __( 'Previous Page', 'gravityforms' ), self::get_current_page( $form_id ) - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Filter through the form previous button when paged&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param int $form_id The Form ID to filter through&nbsp;</div></li><li><div>                 * @param string $previous_button The HTML rendered button (rendered with the form ID and the function get_form_button)&nbsp;</div></li><li><div>                 * @param array $form The Form object to filter through&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $previous_button = gf_apply_filters( array( 'gform_previous_button', $form_id ), $previous_button, $form );&nbsp;</div></li><li><div>                $form_string .= '&lt;/div&gt;' . self::gform_footer( $form, 'gform_page_footer ' . $form['labelPlacement'], $ajax, $field_values, $previous_button, $display_title, $display_description, $is_postback ) . '&nbsp;</div></li><li><div>                        &lt;/div&gt;'; //closes gform_page&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_string .= '&lt;/div&gt;'; //closes gform_body&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //suppress form footer for multi-page forms (footer will be included on the last page&nbsp;</div></li><li><div>            if ( ! $has_pages ) {&nbsp;</div></li><li><div>                $form_string .= self::gform_footer( $form, 'gform_footer ' . $form['labelPlacement'], $ajax, $field_values, '', $display_title, $display_description, $tabindex );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form_string .= '&nbsp;</div></li><li><div>                        &lt;/form&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $ajax && $is_postback ) {&nbsp;</div></li><li><div>                global $wp_scripts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $form_string = apply_filters(&nbsp;</div></li><li><div>                    'gform_ajax_iframe_content', '&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;' .&nbsp;</div></li><li><div>                    &quot;&lt;meta charset='UTF-8' /&gt;&lt;/head&gt;&lt;body class='GF_AJAX_POSTBACK'&gt;&quot; . $form_string . '&lt;/body&gt;&lt;/html&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $ajax && ! $is_postback ) {&nbsp;</div></li><li><div>                $spinner_url = gf_apply_filters( array( 'gform_ajax_spinner_url', $form_id ), GFCommon::get_base_url() . '/images/spinner.gif', $form );&nbsp;</div></li><li><div>                $scroll_position = array( 'default' =&gt; '', 'confirmation' =&gt; '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $use_anchor !== false ) {&nbsp;</div></li><li><div>                    $scroll_position['default'] = is_numeric( $use_anchor ) ? 'jQuery(document).scrollTop(' . intval( $use_anchor ) . ');' : &quot;jQuery(document).scrollTop(jQuery('#gform_wrapper_{$form_id}').offset().top);&quot;;&nbsp;</div></li><li><div>                    $scroll_position['confirmation'] = is_numeric( $use_anchor ) ? 'jQuery(document).scrollTop(' . intval( $use_anchor ) . ');' : &quot;jQuery(document).scrollTop(jQuery('#gforms_confirmation_message_{$form_id}').offset().top);&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $iframe_style = defined( 'GF_DEBUG' ) && GF_DEBUG ? 'display:block;width:600px;height:300px;border:1px solid #eee;' : 'display:none;width:0px;height:0px;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $is_html5 = RGFormsModel::is_html5_enabled();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $iframe_title = $is_html5 ? &quot; title='Ajax Frame'&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $form_string .= &quot;&nbsp;</div></li><li><div>                &lt;iframe style='{$iframe_style}' src='about:blank' name='gform_ajax_frame_{$form_id}' id='gform_ajax_frame_{$form_id}'&quot; . $iframe_title . &quot;&gt;&lt;/iframe&gt;&nbsp;</div></li><li><div>                &lt;script type='text/javascript'&gt;&quot; . apply_filters( 'gform_cdata_open', '' ) . '' .&nbsp;</div></li><li><div>                    'jQuery(document).ready(function($) {' .&nbsp;</div></li><li><div>                        &quot;gformInitSpinner( {$form_id}, '{$spinner_url}' );&quot; .&nbsp;</div></li><li><div>                        &quot;jQuery('#gform_ajax_frame_{$form_id}').load( function() {&quot; .&nbsp;</div></li><li><div>                            &quot;var contents = jQuery(this).contents().find('*').html();&quot; .&nbsp;</div></li><li><div>                            &quot;var is_postback = contents.indexOf('GF_AJAX_POSTBACK') &gt;= 0;&quot; .&nbsp;</div></li><li><div>                            'if(!is_postback) {return;}' .&nbsp;</div></li><li><div>                            &quot;var form_content = jQuery(this).contents().find('#gform_wrapper_{$form_id}');&quot; .&nbsp;</div></li><li><div>                            &quot;var is_confirmation = jQuery(this).contents().find('#gform_confirmation_wrapper_{$form_id}').length &gt; 0;&quot; .&nbsp;</div></li><li><div>                            &quot;var is_redirect = contents.indexOf('gformRedirect() {') &gt;= 0;&quot; .&nbsp;</div></li><li><div>                            'var is_form = form_content.length &gt; 0 && ! is_redirect && ! is_confirmation;' .&nbsp;</div></li><li><div>                            'if(is_form) {' .&nbsp;</div></li><li><div>                                &quot;jQuery('#gform_wrapper_{$form_id}').html(form_content.html());&quot; .&nbsp;</div></li><li><div>                                &quot;setTimeout( function() { /* delay the scroll by 50 milliseconds to fix a bug in chrome */ {$scroll_position['default']} }, 50 );&quot; .&nbsp;</div></li><li><div>                                &quot;if(window['gformInitDatepicker']) {gformInitDatepicker();}&quot; .&nbsp;</div></li><li><div>                                &quot;if(window['gformInitPriceFields']) {gformInitPriceFields();}&quot; .&nbsp;</div></li><li><div>                                &quot;var current_page = jQuery('#gform_source_page_number_{$form_id}').val();&quot; .&nbsp;</div></li><li><div>                                &quot;gformInitSpinner( {$form_id}, '{$spinner_url}' );&quot; .&nbsp;</div></li><li><div>                                &quot;jQuery(document).trigger('gform_page_loaded', [{$form_id}, current_page]);&quot; .&nbsp;</div></li><li><div>                                &quot;window['gf_submitting_{$form_id}'] = false;&quot; .&nbsp;</div></li><li><div>                            '}' .&nbsp;</div></li><li><div>                            'else if(!is_redirect) {' .&nbsp;</div></li><li><div>                                &quot;var confirmation_content = jQuery(this).contents().find('#gforms_confirmation_message_{$form_id}').html();&quot; .&nbsp;</div></li><li><div>                                'if(!confirmation_content) {' .&nbsp;</div></li><li><div>                                    'confirmation_content = contents;' .&nbsp;</div></li><li><div>                                '}' .&nbsp;</div></li><li><div>                                'setTimeout(function() {' .&nbsp;</div></li><li><div>                                    &quot;jQuery('#gform_wrapper_{$form_id}').replaceWith('&lt;' + 'div id=\'gforms_confirmation_message_{$form_id}\' class=\'gform_confirmation_message_{$form_id} gforms_confirmation_message\'' + '&gt;' + confirmation_content + '&lt;' + '/div' + '&gt;');&quot; .&nbsp;</div></li><li><div>                                    &quot;{$scroll_position['confirmation']}&quot; .&nbsp;</div></li><li><div>                                    &quot;jQuery(document).trigger('gform_confirmation_loaded', [{$form_id}]);&quot; .&nbsp;</div></li><li><div>                                    &quot;window['gf_submitting_{$form_id}'] = false;&quot; .&nbsp;</div></li><li><div>                                    '}, 50);' .&nbsp;</div></li><li><div>                                '}' .&nbsp;</div></li><li><div>                            'else{' .&nbsp;</div></li><li><div>                                &quot;jQuery('#gform_{$form_id}').append(contents);&quot; .&nbsp;</div></li><li><div>                                &quot;if(window['gformRedirect']) {gformRedirect();}&quot; .&nbsp;</div></li><li><div>                            '}' .&nbsp;</div></li><li><div>                            &quot;jQuery(document).trigger('gform_post_render', [{$form_id}, current_page]);&quot; .&nbsp;</div></li><li><div>                        '} );' .&nbsp;</div></li><li><div>                    '} );' . apply_filters( 'gform_cdata_close', '' ) . '&lt;/script&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_first_load = ! $is_postback;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ( ! $ajax || $is_first_load ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                self::register_form_init_scripts( $form, $field_values, $ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( apply_filters( 'gform_init_scripts_footer', false ) ) {&nbsp;</div></li><li><div>                    add_action( 'wp_footer', create_function( '', 'GFFormDisplay::footer_init_scripts(' . $form['id'] . ');' ), 20 );&nbsp;</div></li><li><div>                    add_action( 'gform_preview_footer', create_function( '', 'GFFormDisplay::footer_init_scripts(' . $form['id'] . ');' ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $form_string .= self::get_form_init_scripts( $form );&nbsp;</div></li><li><div>                    $form_string .= &quot;&lt;script type='text/javascript'&gt;&quot; . apply_filters( 'gform_cdata_open', '' ) . &quot; jQuery(document).ready(function() {jQuery(document).trigger('gform_post_render', [{$form_id}, {$current_page}]) } ); &quot; . apply_filters( 'gform_cdata_close', '' ) . '&lt;/script&gt;';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return gf_apply_filters( array( 'gform_get_form_filter', $form_id ), $form_string, $form );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $progress_confirmation = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //check admin setting for whether the progress bar should start at zero&nbsp;</div></li><li><div>            $start_at_zero = rgars( $form, 'pagination/display_progressbar_on_confirmation' );&nbsp;</div></li><li><div>            $start_at_zero = apply_filters( 'gform_progressbar_start_at_zero', $start_at_zero, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //show progress bar on confirmation&nbsp;</div></li><li><div>            if ( $start_at_zero && $has_pages && ! $is_admin && ( $form['confirmation']['type'] == 'message' && $form['pagination']['type'] == 'percentage' ) ) {&nbsp;</div></li><li><div>                $progress_confirmation = self::get_progress_bar( $form, $form_id, $confirmation_message );&nbsp;</div></li><li><div>                if ( $ajax ) {&nbsp;</div></li><li><div>                    $progress_confirmation = apply_filters( 'gform_ajax_iframe_content', &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset='UTF-8' /&gt;&lt;/head&gt;&lt;body class='GF_AJAX_POSTBACK'&gt;&quot; . $progress_confirmation . '&lt;/body&gt;&lt;/html&gt;' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                //return regular confirmation message&nbsp;</div></li><li><div>                if ( $ajax ) {&nbsp;</div></li><li><div>                    $progress_confirmation = apply_filters( 'gform_ajax_iframe_content', &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset='UTF-8' /&gt;&lt;/head&gt;&lt;body class='GF_AJAX_POSTBACK'&gt;&quot; . $confirmation_message . '&lt;/body&gt;&lt;/html&gt;' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $progress_confirmation = $confirmation_message;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $progress_confirmation;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function footer_init_scripts( $form_id ) {&nbsp;</div></li><li><div>        global $_init_forms;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = RGFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $form_string = self::get_form_init_scripts( $form );&nbsp;</div></li><li><div>        $current_page = self::get_current_page( $form_id );&nbsp;</div></li><li><div>        $form_string .= &quot;&lt;script type='text/javascript'&gt;&quot; . apply_filters( 'gform_cdata_open', '' ) . &quot; jQuery(document).ready(function() {jQuery(document).trigger('gform_post_render', [{$form_id}, {$current_page}]) } ); &quot; . apply_filters( 'gform_cdata_close', '' ) . '&lt;/script&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * A filter to allow modification of scripts that fire in the footer&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form_id The Form ID to filter through&nbsp;</div></li><li><div>         * @param string $form_string Get the form scripts in a string&nbsp;</div></li><li><div>         * @param array $form The Form object to filter through&nbsp;</div></li><li><div>         * @param int $current_page The Current form page ID (If paging is enabled)&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $form_string = gf_apply_filters( array( 'gform_footer_init_scripts_filter', $form_id ), $form_string, $form, $current_page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $_init_forms[ $form_id ] ) ) {&nbsp;</div></li><li><div>            echo $form_string;&nbsp;</div></li><li><div>            if ( ! is_array( $_init_forms ) ) {&nbsp;</div></li><li><div>                $_init_forms = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $_init_forms[ $form_id ] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_init_script( $form_id, $script_name, $location, $script ) {&nbsp;</div></li><li><div>        $key = $script_name . '_' . $location;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( self::$init_scripts[ $form_id ] ) ) {&nbsp;</div></li><li><div>            self::$init_scripts[ $form_id ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //add script if it hasn't been added before&nbsp;</div></li><li><div>        if ( ! array_key_exists( $key, self::$init_scripts[ $form_id ] ) ) {&nbsp;</div></li><li><div>            self::$init_scripts[ $form_id ][ $key ] = array( 'location' =&gt; $location, 'script' =&gt; $script );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_button( $form_id, $button_input_id, $button, $default_text, $class, $alt, $target_page_number, $onclick = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tabindex = GFCommon::get_tabindex();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $input_type = 'submit';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $target_page_number ) ) {&nbsp;</div></li><li><div>            $onclick = &quot;onclick='jQuery(\&quot;#gform_target_page_number_{$form_id}\&quot;).val(\&quot;{$target_page_number}\&quot;); {$onclick} jQuery(\&quot;#gform_{$form_id}\&quot;).trigger(\&quot;submit\&quot;, [true]); '&quot;;&nbsp;</div></li><li><div>            $input_type = 'button';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // prevent multiple form submissions when button is pressed multiple times&nbsp;</div></li><li><div>            if ( GFFormsModel::is_html5_enabled() ) {&nbsp;</div></li><li><div>                $set_submitting = &quot;if( !jQuery(\&quot;#gform_{$form_id}\&quot;)[0].checkValidity || jQuery(\&quot;#gform_{$form_id}\&quot;)[0].checkValidity()) {window[\&quot;gf_submitting_{$form_id}\&quot;]=true;}&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $set_submitting = &quot;window[\&quot;gf_submitting_{$form_id}\&quot;]=true;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $onclick_submit = $button['type'] == 'link' ? &quot;jQuery(\&quot;#gform_{$form_id}\&quot;).trigger(\&quot;submit\&quot;, [true]);&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $onclick = &quot;onclick='if(window[\&quot;gf_submitting_{$form_id}\&quot;]) {return false;}  {$set_submitting} {$onclick} {$onclick_submit}'&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $button, 'type' ) == 'text' || rgar( $button, 'type' ) == 'link' || empty( $button['imageUrl'] ) ) {&nbsp;</div></li><li><div>            $button_text = ! empty( $button['text'] ) ? $button['text'] : $default_text;&nbsp;</div></li><li><div>            if ( rgar( $button, 'type' ) == 'link' ) {&nbsp;</div></li><li><div>                $button_input = &quot;&lt;a href='javascript:void(0);' id='{$button_input_id}_link' class='{$class}' {$tabindex} {$onclick}&gt;{$button_text}&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $class .= ' button';&nbsp;</div></li><li><div>                $button_input = &quot;&lt;input type='{$input_type}' id='{$button_input_id}' class='{$class}' value='&quot; . esc_attr( $button_text ) . &quot;' {$tabindex} {$onclick} /&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $imageUrl = $button['imageUrl'];&nbsp;</div></li><li><div>            $class .= ' gform_image_button';&nbsp;</div></li><li><div>            $button_input = &quot;&lt;input type='image' src='{$imageUrl}' id='{$button_input_id}' class='{$class}' alt='{$alt}' {$tabindex} {$onclick} /&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $button_input;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function gform_footer( $form, $class, $ajax, $field_values, $previous_button, $display_title, $display_description, $tabindex = 1 ) {&nbsp;</div></li><li><div>        $form_id = absint( $form['id'] );&nbsp;</div></li><li><div>        $footer = &quot;&nbsp;</div></li><li><div>        &lt;div class='&quot; . esc_attr( $class ) . &quot;'&gt;&quot;;&nbsp;</div></li><li><div>        $button_input = self::get_form_button( $form['id'], &quot;gform_submit_button_{$form['id']}&quot;, $form['button'], __( 'Submit', 'gravityforms' ), 'gform_button', __( 'Submit', 'gravityforms' ), 0 );&nbsp;</div></li><li><div>        $button_input = gf_apply_filters( array( 'gform_submit_button', $form_id ), $button_input, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $save_button = rgars( $form, 'save/enabled' ) ? self::get_form_button( $form_id, &quot;gform_save_{$form_id}&quot;, $form['save']['button'], rgars( $form, 'save/button/text' ), 'gform_save_link', rgars( $form, 'save/button/text' ), 0, &quot;jQuery(\&quot;#gform_save_{$form_id}\&quot;).val(1);&quot; ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $footer .= $previous_button . ' ' . $button_input . ' ' . $save_button;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tabindex = (int) $tabindex;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $ajax ) {&nbsp;</div></li><li><div>            $footer .= &quot;&lt;input type='hidden' name='gform_ajax' value='&quot; . esc_attr( &quot;form_id={$form_id}&amp;title={$display_title}&amp;description={$display_description}&amp;tabindex={$tabindex}&quot; ) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_page = self::get_current_page( $form_id );&nbsp;</div></li><li><div>        $next_page = $current_page + 1;&nbsp;</div></li><li><div>        $next_page = $next_page &gt; self::get_max_page_number( $form ) ? 0 : $next_page;&nbsp;</div></li><li><div>        $field_values_str = is_array( $field_values ) ? http_build_query( $field_values ) : $field_values;&nbsp;</div></li><li><div>        $files_input = '';&nbsp;</div></li><li><div>        if ( GFCommon::has_multifile_fileupload_field( $form ) || ! empty( RGFormsModel::$uploaded_files[ $form_id ] ) ) {&nbsp;</div></li><li><div>            $files = ! empty( RGFormsModel::$uploaded_files[ $form_id ] ) ? GFCommon::json_encode( RGFormsModel::$uploaded_files[ $form_id ] ) : '';&nbsp;</div></li><li><div>            $files_input = &quot;&lt;input type='hidden' name='gform_uploaded_files' id='gform_uploaded_files_{$form_id}' value='&quot; . str_replace( &quot;'&quot;, '&#039;', $files ) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $save_inputs = '';&nbsp;</div></li><li><div>        if ( rgars( $form, 'save/enabled' ) ) {&nbsp;</div></li><li><div>            $resume_token = isset( $_POST['gform_resume_token'] ) ? $_POST['gform_resume_token'] : rgget( 'gf_token' );&nbsp;</div></li><li><div>            $resume_token = sanitize_key( $resume_token );&nbsp;</div></li><li><div>            $save_inputs = &quot;&lt;input type='hidden' class='gform_hidden' name='gform_save' id='gform_save_{$form_id}' value='' /&gt;&nbsp;</div></li><li><div>                             &lt;input type='hidden' class='gform_hidden' name='gform_resume_token' id='gform_resume_token_{$form_id}' value='{$resume_token}' /&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $form, 'requireLogin' ) ) {&nbsp;</div></li><li><div>            $footer .= wp_nonce_field( 'gform_submit_' . $form_id, '_gform_submit_nonce_' . $form_id, true, false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $unique_id = isset( self::$submission[ $form_id ] ) && rgar( self::$submission[ $form_id ], 'resuming_incomplete_submission' ) == true ? rgar( GFFormsModel::$unique_ids, $form_id ) : GFFormsModel::get_form_unique_id( $form_id );&nbsp;</div></li><li><div>        $footer .= &quot;&nbsp;</div></li><li><div>            &lt;input type='hidden' class='gform_hidden' name='is_submit_{$form_id}' value='1' /&gt;&nbsp;</div></li><li><div>            &lt;input type='hidden' class='gform_hidden' name='gform_submit' value='{$form_id}' /&gt;&nbsp;</div></li><li><div>            {$save_inputs}&nbsp;</div></li><li><div>            &lt;input type='hidden' class='gform_hidden' name='gform_unique_id' value='&quot; . esc_attr( $unique_id ) . &quot;' /&gt;&nbsp;</div></li><li><div>            &lt;input type='hidden' class='gform_hidden' name='state_{$form_id}' value='&quot; . self::get_state( $form, $field_values ) . &quot;' /&gt;&nbsp;</div></li><li><div>            &lt;input type='hidden' class='gform_hidden' name='gform_target_page_number_{$form_id}' id='gform_target_page_number_{$form_id}' value='&quot; . esc_attr( $next_page ) . &quot;' /&gt;&nbsp;</div></li><li><div>            &lt;input type='hidden' class='gform_hidden' name='gform_source_page_number_{$form_id}' id='gform_source_page_number_{$form_id}' value='&quot; . esc_attr( $current_page ) . &quot;' /&gt;&nbsp;</div></li><li><div>            &lt;input type='hidden' name='gform_field_values' value='&quot; . esc_attr( $field_values_str ) . &quot;' /&gt;&nbsp;</div></li><li><div>            {$files_input}&nbsp;</div></li><li><div>        &lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $footer;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_max_page_number( $form ) {&nbsp;</div></li><li><div>        $page_number = 0;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'page' ) {&nbsp;</div></li><li><div>                $page_number ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $page_number == 0 ? 0 : $page_number + 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_honeypot_field( $form ) {&nbsp;</div></li><li><div>        $max_id = self::get_max_field_id( $form );&nbsp;</div></li><li><div>        $labels = self::get_honeypot_labels();&nbsp;</div></li><li><div>        $properties = array( 'type' =&gt; 'honeypot', 'label' =&gt; $labels[ rand( 0, 3 ) ], 'id' =&gt; $max_id + 1, 'cssClass' =&gt; 'gform_validation_container', 'description' =&gt; __( 'This field is for validation purposes and should be left unchanged.', 'gravityforms' ) );&nbsp;</div></li><li><div>        $field = GF_Fields::create( $properties );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_max_field_id( $form ) {&nbsp;</div></li><li><div>        $max = 0;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( floatval( $field-&gt;id ) &gt; $max ) {&nbsp;</div></li><li><div>                $max = floatval( $field-&gt;id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $max;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_honeypot_labels() {&nbsp;</div></li><li><div>        return array( 'Name', 'Email', 'Phone', 'Comments' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Used to determine the required validation result.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param int $form_id&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_empty( $field, $form_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $_POST[ 'is_submit_' . $field-&gt;formId ] ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;is_value_submission_empty( $form_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function validate_honeypot( $form ) {&nbsp;</div></li><li><div>        $honeypot_id = self::get_max_field_id( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return rgempty( &quot;input_{$honeypot_id}&quot; );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function handle_submission( $form, &$lead, $ajax = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_id = gf_apply_filters( array( 'gform_entry_id_pre_save_lead', $form['id'] ), null, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $lead_id ) ) {&nbsp;</div></li><li><div>            if ( empty( $lead ) ) {&nbsp;</div></li><li><div>                $lead = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $lead['id'] = $lead_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creating entry in DB&nbsp;</div></li><li><div>        RGFormsModel::save_lead( $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //reading entry that was just saved&nbsp;</div></li><li><div>        $lead = RGFormsModel::get_lead( $lead['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead = GFFormsModel::set_entry_meta( $lead, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if Akismet plugin is installed, run lead through Akismet and mark it as Spam when appropriate&nbsp;</div></li><li><div>        $is_spam = GFCommon::akismet_enabled( $form['id'] ) && GFCommon::is_akismet_spam( $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * A filter to set if an entry is spam&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form['id'] The Form ID to filter through (take directly from the form object)&nbsp;</div></li><li><div>         * @param bool $is_spam True or false to filter if the entry is spam&nbsp;</div></li><li><div>         * @param array $form The Form object to filer through&nbsp;</div></li><li><div>         * @param array $lead The Lead object to filter through&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $is_spam = gf_apply_filters( array( 'gform_entry_is_spam', $form['id'] ), $is_spam, $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( GFCommon::spam_enabled( $form['id'] ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormDisplay::handle_submission(): Akismet integration enabled OR gform_entry_is_spam hook in use.' );&nbsp;</div></li><li><div>            $log_is_spam = $is_spam ? 'Yes' : 'No';&nbsp;</div></li><li><div>            GFCommon::log_debug( &quot;GFFormDisplay::handle_submission(): Is entry considered spam? {$log_is_spam}.&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_spam ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //marking entry as spam&nbsp;</div></li><li><div>            RGFormsModel::update_lead_property( $lead['id'], 'status', 'spam', false, true );&nbsp;</div></li><li><div>            $lead['status'] = 'spam';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_entry_created', $lead, $form );&nbsp;</div></li><li><div>        $lead = gf_apply_filters( array( 'gform_entry_post_save', $form['id'] ), $lead, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        RGFormsModel::set_current_lead( $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $is_spam ) {&nbsp;</div></li><li><div>            GFCommon::create_post( $form, $lead );&nbsp;</div></li><li><div>            //send notifications&nbsp;</div></li><li><div>            GFCommon::send_form_submission_notifications( $form, $lead );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::clean_up_files( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // remove incomplete submission and purge expired&nbsp;</div></li><li><div>        if ( rgars( $form, 'save/enabled' ) ) {&nbsp;</div></li><li><div>            GFFormsModel::delete_incomplete_submission( rgpost( 'gform_resume_token' ) );&nbsp;</div></li><li><div>            GFFormsModel::purge_expired_incomplete_submissions();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //display confirmation message or redirect to confirmation page&nbsp;</div></li><li><div>        return self::handle_confirmation( $form, $lead, $ajax );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function clean_up_files( $form ) {&nbsp;</div></li><li><div>        $unique_form_id = rgpost( 'gform_unique_id' );&nbsp;</div></li><li><div>        if ( ! ctype_alnum( $unique_form_id ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $target_path = RGFormsModel::get_upload_path( $form['id'] ) . '/tmp/';&nbsp;</div></li><li><div>        $filename = $target_path . $unique_form_id . '_input_*';&nbsp;</div></li><li><div>        $files = glob( $filename );&nbsp;</div></li><li><div>        if ( is_array( $files ) ) {&nbsp;</div></li><li><div>            array_map( 'unlink', $files );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // clean up files from abandoned submissions older than 48 hours (30 days if Save and Continue is enabled)&nbsp;</div></li><li><div>        $files = glob( $target_path . '*' );&nbsp;</div></li><li><div>        if ( is_array( $files ) ) {&nbsp;</div></li><li><div>            $seconds_in_day = 24 * 60 * 60;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter through the experiation days of a incomplete form submission&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $lifespan = rgars( $form, 'save/enabled' ) ? $expiration_days = apply_filters( 'gform_incomplete_submissions_expiration_days', 30 ) * $seconds_in_day : 2 * $seconds_in_day;&nbsp;</div></li><li><div>            foreach ( $files as $file ) {&nbsp;</div></li><li><div>                if ( is_file( $file ) && time() - filemtime( $file ) &gt;= $lifespan ) {&nbsp;</div></li><li><div>                    unlink( $file );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function handle_confirmation( $form, $lead, $ajax = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormDisplay::handle_confirmation(): Sending confirmation.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //run the function to populate the legacy confirmation format to be safe&nbsp;</div></li><li><div>        $form = self::update_confirmation( $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $form['confirmation']['type'] == 'message' ) {&nbsp;</div></li><li><div>            $default_anchor = self::has_pages( $form ) ? 1 : 0;&nbsp;</div></li><li><div>            $anchor = gf_apply_filters( array( 'gform_confirmation_anchor', $form['id'] ), $default_anchor ) ? &quot;&lt;a id='gf_{$form['id']}' class='gform_anchor' &gt;&lt;/a&gt;&quot; : '';&nbsp;</div></li><li><div>            $nl2br = rgar( $form['confirmation'], 'disableAutoformat' ) ? false : true;&nbsp;</div></li><li><div>            $cssClass = rgar( $form, 'cssClass' );&nbsp;</div></li><li><div>            $confirmation = empty( $form['confirmation']['message'] ) ? &quot;{$anchor} &quot; : &quot;{$anchor}&lt;div id='gform_confirmation_wrapper_{$form['id']}' class='gform_confirmation_wrapper {$cssClass}'&gt;&lt;div id='gform_confirmation_message_{$form['id']}' class='gform_confirmation_message_{$form['id']} gform_confirmation_message'&gt;&quot; . GFCommon::replace_variables( $form['confirmation']['message'], $form, $lead, false, true, $nl2br ) . '&lt;/div&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( ! empty( $form['confirmation']['pageId'] ) ) {&nbsp;</div></li><li><div>                $url = get_permalink( $form['confirmation']['pageId'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $url = GFCommon::replace_variables( trim( $form['confirmation']['url'] ), $form, $lead, false, true, true, 'text' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $url_info = parse_url( $url );&nbsp;</div></li><li><div>            $query_string = rgar( $url_info, 'query' );&nbsp;</div></li><li><div>            $dynamic_query = GFCommon::replace_variables( trim( $form['confirmation']['queryString'] ), $form, $lead, true, false, false, 'text' );&nbsp;</div></li><li><div>            $dynamic_query = str_replace( array( &quot;\r&quot;, &quot;\n&quot; ), '', $dynamic_query );&nbsp;</div></li><li><div>            $query_string .= rgempty( 'query', $url_info ) || empty( $dynamic_query ) ? $dynamic_query : '&' . $dynamic_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $url_info['fragment'] ) ) {&nbsp;</div></li><li><div>                $query_string .= '#' . rgar( $url_info, 'fragment' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $url = isset( $url_info['scheme'] ) ? $url_info['scheme'] : 'http';&nbsp;</div></li><li><div>            $url .= '://' . rgar( $url_info, 'host' );&nbsp;</div></li><li><div>            if ( ! empty( $url_info['port'] ) ) {&nbsp;</div></li><li><div>                $url .= ':' . rgar( $url_info, 'port' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $url .= rgar( $url_info, 'path' );&nbsp;</div></li><li><div>            if ( ! empty( $query_string ) ) {&nbsp;</div></li><li><div>                $url .= &quot;?{$query_string}&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( headers_sent() || $ajax ) {&nbsp;</div></li><li><div>                //Perform client side redirect for AJAX forms, of if headers have already been sent&nbsp;</div></li><li><div>                $confirmation = self::get_js_redirect_confirmation( $url, $ajax );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $confirmation = array( 'redirect' =&gt; $url );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmation = gf_apply_filters( array( 'gform_confirmation', $form['id'] ), $confirmation, $form, $lead, $ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $confirmation ) ) {&nbsp;</div></li><li><div>            $confirmation = GFCommon::gform_do_shortcode( $confirmation ); //enabling shortcodes&nbsp;</div></li><li><div>        } else if ( headers_sent() || $ajax ) {&nbsp;</div></li><li><div>            //Perform client side redirect for AJAX forms, of if headers have already been sent&nbsp;</div></li><li><div>            $confirmation = self::get_js_redirect_confirmation( $confirmation['redirect'], $ajax ); //redirecting via client side&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormDisplay::handle_confirmation(): Confirmation =&gt; ' . print_r( $confirmation, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $confirmation;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_js_redirect_confirmation( $url, $ajax ) {&nbsp;</div></li><li><div>        $confirmation = &quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot; . apply_filters( 'gform_cdata_open', '' ) . &quot; function gformRedirect() {document.location.href='$url';}&quot;;&nbsp;</div></li><li><div>        if ( ! $ajax ) {&nbsp;</div></li><li><div>            $confirmation .= 'gformRedirect();';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmation .= apply_filters( 'gform_cdata_close', '' ) . '&lt;/script&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $confirmation;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function send_emails( $form, $lead ) {&nbsp;</div></li><li><div>        _deprecated_function( 'send_emails', '1.7', 'GFCommon::send_form_submission_notifications' );&nbsp;</div></li><li><div>        GFCommon::send_form_submission_notifications( $form, $lead );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function validate( &$form, $field_values, $page_number = 0, &$failed_validation_page = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = gf_apply_filters( array( 'gform_pre_validation', $form['id'] ), $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // validate form schedule&nbsp;</div></li><li><div>        if ( self::validate_form_schedule( $form ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // validate entry limit&nbsp;</div></li><li><div>        if ( self::validate_entry_limit( $form ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Prevent tampering with the submitted form&nbsp;</div></li><li><div>        if ( empty( $_POST[ 'is_submit_' . $form['id'] ] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_valid = true;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as &$field ) {&nbsp;</div></li><li><div>            /** @var GF_Field $field */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //If a page number is specified, only validates fields that are on current page&nbsp;</div></li><li><div>            $field_in_other_page = $page_number &gt; 0 && $field-&gt;pageNumber != $page_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //validate fields with 'no duplicate' functionality when they are present on pages before the current page.&nbsp;</div></li><li><div>            $validate_duplicate_feature = $field-&gt;noDuplicates && $page_number &gt; 0 && $field-&gt;pageNumber &lt;= $page_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field_in_other_page && ! $validate_duplicate_feature ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //ignore validation if field is hidden or admin only&nbsp;</div></li><li><div>            if ( RGFormsModel::is_field_hidden( $form, $field, $field_values ) || $field-&gt;adminOnly ) {&nbsp;</div></li><li><div>                $field-&gt;is_field_hidden = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = RGFormsModel::get_field_value( $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //display error message if field is marked as required and the submitted value is empty&nbsp;</div></li><li><div>            if ( $field-&gt;isRequired && self::is_empty( $field, $form['id'] ) ) {&nbsp;</div></li><li><div>                $field-&gt;failed_validation = true;&nbsp;</div></li><li><div>                $field-&gt;validation_message = empty( $field-&gt;errorMessage ) ? __( 'This field is required.', 'gravityforms' ) : $field-&gt;errorMessage;&nbsp;</div></li><li><div>            } //display error if field does not allow duplicates and the submitted value already exists&nbsp;</div></li><li><div>            else if ( $field-&gt;noDuplicates && RGFormsModel::is_duplicate( $form['id'], $field, $value ) ) {&nbsp;</div></li><li><div>                $field-&gt;failed_validation = true;&nbsp;</div></li><li><div>                //set page number so the failed field displays if on multi-page form&nbsp;</div></li><li><div>                $failed_validation_page = $field-&gt;pageNumber;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( $input_type ) {&nbsp;</div></li><li><div>                    case 'date' :&nbsp;</div></li><li><div>                        $default_message = __( 'This date has already been taken. Please select a new date.', 'gravityforms' );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $default_message = is_array( $value ) ? __( 'This field requires a unique entry and the values you entered have been already been used.', 'gravityforms' ) :&nbsp;</div></li><li><div>                            sprintf( __( &quot;This field requires a unique entry and '%s' has already been used&quot;, 'gravityforms' ), $value );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $field-&gt;validation_message = gf_apply_filters( array( 'gform_duplicate_message', $form['id'] ), $default_message, $form, $field, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( self::failed_state_validation( $form['id'], $field, $value ) ) {&nbsp;</div></li><li><div>                    $field-&gt;failed_validation = true;&nbsp;</div></li><li><div>                    $field-&gt;validation_message = in_array( $field-&gt;inputType, array( 'singleproduct', 'singleshipping', 'hiddenproduct' ) ) ? __( 'Please enter a valid value.', 'gravityforms' ) : __( 'Invalid selection. Please select one of the available choices.', 'gravityforms' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $field-&gt;validate( $value, $form );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $custom_validation_result = gf_apply_filters( array( 'gform_field_validation', $form['id'], $field-&gt;id ), array(&nbsp;</div></li><li><div>                'is_valid' =&gt; $field-&gt;failed_validation ? false : true, &nbsp;</div></li><li><div>                'message' =&gt; $field-&gt;validation_message&nbsp;</div></li><li><div> ), $value, $form, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field-&gt;failed_validation = rgar( $custom_validation_result, 'is_valid' ) ? false : true;&nbsp;</div></li><li><div>            $field-&gt;validation_message = rgar( $custom_validation_result, 'message' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;failed_validation ) {&nbsp;</div></li><li><div>                $is_valid = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_last_page = self::get_target_page( $form, $page_number, $field_values ) == '0';&nbsp;</div></li><li><div>        if ( $is_valid && $is_last_page && self::is_form_empty( $form ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as &$field ) {&nbsp;</div></li><li><div>                $field-&gt;failed_validation = true;&nbsp;</div></li><li><div>                $field-&gt;validation_message = esc_html__( 'At least one field must be filled out', 'gravityforms' );&nbsp;</div></li><li><div>                $is_valid = false;&nbsp;</div></li><li><div>                unset( $field-&gt;is_field_hidden );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $validation_result = gf_apply_filters( array( 'gform_validation', $form['id'] ), array( 'is_valid' =&gt; $is_valid, 'form' =&gt; $form, 'failed_validation_page' =&gt; $failed_validation_page ) );&nbsp;</div></li><li><div>        $is_valid = $validation_result['is_valid'];&nbsp;</div></li><li><div>        $form = $validation_result['form'];&nbsp;</div></li><li><div>        $failed_validation_page = $validation_result['failed_validation_page'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_valid;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_form_empty( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( ! self::is_empty( $field, $form['id'] ) && ! $field-&gt;is_field_hidden ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function failed_state_validation( $form_id, $field, $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $_gf_state;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if field can be populated dynamically, disable state validation&nbsp;</div></li><li><div>        if ( $field-&gt;allowsPrepopulate ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } else if ( ! GFCommon::is_product_field( $field-&gt;type ) && $field-&gt;type != 'donation' ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } else if ( ! in_array( $field-&gt;inputType, array( 'singleshipping', 'singleproduct', 'hiddenproduct', 'checkbox', 'radio', 'select' ) ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $_gf_state ) ) {&nbsp;</div></li><li><div>            $state = json_decode( base64_decode( $_POST[ &quot;state_{$form_id}&quot; ] ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $state || sizeof( $state ) != 2 ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //making sure state wasn't tampered with by validating checksum&nbsp;</div></li><li><div>            $checksum = wp_hash( crc32( $state[0] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $checksum !== $state[1] ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $_gf_state = json_decode( $state[0], true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $value ) ) {&nbsp;</div></li><li><div>            $value = array( $field-&gt;id =&gt; $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $value as $key =&gt; $input_value ) {&nbsp;</div></li><li><div>            $state = isset( $_gf_state[ $key ] ) ? $_gf_state[ $key ] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //converting price to a number for single product fields and single shipping fields&nbsp;</div></li><li><div>            if ( ( in_array( $field-&gt;inputType, array( 'singleproduct', 'hiddenproduct' ) ) && $key == $field-&gt;id . '.2' ) || $field-&gt;inputType == 'singleshipping' ) {&nbsp;</div></li><li><div>                $input_value = GFCommon::to_number( $input_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $sanitized_input_value = wp_kses( $input_value, wp_kses_allowed_html( 'post' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $hash = wp_hash( $input_value );&nbsp;</div></li><li><div>            $sanitized_hash = wp_hash( $sanitized_input_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fails_hash = strlen( $input_value ) &gt; 0 && $state !== false && ( ( is_array( $state ) && ! in_array( $hash, $state ) ) || ( ! is_array( $state ) && $hash != $state ) );&nbsp;</div></li><li><div>            $fails_sanitized_hash = strlen( $sanitized_input_value ) &gt; 0 && $state !== false && ( ( is_array( $state ) && ! in_array( $sanitized_hash, $state ) ) || ( ! is_array( $state ) && $sanitized_hash != $state ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $fails_hash && $fails_sanitized_hash ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function enqueue_scripts() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>        if ( isset( $wp_query-&gt;posts ) && is_array( $wp_query-&gt;posts ) ) {&nbsp;</div></li><li><div>            foreach ( $wp_query-&gt;posts as $post ) {&nbsp;</div></li><li><div>                $forms = self::get_embedded_forms( $post-&gt;post_content, $ajax );&nbsp;</div></li><li><div>                foreach ( $forms as $form ) {&nbsp;</div></li><li><div>                    if ( isset( $form['id'] ) ) {&nbsp;</div></li><li><div>                        self::enqueue_form_scripts( $form, $ajax );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_embedded_forms( $post_content, &$ajax ) {&nbsp;</div></li><li><div>        $forms = array();&nbsp;</div></li><li><div>        if ( preg_match_all( '/\[gravityform[s]? +.*?((id=.+?)|(name=.+?))\]/is', $post_content, $matches, PREG_SET_ORDER ) ) {&nbsp;</div></li><li><div>            $ajax = false;&nbsp;</div></li><li><div>            foreach ( $matches as $match ) {&nbsp;</div></li><li><div>                //parsing shortcode attributes&nbsp;</div></li><li><div>                $attr = shortcode_parse_atts( $match[1] );&nbsp;</div></li><li><div>                $form_id = rgar( $attr, 'id' );&nbsp;</div></li><li><div>                if ( ! is_numeric( $form_id ) ) {&nbsp;</div></li><li><div>                    $form_id = RGFormsModel::get_form_id( rgar( $attr, 'name' ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $form_id ) ) {&nbsp;</div></li><li><div>                    $forms[] = RGFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>                    $ajax = isset( $attr['ajax'] ) && strtolower( substr( $attr['ajax'], 0, 4 ) ) == 'true';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $forms;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function enqueue_form_scripts( $form, $ajax = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // adding pre enqueue scripts hook so that scripts can be added first if a need exists&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires before any scripts are enqueued (form specific using the ID as well)&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $form The Form Object&nbsp;</div></li><li><div>         * @param bool $ajax Whether AJAX is on or off (True or False)&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        gf_do_action( array( 'gform_pre_enqueue_scripts', $form['id'] ), $form, $ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $min = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG || isset( $_GET['gform_debug'] ) ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! get_option( 'rg_gforms_disable_css' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_enqueue_style( 'gforms_reset_css', GFCommon::get_base_url() . &quot;/css/formreset{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( self::has_datepicker_field( $form ) ) {&nbsp;</div></li><li><div>                wp_enqueue_style( 'gforms_datepicker_css', GFCommon::get_base_url() . &quot;/css/datepicker{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_enqueue_style( 'gforms_formsmain_css', GFCommon::get_base_url() . &quot;/css/formsmain{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>            wp_enqueue_style( 'gforms_ready_class_css', GFCommon::get_base_url() . &quot;/css/readyclass{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>            wp_enqueue_style( 'gforms_browsers_css', GFCommon::get_base_url() . &quot;/css/browsers{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_rtl() ) {&nbsp;</div></li><li><div>                wp_enqueue_style( 'gforms_rtl_css', GFCommon::get_base_url() . &quot;/css/rtl{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_conditional_logic( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_conditional_logic' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_datepicker_field( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_datepicker_init' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $ajax || self::has_price_field( $form ) || self::has_password_strength( $form ) || GFCommon::has_list_field( $form ) || GFCommon::has_credit_card_field( $form ) || self::has_conditional_logic( $form ) || self::has_currency_format_number_field( $form ) || self::has_calculation_field( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_gravityforms' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( GFCommon::has_multifile_fileupload_field( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'plupload-all' );&nbsp;</div></li><li><div>            GFCommon::localize_gform_gravityforms_multifile();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_enhanced_dropdown( $form ) || self::has_pages( $form ) || self::has_fileupload_field( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_json' );&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_gravityforms' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_character_counter( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_textarea_counter' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_input_mask( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_masked_input' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_enhanced_dropdown( $form ) && ! wp_script_is( 'chosen' ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_chosen' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_enhanced_dropdown( $form ) ) {&nbsp;</div></li><li><div>            if ( wp_script_is( 'chosen', 'registered' ) ) {&nbsp;</div></li><li><div>                wp_enqueue_script( 'chosen' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                wp_enqueue_script( 'gform_chosen' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_placeholder( $form ) ) {&nbsp;</div></li><li><div>            wp_enqueue_script( 'gform_placeholder' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        gf_do_action( array( 'gform_enqueue_scripts', $form['id'] ), $form, $ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // enqueue jQuery every time form is displayed to allow 'gform_post_render' js hook&nbsp;</div></li><li><div>        // to be available to users even when GF is not using it&nbsp;</div></li><li><div>        wp_enqueue_script( 'jquery' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static $printed_scripts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function print_form_scripts( $form, $ajax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! get_option( 'rg_gforms_disable_css' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! wp_style_is( 'gforms_css' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $min = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG || isset( $_GET['gform_debug'] ) ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_enqueue_style( 'gforms_reset_css', GFCommon::get_base_url() . &quot;/css/formreset{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>                wp_print_styles( array( 'gforms_reset_css' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_enqueue_style( 'gforms_formsmain_css', GFCommon::get_base_url() . &quot;/css/formsmain{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>                wp_print_styles( array( 'gforms_formsmain_css' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_enqueue_style( 'gforms_ready_class_css', GFCommon::get_base_url() . &quot;/css/readyclass{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>                wp_print_styles( array( 'gforms_ready_class_css' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_enqueue_style( 'gforms_browsers_css', GFCommon::get_base_url() . &quot;/css/browsers{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>                wp_print_styles( array( 'gforms_browsers_css' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( self::has_datepicker_field( $form ) ) {&nbsp;</div></li><li><div>                    wp_enqueue_style( 'gforms_datepicker_css', GFCommon::get_base_url() . &quot;/css/datepicker{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>                    wp_print_styles( array( 'gforms_datepicker_css' ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_rtl() ) {&nbsp;</div></li><li><div>                    wp_enqueue_style( 'gforms_rtl_css', GFCommon::get_base_url() . &quot;/css/rtl{$min}.css&quot;, null, GFCommon::$version );&nbsp;</div></li><li><div>                    wp_print_styles( array( 'gforms_rtl_css' ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $scripts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ( $ajax || self::has_enhanced_dropdown( $form ) || self::has_price_field( $form ) || self::has_password_strength( $form ) || self::has_pages( $form ) || self::has_password_strength( $form ) || GFCommon::has_list_field( $form ) || GFCommon::has_credit_card_field( $form ) || self::has_calculation_field( $form ) ) && ! wp_script_is( 'gform_gravityforms' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'gform_gravityforms';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_conditional_logic( $form ) && ! wp_script_is( 'gform_conditional_logic' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'gform_conditional_logic';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_datepicker_field( $form ) && ! wp_script_is( 'gform_datepicker_init' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'gform_datepicker_init';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_pages( $form ) && ! wp_script_is( 'gform_json' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'gform_json';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_character_counter( $form ) && ! wp_script_is( 'gform_textarea_counter' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'gform_textarea_counter';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_input_mask( $form ) && ! wp_script_is( 'gform_masked_input' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'gform_masked_input';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_enhanced_dropdown( $form ) && ! wp_script_is( 'gform_chosen' ) && ! wp_script_is( 'chosen' ) ) {&nbsp;</div></li><li><div>            if ( wp_script_is( 'chosen', 'registered' ) ) {&nbsp;</div></li><li><div>                $scripts[] = 'chosen';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $scripts[] = 'gform_chosen';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_script_is( 'jquery' ) ) {&nbsp;</div></li><li><div>            $scripts[] = 'jquery';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $scripts as $script ) {&nbsp;</div></li><li><div>            wp_enqueue_script( $script );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_print_scripts( $scripts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( wp_script_is( 'gform_gravityforms' ) ) {&nbsp;</div></li><li><div>            echo '&lt;script type=&quot;text/javascript&quot;&gt; ' . GFCommon::gf_global( false ) . ' &lt;/script&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_conditional_logic( $form ) {&nbsp;</div></li><li><div>        $has_conditional_logic = self::has_conditional_logic_legwork( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * A filter that runs through a form that has conditional logic&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $has_conditional_logic True or False if the user has conditional logic active in their current form settings&nbsp;</div></li><li><div>         * @param array $form The Current form object&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'gform_has_conditional_logic', $has_conditional_logic, $form );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_conditional_logic_legwork( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $form['button']['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( rgar( $form, 'fields' ) ) ) {&nbsp;</div></li><li><div>            foreach ( rgar( $form, 'fields' ) as $field ) {&nbsp;</div></li><li><div>                if ( ! empty( $field-&gt;conditionalLogic ) ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                } else if ( isset( $field-&gt;nextButton ) && ! empty( $field-&gt;nextButton['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get init script and all necessary data for conditional logic.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo: Replace much of the field value retrieval with a get_original_value() method in GF_Field class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param       $form&nbsp;</div></li><li><div>     * @param array $field_values&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function get_conditional_logic( $form, $field_values = array() ) {&nbsp;</div></li><li><div>        $logics = '';&nbsp;</div></li><li><div>        $dependents = '';&nbsp;</div></li><li><div>        $fields_with_logic = array();&nbsp;</div></li><li><div>        $default_values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** @var GF_Field $field */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_deps = self::get_conditional_logic_fields( $form, $field-&gt;id );&nbsp;</div></li><li><div>            $field_dependents[ $field-&gt;id ] = ! empty( $field_deps ) ? $field_deps : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //use section's logic if one exists&nbsp;</div></li><li><div>            $section = RGFormsModel::get_section( $form, $field-&gt;id );&nbsp;</div></li><li><div>            $section_logic = ! empty( $section ) ? rgar( $section, 'conditionalLogic' ) : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $field_logic = $field-&gt;type != 'page' ? $field-&gt;conditionalLogic : null; //page break conditional logic will be handled during the next button click&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $next_button_logic = ! empty( $field-&gt;nextButton ) && ! empty( $field-&gt;nextButton['conditionalLogic'] ) ? $field-&gt;nextButton['conditionalLogic'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $field_logic ) || ! empty( $next_button_logic ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $field_section_logic = array( 'field' =&gt; $field_logic, 'nextButton' =&gt; $next_button_logic, 'section' =&gt; $section_logic );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $logics .= $field-&gt;id . ': ' . GFCommon::json_encode( $field_section_logic ) . ', ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $fields_with_logic[] = $field-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $peers = $field-&gt;type == 'section' ? GFCommon::get_section_fields( $form, $field-&gt;id ) : array( $field );&nbsp;</div></li><li><div>                $peer_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $peers as $peer ) {&nbsp;</div></li><li><div>                    $peer_ids[] = $peer-&gt;id;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $dependents .= $field-&gt;id . ': ' . GFCommon::json_encode( $peer_ids ) . ', ';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //-- Saving default values so that they can be restored when toggling conditional logic ---&nbsp;</div></li><li><div>            $field_val = '';&nbsp;</div></li><li><div>            $input_type = $field-&gt;get_input_type();&nbsp;</div></li><li><div>            $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //get parameter value if pre-populate is enabled&nbsp;</div></li><li><div>            if ( $field-&gt;allowsPrepopulate ) {&nbsp;</div></li><li><div>                if ( $input_type == 'checkbox' ) {&nbsp;</div></li><li><div>                    $field_val = RGFormsModel::get_parameter_value( $field-&gt;inputName, $field_values, $field );&nbsp;</div></li><li><div>                    if ( ! is_array( $field_val ) ) {&nbsp;</div></li><li><div>                        $field_val = explode( ', ', $field_val );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } elseif ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    $field_val = array();&nbsp;</div></li><li><div>                    foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                        $field_val[&quot;input_{$input['id']}&quot;] = RGFormsModel::get_parameter_value( rgar( $input, 'name' ), $field_values, $field );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } elseif ( $input_type == 'time' ) { // maintained for backwards compatibility. The Time field now has an inputs array.&nbsp;</div></li><li><div>                    $parameter_val = RGFormsModel::get_parameter_value( $field-&gt;inputName, $field_values, $field );&nbsp;</div></li><li><div>                    if ( ! empty( $parameter_val ) && preg_match( '/^(\d*):(\d*) ?(.*)$/', $parameter_val, $matches ) ) {&nbsp;</div></li><li><div>                        $field_val = array();&nbsp;</div></li><li><div>                        $field_val[] = esc_attr( $matches[1] ); //hour&nbsp;</div></li><li><div>                        $field_val[] = esc_attr( $matches[2] ); //minute&nbsp;</div></li><li><div>                        $field_val[] = rgar( $matches, 3 );     //am or pm&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } elseif ( $input_type == 'list' ) {&nbsp;</div></li><li><div>                    $parameter_val = RGFormsModel::get_parameter_value( $field-&gt;inputName, $field_values, $field );&nbsp;</div></li><li><div>                    $field_val = is_array( $parameter_val ) ? $parameter_val : explode( ', ', str_replace( '|', ', ', $parameter_val ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_array( rgar( $field_val, 0 ) ) ) {&nbsp;</div></li><li><div>                        $list_values = array();&nbsp;</div></li><li><div>                        foreach ( $field_val as $row ) {&nbsp;</div></li><li><div>                            $list_values = array_merge( $list_values, array_values( $row ) );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $field_val = $list_values;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $field_val = RGFormsModel::get_parameter_value( $field-&gt;inputName, $field_values, $field );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //use default value if pre-populated value is empty&nbsp;</div></li><li><div>            $field_val = $field-&gt;get_value_default_if_empty( $field_val );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $field-&gt;choices ) && $input_type != 'list' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //radio buttons start at 0 and checkboxes start at 1&nbsp;</div></li><li><div>                $choice_index = $input_type == 'radio' ? 0 : 1;&nbsp;</div></li><li><div>                $is_pricing_field = GFCommon::is_pricing_field( $field-&gt;type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $input_type == 'checkbox' && ( $choice_index % 10 ) == 0 ) {&nbsp;</div></li><li><div>                        $choice_index++;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $is_prepopulated = is_array( $field_val ) ? in_array( $choice['value'], $field_val ) : $choice['value'] == $field_val;&nbsp;</div></li><li><div>                    $is_choice_selected = rgar( $choice, 'isSelected' ) || $is_prepopulated;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $is_choice_selected && $input_type == 'select' ) {&nbsp;</div></li><li><div>                        $price = GFCommon::to_number( rgar( $choice, 'price' ) ) == false ? 0 : GFCommon::to_number( rgar( $choice, 'price' ) );&nbsp;</div></li><li><div>                        $val = $is_pricing_field && $field-&gt;type != 'quantity' ? $choice['value'] . '|' . $price : $choice['value'];&nbsp;</div></li><li><div>                        $default_values[ $field-&gt;id ] = $val;&nbsp;</div></li><li><div>                    } elseif ( $is_choice_selected ) {&nbsp;</div></li><li><div>                        if ( ! isset( $default_values[ $field-&gt;id ] ) ) {&nbsp;</div></li><li><div>                            $default_values[ $field-&gt;id ] = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $default_values[ $field-&gt;id ][] = &quot;choice_{$form['id']}_{$field-&gt;id}_{$choice_index}&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $choice_index ++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( ! empty( $field_val ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch ( $input_type ) {&nbsp;</div></li><li><div>                    case 'date':&nbsp;</div></li><li><div>                        // for date fields; that are multi-input; and where the field value is a string&nbsp;</div></li><li><div>                        // (happens with prepop, default value will always be an array for multi-input date fields)&nbsp;</div></li><li><div>                        if ( is_array( $field-&gt;inputs ) && ( ! is_array( $field_val ) || ! isset( $field_val['m'] ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $format = empty( $field-&gt;dateFormat ) ? 'mdy' : esc_attr( $field-&gt;dateFormat );&nbsp;</div></li><li><div>                            $date_info = GFcommon::parse_date( $field_val, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            // converts date to array( 'm' =&gt; 1, 'd' =&gt; '13', 'y' =&gt; '1987' )&nbsp;</div></li><li><div>                            $field_val = $field-&gt;get_date_array_by_format( array( $date_info['month'], $date_info['day'], $date_info['year'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'time':&nbsp;</div></li><li><div>                        if ( is_array( $field_val ) ) {&nbsp;</div></li><li><div>                            $ampm_key = key( array_slice( $field_val, - 1, 1, true ) );&nbsp;</div></li><li><div>                            $field_val[ $ampm_key ] = strtolower( $field_val[ $ampm_key ] );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'address':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $state_input_id = sprintf( '%s.4', $field-&gt;id );&nbsp;</div></li><li><div>                        if ( isset( $field_val[ $state_input_id ] ) && ! $field_val[ $state_input_id ] ) {&nbsp;</div></li><li><div>                            $field_val[ $state_input_id ] = $field-&gt;defaultState;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $country_input_id = sprintf( '%s.6', $field-&gt;id );&nbsp;</div></li><li><div>                        if ( isset( $field_val[ $country_input_id ] ) && ! $field_val[ $country_input_id ] ) {&nbsp;</div></li><li><div>                            $field_val[ $country_input_id ] = $field-&gt;defaultCountry;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $default_values[ $field-&gt;id ] = $field_val;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $button_conditional_script = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding form button conditional logic if enabled&nbsp;</div></li><li><div>        if ( isset( $form['button']['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>            $logics .= '0: ' . GFCommon::json_encode( array( 'field' =&gt; $form['button']['conditionalLogic'], 'section' =&gt; null ) ) . ', ';&nbsp;</div></li><li><div>            $dependents .= '0: ' . GFCommon::json_encode( array( 0 ) ) . ', ';&nbsp;</div></li><li><div>            $fields_with_logic[] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $button_conditional_script = &quot;jQuery('#gform_{$form['id']}').submit(&quot; .&nbsp;</div></li><li><div>                'function(event, isButtonPress) {' .&nbsp;</div></li><li><div>                '    var visibleButton = jQuery(&quot;.gform_next_button:visible, .gform_button:visible, .gform_image_button:visible&quot;);' .&nbsp;</div></li><li><div>                '    return visibleButton.length &gt; 0 || isButtonPress == true;' .&nbsp;</div></li><li><div>                '}' .&nbsp;</div></li><li><div>                ');';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $logics ) ) {&nbsp;</div></li><li><div>            $logics = substr( $logics, 0, strlen( $logics ) - 1 );&nbsp;</div></li><li><div>        } //removing last comma;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $dependents ) ) {&nbsp;</div></li><li><div>            $dependents = substr( $dependents, 0, strlen( $dependents ) - 1 );&nbsp;</div></li><li><div>        } //removing last comma;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $animation = rgar( $form, 'enableAnimation' ) ? '1' : '0';&nbsp;</div></li><li><div>        global $wp_locale;&nbsp;</div></li><li><div>        $number_format = $wp_locale-&gt;number_format['decimal_point'] == ', ' ? 'decimal_comma' : 'decimal_dot';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $str = &quot;if(window['jQuery']) {&quot; .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &quot;if(!window['gf_form_conditional_logic'])&quot; .&nbsp;</div></li><li><div>            &quot;window['gf_form_conditional_logic'] = new Array();&quot; .&nbsp;</div></li><li><div>            &quot;window['gf_form_conditional_logic'][{$form['id']}] = { logic: { {$logics} }, dependents: { {$dependents} }, animation: {$animation}, defaults: &quot; . json_encode( $default_values ) . &quot;, fields: &quot; . json_encode( $field_dependents ) . &quot; }; &quot; .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &quot;if(!window['gf_number_format'])&quot; .&nbsp;</div></li><li><div>            &quot;window['gf_number_format'] = '&quot; . $number_format . &quot;';&quot; .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            'jQuery(document).ready(function() {' .&nbsp;</div></li><li><div>            &quot;gf_apply_rules({$form['id']}, &quot; . json_encode( $fields_with_logic ) . ', true);' .&nbsp;</div></li><li><div>            &quot;jQuery('#gform_wrapper_{$form['id']}').show();&quot; .&nbsp;</div></li><li><div>            &quot;jQuery(document).trigger('gform_post_conditional_logic', [{$form['id']}, null, true]);&quot; .&nbsp;</div></li><li><div>            $button_conditional_script .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            '} );' .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            '} ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Enqueue and retrieve all inline scripts that should be executed when the form is rendered.&nbsp;</div></li><li><div>     * Use add_init_script() function to enqueue scripts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form&nbsp;</div></li><li><div>     * @param array $field_values&nbsp;</div></li><li><div>     * @param bool  $is_ajax&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function register_form_init_scripts( $form, $field_values = array(), $is_ajax = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgars( $form, 'save/enabled' ) ) {&nbsp;</div></li><li><div>            $save_script = &quot;jQuery('#gform_save_{$form['id']}').val('');&quot;;&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'save', self::ON_PAGE_RENDER, $save_script );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // adding conditional logic script if conditional logic is configured for this form.&nbsp;</div></li><li><div>        // get_conditional_logic also adds the chosen script for the enhanced dropdown option.&nbsp;</div></li><li><div>        // if this form does not have conditional logic, add chosen script separately&nbsp;</div></li><li><div>        if ( self::has_conditional_logic( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'number_formats', self::ON_PAGE_RENDER, self::get_number_formats_script( $form ) );&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'conditional_logic', self::ON_PAGE_RENDER, self::get_conditional_logic( $form, $field_values ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding currency config if there are any product fields in the form&nbsp;</div></li><li><div>        if ( self::has_price_field( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'pricing', self::ON_PAGE_RENDER, self::get_pricing_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_password_strength( $form ) ) {&nbsp;</div></li><li><div>            $password_script = self::get_password_strength_init_script( $form );&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'password', self::ON_PAGE_RENDER, $password_script );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_enhanced_dropdown( $form ) ) {&nbsp;</div></li><li><div>            $chosen_script = self::get_chosen_init_script( $form );&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'chosen', self::ON_PAGE_RENDER, $chosen_script );&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'chosen', self::ON_CONDITIONAL_LOGIC, $chosen_script );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_character_counter( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'character_counter', self::ON_PAGE_RENDER, self::get_counter_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_input_mask( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'input_mask', self::ON_PAGE_RENDER, self::get_input_mask_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_calculation_field( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'number_formats', self::ON_PAGE_RENDER, self::get_number_formats_script( $form ) );&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'calculation', self::ON_PAGE_RENDER, self::get_calculations_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_currency_format_number_field( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'currency_format', self::ON_PAGE_RENDER, self::get_currency_format_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_currency_copy_values_option( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'copy_values', self::ON_PAGE_RENDER, self::get_copy_values_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( self::has_placeholder( $form ) ) {&nbsp;</div></li><li><div>            self::add_init_script( $form['id'], 'placeholders', self::ON_PAGE_RENDER, self::get_placeholders_init_script( $form ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $form['fields'] ) && is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                /** @var GF_Field $field */&nbsp;</div></li><li><div>                if ( is_subclass_of( $field, 'GF_Field' ) ) {&nbsp;</div></li><li><div>                    $field-&gt;register_form_init_scripts( $form );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        gf_do_action( array( 'gform_register_init_scripts', $form['id'] ), $form, $field_values, $is_ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_init_scripts( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $script_string = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // temporary solution for output gf_global obj until wp min version raised to 3.3&nbsp;</div></li><li><div>        if ( wp_script_is( 'gform_gravityforms' ) ) {&nbsp;</div></li><li><div>            $gf_global_script = &quot;if(typeof gf_global == 'undefined') &quot; . GFCommon::gf_global( false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** rendering initialization scripts */&nbsp;</div></li><li><div>        $init_scripts = rgar( self::$init_scripts, $form['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $init_scripts ) ) {&nbsp;</div></li><li><div>            $script_string =&nbsp;</div></li><li><div>                &quot;&lt;script type='text/javascript'&gt;&quot; . apply_filters( 'gform_cdata_open', '' ) . ' ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $script_string .= isset( $gf_global_script ) ? $gf_global_script : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $script_string .=&nbsp;</div></li><li><div>                &quot;jQuery(document).bind('gform_post_render', function(event, formId, currentPage) {&quot; .&nbsp;</div></li><li><div>                &quot;if(formId == {$form['id']}) {&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $init_scripts as $init_script ) {&nbsp;</div></li><li><div>                if ( $init_script['location'] == self::ON_PAGE_RENDER ) {&nbsp;</div></li><li><div>                    $script_string .= $init_script['script'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $script_string .=&nbsp;</div></li><li><div>                &quot;} &quot; . //keep the space. needed to prevent plugins from replacing }} with ]}&nbsp;</div></li><li><div>                &quot;} );&quot; .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &quot;jQuery(document).bind('gform_post_conditional_logic', function(event, formId, fields, isInit) {&quot;;&nbsp;</div></li><li><div>            foreach ( $init_scripts as $init_script ) {&nbsp;</div></li><li><div>                if ( $init_script['location'] == self::ON_CONDITIONAL_LOGIC ) {&nbsp;</div></li><li><div>                    $script_string .= $init_script['script'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $script_string .=&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &quot;} );&quot; . apply_filters( 'gform_cdata_close', '' ) . '&lt;/script&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script_string;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_chosen_init_script( $form ) {&nbsp;</div></li><li><div>        $chosen_fields = array();&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            $input_type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>            if ( $field-&gt;enableEnhancedUI && in_array( $input_type, array( 'select', 'multiselect' ) ) ) {&nbsp;</div></li><li><div>                $chosen_fields[] = &quot;#input_{$form['id']}_{$field-&gt;id}&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return &quot;gformInitChosenFields('&quot; . implode( ', ', $chosen_fields ) . &quot;', '&quot; . esc_attr( gf_apply_filters( array( 'gform_dropdown_no_results_text', $form['id'] ), __( 'No results matched', 'gravityforms' ), $form['id'] ) ) . &quot;');&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_currency_format_init_script( $form ) {&nbsp;</div></li><li><div>        $currency_fields = array();&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;numberFormat == 'currency' ) {&nbsp;</div></li><li><div>                $currency_fields[] = &quot;#input_{$form['id']}_{$field-&gt;id}&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return &quot;gformInitCurrencyFormatFields('&quot; . implode( ', ', $currency_fields ) . &quot;');&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_copy_values_init_script( $form ) {&nbsp;</div></li><li><div>        $script = &quot;jQuery('.copy_values_activated').on('click', function() {&nbsp;</div></li><li><div>                        var inputId = this.id.replace('_copy_values_activated', '');&nbsp;</div></li><li><div>                        jQuery('#' + inputId).toggle(!this.checked);&nbsp;</div></li><li><div>                    });&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_placeholders_init_script( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $script = &quot;if(typeof Placeholders != 'undefined') {&nbsp;</div></li><li><div>                        Placeholders.enable();&nbsp;</div></li><li><div>                    }&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_counter_init_script( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $script = '';&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            $max_length = $field-&gt;maxLength;&nbsp;</div></li><li><div>            $field_id = &quot;input_{$form['id']}_{$field-&gt;id}&quot;;&nbsp;</div></li><li><div>            if ( ! empty( $max_length ) && ! $field-&gt;adminOnly ) {&nbsp;</div></li><li><div>                $field_script =&nbsp;</div></li><li><div>                    &quot;jQuery('#{$field_id}').textareaCount(&quot; .&nbsp;</div></li><li><div>                    &quot;    {&quot; .&nbsp;</div></li><li><div>                    &quot;    'maxCharacterSize': {$max_length}, &quot; .&nbsp;</div></li><li><div>                    &quot;    'originalStyle': 'ginput_counter', &quot; .&nbsp;</div></li><li><div>                    &quot;    'displayFormat' : '#input &quot; . esc_js( __( 'of', 'gravityforms' ) ) . ' #max ' . esc_js( __( 'max characters', 'gravityforms' ) ) . &quot;'&quot; .&nbsp;</div></li><li><div>                    &quot;    } );&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $script .= gf_apply_filters( array( 'gform_counter_script', $form['id'] ), $field_script, $form['id'], $field_id, $max_length );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_pricing_init_script( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! class_exists( 'RGCurrency' ) ) {&nbsp;</div></li><li><div>            require_once( 'currency.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return &quot;if(window[\&quot;gformInitPriceFields\&quot;]) jQuery(document).ready(function() {gformInitPriceFields();} );&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_password_strength_init_script( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_script = &quot;if(!window['gf_text']) {window['gf_text'] = new Array();} window['gf_text']['password_blank'] = '&quot; . esc_js( __( 'Strength indicator', 'gravityforms' ) ) . &quot;'; window['gf_text']['password_mismatch'] = '&quot; . esc_js( __( 'Mismatch', 'gravityforms' ) ) . &quot;';window['gf_text']['password_bad'] = '&quot; . esc_js( __( 'Bad', 'gravityforms' ) ) . &quot;'; window['gf_text']['password_short'] = '&quot; . esc_js( __( 'Short', 'gravityforms' ) ) . &quot;'; window['gf_text']['password_good'] = '&quot; . esc_js( __( 'Good', 'gravityforms' ) ) . &quot;'; window['gf_text']['password_strong'] = '&quot; . esc_js( __( 'Strong', 'gravityforms' ) ) . &quot;';&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'password' && $field-&gt;passwordStrengthEnabled ) {&nbsp;</div></li><li><div>                $field_id = &quot;input_{$form['id']}_{$field-&gt;id}&quot;;&nbsp;</div></li><li><div>                $field_script .= &quot;gformShowPasswordStrength(\&quot;$field_id\&quot;);&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_script;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_input_mask_init_script( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $script_str = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $field-&gt;inputMask || ! $field-&gt;inputMaskValue ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $mask = $field-&gt;inputMaskValue;&nbsp;</div></li><li><div>            $script = &quot;jQuery('#input_{$form['id']}_{$field-&gt;id}').mask('&quot; . esc_js( $mask ) . &quot;').bind('keypress', function(e) {if(e.which == 13) {jQuery(this).blur();} } );&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $script_str .= gf_apply_filters( array( 'gform_input_mask_script', $form['id'] ), $script, $form['id'], $field-&gt;id, $mask );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $script_str ) ) {&nbsp;</div></li><li><div>            return 'if(!/(android)/i.test(navigator.userAgent)) {' . $script_str . '}';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script_str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_calculations_init_script( $form ) {&nbsp;</div></li><li><div>        require_once( GFCommon::get_base_path() . '/currency.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $formula_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $field-&gt;enableCalculation || ! $field-&gt;calculationFormula ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $formula_fields[] = array( 'field_id' =&gt; $field-&gt;id, 'formula' =&gt; $field-&gt;calculationFormula, 'rounding' =&gt; $field-&gt;calculationRounding );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $formula_fields ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $script = 'new GFCalc(' . $form['id'] . ', ' . GFCommon::json_encode( $formula_fields ) . ');';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $script;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates a map of fields IDs and their corresponding number formats used by the GFCalc JS object for correctly&nbsp;</div></li><li><div>     * converting field values to clean numbers.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * - Number fields have a 'numberFormat' setting (w/ UI).&nbsp;</div></li><li><div>     * - Single-input product fields (i.e. 'singleproduct', 'calculation', 'price' and 'hiddenproduct') should default to&nbsp;</div></li><li><div>     *   the number format of the configured currency.&nbsp;</div></li><li><div>     * - All other product fields will default to 'decimal_dot' for the number format.&nbsp;</div></li><li><div>     * - All other fields will have no format (false) and inherit the format of the formula field when the formula is&nbsp;</div></li><li><div>     *   calculated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed $form&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_number_formats_script( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once ( GFCommon::get_base_path() . '/currency.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $number_formats = array();&nbsp;</div></li><li><div>        $currency = RGCurrency::get_currency( GFCommon::get_currency() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // default format is false, fields with no format will inherit the format of the formula field when calculated&nbsp;</div></li><li><div>            $format = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( GFFormsModel::get_input_type( $field ) ) {&nbsp;</div></li><li><div>                case 'number':&nbsp;</div></li><li><div>                    $format = $field-&gt;numberFormat ? $field-&gt;numberFormat : 'decimal_dot';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'singleproduct':&nbsp;</div></li><li><div>                case 'calculation':&nbsp;</div></li><li><div>                case 'price':&nbsp;</div></li><li><div>                case 'hiddenproduct':&nbsp;</div></li><li><div>                case 'singleshipping':&nbsp;</div></li><li><div>                    $format = $currency['decimal_separator'] == ', ' ? 'decimal_comma' : 'decimal_dot';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // we check above for all single-input product types, for all other products, assume decimal format&nbsp;</div></li><li><div>                    if ( in_array( $field-&gt;type, array( 'product', 'option', 'shipping' ) ) ) {&nbsp;</div></li><li><div>                        $format = 'decimal_dot';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $number_formats[ $field-&gt;id ] = $format;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return 'gf_global[&quot;number_formats&quot;][' . $form['id'] . '] = ' . json_encode( $number_formats ) . ';';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_datepicker_field( $form ) {&nbsp;</div></li><li><div>        if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( RGFormsModel::get_input_type( $field ) == 'date' && $field-&gt;dateType == 'datepicker' ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_price_field( $form ) {&nbsp;</div></li><li><div>        $has_price_field = false;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            $input_type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>            $has_price_field = GFCommon::is_product_field( $input_type ) ? true : $has_price_field;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        return $has_price_field;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_fileupload_field( $form ) {&nbsp;</div></li><li><div>        if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>                if ( in_array( $input_type, array( 'fileupload', 'post_image' ) ) ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_currency_format_number_field( $form ) {&nbsp;</div></li><li><div>        if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                $input_type = RGFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>                if ( $input_type == 'number' && $field-&gt;numberFormat == 'currency' ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_currency_copy_values_option( $form ) {&nbsp;</div></li><li><div>        if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                if ( $field-&gt;enableCopyValuesOption == true ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function has_recaptcha_field( $form ) {&nbsp;</div></li><li><div>        if ( is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                if ( ( $field-&gt;type == 'captcha' || $field-&gt;inputType == 'captcha' ) && ! in_array( $field-&gt;captchaType, array( 'simple_captcha', 'math' ) ) ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_input_mask( $form, $field = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field ) {&nbsp;</div></li><li><div>            if ( self::has_field_input_mask( $field ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                if ( self::has_field_input_mask( $field ) ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_field_input_mask( $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>        if ( $type == 'phone' && $field-&gt;phoneFormat == 'standard' ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field-&gt;inputMask && $field-&gt;inputMaskValue && ! $field-&gt;enablePasswordInput ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_calculation_field( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var $field GF_Field */&nbsp;</div></li><li><div>            if ( $field-&gt;has_calculation() ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //Getting all fields that have a rule based on the specified field id&nbsp;</div></li><li><div>    public static function get_conditional_logic_fields( $form, $fieldId ) {&nbsp;</div></li><li><div>        $fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding submit button field if enabled&nbsp;</div></li><li><div>        if ( isset( $form['button']['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>            $fields[] = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;type != 'page' && ! empty( $field-&gt;conditionalLogic ) ) {&nbsp;</div></li><li><div>                foreach ( $field-&gt;conditionalLogic['rules'] as $rule ) {&nbsp;</div></li><li><div>                    if ( intval( $rule['fieldId'] ) == $fieldId ) {&nbsp;</div></li><li><div>                        $fields[] = floatval( $field-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        //if field is a section, add all fields in the section that have conditional logic (to support nesting)&nbsp;</div></li><li><div>                        if ( $field-&gt;type == 'section' ) {&nbsp;</div></li><li><div>                            $section_fields = GFCommon::get_section_fields( $form, $field-&gt;id );&nbsp;</div></li><li><div>                            foreach ( $section_fields as $section_field ) {&nbsp;</div></li><li><div>                                if ( ! empty( $section_field['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>                                    $fields[] = floatval( $section_field['id'] );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //adding fields with next button logic&nbsp;</div></li><li><div>            if ( ! empty( $field-&gt;nextButton['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>                foreach ( $field-&gt;nextButton['conditionalLogic']['rules'] as $rule ) {&nbsp;</div></li><li><div>                    if ( $rule['fieldId'] == $fieldId && ! in_array( $fieldId, $fields ) ) {&nbsp;</div></li><li><div>                        $fields[] = floatval( $field-&gt;id );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_field( $field, $value = '', $force_frontend_label = false, $form = null, $field_values = null ) {&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $custom_class = $is_admin ? '' : $field-&gt;cssClass;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field-&gt;type == 'page' ) {&nbsp;</div></li><li><div>            if ( $is_entry_detail ) {&nbsp;</div></li><li><div>                return; //ignore page breaks in the entry detail page&nbsp;</div></li><li><div>            } else if ( ! $is_form_editor ) {&nbsp;</div></li><li><div>                $save_button = rgars( $form, 'save/enabled' ) ? self::get_form_button( $form['id'], &quot;gform_save_{$form['id']}&quot;, $form['save']['button'], rgars( $form, 'save/button/text' ), 'gform_save_link', rgars( $form, 'save/button/text' ), 0, &quot;jQuery(\&quot;#gform_save_{$form['id']}\&quot;).val(1);&quot; ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $next_button = rgobj( $field, 'nextButton' ) && ! is_array( $field-&gt;nextButton ) ? $field-&gt;nextButton : self::get_form_button( $form['id'], &quot;gform_next_button_{$form['id']}_{$field-&gt;id}&quot;, $field-&gt;nextButton, __( 'Next', 'gravityforms' ), 'gform_next_button', __( 'Next Page', 'gravityforms' ), $field-&gt;pageNumber );&nbsp;</div></li><li><div>                $next_button = gf_apply_filters( array( 'gform_next_button', $form['id'] ), $next_button, $form );&nbsp;</div></li><li><div>                $previous_button = $field-&gt;pageNumber == 2 ? '' : self::get_form_button( $form['id'], &quot;gform_previous_button_{$form['id']}_{$field-&gt;id}&quot;, $field-&gt;previousButton, __( 'Previous', 'gravityforms' ), 'gform_previous_button', __( 'Previous Page', 'gravityforms' ), $field-&gt;pageNumber - 2 );&nbsp;</div></li><li><div>                if ( ! empty( $previous_button ) ) {&nbsp;</div></li><li><div>                    $previous_button = gf_apply_filters( array( 'gform_previous_button', $form['id'] ), $previous_button, $form );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $style = self::is_page_active( $form['id'], $field-&gt;pageNumber ) ? '' : &quot;style='display:none;'&quot;;&nbsp;</div></li><li><div>                $custom_class = ! empty( $custom_class ) ? &quot; {$custom_class}&quot; : '';&nbsp;</div></li><li><div>                $html = &quot;&lt;/ul&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;div class='gform_page_footer'&gt;&nbsp;</div></li><li><div>                        {$previous_button} {$next_button} {$save_button}&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div id='gform_page_{$form['id']}_{$field-&gt;pageNumber}' class='gform_page{$custom_class}' {$style}&gt;&nbsp;</div></li><li><div>                    &lt;div class='gform_page_fields'&gt;&nbsp;</div></li><li><div>                        &lt;ul id='gform_fields_{$form['id']}_{$field-&gt;pageNumber}' class='&quot; . GFCommon::get_ul_classes( $form ) . &quot;'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $html;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $is_admin && $field-&gt;adminOnly ) {&nbsp;</div></li><li><div>            if ( $field-&gt;allowsPrepopulate ) {&nbsp;</div></li><li><div>                $field-&gt;inputType = 'adminonly_hidden';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $field-&gt;id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $input_type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error_class = $field-&gt;failed_validation ? 'gfield_error' : '';&nbsp;</div></li><li><div>        $admin_only_class = $field-&gt;adminOnly ? 'field_admin_only' : '';&nbsp;</div></li><li><div>        $selectable_class = $is_admin ? 'selectable' : '';&nbsp;</div></li><li><div>        $hidden_class = in_array( $input_type, array( 'hidden', 'hiddenproduct' ) ) ? 'gform_hidden' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $section_class = $field-&gt;type == 'section' ? 'gsection' : '';&nbsp;</div></li><li><div>        $page_class = $field-&gt;type == 'page' ? 'gpage' : '';&nbsp;</div></li><li><div>        $html_block_class = $field-&gt;type == 'html' ? 'gfield_html' : '';&nbsp;</div></li><li><div>        $html_formatted_class = $field-&gt;type == 'html' && ! $is_admin && ! $field-&gt;disableMargins ? 'gfield_html_formatted' : '';&nbsp;</div></li><li><div>        $html_no_follows_desc_class = $field-&gt;type == 'html' && ! $is_admin && ! self::prev_field_has_description( $form, $field-&gt;id ) ? 'gfield_no_follows_desc' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $calculation_class = $input_type == 'calculation' || ( $input_type == 'number' && $field-&gt;has_calculation() )  ? 'gfield_calculation' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_suffix = &quot;_{$form['id']}_&quot; . $field-&gt;productField;&nbsp;</div></li><li><div>        $option_class = $field-&gt;type == 'option' ? &quot;gfield_price gfield_price{$product_suffix} gfield_option{$product_suffix}&quot; : '';&nbsp;</div></li><li><div>        $quantity_class = $field-&gt;type == 'quantity' ? &quot;gfield_price gfield_price{$product_suffix} gfield_quantity gfield_quantity{$product_suffix}&quot; : '';&nbsp;</div></li><li><div>        $total_class = $field-&gt;type == 'total' ? &quot;gfield_price gfield_price{$product_suffix} gfield_total gfield_total{$product_suffix}&quot; : '';&nbsp;</div></li><li><div>        $shipping_class = $field-&gt;type == 'shipping' ? &quot;gfield_price gfield_shipping gfield_shipping_{$form['id']}&quot; : '';&nbsp;</div></li><li><div>        $product_class = $field-&gt;type == 'product' ? &quot;gfield_price gfield_price_{$form['id']}_{$field-&gt;id} gfield_product_{$form['id']}_{$field-&gt;id}&quot; : '';&nbsp;</div></li><li><div>        $hidden_product_class = $input_type == 'hiddenproduct' ? 'gfield_hidden_product' : '';&nbsp;</div></li><li><div>        $donation_class = $field-&gt;type == 'donation' ? &quot;gfield_price gfield_price_{$form['id']}_{$field-&gt;id} gfield_donation_{$form['id']}_{$field-&gt;id}&quot; : '';&nbsp;</div></li><li><div>        $required_class = $field-&gt;isRequired ? 'gfield_contains_required' : '';&nbsp;</div></li><li><div>        $creditcard_warning_class = $input_type == 'creditcard' && ! GFCommon::is_ssl() ? 'gfield_creditcard_warning' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_sublabel_setting = rgempty( 'subLabelPlacement', $form ) ? 'below' : $form['subLabelPlacement'];&nbsp;</div></li><li><div>        $sublabel_setting = ! isset( $field-&gt;subLabelPlacement ) || empty( $field-&gt;subLabelPlacement ) ? $form_sublabel_setting : $field-&gt;subLabelPlacement;&nbsp;</div></li><li><div>        $sublabel_class = &quot;field_sublabel_{$sublabel_setting}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_description_setting = rgempty( 'descriptionPlacement', $form ) ? 'below' : $form['descriptionPlacement'];&nbsp;</div></li><li><div>        $description_setting = ! isset( $field-&gt;descriptionPlacement ) || empty( $field-&gt;descriptionPlacement ) ? $form_description_setting : $field-&gt;descriptionPlacement;&nbsp;</div></li><li><div>        $description_class = &quot;field_description_{$description_setting}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_setting_label_placement = $field-&gt;labelPlacement;&nbsp;</div></li><li><div>        $label_placement = empty( $field_setting_label_placement ) ? '' : $field_setting_label_placement;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $css_class = &quot;$selectable_class gfield $error_class $section_class $admin_only_class $custom_class $hidden_class $html_block_class $html_formatted_class $html_no_follows_desc_class $option_class $quantity_class $product_class $total_class $donation_class $shipping_class $page_class $required_class $hidden_product_class $creditcard_warning_class $calculation_class $sublabel_class $description_class $label_placement&quot;;&nbsp;</div></li><li><div>        $css_class = preg_replace( '/\s+/', ' ', $css_class ); //removing extra spaces&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $css_class = gf_apply_filters( array( 'gform_field_css_class', $form['id'] ), trim( $css_class ), $field, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $style = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_id = $is_admin || empty( $form ) ? &quot;field_$id&quot; : 'field_' . $form['id'] . &quot;_$id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_content = self::get_field_content( $field, $value, $force_frontend_label, $form == null ? 0 : $form['id'], $form );&nbsp;</div></li><li><div>        $field_container = &quot;&lt;li id='$field_id' class='{$css_class}' $style&gt;{FIELD_CONTENT}&lt;/li&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_container = gf_apply_filters( array( 'gform_field_container', $form['id'], $field-&gt;id ), $field_container, $field, $form, $css_class, $style, $field_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_markup = str_replace( '{FIELD_CONTENT}', $field_content, $field_container );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_markup;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function prev_field_has_description( $form, $field_id ) {&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $prev = null;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;id == $field_id ) {&nbsp;</div></li><li><div>                return $prev != null && ! empty( $prev['description'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $prev = $field;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field      $field&nbsp;</div></li><li><div>     * @param string         $value&nbsp;</div></li><li><div>     * @param bool           $force_frontend_label&nbsp;</div></li><li><div>     * @param int           $form_id&nbsp;</div></li><li><div>     * @param null|array       $form&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_field_content( $field, $value = '', $force_frontend_label = false, $form_id = 0, $form = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_label = $field-&gt;get_field_label( $form, $value );&nbsp;</div></li><li><div>        $admin_buttons = $field-&gt;get_admin_buttons();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $input_type = GFFormsModel::get_input_type( $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $input_type == 'adminonly_hidden' ) {&nbsp;</div></li><li><div>            $field_content = ! $is_admin ? '{FIELD}' : sprintf( &quot;%s&lt;label class='gfield_label' &gt;%s&lt;/label&gt;{FIELD}&quot;, $admin_buttons, esc_html( $field_label ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $field_content = $field-&gt;get_field_content( $value, $force_frontend_label, $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $input_type == 'creditcard' && ! GFCommon::is_ssl() && ! $is_admin ) {&nbsp;</div></li><li><div>            $field_content = &quot;&lt;div class='gfield_creditcard_warning_message'&gt;&lt;span&gt;&quot; . esc_html__( 'This page is unsecured. Do not enter a real credit card number! Use this field only for testing purposes. ', 'gravityforms' ) . '&lt;/span&gt;&lt;/div&gt;' . $field_content;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = $field-&gt;get_value_default_if_empty( $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_content = str_replace( '{FIELD}', GFCommon::get_field_input( $field, $value, 0, $form_id, $form ), $field_content );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_content = apply_filters( 'gform_field_content', $field_content, $field, $value, 0, $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_content;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_progress_bar( $form, $form_id, $confirmation_message ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $progress_complete = false;&nbsp;</div></li><li><div>        $progress_bar = '';&nbsp;</div></li><li><div>        $page_count = self::get_max_page_number( $form );&nbsp;</div></li><li><div>        $current_page = self::get_current_page( $form_id );&nbsp;</div></li><li><div>        $page_name = rgar( rgar( $form['pagination'], 'pages' ), $current_page - 1 );&nbsp;</div></li><li><div>        $page_name = ! empty( $page_name ) ? ' - ' . $page_name : '';&nbsp;</div></li><li><div>        $style = $form['pagination']['style'];&nbsp;</div></li><li><div>        $color = $style == 'custom' ? &quot; color:{$form['pagination']['color']};&quot; : '';&nbsp;</div></li><li><div>        $bgcolor = $style == 'custom' ? &quot; background-color:{$form['pagination']['backgroundColor']};&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $confirmation_message ) ) {&nbsp;</div></li><li><div>            $progress_complete = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        //check admin setting for whether the progress bar should start at zero&nbsp;</div></li><li><div>        $start_at_zero = rgars( $form, 'pagination/display_progressbar_on_confirmation' );&nbsp;</div></li><li><div>        //check for filter&nbsp;</div></li><li><div>        $start_at_zero = apply_filters( 'gform_progressbar_start_at_zero', $start_at_zero, $form );&nbsp;</div></li><li><div>        $progressbar_page_count = $start_at_zero ? $current_page - 1 : $current_page;&nbsp;</div></li><li><div>        $percent = ! $progress_complete ? floor( ( ( $progressbar_page_count ) / $page_count ) * 100 ) . '%' : '100%';&nbsp;</div></li><li><div>        $percent_number = ! $progress_complete ? floor( ( ( $progressbar_page_count ) / $page_count ) * 100 ) . '' : '100';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $progress_complete ) {&nbsp;</div></li><li><div>            $wrapper_css_class = GFCommon::get_browser_class() . ' gform_wrapper';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //add on surrounding wrapper class when confirmation page&nbsp;</div></li><li><div>            $progress_bar = &quot;&lt;div class='{$wrapper_css_class}' id='gform_wrapper_$form_id' &gt;&quot;;&nbsp;</div></li><li><div>            $page_name = ! empty( $form['pagination']['progressbar_completion_text'] ) ? $form['pagination']['progressbar_completion_text'] : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $progress_bar .= &quot;&nbsp;</div></li><li><div>        &lt;div id='gf_progressbar_wrapper_{$form_id}' class='gf_progressbar_wrapper'&gt;&nbsp;</div></li><li><div>            &lt;h3 class='gf_progressbar_title'&gt;&quot;;&nbsp;</div></li><li><div>        $progress_bar .= ! $progress_complete ? esc_html__( 'Step', 'gravityforms' ) . &quot; {$current_page} &quot; . esc_html__( 'of', 'gravityforms' ) . &quot; {$page_count}{$page_name}&quot; : &quot;{$page_name}&quot;;&nbsp;</div></li><li><div>        $progress_bar .= &quot;&nbsp;</div></li><li><div>        &lt;/h3&gt;&nbsp;</div></li><li><div>            &lt;div class='gf_progressbar'&gt;&nbsp;</div></li><li><div>                &lt;div class='gf_progressbar_percentage percentbar_{$style} percentbar_{$percent_number}' style='width:{$percent};{$color}{$bgcolor}'&gt;&lt;span&gt;{$percent}&lt;/span&gt;&lt;/div&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>        //close div for surrounding wrapper class when confirmation page&nbsp;</div></li><li><div>        $progress_bar .= $progress_complete ? $confirmation_message . '&lt;/div&gt;' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $progress_bar;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validates the form's entry limit settings. Returns the entry limit message if entry limit exceeded.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form current GF form object&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string If entry limit exceeded returns entry limit setting.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function validate_entry_limit( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //If form has a limit of entries, check current entry count&nbsp;</div></li><li><div>        if ( rgar( $form, 'limitEntries' ) ) {&nbsp;</div></li><li><div>            $period = rgar( $form, 'limitEntriesPeriod' );&nbsp;</div></li><li><div>            $range = self::get_limit_period_dates( $period );&nbsp;</div></li><li><div>            $entry_count = RGFormsModel::get_lead_count( $form['id'], '', null, null, $range['start_date'], $range['end_date'], 'active' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $entry_count &gt;= $form['limitEntriesCount'] ) {&nbsp;</div></li><li><div>                return empty( $form['limitEntriesMessage'] ) ? &quot;&lt;div class='gf_submission_limit_message'&gt;&lt;p&gt;&quot; . esc_html__( 'Sorry. This form is no longer accepting new submissions.', 'gravityforms' ) . '&lt;/p&gt;&lt;/div&gt;' : '&lt;p&gt;' . GFCommon::gform_do_shortcode( $form['limitEntriesMessage'] ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function validate_form_schedule( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //If form has a schedule, make sure it is within the configured start and end dates&nbsp;</div></li><li><div>        if ( rgar( $form, 'scheduleForm' ) ) {&nbsp;</div></li><li><div>            $local_time_start = sprintf( '%s %02d:%02d %s', $form['scheduleStart'], $form['scheduleStartHour'], $form['scheduleStartMinute'], $form['scheduleStartAmpm'] );&nbsp;</div></li><li><div>            $local_time_end = sprintf( '%s %02d:%02d %s', $form['scheduleEnd'], $form['scheduleEndHour'], $form['scheduleEndMinute'], $form['scheduleEndAmpm'] );&nbsp;</div></li><li><div>            $timestamp_start = strtotime( $local_time_start . ' +0000' );&nbsp;</div></li><li><div>            $timestamp_end = strtotime( $local_time_end . ' +0000' );&nbsp;</div></li><li><div>            $now = current_time( 'timestamp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $form['scheduleStart'] ) && $now &lt; $timestamp_start ) {&nbsp;</div></li><li><div>                return empty( $form['schedulePendingMessage'] ) ? '&lt;p&gt;' . esc_html__( 'This form is not yet available.', 'gravityforms' ) . '&lt;/p&gt;' : '&lt;p&gt;' . GFCommon::gform_do_shortcode( $form['schedulePendingMessage'] ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>            } elseif ( ! empty( $form['scheduleEnd'] ) && $now &gt; $timestamp_end ) {&nbsp;</div></li><li><div>                return empty( $form['scheduleMessage'] ) ? '&lt;p&gt;' . esc_html__( 'Sorry. This form is no longer available.', 'gravityforms' ) . '&lt;/p&gt;' : '&lt;p&gt;' . GFCommon::gform_do_shortcode( $form['scheduleMessage'] ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_confirmation( $form, $lead = null, $event = '' ) {&nbsp;</div></li><li><div>        if ( ! is_array( rgar( $form, 'confirmations' ) ) ) {&nbsp;</div></li><li><div>            return $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $event ) ) {&nbsp;</div></li><li><div>            $confirmations = wp_filter_object_list( $form['confirmations'], array( 'event' =&gt; $event ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $confirmations = $form['confirmations'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if there is only one confirmation, don't bother with the conditional logic, just return it&nbsp;</div></li><li><div>        // this is here mostly to avoid the semi-costly GFFormsModel::create_lead() function unless we really need it&nbsp;</div></li><li><div>        if ( is_array( $form['confirmations'] ) && count( $confirmations ) &lt;= 1 ) {&nbsp;</div></li><li><div>            $form['confirmation'] = reset( $confirmations );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $lead ) ) {&nbsp;</div></li><li><div>            $lead = GFFormsModel::create_lead( $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $confirmations as $confirmation ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( rgar( $confirmation, 'event' ) != $event ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( rgar( $confirmation, 'isDefault' ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $confirmation['isActive'] ) && ! $confirmation['isActive'] ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $logic = rgar( $confirmation, 'conditionalLogic' );&nbsp;</div></li><li><div>            if ( GFCommon::evaluate_conditional_logic( $logic, $form, $lead ) ) {&nbsp;</div></li><li><div>                $form['confirmation'] = $confirmation;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $form;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filtered_list = wp_filter_object_list( $form['confirmations'], array( 'isDefault' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['confirmation'] = reset( $filtered_list );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function process_send_resume_link() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = rgpost( 'gform_send_resume_link' );&nbsp;</div></li><li><div>        $form_id = absint( $form_id );&nbsp;</div></li><li><div>        $email = rgpost( 'gform_resume_email' );&nbsp;</div></li><li><div>        $resume_token = rgpost( 'gform_resume_token' );&nbsp;</div></li><li><div>        $resume_token = sanitize_key( $resume_token );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form_id ) || empty( $email ) || empty( $resume_token ) || ! GFCommon::is_valid_email( $email ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = GFFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $form, 'requireLogin' ) ) {&nbsp;</div></li><li><div>            if ( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>                wp_die();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            check_admin_referer( 'gform_send_resume_link', '_gform_send_resume_link_nonce' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $incomplete_submission = GFFormsModel::get_incomplete_submission_values( $resume_token );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $submission = json_decode( $incomplete_submission['submission'], true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $partial_entry = $submission['partial_entry'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notifications_to_send = GFCommon::get_notifications_to_send( 'form_save_email_requested', $form, $partial_entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $log_notification_event = empty( $notifications_to_send ) ? 'No notifications to process' : 'Processing notifications';&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFFormDisplay::process_send_resume_link(): {$log_notification_event} for form_save_email_requested event.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $notifications_to_send as $notification ) {&nbsp;</div></li><li><div>            if ( isset( $notification['isActive'] ) && ! $notification['isActive'] ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( &quot;GFFormDisplay::process_send_resume_link(): Notification is inactive, not processing notification (#{$notification['id']} - {$notification['name']}).&quot; );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $notification['toType'] == 'hidden' ) {&nbsp;</div></li><li><div>                $notification['to'] = $email;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $notification['message'] = self::replace_save_variables( $notification['message'], $form, $resume_token, $email );&nbsp;</div></li><li><div>            GFCommon::send_notification( $notification, $form, $partial_entry );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFFormsModel::add_email_to_incomplete_sumbmission( $resume_token, $email );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function replace_save_variables( $text, $form, $resume_token, $email = null ) {&nbsp;</div></li><li><div>        $resume_token = sanitize_key( $resume_token );&nbsp;</div></li><li><div>        $form_id = intval( $form['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $resume_url = apply_filters( 'gform_save_and_continue_resume_url', add_query_arg( array( 'gf_token' =&gt; $resume_token ), GFFormsModel::get_current_page_url() ), $form, $resume_token, $email );&nbsp;</div></li><li><div>        $resume_url = esc_url( $resume_url );&nbsp;</div></li><li><div>        $resume_link = &quot;&lt;a href=\&quot;{$resume_url}\&quot; class='resume_form_link'&gt;{$resume_url}&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>        $text = str_replace( '{save_link}', $resume_link, $text );&nbsp;</div></li><li><div>        $text = str_replace( '{save_token}', $resume_token, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = str_replace( '{save_url}', $resume_url, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $email_esc = esc_attr( $email );&nbsp;</div></li><li><div>        $text = str_replace( '{save_email}', $email_esc, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $resume_submit_button_text = esc_html__( 'Send Email', 'gravityforms' );&nbsp;</div></li><li><div>        $resume_email_validation_message = esc_html__( 'Please enter a valid email address.', 'gravityforms' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The {save_email_input} accepts shortcode-style options button_text and validation_message. E.g., &nbsp;</div></li><li><div>        // {save_email_input: button_text=&quot;Send the link to my email address&quot; validation_message=&quot;The link couldn't be sent because the email address is not valid.&quot;}&nbsp;</div></li><li><div>        preg_match_all( '/\{save_email_input:(.*?)\}/', $text, $matches, PREG_SET_ORDER );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $matches ) && isset( $matches[0] ) && isset( $matches[0][1] ) ) {&nbsp;</div></li><li><div>            $options_string = isset( $matches[0][1] ) ? $matches[0][1] : '';&nbsp;</div></li><li><div>            $options = shortcode_parse_atts( $options_string );&nbsp;</div></li><li><div>            if ( isset( $options['button_text'] ) ) {&nbsp;</div></li><li><div>                $resume_submit_button_text = $options['button_text'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( isset( $options['validation_message'] ) ) {&nbsp;</div></li><li><div>                $resume_email_validation_message = $options['validation_message'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $full_tag = $matches[0][0];&nbsp;</div></li><li><div>            $text = str_replace( $full_tag, '{save_email_input}', $text );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $action = esc_url( remove_query_arg( 'gf_token' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ajax = isset( $_POST['gform_ajax'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_pages = self::has_pages( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $default_anchor = $has_pages || $ajax ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $use_anchor = gf_apply_filters( array( 'gform_confirmation_anchor', $form_id ), $default_anchor );&nbsp;</div></li><li><div>        if ( $use_anchor !== false ) {&nbsp;</div></li><li><div>            $action .= &quot;#gf_$form_id&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $html_input_type = RGFormsModel::is_html5_enabled() ? 'email' : 'text';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $resume_token = esc_attr( $resume_token );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $validation_message = ! is_null( $email ) && ! GFCommon::is_valid_email( $email ) ? sprintf( '&lt;div class=&quot;validation_message&quot;&gt;%s&lt;/div&gt;', $resume_email_validation_message ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $nonce_input = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rgar( $form, 'requireLogin' ) ) {&nbsp;</div></li><li><div>            $nonce_input = wp_nonce_field( 'gform_send_resume_link', '_gform_send_resume_link_nonce', true, false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $target = $ajax ? &quot;target='gform_ajax_frame_{$form_id}'&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ajax_fields = '';&nbsp;</div></li><li><div>        if ( $ajax ) {&nbsp;</div></li><li><div>            $ajax_fields = &quot;&lt;input type='hidden' name='gform_ajax' value='&quot; . esc_attr( &quot;form_id={$form_id}&amp;title=1&amp;description=1&amp;tabindex=1&quot; ) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>            $ajax_fields .= &quot;&lt;input type='hidden' name='gform_field_values' value='' /&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $resume_form = &quot;&lt;div class='form_saved_message_emailform'&gt;&nbsp;</div></li><li><div>                            &lt;form action='{$action}' method='POST' id='gform_{$form_id}' {$target}&gt;&nbsp;</div></li><li><div>                                {$ajax_fields}&nbsp;</div></li><li><div>                                &lt;input type='{$html_input_type}' name='gform_resume_email' value='{$email_esc}'/&gt;&nbsp;</div></li><li><div>                                &lt;input type='hidden' name='gform_resume_token' value='{$resume_token}' /&gt;&nbsp;</div></li><li><div>                                &lt;input type='hidden' name='gform_send_resume_link' value='{$form_id}' /&gt;&nbsp;</div></li><li><div>                                &lt;input type='submit' name='gform_send_resume_link_button' id='gform_send_resume_link_button_{$form_id}' value='{$resume_submit_button_text}' /&gt;&nbsp;</div></li><li><div>                                {$validation_message}&nbsp;</div></li><li><div>                                {$nonce_input}&nbsp;</div></li><li><div>                            &lt;/form&gt;&nbsp;</div></li><li><div>                        &lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $text = str_replace( '{save_email_input}', $resume_form, $text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function handle_save_email_confirmation( $form, $ajax ) {&nbsp;</div></li><li><div>        $resume_email = $_POST['gform_resume_email'];&nbsp;</div></li><li><div>        if ( ! GFCommon::is_valid_email( $resume_email ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormDisplay::handle_save_email_confirmation(): Invalid email address: ' . $resume_email );&nbsp;</div></li><li><div>            return new WP_Error( 'invalid_email' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $resume_token = $_POST['gform_resume_token'];&nbsp;</div></li><li><div>        $submission_details = GFFormsModel::get_incomplete_submission_values( $resume_token );&nbsp;</div></li><li><div>        $submission_json = $submission_details['submission'];&nbsp;</div></li><li><div>        $submission = json_decode( $submission_json, true );&nbsp;</div></li><li><div>        $entry = $submission['partial_entry'];&nbsp;</div></li><li><div>        $form = self::update_confirmation( $form, $entry, 'form_save_email_sent' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmation = '&lt;div class=&quot;form_saved_message_sent&quot;&gt;&lt;span&gt;' . rgar( $form['confirmation'], 'message' ) . '&lt;/span&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>        $nl2br = rgar( $form['confirmation'], 'disableAutoformat' ) ? false : true;&nbsp;</div></li><li><div>        $save_email_confirmation = self::replace_save_variables( $confirmation, $form, $resume_token, $resume_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $save_email_confirmation = GFCommon::replace_variables( $save_email_confirmation, $form, $entry, false, true, $nl2br );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = absint( $form['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_pages = self::has_pages( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $default_anchor = $has_pages || $ajax ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $use_anchor = gf_apply_filters( array( 'gform_confirmation_anchor', $form_id ), $default_anchor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_anchor !== false ) {&nbsp;</div></li><li><div>            $save_email_confirmation = &quot;&lt;a id='gf_$form_id' class='gform_anchor' &gt;&lt;/a&gt;&quot; . $save_email_confirmation;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $ajax ) {&nbsp;</div></li><li><div>            $save_email_confirmation = &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset='UTF-8' /&gt;&lt;/head&gt;&lt;body class='GF_AJAX_POSTBACK'&gt;&quot; . $save_email_confirmation . '&lt;/body&gt;&lt;/html&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormDisplay::handle_save_email_confirmation(): Confirmation =&gt; ' . print_r( $save_email_confirmation, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $save_email_confirmation;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function handle_save_confirmation( $form, $resume_token, $confirmation_message, $ajax ) {&nbsp;</div></li><li><div>        $resume_email = isset( $_POST['gform_resume_email'] ) ? $_POST['gform_resume_email'] : null;&nbsp;</div></li><li><div>        $confirmation_message = self::replace_save_variables( $confirmation_message, $form, $resume_token, $resume_email );&nbsp;</div></li><li><div>        $confirmation_message = &quot;&lt;div class='form_saved_message'&gt;&lt;span&gt;&quot; . $confirmation_message . '&lt;/span&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = absint( $form['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_pages = self::has_pages( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $default_anchor = $has_pages || $ajax ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $use_anchor = gf_apply_filters( array( 'gform_confirmation_anchor', $form_id ), $default_anchor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_anchor !== false ) {&nbsp;</div></li><li><div>            $confirmation_message = &quot;&lt;a id='gf_{$form_id}' class='gform_anchor' &gt;&lt;/a&gt;&quot; . $confirmation_message;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wrapper_css_class = GFCommon::get_browser_class() . ' gform_wrapper';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmation_message = &quot;&lt;div class='{$wrapper_css_class}' id='gform_wrapper_{$form_id}'&gt;&quot; . $confirmation_message . '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $ajax ) {&nbsp;</div></li><li><div>            $confirmation_message = &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset='UTF-8' /&gt;&lt;/head&gt;&lt;body class='GF_AJAX_POSTBACK'&gt;&quot; . $confirmation_message . '&lt;/body&gt;&lt;/html&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormDisplay::handle_save_confirmation(): Confirmation =&gt; ' . print_r( $confirmation_message, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $confirmation_message;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Insert review page into form.&nbsp;</div></li><li><div>     * &nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     * @param array $form - The current Form object&nbsp;</div></li><li><div>     * @param array $review_page - The review page&nbsp;</div></li><li><div>     * @return array $form&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function insert_review_page( $form, $review_page ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Get field ID and page number for new fields. */&nbsp;</div></li><li><div>        $new_field_id = self::get_max_field_id( $form ) + 1;&nbsp;</div></li><li><div>        $page_number = self::get_max_page_number( $form );&nbsp;</div></li><li><div>        $page_number = $page_number == 0 ? 2 : $page_number+1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Get Review Page button text. */&nbsp;</div></li><li><div>        $button_text = rgar( $review_page, 'button_text' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Create new Page field for review page. */&nbsp;</div></li><li><div>        $review_page_break = new GF_Field_Page();&nbsp;</div></li><li><div>        $review_page_break-&gt;id = $new_field_id;&nbsp;</div></li><li><div>        $review_page_break-&gt;pageNumber = $page_number;&nbsp;</div></li><li><div>        $review_page_break-&gt;nextButton = self::get_form_button( $form['id'], &quot;gform_next_button_{$form['id']}_{$review_page_break-&gt;id}&quot;, array( 'type' =&gt; 'text', 'text' =&gt; $button_text ), $button_text, 'gform_next_button', $button_text, $review_page_break-&gt;pageNumber );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Add review page break field to form. */&nbsp;</div></li><li><div>        $form['fields'][] = $review_page_break;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        /** Create new HTML field for review page. */&nbsp;</div></li><li><div>        $review_page_field = new GF_Field_HTML();&nbsp;</div></li><li><div>        $review_page_field-&gt;id = $new_field_id++;&nbsp;</div></li><li><div>        $review_page_field-&gt;pageNumber = $page_number;&nbsp;</div></li><li><div>        $review_page_field-&gt;content = rgar( $review_page, 'content' );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        /** Add review page field to form. */&nbsp;</div></li><li><div>        $form['fields'][] = $review_page_field;&nbsp;</div></li><li><div>                &nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.3.9.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/gfform_display/" class="active">1.9.14.22</a></li><li><a href="http://hookr.io/plugins/gravity-forms/1.3.9.1/classes/gfform_display/" class="">1.3.9.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>GFFormDisplay</li><li><span></span>wp-plugin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>