<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.4" data-type="file" data-id="4778"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-includes-id3-module-audio-mp3 | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=5e306f9589e60f29fc3c2d0f6ea4ce2b' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-includes-id3-module-audio-mp3/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-id3-module-audio-mp3%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-id3-module-audio-mp3%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.4-file-wp-includes-id3-module-audio-mp3","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-includes-id3-module-audio-mp3" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.4." href="http://hookr.io/4.7.4/" class="H_VERSION"><span property="name">4.7.4</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-includes-id3-module-audio-&hellip;</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6316"><a href="http://hookr.io/4.7.4/all/" title="All">All <span class="count badge">6316</span></a></li><li class="" data-id="new" data-count="6"><a href="http://hookr.io/4.7.4/new/" title="New">New <span class="count badge">6</span></a></li><li class="" data-id="hooks" data-count="2538"><a href="http://hookr.io/4.7.4/hooks/" title="Hooks">Hooks <span class="count badge">2538</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.4/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1674"><a href="http://hookr.io/4.7.4/filters/" title="Filters">Filters <span class="count badge">1674</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.4/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.4/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2853"><a href="http://hookr.io/4.7.4/functions/" title="Functions">Functions <span class="count badge">2853</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-includes/ID3/module.audio.mp3.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">/////////////////////////////////////////////////////////////////</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">/// getID3() by James Heinrich &lt;info@getid3.org&gt;               //</span>&nbsp;</div></li><li><div><span class="comment">//  available at http://getid3.sourceforge.net                 //</span>&nbsp;</div></li><li><div><span class="comment">//            or http://www.getid3.org                         //</span>&nbsp;</div></li><li><div><span class="comment">//          also https://github.com/JamesHeinrich/getID3       //</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">/////////////////////////////////////////////////////////////////</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">// See readme.txt for more details                             //</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">/////////////////////////////////////////////////////////////////</span></span></span></span>&nbsp;</div></li><li><div><span class="comment">//                                                             //</span>&nbsp;</div></li><li><div><span class="comment">// module.audio.mp3.php                                        //</span>&nbsp;</div></li><li><div><span class="comment">// module for analyzing MP3 files                              //</span>&nbsp;</div></li><li><div><span class="comment">// dependencies: NONE                                          //</span>&nbsp;</div></li><li><div><span class="comment">//                                                            ///</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">/////////////////////////////////////////////////////////////////</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// number of frames to scan to determine if MPEG-audio sequence is valid</span>&nbsp;</div></li><li><div><span class="comment">// Lower this number to 5-20 for faster scanning</span>&nbsp;</div></li><li><div><span class="comment">// Increase this number to 50+ for most accurate detection of valid VBR/CBR</span>&nbsp;</div></li><li><div><span class="comment">// mpeg-audio streams</span>&nbsp;</div></li><li><div>define('GETID3_MP3_VALID_CHECK_FRAMES', 35);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class getid3_mp3 extends getid3_handler&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $allow_bruteforce = false; <span class="comment">// forces getID3() to scan the file byte-by-byte and log all the valid audio frame headers - extremely slow, unrecommended, but may provide data from otherwise-unusuable files</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function Analyze() {&nbsp;</div></li><li><div>      $info = &$this-&gt;getid3-&gt;info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $initialOffset = $info['avdataoffset'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;getOnlyMPEGaudioInfo($info['avdataoffset'])) {&nbsp;</div></li><li><div>          if ($this-&gt;allow_bruteforce) {&nbsp;</div></li><li><div>              $info['error'][] = 'Rescanning file in BruteForce mode';&nbsp;</div></li><li><div>              $this-&gt;getOnlyMPEGaudioInfoBruteForce($this-&gt;getid3-&gt;fp, $info);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($info['mpeg']['audio']['bitrate_mode'])) {&nbsp;</div></li><li><div>          $info['audio']['bitrate_mode'] = strtolower($info['mpeg']['audio']['bitrate_mode']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (((isset($info['id3v2']['headerlength']) && ($info['avdataoffset'] &gt; $info['id3v2']['headerlength'])) || (!isset($info['id3v2']) && ($info['avdataoffset'] &gt; 0) && ($info['avdataoffset'] != $initialOffset)))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $synchoffsetwarning = 'Unknown data before synch ';&nbsp;</div></li><li><div>          if (isset($info['id3v2']['headerlength'])) {&nbsp;</div></li><li><div>              $synchoffsetwarning .= '(ID3v2 header ends at '.$info['id3v2']['headerlength'].', then '.($info['avdataoffset'] - $info['id3v2']['headerlength']).' bytes garbage, ';&nbsp;</div></li><li><div>          } elseif ($initialOffset &gt; 0) {&nbsp;</div></li><li><div>              $synchoffsetwarning .= '(should be at '.$initialOffset.', ';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $synchoffsetwarning .= '(should be at beginning of file, ';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $synchoffsetwarning .= 'synch detected at '.$info['avdataoffset'].')';&nbsp;</div></li><li><div>          if (isset($info['audio']['bitrate_mode']) && ($info['audio']['bitrate_mode'] == 'cbr')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!empty($info['id3v2']['headerlength']) && (($info['avdataoffset'] - $info['id3v2']['headerlength']) == $info['mpeg']['audio']['framelength'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $synchoffsetwarning .= '. This is a known problem with some versions of LAME (3.90-3.92) DLL in CBR mode.';&nbsp;</div></li><li><div>                  $info['audio']['codec'] = 'LAME';&nbsp;</div></li><li><div>                  $CurrentDataLAMEversionString = 'LAME3.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif (empty($info['id3v2']['headerlength']) && ($info['avdataoffset'] == $info['mpeg']['audio']['framelength'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $synchoffsetwarning .= '. This is a known problem with some versions of LAME (3.90 - 3.92) DLL in CBR mode.';&nbsp;</div></li><li><div>                  $info['audio']['codec'] = 'LAME';&nbsp;</div></li><li><div>                  $CurrentDataLAMEversionString = 'LAME3.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $info['warning'][] = $synchoffsetwarning;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($info['mpeg']['audio']['LAME'])) {&nbsp;</div></li><li><div>          $info['audio']['codec'] = 'LAME';&nbsp;</div></li><li><div>          if (!empty($info['mpeg']['audio']['LAME']['long_version'])) {&nbsp;</div></li><li><div>              $info['audio']['encoder'] = rtrim($info['mpeg']['audio']['LAME']['long_version'], &quot;\x00&quot;);&nbsp;</div></li><li><div>          } elseif (!empty($info['mpeg']['audio']['LAME']['short_version'])) {&nbsp;</div></li><li><div>              $info['audio']['encoder'] = rtrim($info['mpeg']['audio']['LAME']['short_version'], &quot;\x00&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $CurrentDataLAMEversionString = (!empty($CurrentDataLAMEversionString) ? $CurrentDataLAMEversionString : (isset($info['audio']['encoder']) ? $info['audio']['encoder'] : ''));&nbsp;</div></li><li><div>      if (!empty($CurrentDataLAMEversionString) && (substr($CurrentDataLAMEversionString, 0, 6) == 'LAME3.') && !preg_match('[0-9\)]', substr($CurrentDataLAMEversionString, -1))) {&nbsp;</div></li><li><div>          <span class="comment">// a version number of LAME that does not end with a number like &quot;LAME3.92&quot;</span>&nbsp;</div></li><li><div>          <span class="comment">// or with a closing parenthesis like &quot;LAME3.88 (alpha)&quot;</span>&nbsp;</div></li><li><div>          <span class="comment">// or a version of LAME with the LAMEtag-not-filled-in-DLL-mode bug (3.90-3.92)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// not sure what the actual last frame length will be, but will be less than or equal to 1441</span>&nbsp;</div></li><li><div>          $PossiblyLongerLAMEversion_FrameLength = 1441;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Not sure what version of LAME this is - look in padding of last frame for longer version string</span>&nbsp;</div></li><li><div>          $PossibleLAMEversionStringOffset = $info['avdataend'] - $PossiblyLongerLAMEversion_FrameLength;&nbsp;</div></li><li><div>          $this-&gt;fseek($PossibleLAMEversionStringOffset);&nbsp;</div></li><li><div>          $PossiblyLongerLAMEversion_Data = $this-&gt;fread($PossiblyLongerLAMEversion_FrameLength);&nbsp;</div></li><li><div>          switch (substr($CurrentDataLAMEversionString, -1)) {&nbsp;</div></li><li><div>              case 'a':&nbsp;</div></li><li><div>              case 'b':&nbsp;</div></li><li><div>                  <span class="comment">// &quot;LAME3.94a&quot; will have a longer version string of &quot;LAME3.94 (alpha)&quot; for example</span>&nbsp;</div></li><li><div>                  <span class="comment">// need to trim off &quot;a&quot; to match longer string</span>&nbsp;</div></li><li><div>                  $CurrentDataLAMEversionString = substr($CurrentDataLAMEversionString, 0, -1);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (($PossiblyLongerLAMEversion_String = strstr($PossiblyLongerLAMEversion_Data, $CurrentDataLAMEversionString)) !== false) {&nbsp;</div></li><li><div>              if (substr($PossiblyLongerLAMEversion_String, 0, strlen($CurrentDataLAMEversionString)) == $CurrentDataLAMEversionString) {&nbsp;</div></li><li><div>                  $PossiblyLongerLAMEversion_NewString = substr($PossiblyLongerLAMEversion_String, 0, strspn($PossiblyLongerLAMEversion_String, 'LAME0123456789., (abcdefghijklmnopqrstuvwxyzJFSOND)')); <span class="comment">//&quot;LAME3.90.3&quot;  &quot;LAME3.87 (beta 1, Sep 27 2000)&quot; &quot;LAME3.88 (beta)&quot;</span>&nbsp;</div></li><li><div>                  if (empty($info['audio']['encoder']) || (strlen($PossiblyLongerLAMEversion_NewString) &gt; strlen($info['audio']['encoder']))) {&nbsp;</div></li><li><div>                      $info['audio']['encoder'] = $PossiblyLongerLAMEversion_NewString;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!empty($info['audio']['encoder'])) {&nbsp;</div></li><li><div>          $info['audio']['encoder'] = rtrim($info['audio']['encoder'], &quot;\x00 &quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch (isset($info['mpeg']['audio']['layer']) ? $info['mpeg']['audio']['layer'] : '') {&nbsp;</div></li><li><div>          case 1:&nbsp;</div></li><li><div>          case 2:&nbsp;</div></li><li><div>              $info['audio']['dataformat'] = 'mp'.$info['mpeg']['audio']['layer'];&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($info['fileformat']) && ($info['fileformat'] == 'mp3')) {&nbsp;</div></li><li><div>          switch ($info['audio']['dataformat']) {&nbsp;</div></li><li><div>              case 'mp1':&nbsp;</div></li><li><div>              case 'mp2':&nbsp;</div></li><li><div>              case 'mp3':&nbsp;</div></li><li><div>                  $info['fileformat'] = $info['audio']['dataformat'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $info['warning'][] = 'Expecting [dataformat] to be mp1/mp2/mp3 when fileformat == mp3, [dataformat] actually &quot;'.$info['audio']['dataformat'].'&quot;';&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty($info['fileformat'])) {&nbsp;</div></li><li><div>          unset($info['fileformat']);&nbsp;</div></li><li><div>          unset($info['audio']['bitrate_mode']);&nbsp;</div></li><li><div>          unset($info['avdataoffset']);&nbsp;</div></li><li><div>          unset($info['avdataend']);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info['mime_type'] = 'audio/mpeg';&nbsp;</div></li><li><div>      $info['audio']['lossless'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Calculate playtime</span>&nbsp;</div></li><li><div>      if (!isset($info['playtime_seconds']) && isset($info['audio']['bitrate']) && ($info['audio']['bitrate'] &gt; 0)) {&nbsp;</div></li><li><div>          $info['playtime_seconds'] = ($info['avdataend'] - $info['avdataoffset']) * 8 / $info['audio']['bitrate'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info['audio']['encoder_options'] = $this-&gt;GuessEncoderOptions();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function GuessEncoderOptions() {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// shortcut</span></span>s</span>&nbsp;</div></li><li><div>      $info = &$this-&gt;getid3-&gt;info;&nbsp;</div></li><li><div>      if (!empty($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>          $thisfile_mpeg_audio = &$info['mpeg']['audio'];&nbsp;</div></li><li><div>          if (!empty($thisfile_mpeg_audio['LAME'])) {&nbsp;</div></li><li><div>              $thisfile_mpeg_audio_lame = &$thisfile_mpeg_audio['LAME'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $encoder_options = '';&nbsp;</div></li><li><div>      static $NamedPresetBitrates = array(16, 24, 40, 56, 112, 128, 160, 192, 256);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($thisfile_mpeg_audio['VBR_method']) && ($thisfile_mpeg_audio['VBR_method'] == 'Fraunhofer') && !empty($thisfile_mpeg_audio['VBR_quality'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $encoder_options = 'VBR q'.$thisfile_mpeg_audio['VBR_quality'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif (!empty($thisfile_mpeg_audio_lame['preset_used']) && (!in_array($thisfile_mpeg_audio_lame['preset_used_id'], $NamedPresetBitrates))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $encoder_options = $thisfile_mpeg_audio_lame['preset_used'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif (!empty($thisfile_mpeg_audio_lame['vbr_quality'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          static $KnownEncoderValues = array();&nbsp;</div></li><li><div>          if (empty($KnownEncoderValues)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//$KnownEncoderValues[abrbitrate_minbitrate][vbr_quality][raw_vbr_method][raw_noise_shaping][raw_stereo_mode][ath_type][lowpass_frequency] = 'preset name';</span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][58][1][1][3][2][20500] = '--alt-preset insane';        <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][58][1][1][3][2][20600] = '--alt-preset insane';        <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][57][1][1][3][4][20500] = '--alt-preset insane';        <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][3][2][3][2][19500] = '--alt-preset extreme';       <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][3][2][3][2][19600] = '--alt-preset extreme';       <span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.91</span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][3][1][3][2][19600] = '--alt-preset extreme';       <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][4][2][3][2][19500] = '--alt-preset fast extreme';  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][4][2][3][2][19600] = '--alt-preset fast extreme';  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][3][2][3][4][19000] = '--alt-preset standard';      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][3][1][3][4][19000] = '--alt-preset standard';      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][4][2][3][4][19000] = '--alt-preset fast standard'; <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][78][4][1][3][4][19000] = '--alt-preset fast standard'; <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][88][4][1][3][3][19500] = '--r3mix';                    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][88][4][1][3][3][19600] = '--r3mix';                    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][67][4][1][3][4][18000] = '--r3mix';                    <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][68][3][2][3][4][18000] = '--alt-preset medium';        <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues['**'][68][4][2][3][4][18000] = '--alt-preset fast medium';   <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][99][1][1][1][2][0] = '--preset studio';            <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][58][2][1][3][2][20600] = '--preset studio';            <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][58][2][1][3][2][20500] = '--preset studio';            <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.93</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xFF][57][2][1][3][4][20500] = '--preset studio';            <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xC0][88][1][1][1][2][0] = '--preset cd';                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xC0][58][2][2][3][2][19600] = '--preset cd';                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0xC0][58][2][2][3][2][19500] = '--preset cd';                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.93</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xC0][57][2][1][3][4][19500] = '--preset cd';                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xA0][78][1][1][3][2][18000] = '--preset hifi';              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0xA0][58][2][2][3][2][18000] = '--preset hifi';              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0xA0][57][2][1][3][4][18000] = '--preset hifi';              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x80][67][1][1][3][2][18000] = '--preset tape';              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x80][67][1][1][3][2][15000] = '--preset radio';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x70][67][1][1][3][2][15000] = '--preset fm';                <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.90.2, 3.91, 3.92</span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x70][58][2][2][3][2][16000] = '--preset tape/radio/fm';     <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0x70][57][2][1][3][4][16000] = '--preset tape/radio/fm';     <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x38][58][2][2][0][2][10000] = '--preset voice';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0x38][57][2][1][0][4][15000] = '--preset voice';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x38][57][2][1][0][4][16000] = '--preset voice';             <span class="comment"><span class="comment"><span class="comment">// 3.94a14</span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x28][65][1][1][0][2][7500] = '--preset mw-us';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x28][65][1][1][0][2][7600] = '--preset mw-us';             <span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.91</span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x28][58][2][2][0][2][7000] = '--preset mw-us';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0x28][57][2][1][0][4][10500] = '--preset mw-us';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x28][57][2][1][0][4][11200] = '--preset mw-us';             <span class="comment"><span class="comment"><span class="comment">// 3.94a14</span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x28][57][2][1][0][4][8800] = '--preset mw-us';             <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x18][58][2][2][0][2][4000] = '--preset phon+/lw/mw-eu/sw'; <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0x18][58][2][2][0][2][3900] = '--preset phon+/lw/mw-eu/sw'; <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.93</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x18][57][2][1][0][4][5900] = '--preset phon+/lw/mw-eu/sw'; <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x18][57][2][1][0][4][6200] = '--preset phon+/lw/mw-eu/sw'; <span class="comment"><span class="comment"><span class="comment">// 3.94a14</span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x18][57][2][1][0][4][3200] = '--preset phon+/lw/mw-eu/sw'; <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x10][58][2][2][0][2][3800] = '--preset phone';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.3</span></span></span></span></span>, 3.93.1&nbsp;</div></li><li><div>              $KnownEncoderValues[0x10][58][2][2][0][2][3700] = '--preset phone';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.93</span></span></span></span></span>&nbsp;</div></li><li><div>              $KnownEncoderValues[0x10][57][2][1][0][4][5600] = '--preset phone';             <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($KnownEncoderValues[$thisfile_mpeg_audio_lame['raw']['abrbitrate_minbitrate']][$thisfile_mpeg_audio_lame['vbr_quality']][$thisfile_mpeg_audio_lame['raw']['vbr_method']][$thisfile_mpeg_audio_lame['raw']['noise_shaping']][$thisfile_mpeg_audio_lame['raw']['stereo_mode']][$thisfile_mpeg_audio_lame['ath_type']][$thisfile_mpeg_audio_lame['lowpass_frequency']])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $encoder_options = $KnownEncoderValues[$thisfile_mpeg_audio_lame['raw']['abrbitrate_minbitrate']][$thisfile_mpeg_audio_lame['vbr_quality']][$thisfile_mpeg_audio_lame['raw']['vbr_method']][$thisfile_mpeg_audio_lame['raw']['noise_shaping']][$thisfile_mpeg_audio_lame['raw']['stereo_mode']][$thisfile_mpeg_audio_lame['ath_type']][$thisfile_mpeg_audio_lame['lowpass_frequency']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } elseif (isset($KnownEncoderValues['**'][$thisfile_mpeg_audio_lame['vbr_quality']][$thisfile_mpeg_audio_lame['raw']['vbr_method']][$thisfile_mpeg_audio_lame['raw']['noise_shaping']][$thisfile_mpeg_audio_lame['raw']['stereo_mode']][$thisfile_mpeg_audio_lame['ath_type']][$thisfile_mpeg_audio_lame['lowpass_frequency']])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $encoder_options = $KnownEncoderValues['**'][$thisfile_mpeg_audio_lame['vbr_quality']][$thisfile_mpeg_audio_lame['raw']['vbr_method']][$thisfile_mpeg_audio_lame['raw']['noise_shaping']][$thisfile_mpeg_audio_lame['raw']['stereo_mode']][$thisfile_mpeg_audio_lame['ath_type']][$thisfile_mpeg_audio_lame['lowpass_frequency']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } elseif ($info['audio']['bitrate_mode'] == 'vbr') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// http://gabriel.mp3-tech.org/mp3infotag.html</span></span>&nbsp;</div></li><li><div>              <span class="comment">// int    Quality = (100 - 10 * gfp-&gt;VBR_q - gfp-&gt;quality)h</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $LAME_V_value = 10 - ceil($thisfile_mpeg_audio_lame['vbr_quality'] / 10);&nbsp;</div></li><li><div>              $LAME_q_value = 100 - $thisfile_mpeg_audio_lame['vbr_quality'] - ($LAME_V_value * 10);&nbsp;</div></li><li><div>              $encoder_options = '-V'.$LAME_V_value.' -q'.$LAME_q_value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } elseif ($info['audio']['bitrate_mode'] == 'cbr') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $encoder_options = strtoupper($info['audio']['bitrate_mode']).ceil($info['audio']['bitrate'] / 1000);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $encoder_options = strtoupper($info['audio']['bitrate_mode']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif (!empty($thisfile_mpeg_audio_lame['bitrate_abr'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $encoder_options = 'ABR'.$thisfile_mpeg_audio_lame['bitrate_abr'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif (!empty($info['audio']['bitrate'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($info['audio']['bitrate_mode'] == 'cbr') {&nbsp;</div></li><li><div>              $encoder_options = strtoupper($info['audio']['bitrate_mode']).ceil($info['audio']['bitrate'] / 1000);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $encoder_options = strtoupper($info['audio']['bitrate_mode']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!empty($thisfile_mpeg_audio_lame['bitrate_min'])) {&nbsp;</div></li><li><div>          $encoder_options .= ' -b'.$thisfile_mpeg_audio_lame['bitrate_min'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($thisfile_mpeg_audio_lame['encoding_flags']['nogap_prev']) || !empty($thisfile_mpeg_audio_lame['encoding_flags']['nogap_next'])) {&nbsp;</div></li><li><div>          $encoder_options .= ' --nogap';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($thisfile_mpeg_audio_lame['lowpass_frequency'])) {&nbsp;</div></li><li><div>          $ExplodedOptions = explode(' ', $encoder_options, 4);&nbsp;</div></li><li><div>          if ($ExplodedOptions[0] == '--r3mix') {&nbsp;</div></li><li><div>              $ExplodedOptions[1] = 'r3mix';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          switch ($ExplodedOptions[0]) {&nbsp;</div></li><li><div>              case '--preset':&nbsp;</div></li><li><div>              case '--alt-preset':&nbsp;</div></li><li><div>              case '--r3mix':&nbsp;</div></li><li><div>                  if ($ExplodedOptions[1] == 'fast') {&nbsp;</div></li><li><div>                      $ExplodedOptions[1] .= ' '.$ExplodedOptions[2];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  switch ($ExplodedOptions[1]) {&nbsp;</div></li><li><div>                      case 'portable':&nbsp;</div></li><li><div>                      case 'medium':&nbsp;</div></li><li><div>                      case 'standard':&nbsp;</div></li><li><div>                      case 'extreme':&nbsp;</div></li><li><div>                      case 'insane':&nbsp;</div></li><li><div>                      case 'fast portable':&nbsp;</div></li><li><div>                      case 'fast medium':&nbsp;</div></li><li><div>                      case 'fast standard':&nbsp;</div></li><li><div>                      case 'fast extreme':&nbsp;</div></li><li><div>                      case 'fast insane':&nbsp;</div></li><li><div>                      case 'r3mix':&nbsp;</div></li><li><div>                          static $ExpectedLowpass = array(&nbsp;</div></li><li><div>                                  'insane|20500' =&gt; 20500, &nbsp;</div></li><li><div>                                  'insane|20600' =&gt; 20600, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>&nbsp;</div></li><li><div>                                  'medium|18000' =&gt; 18000, &nbsp;</div></li><li><div>                                  'fast medium|18000' =&gt; 18000, &nbsp;</div></li><li><div>                                  'extreme|19500' =&gt; 19500, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>, 3.95&nbsp;</div></li><li><div>                                  'extreme|19600' =&gt; 19600, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>, 3.93.1&nbsp;</div></li><li><div>                                  'fast extreme|19500' =&gt; 19500, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>, 3.95&nbsp;</div></li><li><div>                                  'fast extreme|19600' =&gt; 19600, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>, 3.93.1&nbsp;</div></li><li><div>                                  'standard|19000' =&gt; 19000, &nbsp;</div></li><li><div>                                  'fast standard|19000' =&gt; 19000, &nbsp;</div></li><li><div>                                  'r3mix|19500' =&gt; 19500, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>, 3.90.1, 3.92</span></span></span></span></span></span>&nbsp;</div></li><li><div>                                  'r3mix|19600' =&gt; 19600, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.90</span>.2, 3.90.3, 3.91</span></span></span></span></span>&nbsp;</div></li><li><div>                                  'r3mix|18000' =&gt; 18000, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94, 3.95</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                          if (!isset($ExpectedLowpass[$ExplodedOptions[1].'|'.$thisfile_mpeg_audio_lame['lowpass_frequency']]) && ($thisfile_mpeg_audio_lame['lowpass_frequency'] &lt; 22050) && (round($thisfile_mpeg_audio_lame['lowpass_frequency'] / 1000) &lt; round($thisfile_mpeg_audio['sample_rate'] / 2000))) {&nbsp;</div></li><li><div>                              $encoder_options .= ' --lowpass '.$thisfile_mpeg_audio_lame['lowpass_frequency'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      default:&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($thisfile_mpeg_audio_lame['raw']['source_sample_freq'])) {&nbsp;</div></li><li><div>          if (($thisfile_mpeg_audio['sample_rate'] == 44100) && ($thisfile_mpeg_audio_lame['raw']['source_sample_freq'] != 1)) {&nbsp;</div></li><li><div>              $encoder_options .= ' --resample 44100';&nbsp;</div></li><li><div>          } elseif (($thisfile_mpeg_audio['sample_rate'] == 48000) && ($thisfile_mpeg_audio_lame['raw']['source_sample_freq'] != 2)) {&nbsp;</div></li><li><div>              $encoder_options .= ' --resample 48000';&nbsp;</div></li><li><div>          } elseif ($thisfile_mpeg_audio['sample_rate'] &lt; 44100) {&nbsp;</div></li><li><div>              switch ($thisfile_mpeg_audio_lame['raw']['source_sample_freq']) {&nbsp;</div></li><li><div>                  case 0: <span class="comment">// &lt;= 32000</span>&nbsp;</div></li><li><div>                      <span class="comment">// may or may not be same as source frequency - ignore</span>&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 1: <span class="comment">// 44100</span>&nbsp;</div></li><li><div>                  case 2: <span class="comment">// 48000</span>&nbsp;</div></li><li><div>                  case 3: <span class="comment">// 48000</span>+&nbsp;</div></li><li><div>                      $ExplodedOptions = explode(' ', $encoder_options, 4);&nbsp;</div></li><li><div>                      switch ($ExplodedOptions[0]) {&nbsp;</div></li><li><div>                          case '--preset':&nbsp;</div></li><li><div>                          case '--alt-preset':&nbsp;</div></li><li><div>                              switch ($ExplodedOptions[1]) {&nbsp;</div></li><li><div>                                  case 'fast':&nbsp;</div></li><li><div>                                  case 'portable':&nbsp;</div></li><li><div>                                  case 'medium':&nbsp;</div></li><li><div>                                  case 'standard':&nbsp;</div></li><li><div>                                  case 'extreme':&nbsp;</div></li><li><div>                                  case 'insane':&nbsp;</div></li><li><div>                                      $encoder_options .= ' --resample '.$thisfile_mpeg_audio['sample_rate'];&nbsp;</div></li><li><div>                                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  default:&nbsp;</div></li><li><div>                                      static $ExpectedResampledRate = array(&nbsp;</div></li><li><div>                                              'phon+/lw/mw-eu/sw|16000' =&gt; 16000, &nbsp;</div></li><li><div>                                              'mw-us|24000' =&gt; 24000, <span class="comment">// 3.95</span>&nbsp;</div></li><li><div>                                              'mw-us|32000' =&gt; 32000, <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.93</span></span></span></span></span>&nbsp;</div></li><li><div>                                              'mw-us|16000' =&gt; 16000, <span class="comment"><span class="comment">// 3.92</span></span>&nbsp;</div></li><li><div>                                              'phone|16000' =&gt; 16000, &nbsp;</div></li><li><div>                                              'phone|11025' =&gt; 11025, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span>&nbsp;</div></li><li><div>                                              'radio|32000' =&gt; 32000, <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span>&nbsp;</div></li><li><div>                                              'fm/radio|32000' =&gt; 32000, <span class="comment"><span class="comment">// 3.92</span></span>&nbsp;</div></li><li><div>                                              'fm|32000' =&gt; 32000, <span class="comment">// 3.90</span>&nbsp;</div></li><li><div>                                              'voice|32000' =&gt; 32000);&nbsp;</div></li><li><div>                                      if (!isset($ExpectedResampledRate[$ExplodedOptions[1].'|'.$thisfile_mpeg_audio['sample_rate']])) {&nbsp;</div></li><li><div>                                          $encoder_options .= ' --resample '.$thisfile_mpeg_audio['sample_rate'];&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>                                      break;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          case '--r3mix':&nbsp;</div></li><li><div>                          default:&nbsp;</div></li><li><div>                              $encoder_options .= ' --resample '.$thisfile_mpeg_audio['sample_rate'];&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (empty($encoder_options) && !empty($info['audio']['bitrate']) && !empty($info['audio']['bitrate_mode'])) {&nbsp;</div></li><li><div>          <span class="comment">//$encoder_options = strtoupper($info['audio']['bitrate_mode']).ceil($info['audio']['bitrate'] / 1000);</span>&nbsp;</div></li><li><div>          $encoder_options = strtoupper($info['audio']['bitrate_mode']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $encoder_options;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function decodeMPEGaudioHeader($offset, &$info, $recursivesearch=true, $ScanAsCBR=false, $FastMPEGheaderScan=false) {&nbsp;</div></li><li><div>      static $MPEGaudioVersionLookup;&nbsp;</div></li><li><div>      static $MPEGaudioLayerLookup;&nbsp;</div></li><li><div>      static $MPEGaudioBitrateLookup;&nbsp;</div></li><li><div>      static $MPEGaudioFrequencyLookup;&nbsp;</div></li><li><div>      static $MPEGaudioChannelModeLookup;&nbsp;</div></li><li><div>      static $MPEGaudioModeExtensionLookup;&nbsp;</div></li><li><div>      static $MPEGaudioEmphasisLookup;&nbsp;</div></li><li><div>      if (empty($MPEGaudioVersionLookup)) {&nbsp;</div></li><li><div>          $MPEGaudioVersionLookup = self::MPEGaudioVersionArray();&nbsp;</div></li><li><div>          $MPEGaudioLayerLookup = self::MPEGaudioLayerArray();&nbsp;</div></li><li><div>          $MPEGaudioBitrateLookup = self::MPEGaudioBitrateArray();&nbsp;</div></li><li><div>          $MPEGaudioFrequencyLookup = self::MPEGaudioFrequencyArray();&nbsp;</div></li><li><div>          $MPEGaudioChannelModeLookup = self::MPEGaudioChannelModeArray();&nbsp;</div></li><li><div>          $MPEGaudioModeExtensionLookup = self::MPEGaudioModeExtensionArray();&nbsp;</div></li><li><div>          $MPEGaudioEmphasisLookup = self::MPEGaudioEmphasisArray();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;fseek($offset) != 0) {&nbsp;</div></li><li><div>          $info['error'][] = 'decodeMPEGaudioHeader() failed to seek to next offset at '.$offset;&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//$headerstring = $this-&gt;fread(1441); // worst-case max length = 32kHz @ 320kbps layer 3 = 1441 bytes/frame</span>&nbsp;</div></li><li><div>      $headerstring = $this-&gt;fread(226); <span class="comment">// LAME header at offset 36 + 190 bytes of Xing/LAME data</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// MP3 audio frame structure:</span>&nbsp;</div></li><li><div>      <span class="comment">// $aa $aa $aa $aa [$bb $bb] $cc...</span>&nbsp;</div></li><li><div>      <span class="comment">// where $aa..$aa is the four-byte mpeg-audio header (below)</span>&nbsp;</div></li><li><div>      <span class="comment">// $bb $bb is the optional 2-byte CRC</span>&nbsp;</div></li><li><div>      <span class="comment">// and $cc... is the audio data</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $head4 = substr($headerstring, 0, 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      static $MPEGaudioHeaderDecodeCache = array();&nbsp;</div></li><li><div>      if (isset($MPEGaudioHeaderDecodeCache[$head4])) {&nbsp;</div></li><li><div>          $MPEGheaderRawArray = $MPEGaudioHeaderDecodeCache[$head4];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $MPEGheaderRawArray = self::MPEGaudioHeaderDecode($head4);&nbsp;</div></li><li><div>          $MPEGaudioHeaderDecodeCache[$head4] = $MPEGheaderRawArray;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      static $MPEGaudioHeaderValidCache = array();&nbsp;</div></li><li><div>      if (!isset($MPEGaudioHeaderValidCache[$head4])) { <span class="comment">// Not in cache</span>&nbsp;</div></li><li><div>          <span class="comment">//$MPEGaudioHeaderValidCache[$head4] = self::MPEGaudioHeaderValid($MPEGheaderRawArray, false, true);  // allow badly-formatted freeformat (from LAME 3.90 - 3.93.1)</span>&nbsp;</div></li><li><div>          $MPEGaudioHeaderValidCache[$head4] = self::MPEGaudioHeaderValid($MPEGheaderRawArray, false, false);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// shortcut</span></span>&nbsp;</div></li><li><div>      if (!isset($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>          $info['mpeg']['audio'] = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $thisfile_mpeg_audio = &$info['mpeg']['audio'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($MPEGaudioHeaderValidCache[$head4]) {&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['raw'] = $MPEGheaderRawArray;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $info['error'][] = 'Invalid MPEG audio header ('.getid3_lib::PrintHexBytes($head4).') at offset '.$offset;&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$FastMPEGheaderScan) {&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['version'] = $MPEGaudioVersionLookup[$thisfile_mpeg_audio['raw']['version']];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['layer'] = $MPEGaudioLayerLookup[$thisfile_mpeg_audio['raw']['layer']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['channelmode'] = $MPEGaudioChannelModeLookup[$thisfile_mpeg_audio['raw']['channelmode']];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['channels'] = (($thisfile_mpeg_audio['channelmode'] == 'mono') ? 1 : 2);&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['sample_rate'] = $MPEGaudioFrequencyLookup[$thisfile_mpeg_audio['version']][$thisfile_mpeg_audio['raw']['sample_rate']];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['protection'] = !$thisfile_mpeg_audio['raw']['protection'];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['private'] = (bool) $thisfile_mpeg_audio['raw']['private'];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['modeextension'] = $MPEGaudioModeExtensionLookup[$thisfile_mpeg_audio['layer']][$thisfile_mpeg_audio['raw']['modeextension']];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['copyright'] = (bool) $thisfile_mpeg_audio['raw']['copyright'];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['original'] = (bool) $thisfile_mpeg_audio['raw']['original'];&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['emphasis'] = $MPEGaudioEmphasisLookup[$thisfile_mpeg_audio['raw']['emphasis']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $info['audio']['channels'] = $thisfile_mpeg_audio['channels'];&nbsp;</div></li><li><div>          $info['audio']['sample_rate'] = $thisfile_mpeg_audio['sample_rate'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($thisfile_mpeg_audio['protection']) {&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['crc'] = getid3_lib::BigEndian2Int(substr($headerstring, 4, 2));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($thisfile_mpeg_audio['raw']['bitrate'] == 15) {&nbsp;</div></li><li><div>          <span class="comment">// http://www.hydrogenaudio.org/?act=ST&f=16&t=9682&st=0</span>&nbsp;</div></li><li><div>          $info['warning'][] = 'Invalid bitrate index (15), this is a known bug in free-format MP3s encoded by LAME v3.90 - 3.93.1';&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['raw']['bitrate'] = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $thisfile_mpeg_audio['padding'] = (bool) $thisfile_mpeg_audio['raw']['padding'];&nbsp;</div></li><li><div>      $thisfile_mpeg_audio['bitrate'] = $MPEGaudioBitrateLookup[$thisfile_mpeg_audio['version']][$thisfile_mpeg_audio['layer']][$thisfile_mpeg_audio['raw']['bitrate']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (($thisfile_mpeg_audio['bitrate'] == 'free') && ($offset == $info['avdataoffset'])) {&nbsp;</div></li><li><div>          <span class="comment">// only skip multiple frame check if free-format bitstream found at beginning of file</span>&nbsp;</div></li><li><div>          <span class="comment">// otherwise is quite possibly simply corrupted data</span>&nbsp;</div></li><li><div>          $recursivesearch = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For Layer 2 there are some combinations of bitrate and mode which are not allowed.</span>&nbsp;</div></li><li><div>      if (!$FastMPEGheaderScan && ($thisfile_mpeg_audio['layer'] == '2')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $info['audio']['dataformat'] = 'mp2';&nbsp;</div></li><li><div>          switch ($thisfile_mpeg_audio['channelmode']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'mono':&nbsp;</div></li><li><div>                  if (($thisfile_mpeg_audio['bitrate'] == 'free') || ($thisfile_mpeg_audio['bitrate'] &lt;= 192000)) {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// these are ok</span></span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $info['error'][] = $thisfile_mpeg_audio['bitrate'].'kbps not allowed in Layer 2, '.$thisfile_mpeg_audio['channelmode'].'.';&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'stereo':&nbsp;</div></li><li><div>              case 'joint stereo':&nbsp;</div></li><li><div>              case 'dual channel':&nbsp;</div></li><li><div>                  if (($thisfile_mpeg_audio['bitrate'] == 'free') || ($thisfile_mpeg_audio['bitrate'] == 64000) || ($thisfile_mpeg_audio['bitrate'] &gt;= 96000)) {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// these are ok</span></span>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $info['error'][] = intval(round($thisfile_mpeg_audio['bitrate'] / 1000)).'kbps not allowed in Layer 2, '.$thisfile_mpeg_audio['channelmode'].'.';&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($info['audio']['sample_rate'] &gt; 0) {&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['framelength'] = self::MPEGaudioFrameLength($thisfile_mpeg_audio['bitrate'], $thisfile_mpeg_audio['version'], $thisfile_mpeg_audio['layer'], (int) $thisfile_mpeg_audio['padding'], $info['audio']['sample_rate']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $nextframetestoffset = $offset + 1;&nbsp;</div></li><li><div>      if ($thisfile_mpeg_audio['bitrate'] != 'free') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $info['audio']['bitrate'] = $thisfile_mpeg_audio['bitrate'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($thisfile_mpeg_audio['framelength'])) {&nbsp;</div></li><li><div>              $nextframetestoffset = $offset + $thisfile_mpeg_audio['framelength'];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $info['error'][] = 'Frame at offset('.$offset.') is has an invalid frame length.';&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ExpectedNumberOfAudioBytes = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">/////////////////////////////////////////////////////////////////</span></span></span></span>///////////////////&nbsp;</div></li><li><div>      <span class="comment">// Variable-bitrate headers</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (substr($headerstring, 4 + 32, 4) == 'VBRI') {&nbsp;</div></li><li><div>          <span class="comment">// Fraunhofer VBR header is hardcoded 'VBRI' at offset 0x24 (36)</span>&nbsp;</div></li><li><div>          <span class="comment">// specs taken from http://minnie.tuhs.org/pipermail/mp3encoder/2001-January/001800.html</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['bitrate_mode'] = 'vbr';&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_method'] = 'Fraunhofer';&nbsp;</div></li><li><div>          $info['audio']['codec'] = 'Fraunhofer';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $SideInfoData = substr($headerstring, 4 + 2, 32);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $FraunhoferVBROffset = 36;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_encoder_version'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset +  4, 2)); <span class="comment">// VbriVersion</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_encoder_delay'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset +  6, 2)); <span class="comment">// VbriDelay</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_quality'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset +  8, 2)); <span class="comment">// VbriQuality</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_bytes'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset + 10, 4)); <span class="comment">// VbriStreamBytes</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_frames'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset + 14, 4)); <span class="comment">// VbriStreamFrames</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_seek_offsets'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset + 18, 2)); <span class="comment">// VbriTableSize</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_seek_scale'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset + 20, 2)); <span class="comment">// VbriTableScale</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_entry_bytes'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset + 22, 2)); <span class="comment">// VbriEntryBytes</span>&nbsp;</div></li><li><div>          $thisfile_mpeg_audio['VBR_entry_frames'] = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset + 24, 2)); <span class="comment">// VbriEntryFrames</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ExpectedNumberOfAudioBytes = $thisfile_mpeg_audio['VBR_bytes'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $previousbyteoffset = $offset;&nbsp;</div></li><li><div>          for ($i = 0; $i &lt; $thisfile_mpeg_audio['VBR_seek_offsets']; $i++) {&nbsp;</div></li><li><div>              $Fraunhofer_OffsetN = getid3_lib::BigEndian2Int(substr($headerstring, $FraunhoferVBROffset, $thisfile_mpeg_audio['VBR_entry_bytes']));&nbsp;</div></li><li><div>              $FraunhoferVBROffset += $thisfile_mpeg_audio['VBR_entry_bytes'];&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['VBR_offsets_relative'][$i] = ($Fraunhofer_OffsetN * $thisfile_mpeg_audio['VBR_seek_scale']);&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['VBR_offsets_absolute'][$i] = ($Fraunhofer_OffsetN * $thisfile_mpeg_audio['VBR_seek_scale']) + $previousbyteoffset;&nbsp;</div></li><li><div>              $previousbyteoffset += $Fraunhofer_OffsetN;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Xing VBR header is hardcoded 'Xing' at a offset 0x0D (13), 0x15 (21) or 0x24 (36)</span>&nbsp;</div></li><li><div>          <span class="comment">// depending on MPEG layer and number of channels</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $VBRidOffset = self::XingVBRidOffset($thisfile_mpeg_audio['version'], $thisfile_mpeg_audio['channelmode']);&nbsp;</div></li><li><div>          $SideInfoData = substr($headerstring, 4 + 2, $VBRidOffset - 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ((substr($headerstring, $VBRidOffset, strlen('Xing')) == 'Xing') || (substr($headerstring, $VBRidOffset, strlen('Info')) == 'Info')) {&nbsp;</div></li><li><div>              <span class="comment">// 'Xing' is traditional Xing VBR frame</span>&nbsp;</div></li><li><div>              <span class="comment">// 'Info' is LAME-encoded CBR (This was done to avoid CBR files to be recognized as traditional Xing VBR files by some decoders.)</span>&nbsp;</div></li><li><div>              <span class="comment">// 'Info' *can* legally be used to specify a VBR file as well, however.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// http://www.multiweb.cz/twoinches/MP3inside.htm</span>&nbsp;</div></li><li><div>              <span class="comment">//00..03 = &quot;Xing&quot; or &quot;Info&quot;</span>&nbsp;</div></li><li><div>              <span class="comment">//04..07 = Flags:</span>&nbsp;</div></li><li><div>              <span class="comment">//  0x01  Frames Flag     set if value for number of frames in file is stored</span>&nbsp;</div></li><li><div>              <span class="comment">//  0x02  Bytes Flag      set if value for filesize in bytes is stored</span>&nbsp;</div></li><li><div>              <span class="comment">//  0x04  TOC Flag        set if values for TOC are stored</span>&nbsp;</div></li><li><div>              <span class="comment">//  0x08  VBR Scale Flag  set if values for VBR scale is stored</span>&nbsp;</div></li><li><div>              <span class="comment">//08..11  Frames: Number of frames in file (including the first Xing/Info one)</span>&nbsp;</div></li><li><div>              <span class="comment">//12..15  Bytes:  File length in Bytes</span>&nbsp;</div></li><li><div>              <span class="comment">//16..115  TOC (Table of Contents):</span>&nbsp;</div></li><li><div>              <span class="comment">//  Contains of 100 indexes (one Byte length) for easier lookup in file. Approximately solves problem with moving inside file.</span>&nbsp;</div></li><li><div>              <span class="comment">//  Each Byte has a value according this formula:</span>&nbsp;</div></li><li><div>              <span class="comment">//  (TOC[i] / 256) * fileLenInBytes</span>&nbsp;</div></li><li><div>              <span class="comment">//  So if song lasts eg. 240 sec. and you want to jump to 60. sec. (and file is 5 000 000 Bytes length) you can use:</span>&nbsp;</div></li><li><div>              <span class="comment">//  TOC[(60/240)*100] = TOC[25]</span>&nbsp;</div></li><li><div>              <span class="comment">//  and corresponding Byte in file is then approximately at:</span>&nbsp;</div></li><li><div>              <span class="comment">//  (TOC[25]/256) * 5000000</span>&nbsp;</div></li><li><div>              <span class="comment">//116..119  VBR Scale</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// should be safe to leave this at 'vbr' and let it be overriden to 'cbr' if a CBR preset/mode is used by LAME</span>&nbsp;</div></li><li><div><span class="comment">//                if (substr($headerstring, $VBRidOffset, strlen('Info')) == 'Xing') {</span>&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['bitrate_mode'] = 'vbr';&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['VBR_method'] = 'Xing';&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span> else {</span>&nbsp;</div></li><li><div><span class="comment">//                    $ScanAsCBR = true;</span>&nbsp;</div></li><li><div><span class="comment">//                    $thisfile_mpeg_audio['bitrate_mode'] = 'cbr';</span>&nbsp;</div></li><li><div><span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['xing_flags_raw'] = getid3_lib::BigEndian2Int(substr($headerstring, $VBRidOffset + 4, 4));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['xing_flags']['frames'] = (bool) ($thisfile_mpeg_audio['xing_flags_raw'] & 0x00000001);&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['xing_flags']['bytes'] = (bool) ($thisfile_mpeg_audio['xing_flags_raw'] & 0x00000002);&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['xing_flags']['toc'] = (bool) ($thisfile_mpeg_audio['xing_flags_raw'] & 0x00000004);&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['xing_flags']['vbr_scale'] = (bool) ($thisfile_mpeg_audio['xing_flags_raw'] & 0x00000008);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($thisfile_mpeg_audio['xing_flags']['frames']) {&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['VBR_frames'] = getid3_lib::BigEndian2Int(substr($headerstring, $VBRidOffset +  8, 4));&nbsp;</div></li><li><div>                  <span class="comment">//$thisfile_mpeg_audio['VBR_frames']--; // don't count header Xing/Info frame</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($thisfile_mpeg_audio['xing_flags']['bytes']) {&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['VBR_bytes'] = getid3_lib::BigEndian2Int(substr($headerstring, $VBRidOffset + 12, 4));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//if (($thisfile_mpeg_audio['bitrate'] == 'free') && !empty($thisfile_mpeg_audio['VBR_frames']) && !empty($thisfile_mpeg_audio['VBR_bytes'])) {</span>&nbsp;</div></li><li><div>              if (!empty($thisfile_mpeg_audio['VBR_frames']) && !empty($thisfile_mpeg_audio['VBR_bytes'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $framelengthfloat = $thisfile_mpeg_audio['VBR_bytes'] / $thisfile_mpeg_audio['VBR_frames'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($thisfile_mpeg_audio['layer'] == '1') {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// BitRate = (((FrameLengthInBytes / 4) - Padding) * SampleRate) / 12</span></span>&nbsp;</div></li><li><div>                      <span class="comment">//$info['audio']['bitrate'] = ((($framelengthfloat / 4) - intval($thisfile_mpeg_audio['padding'])) * $thisfile_mpeg_audio['sample_rate']) / 12;</span>&nbsp;</div></li><li><div>                      $info['audio']['bitrate'] = ($framelengthfloat / 4) * $thisfile_mpeg_audio['sample_rate'] * (2 / $info['audio']['channels']) / 12;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Bitrate = ((FrameLengthInBytes - Padding) * SampleRate) / 144</span></span>&nbsp;</div></li><li><div>                      <span class="comment">//$info['audio']['bitrate'] = (($framelengthfloat - intval($thisfile_mpeg_audio['padding'])) * $thisfile_mpeg_audio['sample_rate']) / 144;</span>&nbsp;</div></li><li><div>                      $info['audio']['bitrate'] = $framelengthfloat * $thisfile_mpeg_audio['sample_rate'] * (2 / $info['audio']['channels']) / 144;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['framelength'] = floor($framelengthfloat);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($thisfile_mpeg_audio['xing_flags']['toc']) {&nbsp;</div></li><li><div>                  $LAMEtocData = substr($headerstring, $VBRidOffset + 16, 100);&nbsp;</div></li><li><div>                  for ($i = 0; $i &lt; 100; $i++) {&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio['toc'][$i] = ord($LAMEtocData{$i});&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($thisfile_mpeg_audio['xing_flags']['vbr_scale']) {&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['VBR_scale'] = getid3_lib::BigEndian2Int(substr($headerstring, $VBRidOffset + 116, 4));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// http://gabriel.mp3-tech.org/mp3infotag.html</span></span>&nbsp;</div></li><li><div>              if (substr($headerstring, $VBRidOffset + 120, 4) == 'LAME') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// shortcut</span></span>&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['LAME'] = array();&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio_lame = &$thisfile_mpeg_audio['LAME'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio_lame['long_version'] = substr($headerstring, $VBRidOffset + 120, 20);&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio_lame['short_version'] = substr($thisfile_mpeg_audio_lame['long_version'], 0, 9);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($thisfile_mpeg_audio_lame['short_version'] &gt;= 'LAME3.90') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// extra 11 chars are not part of version string when LAMEtag present</span>&nbsp;</div></li><li><div>                      unset($thisfile_mpeg_audio_lame['long_version']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// It the LAME tag was only introduced in LAME v3.90</span>&nbsp;</div></li><li><div>                      <span class="comment">// http://www.hydrogenaudio.org/?act=ST&f=15&t=9933</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Offsets of various bytes in http://gabriel.mp3-tech.org/mp3infotag.html</span>&nbsp;</div></li><li><div>                      <span class="comment">// are assuming a 'Xing' identifier offset of 0x24, which is the case for</span>&nbsp;</div></li><li><div>                      <span class="comment">// MPEG-1 non-mono, but not for other combinations</span>&nbsp;</div></li><li><div>                      $LAMEtagOffsetContant = $VBRidOffset - 0x24;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">// shortcut</span></span>s</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['RGAD'] = array('track'=&gt;array(), 'album'=&gt;array());&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_RGAD = &$thisfile_mpeg_audio_lame['RGAD'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_RGAD_track = &$thisfile_mpeg_audio_lame_RGAD['track'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_RGAD_album = &$thisfile_mpeg_audio_lame_RGAD['album'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['raw'] = array();&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw = &$thisfile_mpeg_audio_lame['raw'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $9B  VBR Quality</span>&nbsp;</div></li><li><div>                      <span class="comment">// This field is there to indicate a quality level, although the scale was not precised in the original Xing specifications.</span>&nbsp;</div></li><li><div>                      <span class="comment">// Actually overwrites original Xing bytes</span>&nbsp;</div></li><li><div>                      unset($thisfile_mpeg_audio['VBR_scale']);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['vbr_quality'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0x9B, 1));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $9C-$A4  Encoder short VersionString</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['short_version'] = substr($headerstring, $LAMEtagOffsetContant + 0x9C, 9);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $A5  Info Tag revision + VBR method</span>&nbsp;</div></li><li><div>                      $LAMEtagRevisionVBRmethod = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xA5, 1));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['tag_revision'] = ($LAMEtagRevisionVBRmethod & 0xF0) &gt;&gt; 4;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['vbr_method'] =  $LAMEtagRevisionVBRmethod & 0x0F;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['vbr_method'] = self::LAMEvbrMethodLookup($thisfile_mpeg_audio_lame_raw['vbr_method']);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio['bitrate_mode'] = substr($thisfile_mpeg_audio_lame['vbr_method'], 0, 3); <span class="comment">// usually either 'cbr' or 'vbr', but truncates 'vbr-old / vbr-rh' to 'vbr'</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $A6  Lowpass filter value</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['lowpass_frequency'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xA6, 1)) * 100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $A7-$AE  Replay Gain</span>&nbsp;</div></li><li><div>                      <span class="comment">// http://privatewww.essex.ac.uk/~djmrob/replaygain/rg_data_format.html</span>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $A7-$AA : 32 bit floating point &quot;Peak signal amplitude&quot;</span>&nbsp;</div></li><li><div>                      if ($thisfile_mpeg_audio_lame['short_version'] &gt;= 'LAME3.94b') {&nbsp;</div></li><li><div>                          <span class="comment">// LAME 3.94a16 and later - 9.23 fixed point</span>&nbsp;</div></li><li><div>                          <span class="comment">// ie 0x0059E2EE / (2^23) = 5890798 / 8388608 = 0.7022378444671630859375</span>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD['peak_amplitude'] = (float) ((getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xA7, 4))) / 8388608);&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          <span class="comment">// LAME 3.94a15 and earlier - 32-bit floating point</span>&nbsp;</div></li><li><div>                          <span class="comment">// Actually 3.94a16 will fall in here too and be WRONG, but is hard to detect 3.94a16 vs 3.94a15</span>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD['peak_amplitude'] = getid3_lib::LittleEndian2Float(substr($headerstring, $LAMEtagOffsetContant + 0xA7, 4));&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($thisfile_mpeg_audio_lame_RGAD['peak_amplitude'] == 0) {&nbsp;</div></li><li><div>                          unset($thisfile_mpeg_audio_lame_RGAD['peak_amplitude']);&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD['peak_db'] = getid3_lib::RGADamplitude2dB($thisfile_mpeg_audio_lame_RGAD['peak_amplitude']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['RGAD_track'] =   getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xAB, 2));&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['RGAD_album'] =   getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xAD, 2));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($thisfile_mpeg_audio_lame_raw['RGAD_track'] != 0) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['raw']['name'] = ($thisfile_mpeg_audio_lame_raw['RGAD_track'] & 0xE000) &gt;&gt; 13;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['raw']['originator'] = ($thisfile_mpeg_audio_lame_raw['RGAD_track'] & 0x1C00) &gt;&gt; 10;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['raw']['sign_bit'] = ($thisfile_mpeg_audio_lame_raw['RGAD_track'] & 0x0200) &gt;&gt; 9;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['raw']['gain_adjust'] =  $thisfile_mpeg_audio_lame_raw['RGAD_track'] & 0x01FF;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['name'] = getid3_lib::RGADnameLookup($thisfile_mpeg_audio_lame_RGAD_track['raw']['name']);&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['originator'] = getid3_lib::RGADoriginatorLookup($thisfile_mpeg_audio_lame_RGAD_track['raw']['originator']);&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_track['gain_db'] = getid3_lib::RGADadjustmentLookup($thisfile_mpeg_audio_lame_RGAD_track['raw']['gain_adjust'], $thisfile_mpeg_audio_lame_RGAD_track['raw']['sign_bit']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if (!empty($thisfile_mpeg_audio_lame_RGAD['peak_amplitude'])) {&nbsp;</div></li><li><div>                              $info['replay_gain']['track']['peak'] = $thisfile_mpeg_audio_lame_RGAD['peak_amplitude'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $info['replay_gain']['track']['originator'] = $thisfile_mpeg_audio_lame_RGAD_track['originator'];&nbsp;</div></li><li><div>                          $info['replay_gain']['track']['adjustment'] = $thisfile_mpeg_audio_lame_RGAD_track['gain_db'];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          unset($thisfile_mpeg_audio_lame_RGAD['track']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($thisfile_mpeg_audio_lame_raw['RGAD_album'] != 0) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['raw']['name'] = ($thisfile_mpeg_audio_lame_raw['RGAD_album'] & 0xE000) &gt;&gt; 13;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['raw']['originator'] = ($thisfile_mpeg_audio_lame_raw['RGAD_album'] & 0x1C00) &gt;&gt; 10;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['raw']['sign_bit'] = ($thisfile_mpeg_audio_lame_raw['RGAD_album'] & 0x0200) &gt;&gt; 9;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['raw']['gain_adjust'] = $thisfile_mpeg_audio_lame_raw['RGAD_album'] & 0x01FF;&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['name'] = getid3_lib::RGADnameLookup($thisfile_mpeg_audio_lame_RGAD_album['raw']['name']);&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['originator'] = getid3_lib::RGADoriginatorLookup($thisfile_mpeg_audio_lame_RGAD_album['raw']['originator']);&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame_RGAD_album['gain_db'] = getid3_lib::RGADadjustmentLookup($thisfile_mpeg_audio_lame_RGAD_album['raw']['gain_adjust'], $thisfile_mpeg_audio_lame_RGAD_album['raw']['sign_bit']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if (!empty($thisfile_mpeg_audio_lame_RGAD['peak_amplitude'])) {&nbsp;</div></li><li><div>                              $info['replay_gain']['album']['peak'] = $thisfile_mpeg_audio_lame_RGAD['peak_amplitude'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $info['replay_gain']['album']['originator'] = $thisfile_mpeg_audio_lame_RGAD_album['originator'];&nbsp;</div></li><li><div>                          $info['replay_gain']['album']['adjustment'] = $thisfile_mpeg_audio_lame_RGAD_album['gain_db'];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          unset($thisfile_mpeg_audio_lame_RGAD['album']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if (empty($thisfile_mpeg_audio_lame_RGAD)) {&nbsp;</div></li><li><div>                          unset($thisfile_mpeg_audio_lame['RGAD']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $AF  Encoding flags + ATH Type</span>&nbsp;</div></li><li><div>                      $EncodingFlagsATHtype = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xAF, 1));&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['encoding_flags']['nspsytune'] = (bool) ($EncodingFlagsATHtype & 0x10);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['encoding_flags']['nssafejoint'] = (bool) ($EncodingFlagsATHtype & 0x20);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['encoding_flags']['nogap_next'] = (bool) ($EncodingFlagsATHtype & 0x40);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['encoding_flags']['nogap_prev'] = (bool) ($EncodingFlagsATHtype & 0x80);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['ath_type'] =         $EncodingFlagsATHtype & 0x0F;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $B0  if ABR {specified bitrate} else {minimal bitrate}</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['raw']['abrbitrate_minbitrate'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xB0, 1));&nbsp;</div></li><li><div>                      if ($thisfile_mpeg_audio_lame_raw['vbr_method'] == 2) { <span class="comment">// Average BitRate (ABR)</span>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame['bitrate_abr'] = $thisfile_mpeg_audio_lame['raw']['abrbitrate_minbitrate'];&nbsp;</div></li><li><div>                      } elseif ($thisfile_mpeg_audio_lame_raw['vbr_method'] == 1) { <span class="comment">// Constant BitRate (CBR)</span>&nbsp;</div></li><li><div>                          <span class="comment">// ignore</span>&nbsp;</div></li><li><div>                      } elseif ($thisfile_mpeg_audio_lame['raw']['abrbitrate_minbitrate'] &gt; 0) { <span class="comment">// Variable BitRate (VBR) - minimum bitrate</span>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame['bitrate_min'] = $thisfile_mpeg_audio_lame['raw']['abrbitrate_minbitrate'];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $B1-$B3  Encoder delays</span>&nbsp;</div></li><li><div>                      $EncoderDelays = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xB1, 3));&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['encoder_delay'] = ($EncoderDelays & 0xFFF000) &gt;&gt; 12;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['end_padding'] =  $EncoderDelays & 0x000FFF;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $B4  Misc</span>&nbsp;</div></li><li><div>                      $MiscByte = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xB4, 1));&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['noise_shaping'] = ($MiscByte & 0x03);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['stereo_mode'] = ($MiscByte & 0x1C) &gt;&gt; 2;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['not_optimal_quality'] = ($MiscByte & 0x20) &gt;&gt; 5;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['source_sample_freq'] = ($MiscByte & 0xC0) &gt;&gt; 6;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['noise_shaping'] = $thisfile_mpeg_audio_lame_raw['noise_shaping'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['stereo_mode'] = self::LAMEmiscStereoModeLookup($thisfile_mpeg_audio_lame_raw['stereo_mode']);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['not_optimal_quality'] = (bool) $thisfile_mpeg_audio_lame_raw['not_optimal_quality'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['source_sample_freq'] = self::LAMEmiscSourceSampleFrequencyLookup($thisfile_mpeg_audio_lame_raw['source_sample_freq']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// byte $B5  MP3 Gain</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['mp3_gain'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xB5, 1), false, true);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['mp3_gain_db'] = (getid3_lib::RGADamplitude2dB(2) / 4) * $thisfile_mpeg_audio_lame_raw['mp3_gain'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['mp3_gain_factor'] = pow(2, ($thisfile_mpeg_audio_lame['mp3_gain_db'] / 6));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $B6-$B7  Preset and surround info</span>&nbsp;</div></li><li><div>                      $PresetSurroundBytes = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xB6, 2));&nbsp;</div></li><li><div>                      <span class="comment">// Reserved = ($PresetSurroundBytes & 0xC000);</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame_raw['surround_info'] = ($PresetSurroundBytes & 0x3800);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['surround_info'] = self::LAMEsurroundInfoLookup($thisfile_mpeg_audio_lame_raw['surround_info']);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['preset_used_id'] = ($PresetSurroundBytes & 0x07FF);&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['preset_used'] = self::LAMEpresetUsedLookup($thisfile_mpeg_audio_lame);&nbsp;</div></li><li><div>                      if (!empty($thisfile_mpeg_audio_lame['preset_used_id']) && empty($thisfile_mpeg_audio_lame['preset_used'])) {&nbsp;</div></li><li><div>                          $info['warning'][] = 'Unknown LAME preset used ('.$thisfile_mpeg_audio_lame['preset_used_id'].') - please report to info@getid3.org';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if (($thisfile_mpeg_audio_lame['short_version'] == 'LAME3.90.') && !empty($thisfile_mpeg_audio_lame['preset_used_id'])) {&nbsp;</div></li><li><div>                          <span class="comment">// this may change if 3.90.4 ever comes out</span>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio_lame['short_version'] = 'LAME3.90.3';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $B8-$BB  MusicLength</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['audio_bytes'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xB8, 4));&nbsp;</div></li><li><div>                      $ExpectedNumberOfAudioBytes = (($thisfile_mpeg_audio_lame['audio_bytes'] &gt; 0) ? $thisfile_mpeg_audio_lame['audio_bytes'] : $thisfile_mpeg_audio['VBR_bytes']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $BC-$BD  MusicCRC</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['music_crc'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xBC, 2));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// bytes $BE-$BF  CRC-16 of Info Tag</span>&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio_lame['lame_tag_crc'] = getid3_lib::BigEndian2Int(substr($headerstring, $LAMEtagOffsetContant + 0xBE, 2));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// LAME CBR</span>&nbsp;</div></li><li><div>                      if ($thisfile_mpeg_audio_lame_raw['vbr_method'] == 1) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio['bitrate_mode'] = 'cbr';&nbsp;</div></li><li><div>                          $thisfile_mpeg_audio['bitrate'] = self::ClosestStandardMP3Bitrate($thisfile_mpeg_audio['bitrate']);&nbsp;</div></li><li><div>                          $info['audio']['bitrate'] = $thisfile_mpeg_audio['bitrate'];&nbsp;</div></li><li><div>                          <span class="comment">//if (empty($thisfile_mpeg_audio['bitrate']) || (!empty($thisfile_mpeg_audio_lame['bitrate_min']) && ($thisfile_mpeg_audio_lame['bitrate_min'] != 255))) {</span>&nbsp;</div></li><li><div>                          <span class="comment">//    $thisfile_mpeg_audio['bitrate'] = $thisfile_mpeg_audio_lame['bitrate_min'];</span>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment">//}</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// not Fraunhofer or Xing VBR methods, most likely CBR (but could be VBR with no header)</span>&nbsp;</div></li><li><div>              $thisfile_mpeg_audio['bitrate_mode'] = 'cbr';&nbsp;</div></li><li><div>              if ($recursivesearch) {&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['bitrate_mode'] = 'vbr';&nbsp;</div></li><li><div>                  if ($this-&gt;RecursiveFrameScanning($offset, $nextframetestoffset, true)) {&nbsp;</div></li><li><div>                      $recursivesearch = false;&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio['bitrate_mode'] = 'cbr';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ($thisfile_mpeg_audio['bitrate_mode'] == 'vbr') {&nbsp;</div></li><li><div>                      $info['warning'][] = 'VBR file with no VBR header. Bitrate values calculated from actual frame bitrates.';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (($ExpectedNumberOfAudioBytes &gt; 0) && ($ExpectedNumberOfAudioBytes != ($info['avdataend'] - $info['avdataoffset']))) {&nbsp;</div></li><li><div>          if ($ExpectedNumberOfAudioBytes &gt; ($info['avdataend'] - $info['avdataoffset'])) {&nbsp;</div></li><li><div>              if ($this-&gt;isDependencyFor('matroska') || $this-&gt;isDependencyFor('riff')) {&nbsp;</div></li><li><div>                  <span class="comment">// ignore</span>, audio data is broken into chunks so will always be data &quot;missing&quot;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              elseif (($ExpectedNumberOfAudioBytes - ($info['avdataend'] - $info['avdataoffset'])) == 1) {&nbsp;</div></li><li><div>                  $this-&gt;warning('Last byte of data truncated (this is a known bug in Meracl ID3 Tag Writer before v1.3.5)');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              else {&nbsp;</div></li><li><div>                  $this-&gt;warning('Probable truncated file: expecting '.$ExpectedNumberOfAudioBytes.' bytes of audio data, only found '.($info['avdataend'] - $info['avdataoffset']).' (short by '.($ExpectedNumberOfAudioBytes - ($info['avdataend'] - $info['avdataoffset'])).' bytes)');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ((($info['avdataend'] - $info['avdataoffset']) - $ExpectedNumberOfAudioBytes) == 1) {&nbsp;</div></li><li><div>              <span class="comment">//    $prenullbytefileoffset = $this-&gt;ftell();</span>&nbsp;</div></li><li><div>              <span class="comment">//    $this-&gt;fseek($info['avdataend']);</span>&nbsp;</div></li><li><div>              <span class="comment">//    $PossibleNullByte = $this-&gt;fread(1);</span>&nbsp;</div></li><li><div>              <span class="comment">//    $this-&gt;fseek($prenullbytefileoffset);</span>&nbsp;</div></li><li><div>              <span class="comment">//    if ($PossibleNullByte === &quot;\x00&quot;) {</span>&nbsp;</div></li><li><div>                      $info['avdataend']--;&nbsp;</div></li><li><div>              <span class="comment">//        $info['warning'][] = 'Extra null byte at end of MP3 data assumed to be RIFF padding and therefore ignored';</span>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">//    }</span></span></span></span> else {</span>&nbsp;</div></li><li><div>              <span class="comment">//        $info['warning'][] = 'Too much data in file: expecting '.$ExpectedNumberOfAudioBytes.' bytes of audio data, found '.($info['avdataend'] - $info['avdataoffset']).' ('.(($info['avdataend'] - $info['avdataoffset']) - $ExpectedNumberOfAudioBytes).' bytes too many)';</span>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">//    }</span></span></span></span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $info['warning'][] = 'Too much data in file: expecting '.$ExpectedNumberOfAudioBytes.' bytes of audio data, found '.($info['avdataend'] - $info['avdataoffset']).' ('.(($info['avdataend'] - $info['avdataoffset']) - $ExpectedNumberOfAudioBytes).' bytes too many)';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (($thisfile_mpeg_audio['bitrate'] == 'free') && empty($info['audio']['bitrate'])) {&nbsp;</div></li><li><div>          if (($offset == $info['avdataoffset']) && empty($thisfile_mpeg_audio['VBR_frames'])) {&nbsp;</div></li><li><div>              $framebytelength = $this-&gt;FreeFormatFrameLength($offset, true);&nbsp;</div></li><li><div>              if ($framebytelength &gt; 0) {&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['framelength'] = $framebytelength;&nbsp;</div></li><li><div>                  if ($thisfile_mpeg_audio['layer'] == '1') {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// BitRate = (((FrameLengthInBytes / 4) - Padding) * SampleRate) / 12</span></span>&nbsp;</div></li><li><div>                      $info['audio']['bitrate'] = ((($framebytelength / 4) - intval($thisfile_mpeg_audio['padding'])) * $thisfile_mpeg_audio['sample_rate']) / 12;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// Bitrate = ((FrameLengthInBytes - Padding) * SampleRate) / 144</span></span>&nbsp;</div></li><li><div>                      $info['audio']['bitrate'] = (($framebytelength - intval($thisfile_mpeg_audio['padding'])) * $thisfile_mpeg_audio['sample_rate']) / 144;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $info['error'][] = 'Error calculating frame length of free-format MP3 without Xing/LAME header';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($thisfile_mpeg_audio['VBR_frames']) ? $thisfile_mpeg_audio['VBR_frames'] : '') {&nbsp;</div></li><li><div>          switch ($thisfile_mpeg_audio['bitrate_mode']) {&nbsp;</div></li><li><div>              case 'vbr':&nbsp;</div></li><li><div>              case 'abr':&nbsp;</div></li><li><div>                  $bytes_per_frame = 1152;&nbsp;</div></li><li><div>                  if (($thisfile_mpeg_audio['version'] == '1') && ($thisfile_mpeg_audio['layer'] == 1)) {&nbsp;</div></li><li><div>                      $bytes_per_frame = 384;&nbsp;</div></li><li><div>                  } elseif ((($thisfile_mpeg_audio['version'] == '2') || ($thisfile_mpeg_audio['version'] == '2.5')) && ($thisfile_mpeg_audio['layer'] == 3)) {&nbsp;</div></li><li><div>                      $bytes_per_frame = 576;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $thisfile_mpeg_audio['VBR_bitrate'] = (isset($thisfile_mpeg_audio['VBR_bytes']) ? (($thisfile_mpeg_audio['VBR_bytes'] / $thisfile_mpeg_audio['VBR_frames']) * 8) * ($info['audio']['sample_rate'] / $bytes_per_frame) : 0);&nbsp;</div></li><li><div>                  if ($thisfile_mpeg_audio['VBR_bitrate'] &gt; 0) {&nbsp;</div></li><li><div>                      $info['audio']['bitrate'] = $thisfile_mpeg_audio['VBR_bitrate'];&nbsp;</div></li><li><div>                      $thisfile_mpeg_audio['bitrate'] = $thisfile_mpeg_audio['VBR_bitrate']; <span class="comment">// to avoid confusion</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// End variable-bitrate headers</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">/////////////////////////////////////////////////////////////////</span></span></span></span>///////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($recursivesearch) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$this-&gt;RecursiveFrameScanning($offset, $nextframetestoffset, $ScanAsCBR)) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//if (false) {</span>&nbsp;</div></li><li><div>      <span class="comment">//    // experimental side info parsing section - not returning anything useful yet</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //    $SideInfoBitstream = getid3_lib::BigEndian2Bin($SideInfoData);</span>&nbsp;</div></li><li><div>      <span class="comment">//    $SideInfoOffset = 0;</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //    if ($thisfile_mpeg_audio['version'] == '1') {</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        if ($thisfile_mpeg_audio['channelmode'] == 'mono') {</span></span>&nbsp;</div></li><li><div>      <span class="comment">//            // MPEG-1 (mono)</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//            $thisfile_mpeg_audio['side_info']['main_data_begin'] = substr($SideInfoBitstream, $SideInfoOffset, 9);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 9;</span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $SideInfoOffset += 5;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">//        }</span></span></span></span> else {</span>&nbsp;</div></li><li><div>      <span class="comment">//            // MPEG-1 (stereo, joint-stereo, dual-channel)</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//            $thisfile_mpeg_audio['side_info']['main_data_begin'] = substr($SideInfoBitstream, $SideInfoOffset, 9);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 9;</span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $SideInfoOffset += 3;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//        }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">//    }</span></span></span></span> else {</span> // 2 or 2.5&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        if ($thisfile_mpeg_audio['channelmode'] == 'mono') {</span></span>&nbsp;</div></li><li><div>      <span class="comment">//            // MPEG-2, MPEG-2.5 (mono)</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//            $thisfile_mpeg_audio['side_info']['main_data_begin'] = substr($SideInfoBitstream, $SideInfoOffset, 8);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 8;</span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 1;</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">//        }</span></span></span></span> else {</span>&nbsp;</div></li><li><div>      <span class="comment">//            // MPEG-2, MPEG-2.5 (stereo, joint-stereo, dual-channel)</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//            $thisfile_mpeg_audio['side_info']['main_data_begin'] = substr($SideInfoBitstream, $SideInfoOffset, 8);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 8;</span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $SideInfoOffset += 2;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//        }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//    }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //    if ($thisfile_mpeg_audio['version'] == '1') {</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        for ($channel = 0; $channel &lt; $info['audio']['channels']; $channel++) {</span></span>&nbsp;</div></li><li><div>      <span class="comment">//            for ($scfsi_band = 0; $scfsi_band &lt; 4; $scfsi_band++) {</span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['scfsi'][$channel][$scfsi_band] = substr($SideInfoBitstream, $SideInfoOffset, 1);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                $SideInfoOffset += 2;</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//        }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//    }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//    for ($granule = 0; $granule &lt; (($thisfile_mpeg_audio['version'] == '1') ? 2 : 1); $granule++) {</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        for ($channel = 0; $channel &lt; $info['audio']['channels']; $channel++) {</span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $thisfile_mpeg_audio['part2_3_length'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 12);</span>&nbsp;</div></li><li><div>      <span class="comment">//            $SideInfoOffset += 12;</span>&nbsp;</div></li><li><div>      <span class="comment">//            $thisfile_mpeg_audio['big_values'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 9);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 9;</span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $thisfile_mpeg_audio['global_gain'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 8);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 8;</span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            if ($thisfile_mpeg_audio['version'] == '1') {</span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['scalefac_compress'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 4);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                $SideInfoOffset += 4;</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            }</span></span></span></span> else {&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['scalefac_compress'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 9);</span>&nbsp;</div></li><li><div>      <span class="comment">//                $SideInfoOffset += 9;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $thisfile_mpeg_audio['window_switching_flag'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 1);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 1;</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //            if ($thisfile_mpeg_audio['window_switching_flag'][$granule][$channel] == '1') {</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //                $thisfile_mpeg_audio['block_type'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 2);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                $SideInfoOffset += 2;</span></span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['mixed_block_flag'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 1);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                $SideInfoOffset += 1;</span></span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //                for ($region = 0; $region &lt; 2; $region++) {</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                    $thisfile_mpeg_audio['table_select'][$granule][$channel][$region] = substr($SideInfoBitstream, $SideInfoOffset, 5);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                    $SideInfoOffset += 5;</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['table_select'][$granule][$channel][2] = 0;</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //                for ($window = 0; $window &lt; 3; $window++) {</span>&nbsp;</div></li><li><div>      <span class="comment">//                    $thisfile_mpeg_audio['subblock_gain'][$granule][$channel][$window] = substr($SideInfoBitstream, $SideInfoOffset, 3);</span>&nbsp;</div></li><li><div>      <span class="comment">//                    $SideInfoOffset += 3;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div>      //&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            }</span></span></span></span> else {&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //                for ($region = 0; $region &lt; 3; $region++) {</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                    $thisfile_mpeg_audio['table_select'][$granule][$channel][$region] = substr($SideInfoBitstream, $SideInfoOffset, 5);</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                    $SideInfoOffset += 5;</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//                }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      //                $thisfile_mpeg_audio['region0_count'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 4);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                $SideInfoOffset += 4;</span></span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['region1_count'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 3);</span>&nbsp;</div></li><li><div>      <span class="comment">//                $SideInfoOffset += 3;</span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['block_type'][$granule][$channel] = 0;</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            }</span></span></span></span>&nbsp;</div></li><li><div>      //&nbsp;</div></li><li><div>      <span class="comment">//            if ($thisfile_mpeg_audio['version'] == '1') {</span>&nbsp;</div></li><li><div>      <span class="comment">//                $thisfile_mpeg_audio['preflag'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 1);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//                $SideInfoOffset += 1;</span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $thisfile_mpeg_audio['scalefac_scale'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 1);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 1;</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment">//            $thisfile_mpeg_audio['count1table_select'][$granule][$channel] = substr($SideInfoBitstream, $SideInfoOffset, 1);</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//            $SideInfoOffset += 1;</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//        }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">//    }</span></span></span></span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//}</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function RecursiveFrameScanning(&$offset, &$nextframetestoffset, $ScanAsCBR) {&nbsp;</div></li><li><div>      $info = &$this-&gt;getid3-&gt;info;&nbsp;</div></li><li><div>      $firstframetestarray = array('error'=&gt;'', 'warning'=&gt;'', 'avdataend'=&gt;$info['avdataend'], 'avdataoffset'=&gt;$info['avdataoffset']);&nbsp;</div></li><li><div>      $this-&gt;decodeMPEGaudioHeader($offset, $firstframetestarray, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      for ($i = 0; $i &lt; GETID3_MP3_VALID_CHECK_FRAMES; $i++) {&nbsp;</div></li><li><div>          <span class="comment">// check next GETID3_MP3_VALID_CHECK_FRAMES frames for validity, to make sure we haven't run across a false synch</span>&nbsp;</div></li><li><div>          if (($nextframetestoffset + 4) &gt;= $info['avdataend']) {&nbsp;</div></li><li><div>              <span class="comment">// end of file</span>&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $nextframetestarray = array('error'=&gt;'', 'warning'=&gt;'', 'avdataend'=&gt;$info['avdataend'], 'avdataoffset'=&gt;$info['avdataoffset']);&nbsp;</div></li><li><div>          if ($this-&gt;decodeMPEGaudioHeader($nextframetestoffset, $nextframetestarray, false)) {&nbsp;</div></li><li><div>              if ($ScanAsCBR) {&nbsp;</div></li><li><div>                  <span class="comment">// force CBR mode, used for trying to pick out invalid audio streams with valid(?) VBR headers, or VBR streams with no VBR header</span>&nbsp;</div></li><li><div>                  if (!isset($nextframetestarray['mpeg']['audio']['bitrate']) || !isset($firstframetestarray['mpeg']['audio']['bitrate']) || ($nextframetestarray['mpeg']['audio']['bitrate'] != $firstframetestarray['mpeg']['audio']['bitrate'])) {&nbsp;</div></li><li><div>                      return false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// next frame is OK, get ready to check the one after that</span>&nbsp;</div></li><li><div>              if (isset($nextframetestarray['mpeg']['audio']['framelength']) && ($nextframetestarray['mpeg']['audio']['framelength'] &gt; 0)) {&nbsp;</div></li><li><div>                  $nextframetestoffset += $nextframetestarray['mpeg']['audio']['framelength'];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $info['error'][] = 'Frame at offset ('.$offset.') is has an invalid frame length.';&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } elseif (!empty($firstframetestarray['mpeg']['audio']['framelength']) && (($nextframetestoffset + $firstframetestarray['mpeg']['audio']['framelength']) &gt; $info['avdataend'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// it's not the end of the file, but there's not enough data left for another frame, so assume it's garbage/padding and return OK</span>&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// next frame is not valid, note the error and fail, so scanning can contiue for a valid frame sequence</span>&nbsp;</div></li><li><div>              $info['warning'][] = 'Frame at offset ('.$offset.') is valid, but the next one at ('.$nextframetestoffset.') is not.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function FreeFormatFrameLength($offset, $deepscan=false) {&nbsp;</div></li><li><div>      $info = &$this-&gt;getid3-&gt;info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;fseek($offset);&nbsp;</div></li><li><div>      $MPEGaudioData = $this-&gt;fread(32768);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $SyncPattern1 = substr($MPEGaudioData, 0, 4);&nbsp;</div></li><li><div>      <span class="comment">// may be different pattern due to padding</span>&nbsp;</div></li><li><div>      $SyncPattern2 = $SyncPattern1{0}.$SyncPattern1{1}.chr(ord($SyncPattern1{2}) | 0x02).$SyncPattern1{3};&nbsp;</div></li><li><div>      if ($SyncPattern2 === $SyncPattern1) {&nbsp;</div></li><li><div>          $SyncPattern2 = $SyncPattern1{0}.$SyncPattern1{1}.chr(ord($SyncPattern1{2}) & 0xFD).$SyncPattern1{3};&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $framelength = false;&nbsp;</div></li><li><div>      $framelength1 = strpos($MPEGaudioData, $SyncPattern1, 4);&nbsp;</div></li><li><div>      $framelength2 = strpos($MPEGaudioData, $SyncPattern2, 4);&nbsp;</div></li><li><div>      if ($framelength1 &gt; 4) {&nbsp;</div></li><li><div>          $framelength = $framelength1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($framelength2 &gt; 4) && ($framelength2 &lt; $framelength1)) {&nbsp;</div></li><li><div>          $framelength = $framelength2;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$framelength) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// LAME 3.88 has a different value for modeextension on the first frame vs the rest</span>&nbsp;</div></li><li><div>          $framelength1 = strpos($MPEGaudioData, substr($SyncPattern1, 0, 3), 4);&nbsp;</div></li><li><div>          $framelength2 = strpos($MPEGaudioData, substr($SyncPattern2, 0, 3), 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($framelength1 &gt; 4) {&nbsp;</div></li><li><div>              $framelength = $framelength1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (($framelength2 &gt; 4) && ($framelength2 &lt; $framelength1)) {&nbsp;</div></li><li><div>              $framelength = $framelength2;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!$framelength) {&nbsp;</div></li><li><div>              $info['error'][] = 'Cannot find next free-format synch pattern ('.getid3_lib::PrintHexBytes($SyncPattern1).' or '.getid3_lib::PrintHexBytes($SyncPattern2).') after offset '.$offset;&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $info['warning'][] = 'ModeExtension varies between first frame and other frames (known free-format issue in LAME 3.88)';&nbsp;</div></li><li><div>              $info['audio']['codec'] = 'LAME';&nbsp;</div></li><li><div>              $info['audio']['encoder'] = 'LAME3.88';&nbsp;</div></li><li><div>              $SyncPattern1 = substr($SyncPattern1, 0, 3);&nbsp;</div></li><li><div>              $SyncPattern2 = substr($SyncPattern2, 0, 3);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($deepscan) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ActualFrameLengthValues = array();&nbsp;</div></li><li><div>          $nextoffset = $offset + $framelength;&nbsp;</div></li><li><div>          while ($nextoffset &lt; ($info['avdataend'] - 6)) {&nbsp;</div></li><li><div>              $this-&gt;fseek($nextoffset - 1);&nbsp;</div></li><li><div>              $NextSyncPattern = $this-&gt;fread(6);&nbsp;</div></li><li><div>              if ((substr($NextSyncPattern, 1, strlen($SyncPattern1)) == $SyncPattern1) || (substr($NextSyncPattern, 1, strlen($SyncPattern2)) == $SyncPattern2)) {&nbsp;</div></li><li><div>                  <span class="comment">// good - found where expected</span>&nbsp;</div></li><li><div>                  $ActualFrameLengthValues[] = $framelength;&nbsp;</div></li><li><div>              } elseif ((substr($NextSyncPattern, 0, strlen($SyncPattern1)) == $SyncPattern1) || (substr($NextSyncPattern, 0, strlen($SyncPattern2)) == $SyncPattern2)) {&nbsp;</div></li><li><div>                  <span class="comment">// ok - found one byte earlier than expected (last frame wasn't padded, first frame was)</span>&nbsp;</div></li><li><div>                  $ActualFrameLengthValues[] = ($framelength - 1);&nbsp;</div></li><li><div>                  $nextoffset--;&nbsp;</div></li><li><div>              } elseif ((substr($NextSyncPattern, 2, strlen($SyncPattern1)) == $SyncPattern1) || (substr($NextSyncPattern, 2, strlen($SyncPattern2)) == $SyncPattern2)) {&nbsp;</div></li><li><div>                  <span class="comment">// ok - found one byte later than expected (last frame was padded, first frame wasn't)</span>&nbsp;</div></li><li><div>                  $ActualFrameLengthValues[] = ($framelength + 1);&nbsp;</div></li><li><div>                  $nextoffset++;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $info['error'][] = 'Did not find expected free-format sync pattern at offset '.$nextoffset;&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $nextoffset += $framelength;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (count($ActualFrameLengthValues) &gt; 0) {&nbsp;</div></li><li><div>              $framelength = intval(round(array_sum($ActualFrameLengthValues) / count($ActualFrameLengthValues)));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $framelength;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getOnlyMPEGaudioInfoBruteForce() {&nbsp;</div></li><li><div>      $MPEGaudioHeaderDecodeCache = array();&nbsp;</div></li><li><div>      $MPEGaudioHeaderValidCache = array();&nbsp;</div></li><li><div>      $MPEGaudioHeaderLengthCache = array();&nbsp;</div></li><li><div>      $MPEGaudioVersionLookup = self::MPEGaudioVersionArray();&nbsp;</div></li><li><div>      $MPEGaudioLayerLookup = self::MPEGaudioLayerArray();&nbsp;</div></li><li><div>      $MPEGaudioBitrateLookup = self::MPEGaudioBitrateArray();&nbsp;</div></li><li><div>      $MPEGaudioFrequencyLookup = self::MPEGaudioFrequencyArray();&nbsp;</div></li><li><div>      $MPEGaudioChannelModeLookup = self::MPEGaudioChannelModeArray();&nbsp;</div></li><li><div>      $MPEGaudioModeExtensionLookup = self::MPEGaudioModeExtensionArray();&nbsp;</div></li><li><div>      $MPEGaudioEmphasisLookup = self::MPEGaudioEmphasisArray();&nbsp;</div></li><li><div>      $LongMPEGversionLookup = array();&nbsp;</div></li><li><div>      $LongMPEGlayerLookup = array();&nbsp;</div></li><li><div>      $LongMPEGbitrateLookup = array();&nbsp;</div></li><li><div>      $LongMPEGpaddingLookup = array();&nbsp;</div></li><li><div>      $LongMPEGfrequencyLookup = array();&nbsp;</div></li><li><div>      $Distribution['bitrate'] = array();&nbsp;</div></li><li><div>      $Distribution['frequency'] = array();&nbsp;</div></li><li><div>      $Distribution['layer'] = array();&nbsp;</div></li><li><div>      $Distribution['version'] = array();&nbsp;</div></li><li><div>      $Distribution['padding'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info = &$this-&gt;getid3-&gt;info;&nbsp;</div></li><li><div>      $this-&gt;fseek($info['avdataoffset']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $max_frames_scan = 5000;&nbsp;</div></li><li><div>      $frames_scanned = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $previousvalidframe = $info['avdataoffset'];&nbsp;</div></li><li><div>      while ($this-&gt;ftell() &lt; $info['avdataend']) {&nbsp;</div></li><li><div>          set_time_limit(30);&nbsp;</div></li><li><div>          $head4 = $this-&gt;fread(4);&nbsp;</div></li><li><div>          if (strlen($head4) &lt; 4) {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($head4{0} != &quot;\xFF&quot;) {&nbsp;</div></li><li><div>              for ($i = 1; $i &lt; 4; $i++) {&nbsp;</div></li><li><div>                  if ($head4{$i} == &quot;\xFF&quot;) {&nbsp;</div></li><li><div>                      $this-&gt;fseek($i - 4, SEEK_CUR);&nbsp;</div></li><li><div>                      continue 2;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!isset($MPEGaudioHeaderDecodeCache[$head4])) {&nbsp;</div></li><li><div>              $MPEGaudioHeaderDecodeCache[$head4] = self::MPEGaudioHeaderDecode($head4);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!isset($MPEGaudioHeaderValidCache[$head4])) {&nbsp;</div></li><li><div>              $MPEGaudioHeaderValidCache[$head4] = self::MPEGaudioHeaderValid($MPEGaudioHeaderDecodeCache[$head4], false, false);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($MPEGaudioHeaderValidCache[$head4]) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!isset($MPEGaudioHeaderLengthCache[$head4])) {&nbsp;</div></li><li><div>                  $LongMPEGversionLookup[$head4] = $MPEGaudioVersionLookup[$MPEGaudioHeaderDecodeCache[$head4]['version']];&nbsp;</div></li><li><div>                  $LongMPEGlayerLookup[$head4] = $MPEGaudioLayerLookup[$MPEGaudioHeaderDecodeCache[$head4]['layer']];&nbsp;</div></li><li><div>                  $LongMPEGbitrateLookup[$head4] = $MPEGaudioBitrateLookup[$LongMPEGversionLookup[$head4]][$LongMPEGlayerLookup[$head4]][$MPEGaudioHeaderDecodeCache[$head4]['bitrate']];&nbsp;</div></li><li><div>                  $LongMPEGpaddingLookup[$head4] = (bool) $MPEGaudioHeaderDecodeCache[$head4]['padding'];&nbsp;</div></li><li><div>                  $LongMPEGfrequencyLookup[$head4] = $MPEGaudioFrequencyLookup[$LongMPEGversionLookup[$head4]][$MPEGaudioHeaderDecodeCache[$head4]['sample_rate']];&nbsp;</div></li><li><div>                  $MPEGaudioHeaderLengthCache[$head4] = self::MPEGaudioFrameLength(&nbsp;</div></li><li><div>                      $LongMPEGbitrateLookup[$head4], &nbsp;</div></li><li><div>                      $LongMPEGversionLookup[$head4], &nbsp;</div></li><li><div>                      $LongMPEGlayerLookup[$head4], &nbsp;</div></li><li><div>                      $LongMPEGpaddingLookup[$head4], &nbsp;</div></li><li><div>                      $LongMPEGfrequencyLookup[$head4]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($MPEGaudioHeaderLengthCache[$head4] &gt; 4) {&nbsp;</div></li><li><div>                  $WhereWeWere = $this-&gt;ftell();&nbsp;</div></li><li><div>                  $this-&gt;fseek($MPEGaudioHeaderLengthCache[$head4] - 4, SEEK_CUR);&nbsp;</div></li><li><div>                  $next4 = $this-&gt;fread(4);&nbsp;</div></li><li><div>                  if ($next4{0} == &quot;\xFF&quot;) {&nbsp;</div></li><li><div>                      if (!isset($MPEGaudioHeaderDecodeCache[$next4])) {&nbsp;</div></li><li><div>                          $MPEGaudioHeaderDecodeCache[$next4] = self::MPEGaudioHeaderDecode($next4);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if (!isset($MPEGaudioHeaderValidCache[$next4])) {&nbsp;</div></li><li><div>                          $MPEGaudioHeaderValidCache[$next4] = self::MPEGaudioHeaderValid($MPEGaudioHeaderDecodeCache[$next4], false, false);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($MPEGaudioHeaderValidCache[$next4]) {&nbsp;</div></li><li><div>                          $this-&gt;fseek(-4, SEEK_CUR);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          getid3_lib::safe_inc($Distribution['bitrate'][$LongMPEGbitrateLookup[$head4]]);&nbsp;</div></li><li><div>                          getid3_lib::safe_inc($Distribution['layer'][$LongMPEGlayerLookup[$head4]]);&nbsp;</div></li><li><div>                          getid3_lib::safe_inc($Distribution['version'][$LongMPEGversionLookup[$head4]]);&nbsp;</div></li><li><div>                          getid3_lib::safe_inc($Distribution['padding'][intval($LongMPEGpaddingLookup[$head4])]);&nbsp;</div></li><li><div>                          getid3_lib::safe_inc($Distribution['frequency'][$LongMPEGfrequencyLookup[$head4]]);&nbsp;</div></li><li><div>                          if ($max_frames_scan && (++$frames_scanned &gt;= $max_frames_scan)) {&nbsp;</div></li><li><div>                              $pct_data_scanned = ($this-&gt;ftell() - $info['avdataoffset']) / ($info['avdataend'] - $info['avdataoffset']);&nbsp;</div></li><li><div>                              $info['warning'][] = 'too many MPEG audio frames to scan, only scanned first '.$max_frames_scan.' frames ('.number_format($pct_data_scanned * 100, 1).'% of file) and extrapolated distribution, playtime and bitrate may be incorrect.';&nbsp;</div></li><li><div>                              foreach ($Distribution as $key1 =&gt; $value1) {&nbsp;</div></li><li><div>                                  foreach ($value1 as $key2 =&gt; $value2) {&nbsp;</div></li><li><div>                                      $Distribution[$key1][$key2] = round($value2 / $pct_data_scanned);&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  unset($next4);&nbsp;</div></li><li><div>                  $this-&gt;fseek($WhereWeWere - 3);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach ($Distribution as $key =&gt; $value) {&nbsp;</div></li><li><div>          ksort($Distribution[$key], SORT_NUMERIC);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ksort($Distribution['version'], SORT_STRING);&nbsp;</div></li><li><div>      $info['mpeg']['audio']['bitrate_distribution'] = $Distribution['bitrate'];&nbsp;</div></li><li><div>      $info['mpeg']['audio']['frequency_distribution'] = $Distribution['frequency'];&nbsp;</div></li><li><div>      $info['mpeg']['audio']['layer_distribution'] = $Distribution['layer'];&nbsp;</div></li><li><div>      $info['mpeg']['audio']['version_distribution'] = $Distribution['version'];&nbsp;</div></li><li><div>      $info['mpeg']['audio']['padding_distribution'] = $Distribution['padding'];&nbsp;</div></li><li><div>      if (count($Distribution['version']) &gt; 1) {&nbsp;</div></li><li><div>          $info['error'][] = 'Corrupt file - more than one MPEG version detected';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (count($Distribution['layer']) &gt; 1) {&nbsp;</div></li><li><div>          $info['error'][] = 'Corrupt file - more than one MPEG layer detected';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (count($Distribution['frequency']) &gt; 1) {&nbsp;</div></li><li><div>          $info['error'][] = 'Corrupt file - more than one MPEG sample rate detected';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $bittotal = 0;&nbsp;</div></li><li><div>      foreach ($Distribution['bitrate'] as $bitratevalue =&gt; $bitratecount) {&nbsp;</div></li><li><div>          if ($bitratevalue != 'free') {&nbsp;</div></li><li><div>              $bittotal += ($bitratevalue * $bitratecount);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $info['mpeg']['audio']['frame_count'] = array_sum($Distribution['bitrate']);&nbsp;</div></li><li><div>      if ($info['mpeg']['audio']['frame_count'] == 0) {&nbsp;</div></li><li><div>          $info['error'][] = 'no MPEG audio frames found';&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $info['mpeg']['audio']['bitrate'] = ($bittotal / $info['mpeg']['audio']['frame_count']);&nbsp;</div></li><li><div>      $info['mpeg']['audio']['bitrate_mode'] = ((count($Distribution['bitrate']) &gt; 0) ? 'vbr' : 'cbr');&nbsp;</div></li><li><div>      $info['mpeg']['audio']['sample_rate'] = getid3_lib::array_max($Distribution['frequency'], true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info['audio']['bitrate'] = $info['mpeg']['audio']['bitrate'];&nbsp;</div></li><li><div>      $info['audio']['bitrate_mode'] = $info['mpeg']['audio']['bitrate_mode'];&nbsp;</div></li><li><div>      $info['audio']['sample_rate'] = $info['mpeg']['audio']['sample_rate'];&nbsp;</div></li><li><div>      $info['audio']['dataformat'] = 'mp'.getid3_lib::array_max($Distribution['layer'], true);&nbsp;</div></li><li><div>      $info['fileformat'] = $info['audio']['dataformat'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getOnlyMPEGaudioInfo($avdataoffset, $BitrateHistogram=false) {&nbsp;</div></li><li><div>      <span class="comment">// looks for synch, decodes MPEG audio header</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info = &$this-&gt;getid3-&gt;info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      static $MPEGaudioVersionLookup;&nbsp;</div></li><li><div>      static $MPEGaudioLayerLookup;&nbsp;</div></li><li><div>      static $MPEGaudioBitrateLookup;&nbsp;</div></li><li><div>      if (empty($MPEGaudioVersionLookup)) {&nbsp;</div></li><li><div>         $MPEGaudioVersionLookup = self::MPEGaudioVersionArray();&nbsp;</div></li><li><div>         $MPEGaudioLayerLookup = self::MPEGaudioLayerArray();&nbsp;</div></li><li><div>         $MPEGaudioBitrateLookup = self::MPEGaudioBitrateArray();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;fseek($avdataoffset);&nbsp;</div></li><li><div>      $sync_seek_buffer_size = min(128 * 1024, $info['avdataend'] - $avdataoffset);&nbsp;</div></li><li><div>      if ($sync_seek_buffer_size &lt;= 0) {&nbsp;</div></li><li><div>          $info['error'][] = 'Invalid $sync_seek_buffer_size at offset '.$avdataoffset;&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $header = $this-&gt;fread($sync_seek_buffer_size);&nbsp;</div></li><li><div>      $sync_seek_buffer_size = strlen($header);&nbsp;</div></li><li><div>      $SynchSeekOffset = 0;&nbsp;</div></li><li><div>      while ($SynchSeekOffset &lt; $sync_seek_buffer_size) {&nbsp;</div></li><li><div>          if ((($avdataoffset + $SynchSeekOffset)  &lt; $info['avdataend']) && !feof($this-&gt;getid3-&gt;fp)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($SynchSeekOffset &gt; $sync_seek_buffer_size) {&nbsp;</div></li><li><div>                  <span class="comment">// if a synch's not found within the first 128k bytes, then give up</span>&nbsp;</div></li><li><div>                  $info['error'][] = 'Could not find valid MPEG audio synch within the first '.round($sync_seek_buffer_size / 1024).'kB';&nbsp;</div></li><li><div>                  if (isset($info['audio']['bitrate'])) {&nbsp;</div></li><li><div>                      unset($info['audio']['bitrate']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>                      unset($info['mpeg']['audio']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (empty($info['mpeg'])) {&nbsp;</div></li><li><div>                      unset($info['mpeg']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } elseif (feof($this-&gt;getid3-&gt;fp)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $info['error'][] = 'Could not find valid MPEG audio synch before end of file';&nbsp;</div></li><li><div>                  if (isset($info['audio']['bitrate'])) {&nbsp;</div></li><li><div>                      unset($info['audio']['bitrate']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>                      unset($info['mpeg']['audio']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($info['mpeg']) && (!is_array($info['mpeg']) || (count($info['mpeg']) == 0))) {&nbsp;</div></li><li><div>                      unset($info['mpeg']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (($SynchSeekOffset + 1) &gt;= strlen($header)) {&nbsp;</div></li><li><div>              $info['error'][] = 'Could not find valid MPEG synch before end of file';&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (($header{$SynchSeekOffset} == &quot;\xFF&quot;) && ($header{($SynchSeekOffset + 1)} &gt; &quot;\xE0&quot;)) { <span class="comment"><span class="comment">// synch detected</span></span>&nbsp;</div></li><li><div>              if (!isset($FirstFrameThisfileInfo) && !isset($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>                  $FirstFrameThisfileInfo = $info;&nbsp;</div></li><li><div>                  $FirstFrameAVDataOffset = $avdataoffset + $SynchSeekOffset;&nbsp;</div></li><li><div>                  if (!$this-&gt;decodeMPEGaudioHeader($FirstFrameAVDataOffset, $FirstFrameThisfileInfo, false)) {&nbsp;</div></li><li><div>                      <span class="comment">// if this is the first valid MPEG-audio frame, save it in case it's a VBR header frame and there's</span>&nbsp;</div></li><li><div>                      <span class="comment">// garbage between this frame and a valid sequence of MPEG-audio frames, to be restored below</span>&nbsp;</div></li><li><div>                      unset($FirstFrameThisfileInfo);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $dummy = $info; <span class="comment">// only overwrite real data if valid header found</span>&nbsp;</div></li><li><div>              if ($this-&gt;decodeMPEGaudioHeader($avdataoffset + $SynchSeekOffset, $dummy, true)) {&nbsp;</div></li><li><div>                  $info = $dummy;&nbsp;</div></li><li><div>                  $info['avdataoffset'] = $avdataoffset + $SynchSeekOffset;&nbsp;</div></li><li><div>                  switch (isset($info['fileformat']) ? $info['fileformat'] : '') {&nbsp;</div></li><li><div>                      case '':&nbsp;</div></li><li><div>                      case 'id3':&nbsp;</div></li><li><div>                      case 'ape':&nbsp;</div></li><li><div>                      case 'mp3':&nbsp;</div></li><li><div>                          $info['fileformat'] = 'mp3';&nbsp;</div></li><li><div>                          $info['audio']['dataformat'] = 'mp3';&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($FirstFrameThisfileInfo['mpeg']['audio']['bitrate_mode']) && ($FirstFrameThisfileInfo['mpeg']['audio']['bitrate_mode'] == 'vbr')) {&nbsp;</div></li><li><div>                      if (!(abs($info['audio']['bitrate'] - $FirstFrameThisfileInfo['audio']['bitrate']) &lt;= 1)) {&nbsp;</div></li><li><div>                          <span class="comment">// If there is garbage data between a valid VBR header frame and a sequence</span>&nbsp;</div></li><li><div>                          <span class="comment">// of valid MPEG-audio frames the VBR data is no longer discarded.</span>&nbsp;</div></li><li><div>                          $info = $FirstFrameThisfileInfo;&nbsp;</div></li><li><div>                          $info['avdataoffset'] = $FirstFrameAVDataOffset;&nbsp;</div></li><li><div>                          $info['fileformat'] = 'mp3';&nbsp;</div></li><li><div>                          $info['audio']['dataformat'] = 'mp3';&nbsp;</div></li><li><div>                          $dummy = $info;&nbsp;</div></li><li><div>                          unset($dummy['mpeg']['audio']);&nbsp;</div></li><li><div>                          $GarbageOffsetStart = $FirstFrameAVDataOffset + $FirstFrameThisfileInfo['mpeg']['audio']['framelength'];&nbsp;</div></li><li><div>                          $GarbageOffsetEnd = $avdataoffset + $SynchSeekOffset;&nbsp;</div></li><li><div>                          if ($this-&gt;decodeMPEGaudioHeader($GarbageOffsetEnd, $dummy, true, true)) {&nbsp;</div></li><li><div>                              $info = $dummy;&nbsp;</div></li><li><div>                              $info['avdataoffset'] = $GarbageOffsetEnd;&nbsp;</div></li><li><div>                              $info['warning'][] = 'apparently-valid VBR header not used because could not find '.GETID3_MP3_VALID_CHECK_FRAMES.' consecutive MPEG-audio frames immediately after VBR header (garbage data for '.($GarbageOffsetEnd - $GarbageOffsetStart).' bytes between '.$GarbageOffsetStart.' and '.$GarbageOffsetEnd.'), but did find valid CBR stream starting at '.$GarbageOffsetEnd;&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              $info['warning'][] = 'using data from VBR header even though could not find '.GETID3_MP3_VALID_CHECK_FRAMES.' consecutive MPEG-audio frames immediately after VBR header (garbage data for '.($GarbageOffsetEnd - $GarbageOffsetStart).' bytes between '.$GarbageOffsetStart.' and '.$GarbageOffsetEnd.')';&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($info['mpeg']['audio']['bitrate_mode']) && ($info['mpeg']['audio']['bitrate_mode'] == 'vbr') && !isset($info['mpeg']['audio']['VBR_method'])) {&nbsp;</div></li><li><div>                      <span class="comment">// VBR file with no VBR header</span>&nbsp;</div></li><li><div>                      $BitrateHistogram = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($BitrateHistogram) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $info['mpeg']['audio']['stereo_distribution'] = array('stereo'=&gt;0, 'joint stereo'=&gt;0, 'dual channel'=&gt;0, 'mono'=&gt;0);&nbsp;</div></li><li><div>                      $info['mpeg']['audio']['version_distribution'] = array('1'=&gt;0, '2'=&gt;0, '2.5'=&gt;0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($info['mpeg']['audio']['version'] == '1') {&nbsp;</div></li><li><div>                          if ($info['mpeg']['audio']['layer'] == 3) {&nbsp;</div></li><li><div>                              $info['mpeg']['audio']['bitrate_distribution'] = array('free'=&gt;0, 32000=&gt;0, 40000=&gt;0, 48000=&gt;0, 56000=&gt;0, 64000=&gt;0, 80000=&gt;0, 96000=&gt;0, 112000=&gt;0, 128000=&gt;0, 160000=&gt;0, 192000=&gt;0, 224000=&gt;0, 256000=&gt;0, 320000=&gt;0);&nbsp;</div></li><li><div>                          } elseif ($info['mpeg']['audio']['layer'] == 2) {&nbsp;</div></li><li><div>                              $info['mpeg']['audio']['bitrate_distribution'] = array('free'=&gt;0, 32000=&gt;0, 48000=&gt;0, 56000=&gt;0, 64000=&gt;0, 80000=&gt;0, 96000=&gt;0, 112000=&gt;0, 128000=&gt;0, 160000=&gt;0, 192000=&gt;0, 224000=&gt;0, 256000=&gt;0, 320000=&gt;0, 384000=&gt;0);&nbsp;</div></li><li><div>                          } elseif ($info['mpeg']['audio']['layer'] == 1) {&nbsp;</div></li><li><div>                              $info['mpeg']['audio']['bitrate_distribution'] = array('free'=&gt;0, 32000=&gt;0, 64000=&gt;0, 96000=&gt;0, 128000=&gt;0, 160000=&gt;0, 192000=&gt;0, 224000=&gt;0, 256000=&gt;0, 288000=&gt;0, 320000=&gt;0, 352000=&gt;0, 384000=&gt;0, 416000=&gt;0, 448000=&gt;0);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } elseif ($info['mpeg']['audio']['layer'] == 1) {&nbsp;</div></li><li><div>                          $info['mpeg']['audio']['bitrate_distribution'] = array('free'=&gt;0, 32000=&gt;0, 48000=&gt;0, 56000=&gt;0, 64000=&gt;0, 80000=&gt;0, 96000=&gt;0, 112000=&gt;0, 128000=&gt;0, 144000=&gt;0, 160000=&gt;0, 176000=&gt;0, 192000=&gt;0, 224000=&gt;0, 256000=&gt;0);&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $info['mpeg']['audio']['bitrate_distribution'] = array('free'=&gt;0, 8000=&gt;0, 16000=&gt;0, 24000=&gt;0, 32000=&gt;0, 40000=&gt;0, 48000=&gt;0, 56000=&gt;0, 64000=&gt;0, 80000=&gt;0, 96000=&gt;0, 112000=&gt;0, 128000=&gt;0, 144000=&gt;0, 160000=&gt;0);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $dummy = array('error'=&gt;$info['error'], 'warning'=&gt;$info['warning'], 'avdataend'=&gt;$info['avdataend'], 'avdataoffset'=&gt;$info['avdataoffset']);&nbsp;</div></li><li><div>                      $synchstartoffset = $info['avdataoffset'];&nbsp;</div></li><li><div>                      $this-&gt;fseek($info['avdataoffset']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// you can play with these numbers:</span>&nbsp;</div></li><li><div>                      $max_frames_scan = 50000;&nbsp;</div></li><li><div>                      $max_scan_segments = 10;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// don't play with these numbers:</span>&nbsp;</div></li><li><div>                      $FastMode = false;&nbsp;</div></li><li><div>                      $SynchErrorsFound = 0;&nbsp;</div></li><li><div>                      $frames_scanned = 0;&nbsp;</div></li><li><div>                      $this_scan_segment = 0;&nbsp;</div></li><li><div>                      $frames_scan_per_segment = ceil($max_frames_scan / $max_scan_segments);&nbsp;</div></li><li><div>                      $pct_data_scanned = 0;&nbsp;</div></li><li><div>                      for ($current_segment = 0; $current_segment &lt; $max_scan_segments; $current_segment++) {&nbsp;</div></li><li><div>                          $frames_scanned_this_segment = 0;&nbsp;</div></li><li><div>                          if ($this-&gt;ftell() &gt;= $info['avdataend']) {&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $scan_start_offset[$current_segment] = max($this-&gt;ftell(), $info['avdataoffset'] + round($current_segment * (($info['avdataend'] - $info['avdataoffset']) / $max_scan_segments)));&nbsp;</div></li><li><div>                          if ($current_segment &gt; 0) {&nbsp;</div></li><li><div>                              $this-&gt;fseek($scan_start_offset[$current_segment]);&nbsp;</div></li><li><div>                              $buffer_4k = $this-&gt;fread(4096);&nbsp;</div></li><li><div>                              for ($j = 0; $j &lt; (strlen($buffer_4k) - 4); $j++) {&nbsp;</div></li><li><div>                                  if (($buffer_4k{$j} == &quot;\xFF&quot;) && ($buffer_4k{($j + 1)} &gt; &quot;\xE0&quot;)) { <span class="comment"><span class="comment">// synch detected</span></span>&nbsp;</div></li><li><div>                                      if ($this-&gt;decodeMPEGaudioHeader($scan_start_offset[$current_segment] + $j, $dummy, false, false, $FastMode)) {&nbsp;</div></li><li><div>                                          $calculated_next_offset = $scan_start_offset[$current_segment] + $j + $dummy['mpeg']['audio']['framelength'];&nbsp;</div></li><li><div>                                          if ($this-&gt;decodeMPEGaudioHeader($calculated_next_offset, $dummy, false, false, $FastMode)) {&nbsp;</div></li><li><div>                                              $scan_start_offset[$current_segment] += $j;&nbsp;</div></li><li><div>                                              break;&nbsp;</div></li><li><div>                                          }&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $synchstartoffset = $scan_start_offset[$current_segment];&nbsp;</div></li><li><div>                          while ($this-&gt;decodeMPEGaudioHeader($synchstartoffset, $dummy, false, false, $FastMode)) {&nbsp;</div></li><li><div>                              $FastMode = true;&nbsp;</div></li><li><div>                              $thisframebitrate = $MPEGaudioBitrateLookup[$MPEGaudioVersionLookup[$dummy['mpeg']['audio']['raw']['version']]][$MPEGaudioLayerLookup[$dummy['mpeg']['audio']['raw']['layer']]][$dummy['mpeg']['audio']['raw']['bitrate']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if (empty($dummy['mpeg']['audio']['framelength'])) {&nbsp;</div></li><li><div>                                  $SynchErrorsFound++;&nbsp;</div></li><li><div>                                  $synchstartoffset++;&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  getid3_lib::safe_inc($info['mpeg']['audio']['bitrate_distribution'][$thisframebitrate]);&nbsp;</div></li><li><div>                                  getid3_lib::safe_inc($info['mpeg']['audio']['stereo_distribution'][$dummy['mpeg']['audio']['channelmode']]);&nbsp;</div></li><li><div>                                  getid3_lib::safe_inc($info['mpeg']['audio']['version_distribution'][$dummy['mpeg']['audio']['version']]);&nbsp;</div></li><li><div>                                  $synchstartoffset += $dummy['mpeg']['audio']['framelength'];&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              $frames_scanned++;&nbsp;</div></li><li><div>                              if ($frames_scan_per_segment && (++$frames_scanned_this_segment &gt;= $frames_scan_per_segment)) {&nbsp;</div></li><li><div>                                  $this_pct_scanned = ($this-&gt;ftell() - $scan_start_offset[$current_segment]) / ($info['avdataend'] - $info['avdataoffset']);&nbsp;</div></li><li><div>                                  if (($current_segment == 0) && (($this_pct_scanned * $max_scan_segments) &gt;= 1)) {&nbsp;</div></li><li><div>                                      <span class="comment">// file likely contains &lt; $max_frames_scan, just scan as one segment</span>&nbsp;</div></li><li><div>                                      $max_scan_segments = 1;&nbsp;</div></li><li><div>                                      $frames_scan_per_segment = $max_frames_scan;&nbsp;</div></li><li><div>                                  } else {&nbsp;</div></li><li><div>                                      $pct_data_scanned += $this_pct_scanned;&nbsp;</div></li><li><div>                                      break;&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($pct_data_scanned &gt; 0) {&nbsp;</div></li><li><div>                          $info['warning'][] = 'too many MPEG audio frames to scan, only scanned '.$frames_scanned.' frames in '.$max_scan_segments.' segments ('.number_format($pct_data_scanned * 100, 1).'% of file) and extrapolated distribution, playtime and bitrate may be incorrect.';&nbsp;</div></li><li><div>                          foreach ($info['mpeg']['audio'] as $key1 =&gt; $value1) {&nbsp;</div></li><li><div>                              if (!preg_match('#_distribution$#i', $key1)) {&nbsp;</div></li><li><div>                                  continue;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              foreach ($value1 as $key2 =&gt; $value2) {&nbsp;</div></li><li><div>                                  $info['mpeg']['audio'][$key1][$key2] = round($value2 / $pct_data_scanned);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($SynchErrorsFound &gt; 0) {&nbsp;</div></li><li><div>                          $info['warning'][] = 'Found '.$SynchErrorsFound.' synch errors in histogram analysis';&nbsp;</div></li><li><div>                          <span class="comment">//return false;</span>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $bittotal = 0;&nbsp;</div></li><li><div>                      $framecounter = 0;&nbsp;</div></li><li><div>                      foreach ($info['mpeg']['audio']['bitrate_distribution'] as $bitratevalue =&gt; $bitratecount) {&nbsp;</div></li><li><div>                          $framecounter += $bitratecount;&nbsp;</div></li><li><div>                          if ($bitratevalue != 'free') {&nbsp;</div></li><li><div>                              $bittotal += ($bitratevalue * $bitratecount);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($framecounter == 0) {&nbsp;</div></li><li><div>                          $info['error'][] = 'Corrupt MP3 file: framecounter == zero';&nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $info['mpeg']['audio']['frame_count'] = getid3_lib::CastAsInt($framecounter);&nbsp;</div></li><li><div>                      $info['mpeg']['audio']['bitrate'] = ($bittotal / $framecounter);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $info['audio']['bitrate'] = $info['mpeg']['audio']['bitrate'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Definitively set VBR vs CBR, even if the Xing/LAME/VBRI header says differently</span>&nbsp;</div></li><li><div>                      $distinct_bitrates = 0;&nbsp;</div></li><li><div>                      foreach ($info['mpeg']['audio']['bitrate_distribution'] as $bitrate_value =&gt; $bitrate_count) {&nbsp;</div></li><li><div>                          if ($bitrate_count &gt; 0) {&nbsp;</div></li><li><div>                              $distinct_bitrates++;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($distinct_bitrates &gt; 1) {&nbsp;</div></li><li><div>                          $info['mpeg']['audio']['bitrate_mode'] = 'vbr';&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $info['mpeg']['audio']['bitrate_mode'] = 'cbr';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $info['audio']['bitrate_mode'] = $info['mpeg']['audio']['bitrate_mode'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break; <span class="comment">// exit while()</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $SynchSeekOffset++;&nbsp;</div></li><li><div>          if (($avdataoffset + $SynchSeekOffset) &gt;= $info['avdataend']) {&nbsp;</div></li><li><div>              <span class="comment">// end of file</span>/data&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (empty($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $info['error'][] = 'could not find valid MPEG synch before end of file';&nbsp;</div></li><li><div>                  if (isset($info['audio']['bitrate'])) {&nbsp;</div></li><li><div>                      unset($info['audio']['bitrate']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($info['mpeg']['audio'])) {&nbsp;</div></li><li><div>                      unset($info['mpeg']['audio']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (isset($info['mpeg']) && (!is_array($info['mpeg']) || empty($info['mpeg']))) {&nbsp;</div></li><li><div>                      unset($info['mpeg']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $info['audio']['channels'] = $info['mpeg']['audio']['channels'];&nbsp;</div></li><li><div>      $info['audio']['channelmode'] = $info['mpeg']['audio']['channelmode'];&nbsp;</div></li><li><div>      $info['audio']['sample_rate'] = $info['mpeg']['audio']['sample_rate'];&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioVersionArray() {&nbsp;</div></li><li><div>      static $MPEGaudioVersion = array('2.5', false, '2', '1');&nbsp;</div></li><li><div>      return $MPEGaudioVersion;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioLayerArray() {&nbsp;</div></li><li><div>      static $MPEGaudioLayer = array(false, 3, 2, 1);&nbsp;</div></li><li><div>      return $MPEGaudioLayer;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioBitrateArray() {&nbsp;</div></li><li><div>      static $MPEGaudioBitrate;&nbsp;</div></li><li><div>      if (empty($MPEGaudioBitrate)) {&nbsp;</div></li><li><div>          $MPEGaudioBitrate = array (&nbsp;</div></li><li><div>              '1' =&gt;  array (1 =&gt; array('free', 32000, 64000, 96000, 128000, 160000, 192000, 224000, 256000, 288000, 320000, 352000, 384000, 416000, 448000), &nbsp;</div></li><li><div>                              2 =&gt; array('free', 32000, 48000, 56000, 64000, 80000, 96000, 112000, 128000, 160000, 192000, 224000, 256000, 320000, 384000), &nbsp;</div></li><li><div>                              3 =&gt; array('free', 32000, 40000, 48000, 56000, 64000, 80000, 96000, 112000, 128000, 160000, 192000, 224000, 256000, 320000)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              '2' =&gt;  array (1 =&gt; array('free', 32000, 48000, 56000, 64000, 80000, 96000, 112000, 128000, 144000, 160000, 176000, 192000, 224000, 256000), &nbsp;</div></li><li><div>                              2 =&gt; array('free', 8000, 16000, 24000, 32000, 40000, 48000, 56000, 64000, 80000, 96000, 112000, 128000, 144000, 160000), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $MPEGaudioBitrate['2'][3] = $MPEGaudioBitrate['2'][2];&nbsp;</div></li><li><div>          $MPEGaudioBitrate['2.5'] = $MPEGaudioBitrate['2'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $MPEGaudioBitrate;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioFrequencyArray() {&nbsp;</div></li><li><div>      static $MPEGaudioFrequency;&nbsp;</div></li><li><div>      if (empty($MPEGaudioFrequency)) {&nbsp;</div></li><li><div>          $MPEGaudioFrequency = array (&nbsp;</div></li><li><div>              '1' =&gt; array(44100, 48000, 32000), &nbsp;</div></li><li><div>              '2' =&gt; array(22050, 24000, 16000), &nbsp;</div></li><li><div>              '2.5' =&gt; array(11025, 12000, 8000)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $MPEGaudioFrequency;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioChannelModeArray() {&nbsp;</div></li><li><div>      static $MPEGaudioChannelMode = array('stereo', 'joint stereo', 'dual channel', 'mono');&nbsp;</div></li><li><div>      return $MPEGaudioChannelMode;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioModeExtensionArray() {&nbsp;</div></li><li><div>      static $MPEGaudioModeExtension;&nbsp;</div></li><li><div>      if (empty($MPEGaudioModeExtension)) {&nbsp;</div></li><li><div>          $MPEGaudioModeExtension = array (&nbsp;</div></li><li><div>              1 =&gt; array('4-31', '8-31', '12-31', '16-31'), &nbsp;</div></li><li><div>              2 =&gt; array('4-31', '8-31', '12-31', '16-31'), &nbsp;</div></li><li><div>              3 =&gt; array('', 'IS', 'MS', 'IS+MS')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $MPEGaudioModeExtension;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioEmphasisArray() {&nbsp;</div></li><li><div>      static $MPEGaudioEmphasis = array('none', '50/15ms', false, 'CCIT J.17');&nbsp;</div></li><li><div>      return $MPEGaudioEmphasis;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioHeaderBytesValid($head4, $allowBitrate15=false) {&nbsp;</div></li><li><div>      return self::MPEGaudioHeaderValid(self::MPEGaudioHeaderDecode($head4), false, $allowBitrate15);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioHeaderValid($rawarray, $echoerrors=false, $allowBitrate15=false) {&nbsp;</div></li><li><div>      if (($rawarray['synch'] & 0x0FFE) != 0x0FFE) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      static $MPEGaudioVersionLookup;&nbsp;</div></li><li><div>      static $MPEGaudioLayerLookup;&nbsp;</div></li><li><div>      static $MPEGaudioBitrateLookup;&nbsp;</div></li><li><div>      static $MPEGaudioFrequencyLookup;&nbsp;</div></li><li><div>      static $MPEGaudioChannelModeLookup;&nbsp;</div></li><li><div>      static $MPEGaudioModeExtensionLookup;&nbsp;</div></li><li><div>      static $MPEGaudioEmphasisLookup;&nbsp;</div></li><li><div>      if (empty($MPEGaudioVersionLookup)) {&nbsp;</div></li><li><div>          $MPEGaudioVersionLookup = self::MPEGaudioVersionArray();&nbsp;</div></li><li><div>          $MPEGaudioLayerLookup = self::MPEGaudioLayerArray();&nbsp;</div></li><li><div>          $MPEGaudioBitrateLookup = self::MPEGaudioBitrateArray();&nbsp;</div></li><li><div>          $MPEGaudioFrequencyLookup = self::MPEGaudioFrequencyArray();&nbsp;</div></li><li><div>          $MPEGaudioChannelModeLookup = self::MPEGaudioChannelModeArray();&nbsp;</div></li><li><div>          $MPEGaudioModeExtensionLookup = self::MPEGaudioModeExtensionArray();&nbsp;</div></li><li><div>          $MPEGaudioEmphasisLookup = self::MPEGaudioEmphasisArray();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($MPEGaudioVersionLookup[$rawarray['version']])) {&nbsp;</div></li><li><div>          $decodedVersion = $MPEGaudioVersionLookup[$rawarray['version']];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid Version ('.$rawarray['version'].')' : '');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($MPEGaudioLayerLookup[$rawarray['layer']])) {&nbsp;</div></li><li><div>          $decodedLayer = $MPEGaudioLayerLookup[$rawarray['layer']];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid Layer ('.$rawarray['layer'].')' : '');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($MPEGaudioBitrateLookup[$decodedVersion][$decodedLayer][$rawarray['bitrate']])) {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid Bitrate ('.$rawarray['bitrate'].')' : '');&nbsp;</div></li><li><div>          if ($rawarray['bitrate'] == 15) {&nbsp;</div></li><li><div>              <span class="comment">// known issue in LAME 3.90 - 3.93.1 where free-format has bitrate ID of 15 instead of 0</span>&nbsp;</div></li><li><div>              <span class="comment">// let it go through here otherwise file will not be identified</span>&nbsp;</div></li><li><div>              if (!$allowBitrate15) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($MPEGaudioFrequencyLookup[$decodedVersion][$rawarray['sample_rate']])) {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid Frequency ('.$rawarray['sample_rate'].')' : '');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($MPEGaudioChannelModeLookup[$rawarray['channelmode']])) {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid ChannelMode ('.$rawarray['channelmode'].')' : '');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($MPEGaudioModeExtensionLookup[$decodedLayer][$rawarray['modeextension']])) {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid Mode Extension ('.$rawarray['modeextension'].')' : '');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($MPEGaudioEmphasisLookup[$rawarray['emphasis']])) {&nbsp;</div></li><li><div>          echo ($echoerrors ? &quot;\n&quot;.'invalid Emphasis ('.$rawarray['emphasis'].')' : '');&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// These are just either set or not set, you can't mess that up :)</span>&nbsp;</div></li><li><div>      <span class="comment">// $rawarray['protection'];</span>&nbsp;</div></li><li><div>      <span class="comment">// $rawarray['padding'];</span>&nbsp;</div></li><li><div>      <span class="comment">// $rawarray['private'];</span>&nbsp;</div></li><li><div>      <span class="comment">// $rawarray['copyright'];</span>&nbsp;</div></li><li><div>      <span class="comment">// $rawarray['original'];</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioHeaderDecode($Header4Bytes) {&nbsp;</div></li><li><div>      <span class="comment">// AAAA AAAA  AAAB BCCD  EEEE FFGH  IIJJ KLMM</span>&nbsp;</div></li><li><div>      <span class="comment">// A - Frame sync (all bits set)</span>&nbsp;</div></li><li><div>      <span class="comment">// B - MPEG Audio version ID</span>&nbsp;</div></li><li><div>      <span class="comment">// C - Layer description</span>&nbsp;</div></li><li><div>      <span class="comment">// D - Protection bit</span>&nbsp;</div></li><li><div>      <span class="comment">// E - Bitrate index</span>&nbsp;</div></li><li><div>      <span class="comment">// F - Sampling rate frequency index</span>&nbsp;</div></li><li><div>      <span class="comment">// G - Padding bit</span>&nbsp;</div></li><li><div>      <span class="comment">// H - Private bit</span>&nbsp;</div></li><li><div>      <span class="comment">// I - Channel Mode</span>&nbsp;</div></li><li><div>      <span class="comment">// J - Mode extension (Only if Joint stereo)</span>&nbsp;</div></li><li><div>      <span class="comment">// K - Copyright</span>&nbsp;</div></li><li><div>      <span class="comment">// L - Original</span>&nbsp;</div></li><li><div>      <span class="comment">// M - Emphasis</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (strlen($Header4Bytes) != 4) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $MPEGrawHeader['synch'] = (getid3_lib::BigEndian2Int(substr($Header4Bytes, 0, 2)) & 0xFFE0) &gt;&gt; 4;&nbsp;</div></li><li><div>      $MPEGrawHeader['version'] = (ord($Header4Bytes{1}) & 0x18) &gt;&gt; 3; <span class="comment">//    BB</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['layer'] = (ord($Header4Bytes{1}) & 0x06) &gt;&gt; 1; <span class="comment">//      CC</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['protection'] = (ord($Header4Bytes{1}) & 0x01);      <span class="comment">//        D</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['bitrate'] = (ord($Header4Bytes{2}) & 0xF0) &gt;&gt; 4; <span class="comment">// EEEE</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['sample_rate'] = (ord($Header4Bytes{2}) & 0x0C) &gt;&gt; 2; <span class="comment">//     FF</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['padding'] = (ord($Header4Bytes{2}) & 0x02) &gt;&gt; 1; <span class="comment">//       G</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['private'] = (ord($Header4Bytes{2}) & 0x01);      <span class="comment">//        H</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['channelmode'] = (ord($Header4Bytes{3}) & 0xC0) &gt;&gt; 6; <span class="comment">// II</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['modeextension'] = (ord($Header4Bytes{3}) & 0x30) &gt;&gt; 4; <span class="comment">//   JJ</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['copyright'] = (ord($Header4Bytes{3}) & 0x08) &gt;&gt; 3; <span class="comment">//     K</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['original'] = (ord($Header4Bytes{3}) & 0x04) &gt;&gt; 2; <span class="comment">//      L</span>&nbsp;</div></li><li><div>      $MPEGrawHeader['emphasis'] = (ord($Header4Bytes{3}) & 0x03);      <span class="comment">//       MM</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $MPEGrawHeader;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function MPEGaudioFrameLength(&$bitrate, &$version, &$layer, $padding, &$samplerate) {&nbsp;</div></li><li><div>      static $AudioFrameLengthCache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($AudioFrameLengthCache[$bitrate][$version][$layer][$padding][$samplerate])) {&nbsp;</div></li><li><div>          $AudioFrameLengthCache[$bitrate][$version][$layer][$padding][$samplerate] = false;&nbsp;</div></li><li><div>          if ($bitrate != 'free') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($version == '1') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($layer == '1') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// For Layer I slot is 32 bits long</span></span>&nbsp;</div></li><li><div>                      $FrameLengthCoefficient = 48;&nbsp;</div></li><li><div>                      $SlotLength = 4;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else { <span class="comment">// Layer 2 / 3</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">// for Layer 2 and Layer 3 slot is 8 bits long.</span></span></span>&nbsp;</div></li><li><div>                      $FrameLengthCoefficient = 144;&nbsp;</div></li><li><div>                      $SlotLength = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else { <span class="comment">// MPEG-2 / MPEG-2.5</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($layer == '1') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// For Layer I slot is 32 bits long</span></span>&nbsp;</div></li><li><div>                      $FrameLengthCoefficient = 24;&nbsp;</div></li><li><div>                      $SlotLength = 4;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } elseif ($layer == '2') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">// for Layer 2 and Layer 3 slot is 8 bits long.</span></span></span>&nbsp;</div></li><li><div>                      $FrameLengthCoefficient = 144;&nbsp;</div></li><li><div>                      $SlotLength = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else { <span class="comment">// layer 3</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">// for Layer 2 and Layer 3 slot is 8 bits long.</span></span></span>&nbsp;</div></li><li><div>                      $FrameLengthCoefficient = 72;&nbsp;</div></li><li><div>                      $SlotLength = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// FrameLengthInBytes = ((Coefficient * BitRate) / SampleRate) + Padding</span>&nbsp;</div></li><li><div>              if ($samplerate &gt; 0) {&nbsp;</div></li><li><div>                  $NewFramelength = ($FrameLengthCoefficient * $bitrate) / $samplerate;&nbsp;</div></li><li><div>                  $NewFramelength = floor($NewFramelength / $SlotLength) * $SlotLength; <span class="comment">// round to next-lower multiple of SlotLength (1 byte for Layer 2/3, 4 bytes for Layer I)</span>&nbsp;</div></li><li><div>                  if ($padding) {&nbsp;</div></li><li><div>                      $NewFramelength += $SlotLength;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $AudioFrameLengthCache[$bitrate][$version][$layer][$padding][$samplerate] = (int) $NewFramelength;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $AudioFrameLengthCache[$bitrate][$version][$layer][$padding][$samplerate];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function ClosestStandardMP3Bitrate($bit_rate) {&nbsp;</div></li><li><div>      static $standard_bit_rates = array (320000, 256000, 224000, 192000, 160000, 128000, 112000, 96000, 80000, 64000, 56000, 48000, 40000, 32000, 24000, 16000, 8000);&nbsp;</div></li><li><div>      static $bit_rate_table = array (0=&gt;'-');&nbsp;</div></li><li><div>      $round_bit_rate = intval(round($bit_rate, -3));&nbsp;</div></li><li><div>      if (!isset($bit_rate_table[$round_bit_rate])) {&nbsp;</div></li><li><div>          if ($round_bit_rate &gt; max($standard_bit_rates)) {&nbsp;</div></li><li><div>              $bit_rate_table[$round_bit_rate] = round($bit_rate, 2 - strlen($bit_rate));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $bit_rate_table[$round_bit_rate] = max($standard_bit_rates);&nbsp;</div></li><li><div>              foreach ($standard_bit_rates as $standard_bit_rate) {&nbsp;</div></li><li><div>                  if ($round_bit_rate &gt;= $standard_bit_rate + (($bit_rate_table[$round_bit_rate] - $standard_bit_rate) / 2)) {&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $bit_rate_table[$round_bit_rate] = $standard_bit_rate;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $bit_rate_table[$round_bit_rate];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function XingVBRidOffset($version, $channelmode) {&nbsp;</div></li><li><div>      static $XingVBRidOffsetCache = array();&nbsp;</div></li><li><div>      if (empty($XingVBRidOffset)) {&nbsp;</div></li><li><div>          $XingVBRidOffset = array (&nbsp;</div></li><li><div>              '1' =&gt; array ('mono' =&gt; 0x15, <span class="comment"><span class="comment">// 4 + 17 = 21</span></span>&nbsp;</div></li><li><div>                              'stereo' =&gt; 0x24, <span class="comment">// 4 + 32 = 36</span>&nbsp;</div></li><li><div>                              'joint stereo' =&gt; 0x24, &nbsp;</div></li><li><div>                              'dual channel' =&gt; 0x24&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              '2' =&gt; array ('mono' =&gt; 0x0D, <span class="comment">// 4 +  9 = 13</span>&nbsp;</div></li><li><div>                              'stereo' =&gt; 0x15, <span class="comment"><span class="comment">// 4 + 17 = 21</span></span>&nbsp;</div></li><li><div>                              'joint stereo' =&gt; 0x15, &nbsp;</div></li><li><div>                              'dual channel' =&gt; 0x15&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              '2.5' =&gt; array ('mono' =&gt; 0x15, &nbsp;</div></li><li><div>                              'stereo' =&gt; 0x15, &nbsp;</div></li><li><div>                              'joint stereo' =&gt; 0x15, &nbsp;</div></li><li><div>                              'dual channel' =&gt; 0x15&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $XingVBRidOffset[$version][$channelmode];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function LAMEvbrMethodLookup($VBRmethodID) {&nbsp;</div></li><li><div>      static $LAMEvbrMethodLookup = array(&nbsp;</div></li><li><div>          0x00 =&gt; 'unknown', &nbsp;</div></li><li><div>          0x01 =&gt; 'cbr', &nbsp;</div></li><li><div>          0x02 =&gt; 'abr', &nbsp;</div></li><li><div>          0x03 =&gt; 'vbr-old / vbr-rh', &nbsp;</div></li><li><div>          0x04 =&gt; 'vbr-new / vbr-mtrh', &nbsp;</div></li><li><div>          0x05 =&gt; 'vbr-mt', &nbsp;</div></li><li><div>          0x06 =&gt; 'vbr (full vbr method 4)', &nbsp;</div></li><li><div>          0x08 =&gt; 'cbr (constant bitrate 2 pass)', &nbsp;</div></li><li><div>          0x09 =&gt; 'abr (2 pass)', &nbsp;</div></li><li><div>          0x0F =&gt; 'reserved'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return (isset($LAMEvbrMethodLookup[$VBRmethodID]) ? $LAMEvbrMethodLookup[$VBRmethodID] : '');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function LAMEmiscStereoModeLookup($StereoModeID) {&nbsp;</div></li><li><div>      static $LAMEmiscStereoModeLookup = array(&nbsp;</div></li><li><div>          0 =&gt; 'mono', &nbsp;</div></li><li><div>          1 =&gt; 'stereo', &nbsp;</div></li><li><div>          2 =&gt; 'dual mono', &nbsp;</div></li><li><div>          3 =&gt; 'joint stereo', &nbsp;</div></li><li><div>          4 =&gt; 'forced stereo', &nbsp;</div></li><li><div>          5 =&gt; 'auto', &nbsp;</div></li><li><div>          6 =&gt; 'intensity stereo', &nbsp;</div></li><li><div>          7 =&gt; 'other'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return (isset($LAMEmiscStereoModeLookup[$StereoModeID]) ? $LAMEmiscStereoModeLookup[$StereoModeID] : '');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function LAMEmiscSourceSampleFrequencyLookup($SourceSampleFrequencyID) {&nbsp;</div></li><li><div>      static $LAMEmiscSourceSampleFrequencyLookup = array(&nbsp;</div></li><li><div>          0 =&gt; '&lt;= 32 kHz', &nbsp;</div></li><li><div>          1 =&gt; '44.1 kHz', &nbsp;</div></li><li><div>          2 =&gt; '48 kHz', &nbsp;</div></li><li><div>          3 =&gt; '&gt; 48kHz'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return (isset($LAMEmiscSourceSampleFrequencyLookup[$SourceSampleFrequencyID]) ? $LAMEmiscSourceSampleFrequencyLookup[$SourceSampleFrequencyID] : '');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function LAMEsurroundInfoLookup($SurroundInfoID) {&nbsp;</div></li><li><div>      static $LAMEsurroundInfoLookup = array(&nbsp;</div></li><li><div>          0 =&gt; 'no surround info', &nbsp;</div></li><li><div>          1 =&gt; 'DPL encoding', &nbsp;</div></li><li><div>          2 =&gt; 'DPL2 encoding', &nbsp;</div></li><li><div>          3 =&gt; 'Ambisonic encoding'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      return (isset($LAMEsurroundInfoLookup[$SurroundInfoID]) ? $LAMEsurroundInfoLookup[$SurroundInfoID] : 'reserved');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function LAMEpresetUsedLookup($LAMEtag) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($LAMEtag['preset_used_id'] == 0) {&nbsp;</div></li><li><div>          <span class="comment">// no preset used (LAME &gt;=3.93)</span>&nbsp;</div></li><li><div>          <span class="comment">// no preset recorded (LAME &lt;3.93)</span>&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/////  THIS PART CANNOT BE STATIC .</span>&nbsp;</div></li><li><div>      for ($i = 8; $i &lt;= 320; $i++) {&nbsp;</div></li><li><div>          switch ($LAMEtag['vbr_method']) {&nbsp;</div></li><li><div>              case 'cbr':&nbsp;</div></li><li><div>                  $LAMEpresetUsedLookup[$i] = '--alt-preset '.$LAMEtag['vbr_method'].' '.$i;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'abr':&nbsp;</div></li><li><div>              default: <span class="comment">// other VBR modes shouldn't be here(?)</span>&nbsp;</div></li><li><div>                  $LAMEpresetUsedLookup[$i] = '--alt-preset '.$i;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// named old-style presets (studio, phone, voice, etc) are handled in GuessEncoderOptions()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// named alt-presets</span>&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1000] = '--r3mix';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1001] = '--alt-preset standard';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1002] = '--alt-preset extreme';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1003] = '--alt-preset insane';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1004] = '--alt-preset fast standard';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1005] = '--alt-preset fast extreme';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1006] = '--alt-preset medium';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1007] = '--alt-preset fast medium';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// LAME 3.94 additions/changes</span>&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1010] = '--preset portable';                                                           <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Oct 21 2003&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[1015] = '--preset radio';                                                              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Oct 21 2003&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[320] = '--preset insane';                                                             <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Nov 12 2003&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[410] = '-V9';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[420] = '-V8';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[440] = '-V6';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[430] = '--preset radio';                                                              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Nov 12 2003&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[450] = '--preset '.(($LAMEtag['raw']['vbr_method'] == 4) ? 'fast ' : '').'portable';  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Nov 12 2003&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[460] = '--preset '.(($LAMEtag['raw']['vbr_method'] == 4) ? 'fast ' : '').'medium';    <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Nov 12 2003&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[470] = '--r3mix';                                                                     <span class="comment">// 3.94b1  Dec 18 2003</span>&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[480] = '--preset '.(($LAMEtag['raw']['vbr_method'] == 4) ? 'fast ' : '').'standard';  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Nov 12 2003&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[490] = '-V1';&nbsp;</div></li><li><div>      $LAMEpresetUsedLookup[500] = '--preset '.(($LAMEtag['raw']['vbr_method'] == 4) ? 'fast ' : '').'extreme';   <span class="comment"><span class="comment"><span class="comment"><span class="comment">// 3.94a15</span></span></span></span> Nov 12 2003&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (isset($LAMEpresetUsedLookup[$LAMEtag['preset_used_id']]) ? $LAMEpresetUsedLookup[$LAMEtag['preset_used_id']] : 'new/unknown preset: '.$LAMEtag['preset_used_id'].' - report to info@getid3.org');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-include</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>