<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.4" data-type="file" data-id="4417"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-admin-custom-header | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=855b3485e395ec4269dcefad63c13446' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-admin-custom-header/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-custom-header%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-custom-header%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.4-file-wp-admin-custom-header","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-admin-custom-header" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.4." href="http://hookr.io/4.7.4/" class="H_VERSION"><span property="name">4.7.4</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-admin-custom-header</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6316"><a href="http://hookr.io/4.7.4/all/" title="All">All <span class="count badge">6316</span></a></li><li class="" data-id="new" data-count="6"><a href="http://hookr.io/4.7.4/new/" title="New">New <span class="count badge">6</span></a></li><li class="" data-id="hooks" data-count="2538"><a href="http://hookr.io/4.7.4/hooks/" title="Hooks">Hooks <span class="count badge">2538</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.4/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1674"><a href="http://hookr.io/4.7.4/filters/" title="Filters">Filters <span class="count badge">1674</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.4/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.4/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2853"><a href="http://hookr.io/4.7.4/functions/" title="Functions">Functions <span class="count badge">2853</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-admin/custom-header.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The custom header image script.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The custom header image class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Custom_Image_Header {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Callback for administration header.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var callable</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $admin_header_callback;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Callback for header div.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var callable</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $admin_image_div_callback;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds default headers.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $default_headers = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Used to trigger a success message when settings updated and set to true.</span>&nbsp;</div></li><li><div><span class="comment">    *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $updated;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor - Register administration header callback.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param callable $admin_header_callback</span>&nbsp;</div></li><li><div><span class="comment">   * @param callable $admin_image_div_callback Optional custom image div output callback.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($admin_header_callback, $admin_image_div_callback = '') {&nbsp;</div></li><li><div>      $this-&gt;admin_header_callback = $admin_header_callback;&nbsp;</div></li><li><div>      $this-&gt;admin_image_div_callback = $admin_image_div_callback;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'admin_menu', array( $this, 'init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'customize_save_after', array( $this, 'customize_set_last_used' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_custom-header-crop', array( $this, 'ajax_header_crop' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_custom-header-add', array( $this, 'ajax_header_add' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_custom-header-remove', array( $this, 'ajax_header_remove' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up the hooks for the Custom Header admin page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init() {&nbsp;</div></li><li><div>      $page = add_theme_page( __( 'Header' ), __( 'Header' ), 'edit_theme_options', 'custom-header', array( $this, 'admin_page' ) );&nbsp;</div></li><li><div>      if ( ! $page ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( &quot;admin_print_scripts-$page&quot;, array( $this, 'js_includes' ) );&nbsp;</div></li><li><div>      add_action( &quot;admin_print_styles-$page&quot;, array( $this, 'css_includes' ) );&nbsp;</div></li><li><div>      add_action( &quot;admin_head-$page&quot;, array( $this, 'help' ) );&nbsp;</div></li><li><div>      add_action( &quot;admin_head-$page&quot;, array( $this, 'take_action' ), 50 );&nbsp;</div></li><li><div>      add_action( &quot;admin_head-$page&quot;, array( $this, 'js' ), 50 );&nbsp;</div></li><li><div>      if ( $this-&gt;admin_header_callback ) {&nbsp;</div></li><li><div>          add_action( &quot;admin_head-$page&quot;, $this-&gt;admin_header_callback, 51 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds contextual help.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function help() {&nbsp;</div></li><li><div>      get_current_screen()-&gt;add_help_tab( array(&nbsp;</div></li><li><div>          'id' =&gt; 'overview', &nbsp;</div></li><li><div>          'title' =&gt; __('Overview'), &nbsp;</div></li><li><div>          'content' =&gt;&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'This screen is used to customize the header section of your theme.') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'You can choose from the theme&#8217;s default header images, or use one of your own. You can also customize how your Site Title and Tagline are displayed.') . '&lt;p&gt;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      get_current_screen()-&gt;add_help_tab( array(&nbsp;</div></li><li><div>          'id' =&gt; 'set-header-image', &nbsp;</div></li><li><div>          'title' =&gt; __('Header Image'), &nbsp;</div></li><li><div>          'content' =&gt;&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'You can set a custom image header for your site. Simply upload the image and crop it, and the new header will go live immediately. Alternatively, you can use an image that has already been uploaded to your Media Library by clicking the &#8220;Choose Image&#8221; button.' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'Some themes come with additional header images bundled. If you see multiple images displayed, select the one you&#8217;d like and click the &#8220;Save Changes&#8221; button.' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'If your theme has more than one default header image, or you have uploaded more than one custom header image, you have the option of having WordPress display a randomly different image on each page of your site. Click the &#8220;Random&#8221; radio button next to the Uploaded Images or Default Images section to enable this feature.') . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'If you don&#8217;t want a header image to be displayed on your site at all, click the &#8220;Remove Header Image&#8221; button at the bottom of the Header Image section of this page. If you want to re-enable the header image later, you just have to select one of the other image options and click &#8220;Save Changes&#8221;.') . '&lt;/p&gt;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      get_current_screen()-&gt;add_help_tab( array(&nbsp;</div></li><li><div>          'id' =&gt; 'set-header-text', &nbsp;</div></li><li><div>          'title' =&gt; __('Header Text'), &nbsp;</div></li><li><div>          'content' =&gt;&nbsp;</div></li><li><div>              '&lt;p&gt;' . sprintf( __( 'For most themes, the header text is your Site Title and Tagline, as defined in the &lt;a href=&quot;%1$s&quot;&gt;General Settings&lt;/a&gt; section.' ), admin_url( 'options-general.php' ) ) . '&lt;p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'In the Header Text section of this page, you can choose whether to display this text or hide it. You can also choose a color for the text by clicking the Select Color button and either typing in a legitimate HTML hex value, e.g. &#8220;#ff0000&#8221; for red, or by choosing a color using the color picker.' ) . '&lt;/p&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'Don&#8217;t forget to click &#8220;Save Changes&#8221; when you&#8217;re done!') . '&lt;/p&gt;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      get_current_screen()-&gt;set_help_sidebar(&nbsp;</div></li><li><div>          '&lt;p&gt;&lt;strong&gt;' . __( 'For more information:' ) . '&lt;/strong&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>          '&lt;p&gt;' . __( '&lt;a href=&quot;https:<span class="comment">//codex.wordpress.org/Appearance_Header_Screen&quot;&gt;Documentation on Custom Header&lt;/a&gt;' ) . '&lt;/p&gt;' .</span>&nbsp;</div></li><li><div>          '&lt;p&gt;' . __( '&lt;a href=&quot;https:<span class="comment">//wordpress.org/support/&quot;&gt;Support Forums&lt;/a&gt;' ) . '&lt;/p&gt;'</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the current step.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int Current step</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function step() {&nbsp;</div></li><li><div>      if ( ! isset( $_GET['step'] ) )&nbsp;</div></li><li><div>          return 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $step = (int) $_GET['step'];&nbsp;</div></li><li><div>      if ( $step &lt; 1 || 3 &lt; $step ||&nbsp;</div></li><li><div>          ( 2 == $step && ! wp_verify_nonce( $_REQUEST['_wpnonce-custom-header-upload'], 'custom-header-upload' ) ) ||&nbsp;</div></li><li><div>          ( 3 == $step && ! wp_verify_nonce( $_REQUEST['_wpnonce'], 'custom-header-crop-image' ) )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div>          return 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $step;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up the enqueue for the JavaScript files.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function js_includes() {&nbsp;</div></li><li><div>      $step = $this-&gt;step();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( 1 == $step || 3 == $step ) ) {&nbsp;</div></li><li><div>          wp_enqueue_media();&nbsp;</div></li><li><div>          wp_enqueue_script( 'custom-header' );&nbsp;</div></li><li><div>          if ( current_theme_supports( 'custom-header', 'header-text' ) )&nbsp;</div></li><li><div>              wp_enqueue_script( 'wp-color-picker' );&nbsp;</div></li><li><div>      } elseif ( 2 == $step ) {&nbsp;</div></li><li><div>          wp_enqueue_script('imgareaselect');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up the enqueue for the CSS files</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function css_includes() {&nbsp;</div></li><li><div>      $step = $this-&gt;step();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( 1 == $step || 3 == $step ) && current_theme_supports( 'custom-header', 'header-text' ) )&nbsp;</div></li><li><div>          wp_enqueue_style( 'wp-color-picker' );&nbsp;</div></li><li><div>      elseif ( 2 == $step )&nbsp;</div></li><li><div>          wp_enqueue_style('imgareaselect');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Execute custom header modification.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function take_action() {&nbsp;</div></li><li><div>      if ( ! current_user_can('edit_theme_options') )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $_POST ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;updated = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['resetheader'] ) ) {&nbsp;</div></li><li><div>          check_admin_referer( 'custom-header-options', '_wpnonce-custom-header-options' );&nbsp;</div></li><li><div>          $this-&gt;reset_header_image();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['removeheader'] ) ) {&nbsp;</div></li><li><div>          check_admin_referer( 'custom-header-options', '_wpnonce-custom-header-options' );&nbsp;</div></li><li><div>          $this-&gt;remove_header_image();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['text-color'] ) && ! isset( $_POST['display-header-text'] ) ) {&nbsp;</div></li><li><div>          check_admin_referer( 'custom-header-options', '_wpnonce-custom-header-options' );&nbsp;</div></li><li><div>          set_theme_mod( 'header_textcolor', 'blank' );&nbsp;</div></li><li><div>      } elseif ( isset( $_POST['text-color'] ) ) {&nbsp;</div></li><li><div>          check_admin_referer( 'custom-header-options', '_wpnonce-custom-header-options' );&nbsp;</div></li><li><div>          $_POST['text-color'] = str_replace( '#', '', $_POST['text-color'] );&nbsp;</div></li><li><div>          $color = preg_replace('/[^0-9a-fA-F]/', '', $_POST['text-color']);&nbsp;</div></li><li><div>          if ( strlen($color) == 6 || strlen($color) == 3 )&nbsp;</div></li><li><div>              set_theme_mod('header_textcolor', $color);&nbsp;</div></li><li><div>          elseif ( ! $color )&nbsp;</div></li><li><div>              set_theme_mod( 'header_textcolor', 'blank' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['default-header'] ) ) {&nbsp;</div></li><li><div>          check_admin_referer( 'custom-header-options', '_wpnonce-custom-header-options' );&nbsp;</div></li><li><div>          $this-&gt;set_header_image( $_POST['default-header'] );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the default headers</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @global array $_wp_default_headers</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_default_headers() {&nbsp;</div></li><li><div>      global $_wp_default_headers;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !isset($_wp_default_headers) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;default_headers ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;default_headers = $_wp_default_headers;&nbsp;</div></li><li><div>      $template_directory_uri = get_template_directory_uri();&nbsp;</div></li><li><div>      $stylesheet_directory_uri = get_stylesheet_directory_uri();&nbsp;</div></li><li><div>      foreach ( array_keys($this-&gt;default_headers) as $header ) {&nbsp;</div></li><li><div>          $this-&gt;default_headers[$header]['url'] =  sprintf( $this-&gt;default_headers[$header]['url'], $template_directory_uri, $stylesheet_directory_uri );&nbsp;</div></li><li><div>          $this-&gt;default_headers[$header]['thumbnail_url'] =  sprintf( $this-&gt;default_headers[$header]['thumbnail_url'], $template_directory_uri, $stylesheet_directory_uri );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display UI for selecting one of several default headers.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Show the random image option if this theme has multiple header images.</span>&nbsp;</div></li><li><div><span class="comment">   * Random image option is on by default if no header has been set.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type The header type. One of 'default' (for the Uploaded Images control)</span>&nbsp;</div></li><li><div><span class="comment">   *                     or 'uploaded' (for the Uploaded Images control).</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function show_header_selector( $type = 'default' ) {&nbsp;</div></li><li><div>      if ( 'default' == $type ) {&nbsp;</div></li><li><div>          $headers = $this-&gt;default_headers;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $headers = get_uploaded_header_images();&nbsp;</div></li><li><div>          $type = 'uploaded';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 1 &lt; count( $headers ) ) {&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;random-header&quot;&gt;';&nbsp;</div></li><li><div>          echo '&lt;label&gt;&lt;input name=&quot;default-header&quot; type=&quot;radio&quot; value=&quot;random-' . $type . '-image&quot;' . checked( is_random_header_image( $type ), true, false ) . ' /&gt;';&nbsp;</div></li><li><div>          _e( '&lt;strong&gt;Random:&lt;/strong&gt; Show a different image on each page.' );&nbsp;</div></li><li><div>          echo '&lt;/label&gt;';&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;available-headers&quot;&gt;';&nbsp;</div></li><li><div>      foreach ( $headers as $header_key =&gt; $header ) {&nbsp;</div></li><li><div>          $header_thumbnail = $header['thumbnail_url'];&nbsp;</div></li><li><div>          $header_url = $header['url'];&nbsp;</div></li><li><div>          $header_alt_text = empty( $header['alt_text'] ) ? '' : $header['alt_text'];&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;default-header&quot;&gt;';&nbsp;</div></li><li><div>          echo '&lt;label&gt;&lt;input name=&quot;default-header&quot; type=&quot;radio&quot; value=&quot;' . esc_attr( $header_key ) . '&quot; ' . checked( $header_url, get_theme_mod( 'header_image' ), false ) . ' /&gt;';&nbsp;</div></li><li><div>          $width = '';&nbsp;</div></li><li><div>          if ( !empty( $header['attachment_id'] ) )&nbsp;</div></li><li><div>              $width = ' width=&quot;230&quot;';&nbsp;</div></li><li><div>          echo '&lt;img src=&quot;' . set_url_scheme( $header_thumbnail ) . '&quot; alt=&quot;' . esc_attr( $header_alt_text ) .'&quot;' . $width . ' /&gt;&lt;/label&gt;';&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Execute JavaScript depending on step.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function js() {&nbsp;</div></li><li><div>      $step = $this-&gt;step();&nbsp;</div></li><li><div>      if ( ( 1 == $step || 3 == $step ) && current_theme_supports( 'custom-header', 'header-text' ) )&nbsp;</div></li><li><div>          $this-&gt;js_1();&nbsp;</div></li><li><div>      elseif ( 2 == $step )&nbsp;</div></li><li><div>          $this-&gt;js_2();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display JavaScript based on Step 1 and 3.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function js_1() {&nbsp;</div></li><li><div>      $default_color = '';&nbsp;</div></li><li><div>      if ( current_theme_supports( 'custom-header', 'default-text-color' ) ) {&nbsp;</div></li><li><div>          $default_color = get_theme_support( 'custom-header', 'default-text-color' );&nbsp;</div></li><li><div>          if ( $default_color && false === strpos( $default_color, '#' ) ) {&nbsp;</div></li><li><div>              $default_color = '#' . $default_color;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>(function($) {&nbsp;</div></li><li><div>  var default_color = '&lt;?php echo $default_color; ?&gt;', &nbsp;</div></li><li><div>      header_text_fields;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function pickColor(color) {&nbsp;</div></li><li><div>      $('#name').css('color', color);&nbsp;</div></li><li><div>      $('#desc').css('color', color);&nbsp;</div></li><li><div>      $('#text-color').val(color);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function toggle_text() {&nbsp;</div></li><li><div>      var checked = $('#display-header-text').prop('checked'), &nbsp;</div></li><li><div>          text_color;&nbsp;</div></li><li><div>      header_text_fields.toggle( checked );&nbsp;</div></li><li><div>      if ( ! checked )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      text_color = $('#text-color');&nbsp;</div></li><li><div>      if ( '' == text_color.val().replace('#', '') ) {&nbsp;</div></li><li><div>          text_color.val( default_color );&nbsp;</div></li><li><div>          pickColor( default_color );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          pickColor( text_color.val() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $(document).ready(function() {&nbsp;</div></li><li><div>      var text_color = $('#text-color');&nbsp;</div></li><li><div>      header_text_fields = $('.displaying-header-text');&nbsp;</div></li><li><div>      text_color.wpColorPicker({&nbsp;</div></li><li><div>          change: function( event, ui ) {&nbsp;</div></li><li><div>              pickColor( text_color.wpColorPicker('color') );&nbsp;</div></li><li><div>          }, &nbsp;</div></li><li><div>          clear: function() {&nbsp;</div></li><li><div>              pickColor( '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>      $('#display-header-text').click( toggle_text );&nbsp;</div></li><li><div>      &lt;?php if ( ! display_header_text() ) : ?&gt;&nbsp;</div></li><li><div>      toggle_text();&nbsp;</div></li><li><div>      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>  });&nbsp;</div></li><li><div>})(jQuery);&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display JavaScript based on Step 2.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function js_2() { ?&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>  function onEndCrop( coords ) {&nbsp;</div></li><li><div>      jQuery( '#x1' ).val(coords.x);&nbsp;</div></li><li><div>      jQuery( '#y1' ).val(coords.y);&nbsp;</div></li><li><div>      jQuery( '#width' ).val(coords.w);&nbsp;</div></li><li><div>      jQuery( '#height' ).val(coords.h);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  jQuery(document).ready(function() {&nbsp;</div></li><li><div>      var xinit = &lt;?php echo absint( get_theme_support( 'custom-header', 'width' ) ); ?&gt;;&nbsp;</div></li><li><div>      var yinit = &lt;?php echo absint( get_theme_support( 'custom-header', 'height' ) ); ?&gt;;&nbsp;</div></li><li><div>      var ratio = xinit / yinit;&nbsp;</div></li><li><div>      var ximg = jQuery('img#upload').width();&nbsp;</div></li><li><div>      var yimg = jQuery('img#upload').height();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( yimg &lt; yinit || ximg &lt; xinit ) {&nbsp;</div></li><li><div>          if ( ximg / yimg &gt; ratio ) {&nbsp;</div></li><li><div>              yinit = yimg;&nbsp;</div></li><li><div>              xinit = yinit * ratio;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              xinit = ximg;&nbsp;</div></li><li><div>              yinit = xinit / ratio;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      jQuery('img#upload').imgAreaSelect({&nbsp;</div></li><li><div>          handles: true, &nbsp;</div></li><li><div>          keys: true, &nbsp;</div></li><li><div>          show: true, &nbsp;</div></li><li><div>          x1: 0, &nbsp;</div></li><li><div>          y1: 0, &nbsp;</div></li><li><div>          x2: xinit, &nbsp;</div></li><li><div>          y2: yinit, &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          if ( ! current_theme_supports( 'custom-header', 'flex-height' ) && ! current_theme_supports( 'custom-header', 'flex-width' ) ) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          aspectRatio: xinit + ':' + yinit, &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! current_theme_supports( 'custom-header', 'flex-height' ) ) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          maxHeight: &lt;?php echo get_theme_support( 'custom-header', 'height' ); ?&gt;, &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! current_theme_supports( 'custom-header', 'flex-width' ) ) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          maxWidth: &lt;?php echo get_theme_support( 'custom-header', 'width' ); ?&gt;, &nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          onInit: function () {&nbsp;</div></li><li><div>              jQuery('#width').val(xinit);&nbsp;</div></li><li><div>              jQuery('#height').val(yinit);&nbsp;</div></li><li><div>          }, &nbsp;</div></li><li><div>          onSelectChange: function(img, c) {&nbsp;</div></li><li><div>              jQuery('#x1').val(c.x1);&nbsp;</div></li><li><div>              jQuery('#y1').val(c.y1);&nbsp;</div></li><li><div>              jQuery('#width').val(c.width);&nbsp;</div></li><li><div>              jQuery('#height').val(c.height);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>  });&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display first step of custom header image page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function step_1() {&nbsp;</div></li><li><div>      $this-&gt;process_default_headers();&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>&lt;h1&gt;&lt;?php _e( 'Custom Header' ); ?&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php if ( current_user_can( 'customize' ) ) { ?&gt;&nbsp;</div></li><li><div>&lt;div class=&quot;notice notice-info hide-if-no-customize&quot;&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      printf(&nbsp;</div></li><li><div>          __( 'You can now manage and live-preview Custom Header in the &lt;a href=&quot;%1$s&quot;&gt;Customizer&lt;/a&gt;.' ), &nbsp;</div></li><li><div>          admin_url( 'customize.php?autofocus[control]=header_image' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php if ( ! empty( $this-&gt;updated ) ) { ?&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;message&quot; class=&quot;updated&quot;&gt;&nbsp;</div></li><li><div>&lt;p&gt;&lt;?php printf( __( 'Header updated. &lt;a href=&quot;%s&quot;&gt;Visit your site&lt;/a&gt; to see how it looks.' ), home_url( '/' ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;h3&gt;&lt;?php _e( 'Header Image' ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>&lt;tbody&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php if ( get_custom_header() || display_header_text() ) : ?&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Preview' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  if ( $this-&gt;admin_image_div_callback ) {&nbsp;</div></li><li><div>      call_user_func( $this-&gt;admin_image_div_callback );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $custom_header = get_custom_header();&nbsp;</div></li><li><div>      $header_image = get_header_image();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $header_image ) {&nbsp;</div></li><li><div>          $header_image_style = 'background-image:url(' . esc_url( $header_image ) . ');';&nbsp;</div></li><li><div>      }  else {&nbsp;</div></li><li><div>          $header_image_style = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $custom_header-&gt;width )&nbsp;</div></li><li><div>          $header_image_style .= 'max-width:' . $custom_header-&gt;width . 'px;';&nbsp;</div></li><li><div>      if ( $custom_header-&gt;height )&nbsp;</div></li><li><div>          $header_image_style .= 'height:' . $custom_header-&gt;height . 'px;';&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;div id=&quot;headimg&quot; style=&quot;&lt;?php echo $header_image_style; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      if ( display_header_text() )&nbsp;</div></li><li><div>          $style = ' style=&quot;color:#' . get_header_textcolor() . ';&quot;';&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $style = ' style=&quot;display:none;&quot;';&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;h1&gt;&lt;a id=&quot;name&quot; class=&quot;displaying-header-text&quot; &lt;?php echo $style; ?&gt; onclick=&quot;return false;&quot; href=&quot;&lt;?php bloginfo('url'); ?&gt;&quot; tabindex=&quot;-1&quot;&gt;&lt;?php bloginfo( 'name' ); ?&gt;&lt;/a&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>      &lt;div id=&quot;desc&quot; class=&quot;displaying-header-text&quot; &lt;?php echo $style; ?&gt;&gt;&lt;?php bloginfo( 'description' ); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php } ?&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>&lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php if ( current_user_can( 'upload_files' ) && current_theme_supports( 'custom-header', 'uploads' ) ) : ?&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Select Image' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _e( 'You can select an image to be shown at the top of your site by uploading from your computer or choosing from your media library. After selecting an image you will be able to crop it.' ); ?&gt;&lt;br /&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  if ( ! current_theme_supports( 'custom-header', 'flex-height' ) && ! current_theme_supports( 'custom-header', 'flex-width' ) ) {&nbsp;</div></li><li><div>      printf( __( 'Images of exactly &lt;strong&gt;%1$d &times; %2$d pixels&lt;/strong&gt; will be used as-is.' ) . '&lt;br /&gt;', get_theme_support( 'custom-header', 'width' ), get_theme_support( 'custom-header', 'height' ) );&nbsp;</div></li><li><div>  } elseif ( current_theme_supports( 'custom-header', 'flex-height' ) ) {&nbsp;</div></li><li><div>      if ( ! current_theme_supports( 'custom-header', 'flex-width' ) )&nbsp;</div></li><li><div>          printf(&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: %s: size in pixels */</span></span></span></span>&nbsp;</div></li><li><div>              __( 'Images should be at least %s wide.' ) . ' ', &nbsp;</div></li><li><div>              sprintf(&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">/** translators: %d: custom header width */</span></span>&nbsp;</div></li><li><div>                  '&lt;strong&gt;' . __( '%d pixels' ) . '&lt;/strong&gt;', &nbsp;</div></li><li><div>                  get_theme_support( 'custom-header', 'width' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  } elseif ( current_theme_supports( 'custom-header', 'flex-width' ) ) {&nbsp;</div></li><li><div>      if ( ! current_theme_supports( 'custom-header', 'flex-height' ) )&nbsp;</div></li><li><div>          printf(&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: %s: size in pixels */</span></span></span></span>&nbsp;</div></li><li><div>              __( 'Images should be at least %s tall.' ) . ' ', &nbsp;</div></li><li><div>              sprintf(&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">/** translators: %d: custom header height */</span></span>&nbsp;</div></li><li><div>                  '&lt;strong&gt;' . __( '%d pixels' ) . '&lt;/strong&gt;', &nbsp;</div></li><li><div>                  get_theme_support( 'custom-header', 'height' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( current_theme_supports( 'custom-header', 'flex-height' ) || current_theme_supports( 'custom-header', 'flex-width' ) ) {&nbsp;</div></li><li><div>      if ( current_theme_supports( 'custom-header', 'width' ) )&nbsp;</div></li><li><div>          printf(&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: %s: size in pixels */</span></span></span></span>&nbsp;</div></li><li><div>              __( 'Suggested width is %s.' ) . ' ', &nbsp;</div></li><li><div>              sprintf(&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">/** translators: %d: custom header width */</span></span>&nbsp;</div></li><li><div>                  '&lt;strong&gt;' . __( '%d pixels' ) . '&lt;/strong&gt;', &nbsp;</div></li><li><div>                  get_theme_support( 'custom-header', 'width' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      if ( current_theme_supports( 'custom-header', 'height' ) )&nbsp;</div></li><li><div>          printf(&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** translators: %s: size in pixels */</span></span></span></span>&nbsp;</div></li><li><div>              __( 'Suggested height is %s.' ) . ' ', &nbsp;</div></li><li><div>              sprintf(&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">/** translators: %d: custom header height */</span></span>&nbsp;</div></li><li><div>                  '&lt;strong&gt;' . __( '%d pixels' ) . '&lt;/strong&gt;', &nbsp;</div></li><li><div>                  get_theme_support( 'custom-header', 'height' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;form enctype=&quot;multipart/form-data&quot; id=&quot;upload-form&quot; class=&quot;wp-upload-form&quot; method=&quot;post&quot; action=&quot;&lt;?php echo esc_url( add_query_arg( 'step', 2 ) ) ?&gt;&quot;&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;upload&quot;&gt;&lt;?php _e( 'Choose an image from your computer:' ); ?&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;file&quot; id=&quot;upload&quot; name=&quot;import&quot; /&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;save&quot; /&gt;&nbsp;</div></li><li><div>      &lt;?php wp_nonce_field( 'custom-header-upload', '_wpnonce-custom-header-upload' ); ?&gt;&nbsp;</div></li><li><div>      &lt;?php submit_button( __( 'Upload' ), '', 'submit', false ); ?&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      $modal_update_href = esc_url( add_query_arg( array(&nbsp;</div></li><li><div>          'page' =&gt; 'custom-header', &nbsp;</div></li><li><div>          'step' =&gt; 2, &nbsp;</div></li><li><div>          '_wpnonce-custom-header-upload' =&gt; wp_create_nonce('custom-header-upload'), &nbsp;</div></li><li><div> ), admin_url('themes.php') ) );&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;choose-from-library-link&quot;&gt;&lt;?php _e( 'Or choose an image from your media library:' ); ?&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>      &lt;button id=&quot;choose-from-library-link&quot; class=&quot;button&quot;&nbsp;</div></li><li><div>          data-update-link=&quot;&lt;?php echo esc_attr( $modal_update_href ); ?&gt;&quot;&nbsp;</div></li><li><div>          data-choose=&quot;&lt;?php esc_attr_e( 'Choose a Custom Header' ); ?&gt;&quot;&nbsp;</div></li><li><div>          data-update=&quot;&lt;?php esc_attr_e( 'Set as header' ); ?&gt;&quot;&gt;&lt;?php _e( 'Choose Image' ); ?&gt;&lt;/button&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/form&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>&lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&lt;/tbody&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo esc_url( add_query_arg( 'step', 1 ) ) ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&lt;?php submit_button( null, 'screen-reader-text', 'save-header-options', false ); ?&gt;&nbsp;</div></li><li><div>&lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>&lt;tbody&gt;&nbsp;</div></li><li><div>  &lt;?php if ( get_uploaded_header_images() ) : ?&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Uploaded Images' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _e( 'You can choose one of your previously uploaded headers, or show a random one.' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      $this-&gt;show_header_selector( 'uploaded' );&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>  &lt;?php endif;&nbsp;</div></li><li><div>  if ( ! empty( $this-&gt;default_headers ) ) : ?&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Default Images' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>&lt;?php if ( current_theme_supports( 'custom-header', 'uploads' ) ) : ?&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _e( 'If you don&lsquo;t want to upload your own image, you can use one of these cool headers, or show a random one.' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php else: ?&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _e( 'You can use one of these cool headers or show a random one on each page.' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php endif; ?&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      $this-&gt;show_header_selector( 'default' );&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>  &lt;?php endif;&nbsp;</div></li><li><div>  if ( get_header_image() ) : ?&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Remove Image' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _e( 'This will remove the header image. You will not be able to restore any customizations.' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php submit_button( __( 'Remove Header Image' ), '', 'removeheader', false ); ?&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>  &lt;?php endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_image = sprintf( get_theme_support( 'custom-header', 'default-image' ), get_template_directory_uri(), get_stylesheet_directory_uri() );&nbsp;</div></li><li><div>  if ( $default_image && get_header_image() != $default_image ) : ?&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Reset Image' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _e( 'This will restore the original header image. You will not be able to restore any customizations.' ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php submit_button( __( 'Restore Original Header Image' ), '', 'resetheader', false ); ?&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>  &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&lt;/tbody&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php if ( current_theme_supports( 'custom-header', 'header-text' ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;h3&gt;&lt;?php _e( 'Header Text' ); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>&lt;tbody&gt;&nbsp;</div></li><li><div>&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Header Text' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>  &lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;display-header-text&quot; id=&quot;display-header-text&quot;&lt;?php checked( display_header_text() ); ?&gt; /&gt; &lt;?php _e( 'Show header text with your image.' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;tr class=&quot;displaying-header-text&quot;&gt;&nbsp;</div></li><li><div>&lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Text Color' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;td&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  $default_color = '';&nbsp;</div></li><li><div>  if ( current_theme_supports( 'custom-header', 'default-text-color' ) ) {&nbsp;</div></li><li><div>      $default_color = get_theme_support( 'custom-header', 'default-text-color' );&nbsp;</div></li><li><div>      if ( $default_color && false === strpos( $default_color, '#' ) ) {&nbsp;</div></li><li><div>          $default_color = '#' . $default_color;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_color_attr = $default_color ? ' data-default-color=&quot;' . esc_attr( $default_color ) . '&quot;' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $header_textcolor = display_header_text() ? get_header_textcolor() : get_theme_support( 'custom-header', 'default-text-color' );&nbsp;</div></li><li><div>  if ( $header_textcolor && false === strpos( $header_textcolor, '#' ) ) {&nbsp;</div></li><li><div>      $header_textcolor = '#' . $header_textcolor;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo '&lt;input type=&quot;text&quot; name=&quot;text-color&quot; id=&quot;text-color&quot; value=&quot;' . esc_attr( $header_textcolor ) . '&quot;' . $default_color_attr . ' /&gt;';&nbsp;</div></li><li><div>  if ( $default_color ) {&nbsp;</div></li><li><div>      echo ' &lt;span class=&quot;description hide-if-js&quot;&gt;' . sprintf( _x( 'Default: %s', 'color' ), esc_html( $default_color ) ) . '&lt;/span&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>&lt;/td&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&nbsp;</div></li><li><div>&lt;/tbody&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&lt;?php endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fires just before the submit button in the custom header options form.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>do_action( 'custom_header_options' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>wp_nonce_field( 'custom-header-options', '_wpnonce-custom-header-options' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php submit_button( null, 'primary', 'save-header-options' ); ?&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display second step of custom header image page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function step_2() {&nbsp;</div></li><li><div>      check_admin_referer('custom-header-upload', '_wpnonce-custom-header-upload');&nbsp;</div></li><li><div>      if ( ! current_theme_supports( 'custom-header', 'uploads' ) ) {&nbsp;</div></li><li><div>          wp_die(&nbsp;</div></li><li><div>              '&lt;h1&gt;' . __( 'Cheatin&#8217; uh?' ) . '&lt;/h1&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'The current theme does not support uploading a custom header image.' ) . '&lt;/p&gt;', &nbsp;</div></li><li><div>              403&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $_POST ) && isset( $_GET['file'] ) ) {&nbsp;</div></li><li><div>          $attachment_id = absint( $_GET['file'] );&nbsp;</div></li><li><div>          $file = get_attached_file( $attachment_id, true );&nbsp;</div></li><li><div>          $url = wp_get_attachment_image_src( $attachment_id, 'full' );&nbsp;</div></li><li><div>          $url = $url[0];&nbsp;</div></li><li><div>      } elseif ( isset( $_POST ) ) {&nbsp;</div></li><li><div>          $data = $this-&gt;step_2_manage_upload();&nbsp;</div></li><li><div>          $attachment_id = $data['attachment_id'];&nbsp;</div></li><li><div>          $file = $data['file'];&nbsp;</div></li><li><div>          $url = $data['url'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( file_exists( $file ) ) {&nbsp;</div></li><li><div>          list( $width, $height, $type, $attr ) = getimagesize( $file );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $data = wp_get_attachment_metadata( $attachment_id );&nbsp;</div></li><li><div>          $height = isset( $data[ 'height' ] ) ? $data[ 'height' ] : 0;&nbsp;</div></li><li><div>          $width = isset( $data[ 'width' ] ) ? $data[ 'width' ] : 0;&nbsp;</div></li><li><div>          unset( $data );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $max_width = 0;&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// For flex, limit size of image displayed to 1500px unless theme says otherwise</span></span>&nbsp;</div></li><li><div>      if ( current_theme_supports( 'custom-header', 'flex-width' ) )&nbsp;</div></li><li><div>          $max_width = 1500;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( current_theme_supports( 'custom-header', 'max-width' ) )&nbsp;</div></li><li><div>          $max_width = max( $max_width, get_theme_support( 'custom-header', 'max-width' ) );&nbsp;</div></li><li><div>      $max_width = max( $max_width, get_theme_support( 'custom-header', 'width' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If flexible height isn't supported and the image is the exact right size</span>&nbsp;</div></li><li><div>      if ( ! current_theme_supports( 'custom-header', 'flex-height' ) && ! current_theme_supports( 'custom-header', 'flex-width' )&nbsp;</div></li><li><div>          && $width == get_theme_support( 'custom-header', 'width' ) && $height == get_theme_support( 'custom-header', 'height' ) )&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">// Add the meta-data</span>&nbsp;</div></li><li><div>          if ( file_exists( $file ) )&nbsp;</div></li><li><div>              wp_update_attachment_metadata( $attachment_id, wp_generate_attachment_metadata( $attachment_id, $file ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;set_header_image( compact( 'url', 'attachment_id', 'width', 'height' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires after the header image is set or an error is returned.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $file          Path to the file.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $attachment_id Attachment ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'wp_create_file_in_uploads', $file, $attachment_id ); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For replication</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $this-&gt;finished();&nbsp;</div></li><li><div>      } elseif ( $width &gt; $max_width ) {&nbsp;</div></li><li><div>          $oitar = $width / $max_width;&nbsp;</div></li><li><div>          $image = wp_crop_image($attachment_id, 0, 0, $width, $height, $max_width, $height / $oitar, false, str_replace(basename($file), 'midsize-'.basename($file), $file));&nbsp;</div></li><li><div>          if ( ! $image || is_wp_error( $image ) )&nbsp;</div></li><li><div>              wp_die( __( 'Image could not be processed. Please go back and try again.' ), __( 'Image Processing Error' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/custom-header.php */</span></span></span>&nbsp;</div></li><li><div>          $image = apply_filters( 'wp_create_file_in_uploads', $image, $attachment_id ); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For replication</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $url = str_replace(basename($url), basename($image), $url);&nbsp;</div></li><li><div>          $width = $width / $oitar;&nbsp;</div></li><li><div>          $height = $height / $oitar;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $oitar = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>&lt;h1&gt;&lt;?php _e( 'Crop Header Image' ); ?&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo esc_url(add_query_arg('step', 3)); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;hide-if-no-js&quot;&gt;&lt;?php _e('Choose the part of the image you want to use as your header.'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;hide-if-js&quot;&gt;&lt;strong&gt;&lt;?php _e( 'You need JavaScript to choose a part of the image.'); ?&gt;&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;div id=&quot;crop_image&quot; style=&quot;position: relative&quot;&gt;&nbsp;</div></li><li><div>      &lt;img src=&quot;&lt;?php echo esc_url( $url ); ?&gt;&quot; id=&quot;upload&quot; width=&quot;&lt;?php echo $width; ?&gt;&quot; height=&quot;&lt;?php echo $height; ?&gt;&quot; alt=&quot;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;x1&quot; id=&quot;x1&quot; value=&quot;0&quot;/&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;y1&quot; id=&quot;y1&quot; value=&quot;0&quot;/&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;width&quot; id=&quot;width&quot; value=&quot;&lt;?php echo esc_attr( $width ); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;height&quot; id=&quot;height&quot; value=&quot;&lt;?php echo esc_attr( $height ); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;attachment_id&quot; id=&quot;attachment_id&quot; value=&quot;&lt;?php echo esc_attr( $attachment_id ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;oitar&quot; id=&quot;oitar&quot; value=&quot;&lt;?php echo esc_attr( $oitar ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;?php if ( empty( $_POST ) && isset( $_GET['file'] ) ) { ?&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;hidden&quot; name=&quot;create-new-attachment&quot; value=&quot;true&quot; /&gt;&nbsp;</div></li><li><div>  &lt;?php } ?&gt;&nbsp;</div></li><li><div>  &lt;?php wp_nonce_field( 'custom-header-crop-image' ) ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;p class=&quot;submit&quot;&gt;&nbsp;</div></li><li><div>  &lt;?php submit_button( __( 'Crop and Publish' ), 'primary', 'submit', false ); ?&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  if ( isset( $oitar ) && 1 == $oitar && ( current_theme_supports( 'custom-header', 'flex-height' ) || current_theme_supports( 'custom-header', 'flex-width' ) ) )&nbsp;</div></li><li><div>      submit_button( __( 'Skip Cropping, Publish Image as Is' ), '', 'skip-cropping', false );&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Upload the file to be cropped in the second step.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function step_2_manage_upload() {&nbsp;</div></li><li><div>      $overrides = array('test_form' =&gt; false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $uploaded_file = $_FILES['import'];&nbsp;</div></li><li><div>      $wp_filetype = wp_check_filetype_and_ext( $uploaded_file['tmp_name'], $uploaded_file['name'] );&nbsp;</div></li><li><div>      if ( ! wp_match_mime_types( 'image', $wp_filetype['type'] ) )&nbsp;</div></li><li><div>          wp_die( __( 'The uploaded file is not a valid image. Please try again.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file = wp_handle_upload($uploaded_file, $overrides);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($file['error']) )&nbsp;</div></li><li><div>          wp_die( $file['error'], __( 'Image Upload Error' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = $file['url'];&nbsp;</div></li><li><div>      $type = $file['type'];&nbsp;</div></li><li><div>      $file = $file['file'];&nbsp;</div></li><li><div>      $filename = basename($file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Construct the object array</span>&nbsp;</div></li><li><div>      $object = array(&nbsp;</div></li><li><div>          'post_title' =&gt; $filename, &nbsp;</div></li><li><div>          'post_content' =&gt; $url, &nbsp;</div></li><li><div>          'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>          'guid' =&gt; $url, &nbsp;</div></li><li><div>          'context' =&gt; 'custom-header'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save the data</span>&nbsp;</div></li><li><div>      $attachment_id = wp_insert_attachment( $object, $file );&nbsp;</div></li><li><div>      return compact( 'attachment_id', 'file', 'filename', 'url', 'type' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display third step of custom header image page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0 Switched to using wp_get_attachment_url() instead of the guid</span>&nbsp;</div></li><li><div><span class="comment">   *              for retrieving the header image URL.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function step_3() {&nbsp;</div></li><li><div>      check_admin_referer( 'custom-header-crop-image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! current_theme_supports( 'custom-header', 'uploads' ) ) {&nbsp;</div></li><li><div>          wp_die(&nbsp;</div></li><li><div>              '&lt;h1&gt;' . __( 'Cheatin&#8217; uh?' ) . '&lt;/h1&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'The current theme does not support uploading a custom header image.' ) . '&lt;/p&gt;', &nbsp;</div></li><li><div>              403&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $_POST['skip-cropping'] ) && ! ( current_theme_supports( 'custom-header', 'flex-height' ) || current_theme_supports( 'custom-header', 'flex-width' ) ) ) {&nbsp;</div></li><li><div>          wp_die(&nbsp;</div></li><li><div>              '&lt;h1&gt;' . __( 'Cheatin&#8217; uh?' ) . '&lt;/h1&gt;' .&nbsp;</div></li><li><div>              '&lt;p&gt;' . __( 'The current theme does not support a flexible sized header image.' ) . '&lt;/p&gt;', &nbsp;</div></li><li><div>              403&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $_POST['oitar'] &gt; 1 ) {&nbsp;</div></li><li><div>          $_POST['x1'] = $_POST['x1'] * $_POST['oitar'];&nbsp;</div></li><li><div>          $_POST['y1'] = $_POST['y1'] * $_POST['oitar'];&nbsp;</div></li><li><div>          $_POST['width'] = $_POST['width'] * $_POST['oitar'];&nbsp;</div></li><li><div>          $_POST['height'] = $_POST['height'] * $_POST['oitar'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_id = absint( $_POST['attachment_id'] );&nbsp;</div></li><li><div>      $original = get_attached_file($attachment_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $dimensions = $this-&gt;get_header_dimensions( array(&nbsp;</div></li><li><div>          'height' =&gt; $_POST['height'], &nbsp;</div></li><li><div>          'width' =&gt; $_POST['width'], &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $height = $dimensions['dst_height'];&nbsp;</div></li><li><div>      $width = $dimensions['dst_width'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $_POST['skip-cropping'] ) )&nbsp;</div></li><li><div>          $cropped = wp_crop_image( $attachment_id, (int) $_POST['x1'], (int) $_POST['y1'], (int) $_POST['width'], (int) $_POST['height'], $width, $height );&nbsp;</div></li><li><div>      elseif ( ! empty( $_POST['create-new-attachment'] ) )&nbsp;</div></li><li><div>          $cropped = _copy_image_file( $attachment_id );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $cropped = get_attached_file( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $cropped || is_wp_error( $cropped ) )&nbsp;</div></li><li><div>          wp_die( __( 'Image could not be processed. Please go back and try again.' ), __( 'Image Processing Error' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/custom-header.php */</span></span></span>&nbsp;</div></li><li><div>      $cropped = apply_filters( 'wp_create_file_in_uploads', $cropped, $attachment_id ); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For replication</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $object = $this-&gt;create_attachment_object( $cropped, $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $_POST['create-new-attachment'] ) )&nbsp;</div></li><li><div>          unset( $object['ID'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update the attachment</span>&nbsp;</div></li><li><div>      $attachment_id = $this-&gt;insert_attachment( $object, $cropped );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = wp_get_attachment_url( $attachment_id );&nbsp;</div></li><li><div>      $this-&gt;set_header_image( compact( 'url', 'attachment_id', 'width', 'height' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cleanup.</span>&nbsp;</div></li><li><div>      $medium = str_replace( basename( $original ), 'midsize-' . basename( $original ), $original );&nbsp;</div></li><li><div>      if ( file_exists( $medium ) ) {&nbsp;</div></li><li><div>          wp_delete_file( $medium );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $_POST['create-new-attachment'] ) && empty( $_POST['skip-cropping'] ) ) {&nbsp;</div></li><li><div>          wp_delete_file( $original );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;finished();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display last step of custom header image page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function finished() {&nbsp;</div></li><li><div>      $this-&gt;updated = true;&nbsp;</div></li><li><div>      $this-&gt;step_1();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the page based on the current step.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function admin_page() {&nbsp;</div></li><li><div>      if ( ! current_user_can('edit_theme_options') )&nbsp;</div></li><li><div>          wp_die(__('Sorry, you are not allowed to customize headers.'));&nbsp;</div></li><li><div>      $step = $this-&gt;step();&nbsp;</div></li><li><div>      if ( 2 == $step )&nbsp;</div></li><li><div>          $this-&gt;step_2();&nbsp;</div></li><li><div>      elseif ( 3 == $step )&nbsp;</div></li><li><div>          $this-&gt;step_3();&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $this-&gt;step_1();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Unused since 3.5.0.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $form_fields</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $form_fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function attachment_fields_to_edit( $form_fields ) {&nbsp;</div></li><li><div>      return $form_fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Unused since 3.5.0.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $tabs</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $tabs</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function filter_upload_tabs( $tabs ) {&nbsp;</div></li><li><div>      return $tabs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Choose a header image, selected from existing uploaded and default headers, </span>&nbsp;</div></li><li><div><span class="comment">   * or provide an array of uploaded header data (either new, or from media library).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $choice Which header image to select. Allows for values of 'random-default-image', </span>&nbsp;</div></li><li><div><span class="comment">   *     for randomly cycling among the default images; 'random-uploaded-image', for randomly cycling</span>&nbsp;</div></li><li><div><span class="comment">   *     among the uploaded images; the key of a default image registered for that theme; and</span>&nbsp;</div></li><li><div><span class="comment">   *     the key of an image uploaded for that theme (the attachment ID of the image).</span>&nbsp;</div></li><li><div><span class="comment">   *  Or an array of arguments: attachment_id, url, width, height. All are required.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  final public function set_header_image( $choice ) {&nbsp;</div></li><li><div>      if ( is_array( $choice ) || is_object( $choice ) ) {&nbsp;</div></li><li><div>          $choice = (array) $choice;&nbsp;</div></li><li><div>          if ( ! isset( $choice['attachment_id'] ) || ! isset( $choice['url'] ) )&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $choice['url'] = esc_url_raw( $choice['url'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $header_image_data = (object) array(&nbsp;</div></li><li><div>              'attachment_id' =&gt; $choice['attachment_id'], &nbsp;</div></li><li><div>              'url' =&gt; $choice['url'], &nbsp;</div></li><li><div>              'thumbnail_url' =&gt; $choice['url'], &nbsp;</div></li><li><div>              'height' =&gt; $choice['height'], &nbsp;</div></li><li><div>              'width' =&gt; $choice['width'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_post_meta( $choice['attachment_id'], '_wp_attachment_is_custom_header', get_stylesheet() );&nbsp;</div></li><li><div>          set_theme_mod( 'header_image', $choice['url'] );&nbsp;</div></li><li><div>          set_theme_mod( 'header_image_data', $header_image_data );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $choice, array( 'remove-header', 'random-default-image', 'random-uploaded-image' ) ) ) {&nbsp;</div></li><li><div>          set_theme_mod( 'header_image', $choice );&nbsp;</div></li><li><div>          remove_theme_mod( 'header_image_data' );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $uploaded = get_uploaded_header_images();&nbsp;</div></li><li><div>      if ( $uploaded && isset( $uploaded[ $choice ] ) ) {&nbsp;</div></li><li><div>          $header_image_data = $uploaded[ $choice ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;process_default_headers();&nbsp;</div></li><li><div>          if ( isset( $this-&gt;default_headers[ $choice ] ) )&nbsp;</div></li><li><div>              $header_image_data = $this-&gt;default_headers[ $choice ];&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_theme_mod( 'header_image', esc_url_raw( $header_image_data['url'] ) );&nbsp;</div></li><li><div>      set_theme_mod( 'header_image_data', $header_image_data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove a header image.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  final public function remove_header_image() {&nbsp;</div></li><li><div>      $this-&gt;set_header_image( 'remove-header' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Reset a header image to the default image for the theme.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method does not do anything if the theme does not have a default header image.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  final public function reset_header_image() {&nbsp;</div></li><li><div>      $this-&gt;process_default_headers();&nbsp;</div></li><li><div>      $default = get_theme_support( 'custom-header', 'default-image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $default ) {&nbsp;</div></li><li><div>          $this-&gt;remove_header_image();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $default = sprintf( $default, get_template_directory_uri(), get_stylesheet_directory_uri() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_data = array();&nbsp;</div></li><li><div>      foreach ( $this-&gt;default_headers as $header =&gt; $details ) {&nbsp;</div></li><li><div>          if ( $details['url'] == $default ) {&nbsp;</div></li><li><div>              $default_data = $details;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_theme_mod( 'header_image', $default );&nbsp;</div></li><li><div>      set_theme_mod( 'header_image_data', (object) $default_data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate width and height based on what the currently selected theme supports.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $dimensions</span>&nbsp;</div></li><li><div><span class="comment">   * @return array dst_height and dst_width of header image.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  final public function get_header_dimensions( $dimensions ) {&nbsp;</div></li><li><div>      $max_width = 0;&nbsp;</div></li><li><div>      $width = absint( $dimensions['width'] );&nbsp;</div></li><li><div>      $height = absint( $dimensions['height'] );&nbsp;</div></li><li><div>      $theme_height = get_theme_support( 'custom-header', 'height' );&nbsp;</div></li><li><div>      $theme_width = get_theme_support( 'custom-header', 'width' );&nbsp;</div></li><li><div>      $has_flex_width = current_theme_supports( 'custom-header', 'flex-width' );&nbsp;</div></li><li><div>      $has_flex_height = current_theme_supports( 'custom-header', 'flex-height' );&nbsp;</div></li><li><div>      $has_max_width = current_theme_supports( 'custom-header', 'max-width' ) ;&nbsp;</div></li><li><div>      $dst = array( 'dst_height' =&gt; null, 'dst_width' =&gt; null );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// For flex, limit size of image displayed to 1500px unless theme says otherwise</span></span>&nbsp;</div></li><li><div>      if ( $has_flex_width ) {&nbsp;</div></li><li><div>          $max_width = 1500;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $has_max_width ) {&nbsp;</div></li><li><div>          $max_width = max( $max_width, get_theme_support( 'custom-header', 'max-width' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $max_width = max( $max_width, $theme_width );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $has_flex_height && ( ! $has_flex_width || $width &gt; $max_width ) ) {&nbsp;</div></li><li><div>          $dst['dst_height'] = absint( $height * ( $max_width / $width ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif ( $has_flex_height && $has_flex_width ) {&nbsp;</div></li><li><div>          $dst['dst_height'] = $height;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $dst['dst_height'] = $theme_height;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $has_flex_width && ( ! $has_flex_height || $width &gt; $max_width ) ) {&nbsp;</div></li><li><div>          $dst['dst_width'] = absint( $width * ( $max_width / $width ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif ( $has_flex_width && $has_flex_height ) {&nbsp;</div></li><li><div>          $dst['dst_width'] = $width;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $dst['dst_width'] = $theme_width;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $dst;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create an attachment 'object'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $cropped              Cropped image URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $parent_attachment_id Attachment ID of parent image.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Attachment object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  final public function create_attachment_object( $cropped, $parent_attachment_id ) {&nbsp;</div></li><li><div>      $parent = get_post( $parent_attachment_id );&nbsp;</div></li><li><div>      $parent_url = wp_get_attachment_url( $parent-&gt;ID );&nbsp;</div></li><li><div>      $url = str_replace( basename( $parent_url ), basename( $cropped ), $parent_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $size = @getimagesize( $cropped );&nbsp;</div></li><li><div>      $image_type = ( $size ) ? $size['mime'] : 'image/jpeg';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $object = array(&nbsp;</div></li><li><div>          'ID' =&gt; $parent_attachment_id, &nbsp;</div></li><li><div>          'post_title' =&gt; basename($cropped), &nbsp;</div></li><li><div>          'post_mime_type' =&gt; $image_type, &nbsp;</div></li><li><div>          'guid' =&gt; $url, &nbsp;</div></li><li><div>          'context' =&gt; 'custom-header'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $object;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Insert an attachment and its metadata.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $object  Attachment object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $cropped Cropped image URL.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int Attachment ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  final public function insert_attachment( $object, $cropped ) {&nbsp;</div></li><li><div>      $attachment_id = wp_insert_attachment( $object, $cropped );&nbsp;</div></li><li><div>      $metadata = wp_generate_attachment_metadata( $attachment_id, $cropped );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the header image attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see wp_generate_attachment_metadata()</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $metadata Attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $metadata = apply_filters( 'wp_header_image_attachment_metadata', $metadata );&nbsp;</div></li><li><div>      wp_update_attachment_metadata( $attachment_id, $metadata );&nbsp;</div></li><li><div>      return $attachment_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets attachment uploaded by Media Manager, crops it, then saves it as a</span>&nbsp;</div></li><li><div><span class="comment">   * new object. Returns JSON-encoded object details.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function ajax_header_crop() {&nbsp;</div></li><li><div>      check_ajax_referer( 'image_editor-' . $_POST['id'], 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_theme_options' ) ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! current_theme_supports( 'custom-header', 'uploads' ) ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $crop_details = $_POST['cropDetails'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $dimensions = $this-&gt;get_header_dimensions( array(&nbsp;</div></li><li><div>          'height' =&gt; $crop_details['height'], &nbsp;</div></li><li><div>          'width' =&gt; $crop_details['width'], &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_id = absint( $_POST['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cropped = wp_crop_image(&nbsp;</div></li><li><div>          $attachment_id, &nbsp;</div></li><li><div>          (int) $crop_details['x1'], &nbsp;</div></li><li><div>          (int) $crop_details['y1'], &nbsp;</div></li><li><div>          (int) $crop_details['width'], &nbsp;</div></li><li><div>          (int) $crop_details['height'], &nbsp;</div></li><li><div>          (int) $dimensions['dst_width'], &nbsp;</div></li><li><div>          (int) $dimensions['dst_height']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $cropped || is_wp_error( $cropped ) ) {&nbsp;</div></li><li><div>          wp_send_json_error( array( 'message' =&gt; __( 'Image could not be processed. Please go back and try again.' ) ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/custom-header.php */</span></span></span>&nbsp;</div></li><li><div>      $cropped = apply_filters( 'wp_create_file_in_uploads', $cropped, $attachment_id ); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// For replication</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $object = $this-&gt;create_attachment_object( $cropped, $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $object['ID'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new_attachment_id = $this-&gt;insert_attachment( $object, $cropped );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $object['attachment_id'] = $new_attachment_id;&nbsp;</div></li><li><div>      $object['url'] = wp_get_attachment_url( $new_attachment_id );;&nbsp;</div></li><li><div>      $object['width'] = $dimensions['dst_width'];&nbsp;</div></li><li><div>      $object['height'] = $dimensions['dst_height'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_success( $object );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Given an attachment ID for a header image, updates its &quot;last used&quot;</span>&nbsp;</div></li><li><div><span class="comment">   * timestamp to now.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Triggered when the user tries adds a new header image from the</span>&nbsp;</div></li><li><div><span class="comment">   * Media Manager, even if s/he doesn't save that change.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function ajax_header_add() {&nbsp;</div></li><li><div>      check_ajax_referer( 'header-add', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_theme_options' ) ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_id = absint( $_POST['attachment_id'] );&nbsp;</div></li><li><div>      if ( $attachment_id &lt; 1 ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $key = '_wp_attachment_custom_header_last_used_' . get_stylesheet();&nbsp;</div></li><li><div>      update_post_meta( $attachment_id, $key, time() );&nbsp;</div></li><li><div>      update_post_meta( $attachment_id, '_wp_attachment_is_custom_header', get_stylesheet() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_success();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Given an attachment ID for a header image, unsets it as a user-uploaded</span>&nbsp;</div></li><li><div><span class="comment">   * header image for the current theme.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Triggered when the user clicks the overlay &quot;X&quot; button next to each image</span>&nbsp;</div></li><li><div><span class="comment">   * choice in the Customizer's Header tool.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function ajax_header_remove() {&nbsp;</div></li><li><div>      check_ajax_referer( 'header-remove', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_theme_options' ) ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_id = absint( $_POST['attachment_id'] );&nbsp;</div></li><li><div>      if ( $attachment_id &lt; 1 ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $key = '_wp_attachment_custom_header_last_used_' . get_stylesheet();&nbsp;</div></li><li><div>      delete_post_meta( $attachment_id, $key );&nbsp;</div></li><li><div>      delete_post_meta( $attachment_id, '_wp_attachment_is_custom_header', get_stylesheet() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_success();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Customize_Manager $wp_customize</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function customize_set_last_used( $wp_customize ) {&nbsp;</div></li><li><div>      $data = $wp_customize-&gt;get_setting( 'header_image_data' )-&gt;post_value();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $data['attachment_id'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_id = $data['attachment_id'];&nbsp;</div></li><li><div>      $key = '_wp_attachment_custom_header_last_used_' . get_stylesheet();&nbsp;</div></li><li><div>      update_post_meta( $attachment_id, $key, time() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_default_header_images() {&nbsp;</div></li><li><div>      $this-&gt;process_default_headers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the default image if there is one.</span>&nbsp;</div></li><li><div>      $default = get_theme_support( 'custom-header', 'default-image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $default ) { <span class="comment">// If not, </span>&nbsp;</div></li><li><div>          return $this-&gt;default_headers; <span class="comment">// easy peasy.</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default = sprintf( $default, get_template_directory_uri(), get_stylesheet_directory_uri() );&nbsp;</div></li><li><div>      $already_has_default = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;default_headers as $k =&gt; $h ) {&nbsp;</div></li><li><div>          if ( $h['url'] === $default ) {&nbsp;</div></li><li><div>              $already_has_default = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $already_has_default ) {&nbsp;</div></li><li><div>          return $this-&gt;default_headers;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the one true image isn't included in the default set, prepend it.</span>&nbsp;</div></li><li><div>      $header_images = array();&nbsp;</div></li><li><div>      $header_images['default'] = array(&nbsp;</div></li><li><div>          'url' =&gt; $default, &nbsp;</div></li><li><div>          'thumbnail_url' =&gt; $default, &nbsp;</div></li><li><div>          'description' =&gt; 'Default'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The rest of the set comes after.</span>&nbsp;</div></li><li><div>      return array_merge( $header_images, $this-&gt;default_headers );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_uploaded_header_images() {&nbsp;</div></li><li><div>      $header_images = get_uploaded_header_images();&nbsp;</div></li><li><div>      $timestamp_key = '_wp_attachment_custom_header_last_used_' . get_stylesheet();&nbsp;</div></li><li><div>      $alt_text_key = '_wp_attachment_image_alt';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $header_images as &$header_image ) {&nbsp;</div></li><li><div>          $header_meta = get_post_meta( $header_image['attachment_id'] );&nbsp;</div></li><li><div>          $header_image['timestamp'] = isset( $header_meta[ $timestamp_key ] ) ? $header_meta[ $timestamp_key ] : '';&nbsp;</div></li><li><div>          $header_image['alt_text'] = isset( $header_meta[ $alt_text_key ] ) ? $header_meta[ $alt_text_key ] : '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $header_images;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-admin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>