<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.2" data-type="file" data-id="4497"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-admin-includes-media | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.11"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d78cef78f064b5a79691282b17096ecb' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.11' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-admin-includes-media/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-media%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-media%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.2-file-wp-admin-includes-media","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-admin-includes-media" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.2." href="http://hookr.io/4.7.2/" class="H_VERSION"><span property="name">4.7.2</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-admin-includes-media</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6308"><a href="http://hookr.io/4.7.2/all/" title="All">All <span class="count badge">6308</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/4.7.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2531"><a href="http://hookr.io/4.7.2/hooks/" title="Hooks">Hooks <span class="count badge">2531</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.2/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1667"><a href="http://hookr.io/4.7.2/filters/" title="Filters">Filters <span class="count badge">1667</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.2/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.2/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2852"><a href="http://hookr.io/4.7.2/functions/" title="Functions">Functions <span class="count badge">2852</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-admin/includes/media.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress Administration Media API.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Defines the default media upload tabs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array default tabs</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_tabs() {&nbsp;</div></li><li><div>  $_default_tabs = array(&nbsp;</div></li><li><div>      'type' =&gt; __('From Computer'), <span class="comment">// handler action suffix =&gt; tab text</span>&nbsp;</div></li><li><div>      'type_url' =&gt; __('From URL'), &nbsp;</div></li><li><div>      'gallery' =&gt; __('Gallery'), &nbsp;</div></li><li><div>      'library' =&gt; __('Media Library')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the available tabs in the legacy (pre-3.5.0) media popup.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $_default_tabs An array of media tabs.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'media_upload_tabs', $_default_tabs );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds the gallery tab back to the tabs array if post has image attachments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $tabs</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $tabs with gallery if post has image attachment</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_gallery_tab($tabs) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !isset($_REQUEST['post_id']) ) {&nbsp;</div></li><li><div>      unset($tabs['gallery']);&nbsp;</div></li><li><div>      return $tabs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = intval($_REQUEST['post_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post_id )&nbsp;</div></li><li><div>      $attachments = intval( $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT count(*) FROM $wpdb-&gt;posts WHERE post_type = 'attachment' AND post_status != 'trash' AND post_parent = %d&quot;, $post_id ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($attachments) ) {&nbsp;</div></li><li><div>      unset($tabs['gallery']);&nbsp;</div></li><li><div>      return $tabs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $tabs['gallery'] = sprintf(__('Gallery (%s)'), &quot;&lt;span id='attachments-count'&gt;$attachments&lt;/span&gt;&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $tabs;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the legacy media upload tabs UI.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $redir_tab</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function the_media_upload_tabs() {&nbsp;</div></li><li><div>  global $redir_tab;&nbsp;</div></li><li><div>  $tabs = media_upload_tabs();&nbsp;</div></li><li><div>  $default = 'type';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($tabs) ) {&nbsp;</div></li><li><div>      echo &quot;&lt;ul id='sidemenu'&gt;\n&quot;;&nbsp;</div></li><li><div>      if ( isset($redir_tab) && array_key_exists($redir_tab, $tabs) ) {&nbsp;</div></li><li><div>          $current = $redir_tab;&nbsp;</div></li><li><div>      } elseif ( isset($_GET['tab']) && array_key_exists($_GET['tab'], $tabs) ) {&nbsp;</div></li><li><div>          $current = $_GET['tab'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/** This filter is documented in wp-admin/media-upload.php */</span>&nbsp;</div></li><li><div>          $current = apply_filters( 'media_upload_default_tab', $default );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $tabs as $callback =&gt; $text ) {&nbsp;</div></li><li><div>          $class = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $current == $callback )&nbsp;</div></li><li><div>              $class = &quot; class='current'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $href = add_query_arg(array('tab' =&gt; $callback, 's' =&gt; false, 'paged' =&gt; false, 'post_mime_type' =&gt; false, 'm' =&gt; false));&nbsp;</div></li><li><div>          $link = &quot;&lt;a href='&quot; . esc_url($href) . &quot;'$class&gt;$text&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;\t&lt;li id='&quot; . esc_attr(&quot;tab-$callback&quot;) . &quot;'&gt;$link&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo &quot;&lt;/ul&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the image HTML to send to the editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int          $id      Image attachment id.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $caption Image caption.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $title   Image title attribute.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $align   Image CSS alignment property.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $url     Optional. Image src URL. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool|string  $rel     Optional. Value for rel attribute or whether to add a default value. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $size    Optional. Image size. Accepts any valid image size, or an array of width</span>&nbsp;</div></li><li><div><span class="comment"> *                              and height values in pixels (in that order). Default 'medium'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string       $alt     Optional. Image alt attribute. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The HTML output to insert into the editor.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_image_send_to_editor( $id, $caption, $title, $align, $url = '', $rel = false, $size = 'medium', $alt = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $html = get_image_tag( $id, $alt, '', $align, $size );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $rel ) {&nbsp;</div></li><li><div>      if ( is_string( $rel ) ) {&nbsp;</div></li><li><div>          $rel = ' rel=&quot;' . esc_attr( $rel ) . '&quot;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $rel = ' rel=&quot;attachment wp-att-' . intval( $id ) . '&quot;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $rel = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $url )&nbsp;</div></li><li><div>      $html = '&lt;a href=&quot;' . esc_attr( $url ) . '&quot;' . $rel . '&gt;' . $html . '&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the image HTML markup to send to the editor when inserting an image.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $html    The image HTML markup to send.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int          $id      The attachment id.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $caption The image caption.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $title   The image title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $align   The image alignment.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $url     The image source URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $size    Size of image. Image size or array of width and height values</span>&nbsp;</div></li><li><div><span class="comment">   *                              (in that order). Default 'medium'.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $alt     The image alternative, or alt, text.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $html = apply_filters( 'image_send_to_editor', $html, $id, $caption, $title, $align, $url, $size, $alt );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $html;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds image shortcode with caption to editor</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $html</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer $id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $caption image caption</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title image title attribute</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $align image css alignment property</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url image src url</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $size image size (thumbnail, medium, large, full or added with add_image_size() )</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $alt image alt attribute</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_add_caption( $html, $id, $caption, $title, $align, $url, $size, $alt = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the caption text.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note: If the caption text is empty, the caption shortcode will not be appended</span>&nbsp;</div></li><li><div><span class="comment">   * to the image HTML when inserted into the editor.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Passing an empty value also prevents the {@see 'image_add_caption_shortcode'}</span>&nbsp;</div></li><li><div><span class="comment">   * Filters from being evaluated at the end of image_add_caption().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $caption The original caption text.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $id      The attachment ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $caption = apply_filters( 'image_add_caption_text', $caption, $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to disable captions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Prevents image captions from being appended to image HTML when inserted into the editor.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $bool Whether to disable appending captions. Returning true to the filter</span>&nbsp;</div></li><li><div><span class="comment">   *                   will disable captions. Default empty string.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( empty($caption) || apply_filters( 'disable_captions', '' ) )&nbsp;</div></li><li><div>      return $html;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id = ( 0 &lt; (int) $id ) ? 'attachment_' . $id : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! preg_match( '/width=[&quot;\']([0-9]+)/', $html, $matches ) )&nbsp;</div></li><li><div>      return $html;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $width = $matches[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $caption = str_replace( array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $caption);&nbsp;</div></li><li><div>  $caption = preg_replace_callback( '/&lt;[a-zA-Z0-9]+(?: [^&lt;&gt;]+&gt;)*/', '_cleanup_image_add_caption', $caption );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Convert any remaining line breaks to &lt;br&gt;.</span>&nbsp;</div></li><li><div>  $caption = preg_replace( '/[ \n\t]*\n[ \t]*/', '&lt;br /&gt;', $caption );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $html = preg_replace( '/(class=[&quot;\'][^\'&quot;]*)align(none|left|right|center)\s?/', '$1', $html );&nbsp;</div></li><li><div>  if ( empty($align) )&nbsp;</div></li><li><div>      $align = 'none';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $shcode = '' . $html . ' ' . $caption . '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the image HTML markup including the caption shortcode.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $shcode The image HTML markup with caption shortcode.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $html   The image HTML markup.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'image_add_caption_shortcode', $shcode, $html );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Private preg_replace callback used in image_add_caption()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _cleanup_image_add_caption( $matches ) {&nbsp;</div></li><li><div>  <span class="comment">// Remove any line breaks from inside the tags.</span>&nbsp;</div></li><li><div>  return preg_replace( '/[\r\n\t]+/', ' ', $matches[0] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds image html to editor</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $html</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_send_to_editor($html) {&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>var win = window.dialogArguments || opener || parent || top;&nbsp;</div></li><li><div>win.send_to_editor( &lt;?php echo wp_json_encode( $html ); ?&gt; );&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save a file submitted from a POST request and create an attachment post for it.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file_id   Index of the `$_FILES` array that the file was sent. Required.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $post_id   The post ID of a post to attach the media item to. Required, but can</span>&nbsp;</div></li><li><div><span class="comment"> *                          be set to 0, creating a media item that has no relationship to a post.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $post_data Overwrite some of the attachment. Optional.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $overrides Override the wp_handle_upload() behavior. Optional.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error ID of the attachment or a WP_Error object on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_handle_upload($file_id, $post_id, $post_data = array(), $overrides = array( 'test_form' =&gt; false )) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $time = current_time('mysql');&nbsp;</div></li><li><div>  if ( $post = get_post($post_id) ) {&nbsp;</div></li><li><div>      if ( substr( $post-&gt;post_date, 0, 4 ) &gt; 0 )&nbsp;</div></li><li><div>          $time = $post-&gt;post_date;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = wp_handle_upload($_FILES[$file_id], $overrides, $time);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($file['error']) )&nbsp;</div></li><li><div>      return new WP_Error( 'upload_error', $file['error'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $name = $_FILES[$file_id]['name'];&nbsp;</div></li><li><div>  $ext = pathinfo( $name, PATHINFO_EXTENSION );&nbsp;</div></li><li><div>  $name = wp_basename( $name, &quot;.$ext&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = $file['url'];&nbsp;</div></li><li><div>  $type = $file['type'];&nbsp;</div></li><li><div>  $file = $file['file'];&nbsp;</div></li><li><div>  $title = sanitize_text_field( $name );&nbsp;</div></li><li><div>  $content = '';&nbsp;</div></li><li><div>  $excerpt = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( '#^audio#', $type ) ) {&nbsp;</div></li><li><div>      $meta = wp_read_audio_metadata( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $meta['title'] ) ) {&nbsp;</div></li><li><div>          $title = $meta['title'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $title ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $meta['album'] ) && ! empty( $meta['artist'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">/** translators: 1: audio track title, 2: album title, 3: artist name */</span>&nbsp;</div></li><li><div>              $content .= sprintf( __( '&quot;%1$s&quot; from %2$s by %3$s.' ), $title, $meta['album'], $meta['artist'] );&nbsp;</div></li><li><div>          } elseif ( ! empty( $meta['album'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">/** translators: 1: audio track title, 2: album title */</span>&nbsp;</div></li><li><div>              $content .= sprintf( __( '&quot;%1$s&quot; from %2$s.' ), $title, $meta['album'] );&nbsp;</div></li><li><div>          } elseif ( ! empty( $meta['artist'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">/** translators: 1: audio track title, 2: artist name */</span>&nbsp;</div></li><li><div>              $content .= sprintf( __( '&quot;%1$s&quot; by %2$s.' ), $title, $meta['artist'] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">/** translators: 1: audio track title */</span>&nbsp;</div></li><li><div>              $content .= sprintf( __( '&quot;%s&quot;.' ), $title );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( ! empty( $meta['album'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $meta['artist'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">/** translators: 1: audio album title, 2: artist name */</span>&nbsp;</div></li><li><div>              $content .= sprintf( __( '%1$s by %2$s.' ), $meta['album'], $meta['artist'] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $content .= $meta['album'] . '.';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( ! empty( $meta['artist'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $content .= $meta['artist'] . '.';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $meta['year'] ) ) {&nbsp;</div></li><li><div>          <span class="comment">/** translators: Audio file track information. 1: Year of audio track release */</span>&nbsp;</div></li><li><div>          $content .= ' ' . sprintf( __( 'Released: %d.' ), $meta['year'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $meta['track_number'] ) ) {&nbsp;</div></li><li><div>          $track_number = explode( '/', $meta['track_number'] );&nbsp;</div></li><li><div>          if ( isset( $track_number[1] ) ) {&nbsp;</div></li><li><div>              <span class="comment">/** translators: Audio file track information. 1: Audio track number, 2: Total audio tracks */</span>&nbsp;</div></li><li><div>              $content .= ' ' . sprintf( __( 'Track %1$s of %2$s.' ), number_format_i18n( $track_number[0] ), number_format_i18n( $track_number[1] ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">/** translators: Audio file track information. 1: Audio track number */</span>&nbsp;</div></li><li><div>              $content .= ' ' . sprintf( __( 'Track %1$s.' ), number_format_i18n( $track_number[0] ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $meta['genre'] ) ) {&nbsp;</div></li><li><div>          <span class="comment">/** translators: Audio file genre information. 1: Audio genre name */</span>&nbsp;</div></li><li><div>          $content .= ' ' . sprintf( __( 'Genre: %s.' ), $meta['genre'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use image exif/iptc data for title and caption defaults if possible.</span></span>&nbsp;</div></li><li><div>  } elseif ( 0 === strpos( $type, 'image/' ) && $image_meta = @wp_read_image_metadata( $file ) ) {&nbsp;</div></li><li><div>      if ( trim( $image_meta['title'] ) && ! is_numeric( sanitize_title( $image_meta['title'] ) ) ) {&nbsp;</div></li><li><div>          $title = $image_meta['title'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( trim( $image_meta['caption'] ) ) {&nbsp;</div></li><li><div>          $excerpt = $image_meta['caption'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Construct the attachment array</span>&nbsp;</div></li><li><div>  $attachment = array_merge( array(&nbsp;</div></li><li><div>      'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>      'guid' =&gt; $url, &nbsp;</div></li><li><div>      'post_parent' =&gt; $post_id, &nbsp;</div></li><li><div>      'post_title' =&gt; $title, &nbsp;</div></li><li><div>      'post_content' =&gt; $content, &nbsp;</div></li><li><div>      'post_excerpt' =&gt; $excerpt, &nbsp;</div></li><li><div> ), $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// This should never be set as it would then overwrite an existing attachment.</span></span>&nbsp;</div></li><li><div>  unset( $attachment['ID'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Save the data</span>&nbsp;</div></li><li><div>  $id = wp_insert_attachment($attachment, $file, $post_id);&nbsp;</div></li><li><div>  if ( !is_wp_error($id) ) {&nbsp;</div></li><li><div>      wp_update_attachment_metadata( $id, wp_generate_attachment_metadata( $id, $file ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles a side-loaded file in the same way as an uploaded file is handled by media_handle_upload().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $file_array Array similar to a `$_FILES` upload array.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $post_id    The post ID the media is associated with.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $desc       Optional. Description of the side-loaded file. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $post_data  Optional. Post data to override. Default empty array.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|object The ID of the attachment or a WP_Error on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_handle_sideload( $file_array, $post_id, $desc = null, $post_data = array() ) {&nbsp;</div></li><li><div>  $overrides = array('test_form'=&gt;false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $time = current_time( 'mysql' );&nbsp;</div></li><li><div>  if ( $post = get_post( $post_id ) ) {&nbsp;</div></li><li><div>      if ( substr( $post-&gt;post_date, 0, 4 ) &gt; 0 )&nbsp;</div></li><li><div>          $time = $post-&gt;post_date;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = wp_handle_sideload( $file_array, $overrides, $time );&nbsp;</div></li><li><div>  if ( isset($file['error']) )&nbsp;</div></li><li><div>      return new WP_Error( 'upload_error', $file['error'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = $file['url'];&nbsp;</div></li><li><div>  $type = $file['type'];&nbsp;</div></li><li><div>  $file = $file['file'];&nbsp;</div></li><li><div>  $title = preg_replace('/\.[^.]+$/', '', basename($file));&nbsp;</div></li><li><div>  $content = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use image exif/iptc data for title and caption defaults if possible.</span></span>&nbsp;</div></li><li><div>  if ( $image_meta = @wp_read_image_metadata($file) ) {&nbsp;</div></li><li><div>      if ( trim( $image_meta['title'] ) && ! is_numeric( sanitize_title( $image_meta['title'] ) ) )&nbsp;</div></li><li><div>          $title = $image_meta['title'];&nbsp;</div></li><li><div>      if ( trim( $image_meta['caption'] ) )&nbsp;</div></li><li><div>          $content = $image_meta['caption'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $desc ) )&nbsp;</div></li><li><div>      $title = $desc;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Construct the attachment array</span>.&nbsp;</div></li><li><div>  $attachment = array_merge( array(&nbsp;</div></li><li><div>      'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>      'guid' =&gt; $url, &nbsp;</div></li><li><div>      'post_parent' =&gt; $post_id, &nbsp;</div></li><li><div>      'post_title' =&gt; $title, &nbsp;</div></li><li><div>      'post_content' =&gt; $content, &nbsp;</div></li><li><div> ), $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// This should never be set as it would then overwrite an existing attachment.</span></span>&nbsp;</div></li><li><div>  unset( $attachment['ID'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Save the attachment metadata</span>&nbsp;</div></li><li><div>  $id = wp_insert_attachment($attachment, $file, $post_id);&nbsp;</div></li><li><div>  if ( !is_wp_error($id) )&nbsp;</div></li><li><div>      wp_update_attachment_metadata( $id, wp_generate_attachment_metadata( $id, $file ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds the iframe to display content for the media upload page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $body_id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|callable $content_func</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_iframe($content_func <span class="comment">/** ... */</span>) {&nbsp;</div></li><li><div>  _wp_admin_html_begin();&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;title&gt;&lt;?php bloginfo('name') ?&gt; &rsaquo; &lt;?php _e('Uploads'); ?&gt; &#8212; &lt;?php _e('WordPress'); ?&gt;&lt;/title&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>wp_enqueue_style( 'colors' );&nbsp;</div></li><li><div><span class="comment">// Check callback name for 'media'</span>&nbsp;</div></li><li><div>if ( ( is_array( $content_func ) && ! empty( $content_func[1] ) && 0 === strpos( (string) $content_func[1], 'media' ) )&nbsp;</div></li><li><div>  || ( ! is_array( $content_func ) && 0 === strpos( $content_func, 'media' ) ) )&nbsp;</div></li><li><div>  wp_enqueue_style( 'deprecated-media' );&nbsp;</div></li><li><div>wp_enqueue_style( 'ie' );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>addLoadEvent = function(func) {if(typeof jQuery!=&quot;undefined&quot;)jQuery(document).ready(func);else if(typeof wpOnload!='function') {wpOnload=func;}else{var oldonload=wpOnload;wpOnload=function() {oldonload();func();}}};&nbsp;</div></li><li><div>var ajaxurl = '&lt;?php echo admin_url( 'admin-ajax.php', 'relative' ); ?&gt;', pagenow = 'media-upload-popup', adminpage = 'media-upload-popup', &nbsp;</div></li><li><div>isRtl = &lt;?php echo (int) is_rtl(); ?&gt;;&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This action is documented in wp-admin/admin-header.php */</span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'admin_enqueue_scripts', 'media-upload-popup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when admin styles enqueued for the legacy (pre-3.5.0) media upload popup are printed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'admin_print_styles-media-upload-popup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This action is documented in wp-admin/admin-header.php */</span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'admin_print_styles' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when admin scripts enqueued for the legacy (pre-3.5.0) media upload popup are printed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'admin_print_scripts-media-upload-popup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This action is documented in wp-admin/admin-header.php */</span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'admin_print_scripts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when scripts enqueued for the admin header for the legacy (pre-3.5.0)</span>&nbsp;</div></li><li><div><span class="comment">   * media upload popup are printed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'admin_head-media-upload-popup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This action is documented in wp-admin/admin-header.php */</span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'admin_head' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( is_string( $content_func ) ) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires in the admin header for each specific form tab in the legacy</span>&nbsp;</div></li><li><div><span class="comment">   * (pre-3.5.0) media upload popup.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portion of the hook, `$content_func`, refers to the form</span>&nbsp;</div></li><li><div><span class="comment">   * callback for the media upload type. Possible values include</span>&nbsp;</div></li><li><div><span class="comment">   * 'media_upload_type_form', 'media_upload_type_url_form', and</span>&nbsp;</div></li><li><div><span class="comment">   * 'media_upload_library_form'.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( &quot;admin_head_{$content_func}&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/head&gt;&nbsp;</div></li><li><div>&lt;body&lt;?php if ( isset($GLOBALS['body_id']) ) echo ' id=&quot;' . $GLOBALS['body_id'] . '&quot;'; ?&gt; class=&quot;wp-core-ui no-js&quot;&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>document.body.className = document.body.className.replace('no-js', 'js');&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  $args = func_get_args();&nbsp;</div></li><li><div>  $args = array_slice($args, 1);&nbsp;</div></li><li><div>  call_user_func_array($content_func, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** This action is documented in wp-admin/admin-footer.php */</span>&nbsp;</div></li><li><div>  do_action( 'admin_print_footer_scripts' );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;if(typeof wpOnload=='function')wpOnload();&lt;/script&gt;&nbsp;</div></li><li><div>&lt;/body&gt;&nbsp;</div></li><li><div>&lt;/html&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds the media button to the editor</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $post_ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @staticvar int $instance</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $editor_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_buttons($editor_id = 'content') {&nbsp;</div></li><li><div>  static $instance = 0;&nbsp;</div></li><li><div>  $instance++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post();&nbsp;</div></li><li><div>  if ( ! $post && ! empty( $GLOBALS['post_ID'] ) )&nbsp;</div></li><li><div>      $post = $GLOBALS['post_ID'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_enqueue_media( array(&nbsp;</div></li><li><div>      'post' =&gt; $post&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $img = '&lt;span class=&quot;wp-media-buttons-icon&quot;&gt;&lt;/span&gt; ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id_attribute = $instance === 1 ? ' id=&quot;insert-media-button&quot;' : '';&nbsp;</div></li><li><div>  printf( '&lt;button type=&quot;button&quot;%s class=&quot;button insert-media add_media&quot; data-editor=&quot;%s&quot;&gt;%s&lt;/button&gt;', &nbsp;</div></li><li><div>      $id_attribute, &nbsp;</div></li><li><div>      esc_attr( $editor_id ), &nbsp;</div></li><li><div>      $img . __( 'Add Media' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the legacy (pre-3.5.0) media buttons.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Use {@see 'media_buttons'} action instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 3.5.0 Use {@see 'media_buttons'} action instead.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $string Media buttons context. Default empty.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $legacy_filter = apply_filters( 'media_buttons_context', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $legacy_filter ) {&nbsp;</div></li><li><div>      <span class="comment">// #WP22559. Close &lt;a&gt; if a plugin started by closing &lt;a&gt; to open their own &lt;a&gt; tag.</span>&nbsp;</div></li><li><div>      if ( 0 === stripos( trim( $legacy_filter ), '&lt;/a&gt;' ) )&nbsp;</div></li><li><div>          $legacy_filter .= '&lt;/a&gt;';&nbsp;</div></li><li><div>      echo $legacy_filter;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $post_ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $tab</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_upload_iframe_src( $type = null, $post_id = null, $tab = null ) {&nbsp;</div></li><li><div>  global $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post_id ) )&nbsp;</div></li><li><div>      $post_id = $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $upload_iframe_src = add_query_arg( 'post_id', (int) $post_id, admin_url('media-upload.php') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $type && 'media' != $type )&nbsp;</div></li><li><div>      $upload_iframe_src = add_query_arg('type', $type, $upload_iframe_src);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $tab ) )&nbsp;</div></li><li><div>      $upload_iframe_src = add_query_arg('tab', $tab, $upload_iframe_src);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the upload iframe source URL for a specific media type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portion of the hook name, `$type`, refers to the type</span>&nbsp;</div></li><li><div><span class="comment">   * of media uploaded.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $upload_iframe_src The upload iframe source URL by type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $upload_iframe_src = apply_filters( &quot;{$type}_upload_iframe_src&quot;, $upload_iframe_src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return add_query_arg('TB_iframe', true, $upload_iframe_src);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles form submissions for the legacy media uploader.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed void|object WP_Error on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_form_handler() {&nbsp;</div></li><li><div>  check_admin_referer('media-form');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $errors = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_POST['send']) ) {&nbsp;</div></li><li><div>      $keys = array_keys( $_POST['send'] );&nbsp;</div></li><li><div>      $send_id = (int) reset( $keys );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($_POST['attachments']) ) foreach ( $_POST['attachments'] as $attachment_id =&gt; $attachment ) {&nbsp;</div></li><li><div>      $post = $_post = get_post($attachment_id, ARRAY_A);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !current_user_can( 'edit_post', $attachment_id ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($attachment['post_content']) )&nbsp;</div></li><li><div>          $post['post_content'] = $attachment['post_content'];&nbsp;</div></li><li><div>      if ( isset($attachment['post_title']) )&nbsp;</div></li><li><div>          $post['post_title'] = $attachment['post_title'];&nbsp;</div></li><li><div>      if ( isset($attachment['post_excerpt']) )&nbsp;</div></li><li><div>          $post['post_excerpt'] = $attachment['post_excerpt'];&nbsp;</div></li><li><div>      if ( isset($attachment['menu_order']) )&nbsp;</div></li><li><div>          $post['menu_order'] = $attachment['menu_order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($send_id) && $attachment_id == $send_id ) {&nbsp;</div></li><li><div>          if ( isset($attachment['post_parent']) )&nbsp;</div></li><li><div>              $post['post_parent'] = $attachment['post_parent'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the attachment fields to be saved.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see wp_get_attachment_metadata()</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $post       An array of post data.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $attachment An array of attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $post = apply_filters( 'attachment_fields_to_save', $post, $attachment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($attachment['image_alt']) ) {&nbsp;</div></li><li><div>          $image_alt = wp_unslash( $attachment['image_alt'] );&nbsp;</div></li><li><div>          if ( $image_alt != get_post_meta($attachment_id, '_wp_attachment_image_alt', true) ) {&nbsp;</div></li><li><div>              $image_alt = wp_strip_all_tags( $image_alt, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update_meta expects slashed.</span>&nbsp;</div></li><li><div>              update_post_meta( $attachment_id, '_wp_attachment_image_alt', wp_slash( $image_alt ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($post['errors']) ) {&nbsp;</div></li><li><div>          $errors[$attachment_id] = $post['errors'];&nbsp;</div></li><li><div>          unset($post['errors']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $post != $_post )&nbsp;</div></li><li><div>          wp_update_post($post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( get_attachment_taxonomies($post) as $t ) {&nbsp;</div></li><li><div>          if ( isset($attachment[$t]) )&nbsp;</div></li><li><div>              wp_set_object_terms($attachment_id, array_map('trim', preg_split('/, +/', $attachment[$t])), $t, false);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_POST['insert-gallery']) || isset($_POST['update-gallery']) ) { ?&gt;&nbsp;</div></li><li><div>      &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>      var win = window.dialogArguments || opener || parent || top;&nbsp;</div></li><li><div>      win.tb_remove();&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($send_id) ) {&nbsp;</div></li><li><div>      $attachment = wp_unslash( $_POST['attachments'][$send_id] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $html = isset( $attachment['post_title'] ) ? $attachment['post_title'] : '';&nbsp;</div></li><li><div>      if ( !empty($attachment['url']) ) {&nbsp;</div></li><li><div>          $rel = '';&nbsp;</div></li><li><div>          if ( strpos($attachment['url'], 'attachment_id') || get_attachment_link($send_id) == $attachment['url'] )&nbsp;</div></li><li><div>              $rel = &quot; rel='attachment wp-att-&quot; . esc_attr($send_id) . &quot;'&quot;;&nbsp;</div></li><li><div>          $html = &quot;&lt;a href='{$attachment['url']}'$rel&gt;$html&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the HTML markup for a media item sent to the editor.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @see wp_get_attachment_metadata()</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $html       HTML markup for a media item sent to the editor.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $send_id    The first key from the $_POST['send'] data.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $attachment Array of attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $html = apply_filters( 'media_send_to_editor', $html, $send_id, $attachment );&nbsp;</div></li><li><div>      return media_send_to_editor($html);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $errors;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the process of uploading media.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return null|string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_media_upload_handler() {&nbsp;</div></li><li><div>  $errors = array();&nbsp;</div></li><li><div>  $id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_POST['html-upload']) && !empty($_FILES) ) {&nbsp;</div></li><li><div>      check_admin_referer('media-form');&nbsp;</div></li><li><div>      <span class="comment">// Upload File button was clicked</span>&nbsp;</div></li><li><div>      $id = media_handle_upload('async-upload', $_REQUEST['post_id']);&nbsp;</div></li><li><div>      unset($_FILES);&nbsp;</div></li><li><div>      if ( is_wp_error($id) ) {&nbsp;</div></li><li><div>          $errors['upload_error'] = $id;&nbsp;</div></li><li><div>          $id = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($_POST['insertonlybutton']) ) {&nbsp;</div></li><li><div>      $src = $_POST['src'];&nbsp;</div></li><li><div>      if ( !empty($src) && !strpos($src, ':<span class="comment">//') )</span>&nbsp;</div></li><li><div>          $src = &quot;http:<span class="comment">//$src&quot;;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['media_type'] ) && 'image' != $_POST['media_type'] ) {&nbsp;</div></li><li><div>          $title = esc_html( wp_unslash( $_POST['title'] ) );&nbsp;</div></li><li><div>          if ( empty( $title ) )&nbsp;</div></li><li><div>              $title = esc_html( basename( $src ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $title && $src )&nbsp;</div></li><li><div>              $html = &quot;&lt;a href='&quot; . esc_url($src) . &quot;'&gt;$title&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $type = 'file';&nbsp;</div></li><li><div>          if ( ( $ext = preg_replace( '/^.+?\.([^.]+)$/', '$1', $src ) ) && ( $ext_type = wp_ext2type( $ext ) )&nbsp;</div></li><li><div>              && ( 'audio' == $ext_type || 'video' == $ext_type ) )&nbsp;</div></li><li><div>                  $type = $ext_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the URL sent to the editor for a specific media type.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * The dynamic portion of the hook name, `$type`, refers to the type</span>&nbsp;</div></li><li><div><span class="comment">           * of media being sent.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $html  HTML markup sent to the editor.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $src   Media source URL.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $title Media title.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $html = apply_filters( &quot;{$type}_send_to_editor_url&quot;, $html, esc_url_raw( $src ), $title );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $align = '';&nbsp;</div></li><li><div>          $alt = esc_attr( wp_unslash( $_POST['alt'] ) );&nbsp;</div></li><li><div>          if ( isset($_POST['align']) ) {&nbsp;</div></li><li><div>              $align = esc_attr( wp_unslash( $_POST['align'] ) );&nbsp;</div></li><li><div>              $class = &quot; class='align$align'&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( !empty($src) )&nbsp;</div></li><li><div>              $html = &quot;&lt;img src='&quot; . esc_url($src) . &quot;' alt='$alt'$class /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the image URL sent to the editor.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $html  HTML markup sent to the editor for an image.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $src   Image source URL.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $alt   Image alternate, or alt, text.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $align The image alignment. Default 'alignnone'. Possible values include</span>&nbsp;</div></li><li><div><span class="comment">           *                      'alignleft', 'aligncenter', 'alignright', 'alignnone'.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $html = apply_filters( 'image_send_to_editor_url', $html, esc_url_raw( $src ), $alt, $align );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return media_send_to_editor($html);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_POST['save'] ) ) {&nbsp;</div></li><li><div>      $errors['upload_notice'] = __('Saved.');&nbsp;</div></li><li><div>      wp_enqueue_script( 'admin-gallery' );&nbsp;</div></li><li><div>       return wp_iframe( 'media_upload_gallery_form', $errors );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } elseif ( ! empty( $_POST ) ) {&nbsp;</div></li><li><div>      $return = media_upload_form_handler();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_string($return) )&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      if ( is_array($return) )&nbsp;</div></li><li><div>          $errors = $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_GET['tab']) && $_GET['tab'] == 'type_url' ) {&nbsp;</div></li><li><div>      $type = 'image';&nbsp;</div></li><li><div>      if ( isset( $_GET['type'] ) && in_array( $_GET['type'], array( 'video', 'audio', 'file' ) ) )&nbsp;</div></li><li><div>          $type = $_GET['type'];&nbsp;</div></li><li><div>      return wp_iframe( 'media_upload_type_url_form', $type, $errors, $id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return wp_iframe( 'media_upload_type_form', 'image', $errors, $id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Downloads an image from the specified URL and attaches it to a post.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0 Introduced the `$return` parameter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file    The URL of the image to download.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $post_id The post ID the media is to be associated with.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $desc    Optional. Description of the image.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $return  Optional. Accepts 'html' (image tag html) or 'src' (URL). Default 'html'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|WP_Error Populated HTML img tag on success, WP_Error object otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_sideload_image( $file, $post_id, $desc = null, $return = 'html' ) {&nbsp;</div></li><li><div>  if ( ! empty( $file ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set variables for storage, fix file filename for query strings.</span>&nbsp;</div></li><li><div>      preg_match( '/[^\?]+\.(jpe?g|jpe|gif|png)\b/i', $file, $matches );&nbsp;</div></li><li><div>      if ( ! $matches ) {&nbsp;</div></li><li><div>          return new WP_Error( 'image_sideload_failed', __( 'Invalid image URL' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file_array = array();&nbsp;</div></li><li><div>      $file_array['name'] = basename( $matches[0] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Download file to temp location.</span>&nbsp;</div></li><li><div>      $file_array['tmp_name'] = download_url( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If error storing temporarily, return the error.</span>&nbsp;</div></li><li><div>      if ( is_wp_error( $file_array['tmp_name'] ) ) {&nbsp;</div></li><li><div>          return $file_array['tmp_name'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Do the validation and storage stuff.</span>&nbsp;</div></li><li><div>      $id = media_handle_sideload( $file_array, $post_id, $desc );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If error storing permanently, unlink.</span>&nbsp;</div></li><li><div>      if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>          @unlink( $file_array['tmp_name'] );&nbsp;</div></li><li><div>          return $id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $src = wp_get_attachment_url( $id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Finally, check to make sure the file has been saved, then return the HTML.</span>&nbsp;</div></li><li><div>  if ( ! empty( $src ) ) {&nbsp;</div></li><li><div>      if ( $return === 'src' ) {&nbsp;</div></li><li><div>          return $src;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $alt = isset( $desc ) ? esc_attr( $desc ) : '';&nbsp;</div></li><li><div>      $html = &quot;&lt;img src='$src' alt='$alt' /&gt;&quot;;&nbsp;</div></li><li><div>      return $html;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return new WP_Error( 'image_sideload_failed' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the legacy media uploader form in an iframe.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_gallery() {&nbsp;</div></li><li><div>  $errors = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($_POST) ) {&nbsp;</div></li><li><div>      $return = media_upload_form_handler();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_string($return) )&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      if ( is_array($return) )&nbsp;</div></li><li><div>          $errors = $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_enqueue_script('admin-gallery');&nbsp;</div></li><li><div>  return wp_iframe( 'media_upload_gallery_form', $errors );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the legacy media library form in an iframe.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|null</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_library() {&nbsp;</div></li><li><div>  $errors = array();&nbsp;</div></li><li><div>  if ( !empty($_POST) ) {&nbsp;</div></li><li><div>      $return = media_upload_form_handler();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_string($return) )&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      if ( is_array($return) )&nbsp;</div></li><li><div>          $errors = $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return wp_iframe( 'media_upload_library_form', $errors );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve HTML for the image alignment radio buttons with the specified one checked.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $checked</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_align_input_fields( $post, $checked = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($checked) )&nbsp;</div></li><li><div>      $checked = get_user_setting('align', 'none');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $alignments = array('none' =&gt; __('None'), 'left' =&gt; __('Left'), 'center' =&gt; __('Center'), 'right' =&gt; __('Right'));&nbsp;</div></li><li><div>  if ( !array_key_exists( (string) $checked, $alignments ) )&nbsp;</div></li><li><div>      $checked = 'none';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $out = array();&nbsp;</div></li><li><div>  foreach ( $alignments as $name =&gt; $label ) {&nbsp;</div></li><li><div>      $name = esc_attr($name);&nbsp;</div></li><li><div>      $out[] = &quot;&lt;input type='radio' name='attachments[{$post-&gt;ID}][align]' id='image-align-{$name}-{$post-&gt;ID}' value='$name'&quot;.&nbsp;</div></li><li><div>          ( $checked == $name ? &quot; checked='checked'&quot; : &quot;&quot; ) .&nbsp;</div></li><li><div>          &quot; /&gt;&lt;label for='image-align-{$name}-{$post-&gt;ID}' class='align image-align-{$name}-label'&gt;$label&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return join(&quot;\n&quot;, $out);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve HTML for the size radio buttons with the specified one checked.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool|string $check</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_size_input_fields( $post, $check = '' ) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the names and labels of the default image sizes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $size_names Array of image sizes and their names. Default values</span>&nbsp;</div></li><li><div><span class="comment">   *                          include 'Thumbnail', 'Medium', 'Large', 'Full Size'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $size_names = apply_filters( 'image_size_names_choose', array(&nbsp;</div></li><li><div>      'thumbnail' =&gt; __( 'Thumbnail' ), &nbsp;</div></li><li><div>      'medium' =&gt; __( 'Medium' ), &nbsp;</div></li><li><div>      'large' =&gt; __( 'Large' ), &nbsp;</div></li><li><div>      'full' =&gt; __( 'Full Size' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $check ) ) {&nbsp;</div></li><li><div>      $check = get_user_setting('imgsize', 'medium');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $out = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $size_names as $size =&gt; $label ) {&nbsp;</div></li><li><div>      $downsize = image_downsize( $post-&gt;ID, $size );&nbsp;</div></li><li><div>      $checked = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is this size selectable?</span>&nbsp;</div></li><li><div>      $enabled = ( $downsize[3] || 'full' == $size );&nbsp;</div></li><li><div>      $css_id = &quot;image-size-{$size}-{$post-&gt;ID}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this size is the default but that's not available, don't select it.</span>&nbsp;</div></li><li><div>      if ( $size == $check ) {&nbsp;</div></li><li><div>          if ( $enabled ) {&nbsp;</div></li><li><div>              $checked = &quot; checked='checked'&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $check = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( ! $check && $enabled && 'thumbnail' != $size ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * If $check is not enabled, default to the first available size</span>&nbsp;</div></li><li><div><span class="comment">           * that's bigger than a thumbnail.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $check = $size;&nbsp;</div></li><li><div>          $checked = &quot; checked='checked'&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $html = &quot;&lt;div class='image-size-item'&gt;&lt;input type='radio' &quot; . disabled( $enabled, false, false ) . &quot;name='attachments[$post-&gt;ID][image-size]' id='{$css_id}' value='{$size}'$checked /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $html .= &quot;&lt;label for='{$css_id}'&gt;$label&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only show the dimensions if that choice is available.</span>&nbsp;</div></li><li><div>      if ( $enabled ) {&nbsp;</div></li><li><div>          $html .= &quot; &lt;label for='{$css_id}' class='help'&gt;&quot; . sprintf( &quot;(%d&nbsp;&times;&nbsp;%d)&quot;, $downsize[1], $downsize[2] ). &quot;&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $html .= '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out[] = $html;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'label' =&gt; __( 'Size' ), &nbsp;</div></li><li><div>      'input' =&gt; 'html', &nbsp;</div></li><li><div>      'html' =&gt; join( &quot;\n&quot;, $out ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve HTML for the Link URL buttons with the default link type as specified.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url_type</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_link_input_fields($post, $url_type = '') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = wp_get_attachment_url($post-&gt;ID);&nbsp;</div></li><li><div>  $link = get_attachment_link($post-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($url_type) )&nbsp;</div></li><li><div>      $url_type = get_user_setting('urlbutton', 'post');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = '';&nbsp;</div></li><li><div>  if ( $url_type == 'file' )&nbsp;</div></li><li><div>      $url = $file;&nbsp;</div></li><li><div>  elseif ( $url_type == 'post' )&nbsp;</div></li><li><div>      $url = $link;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return &quot;&nbsp;</div></li><li><div>  &lt;input type='text' class='text urlfield' name='attachments[$post-&gt;ID][url]' value='&quot; . esc_attr($url) . &quot;' /&gt;&lt;br /&gt;&nbsp;</div></li><li><div>  &lt;button type='button' class='button urlnone' data-link-url=''&gt;&quot; . __('None') . &quot;&lt;/button&gt;&nbsp;</div></li><li><div>  &lt;button type='button' class='button urlfile' data-link-url='&quot; . esc_attr($file) . &quot;'&gt;&quot; . __('File URL') . &quot;&lt;/button&gt;&nbsp;</div></li><li><div>  &lt;button type='button' class='button urlpost' data-link-url='&quot; . esc_attr($link) . &quot;'&gt;&quot; . __('Attachment Post URL') . &quot;&lt;/button&gt;&nbsp;</div></li><li><div>&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output a textarea element for inputting an attachment caption.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $edit_post Attachment WP_Post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string HTML markup for the textarea element.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_caption_input_textarea($edit_post) {&nbsp;</div></li><li><div>  <span class="comment">// Post data is already escaped.</span>&nbsp;</div></li><li><div>  $name = &quot;attachments[{$edit_post-&gt;ID}][post_excerpt]&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return '&lt;textarea name=&quot;' . $name . '&quot; id=&quot;' . $name . '&quot;&gt;' . $edit_post-&gt;post_excerpt . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the image attachment fields to edit form fields.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $form_fields</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $post</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_attachment_fields_to_edit($form_fields, $post) {&nbsp;</div></li><li><div>  return $form_fields;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the single non-image attachment fields to edit form fields.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $form_fields An array of attachment form fields.</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post        The WP_Post attachment object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Filtered attachment form fields.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_single_attachment_fields_to_edit( $form_fields, $post ) {&nbsp;</div></li><li><div>  unset($form_fields['url'], $form_fields['align'], $form_fields['image-size']);&nbsp;</div></li><li><div>  return $form_fields;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the post non-image attachment fields to edito form fields.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $form_fields An array of attachment form fields.</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post        The WP_Post attachment object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Filtered attachment form fields.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_post_single_attachment_fields_to_edit( $form_fields, $post ) {&nbsp;</div></li><li><div>  unset($form_fields['image_url']);&nbsp;</div></li><li><div>  return $form_fields;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters input from media_upload_form_handler() and assigns a default</span>&nbsp;</div></li><li><div><span class="comment"> * post_title from the file name if none supplied.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Illustrates the use of the {@see 'attachment_fields_to_save'} filter</span>&nbsp;</div></li><li><div><span class="comment"> * which can be used to add default values to any field before saving to DB.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post       The WP_Post attachment object converted to an array.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $attachment An array of attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Filtered attachment post object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_attachment_fields_to_save( $post, $attachment ) {&nbsp;</div></li><li><div>  if ( substr( $post['post_mime_type'], 0, 5 ) == 'image' ) {&nbsp;</div></li><li><div>      if ( strlen( trim( $post['post_title'] ) ) == 0 ) {&nbsp;</div></li><li><div>          $attachment_url = ( isset( $post['attachment_url'] ) ) ? $post['attachment_url'] : $post['guid'];&nbsp;</div></li><li><div>          $post['post_title'] = preg_replace( '/\.\w+$/', '', wp_basename( $attachment_url ) );&nbsp;</div></li><li><div>          $post['errors']['post_title']['errors'][] = __( 'Empty Title filled from filename.' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the media element HTML to send to the editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $html</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer $attachment_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $attachment</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function image_media_send_to_editor($html, $attachment_id, $attachment) {&nbsp;</div></li><li><div>  $post = get_post($attachment_id);&nbsp;</div></li><li><div>  if ( substr($post-&gt;post_mime_type, 0, 5) == 'image' ) {&nbsp;</div></li><li><div>      $url = $attachment['url'];&nbsp;</div></li><li><div>      $align = !empty($attachment['align']) ? $attachment['align'] : 'none';&nbsp;</div></li><li><div>      $size = !empty($attachment['image-size']) ? $attachment['image-size'] : 'medium';&nbsp;</div></li><li><div>      $alt = !empty($attachment['image_alt']) ? $attachment['image_alt'] : '';&nbsp;</div></li><li><div>      $rel = ( strpos( $url, 'attachment_id') || $url === get_attachment_link( $attachment_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return get_image_send_to_editor($attachment_id, $attachment['post_excerpt'], $attachment['post_title'], $align, $url, $rel, $size, $alt);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $html;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the attachment fields to edit form fields.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $errors</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_attachment_fields_to_edit($post, $errors = null) {&nbsp;</div></li><li><div>  if ( is_int($post) )&nbsp;</div></li><li><div>      $post = get_post($post);&nbsp;</div></li><li><div>  if ( is_array($post) )&nbsp;</div></li><li><div>      $post = new WP_Post( (object) $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $image_url = wp_get_attachment_url($post-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $edit_post = sanitize_post($post, 'edit');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $form_fields = array(&nbsp;</div></li><li><div>      'post_title' =&gt; array(&nbsp;</div></li><li><div>          'label' =&gt; __('Title'), &nbsp;</div></li><li><div>          'value' =&gt; $edit_post-&gt;post_title&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'image_alt' =&gt; array(), &nbsp;</div></li><li><div>      'post_excerpt' =&gt; array(&nbsp;</div></li><li><div>          'label' =&gt; __('Caption'), &nbsp;</div></li><li><div>          'input' =&gt; 'html', &nbsp;</div></li><li><div>          'html' =&gt; wp_caption_input_textarea($edit_post)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'post_content' =&gt; array(&nbsp;</div></li><li><div>          'label' =&gt; __('Description'), &nbsp;</div></li><li><div>          'value' =&gt; $edit_post-&gt;post_content, &nbsp;</div></li><li><div>          'input' =&gt; 'textarea'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'url' =&gt; array(&nbsp;</div></li><li><div>          'label' =&gt; __('Link URL'), &nbsp;</div></li><li><div>          'input' =&gt; 'html', &nbsp;</div></li><li><div>          'html' =&gt; image_link_input_fields($post, get_option('image_default_link_type')), &nbsp;</div></li><li><div>          'helps' =&gt; __('Enter a link URL or click above for presets.')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'menu_order' =&gt; array(&nbsp;</div></li><li><div>          'label' =&gt; __('Order'), &nbsp;</div></li><li><div>          'value' =&gt; $edit_post-&gt;menu_order&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'image_url' =&gt; array(&nbsp;</div></li><li><div>          'label' =&gt; __('File URL'), &nbsp;</div></li><li><div>          'input' =&gt; 'html', &nbsp;</div></li><li><div>          'html' =&gt; &quot;&lt;input type='text' class='text urlfield' readonly='readonly' name='attachments[$post-&gt;ID][url]' value='&quot; . esc_attr($image_url) . &quot;' /&gt;&lt;br /&gt;&quot;, &nbsp;</div></li><li><div>          'value' =&gt; wp_get_attachment_url($post-&gt;ID), &nbsp;</div></li><li><div>          'helps' =&gt; __('Location of the uploaded file.')&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( get_attachment_taxonomies($post) as $taxonomy ) {&nbsp;</div></li><li><div>      $t = (array) get_taxonomy($taxonomy);&nbsp;</div></li><li><div>      if ( ! $t['public'] || ! $t['show_ui'] )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( empty($t['label']) )&nbsp;</div></li><li><div>          $t['label'] = $taxonomy;&nbsp;</div></li><li><div>      if ( empty($t['args']) )&nbsp;</div></li><li><div>          $t['args'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $terms = get_object_term_cache($post-&gt;ID, $taxonomy);&nbsp;</div></li><li><div>      if ( false === $terms )&nbsp;</div></li><li><div>          $terms = wp_get_object_terms($post-&gt;ID, $taxonomy, $t['args']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $terms as $term )&nbsp;</div></li><li><div>          $values[] = $term-&gt;slug;&nbsp;</div></li><li><div>      $t['value'] = join(', ', $values);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_fields[$taxonomy] = $t;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Merge default fields with their errors, so any key passed with the error (e.g. 'error', 'helps', 'value') will replace the default</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// The recursive merge is easily traversed with array casting: foreach ( (array) $things as $thing )</span></span>&nbsp;</div></li><li><div>  $form_fields = array_merge_recursive($form_fields, (array) $errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// This was formerly in image_attachment_fields_to_edit().</span>&nbsp;</div></li><li><div>  if ( substr($post-&gt;post_mime_type, 0, 5) == 'image' ) {&nbsp;</div></li><li><div>      $alt = get_post_meta($post-&gt;ID, '_wp_attachment_image_alt', true);&nbsp;</div></li><li><div>      if ( empty($alt) )&nbsp;</div></li><li><div>          $alt = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_fields['post_title']['required'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_fields['image_alt'] = array(&nbsp;</div></li><li><div>          'value' =&gt; $alt, &nbsp;</div></li><li><div>          'label' =&gt; __('Alternative Text'), &nbsp;</div></li><li><div>          'helps' =&gt; __('Alt text for the image, e.g. &#8220;The Mona Lisa&#8221;')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_fields['align'] = array(&nbsp;</div></li><li><div>          'label' =&gt; __('Alignment'), &nbsp;</div></li><li><div>          'input' =&gt; 'html', &nbsp;</div></li><li><div>          'html' =&gt; image_align_input_fields($post, get_option('image_default_align')), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_fields['image-size'] = image_size_input_fields( $post, get_option('image_default_size', 'medium') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      unset( $form_fields['image_alt'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the attachment fields to edit.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $form_fields An array of attachment form fields.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post        The WP_Post attachment object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $form_fields = apply_filters( 'attachment_fields_to_edit', $form_fields, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $form_fields;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve HTML for media items of post gallery.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The HTML markup retrieved will be created for the progress of SWF Upload</span>&nbsp;</div></li><li><div><span class="comment"> * component. Will also create link for showing and hiding the form to modify</span>&nbsp;</div></li><li><div><span class="comment"> * the image attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Query $wp_the_query</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id Optional. Post ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $errors Errors for attachment, if any.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_media_items( $post_id, $errors ) {&nbsp;</div></li><li><div>  $attachments = array();&nbsp;</div></li><li><div>  if ( $post_id ) {&nbsp;</div></li><li><div>      $post = get_post($post_id);&nbsp;</div></li><li><div>      if ( $post && $post-&gt;post_type == 'attachment' )&nbsp;</div></li><li><div>          $attachments = array($post-&gt;ID =&gt; $post);&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $attachments = get_children( array( 'post_parent' =&gt; $post_id, 'post_type' =&gt; 'attachment', 'orderby' =&gt; 'menu_order ASC, ID', 'order' =&gt; 'DESC') );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( is_array($GLOBALS['wp_the_query']-&gt;posts) )&nbsp;</div></li><li><div>          foreach ( $GLOBALS['wp_the_query']-&gt;posts as $attachment )&nbsp;</div></li><li><div>              $attachments[$attachment-&gt;ID] = $attachment;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  foreach ( (array) $attachments as $id =&gt; $attachment ) {&nbsp;</div></li><li><div>      if ( $attachment-&gt;post_status == 'trash' )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( $item = get_media_item( $id, array( 'errors' =&gt; isset($errors[$id]) ? $errors[$id] : null) ) )&nbsp;</div></li><li><div>          $output .= &quot;\n&lt;div id='media-item-$id' class='media-item child-of-$attachment-&gt;post_parent preloaded'&gt;&lt;div class='progress hidden'&gt;&lt;div class='bar'&gt;&lt;/div&gt;&lt;/div&gt;&lt;div id='media-upload-error-$id' class='hidden'&gt;&lt;/div&gt;&lt;div class='filename hidden'&gt;&lt;/div&gt;$item\n&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve HTML form for modifying the image attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $redir_tab</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $attachment_id Attachment ID for modification.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $args Optional. Override defaults.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string HTML form for attachment.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_media_item( $attachment_id, $args = null ) {&nbsp;</div></li><li><div>  global $redir_tab;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( $attachment_id = intval( $attachment_id ) ) && $thumb_url = wp_get_attachment_image_src( $attachment_id, 'thumbnail', true ) )&nbsp;</div></li><li><div>      $thumb_url = $thumb_url[0];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $thumb_url = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post( $attachment_id );&nbsp;</div></li><li><div>  $current_post_id = !empty( $_GET['post_id'] ) ? (int) $_GET['post_id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_args = array(&nbsp;</div></li><li><div>      'errors' =&gt; null, &nbsp;</div></li><li><div>      'send' =&gt; $current_post_id ? post_type_supports( get_post_type( $current_post_id ), 'editor' ) : true, &nbsp;</div></li><li><div>      'delete' =&gt; true, &nbsp;</div></li><li><div>      'toggle' =&gt; true, &nbsp;</div></li><li><div>      'show_title' =&gt; true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $default_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the arguments used to retrieve an image for the edit image form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see get_media_item</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args An array of arguments.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $r = apply_filters( 'get_media_item_args', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $toggle_on = __( 'Show' );&nbsp;</div></li><li><div>  $toggle_off = __( 'Hide' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = get_attached_file( $post-&gt;ID );&nbsp;</div></li><li><div>  $filename = esc_html( wp_basename( $file ) );&nbsp;</div></li><li><div>  $title = esc_attr( $post-&gt;post_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_mime_types = get_post_mime_types();&nbsp;</div></li><li><div>  $keys = array_keys( wp_match_mime_types( array_keys( $post_mime_types ), $post-&gt;post_mime_type ) );&nbsp;</div></li><li><div>  $type = reset( $keys );&nbsp;</div></li><li><div>  $type_html = &quot;&lt;input type='hidden' id='type-of-$attachment_id' value='&quot; . esc_attr( $type ) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $form_fields = get_attachment_fields_to_edit( $post, $r['errors'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $r['toggle'] ) {&nbsp;</div></li><li><div>      $class = empty( $r['errors'] ) ? 'startclosed' : 'startopen';&nbsp;</div></li><li><div>      $toggle_links = &quot;&nbsp;</div></li><li><div>  &lt;a class='toggle describe-toggle-on' href='#'&gt;$toggle_on&lt;/a&gt;&nbsp;</div></li><li><div>  &lt;a class='toggle describe-toggle-off' href='#'&gt;$toggle_off&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $class = '';&nbsp;</div></li><li><div>      $toggle_links = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $display_title = ( !empty( $title ) ) ? $title : $filename; <span class="comment">// $title shouldn't ever be empty, but just in case</span>&nbsp;</div></li><li><div>  $display_title = $r['show_title'] ? &quot;&lt;div class='filename new'&gt;&lt;span class='title'&gt;&quot; . wp_html_excerpt( $display_title, 60, '&hellip;' ) . &quot;&lt;/span&gt;&lt;/div&gt;&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $gallery = ( ( isset( $_REQUEST['tab'] ) && 'gallery' == $_REQUEST['tab'] ) || ( isset( $redir_tab ) && 'gallery' == $redir_tab ) );&nbsp;</div></li><li><div>  $order = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $form_fields as $key =&gt; $val ) {&nbsp;</div></li><li><div>      if ( 'menu_order' == $key ) {&nbsp;</div></li><li><div>          if ( $gallery )&nbsp;</div></li><li><div>              $order = &quot;&lt;div class='menu_order'&gt; &lt;input class='menu_order_input' type='text' id='attachments[$attachment_id][menu_order]' name='attachments[$attachment_id][menu_order]' value='&quot; . esc_attr( $val['value'] ). &quot;' /&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $order = &quot;&lt;input type='hidden' name='attachments[$attachment_id][menu_order]' value='&quot; . esc_attr( $val['value'] ) . &quot;' /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          unset( $form_fields['menu_order'] );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $media_dims = '';&nbsp;</div></li><li><div>  $meta = wp_get_attachment_metadata( $post-&gt;ID );&nbsp;</div></li><li><div>  if ( isset( $meta['width'], $meta['height'] ) )&nbsp;</div></li><li><div>      $media_dims .= &quot;&lt;span id='media-dims-$post-&gt;ID'&gt;{$meta['width']}&nbsp;&times;&nbsp;{$meta['height']}&lt;/span&gt; &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the media metadata.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $media_dims The HTML markup containing the media dimensions.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post       The WP_Post attachment object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $media_dims = apply_filters( 'media_meta', $media_dims, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $image_edit_button = '';&nbsp;</div></li><li><div>  if ( wp_attachment_is_image( $post-&gt;ID ) && wp_image_editor_supports( array( 'mime_type' =&gt; $post-&gt;post_mime_type ) ) ) {&nbsp;</div></li><li><div>      $nonce = wp_create_nonce( &quot;image_editor-$post-&gt;ID&quot; );&nbsp;</div></li><li><div>      $image_edit_button = &quot;&lt;input type='button' id='imgedit-open-btn-$post-&gt;ID' onclick='imageEdit.open( $post-&gt;ID, \&quot;$nonce\&quot; )' class='button' value='&quot; . esc_attr__( 'Edit Image' ) . &quot;' /&gt; &lt;span class='spinner'&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $attachment_url = get_permalink( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $item = &quot;&nbsp;</div></li><li><div>  $type_html&nbsp;</div></li><li><div>  $toggle_links&nbsp;</div></li><li><div>  $order&nbsp;</div></li><li><div>  $display_title&nbsp;</div></li><li><div>  &lt;table class='slidetoggle describe $class'&gt;&nbsp;</div></li><li><div>      &lt;thead class='media-item-info' id='media-head-$post-&gt;ID'&gt;&nbsp;</div></li><li><div>      &lt;tr&gt;&nbsp;</div></li><li><div>          &lt;td class='A1B1' id='thumbnail-head-$post-&gt;ID'&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;a href='$attachment_url' target='_blank'&gt;&lt;img class='thumbnail' src='$thumb_url' alt='' /&gt;&lt;/a&gt;&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;p&gt;$image_edit_button&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;td&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;strong&gt;&quot; . __('File name:') . &quot;&lt;/strong&gt; $filename&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;strong&gt;&quot; . __('File type:') . &quot;&lt;/strong&gt; $post-&gt;post_mime_type&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;strong&gt;&quot; . __('Upload date:') . &quot;&lt;/strong&gt; &quot; . mysql2date( __( 'F j, Y' ), $post-&gt;post_date ). '&lt;/p&gt;';&nbsp;</div></li><li><div>          if ( !empty( $media_dims ) )&nbsp;</div></li><li><div>              $item .= &quot;&lt;p&gt;&lt;strong&gt;&quot; . __('Dimensions:') . &quot;&lt;/strong&gt; $media_dims&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $item .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $item .= &quot;&nbsp;</div></li><li><div>      &lt;/thead&gt;&nbsp;</div></li><li><div>      &lt;tbody&gt;&nbsp;</div></li><li><div>      &lt;tr&gt;&lt;td colspan='2' class='imgedit-response' id='imgedit-response-$post-&gt;ID'&gt;&lt;/td&gt;&lt;/tr&gt;\n&nbsp;</div></li><li><div>      &lt;tr&gt;&lt;td style='display:none' colspan='2' class='image-editor' id='image-editor-$post-&gt;ID'&gt;&lt;/td&gt;&lt;/tr&gt;\n&nbsp;</div></li><li><div>      &lt;tr&gt;&lt;td colspan='2'&gt;&lt;p class='media-types media-types-required-info'&gt;&quot; . sprintf( __( 'Required fields are marked %s' ), '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;' ) . &quot;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'input' =&gt; 'text', &nbsp;</div></li><li><div>      'required' =&gt; false, &nbsp;</div></li><li><div>      'value' =&gt; '', &nbsp;</div></li><li><div>      'extra_rows' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $r['send'] ) {&nbsp;</div></li><li><div>      $r['send'] = get_submit_button( __( 'Insert into Post' ), '', &quot;send[$attachment_id]&quot;, false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $delete = empty( $r['delete'] ) ? '' : $r['delete'];&nbsp;</div></li><li><div>  if ( $delete && current_user_can( 'delete_post', $attachment_id ) ) {&nbsp;</div></li><li><div>      if ( !EMPTY_TRASH_DAYS ) {&nbsp;</div></li><li><div>          $delete = &quot;&lt;a href='&quot; . wp_nonce_url( &quot;post.php?action=delete&amp;post=$attachment_id&quot;, 'delete-post_' . $attachment_id ) . &quot;' id='del[$attachment_id]' class='delete-permanently'&gt;&quot; . __( 'Delete Permanently' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      } elseif ( !MEDIA_TRASH ) {&nbsp;</div></li><li><div>          $delete = &quot;&lt;a href='#' class='del-link' onclick=\&quot;document.getElementById('del_attachment_$attachment_id').style.display='block';return false;\&quot;&gt;&quot; . __( 'Delete' ) . &quot;&lt;/a&gt;&nbsp;</div></li><li><div>           &lt;div id='del_attachment_$attachment_id' class='del-attachment' style='display:none;'&gt;&quot; .&nbsp;</div></li><li><div>           <span class="comment">/** translators: %s: file name */</span>&nbsp;</div></li><li><div>          '&lt;p&gt;' . sprintf( __( 'You are about to delete %s.' ), '&lt;strong&gt;' . $filename . '&lt;/strong&gt;' ) . &quot;&lt;/p&gt;&nbsp;</div></li><li><div>           &lt;a href='&quot; . wp_nonce_url( &quot;post.php?action=delete&amp;post=$attachment_id&quot;, 'delete-post_' . $attachment_id ) . &quot;' id='del[$attachment_id]' class='button'&gt;&quot; . __( 'Continue' ) . &quot;&lt;/a&gt;&nbsp;</div></li><li><div>           &lt;a href='#' class='button' onclick=\&quot;this.parentNode.style.display='none';return false;\&quot;&gt;&quot; . __( 'Cancel' ) . &quot;&lt;/a&gt;&nbsp;</div></li><li><div>           &lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $delete = &quot;&lt;a href='&quot; . wp_nonce_url( &quot;post.php?action=trash&amp;post=$attachment_id&quot;, 'trash-post_' . $attachment_id ) . &quot;' id='del[$attachment_id]' class='delete'&gt;&quot; . __( 'Move to Trash' ) . &quot;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;a href='&quot; . wp_nonce_url( &quot;post.php?action=untrash&amp;post=$attachment_id&quot;, 'untrash-post_' . $attachment_id ) . &quot;' id='undo[$attachment_id]' class='undo hidden'&gt;&quot; . __( 'Undo' ) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $delete = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thumbnail = '';&nbsp;</div></li><li><div>  $calling_post_id = 0;&nbsp;</div></li><li><div>  if ( isset( $_GET['post_id'] ) ) {&nbsp;</div></li><li><div>      $calling_post_id = absint( $_GET['post_id'] );&nbsp;</div></li><li><div>  } elseif ( isset( $_POST ) && count( $_POST ) ) {<span class="comment">// Like for async-upload where $_GET['post_id'] isn't set</span>&nbsp;</div></li><li><div>      $calling_post_id = $post-&gt;post_parent;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( 'image' == $type && $calling_post_id && current_theme_supports( 'post-thumbnails', get_post_type( $calling_post_id ) )&nbsp;</div></li><li><div>      && post_type_supports( get_post_type( $calling_post_id ), 'thumbnail' ) && get_post_thumbnail_id( $calling_post_id ) != $attachment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $calling_post = get_post( $calling_post_id );&nbsp;</div></li><li><div>      $calling_post_type_object = get_post_type_object( $calling_post-&gt;post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ajax_nonce = wp_create_nonce( &quot;set_post_thumbnail-$calling_post_id&quot; );&nbsp;</div></li><li><div>      $thumbnail = &quot;&lt;a class='wp-post-thumbnail' id='wp-post-thumbnail-&quot; . $attachment_id . &quot;' href='#' onclick='WPSetAsThumbnail(\&quot;$attachment_id\&quot;, \&quot;$ajax_nonce\&quot;);return false;'&gt;&quot; . esc_html( $calling_post_type_object-&gt;labels-&gt;use_featured_image ) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( $r['send'] || $thumbnail || $delete ) && !isset( $form_fields['buttons'] ) ) {&nbsp;</div></li><li><div>      $form_fields['buttons'] = array( 'tr' =&gt; &quot;\t\t&lt;tr class='submit'&gt;&lt;td&gt;&lt;/td&gt;&lt;td class='savesend'&gt;&quot; . $r['send'] . &quot; $thumbnail $delete&lt;/td&gt;&lt;/tr&gt;\n&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $hidden_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $form_fields as $id =&gt; $field ) {&nbsp;</div></li><li><div>      if ( $id[0] == '_' )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field['tr'] ) ) {&nbsp;</div></li><li><div>          $item .= $field['tr'];&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $field = array_merge( $defaults, $field );&nbsp;</div></li><li><div>      $name = &quot;attachments[$attachment_id][$id]&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $field['input'] == 'hidden' ) {&nbsp;</div></li><li><div>          $hidden_fields[$name] = $field['value'];&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $required = $field['required'] ? '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;' : '';&nbsp;</div></li><li><div>      $required_attr = $field['required'] ? ' required' : '';&nbsp;</div></li><li><div>      $aria_required = $field['required'] ? &quot; aria-required='true'&quot; : '';&nbsp;</div></li><li><div>      $class = $id;&nbsp;</div></li><li><div>      $class .= $field['required'] ? ' form-required' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item .= &quot;\t\t&lt;tr class='$class'&gt;\n\t\t\t&lt;th scope='row' class='label'&gt;&lt;label for='$name'&gt;&lt;span class='alignleft'&gt;{$field['label']}{$required}&lt;/span&gt;&lt;br class='clear' /&gt;&lt;/label&gt;&lt;/th&gt;\n\t\t\t&lt;td class='field'&gt;&quot;;&nbsp;</div></li><li><div>      if ( !empty( $field[ $field['input'] ] ) )&nbsp;</div></li><li><div>          $item .= $field[ $field['input'] ];&nbsp;</div></li><li><div>      elseif ( $field['input'] == 'textarea' ) {&nbsp;</div></li><li><div>          if ( 'post_content' == $id && user_can_richedit() ) {&nbsp;</div></li><li><div>              <span class="comment">// Sanitize_post() skips the post_content when user_can_richedit.</span>&nbsp;</div></li><li><div>              $field['value'] = htmlspecialchars( $field['value'], ENT_QUOTES );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Post_excerpt is already escaped by sanitize_post() in get_attachment_fields_to_edit().</span>&nbsp;</div></li><li><div>          $item .= &quot;&lt;textarea id='$name' name='$name'{$required_attr}{$aria_required}&gt;&quot; . $field['value'] . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $item .= &quot;&lt;input type='text' class='text' id='$name' name='$name' value='&quot; . esc_attr( $field['value'] ) . &quot;'{$required_attr}{$aria_required} /&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( !empty( $field['helps'] ) )&nbsp;</div></li><li><div>          $item .= &quot;&lt;p class='help'&gt;&quot; . join( &quot;&lt;/p&gt;\n&lt;p class='help'&gt;&quot;, array_unique( (array) $field['helps'] ) ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>      $item .= &quot;&lt;/td&gt;\n\t\t&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $extra_rows = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field['errors'] ) )&nbsp;</div></li><li><div>          foreach ( array_unique( (array) $field['errors'] ) as $error )&nbsp;</div></li><li><div>              $extra_rows['error'][] = $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field['extra_rows'] ) )&nbsp;</div></li><li><div>          foreach ( $field['extra_rows'] as $class =&gt; $rows )&nbsp;</div></li><li><div>              foreach ( (array) $rows as $html )&nbsp;</div></li><li><div>                  $extra_rows[$class][] = $html;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $extra_rows as $class =&gt; $rows )&nbsp;</div></li><li><div>          foreach ( $rows as $html )&nbsp;</div></li><li><div>              $item .= &quot;\t\t&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class='$class'&gt;$html&lt;/td&gt;&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $form_fields['_final'] ) )&nbsp;</div></li><li><div>      $item .= &quot;\t\t&lt;tr class='final'&gt;&lt;td colspan='2'&gt;{$form_fields['_final']}&lt;/td&gt;&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>  $item .= &quot;\t&lt;/tbody&gt;\n&quot;;&nbsp;</div></li><li><div>  $item .= &quot;\t&lt;/table&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $hidden_fields as $name =&gt; $value )&nbsp;</div></li><li><div>      $item .= &quot;\t&lt;input type='hidden' name='$name' id='$name' value='&quot; . esc_attr( $value ) . &quot;' /&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post-&gt;post_parent &lt; 1 && isset( $_REQUEST['post_id'] ) ) {&nbsp;</div></li><li><div>      $parent = (int) $_REQUEST['post_id'];&nbsp;</div></li><li><div>      $parent_name = &quot;attachments[$attachment_id][post_parent]&quot;;&nbsp;</div></li><li><div>      $item .= &quot;\t&lt;input type='hidden' name='$parent_name' id='$parent_name' value='$parent' /&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $item;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $attachment_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_compat_media_markup( $attachment_id, $args = null ) {&nbsp;</div></li><li><div>  $post = get_post( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_args = array(&nbsp;</div></li><li><div>      'errors' =&gt; null, &nbsp;</div></li><li><div>      'in_modal' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_can_edit = current_user_can( 'edit_post', $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $default_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $args = apply_filters( 'get_media_item_args', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $form_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $args['in_modal'] ) {&nbsp;</div></li><li><div>      foreach ( get_attachment_taxonomies($post) as $taxonomy ) {&nbsp;</div></li><li><div>          $t = (array) get_taxonomy($taxonomy);&nbsp;</div></li><li><div>          if ( ! $t['public'] || ! $t['show_ui'] )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( empty($t['label']) )&nbsp;</div></li><li><div>              $t['label'] = $taxonomy;&nbsp;</div></li><li><div>          if ( empty($t['args']) )&nbsp;</div></li><li><div>              $t['args'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $terms = get_object_term_cache($post-&gt;ID, $taxonomy);&nbsp;</div></li><li><div>          if ( false === $terms )&nbsp;</div></li><li><div>              $terms = wp_get_object_terms($post-&gt;ID, $taxonomy, $t['args']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $terms as $term )&nbsp;</div></li><li><div>              $values[] = $term-&gt;slug;&nbsp;</div></li><li><div>          $t['value'] = join(', ', $values);&nbsp;</div></li><li><div>          $t['taxonomy'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $form_fields[$taxonomy] = $t;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Merge default fields with their errors, so any key passed with the error (e.g. 'error', 'helps', 'value') will replace the default</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// The recursive merge is easily traversed with array casting: foreach ( (array) $things as $thing )</span></span>&nbsp;</div></li><li><div>  $form_fields = array_merge_recursive($form_fields, (array) $args['errors'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $form_fields = apply_filters( 'attachment_fields_to_edit', $form_fields, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset( $form_fields['image-size'], $form_fields['align'], $form_fields['image_alt'], &nbsp;</div></li><li><div>      $form_fields['post_title'], $form_fields['post_excerpt'], $form_fields['post_content'], &nbsp;</div></li><li><div>      $form_fields['url'], $form_fields['menu_order'], $form_fields['image_url'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $media_meta = apply_filters( 'media_meta', '', $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'input' =&gt; 'text', &nbsp;</div></li><li><div>      'required' =&gt; false, &nbsp;</div></li><li><div>      'value' =&gt; '', &nbsp;</div></li><li><div>      'extra_rows' =&gt; array(), &nbsp;</div></li><li><div>      'show_in_edit' =&gt; true, &nbsp;</div></li><li><div>      'show_in_modal' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $hidden_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $item = '';&nbsp;</div></li><li><div>  foreach ( $form_fields as $id =&gt; $field ) {&nbsp;</div></li><li><div>      if ( $id[0] == '_' )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $name = &quot;attachments[$attachment_id][$id]&quot;;&nbsp;</div></li><li><div>      $id_attr = &quot;attachments-$attachment_id-$id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field['tr'] ) ) {&nbsp;</div></li><li><div>          $item .= $field['tr'];&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $field = array_merge( $defaults, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( ! $field['show_in_edit'] && ! $args['in_modal'] ) || ( ! $field['show_in_modal'] && $args['in_modal'] ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $field['input'] == 'hidden' ) {&nbsp;</div></li><li><div>          $hidden_fields[$name] = $field['value'];&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $readonly = ! $user_can_edit && ! empty( $field['taxonomy'] ) ? &quot; readonly='readonly' &quot; : '';&nbsp;</div></li><li><div>      $required = $field['required'] ? '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;' : '';&nbsp;</div></li><li><div>      $required_attr = $field['required'] ? ' required' : '';&nbsp;</div></li><li><div>      $aria_required = $field['required'] ? &quot; aria-required='true'&quot; : '';&nbsp;</div></li><li><div>      $class = 'compat-field-' . $id;&nbsp;</div></li><li><div>      $class .= $field['required'] ? ' form-required' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item .= &quot;\t\t&lt;tr class='$class'&gt;&quot;;&nbsp;</div></li><li><div>      $item .= &quot;\t\t\t&lt;th scope='row' class='label'&gt;&lt;label for='$id_attr'&gt;&lt;span class='alignleft'&gt;{$field['label']}&lt;/span&gt;$required&lt;br class='clear' /&gt;&lt;/label&gt;&quot;;&nbsp;</div></li><li><div>      $item .= &quot;&lt;/th&gt;\n\t\t\t&lt;td class='field'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field[ $field['input'] ] ) )&nbsp;</div></li><li><div>          $item .= $field[ $field['input'] ];&nbsp;</div></li><li><div>      elseif ( $field['input'] == 'textarea' ) {&nbsp;</div></li><li><div>          if ( 'post_content' == $id && user_can_richedit() ) {&nbsp;</div></li><li><div>              <span class="comment">// sanitize_post() skips the post_content when user_can_richedit.</span>&nbsp;</div></li><li><div>              $field['value'] = htmlspecialchars( $field['value'], ENT_QUOTES );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $item .= &quot;&lt;textarea id='$id_attr' name='$name'{$required_attr}{$aria_required}&gt;&quot; . $field['value'] . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $item .= &quot;&lt;input type='text' class='text' id='$id_attr' name='$name' value='&quot; . esc_attr( $field['value'] ) . &quot;' $readonly{$required_attr}{$aria_required} /&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( !empty( $field['helps'] ) )&nbsp;</div></li><li><div>          $item .= &quot;&lt;p class='help'&gt;&quot; . join( &quot;&lt;/p&gt;\n&lt;p class='help'&gt;&quot;, array_unique( (array) $field['helps'] ) ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>      $item .= &quot;&lt;/td&gt;\n\t\t&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $extra_rows = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field['errors'] ) )&nbsp;</div></li><li><div>          foreach ( array_unique( (array) $field['errors'] ) as $error )&nbsp;</div></li><li><div>              $extra_rows['error'][] = $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $field['extra_rows'] ) )&nbsp;</div></li><li><div>          foreach ( $field['extra_rows'] as $class =&gt; $rows )&nbsp;</div></li><li><div>              foreach ( (array) $rows as $html )&nbsp;</div></li><li><div>                  $extra_rows[$class][] = $html;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $extra_rows as $class =&gt; $rows )&nbsp;</div></li><li><div>          foreach ( $rows as $html )&nbsp;</div></li><li><div>              $item .= &quot;\t\t&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class='$class'&gt;$html&lt;/td&gt;&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $form_fields['_final'] ) )&nbsp;</div></li><li><div>      $item .= &quot;\t\t&lt;tr class='final'&gt;&lt;td colspan='2'&gt;{$form_fields['_final']}&lt;/td&gt;&lt;/tr&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $item ) {&nbsp;</div></li><li><div>      $item = '&lt;p class=&quot;media-types media-types-required-info&quot;&gt;' .&nbsp;</div></li><li><div>          sprintf( __( 'Required fields are marked %s' ), '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;' ) . '&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;table class=&quot;compat-attachment-fields&quot;&gt;' . $item . '&lt;/table&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $hidden_fields as $hidden_field =&gt; $value ) {&nbsp;</div></li><li><div>      $item .= '&lt;input type=&quot;hidden&quot; name=&quot;' . esc_attr( $hidden_field ) . '&quot; value=&quot;' . esc_attr( $value ) . '&quot; /&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $item )&nbsp;</div></li><li><div>      $item = '&lt;input type=&quot;hidden&quot; name=&quot;attachments[' . $attachment_id . '][menu_order]&quot; value=&quot;' . esc_attr( $post-&gt;menu_order ) . '&quot; /&gt;' . $item;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'item' =&gt; $item, &nbsp;</div></li><li><div>      'meta' =&gt; $media_meta, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the legacy media upload header.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_header() {&nbsp;</div></li><li><div>  $post_id = isset( $_REQUEST['post_id'] ) ? intval( $_REQUEST['post_id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo '&lt;script type=&quot;text/javascript&quot;&gt;post_id = ' . $post_id . ';&lt;/script&gt;';&nbsp;</div></li><li><div>  if ( empty( $_GET['chromeless'] ) ) {&nbsp;</div></li><li><div>      echo '&lt;div id=&quot;media-upload-header&quot;&gt;';&nbsp;</div></li><li><div>      the_media_upload_tabs();&nbsp;</div></li><li><div>      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the legacy media upload form.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $type</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $tab</span>&nbsp;</div></li><li><div><span class="comment"> * @global bool   $is_IE</span>&nbsp;</div></li><li><div><span class="comment"> * @global bool   $is_opera</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $errors</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_form( $errors = null ) {&nbsp;</div></li><li><div>  global $type, $tab, $is_IE, $is_opera;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! _device_can_upload() ) {&nbsp;</div></li><li><div>      echo '&lt;p&gt;' . sprintf( __('The web browser on your device cannot be used to upload files. You may be able to use the &lt;a href=&quot;%s&quot;&gt;native app for your device&lt;/a&gt; instead.'), 'https:<span class="comment">//apps.wordpress.org/' ) . '&lt;/p&gt;';</span>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $upload_action_url = admin_url('async-upload.php');&nbsp;</div></li><li><div>  $post_id = isset($_REQUEST['post_id']) ? intval($_REQUEST['post_id']) : 0;&nbsp;</div></li><li><div>  $_type = isset($type) ? $type : '';&nbsp;</div></li><li><div>  $_tab = isset($tab) ? $tab : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $max_upload_size = wp_max_upload_size();&nbsp;</div></li><li><div>  if ( ! $max_upload_size ) {&nbsp;</div></li><li><div>      $max_upload_size = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div id=&quot;media-upload-notice&quot;&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (isset($errors['upload_notice']) )&nbsp;</div></li><li><div>      echo $errors['upload_notice'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;media-upload-error&quot;&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (isset($errors['upload_error']) && is_wp_error($errors['upload_error']))&nbsp;</div></li><li><div>      echo $errors['upload_error']-&gt;get_error_message();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>if ( is_multisite() && !is_upload_space_available() ) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when an upload will exceed the defined upload space quota for a network site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'upload_ui_over_quota' );&nbsp;</div></li><li><div>  return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fires just before the legacy (pre-3.5.0) upload interface is loaded.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>do_action( 'pre-upload-ui' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$post_params = array(&nbsp;</div></li><li><div>  &quot;post_id&quot; =&gt; $post_id, &nbsp;</div></li><li><div>  &quot;_wpnonce&quot; =&gt; wp_create_nonce('media-form'), &nbsp;</div></li><li><div>  &quot;type&quot; =&gt; $_type, &nbsp;</div></li><li><div>  &quot;tab&quot; =&gt; $_tab, &nbsp;</div></li><li><div>  &quot;short&quot; =&gt; &quot;1&quot;, &nbsp;</div></li><li><div>);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters the media upload post parameters.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0 As 'swfupload_post_params'</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post_params An array of media upload parameters used by Plupload.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>$post_params = apply_filters( 'upload_post_params', $post_params );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$plupload_init = array(&nbsp;</div></li><li><div>  'runtimes' =&gt; 'html5, flash, silverlight, html4', &nbsp;</div></li><li><div>  'browse_button' =&gt; 'plupload-browse-button', &nbsp;</div></li><li><div>  'container' =&gt; 'plupload-upload-ui', &nbsp;</div></li><li><div>  'drop_element' =&gt; 'drag-drop-area', &nbsp;</div></li><li><div>  'file_data_name' =&gt; 'async-upload', &nbsp;</div></li><li><div>  'url' =&gt; $upload_action_url, &nbsp;</div></li><li><div>  'flash_swf_url' =&gt; includes_url( 'js/plupload/plupload.flash.swf' ), &nbsp;</div></li><li><div>  'silverlight_xap_url' =&gt; includes_url( 'js/plupload/plupload.silverlight.xap' ), &nbsp;</div></li><li><div>  'filters' =&gt; array(&nbsp;</div></li><li><div>      'max_file_size' =&gt; $max_upload_size . 'b', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>  'multipart_params' =&gt; $post_params, &nbsp;</div></li><li><div>);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Currently only iOS Safari supports multiple files uploading but iOS 7.x has a bug that prevents uploading of videos</span>&nbsp;</div></li><li><div><span class="comment">// when enabled. See #29602.</span>&nbsp;</div></li><li><div>if ( wp_is_mobile() && strpos( $_SERVER['HTTP_USER_AGENT'], 'OS 7_' ) !== false &&&nbsp;</div></li><li><div>  strpos( $_SERVER['HTTP_USER_AGENT'], 'like Mac OS X' ) !== false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $plupload_init['multi_selection'] = false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters the default Plupload settings.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $plupload_init An array of default settings used by Plupload.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>$plupload_init = apply_filters( 'plupload_init', $plupload_init );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">// Verify size is an int. If not return default value.</span>&nbsp;</div></li><li><div>$large_size_h = absint( get_option('large_size_h') );&nbsp;</div></li><li><div>if( !$large_size_h )&nbsp;</div></li><li><div>  $large_size_h = 1024;&nbsp;</div></li><li><div>$large_size_w = absint( get_option('large_size_w') );&nbsp;</div></li><li><div>if( !$large_size_w )&nbsp;</div></li><li><div>  $large_size_w = 1024;&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>var resize_height = &lt;?php echo $large_size_h; ?&gt;, resize_width = &lt;?php echo $large_size_w; ?&gt;, &nbsp;</div></li><li><div>wpUploaderInit = &lt;?php echo wp_json_encode( $plupload_init ); ?&gt;;&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div id=&quot;plupload-upload-ui&quot; class=&quot;hide-if-no-js&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fires before the upload interface loads.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0 As 'pre-flash-upload-ui'</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>do_action( 'pre-plupload-upload-ui' ); ?&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;drag-drop-area&quot;&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;drag-drop-inside&quot;&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;drag-drop-info&quot;&gt;&lt;?php _e('Drop files here'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php _ex('or', 'Uploader: Drop files here - or - Select Files'); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;drag-drop-buttons&quot;&gt;&lt;input id=&quot;plupload-browse-button&quot; type=&quot;button&quot; value=&quot;&lt;?php esc_attr_e('Select Files'); ?&gt;&quot; class=&quot;button&quot; /&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fires after the upload interface loads.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0 As 'post-flash-upload-ui'</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>do_action( 'post-plupload-upload-ui' ); ?&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div id=&quot;html-upload-ui&quot; class=&quot;hide-if-js&quot;&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before the upload button in the media upload interface.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'pre-html-upload-ui' );&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;p id=&quot;async-upload-wrap&quot;&gt;&nbsp;</div></li><li><div>      &lt;label class=&quot;screen-reader-text&quot; for=&quot;async-upload&quot;&gt;&lt;?php _e('Upload'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;file&quot; name=&quot;async-upload&quot; id=&quot;async-upload&quot; /&gt;&nbsp;</div></li><li><div>      &lt;?php submit_button( __( 'Upload' ), 'primary', 'html-upload', false ); ?&gt;&nbsp;</div></li><li><div>      &lt;a href=&quot;#&quot; onclick=&quot;try{top.tb_remove();}catch(e) {}; return false;&quot;&gt;&lt;?php _e('Cancel'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fires after the upload button in the media upload interface.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>do_action( 'post-html-upload-ui' );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;p class=&quot;max-upload-size&quot;&gt;&lt;?php printf( __( 'Maximum upload file size: %s.' ), esc_html( size_format( $max_upload_size ) ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires on the post upload UI screen.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Legacy (pre-3.5.0) media workflow hook.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'post-upload-ui' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the legacy media upload form for a given media type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $errors</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer $id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_type_form($type = 'file', $errors = null, $id = null) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  media_upload_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = isset( $_REQUEST['post_id'] )? intval( $_REQUEST['post_id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $form_action_url = admin_url(&quot;media-upload.php?type=$type&tab=type&post_id=$post_id&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the media upload form action URL.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $form_action_url The media upload form action URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type            The type of media. Default 'file'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $form_action_url = apply_filters( 'media_upload_form_url', $form_action_url, $type );&nbsp;</div></li><li><div>  $form_class = 'media-upload-form type-form validate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_user_setting('uploader') )&nbsp;</div></li><li><div>      $form_class .= ' html-uploader';&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;&lt;?php echo esc_url( $form_action_url ); ?&gt;&quot; class=&quot;&lt;?php echo $form_class; ?&gt;&quot; id=&quot;&lt;?php echo $type; ?&gt;-form&quot;&gt;&nbsp;</div></li><li><div>&lt;?php submit_button( '', 'hidden', 'save', false ); ?&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;post_id&quot; id=&quot;post_id&quot; value=&quot;&lt;?php echo (int) $post_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;?php wp_nonce_field('media-form'); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;h3 class=&quot;media-title&quot;&gt;&lt;?php _e('Add media files from your computer'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php media_upload_form( $errors ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>jQuery(function($) {&nbsp;</div></li><li><div>  var preloaded = $(&quot;.media-item.preloaded&quot;);&nbsp;</div></li><li><div>  if ( preloaded.length &gt; 0 ) {&nbsp;</div></li><li><div>      preloaded.each(function() {prepareMediaItem({id:this.id.replace(/[^0-9]/g, '')}, '');});&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  updateMediaForm();&nbsp;</div></li><li><div>});&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;media-items&quot;&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( $id ) {&nbsp;</div></li><li><div>  if ( !is_wp_error($id) ) {&nbsp;</div></li><li><div>      add_filter('attachment_fields_to_edit', 'media_post_single_attachment_fields_to_edit', 10, 2);&nbsp;</div></li><li><div>      echo get_media_items( $id, $errors );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      echo '&lt;div id=&quot;media-upload-error&quot;&gt;'.esc_html($id-&gt;get_error_message()).'&lt;/div&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;p class=&quot;savebutton ml-submit&quot;&gt;&nbsp;</div></li><li><div>&lt;?php submit_button( __( 'Save all changes' ), '', 'save', false ); ?&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the legacy media upload form for external media.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $errors</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer $id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_type_url_form($type = null, $errors = null, $id = null) {&nbsp;</div></li><li><div>  if ( null === $type )&nbsp;</div></li><li><div>      $type = 'image';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  media_upload_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = isset( $_REQUEST['post_id'] ) ? intval( $_REQUEST['post_id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $form_action_url = admin_url(&quot;media-upload.php?type=$type&tab=type&post_id=$post_id&quot;);&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $form_action_url = apply_filters( 'media_upload_form_url', $form_action_url, $type );&nbsp;</div></li><li><div>  $form_class = 'media-upload-form type-form validate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_user_setting('uploader') )&nbsp;</div></li><li><div>      $form_class .= ' html-uploader';&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;&lt;?php echo esc_url( $form_action_url ); ?&gt;&quot; class=&quot;&lt;?php echo $form_class; ?&gt;&quot; id=&quot;&lt;?php echo $type; ?&gt;-form&quot;&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;post_id&quot; id=&quot;post_id&quot; value=&quot;&lt;?php echo (int) $post_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;?php wp_nonce_field('media-form'); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;h3 class=&quot;media-title&quot;&gt;&lt;?php _e('Insert media from another website'); ?&gt;&lt;/h3&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>var addExtImage = {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  width : '', &nbsp;</div></li><li><div>  height : '', &nbsp;</div></li><li><div>  align : 'alignnone', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  insert : function() {&nbsp;</div></li><li><div>      var t = this, html, f = document.forms[0], cls, title = '', alt = '', caption = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == f.src.value || '' == t.width )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( f.alt.value )&nbsp;</div></li><li><div>          alt = f.alt.value.replace(/'/g, '&#039;').replace(/&quot;/g, '&quot;').replace(/&lt;/g, '&lt;').replace(/&gt;/g, '&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'disable_captions', '' ) ) {&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      if ( f.caption.value ) {&nbsp;</div></li><li><div>          caption = f.caption.value.replace(/\r\n|\r/g, '\n');&nbsp;</div></li><li><div>          caption = caption.replace(/&lt;[a-zA-Z0-9]+( [^&lt;&gt;]+)?&gt;/g, function(a) {&nbsp;</div></li><li><div>              return a.replace(/[\r\n\t]+/, ' ');&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          caption = caption.replace(/\s*\n\s*/g, '&lt;br /&gt;');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      cls = caption ? '' : ' class=&quot;'+t.align+'&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      html = '&lt;img alt=&quot;'+alt+'&quot; src=&quot;'+f.src.value+'&quot;'+cls+' width=&quot;'+t.width+'&quot; height=&quot;'+t.height+'&quot; /&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( f.url.value ) {&nbsp;</div></li><li><div>          url = f.url.value.replace(/'/g, '&#039;').replace(/&quot;/g, '&quot;').replace(/&lt;/g, '&lt;').replace(/&gt;/g, '&gt;');&nbsp;</div></li><li><div>          html = '&lt;a href=&quot;'+url+'&quot;&gt;'+html+'&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( caption )&nbsp;</div></li><li><div>          html = ''+html+caption+'';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      var win = window.dialogArguments || opener || parent || top;&nbsp;</div></li><li><div>      win.send_to_editor(html);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  resetImageData : function() {&nbsp;</div></li><li><div>      var t = addExtImage;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      t.width = t.height = '';&nbsp;</div></li><li><div>      document.getElementById('go_button').style.color = '#bbb';&nbsp;</div></li><li><div>      if ( ! document.forms[0].src.value )&nbsp;</div></li><li><div>          document.getElementById('status_img').innerHTML = '';&nbsp;</div></li><li><div>      else document.getElementById('status_img').innerHTML = '&lt;img src=&quot;&lt;?php echo esc_url( admin_url( 'images/no.png' ) ); ?&gt;&quot; alt=&quot;&quot; /&gt;';&nbsp;</div></li><li><div>  }, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  updateImageData : function() {&nbsp;</div></li><li><div>      var t = addExtImage;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      t.width = t.preloadImg.width;&nbsp;</div></li><li><div>      t.height = t.preloadImg.height;&nbsp;</div></li><li><div>      document.getElementById('go_button').style.color = '#333';&nbsp;</div></li><li><div>      document.getElementById('status_img').innerHTML = '&lt;img src=&quot;&lt;?php echo esc_url( admin_url( 'images/yes.png' ) ); ?&gt;&quot; alt=&quot;&quot; /&gt;';&nbsp;</div></li><li><div>  }, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  getImageData : function() {&nbsp;</div></li><li><div>      if ( jQuery('table.describe').hasClass('not-image') )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      var t = addExtImage, src = document.forms[0].src.value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! src ) {&nbsp;</div></li><li><div>          t.resetImageData();&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      document.getElementById('status_img').innerHTML = '&lt;img src=&quot;&lt;?php echo esc_url( admin_url( 'images/spinner-2x.gif' ) ); ?&gt;&quot; alt=&quot;&quot; width=&quot;16&quot; height=&quot;16&quot; /&gt;';&nbsp;</div></li><li><div>      t.preloadImg = new Image();&nbsp;</div></li><li><div>      t.preloadImg.onload = t.updateImageData;&nbsp;</div></li><li><div>      t.preloadImg.onerror = t.resetImageData;&nbsp;</div></li><li><div>      t.preloadImg.src = src;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>};&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>jQuery(document).ready( function($) {&nbsp;</div></li><li><div>  $('.media-types input').click( function() {&nbsp;</div></li><li><div>      $('table.describe').toggleClass('not-image', $('#not-image').prop('checked') );&nbsp;</div></li><li><div>  });&nbsp;</div></li><li><div>});&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div id=&quot;media-items&quot;&gt;&nbsp;</div></li><li><div>&lt;div class=&quot;media-item media-blank&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters the insert media from URL form HTML.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $form_html The insert from URL form HTML.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>echo apply_filters( 'type_url_form_media', wp_media_insert_url_form( $type ) );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds gallery form to upload iframe</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $redir_tab</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $type</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $tab</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $errors</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_gallery_form($errors) {&nbsp;</div></li><li><div>  global $redir_tab, $type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $redir_tab = 'gallery';&nbsp;</div></li><li><div>  media_upload_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = intval($_REQUEST['post_id']);&nbsp;</div></li><li><div>  $form_action_url = admin_url(&quot;media-upload.php?type=$type&tab=gallery&post_id=$post_id&quot;);&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $form_action_url = apply_filters( 'media_upload_form_url', $form_action_url, $type );&nbsp;</div></li><li><div>  $form_class = 'media-upload-form validate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_user_setting('uploader') )&nbsp;</div></li><li><div>      $form_class .= ' html-uploader';&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>jQuery(function($) {&nbsp;</div></li><li><div>  var preloaded = $(&quot;.media-item.preloaded&quot;);&nbsp;</div></li><li><div>  if ( preloaded.length &gt; 0 ) {&nbsp;</div></li><li><div>      preloaded.each(function() {prepareMediaItem({id:this.id.replace(/[^0-9]/g, '')}, '');});&nbsp;</div></li><li><div>      updateMediaForm();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>});&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;sort-buttons&quot; class=&quot;hide-if-no-js&quot;&gt;&nbsp;</div></li><li><div>&lt;span&gt;&nbsp;</div></li><li><div>&lt;?php _e('All Tabs:'); ?&gt;&nbsp;</div></li><li><div>&lt;a href=&quot;#&quot; id=&quot;showall&quot;&gt;&lt;?php _e('Show'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&lt;a href=&quot;#&quot; id=&quot;hideall&quot; style=&quot;display:none;&quot;&gt;&lt;?php _e('Hide'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&lt;/span&gt;&nbsp;</div></li><li><div>&lt;?php _e('Sort Order:'); ?&gt;&nbsp;</div></li><li><div>&lt;a href=&quot;#&quot; id=&quot;asc&quot;&gt;&lt;?php _e('Ascending'); ?&gt;&lt;/a&gt; |&nbsp;</div></li><li><div>&lt;a href=&quot;#&quot; id=&quot;desc&quot;&gt;&lt;?php _e('Descending'); ?&gt;&lt;/a&gt; |&nbsp;</div></li><li><div>&lt;a href=&quot;#&quot; id=&quot;clear&quot;&gt;&lt;?php _ex('Clear', 'verb'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;&lt;?php echo esc_url( $form_action_url ); ?&gt;&quot; class=&quot;&lt;?php echo $form_class; ?&gt;&quot; id=&quot;gallery-form&quot;&gt;&nbsp;</div></li><li><div>&lt;?php wp_nonce_field('media-form'); ?&gt;&nbsp;</div></li><li><div>&lt;?php <span class="comment"><span class="comment">//media_upload_form( $errors ); ?&gt;</span></span>&nbsp;</div></li><li><div>&lt;table class=&quot;widefat&quot;&gt;&nbsp;</div></li><li><div>&lt;thead&gt;&lt;tr&gt;&nbsp;</div></li><li><div>&lt;th&gt;&lt;?php _e('Media'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;th class=&quot;order-head&quot;&gt;&lt;?php _e('Order'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;th class=&quot;actions-head&quot;&gt;&lt;?php _e('Actions'); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>&lt;/tr&gt;&lt;/thead&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&lt;div id=&quot;media-items&quot;&gt;&nbsp;</div></li><li><div>&lt;?php add_filter('attachment_fields_to_edit', 'media_post_single_attachment_fields_to_edit', 10, 2); ?&gt;&nbsp;</div></li><li><div>&lt;?php echo get_media_items($post_id, $errors); ?&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;p class=&quot;ml-submit&quot;&gt;&nbsp;</div></li><li><div>&lt;?php submit_button( __( 'Save all changes' ), 'savebutton', 'save', false, array( 'id' =&gt; 'save-all', 'style' =&gt; 'display: none;' ) ); ?&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;post_id&quot; id=&quot;post_id&quot; value=&quot;&lt;?php echo (int) $post_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;type&quot; value=&quot;&lt;?php echo esc_attr( $GLOBALS['type'] ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;tab&quot; value=&quot;&lt;?php echo esc_attr( $GLOBALS['tab'] ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div id=&quot;gallery-settings&quot; style=&quot;display:none;&quot;&gt;&nbsp;</div></li><li><div>&lt;div class=&quot;title&quot;&gt;&lt;?php _e('Gallery Settings'); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&lt;table id=&quot;basic&quot; class=&quot;describe&quot;&gt;&lt;tbody&gt;&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>  &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;alignleft&quot;&gt;&lt;?php _e('Link thumbnails to:'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/th&gt;&nbsp;</div></li><li><div>  &lt;td class=&quot;field&quot;&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;radio&quot; name=&quot;linkto&quot; id=&quot;linkto-file&quot; value=&quot;file&quot; /&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;linkto-file&quot; class=&quot;radio&quot;&gt;&lt;?php _e('Image File'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;input type=&quot;radio&quot; checked=&quot;checked&quot; name=&quot;linkto&quot; id=&quot;linkto-post&quot; value=&quot;post&quot; /&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;linkto-post&quot; class=&quot;radio&quot;&gt;&lt;?php _e('Attachment Page'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/td&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>  &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;alignleft&quot;&gt;&lt;?php _e('Order images by:'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/th&gt;&nbsp;</div></li><li><div>  &lt;td class=&quot;field&quot;&gt;&nbsp;</div></li><li><div>      &lt;select id=&quot;orderby&quot; name=&quot;orderby&quot;&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;menu_order&quot; selected=&quot;selected&quot;&gt;&lt;?php _e('Menu order'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;title&quot;&gt;&lt;?php _e('Title'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;post_date&quot;&gt;&lt;?php _e('Date/Time'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;rand&quot;&gt;&lt;?php _e('Random'); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>      &lt;/select&gt;&nbsp;</div></li><li><div>  &lt;/td&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>  &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;alignleft&quot;&gt;&lt;?php _e('Order:'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/th&gt;&nbsp;</div></li><li><div>  &lt;td class=&quot;field&quot;&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;radio&quot; checked=&quot;checked&quot; name=&quot;order&quot; id=&quot;order-asc&quot; value=&quot;asc&quot; /&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;order-asc&quot; class=&quot;radio&quot;&gt;&lt;?php _e('Ascending'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;input type=&quot;radio&quot; name=&quot;order&quot; id=&quot;order-desc&quot; value=&quot;desc&quot; /&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;order-desc&quot; class=&quot;radio&quot;&gt;&lt;?php _e('Descending'); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/td&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>  &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;alignleft&quot;&gt;&lt;?php _e('Gallery columns:'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/th&gt;&nbsp;</div></li><li><div>  &lt;td class=&quot;field&quot;&gt;&nbsp;</div></li><li><div>      &lt;select id=&quot;columns&quot; name=&quot;columns&quot;&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;1&quot;&gt;1&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;2&quot;&gt;2&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;3&quot; selected=&quot;selected&quot;&gt;3&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;4&quot;&gt;4&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;5&quot;&gt;5&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;6&quot;&gt;6&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;7&quot;&gt;7&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;8&quot;&gt;8&lt;/option&gt;&nbsp;</div></li><li><div>          &lt;option value=&quot;9&quot;&gt;9&lt;/option&gt;&nbsp;</div></li><li><div>      &lt;/select&gt;&nbsp;</div></li><li><div>  &lt;/td&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&lt;/tbody&gt;&lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;p class=&quot;ml-submit&quot;&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;button&quot; class=&quot;button&quot; style=&quot;display:none;&quot; onMouseDown=&quot;wpgallery.update();&quot; name=&quot;insert-gallery&quot; id=&quot;insert-gallery&quot; value=&quot;&lt;?php esc_attr_e( 'Insert gallery' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;button&quot; class=&quot;button&quot; style=&quot;display:none;&quot; onMouseDown=&quot;wpgallery.update();&quot; name=&quot;update-gallery&quot; id=&quot;update-gallery&quot; value=&quot;&lt;?php esc_attr_e( 'Update gallery settings' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the legacy media upload form for the media library.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb      $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Query  $wp_query</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Locale $wp_locale</span>&nbsp;</div></li><li><div><span class="comment"> * @global string    $type</span>&nbsp;</div></li><li><div><span class="comment"> * @global string    $tab</span>&nbsp;</div></li><li><div><span class="comment"> * @global array     $post_mime_types</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $errors</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_library_form($errors) {&nbsp;</div></li><li><div>  global $wpdb, $wp_query, $wp_locale, $type, $tab, $post_mime_types;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  media_upload_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = isset( $_REQUEST['post_id'] ) ? intval( $_REQUEST['post_id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $form_action_url = admin_url(&quot;media-upload.php?type=$type&tab=library&post_id=$post_id&quot;);&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $form_action_url = apply_filters( 'media_upload_form_url', $form_action_url, $type );&nbsp;</div></li><li><div>  $form_class = 'media-upload-form validate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_user_setting('uploader') )&nbsp;</div></li><li><div>      $form_class .= ' html-uploader';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $q = $_GET;&nbsp;</div></li><li><div>  $q['posts_per_page'] = 10;&nbsp;</div></li><li><div>  $q['paged'] = isset( $q['paged'] ) ? intval( $q['paged'] ) : 0;&nbsp;</div></li><li><div>  if ( $q['paged'] &lt; 1 ) {&nbsp;</div></li><li><div>      $q['paged'] = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $q['offset'] = ( $q['paged'] - 1 ) * 10;&nbsp;</div></li><li><div>  if ( $q['offset'] &lt; 1 ) {&nbsp;</div></li><li><div>      $q['offset'] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  list($post_mime_types, $avail_post_mime_types) = wp_edit_attachments_query( $q );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;form id=&quot;filter&quot; method=&quot;get&quot;&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;type&quot; value=&quot;&lt;?php echo esc_attr( $type ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;tab&quot; value=&quot;&lt;?php echo esc_attr( $tab ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;post_id&quot; value=&quot;&lt;?php echo (int) $post_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;post_mime_type&quot; value=&quot;&lt;?php echo isset( $_GET['post_mime_type'] ) ? esc_attr( $_GET['post_mime_type'] ) : ''; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;context&quot; value=&quot;&lt;?php echo isset( $_GET['context'] ) ? esc_attr( $_GET['context'] ) : ''; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;p id=&quot;media-search&quot; class=&quot;search-box&quot;&gt;&nbsp;</div></li><li><div>  &lt;label class=&quot;screen-reader-text&quot; for=&quot;media-search-input&quot;&gt;&lt;?php _e('Search Media');?&gt;:&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;input type=&quot;search&quot; id=&quot;media-search-input&quot; name=&quot;s&quot; value=&quot;&lt;?php the_search_query(); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;?php submit_button( __( 'Search Media' ), '', '', false ); ?&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;ul class=&quot;subsubsub&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>$type_links = array();&nbsp;</div></li><li><div>$_num_posts = (array) wp_count_attachments();&nbsp;</div></li><li><div>$matches = wp_match_mime_types(array_keys($post_mime_types), array_keys($_num_posts));&nbsp;</div></li><li><div>foreach ( $matches as $_type =&gt; $reals )&nbsp;</div></li><li><div>  foreach ( $reals as $real )&nbsp;</div></li><li><div>      if ( isset($num_posts[$_type]) )&nbsp;</div></li><li><div>          $num_posts[$_type] += $_num_posts[$real];&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $num_posts[$_type] = $_num_posts[$real];&nbsp;</div></li><li><div><span class="comment">// If available type specified by media button clicked, filter by that type</span>&nbsp;</div></li><li><div>if ( empty($_GET['post_mime_type']) && !empty($num_posts[$type]) ) {&nbsp;</div></li><li><div>  $_GET['post_mime_type'] = $type;&nbsp;</div></li><li><div>  list($post_mime_types, $avail_post_mime_types) = wp_edit_attachments_query();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>if ( empty($_GET['post_mime_type']) || $_GET['post_mime_type'] == 'all' )&nbsp;</div></li><li><div>  $class = ' class=&quot;current&quot;';&nbsp;</div></li><li><div>else&nbsp;</div></li><li><div>  $class = '';&nbsp;</div></li><li><div>$type_links[] = '&lt;li&gt;&lt;a href=&quot;' . esc_url(add_query_arg(array('post_mime_type'=&gt;'all', 'paged'=&gt;false, 'm'=&gt;false))) . '&quot;' . $class . '&gt;' . __('All Types') . '&lt;/a&gt;';&nbsp;</div></li><li><div>foreach ( $post_mime_types as $mime_type =&gt; $label ) {&nbsp;</div></li><li><div>  $class = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !wp_match_mime_types($mime_type, $avail_post_mime_types) )&nbsp;</div></li><li><div>      continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_GET['post_mime_type']) && wp_match_mime_types($mime_type, $_GET['post_mime_type']) )&nbsp;</div></li><li><div>      $class = ' class=&quot;current&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $type_links[] = '&lt;li&gt;&lt;a href=&quot;' . esc_url(add_query_arg(array('post_mime_type'=&gt;$mime_type, 'paged'=&gt;false))) . '&quot;' . $class . '&gt;' . sprintf( translate_nooped_plural( $label[2], $num_posts[$mime_type] ), '&lt;span id=&quot;' . $mime_type . '-counter&quot;&gt;' . number_format_i18n( $num_posts[$mime_type] ) . '&lt;/span&gt;') . '&lt;/a&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters the media upload mime type list items.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returned values should begin with an `&lt;li&gt;` tag.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $type_links An array of list items containing mime type link HTML.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>echo implode(' | &lt;/li&gt;', apply_filters( 'media_upload_mime_type_links', $type_links ) ) . '&lt;/li&gt;';&nbsp;</div></li><li><div>unset($type_links);&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/ul&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div class=&quot;tablenav&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>$page_links = paginate_links( array(&nbsp;</div></li><li><div>  'base' =&gt; add_query_arg( 'paged', '%#%' ), &nbsp;</div></li><li><div>  'format' =&gt; '', &nbsp;</div></li><li><div>  'prev_text' =&gt; __('&laquo;'), &nbsp;</div></li><li><div>  'next_text' =&gt; __('&raquo;'), &nbsp;</div></li><li><div>  'total' =&gt; ceil($wp_query-&gt;found_posts / 10), &nbsp;</div></li><li><div>  'current' =&gt; $q['paged'], &nbsp;</div></li><li><div>));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( $page_links )&nbsp;</div></li><li><div>  echo &quot;&lt;div class='tablenav-pages'&gt;$page_links&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div class=&quot;alignleft actions&quot;&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$arc_query = &quot;SELECT DISTINCT YEAR(post_date) AS yyear, MONTH(post_date) AS mmonth FROM $wpdb-&gt;posts WHERE post_type = 'attachment' ORDER BY post_date DESC&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$arc_result = $wpdb-&gt;get_results( $arc_query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$month_count = count($arc_result);&nbsp;</div></li><li><div>$selected_month = isset( $_GET['m'] ) ? $_GET['m'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( $month_count && !( 1 == $month_count && 0 == $arc_result[0]-&gt;mmonth ) ) { ?&gt;&nbsp;</div></li><li><div>&lt;select name='m'&gt;&nbsp;</div></li><li><div>&lt;option&lt;?php selected( $selected_month, 0 ); ?&gt; value='0'&gt;&lt;?php _e( 'All dates' ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>foreach ($arc_result as $arc_row) {&nbsp;</div></li><li><div>  if ( $arc_row-&gt;yyear == 0 )&nbsp;</div></li><li><div>      continue;&nbsp;</div></li><li><div>  $arc_row-&gt;mmonth = zeroise( $arc_row-&gt;mmonth, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $arc_row-&gt;yyear . $arc_row-&gt;mmonth == $selected_month )&nbsp;</div></li><li><div>      $default = ' selected=&quot;selected&quot;';&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $default = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo &quot;&lt;option$default value='&quot; . esc_attr( $arc_row-&gt;yyear . $arc_row-&gt;mmonth ) . &quot;'&gt;&quot;;&nbsp;</div></li><li><div>  echo esc_html( $wp_locale-&gt;get_month($arc_row-&gt;mmonth) . &quot; $arc_row-&gt;yyear&quot; );&nbsp;</div></li><li><div>  echo &quot;&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/select&gt;&nbsp;</div></li><li><div>&lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php submit_button( __( 'Filter &#187;' ), '', 'post-query-submit', false ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;br class=&quot;clear&quot; /&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;&lt;?php echo esc_url( $form_action_url ); ?&gt;&quot; class=&quot;&lt;?php echo $form_class; ?&gt;&quot; id=&quot;library-form&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php wp_nonce_field('media-form'); ?&gt;&nbsp;</div></li><li><div>&lt;?php <span class="comment"><span class="comment">//media_upload_form( $errors ); ?&gt;</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>&lt;!--&nbsp;</div></li><li><div>jQuery(function($) {&nbsp;</div></li><li><div>  var preloaded = $(&quot;.media-item.preloaded&quot;);&nbsp;</div></li><li><div>  if ( preloaded.length &gt; 0 ) {&nbsp;</div></li><li><div>      preloaded.each(function() {prepareMediaItem({id:this.id.replace(/[^0-9]/g, '')}, '');});&nbsp;</div></li><li><div>      updateMediaForm();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>});&nbsp;</div></li><li><div>--&gt;&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;div id=&quot;media-items&quot;&gt;&nbsp;</div></li><li><div>&lt;?php add_filter('attachment_fields_to_edit', 'media_post_single_attachment_fields_to_edit', 10, 2); ?&gt;&nbsp;</div></li><li><div>&lt;?php echo get_media_items(null, $errors); ?&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>&lt;p class=&quot;ml-submit&quot;&gt;&nbsp;</div></li><li><div>&lt;?php submit_button( __( 'Save all changes' ), 'savebutton', 'save', false ); ?&gt;&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;post_id&quot; id=&quot;post_id&quot; value=&quot;&lt;?php echo (int) $post_id; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates the form for external url</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $default_view</span>&nbsp;</div></li><li><div><span class="comment"> * @return string the form html</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_media_insert_url_form( $default_view = 'image' ) {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'disable_captions', '' ) ) {&nbsp;</div></li><li><div>      $caption = '&nbsp;</div></li><li><div>      &lt;tr class=&quot;image-only&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;caption&quot;&gt;&lt;span class=&quot;alignleft&quot;&gt;' . __('Image Caption') . '&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;field&quot;&gt;&lt;textarea id=&quot;caption&quot; name=&quot;caption&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $caption = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $default_align = get_option('image_default_align');&nbsp;</div></li><li><div>  if ( empty($default_align) )&nbsp;</div></li><li><div>      $default_align = 'none';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'image' == $default_view ) {&nbsp;</div></li><li><div>      $view = 'image-only';&nbsp;</div></li><li><div>      $table_class = '';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $view = $table_class = 'not-image';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return '&nbsp;</div></li><li><div>  &lt;p class=&quot;media-types&quot;&gt;&lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;media_type&quot; value=&quot;image&quot; id=&quot;image-only&quot;' . checked( 'image-only', $view, false ) . ' /&gt; ' . __( 'Image' ) . '&lt;/label&gt; &nbsp; &nbsp; &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;media_type&quot; value=&quot;generic&quot; id=&quot;not-image&quot;' . checked( 'not-image', $view, false ) . ' /&gt; ' . __( 'Audio, Video, or Other File' ) . '&lt;/label&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;media-types media-types-required-info&quot;&gt;' . sprintf( __( 'Required fields are marked %s' ), '&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;' ) . '&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;table class=&quot;describe ' . $table_class . '&quot;&gt;&lt;tbody&gt;&nbsp;</div></li><li><div>      &lt;tr&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;label&quot; style=&quot;width:130px;&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;src&quot;&gt;&lt;span class=&quot;alignleft&quot;&gt;' . __( 'URL' ) . '&lt;/span&gt; &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>              &lt;span class=&quot;alignright&quot; id=&quot;status_img&quot;&gt;&lt;/span&gt;&nbsp;</div></li><li><div>          &lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;field&quot;&gt;&lt;input id=&quot;src&quot; name=&quot;src&quot; value=&quot;&quot; type=&quot;text&quot; required aria-required=&quot;true&quot; onblur=&quot;addExtImage.getImageData()&quot; /&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;title&quot;&gt;&lt;span class=&quot;alignleft&quot;&gt;' . __( 'Title' ) . '&lt;/span&gt; &lt;span class=&quot;required&quot;&gt;*&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;field&quot;&gt;&lt;input id=&quot;title&quot; name=&quot;title&quot; value=&quot;&quot; type=&quot;text&quot; required aria-required=&quot;true&quot; /&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;not-image&quot;&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;p class=&quot;help&quot;&gt;' . __('Link text, e.g. &#8220;Ransom Demands (PDF)&#8221;') . '&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;image-only&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;alt&quot;&gt;&lt;span class=&quot;alignleft&quot;&gt;' . __('Alternative Text') . '&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;field&quot;&gt;&lt;input id=&quot;alt&quot; name=&quot;alt&quot; value=&quot;&quot; type=&quot;text&quot; aria-required=&quot;true&quot; /&gt;&nbsp;</div></li><li><div>          &lt;p class=&quot;help&quot;&gt;' . __('Alt text for the image, e.g. &#8220;The Mona Lisa&#8221;') . '&lt;/p&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>      ' . $caption . '&nbsp;</div></li><li><div>      &lt;tr class=&quot;align image-only&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&lt;p&gt;&lt;label for=&quot;align&quot;&gt;' . __('Alignment') . '&lt;/label&gt;&lt;/p&gt;&lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;field&quot;&gt;&nbsp;</div></li><li><div>              &lt;input name=&quot;align&quot; id=&quot;align-none&quot; value=&quot;none&quot; onclick=&quot;addExtImage.align=\'align\'+this.value&quot; type=&quot;radio&quot;' . ($default_align == 'none' ? ' checked=&quot;checked&quot;' : '').' /&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;align-none&quot; class=&quot;align image-align-none-label&quot;&gt;' . __('None') . '&lt;/label&gt;&nbsp;</div></li><li><div>              &lt;input name=&quot;align&quot; id=&quot;align-left&quot; value=&quot;left&quot; onclick=&quot;addExtImage.align=\'align\'+this.value&quot; type=&quot;radio&quot;' . ($default_align == 'left' ? ' checked=&quot;checked&quot;' : '').' /&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;align-left&quot; class=&quot;align image-align-left-label&quot;&gt;' . __('Left') . '&lt;/label&gt;&nbsp;</div></li><li><div>              &lt;input name=&quot;align&quot; id=&quot;align-center&quot; value=&quot;center&quot; onclick=&quot;addExtImage.align=\'align\'+this.value&quot; type=&quot;radio&quot;' . ($default_align == 'center' ? ' checked=&quot;checked&quot;' : '').' /&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;align-center&quot; class=&quot;align image-align-center-label&quot;&gt;' . __('Center') . '&lt;/label&gt;&nbsp;</div></li><li><div>              &lt;input name=&quot;align&quot; id=&quot;align-right&quot; value=&quot;right&quot; onclick=&quot;addExtImage.align=\'align\'+this.value&quot; type=&quot;radio&quot;' . ($default_align == 'right' ? ' checked=&quot;checked&quot;' : '').' /&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;align-right&quot; class=&quot;align image-align-right-label&quot;&gt;' . __('Right') . '&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;image-only&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;label&quot;&gt;&nbsp;</div></li><li><div>              &lt;label for=&quot;url&quot;&gt;&lt;span class=&quot;alignleft&quot;&gt;' . __('Link Image To:') . '&lt;/span&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;field&quot;&gt;&lt;input id=&quot;url&quot; name=&quot;url&quot; value=&quot;&quot; type=&quot;text&quot; /&gt;&lt;br /&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;button type=&quot;button&quot; class=&quot;button&quot; value=&quot;&quot; onclick=&quot;document.forms[0].url.value=null&quot;&gt;' . __('None') . '&lt;/button&gt;&nbsp;</div></li><li><div>          &lt;button type=&quot;button&quot; class=&quot;button&quot; value=&quot;&quot; onclick=&quot;document.forms[0].url.value=document.forms[0].src.value&quot;&gt;' . __('Link to image') . '&lt;/button&gt;&nbsp;</div></li><li><div>          &lt;p class=&quot;help&quot;&gt;' . __('Enter a link URL or click above for presets.') . '&lt;/p&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>      &lt;tr class=&quot;image-only&quot;&gt;&nbsp;</div></li><li><div>          &lt;td&gt;&lt;/td&gt;&nbsp;</div></li><li><div>          &lt;td&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;button&quot; class=&quot;button&quot; id=&quot;go_button&quot; style=&quot;color:#bbb;&quot; onclick=&quot;addExtImage.insert()&quot; value=&quot;' . esc_attr__('Insert into Post') . '&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>      &lt;tr class=&quot;not-image&quot;&gt;&nbsp;</div></li><li><div>          &lt;td&gt;&lt;/td&gt;&nbsp;</div></li><li><div>          &lt;td&gt;&nbsp;</div></li><li><div>              ' . get_submit_button( __( 'Insert into Post' ), '', 'insertonlybutton', false ) . '&nbsp;</div></li><li><div>          &lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>  &lt;/tbody&gt;&lt;/table&gt;&nbsp;</div></li><li><div>';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the multi-file uploader message.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $post_ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_flash_bypass() {&nbsp;</div></li><li><div>  $browser_uploader = admin_url( 'media-new.php?browser-uploader' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post = get_post() )&nbsp;</div></li><li><div>      $browser_uploader .= '&amp;post_id=' . intval( $post-&gt;ID );&nbsp;</div></li><li><div>  elseif ( ! empty( $GLOBALS['post_ID'] ) )&nbsp;</div></li><li><div>      $browser_uploader .= '&amp;post_id=' . intval( $GLOBALS['post_ID'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;upload-flash-bypass&quot;&gt;&nbsp;</div></li><li><div>  &lt;?php printf( __( 'You are using the multi-file uploader. Problems? Try the &lt;a href=&quot;%1$s&quot; target=&quot;%2$s&quot;&gt;browser uploader&lt;/a&gt; instead.' ), $browser_uploader, '_blank' ); ?&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the browser's built-in uploader message.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_html_bypass() {&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;upload-html-bypass hide-if-no-js&quot;&gt;&nbsp;</div></li><li><div>     &lt;?php _e('You are using the browser&#8217;s built-in file uploader. The WordPress uploader includes multiple file selection and drag and drop capability. &lt;a href=&quot;#&quot;&gt;Switch to the multi-file uploader&lt;/a&gt;.'); ?&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Used to display a &quot;After a file has been uploaded...&quot; help message.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_text_after() {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the checkbox to scale images.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function media_upload_max_image_resize() {&nbsp;</div></li><li><div>  $checked = get_user_setting('upload_resize') ? ' checked=&quot;true&quot;' : '';&nbsp;</div></li><li><div>  $a = $end = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( 'manage_options' ) ) {&nbsp;</div></li><li><div>      $a = '&lt;a href=&quot;' . esc_url( admin_url( 'options-media.php' ) ) . '&quot; target=&quot;_blank&quot;&gt;';&nbsp;</div></li><li><div>      $end = '&lt;/a&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;p class=&quot;hide-if-no-js&quot;&gt;&lt;label&gt;&nbsp;</div></li><li><div>&lt;input name=&quot;image_resize&quot; type=&quot;checkbox&quot; id=&quot;image_resize&quot; value=&quot;true&quot;&lt;?php echo $checked; ?&gt; /&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  <span class="comment">/** translators: %1$s is link start tag, %2$s is link end tag, %3$d is width, %4$d is height*/</span>&nbsp;</div></li><li><div>  printf( __( 'Scale images to match the large size selected in %1$simage options%2$s (%3$d &times; %4$d).' ), $a, $end, (int) get_option( 'large_size_w', '1024' ), (int) get_option( 'large_size_h', '1024' ) );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;/label&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the out of storage quota message in Multisite.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function multisite_over_quota_message() {&nbsp;</div></li><li><div>  echo '&lt;p&gt;' . sprintf( __( 'Sorry, you have used all of your storage quota of %s MB.' ), get_space_allowed() ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the image and editor in the post editor</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Post $post A post object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edit_form_image_editor( $post ) {&nbsp;</div></li><li><div>  $open = isset( $_GET['image-editor'] );&nbsp;</div></li><li><div>  if ( $open )&nbsp;</div></li><li><div>      require_once ABSPATH . 'wp-admin/includes/image-edit.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thumb_url = false;&nbsp;</div></li><li><div>  if ( $attachment_id = intval( $post-&gt;ID ) )&nbsp;</div></li><li><div>      $thumb_url = wp_get_attachment_image_src( $attachment_id, array( 900, 450 ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $alt_text = get_post_meta( $post-&gt;ID, '_wp_attachment_image_alt', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $att_url = wp_get_attachment_url( $post-&gt;ID ); ?&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;wp_attachment_holder wp-clearfix&quot;&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  if ( wp_attachment_is_image( $post-&gt;ID ) ) :&nbsp;</div></li><li><div>      $image_edit_button = '';&nbsp;</div></li><li><div>      if ( wp_image_editor_supports( array( 'mime_type' =&gt; $post-&gt;post_mime_type ) ) ) {&nbsp;</div></li><li><div>          $nonce = wp_create_nonce( &quot;image_editor-$post-&gt;ID&quot; );&nbsp;</div></li><li><div>          $image_edit_button = &quot;&lt;input type='button' id='imgedit-open-btn-$post-&gt;ID' onclick='imageEdit.open( $post-&gt;ID, \&quot;$nonce\&quot; )' class='button' value='&quot; . esc_attr__( 'Edit Image' ) . &quot;' /&gt; &lt;span class='spinner'&gt;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div class=&quot;imgedit-response&quot; id=&quot;imgedit-response-&lt;?php echo $attachment_id; ?&gt;&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;div&lt;?php if ( $open ) echo ' style=&quot;display:none&quot;'; ?&gt; class=&quot;wp_attachment_image wp-clearfix&quot; id=&quot;media-head-&lt;?php echo $attachment_id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;p id=&quot;thumbnail-head-&lt;?php echo $attachment_id; ?&gt;&quot;&gt;&lt;img class=&quot;thumbnail&quot; src=&quot;&lt;?php echo set_url_scheme( $thumb_url[0] ); ?&gt;&quot; style=&quot;max-width:100%&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;?php echo $image_edit_button; ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;div&lt;?php if ( ! $open ) echo ' style=&quot;display:none&quot;'; ?&gt; class=&quot;image-editor&quot; id=&quot;image-editor-&lt;?php echo $attachment_id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php if ( $open ) wp_image_editor( $attachment_id ); ?&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  elseif ( $attachment_id && wp_attachment_is( 'audio', $post ) ):&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_maybe_generate_attachment_metadata( $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo wp_audio_shortcode( array( 'src' =&gt; $att_url ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  elseif ( $attachment_id && wp_attachment_is( 'video', $post ) ):&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_maybe_generate_attachment_metadata( $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $meta = wp_get_attachment_metadata( $attachment_id );&nbsp;</div></li><li><div>      $w = ! empty( $meta['width'] ) ? min( $meta['width'], 640 ) : 0;&nbsp;</div></li><li><div>      $h = ! empty( $meta['height'] ) ? $meta['height'] : 0;&nbsp;</div></li><li><div>      if ( $h && $w &lt; $meta['width'] ) {&nbsp;</div></li><li><div>          $h = round( ( $meta['height'] * $w ) / $meta['width'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attr = array( 'src' =&gt; $att_url );&nbsp;</div></li><li><div>      if ( ! empty( $w ) && ! empty( $h ) ) {&nbsp;</div></li><li><div>          $attr['width'] = $w;&nbsp;</div></li><li><div>          $attr['height'] = $h;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $thumb_id = get_post_thumbnail_id( $attachment_id );&nbsp;</div></li><li><div>      if ( ! empty( $thumb_id ) ) {&nbsp;</div></li><li><div>          $attr['poster'] = wp_get_attachment_url( $thumb_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo wp_video_shortcode( $attr );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  elseif ( isset( $thumb_url[0] ) ):&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;wp_attachment_image wp-clearfix&quot; id=&quot;media-head-&lt;?php echo $attachment_id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;p id=&quot;thumbnail-head-&lt;?php echo $attachment_id; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>              &lt;img class=&quot;thumbnail&quot; src=&quot;&lt;?php echo set_url_scheme( $thumb_url[0] ); ?&gt;&quot; style=&quot;max-width:100%&quot; alt=&quot;&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  else:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires when an attachment type can't be rendered in the edit form.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_Post $post A post object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'wp_edit_form_attachment_display', $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  endif; ?&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;wp_attachment_details edit-form-section&quot;&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&nbsp;</div></li><li><div>          &lt;label for=&quot;attachment_caption&quot;&gt;&lt;strong&gt;&lt;?php _e( 'Caption' ); ?&gt;&lt;/strong&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>          &lt;textarea class=&quot;widefat&quot; name=&quot;excerpt&quot; id=&quot;attachment_caption&quot;&gt;&lt;?php echo $post-&gt;post_excerpt; ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php if ( 'image' === substr( $post-&gt;post_mime_type, 0, 5 ) ) : ?&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&nbsp;</div></li><li><div>          &lt;label for=&quot;attachment_alt&quot;&gt;&lt;strong&gt;&lt;?php _e( 'Alternative Text' ); ?&gt;&lt;/strong&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;text&quot; class=&quot;widefat&quot; name=&quot;_wp_attachment_image_alt&quot; id=&quot;attachment_alt&quot; value=&quot;&lt;?php echo esc_attr( $alt_text ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      $quicktags_settings = array( 'buttons' =&gt; 'strong, em, link, block, del, ins, img, ul, ol, li, code, close' );&nbsp;</div></li><li><div>      $editor_args = array(&nbsp;</div></li><li><div>          'textarea_name' =&gt; 'content', &nbsp;</div></li><li><div>          'textarea_rows' =&gt; 5, &nbsp;</div></li><li><div>          'media_buttons' =&gt; false, &nbsp;</div></li><li><div>          'tinymce' =&gt; false, &nbsp;</div></li><li><div>          'quicktags' =&gt; $quicktags_settings, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;label for=&quot;attachment_content&quot;&gt;&lt;strong&gt;&lt;?php _e( 'Description' ); ?&gt;&lt;/strong&gt;&lt;?php&nbsp;</div></li><li><div>  if ( preg_match( '#^(audio|video)/#', $post-&gt;post_mime_type ) ) {&nbsp;</div></li><li><div>      echo ': ' . __( 'Displayed on attachment pages.' );&nbsp;</div></li><li><div>  } ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;?php wp_editor( $post-&gt;post_content, 'attachment_content', $editor_args ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>  $extras = get_compat_media_markup( $post-&gt;ID );&nbsp;</div></li><li><div>  echo $extras['item'];&nbsp;</div></li><li><div>  echo '&lt;input type=&quot;hidden&quot; id=&quot;image-edit-context&quot; value=&quot;edit-attachment&quot; /&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays non-editable attachment metadata in the publish meta box.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function attachment_submitbox_metadata() {&nbsp;</div></li><li><div>  $post = get_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = get_attached_file( $post-&gt;ID );&nbsp;</div></li><li><div>  $filename = esc_html( wp_basename( $file ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $media_dims = '';&nbsp;</div></li><li><div>  $meta = wp_get_attachment_metadata( $post-&gt;ID );&nbsp;</div></li><li><div>  if ( isset( $meta['width'], $meta['height'] ) )&nbsp;</div></li><li><div>      $media_dims .= &quot;&lt;span id='media-dims-$post-&gt;ID'&gt;{$meta['width']}&nbsp;&times;&nbsp;{$meta['height']}&lt;/span&gt; &quot;;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  $media_dims = apply_filters( 'media_meta', $media_dims, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $att_url = wp_get_attachment_url( $post-&gt;ID );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;misc-pub-section misc-pub-attachment&quot;&gt;&nbsp;</div></li><li><div>      &lt;label for=&quot;attachment_url&quot;&gt;&lt;?php _e( 'File URL:' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>      &lt;input type=&quot;text&quot; class=&quot;widefat urlfield&quot; readonly=&quot;readonly&quot; name=&quot;attachment_url&quot; id=&quot;attachment_url&quot; value=&quot;&lt;?php echo esc_attr( $att_url ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;misc-pub-section misc-pub-filename&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'File name:' ); ?&gt; &lt;strong&gt;&lt;?php echo $filename; ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;misc-pub-section misc-pub-filetype&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'File type:' ); ?&gt; &lt;strong&gt;&lt;?php&nbsp;</div></li><li><div>          if ( preg_match( '/^.*?\.(\w+)$/', get_attached_file( $post-&gt;ID ), $matches ) ) {&nbsp;</div></li><li><div>              echo esc_html( strtoupper( $matches[1] ) );&nbsp;</div></li><li><div>              list( $mime_type ) = explode( '/', $post-&gt;post_mime_type );&nbsp;</div></li><li><div>              if ( $mime_type !== 'image' && ! empty( $meta['mime_type'] ) ) {&nbsp;</div></li><li><div>                  if ( $meta['mime_type'] !== &quot;$mime_type/&quot; . strtolower( $matches[1] ) ) {&nbsp;</div></li><li><div>                      echo ' (' . $meta['mime_type'] . ')';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              echo strtoupper( str_replace( 'image/', '', $post-&gt;post_mime_type ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      $file_size = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $meta['filesize'] ) )&nbsp;</div></li><li><div>          $file_size = $meta['filesize'];&nbsp;</div></li><li><div>      elseif ( file_exists( $file ) )&nbsp;</div></li><li><div>          $file_size = filesize( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $file_size ) ) : ?&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;misc-pub-section misc-pub-filesize&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php _e( 'File size:' ); ?&gt; &lt;strong&gt;&lt;?php echo size_format( $file_size ); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( '#^(audio|video)/#', $post-&gt;post_mime_type ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the audio and video metadata fields to be shown in the publish meta box.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * The key for each item in the array should correspond to an attachment</span>&nbsp;</div></li><li><div><span class="comment">       * metadata key, and the value should be the desired label.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $fields An array of the attachment metadata keys and labels.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $fields = apply_filters( 'media_submitbox_misc_sections', array(&nbsp;</div></li><li><div>          'length_formatted' =&gt; __( 'Length:' ), &nbsp;</div></li><li><div>          'bitrate' =&gt; __( 'Bitrate:' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $fields as $key =&gt; $label ) {&nbsp;</div></li><li><div>          if ( empty( $meta[ $key ] ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;misc-pub-section misc-pub-mime-meta misc-pub-&lt;?php echo sanitize_html_class( $key ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php echo $label ?&gt; &lt;strong&gt;&lt;?php&nbsp;</div></li><li><div>              switch ( $key ) {&nbsp;</div></li><li><div>                  case 'bitrate' :&nbsp;</div></li><li><div>                      echo round( $meta['bitrate'] / 1000 ) . 'kb/s';&nbsp;</div></li><li><div>                      if ( ! empty( $meta['bitrate_mode'] ) ) {&nbsp;</div></li><li><div>                          echo ' ' . strtoupper( esc_html( $meta['bitrate_mode'] ) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  default:&nbsp;</div></li><li><div>                      echo esc_html( $meta[ $key ] );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the audio attachment metadata fields to be shown in the publish meta box.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * The key for each item in the array should correspond to an attachment</span>&nbsp;</div></li><li><div><span class="comment">       * metadata key, and the value should be the desired label.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $fields An array of the attachment metadata keys and labels.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $audio_fields = apply_filters( 'audio_submitbox_misc_sections', array(&nbsp;</div></li><li><div>          'dataformat' =&gt; __( 'Audio Format:' ), &nbsp;</div></li><li><div>          'codec' =&gt; __( 'Audio Codec:' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $audio_fields as $key =&gt; $label ) {&nbsp;</div></li><li><div>          if ( empty( $meta['audio'][ $key ] ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;misc-pub-section misc-pub-audio misc-pub-&lt;?php echo sanitize_html_class( $key ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php echo $label; ?&gt; &lt;strong&gt;&lt;?php echo esc_html( $meta['audio'][$key] ); ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $media_dims ) : ?&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;misc-pub-section misc-pub-dimensions&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php _e( 'Dimensions:' ); ?&gt; &lt;strong&gt;&lt;?php echo $media_dims; ?&gt;&lt;/strong&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>  endif;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Parse ID3v2, ID3v1, and getID3 comments to extract usable data</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $metadata An existing array with data</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $data Data supplied by ID3 tags</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_add_id3_tag_data( &$metadata, $data ) {&nbsp;</div></li><li><div>  foreach ( array( 'id3v2', 'id3v1' ) as $version ) {&nbsp;</div></li><li><div>      if ( ! empty( $data[$version]['comments'] ) ) {&nbsp;</div></li><li><div>          foreach ( $data[$version]['comments'] as $key =&gt; $list ) {&nbsp;</div></li><li><div>              if ( 'length' !== $key && ! empty( $list ) ) {&nbsp;</div></li><li><div>                  $metadata[$key] = reset( $list );&nbsp;</div></li><li><div>                  <span class="comment">// Fix bug in byte stream analysis.</span>&nbsp;</div></li><li><div>                  if ( 'terms_of_use' === $key && 0 === strpos( $metadata[$key], 'yright notice.' ) )&nbsp;</div></li><li><div>                      $metadata[$key] = 'Cop' . $metadata[$key];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $data['id3v2']['APIC'] ) ) {&nbsp;</div></li><li><div>      $image = reset( $data['id3v2']['APIC']);&nbsp;</div></li><li><div>      if ( ! empty( $image['data'] ) ) {&nbsp;</div></li><li><div>          $metadata['image'] = array(&nbsp;</div></li><li><div>              'data' =&gt; $image['data'], &nbsp;</div></li><li><div>              'mime' =&gt; $image['image_mime'], &nbsp;</div></li><li><div>              'width' =&gt; $image['image_width'], &nbsp;</div></li><li><div>              'height' =&gt; $image['image_height']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( ! empty( $data['comments']['picture'] ) ) {&nbsp;</div></li><li><div>      $image = reset( $data['comments']['picture'] );&nbsp;</div></li><li><div>      if ( ! empty( $image['data'] ) ) {&nbsp;</div></li><li><div>          $metadata['image'] = array(&nbsp;</div></li><li><div>              'data' =&gt; $image['data'], &nbsp;</div></li><li><div>              'mime' =&gt; $image['image_mime']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve metadata from a video file's ID3 tags</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file Path to file.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|bool Returns array of metadata, if found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_read_video_metadata( $file ) {&nbsp;</div></li><li><div>  if ( ! file_exists( $file ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $metadata = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! defined( 'GETID3_TEMP_DIR' ) ) {&nbsp;</div></li><li><div>      define( 'GETID3_TEMP_DIR', get_temp_dir() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! class_exists( 'getID3', false ) ) {&nbsp;</div></li><li><div>      require( ABSPATH . WPINC . '/ID3/getid3.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $id3 = new getID3();&nbsp;</div></li><li><div>  $data = $id3-&gt;analyze( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $data['video']['lossless'] ) )&nbsp;</div></li><li><div>      $metadata['lossless'] = $data['video']['lossless'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['bitrate'] ) )&nbsp;</div></li><li><div>      $metadata['bitrate'] = (int) $data['video']['bitrate'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['bitrate_mode'] ) )&nbsp;</div></li><li><div>      $metadata['bitrate_mode'] = $data['video']['bitrate_mode'];&nbsp;</div></li><li><div>  if ( ! empty( $data['filesize'] ) )&nbsp;</div></li><li><div>      $metadata['filesize'] = (int) $data['filesize'];&nbsp;</div></li><li><div>  if ( ! empty( $data['mime_type'] ) )&nbsp;</div></li><li><div>      $metadata['mime_type'] = $data['mime_type'];&nbsp;</div></li><li><div>  if ( ! empty( $data['playtime_seconds'] ) )&nbsp;</div></li><li><div>      $metadata['length'] = (int) round( $data['playtime_seconds'] );&nbsp;</div></li><li><div>  if ( ! empty( $data['playtime_string'] ) )&nbsp;</div></li><li><div>      $metadata['length_formatted'] = $data['playtime_string'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['resolution_x'] ) )&nbsp;</div></li><li><div>      $metadata['width'] = (int) $data['video']['resolution_x'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['resolution_y'] ) )&nbsp;</div></li><li><div>      $metadata['height'] = (int) $data['video']['resolution_y'];&nbsp;</div></li><li><div>  if ( ! empty( $data['fileformat'] ) )&nbsp;</div></li><li><div>      $metadata['fileformat'] = $data['fileformat'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['dataformat'] ) )&nbsp;</div></li><li><div>      $metadata['dataformat'] = $data['video']['dataformat'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['encoder'] ) )&nbsp;</div></li><li><div>      $metadata['encoder'] = $data['video']['encoder'];&nbsp;</div></li><li><div>  if ( ! empty( $data['video']['codec'] ) )&nbsp;</div></li><li><div>      $metadata['codec'] = $data['video']['codec'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $data['audio'] ) ) {&nbsp;</div></li><li><div>      unset( $data['audio']['streams'] );&nbsp;</div></li><li><div>      $metadata['audio'] = $data['audio'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_add_id3_tag_data( $metadata, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $metadata;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve metadata from a audio file's ID3 tags</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file Path to file.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|bool Returns array of metadata, if found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_read_audio_metadata( $file ) {&nbsp;</div></li><li><div>  if ( ! file_exists( $file ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $metadata = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! defined( 'GETID3_TEMP_DIR' ) ) {&nbsp;</div></li><li><div>      define( 'GETID3_TEMP_DIR', get_temp_dir() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! class_exists( 'getID3', false ) ) {&nbsp;</div></li><li><div>      require( ABSPATH . WPINC . '/ID3/getid3.php' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $id3 = new getID3();&nbsp;</div></li><li><div>  $data = $id3-&gt;analyze( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $data['audio'] ) ) {&nbsp;</div></li><li><div>      unset( $data['audio']['streams'] );&nbsp;</div></li><li><div>      $metadata = $data['audio'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $data['fileformat'] ) )&nbsp;</div></li><li><div>      $metadata['fileformat'] = $data['fileformat'];&nbsp;</div></li><li><div>  if ( ! empty( $data['filesize'] ) )&nbsp;</div></li><li><div>      $metadata['filesize'] = (int) $data['filesize'];&nbsp;</div></li><li><div>  if ( ! empty( $data['mime_type'] ) )&nbsp;</div></li><li><div>      $metadata['mime_type'] = $data['mime_type'];&nbsp;</div></li><li><div>  if ( ! empty( $data['playtime_seconds'] ) )&nbsp;</div></li><li><div>      $metadata['length'] = (int) round( $data['playtime_seconds'] );&nbsp;</div></li><li><div>  if ( ! empty( $data['playtime_string'] ) )&nbsp;</div></li><li><div>      $metadata['length_formatted'] = $data['playtime_string'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_add_id3_tag_data( $metadata, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $metadata;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Encapsulate logic for Attach/Detach actions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $parent_id Attachment parent ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action    Optional. Attach/detach action. Accepts 'attach' or 'detach'.</span>&nbsp;</div></li><li><div><span class="comment"> *                          Default 'attach'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_media_attach_action( $parent_id, $action = 'attach' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $parent_id ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $parent_id ) ) {&nbsp;</div></li><li><div>      wp_die( __( 'Sorry, you are not allowed to edit this post.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $ids = array();&nbsp;</div></li><li><div>  foreach ( (array) $_REQUEST['media'] as $att_id ) {&nbsp;</div></li><li><div>      $att_id = (int) $att_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_post', $att_id ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ids[] = $att_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $ids ) ) {&nbsp;</div></li><li><div>      $ids_string = implode( ', ', $ids );&nbsp;</div></li><li><div>      if ( 'attach' === $action ) {&nbsp;</div></li><li><div>          $result = $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE $wpdb-&gt;posts SET post_parent = %d WHERE post_type = 'attachment' AND ID IN ( $ids_string )&quot;, $parent_id ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $result = $wpdb-&gt;query( &quot;UPDATE $wpdb-&gt;posts SET post_parent = 0 WHERE post_type = 'attachment' AND ID IN ( $ids_string )&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $ids as $att_id ) {&nbsp;</div></li><li><div>          clean_attachment_cache( $att_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $result ) ) {&nbsp;</div></li><li><div>      $location = 'upload.php';&nbsp;</div></li><li><div>      if ( $referer = wp_get_referer() ) {&nbsp;</div></li><li><div>          if ( false !== strpos( $referer, 'upload.php' ) ) {&nbsp;</div></li><li><div>              $location = remove_query_arg( array( 'attached', 'detach' ), $referer );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $key = 'attach' === $action ? 'attached' : 'detach';&nbsp;</div></li><li><div>      $location = add_query_arg( array( $key =&gt; $result ), $location );&nbsp;</div></li><li><div>      wp_redirect( $location );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-admin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>