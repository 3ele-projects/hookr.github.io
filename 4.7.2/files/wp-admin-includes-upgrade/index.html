<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.2" data-type="file" data-id="4521"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-admin-includes-upgrade | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d12cfac90bb48143a0743d417b1c7fc4' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-admin-includes-upgrade/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-upgrade%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-upgrade%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.2-file-wp-admin-includes-upgrade","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-admin-includes-upgrade" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.2." href="http://hookr.io/4.7.2/" class="H_VERSION"><span property="name">4.7.2</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-admin-includes-upgrade</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6308"><a href="http://hookr.io/4.7.2/all/" title="All">All <span class="count badge">6308</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/4.7.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2531"><a href="http://hookr.io/4.7.2/hooks/" title="Hooks">Hooks <span class="count badge">2531</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.2/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1667"><a href="http://hookr.io/4.7.2/filters/" title="Filters">Filters <span class="count badge">1667</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.2/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.2/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2852"><a href="http://hookr.io/4.7.2/functions/" title="Functions">Functions <span class="count badge">2852</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-admin/includes/upgrade.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress Upgrade API</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Most of the functions are pluggable and can be overwritten.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Include user install customize script. */</span>&nbsp;</div></li><li><div>if ( file_exists(WP_CONTENT_DIR . '/install.php') )&nbsp;</div></li><li><div>  require (WP_CONTENT_DIR . '/install.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** WordPress Administration API */</span>&nbsp;</div></li><li><div>require_once(ABSPATH . 'wp-admin/includes/admin.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** WordPress Schema API */</span>&nbsp;</div></li><li><div>require_once(ABSPATH . 'wp-admin/includes/schema.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('wp_install') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Installs the site.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Runs the required functions to set up and populate the database, </span>&nbsp;</div></li><li><div><span class="comment"> * including primary admin user and initial options.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_title    Site title.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_name     User's username.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email    User's email.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $public        Whether site is public.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $deprecated    Optional. Not used.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_password Optional. User's chosen password. Default empty (random password).</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $language      Optional. Language chosen. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array keys 'url', 'user_id', 'password', and 'password_message'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_install( $blog_title, $user_name, $user_email, $public, $deprecated = '', $user_password = '', $language = '' ) {&nbsp;</div></li><li><div>  if ( !empty( $deprecated ) )&nbsp;</div></li><li><div>      _deprecated_argument( __FUNCTION__, '2.6.0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_check_mysql_version();&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>  make_db_current_silent();&nbsp;</div></li><li><div>  populate_options();&nbsp;</div></li><li><div>  populate_roles();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option('blogname', $blog_title);&nbsp;</div></li><li><div>  update_option('admin_email', $user_email);&nbsp;</div></li><li><div>  update_option('blog_public', $public);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Freshness of site - in the future, this could get more specific about actions taken, perhaps.</span>&nbsp;</div></li><li><div>  update_option( 'fresh_site', 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $language ) {&nbsp;</div></li><li><div>      update_option( 'WPLANG', $language );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $guessurl = wp_guess_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option('siteurl', $guessurl);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If not a public blog, don't ping.</span>&nbsp;</div></li><li><div>  if ( ! $public )&nbsp;</div></li><li><div>      update_option('default_pingback_flag', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create default user. If the user already exists, the user tables are</span>&nbsp;</div></li><li><div><span class="comment">   * being shared among sites. Just set the role in that case.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $user_id = username_exists($user_name);&nbsp;</div></li><li><div>  $user_password = trim($user_password);&nbsp;</div></li><li><div>  $email_password = false;&nbsp;</div></li><li><div>  if ( !$user_id && empty($user_password) ) {&nbsp;</div></li><li><div>      $user_password = wp_generate_password( 12, false );&nbsp;</div></li><li><div>      $message = __('&lt;strong&gt;&lt;em&gt;Note that password&lt;/em&gt;&lt;/strong&gt; carefully! It is a &lt;em&gt;random&lt;/em&gt; password that was generated just for you.');&nbsp;</div></li><li><div>      $user_id = wp_create_user($user_name, $user_password, $user_email);&nbsp;</div></li><li><div>      update_user_option($user_id, 'default_password_nag', true, true);&nbsp;</div></li><li><div>      $email_password = true;&nbsp;</div></li><li><div>  } elseif ( ! $user_id ) {&nbsp;</div></li><li><div>      <span class="comment">// Password has been provided</span>&nbsp;</div></li><li><div>      $message = '&lt;em&gt;'.__('Your chosen password.').'&lt;/em&gt;';&nbsp;</div></li><li><div>      $user_id = wp_create_user($user_name, $user_password, $user_email);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $message = __('User already exists. Password inherited.');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = new WP_User($user_id);&nbsp;</div></li><li><div>  $user-&gt;set_role('administrator');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_install_defaults($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_install_maybe_enable_pretty_permalinks();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  flush_rewrite_rules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_new_blog_notification($blog_title, $guessurl, $user_id, ($email_password ? $user_password : __('The password you chose during the install.') ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a site is fully installed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User $user The site owner.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wp_install', $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array('url' =&gt; $guessurl, 'user_id' =&gt; $user_id, 'password' =&gt; $user_password, 'password_message' =&gt; $message);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('wp_install_defaults') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates the initial content for a newly-installed site.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Adds the default &quot;Uncategorized&quot; category, the first post (with comment), </span>&nbsp;</div></li><li><div><span class="comment"> * first page, and default widgets for default theme for the current version.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb       $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Rewrite $wp_rewrite</span>&nbsp;</div></li><li><div><span class="comment"> * @global string     $table_prefix</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_install_defaults( $user_id ) {&nbsp;</div></li><li><div>  global $wpdb, $wp_rewrite, $table_prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default category</span>&nbsp;</div></li><li><div>  $cat_name = __('Uncategorized');&nbsp;</div></li><li><div>  <span class="comment">/** translators: Default category slug */</span>&nbsp;</div></li><li><div>  $cat_slug = sanitize_title(_x('Uncategorized', 'Default category slug'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( global_terms_enabled() ) {&nbsp;</div></li><li><div>      $cat_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT cat_ID FROM {$wpdb-&gt;sitecategories} WHERE category_nicename = %s&quot;, $cat_slug ) );&nbsp;</div></li><li><div>      if ( $cat_id == null ) {&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;sitecategories, array('cat_ID' =&gt; 0, 'cat_name' =&gt; $cat_name, 'category_nicename' =&gt; $cat_slug, 'last_updated' =&gt; current_time('mysql', true)) );&nbsp;</div></li><li><div>          $cat_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      update_option('default_category', $cat_id);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $cat_id = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;terms, array('term_id' =&gt; $cat_id, 'name' =&gt; $cat_name, 'slug' =&gt; $cat_slug, 'term_group' =&gt; 0) );&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;term_taxonomy, array('term_id' =&gt; $cat_id, 'taxonomy' =&gt; 'category', 'description' =&gt; '', 'parent' =&gt; 0, 'count' =&gt; 1));&nbsp;</div></li><li><div>  $cat_tt_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// First post</span>&nbsp;</div></li><li><div>  $now = current_time( 'mysql' );&nbsp;</div></li><li><div>  $now_gmt = current_time( 'mysql', 1 );&nbsp;</div></li><li><div>  $first_post_guid = get_option( 'home' ) . '/?p=1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $first_post = get_site_option( 'first_post' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $first_post ) {&nbsp;</div></li><li><div>          <span class="comment">/** translators: %s: site link */</span>&nbsp;</div></li><li><div>          $first_post = __( 'Welcome to %s. This is your first post. Edit or delete it, then start blogging!' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $first_post = sprintf( $first_post, &nbsp;</div></li><li><div>          sprintf( '&lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;', esc_url( network_home_url() ), get_network()-&gt;site_name )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Back-compat for pre-4.4</span>&nbsp;</div></li><li><div>      $first_post = str_replace( 'SITE_URL', esc_url( network_home_url() ), $first_post );&nbsp;</div></li><li><div>      $first_post = str_replace( 'SITE_NAME', get_network()-&gt;site_name, $first_post );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $first_post = __( 'Welcome to WordPress. This is your first post. Edit or delete it, then start writing!' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;posts, array(&nbsp;</div></li><li><div>      'post_author' =&gt; $user_id, &nbsp;</div></li><li><div>      'post_date' =&gt; $now, &nbsp;</div></li><li><div>      'post_date_gmt' =&gt; $now_gmt, &nbsp;</div></li><li><div>      'post_content' =&gt; $first_post, &nbsp;</div></li><li><div>      'post_excerpt' =&gt; '', &nbsp;</div></li><li><div>      'post_title' =&gt; __('Hello world!'), &nbsp;</div></li><li><div>      <span class="comment">/** translators: Default post slug */</span>&nbsp;</div></li><li><div>      'post_name' =&gt; sanitize_title( _x('hello-world', 'Default post slug') ), &nbsp;</div></li><li><div>      'post_modified' =&gt; $now, &nbsp;</div></li><li><div>      'post_modified_gmt' =&gt; $now_gmt, &nbsp;</div></li><li><div>      'guid' =&gt; $first_post_guid, &nbsp;</div></li><li><div>      'comment_count' =&gt; 1, &nbsp;</div></li><li><div>      'to_ping' =&gt; '', &nbsp;</div></li><li><div>      'pinged' =&gt; '', &nbsp;</div></li><li><div>      'post_content_filtered' =&gt; ''&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;term_relationships, array('term_taxonomy_id' =&gt; $cat_tt_id, 'object_id' =&gt; 1) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Default comment</span>&nbsp;</div></li><li><div>  $first_comment_author = __( 'A WordPress Commenter' );&nbsp;</div></li><li><div>  $first_comment_email = 'wapuu@wordpress.example';&nbsp;</div></li><li><div>  $first_comment_url = 'https:<span class="comment"><span class="comment">//wordpress.org/</span>';</span>&nbsp;</div></li><li><div>  $first_comment = __( 'Hi, this is a comment.&nbsp;</div></li><li><div>To get started with moderating, editing, and deleting comments, please visit the Comments screen in the dashboard.&nbsp;</div></li><li><div>Commenter avatars come from &lt;a href=&quot;https:<span class="comment">//gravatar.com&quot;&gt;Gravatar&lt;/a&gt;.' );</span>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $first_comment_author = get_site_option( 'first_comment_author', $first_comment_author );&nbsp;</div></li><li><div>      $first_comment_email = get_site_option( 'first_comment_email', $first_comment_email );&nbsp;</div></li><li><div>      $first_comment_url = get_site_option( 'first_comment_url', network_home_url() );&nbsp;</div></li><li><div>      $first_comment = get_site_option( 'first_comment', $first_comment );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;comments, array(&nbsp;</div></li><li><div>      'comment_post_ID' =&gt; 1, &nbsp;</div></li><li><div>      'comment_author' =&gt; $first_comment_author, &nbsp;</div></li><li><div>      'comment_author_email' =&gt; $first_comment_email, &nbsp;</div></li><li><div>      'comment_author_url' =&gt; $first_comment_url, &nbsp;</div></li><li><div>      'comment_date' =&gt; $now, &nbsp;</div></li><li><div>      'comment_date_gmt' =&gt; $now_gmt, &nbsp;</div></li><li><div>      'comment_content' =&gt; $first_comment&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// First Page</span>&nbsp;</div></li><li><div>  $first_page = sprintf( __( &quot;This is an example page. It's different from a blog post because it will stay in one place and will show up in your site navigation (in most themes). Most people start with an About page that introduces them to potential site visitors. It might say something like this:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;blockquote&gt;Hi there! I'm a bike messenger by day, aspiring actor by night, and this is my website. I live in Los Angeles, have a great dog named Jack, and I like pi&#241;a coladas. (And gettin' caught in the rain.)&lt;/blockquote&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>...or something like this:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;blockquote&gt;The XYZ Doohickey Company was founded in 1971, and has been providing quality doohickeys to the public ever since. Located in Gotham City, XYZ employs over 2, 000 people and does all kinds of awesome things for the Gotham community.&lt;/blockquote&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>As a new WordPress user, you should go to &lt;a href=\&quot;%s\&quot;&gt;your dashboard&lt;/a&gt; to delete this page and create new pages for your content. Have fun!&quot; ), admin_url() );&nbsp;</div></li><li><div>  if ( is_multisite() )&nbsp;</div></li><li><div>      $first_page = get_site_option( 'first_page', $first_page );&nbsp;</div></li><li><div>  $first_post_guid = get_option('home') . '/?page_id=2';&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;posts, array(&nbsp;</div></li><li><div>      'post_author' =&gt; $user_id, &nbsp;</div></li><li><div>      'post_date' =&gt; $now, &nbsp;</div></li><li><div>      'post_date_gmt' =&gt; $now_gmt, &nbsp;</div></li><li><div>      'post_content' =&gt; $first_page, &nbsp;</div></li><li><div>      'post_excerpt' =&gt; '', &nbsp;</div></li><li><div>      'comment_status' =&gt; 'closed', &nbsp;</div></li><li><div>      'post_title' =&gt; __( 'Sample Page' ), &nbsp;</div></li><li><div>      <span class="comment">/** translators: Default page slug */</span>&nbsp;</div></li><li><div>      'post_name' =&gt; __( 'sample-page' ), &nbsp;</div></li><li><div>      'post_modified' =&gt; $now, &nbsp;</div></li><li><div>      'post_modified_gmt' =&gt; $now_gmt, &nbsp;</div></li><li><div>      'guid' =&gt; $first_post_guid, &nbsp;</div></li><li><div>      'post_type' =&gt; 'page', &nbsp;</div></li><li><div>      'to_ping' =&gt; '', &nbsp;</div></li><li><div>      'pinged' =&gt; '', &nbsp;</div></li><li><div>      'post_content_filtered' =&gt; ''&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;postmeta, array( 'post_id' =&gt; 2, 'meta_key' =&gt; '_wp_page_template', 'meta_value' =&gt; 'default' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set up default widgets for default theme.</span>&nbsp;</div></li><li><div>  update_option( 'widget_search', array ( 2 =&gt; array ( 'title' =&gt; '' ), '_multiwidget' =&gt; 1 ) );&nbsp;</div></li><li><div>  update_option( 'widget_recent-posts', array ( 2 =&gt; array ( 'title' =&gt; '', 'number' =&gt; 5 ), '_multiwidget' =&gt; 1 ) );&nbsp;</div></li><li><div>  update_option( 'widget_recent-comments', array ( 2 =&gt; array ( 'title' =&gt; '', 'number' =&gt; 5 ), '_multiwidget' =&gt; 1 ) );&nbsp;</div></li><li><div>  update_option( 'widget_archives', array ( 2 =&gt; array ( 'title' =&gt; '', 'count' =&gt; 0, 'dropdown' =&gt; 0 ), '_multiwidget' =&gt; 1 ) );&nbsp;</div></li><li><div>  update_option( 'widget_categories', array ( 2 =&gt; array ( 'title' =&gt; '', 'count' =&gt; 0, 'hierarchical' =&gt; 0, 'dropdown' =&gt; 0 ), '_multiwidget' =&gt; 1 ) );&nbsp;</div></li><li><div>  update_option( 'widget_meta', array ( 2 =&gt; array ( 'title' =&gt; '' ), '_multiwidget' =&gt; 1 ) );&nbsp;</div></li><li><div>  update_option( 'sidebars_widgets', array( 'wp_inactive_widgets' =&gt; array(), 'sidebar-1' =&gt; array( 0 =&gt; 'search-2', 1 =&gt; 'recent-posts-2', 2 =&gt; 'recent-comments-2', 3 =&gt; 'archives-2', 4 =&gt; 'categories-2', 5 =&gt; 'meta-2' ), 'sidebar-2' =&gt; array(), 'sidebar-3' =&gt; array(), 'array_version' =&gt; 3 ) );&nbsp;</div></li><li><div>  if ( ! is_multisite() )&nbsp;</div></li><li><div>      update_user_meta( $user_id, 'show_welcome_panel', 1 );&nbsp;</div></li><li><div>  elseif ( ! is_super_admin( $user_id ) && ! metadata_exists( 'user', $user_id, 'show_welcome_panel' ) )&nbsp;</div></li><li><div>      update_user_meta( $user_id, 'show_welcome_panel', 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      <span class="comment">// Flush rules to pick up the new page.</span>&nbsp;</div></li><li><div>      $wp_rewrite-&gt;init();&nbsp;</div></li><li><div>      $wp_rewrite-&gt;flush_rules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user = new WP_User($user_id);&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;options, array('option_value' =&gt; $user-&gt;user_email), array('option_name' =&gt; 'admin_email') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove all perms except for the login user.</span>&nbsp;</div></li><li><div>      $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;DELETE FROM $wpdb-&gt;usermeta WHERE user_id != %d AND meta_key = %s&quot;, $user_id, $table_prefix.'user_level') );&nbsp;</div></li><li><div>      $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;DELETE FROM $wpdb-&gt;usermeta WHERE user_id != %d AND meta_key = %s&quot;, $user_id, $table_prefix.'capabilities') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete any caps that snuck into the previously active blog. (Hardcoded to blog 1 for now.) TODO: Get previous_blog_id.</span>&nbsp;</div></li><li><div>      if ( !is_super_admin( $user_id ) && $user_id != 1 )&nbsp;</div></li><li><div>          $wpdb-&gt;delete( $wpdb-&gt;usermeta, array( 'user_id' =&gt; $user_id , 'meta_key' =&gt; $wpdb-&gt;base_prefix.'1_capabilities' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Maybe enable pretty permalinks on install.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If after enabling pretty permalinks don't work, fallback to query-string permalinks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Rewrite $wp_rewrite WordPress rewrite component.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether pretty permalinks are enabled. False otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_install_maybe_enable_pretty_permalinks() {&nbsp;</div></li><li><div>  global $wp_rewrite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bail if a permalink structure is already enabled.</span>&nbsp;</div></li><li><div>  if ( get_option( 'permalink_structure' ) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The Permalink structures to attempt.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The first is designed for mod_rewrite or nginx rewriting.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The second is PATHINFO-based permalinks for web server configurations</span>&nbsp;</div></li><li><div><span class="comment">   * without a true rewrite module enabled.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $permalink_structures = array(&nbsp;</div></li><li><div>      '/%year%/%monthnum%/%day%/%postname%/', &nbsp;</div></li><li><div>      '/index.php/%year%/%monthnum%/%day%/%postname%/'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) $permalink_structures as $permalink_structure ) {&nbsp;</div></li><li><div>      $wp_rewrite-&gt;set_permalink_structure( $permalink_structure );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">        * Flush rules with the hard option to force refresh of the web-server's</span>&nbsp;</div></li><li><div><span class="comment">        * rewrite config file (e.g. .htaccess or web.config).</span>&nbsp;</div></li><li><div><span class="comment">        */</span>&nbsp;</div></li><li><div>      $wp_rewrite-&gt;flush_rules( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $test_url = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Test against a real WordPress Post</span>&nbsp;</div></li><li><div>      $first_post = get_page_by_path( sanitize_title( _x( 'hello-world', 'Default post slug' ) ), OBJECT, 'post' );&nbsp;</div></li><li><div>      if ( $first_post ) {&nbsp;</div></li><li><div>          $test_url = get_permalink( $first_post-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">        * Send a request to the site, and check whether</span>&nbsp;</div></li><li><div><span class="comment">        * the 'x-pingback' header is returned as expected.</span>&nbsp;</div></li><li><div><span class="comment">        *</span>&nbsp;</div></li><li><div><span class="comment">        * Uses wp_remote_get() instead of wp_remote_head() because web servers</span>&nbsp;</div></li><li><div><span class="comment">        * can block head requests.</span>&nbsp;</div></li><li><div><span class="comment">        */</span>&nbsp;</div></li><li><div>      $response = wp_remote_get( $test_url, array( 'timeout' =&gt; 5 ) );&nbsp;</div></li><li><div>      $x_pingback_header = wp_remote_retrieve_header( $response, 'x-pingback' );&nbsp;</div></li><li><div>      $pretty_permalinks = $x_pingback_header && $x_pingback_header === get_bloginfo( 'pingback_url' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $pretty_permalinks ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If it makes it this far, pretty permalinks failed.</span>&nbsp;</div></li><li><div><span class="comment">   * Fallback to query-string permalinks.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $wp_rewrite-&gt;set_permalink_structure( '' );&nbsp;</div></li><li><div>  $wp_rewrite-&gt;flush_rules( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('wp_new_blog_notification') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notifies the site admin that the setup is complete.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Sends an email with wp_mail to the new administrator that the site setup is complete, </span>&nbsp;</div></li><li><div><span class="comment"> * and provides them with a record of their login credentials.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_title Site title.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_url   Site url.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id    User ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $password   User's Password.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_new_blog_notification($blog_title, $blog_url, $user_id, $password) {&nbsp;</div></li><li><div>  $user = new WP_User( $user_id );&nbsp;</div></li><li><div>  $email = $user-&gt;user_email;&nbsp;</div></li><li><div>  $name = $user-&gt;user_login;&nbsp;</div></li><li><div>  $login_url = wp_login_url();&nbsp;</div></li><li><div>  <span class="comment">/** translators: New site notification email. 1: New site URL, 2: User login, 3: User password or password reset link, 4: Login URL */</span>&nbsp;</div></li><li><div>  $message = sprintf( __( &quot;Your new WordPress site has been successfully set up at:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>%1\$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>You can log in to the administrator account with the following information:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Username: %2\$s&nbsp;</div></li><li><div>Password: %3\$s&nbsp;</div></li><li><div>Log in here: %4\$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>We hope you enjoy your new site. Thanks!&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>--The WordPress Team&nbsp;</div></li><li><div>https:<span class="comment">//wordpress.org/</span>&nbsp;</div></li><li><div>&quot;), $blog_url, $name, $password, $login_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  @wp_mail($email, __('New WordPress Site'), $message);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( !function_exists('wp_upgrade') ) :&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Runs WordPress Upgrade functions.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Upgrades the database if needed during a site update.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_upgrade() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wp_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_current_db_version = __get_option('db_version');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// We are up-to-date. Nothing to do.</span></span>&nbsp;</div></li><li><div>  if ( $wp_db_version == $wp_current_db_version )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_blog_installed() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_check_mysql_version();&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>  pre_schema_upgrade();&nbsp;</div></li><li><div>  make_db_current_silent();&nbsp;</div></li><li><div>  upgrade_all();&nbsp;</div></li><li><div>  if ( is_multisite() && is_main_site() )&nbsp;</div></li><li><div>      upgrade_network();&nbsp;</div></li><li><div>  wp_cache_flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      if ( $wpdb-&gt;get_row( &quot;SELECT blog_id FROM {$wpdb-&gt;blog_versions} WHERE blog_id = '{$wpdb-&gt;blogid}'&quot; ) )&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;UPDATE {$wpdb-&gt;blog_versions} SET db_version = '{$wp_db_version}' WHERE blog_id = '{$wpdb-&gt;blogid}'&quot; );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;INSERT INTO {$wpdb-&gt;blog_versions} ( `blog_id` , `db_version` , `last_updated` ) VALUES ( '{$wpdb-&gt;blogid}', '{$wp_db_version}', NOW());&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a site is fully upgraded.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $wp_db_version         The new $wp_db_version.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $wp_current_db_version The old (current) $wp_db_version.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wp_upgrade', $wp_db_version, $wp_current_db_version );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Functions to be called in install and upgrade scripts.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Contains conditional checks to determine which upgrade scripts to run, </span>&nbsp;</div></li><li><div><span class="comment"> * based on database version and WP version being updated-to.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_all() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wp_db_version;&nbsp;</div></li><li><div>  $wp_current_db_version = __get_option('db_version');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// We are up-to-date. Nothing to do.</span></span>&nbsp;</div></li><li><div>  if ( $wp_db_version == $wp_current_db_version )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the version is not set in the DB, try to guess the version.</span>&nbsp;</div></li><li><div>  if ( empty($wp_current_db_version) ) {&nbsp;</div></li><li><div>      $wp_current_db_version = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the template option exists, we have 1.5.</span>&nbsp;</div></li><li><div>      $template = __get_option('template');&nbsp;</div></li><li><div>      if ( !empty($template) )&nbsp;</div></li><li><div>          $wp_current_db_version = 2541;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 6039 )&nbsp;</div></li><li><div>      upgrade_230_options_table();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  populate_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 2541 ) {&nbsp;</div></li><li><div>      upgrade_100();&nbsp;</div></li><li><div>      upgrade_101();&nbsp;</div></li><li><div>      upgrade_110();&nbsp;</div></li><li><div>      upgrade_130();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 3308 )&nbsp;</div></li><li><div>      upgrade_160();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 4772 )&nbsp;</div></li><li><div>      upgrade_210();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 4351 )&nbsp;</div></li><li><div>      upgrade_old_slugs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 5539 )&nbsp;</div></li><li><div>      upgrade_230();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 6124 )&nbsp;</div></li><li><div>      upgrade_230_old_tables();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 7499 )&nbsp;</div></li><li><div>      upgrade_250();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 7935 )&nbsp;</div></li><li><div>      upgrade_252();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 8201 )&nbsp;</div></li><li><div>      upgrade_260();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 8989 )&nbsp;</div></li><li><div>      upgrade_270();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 10360 )&nbsp;</div></li><li><div>      upgrade_280();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 11958 )&nbsp;</div></li><li><div>      upgrade_290();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 15260 )&nbsp;</div></li><li><div>      upgrade_300();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 19389 )&nbsp;</div></li><li><div>      upgrade_330();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 20080 )&nbsp;</div></li><li><div>      upgrade_340();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 22422 )&nbsp;</div></li><li><div>      upgrade_350();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 25824 )&nbsp;</div></li><li><div>      upgrade_370();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 26148 )&nbsp;</div></li><li><div>      upgrade_372();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 26691 )&nbsp;</div></li><li><div>      upgrade_380();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 29630 )&nbsp;</div></li><li><div>      upgrade_400();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 33055 )&nbsp;</div></li><li><div>      upgrade_430();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 33056 )&nbsp;</div></li><li><div>      upgrade_431();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 35700 )&nbsp;</div></li><li><div>      upgrade_440();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 36686 )&nbsp;</div></li><li><div>      upgrade_450();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 37965 )&nbsp;</div></li><li><div>      upgrade_460();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  maybe_disable_link_manager();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  maybe_disable_automattic_widgets();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option( 'db_version', $wp_db_version );&nbsp;</div></li><li><div>  update_option( 'db_upgraded', true );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 1.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_100() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the title and ID of every post, post_name to check if it already has a value</span>&nbsp;</div></li><li><div>  $posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title, post_name FROM $wpdb-&gt;posts WHERE post_name = ''&quot;);&nbsp;</div></li><li><div>  if ($posts) {&nbsp;</div></li><li><div>      foreach ($posts as $post) {&nbsp;</div></li><li><div>          if ('' == $post-&gt;post_name) {&nbsp;</div></li><li><div>              $newtitle = sanitize_title($post-&gt;post_title);&nbsp;</div></li><li><div>              $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;UPDATE $wpdb-&gt;posts SET post_name = %s WHERE ID = %d&quot;, $newtitle, $post-&gt;ID) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $categories = $wpdb-&gt;get_results(&quot;SELECT cat_ID, cat_name, category_nicename FROM $wpdb-&gt;categories&quot;);&nbsp;</div></li><li><div>  foreach ($categories as $category) {&nbsp;</div></li><li><div>      if ('' == $category-&gt;category_nicename) {&nbsp;</div></li><li><div>          $newtitle = sanitize_title($category-&gt;cat_name);&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;categories, array('category_nicename' =&gt; $newtitle), array('cat_ID' =&gt; $category-&gt;cat_ID) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = &quot;UPDATE $wpdb-&gt;options&nbsp;</div></li><li><div>      SET option_value = REPLACE(option_value, 'wp-links/links-images/', 'wp-images/links/')&nbsp;</div></li><li><div>      WHERE option_name LIKE %s&nbsp;</div></li><li><div>      AND option_value LIKE %s&quot;;&nbsp;</div></li><li><div>  $wpdb-&gt;query( $wpdb-&gt;prepare( $sql, $wpdb-&gt;esc_like( 'links_rating_image' ) . '%', $wpdb-&gt;esc_like( 'wp-links/links-images/' ) . '%' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $done_ids = $wpdb-&gt;get_results(&quot;SELECT DISTINCT post_id FROM $wpdb-&gt;post2cat&quot;);&nbsp;</div></li><li><div>  if ($done_ids) :&nbsp;</div></li><li><div>      $done_posts = array();&nbsp;</div></li><li><div>      foreach ($done_ids as $done_id) :&nbsp;</div></li><li><div>          $done_posts[] = $done_id-&gt;post_id;&nbsp;</div></li><li><div>      endforeach;&nbsp;</div></li><li><div>      $catwhere = ' AND ID NOT IN (' . implode(', ', $done_posts) . ')';&nbsp;</div></li><li><div>  else:&nbsp;</div></li><li><div>      $catwhere = '';&nbsp;</div></li><li><div>  endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $allposts = $wpdb-&gt;get_results(&quot;SELECT ID, post_category FROM $wpdb-&gt;posts WHERE post_category != '0' $catwhere&quot;);&nbsp;</div></li><li><div>  if ($allposts) :&nbsp;</div></li><li><div>      foreach ($allposts as $post) {&nbsp;</div></li><li><div>          <span class="comment">// Check to see if it's already been imported</span>&nbsp;</div></li><li><div>          $cat = $wpdb-&gt;get_row( $wpdb-&gt;prepare(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = %d AND category_id = %d&quot;, $post-&gt;ID, $post-&gt;post_category) );&nbsp;</div></li><li><div>          if (!$cat && 0 != $post-&gt;post_category) { <span class="comment">// If there's no result</span>&nbsp;</div></li><li><div>              $wpdb-&gt;insert( $wpdb-&gt;post2cat, array('post_id' =&gt; $post-&gt;ID, 'category_id' =&gt; $post-&gt;post_category) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  endif;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 1.0.1.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_101() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Clean up indices, add a few</span>&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;posts, 'post_name');&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;posts, 'post_status');&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;categories, 'category_nicename');&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;comments, 'comment_approved');&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;comments, 'comment_post_ID');&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;links , 'link_category');&nbsp;</div></li><li><div>  add_clean_index($wpdb-&gt;links , 'link_visible');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 1.2.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_110() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set user_nicename.</span>&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_results(&quot;SELECT ID, user_nickname, user_nicename FROM $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>  foreach ($users as $user) {&nbsp;</div></li><li><div>      if ('' == $user-&gt;user_nicename) {&nbsp;</div></li><li><div>          $newname = sanitize_title($user-&gt;user_nickname);&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;users, array('user_nicename' =&gt; $newname), array('ID' =&gt; $user-&gt;ID) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_results(&quot;SELECT ID, user_pass from $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>  foreach ($users as $row) {&nbsp;</div></li><li><div>      if (!preg_match('/^[A-Fa-f0-9]{32}$/', $row-&gt;user_pass)) {&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;users, array('user_pass' =&gt; md5($row-&gt;user_pass)), array('ID' =&gt; $row-&gt;ID) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the GMT offset, we'll use that later on</span>&nbsp;</div></li><li><div>  $all_options = get_alloptions_110();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $time_difference = $all_options-&gt;time_difference;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $server_time = time()+date('Z');&nbsp;</div></li><li><div>  $weblogger_time = $server_time + $time_difference * HOUR_IN_SECONDS;&nbsp;</div></li><li><div>  $gmt_time = time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $diff_gmt_server = ($gmt_time - $server_time) / HOUR_IN_SECONDS;&nbsp;</div></li><li><div>  $diff_weblogger_server = ($weblogger_time - $server_time) / HOUR_IN_SECONDS;&nbsp;</div></li><li><div>  $diff_gmt_weblogger = $diff_gmt_server - $diff_weblogger_server;&nbsp;</div></li><li><div>  $gmt_offset = -$diff_gmt_weblogger;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add a gmt_offset option, with value $gmt_offset</span>&nbsp;</div></li><li><div>  add_option('gmt_offset', $gmt_offset);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if we already set the GMT fields (if we did, then</span>&nbsp;</div></li><li><div>  <span class="comment">// MAX(post_date_gmt) can't be '0000-00-00 00:00:00'</span>&nbsp;</div></li><li><div>  <span class="comment">// &lt;michel_v&gt; I just slapped myself silly for not thinking about it earlier</span>&nbsp;</div></li><li><div>  $got_gmt_fields = ! ($wpdb-&gt;get_var(&quot;SELECT MAX(post_date_gmt) FROM $wpdb-&gt;posts&quot;) == '0000-00-00 00:00:00');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!$got_gmt_fields) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add or subtract time to all dates, to get GMT dates</span>&nbsp;</div></li><li><div>      $add_hours = intval($diff_gmt_weblogger);&nbsp;</div></li><li><div>      $add_minutes = intval(60 * ($diff_gmt_weblogger - $add_hours));&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_date_gmt = DATE_ADD(post_date, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_modified = post_date&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_modified_gmt = DATE_ADD(post_modified, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE) WHERE post_modified != '0000-00-00 00:00:00'&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_date_gmt = DATE_ADD(comment_date, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_registered = DATE_ADD(user_registered, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 1.5.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_130() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Remove extraneous backslashes.</span></span></span>&nbsp;</div></li><li><div>  $posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title, post_content, post_excerpt, guid, post_date, post_name, post_status, post_author FROM $wpdb-&gt;posts&quot;);&nbsp;</div></li><li><div>  if ($posts) {&nbsp;</div></li><li><div>      foreach ($posts as $post) {&nbsp;</div></li><li><div>          $post_content = addslashes(deslash($post-&gt;post_content));&nbsp;</div></li><li><div>          $post_title = addslashes(deslash($post-&gt;post_title));&nbsp;</div></li><li><div>          $post_excerpt = addslashes(deslash($post-&gt;post_excerpt));&nbsp;</div></li><li><div>          if ( empty($post-&gt;guid) )&nbsp;</div></li><li><div>              $guid = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $guid = $post-&gt;guid;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;posts, compact('post_title', 'post_content', 'post_excerpt', 'guid'), array('ID' =&gt; $post-&gt;ID) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Remove extraneous backslashes.</span></span></span>&nbsp;</div></li><li><div>  $comments = $wpdb-&gt;get_results(&quot;SELECT comment_ID, comment_author, comment_content FROM $wpdb-&gt;comments&quot;);&nbsp;</div></li><li><div>  if ($comments) {&nbsp;</div></li><li><div>      foreach ($comments as $comment) {&nbsp;</div></li><li><div>          $comment_content = deslash($comment-&gt;comment_content);&nbsp;</div></li><li><div>          $comment_author = deslash($comment-&gt;comment_author);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;update($wpdb-&gt;comments, compact('comment_content', 'comment_author'), array('comment_ID' =&gt; $comment-&gt;comment_ID) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Remove extraneous backslashes.</span></span></span>&nbsp;</div></li><li><div>  $links = $wpdb-&gt;get_results(&quot;SELECT link_id, link_name, link_description FROM $wpdb-&gt;links&quot;);&nbsp;</div></li><li><div>  if ($links) {&nbsp;</div></li><li><div>      foreach ($links as $link) {&nbsp;</div></li><li><div>          $link_name = deslash($link-&gt;link_name);&nbsp;</div></li><li><div>          $link_description = deslash($link-&gt;link_description);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;links, compact('link_name', 'link_description'), array('link_id' =&gt; $link-&gt;link_id) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $active_plugins = __get_option('active_plugins');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If plugins are not stored in an array, they're stored in the old</span>&nbsp;</div></li><li><div><span class="comment">   * newline separated format. Convert to new format.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( !is_array( $active_plugins ) ) {&nbsp;</div></li><li><div>      $active_plugins = explode(&quot;\n&quot;, trim($active_plugins));&nbsp;</div></li><li><div>      update_option('active_plugins', $active_plugins);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Obsolete tables</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'optionvalues');&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'optiontypes');&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'optiongroups');&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'optiongroup_options');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update comments table to use comment_type</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_type='trackback', comment_content = REPLACE(comment_content, '&lt;trackback /&gt;', '') WHERE comment_content LIKE '&lt;trackback /&gt;%'&quot;);&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_type='pingback', comment_content = REPLACE(comment_content, '&lt;pingback /&gt;', '') WHERE comment_content LIKE '&lt;pingback /&gt;%'&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Some versions have multiple duplicate option_name rows with the same values</span>&nbsp;</div></li><li><div>  $options = $wpdb-&gt;get_results(&quot;SELECT option_name, COUNT(option_name) AS dupes FROM `$wpdb-&gt;options` GROUP BY option_name&quot;);&nbsp;</div></li><li><div>  foreach ( $options as $option ) {&nbsp;</div></li><li><div>      if ( 1 != $option-&gt;dupes ) { <span class="comment">// Could this be done in the query?</span>&nbsp;</div></li><li><div>          $limit = $option-&gt;dupes - 1;&nbsp;</div></li><li><div>          $dupe_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare(&quot;SELECT option_id FROM $wpdb-&gt;options WHERE option_name = %s LIMIT %d&quot;, $option-&gt;option_name, $limit) );&nbsp;</div></li><li><div>          if ( $dupe_ids ) {&nbsp;</div></li><li><div>              $dupe_ids = join($dupe_ids, ', ');&nbsp;</div></li><li><div>              $wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;options WHERE option_id IN ($dupe_ids)&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  make_site_theme();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_160() {&nbsp;</div></li><li><div>  global $wpdb, $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  populate_roles_160();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $users = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>  foreach ( $users as $user ) :&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_firstname ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'first_name', wp_slash($user-&gt;user_firstname) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_lastname ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'last_name', wp_slash($user-&gt;user_lastname) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_nickname ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'nickname', wp_slash($user-&gt;user_nickname) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_level ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, $wpdb-&gt;prefix . 'user_level', $user-&gt;user_level );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_icq ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'icq', wp_slash($user-&gt;user_icq) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_aim ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'aim', wp_slash($user-&gt;user_aim) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_msn ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'msn', wp_slash($user-&gt;user_msn) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_yim ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'yim', wp_slash($user-&gt;user_icq) );&nbsp;</div></li><li><div>      if ( !empty( $user-&gt;user_description ) )&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, 'description', wp_slash($user-&gt;user_description) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $user-&gt;user_idmode ) ):&nbsp;</div></li><li><div>          $idmode = $user-&gt;user_idmode;&nbsp;</div></li><li><div>          if ($idmode == 'nickname') $id = $user-&gt;user_nickname;&nbsp;</div></li><li><div>          if ($idmode == 'login') $id = $user-&gt;user_login;&nbsp;</div></li><li><div>          if ($idmode == 'firstname') $id = $user-&gt;user_firstname;&nbsp;</div></li><li><div>          if ($idmode == 'lastname') $id = $user-&gt;user_lastname;&nbsp;</div></li><li><div>          if ($idmode == 'namefl') $id = $user-&gt;user_firstname.' '.$user-&gt;user_lastname;&nbsp;</div></li><li><div>          if ($idmode == 'namelf') $id = $user-&gt;user_lastname.' '.$user-&gt;user_firstname;&nbsp;</div></li><li><div>          if (!$idmode) $id = $user-&gt;user_nickname;&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;users, array('display_name' =&gt; $id), array('ID' =&gt; $user-&gt;ID) );&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// FIXME: RESET_CAPS is temporary code to reset roles and caps if flag is set.</span>&nbsp;</div></li><li><div>      $caps = get_user_meta( $user-&gt;ID, $wpdb-&gt;prefix . 'capabilities');&nbsp;</div></li><li><div>      if ( empty($caps) || defined('RESET_CAPS') ) {&nbsp;</div></li><li><div>          $level = get_user_meta($user-&gt;ID, $wpdb-&gt;prefix . 'user_level', true);&nbsp;</div></li><li><div>          $role = translate_level_to_role($level);&nbsp;</div></li><li><div>          update_user_meta( $user-&gt;ID, $wpdb-&gt;prefix . 'capabilities', array($role =&gt; true) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  endforeach;&nbsp;</div></li><li><div>  $old_user_fields = array( 'user_firstname', 'user_lastname', 'user_icq', 'user_aim', 'user_msn', 'user_yim', 'user_idmode', 'user_ip', 'user_domain', 'user_browser', 'user_description', 'user_nickname', 'user_level' );&nbsp;</div></li><li><div>  $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>  foreach ( $old_user_fields as $old )&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE $wpdb-&gt;users DROP $old&quot;);&nbsp;</div></li><li><div>  $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Populate comment_count field of posts table.</span>&nbsp;</div></li><li><div>  $comments = $wpdb-&gt;get_results( &quot;SELECT comment_post_ID, COUNT(*) as c FROM $wpdb-&gt;comments WHERE comment_approved = '1' GROUP BY comment_post_ID&quot; );&nbsp;</div></li><li><div>  if ( is_array( $comments ) )&nbsp;</div></li><li><div>      foreach ($comments as $comment)&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;posts, array('comment_count' =&gt; $comment-&gt;c), array('ID' =&gt; $comment-&gt;comment_post_ID) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Some alpha versions used a post status of object instead of attachment</span>&nbsp;</div></li><li><div><span class="comment">   * and put the mime type in post_type instead of post_mime_type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &gt; 2541 && $wp_current_db_version &lt;= 3091 ) {&nbsp;</div></li><li><div>      $objects = $wpdb-&gt;get_results(&quot;SELECT ID, post_type FROM $wpdb-&gt;posts WHERE post_status = 'object'&quot;);&nbsp;</div></li><li><div>      foreach ($objects as $object) {&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;posts, array(    'post_status' =&gt; 'attachment', &nbsp;</div></li><li><div>                                              'post_mime_type' =&gt; $object-&gt;post_type, &nbsp;</div></li><li><div>                                              'post_type' =&gt; ''), &nbsp;</div></li><li><div>                                       array( 'ID' =&gt; $object-&gt;ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta = get_post_meta($object-&gt;ID, 'imagedata', true);&nbsp;</div></li><li><div>          if ( ! empty($meta['file']) )&nbsp;</div></li><li><div>              update_attached_file( $object-&gt;ID, $meta['file'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.1.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_210() {&nbsp;</div></li><li><div>  global $wpdb, $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 3506 ) {&nbsp;</div></li><li><div>      <span class="comment">// Update status and type.</span>&nbsp;</div></li><li><div>      $posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_status FROM $wpdb-&gt;posts&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty($posts) ) foreach ($posts as $post) {&nbsp;</div></li><li><div>          $status = $post-&gt;post_status;&nbsp;</div></li><li><div>          $type = 'post';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'static' == $status ) {&nbsp;</div></li><li><div>              $status = 'publish';&nbsp;</div></li><li><div>              $type = 'page';&nbsp;</div></li><li><div>          } elseif ( 'attachment' == $status ) {&nbsp;</div></li><li><div>              $status = 'inherit';&nbsp;</div></li><li><div>              $type = 'attachment';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;UPDATE $wpdb-&gt;posts SET post_status = %s, post_type = %s WHERE ID = %d&quot;, $status, $type, $post-&gt;ID) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 3845 ) {&nbsp;</div></li><li><div>      populate_roles_210();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 3531 ) {&nbsp;</div></li><li><div>      <span class="comment">// Give future posts a post_status of future.</span>&nbsp;</div></li><li><div>      $now = gmdate('Y-m-d H:i:59');&nbsp;</div></li><li><div>      $wpdb-&gt;query (&quot;UPDATE $wpdb-&gt;posts SET post_status = 'future' WHERE post_status = 'publish' AND post_date_gmt &gt; '$now'&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_date FROM $wpdb-&gt;posts WHERE post_status ='future'&quot;);&nbsp;</div></li><li><div>      if ( !empty($posts) )&nbsp;</div></li><li><div>          foreach ( $posts as $post )&nbsp;</div></li><li><div>              wp_schedule_single_event(mysql2date('U', $post-&gt;post_date, false), 'publish_future_post', array($post-&gt;ID));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.3.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_230() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 5200 ) {&nbsp;</div></li><li><div>      populate_roles_230();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Convert categories to terms.</span>&nbsp;</div></li><li><div>  $tt_ids = array();&nbsp;</div></li><li><div>  $have_tags = false;&nbsp;</div></li><li><div>  $categories = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;categories ORDER BY cat_ID&quot;);&nbsp;</div></li><li><div>  foreach ($categories as $category) {&nbsp;</div></li><li><div>      $term_id = (int) $category-&gt;cat_ID;&nbsp;</div></li><li><div>      $name = $category-&gt;cat_name;&nbsp;</div></li><li><div>      $description = $category-&gt;category_description;&nbsp;</div></li><li><div>      $slug = $category-&gt;category_nicename;&nbsp;</div></li><li><div>      $parent = $category-&gt;category_parent;&nbsp;</div></li><li><div>      $term_group = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Associate terms with the same slug in a term group and make slugs unique.</span></span>&nbsp;</div></li><li><div>      if ( $exists = $wpdb-&gt;get_results( $wpdb-&gt;prepare(&quot;SELECT term_id, term_group FROM $wpdb-&gt;terms WHERE slug = %s&quot;, $slug) ) ) {&nbsp;</div></li><li><div>          $term_group = $exists[0]-&gt;term_group;&nbsp;</div></li><li><div>          $id = $exists[0]-&gt;term_id;&nbsp;</div></li><li><div>          $num = 2;&nbsp;</div></li><li><div>          do {&nbsp;</div></li><li><div>              $alt_slug = $slug . &quot;-$num&quot;;&nbsp;</div></li><li><div>              $num++;&nbsp;</div></li><li><div>              $slug_check = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT slug FROM $wpdb-&gt;terms WHERE slug = %s&quot;, $alt_slug) );&nbsp;</div></li><li><div>          } while ( $slug_check );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $slug = $alt_slug;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $term_group ) ) {&nbsp;</div></li><li><div>              $term_group = $wpdb-&gt;get_var(&quot;SELECT MAX(term_group) FROM $wpdb-&gt;terms GROUP BY term_group&quot;) + 1;&nbsp;</div></li><li><div>              $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;UPDATE $wpdb-&gt;terms SET term_group = %d WHERE term_id = %d&quot;, $term_group, $id) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;INSERT INTO $wpdb-&gt;terms (term_id, name, slug, term_group) VALUES&nbsp;</div></li><li><div>      (%d, %s, %s, %d)&quot;, $term_id, $name, $slug, $term_group) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $count = 0;&nbsp;</div></li><li><div>      if ( !empty($category-&gt;category_count) ) {&nbsp;</div></li><li><div>          $count = (int) $category-&gt;category_count;&nbsp;</div></li><li><div>          $taxonomy = 'category';&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;INSERT INTO $wpdb-&gt;term_taxonomy (term_id, taxonomy, description, parent, count) VALUES ( %d, %s, %s, %d, %d)&quot;, $term_id, $taxonomy, $description, $parent, $count) );&nbsp;</div></li><li><div>          $tt_ids[$term_id][$taxonomy] = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty($category-&gt;link_count) ) {&nbsp;</div></li><li><div>          $count = (int) $category-&gt;link_count;&nbsp;</div></li><li><div>          $taxonomy = 'link_category';&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare(&quot;INSERT INTO $wpdb-&gt;term_taxonomy (term_id, taxonomy, description, parent, count) VALUES ( %d, %s, %s, %d, %d)&quot;, $term_id, $taxonomy, $description, $parent, $count) );&nbsp;</div></li><li><div>          $tt_ids[$term_id][$taxonomy] = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty($category-&gt;tag_count) ) {&nbsp;</div></li><li><div>          $have_tags = true;&nbsp;</div></li><li><div>          $count = (int) $category-&gt;tag_count;&nbsp;</div></li><li><div>          $taxonomy = 'post_tag';&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;term_taxonomy, compact('term_id', 'taxonomy', 'description', 'parent', 'count') );&nbsp;</div></li><li><div>          $tt_ids[$term_id][$taxonomy] = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty($count) ) {&nbsp;</div></li><li><div>          $count = 0;&nbsp;</div></li><li><div>          $taxonomy = 'category';&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;term_taxonomy, compact('term_id', 'taxonomy', 'description', 'parent', 'count') );&nbsp;</div></li><li><div>          $tt_ids[$term_id][$taxonomy] = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $select = 'post_id, category_id';&nbsp;</div></li><li><div>  if ( $have_tags )&nbsp;</div></li><li><div>      $select .= ', rel_type';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posts = $wpdb-&gt;get_results(&quot;SELECT $select FROM $wpdb-&gt;post2cat GROUP BY post_id, category_id&quot;);&nbsp;</div></li><li><div>  foreach ( $posts as $post ) {&nbsp;</div></li><li><div>      $post_id = (int) $post-&gt;post_id;&nbsp;</div></li><li><div>      $term_id = (int) $post-&gt;category_id;&nbsp;</div></li><li><div>      $taxonomy = 'category';&nbsp;</div></li><li><div>      if ( !empty($post-&gt;rel_type) && 'tag' == $post-&gt;rel_type)&nbsp;</div></li><li><div>          $taxonomy = 'tag';&nbsp;</div></li><li><div>      $tt_id = $tt_ids[$term_id][$taxonomy];&nbsp;</div></li><li><div>      if ( empty($tt_id) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpdb-&gt;insert( $wpdb-&gt;term_relationships, array('object_id' =&gt; $post_id, 'term_taxonomy_id' =&gt; $tt_id) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// &lt; 3570 we used linkcategories. &gt;= 3570 we used categories and link2cat.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 3570 ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create link_category terms for link categories. Create a map of link</span>&nbsp;</div></li><li><div><span class="comment">       * cat IDs to link_category terms.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $link_cat_id_map = array();&nbsp;</div></li><li><div>      $default_link_cat = 0;&nbsp;</div></li><li><div>      $tt_ids = array();&nbsp;</div></li><li><div>      $link_cats = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name FROM &quot; . $wpdb-&gt;prefix . 'linkcategories');&nbsp;</div></li><li><div>      foreach ( $link_cats as $category) {&nbsp;</div></li><li><div>          $cat_id = (int) $category-&gt;cat_id;&nbsp;</div></li><li><div>          $term_id = 0;&nbsp;</div></li><li><div>          $name = wp_slash($category-&gt;cat_name);&nbsp;</div></li><li><div>          $slug = sanitize_title($name);&nbsp;</div></li><li><div>          $term_group = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Associate terms with the same slug in a term group and make slugs unique.</span></span>&nbsp;</div></li><li><div>          if ( $exists = $wpdb-&gt;get_results( $wpdb-&gt;prepare(&quot;SELECT term_id, term_group FROM $wpdb-&gt;terms WHERE slug = %s&quot;, $slug) ) ) {&nbsp;</div></li><li><div>              $term_group = $exists[0]-&gt;term_group;&nbsp;</div></li><li><div>              $term_id = $exists[0]-&gt;term_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty($term_id) ) {&nbsp;</div></li><li><div>              $wpdb-&gt;insert( $wpdb-&gt;terms, compact('name', 'slug', 'term_group') );&nbsp;</div></li><li><div>              $term_id = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $link_cat_id_map[$cat_id] = $term_id;&nbsp;</div></li><li><div>          $default_link_cat = $term_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;term_taxonomy, array('term_id' =&gt; $term_id, 'taxonomy' =&gt; 'link_category', 'description' =&gt; '', 'parent' =&gt; 0, 'count' =&gt; 0) );&nbsp;</div></li><li><div>          $tt_ids[$term_id] = (int) $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Associate links to cats.</span>&nbsp;</div></li><li><div>      $links = $wpdb-&gt;get_results(&quot;SELECT link_id, link_category FROM $wpdb-&gt;links&quot;);&nbsp;</div></li><li><div>      if ( !empty($links) ) foreach ( $links as $link ) {&nbsp;</div></li><li><div>          if ( 0 == $link-&gt;link_category )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( ! isset($link_cat_id_map[$link-&gt;link_category]) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          $term_id = $link_cat_id_map[$link-&gt;link_category];&nbsp;</div></li><li><div>          $tt_id = $tt_ids[$term_id];&nbsp;</div></li><li><div>          if ( empty($tt_id) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;term_relationships, array('object_id' =&gt; $link-&gt;link_id, 'term_taxonomy_id' =&gt; $tt_id) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set default to the last category we grabbed during the upgrade loop.</span>&nbsp;</div></li><li><div>      update_option('default_link_category', $default_link_cat);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $links = $wpdb-&gt;get_results(&quot;SELECT link_id, category_id FROM $wpdb-&gt;link2cat GROUP BY link_id, category_id&quot;);&nbsp;</div></li><li><div>      foreach ( $links as $link ) {&nbsp;</div></li><li><div>          $link_id = (int) $link-&gt;link_id;&nbsp;</div></li><li><div>          $term_id = (int) $link-&gt;category_id;&nbsp;</div></li><li><div>          $taxonomy = 'link_category';&nbsp;</div></li><li><div>          $tt_id = $tt_ids[$term_id][$taxonomy];&nbsp;</div></li><li><div>          if ( empty($tt_id) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;term_relationships, array('object_id' =&gt; $link_id, 'term_taxonomy_id' =&gt; $tt_id) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 4772 ) {&nbsp;</div></li><li><div>      <span class="comment">// Obsolete linkcategories table</span>&nbsp;</div></li><li><div>      $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'linkcategories');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Recalculate all counts</span>&nbsp;</div></li><li><div>  $terms = $wpdb-&gt;get_results(&quot;SELECT term_taxonomy_id, taxonomy FROM $wpdb-&gt;term_taxonomy&quot;);&nbsp;</div></li><li><div>  foreach ( (array) $terms as $term ) {&nbsp;</div></li><li><div>      if ( ('post_tag' == $term-&gt;taxonomy) || ('category' == $term-&gt;taxonomy) )&nbsp;</div></li><li><div>          $count = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT COUNT(*) FROM $wpdb-&gt;term_relationships, $wpdb-&gt;posts WHERE $wpdb-&gt;posts.ID = $wpdb-&gt;term_relationships.object_id AND post_status = 'publish' AND post_type = 'post' AND term_taxonomy_id = %d&quot;, $term-&gt;term_taxonomy_id) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $count = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT COUNT(*) FROM $wpdb-&gt;term_relationships WHERE term_taxonomy_id = %d&quot;, $term-&gt;term_taxonomy_id) );&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;term_taxonomy, array('count' =&gt; $count), array('term_taxonomy_id' =&gt; $term-&gt;term_taxonomy_id) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove old options from the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_230_options_table() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $old_options_fields = array( 'option_can_override', 'option_type', 'option_width', 'option_height', 'option_description', 'option_admin_level' );&nbsp;</div></li><li><div>  $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>  foreach ( $old_options_fields as $old )&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE $wpdb-&gt;options DROP $old&quot;);&nbsp;</div></li><li><div>  $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove old categories, link2cat, and post2cat database tables.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_230_old_tables() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'categories');&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'link2cat');&nbsp;</div></li><li><div>  $wpdb-&gt;query('DROP TABLE IF EXISTS ' . $wpdb-&gt;prefix . 'post2cat');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Upgrade old slugs made in version 2.2.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_old_slugs() {&nbsp;</div></li><li><div>  <span class="comment">// Upgrade people who were using the Redirect Old Slugs plugin.</span>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;postmeta SET meta_key = '_wp_old_slug' WHERE meta_key = 'old_slug'&quot;);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.5.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_250() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 6689 ) {&nbsp;</div></li><li><div>      populate_roles_250();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.5.2.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.2</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_252() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_activation_key = ''&quot;);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.6.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_260() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 8000 )&nbsp;</div></li><li><div>      populate_roles_260();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.7.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_270() {&nbsp;</div></li><li><div>  global $wpdb, $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 8980 )&nbsp;</div></li><li><div>      populate_roles_270();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update post_date for unpublished posts with empty timestamp</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 8921 )&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;UPDATE $wpdb-&gt;posts SET post_date = post_modified WHERE post_date = '0000-00-00 00:00:00'&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.8.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_280() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 10360 )&nbsp;</div></li><li><div>      populate_roles_280();&nbsp;</div></li><li><div>  if ( is_multisite() ) {&nbsp;</div></li><li><div>      $start = 0;&nbsp;</div></li><li><div>      while( $rows = $wpdb-&gt;get_results( &quot;SELECT option_name, option_value FROM $wpdb-&gt;options ORDER BY option_id LIMIT $start, 20&quot; ) ) {&nbsp;</div></li><li><div>          foreach ( $rows as $row ) {&nbsp;</div></li><li><div>              $value = $row-&gt;option_value;&nbsp;</div></li><li><div>              if ( !@unserialize( $value ) )&nbsp;</div></li><li><div>                  $value = stripslashes( $value );&nbsp;</div></li><li><div>              if ( $value !== $row-&gt;option_value ) {&nbsp;</div></li><li><div>                  update_option( $row-&gt;option_name, $value );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $start += 20;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      refresh_blog_details( $wpdb-&gt;blogid );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 2.9.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_290() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 11958 ) {&nbsp;</div></li><li><div>      <span class="comment">// Previously, setting depth to 1 would redundantly disable threading, but now 2 is the minimum depth to avoid confusion</span>&nbsp;</div></li><li><div>      if ( get_option( 'thread_comments_depth' ) == '1' ) {&nbsp;</div></li><li><div>          update_option( 'thread_comments_depth', 2 );&nbsp;</div></li><li><div>          update_option( 'thread_comments', 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_300() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 15093 )&nbsp;</div></li><li><div>      populate_roles_300();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 14139 && is_multisite() && is_main_site() && ! defined( 'MULTISITE' ) && get_site_option( 'siteurl' ) === false )&nbsp;</div></li><li><div>      add_site_option( 'siteurl', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// 3.0</span> screen options key name changes.</span>&nbsp;</div></li><li><div>  if ( wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>      $sql = &quot;DELETE FROM $wpdb-&gt;usermeta&nbsp;</div></li><li><div>          WHERE meta_key LIKE %s&nbsp;</div></li><li><div>          OR meta_key LIKE %s&nbsp;</div></li><li><div>          OR meta_key LIKE %s&nbsp;</div></li><li><div>          OR meta_key LIKE %s&nbsp;</div></li><li><div>          OR meta_key LIKE %s&nbsp;</div></li><li><div>          OR meta_key LIKE %s&nbsp;</div></li><li><div>          OR meta_key = 'manageedittagscolumnshidden'&nbsp;</div></li><li><div>          OR meta_key = 'managecategoriescolumnshidden'&nbsp;</div></li><li><div>          OR meta_key = 'manageedit-tagscolumnshidden'&nbsp;</div></li><li><div>          OR meta_key = 'manageeditcolumnshidden'&nbsp;</div></li><li><div>          OR meta_key = 'categories_per_page'&nbsp;</div></li><li><div>          OR meta_key = 'edit_tags_per_page'&quot;;&nbsp;</div></li><li><div>      $prefix = $wpdb-&gt;esc_like( $wpdb-&gt;base_prefix );&nbsp;</div></li><li><div>      $wpdb-&gt;query( $wpdb-&gt;prepare( $sql, &nbsp;</div></li><li><div>          $prefix . '%' . $wpdb-&gt;esc_like( 'meta-box-hidden' ) . '%', &nbsp;</div></li><li><div>          $prefix . '%' . $wpdb-&gt;esc_like( 'closedpostboxes' ) . '%', &nbsp;</div></li><li><div>          $prefix . '%' . $wpdb-&gt;esc_like( 'manage-' ) . '%' . $wpdb-&gt;esc_like( '-columns-hidden' ) . '%', &nbsp;</div></li><li><div>          $prefix . '%' . $wpdb-&gt;esc_like( 'meta-box-order' ) . '%', &nbsp;</div></li><li><div>          $prefix . '%' . $wpdb-&gt;esc_like( 'metaboxorder' ) . '%', &nbsp;</div></li><li><div>          $prefix . '%' . $wpdb-&gt;esc_like( 'screen_layout' ) . '%'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.3.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int   $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $wp_registered_widgets</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $sidebars_widgets</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_330() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb, $wp_registered_widgets, $sidebars_widgets;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 19061 && wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;DELETE FROM $wpdb-&gt;usermeta WHERE meta_key IN ('show_admin_bar_admin', 'plugins_last_view')&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &gt;= 11548 )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sidebars_widgets = get_option( 'sidebars_widgets', array() );&nbsp;</div></li><li><div>  $_sidebars_widgets = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($sidebars_widgets['wp_inactive_widgets']) || empty($sidebars_widgets) )&nbsp;</div></li><li><div>      $sidebars_widgets['array_version'] = 3;&nbsp;</div></li><li><div>  elseif ( !isset($sidebars_widgets['array_version']) )&nbsp;</div></li><li><div>      $sidebars_widgets['array_version'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $sidebars_widgets['array_version'] ) {&nbsp;</div></li><li><div>      case 1 :&nbsp;</div></li><li><div>          foreach ( (array) $sidebars_widgets as $index =&gt; $sidebar )&nbsp;</div></li><li><div>          if ( is_array($sidebar) )&nbsp;</div></li><li><div>          foreach ( (array) $sidebar as $i =&gt; $name ) {&nbsp;</div></li><li><div>              $id = strtolower($name);&nbsp;</div></li><li><div>              if ( isset($wp_registered_widgets[$id]) ) {&nbsp;</div></li><li><div>                  $_sidebars_widgets[$index][$i] = $id;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $id = sanitize_title($name);&nbsp;</div></li><li><div>              if ( isset($wp_registered_widgets[$id]) ) {&nbsp;</div></li><li><div>                  $_sidebars_widgets[$index][$i] = $id;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $found = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $wp_registered_widgets as $widget_id =&gt; $widget ) {&nbsp;</div></li><li><div>                  if ( strtolower($widget['name']) == strtolower($name) ) {&nbsp;</div></li><li><div>                      $_sidebars_widgets[$index][$i] = $widget['id'];&nbsp;</div></li><li><div>                      $found = true;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  } elseif ( sanitize_title($widget['name']) == sanitize_title($name) ) {&nbsp;</div></li><li><div>                      $_sidebars_widgets[$index][$i] = $widget['id'];&nbsp;</div></li><li><div>                      $found = true;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $found )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              unset($_sidebars_widgets[$index][$i]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $_sidebars_widgets['array_version'] = 2;&nbsp;</div></li><li><div>          $sidebars_widgets = $_sidebars_widgets;&nbsp;</div></li><li><div>          unset($_sidebars_widgets);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 2 :&nbsp;</div></li><li><div>          $sidebars_widgets = retrieve_widgets();&nbsp;</div></li><li><div>          $sidebars_widgets['array_version'] = 3;&nbsp;</div></li><li><div>          update_option( 'sidebars_widgets', $sidebars_widgets );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.4.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int   $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_340() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 19798 ) {&nbsp;</div></li><li><div>      $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;options DROP COLUMN blog_id&quot; );&nbsp;</div></li><li><div>      $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 19799 ) {&nbsp;</div></li><li><div>      $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE $wpdb-&gt;comments DROP INDEX comment_approved&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 20022 && wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;DELETE FROM $wpdb-&gt;usermeta WHERE meta_key = 'themes_last_view'&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 20080 ) {&nbsp;</div></li><li><div>      if ( 'yes' == $wpdb-&gt;get_var( &quot;SELECT autoload FROM $wpdb-&gt;options WHERE option_name = 'uninstall_plugins'&quot; ) ) {&nbsp;</div></li><li><div>          $uninstall_plugins = get_option( 'uninstall_plugins' );&nbsp;</div></li><li><div>          delete_option( 'uninstall_plugins' );&nbsp;</div></li><li><div>          add_option( 'uninstall_plugins', $uninstall_plugins, null, 'no' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.5.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int   $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_350() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 22006 && $wpdb-&gt;get_var( &quot;SELECT link_id FROM $wpdb-&gt;links LIMIT 1&quot; ) )&nbsp;</div></li><li><div>      update_option( 'link_manager_enabled', 1 ); <span class="comment">// Previously set to 0 by populate_options()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 21811 && wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>      $meta_keys = array();&nbsp;</div></li><li><div>      foreach ( array_merge( get_post_types(), get_taxonomies() ) as $name ) {&nbsp;</div></li><li><div>          if ( false !== strpos( $name, '-' ) )&nbsp;</div></li><li><div>          $meta_keys[] = 'edit_' . str_replace( '-', '_', $name ) . '_per_page';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $meta_keys ) {&nbsp;</div></li><li><div>          $meta_keys = implode( &quot;', '&quot;, $meta_keys );&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;DELETE FROM $wpdb-&gt;usermeta WHERE meta_key IN ('$meta_keys')&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 22422 && $term = get_term_by( 'slug', 'post-format-standard', 'post_format' ) )&nbsp;</div></li><li><div>      wp_delete_term( $term-&gt;term_id, 'post_format' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.7.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_370() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 25824 )&nbsp;</div></li><li><div>      wp_clear_scheduled_hook( 'wp_auto_updates_maybe_update' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.7.2.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.2</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_372() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 26148 )&nbsp;</div></li><li><div>      wp_clear_scheduled_hook( 'wp_maybe_auto_update' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 3.8.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_380() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 26691 ) {&nbsp;</div></li><li><div>      deactivate_plugins( array( 'mp6/mp6.php' ), true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 4.0.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_400() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 29630 ) {&nbsp;</div></li><li><div>      if ( ! is_multisite() && false === get_option( 'WPLANG' ) ) {&nbsp;</div></li><li><div>          if ( defined( 'WPLANG' ) && ( '' !== WPLANG ) && in_array( WPLANG, get_available_languages() ) ) {&nbsp;</div></li><li><div>              update_option( 'WPLANG', WPLANG );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_option( 'WPLANG', '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Execute changes made in WordPress 4.2.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int   $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_420() {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes changes made in WordPress 4.3.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version Current version.</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb                  WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_430() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 32364 ) {&nbsp;</div></li><li><div>      upgrade_430_fix_comments();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Shared terms are split in a separate process.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 32814 ) {&nbsp;</div></li><li><div>      update_option( 'finished_splitting_shared_terms', 0 );&nbsp;</div></li><li><div>      wp_schedule_single_event( time() + ( 1 * MINUTE_IN_SECONDS ), 'wp_split_shared_term_batch' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 33055 && 'utf8mb4' === $wpdb-&gt;charset ) {&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $tables = $wpdb-&gt;tables( 'blog' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $tables = $wpdb-&gt;tables( 'all' );&nbsp;</div></li><li><div>          if ( ! wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>              $global_tables = $wpdb-&gt;tables( 'global' );&nbsp;</div></li><li><div>              $tables = array_diff_assoc( $tables, $global_tables );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $tables as $table ) {&nbsp;</div></li><li><div>          maybe_convert_table_to_utf8mb4( $table );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes comments changes made in WordPress 4.3.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version Current version.</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb                  WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_430_fix_comments() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $content_length = $wpdb-&gt;get_col_length( $wpdb-&gt;comments, 'comment_content' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $content_length ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $content_length ) {&nbsp;</div></li><li><div>      $content_length = array(&nbsp;</div></li><li><div>          'type' =&gt; 'byte', &nbsp;</div></li><li><div>          'length' =&gt; 65535, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  } elseif ( ! is_array( $content_length ) ) {&nbsp;</div></li><li><div>      $length = (int) $content_length &gt; 0 ? (int) $content_length : 65535;&nbsp;</div></li><li><div>      $content_length = array(&nbsp;</div></li><li><div>          'type' =&gt; 'byte', &nbsp;</div></li><li><div>          'length' =&gt; $length&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'byte' !== $content_length['type'] || 0 === $content_length['length'] ) {&nbsp;</div></li><li><div>      <span class="comment">// Sites with malformed DB schemas are on their own.</span>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $allowed_length = intval( $content_length['length'] ) - 10;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comments = $wpdb-&gt;get_results(&nbsp;</div></li><li><div>      &quot;SELECT `comment_ID` FROM `{$wpdb-&gt;comments}`&nbsp;</div></li><li><div>          WHERE `comment_date_gmt` &gt; '2015-04-26'&nbsp;</div></li><li><div>          AND LENGTH( `comment_content` ) &gt;= {$allowed_length}&nbsp;</div></li><li><div>          AND ( `comment_content` LIKE '%&lt;%' OR `comment_content` LIKE '%&gt;%' )&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>      wp_delete_comment( $comment-&gt;comment_ID, true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes changes made in WordPress 4.3.1.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.1</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_431() {&nbsp;</div></li><li><div>  <span class="comment">// Fix incorrect cron entries for term splitting</span>&nbsp;</div></li><li><div>  $cron_array = _get_cron_array();&nbsp;</div></li><li><div>  if ( isset( $cron_array['wp_batch_split_terms'] ) ) {&nbsp;</div></li><li><div>      unset( $cron_array['wp_batch_split_terms'] );&nbsp;</div></li><li><div>      _set_cron_array( $cron_array );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes changes made in WordPress 4.4.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version Current version.</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb                  WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_440() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 34030 ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE {$wpdb-&gt;options} MODIFY option_name VARCHAR(191)&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the unused 'add_users' role.</span>&nbsp;</div></li><li><div>  $roles = wp_roles();&nbsp;</div></li><li><div>  foreach ( $roles-&gt;role_objects as $role ) {&nbsp;</div></li><li><div>      if ( $role-&gt;has_cap( 'add_users' ) ) {&nbsp;</div></li><li><div>          $role-&gt;remove_cap( 'add_users' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes changes made in WordPress 4.5.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version Current database version.</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb                  WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_450() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 36180 ) {&nbsp;</div></li><li><div>      wp_clear_scheduled_hook( 'wp_maybe_auto_update' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove unused email confirmation options, moved to usermeta.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 36679 && is_multisite() ) {&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;DELETE FROM $wpdb-&gt;options WHERE option_name REGEXP '^[0-9]+_new_email$'&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove unused user setting for wpLink.</span>&nbsp;</div></li><li><div>  delete_user_setting( 'wplink' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes changes made in WordPress 4.6.0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int $wp_current_db_version Current database version.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_460() {&nbsp;</div></li><li><div>  global $wp_current_db_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove unused post meta.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 37854 ) {&nbsp;</div></li><li><div>      delete_post_meta_by_key( '_post_restored_from' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove plugins with callback as an array object/method as the uninstall hook, see #13786.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 37965 ) {&nbsp;</div></li><li><div>      $uninstall_plugins = get_option( 'uninstall_plugins', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $uninstall_plugins ) ) {&nbsp;</div></li><li><div>          foreach ( $uninstall_plugins as $basename =&gt; $callback ) {&nbsp;</div></li><li><div>              if ( is_array( $callback ) && is_object( $callback[0] ) ) {&nbsp;</div></li><li><div>                  unset( $uninstall_plugins[ $basename ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_option( 'uninstall_plugins', $uninstall_plugins );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes network-level upgrade routines.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int   $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upgrade_network() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Always.</span>&nbsp;</div></li><li><div>  if ( is_main_network() ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Deletes all expired transients. The multi-table delete syntax is used</span>&nbsp;</div></li><li><div><span class="comment">       * to delete the transient record from table a, and the corresponding</span>&nbsp;</div></li><li><div><span class="comment">       * transient_timeout record from table b.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $time = time();&nbsp;</div></li><li><div>      $sql = &quot;DELETE a, b FROM $wpdb-&gt;sitemeta a, $wpdb-&gt;sitemeta b&nbsp;</div></li><li><div>          WHERE a.meta_key LIKE %s&nbsp;</div></li><li><div>          AND a.meta_key NOT LIKE %s&nbsp;</div></li><li><div>          AND b.meta_key = CONCAT( '_site_transient_timeout_', SUBSTRING( a.meta_key, 17 ) )&nbsp;</div></li><li><div>          AND b.meta_value &lt; %d&quot;;&nbsp;</div></li><li><div>      $wpdb-&gt;query( $wpdb-&gt;prepare( $sql, $wpdb-&gt;esc_like( '_site_transient_' ) . '%', $wpdb-&gt;esc_like ( '_site_transient_timeout_' ) . '%', $time ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 2.8.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 11549 ) {&nbsp;</div></li><li><div>      $wpmu_sitewide_plugins = get_site_option( 'wpmu_sitewide_plugins' );&nbsp;</div></li><li><div>      $active_sitewide_plugins = get_site_option( 'active_sitewide_plugins' );&nbsp;</div></li><li><div>      if ( $wpmu_sitewide_plugins ) {&nbsp;</div></li><li><div>          if ( !$active_sitewide_plugins )&nbsp;</div></li><li><div>              $sitewide_plugins = (array) $wpmu_sitewide_plugins;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $sitewide_plugins = array_merge( (array) $active_sitewide_plugins, (array) $wpmu_sitewide_plugins );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_site_option( 'active_sitewide_plugins', $sitewide_plugins );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      delete_site_option( 'wpmu_sitewide_plugins' );&nbsp;</div></li><li><div>      delete_site_option( 'deactivated_sitewide_plugins' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $start = 0;&nbsp;</div></li><li><div>      while( $rows = $wpdb-&gt;get_results( &quot;SELECT meta_key, meta_value FROM {$wpdb-&gt;sitemeta} ORDER BY meta_id LIMIT $start, 20&quot; ) ) {&nbsp;</div></li><li><div>          foreach ( $rows as $row ) {&nbsp;</div></li><li><div>              $value = $row-&gt;meta_value;&nbsp;</div></li><li><div>              if ( !@unserialize( $value ) )&nbsp;</div></li><li><div>                  $value = stripslashes( $value );&nbsp;</div></li><li><div>              if ( $value !== $row-&gt;meta_value ) {&nbsp;</div></li><li><div>                  update_site_option( $row-&gt;meta_key, $value );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $start += 20;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 3.0</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 13576 )&nbsp;</div></li><li><div>      update_site_option( 'global_terms_enabled', '1' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 3.3</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 19390 )&nbsp;</div></li><li><div>      update_site_option( 'initial_db_version', $wp_current_db_version );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 19470 ) {&nbsp;</div></li><li><div>      if ( false === get_site_option( 'active_sitewide_plugins' ) )&nbsp;</div></li><li><div>          update_site_option( 'active_sitewide_plugins', array() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 3.4</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 20148 ) {&nbsp;</div></li><li><div>      <span class="comment">// 'allowedthemes' keys things by stylesheet. 'allowed_themes' keyed things by name.</span>&nbsp;</div></li><li><div>      $allowedthemes = get_site_option( 'allowedthemes' );&nbsp;</div></li><li><div>      $allowed_themes = get_site_option( 'allowed_themes' );&nbsp;</div></li><li><div>      if ( false === $allowedthemes && is_array( $allowed_themes ) && $allowed_themes ) {&nbsp;</div></li><li><div>          $converted = array();&nbsp;</div></li><li><div>          $themes = wp_get_themes();&nbsp;</div></li><li><div>          foreach ( $themes as $stylesheet =&gt; $theme_data ) {&nbsp;</div></li><li><div>              if ( isset( $allowed_themes[ $theme_data-&gt;get('Name') ] ) )&nbsp;</div></li><li><div>                  $converted[ $stylesheet ] = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          update_site_option( 'allowedthemes', $converted );&nbsp;</div></li><li><div>          delete_site_option( 'allowed_themes' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 3.5</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 21823 )&nbsp;</div></li><li><div>      update_site_option( 'ms_files_rewriting', '1' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 3.5</span>.2&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 24448 ) {&nbsp;</div></li><li><div>      $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>      if ( is_array( $illegal_names ) && count( $illegal_names ) === 1 ) {&nbsp;</div></li><li><div>          $illegal_name = reset( $illegal_names );&nbsp;</div></li><li><div>          $illegal_names = explode( ' ', $illegal_name );&nbsp;</div></li><li><div>          update_site_option( 'illegal_names', $illegal_names );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 4.2</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 31351 && $wpdb-&gt;charset === 'utf8mb4' ) {&nbsp;</div></li><li><div>      if ( wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;usermeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))&quot; );&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;site DROP INDEX domain, ADD INDEX domain(domain(140), path(51))&quot; );&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;sitemeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))&quot; );&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;signups DROP INDEX domain_path, ADD INDEX domain_path(domain(140), path(51))&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tables = $wpdb-&gt;tables( 'global' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// sitecategories may not exist.</span></span>&nbsp;</div></li><li><div>          if ( ! $wpdb-&gt;get_var( &quot;SHOW TABLES LIKE '{$tables['sitecategories']}'&quot; ) ) {&nbsp;</div></li><li><div>              unset( $tables['sitecategories'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $tables as $table ) {&nbsp;</div></li><li><div>              maybe_convert_table_to_utf8mb4( $table );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// 4.3</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 33055 && 'utf8mb4' === $wpdb-&gt;charset ) {&nbsp;</div></li><li><div>      if ( wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>          $upgrade = false;&nbsp;</div></li><li><div>          $indexes = $wpdb-&gt;get_results( &quot;SHOW INDEXES FROM $wpdb-&gt;signups&quot; );&nbsp;</div></li><li><div>          foreach ( $indexes as $index ) {&nbsp;</div></li><li><div>              if ( 'domain_path' == $index-&gt;Key_name && 'domain' == $index-&gt;Column_name && 140 != $index-&gt;Sub_part ) {&nbsp;</div></li><li><div>                  $upgrade = true;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $upgrade ) {&nbsp;</div></li><li><div>              $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;signups DROP INDEX domain_path, ADD INDEX domain_path(domain(140), path(51))&quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tables = $wpdb-&gt;tables( 'global' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// sitecategories may not exist.</span></span>&nbsp;</div></li><li><div>          if ( ! $wpdb-&gt;get_var( &quot;SHOW TABLES LIKE '{$tables['sitecategories']}'&quot; ) ) {&nbsp;</div></li><li><div>              unset( $tables['sitecategories'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $tables as $table ) {&nbsp;</div></li><li><div>              maybe_convert_table_to_utf8mb4( $table );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// General functions we use to actually do stuff</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a table in the database if it doesn't already exist.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This method checks for an existing database and creates a new one if it's not</span>&nbsp;</div></li><li><div><span class="comment"> * already present. It doesn't rely on MySQL's &quot;IF NOT EXISTS&quot; statement, but chooses</span>&nbsp;</div></li><li><div><span class="comment"> * to query all tables first and then run the SQL statement creating the table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $table_name Database table name to create.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $create_ddl SQL statement to create table.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool If table already exists or was created by function.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_create_table($table_name, $create_ddl) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = $wpdb-&gt;prepare( &quot;SHOW TABLES LIKE %s&quot;, $wpdb-&gt;esc_like( $table_name ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wpdb-&gt;get_var( $query ) == $table_name ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Didn't find it try to create it.</span>.</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query($create_ddl);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// We cannot directly tell that whether this succeeded!</span></span>&nbsp;</div></li><li><div>  if ( $wpdb-&gt;get_var( $query ) == $table_name ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Drops a specified index from a table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $table Database table name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $index Index name to drop.</span>&nbsp;</div></li><li><div><span class="comment"> * @return true True, when finished.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function drop_index($table, $index) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;ALTER TABLE `$table` DROP INDEX `$index`&quot;);&nbsp;</div></li><li><div>  <span class="comment">// Now we need to take out all the extra ones we may have created</span>&nbsp;</div></li><li><div>  for ($i = 0; $i &lt; 25; $i++) {&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE `$table` DROP INDEX `{$index}_$i`&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $wpdb-&gt;show_errors();&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds an index to a specified table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.1</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $table Database table name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $index Database table index column.</span>&nbsp;</div></li><li><div><span class="comment"> * @return true True, when done with execution.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_clean_index($table, $index) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  drop_index($table, $index);&nbsp;</div></li><li><div>  $wpdb-&gt;query(&quot;ALTER TABLE `$table` ADD INDEX ( `$index` )&quot;);&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds column to a database table if it doesn't already exist.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $table_name  The table name to modify.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $column_name The column name to add to the table.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $create_ddl  The SQL statement used to add the column.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if already exists or on successful completion, false on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_add_column($table_name, $column_name, $create_ddl) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;, 0) as $column ) {&nbsp;</div></li><li><div>      if ($column == $column_name) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Didn't find it try to create it.</span>&nbsp;</div></li><li><div>  $wpdb-&gt;query($create_ddl);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// We cannot directly tell that whether this succeeded!</span></span>&nbsp;</div></li><li><div>  foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;, 0) as $column ) {&nbsp;</div></li><li><div>      if ($column == $column_name) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * If a table only contains utf8 or utf8mb4 columns, convert it to utf8mb4.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $table The table to convert.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool true if the table was converted, false if it wasn't.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_convert_table_to_utf8mb4( $table ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $results = $wpdb-&gt;get_results( &quot;SHOW FULL COLUMNS FROM `$table`&quot; );&nbsp;</div></li><li><div>  if ( ! $results ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $results as $column ) {&nbsp;</div></li><li><div>      if ( $column-&gt;Collation ) {&nbsp;</div></li><li><div>          list( $charset ) = explode( '_', $column-&gt;Collation );&nbsp;</div></li><li><div>          $charset = strtolower( $charset );&nbsp;</div></li><li><div>          if ( 'utf8' !== $charset && 'utf8mb4' !== $charset ) {&nbsp;</div></li><li><div>              <span class="comment">// Don't upgrade tables that have non-utf8 columns.</span>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $table_details = $wpdb-&gt;get_row( &quot;SHOW TABLE STATUS LIKE '$table'&quot; );&nbsp;</div></li><li><div>  if ( ! $table_details ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  list( $table_charset ) = explode( '_', $table_details-&gt;Collation );&nbsp;</div></li><li><div>  $table_charset = strtolower( $table_charset );&nbsp;</div></li><li><div>  if ( 'utf8mb4' === $table_charset ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $wpdb-&gt;query( &quot;ALTER TABLE $table CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve all options as it was for 1.2.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return stdClass List of options.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_alloptions_110() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $all_options = new stdClass;&nbsp;</div></li><li><div>  if ( $options = $wpdb-&gt;get_results( &quot;SELECT option_name, option_value FROM $wpdb-&gt;options&quot; ) ) {&nbsp;</div></li><li><div>      foreach ( $options as $option ) {&nbsp;</div></li><li><div>          if ( 'siteurl' == $option-&gt;option_name || 'home' == $option-&gt;option_name || 'category_base' == $option-&gt;option_name )&nbsp;</div></li><li><div>              $option-&gt;option_value = untrailingslashit( $option-&gt;option_value );&nbsp;</div></li><li><div>          $all_options-&gt;{$option-&gt;option_name} = stripslashes( $option-&gt;option_value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $all_options;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Utility version of get_option that is private to install/upgrade.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @ignore</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.1</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $setting Option name.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function __get_option($setting) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $setting == 'home' && defined( 'WP_HOME' ) )&nbsp;</div></li><li><div>      return untrailingslashit( WP_HOME );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $setting == 'siteurl' && defined( 'WP_SITEURL' ) )&nbsp;</div></li><li><div>      return untrailingslashit( WP_SITEURL );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $option = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT option_value FROM $wpdb-&gt;options WHERE option_name = %s&quot;, $setting ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'home' == $setting && '' == $option )&nbsp;</div></li><li><div>      return __get_option( 'siteurl' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'siteurl' == $setting || 'home' == $setting || 'category_base' == $setting || 'tag_base' == $setting )&nbsp;</div></li><li><div>      $option = untrailingslashit( $option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return maybe_unserialize( $option );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters for content to remove unnecessary slashes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content The content to modify.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The de-slashed content.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function deslash($content) {&nbsp;</div></li><li><div>  <span class="comment">// Note: \\\ inside a regex denotes a single backslash.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Replace one or more backslashes followed by a single quote with</span>&nbsp;</div></li><li><div><span class="comment">   * a single quote.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $content = preg_replace(&quot;/\\\+'/&quot;, &quot;'&quot;, $content);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Replace one or more backslashes followed by a double quote with</span>&nbsp;</div></li><li><div><span class="comment">   * a double quote.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $content = preg_replace('/\\\+&quot;/', '&quot;', $content);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Replace one or more backslashes with one backslash.</span>&nbsp;</div></li><li><div>  $content = preg_replace(&quot;/\\\+/&quot;, &quot;\\&quot;, $content);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $content;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Modifies the database based on specified SQL statements.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Useful for creating new tables and updating existing tables to a new structure.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $queries Optional. The query to run. Can be multiple queries</span>&nbsp;</div></li><li><div><span class="comment"> *                              in an array, or a string of queries separated by</span>&nbsp;</div></li><li><div><span class="comment"> *                              semicolons. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool         $execute Optional. Whether or not to execute the query right away.</span>&nbsp;</div></li><li><div><span class="comment"> *                              Default true.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Strings containing the results of the various update queries.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function dbDelta( $queries = '', $execute = true ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( in_array( $queries, array( '', 'all', 'blog', 'global', 'ms_global' ), true ) )&nbsp;</div></li><li><div>      $queries = wp_get_db_schema( $queries );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Separate individual queries into an array</span>&nbsp;</div></li><li><div>  if ( !is_array($queries) ) {&nbsp;</div></li><li><div>      $queries = explode( ';', $queries );&nbsp;</div></li><li><div>      $queries = array_filter( $queries );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the dbDelta SQL queries.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $queries An array of dbDelta SQL queries.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $queries = apply_filters( 'dbdelta_queries', $queries );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cqueries = array(); <span class="comment">// Creation Queries</span>&nbsp;</div></li><li><div>  $iqueries = array(); <span class="comment">// Insertion Queries</span>&nbsp;</div></li><li><div>  $for_update = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create a tablename index for an array ($cqueries) of queries</span>&nbsp;</div></li><li><div>  foreach ($queries as $qry) {&nbsp;</div></li><li><div>      if ( preg_match( &quot;|CREATE TABLE ([^ ]*)|&quot;, $qry, $matches ) ) {&nbsp;</div></li><li><div>          $cqueries[ trim( $matches[1], '`' ) ] = $qry;&nbsp;</div></li><li><div>          $for_update[$matches[1]] = 'Created table '.$matches[1];&nbsp;</div></li><li><div>      } elseif ( preg_match( &quot;|CREATE DATABASE ([^ ]*)|&quot;, $qry, $matches ) ) {&nbsp;</div></li><li><div>          array_unshift( $cqueries, $qry );&nbsp;</div></li><li><div>      } elseif ( preg_match( &quot;|INSERT INTO ([^ ]*)|&quot;, $qry, $matches ) ) {&nbsp;</div></li><li><div>          $iqueries[] = $qry;&nbsp;</div></li><li><div>      } elseif ( preg_match( &quot;|UPDATE ([^ ]*)|&quot;, $qry, $matches ) ) {&nbsp;</div></li><li><div>          $iqueries[] = $qry;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Unrecognized query type</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the dbDelta SQL queries for creating tables and/or databases.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Queries filterable via this hook contain &quot;CREATE TABLE&quot; or &quot;CREATE DATABASE&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $cqueries An array of dbDelta create SQL queries.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $cqueries = apply_filters( 'dbdelta_create_queries', $cqueries );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the dbDelta SQL queries for inserting or updating.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Queries filterable via this hook contain &quot;INSERT INTO&quot; or &quot;UPDATE&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $iqueries An array of dbDelta insert or update SQL queries.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $iqueries = apply_filters( 'dbdelta_insert_queries', $iqueries );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $text_fields = array( 'tinytext', 'text', 'mediumtext', 'longtext' );&nbsp;</div></li><li><div>  $blob_fields = array( 'tinyblob', 'blob', 'mediumblob', 'longblob' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $global_tables = $wpdb-&gt;tables( 'global' );&nbsp;</div></li><li><div>  foreach ( $cqueries as $table =&gt; $qry ) {&nbsp;</div></li><li><div>      <span class="comment">// Upgrade global tables only for the main site. Don't upgrade at all if conditions are not optimal.</span>&nbsp;</div></li><li><div>      if ( in_array( $table, $global_tables ) && ! wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>          unset( $cqueries[ $table ], $for_update[ $table ] );&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fetch the table column structure from the database</span>&nbsp;</div></li><li><div>      $suppress = $wpdb-&gt;suppress_errors();&nbsp;</div></li><li><div>      $tablefields = $wpdb-&gt;get_results(&quot;DESCRIBE {$table};&quot;);&nbsp;</div></li><li><div>      $wpdb-&gt;suppress_errors( $suppress );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $tablefields )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Clear the field and index arrays.</span>&nbsp;</div></li><li><div>      $cfields = $indices = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get all of the field names in the query from between the parentheses.</span>&nbsp;</div></li><li><div>      preg_match(&quot;|\((.*)\)|ms&quot;, $qry, $match2);&nbsp;</div></li><li><div>      $qryline = trim($match2[1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Separate field lines into an array.</span>&nbsp;</div></li><li><div>      $flds = explode(&quot;\n&quot;, $qryline);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For every field line specified in the query.</span>&nbsp;</div></li><li><div>      foreach ( $flds as $fld ) {&nbsp;</div></li><li><div>          $fld = trim( $fld, &quot; \t\n\r\0\x0B, &quot; ); <span class="comment">// Default trim characters, plus ', '.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Extract the field name.</span>&nbsp;</div></li><li><div>          preg_match( '|^([^ ]*)|', $fld, $fvals );&nbsp;</div></li><li><div>          $fieldname = trim( $fvals[1], '`' );&nbsp;</div></li><li><div>          $fieldname_lowercased = strtolower( $fieldname );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Verify the found field name.</span>&nbsp;</div></li><li><div>          $validfield = true;&nbsp;</div></li><li><div>          switch ( $fieldname_lowercased ) {&nbsp;</div></li><li><div>              case '':&nbsp;</div></li><li><div>              case 'primary':&nbsp;</div></li><li><div>              case 'index':&nbsp;</div></li><li><div>              case 'fulltext':&nbsp;</div></li><li><div>              case 'unique':&nbsp;</div></li><li><div>              case 'key':&nbsp;</div></li><li><div>              case 'spatial':&nbsp;</div></li><li><div>                  $validfield = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                   * Normalize the index definition.</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * This is done so the definition can be compared against the result of a</span>&nbsp;</div></li><li><div><span class="comment">                   * `SHOW INDEX FROM $table_name` query which returns the current table</span>&nbsp;</div></li><li><div><span class="comment">                   * index information.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Extract type, name and columns from the definition.</span>&nbsp;</div></li><li><div>                  preg_match(&nbsp;</div></li><li><div>                        '/^'&nbsp;</div></li><li><div>                      .   '(?P&lt;index_type&gt;'             <span class="comment">// 1) Type of the index.</span>&nbsp;</div></li><li><div>                      .       'PRIMARY\s+KEY|(?:UNIQUE|FULLTEXT|SPATIAL)\s+(?:KEY|INDEX)|KEY|INDEX'&nbsp;</div></li><li><div>                      .   ')'&nbsp;</div></li><li><div>                      .   '\s+'                         <span class="comment"><span class="comment">// Followed by at least one white space character.</span></span>&nbsp;</div></li><li><div>                      .   '(?:'                         <span class="comment">// Name of the index. Optional if type is PRIMARY KEY.</span>&nbsp;</div></li><li><div>                      .       '`?'                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Name can be escaped with a backtick.</span></span></span></span>&nbsp;</div></li><li><div>                      .           '(?P&lt;index_name&gt;'     <span class="comment">// 2) Name of the index.</span>&nbsp;</div></li><li><div>                      .               '(?:[0-9a-zA-Z$_-]|[\xC2-\xDF][\x80-\xBF])+'&nbsp;</div></li><li><div>                      .           ')'&nbsp;</div></li><li><div>                      .       '`?'                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Name can be escaped with a backtick.</span></span></span></span>&nbsp;</div></li><li><div>                      .       '\s+'                     <span class="comment"><span class="comment">// Followed by at least one white space character.</span></span>&nbsp;</div></li><li><div>                      .   ')*'&nbsp;</div></li><li><div>                      .   '\('                          <span class="comment">// Opening bracket for the columns.</span>&nbsp;</div></li><li><div>                      .       '(?P&lt;index_columns&gt;'&nbsp;</div></li><li><div>                      .           '.+?'                 <span class="comment">// 3) Column names, index prefixes, and orders.</span>&nbsp;</div></li><li><div>                      .       ')'&nbsp;</div></li><li><div>                      .   '\)'                          <span class="comment">// Closing bracket for the columns.</span>&nbsp;</div></li><li><div>                      . '$/im', &nbsp;</div></li><li><div>                      $fld, &nbsp;</div></li><li><div>                      $index_matches&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Uppercase the index type and normalize space characters.</span>&nbsp;</div></li><li><div>                  $index_type = strtoupper( preg_replace( '/\s+/', ' ', trim( $index_matches['index_type'] ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// 'INDEX' is a synonym for 'KEY', standardize on 'KEY'.</span>&nbsp;</div></li><li><div>                  $index_type = str_replace( 'INDEX', 'KEY', $index_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Escape the index name with backticks. An index for a primary key has no name.</span>&nbsp;</div></li><li><div>                  $index_name = ( 'PRIMARY KEY' === $index_type ) ? '' : '`' . strtolower( $index_matches['index_name'] ) . '`';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Parse the columns. Multiple columns are separated by a comma.</span>&nbsp;</div></li><li><div>                  $index_columns = array_map( 'trim', explode( ', ', $index_matches['index_columns'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Normalize columns.</span>&nbsp;</div></li><li><div>                  foreach ( $index_columns as &$index_column ) {&nbsp;</div></li><li><div>                      <span class="comment">// Extract column name and number of indexed characters (sub_part).</span>&nbsp;</div></li><li><div>                      preg_match(&nbsp;</div></li><li><div>                            '/'&nbsp;</div></li><li><div>                          .   '`?'                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Name can be escaped with a backtick.</span></span></span></span>&nbsp;</div></li><li><div>                          .       '(?P&lt;column_name&gt;'    <span class="comment">// 1) Name of the column.</span>&nbsp;</div></li><li><div>                          .           '(?:[0-9a-zA-Z$_-]|[\xC2-\xDF][\x80-\xBF])+'&nbsp;</div></li><li><div>                          .       ')'&nbsp;</div></li><li><div>                          .   '`?'                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Name can be escaped with a backtick.</span></span></span></span>&nbsp;</div></li><li><div>                          .   '(?:'                     <span class="comment">// Optional sub part.</span>&nbsp;</div></li><li><div>                          .       '\s*'                 <span class="comment">// Optional white space character between name and opening bracket.</span>&nbsp;</div></li><li><div>                          .       '\('                  <span class="comment">// Opening bracket for the sub part.</span>&nbsp;</div></li><li><div>                          .           '\s*'             <span class="comment">// Optional white space character after opening bracket.</span>&nbsp;</div></li><li><div>                          .           '(?P&lt;sub_part&gt;'&nbsp;</div></li><li><div>                          .               '\d+'         <span class="comment">// 2) Number of indexed characters.</span>&nbsp;</div></li><li><div>                          .           ')'&nbsp;</div></li><li><div>                          .           '\s*'             <span class="comment">// Optional white space character before closing bracket.</span>&nbsp;</div></li><li><div>                          .        '\)'                 <span class="comment">// Closing bracket for the sub part.</span>&nbsp;</div></li><li><div>                          .   ')?'&nbsp;</div></li><li><div>                          . '/', &nbsp;</div></li><li><div>                          $index_column, &nbsp;</div></li><li><div>                          $index_column_matches&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Escape the column name with backticks.</span>&nbsp;</div></li><li><div>                      $index_column = '`' . $index_column_matches['column_name'] . '`';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Append the optional sup part with the number of indexed characters.</span>&nbsp;</div></li><li><div>                      if ( isset( $index_column_matches['sub_part'] ) ) {&nbsp;</div></li><li><div>                          $index_column .= '(' . $index_column_matches['sub_part'] . ')';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Build the normalized index definition and add it to the list of indices.</span>&nbsp;</div></li><li><div>                  $indices[] = &quot;{$index_type} {$index_name} (&quot; . implode( ', ', $index_columns ) . &quot;)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Destroy no longer needed variables.</span>&nbsp;</div></li><li><div>                  unset( $index_column, $index_column_matches, $index_matches, $index_type, $index_name, $index_columns );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If it's a valid field, add it to the field array.</span>&nbsp;</div></li><li><div>          if ( $validfield ) {&nbsp;</div></li><li><div>              $cfields[ $fieldname_lowercased ] = $fld;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For every field in the table.</span>&nbsp;</div></li><li><div>      foreach ( $tablefields as $tablefield ) {&nbsp;</div></li><li><div>          $tablefield_field_lowercased = strtolower( $tablefield-&gt;Field );&nbsp;</div></li><li><div>          $tablefield_type_lowercased = strtolower( $tablefield-&gt;Type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If the table field exists in the field array ...</span>&nbsp;</div></li><li><div>          if ( array_key_exists( $tablefield_field_lowercased, $cfields ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get the field type from the query.</span>&nbsp;</div></li><li><div>              preg_match( '|`?' . $tablefield-&gt;Field . '`? ([^ ]*( unsigned)?)|i', $cfields[ $tablefield_field_lowercased ], $matches );&nbsp;</div></li><li><div>              $fieldtype = $matches[1];&nbsp;</div></li><li><div>              $fieldtype_lowercased = strtolower( $fieldtype );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Is actual field type different from the field type in query?</span>&nbsp;</div></li><li><div>              if ($tablefield-&gt;Type != $fieldtype) {&nbsp;</div></li><li><div>                  $do_change = true;&nbsp;</div></li><li><div>                  if ( in_array( $fieldtype_lowercased, $text_fields ) && in_array( $tablefield_type_lowercased, $text_fields ) ) {&nbsp;</div></li><li><div>                      if ( array_search( $fieldtype_lowercased, $text_fields ) &lt; array_search( $tablefield_type_lowercased, $text_fields ) ) {&nbsp;</div></li><li><div>                          $do_change = false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( in_array( $fieldtype_lowercased, $blob_fields ) && in_array( $tablefield_type_lowercased, $blob_fields ) ) {&nbsp;</div></li><li><div>                      if ( array_search( $fieldtype_lowercased, $blob_fields ) &lt; array_search( $tablefield_type_lowercased, $blob_fields ) ) {&nbsp;</div></li><li><div>                          $do_change = false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $do_change ) {&nbsp;</div></li><li><div>                      <span class="comment">// Add a query to change the column type.</span>&nbsp;</div></li><li><div>                      $cqueries[] = &quot;ALTER TABLE {$table} CHANGE COLUMN `{$tablefield-&gt;Field}` &quot; . $cfields[ $tablefield_field_lowercased ];&nbsp;</div></li><li><div>                      $for_update[$table.'.'.$tablefield-&gt;Field] = &quot;Changed type of {$table}.{$tablefield-&gt;Field} from {$tablefield-&gt;Type} to {$fieldtype}&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get the default value from the array.</span>&nbsp;</div></li><li><div>              if ( preg_match( &quot;| DEFAULT '(.*?)'|i&quot;, $cfields[ $tablefield_field_lowercased ], $matches ) ) {&nbsp;</div></li><li><div>                  $default_value = $matches[1];&nbsp;</div></li><li><div>                  if ($tablefield-&gt;Default != $default_value) {&nbsp;</div></li><li><div>                      <span class="comment">// Add a query to change the column's default value</span>&nbsp;</div></li><li><div>                      $cqueries[] = &quot;ALTER TABLE {$table} ALTER COLUMN `{$tablefield-&gt;Field}` SET DEFAULT '{$default_value}'&quot;;&nbsp;</div></li><li><div>                      $for_update[$table.'.'.$tablefield-&gt;Field] = &quot;Changed default value of {$table}.{$tablefield-&gt;Field} from {$tablefield-&gt;Default} to {$default_value}&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Remove the field from the array (so it's not added).</span>&nbsp;</div></li><li><div>              unset( $cfields[ $tablefield_field_lowercased ] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// This field exists in the table, but not in the creation queries?</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For every remaining field specified for the table.</span>&nbsp;</div></li><li><div>      foreach ($cfields as $fieldname =&gt; $fielddef) {&nbsp;</div></li><li><div>          <span class="comment">// Push a query line into $cqueries that adds the field to that table.</span>&nbsp;</div></li><li><div>          $cqueries[] = &quot;ALTER TABLE {$table} ADD COLUMN $fielddef&quot;;&nbsp;</div></li><li><div>          $for_update[$table.'.'.$fieldname] = 'Added column '.$table.'.'.$fieldname;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Index stuff goes here. Fetch the table index structure from the database.</span>&nbsp;</div></li><li><div>      $tableindices = $wpdb-&gt;get_results(&quot;SHOW INDEX FROM {$table};&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($tableindices) {&nbsp;</div></li><li><div>          <span class="comment">// Clear the index array.</span>&nbsp;</div></li><li><div>          $index_ary = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// For every index in the table.</span>&nbsp;</div></li><li><div>          foreach ($tableindices as $tableindex) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Add the index to the index data array.</span>&nbsp;</div></li><li><div>              $keyname = strtolower( $tableindex-&gt;Key_name );&nbsp;</div></li><li><div>              $index_ary[$keyname]['columns'][] = array('fieldname' =&gt; $tableindex-&gt;Column_name, 'subpart' =&gt; $tableindex-&gt;Sub_part);&nbsp;</div></li><li><div>              $index_ary[$keyname]['unique'] = ($tableindex-&gt;Non_unique == 0)?true:false;&nbsp;</div></li><li><div>              $index_ary[$keyname]['index_type'] = $tableindex-&gt;Index_type;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// For each actual index in the index array.</span>&nbsp;</div></li><li><div>          foreach ($index_ary as $index_name =&gt; $index_data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Build a create string to compare to the query.</span>&nbsp;</div></li><li><div>              $index_string = '';&nbsp;</div></li><li><div>              if ($index_name == 'primary') {&nbsp;</div></li><li><div>                  $index_string .= 'PRIMARY ';&nbsp;</div></li><li><div>              } elseif ( $index_data['unique'] ) {&nbsp;</div></li><li><div>                  $index_string .= 'UNIQUE ';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( 'FULLTEXT' === strtoupper( $index_data['index_type'] ) ) {&nbsp;</div></li><li><div>                  $index_string .= 'FULLTEXT ';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( 'SPATIAL' === strtoupper( $index_data['index_type'] ) ) {&nbsp;</div></li><li><div>                  $index_string .= 'SPATIAL ';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $index_string .= 'KEY ';&nbsp;</div></li><li><div>              if ( 'primary' !== $index_name ) {&nbsp;</div></li><li><div>                  $index_string .= '`' . $index_name . '`';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $index_columns = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// For each column in the index.</span>&nbsp;</div></li><li><div>              foreach ($index_data['columns'] as $column_data) {&nbsp;</div></li><li><div>                  if ( $index_columns != '' ) {&nbsp;</div></li><li><div>                      $index_columns .= ', ';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Add the field to the column list string.</span>&nbsp;</div></li><li><div>                  $index_columns .= '`' . $column_data['fieldname'] . '`';&nbsp;</div></li><li><div>                  if ($column_data['subpart'] != '') {&nbsp;</div></li><li><div>                      $index_columns .= '('.$column_data['subpart'].')';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// The alternative index string doesn't care about subparts</span>&nbsp;</div></li><li><div>              $alt_index_columns = preg_replace( '/\([^)]*\)/', '', $index_columns );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Add the column list to the index create string.</span>&nbsp;</div></li><li><div>              $index_strings = array(&nbsp;</div></li><li><div>                  &quot;$index_string ($index_columns)&quot;, &nbsp;</div></li><li><div>                  &quot;$index_string ($alt_index_columns)&quot;, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $index_strings as $index_string ) {&nbsp;</div></li><li><div>                  if ( ! ( ( $aindex = array_search( $index_string, $indices ) ) === false ) ) {&nbsp;</div></li><li><div>                      unset( $indices[ $aindex ] );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// For every remaining index specified for the table.</span>&nbsp;</div></li><li><div>      foreach ( (array) $indices as $index ) {&nbsp;</div></li><li><div>          <span class="comment">// Push a query line into $cqueries that adds the index to that table.</span>&nbsp;</div></li><li><div>          $cqueries[] = &quot;ALTER TABLE {$table} ADD $index&quot;;&nbsp;</div></li><li><div>          $for_update[] = 'Added index ' . $table . ' ' . $index;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove the original table creation query from processing.</span>&nbsp;</div></li><li><div>      unset( $cqueries[ $table ], $for_update[ $table ] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $allqueries = array_merge($cqueries, $iqueries);&nbsp;</div></li><li><div>  if ($execute) {&nbsp;</div></li><li><div>      foreach ($allqueries as $query) {&nbsp;</div></li><li><div>          $wpdb-&gt;query($query);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $for_update;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Updates the database tables to a new schema.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * By default, updates all the tables to use the latest defined schema, but can also</span>&nbsp;</div></li><li><div><span class="comment"> * be used to update a specific set of tables in wp_get_db_schema().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses dbDelta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $tables Optional. Which set of tables to update. Default is 'all'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function make_db_current( $tables = 'all' ) {&nbsp;</div></li><li><div>  $alterations = dbDelta( $tables );&nbsp;</div></li><li><div>  echo &quot;&lt;ol&gt;\n&quot;;&nbsp;</div></li><li><div>  foreach ($alterations as $alteration) echo &quot;&lt;li&gt;$alteration&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>  echo &quot;&lt;/ol&gt;\n&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Updates the database tables to a new schema, but without displaying results.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * By default, updates all the tables to use the latest defined schema, but can</span>&nbsp;</div></li><li><div><span class="comment"> * also be used to update a specific set of tables in wp_get_db_schema().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see make_db_current()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $tables Optional. Which set of tables to update. Default is 'all'.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function make_db_current_silent( $tables = 'all' ) {&nbsp;</div></li><li><div>  dbDelta( $tables );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a site theme from an existing theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * {@internal Missing Long Description}}</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $theme_name The name of the theme.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $template   The directory name of the theme.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function make_site_theme_from_oldschool($theme_name, $template) {&nbsp;</div></li><li><div>  $home_path = get_home_path();&nbsp;</div></li><li><div>  $site_dir = WP_CONTENT_DIR . &quot;/themes/$template&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (! file_exists(&quot;$home_path/index.php&quot;))&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Copy files from the old locations to the site theme.</span>&nbsp;</div></li><li><div><span class="comment">   * TODO: This does not copy arbitrary include dependencies. Only the standard WP files are copied.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $files = array('index.php' =&gt; 'index.php', 'wp-layout.css' =&gt; 'style.css', 'wp-comments.php' =&gt; 'comments.php', 'wp-comments-popup.php' =&gt; 'comments-popup.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ($files as $oldfile =&gt; $newfile) {&nbsp;</div></li><li><div>      if ($oldfile == 'index.php')&nbsp;</div></li><li><div>          $oldpath = $home_path;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $oldpath = ABSPATH;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check to make sure it's not a new index.</span>&nbsp;</div></li><li><div>      if ($oldfile == 'index.php') {&nbsp;</div></li><li><div>          $index = implode('', file(&quot;$oldpath/$oldfile&quot;));&nbsp;</div></li><li><div>          if (strpos($index, 'WP_USE_THEMES') !== false) {&nbsp;</div></li><li><div>              if (! @copy(WP_CONTENT_DIR . '/themes/' . WP_DEFAULT_THEME . '/index.php', &quot;$site_dir/$newfile&quot;))&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Don't copy anything.</span>&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (! @copy(&quot;$oldpath/$oldfile&quot;, &quot;$site_dir/$newfile&quot;))&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      chmod(&quot;$site_dir/$newfile&quot;, 0777);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update the blog header include in each file.</span>&nbsp;</div></li><li><div>      $lines = explode(&quot;\n&quot;, implode('', file(&quot;$site_dir/$newfile&quot;)));&nbsp;</div></li><li><div>      if ($lines) {&nbsp;</div></li><li><div>          $f = fopen(&quot;$site_dir/$newfile&quot;, 'w');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($lines as $line) {&nbsp;</div></li><li><div>              if (preg_match('/require.*wp-blog-header/', $line))&nbsp;</div></li><li><div>                  $line = '<span class="comment">//' . $line;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update stylesheet references.</span>&nbsp;</div></li><li><div>              $line = str_replace(&quot;&lt;?php echo __get_option('siteurl'); ?&gt;/wp-layout.css&quot;, &quot;&lt;?php bloginfo('stylesheet_url'); ?&gt;&quot;, $line);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update comments template inclusion.</span>&nbsp;</div></li><li><div>              $line = str_replace(&quot;&lt;?php include(ABSPATH . 'wp-comments.php'); ?&gt;&quot;, &quot;&lt;?php comments_template(); ?&gt;&quot;, $line);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              fwrite($f, &quot;{$line}\n&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          fclose($f);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add a theme header.</span>&nbsp;</div></li><li><div>  $header = &quot;<span class="comment">/*\nTheme Name: $theme_name\nTheme URI: &quot; . __get_option('siteurl') . &quot;\nDescription: A theme automatically created by the update.\nVersion: 1.0\nAuthor: Moi\n*/</span>\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stylelines = file_get_contents(&quot;$site_dir/style.css&quot;);&nbsp;</div></li><li><div>  if ($stylelines) {&nbsp;</div></li><li><div>      $f = fopen(&quot;$site_dir/style.css&quot;, 'w');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      fwrite($f, $header);&nbsp;</div></li><li><div>      fwrite($f, $stylelines);&nbsp;</div></li><li><div>      fclose($f);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a site theme from the default theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * {@internal Missing Long Description}}</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $theme_name The name of the theme.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $template   The directory name of the theme.</span>&nbsp;</div></li><li><div><span class="comment"> * @return false|void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function make_site_theme_from_default($theme_name, $template) {&nbsp;</div></li><li><div>  $site_dir = WP_CONTENT_DIR . &quot;/themes/$template&quot;;&nbsp;</div></li><li><div>  $default_dir = WP_CONTENT_DIR . '/themes/' . WP_DEFAULT_THEME;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy files from the default theme to the site theme.</span>&nbsp;</div></li><li><div>  <span class="comment">//$files = array('index.php', 'comments.php', 'comments-popup.php', 'footer.php', 'header.php', 'sidebar.php', 'style.css');</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $theme_dir = @ opendir($default_dir);&nbsp;</div></li><li><div>  if ($theme_dir) {&nbsp;</div></li><li><div>      while(($theme_file = readdir( $theme_dir )) !== false) {&nbsp;</div></li><li><div>          if (is_dir(&quot;$default_dir/$theme_file&quot;))&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if (! @copy(&quot;$default_dir/$theme_file&quot;, &quot;$site_dir/$theme_file&quot;))&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          chmod(&quot;$site_dir/$theme_file&quot;, 0777);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  @closedir($theme_dir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Rewrite the theme header.</span>&nbsp;</div></li><li><div>  $stylelines = explode(&quot;\n&quot;, implode('', file(&quot;$site_dir/style.css&quot;)));&nbsp;</div></li><li><div>  if ($stylelines) {&nbsp;</div></li><li><div>      $f = fopen(&quot;$site_dir/style.css&quot;, 'w');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($stylelines as $line) {&nbsp;</div></li><li><div>          if (strpos($line, 'Theme Name:') !== false) $line = 'Theme Name: ' . $theme_name;&nbsp;</div></li><li><div>          elseif (strpos($line, 'Theme URI:') !== false) $line = 'Theme URI: ' . __get_option('url');&nbsp;</div></li><li><div>          elseif (strpos($line, 'Description:') !== false) $line = 'Description: Your theme.';&nbsp;</div></li><li><div>          elseif (strpos($line, 'Version:') !== false) $line = 'Version: 1';&nbsp;</div></li><li><div>          elseif (strpos($line, 'Author:') !== false) $line = 'Author: You';&nbsp;</div></li><li><div>          fwrite($f, $line . &quot;\n&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      fclose($f);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Copy the images.</span>&nbsp;</div></li><li><div>  umask(0);&nbsp;</div></li><li><div>  if (! mkdir(&quot;$site_dir/images&quot;, 0777)) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $images_dir = @ opendir(&quot;$default_dir/images&quot;);&nbsp;</div></li><li><div>  if ($images_dir) {&nbsp;</div></li><li><div>      while(($image = readdir($images_dir)) !== false) {&nbsp;</div></li><li><div>          if (is_dir(&quot;$default_dir/images/$image&quot;))&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if (! @copy(&quot;$default_dir/images/$image&quot;, &quot;$site_dir/images/$image&quot;))&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          chmod(&quot;$site_dir/images/$image&quot;, 0777);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  @closedir($images_dir);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a site theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * {@internal Missing Long Description}}</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return false|string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function make_site_theme() {&nbsp;</div></li><li><div>  <span class="comment">// Name the theme after the blog.</span>&nbsp;</div></li><li><div>  $theme_name = __get_option('blogname');&nbsp;</div></li><li><div>  $template = sanitize_title($theme_name);&nbsp;</div></li><li><div>  $site_dir = WP_CONTENT_DIR . &quot;/themes/$template&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the theme already exists, nothing to do.</span>&nbsp;</div></li><li><div>  if ( is_dir($site_dir)) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We must be able to write to the themes dir.</span>&nbsp;</div></li><li><div>  if (! is_writable(WP_CONTENT_DIR . &quot;/themes&quot;)) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  umask(0);&nbsp;</div></li><li><div>  if (! mkdir($site_dir, 0777)) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (file_exists(ABSPATH . 'wp-layout.css')) {&nbsp;</div></li><li><div>      if (! make_site_theme_from_oldschool($theme_name, $template)) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// TODO: rm -rf the site theme directory.</span></span>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if (! make_site_theme_from_default($theme_name, $template))&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// TODO: rm -rf the site theme directory.</span></span>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make the new site theme active.</span>&nbsp;</div></li><li><div>  $current_template = __get_option('template');&nbsp;</div></li><li><div>  if ($current_template == WP_DEFAULT_THEME) {&nbsp;</div></li><li><div>      update_option('template', $template);&nbsp;</div></li><li><div>      update_option('stylesheet', $template);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $template;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Translate user level to user role name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $level User level.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string User role name.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function translate_level_to_role($level) {&nbsp;</div></li><li><div>  switch ($level) {&nbsp;</div></li><li><div>  case 10:&nbsp;</div></li><li><div>  case 9:&nbsp;</div></li><li><div>  case 8:&nbsp;</div></li><li><div>      return 'administrator';&nbsp;</div></li><li><div>  case 7:&nbsp;</div></li><li><div>  case 6:&nbsp;</div></li><li><div>  case 5:&nbsp;</div></li><li><div>      return 'editor';&nbsp;</div></li><li><div>  case 4:&nbsp;</div></li><li><div>  case 3:&nbsp;</div></li><li><div>  case 2:&nbsp;</div></li><li><div>      return 'author';&nbsp;</div></li><li><div>  case 1:&nbsp;</div></li><li><div>      return 'contributor';&nbsp;</div></li><li><div>  case 0:&nbsp;</div></li><li><div>      return 'subscriber';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks the version of the installed MySQL binary.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb  $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_check_mysql_version() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $result = $wpdb-&gt;check_database_version();&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) )&nbsp;</div></li><li><div>      die( $result-&gt;get_error_message() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Disables the Automattic widgets plugin, which was merged into core.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_disable_automattic_widgets() {&nbsp;</div></li><li><div>  $plugins = __get_option( 'active_plugins' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) $plugins as $plugin ) {&nbsp;</div></li><li><div>      if ( basename( $plugin ) == 'widgets.php' ) {&nbsp;</div></li><li><div>          array_splice( $plugins, array_search( $plugin, $plugins ), 1 );&nbsp;</div></li><li><div>          update_option( 'active_plugins', $plugins );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Disables the Link Manager on upgrade if, at the time of upgrade, no links exist in the DB.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_disable_link_manager() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &gt;= 22006 && get_option( 'link_manager_enabled' ) && ! $wpdb-&gt;get_var( &quot;SELECT link_id FROM $wpdb-&gt;links LIMIT 1&quot; ) )&nbsp;</div></li><li><div>      update_option( 'link_manager_enabled', 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Runs before the schema is upgraded.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int  $wp_current_db_version</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function pre_schema_upgrade() {&nbsp;</div></li><li><div>  global $wp_current_db_version, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Upgrade versions prior to 2.9</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 11557 ) {&nbsp;</div></li><li><div>      <span class="comment">// Delete duplicate options. Keep the option with the highest option_id.</span>&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;DELETE o1 FROM $wpdb-&gt;options AS o1 JOIN $wpdb-&gt;options AS o2 USING (`option_name`) WHERE o2.option_id &gt; o1.option_id&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Drop the old primary key and add the new.</span>&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE $wpdb-&gt;options DROP PRIMARY KEY, ADD PRIMARY KEY(option_id)&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Drop the old option_name index. dbDelta() doesn't do the drop.</span>&nbsp;</div></li><li><div>      $wpdb-&gt;query(&quot;ALTER TABLE $wpdb-&gt;options DROP INDEX option_name&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Multisite schema upgrades.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 25448 && is_multisite() && wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Upgrade versions prior to 3.7</span>&nbsp;</div></li><li><div>      if ( $wp_current_db_version &lt; 25179 ) {&nbsp;</div></li><li><div>          <span class="comment">// New primary key for signups.</span>&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;signups ADD signup_id BIGINT(20) NOT NULL AUTO_INCREMENT PRIMARY KEY FIRST&quot; );&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;signups DROP INDEX domain&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $wp_current_db_version &lt; 25448 ) {&nbsp;</div></li><li><div>          <span class="comment">// Convert archived from enum to tinyint.</span>&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;blogs CHANGE COLUMN archived archived varchar(1) NOT NULL default '0'&quot; );&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;blogs CHANGE COLUMN archived archived tinyint(2) NOT NULL default 0&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Upgrade versions prior to 4.2.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 31351 ) {&nbsp;</div></li><li><div>      if ( ! is_multisite() && wp_should_upgrade_global_tables() ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;usermeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;terms DROP INDEX slug, ADD INDEX slug(slug(191))&quot; );&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;terms DROP INDEX name, ADD INDEX name(name(191))&quot; );&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;commentmeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))&quot; );&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;postmeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))&quot; );&nbsp;</div></li><li><div>      $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;posts DROP INDEX post_name, ADD INDEX post_name(post_name(191))&quot; );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Upgrade versions prior to 4.4.</span>&nbsp;</div></li><li><div>  if ( $wp_current_db_version &lt; 34978 ) {&nbsp;</div></li><li><div>      <span class="comment">// If compatible termmeta table is found, use it, but enforce a proper index and update collation.</span>&nbsp;</div></li><li><div>      if ( $wpdb-&gt;get_var( &quot;SHOW TABLES LIKE '{$wpdb-&gt;termmeta}'&quot; ) && $wpdb-&gt;get_results( &quot;SHOW INDEX FROM {$wpdb-&gt;termmeta} WHERE Column_name = 'meta_key'&quot; ) ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query( &quot;ALTER TABLE $wpdb-&gt;termmeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))&quot; );&nbsp;</div></li><li><div>          maybe_convert_table_to_utf8mb4( $wpdb-&gt;termmeta );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Install global terms.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb   $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $charset_collate</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>if ( !function_exists( 'install_global_terms' ) ) :&nbsp;</div></li><li><div>function install_global_terms() {&nbsp;</div></li><li><div>  global $wpdb, $charset_collate;&nbsp;</div></li><li><div>  $ms_queries = &quot;&nbsp;</div></li><li><div>CREATE TABLE $wpdb-&gt;sitecategories (&nbsp;</div></li><li><div>cat_ID bigint(20) NOT NULL auto_increment, &nbsp;</div></li><li><div>cat_name varchar(55) NOT NULL default '', &nbsp;</div></li><li><div>category_nicename varchar(200) NOT NULL default '', &nbsp;</div></li><li><div>last_updated timestamp NOT NULL, &nbsp;</div></li><li><div>PRIMARY KEY  (cat_ID), &nbsp;</div></li><li><div>KEY category_nicename (category_nicename), &nbsp;</div></li><li><div>KEY last_updated (last_updated)&nbsp;</div></li><li><div>) $charset_collate;&nbsp;</div></li><li><div>&quot;;&nbsp;</div></li><li><div><span class="comment">// now create tables</span>&nbsp;</div></li><li><div>  dbDelta( $ms_queries );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determine if global tables should be upgraded.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function performs a series of checks to ensure the environment allows</span>&nbsp;</div></li><li><div><span class="comment"> * for the safe upgrading of global WordPress database tables. It is necessary</span>&nbsp;</div></li><li><div><span class="comment"> * because global tables will commonly grow to millions of rows on large</span>&nbsp;</div></li><li><div><span class="comment"> * installations, and the ability to control their upgrade routines can be</span>&nbsp;</div></li><li><div><span class="comment"> * critical to the operation of large networks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * In a future iteration, this function may use `wp_is_large_network()` to more-</span>&nbsp;</div></li><li><div><span class="comment"> * intelligently prevent global table upgrades. Until then, we make sure</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress is on the main site of the main network, to avoid running queries</span>&nbsp;</div></li><li><div><span class="comment"> * more than once in multi-site or multi-network environments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Whether to run the upgrade routines on global tables.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_should_upgrade_global_tables() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return false early if explicitly not upgrading</span>&nbsp;</div></li><li><div>  if ( defined( 'DO_NOT_UPGRADE_GLOBAL_TABLES' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Assume global tables should be upgraded</span>&nbsp;</div></li><li><div>  $should_upgrade = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set to false if not on main network (does not matter if not multi-network)</span>&nbsp;</div></li><li><div>  if ( ! is_main_network() ) {&nbsp;</div></li><li><div>      $should_upgrade = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set to false if not on main site of current network (does not matter if not multi-site)</span>&nbsp;</div></li><li><div>  if ( ! is_main_site() ) {&nbsp;</div></li><li><div>      $should_upgrade = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters if upgrade routines should be run on global tables.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $should_upgrade Whether to run the upgrade routines on global tables.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'wp_should_upgrade_global_tables', $should_upgrade );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-admin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>