<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.4" data-type="file" data-id="4628"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-includes-canonical | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=2d97bb801d95fbb74e5606f5b669d5d6' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-includes-canonical/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-canonical%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-canonical%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.4-file-wp-includes-canonical","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-includes-canonical" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.4." href="http://hookr.io/4.7.4/" class="H_VERSION"><span property="name">4.7.4</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-includes-canonical</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6316"><a href="http://hookr.io/4.7.4/all/" title="All">All <span class="count badge">6316</span></a></li><li class="" data-id="new" data-count="6"><a href="http://hookr.io/4.7.4/new/" title="New">New <span class="count badge">6</span></a></li><li class="" data-id="hooks" data-count="2538"><a href="http://hookr.io/4.7.4/hooks/" title="Hooks">Hooks <span class="count badge">2538</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.4/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1674"><a href="http://hookr.io/4.7.4/filters/" title="Filters">Filters <span class="count badge">1674</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.4/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.4/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2853"><a href="http://hookr.io/4.7.4/functions/" title="Functions">Functions <span class="count badge">2853</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-includes/canonical.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Canonical API to handle WordPress Redirecting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Based on &quot;Permalink Redirect&quot; from Scott Yang and &quot;Enforce www. Preference&quot;</span>&nbsp;</div></li><li><div><span class="comment"> * by Mark Jaquith</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirects incoming links to the proper URL based on the site url.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Search engines consider www.somedomain.com and somedomain.com to be two</span>&nbsp;</div></li><li><div><span class="comment"> * different URLs when they both go to the same location. This SEO enhancement</span>&nbsp;</div></li><li><div><span class="comment"> * prevents penalty for duplicate content by redirecting all incoming links to</span>&nbsp;</div></li><li><div><span class="comment"> * one or the other.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Prevents redirection for feeds, trackbacks, searches, and</span>&nbsp;</div></li><li><div><span class="comment"> * admin URLs. Does not redirect on non-pretty-permalink-supporting IIS 7+, </span>&nbsp;</div></li><li><div><span class="comment"> * page/post previews, WP admin, Trackbacks, robots.txt, searches, or on POST</span>&nbsp;</div></li><li><div><span class="comment"> * requests.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Will also attempt to find the correct link when a user enters a URL that does</span>&nbsp;</div></li><li><div><span class="comment"> * not exist based on exact WordPress query. Will instead try to parse the URL</span>&nbsp;</div></li><li><div><span class="comment"> * or query in an attempt to figure the correct page to go to.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Rewrite $wp_rewrite</span>&nbsp;</div></li><li><div><span class="comment"> * @global bool $is_IIS</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Query $wp_query</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $requested_url Optional. The URL that was requested, used to</span>&nbsp;</div></li><li><div><span class="comment"> *        figure if redirect is needed.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $do_redirect Optional. Redirect to the new URL.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|void The string of the URL, if redirect needed.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function redirect_canonical( $requested_url = null, $do_redirect = true ) {&nbsp;</div></li><li><div>  global $wp_rewrite, $is_IIS, $wp_query, $wpdb, $wp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_SERVER['REQUEST_METHOD'] ) && ! in_array( strtoupper( $_SERVER['REQUEST_METHOD'] ), array( 'GET', 'HEAD' ) ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we're not in wp-admin and the post has been published and preview nonce</span>&nbsp;</div></li><li><div>  <span class="comment">// is non-existent or invalid then no need for preview in query</span>&nbsp;</div></li><li><div>  if ( is_preview() && get_query_var( 'p' ) && 'publish' == get_post_status( get_query_var( 'p' ) ) ) {&nbsp;</div></li><li><div>      if ( ! isset( $_GET['preview_id'] )&nbsp;</div></li><li><div>          || ! isset( $_GET['preview_nonce'] )&nbsp;</div></li><li><div>          || ! wp_verify_nonce( $_GET['preview_nonce'], 'post_preview_' . (int) $_GET['preview_id'] ) ) {&nbsp;</div></li><li><div>          $wp_query-&gt;is_preview = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_trackback() || is_search() || is_admin() || is_preview() || is_robots() || ( $is_IIS && !iis7_supports_permalinks() ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $requested_url && isset( $_SERVER['HTTP_HOST'] ) ) {&nbsp;</div></li><li><div>      <span class="comment">// build the URL in the address bar</span>&nbsp;</div></li><li><div>      $requested_url = is_ssl() ? 'https:<span class="comment">//' : 'http://';</span>&nbsp;</div></li><li><div>      $requested_url .= $_SERVER['HTTP_HOST'];&nbsp;</div></li><li><div>      $requested_url .= $_SERVER['REQUEST_URI'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $original = @parse_url($requested_url);&nbsp;</div></li><li><div>  if ( false === $original ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $redirect = $original;&nbsp;</div></li><li><div>  $redirect_url = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Notice fixing</span>&nbsp;</div></li><li><div>  if ( !isset($redirect['path']) )&nbsp;</div></li><li><div>      $redirect['path'] = '';&nbsp;</div></li><li><div>  if ( !isset($redirect['query']) )&nbsp;</div></li><li><div>      $redirect['query'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the original URL ended with non-breaking spaces, they were almost</span>&nbsp;</div></li><li><div>  <span class="comment">// certainly inserted by accident. Let's remove them, so the reader doesn't</span>&nbsp;</div></li><li><div>  <span class="comment">// see a 404 error with no obvious cause.</span>&nbsp;</div></li><li><div>  $redirect['path'] = preg_replace( '|(%C2%A0)+$|i', '', $redirect['path'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// It's not a preview, so remove it from URL</span>&nbsp;</div></li><li><div>  if ( get_query_var( 'preview' ) ) {&nbsp;</div></li><li><div>      $redirect['query'] = remove_query_arg( 'preview', $redirect['query'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_feed() && ( $id = get_query_var( 'p' ) ) ) {&nbsp;</div></li><li><div>      if ( $redirect_url = get_post_comments_feed_link( $id, get_query_var( 'feed' ) ) ) {&nbsp;</div></li><li><div>          $redirect['query'] = _remove_qs_args_if_not_in_url( $redirect['query'], array( 'p', 'page_id', 'attachment_id', 'pagename', 'name', 'post_type', 'feed'), $redirect_url );&nbsp;</div></li><li><div>          $redirect['path'] = parse_url( $redirect_url, PHP_URL_PATH );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_singular() && 1 &gt; $wp_query-&gt;post_count && ($id = get_query_var('p')) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $vars = $wpdb-&gt;get_results( $wpdb-&gt;prepare(&quot;SELECT post_type, post_parent FROM $wpdb-&gt;posts WHERE ID = %d&quot;, $id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($vars[0]) && $vars = $vars[0] ) {&nbsp;</div></li><li><div>          if ( 'revision' == $vars-&gt;post_type && $vars-&gt;post_parent &gt; 0 )&nbsp;</div></li><li><div>              $id = $vars-&gt;post_parent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $redirect_url = get_permalink($id) )&nbsp;</div></li><li><div>              $redirect['query'] = _remove_qs_args_if_not_in_url( $redirect['query'], array( 'p', 'page_id', 'attachment_id', 'pagename', 'name', 'post_type' ), $redirect_url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// These tests give us a WP-generated permalink</span>&nbsp;</div></li><li><div>  if ( is_404() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Redirect ?page_id, ?p=, ?attachment_id= to their respective url's</span>&nbsp;</div></li><li><div>      $id = max( get_query_var('p'), get_query_var('page_id'), get_query_var('attachment_id') );&nbsp;</div></li><li><div>      if ( $id && $redirect_post = get_post($id) ) {&nbsp;</div></li><li><div>          $post_type_obj = get_post_type_object($redirect_post-&gt;post_type);&nbsp;</div></li><li><div>          if ( $post_type_obj-&gt;public && 'auto-draft' != $redirect_post-&gt;post_status ) {&nbsp;</div></li><li><div>              $redirect_url = get_permalink($redirect_post);&nbsp;</div></li><li><div>              $redirect['query'] = _remove_qs_args_if_not_in_url( $redirect['query'], array( 'p', 'page_id', 'attachment_id', 'pagename', 'name', 'post_type' ), $redirect_url );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_query_var( 'day' ) && get_query_var( 'monthnum' ) && get_query_var( 'year' ) ) {&nbsp;</div></li><li><div>          $year = get_query_var( 'year' );&nbsp;</div></li><li><div>          $month = get_query_var( 'monthnum' );&nbsp;</div></li><li><div>          $day = get_query_var( 'day' );&nbsp;</div></li><li><div>          $date = sprintf( '%04d-%02d-%02d', $year, $month, $day );&nbsp;</div></li><li><div>          if ( ! wp_checkdate( $month, $day, $year, $date ) ) {&nbsp;</div></li><li><div>              $redirect_url = get_month_link( $year, $month );&nbsp;</div></li><li><div>              $redirect['query'] = _remove_qs_args_if_not_in_url( $redirect['query'], array( 'year', 'monthnum', 'day' ), $redirect_url );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( get_query_var( 'monthnum' ) && get_query_var( 'year' ) && 12 &lt; get_query_var( 'monthnum' ) ) {&nbsp;</div></li><li><div>          $redirect_url = get_year_link( get_query_var( 'year' ) );&nbsp;</div></li><li><div>          $redirect['query'] = _remove_qs_args_if_not_in_url( $redirect['query'], array( 'year', 'monthnum' ), $redirect_url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $redirect_url ) {&nbsp;</div></li><li><div>          if ( $redirect_url = redirect_guess_404_permalink() ) {&nbsp;</div></li><li><div>              $redirect['query'] = _remove_qs_args_if_not_in_url( $redirect['query'], array( 'page', 'feed', 'p', 'page_id', 'attachment_id', 'pagename', 'name', 'post_type' ), $redirect_url );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_query_var( 'page' ) && $wp_query-&gt;post &&&nbsp;</div></li><li><div>          false !== strpos( $wp_query-&gt;post-&gt;post_content, '&lt;!--nextpage--&gt;' ) ) {&nbsp;</div></li><li><div>          $redirect['path'] = rtrim( $redirect['path'], (int) get_query_var( 'page' ) . '/' );&nbsp;</div></li><li><div>          $redirect['query'] = remove_query_arg( 'page', $redirect['query'] );&nbsp;</div></li><li><div>          $redirect_url = get_permalink( $wp_query-&gt;post-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } elseif ( is_object($wp_rewrite) && $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>      <span class="comment">// rewriting of old ?p=X, ?m=2004, ?m=200401, ?m=20040101</span>&nbsp;</div></li><li><div>      if ( is_attachment() &&&nbsp;</div></li><li><div>          ! array_diff( array_keys( $wp-&gt;query_vars ), array( 'attachment', 'attachment_id' ) ) &&&nbsp;</div></li><li><div>          ! $redirect_url ) {&nbsp;</div></li><li><div>          if ( ! empty( $_GET['attachment_id'] ) ) {&nbsp;</div></li><li><div>              $redirect_url = get_attachment_link( get_query_var( 'attachment_id' ) );&nbsp;</div></li><li><div>              if ( $redirect_url ) {&nbsp;</div></li><li><div>                  $redirect['query'] = remove_query_arg( 'attachment_id', $redirect['query'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $redirect_url = get_attachment_link();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( is_single() && !empty($_GET['p']) && ! $redirect_url ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_permalink(get_query_var('p')) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg(array('p', 'post_type'), $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( is_single() && !empty($_GET['name'])  && ! $redirect_url ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_permalink( $wp_query-&gt;get_queried_object_id() ) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg('name', $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( is_page() && !empty($_GET['page_id']) && ! $redirect_url ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_permalink(get_query_var('page_id')) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg('page_id', $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( is_page() && !is_feed() && 'page' == get_option('show_on_front') && get_queried_object_id() == get_option('page_on_front')  && ! $redirect_url ) {&nbsp;</div></li><li><div>          $redirect_url = home_url('/');&nbsp;</div></li><li><div>      } elseif ( is_home() && !empty($_GET['page_id']) && 'page' == get_option('show_on_front') && get_query_var('page_id') == get_option('page_for_posts')  && ! $redirect_url ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_permalink(get_option('page_for_posts')) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg('page_id', $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( !empty($_GET['m']) && ( is_year() || is_month() || is_day() ) ) {&nbsp;</div></li><li><div>          $m = get_query_var('m');&nbsp;</div></li><li><div>          switch ( strlen($m) ) {&nbsp;</div></li><li><div>              case 4: <span class="comment">// Yearly</span>&nbsp;</div></li><li><div>                  $redirect_url = get_year_link($m);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 6: <span class="comment">// Monthly</span>&nbsp;</div></li><li><div>                  $redirect_url = get_month_link( substr($m, 0, 4), substr($m, 4, 2) );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 8: <span class="comment">// Daily</span>&nbsp;</div></li><li><div>                  $redirect_url = get_day_link(substr($m, 0, 4), substr($m, 4, 2), substr($m, 6, 2));&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $redirect_url )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg('m', $redirect['query']);&nbsp;</div></li><li><div>      <span class="comment">// now moving on to non ?m=X year/month/day links</span>&nbsp;</div></li><li><div>      } elseif ( is_day() && get_query_var('year') && get_query_var('monthnum') && !empty($_GET['day']) ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_day_link(get_query_var('year'), get_query_var('monthnum'), get_query_var('day')) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg(array('year', 'monthnum', 'day'), $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( is_month() && get_query_var('year') && !empty($_GET['monthnum']) ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_month_link(get_query_var('year'), get_query_var('monthnum')) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg(array('year', 'monthnum'), $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( is_year() && !empty($_GET['year']) ) {&nbsp;</div></li><li><div>          if ( $redirect_url = get_year_link(get_query_var('year')) )&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg('year', $redirect['query']);&nbsp;</div></li><li><div>      } elseif ( is_author() && !empty($_GET['author']) && preg_match( '|^[0-9]+$|', $_GET['author'] ) ) {&nbsp;</div></li><li><div>          $author = get_userdata(get_query_var('author'));&nbsp;</div></li><li><div>          if ( ( false !== $author ) && $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT ID FROM $wpdb-&gt;posts WHERE $wpdb-&gt;posts.post_author = %d AND $wpdb-&gt;posts.post_status = 'publish' LIMIT 1&quot;, $author-&gt;ID ) ) ) {&nbsp;</div></li><li><div>              if ( $redirect_url = get_author_posts_url($author-&gt;ID, $author-&gt;user_nicename) )&nbsp;</div></li><li><div>                  $redirect['query'] = remove_query_arg('author', $redirect['query']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( is_category() || is_tag() || is_tax() ) { <span class="comment">// Terms (Tags/categories)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $term_count = 0;&nbsp;</div></li><li><div>          foreach ( $wp_query-&gt;tax_query-&gt;queried_terms as $tax_query )&nbsp;</div></li><li><div>              $term_count += count( $tax_query['terms'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $obj = $wp_query-&gt;get_queried_object();&nbsp;</div></li><li><div>          if ( $term_count &lt;= 1 && !empty($obj-&gt;term_id) && ( $tax_url = get_term_link((int)$obj-&gt;term_id, $obj-&gt;taxonomy) ) && !is_wp_error($tax_url) ) {&nbsp;</div></li><li><div>              if ( !empty($redirect['query']) ) {&nbsp;</div></li><li><div>                  <span class="comment">// Strip taxonomy query vars off the url.</span>&nbsp;</div></li><li><div>                  $qv_remove = array( 'term', 'taxonomy');&nbsp;</div></li><li><div>                  if ( is_category() ) {&nbsp;</div></li><li><div>                      $qv_remove[] = 'category_name';&nbsp;</div></li><li><div>                      $qv_remove[] = 'cat';&nbsp;</div></li><li><div>                  } elseif ( is_tag() ) {&nbsp;</div></li><li><div>                      $qv_remove[] = 'tag';&nbsp;</div></li><li><div>                      $qv_remove[] = 'tag_id';&nbsp;</div></li><li><div>                  } else { <span class="comment">// Custom taxonomies will have a custom query var, remove those too:</span>&nbsp;</div></li><li><div>                      $tax_obj = get_taxonomy( $obj-&gt;taxonomy );&nbsp;</div></li><li><div>                      if ( false !== $tax_obj-&gt;query_var )&nbsp;</div></li><li><div>                          $qv_remove[] = $tax_obj-&gt;query_var;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $rewrite_vars = array_diff( array_keys($wp_query-&gt;query), array_keys($_GET) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( !array_diff($rewrite_vars, array_keys($_GET)) ) { <span class="comment">// Check to see if all the Query vars are coming from the rewrite, none are set via $_GET</span>&nbsp;</div></li><li><div>                      $redirect['query'] = remove_query_arg($qv_remove, $redirect['query']); <span class="comment">//Remove all of the per-tax qv's</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Create the destination url for this taxonomy</span>&nbsp;</div></li><li><div>                      $tax_url = parse_url($tax_url);&nbsp;</div></li><li><div>                      if ( ! empty($tax_url['query']) ) { <span class="comment">// Taxonomy accessible via ?taxonomy=..&term=.. or any custom qv..</span>&nbsp;</div></li><li><div>                          parse_str($tax_url['query'], $query_vars);&nbsp;</div></li><li><div>                          $redirect['query'] = add_query_arg($query_vars, $redirect['query']);&nbsp;</div></li><li><div>                      } else { <span class="comment">// Taxonomy is accessible via a &quot;pretty-URL&quot;</span>&nbsp;</div></li><li><div>                          $redirect['path'] = $tax_url['path'];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else { <span class="comment">// Some query vars are set via $_GET. Unset those from $_GET that exist via the rewrite</span>&nbsp;</div></li><li><div>                      foreach ( $qv_remove as $_qv ) {&nbsp;</div></li><li><div>                          if ( isset($rewrite_vars[$_qv]) )&nbsp;</div></li><li><div>                              $redirect['query'] = remove_query_arg($_qv, $redirect['query']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( is_single() && strpos($wp_rewrite-&gt;permalink_structure, '%category%') !== false && $cat = get_query_var( 'category_name' ) ) {&nbsp;</div></li><li><div>          $category = get_category_by_path( $cat );&nbsp;</div></li><li><div>          if ( ( ! $category || is_wp_error( $category ) ) || ! has_term( $category-&gt;term_id, 'category', $wp_query-&gt;get_queried_object_id() ) ) {&nbsp;</div></li><li><div>              $redirect_url = get_permalink($wp_query-&gt;get_queried_object_id());&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Post Paging</span>&nbsp;</div></li><li><div>      if ( is_singular() && get_query_var('page') ) {&nbsp;</div></li><li><div>          if ( !$redirect_url )&nbsp;</div></li><li><div>              $redirect_url = get_permalink( get_queried_object_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $page = get_query_var( 'page' );&nbsp;</div></li><li><div>          if ( $page &gt; 1 ) {&nbsp;</div></li><li><div>              if ( is_front_page() ) {&nbsp;</div></li><li><div>                  $redirect_url = trailingslashit( $redirect_url ) . user_trailingslashit( &quot;$wp_rewrite-&gt;pagination_base/$page&quot;, 'paged' );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $redirect_url = trailingslashit( $redirect_url ) . user_trailingslashit( $page, 'single_paged' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $redirect['query'] = remove_query_arg( 'page', $redirect['query'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// paging and feeds</span>&nbsp;</div></li><li><div>      if ( get_query_var('paged') || is_feed() || get_query_var('cpage') ) {&nbsp;</div></li><li><div>          while ( preg_match( &quot;#/$wp_rewrite-&gt;pagination_base/?[0-9]+?(/+)?$#&quot;, $redirect['path'] ) || preg_match( '#/(comments/?)?(feed|rss|rdf|atom|rss2)(/+)?$#', $redirect['path'] ) || preg_match( &quot;#/{$wp_rewrite-&gt;comments_pagination_base}-[0-9]+(/+)?$#&quot;, $redirect['path'] ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Strip off paging and feed</span>&nbsp;</div></li><li><div>              $redirect['path'] = preg_replace(&quot;#/$wp_rewrite-&gt;pagination_base/?[0-9]+?(/+)?$#&quot;, '/', $redirect['path']); <span class="comment">// strip off any existing paging</span>&nbsp;</div></li><li><div>              $redirect['path'] = preg_replace('#/(comments/?)?(feed|rss2?|rdf|atom)(/+|$)#', '/', $redirect['path']); <span class="comment">// strip off feed endings</span>&nbsp;</div></li><li><div>              $redirect['path'] = preg_replace(&quot;#/{$wp_rewrite-&gt;comments_pagination_base}-[0-9]+?(/+)?$#&quot;, '/', $redirect['path']); <span class="comment">// strip off any existing comment paging</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $addl_path = '';&nbsp;</div></li><li><div>          if ( is_feed() && in_array( get_query_var('feed'), $wp_rewrite-&gt;feeds ) ) {&nbsp;</div></li><li><div>              $addl_path = !empty( $addl_path ) ? trailingslashit($addl_path) : '';&nbsp;</div></li><li><div>              if ( !is_singular() && get_query_var( 'withcomments' ) )&nbsp;</div></li><li><div>                  $addl_path .= 'comments/';&nbsp;</div></li><li><div>              if ( ( 'rss' == get_default_feed() && 'feed' == get_query_var('feed') ) || 'rss' == get_query_var('feed') )&nbsp;</div></li><li><div>                  $addl_path .= user_trailingslashit( 'feed/' . ( ( get_default_feed() == 'rss2' ) ? '' : 'rss2' ), 'feed' );&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $addl_path .= user_trailingslashit( 'feed/' . ( ( get_default_feed() ==  get_query_var('feed') || 'feed' == get_query_var('feed') ) ? '' : get_query_var('feed') ), 'feed' );&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg( 'feed', $redirect['query'] );&nbsp;</div></li><li><div>          } elseif ( is_feed() && 'old' == get_query_var('feed') ) {&nbsp;</div></li><li><div>              $old_feed_files = array(&nbsp;</div></li><li><div>                  'wp-atom.php' =&gt; 'atom', &nbsp;</div></li><li><div>                  'wp-commentsrss2.php' =&gt; 'comments_rss2', &nbsp;</div></li><li><div>                  'wp-feed.php' =&gt; get_default_feed(), &nbsp;</div></li><li><div>                  'wp-rdf.php' =&gt; 'rdf', &nbsp;</div></li><li><div>                  'wp-rss.php' =&gt; 'rss2', &nbsp;</div></li><li><div>                  'wp-rss2.php' =&gt; 'rss2', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              if ( isset( $old_feed_files[ basename( $redirect['path'] ) ] ) ) {&nbsp;</div></li><li><div>                  $redirect_url = get_feed_link( $old_feed_files[ basename( $redirect['path'] ) ] );&nbsp;</div></li><li><div>                  wp_redirect( $redirect_url, 301 );&nbsp;</div></li><li><div>                  die();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( get_query_var('paged') &gt; 0 ) {&nbsp;</div></li><li><div>              $paged = get_query_var('paged');&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg( 'paged', $redirect['query'] );&nbsp;</div></li><li><div>              if ( !is_feed() ) {&nbsp;</div></li><li><div>                  if ( $paged &gt; 1 && !is_single() ) {&nbsp;</div></li><li><div>                      $addl_path = ( !empty( $addl_path ) ? trailingslashit($addl_path) : '' ) . user_trailingslashit(&quot;$wp_rewrite-&gt;pagination_base/$paged&quot;, 'paged');&nbsp;</div></li><li><div>                  } elseif ( !is_single() ) {&nbsp;</div></li><li><div>                      $addl_path = !empty( $addl_path ) ? trailingslashit($addl_path) : '';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( $paged &gt; 1 ) {&nbsp;</div></li><li><div>                  $redirect['query'] = add_query_arg( 'paged', $paged, $redirect['query'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( get_option( 'page_comments' ) && (&nbsp;</div></li><li><div>              ( 'newest' == get_option( 'default_comments_page' ) && get_query_var( 'cpage' ) &gt; 0 ) ||&nbsp;</div></li><li><div>              ( 'newest' != get_option( 'default_comments_page' ) && get_query_var( 'cpage' ) &gt; 1 )&nbsp;</div></li><li><div> ) ) {&nbsp;</div></li><li><div>              $addl_path = ( !empty( $addl_path ) ? trailingslashit($addl_path) : '' ) . user_trailingslashit( $wp_rewrite-&gt;comments_pagination_base . '-' . get_query_var('cpage'), 'commentpaged' );&nbsp;</div></li><li><div>              $redirect['query'] = remove_query_arg( 'cpage', $redirect['query'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $redirect['path'] = user_trailingslashit( preg_replace('|/' . preg_quote( $wp_rewrite-&gt;index, '|' ) . '/?$|', '/', $redirect['path']) ); <span class="comment">// strip off trailing /index.php/</span>&nbsp;</div></li><li><div>          if ( !empty( $addl_path ) && $wp_rewrite-&gt;using_index_permalinks() && strpos($redirect['path'], '/' . $wp_rewrite-&gt;index . '/') === false )&nbsp;</div></li><li><div>              $redirect['path'] = trailingslashit($redirect['path']) . $wp_rewrite-&gt;index . '/';&nbsp;</div></li><li><div>          if ( !empty( $addl_path ) )&nbsp;</div></li><li><div>              $redirect['path'] = trailingslashit($redirect['path']) . $addl_path;&nbsp;</div></li><li><div>          $redirect_url = $redirect['scheme'] . ':<span class="comment">//' . $redirect['host'] . $redirect['path'];</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'wp-register.php' == basename( $redirect['path'] ) ) {&nbsp;</div></li><li><div>          if ( is_multisite() ) {&nbsp;</div></li><li><div>              <span class="comment">/** This filter is documented in wp-login.php */</span>&nbsp;</div></li><li><div>              $redirect_url = apply_filters( 'wp_signup_location', network_site_url( 'wp-signup.php' ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $redirect_url = wp_registration_url();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_redirect( $redirect_url, 301 );&nbsp;</div></li><li><div>          die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// tack on any additional query vars</span>&nbsp;</div></li><li><div>  $redirect['query'] = preg_replace( '#^\??&*?#', '', $redirect['query'] );&nbsp;</div></li><li><div>  if ( $redirect_url && !empty($redirect['query']) ) {&nbsp;</div></li><li><div>      parse_str( $redirect['query'], $_parsed_query );&nbsp;</div></li><li><div>      $redirect = @parse_url($redirect_url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $_parsed_query['name'] ) && ! empty( $redirect['query'] ) ) {&nbsp;</div></li><li><div>          parse_str( $redirect['query'], $_parsed_redirect_query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $_parsed_redirect_query['name'] ) )&nbsp;</div></li><li><div>              unset( $_parsed_query['name'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $_parsed_query = rawurlencode_deep( $_parsed_query );&nbsp;</div></li><li><div>      $redirect_url = add_query_arg( $_parsed_query, $redirect_url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $redirect_url )&nbsp;</div></li><li><div>      $redirect = @parse_url($redirect_url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// www.example.com vs example.com</span>&nbsp;</div></li><li><div>  $user_home = @parse_url(home_url());&nbsp;</div></li><li><div>  if ( !empty($user_home['host']) )&nbsp;</div></li><li><div>      $redirect['host'] = $user_home['host'];&nbsp;</div></li><li><div>  if ( empty($user_home['path']) )&nbsp;</div></li><li><div>      $user_home['path'] = '/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle ports</span>&nbsp;</div></li><li><div>  if ( !empty($user_home['port']) )&nbsp;</div></li><li><div>      $redirect['port'] = $user_home['port'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      unset($redirect['port']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// trailing /index.php</span>&nbsp;</div></li><li><div>  $redirect['path'] = preg_replace('|/' . preg_quote( $wp_rewrite-&gt;index, '|' ) . '<span class="comment">/*?$|', '/', $redirect['path']);</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // Remove trailing spaces from the path</span>&nbsp;</div></li><li><div><span class="comment">  $redirect['path'] = preg_replace( '#(%20| )+$#', '', $redirect['path'] );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( !empty( $redirect['query'] ) ) {</span>&nbsp;</div></li><li><div><span class="comment">      // Remove trailing spaces from certain terminating query string args</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['query'] = preg_replace( '#((p|page_id|cat|tag)=[^&]*?)(%20| )+$#', '$1', $redirect['query'] );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">      // Clean up empty query strings</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['query'] = trim(preg_replace( '#(^|&)(p|page_id|cat|tag)=?(&|$)#', '&', $redirect['query']), '&');</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">      // Redirect obsolete feeds</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['query'] = preg_replace( '#(^|&)feed=rss(&|$)#', '$1feed=rss2$2', $redirect['query'] );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">      // Remove redundant leading ampersands</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['query'] = preg_replace( '#^\??&*?#', '', $redirect['query'] );</span>&nbsp;</div></li><li><div><span class="comment">  }</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // strip /index.php/ when we're not using PATHINFO permalinks</span>&nbsp;</div></li><li><div><span class="comment">  if ( !$wp_rewrite-&gt;using_index_permalinks() )</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['path'] = str_replace( '/' . $wp_rewrite-&gt;index . '/', '/', $redirect['path'] );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // trailing slashes</span>&nbsp;</div></li><li><div><span class="comment">  if ( is_object($wp_rewrite) && $wp_rewrite-&gt;using_permalinks() && !is_404() && (!is_front_page() || ( is_front_page() && (get_query_var('paged') &gt; 1) ) ) ) {</span>&nbsp;</div></li><li><div><span class="comment">      $user_ts_type = '';</span>&nbsp;</div></li><li><div><span class="comment">      if ( get_query_var('paged') &gt; 0 ) {</span>&nbsp;</div></li><li><div><span class="comment">          $user_ts_type = 'paged';</span>&nbsp;</div></li><li><div><span class="comment">      } else {</span>&nbsp;</div></li><li><div><span class="comment">          foreach ( array('single', 'category', 'page', 'day', 'month', 'year', 'home') as $type ) {</span>&nbsp;</div></li><li><div><span class="comment">              $func = 'is_' . $type;</span>&nbsp;</div></li><li><div><span class="comment">              if ( call_user_func($func) ) {</span>&nbsp;</div></li><li><div><span class="comment">                  $user_ts_type = $type;</span>&nbsp;</div></li><li><div><span class="comment">                  break;</span>&nbsp;</div></li><li><div><span class="comment">              }</span>&nbsp;</div></li><li><div><span class="comment">          }</span>&nbsp;</div></li><li><div><span class="comment">      }</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['path'] = user_trailingslashit($redirect['path'], $user_ts_type);</span>&nbsp;</div></li><li><div><span class="comment">  } elseif ( is_front_page() ) {</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['path'] = trailingslashit($redirect['path']);</span>&nbsp;</div></li><li><div><span class="comment">  }</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // Strip multiple slashes out of the URL</span>&nbsp;</div></li><li><div><span class="comment">  if ( strpos($redirect['path'], '//') &gt; -1 )</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['path'] = preg_replace('|/+|', '/', $redirect['path']);</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // Always trailing slash the Front Page URL</span>&nbsp;</div></li><li><div><span class="comment">  if ( trailingslashit( $redirect['path'] ) == trailingslashit( $user_home['path'] ) )</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['path'] = trailingslashit($redirect['path']);</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // Ignore differences in host capitalization, as this can lead to infinite redirects</span>&nbsp;</div></li><li><div><span class="comment">  // Only redirect no-www &lt;=&gt; yes-www</span>&nbsp;</div></li><li><div><span class="comment">  if ( strtolower($original['host']) == strtolower($redirect['host']) ||</span>&nbsp;</div></li><li><div><span class="comment">      ( strtolower($original['host']) != 'www.' . strtolower($redirect['host']) && 'www.' . strtolower($original['host']) != strtolower($redirect['host']) ) )</span>&nbsp;</div></li><li><div><span class="comment">      $redirect['host'] = $original['host'];</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  $compare_original = array( $original['host'], $original['path'] );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( !empty( $original['port'] ) )</span>&nbsp;</div></li><li><div><span class="comment">      $compare_original[] = $original['port'];</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( !empty( $original['query'] ) )</span>&nbsp;</div></li><li><div><span class="comment">      $compare_original[] = $original['query'];</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  $compare_redirect = array( $redirect['host'], $redirect['path'] );</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( !empty( $redirect['port'] ) )</span>&nbsp;</div></li><li><div><span class="comment">      $compare_redirect[] = $redirect['port'];</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( !empty( $redirect['query'] ) )</span>&nbsp;</div></li><li><div><span class="comment">      $compare_redirect[] = $redirect['query'];</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( $compare_original !== $compare_redirect ) {</span>&nbsp;</div></li><li><div><span class="comment">      $redirect_url = $redirect['scheme'] . '://' . $redirect['host'];</span>&nbsp;</div></li><li><div><span class="comment">      if ( !empty($redirect['port']) )</span>&nbsp;</div></li><li><div><span class="comment">          $redirect_url .= ':' . $redirect['port'];</span>&nbsp;</div></li><li><div><span class="comment">      $redirect_url .= $redirect['path'];</span>&nbsp;</div></li><li><div><span class="comment">      if ( !empty($redirect['query']) )</span>&nbsp;</div></li><li><div><span class="comment">          $redirect_url .= '?' . $redirect['query'];</span>&nbsp;</div></li><li><div><span class="comment">  }</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  if ( ! $redirect_url || $redirect_url == $requested_url ) {</span>&nbsp;</div></li><li><div><span class="comment">      return;</span>&nbsp;</div></li><li><div><span class="comment">  }</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  // Hex encoded octets are case-insensitive.</span>&nbsp;</div></li><li><div><span class="comment">  if ( false !== strpos($requested_url, '%') ) {</span>&nbsp;</div></li><li><div><span class="comment">      if ( !function_exists('lowercase_octets') ) {</span>&nbsp;</div></li><li><div><span class="comment">          /**</span>&nbsp;</div></li><li><div><span class="comment">           * Converts the first hex-encoded octet match to lowercase.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">           * @ignore</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $matches Hex-encoded octet matches for the requested URL.</span>&nbsp;</div></li><li><div><span class="comment">           * @return string Lowercased version of the first match.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          function lowercase_octets($matches) {&nbsp;</div></li><li><div>              return strtolower( $matches[0] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $requested_url = preg_replace_callback('|%[a-fA-F0-9][a-fA-F0-9]|', 'lowercase_octets', $requested_url);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the canonical redirect URL.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Returning false to this filter will cancel the redirect.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $redirect_url  The redirect URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $requested_url The requested URL.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $redirect_url = apply_filters( 'redirect_canonical', $redirect_url, $requested_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// yes, again -- in case the filter aborted the request</span>&nbsp;</div></li><li><div>  if ( ! $redirect_url || strip_fragment_from_url( $redirect_url ) == strip_fragment_from_url( $requested_url ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $do_redirect ) {&nbsp;</div></li><li><div>      <span class="comment">// protect against chained redirects</span>&nbsp;</div></li><li><div>      if ( !redirect_canonical($redirect_url, false) ) {&nbsp;</div></li><li><div>          wp_redirect($redirect_url, 301);&nbsp;</div></li><li><div>          exit();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Debug</span>&nbsp;</div></li><li><div>          <span class="comment">// die(&quot;1: $redirect_url&lt;br /&gt;2: &quot; . redirect_canonical( $redirect_url, false ) );</span>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $redirect_url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Removes arguments from a query string if they are not present in a URL</span>&nbsp;</div></li><li><div><span class="comment"> * DO NOT use this in plugin code.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $query_string</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args_to_check</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The altered query string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _remove_qs_args_if_not_in_url( $query_string, Array $args_to_check, $url ) {&nbsp;</div></li><li><div>  $parsed_url = @parse_url( $url );&nbsp;</div></li><li><div>  if ( ! empty( $parsed_url['query'] ) ) {&nbsp;</div></li><li><div>      parse_str( $parsed_url['query'], $parsed_query );&nbsp;</div></li><li><div>      foreach ( $args_to_check as $qv ) {&nbsp;</div></li><li><div>          if ( !isset( $parsed_query[$qv] ) )&nbsp;</div></li><li><div>              $query_string = remove_query_arg( $qv, $query_string );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $query_string = remove_query_arg( $args_to_check, $query_string );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $query_string;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Strips the #fragment from a URL, if one is present.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url The URL to strip.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The altered URL.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function strip_fragment_from_url( $url ) {&nbsp;</div></li><li><div>  $parsed_url = @parse_url( $url );&nbsp;</div></li><li><div>  if ( ! empty( $parsed_url['host'] ) ) {&nbsp;</div></li><li><div>      <span class="comment">// This mirrors code in redirect_canonical(). It does not handle every case.</span>&nbsp;</div></li><li><div>      $url = $parsed_url['scheme'] . ':<span class="comment">//' . $parsed_url['host'];</span>&nbsp;</div></li><li><div>      if ( ! empty( $parsed_url['port'] ) ) {&nbsp;</div></li><li><div>          $url .= ':' . $parsed_url['port'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $url .= $parsed_url['path'];&nbsp;</div></li><li><div>      if ( ! empty( $parsed_url['query'] ) ) {&nbsp;</div></li><li><div>          $url .= '?' . $parsed_url['query'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $url;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Attempts to guess the correct URL based on query vars</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return false|string The correct URL if one is found. False on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function redirect_guess_404_permalink() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_query_var('name') ) {&nbsp;</div></li><li><div>      $where = $wpdb-&gt;prepare(&quot;post_name LIKE %s&quot;, $wpdb-&gt;esc_like( get_query_var('name') ) . '%');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if any of post_type, year, monthnum, or day are set, use them to refine the query</span>&nbsp;</div></li><li><div>      if ( get_query_var('post_type') )&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare(&quot; AND post_type = %s&quot;, get_query_var('post_type'));&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $where .= &quot; AND post_type IN ('&quot; . implode( &quot;', '&quot;, get_post_types( array( 'public' =&gt; true ) ) ) . &quot;')&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_query_var('year') )&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare(&quot; AND YEAR(post_date) = %d&quot;, get_query_var('year'));&nbsp;</div></li><li><div>      if ( get_query_var('monthnum') )&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare(&quot; AND MONTH(post_date) = %d&quot;, get_query_var('monthnum'));&nbsp;</div></li><li><div>      if ( get_query_var('day') )&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare(&quot; AND DAYOFMONTH(post_date) = %d&quot;, get_query_var('day'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE $where AND post_status = 'publish'&quot;);&nbsp;</div></li><li><div>      if ( ! $post_id )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      if ( get_query_var( 'feed' ) )&nbsp;</div></li><li><div>          return get_post_comments_feed_link( $post_id, get_query_var( 'feed' ) );&nbsp;</div></li><li><div>      elseif ( get_query_var( 'page' ) && 1 &lt; get_query_var( 'page' ) )&nbsp;</div></li><li><div>          return trailingslashit( get_permalink( $post_id ) ) . user_trailingslashit( get_query_var( 'page' ), 'single_paged' );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return get_permalink( $post_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirects a variety of shorthand URLs to the admin.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If a user visits example.com/admin, they'll be redirected to /wp-admin.</span>&nbsp;</div></li><li><div><span class="comment"> * Visiting /login redirects to /wp-login.php, and so on.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Rewrite $wp_rewrite</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_redirect_admin_locations() {&nbsp;</div></li><li><div>  global $wp_rewrite;&nbsp;</div></li><li><div>  if ( ! ( is_404() && $wp_rewrite-&gt;using_permalinks() ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $admins = array(&nbsp;</div></li><li><div>      home_url( 'wp-admin', 'relative' ), &nbsp;</div></li><li><div>      home_url( 'dashboard', 'relative' ), &nbsp;</div></li><li><div>      home_url( 'admin', 'relative' ), &nbsp;</div></li><li><div>      site_url( 'dashboard', 'relative' ), &nbsp;</div></li><li><div>      site_url( 'admin', 'relative' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  if ( in_array( untrailingslashit( $_SERVER['REQUEST_URI'] ), $admins ) ) {&nbsp;</div></li><li><div>      wp_redirect( admin_url() );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $logins = array(&nbsp;</div></li><li><div>      home_url( 'wp-login.php', 'relative' ), &nbsp;</div></li><li><div>      home_url( 'login', 'relative' ), &nbsp;</div></li><li><div>      site_url( 'login', 'relative' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  if ( in_array( untrailingslashit( $_SERVER['REQUEST_URI'] ), $logins ) ) {&nbsp;</div></li><li><div>      wp_redirect( wp_login_url() );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-include</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2019 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>