<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.1" data-type="file" data-id="4813"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-includes-ms-functions | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=8ac59505700799381b983ff86f8825fa' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-includes-ms-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-ms-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-ms-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.1-file-wp-includes-ms-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-includes-ms-functions" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.1." href="http://hookr.io/4.7.1/" class="H_VERSION"><span property="name">4.7.1</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-includes-ms-functions</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6308"><a href="http://hookr.io/4.7.1/all/" title="All">All <span class="count badge">6308</span></a></li><li class="" data-id="new" data-count="1"><a href="http://hookr.io/4.7.1/new/" title="New">New <span class="count badge">1</span></a></li><li class="" data-id="hooks" data-count="2531"><a href="http://hookr.io/4.7.1/hooks/" title="Hooks">Hooks <span class="count badge">2531</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.1/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1667"><a href="http://hookr.io/4.7.1/filters/" title="Filters">Filters <span class="count badge">1667</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.1/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.1/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2852"><a href="http://hookr.io/4.7.1/functions/" title="Functions">Functions <span class="count badge">2852</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-includes/ms-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Multisite WordPress API</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Multisite</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the network's site and user counts.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Site and user count for the network.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_sitestats() {&nbsp;</div></li><li><div>  $stats = array(&nbsp;</div></li><li><div>      'blogs' =&gt; get_blog_count(), &nbsp;</div></li><li><div>      'users' =&gt; get_user_count(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $stats;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get one of a user's active blogs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the user's primary blog, if they have one and</span>&nbsp;</div></li><li><div><span class="comment"> * it is active. If it's inactive, function returns another</span>&nbsp;</div></li><li><div><span class="comment"> * active blog of the user. If none are found, the user</span>&nbsp;</div></li><li><div><span class="comment"> * is added as a Subscriber to the Dashboard Blog and that blog</span>&nbsp;</div></li><li><div><span class="comment"> * is returned.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The unique ID of the user</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Site|void The blog object</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_active_blog_for_user( $user_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $blogs = get_blogs_of_user( $user_id );&nbsp;</div></li><li><div>  if ( empty( $blogs ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_multisite() )&nbsp;</div></li><li><div>      return $blogs[$wpdb-&gt;blogid];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $primary_blog = get_user_meta( $user_id, 'primary_blog', true );&nbsp;</div></li><li><div>  $first_blog = current($blogs);&nbsp;</div></li><li><div>  if ( false !== $primary_blog ) {&nbsp;</div></li><li><div>      if ( ! isset( $blogs[ $primary_blog ] ) ) {&nbsp;</div></li><li><div>          update_user_meta( $user_id, 'primary_blog', $first_blog-&gt;userblog_id );&nbsp;</div></li><li><div>          $primary = get_site( $first_blog-&gt;userblog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $primary = get_site( $primary_blog );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">//TODO Review this call to add_user_to_blog too - to get here the user must have a role on this blog?</span>&nbsp;</div></li><li><div>      add_user_to_blog( $first_blog-&gt;userblog_id, $user_id, 'subscriber' );&nbsp;</div></li><li><div>      update_user_meta( $user_id, 'primary_blog', $first_blog-&gt;userblog_id );&nbsp;</div></li><li><div>      $primary = $first_blog;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( ! is_object( $primary ) ) || ( $primary-&gt;archived == 1 || $primary-&gt;spam == 1 || $primary-&gt;deleted == 1 ) ) {&nbsp;</div></li><li><div>      $blogs = get_blogs_of_user( $user_id, true ); <span class="comment">// if a user's primary blog is shut down, check their other blogs.</span>&nbsp;</div></li><li><div>      $ret = false;&nbsp;</div></li><li><div>      if ( is_array( $blogs ) && count( $blogs ) &gt; 0 ) {&nbsp;</div></li><li><div>          foreach ( (array) $blogs as $blog_id =&gt; $blog ) {&nbsp;</div></li><li><div>              if ( $blog-&gt;site_id != $wpdb-&gt;siteid )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              $details = get_site( $blog_id );&nbsp;</div></li><li><div>              if ( is_object( $details ) && $details-&gt;archived == 0 && $details-&gt;spam == 0 && $details-&gt;deleted == 0 ) {&nbsp;</div></li><li><div>                  $ret = $blog;&nbsp;</div></li><li><div>                  if ( get_user_meta( $user_id , 'primary_blog', true ) != $blog_id )&nbsp;</div></li><li><div>                      update_user_meta( $user_id, 'primary_blog', $blog_id );&nbsp;</div></li><li><div>                  if ( !get_user_meta($user_id , 'source_domain', true) )&nbsp;</div></li><li><div>                      update_user_meta( $user_id, 'source_domain', $blog-&gt;domain );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $ret;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $primary;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The number of active users in your installation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The count is cached and updated twice daily. This is not a live count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 2.7</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_user_count() {&nbsp;</div></li><li><div>  return get_site_option( 'user_count' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The number of active sites on your installation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The count is cached and updated twice daily. This is not a live count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $network_id Deprecated, not supported.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_count( $network_id = 0 ) {&nbsp;</div></li><li><div>  if ( func_num_args() )&nbsp;</div></li><li><div>      _deprecated_argument( __FUNCTION__, '3.1.0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return get_site_option( 'blog_count' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a blog post from any site on the network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id ID of the blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id ID of the post you're looking for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Post|null WP_Post on success or null on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_post( $blog_id, $post_id ) {&nbsp;</div></li><li><div>  switch_to_blog( $blog_id );&nbsp;</div></li><li><div>  $post = get_post( $post_id );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds a user to a blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Use the {@see 'add_user_to_blog'} action to fire an event when users are added to a blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id ID of the blog you're adding the user to.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id ID of the user you're adding.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $role    The role you want the user to have</span>&nbsp;</div></li><li><div><span class="comment"> * @return true|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_user_to_blog( $blog_id, $user_id, $role ) {&nbsp;</div></li><li><div>  switch_to_blog($blog_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user ) {&nbsp;</div></li><li><div>      restore_current_blog();&nbsp;</div></li><li><div>      return new WP_Error( 'user_does_not_exist', __( 'The requested user does not exist.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !get_user_meta($user_id, 'primary_blog', true) ) {&nbsp;</div></li><li><div>      update_user_meta($user_id, 'primary_blog', $blog_id);&nbsp;</div></li><li><div>      $site = get_site( $blog_id );&nbsp;</div></li><li><div>      update_user_meta( $user_id, 'source_domain', $site-&gt;domain );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user-&gt;set_role($role);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires immediately after a user is added to a site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $role    User role.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'add_user_to_blog', $user_id, $role, $blog_id );&nbsp;</div></li><li><div>  wp_cache_delete( $user_id, 'users' );&nbsp;</div></li><li><div>  wp_cache_delete( $blog_id . '_user_count', 'blog-details' );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove a user from a blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Use the {@see 'remove_user_from_blog'} action to fire an event when</span>&nbsp;</div></li><li><div><span class="comment"> * users are removed from a blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Accepts an optional `$reassign` parameter, if you want to</span>&nbsp;</div></li><li><div><span class="comment"> * reassign the user's blog posts to another user upon removal.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id  ID of the user you're removing.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id  ID of the blog you're removing the user from.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $reassign Optional. A user to whom to reassign posts.</span>&nbsp;</div></li><li><div><span class="comment"> * @return true|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function remove_user_from_blog($user_id, $blog_id = '', $reassign = '') {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  switch_to_blog($blog_id);&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires before a user is removed from a site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'remove_user_from_blog', $user_id, $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If being removed from the primary blog, set a new primary if the user is assigned</span>&nbsp;</div></li><li><div>  <span class="comment">// to multiple blogs.</span>&nbsp;</div></li><li><div>  $primary_blog = get_user_meta($user_id, 'primary_blog', true);&nbsp;</div></li><li><div>  if ( $primary_blog == $blog_id ) {&nbsp;</div></li><li><div>      $new_id = '';&nbsp;</div></li><li><div>      $new_domain = '';&nbsp;</div></li><li><div>      $blogs = get_blogs_of_user($user_id);&nbsp;</div></li><li><div>      foreach ( (array) $blogs as $blog ) {&nbsp;</div></li><li><div>          if ( $blog-&gt;userblog_id == $blog_id )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          $new_id = $blog-&gt;userblog_id;&nbsp;</div></li><li><div>          $new_domain = $blog-&gt;domain;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_user_meta($user_id, 'primary_blog', $new_id);&nbsp;</div></li><li><div>      update_user_meta($user_id, 'source_domain', $new_domain);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// wp_revoke_user($user_id);</span>&nbsp;</div></li><li><div>  $user = get_userdata( $user_id );&nbsp;</div></li><li><div>  if ( ! $user ) {&nbsp;</div></li><li><div>      restore_current_blog();&nbsp;</div></li><li><div>      return new WP_Error('user_does_not_exist', __('That user does not exist.'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user-&gt;remove_all_caps();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blogs = get_blogs_of_user($user_id);&nbsp;</div></li><li><div>  if ( count($blogs) == 0 ) {&nbsp;</div></li><li><div>      update_user_meta($user_id, 'primary_blog', '');&nbsp;</div></li><li><div>      update_user_meta($user_id, 'source_domain', '');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $reassign != '' ) {&nbsp;</div></li><li><div>      $reassign = (int) $reassign;&nbsp;</div></li><li><div>      $post_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_author = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>      $link_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT link_id FROM $wpdb-&gt;links WHERE link_owner = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $post_ids ) ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE $wpdb-&gt;posts SET post_author = %d WHERE post_author = %d&quot;, $reassign, $user_id ) );&nbsp;</div></li><li><div>          array_walk( $post_ids, 'clean_post_cache' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $link_ids ) ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE $wpdb-&gt;links SET link_owner = %d WHERE link_owner = %d&quot;, $reassign, $user_id ) );&nbsp;</div></li><li><div>          array_walk( $link_ids, 'clean_bookmark_cache' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the permalink for a post on another blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id ID of the source blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id ID of the desired post.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The post's permalink</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_permalink( $blog_id, $post_id ) {&nbsp;</div></li><li><div>  switch_to_blog( $blog_id );&nbsp;</div></li><li><div>  $link = get_permalink( $post_id );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $link;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a blog's numeric ID from its URL.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * On a subdirectory installation like example.com/blog1/, </span>&nbsp;</div></li><li><div><span class="comment"> * $domain will be the root 'example.com' and $path the</span>&nbsp;</div></li><li><div><span class="comment"> * subdirectory '/blog1/'. With subdomains like blog1.example.com, </span>&nbsp;</div></li><li><div><span class="comment"> * $domain is 'blog1.example.com' and $path is '/'.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU 2.6.5</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $domain</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path   Optional. Not required for subdomain installations.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int 0 if no blog found, otherwise the ID of the matching blog</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_id_from_url( $domain, $path = '/' ) {&nbsp;</div></li><li><div>  $domain = strtolower( $domain );&nbsp;</div></li><li><div>  $path = strtolower( $path );&nbsp;</div></li><li><div>  $id = wp_cache_get( md5( $domain . $path ), 'blog-id-cache' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $id == -1 ) <span class="comment">// blog does not exist</span>&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  elseif ( $id )&nbsp;</div></li><li><div>      return (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'domain' =&gt; $domain, &nbsp;</div></li><li><div>      'path' =&gt; $path, &nbsp;</div></li><li><div>      'fields' =&gt; 'ids', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  $result = get_sites( $args );&nbsp;</div></li><li><div>  $id = array_shift( $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $id ) {&nbsp;</div></li><li><div>      wp_cache_set( md5( $domain . $path ), -1, 'blog-id-cache' );&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_set( md5( $domain . $path ), $id, 'blog-id-cache' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Admin functions</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks an email address against a list of banned domains.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function checks against the Banned Email Domains list</span>&nbsp;</div></li><li><div><span class="comment"> * at wp-admin/network/settings.php. The check is only run on</span>&nbsp;</div></li><li><div><span class="comment"> * self-registrations; user creation at wp-admin/network/users.php</span>&nbsp;</div></li><li><div><span class="comment"> * bypasses this check.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The email provided by the user at registration.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Returns true when the email address is banned.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_email_address_unsafe( $user_email ) {&nbsp;</div></li><li><div>  $banned_names = get_site_option( 'banned_email_domains' );&nbsp;</div></li><li><div>  if ( $banned_names && ! is_array( $banned_names ) )&nbsp;</div></li><li><div>      $banned_names = explode( &quot;\n&quot;, $banned_names );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_email_address_unsafe = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $banned_names && is_array( $banned_names ) ) {&nbsp;</div></li><li><div>      $banned_names = array_map( 'strtolower', $banned_names );&nbsp;</div></li><li><div>      $normalized_email = strtolower( $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list( $email_local_part, $email_domain ) = explode( '@', $normalized_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $banned_names as $banned_domain ) {&nbsp;</div></li><li><div>          if ( ! $banned_domain )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $email_domain == $banned_domain ) {&nbsp;</div></li><li><div>              $is_email_address_unsafe = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $dotted_domain = &quot;.$banned_domain&quot;;&nbsp;</div></li><li><div>          if ( $dotted_domain === substr( $normalized_email, -strlen( $dotted_domain ) ) ) {&nbsp;</div></li><li><div>              $is_email_address_unsafe = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether an email address is unsafe.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $is_email_address_unsafe Whether the email address is &quot;unsafe&quot;. Default false.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_email              User email address.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'is_email_address_unsafe', $is_email_address_unsafe, $user_email );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sanitize and validate data required for a user sign-up.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Verifies the validity and uniqueness of user names and user email addresses, </span>&nbsp;</div></li><li><div><span class="comment"> * and checks email addresses against admin-provided domain whitelists and blacklists.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The {@see 'wpmu_validate_user_signup'} hook provides an easy way to modify the sign-up</span>&nbsp;</div></li><li><div><span class="comment"> * process. The value $result, which is passed to the hook, contains both the user-provided</span>&nbsp;</div></li><li><div><span class="comment"> * info and the error messages created by the function. {@see 'wpmu_validate_user_signup'}</span>&nbsp;</div></li><li><div><span class="comment"> * allows you to process the data in any way you'd like, and unset the relevant errors if</span>&nbsp;</div></li><li><div><span class="comment"> * necessary.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_name  The login name provided by the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The email provided by the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Contains username, email, and error messages.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_validate_user_signup($user_name, $user_email) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $errors = new WP_Error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $orig_username = $user_name;&nbsp;</div></li><li><div>  $user_name = preg_replace( '/\s+/', '', sanitize_user( $user_name, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $user_name != $orig_username || preg_match( '/[^a-z0-9]/', $user_name ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_name', __( 'Usernames can only contain lowercase letters (a-z) and numbers.' ) );&nbsp;</div></li><li><div>      $user_name = $orig_username;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_email = sanitize_email( $user_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_name ) )&nbsp;</div></li><li><div>         $errors-&gt;add('user_name', __( 'Please enter a username.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>  if ( ! is_array( $illegal_names ) ) {&nbsp;</div></li><li><div>      $illegal_names = array(  'www', 'web', 'root', 'admin', 'main', 'invite', 'administrator' );&nbsp;</div></li><li><div>      add_site_option( 'illegal_names', $illegal_names );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( in_array( $user_name, $illegal_names ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_name', __( 'Sorry, that username is not allowed.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** This filter is documented in wp-includes/user.php */</span>&nbsp;</div></li><li><div>  $illegal_logins = (array) apply_filters( 'illegal_user_logins', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( in_array( strtolower( $user_name ), array_map( 'strtolower', $illegal_logins ) ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_name', __( 'Sorry, that username is not allowed.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_email_address_unsafe( $user_email ) )&nbsp;</div></li><li><div>      $errors-&gt;add('user_email', __('You cannot use that email address to signup. We are having problems with them blocking some of our email. Please use another email provider.'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen( $user_name ) &lt; 4 )&nbsp;</div></li><li><div>      $errors-&gt;add('user_name', __( 'Username must be at least 4 characters.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen( $user_name ) &gt; 60 ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_name', __( 'Username may not be longer than 60 characters.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// all numeric?</span></span>&nbsp;</div></li><li><div>  if ( preg_match( '/^[0-9]*$/', $user_name ) )&nbsp;</div></li><li><div>      $errors-&gt;add('user_name', __('Sorry, usernames must have letters too!'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !is_email( $user_email ) )&nbsp;</div></li><li><div>      $errors-&gt;add('user_email', __( 'Please enter a valid email address.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $limited_email_domains = get_site_option( 'limited_email_domains' );&nbsp;</div></li><li><div>  if ( is_array( $limited_email_domains ) && ! empty( $limited_email_domains ) ) {&nbsp;</div></li><li><div>      $emaildomain = substr( $user_email, 1 + strpos( $user_email, '@' ) );&nbsp;</div></li><li><div>      if ( ! in_array( $emaildomain, $limited_email_domains ) ) {&nbsp;</div></li><li><div>          $errors-&gt;add('user_email', __('Sorry, that email address is not allowed!'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the username has been used already.</span>&nbsp;</div></li><li><div>  if ( username_exists($user_name) )&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_name', __( 'Sorry, that username already exists!' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the email address has been used already.</span>&nbsp;</div></li><li><div>  if ( email_exists($user_email) )&nbsp;</div></li><li><div>      $errors-&gt;add( 'user_email', __( 'Sorry, that email address is already used!' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Has someone already signed up for this username?</span>&nbsp;</div></li><li><div>  $signup = $wpdb-&gt;get_row( $wpdb-&gt;prepare(&quot;SELECT * FROM $wpdb-&gt;signups WHERE user_login = %s&quot;, $user_name) );&nbsp;</div></li><li><div>  if ( $signup != null ) {&nbsp;</div></li><li><div>      $registered_at =  mysql2date('U', $signup-&gt;registered);&nbsp;</div></li><li><div>      $now = current_time( 'timestamp', true );&nbsp;</div></li><li><div>      $diff = $now - $registered_at;&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// If registered more than two days ago, cancel registration and let this signup go through.</span></span></span>&nbsp;</div></li><li><div>      if ( $diff &gt; 2 * DAY_IN_SECONDS )&nbsp;</div></li><li><div>          $wpdb-&gt;delete( $wpdb-&gt;signups, array( 'user_login' =&gt; $user_name ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $errors-&gt;add('user_name', __('That username is currently reserved but may be available in a couple of days.'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $signup = $wpdb-&gt;get_row( $wpdb-&gt;prepare(&quot;SELECT * FROM $wpdb-&gt;signups WHERE user_email = %s&quot;, $user_email) );&nbsp;</div></li><li><div>  if ( $signup != null ) {&nbsp;</div></li><li><div>      $diff = current_time( 'timestamp', true ) - mysql2date('U', $signup-&gt;registered);&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// If registered more than two days ago, cancel registration and let this signup go through.</span></span></span>&nbsp;</div></li><li><div>      if ( $diff &gt; 2 * DAY_IN_SECONDS )&nbsp;</div></li><li><div>          $wpdb-&gt;delete( $wpdb-&gt;signups, array( 'user_email' =&gt; $user_email ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $errors-&gt;add('user_email', __('That email address has already been used. Please check your inbox for an activation email. It will become available in a couple of days if you do nothing.'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = array('user_name' =&gt; $user_name, 'orig_username' =&gt; $orig_username, 'user_email' =&gt; $user_email, 'errors' =&gt; $errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the validated user registration details.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This does not allow you to override the username or email of the user during</span>&nbsp;</div></li><li><div><span class="comment">   * registration. The values are solely used for validation and error handling.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $result {</span>&nbsp;</div></li><li><div><span class="comment">   *     The array of user name, email and the error messages.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $user_name     Sanitized and unique username.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $orig_username Original username.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string   $user_email    User email address.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type WP_Error $errors        WP_Error object containing any errors found.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'wpmu_validate_user_signup', $result );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Processes new site registrations.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks the data provided by the user during blog signup. Verifies</span>&nbsp;</div></li><li><div><span class="comment"> * the validity and uniqueness of blog paths and domains.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function prevents the current user from registering a new site</span>&nbsp;</div></li><li><div><span class="comment"> * with a blogname equivalent to another user's login name. Passing the</span>&nbsp;</div></li><li><div><span class="comment"> * $user parameter to the function, where $user is the other user, is</span>&nbsp;</div></li><li><div><span class="comment"> * effectively an override of this limitation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_validate_blog_signup'} if you want to modify</span>&nbsp;</div></li><li><div><span class="comment"> * the way that WordPress validates new site signups.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb   $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $domain</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string         $blogname   The blog name provided by the user. Must be unique.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string         $blog_title The blog title provided by the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_User|string $user       Optional. The user object to check against the new site name.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Contains the new site data and error messages.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_validate_blog_signup( $blogname, $blog_title, $user = '' ) {&nbsp;</div></li><li><div>  global $wpdb, $domain;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current_network = get_network();&nbsp;</div></li><li><div>  $base = $current_network-&gt;path;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_title = strip_tags( $blog_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $errors = new WP_Error();&nbsp;</div></li><li><div>  $illegal_names = get_site_option( 'illegal_names' );&nbsp;</div></li><li><div>  if ( $illegal_names == false ) {&nbsp;</div></li><li><div>      $illegal_names = array( 'www', 'web', 'root', 'admin', 'main', 'invite', 'administrator' );&nbsp;</div></li><li><div>      add_site_option( 'illegal_names', $illegal_names );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * On sub dir installs, some names are so illegal, only a filter can</span>&nbsp;</div></li><li><div><span class="comment">   * spring them from jail.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! is_subdomain_install() ) {&nbsp;</div></li><li><div>      $illegal_names = array_merge( $illegal_names, get_subdirectory_reserved_names() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $blogname ) )&nbsp;</div></li><li><div>      $errors-&gt;add('blogname', __( 'Please enter a site name.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( '/[^a-z0-9]+/', $blogname ) ) {&nbsp;</div></li><li><div>      $errors-&gt;add( 'blogname', __( 'Site names can only contain lowercase letters (a-z) and numbers.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( in_array( $blogname, $illegal_names ) )&nbsp;</div></li><li><div>      $errors-&gt;add('blogname', __( 'That name is not allowed.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen( $blogname ) &lt; 4 && !is_super_admin() )&nbsp;</div></li><li><div>      $errors-&gt;add('blogname', __( 'Site name must be at least 4 characters.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// do not allow users to create a blog that conflicts with a page on the main blog.</span>&nbsp;</div></li><li><div>  if ( !is_subdomain_install() && $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT post_name FROM &quot; . $wpdb-&gt;get_blog_prefix( $current_network-&gt;site_id ) . &quot;posts WHERE post_type = 'page' AND post_name = %s&quot;, $blogname ) ) )&nbsp;</div></li><li><div>      $errors-&gt;add( 'blogname', __( 'Sorry, you may not use that site name.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// all numeric?</span></span>&nbsp;</div></li><li><div>  if ( preg_match( '/^[0-9]*$/', $blogname ) )&nbsp;</div></li><li><div>      $errors-&gt;add('blogname', __('Sorry, site names must have letters too!'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the new site name during registration.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The name is the site's subdomain or the site's subdirectory</span>&nbsp;</div></li><li><div><span class="comment">   * path depending on the network settings.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $blogname Site name.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $blogname = apply_filters( 'newblogname', $blogname );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_title = wp_unslash(  $blog_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $blog_title ) )&nbsp;</div></li><li><div>      $errors-&gt;add('blog_title', __( 'Please enter a site title.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the domain/path has been used already.</span>&nbsp;</div></li><li><div>  if ( is_subdomain_install() ) {&nbsp;</div></li><li><div>      $mydomain = $blogname . '.' . preg_replace( '|^www\.|', '', $domain );&nbsp;</div></li><li><div>      $path = $base;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $mydomain = &quot;$domain&quot;;&nbsp;</div></li><li><div>      $path = $base.$blogname.'/';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( domain_exists($mydomain, $path, $current_network-&gt;id) )&nbsp;</div></li><li><div>      $errors-&gt;add( 'blogname', __( 'Sorry, that site already exists!' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( username_exists( $blogname ) ) {&nbsp;</div></li><li><div>      if ( ! is_object( $user ) || ( is_object($user) && ( $user-&gt;user_login != $blogname ) ) )&nbsp;</div></li><li><div>          $errors-&gt;add( 'blogname', __( 'Sorry, that site is reserved!' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Has someone already signed up for this domain?</span>&nbsp;</div></li><li><div>  $signup = $wpdb-&gt;get_row( $wpdb-&gt;prepare(&quot;SELECT * FROM $wpdb-&gt;signups WHERE domain = %s AND path = %s&quot;, $mydomain, $path) ); <span class="comment">// TODO: Check email too?</span>&nbsp;</div></li><li><div>  if ( ! empty($signup) ) {&nbsp;</div></li><li><div>      $diff = current_time( 'timestamp', true ) - mysql2date('U', $signup-&gt;registered);&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// If registered more than two days ago, cancel registration and let this signup go through.</span></span></span>&nbsp;</div></li><li><div>      if ( $diff &gt; 2 * DAY_IN_SECONDS )&nbsp;</div></li><li><div>          $wpdb-&gt;delete( $wpdb-&gt;signups, array( 'domain' =&gt; $mydomain , 'path' =&gt; $path ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $errors-&gt;add('blogname', __('That site is currently reserved but may be available in a couple days.'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = array('domain' =&gt; $mydomain, 'path' =&gt; $path, 'blogname' =&gt; $blogname, 'blog_title' =&gt; $blog_title, 'user' =&gt; $user, 'errors' =&gt; $errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters site details and error messages following registration.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $result {</span>&nbsp;</div></li><li><div><span class="comment">   *     Array of domain, path, blog name, blog title, user and error messages.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string         $domain     Domain for the site.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string         $path       Path for the site. Used in subdirectory installs.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string         $blogname   The unique site name (slug).</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string         $blog_title Blog title.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type string|WP_User $user       By default, an empty string. A user object if provided.</span>&nbsp;</div></li><li><div><span class="comment">   *     @type WP_Error       $errors     WP_Error containing any errors found.</span>&nbsp;</div></li><li><div><span class="comment">   * }</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'wpmu_validate_blog_signup', $result );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Record site signup information for future activation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $domain     The requested domain.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path       The requested path.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title      The requested site title.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user       The user's requested login name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The user's email address.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta       By default, contains the requested privacy setting and lang_id.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_signup_blog( $domain, $path, $title, $user, $user_email, $meta = array() )  {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $key = substr( md5( time() . wp_rand() . $domain ), 0, 16 );&nbsp;</div></li><li><div>  $meta = serialize($meta);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;signups, array(&nbsp;</div></li><li><div>      'domain' =&gt; $domain, &nbsp;</div></li><li><div>      'path' =&gt; $path, &nbsp;</div></li><li><div>      'title' =&gt; $title, &nbsp;</div></li><li><div>      'user_login' =&gt; $user, &nbsp;</div></li><li><div>      'user_email' =&gt; $user_email, &nbsp;</div></li><li><div>      'registered' =&gt; current_time('mysql', true), &nbsp;</div></li><li><div>      'activation_key' =&gt; $key, &nbsp;</div></li><li><div>      'meta' =&gt; $meta&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after site signup information has been written to the database.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $domain     The requested domain.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path       The requested path.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $title      The requested site title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user       The user's requested login name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_email The user's email address.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key        The user's activation key</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta       By default, contains the requested privacy setting and lang_id.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'after_signup_site', $domain, $path, $title, $user, $user_email, $key, $meta );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Record user signup information for future activation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is used when user registration is open but</span>&nbsp;</div></li><li><div><span class="comment"> * new site registration is not.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user       The user's requested login name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The user's email address.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta       By default, this is an empty array.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_signup_user( $user, $user_email, $meta = array() ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Format data</span>&nbsp;</div></li><li><div>  $user = preg_replace( '/\s+/', '', sanitize_user( $user, true ) );&nbsp;</div></li><li><div>  $user_email = sanitize_email( $user_email );&nbsp;</div></li><li><div>  $key = substr( md5( time() . wp_rand() . $user_email ), 0, 16 );&nbsp;</div></li><li><div>  $meta = serialize($meta);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;signups, array(&nbsp;</div></li><li><div>      'domain' =&gt; '', &nbsp;</div></li><li><div>      'path' =&gt; '', &nbsp;</div></li><li><div>      'title' =&gt; '', &nbsp;</div></li><li><div>      'user_login' =&gt; $user, &nbsp;</div></li><li><div>      'user_email' =&gt; $user_email, &nbsp;</div></li><li><div>      'registered' =&gt; current_time('mysql', true), &nbsp;</div></li><li><div>      'activation_key' =&gt; $key, &nbsp;</div></li><li><div>      'meta' =&gt; $meta&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a user's signup information has been written to the database.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user       The user's requested login name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_email The user's email address.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key        The user's activation key</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta       Additional signup meta. By default, this is an empty array.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'after_signup_user', $user, $user_email, $key, $meta );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notify user of signup success.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is the notification function used when site registration</span>&nbsp;</div></li><li><div><span class="comment"> * is enabled.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_signup_blog_notification'} to bypass this function or</span>&nbsp;</div></li><li><div><span class="comment"> * replace it with your own notification behavior.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_signup_blog_notification_email'} and</span>&nbsp;</div></li><li><div><span class="comment"> * {@see 'wpmu_signup_blog_notification_subject'} to change the content</span>&nbsp;</div></li><li><div><span class="comment"> * and subject line of the email sent to newly registered users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $domain     The new blog domain.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path       The new blog path.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title      The site title.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_login The user's login name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The user's email address.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key        The activation key created in wpmu_signup_blog()</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta       By default, contains the requested privacy setting and lang_id.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_signup_blog_notification( $domain, $path, $title, $user_login, $user_email, $key, $meta = array() ) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to bypass the new site email notification.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|bool $domain     Site domain.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $path       Site path.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $title      Site title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $user_login User login name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $user_email User email address.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $key        Activation key created in wpmu_signup_blog().</span>&nbsp;</div></li><li><div><span class="comment">   * @param array       $meta       By default, contains the requested privacy setting and lang_id.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'wpmu_signup_blog_notification', $domain, $path, $title, $user_login, $user_email, $key, $meta ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Send email with activation link.</span></span>&nbsp;</div></li><li><div>  if ( !is_subdomain_install() || get_current_network_id() != 1 )&nbsp;</div></li><li><div>      $activate_url = network_site_url(&quot;wp-activate.php?key=$key&quot;);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $activate_url = &quot;http:<span class="comment">//{$domain}{$path}wp-activate.php?key=$key&quot;; // @todo use *_url() API</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $activate_url = esc_url($activate_url);&nbsp;</div></li><li><div>  $admin_email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>  if ( $admin_email == '' )&nbsp;</div></li><li><div>      $admin_email = 'support@' . $_SERVER['SERVER_NAME'];&nbsp;</div></li><li><div>  $from_name = get_site_option( 'site_name' ) == '' ? 'WordPress' : esc_html( get_site_option( 'site_name' ) );&nbsp;</div></li><li><div>  $message_headers = &quot;From: \&quot;{$from_name}\&quot; &lt;{$admin_email}&gt;\n&quot; . &quot;Content-Type: text/plain; charset=\&quot;&quot; . get_option('blog_charset') . &quot;\&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_user_by( 'login', $user_login );&nbsp;</div></li><li><div>  $switched_locale = switch_to_locale( get_user_locale( $user ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = sprintf(&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the message content of the new blog notification email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Content should be formatted for transmission via wp_mail().</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $content    Content of the notification email.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $domain     Site domain.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $path       Site path.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $title      Site title.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_login User login name.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_email User email address.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $key        Activation key created in wpmu_signup_blog().</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $meta       By default, contains the requested privacy setting and lang_id.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      apply_filters( 'wpmu_signup_blog_notification_email', &nbsp;</div></li><li><div>          __( &quot;To activate your blog, please click the following link:\n\n%s\n\nAfter you activate, you will receive *another email* with your login.\n\nAfter you activate, you can visit your site here:\n\n%s&quot; ), &nbsp;</div></li><li><div>          $domain, $path, $title, $user_login, $user_email, $key, $meta&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      $activate_url, &nbsp;</div></li><li><div>      esc_url( &quot;http:<span class="comment">//{$domain}{$path}&quot; ), </span>&nbsp;</div></li><li><div>      $key&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// TODO: Don't hard code activation link.</span></span>&nbsp;</div></li><li><div>  $subject = sprintf(&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the subject of the new blog notification email.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $subject    Subject of the notification email.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $domain     Site domain.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $path       Site path.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $title      Site title.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_login User login name.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_email User email address.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $key        Activation key created in wpmu_signup_blog().</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $meta       By default, contains the requested privacy setting and lang_id.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      apply_filters( 'wpmu_signup_blog_notification_subject', &nbsp;</div></li><li><div>          <span class="comment">/** translators: New site notification email subject. 1: Network name, 2: New site URL */</span>&nbsp;</div></li><li><div>          _x( '[%1$s] Activate %2$s', 'New site notification email subject' ), &nbsp;</div></li><li><div>          $domain, $path, $title, $user_login, $user_email, $key, $meta&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      $from_name, &nbsp;</div></li><li><div>      esc_url( 'http:<span class="comment">//' . $domain . $path )</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  wp_mail( $user_email, wp_specialchars_decode( $subject ), $message, $message_headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $switched_locale ) {&nbsp;</div></li><li><div>      restore_previous_locale();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notify user of signup success.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is the notification function used when no new site has</span>&nbsp;</div></li><li><div><span class="comment"> * been requested.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_signup_user_notification'} to bypass this function or</span>&nbsp;</div></li><li><div><span class="comment"> * replace it with your own notification behavior.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_signup_user_notification_email'} and</span>&nbsp;</div></li><li><div><span class="comment"> * {@see 'wpmu_signup_user_notification_subject'} to change the content</span>&nbsp;</div></li><li><div><span class="comment"> * and subject line of the email sent to newly registered users.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_login The user's login name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_email The user's email address.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key        The activation key created in wpmu_signup_user()</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta       By default, an empty array.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_signup_user_notification( $user_login, $user_email, $key, $meta = array() ) {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to bypass the email notification for new user sign-up.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_login User login name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user_email User email address.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key        Activation key created in wpmu_signup_user().</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta       Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'wpmu_signup_user_notification', $user_login, $user_email, $key, $meta ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_user_by( 'login', $user_login );&nbsp;</div></li><li><div>  $switched_locale = switch_to_locale( get_user_locale( $user ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Send email with activation link.</span></span>&nbsp;</div></li><li><div>  $admin_email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>  if ( $admin_email == '' )&nbsp;</div></li><li><div>      $admin_email = 'support@' . $_SERVER['SERVER_NAME'];&nbsp;</div></li><li><div>  $from_name = get_site_option( 'site_name' ) == '' ? 'WordPress' : esc_html( get_site_option( 'site_name' ) );&nbsp;</div></li><li><div>  $message_headers = &quot;From: \&quot;{$from_name}\&quot; &lt;{$admin_email}&gt;\n&quot; . &quot;Content-Type: text/plain; charset=\&quot;&quot; . get_option('blog_charset') . &quot;\&quot;\n&quot;;&nbsp;</div></li><li><div>  $message = sprintf(&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the content of the notification email for new user sign-up.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Content should be formatted for transmission via wp_mail().</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $content    Content of the notification email.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_login User login name.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_email User email address.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $key        Activation key created in wpmu_signup_user().</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $meta       Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      apply_filters( 'wpmu_signup_user_notification_email', &nbsp;</div></li><li><div>          __( &quot;To activate your user, please click the following link:\n\n%s\n\nAfter you activate, you will receive *another email* with your login.&quot; ), &nbsp;</div></li><li><div>          $user_login, $user_email, $key, $meta&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      site_url( &quot;wp-activate.php?key=$key&quot; )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// TODO: Don't hard code activation link.</span></span>&nbsp;</div></li><li><div>  $subject = sprintf(&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the subject of the notification email of new user signup.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $subject    Subject of the notification email.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_login User login name.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $user_email User email address.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $key        Activation key created in wpmu_signup_user().</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $meta       Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      apply_filters( 'wpmu_signup_user_notification_subject', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** translators: New user notification email subject. 1: Network name, 2: New user login */</span></span>&nbsp;</div></li><li><div>          _x( '[%1$s] Activate %2$s', 'New user notification email subject' ), &nbsp;</div></li><li><div>          $user_login, $user_email, $key, $meta&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      $from_name, &nbsp;</div></li><li><div>      $user_login&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  wp_mail( $user_email, wp_specialchars_decode( $subject ), $message, $message_headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $switched_locale ) {&nbsp;</div></li><li><div>      restore_previous_locale();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Activate a signup.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Hook to {@see 'wpmu_activate_user'} or {@see 'wpmu_activate_blog'} for events</span>&nbsp;</div></li><li><div><span class="comment"> * that should happen only when users or sites are self-created (since</span>&nbsp;</div></li><li><div><span class="comment"> * those actions are not called when users and sites are created</span>&nbsp;</div></li><li><div><span class="comment"> * by a Super Admin).</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key The activation key provided to the user.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error An array containing information about the activated user and/or blog</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_activate_signup($key) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $signup = $wpdb-&gt;get_row( $wpdb-&gt;prepare(&quot;SELECT * FROM $wpdb-&gt;signups WHERE activation_key = %s&quot;, $key) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $signup ) )&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_key', __( 'Invalid activation key.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $signup-&gt;active ) {&nbsp;</div></li><li><div>      if ( empty( $signup-&gt;domain ) )&nbsp;</div></li><li><div>          return new WP_Error( 'already_active', __( 'The user is already active.' ), $signup );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return new WP_Error( 'already_active', __( 'The site is already active.' ), $signup );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta = maybe_unserialize($signup-&gt;meta);&nbsp;</div></li><li><div>  $password = wp_generate_password( 12, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_id = username_exists($signup-&gt;user_login);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user_id )&nbsp;</div></li><li><div>      $user_id = wpmu_create_user($signup-&gt;user_login, $password, $signup-&gt;user_email);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $user_already_exists = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user_id )&nbsp;</div></li><li><div>      return new WP_Error('create_user', __('Could not create user'), $signup);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $now = current_time('mysql', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($signup-&gt;domain) ) {&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;signups, array('active' =&gt; 1, 'activated' =&gt; $now), array('activation_key' =&gt; $key) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $user_already_exists ) )&nbsp;</div></li><li><div>          return new WP_Error( 'user_already_exists', __( 'That username is already activated.' ), $signup);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires immediately after a new user is activated.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int   $user_id  User ID.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int   $password User password.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $meta     Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'wpmu_activate_user', $user_id, $password, $meta );&nbsp;</div></li><li><div>      return array( 'user_id' =&gt; $user_id, 'password' =&gt; $password, 'meta' =&gt; $meta );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_id = wpmu_create_blog( $signup-&gt;domain, $signup-&gt;path, $signup-&gt;title, $user_id, $meta, $wpdb-&gt;siteid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// TODO: What to do if we create a user but cannot create a blog?</span>&nbsp;</div></li><li><div>  if ( is_wp_error($blog_id) ) {&nbsp;</div></li><li><div>      <span class="comment">// If blog is taken, that means a previous attempt to activate this blog failed in between creating the blog and</span>&nbsp;</div></li><li><div>      <span class="comment">// setting the activation flag. Let's just set the active flag and instruct the user to reset their password.</span>&nbsp;</div></li><li><div>      if ( 'blog_taken' == $blog_id-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $blog_id-&gt;add_data( $signup );&nbsp;</div></li><li><div>          $wpdb-&gt;update( $wpdb-&gt;signups, array( 'active' =&gt; 1, 'activated' =&gt; $now ), array( 'activation_key' =&gt; $key ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $blog_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;update( $wpdb-&gt;signups, array('active' =&gt; 1, 'activated' =&gt; $now), array('activation_key' =&gt; $key) );&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires immediately after a site is activated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $blog_id       Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id       User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $password      User password.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $signup_title  Site title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta          Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wpmu_activate_blog', $blog_id, $user_id, $password, $signup-&gt;title, $meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array('blog_id' =&gt; $blog_id, 'user_id' =&gt; $user_id, 'password' =&gt; $password, 'title' =&gt; $signup-&gt;title, 'meta' =&gt; $meta);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function runs when a user self-registers as well as when</span>&nbsp;</div></li><li><div><span class="comment"> * a Super Admin creates a new user. Hook to {@see 'wpmu_new_user'} for events</span>&nbsp;</div></li><li><div><span class="comment"> * that should affect all new users, but only on Multisite (otherwise</span>&nbsp;</div></li><li><div><span class="comment"> * use {@see'user_register'}).</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_name The new user's login name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $password  The new user's password.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $email     The new user's email address.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false Returns false on failure, or int $user_id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_create_user( $user_name, $password, $email ) {&nbsp;</div></li><li><div>  $user_name = preg_replace( '/\s+/', '', sanitize_user( $user_name, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_id = wp_create_user( $user_name, $password, $email );&nbsp;</div></li><li><div>  if ( is_wp_error( $user_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Newly created users have no roles or caps until they are added to a blog.</span>&nbsp;</div></li><li><div>  delete_user_option( $user_id, 'capabilities' );&nbsp;</div></li><li><div>  delete_user_option( $user_id, 'user_level' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires immediately after a new user is created.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wpmu_new_user', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create a site.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function runs when a user self-registers a new site as well</span>&nbsp;</div></li><li><div><span class="comment"> * as when a Super Admin creates a new site. Hook to {@see 'wpmu_new_blog'}</span>&nbsp;</div></li><li><div><span class="comment"> * for events that should affect all new sites.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * On subdirectory installs, $domain is the same as the main site's</span>&nbsp;</div></li><li><div><span class="comment"> * domain, and the path is the subdirectory name (eg 'example.com'</span>&nbsp;</div></li><li><div><span class="comment"> * and '/blog1/'). On subdomain installs, $domain is the new subdomain +</span>&nbsp;</div></li><li><div><span class="comment"> * root domain (eg 'blog1.example.com'), and $path is '/'.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $domain  The new site's domain.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path    The new site's path.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title   The new site's title.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id The user ID of the new site's admin.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta    Optional. Used to set initial site options.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $site_id Optional. Only relevant on multi-network installs.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error Returns WP_Error object on failure, int $blog_id on success</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_create_blog( $domain, $path, $title, $user_id, $meta = array(), $site_id = 1 ) {&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'public' =&gt; 0, &nbsp;</div></li><li><div>      'WPLANG' =&gt; get_site_option( 'WPLANG' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  $meta = wp_parse_args( $meta, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $domain = preg_replace( '/\s+/', '', sanitize_user( $domain, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_subdomain_install() )&nbsp;</div></li><li><div>      $domain = str_replace( '@', '', $domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $title = strip_tags( $title );&nbsp;</div></li><li><div>  $user_id = (int) $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($path) )&nbsp;</div></li><li><div>      $path = '/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if the domain has been used already. We should return an error message.</span>&nbsp;</div></li><li><div>  if ( domain_exists($domain, $path, $site_id) )&nbsp;</div></li><li><div>      return new WP_Error( 'blog_taken', __( 'Sorry, that site already exists!' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_installing() ) {&nbsp;</div></li><li><div>      wp_installing( true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $blog_id = insert_blog($domain, $path, $site_id) )&nbsp;</div></li><li><div>      return new WP_Error('insert_blog', __('Could not create site.'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog($blog_id);&nbsp;</div></li><li><div>  install_blog($blog_id, $title);&nbsp;</div></li><li><div>  wp_install_defaults($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_user_to_blog($blog_id, $user_id, 'administrator');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $meta as $key =&gt; $value ) {&nbsp;</div></li><li><div>      if ( in_array( $key, array( 'public', 'archived', 'mature', 'spam', 'deleted', 'lang_id' ) ) )&nbsp;</div></li><li><div>          update_blog_status( $blog_id, $key, $value );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          update_option( $key, $value );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option( 'blog_public', (int) $meta['public'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_super_admin( $user_id ) && ! get_user_meta( $user_id, 'primary_blog', true ) )&nbsp;</div></li><li><div>      update_user_meta( $user_id, 'primary_blog', $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires immediately after a new site is created.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $domain  Site domain.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path    Site path.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $site_id Site ID. Only relevant on multi-network installs.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta    Meta data. Used to set initial site options.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wpmu_new_blog', $blog_id, $user_id, $domain, $path, $site_id, $meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_set( 'last_changed', microtime(), 'sites' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $blog_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notifies the network admin that a new site has been activated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'newblog_notify_siteadmin'} to change the content of</span>&nbsp;</div></li><li><div><span class="comment"> * the notification email.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id    The new site's ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $deprecated Not used.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function newblog_notify_siteadmin( $blog_id, $deprecated = '' ) {&nbsp;</div></li><li><div>  if ( get_site_option( 'registrationnotification' ) != 'yes' )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>  if ( is_email($email) == false )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $options_site_url = esc_url(network_admin_url('settings.php'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog( $blog_id );&nbsp;</div></li><li><div>  $blogname = get_option( 'blogname' );&nbsp;</div></li><li><div>  $siteurl = site_url();&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** translators: New site notification email. 1: Site URL, 2: User IP address, 3: Settings screen URL */</span>&nbsp;</div></li><li><div>  $msg = sprintf( __( 'New Site: %1$s&nbsp;</div></li><li><div>URL: %2$s&nbsp;</div></li><li><div>Remote IP: %3$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Disable these notifications: %4$s' ), $blogname, $siteurl, wp_unslash( $_SERVER['REMOTE_ADDR'] ), $options_site_url);&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the message body of the new site activation email sent</span>&nbsp;</div></li><li><div><span class="comment">   * to the network administrator.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $msg Email body.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $msg = apply_filters( 'newblog_notify_siteadmin', $msg );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_mail( $email, sprintf( __( 'New Site Registration: %s' ), $siteurl ), $msg );&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notifies the network admin that a new user has been activated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'newuser_notify_siteadmin'} to change the content of</span>&nbsp;</div></li><li><div><span class="comment"> * the notification email.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id The new user's ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function newuser_notify_siteadmin( $user_id ) {&nbsp;</div></li><li><div>  if ( get_site_option( 'registrationnotification' ) != 'yes' )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_email($email) == false )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $options_site_url = esc_url(network_admin_url('settings.php'));&nbsp;</div></li><li><div>  <span class="comment">/** translators: New user notification email. 1: User login, 2: User IP address, 3: Settings screen URL */</span>&nbsp;</div></li><li><div>  $msg = sprintf(__('New User: %1$s&nbsp;</div></li><li><div>Remote IP: %2$s&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Disable these notifications: %3$s'), $user-&gt;user_login, wp_unslash( $_SERVER['REMOTE_ADDR'] ), $options_site_url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the message body of the new user activation email sent</span>&nbsp;</div></li><li><div><span class="comment">   * to the network administrator.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $msg  Email body.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_User $user WP_User instance of the new user.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $msg = apply_filters( 'newuser_notify_siteadmin', $msg, $user );&nbsp;</div></li><li><div>  wp_mail( $email, sprintf(__('New User Registration: %s'), $user-&gt;user_login), $msg );&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether a blogname is already taken.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used during the new site registration process to ensure</span>&nbsp;</div></li><li><div><span class="comment"> * that each blogname is unique.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $domain  The domain to be checked.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path    The path to be checked.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $site_id Optional. Relevant only on multi-network installs.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function domain_exists($domain, $path, $site_id = 1) {&nbsp;</div></li><li><div>  $path = trailingslashit( $path );&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'network_id' =&gt; $site_id, &nbsp;</div></li><li><div>      'domain' =&gt; $domain, &nbsp;</div></li><li><div>      'path' =&gt; $path, &nbsp;</div></li><li><div>      'fields' =&gt; 'ids', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  $result = get_sites( $args );&nbsp;</div></li><li><div>  $result = array_shift( $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether a blogname is taken.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|null $result  The blog_id if the blogname exists, null otherwise.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $domain  Domain to be checked.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $path    Path to be checked.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int      $site_id Site ID. Relevant only on multi-network installs.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'domain_exists', $result, $domain, $path, $site_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Store basic site info in the blogs table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function creates a row in the wp_blogs table and returns</span>&nbsp;</div></li><li><div><span class="comment"> * the new blog's ID. It is the first step in creating a new blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $domain  The domain of the new site.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $path    The path of the new site.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $site_id Unless you're running a multi-network install, be sure to set this value to 1.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false The ID of the new row</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function insert_blog($domain, $path, $site_id) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $path = trailingslashit($path);&nbsp;</div></li><li><div>  $site_id = (int) $site_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = $wpdb-&gt;insert( $wpdb-&gt;blogs, array('site_id' =&gt; $site_id, 'domain' =&gt; $domain, 'path' =&gt; $path, 'registered' =&gt; current_time('mysql')) );&nbsp;</div></li><li><div>  if ( ! $result )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>  refresh_blog_details( $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_maybe_update_network_site_counts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $blog_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Install an empty blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Creates the new blog tables and options. If calling this function</span>&nbsp;</div></li><li><div><span class="comment"> * directly, be sure to use switch_to_blog() first, so that $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * points to the new blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb     $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Roles $wp_roles</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id    The value returned by insert_blog().</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blog_title The title of the new site.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function install_blog( $blog_id, $blog_title = '' ) {&nbsp;</div></li><li><div>  global $wpdb, $wp_roles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Cast for security</span>&nbsp;</div></li><li><div>  $blog_id = (int) $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $suppress = $wpdb-&gt;suppress_errors();&nbsp;</div></li><li><div>  if ( $wpdb-&gt;get_results( &quot;DESCRIBE {$wpdb-&gt;posts}&quot; ) )&nbsp;</div></li><li><div>      die( '&lt;h1&gt;' . __( 'Already Installed' ) . '&lt;/h1&gt;&lt;p&gt;' . __( 'You appear to have already installed WordPress. To reinstall please clear your old database tables first.' ) . '&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;' );&nbsp;</div></li><li><div>  $wpdb-&gt;suppress_errors( $suppress );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = get_blogaddress_by_id( $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set everything up</span>&nbsp;</div></li><li><div>  make_db_current_silent( 'blog' );&nbsp;</div></li><li><div>  populate_options();&nbsp;</div></li><li><div>  populate_roles();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// populate_roles() clears previous role definitions so we start over.</span>&nbsp;</div></li><li><div>  $wp_roles = new WP_Roles();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $siteurl = $home = untrailingslashit( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_subdomain_install() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>       if ( 'https' === parse_url( get_site_option( 'siteurl' ), PHP_URL_SCHEME ) ) {&nbsp;</div></li><li><div>           $siteurl = set_url_scheme( $siteurl, 'https' );&nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>       if ( 'https' === parse_url( get_home_url( get_network()-&gt;site_id ), PHP_URL_SCHEME ) ) {&nbsp;</div></li><li><div>           $home = set_url_scheme( $home, 'https' );&nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option( 'siteurl', $siteurl );&nbsp;</div></li><li><div>  update_option( 'home', $home );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_site_option( 'ms_files_rewriting' ) )&nbsp;</div></li><li><div>      update_option( 'upload_path', UPLOADBLOGSDIR . &quot;/$blog_id/files&quot; );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      update_option( 'upload_path', get_blog_option( get_network()-&gt;site_id, 'upload_path' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option( 'blogname', wp_unslash( $blog_title ) );&nbsp;</div></li><li><div>  update_option( 'admin_email', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// remove all perms</span>&nbsp;</div></li><li><div>  $table_prefix = $wpdb-&gt;get_blog_prefix();&nbsp;</div></li><li><div>  delete_metadata( 'user', 0, $table_prefix . 'user_level', null, true ); <span class="comment"><span class="comment">// delete all</span></span>&nbsp;</div></li><li><div>  delete_metadata( 'user', 0, $table_prefix . 'capabilities', null, true ); <span class="comment"><span class="comment">// delete all</span></span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set blog defaults.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function creates a row in the wp_blogs table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> * @deprecated MU</span>&nbsp;</div></li><li><div><span class="comment"> * @deprecated Use wp_install_defaults()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id Ignored in this function.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function install_blog_defaults($blog_id, $user_id) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $suppress = $wpdb-&gt;suppress_errors();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_install_defaults($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;suppress_errors( $suppress );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notify a user that their blog activation has been successful.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_welcome_notification'} to disable or bypass.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'update_welcome_email'} and {@see 'update_welcome_subject'} to</span>&nbsp;</div></li><li><div><span class="comment"> * modify the content and subject line of the notification email.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $password</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title    The new blog's title</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta     Optional. Not used in the default function, but is passed along to hooks for customization.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_welcome_notification( $blog_id, $user_id, $password, $title, $meta = array() ) {&nbsp;</div></li><li><div>  $current_network = get_network();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to bypass the welcome email after site activation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Returning false disables the welcome email.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|bool $blog_id  Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int      $user_id  User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $password User password.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string   $title    Site title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array    $meta     Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'wpmu_welcome_notification', $blog_id, $user_id, $password, $title, $meta ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $switched_locale = switch_to_locale( get_user_locale( $user ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $welcome_email = get_site_option( 'welcome_email' );&nbsp;</div></li><li><div>  if ( $welcome_email == false ) {&nbsp;</div></li><li><div>      <span class="comment">/** translators: Do not translate USERNAME, SITE_NAME, BLOG_URL, PASSWORD: those are placeholders. */</span>&nbsp;</div></li><li><div>      $welcome_email = __( 'Howdy USERNAME, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Your new SITE_NAME site has been successfully set up at:&nbsp;</div></li><li><div>BLOG_URL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>You can log in to the administrator account with the following information:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Username: USERNAME&nbsp;</div></li><li><div>Password: PASSWORD&nbsp;</div></li><li><div>Log in here: BLOG_URLwp-login.php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>We hope you enjoy your new site. Thanks!&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>--The Team @ SITE_NAME' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = get_blogaddress_by_id($blog_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'SITE_NAME', $current_network-&gt;site_name, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'BLOG_TITLE', $title, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'BLOG_URL', $url, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'USERNAME', $user-&gt;user_login, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'PASSWORD', $password, $welcome_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the content of the welcome email after site activation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Content should be formatted for transmission via wp_mail().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $welcome_email Message body of the email.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $blog_id       Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id       User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $password      User password.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $title         Site title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta          Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $welcome_email = apply_filters( 'update_welcome_email', $welcome_email, $blog_id, $user_id, $password, $title, $meta );&nbsp;</div></li><li><div>  $admin_email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $admin_email == '' )&nbsp;</div></li><li><div>      $admin_email = 'support@' . $_SERVER['SERVER_NAME'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $from_name = get_site_option( 'site_name' ) == '' ? 'WordPress' : esc_html( get_site_option( 'site_name' ) );&nbsp;</div></li><li><div>  $message_headers = &quot;From: \&quot;{$from_name}\&quot; &lt;{$admin_email}&gt;\n&quot; . &quot;Content-Type: text/plain; charset=\&quot;&quot; . get_option('blog_charset') . &quot;\&quot;\n&quot;;&nbsp;</div></li><li><div>  $message = $welcome_email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $current_network-&gt;site_name ) )&nbsp;</div></li><li><div>      $current_network-&gt;site_name = 'WordPress';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** translators: New site notification email subject. 1: Network name, 2: New site name */</span>&nbsp;</div></li><li><div>  $subject = __( 'New %1$s Site: %2$s' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the subject of the welcome email after site activation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $subject Subject of the email.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $subject = apply_filters( 'update_welcome_subject', sprintf( $subject, $current_network-&gt;site_name, wp_unslash( $title ) ) );&nbsp;</div></li><li><div>  wp_mail( $user-&gt;user_email, wp_specialchars_decode( $subject ), $message, $message_headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $switched_locale ) {&nbsp;</div></li><li><div>      restore_previous_locale();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Notify a user that their account activation has been successful.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'wpmu_welcome_user_notification'} to disable or bypass.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Filter {@see 'update_welcome_user_email'} and {@see 'update_welcome_user_subject'} to</span>&nbsp;</div></li><li><div><span class="comment"> * modify the content and subject line of the notification email.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $password</span>&nbsp;</div></li><li><div><span class="comment"> * @param array  $meta     Optional. Not used in the default function, but is passed along to hooks for customization.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_welcome_user_notification( $user_id, $password, $meta = array() ) {&nbsp;</div></li><li><div>  $current_network = get_network();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">    * Filters whether to bypass the welcome email after user activation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Returning false disables the welcome email.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id  User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $password User password.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta     Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'wpmu_welcome_user_notification', $user_id, $password, $meta ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $welcome_email = get_site_option( 'welcome_user_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $switched_locale = switch_to_locale( get_user_locale( $user ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the content of the welcome email after user activation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Content should be formatted for transmission via wp_mail().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $welcome_email The message body of the account activation success email.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $user_id       User ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $password      User password.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $meta          Signup meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $welcome_email = apply_filters( 'update_welcome_user_email', $welcome_email, $user_id, $password, $meta );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'SITE_NAME', $current_network-&gt;site_name, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'USERNAME', $user-&gt;user_login, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'PASSWORD', $password, $welcome_email );&nbsp;</div></li><li><div>  $welcome_email = str_replace( 'LOGINLINK', wp_login_url(), $welcome_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $admin_email = get_site_option( 'admin_email' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $admin_email == '' )&nbsp;</div></li><li><div>      $admin_email = 'support@' . $_SERVER['SERVER_NAME'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $from_name = get_site_option( 'site_name' ) == '' ? 'WordPress' : esc_html( get_site_option( 'site_name' ) );&nbsp;</div></li><li><div>  $message_headers = &quot;From: \&quot;{$from_name}\&quot; &lt;{$admin_email}&gt;\n&quot; . &quot;Content-Type: text/plain; charset=\&quot;&quot; . get_option('blog_charset') . &quot;\&quot;\n&quot;;&nbsp;</div></li><li><div>  $message = $welcome_email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $current_network-&gt;site_name ) )&nbsp;</div></li><li><div>      $current_network-&gt;site_name = 'WordPress';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** translators: New user notification email subject. 1: Network name, 2: New user login */</span></span>&nbsp;</div></li><li><div>  $subject = __( 'New %1$s User: %2$s' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the subject of the welcome email after user activation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $subject Subject of the email.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $subject = apply_filters( 'update_welcome_user_subject', sprintf( $subject, $current_network-&gt;site_name, $user-&gt;user_login) );&nbsp;</div></li><li><div>  wp_mail( $user-&gt;user_email, wp_specialchars_decode( $subject ), $message, $message_headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $switched_locale ) {&nbsp;</div></li><li><div>      restore_previous_locale();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the current network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns an object containing the 'id', 'domain', 'path', and 'site_name'</span>&nbsp;</div></li><li><div><span class="comment"> * properties of the network being viewed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see wpmu_current_site()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Network $current_site</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Network</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_current_site() {&nbsp;</div></li><li><div>  global $current_site;&nbsp;</div></li><li><div>  return $current_site;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a user's most recent post.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Walks through each of a user's blogs to find the post with</span>&nbsp;</div></li><li><div><span class="comment"> * the most recent post_date_gmt.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Contains the blog_id, post_id, post_date_gmt, and post_gmt_ts</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_most_recent_post_of_user( $user_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_blogs = get_blogs_of_user( (int) $user_id );&nbsp;</div></li><li><div>  $most_recent_post = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Walk through each blog and get the most recent post</span>&nbsp;</div></li><li><div>  <span class="comment">// published by $user_id</span>&nbsp;</div></li><li><div>  foreach ( (array) $user_blogs as $blog ) {&nbsp;</div></li><li><div>      $prefix = $wpdb-&gt;get_blog_prefix( $blog-&gt;userblog_id );&nbsp;</div></li><li><div>      $recent_post = $wpdb-&gt;get_row( $wpdb-&gt;prepare(&quot;SELECT ID, post_date_gmt FROM {$prefix}posts WHERE post_author = %d AND post_type = 'post' AND post_status = 'publish' ORDER BY post_date_gmt DESC LIMIT 1&quot;, $user_id ), ARRAY_A);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Make sure we found a post</span>&nbsp;</div></li><li><div>      if ( isset($recent_post['ID']) ) {&nbsp;</div></li><li><div>          $post_gmt_ts = strtotime($recent_post['post_date_gmt']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If this is the first post checked or if this post is</span>&nbsp;</div></li><li><div>          <span class="comment">// newer than the current recent post, make it the new</span>&nbsp;</div></li><li><div>          <span class="comment">// most recent post.</span>&nbsp;</div></li><li><div>          if ( !isset($most_recent_post['post_gmt_ts']) || ( $post_gmt_ts &gt; $most_recent_post['post_gmt_ts'] ) ) {&nbsp;</div></li><li><div>              $most_recent_post = array(&nbsp;</div></li><li><div>                  'blog_id' =&gt; $blog-&gt;userblog_id, &nbsp;</div></li><li><div>                  'post_id' =&gt; $recent_post['ID'], &nbsp;</div></li><li><div>                  'post_date_gmt' =&gt; $recent_post['post_date_gmt'], &nbsp;</div></li><li><div>                  'post_gmt_ts' =&gt; $post_gmt_ts&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $most_recent_post;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Misc functions</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the size of a directory.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * A helper function that is used primarily to check whether</span>&nbsp;</div></li><li><div><span class="comment"> * a blog has exceeded its allowed upload space.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $directory Full path of a directory.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Size of the directory in MB.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_dirsize( $directory ) {&nbsp;</div></li><li><div>  $dirsize = get_transient( 'dirsize_cache' );&nbsp;</div></li><li><div>  if ( is_array( $dirsize ) && isset( $dirsize[ $directory ][ 'size' ] ) )&nbsp;</div></li><li><div>      return $dirsize[ $directory ][ 'size' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $dirsize ) )&nbsp;</div></li><li><div>      $dirsize = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Exclude individual site directories from the total when checking the main site, </span>&nbsp;</div></li><li><div>  <span class="comment">// as they are subdirectories and should not be counted.</span>&nbsp;</div></li><li><div>  if ( is_main_site() ) {&nbsp;</div></li><li><div>      $dirsize[ $directory ][ 'size' ] = recurse_dirsize( $directory, $directory . '/sites' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $dirsize[ $directory ][ 'size' ] = recurse_dirsize( $directory );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  set_transient( 'dirsize_cache', $dirsize, HOUR_IN_SECONDS );&nbsp;</div></li><li><div>  return $dirsize[ $directory ][ 'size' ];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the size of a directory recursively.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Used by get_dirsize() to get a directory's size when it contains</span>&nbsp;</div></li><li><div><span class="comment"> * other directories.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.0 $exclude parameter added.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $directory Full path of a directory.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $exclude   Optional. Full path of a subdirectory to exclude from the total.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|false Size in MB if a valid directory. False if not.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function recurse_dirsize( $directory, $exclude = null ) {&nbsp;</div></li><li><div>  $size = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $directory = untrailingslashit( $directory );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! file_exists( $directory ) || ! is_dir( $directory ) || ! is_readable( $directory ) || $directory === $exclude ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ($handle = opendir($directory)) {&nbsp;</div></li><li><div>      while(($file = readdir($handle)) !== false) {&nbsp;</div></li><li><div>          $path = $directory.'/'.$file;&nbsp;</div></li><li><div>          if ($file != '.' && $file != '..') {&nbsp;</div></li><li><div>              if (is_file($path)) {&nbsp;</div></li><li><div>                  $size += filesize($path);&nbsp;</div></li><li><div>              } elseif (is_dir($path)) {&nbsp;</div></li><li><div>                  $handlesize = recurse_dirsize( $path, $exclude );&nbsp;</div></li><li><div>                  if ($handlesize &gt; 0)&nbsp;</div></li><li><div>                      $size += $handlesize;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      closedir($handle);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $size;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check an array of MIME types against a whitelist.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress ships with a set of allowed upload filetypes, </span>&nbsp;</div></li><li><div><span class="comment"> * which is defined in wp-includes/functions.php in</span>&nbsp;</div></li><li><div><span class="comment"> * get_allowed_mime_types(). This function is used to filter</span>&nbsp;</div></li><li><div><span class="comment"> * that list against the filetype whitelist provided by Multisite</span>&nbsp;</div></li><li><div><span class="comment"> * Super Admins at wp-admin/network/settings.php.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $mimes</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function check_upload_mimes( $mimes ) {&nbsp;</div></li><li><div>  $site_exts = explode( ' ', get_site_option( 'upload_filetypes', 'jpg jpeg png gif' ) );&nbsp;</div></li><li><div>  $site_mimes = array();&nbsp;</div></li><li><div>  foreach ( $site_exts as $ext ) {&nbsp;</div></li><li><div>      foreach ( $mimes as $ext_pattern =&gt; $mime ) {&nbsp;</div></li><li><div>          if ( $ext != '' && strpos( $ext_pattern, $ext ) !== false )&nbsp;</div></li><li><div>              $site_mimes[$ext_pattern] = $mime;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $site_mimes;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update a blog's post count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress MS stores a blog's post count as an option so as</span>&nbsp;</div></li><li><div><span class="comment"> * to avoid extraneous COUNTs when a blog's details are fetched</span>&nbsp;</div></li><li><div><span class="comment"> * with get_site(). This function is called when posts are published</span>&nbsp;</div></li><li><div><span class="comment"> * or unpublished to make sure the count stays current.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $deprecated Not used.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_posts_count( $deprecated = '' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  update_option( 'post_count', (int) $wpdb-&gt;get_var( &quot;SELECT COUNT(ID) FROM {$wpdb-&gt;posts} WHERE post_status = 'publish' and post_type = 'post'&quot; ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Logs user registrations.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_log_new_registrations( $blog_id, $user_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $user = get_userdata( (int) $user_id );&nbsp;</div></li><li><div>  if ( $user )&nbsp;</div></li><li><div>      $wpdb-&gt;insert( $wpdb-&gt;registration_log, array('email' =&gt; $user-&gt;user_email, 'IP' =&gt; preg_replace( '/[^0-9., ]/', '', wp_unslash( $_SERVER['REMOTE_ADDR'] ) ), 'blog_id' =&gt; $blog_id, 'date_registered' =&gt; current_time('mysql')) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Maintains a canonical list of terms by syncing terms created for each blog with the global terms table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see term_id_filter</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> * @staticvar int $global_terms_recurse</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $term_id    An ID for a term on the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $deprecated Not used.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int An ID from the global terms table mapped from $term_id.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function global_terms( $term_id, $deprecated = '' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  static $global_terms_recurse = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !global_terms_enabled() )&nbsp;</div></li><li><div>      return $term_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// prevent a race condition</span>&nbsp;</div></li><li><div>  $recurse_start = false;&nbsp;</div></li><li><div>  if ( $global_terms_recurse === null ) {&nbsp;</div></li><li><div>      $recurse_start = true;&nbsp;</div></li><li><div>      $global_terms_recurse = 1;&nbsp;</div></li><li><div>  } elseif ( 10 &lt; $global_terms_recurse++ ) {&nbsp;</div></li><li><div>      return $term_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $term_id = intval( $term_id );&nbsp;</div></li><li><div>  $c = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;terms WHERE term_id = %d&quot;, $term_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $global_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT cat_ID FROM $wpdb-&gt;sitecategories WHERE category_nicename = %s&quot;, $c-&gt;slug ) );&nbsp;</div></li><li><div>  if ( $global_id == null ) {&nbsp;</div></li><li><div>      $used_global_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT cat_ID FROM $wpdb-&gt;sitecategories WHERE cat_ID = %d&quot;, $c-&gt;term_id ) );&nbsp;</div></li><li><div>      if ( null == $used_global_id ) {&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;sitecategories, array( 'cat_ID' =&gt; $term_id, 'cat_name' =&gt; $c-&gt;name, 'category_nicename' =&gt; $c-&gt;slug ) );&nbsp;</div></li><li><div>          $global_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>          if ( empty( $global_id ) )&nbsp;</div></li><li><div>              return $term_id;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $max_global_id = $wpdb-&gt;get_var( &quot;SELECT MAX(cat_ID) FROM $wpdb-&gt;sitecategories&quot; );&nbsp;</div></li><li><div>          $max_local_id = $wpdb-&gt;get_var( &quot;SELECT MAX(term_id) FROM $wpdb-&gt;terms&quot; );&nbsp;</div></li><li><div>          $new_global_id = max( $max_global_id, $max_local_id ) + mt_rand( 100, 400 );&nbsp;</div></li><li><div>          $wpdb-&gt;insert( $wpdb-&gt;sitecategories, array( 'cat_ID' =&gt; $new_global_id, 'cat_name' =&gt; $c-&gt;name, 'category_nicename' =&gt; $c-&gt;slug ) );&nbsp;</div></li><li><div>          $global_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( $global_id != $term_id ) {&nbsp;</div></li><li><div>      $local_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT term_id FROM $wpdb-&gt;terms WHERE term_id = %d&quot;, $global_id ) );&nbsp;</div></li><li><div>      if ( null != $local_id ) {&nbsp;</div></li><li><div>          global_terms( $local_id );&nbsp;</div></li><li><div>          if ( 10 &lt; $global_terms_recurse ) {&nbsp;</div></li><li><div>              $global_id = $term_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $global_id != $term_id ) {&nbsp;</div></li><li><div>      if ( get_option( 'default_category' ) == $term_id )&nbsp;</div></li><li><div>          update_option( 'default_category', $global_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;terms, array('term_id' =&gt; $global_id), array('term_id' =&gt; $term_id) );&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;term_taxonomy, array('term_id' =&gt; $global_id), array('term_id' =&gt; $term_id) );&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;term_taxonomy, array('parent' =&gt; $global_id), array('parent' =&gt; $term_id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      clean_term_cache($term_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( $recurse_start )&nbsp;</div></li><li><div>      $global_terms_recurse = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $global_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ensure that the current site's domain is listed in the allowed redirect host list.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see wp_validate_redirect()</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|string $deprecated Not used.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The current site's domain</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function redirect_this_site( $deprecated = '' ) {&nbsp;</div></li><li><div>  return array( get_network()-&gt;domain );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether an upload is too big.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @blessed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $upload</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|array If the upload is under the size limit, $upload is returned. Otherwise returns an error message.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upload_is_file_too_big( $upload ) {&nbsp;</div></li><li><div>  if ( ! is_array( $upload ) || defined( 'WP_IMPORTING' ) || get_site_option( 'upload_space_check_disabled' ) )&nbsp;</div></li><li><div>      return $upload;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( strlen( $upload['bits'] )  &gt; ( KB_IN_BYTES * get_site_option( 'fileupload_maxk', 1500 ) ) ) {&nbsp;</div></li><li><div>      return sprintf( __( 'This file is too big. Files must be less than %d KB in size.' ) . '&lt;br /&gt;', get_site_option( 'fileupload_maxk', 1500 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $upload;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a nonce field to the signup page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function signup_nonce_fields() {&nbsp;</div></li><li><div>  $id = mt_rand();&nbsp;</div></li><li><div>  echo &quot;&lt;input type='hidden' name='signup_form_id' value='{$id}' /&gt;&quot;;&nbsp;</div></li><li><div>  wp_nonce_field('signup_form_' . $id, '_signup_form', false);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process the signup nonce created in signup_nonce_fields().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $result</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function signup_nonce_check( $result ) {&nbsp;</div></li><li><div>  if ( !strpos( $_SERVER[ 'PHP_SELF' ], 'wp-signup.php' ) )&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wp_create_nonce('signup_form_' . $_POST[ 'signup_form_id' ]) != $_POST['_signup_form'] )&nbsp;</div></li><li><div>      wp_die( __( 'Please try again.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Correct 404 redirects when NOBLOGREDIRECT is defined.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_redirect_404() {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the redirect URL for 404s on the main site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The filter is only evaluated if the NOBLOGREDIRECT constant is defined.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $no_blog_redirect The redirect URL defined in NOBLOGREDIRECT.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( is_main_site() && is_404() && defined( 'NOBLOGREDIRECT' ) && ( $destination = apply_filters( 'blog_redirect_404', NOBLOGREDIRECT ) ) ) {&nbsp;</div></li><li><div>      if ( $destination == '%siteurl%' )&nbsp;</div></li><li><div>          $destination = network_home_url();&nbsp;</div></li><li><div>      wp_redirect( $destination );&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a new user to a blog by visiting /newbloguser/username/.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This will only work when the user's details are saved as an option</span>&nbsp;</div></li><li><div><span class="comment"> * keyed as 'new_user_x', where 'x' is the username of the user to be</span>&nbsp;</div></li><li><div><span class="comment"> * added, as when a user is invited through the regular WP Add User interface.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function maybe_add_existing_user_to_blog() {&nbsp;</div></li><li><div>  if ( false === strpos( $_SERVER[ 'REQUEST_URI' ], '/newbloguser/' ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parts = explode( '/', $_SERVER[ 'REQUEST_URI' ] );&nbsp;</div></li><li><div>  $key = array_pop( $parts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $key == '' )&nbsp;</div></li><li><div>      $key = array_pop( $parts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $details = get_option( 'new_user_' . $key );&nbsp;</div></li><li><div>  if ( !empty( $details ) )&nbsp;</div></li><li><div>      delete_option( 'new_user_' . $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $details ) || is_wp_error( add_existing_user_to_blog( $details ) ) )&nbsp;</div></li><li><div>      wp_die( sprintf(__('An error occurred adding you to this site. Back to the &lt;a href=&quot;%s&quot;&gt;homepage&lt;/a&gt;.'), home_url() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( sprintf( __( 'You have been added to this site. Please visit the &lt;a href=&quot;%s&quot;&gt;homepage&lt;/a&gt; or &lt;a href=&quot;%s&quot;&gt;log in&lt;/a&gt; using your username and password.' ), home_url(), admin_url() ), __( 'WordPress &rsaquo; Success' ), array( 'response' =&gt; 200 ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a user to a blog based on details from maybe_add_existing_user_to_blog().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $details</span>&nbsp;</div></li><li><div><span class="comment"> * @return true|WP_Error|void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_existing_user_to_blog( $details = false ) {&nbsp;</div></li><li><div>  if ( is_array( $details ) ) {&nbsp;</div></li><li><div>      $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>      $result = add_user_to_blog( $blog_id, $details[ 'user_id' ], $details[ 'role' ] );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires immediately after an existing user is added to a site.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int   $user_id User ID.</span>&nbsp;</div></li><li><div><span class="comment">       * @param mixed $result  True on success or a WP_Error object if the user doesn't exist.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'added_existing_user', $details['user_id'], $result );&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds a newly created user to the appropriate blog</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * To add a user in general, use add_user_to_blog(). This function</span>&nbsp;</div></li><li><div><span class="comment"> * is specifically hooked into the {@see 'wpmu_activate_user'} action.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> * @see add_user_to_blog()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $user_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $password Ignored.</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $meta</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_new_user_to_blog( $user_id, $password, $meta ) {&nbsp;</div></li><li><div>  if ( !empty( $meta[ 'add_to_blog' ] ) ) {&nbsp;</div></li><li><div>      $blog_id = $meta[ 'add_to_blog' ];&nbsp;</div></li><li><div>      $role = $meta[ 'new_role' ];&nbsp;</div></li><li><div>      remove_user_from_blog($user_id, get_network()-&gt;site_id); <span class="comment">// remove user from main blog.</span>&nbsp;</div></li><li><div>      add_user_to_blog( $blog_id, $user_id, $role );&nbsp;</div></li><li><div>      update_user_meta( $user_id, 'primary_blog', $blog_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Correct From host on outgoing mail to match the site domain</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param PHPMailer $phpmailer The PHPMailer instance, passed by reference.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function fix_phpmailer_messageid( $phpmailer ) {&nbsp;</div></li><li><div>  $phpmailer-&gt;Hostname = get_network()-&gt;domain;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check to see whether a user is marked as a spammer, based on user login.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|WP_User $user Optional. Defaults to current user. WP_User object, </span>&nbsp;</div></li><li><div><span class="comment"> *                                or user login name as a string.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_user_spammy( $user = null ) {&nbsp;</div></li><li><div>  if ( ! ( $user instanceof WP_User ) ) {&nbsp;</div></li><li><div>      if ( $user ) {&nbsp;</div></li><li><div>          $user = get_user_by( 'login', $user );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $user = wp_get_current_user();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $user && isset( $user-&gt;spam ) && 1 == $user-&gt;spam;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update this blog's 'public' setting in the global blogs table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Public blogs have a setting of 1, private blogs are 0.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $old_value</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $value     The new public value</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_blog_public( $old_value, $value ) {&nbsp;</div></li><li><div>  update_blog_status( get_current_blog_id(), 'public', (int) $value );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether a usermeta key has to do with the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user_id Optional. Defaults to current user.</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id Optional. Defaults to current blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_user_option_local( $key, $user_id = 0, $blog_id = 0 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current_user = wp_get_current_user();&nbsp;</div></li><li><div>  if ( $blog_id == 0 ) {&nbsp;</div></li><li><div>      $blog_id = $wpdb-&gt;blogid;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $local_key = $wpdb-&gt;get_blog_prefix( $blog_id ) . $key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return isset( $current_user-&gt;$local_key );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check whether users can self-register, based on Network settings.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function users_can_register_signup_filter() {&nbsp;</div></li><li><div>  $registration = get_site_option('registration');&nbsp;</div></li><li><div>  return ( $registration == 'all' || $registration == 'user' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ensure that the welcome message is not empty. Currently unused.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $text</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function welcome_user_msg_filter( $text ) {&nbsp;</div></li><li><div>  if ( !$text ) {&nbsp;</div></li><li><div>      remove_filter( 'site_option_welcome_user_email', 'welcome_user_msg_filter' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** translators: Do not translate USERNAME, PASSWORD, LOGINLINK, SITE_NAME: those are placeholders. */</span>&nbsp;</div></li><li><div>      $text = __( 'Howdy USERNAME, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Your new account is set up.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>You can log in with the following information:&nbsp;</div></li><li><div>Username: USERNAME&nbsp;</div></li><li><div>Password: PASSWORD&nbsp;</div></li><li><div>LOGINLINK&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Thanks!&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>--The Team @ SITE_NAME' );&nbsp;</div></li><li><div>      update_site_option( 'welcome_user_email', $text );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $text;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Whether to force SSL on content.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.5</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @staticvar bool $forced_content</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $force</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if forced, false if not forced.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function force_ssl_content( $force = '' ) {&nbsp;</div></li><li><div>  static $forced_content = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( '' != $force ) {&nbsp;</div></li><li><div>      $old_forced = $forced_content;&nbsp;</div></li><li><div>      $forced_content = $force;&nbsp;</div></li><li><div>      return $old_forced;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $forced_content;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Formats a URL to use https.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Useful as a filter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.5</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url URL</span>&nbsp;</div></li><li><div><span class="comment"> * @return string URL with https as the scheme</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function filter_SSL( $url ) {&nbsp;</div></li><li><div>  if ( ! is_string( $url ) )&nbsp;</div></li><li><div>      return get_bloginfo( 'url' ); <span class="comment">// Return home blog url with proper scheme</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( force_ssl_content() && is_ssl() )&nbsp;</div></li><li><div>      $url = set_url_scheme( $url, 'https' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $url;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Schedule update of the network-wide counts for the current network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_schedule_update_network_counts() {&nbsp;</div></li><li><div>  if ( !is_main_site() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_next_scheduled('update_network_counts') && ! wp_installing() )&nbsp;</div></li><li><div>      wp_schedule_event(time(), 'twicedaily', 'update_network_counts');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *  Update the network-wide counts for the current network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *  @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_update_network_counts() {&nbsp;</div></li><li><div>  wp_update_network_user_counts();&nbsp;</div></li><li><div>  wp_update_network_site_counts();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the count of sites for the current network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If enabled through the {@see 'enable_live_network_counts'} filter, update the sites count</span>&nbsp;</div></li><li><div><span class="comment"> * on a network when a site is created or its status is updated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_maybe_update_network_site_counts() {&nbsp;</div></li><li><div>  $is_small_network = ! wp_is_large_network( 'sites' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters whether to update network site or user counts when a new site is created.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see wp_is_large_network()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $small_network Whether the network is considered small.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context       Context. Either 'users' or 'sites'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'enable_live_network_counts', $is_small_network, 'sites' ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_update_network_site_counts();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the network-wide users count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If enabled through the {@see 'enable_live_network_counts'} filter, update the users count</span>&nbsp;</div></li><li><div><span class="comment"> * on a network when a user is created or its status is updated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_maybe_update_network_user_counts() {&nbsp;</div></li><li><div>  $is_small_network = ! wp_is_large_network( 'users' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-functions.php */</span></span>&nbsp;</div></li><li><div>  if ( ! apply_filters( 'enable_live_network_counts', $is_small_network, 'users' ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_update_network_user_counts();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the network-wide site count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_update_network_site_counts() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = get_sites( array(&nbsp;</div></li><li><div>      'network_id' =&gt; $wpdb-&gt;siteid, &nbsp;</div></li><li><div>      'spam' =&gt; 0, &nbsp;</div></li><li><div>      'deleted' =&gt; 0, &nbsp;</div></li><li><div>      'archived' =&gt; 0, &nbsp;</div></li><li><div>      'count' =&gt; true, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_site_option( 'blog_count', $count );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the network-wide user count.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_update_network_user_counts() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = $wpdb-&gt;get_var( &quot;SELECT COUNT(ID) as c FROM $wpdb-&gt;users WHERE spam = '0' AND deleted = '0'&quot; );&nbsp;</div></li><li><div>  update_site_option( 'user_count', $count );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the space used by the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Used space in megabytes</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_space_used() {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the amount of storage space used by the current site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|bool $space_used The amount of used space, in megabytes. Default false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $space_used = apply_filters( 'pre_get_space_used', false );&nbsp;</div></li><li><div>  if ( false === $space_used ) {&nbsp;</div></li><li><div>      $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>      $space_used = get_dirsize( $upload_dir['basedir'] ) / MB_IN_BYTES;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $space_used;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the upload quota for the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Quota in megabytes</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_space_allowed() {&nbsp;</div></li><li><div>  $space_allowed = get_option( 'blog_upload_space' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_numeric( $space_allowed ) )&nbsp;</div></li><li><div>      $space_allowed = get_site_option( 'blog_upload_space' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_numeric( $space_allowed ) )&nbsp;</div></li><li><div>      $space_allowed = 100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the upload quota for the current site.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $space_allowed Upload quota in megabytes for the current blog.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'get_space_allowed', $space_allowed );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determines if there is any upload space left in the current blog's quota.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int of upload space available in bytes</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_upload_space_available() {&nbsp;</div></li><li><div>  $allowed = get_space_allowed();&nbsp;</div></li><li><div>  if ( $allowed &lt; 0 ) {&nbsp;</div></li><li><div>      $allowed = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $space_allowed = $allowed * MB_IN_BYTES;&nbsp;</div></li><li><div>  if ( get_site_option( 'upload_space_check_disabled' ) )&nbsp;</div></li><li><div>      return $space_allowed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $space_used = get_space_used() * MB_IN_BYTES;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( $space_allowed - $space_used ) &lt;= 0 )&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $space_allowed - $space_used;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determines if there is any upload space left in the current blog's quota.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if space is available, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_upload_space_available() {&nbsp;</div></li><li><div>  if ( get_site_option( 'upload_space_check_disabled' ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) get_upload_space_available();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filters the maximum upload file size allowed, in bytes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $size Upload size limit in bytes.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int       Upload size limit in bytes.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function upload_size_limit_filter( $size ) {&nbsp;</div></li><li><div>  $fileupload_maxk = KB_IN_BYTES * get_site_option( 'fileupload_maxk', 1500 );&nbsp;</div></li><li><div>  if ( get_site_option( 'upload_space_check_disabled' ) )&nbsp;</div></li><li><div>      return min( $size, $fileupload_maxk );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return min( $size, $fileupload_maxk, get_upload_space_available() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Whether or not we have a large network.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The default criteria for a large network is either more than 10, 000 users or more than 10, 000 sites.</span>&nbsp;</div></li><li><div><span class="comment"> * Plugins can alter this criteria using the {@see 'wp_is_large_network'} filter.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $using 'sites or 'users'. Default is 'sites'.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if the network meets the criteria for large. False otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_is_large_network( $using = 'sites' ) {&nbsp;</div></li><li><div>  if ( 'users' == $using ) {&nbsp;</div></li><li><div>      $count = get_user_count();&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters whether the network is considered large.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool   $is_large_network Whether the network has more than 10000 users or sites.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $component        The component to count. Accepts 'users', or 'sites'.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $count            The count of items for the component.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters( 'wp_is_large_network', $count &gt; 10000, 'users', $count );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = get_blog_count();&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-functions.php */</span></span>&nbsp;</div></li><li><div>  return apply_filters( 'wp_is_large_network', $count &gt; 10000, 'sites', $count );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves a list of reserved site on a sub-directory Multisite install.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $names Array of reserved subdirectory names.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_subdirectory_reserved_names() {&nbsp;</div></li><li><div>  $names = array(&nbsp;</div></li><li><div>      'page', 'comments', 'blog', 'files', 'feed', 'wp-admin', &nbsp;</div></li><li><div>      'wp-content', 'wp-includes', 'wp-json', 'embed'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters reserved site names on a sub-directory Multisite install.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0 'wp-admin', 'wp-content', 'wp-includes', 'wp-json', and 'embed' were added</span>&nbsp;</div></li><li><div><span class="comment">   *              to the reserved names list.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $subdirectory_reserved_names Array of reserved names.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'subdirectory_reserved_names', $names );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-include</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>