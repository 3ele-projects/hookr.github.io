<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="theme" data-version="3.7.2" data-slug="evolve" data-type="file" data-id="98421"><head xmlns="http://www.w3.org/1999/xhtml"><title> library-admin-redux-framework-inc-scssphp-scss-inc | file | Evolve | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, theme, evolve, 3.7.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3e4891b2226bbd7368dab9e5c5a19b25' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/library-admin-redux-framework-inc-scssphp-scss-inc/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Flibrary-admin-redux-framework-inc-scssphp-scss-inc%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Flibrary-admin-redux-framework-inc-scssphp-scss-inc%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"theme-evolve-3.7.2-file-library-admin-redux-framework-inc-scssphp-scss-inc","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="library-admin-redux-framework-inc-scssphp-scss-inc" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to themes." href="http://hookr.io/themes/" class=""><span property="name">themes</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to evolve." href="http://hookr.io/themes/evolve/" class="plugin"><span property="name">evolve</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.7.2." href="http://hookr.io/themes/evolve/3.7.2/" class="H_VERSION"><span property="name">3.7.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/themes/evolve/3.7.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">library-admin-redux-framework&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="742"><a href="http://hookr.io/themes/evolve/3.7.2/all/" title="All">All <span class="count badge">742</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/themes/evolve/3.7.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="473"><a href="http://hookr.io/themes/evolve/3.7.2/hooks/" title="Hooks">Hooks <span class="count badge">473</span></a></li><li class="" data-id="action" data-count="274"><a href="http://hookr.io/themes/evolve/3.7.2/actions/" title="Actions">Actions <span class="count badge">274</span></a></li><li class="" data-id="filter" data-count="199"><a href="http://hookr.io/themes/evolve/3.7.2/filters/" title="Filters">Filters <span class="count badge">199</span></a></li><li class="" data-id="class" data-count="123"><a href="http://hookr.io/themes/evolve/3.7.2/classes/" title="Classes">Classes <span class="count badge">123</span></a></li><li class="" data-id="constant" data-count="17"><a href="http://hookr.io/themes/evolve/3.7.2/constants/" title="Constants">Constants <span class="count badge">17</span></a></li><li class="" data-id="function" data-count="129"><a href="http://hookr.io/themes/evolve/3.7.2/functions/" title="Functions">Functions <span class="count badge">129</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/themes/evolve/3.7.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class="active"><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/library/admin/redux-framework/inc/scssphp/scss.inc.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS compiler written in PHP</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright 2012-2013 Leaf Corcoran</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @license http://opensource.org/licenses/gpl-license GPL-3.0</span>&nbsp;</div></li><li><div><span class="comment"> * @license http://opensource.org/licenses/MIT MIT</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @link http://leafo.net/scssphp</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The scss compiler and parser.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Converting SCSS to CSS is a three stage process. The incoming file is parsed</span>&nbsp;</div></li><li><div><span class="comment"> * by `scss_parser` into a syntax tree, then it is compiled into another tree</span>&nbsp;</div></li><li><div><span class="comment"> * representing the CSS structure by `scssc`. The CSS tree is fed into a</span>&nbsp;</div></li><li><div><span class="comment"> * formatter, like `scss_formatter` which then outputs CSS as a string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * During the first compile, all values are *reduced*, which means that their</span>&nbsp;</div></li><li><div><span class="comment"> * types are brought to the lowest form before being dump as strings. This</span>&nbsp;</div></li><li><div><span class="comment"> * handles math equations, variable dereferences, and the like.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `parse` function of `scssc` is the entry point.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * In summary:</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `scssc` class creates an instance of the parser, feeds it SCSS code, </span>&nbsp;</div></li><li><div><span class="comment"> * then transforms the resulting tree to a CSS tree. This class also holds the</span>&nbsp;</div></li><li><div><span class="comment"> * evaluation context, such as all available mixins and variables at any given</span>&nbsp;</div></li><li><div><span class="comment"> * time.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `scss_parser` class is only concerned with parsing its input.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The `scss_formatter` takes a CSS tree, and dumps it to a formatted string, </span>&nbsp;</div></li><li><div><span class="comment"> * handling things like indentation.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS compiler</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class scssc {&nbsp;</div></li><li><div>  static public $VERSION = 'v0.0.12';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $operatorNames = array(&nbsp;</div></li><li><div>      '+' =&gt; &quot;add&quot;, &nbsp;</div></li><li><div>      '-' =&gt; &quot;sub&quot;, &nbsp;</div></li><li><div>      '*' =&gt; &quot;mul&quot;, &nbsp;</div></li><li><div>      '/' =&gt; &quot;div&quot;, &nbsp;</div></li><li><div>      '%' =&gt; &quot;mod&quot;, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      '==' =&gt; &quot;eq&quot;, &nbsp;</div></li><li><div>      '!=' =&gt; &quot;neq&quot;, &nbsp;</div></li><li><div>      '&lt;' =&gt; &quot;lt&quot;, &nbsp;</div></li><li><div>      '&gt;' =&gt; &quot;gt&quot;, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      '&lt;=' =&gt; &quot;lte&quot;, &nbsp;</div></li><li><div>      '&gt;=' =&gt; &quot;gte&quot;, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $namespaces = array(&nbsp;</div></li><li><div>      &quot;special&quot; =&gt; &quot;%&quot;, &nbsp;</div></li><li><div>      &quot;mixin&quot; =&gt; &quot;@&quot;, &nbsp;</div></li><li><div>      &quot;function&quot; =&gt; &quot;^&quot;, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $unitTable = array(&nbsp;</div></li><li><div>      &quot;in&quot; =&gt; array(&nbsp;</div></li><li><div>          &quot;in&quot; =&gt; 1, &nbsp;</div></li><li><div>          &quot;pt&quot; =&gt; 72, &nbsp;</div></li><li><div>          &quot;pc&quot; =&gt; 6, &nbsp;</div></li><li><div>          &quot;cm&quot; =&gt; 2.54, &nbsp;</div></li><li><div>          &quot;mm&quot; =&gt; 25.4, &nbsp;</div></li><li><div>          &quot;px&quot; =&gt; 96, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public $true = array(&quot;keyword&quot;, &quot;true&quot;);&nbsp;</div></li><li><div>  static public $false = array(&quot;keyword&quot;, &quot;false&quot;);&nbsp;</div></li><li><div>  static public $null = array(&quot;null&quot;);&nbsp;</div></li><li><div>  static public $parent = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static public $defaultValue = array(&quot;keyword&quot;, &quot;&quot;);&nbsp;</div></li><li><div>  static public $selfSelector = array(&quot;self&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $importPaths = array(&quot;&quot;);&nbsp;</div></li><li><div>  protected $importCache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $userFunctions = array();&nbsp;</div></li><li><div>  protected $registeredVars = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $numberPrecision = 5;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $formatter = &quot;scss_formatter_nested&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Compile scss</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $code</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function compile($code, $name = null)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;indentLevel = -1;&nbsp;</div></li><li><div>      $this-&gt;commentsSeen = array();&nbsp;</div></li><li><div>      $this-&gt;extends = array();&nbsp;</div></li><li><div>      $this-&gt;extendsMap = array();&nbsp;</div></li><li><div>      $this-&gt;parsedFiles = array();&nbsp;</div></li><li><div>      $this-&gt;env = null;&nbsp;</div></li><li><div>      $this-&gt;scope = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $locale = setlocale(LC_NUMERIC, 0);&nbsp;</div></li><li><div>      setlocale(LC_NUMERIC, &quot;C&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;parser = new scss_parser($name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tree = $this-&gt;parser-&gt;parse($code);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;formatter = new $this-&gt;formatter();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;pushEnv($tree);&nbsp;</div></li><li><div>      $this-&gt;injectVariables($this-&gt;registeredVars);&nbsp;</div></li><li><div>      $this-&gt;compileRoot($tree);&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $this-&gt;formatter-&gt;format($this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      setlocale(LC_NUMERIC, $locale);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function isSelfExtend($target, $origin) {&nbsp;</div></li><li><div>      foreach ($origin as $sel) {&nbsp;</div></li><li><div>          if (in_array($target, $sel)) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function pushExtends($target, $origin) {&nbsp;</div></li><li><div>      if ($this-&gt;isSelfExtend($target, $origin)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $i = count($this-&gt;extends);&nbsp;</div></li><li><div>      $this-&gt;extends[] = array($target, $origin);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($target as $part) {&nbsp;</div></li><li><div>          if (isset($this-&gt;extendsMap[$part])) {&nbsp;</div></li><li><div>              $this-&gt;extendsMap[$part][] = $i;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;extendsMap[$part] = array($i);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function makeOutputBlock($type, $selectors = null) {&nbsp;</div></li><li><div>      $out = new stdClass;&nbsp;</div></li><li><div>      $out-&gt;type = $type;&nbsp;</div></li><li><div>      $out-&gt;lines = array();&nbsp;</div></li><li><div>      $out-&gt;children = array();&nbsp;</div></li><li><div>      $out-&gt;parent = $this-&gt;scope;&nbsp;</div></li><li><div>      $out-&gt;selectors = $selectors;&nbsp;</div></li><li><div>      $out-&gt;depth = $this-&gt;env-&gt;depth;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function matchExtendsSingle($single, &$outOrigin) {&nbsp;</div></li><li><div>      $counts = array();&nbsp;</div></li><li><div>      foreach ($single as $part) {&nbsp;</div></li><li><div>          if (!is_string($part)) return false; <span class="comment">// hmm</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($this-&gt;extendsMap[$part])) {&nbsp;</div></li><li><div>              foreach ($this-&gt;extendsMap[$part] as $idx) {&nbsp;</div></li><li><div>                  $counts[$idx] =&nbsp;</div></li><li><div>                      isset($counts[$idx]) ? $counts[$idx] + 1 : 1;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $outOrigin = array();&nbsp;</div></li><li><div>      $found = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($counts as $idx =&gt; $count) {&nbsp;</div></li><li><div>          list($target, $origin) = $this-&gt;extends[$idx];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// check count</span>&nbsp;</div></li><li><div>          if ($count != count($target)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// check if target is subset of single</span>&nbsp;</div></li><li><div>          if (array_diff(array_intersect($single, $target), $target)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $rem = array_diff($single, $target);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($origin as $j =&gt; $new) {&nbsp;</div></li><li><div>              <span class="comment">// prevent infinite loop when target extends itself</span>&nbsp;</div></li><li><div>              foreach ($new as $new_selector) {&nbsp;</div></li><li><div>                  if (!array_diff($single, $new_selector)) {&nbsp;</div></li><li><div>                      continue 2;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $origin[$j][count($origin[$j]) - 1] = $this-&gt;combineSelectorSingle(end($new), $rem);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $outOrigin = array_merge($outOrigin, $origin);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $found = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $found;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function combineSelectorSingle($base, $other) {&nbsp;</div></li><li><div>      $tag = null;&nbsp;</div></li><li><div>      $out = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach (array($base, $other) as $single) {&nbsp;</div></li><li><div>          foreach ($single as $part) {&nbsp;</div></li><li><div>              if (preg_match('/^[^\[.#:]/', $part)) {&nbsp;</div></li><li><div>                  $tag = $part;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $out[] = $part;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($tag) {&nbsp;</div></li><li><div>          array_unshift($out, $tag);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function matchExtends($selector, &$out, $from = 0, $initial=true) {&nbsp;</div></li><li><div>      foreach ($selector as $i =&gt; $part) {&nbsp;</div></li><li><div>          if ($i &lt; $from) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;matchExtendsSingle($part, $origin)) {&nbsp;</div></li><li><div>              $before = array_slice($selector, 0, $i);&nbsp;</div></li><li><div>              $after = array_slice($selector, $i + 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ($origin as $new) {&nbsp;</div></li><li><div>                  $k = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// remove shared parts</span>&nbsp;</div></li><li><div>                  if ($initial) {&nbsp;</div></li><li><div>                      foreach ($before as $k =&gt; $val) {&nbsp;</div></li><li><div>                          if (!isset($new[$k]) || $val != $new[$k]) {&nbsp;</div></li><li><div>                              break;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $result = array_merge(&nbsp;</div></li><li><div>                      $before, &nbsp;</div></li><li><div>                      $k &gt; 0 ? array_slice($new, $k) : $new, &nbsp;</div></li><li><div>                      $after);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($result == $selector) continue;&nbsp;</div></li><li><div>                  $out[] = $result;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// recursively check for more matches</span>&nbsp;</div></li><li><div>                  $this-&gt;matchExtends($result, $out, $i, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// selector sequence merging</span>&nbsp;</div></li><li><div>                  if (!empty($before) && count($new) &gt; 1) {&nbsp;</div></li><li><div>                      $result2 = array_merge(&nbsp;</div></li><li><div>                          array_slice($new, 0, -1), &nbsp;</div></li><li><div>                          $k &gt; 0 ? array_slice($before, $k) : $before, &nbsp;</div></li><li><div>                          array_slice($new, -1), &nbsp;</div></li><li><div>                          $after);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $out[] = $result2;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function flattenSelectors($block, $parentKey = null) {&nbsp;</div></li><li><div>      if ($block-&gt;selectors) {&nbsp;</div></li><li><div>          $selectors = array();&nbsp;</div></li><li><div>          foreach ($block-&gt;selectors as $s) {&nbsp;</div></li><li><div>              $selectors[] = $s;&nbsp;</div></li><li><div>              if (!is_array($s)) continue;&nbsp;</div></li><li><div>              <span class="comment">// check extends</span>&nbsp;</div></li><li><div>              if (!empty($this-&gt;extendsMap)) {&nbsp;</div></li><li><div>                  $this-&gt;matchExtends($s, $selectors);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $block-&gt;selectors = array();&nbsp;</div></li><li><div>          $placeholderSelector = false;&nbsp;</div></li><li><div>          foreach ($selectors as $selector) {&nbsp;</div></li><li><div>              if ($this-&gt;hasSelectorPlaceholder($selector)) {&nbsp;</div></li><li><div>                  $placeholderSelector = true;&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $block-&gt;selectors[] = $this-&gt;compileSelector($selector);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($placeholderSelector && 0 == count($block-&gt;selectors) && null !== $parentKey) {&nbsp;</div></li><li><div>              unset($block-&gt;parent-&gt;children[$parentKey]);&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($block-&gt;children as $key =&gt; $child) {&nbsp;</div></li><li><div>          $this-&gt;flattenSelectors($child, $key);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileRoot($rootBlock)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;makeOutputBlock('root');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;compileChildren($rootBlock-&gt;children, $this-&gt;scope);&nbsp;</div></li><li><div>      $this-&gt;flattenSelectors($this-&gt;scope);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileMedia($media) {&nbsp;</div></li><li><div>      $this-&gt;pushEnv($media);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $mediaQuery = $this-&gt;compileMediaQuery($this-&gt;multiplyMedia($this-&gt;env));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($mediaQuery)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;scope = $this-&gt;makeOutputBlock(&quot;media&quot;, array($mediaQuery));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parentScope = $this-&gt;mediaParent($this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parentScope-&gt;children[] = $this-&gt;scope;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// top level properties in a media cause it to be wrapped</span>&nbsp;</div></li><li><div>          $needsWrap = false;&nbsp;</div></li><li><div>          foreach ($media-&gt;children as $child) {&nbsp;</div></li><li><div>              $type = $child[0];&nbsp;</div></li><li><div>              if ($type !== 'block' && $type !== 'media' && $type !== 'directive') {&nbsp;</div></li><li><div>                  $needsWrap = true;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($needsWrap) {&nbsp;</div></li><li><div>              $wrapped = (object)array(&nbsp;</div></li><li><div>                  &quot;selectors&quot; =&gt; array(), &nbsp;</div></li><li><div>                  &quot;children&quot; =&gt; $media-&gt;children&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $media-&gt;children = array(array(&quot;block&quot;, $wrapped));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;compileChildren($media-&gt;children, $this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;scope = $this-&gt;scope-&gt;parent;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaParent($scope) {&nbsp;</div></li><li><div>      while (!empty($scope-&gt;parent)) {&nbsp;</div></li><li><div>          if (!empty($scope-&gt;type) && $scope-&gt;type != &quot;media&quot;) {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $scope = $scope-&gt;parent;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $scope;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// TODO refactor compileNestedBlock and compileMedia into same thing</span>&nbsp;</div></li><li><div>  protected function compileNestedBlock($block, $selectors) {&nbsp;</div></li><li><div>      $this-&gt;pushEnv($block);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;makeOutputBlock($block-&gt;type, $selectors);&nbsp;</div></li><li><div>      $this-&gt;scope-&gt;parent-&gt;children[] = $this-&gt;scope;&nbsp;</div></li><li><div>      $this-&gt;compileChildren($block-&gt;children, $this-&gt;scope);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;scope = $this-&gt;scope-&gt;parent;&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Recursively compiles a block.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * A block is analogous to a CSS block in most cases. A single SCSS document</span>&nbsp;</div></li><li><div><span class="comment">   * is encapsulated in a block when parsed, but it does not have parent tags</span>&nbsp;</div></li><li><div><span class="comment">   * so all of its children appear on the root level when compiled.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Blocks are made up of selectors and children.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The children of a block are just all the blocks that are defined within.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Compiling the block involves pushing a fresh environment on the stack, </span>&nbsp;</div></li><li><div><span class="comment">   * and iterating through the props, compiling each one.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see scss::compileChild()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param \StdClass $block</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function compileBlock($block) {&nbsp;</div></li><li><div>      $env = $this-&gt;pushEnv($block);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $env-&gt;selectors =&nbsp;</div></li><li><div>          array_map(array($this, &quot;evalSelector&quot;), $block-&gt;selectors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $this-&gt;makeOutputBlock(null, $this-&gt;multiplySelectors($env));&nbsp;</div></li><li><div>      $this-&gt;scope-&gt;children[] = $out;&nbsp;</div></li><li><div>      $this-&gt;compileChildren($block-&gt;children, $out);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;popEnv();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// joins together .classes and #ids</span>&nbsp;</div></li><li><div>  protected function flattenSelectorSingle($single) {&nbsp;</div></li><li><div>      $joined = array();&nbsp;</div></li><li><div>      foreach ($single as $part) {&nbsp;</div></li><li><div>          if (empty($joined) ||&nbsp;</div></li><li><div>              !is_string($part) ||&nbsp;</div></li><li><div>              preg_match('/[\[.:#%]/', $part))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $joined[] = $part;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (is_array(end($joined))) {&nbsp;</div></li><li><div>              $joined[] = $part;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $joined[count($joined) - 1] .= $part;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $joined;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// replaces all the interpolates</span>&nbsp;</div></li><li><div>  protected function evalSelector($selector) {&nbsp;</div></li><li><div>      return array_map(array($this, &quot;evalSelectorPart&quot;), $selector);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function evalSelectorPart($piece) {&nbsp;</div></li><li><div>      foreach ($piece as &$p) {&nbsp;</div></li><li><div>          if (!is_array($p)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ($p[0]) {&nbsp;</div></li><li><div>          case &quot;interpolate&quot;:&nbsp;</div></li><li><div>              $p = $this-&gt;compileValue($p);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case &quot;string&quot;:&nbsp;</div></li><li><div>              $p = $this-&gt;compileValue($p);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;flattenSelectorSingle($piece);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// compiles to string</span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// self</span>(&) should have been replaced by now</span>&nbsp;</div></li><li><div>  protected function compileSelector($selector) {&nbsp;</div></li><li><div>      if (!is_array($selector)) return $selector; <span class="comment">// media and the like</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return implode(&quot; &quot;, array_map(&nbsp;</div></li><li><div>          array($this, &quot;compileSelectorPart&quot;), $selector));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileSelectorPart($piece) {&nbsp;</div></li><li><div>      foreach ($piece as &$p) {&nbsp;</div></li><li><div>          if (!is_array($p)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ($p[0]) {&nbsp;</div></li><li><div>          case &quot;self&quot;:&nbsp;</div></li><li><div>              $p = &quot;&&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $p = $this-&gt;compileValue($p);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return implode($piece);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function hasSelectorPlaceholder($selector)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!is_array($selector)) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($selector as $parts) {&nbsp;</div></li><li><div>          foreach ($parts as $part) {&nbsp;</div></li><li><div>              if ('%' == $part[0]) {&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileChildren($stms, $out) {&nbsp;</div></li><li><div>      foreach ($stms as $stm) {&nbsp;</div></li><li><div>          $ret = $this-&gt;compileChild($stm, $out);&nbsp;</div></li><li><div>          if (isset($ret)) return $ret;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileMediaQuery($queryList) {&nbsp;</div></li><li><div>      $out = &quot;@media&quot;;&nbsp;</div></li><li><div>      $first = true;&nbsp;</div></li><li><div>      foreach ($queryList as $query) {&nbsp;</div></li><li><div>          $type = null;&nbsp;</div></li><li><div>          $parts = array();&nbsp;</div></li><li><div>          foreach ($query as $q) {&nbsp;</div></li><li><div>              switch ($q[0]) {&nbsp;</div></li><li><div>                  case &quot;mediaType&quot;:&nbsp;</div></li><li><div>                      if ($type) {&nbsp;</div></li><li><div>                          $type = $this-&gt;mergeMediaTypes($type, array_map(array($this, &quot;compileValue&quot;), array_slice($q, 1)));&nbsp;</div></li><li><div>                          if (empty($type)) { <span class="comment">// merge failed</span>&nbsp;</div></li><li><div>                              return null;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $type = array_map(array($this, &quot;compileValue&quot;), array_slice($q, 1));&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case &quot;mediaExp&quot;:&nbsp;</div></li><li><div>                      if (isset($q[2])) {&nbsp;</div></li><li><div>                          $parts[] = &quot;(&quot;. $this-&gt;compileValue($q[1]) . $this-&gt;formatter-&gt;assignSeparator . $this-&gt;compileValue($q[2]) . &quot;)&quot;;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $parts[] = &quot;(&quot; . $this-&gt;compileValue($q[1]) . &quot;)&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($type) {&nbsp;</div></li><li><div>              array_unshift($parts, implode(' ', array_filter($type)));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!empty($parts)) {&nbsp;</div></li><li><div>              if ($first) {&nbsp;</div></li><li><div>                  $first = false;&nbsp;</div></li><li><div>                  $out .= &quot; &quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $out .= $this-&gt;formatter-&gt;tagSeparator;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $out .= implode(&quot; and &quot;, $parts);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mergeMediaTypes($type1, $type2) {&nbsp;</div></li><li><div>      if (empty($type1)) {&nbsp;</div></li><li><div>          return $type2;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (empty($type2)) {&nbsp;</div></li><li><div>          return $type1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $m1 = '';&nbsp;</div></li><li><div>      $t1 = '';&nbsp;</div></li><li><div>      if (count($type1) &gt; 1) {&nbsp;</div></li><li><div>          $m1= strtolower($type1[0]);&nbsp;</div></li><li><div>          $t1= strtolower($type1[1]);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $t1 = strtolower($type1[0]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $m2 = '';&nbsp;</div></li><li><div>      $t2 = '';&nbsp;</div></li><li><div>      if (count($type2) &gt; 1) {&nbsp;</div></li><li><div>          $m2 = strtolower($type2[0]);&nbsp;</div></li><li><div>          $t2 = strtolower($type2[1]);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $t2 = strtolower($type2[0]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (($m1 == 'not') ^ ($m2 == 'not')) {&nbsp;</div></li><li><div>          if ($t1 == $t2) {&nbsp;</div></li><li><div>              return null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              $m1 == 'not' ? $m2 : $m1, &nbsp;</div></li><li><div>              $m1 == 'not' ? $t2 : $t1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } elseif ($m1 == 'not' && $m2 == 'not') {&nbsp;</div></li><li><div>          # CSS has no way of representing &quot;neither screen nor print&quot;&nbsp;</div></li><li><div>          if ($t1 != $t2) {&nbsp;</div></li><li><div>              return null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return array('not', $t1);&nbsp;</div></li><li><div>      } elseif ($t1 != $t2) {&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      } else { <span class="comment">// t1 == t2, neither m1 nor m2 are &quot;not&quot;</span>&nbsp;</div></li><li><div>          return array(empty($m1)? $m2 : $m1, $t1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// returns true if the value was something that could be imported</span>&nbsp;</div></li><li><div>  protected function compileImport($rawPath, $out) {&nbsp;</div></li><li><div>      if ($rawPath[0] == &quot;string&quot;) {&nbsp;</div></li><li><div>          $path = $this-&gt;compileStringContent($rawPath);&nbsp;</div></li><li><div>          if ($path = $this-&gt;findImport($path)) {&nbsp;</div></li><li><div>              $this-&gt;importFile($path, $out);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($rawPath[0] == &quot;list&quot;) {&nbsp;</div></li><li><div>          <span class="comment">// handle a list of strings</span>&nbsp;</div></li><li><div>          if (count($rawPath[2]) == 0) return false;&nbsp;</div></li><li><div>          foreach ($rawPath[2] as $path) {&nbsp;</div></li><li><div>              if ($path[0] != &quot;string&quot;) return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($rawPath[2] as $path) {&nbsp;</div></li><li><div>              $this-&gt;compileImport($path, $out);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// return a value to halt execution</span>&nbsp;</div></li><li><div>  protected function compileChild($child, $out) {&nbsp;</div></li><li><div>      $this-&gt;sourcePos = isset($child[-1]) ? $child[-1] : -1;&nbsp;</div></li><li><div>      $this-&gt;sourceParser = isset($child[-2]) ? $child[-2] : $this-&gt;parser;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ($child[0]) {&nbsp;</div></li><li><div>      case &quot;import&quot;:&nbsp;</div></li><li><div>          list(, $rawPath) = $child;&nbsp;</div></li><li><div>          $rawPath = $this-&gt;reduce($rawPath);&nbsp;</div></li><li><div>          if (!$this-&gt;compileImport($rawPath, $out)) {&nbsp;</div></li><li><div>              $out-&gt;lines[] = &quot;@import &quot; . $this-&gt;compileValue($rawPath) . &quot;;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;directive&quot;:&nbsp;</div></li><li><div>          list(, $directive) = $child;&nbsp;</div></li><li><div>          $s = &quot;@&quot; . $directive-&gt;name;&nbsp;</div></li><li><div>          if (!empty($directive-&gt;value)) {&nbsp;</div></li><li><div>              $s .= &quot; &quot; . $this-&gt;compileValue($directive-&gt;value);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;compileNestedBlock($directive, array($s));&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;media&quot;:&nbsp;</div></li><li><div>          $this-&gt;compileMedia($child[1]);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;block&quot;:&nbsp;</div></li><li><div>          $this-&gt;compileBlock($child[1]);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;charset&quot;:&nbsp;</div></li><li><div>          $out-&gt;lines[] = &quot;@charset &quot;.$this-&gt;compileValue($child[1]).&quot;;&quot;;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;assign&quot;:&nbsp;</div></li><li><div>          list(, $name, $value) = $child;&nbsp;</div></li><li><div>          if ($name[0] == &quot;var&quot;) {&nbsp;</div></li><li><div>              $isDefault = !empty($child[3]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($isDefault) {&nbsp;</div></li><li><div>                  $existingValue = $this-&gt;get($name[1], true);&nbsp;</div></li><li><div>                  $shouldSet = $existingValue === true || $existingValue == self::$null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!$isDefault || $shouldSet) {&nbsp;</div></li><li><div>                  $this-&gt;set($name[1], $this-&gt;reduce($value));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// if the value reduces to null from something else then</span>&nbsp;</div></li><li><div>          <span class="comment">// the property should be discarded</span>&nbsp;</div></li><li><div>          if ($value[0] != &quot;null&quot;) {&nbsp;</div></li><li><div>              $value = $this-&gt;reduce($value);&nbsp;</div></li><li><div>              if ($value[0] == &quot;null&quot;) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $compiledValue = $this-&gt;compileValue($value);&nbsp;</div></li><li><div>          $out-&gt;lines[] = $this-&gt;formatter-&gt;property(&nbsp;</div></li><li><div>              $this-&gt;compileValue($name), &nbsp;</div></li><li><div>              $compiledValue);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;comment&quot;:&nbsp;</div></li><li><div>          $out-&gt;lines[] = $child[1];&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;mixin&quot;:&nbsp;</div></li><li><div>      case &quot;function&quot;:&nbsp;</div></li><li><div>          list(, $block) = $child;&nbsp;</div></li><li><div>          $this-&gt;set(self::$namespaces[$block-&gt;type] . $block-&gt;name, $block);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;extend&quot;:&nbsp;</div></li><li><div>          list(, $selectors) = $child;&nbsp;</div></li><li><div>          foreach ($selectors as $sel) {&nbsp;</div></li><li><div>              <span class="comment">// only use the first one</span>&nbsp;</div></li><li><div>              $sel = current($this-&gt;evalSelector($sel));&nbsp;</div></li><li><div>              $this-&gt;pushExtends($sel, $out-&gt;selectors);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;if&quot;:&nbsp;</div></li><li><div>          list(, $if) = $child;&nbsp;</div></li><li><div>          if ($this-&gt;isTruthy($this-&gt;reduce($if-&gt;cond, true))) {&nbsp;</div></li><li><div>              return $this-&gt;compileChildren($if-&gt;children, $out);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              foreach ($if-&gt;cases as $case) {&nbsp;</div></li><li><div>                  if ($case-&gt;type == &quot;else&quot; ||&nbsp;</div></li><li><div>                      $case-&gt;type == &quot;elseif&quot; && $this-&gt;isTruthy($this-&gt;reduce($case-&gt;cond)))&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      return $this-&gt;compileChildren($case-&gt;children, $out);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;return&quot;:&nbsp;</div></li><li><div>          return $this-&gt;reduce($child[1], true);&nbsp;</div></li><li><div>      case &quot;each&quot;:&nbsp;</div></li><li><div>          list(, $each) = $child;&nbsp;</div></li><li><div>          $list = $this-&gt;coerceList($this-&gt;reduce($each-&gt;list));&nbsp;</div></li><li><div>          foreach ($list[2] as $item) {&nbsp;</div></li><li><div>              $this-&gt;pushEnv();&nbsp;</div></li><li><div>              $this-&gt;set($each-&gt;var, $item);&nbsp;</div></li><li><div>              <span class="comment">// TODO: allow return from here</span>&nbsp;</div></li><li><div>              $this-&gt;compileChildren($each-&gt;children, $out);&nbsp;</div></li><li><div>              $this-&gt;popEnv();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;while&quot;:&nbsp;</div></li><li><div>          list(, $while) = $child;&nbsp;</div></li><li><div>          while ($this-&gt;isTruthy($this-&gt;reduce($while-&gt;cond, true))) {&nbsp;</div></li><li><div>              $ret = $this-&gt;compileChildren($while-&gt;children, $out);&nbsp;</div></li><li><div>              if ($ret) return $ret;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;for&quot;:&nbsp;</div></li><li><div>          list(, $for) = $child;&nbsp;</div></li><li><div>          $start = $this-&gt;reduce($for-&gt;start, true);&nbsp;</div></li><li><div>          $start = $start[1];&nbsp;</div></li><li><div>          $end = $this-&gt;reduce($for-&gt;end, true);&nbsp;</div></li><li><div>          $end = $end[1];&nbsp;</div></li><li><div>          $d = $start &lt; $end ? 1 : -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          while (true) {&nbsp;</div></li><li><div>              if ((!$for-&gt;until && $start - $d == $end) ||&nbsp;</div></li><li><div>                  ($for-&gt;until && $start == $end))&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;set($for-&gt;var, array(&quot;number&quot;, $start, &quot;&quot;));&nbsp;</div></li><li><div>              $start += $d;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ret = $this-&gt;compileChildren($for-&gt;children, $out);&nbsp;</div></li><li><div>              if ($ret) return $ret;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;nestedprop&quot;:&nbsp;</div></li><li><div>          list(, $prop) = $child;&nbsp;</div></li><li><div>          $prefixed = array();&nbsp;</div></li><li><div>          $prefix = $this-&gt;compileValue($prop-&gt;prefix) . &quot;-&quot;;&nbsp;</div></li><li><div>          foreach ($prop-&gt;children as $child) {&nbsp;</div></li><li><div>              if ($child[0] == &quot;assign&quot;) {&nbsp;</div></li><li><div>                  array_unshift($child[1][2], $prefix);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($child[0] == &quot;nestedprop&quot;) {&nbsp;</div></li><li><div>                  array_unshift($child[1]-&gt;prefix[2], $prefix);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $prefixed[] = $child;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;compileChildren($prefixed, $out);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;include&quot;: <span class="comment">// including a mixin</span>&nbsp;</div></li><li><div>          list(, $name, $argValues, $content) = $child;&nbsp;</div></li><li><div>          $mixin = $this-&gt;get(self::$namespaces[&quot;mixin&quot;] . $name, false);&nbsp;</div></li><li><div>          if (!$mixin) {&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;Undefined mixin $name&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $callingScope = $this-&gt;env;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// push scope, apply args</span>&nbsp;</div></li><li><div>          $this-&gt;pushEnv();&nbsp;</div></li><li><div>          if ($this-&gt;env-&gt;depth &gt; 0) {&nbsp;</div></li><li><div>              $this-&gt;env-&gt;depth--;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($content)) {&nbsp;</div></li><li><div>              $content-&gt;scope = $callingScope;&nbsp;</div></li><li><div>              $this-&gt;setRaw(self::$namespaces[&quot;special&quot;] . &quot;content&quot;, $content);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($mixin-&gt;args)) {&nbsp;</div></li><li><div>              $this-&gt;applyArguments($mixin-&gt;args, $argValues);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($mixin-&gt;children as $child) {&nbsp;</div></li><li><div>              $this-&gt;compileChild($child, $out);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;popEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;mixin_content&quot;:&nbsp;</div></li><li><div>          $content = $this-&gt;get(self::$namespaces[&quot;special&quot;] . &quot;content&quot;);&nbsp;</div></li><li><div>          if (!isset($content)) {&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;Expected @content inside of mixin&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $strongTypes = array('include', 'block', 'for', 'while');&nbsp;</div></li><li><div>          foreach ($content-&gt;children as $child) {&nbsp;</div></li><li><div>              $this-&gt;storeEnv = (in_array($child[0], $strongTypes))&nbsp;</div></li><li><div>                  ? null&nbsp;</div></li><li><div>                  : $content-&gt;scope;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;compileChild($child, $out);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          unset($this-&gt;storeEnv);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case &quot;debug&quot;:&nbsp;</div></li><li><div>          list(, $value, $pos) = $child;&nbsp;</div></li><li><div>          $line = $this-&gt;parser-&gt;getLineNo($pos);&nbsp;</div></li><li><div>          $value = $this-&gt;compileValue($this-&gt;reduce($value, true));&nbsp;</div></li><li><div>          <span class="comment">//fwrite(STDERR, &quot;Line $line DEBUG: $value\n&quot;);</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;unknown child type: $child[0]&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function expToString($exp) {&nbsp;</div></li><li><div>      list(, $op, $left, $right, $inParens, $whiteLeft, $whiteRight) = $exp;&nbsp;</div></li><li><div>      $content = array($this-&gt;reduce($left));&nbsp;</div></li><li><div>      if ($whiteLeft) $content[] = &quot; &quot;;&nbsp;</div></li><li><div>      $content[] = $op;&nbsp;</div></li><li><div>      if ($whiteRight) $content[] = &quot; &quot;;&nbsp;</div></li><li><div>      $content[] = $this-&gt;reduce($right);&nbsp;</div></li><li><div>      return array(&quot;string&quot;, &quot;&quot;, $content);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function isTruthy($value) {&nbsp;</div></li><li><div>      return $value != self::$false && $value != self::$null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// should $value cause its operand to eval</span>&nbsp;</div></li><li><div>  protected function shouldEval($value) {&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case &quot;exp&quot;:&nbsp;</div></li><li><div>          if ($value[1] == &quot;/&quot;) {&nbsp;</div></li><li><div>              return $this-&gt;shouldEval($value[2], $value[3]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      case &quot;var&quot;:&nbsp;</div></li><li><div>      case &quot;fncall&quot;:&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function reduce($value, $inExp = false) {&nbsp;</div></li><li><div>      list($type) = $value;&nbsp;</div></li><li><div>      switch ($type) {&nbsp;</div></li><li><div>          case &quot;exp&quot;:&nbsp;</div></li><li><div>              list(, $op, $left, $right, $inParens) = $value;&nbsp;</div></li><li><div>              $opName = isset(self::$operatorNames[$op]) ? self::$operatorNames[$op] : $op;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $inExp = $inExp || $this-&gt;shouldEval($left) || $this-&gt;shouldEval($right);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $left = $this-&gt;reduce($left, true);&nbsp;</div></li><li><div>              $right = $this-&gt;reduce($right, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// only do division in special cases</span>&nbsp;</div></li><li><div>              if ($opName == &quot;div&quot; && !$inParens && !$inExp) {&nbsp;</div></li><li><div>                  if ($left[0] != &quot;color&quot; && $right[0] != &quot;color&quot;) {&nbsp;</div></li><li><div>                      return $this-&gt;expToString($value);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $left = $this-&gt;coerceForExpression($left);&nbsp;</div></li><li><div>              $right = $this-&gt;coerceForExpression($right);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ltype = $left[0];&nbsp;</div></li><li><div>              $rtype = $right[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// this tries:</span>&nbsp;</div></li><li><div>              <span class="comment">// 1. op_[op name]_[left type]_[right type]</span>&nbsp;</div></li><li><div>              <span class="comment">// 2. op_[left type]_[right type] (passing the op as first arg</span>&nbsp;</div></li><li><div>              <span class="comment">// 3. op_[op name]</span>&nbsp;</div></li><li><div>              $fn = &quot;op_${opName}_${ltype}_${rtype}&quot;;&nbsp;</div></li><li><div>              if (is_callable(array($this, $fn)) ||&nbsp;</div></li><li><div>                  (($fn = &quot;op_${ltype}_${rtype}&quot;) &&&nbsp;</div></li><li><div>                      is_callable(array($this, $fn)) &&&nbsp;</div></li><li><div>                      $passOp = true) ||&nbsp;</div></li><li><div>                  (($fn = &quot;op_${opName}&quot;) &&&nbsp;</div></li><li><div>                      is_callable(array($this, $fn)) &&&nbsp;</div></li><li><div>                      $genOp = true))&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $unitChange = false;&nbsp;</div></li><li><div>                  if (!isset($genOp) &&&nbsp;</div></li><li><div>                      $left[0] == &quot;number&quot; && $right[0] == &quot;number&quot;)&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      if ($opName == &quot;mod&quot; && $right[2] != &quot;&quot;) {&nbsp;</div></li><li><div>                          $this-&gt;throwError(&quot;Cannot modulo by a number with units: $right[1]$right[2].&quot;);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $unitChange = true;&nbsp;</div></li><li><div>                      $emptyUnit = $left[2] == &quot;&quot; || $right[2] == &quot;&quot;;&nbsp;</div></li><li><div>                      $targetUnit = &quot;&quot; != $left[2] ? $left[2] : $right[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($opName != &quot;mul&quot;) {&nbsp;</div></li><li><div>                          $left[2] = &quot;&quot; != $left[2] ? $left[2] : $targetUnit;&nbsp;</div></li><li><div>                          $right[2] = &quot;&quot; != $right[2] ? $right[2] : $targetUnit;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($opName != &quot;mod&quot;) {&nbsp;</div></li><li><div>                          $left = $this-&gt;normalizeNumber($left);&nbsp;</div></li><li><div>                          $right = $this-&gt;normalizeNumber($right);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($opName == &quot;div&quot; && !$emptyUnit && $left[2] == $right[2]) {&nbsp;</div></li><li><div>                          $targetUnit = &quot;&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($opName == &quot;mul&quot;) {&nbsp;</div></li><li><div>                          $left[2] = &quot;&quot; != $left[2] ? $left[2] : $right[2];&nbsp;</div></li><li><div>                          $right[2] = &quot;&quot; != $right[2] ? $right[2] : $left[2];&nbsp;</div></li><li><div>                      } elseif ($opName == &quot;div&quot; && $left[2] == $right[2]) {&nbsp;</div></li><li><div>                          $left[2] = &quot;&quot;;&nbsp;</div></li><li><div>                          $right[2] = &quot;&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $shouldEval = $inParens || $inExp;&nbsp;</div></li><li><div>                  if (isset($passOp)) {&nbsp;</div></li><li><div>                      $out = $this-&gt;$fn($op, $left, $right, $shouldEval);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $out = $this-&gt;$fn($left, $right, $shouldEval);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if (isset($out)) {&nbsp;</div></li><li><div>                      if ($unitChange && $out[0] == &quot;number&quot;) {&nbsp;</div></li><li><div>                          $out = $this-&gt;coerceUnit($out, $targetUnit);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      return $out;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $this-&gt;expToString($value);&nbsp;</div></li><li><div>          case &quot;unary&quot;:&nbsp;</div></li><li><div>              list(, $op, $exp, $inParens) = $value;&nbsp;</div></li><li><div>              $inExp = $inExp || $this-&gt;shouldEval($exp);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $exp = $this-&gt;reduce($exp);&nbsp;</div></li><li><div>              if ($exp[0] == &quot;number&quot;) {&nbsp;</div></li><li><div>                  switch ($op) {&nbsp;</div></li><li><div>                  case &quot;+&quot;:&nbsp;</div></li><li><div>                      return $exp;&nbsp;</div></li><li><div>                  case &quot;-&quot;:&nbsp;</div></li><li><div>                      $exp[1] *= -1;&nbsp;</div></li><li><div>                      return $exp;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($op == &quot;not&quot;) {&nbsp;</div></li><li><div>                  if ($inExp || $inParens) {&nbsp;</div></li><li><div>                      if ($exp == self::$false) {&nbsp;</div></li><li><div>                          return self::$true;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          return self::$false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $op = $op . &quot; &quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return array(&quot;string&quot;, &quot;&quot;, array($op, $exp));&nbsp;</div></li><li><div>          case &quot;var&quot;:&nbsp;</div></li><li><div>              list(, $name) = $value;&nbsp;</div></li><li><div>              return $this-&gt;reduce($this-&gt;get($name));&nbsp;</div></li><li><div>          case &quot;list&quot;:&nbsp;</div></li><li><div>              foreach ($value[2] as &$item) {&nbsp;</div></li><li><div>                  $item = $this-&gt;reduce($item);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $value;&nbsp;</div></li><li><div>          case &quot;string&quot;:&nbsp;</div></li><li><div>              foreach ($value[2] as &$item) {&nbsp;</div></li><li><div>                  if (is_array($item)) {&nbsp;</div></li><li><div>                      $item = $this-&gt;reduce($item);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $value;&nbsp;</div></li><li><div>          case &quot;interpolate&quot;:&nbsp;</div></li><li><div>              $value[1] = $this-&gt;reduce($value[1]);&nbsp;</div></li><li><div>              return $value;&nbsp;</div></li><li><div>          case &quot;fncall&quot;:&nbsp;</div></li><li><div>              list(, $name, $argValues) = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// user defined function?</span>&nbsp;</div></li><li><div>              $func = $this-&gt;get(self::$namespaces[&quot;function&quot;] . $name, false);&nbsp;</div></li><li><div>              if ($func) {&nbsp;</div></li><li><div>                  $this-&gt;pushEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// set the args</span>&nbsp;</div></li><li><div>                  if (isset($func-&gt;args)) {&nbsp;</div></li><li><div>                      $this-&gt;applyArguments($func-&gt;args, $argValues);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// throw away lines and children</span>&nbsp;</div></li><li><div>                  $tmp = (object)array(&nbsp;</div></li><li><div>                      &quot;lines&quot; =&gt; array(), &nbsp;</div></li><li><div>                      &quot;children&quot; =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  $ret = $this-&gt;compileChildren($func-&gt;children, $tmp);&nbsp;</div></li><li><div>                  $this-&gt;popEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return !isset($ret) ? self::$defaultValue : $ret;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// built in function</span>&nbsp;</div></li><li><div>              if ($this-&gt;callBuiltin($name, $argValues, $returnValue)) {&nbsp;</div></li><li><div>                  return $returnValue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// need to flatten the arguments into a list</span>&nbsp;</div></li><li><div>              $listArgs = array();&nbsp;</div></li><li><div>              foreach ((array)$argValues as $arg) {&nbsp;</div></li><li><div>                  if (empty($arg[0])) {&nbsp;</div></li><li><div>                      $listArgs[] = $this-&gt;reduce($arg[1]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return array(&quot;function&quot;, $name, array(&quot;list&quot;, &quot;, &quot;, $listArgs));&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function normalizeValue($value) {&nbsp;</div></li><li><div>      $value = $this-&gt;coerceForExpression($this-&gt;reduce($value));&nbsp;</div></li><li><div>      list($type) = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ($type) {&nbsp;</div></li><li><div>      case &quot;list&quot;:&nbsp;</div></li><li><div>          $value = $this-&gt;extractInterpolation($value);&nbsp;</div></li><li><div>          if ($value[0] != &quot;list&quot;) {&nbsp;</div></li><li><div>              return array(&quot;keyword&quot;, $this-&gt;compileValue($value));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          foreach ($value[2] as $key =&gt; $item) {&nbsp;</div></li><li><div>              $value[2][$key] = $this-&gt;normalizeValue($item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      case &quot;number&quot;:&nbsp;</div></li><li><div>          return $this-&gt;normalizeNumber($value);&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// just does physical lengths for now</span>&nbsp;</div></li><li><div>  protected function normalizeNumber($number) {&nbsp;</div></li><li><div>      list(, $value, $unit) = $number;&nbsp;</div></li><li><div>      if (isset(self::$unitTable[&quot;in&quot;][$unit])) {&nbsp;</div></li><li><div>          $conv = self::$unitTable[&quot;in&quot;][$unit];&nbsp;</div></li><li><div>          return array(&quot;number&quot;, $value / $conv, &quot;in&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $number;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// $number should be normalized</span>&nbsp;</div></li><li><div>  protected function coerceUnit($number, $unit) {&nbsp;</div></li><li><div>      list(, $value, $baseUnit) = $number;&nbsp;</div></li><li><div>      if (isset(self::$unitTable[$baseUnit][$unit])) {&nbsp;</div></li><li><div>          $value = $value * self::$unitTable[$baseUnit][$unit];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $value, $unit);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_add_number_number($left, $right) {&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $left[1] + $right[1], $left[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_mul_number_number($left, $right) {&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $left[1] * $right[1], $left[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_sub_number_number($left, $right) {&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $left[1] - $right[1], $left[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_div_number_number($left, $right) {&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $left[1] / $right[1], $left[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_mod_number_number($left, $right) {&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $left[1] % $right[1], $left[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// adding strings</span>&nbsp;</div></li><li><div>  protected function op_add($left, $right) {&nbsp;</div></li><li><div>      if ($strLeft = $this-&gt;coerceString($left)) {&nbsp;</div></li><li><div>          if ($right[0] == &quot;string&quot;) {&nbsp;</div></li><li><div>              $right[1] = &quot;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $strLeft[2][] = $right;&nbsp;</div></li><li><div>          return $strLeft;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($strRight = $this-&gt;coerceString($right)) {&nbsp;</div></li><li><div>          if ($left[0] == &quot;string&quot;) {&nbsp;</div></li><li><div>              $left[1] = &quot;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          array_unshift($strRight[2], $left);&nbsp;</div></li><li><div>          return $strRight;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_and($left, $right, $shouldEval) {&nbsp;</div></li><li><div>      if (!$shouldEval) return;&nbsp;</div></li><li><div>      if ($left != self::$false) return $right;&nbsp;</div></li><li><div>      return $left;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_or($left, $right, $shouldEval) {&nbsp;</div></li><li><div>      if (!$shouldEval) return;&nbsp;</div></li><li><div>      if ($left != self::$false) return $left;&nbsp;</div></li><li><div>      return $right;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_color_color($op, $left, $right) {&nbsp;</div></li><li><div>      $out = array('color');&nbsp;</div></li><li><div>      foreach (range(1, 3) as $i) {&nbsp;</div></li><li><div>          $lval = isset($left[$i]) ? $left[$i] : 0;&nbsp;</div></li><li><div>          $rval = isset($right[$i]) ? $right[$i] : 0;&nbsp;</div></li><li><div>          switch ($op) {&nbsp;</div></li><li><div>          case '+':&nbsp;</div></li><li><div>              $out[] = $lval + $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '-':&nbsp;</div></li><li><div>              $out[] = $lval - $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '*':&nbsp;</div></li><li><div>              $out[] = $lval * $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '%':&nbsp;</div></li><li><div>              $out[] = $lval % $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '/':&nbsp;</div></li><li><div>              if ($rval == 0) {&nbsp;</div></li><li><div>                  $this-&gt;throwError(&quot;color: Can't divide by zero&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $out[] = $lval / $rval;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case &quot;==&quot;:&nbsp;</div></li><li><div>              return $this-&gt;op_eq($left, $right);&nbsp;</div></li><li><div>          case &quot;!=&quot;:&nbsp;</div></li><li><div>              return $this-&gt;op_neq($left, $right);&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;color: unknown op $op&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($left[4])) $out[4] = $left[4];&nbsp;</div></li><li><div>      elseif (isset($right[4])) $out[4] = $right[4];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;fixColor($out);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_color_number($op, $left, $right) {&nbsp;</div></li><li><div>      $value = $right[1];&nbsp;</div></li><li><div>      return $this-&gt;op_color_color($op, $left, &nbsp;</div></li><li><div>          array(&quot;color&quot;, $value, $value, $value));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_number_color($op, $left, $right) {&nbsp;</div></li><li><div>      $value = $left[1];&nbsp;</div></li><li><div>      return $this-&gt;op_color_color($op, &nbsp;</div></li><li><div>          array(&quot;color&quot;, $value, $value, $value), $right);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_eq($left, $right) {&nbsp;</div></li><li><div>      if (($lStr = $this-&gt;coerceString($left)) && ($rStr = $this-&gt;coerceString($right))) {&nbsp;</div></li><li><div>          $lStr[1] = &quot;&quot;;&nbsp;</div></li><li><div>          $rStr[1] = &quot;&quot;;&nbsp;</div></li><li><div>          return $this-&gt;toBool($this-&gt;compileValue($lStr) == $this-&gt;compileValue($rStr));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;toBool($left == $right);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_neq($left, $right) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($left != $right);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_gte_number_number($left, $right) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($left[1] &gt;= $right[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_gt_number_number($left, $right) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($left[1] &gt; $right[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_lte_number_number($left, $right) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($left[1] &lt;= $right[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function op_lt_number_number($left, $right) {&nbsp;</div></li><li><div>      return $this-&gt;toBool($left[1] &lt; $right[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function toBool($thing) {&nbsp;</div></li><li><div>      return $thing ? self::$true : self::$false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Compiles a primitive value into a CSS property value.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Values in scssphp are typed by being wrapped in arrays, their format is</span>&nbsp;</div></li><li><div><span class="comment">   * typically:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   *     array(type, contents [, additional_contents]*)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The input is expected to be reduced. This function will not work on</span>&nbsp;</div></li><li><div><span class="comment">   * things like expressions and variables.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function compileValue($value) {&nbsp;</div></li><li><div>      $value = $this-&gt;reduce($value);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list($type) = $value;&nbsp;</div></li><li><div>      switch ($type) {&nbsp;</div></li><li><div>      case &quot;keyword&quot;:&nbsp;</div></li><li><div>          return $value[1];&nbsp;</div></li><li><div>      case &quot;color&quot;:&nbsp;</div></li><li><div>          <span class="comment">// [1] - red component (either number for a %)</span>&nbsp;</div></li><li><div>          <span class="comment">// [2] - green component</span>&nbsp;</div></li><li><div>          <span class="comment">// [3] - blue component</span>&nbsp;</div></li><li><div>          <span class="comment">// [4] - optional alpha component</span>&nbsp;</div></li><li><div>          list(, $r, $g, $b) = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $r = round($r);&nbsp;</div></li><li><div>          $g = round($g);&nbsp;</div></li><li><div>          $b = round($b);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (count($value) == 5 && $value[4] != 1) { <span class="comment">// rgba</span>&nbsp;</div></li><li><div>              return 'rgba('.$r.', '.$g.', '.$b.', '.$value[4].')';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $h = sprintf(&quot;#%02x%02x%02x&quot;, $r, $g, $b);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Converting hex color to short notation (e.g. #003399 to #039)</span>&nbsp;</div></li><li><div>          if ($h[1] === $h[2] && $h[3] === $h[4] && $h[5] === $h[6]) {&nbsp;</div></li><li><div>              $h = '#' . $h[1] . $h[3] . $h[5];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $h;&nbsp;</div></li><li><div>      case &quot;number&quot;:&nbsp;</div></li><li><div>          return round($value[1], $this-&gt;numberPrecision) . $value[2];&nbsp;</div></li><li><div>      case &quot;string&quot;:&nbsp;</div></li><li><div>          return $value[1] . $this-&gt;compileStringContent($value) . $value[1];&nbsp;</div></li><li><div>      case &quot;function&quot;:&nbsp;</div></li><li><div>          $args = !empty($value[2]) ? $this-&gt;compileValue($value[2]) : &quot;&quot;;&nbsp;</div></li><li><div>          return &quot;$value[1]($args)&quot;;&nbsp;</div></li><li><div>      case &quot;list&quot;:&nbsp;</div></li><li><div>          $value = $this-&gt;extractInterpolation($value);&nbsp;</div></li><li><div>          if ($value[0] != &quot;list&quot;) return $this-&gt;compileValue($value);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          list(, $delim, $items) = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $filtered = array();&nbsp;</div></li><li><div>          foreach ($items as $item) {&nbsp;</div></li><li><div>              if ($item[0] == &quot;null&quot;) continue;&nbsp;</div></li><li><div>              $filtered[] = $this-&gt;compileValue($item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return implode(&quot;$delim &quot;, $filtered);&nbsp;</div></li><li><div>      case &quot;interpolated&quot;: # node created by extractInterpolation&nbsp;</div></li><li><div>          list(, $interpolate, $left, $right) = $value;&nbsp;</div></li><li><div>          list(, , $whiteLeft, $whiteRight) = $interpolate;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $left = count($left[2]) &gt; 0 ?&nbsp;</div></li><li><div>              $this-&gt;compileValue($left).$whiteLeft : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $right = count($right[2]) &gt; 0 ?&nbsp;</div></li><li><div>              $whiteRight.$this-&gt;compileValue($right) : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $left.$this-&gt;compileValue($interpolate).$right;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case &quot;interpolate&quot;: # raw parse node&nbsp;</div></li><li><div>          list(, $exp) = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// strip quotes if it's a string</span>&nbsp;</div></li><li><div>          $reduced = $this-&gt;reduce($exp);&nbsp;</div></li><li><div>          switch ($reduced[0]) {&nbsp;</div></li><li><div>              case &quot;string&quot;:&nbsp;</div></li><li><div>                  $reduced = array(&quot;keyword&quot;, &nbsp;</div></li><li><div>                      $this-&gt;compileStringContent($reduced));&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case &quot;null&quot;:&nbsp;</div></li><li><div>                  $reduced = array(&quot;keyword&quot;, &quot;&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $this-&gt;compileValue($reduced);&nbsp;</div></li><li><div>      case &quot;null&quot;:&nbsp;</div></li><li><div>          return &quot;null&quot;;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;unknown value type: $type&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function compileStringContent($string) {&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>      foreach ($string[2] as $part) {&nbsp;</div></li><li><div>          if (is_array($part)) {&nbsp;</div></li><li><div>              $parts[] = $this-&gt;compileValue($part);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $parts[] = $part;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return implode($parts);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// doesn't need to be recursive, compileValue will handle that</span>&nbsp;</div></li><li><div>  protected function extractInterpolation($list) {&nbsp;</div></li><li><div>      $items = $list[2];&nbsp;</div></li><li><div>      foreach ($items as $i =&gt; $item) {&nbsp;</div></li><li><div>          if ($item[0] == &quot;interpolate&quot;) {&nbsp;</div></li><li><div>              $before = array(&quot;list&quot;, $list[1], array_slice($items, 0, $i));&nbsp;</div></li><li><div>              $after = array(&quot;list&quot;, $list[1], array_slice($items, $i + 1));&nbsp;</div></li><li><div>              return array(&quot;interpolated&quot;, $item, $before, $after);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $list;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// find the final set of selectors</span>&nbsp;</div></li><li><div>  protected function multiplySelectors($env) {&nbsp;</div></li><li><div>      $envs = array();&nbsp;</div></li><li><div>      while (null !== $env) {&nbsp;</div></li><li><div>          if (!empty($env-&gt;selectors)) {&nbsp;</div></li><li><div>              $envs[] = $env;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $env = $env-&gt;parent;&nbsp;</div></li><li><div>      };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $selectors = array();&nbsp;</div></li><li><div>      $parentSelectors = array(array());&nbsp;</div></li><li><div>      while ($env = array_pop($envs)) {&nbsp;</div></li><li><div>          $selectors = array();&nbsp;</div></li><li><div>          foreach ($env-&gt;selectors as $selector) {&nbsp;</div></li><li><div>              foreach ($parentSelectors as $parent) {&nbsp;</div></li><li><div>                  $selectors[] = $this-&gt;joinSelectors($parent, $selector);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $parentSelectors = $selectors;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $selectors;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// looks for & to replace, or append parent before child</span>&nbsp;</div></li><li><div>  protected function joinSelectors($parent, $child) {&nbsp;</div></li><li><div>      $setSelf = false;&nbsp;</div></li><li><div>      $out = array();&nbsp;</div></li><li><div>      foreach ($child as $part) {&nbsp;</div></li><li><div>          $newPart = array();&nbsp;</div></li><li><div>          foreach ($part as $p) {&nbsp;</div></li><li><div>              if ($p == self::$selfSelector) {&nbsp;</div></li><li><div>                  $setSelf = true;&nbsp;</div></li><li><div>                  foreach ($parent as $i =&gt; $parentPart) {&nbsp;</div></li><li><div>                      if ($i &gt; 0) {&nbsp;</div></li><li><div>                          $out[] = $newPart;&nbsp;</div></li><li><div>                          $newPart = array();&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ($parentPart as $pp) {&nbsp;</div></li><li><div>                          $newPart[] = $pp;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $newPart[] = $p;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $out[] = $newPart;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $setSelf ? $out : array_merge($parent, $child);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function multiplyMedia($env, $childQueries = null) {&nbsp;</div></li><li><div>      if (!isset($env) ||&nbsp;</div></li><li><div>          !empty($env-&gt;block-&gt;type) && $env-&gt;block-&gt;type != &quot;media&quot;)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return $childQueries;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// plain old block, skip</span>&nbsp;</div></li><li><div>      if (empty($env-&gt;block-&gt;type)) {&nbsp;</div></li><li><div>          return $this-&gt;multiplyMedia($env-&gt;parent, $childQueries);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parentQueries = $env-&gt;block-&gt;queryList;&nbsp;</div></li><li><div>      if ($childQueries == null) {&nbsp;</div></li><li><div>          $childQueries = $parentQueries;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $originalQueries = $childQueries;&nbsp;</div></li><li><div>          $childQueries = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($parentQueries as $parentQuery) {&nbsp;</div></li><li><div>              foreach ($originalQueries as $childQuery) {&nbsp;</div></li><li><div>                  $childQueries []= array_merge($parentQuery, $childQuery);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;multiplyMedia($env-&gt;parent, $childQueries);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// convert something to list</span>&nbsp;</div></li><li><div>  protected function coerceList($item, $delim = &quot;, &quot;) {&nbsp;</div></li><li><div>      if (isset($item) && $item[0] == &quot;list&quot;) {&nbsp;</div></li><li><div>          return $item;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&quot;list&quot;, $delim, !isset($item) ? array(): array($item));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function applyArguments($argDef, $argValues) {&nbsp;</div></li><li><div>      $hasVariable = false;&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>      foreach ($argDef as $i =&gt; $arg) {&nbsp;</div></li><li><div>          list($name, $default, $isVariable) = $argDef[$i];&nbsp;</div></li><li><div>          $args[$name] = array($i, $name, $default, $isVariable);&nbsp;</div></li><li><div>          $hasVariable |= $isVariable;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $keywordArgs = array();&nbsp;</div></li><li><div>      $deferredKeywordArgs = array();&nbsp;</div></li><li><div>      $remaining = array();&nbsp;</div></li><li><div>      <span class="comment">// assign the keyword args</span>&nbsp;</div></li><li><div>      foreach ((array) $argValues as $arg) {&nbsp;</div></li><li><div>          if (!empty($arg[0])) {&nbsp;</div></li><li><div>              if (!isset($args[$arg[0][1]])) {&nbsp;</div></li><li><div>                  if ($hasVariable) {&nbsp;</div></li><li><div>                      $deferredKeywordArgs[$arg[0][1]] = $arg[1];&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $this-&gt;throwError(&quot;Mixin or function doesn't have an argument named $%s.&quot;, $arg[0][1]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ($args[$arg[0][1]][0] &lt; count($remaining)) {&nbsp;</div></li><li><div>                  $this-&gt;throwError(&quot;The argument $%s was passed both by position and by name.&quot;, $arg[0][1]);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $keywordArgs[$arg[0][1]] = $arg[1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif (count($keywordArgs)) {&nbsp;</div></li><li><div>              $this-&gt;throwError('Positional arguments must come before keyword arguments.');&nbsp;</div></li><li><div>          } elseif ($arg[2] == true) {&nbsp;</div></li><li><div>              $val = $this-&gt;reduce($arg[1], true);&nbsp;</div></li><li><div>              if ($val[0] == &quot;list&quot;) {&nbsp;</div></li><li><div>                  foreach ($val[2] as $name =&gt; $item) {&nbsp;</div></li><li><div>                      if (!is_numeric($name)) {&nbsp;</div></li><li><div>                          $keywordArgs[$name] = $item;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $remaining[] = $item;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $remaining[] = $val;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $remaining[] = $arg[1];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($args as $arg) {&nbsp;</div></li><li><div>          list($i, $name, $default, $isVariable) = $arg;&nbsp;</div></li><li><div>          if ($isVariable) {&nbsp;</div></li><li><div>              $val = array(&quot;list&quot;, &quot;, &quot;, array());&nbsp;</div></li><li><div>              for ($count = count($remaining); $i &lt; $count; $i++) {&nbsp;</div></li><li><div>                  $val[2][] = $remaining[$i];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              foreach ($deferredKeywordArgs as $itemName =&gt; $item) {&nbsp;</div></li><li><div>                  $val[2][$itemName] = $item;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif (isset($remaining[$i])) {&nbsp;</div></li><li><div>              $val = $remaining[$i];&nbsp;</div></li><li><div>          } elseif (isset($keywordArgs[$name])) {&nbsp;</div></li><li><div>              $val = $keywordArgs[$name];&nbsp;</div></li><li><div>          } elseif (!empty($default)) {&nbsp;</div></li><li><div>              $val = $default;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;Missing argument $name&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;set($name, $this-&gt;reduce($val, true), true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function pushEnv($block=null) {&nbsp;</div></li><li><div>      $env = new stdClass;&nbsp;</div></li><li><div>      $env-&gt;parent = $this-&gt;env;&nbsp;</div></li><li><div>      $env-&gt;store = array();&nbsp;</div></li><li><div>      $env-&gt;block = $block;&nbsp;</div></li><li><div>      $env-&gt;depth = isset($this-&gt;env-&gt;depth) ? $this-&gt;env-&gt;depth + 1 : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env = $env;&nbsp;</div></li><li><div>      return $env;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function normalizeName($name) {&nbsp;</div></li><li><div>      return str_replace(&quot;-&quot;, &quot;_&quot;, $name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function getStoreEnv() {&nbsp;</div></li><li><div>      return isset($this-&gt;storeEnv) ? $this-&gt;storeEnv : $this-&gt;env;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function set($name, $value, $shadow=false) {&nbsp;</div></li><li><div>      $name = $this-&gt;normalizeName($name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($shadow) {&nbsp;</div></li><li><div>          $this-&gt;setRaw($name, $value);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;setExisting($name, $value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function setExisting($name, $value, $env = null) {&nbsp;</div></li><li><div>      if (!isset($env)) $env = $this-&gt;getStoreEnv();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($env-&gt;store[$name]) || !isset($env-&gt;parent)) {&nbsp;</div></li><li><div>          $env-&gt;store[$name] = $value;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;setExisting($name, $value, $env-&gt;parent);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function setRaw($name, $value) {&nbsp;</div></li><li><div>      $env = $this-&gt;getStoreEnv();&nbsp;</div></li><li><div>      $env-&gt;store[$name] = $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get($name, $defaultValue = null, $env = null) {&nbsp;</div></li><li><div>      $name = $this-&gt;normalizeName($name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($env)) $env = $this-&gt;getStoreEnv();&nbsp;</div></li><li><div>      if (!isset($defaultValue)) $defaultValue = self::$defaultValue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($env-&gt;store[$name])) {&nbsp;</div></li><li><div>          return $env-&gt;store[$name];&nbsp;</div></li><li><div>      } elseif (isset($env-&gt;parent)) {&nbsp;</div></li><li><div>          return $this-&gt;get($name, $defaultValue, $env-&gt;parent);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $defaultValue; <span class="comment">// found nothing</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function injectVariables(array $args)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (empty($args)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parser = new scss_parser(__METHOD__, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($args as $name =&gt; $strValue) {&nbsp;</div></li><li><div>          if ($name[0] === '$') {&nbsp;</div></li><li><div>              $name = substr($name, 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parser-&gt;env = null;&nbsp;</div></li><li><div>          $parser-&gt;count = 0;&nbsp;</div></li><li><div>          $parser-&gt;buffer = (string) $strValue;&nbsp;</div></li><li><div>          $parser-&gt;inParens = false;&nbsp;</div></li><li><div>          $parser-&gt;eatWhiteDefault = true;&nbsp;</div></li><li><div>          $parser-&gt;insertComments = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $parser-&gt;valueList($value)) {&nbsp;</div></li><li><div>              throw new Exception(&quot;failed to parse passed in variable $name: $strValue&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;set($name, $value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set variables</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $variables</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function setVariables(array $variables)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;registeredVars = array_merge($this-&gt;registeredVars, $variables);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Unset variable</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function unsetVariable($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      unset($this-&gt;registeredVars[$name]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function popEnv() {&nbsp;</div></li><li><div>      $env = $this-&gt;env;&nbsp;</div></li><li><div>      $this-&gt;env = $this-&gt;env-&gt;parent;&nbsp;</div></li><li><div>      return $env;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getParsedFiles() {&nbsp;</div></li><li><div>      return $this-&gt;parsedFiles;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function addImportPath($path) {&nbsp;</div></li><li><div>      $this-&gt;importPaths[] = $path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setImportPaths($path) {&nbsp;</div></li><li><div>      $this-&gt;importPaths = (array)$path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setNumberPrecision($numberPrecision) {&nbsp;</div></li><li><div>      $this-&gt;numberPrecision = $numberPrecision;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setFormatter($formatterName) {&nbsp;</div></li><li><div>      $this-&gt;formatter = $formatterName;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function registerFunction($name, $func) {&nbsp;</div></li><li><div>      $this-&gt;userFunctions[$this-&gt;normalizeName($name)] = $func;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function unregisterFunction($name) {&nbsp;</div></li><li><div>      unset($this-&gt;userFunctions[$this-&gt;normalizeName($name)]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function importFile($path, $out) {&nbsp;</div></li><li><div>      <span class="comment">// see if tree is cached</span>&nbsp;</div></li><li><div>      $realPath = realpath($path);&nbsp;</div></li><li><div>      if (isset($this-&gt;importCache[$realPath])) {&nbsp;</div></li><li><div>          $tree = $this-&gt;importCache[$realPath];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $code = self::$parent-&gt;filesystem-&gt;execute( 'get_contents', $path );&nbsp;</div></li><li><div>          <span class="comment">//$code = file_get_contents($path);</span>&nbsp;</div></li><li><div>          $parser = new scss_parser($path, false);&nbsp;</div></li><li><div>          $tree = $parser-&gt;parse($code);&nbsp;</div></li><li><div>          $this-&gt;parsedFiles[] = $path;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;importCache[$realPath] = $tree;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pi = pathinfo($path);&nbsp;</div></li><li><div>      array_unshift($this-&gt;importPaths, $pi['dirname']);&nbsp;</div></li><li><div>      $this-&gt;compileChildren($tree-&gt;children, $out);&nbsp;</div></li><li><div>      array_shift($this-&gt;importPaths);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// results the file path for an import url if it exists</span>&nbsp;</div></li><li><div>  public function findImport($url) {&nbsp;</div></li><li><div>      $urls = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// for &quot;normal&quot; scss imports (ignore vanilla css and external requests)</span>&nbsp;</div></li><li><div>      if (!preg_match('/\.css|^http:\/\/$/', $url)) {&nbsp;</div></li><li><div>          <span class="comment">// try both normal and the _partial filename</span>&nbsp;</div></li><li><div>          $urls = array($url, preg_replace('/[^\/]+$/', '_\0', $url));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($this-&gt;importPaths as $dir) {&nbsp;</div></li><li><div>          if (is_string($dir)) {&nbsp;</div></li><li><div>              <span class="comment">// check urls for normal import paths</span>&nbsp;</div></li><li><div>              foreach ($urls as $full) {&nbsp;</div></li><li><div>                  $full = $dir .&nbsp;</div></li><li><div>                      (!empty($dir) && substr($dir, -1) != '/' ? '/' : '') .&nbsp;</div></li><li><div>                      $full;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($this-&gt;fileExists($file = $full.'.scss') ||&nbsp;</div></li><li><div>                      $this-&gt;fileExists($file = $full))&nbsp;</div></li><li><div>                  {&nbsp;</div></li><li><div>                      return $file;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// check custom callback for import path</span>&nbsp;</div></li><li><div>              $file = call_user_func($dir, $url, $this);&nbsp;</div></li><li><div>              if ($file !== null) {&nbsp;</div></li><li><div>                  return $file;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function fileExists($name) {&nbsp;</div></li><li><div>      return is_file($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function callBuiltin($name, $args, &$returnValue) {&nbsp;</div></li><li><div>      <span class="comment">// try a lib function</span>&nbsp;</div></li><li><div>      $name = $this-&gt;normalizeName($name);&nbsp;</div></li><li><div>      $libName = &quot;lib_&quot;.$name;&nbsp;</div></li><li><div>      $f = array($this, $libName);&nbsp;</div></li><li><div>      if (is_callable($f)) {&nbsp;</div></li><li><div>          $prototype = isset(self::$$libName) ? self::$$libName : null;&nbsp;</div></li><li><div>          $sorted = $this-&gt;sortArgs($prototype, $args);&nbsp;</div></li><li><div>          foreach ($sorted as &$val) {&nbsp;</div></li><li><div>              $val = $this-&gt;reduce($val, true);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $returnValue = call_user_func($f, $sorted, $this);&nbsp;</div></li><li><div>      } elseif (isset($this-&gt;userFunctions[$name])) {&nbsp;</div></li><li><div>          <span class="comment">// see if we can find a user function</span>&nbsp;</div></li><li><div>          $fn = $this-&gt;userFunctions[$name];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($args as &$val) {&nbsp;</div></li><li><div>              $val = $this-&gt;reduce($val[1], true);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $returnValue = call_user_func($fn, $args, $this);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($returnValue)) {&nbsp;</div></li><li><div>          <span class="comment">// coerce a php value into a scss one</span>&nbsp;</div></li><li><div>          if (is_numeric($returnValue)) {&nbsp;</div></li><li><div>              $returnValue = array('number', $returnValue, &quot;&quot;);&nbsp;</div></li><li><div>          } elseif (is_bool($returnValue)) {&nbsp;</div></li><li><div>              $returnValue = $returnValue ? self::$true : self::$false;&nbsp;</div></li><li><div>          } elseif (!is_array($returnValue)) {&nbsp;</div></li><li><div>              $returnValue = array('keyword', $returnValue);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// sorts any keyword arguments</span>&nbsp;</div></li><li><div>  <span class="comment">// TODO: merge with apply arguments</span>&nbsp;</div></li><li><div>  protected function sortArgs($prototype, $args) {&nbsp;</div></li><li><div>      $keyArgs = array();&nbsp;</div></li><li><div>      $posArgs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($args as $arg) {&nbsp;</div></li><li><div>          list($key, $value) = $arg;&nbsp;</div></li><li><div>          $key = $key[1];&nbsp;</div></li><li><div>          if (empty($key)) {&nbsp;</div></li><li><div>              $posArgs[] = $value;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $keyArgs[$key] = $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($prototype)) return $posArgs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $finalArgs = array();&nbsp;</div></li><li><div>      foreach ($prototype as $i =&gt; $names) {&nbsp;</div></li><li><div>          if (isset($posArgs[$i])) {&nbsp;</div></li><li><div>              $finalArgs[] = $posArgs[$i];&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $set = false;&nbsp;</div></li><li><div>          foreach ((array)$names as $name) {&nbsp;</div></li><li><div>              if (isset($keyArgs[$name])) {&nbsp;</div></li><li><div>                  $finalArgs[] = $keyArgs[$name];&nbsp;</div></li><li><div>                  $set = true;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$set) {&nbsp;</div></li><li><div>              $finalArgs[] = null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $finalArgs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function coerceForExpression($value) {&nbsp;</div></li><li><div>      if ($color = $this-&gt;coerceColor($value)) {&nbsp;</div></li><li><div>          return $color;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function coerceColor($value) {&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case &quot;color&quot;: return $value;&nbsp;</div></li><li><div>      case &quot;keyword&quot;:&nbsp;</div></li><li><div>          $name = $value[1];&nbsp;</div></li><li><div>          if (isset(self::$cssColors[$name])) {&nbsp;</div></li><li><div>              $rgba = explode(', ', self::$cssColors[$name]);&nbsp;</div></li><li><div>              return isset($rgba[3])&nbsp;</div></li><li><div>                  ? array('color', (int) $rgba[0], (int) $rgba[1], (int) $rgba[2], (int) $rgba[3])&nbsp;</div></li><li><div>                  : array('color', (int) $rgba[0], (int) $rgba[1], (int) $rgba[2]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function coerceString($value) {&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case &quot;string&quot;:&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      case &quot;keyword&quot;:&nbsp;</div></li><li><div>          return array(&quot;string&quot;, &quot;&quot;, array($value[1]));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function assertList($value) {&nbsp;</div></li><li><div>      if ($value[0] != &quot;list&quot;)&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;expecting list&quot;);&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function assertColor($value) {&nbsp;</div></li><li><div>      if ($color = $this-&gt;coerceColor($value)) return $color;&nbsp;</div></li><li><div>      $this-&gt;throwError(&quot;expecting color&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function assertNumber($value) {&nbsp;</div></li><li><div>      if ($value[0] != &quot;number&quot;)&nbsp;</div></li><li><div>          $this-&gt;throwError(&quot;expecting number&quot;);&nbsp;</div></li><li><div>      return $value[1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function coercePercent($value) {&nbsp;</div></li><li><div>      if ($value[0] == &quot;number&quot;) {&nbsp;</div></li><li><div>          if ($value[2] == &quot;%&quot;) {&nbsp;</div></li><li><div>              return $value[1] / 100;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $value[1];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// make sure a color's components don't go out of bounds</span>&nbsp;</div></li><li><div>  protected function fixColor($c) {&nbsp;</div></li><li><div>      foreach (range(1, 3) as $i) {&nbsp;</div></li><li><div>          if ($c[$i] &lt; 0) $c[$i] = 0;&nbsp;</div></li><li><div>          if ($c[$i] &gt; 255) $c[$i] = 255;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $c;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function toHSL($red, $green, $blue) {&nbsp;</div></li><li><div>      $min = min($red, $green, $blue);&nbsp;</div></li><li><div>      $max = max($red, $green, $blue);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $l = $min + $max;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($min == $max) {&nbsp;</div></li><li><div>          $s = $h = 0;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $d = $max - $min;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($l &lt; 255)&nbsp;</div></li><li><div>              $s = $d / $l;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $s = $d / (510 - $l);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($red == $max)&nbsp;</div></li><li><div>              $h = 60 * ($green - $blue) / $d;&nbsp;</div></li><li><div>          elseif ($green == $max)&nbsp;</div></li><li><div>              $h = 60 * ($blue - $red) / $d + 120;&nbsp;</div></li><li><div>          elseif ($blue == $max)&nbsp;</div></li><li><div>              $h = 60 * ($red - $green) / $d + 240;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array('hsl', fmod($h, 360), $s * 100, $l / 5.1);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function hueToRGB($m1, $m2, $h) {&nbsp;</div></li><li><div>      if ($h &lt; 0)&nbsp;</div></li><li><div>          $h += 1;&nbsp;</div></li><li><div>      elseif ($h &gt; 1)&nbsp;</div></li><li><div>          $h -= 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($h * 6 &lt; 1)&nbsp;</div></li><li><div>          return $m1 + ($m2 - $m1) * $h * 6;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($h * 2 &lt; 1)&nbsp;</div></li><li><div>          return $m2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($h * 3 &lt; 2)&nbsp;</div></li><li><div>          return $m1 + ($m2 - $m1) * (2/3 - $h) * 6;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $m1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// H from 0 to 360, S and L from 0 to 100</span>&nbsp;</div></li><li><div>  public function toRGB($hue, $saturation, $lightness) {&nbsp;</div></li><li><div>      if ($hue &lt; 0) {&nbsp;</div></li><li><div>          $hue += 360;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $h = $hue / 360;&nbsp;</div></li><li><div>      $s = min(100, max(0, $saturation)) / 100;&nbsp;</div></li><li><div>      $l = min(100, max(0, $lightness)) / 100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $m2 = $l &lt;= 0.5 ? $l * ($s + 1) : $l + $s - $l * $s;&nbsp;</div></li><li><div>      $m1 = $l * 2 - $m2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = $this-&gt;hueToRGB($m1, $m2, $h + 1/3) * 255;&nbsp;</div></li><li><div>      $g = $this-&gt;hueToRGB($m1, $m2, $h) * 255;&nbsp;</div></li><li><div>      $b = $this-&gt;hueToRGB($m1, $m2, $h - 1/3) * 255;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array('color', $r, $g, $b);&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Built in functions</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_if = array(&quot;condition&quot;, &quot;if-true&quot;, &quot;if-false&quot;);&nbsp;</div></li><li><div>  protected function lib_if($args) {&nbsp;</div></li><li><div>      list($cond, $t, $f) = $args;&nbsp;</div></li><li><div>      if (!$this-&gt;isTruthy($cond)) return $f;&nbsp;</div></li><li><div>      return $t;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_index = array(&quot;list&quot;, &quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_index($args) {&nbsp;</div></li><li><div>      list($list, $value) = $args;&nbsp;</div></li><li><div>      $list = $this-&gt;assertList($list);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $values = array();&nbsp;</div></li><li><div>      foreach ($list[2] as $item) {&nbsp;</div></li><li><div>          $values[] = $this-&gt;normalizeValue($item);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $key = array_search($this-&gt;normalizeValue($value), $values);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false === $key ? false : $key + 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_rgb = array(&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;);&nbsp;</div></li><li><div>  protected function lib_rgb($args) {&nbsp;</div></li><li><div>      list($r, $g, $b) = $args;&nbsp;</div></li><li><div>      return array(&quot;color&quot;, $r[1], $g[1], $b[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_rgba = array(&nbsp;</div></li><li><div>      array(&quot;red&quot;, &quot;color&quot;), &nbsp;</div></li><li><div>      &quot;green&quot;, &quot;blue&quot;, &quot;alpha&quot;);&nbsp;</div></li><li><div>  protected function lib_rgba($args) {&nbsp;</div></li><li><div>      if ($color = $this-&gt;coerceColor($args[0])) {&nbsp;</div></li><li><div>          $num = !isset($args[1]) ? $args[3] : $args[1];&nbsp;</div></li><li><div>          $alpha = $this-&gt;assertNumber($num);&nbsp;</div></li><li><div>          $color[4] = $alpha;&nbsp;</div></li><li><div>          return $color;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list($r, $g, $b, $a) = $args;&nbsp;</div></li><li><div>      return array(&quot;color&quot;, $r[1], $g[1], $b[1], $a[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// helper function for adjust_color, change_color, and scale_color</span>&nbsp;</div></li><li><div>  protected function alter_color($args, $fn) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach (array(1, 2, 3, 7) as $i) {&nbsp;</div></li><li><div>          if (isset($args[$i])) {&nbsp;</div></li><li><div>              $val = $this-&gt;assertNumber($args[$i]);&nbsp;</div></li><li><div>              $ii = $i == 7 ? 4 : $i; <span class="comment">// alpha</span>&nbsp;</div></li><li><div>              $color[$ii] =&nbsp;</div></li><li><div>                  $this-&gt;$fn(isset($color[$ii]) ? $color[$ii] : 0, $val, $i);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($args[4]) || isset($args[5]) || isset($args[6])) {&nbsp;</div></li><li><div>          $hsl = $this-&gt;toHSL($color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>          foreach (array(4, 5, 6) as $i) {&nbsp;</div></li><li><div>              if (isset($args[$i])) {&nbsp;</div></li><li><div>                  $val = $this-&gt;assertNumber($args[$i]);&nbsp;</div></li><li><div>                  $hsl[$i - 3] = $this-&gt;$fn($hsl[$i - 3], $val, $i);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $rgb = $this-&gt;toRGB($hsl[1], $hsl[2], $hsl[3]);&nbsp;</div></li><li><div>          if (isset($color[4])) $rgb[4] = $color[4];&nbsp;</div></li><li><div>          $color = $rgb;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_adjust_color = array(&nbsp;</div></li><li><div>      &quot;color&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &nbsp;</div></li><li><div>      &quot;hue&quot;, &quot;saturation&quot;, &quot;lightness&quot;, &quot;alpha&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  protected function adjust_color_helper($base, $alter, $i) {&nbsp;</div></li><li><div>      return $base += $alter;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  protected function lib_adjust_color($args) {&nbsp;</div></li><li><div>      return $this-&gt;alter_color($args, &quot;adjust_color_helper&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_change_color = array(&nbsp;</div></li><li><div>      &quot;color&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &nbsp;</div></li><li><div>      &quot;hue&quot;, &quot;saturation&quot;, &quot;lightness&quot;, &quot;alpha&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  protected function change_color_helper($base, $alter, $i) {&nbsp;</div></li><li><div>      return $alter;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  protected function lib_change_color($args) {&nbsp;</div></li><li><div>      return $this-&gt;alter_color($args, &quot;change_color_helper&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_scale_color = array(&nbsp;</div></li><li><div>      &quot;color&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &nbsp;</div></li><li><div>      &quot;hue&quot;, &quot;saturation&quot;, &quot;lightness&quot;, &quot;alpha&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  protected function scale_color_helper($base, $scale, $i) {&nbsp;</div></li><li><div>      <span class="comment">// 1, 2, 3 - rgb</span>&nbsp;</div></li><li><div>      <span class="comment">// 4, 5, 6 - hsl</span>&nbsp;</div></li><li><div>      <span class="comment">// 7 - a</span>&nbsp;</div></li><li><div>      switch ($i) {&nbsp;</div></li><li><div>      case 1:&nbsp;</div></li><li><div>      case 2:&nbsp;</div></li><li><div>      case 3:&nbsp;</div></li><li><div>          $max = 255; break;&nbsp;</div></li><li><div>      case 4:&nbsp;</div></li><li><div>          $max = 360; break;&nbsp;</div></li><li><div>      case 7:&nbsp;</div></li><li><div>          $max = 1; break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          $max = 100;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $scale = $scale / 100;&nbsp;</div></li><li><div>      if ($scale &lt; 0) {&nbsp;</div></li><li><div>          return $base * $scale + $base;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return ($max - $base) * $scale + $base;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  protected function lib_scale_color($args) {&nbsp;</div></li><li><div>      return $this-&gt;alter_color($args, &quot;scale_color_helper&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_ie_hex_str = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_ie_hex_str($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($args[0]);&nbsp;</div></li><li><div>      $color[4] = isset($color[4]) ? round(255*$color[4]) : 255;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return sprintf('#%02X%02X%02X%02X', $color[4], $color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_red = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_red($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($args[0]);&nbsp;</div></li><li><div>      return $color[1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_green = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_green($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($args[0]);&nbsp;</div></li><li><div>      return $color[2];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_blue = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_blue($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;coerceColor($args[0]);&nbsp;</div></li><li><div>      return $color[3];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_alpha = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_alpha($args) {&nbsp;</div></li><li><div>      if ($color = $this-&gt;coerceColor($args[0])) {&nbsp;</div></li><li><div>          return isset($color[4]) ? $color[4] : 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// this might be the IE function, so return value unchanged</span>&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_opacity = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_opacity($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      if ($value[0] === 'number') return null;&nbsp;</div></li><li><div>      return $this-&gt;lib_alpha($args);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// mix two colors</span>&nbsp;</div></li><li><div>  protected static $lib_mix = array(&quot;color-1&quot;, &quot;color-2&quot;, &quot;weight&quot;);&nbsp;</div></li><li><div>  protected function lib_mix($args) {&nbsp;</div></li><li><div>      list($first, $second, $weight) = $args;&nbsp;</div></li><li><div>      $first = $this-&gt;assertColor($first);&nbsp;</div></li><li><div>      $second = $this-&gt;assertColor($second);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($weight)) {&nbsp;</div></li><li><div>          $weight = 0.5;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $weight = $this-&gt;coercePercent($weight);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $firstAlpha = isset($first[4]) ? $first[4] : 1;&nbsp;</div></li><li><div>      $secondAlpha = isset($second[4]) ? $second[4] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $w = $weight * 2 - 1;&nbsp;</div></li><li><div>      $a = $firstAlpha - $secondAlpha;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $w1 = (($w * $a == -1 ? $w : ($w + $a)/(1 + $w * $a)) + 1) / 2.0;&nbsp;</div></li><li><div>      $w2 = 1.0 - $w1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new = array('color', &nbsp;</div></li><li><div>          $w1 * $first[1] + $w2 * $second[1], &nbsp;</div></li><li><div>          $w1 * $first[2] + $w2 * $second[2], &nbsp;</div></li><li><div>          $w1 * $first[3] + $w2 * $second[3], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($firstAlpha != 1.0 || $secondAlpha != 1.0) {&nbsp;</div></li><li><div>          $new[] = $firstAlpha * $weight + $secondAlpha * ($weight - 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;fixColor($new);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_hsl = array(&quot;hue&quot;, &quot;saturation&quot;, &quot;lightness&quot;);&nbsp;</div></li><li><div>  protected function lib_hsl($args) {&nbsp;</div></li><li><div>      list($h, $s, $l) = $args;&nbsp;</div></li><li><div>      return $this-&gt;toRGB($h[1], $s[1], $l[1]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_hsla = array(&quot;hue&quot;, &quot;saturation&quot;, &nbsp;</div></li><li><div>      &quot;lightness&quot;, &quot;alpha&quot;);&nbsp;</div></li><li><div>  protected function lib_hsla($args) {&nbsp;</div></li><li><div>      list($h, $s, $l, $a) = $args;&nbsp;</div></li><li><div>      $color = $this-&gt;toRGB($h[1], $s[1], $l[1]);&nbsp;</div></li><li><div>      $color[4] = $a[1];&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_hue = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_hue($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $hsl[1], &quot;deg&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_saturation = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_saturation($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $hsl[2], &quot;%&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_lightness = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_lightness($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>      return array(&quot;number&quot;, $hsl[3], &quot;%&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function adjustHsl($color, $idx, $amount) {&nbsp;</div></li><li><div>      $hsl = $this-&gt;toHSL($color[1], $color[2], $color[3]);&nbsp;</div></li><li><div>      $hsl[$idx] += $amount;&nbsp;</div></li><li><div>      $out = $this-&gt;toRGB($hsl[1], $hsl[2], $hsl[3]);&nbsp;</div></li><li><div>      if (isset($color[4])) $out[4] = $color[4];&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_adjust_hue = array(&quot;color&quot;, &quot;degrees&quot;);&nbsp;</div></li><li><div>  protected function lib_adjust_hue($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $degrees = $this-&gt;assertNumber($args[1]);&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($color, 1, $degrees);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_lighten = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_lighten($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $amount = 100*$this-&gt;coercePercent($args[1]);&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($color, 3, $amount);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_darken = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_darken($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $amount = 100*$this-&gt;coercePercent($args[1]);&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($color, 3, -$amount);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_saturate = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_saturate($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      if ($value[0] === 'number') return null;&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($value);&nbsp;</div></li><li><div>      $amount = 100*$this-&gt;coercePercent($args[1]);&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($color, 2, $amount);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_desaturate = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_desaturate($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $amount = 100*$this-&gt;coercePercent($args[1]);&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($color, 2, -$amount);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_grayscale = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_grayscale($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      if ($value[0] === 'number') return null;&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($this-&gt;assertColor($value), 2, -100);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_complement = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_complement($args) {&nbsp;</div></li><li><div>      return $this-&gt;adjustHsl($this-&gt;assertColor($args[0]), 1, 180);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_invert = array(&quot;color&quot;);&nbsp;</div></li><li><div>  protected function lib_invert($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      if ($value[0] === 'number') return null;&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($value);&nbsp;</div></li><li><div>      $color[1] = 255 - $color[1];&nbsp;</div></li><li><div>      $color[2] = 255 - $color[2];&nbsp;</div></li><li><div>      $color[3] = 255 - $color[3];&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// increases opacity by amount</span>&nbsp;</div></li><li><div>  protected static $lib_opacify = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_opacify($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $amount = $this-&gt;coercePercent($args[1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $color[4] = (isset($color[4]) ? $color[4] : 1) + $amount;&nbsp;</div></li><li><div>      $color[4] = min(1, max(0, $color[4]));&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_fade_in = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_fade_in($args) {&nbsp;</div></li><li><div>      return $this-&gt;lib_opacify($args);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// decreases opacity by amount</span>&nbsp;</div></li><li><div>  protected static $lib_transparentize = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_transparentize($args) {&nbsp;</div></li><li><div>      $color = $this-&gt;assertColor($args[0]);&nbsp;</div></li><li><div>      $amount = $this-&gt;coercePercent($args[1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $color[4] = (isset($color[4]) ? $color[4] : 1) - $amount;&nbsp;</div></li><li><div>      $color[4] = min(1, max(0, $color[4]));&nbsp;</div></li><li><div>      return $color;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_fade_out = array(&quot;color&quot;, &quot;amount&quot;);&nbsp;</div></li><li><div>  protected function lib_fade_out($args) {&nbsp;</div></li><li><div>      return $this-&gt;lib_transparentize($args);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_unquote = array(&quot;string&quot;);&nbsp;</div></li><li><div>  protected function lib_unquote($args) {&nbsp;</div></li><li><div>      $str = $args[0];&nbsp;</div></li><li><div>      if ($str[0] == &quot;string&quot;) $str[1] = &quot;&quot;;&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_quote = array(&quot;string&quot;);&nbsp;</div></li><li><div>  protected function lib_quote($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      if ($value[0] == &quot;string&quot; && !empty($value[1]))&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      return array(&quot;string&quot;, '&quot;', array($value));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_percentage = array(&quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_percentage($args) {&nbsp;</div></li><li><div>      return array(&quot;number&quot;, &nbsp;</div></li><li><div>          $this-&gt;coercePercent($args[0]) * 100, &nbsp;</div></li><li><div>          &quot;%&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_round = array(&quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_round($args) {&nbsp;</div></li><li><div>      $num = $args[0];&nbsp;</div></li><li><div>      $num[1] = round($num[1]);&nbsp;</div></li><li><div>      return $num;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_floor = array(&quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_floor($args) {&nbsp;</div></li><li><div>      $num = $args[0];&nbsp;</div></li><li><div>      $num[1] = floor($num[1]);&nbsp;</div></li><li><div>      return $num;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_ceil = array(&quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_ceil($args) {&nbsp;</div></li><li><div>      $num = $args[0];&nbsp;</div></li><li><div>      $num[1] = ceil($num[1]);&nbsp;</div></li><li><div>      return $num;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_abs = array(&quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_abs($args) {&nbsp;</div></li><li><div>      $num = $args[0];&nbsp;</div></li><li><div>      $num[1] = abs($num[1]);&nbsp;</div></li><li><div>      return $num;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_min($args) {&nbsp;</div></li><li><div>      $numbers = $this-&gt;getNormalizedNumbers($args);&nbsp;</div></li><li><div>      $min = null;&nbsp;</div></li><li><div>      foreach ($numbers as $key =&gt; $number) {&nbsp;</div></li><li><div>          if (null === $min || $number[1] &lt;= $min[1]) {&nbsp;</div></li><li><div>              $min = array($key, $number[1]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args[$min[0]];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_max($args) {&nbsp;</div></li><li><div>      $numbers = $this-&gt;getNormalizedNumbers($args);&nbsp;</div></li><li><div>      $max = null;&nbsp;</div></li><li><div>      foreach ($numbers as $key =&gt; $number) {&nbsp;</div></li><li><div>          if (null === $max || $number[1] &gt;= $max[1]) {&nbsp;</div></li><li><div>              $max = array($key, $number[1]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args[$max[0]];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function getNormalizedNumbers($args) {&nbsp;</div></li><li><div>      $unit = null;&nbsp;</div></li><li><div>      $originalUnit = null;&nbsp;</div></li><li><div>      $numbers = array();&nbsp;</div></li><li><div>      foreach ($args as $key =&gt; $item) {&nbsp;</div></li><li><div>          if ('number' != $item[0]) {&nbsp;</div></li><li><div>              $this-&gt;throwError(&quot;%s is not a number&quot;, $item[0]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $number = $this-&gt;normalizeNumber($item);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (null === $unit) {&nbsp;</div></li><li><div>              $unit = $number[2];&nbsp;</div></li><li><div>              $originalUnit = $item[2];&nbsp;</div></li><li><div>          } elseif ($unit !== $number[2]) {&nbsp;</div></li><li><div>              $this-&gt;throwError('Incompatible units: &quot;%s&quot; and &quot;%s&quot;.', $originalUnit, $item[2]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $numbers[$key] = $number;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $numbers;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_length = array(&quot;list&quot;);&nbsp;</div></li><li><div>  protected function lib_length($args) {&nbsp;</div></li><li><div>      $list = $this-&gt;coerceList($args[0]);&nbsp;</div></li><li><div>      return count($list[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_nth = array(&quot;list&quot;, &quot;n&quot;);&nbsp;</div></li><li><div>  protected function lib_nth($args) {&nbsp;</div></li><li><div>      $list = $this-&gt;coerceList($args[0]);&nbsp;</div></li><li><div>      $n = $this-&gt;assertNumber($args[1]) - 1;&nbsp;</div></li><li><div>      return isset($list[2][$n]) ? $list[2][$n] : self::$defaultValue;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function listSeparatorForJoin($list1, $sep) {&nbsp;</div></li><li><div>      if (!isset($sep)) return $list1[1];&nbsp;</div></li><li><div>      switch ($this-&gt;compileValue($sep)) {&nbsp;</div></li><li><div>      case &quot;comma&quot;:&nbsp;</div></li><li><div>          return &quot;, &quot;;&nbsp;</div></li><li><div>      case &quot;space&quot;:&nbsp;</div></li><li><div>          return &quot;&quot;;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          return $list1[1];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_join = array(&quot;list1&quot;, &quot;list2&quot;, &quot;separator&quot;);&nbsp;</div></li><li><div>  protected function lib_join($args) {&nbsp;</div></li><li><div>      list($list1, $list2, $sep) = $args;&nbsp;</div></li><li><div>      $list1 = $this-&gt;coerceList($list1, &quot; &quot;);&nbsp;</div></li><li><div>      $list2 = $this-&gt;coerceList($list2, &quot; &quot;);&nbsp;</div></li><li><div>      $sep = $this-&gt;listSeparatorForJoin($list1, $sep);&nbsp;</div></li><li><div>      return array(&quot;list&quot;, $sep, array_merge($list1[2], $list2[2]));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_append = array(&quot;list&quot;, &quot;val&quot;, &quot;separator&quot;);&nbsp;</div></li><li><div>  protected function lib_append($args) {&nbsp;</div></li><li><div>      list($list1, $value, $sep) = $args;&nbsp;</div></li><li><div>      $list1 = $this-&gt;coerceList($list1, &quot; &quot;);&nbsp;</div></li><li><div>      $sep = $this-&gt;listSeparatorForJoin($list1, $sep);&nbsp;</div></li><li><div>      return array(&quot;list&quot;, $sep, array_merge($list1[2], array($value)));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function lib_zip($args) {&nbsp;</div></li><li><div>      foreach ($args as $arg) {&nbsp;</div></li><li><div>          $this-&gt;assertList($arg);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $lists = array();&nbsp;</div></li><li><div>      $firstList = array_shift($args);&nbsp;</div></li><li><div>      foreach ($firstList[2] as $key =&gt; $item) {&nbsp;</div></li><li><div>          $list = array(&quot;list&quot;, &quot;&quot;, array($item));&nbsp;</div></li><li><div>          foreach ($args as $arg) {&nbsp;</div></li><li><div>              if (isset($arg[2][$key])) {&nbsp;</div></li><li><div>                  $list[2][] = $arg[2][$key];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  break 2;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $lists[] = $list;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&quot;list&quot;, &quot;, &quot;, $lists);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_type_of = array(&quot;value&quot;);&nbsp;</div></li><li><div>  protected function lib_type_of($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      switch ($value[0]) {&nbsp;</div></li><li><div>      case &quot;keyword&quot;:&nbsp;</div></li><li><div>          if ($value == self::$true || $value == self::$false) {&nbsp;</div></li><li><div>              return &quot;bool&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;coerceColor($value)) {&nbsp;</div></li><li><div>              return &quot;color&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return &quot;string&quot;;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          return $value[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_unit = array(&quot;number&quot;);&nbsp;</div></li><li><div>  protected function lib_unit($args) {&nbsp;</div></li><li><div>      $num = $args[0];&nbsp;</div></li><li><div>      if ($num[0] == &quot;number&quot;) {&nbsp;</div></li><li><div>          return array(&quot;string&quot;, '&quot;', array($num[2]));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_unitless = array(&quot;number&quot;);&nbsp;</div></li><li><div>  protected function lib_unitless($args) {&nbsp;</div></li><li><div>      $value = $args[0];&nbsp;</div></li><li><div>      return $value[0] == &quot;number&quot; && empty($value[2]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected static $lib_comparable = array(&quot;number-1&quot;, &quot;number-2&quot;);&nbsp;</div></li><li><div>  protected function lib_comparable($args) {&nbsp;</div></li><li><div>      list($number1, $number2) = $args;&nbsp;</div></li><li><div>      if (!isset($number1[0]) || $number1[0] != &quot;number&quot; || !isset($number2[0]) || $number2[0] != &quot;number&quot;) {&nbsp;</div></li><li><div>          $this-&gt;throwError('Invalid argument(s) for &quot;comparable&quot;');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $number1 = $this-&gt;normalizeNumber($number1);&nbsp;</div></li><li><div>      $number2 = $this-&gt;normalizeNumber($number2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $number1[2] == $number2[2] || $number1[2] == &quot;&quot; || $number2[2] == &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Workaround IE7's content counter bug.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function lib_counter($args) {&nbsp;</div></li><li><div>      $list = array_map(array($this, 'compileValue'), $args);&nbsp;</div></li><li><div>      return array('string', '', array('counter(' . implode(', ', $list) . ')'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function throwError($msg = null) {&nbsp;</div></li><li><div>      if (func_num_args() &gt; 1) {&nbsp;</div></li><li><div>          $msg = call_user_func_array(&quot;sprintf&quot;, func_get_args());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;sourcePos &gt;= 0 && isset($this-&gt;sourceParser)) {&nbsp;</div></li><li><div>          $this-&gt;sourceParser-&gt;throwParseError($msg, $this-&gt;sourcePos);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      throw new Exception($msg);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * CSS Colors</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see http://www.w3.org/TR/css3-color</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static protected $cssColors = array(&nbsp;</div></li><li><div>      'aliceblue' =&gt; '240, 248, 255', &nbsp;</div></li><li><div>      'antiquewhite' =&gt; '250, 235, 215', &nbsp;</div></li><li><div>      'aqua' =&gt; '0, 255, 255', &nbsp;</div></li><li><div>      'aquamarine' =&gt; '127, 255, 212', &nbsp;</div></li><li><div>      'azure' =&gt; '240, 255, 255', &nbsp;</div></li><li><div>      'beige' =&gt; '245, 245, 220', &nbsp;</div></li><li><div>      'bisque' =&gt; '255, 228, 196', &nbsp;</div></li><li><div>      'black' =&gt; '0, 0, 0', &nbsp;</div></li><li><div>      'blanchedalmond' =&gt; '255, 235, 205', &nbsp;</div></li><li><div>      'blue' =&gt; '0, 0, 255', &nbsp;</div></li><li><div>      'blueviolet' =&gt; '138, 43, 226', &nbsp;</div></li><li><div>      'brown' =&gt; '165, 42, 42', &nbsp;</div></li><li><div>      'burlywood' =&gt; '222, 184, 135', &nbsp;</div></li><li><div>      'cadetblue' =&gt; '95, 158, 160', &nbsp;</div></li><li><div>      'chartreuse' =&gt; '127, 255, 0', &nbsp;</div></li><li><div>      'chocolate' =&gt; '210, 105, 30', &nbsp;</div></li><li><div>      'coral' =&gt; '255, 127, 80', &nbsp;</div></li><li><div>      'cornflowerblue' =&gt; '100, 149, 237', &nbsp;</div></li><li><div>      'cornsilk' =&gt; '255, 248, 220', &nbsp;</div></li><li><div>      'crimson' =&gt; '220, 20, 60', &nbsp;</div></li><li><div>      'cyan' =&gt; '0, 255, 255', &nbsp;</div></li><li><div>      'darkblue' =&gt; '0, 0, 139', &nbsp;</div></li><li><div>      'darkcyan' =&gt; '0, 139, 139', &nbsp;</div></li><li><div>      'darkgoldenrod' =&gt; '184, 134, 11', &nbsp;</div></li><li><div>      'darkgray' =&gt; '169, 169, 169', &nbsp;</div></li><li><div>      'darkgreen' =&gt; '0, 100, 0', &nbsp;</div></li><li><div>      'darkgrey' =&gt; '169, 169, 169', &nbsp;</div></li><li><div>      'darkkhaki' =&gt; '189, 183, 107', &nbsp;</div></li><li><div>      'darkmagenta' =&gt; '139, 0, 139', &nbsp;</div></li><li><div>      'darkolivegreen' =&gt; '85, 107, 47', &nbsp;</div></li><li><div>      'darkorange' =&gt; '255, 140, 0', &nbsp;</div></li><li><div>      'darkorchid' =&gt; '153, 50, 204', &nbsp;</div></li><li><div>      'darkred' =&gt; '139, 0, 0', &nbsp;</div></li><li><div>      'darksalmon' =&gt; '233, 150, 122', &nbsp;</div></li><li><div>      'darkseagreen' =&gt; '143, 188, 143', &nbsp;</div></li><li><div>      'darkslateblue' =&gt; '72, 61, 139', &nbsp;</div></li><li><div>      'darkslategray' =&gt; '47, 79, 79', &nbsp;</div></li><li><div>      'darkslategrey' =&gt; '47, 79, 79', &nbsp;</div></li><li><div>      'darkturquoise' =&gt; '0, 206, 209', &nbsp;</div></li><li><div>      'darkviolet' =&gt; '148, 0, 211', &nbsp;</div></li><li><div>      'deeppink' =&gt; '255, 20, 147', &nbsp;</div></li><li><div>      'deepskyblue' =&gt; '0, 191, 255', &nbsp;</div></li><li><div>      'dimgray' =&gt; '105, 105, 105', &nbsp;</div></li><li><div>      'dimgrey' =&gt; '105, 105, 105', &nbsp;</div></li><li><div>      'dodgerblue' =&gt; '30, 144, 255', &nbsp;</div></li><li><div>      'firebrick' =&gt; '178, 34, 34', &nbsp;</div></li><li><div>      'floralwhite' =&gt; '255, 250, 240', &nbsp;</div></li><li><div>      'forestgreen' =&gt; '34, 139, 34', &nbsp;</div></li><li><div>      'fuchsia' =&gt; '255, 0, 255', &nbsp;</div></li><li><div>      'gainsboro' =&gt; '220, 220, 220', &nbsp;</div></li><li><div>      'ghostwhite' =&gt; '248, 248, 255', &nbsp;</div></li><li><div>      'gold' =&gt; '255, 215, 0', &nbsp;</div></li><li><div>      'goldenrod' =&gt; '218, 165, 32', &nbsp;</div></li><li><div>      'gray' =&gt; '128, 128, 128', &nbsp;</div></li><li><div>      'green' =&gt; '0, 128, 0', &nbsp;</div></li><li><div>      'greenyellow' =&gt; '173, 255, 47', &nbsp;</div></li><li><div>      'grey' =&gt; '128, 128, 128', &nbsp;</div></li><li><div>      'honeydew' =&gt; '240, 255, 240', &nbsp;</div></li><li><div>      'hotpink' =&gt; '255, 105, 180', &nbsp;</div></li><li><div>      'indianred' =&gt; '205, 92, 92', &nbsp;</div></li><li><div>      'indigo' =&gt; '75, 0, 130', &nbsp;</div></li><li><div>      'ivory' =&gt; '255, 255, 240', &nbsp;</div></li><li><div>      'khaki' =&gt; '240, 230, 140', &nbsp;</div></li><li><div>      'lavender' =&gt; '230, 230, 250', &nbsp;</div></li><li><div>      'lavenderblush' =&gt; '255, 240, 245', &nbsp;</div></li><li><div>      'lawngreen' =&gt; '124, 252, 0', &nbsp;</div></li><li><div>      'lemonchiffon' =&gt; '255, 250, 205', &nbsp;</div></li><li><div>      'lightblue' =&gt; '173, 216, 230', &nbsp;</div></li><li><div>      'lightcoral' =&gt; '240, 128, 128', &nbsp;</div></li><li><div>      'lightcyan' =&gt; '224, 255, 255', &nbsp;</div></li><li><div>      'lightgoldenrodyellow' =&gt; '250, 250, 210', &nbsp;</div></li><li><div>      'lightgray' =&gt; '211, 211, 211', &nbsp;</div></li><li><div>      'lightgreen' =&gt; '144, 238, 144', &nbsp;</div></li><li><div>      'lightgrey' =&gt; '211, 211, 211', &nbsp;</div></li><li><div>      'lightpink' =&gt; '255, 182, 193', &nbsp;</div></li><li><div>      'lightsalmon' =&gt; '255, 160, 122', &nbsp;</div></li><li><div>      'lightseagreen' =&gt; '32, 178, 170', &nbsp;</div></li><li><div>      'lightskyblue' =&gt; '135, 206, 250', &nbsp;</div></li><li><div>      'lightslategray' =&gt; '119, 136, 153', &nbsp;</div></li><li><div>      'lightslategrey' =&gt; '119, 136, 153', &nbsp;</div></li><li><div>      'lightsteelblue' =&gt; '176, 196, 222', &nbsp;</div></li><li><div>      'lightyellow' =&gt; '255, 255, 224', &nbsp;</div></li><li><div>      'lime' =&gt; '0, 255, 0', &nbsp;</div></li><li><div>      'limegreen' =&gt; '50, 205, 50', &nbsp;</div></li><li><div>      'linen' =&gt; '250, 240, 230', &nbsp;</div></li><li><div>      'magenta' =&gt; '255, 0, 255', &nbsp;</div></li><li><div>      'maroon' =&gt; '128, 0, 0', &nbsp;</div></li><li><div>      'mediumaquamarine' =&gt; '102, 205, 170', &nbsp;</div></li><li><div>      'mediumblue' =&gt; '0, 0, 205', &nbsp;</div></li><li><div>      'mediumorchid' =&gt; '186, 85, 211', &nbsp;</div></li><li><div>      'mediumpurple' =&gt; '147, 112, 219', &nbsp;</div></li><li><div>      'mediumseagreen' =&gt; '60, 179, 113', &nbsp;</div></li><li><div>      'mediumslateblue' =&gt; '123, 104, 238', &nbsp;</div></li><li><div>      'mediumspringgreen' =&gt; '0, 250, 154', &nbsp;</div></li><li><div>      'mediumturquoise' =&gt; '72, 209, 204', &nbsp;</div></li><li><div>      'mediumvioletred' =&gt; '199, 21, 133', &nbsp;</div></li><li><div>      'midnightblue' =&gt; '25, 25, 112', &nbsp;</div></li><li><div>      'mintcream' =&gt; '245, 255, 250', &nbsp;</div></li><li><div>      'mistyrose' =&gt; '255, 228, 225', &nbsp;</div></li><li><div>      'moccasin' =&gt; '255, 228, 181', &nbsp;</div></li><li><div>      'navajowhite' =&gt; '255, 222, 173', &nbsp;</div></li><li><div>      'navy' =&gt; '0, 0, 128', &nbsp;</div></li><li><div>      'oldlace' =&gt; '253, 245, 230', &nbsp;</div></li><li><div>      'olive' =&gt; '128, 128, 0', &nbsp;</div></li><li><div>      'olivedrab' =&gt; '107, 142, 35', &nbsp;</div></li><li><div>      'orange' =&gt; '255, 165, 0', &nbsp;</div></li><li><div>      'orangered' =&gt; '255, 69, 0', &nbsp;</div></li><li><div>      'orchid' =&gt; '218, 112, 214', &nbsp;</div></li><li><div>      'palegoldenrod' =&gt; '238, 232, 170', &nbsp;</div></li><li><div>      'palegreen' =&gt; '152, 251, 152', &nbsp;</div></li><li><div>      'paleturquoise' =&gt; '175, 238, 238', &nbsp;</div></li><li><div>      'palevioletred' =&gt; '219, 112, 147', &nbsp;</div></li><li><div>      'papayawhip' =&gt; '255, 239, 213', &nbsp;</div></li><li><div>      'peachpuff' =&gt; '255, 218, 185', &nbsp;</div></li><li><div>      'peru' =&gt; '205, 133, 63', &nbsp;</div></li><li><div>      'pink' =&gt; '255, 192, 203', &nbsp;</div></li><li><div>      'plum' =&gt; '221, 160, 221', &nbsp;</div></li><li><div>      'powderblue' =&gt; '176, 224, 230', &nbsp;</div></li><li><div>      'purple' =&gt; '128, 0, 128', &nbsp;</div></li><li><div>      'red' =&gt; '255, 0, 0', &nbsp;</div></li><li><div>      'rosybrown' =&gt; '188, 143, 143', &nbsp;</div></li><li><div>      'royalblue' =&gt; '65, 105, 225', &nbsp;</div></li><li><div>      'saddlebrown' =&gt; '139, 69, 19', &nbsp;</div></li><li><div>      'salmon' =&gt; '250, 128, 114', &nbsp;</div></li><li><div>      'sandybrown' =&gt; '244, 164, 96', &nbsp;</div></li><li><div>      'seagreen' =&gt; '46, 139, 87', &nbsp;</div></li><li><div>      'seashell' =&gt; '255, 245, 238', &nbsp;</div></li><li><div>      'sienna' =&gt; '160, 82, 45', &nbsp;</div></li><li><div>      'silver' =&gt; '192, 192, 192', &nbsp;</div></li><li><div>      'skyblue' =&gt; '135, 206, 235', &nbsp;</div></li><li><div>      'slateblue' =&gt; '106, 90, 205', &nbsp;</div></li><li><div>      'slategray' =&gt; '112, 128, 144', &nbsp;</div></li><li><div>      'slategrey' =&gt; '112, 128, 144', &nbsp;</div></li><li><div>      'snow' =&gt; '255, 250, 250', &nbsp;</div></li><li><div>      'springgreen' =&gt; '0, 255, 127', &nbsp;</div></li><li><div>      'steelblue' =&gt; '70, 130, 180', &nbsp;</div></li><li><div>      'tan' =&gt; '210, 180, 140', &nbsp;</div></li><li><div>      'teal' =&gt; '0, 128, 128', &nbsp;</div></li><li><div>      'thistle' =&gt; '216, 191, 216', &nbsp;</div></li><li><div>      'tomato' =&gt; '255, 99, 71', &nbsp;</div></li><li><div>      'transparent' =&gt; '0, 0, 0, 0', &nbsp;</div></li><li><div>      'turquoise' =&gt; '64, 224, 208', &nbsp;</div></li><li><div>      'violet' =&gt; '238, 130, 238', &nbsp;</div></li><li><div>      'wheat' =&gt; '245, 222, 179', &nbsp;</div></li><li><div>      'white' =&gt; '255, 255, 255', &nbsp;</div></li><li><div>      'whitesmoke' =&gt; '245, 245, 245', &nbsp;</div></li><li><div>      'yellow' =&gt; '255, 255, 0', &nbsp;</div></li><li><div>      'yellowgreen' =&gt; '154, 205, 50'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS parser</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class scss_parser {&nbsp;</div></li><li><div>  static protected $precedence = array(&nbsp;</div></li><li><div>      &quot;or&quot; =&gt; 0, &nbsp;</div></li><li><div>      &quot;and&quot; =&gt; 1, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      '==' =&gt; 2, &nbsp;</div></li><li><div>      '!=' =&gt; 2, &nbsp;</div></li><li><div>      '&lt;=' =&gt; 2, &nbsp;</div></li><li><div>      '&gt;=' =&gt; 2, &nbsp;</div></li><li><div>      '=' =&gt; 2, &nbsp;</div></li><li><div>      '&lt;' =&gt; 3, &nbsp;</div></li><li><div>      '&gt;' =&gt; 2, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      '+' =&gt; 3, &nbsp;</div></li><li><div>      '-' =&gt; 3, &nbsp;</div></li><li><div>      '*' =&gt; 4, &nbsp;</div></li><li><div>      '/' =&gt; 4, &nbsp;</div></li><li><div>      '%' =&gt; 4, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $operators = array(&quot;+&quot;, &quot;-&quot;, &quot;*&quot;, &quot;/&quot;, &quot;%&quot;, &nbsp;</div></li><li><div>      &quot;==&quot;, &quot;!=&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;and&quot;, &quot;or&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $operatorStr;&nbsp;</div></li><li><div>  static protected $whitePattern;&nbsp;</div></li><li><div>  static protected $commentMulti;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected $commentSingle = &quot;<span class="comment">//&quot;;</span>&nbsp;</div></li><li><div>  static protected $commentMultiLeft = &quot;<span class="comment">/*&quot;;</span>&nbsp;</div></li><li><div><span class="comment">  static protected $commentMultiRight = &quot;*/</span>&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $sourceName</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $rootParser</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($sourceName = null, $rootParser = true) {&nbsp;</div></li><li><div>      $this-&gt;sourceName = $sourceName;&nbsp;</div></li><li><div>      $this-&gt;rootParser = $rootParser;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty(self::$operatorStr)) {&nbsp;</div></li><li><div>          self::$operatorStr = $this-&gt;makeOperatorStr(self::$operators);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $commentSingle = $this-&gt;preg_quote(self::$commentSingle);&nbsp;</div></li><li><div>          $commentMultiLeft = $this-&gt;preg_quote(self::$commentMultiLeft);&nbsp;</div></li><li><div>          $commentMultiRight = $this-&gt;preg_quote(self::$commentMultiRight);&nbsp;</div></li><li><div>          self::$commentMulti = $commentMultiLeft.'.*?'.$commentMultiRight;&nbsp;</div></li><li><div>          self::$whitePattern = '/'.$commentSingle.'[^\n]*\s*|('.self::$commentMulti.')\s*|\s+/Ais';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static protected function makeOperatorStr($operators) {&nbsp;</div></li><li><div>      return '('.implode('|', array_map(array('scss_parser', 'preg_quote'), &nbsp;</div></li><li><div>          $operators)).')';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parser buffer</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $buffer;</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return \StdClass</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function parse($buffer)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;count = 0;&nbsp;</div></li><li><div>      $this-&gt;env = null;&nbsp;</div></li><li><div>      $this-&gt;inParens = false;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = true;&nbsp;</div></li><li><div>      $this-&gt;insertComments = true;&nbsp;</div></li><li><div>      $this-&gt;buffer = $buffer;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;pushBlock(null); <span class="comment">// root block</span>&nbsp;</div></li><li><div>      $this-&gt;whitespace();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (false !== $this-&gt;parseChunk())&nbsp;</div></li><li><div>          ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;count != strlen($this-&gt;buffer)) {&nbsp;</div></li><li><div>          $this-&gt;throwParseError();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($this-&gt;env-&gt;parent)) {&nbsp;</div></li><li><div>          $this-&gt;throwParseError(&quot;unclosed block&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env-&gt;isRoot = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;env;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parse a single chunk off the head of the buffer and append it to the</span>&nbsp;</div></li><li><div><span class="comment">   * current parse environment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Returns false when the buffer is empty, or when there is an error.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This function is called repeatedly until the entire document is</span>&nbsp;</div></li><li><div><span class="comment">   * parsed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This parser is most similar to a recursive descent parser. Single</span>&nbsp;</div></li><li><div><span class="comment">   * functions represent discrete grammatical rules for the language, and</span>&nbsp;</div></li><li><div><span class="comment">   * they are able to capture the text that represents those rules.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Consider the function scssc::keyword(). (All parse functions are</span>&nbsp;</div></li><li><div><span class="comment">   * structured the same.)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The function takes a single reference argument. When calling the</span>&nbsp;</div></li><li><div><span class="comment">   * function it will attempt to match a keyword on the head of the buffer.</span>&nbsp;</div></li><li><div><span class="comment">   * If it is successful, it will place the keyword in the referenced</span>&nbsp;</div></li><li><div><span class="comment">   * argument, advance the position in the buffer, and return true. If it</span>&nbsp;</div></li><li><div><span class="comment">   * fails then it won't advance the buffer and it will return false.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * All of these parse functions are powered by scssc::match(), which behaves</span>&nbsp;</div></li><li><div><span class="comment">   * the same way, but takes a literal regular expression. Sometimes it is</span>&nbsp;</div></li><li><div><span class="comment">   * more convenient to use match instead of creating a new function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Because of the format of the functions, to parse an entire string of</span>&nbsp;</div></li><li><div><span class="comment">   * grammatical rules, you can chain them together using &&.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * But, if some of the rules in the chain succeed before one fails, then</span>&nbsp;</div></li><li><div><span class="comment">   * the buffer position will be left at an invalid state. In order to</span>&nbsp;</div></li><li><div><span class="comment">   * avoid this, scssc::seek() is used to remember and set buffer positions.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Before parsing a chain, use $s = $this-&gt;seek() to remember the current</span>&nbsp;</div></li><li><div><span class="comment">   * position into $s. Then if a chain fails, use $this-&gt;seek($s) to</span>&nbsp;</div></li><li><div><span class="comment">   * go back where we started.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function parseChunk() {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// the directives</span>&nbsp;</div></li><li><div>      if (isset($this-&gt;buffer[$this-&gt;count]) && $this-&gt;buffer[$this-&gt;count] == &quot;@&quot;) {&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@media&quot;) && $this-&gt;mediaQueryList($mediaQueryList) && $this-&gt;literal(&quot;{&quot;)) {&nbsp;</div></li><li><div>              $media = $this-&gt;pushSpecialBlock(&quot;media&quot;);&nbsp;</div></li><li><div>              $media-&gt;queryList = $mediaQueryList[2];&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@mixin&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;keyword($mixinName) &&&nbsp;</div></li><li><div>              ($this-&gt;argumentDef($args) || true) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $mixin = $this-&gt;pushSpecialBlock(&quot;mixin&quot;);&nbsp;</div></li><li><div>              $mixin-&gt;name = $mixinName;&nbsp;</div></li><li><div>              $mixin-&gt;args = $args;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@include&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;keyword($mixinName) &&&nbsp;</div></li><li><div>              ($this-&gt;literal(&quot;(&quot;) &&&nbsp;</div></li><li><div>                  ($this-&gt;argValues($argValues) || true) &&&nbsp;</div></li><li><div>                  $this-&gt;literal(&quot;)&quot;) || true) &&&nbsp;</div></li><li><div>              ($this-&gt;end() ||&nbsp;</div></li><li><div>                  $this-&gt;literal(&quot;{&quot;) && $hasBlock = true))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $child = array(&quot;include&quot;, &nbsp;</div></li><li><div>                  $mixinName, isset($argValues) ? $argValues : null, null);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (!empty($hasBlock)) {&nbsp;</div></li><li><div>                  $include = $this-&gt;pushSpecialBlock(&quot;include&quot;);&nbsp;</div></li><li><div>                  $include-&gt;child = $child;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;append($child, $s);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@import&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;valueList($importPath) &&&nbsp;</div></li><li><div>              $this-&gt;end())&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;import&quot;, $importPath), $s);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@extend&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;selectors($selector) &&&nbsp;</div></li><li><div>              $this-&gt;end())&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;extend&quot;, $selector), $s);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@function&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;keyword($fnName) &&&nbsp;</div></li><li><div>              $this-&gt;argumentDef($args) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $func = $this-&gt;pushSpecialBlock(&quot;function&quot;);&nbsp;</div></li><li><div>              $func-&gt;name = $fnName;&nbsp;</div></li><li><div>              $func-&gt;args = $args;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@return&quot;) && $this-&gt;valueList($retVal) && $this-&gt;end()) {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;return&quot;, $retVal), $s);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@each&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;variable($varName) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;in&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;valueList($list) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $each = $this-&gt;pushSpecialBlock(&quot;each&quot;);&nbsp;</div></li><li><div>              $each-&gt;var = $varName[1];&nbsp;</div></li><li><div>              $each-&gt;list = $list;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@while&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;expression($cond) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $while = $this-&gt;pushSpecialBlock(&quot;while&quot;);&nbsp;</div></li><li><div>              $while-&gt;cond = $cond;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@for&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;variable($varName) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;from&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;expression($start) &&&nbsp;</div></li><li><div>              ($this-&gt;literal(&quot;through&quot;) ||&nbsp;</div></li><li><div>                  ($forUntil = true && $this-&gt;literal(&quot;to&quot;))) &&&nbsp;</div></li><li><div>              $this-&gt;expression($end) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $for = $this-&gt;pushSpecialBlock(&quot;for&quot;);&nbsp;</div></li><li><div>              $for-&gt;var = $varName[1];&nbsp;</div></li><li><div>              $for-&gt;start = $start;&nbsp;</div></li><li><div>              $for-&gt;end = $end;&nbsp;</div></li><li><div>              $for-&gt;until = isset($forUntil);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@if&quot;) && $this-&gt;valueList($cond) && $this-&gt;literal(&quot;{&quot;)) {&nbsp;</div></li><li><div>              $if = $this-&gt;pushSpecialBlock(&quot;if&quot;);&nbsp;</div></li><li><div>              $if-&gt;cond = $cond;&nbsp;</div></li><li><div>              $if-&gt;cases = array();&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (($this-&gt;literal(&quot;@debug&quot;) || $this-&gt;literal(&quot;@warn&quot;)) &&&nbsp;</div></li><li><div>              $this-&gt;valueList($value) &&&nbsp;</div></li><li><div>              $this-&gt;end()) {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;debug&quot;, $value, $s), $s);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@content&quot;) && $this-&gt;end()) {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;mixin_content&quot;), $s);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $last = $this-&gt;last();&nbsp;</div></li><li><div>          if (isset($last) && $last[0] == &quot;if&quot;) {&nbsp;</div></li><li><div>              list(, $if) = $last;&nbsp;</div></li><li><div>              if ($this-&gt;literal(&quot;@else&quot;)) {&nbsp;</div></li><li><div>                  if ($this-&gt;literal(&quot;{&quot;)) {&nbsp;</div></li><li><div>                      $else = $this-&gt;pushSpecialBlock(&quot;else&quot;);&nbsp;</div></li><li><div>                  } elseif ($this-&gt;literal(&quot;if&quot;) && $this-&gt;valueList($cond) && $this-&gt;literal(&quot;{&quot;)) {&nbsp;</div></li><li><div>                      $else = $this-&gt;pushSpecialBlock(&quot;elseif&quot;);&nbsp;</div></li><li><div>                      $else-&gt;cond = $cond;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if (isset($else)) {&nbsp;</div></li><li><div>                      $else-&gt;dontAppend = true;&nbsp;</div></li><li><div>                      $if-&gt;cases[] = $else;&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@charset&quot;) &&&nbsp;</div></li><li><div>              $this-&gt;valueList($charset) && $this-&gt;end())&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;charset&quot;, $charset), $s);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// doesn't match built in directive, do generic one</span>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;@&quot;, false) && $this-&gt;keyword($dirName) &&&nbsp;</div></li><li><div>              ($this-&gt;openString(&quot;{&quot;, $dirValue) || true) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;{&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $directive = $this-&gt;pushSpecialBlock(&quot;directive&quot;);&nbsp;</div></li><li><div>              $directive-&gt;name = $dirName;&nbsp;</div></li><li><div>              if (isset($dirValue)) $directive-&gt;value = $dirValue;&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// property shortcut</span>&nbsp;</div></li><li><div>      <span class="comment">// captures most properties before having to parse a selector</span>&nbsp;</div></li><li><div>      if ($this-&gt;keyword($name, false) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;: &quot;) &&&nbsp;</div></li><li><div>          $this-&gt;valueList($value) &&&nbsp;</div></li><li><div>          $this-&gt;end())&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $name = array(&quot;string&quot;, &quot;&quot;, array($name));&nbsp;</div></li><li><div>          $this-&gt;append(array(&quot;assign&quot;, $name, $value), $s);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// variable assigns</span>&nbsp;</div></li><li><div>      if ($this-&gt;variable($name) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;:&quot;) &&&nbsp;</div></li><li><div>          $this-&gt;valueList($value) && $this-&gt;end())&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">// check for !default</span>&nbsp;</div></li><li><div>          $defaultVar = $value[0] == &quot;list&quot; && $this-&gt;stripDefault($value);&nbsp;</div></li><li><div>          $this-&gt;append(array(&quot;assign&quot;, $name, $value, $defaultVar), $s);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// misc</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;--&gt;&quot;)) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// opening css block</span>&nbsp;</div></li><li><div>      $oldComments = $this-&gt;insertComments;&nbsp;</div></li><li><div>      $this-&gt;insertComments = false;&nbsp;</div></li><li><div>      if ($this-&gt;selectors($selectors) && $this-&gt;literal(&quot;{&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;pushBlock($selectors);&nbsp;</div></li><li><div>          $this-&gt;insertComments = $oldComments;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;insertComments = $oldComments;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// property assign, or nested assign</span>&nbsp;</div></li><li><div>      if ($this-&gt;propertyName($name) && $this-&gt;literal(&quot;:&quot;)) {&nbsp;</div></li><li><div>          $foundSomething = false;&nbsp;</div></li><li><div>          if ($this-&gt;valueList($value)) {&nbsp;</div></li><li><div>              $this-&gt;append(array(&quot;assign&quot;, $name, $value), $s);&nbsp;</div></li><li><div>              $foundSomething = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;{&quot;)) {&nbsp;</div></li><li><div>              $propBlock = $this-&gt;pushSpecialBlock(&quot;nestedprop&quot;);&nbsp;</div></li><li><div>              $propBlock-&gt;prefix = $name;&nbsp;</div></li><li><div>              $foundSomething = true;&nbsp;</div></li><li><div>          } elseif ($foundSomething) {&nbsp;</div></li><li><div>              $foundSomething = $this-&gt;end();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($foundSomething) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// closing a block</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;}&quot;)) {&nbsp;</div></li><li><div>          $block = $this-&gt;popBlock();&nbsp;</div></li><li><div>          if (isset($block-&gt;type) && $block-&gt;type == &quot;include&quot;) {&nbsp;</div></li><li><div>              $include = $block-&gt;child;&nbsp;</div></li><li><div>              unset($block-&gt;child);&nbsp;</div></li><li><div>              $include[3] = $block;&nbsp;</div></li><li><div>              $this-&gt;append($include, $s);&nbsp;</div></li><li><div>          } elseif (empty($block-&gt;dontAppend)) {&nbsp;</div></li><li><div>              $type = isset($block-&gt;type) ? $block-&gt;type : &quot;block&quot;;&nbsp;</div></li><li><div>              $this-&gt;append(array($type, $block), $s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// extra stuff</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;;&quot;) ||&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;&lt;!--&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function stripDefault(&$value) {&nbsp;</div></li><li><div>      $def = end($value[2]);&nbsp;</div></li><li><div>      if ($def[0] == &quot;keyword&quot; && $def[1] == &quot;!default&quot;) {&nbsp;</div></li><li><div>          array_pop($value[2]);&nbsp;</div></li><li><div>          $value = $this-&gt;flattenList($value);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($def[0] == &quot;list&quot;) {&nbsp;</div></li><li><div>          return $this-&gt;stripDefault($value[2][count($value[2]) - 1]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function literal($what, $eatWhitespace = null) {&nbsp;</div></li><li><div>      if (!isset($eatWhitespace)) $eatWhitespace = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// shortcut on single letter</span>&nbsp;</div></li><li><div>      if (!isset($what[1]) && isset($this-&gt;buffer[$this-&gt;count])) {&nbsp;</div></li><li><div>          if ($this-&gt;buffer[$this-&gt;count] == $what) {&nbsp;</div></li><li><div>              if (!$eatWhitespace) {&nbsp;</div></li><li><div>                  $this-&gt;count++;&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// goes below...</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;match($this-&gt;preg_quote($what), $m, $eatWhitespace);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// tree builders</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function pushBlock($selectors) {&nbsp;</div></li><li><div>      $b = new stdClass;&nbsp;</div></li><li><div>      $b-&gt;parent = $this-&gt;env; <span class="comment">// not sure if we need this yet</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $b-&gt;selectors = $selectors;&nbsp;</div></li><li><div>      $b-&gt;children = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;env = $b;&nbsp;</div></li><li><div>      return $b;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function pushSpecialBlock($type) {&nbsp;</div></li><li><div>      $block = $this-&gt;pushBlock(null);&nbsp;</div></li><li><div>      $block-&gt;type = $type;&nbsp;</div></li><li><div>      return $block;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function popBlock() {&nbsp;</div></li><li><div>      if (empty($this-&gt;env-&gt;parent)) {&nbsp;</div></li><li><div>          $this-&gt;throwParseError(&quot;unexpected }&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $old = $this-&gt;env;&nbsp;</div></li><li><div>      $this-&gt;env = $this-&gt;env-&gt;parent;&nbsp;</div></li><li><div>      unset($old-&gt;parent);&nbsp;</div></li><li><div>      return $old;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function append($statement, $pos=null) {&nbsp;</div></li><li><div>      if ($pos !== null) {&nbsp;</div></li><li><div>          $statement[-1] = $pos;&nbsp;</div></li><li><div>          if (!$this-&gt;rootParser) $statement[-2] = $this;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;env-&gt;children[] = $statement;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// last child that was appended</span>&nbsp;</div></li><li><div>  protected function last() {&nbsp;</div></li><li><div>      $i = count($this-&gt;env-&gt;children) - 1;&nbsp;</div></li><li><div>      if (isset($this-&gt;env-&gt;children[$i]))&nbsp;</div></li><li><div>          return $this-&gt;env-&gt;children[$i];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// high level parsers (they return parts of ast)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaQueryList(&$out) {&nbsp;</div></li><li><div>      return $this-&gt;genericList($out, &quot;mediaQuery&quot;, &quot;, &quot;, false);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaQuery(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $expressions = null;&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (($this-&gt;literal(&quot;only&quot;) && ($only = true) || $this-&gt;literal(&quot;not&quot;) && ($not = true) || true) && $this-&gt;mixedKeyword($mediaType)) {&nbsp;</div></li><li><div>          $prop = array(&quot;mediaType&quot;);&nbsp;</div></li><li><div>          if (isset($only)) $prop[] = array(&quot;keyword&quot;, &quot;only&quot;);&nbsp;</div></li><li><div>          if (isset($not)) $prop[] = array(&quot;keyword&quot;, &quot;not&quot;);&nbsp;</div></li><li><div>          $media = array(&quot;list&quot;, &quot;&quot;, array());&nbsp;</div></li><li><div>          foreach ((array)$mediaType as $type) {&nbsp;</div></li><li><div>              if (is_array($type)) {&nbsp;</div></li><li><div>                  $media[2][] = $type;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $media[2][] = array(&quot;keyword&quot;, $type);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $prop[] = $media;&nbsp;</div></li><li><div>          $parts[] = $prop;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (empty($parts) || $this-&gt;literal(&quot;and&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;genericList($expressions, &quot;mediaExpression&quot;, &quot;and&quot;, false);&nbsp;</div></li><li><div>          if (is_array($expressions)) $parts = array_merge($parts, $expressions[2]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $parts;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mediaExpression(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $value = null;&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;(&quot;) &&&nbsp;</div></li><li><div>          $this-&gt;expression($feature) &&&nbsp;</div></li><li><div>          ($this-&gt;literal(&quot;:&quot;) && $this-&gt;expression($value) || true) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;)&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $out = array(&quot;mediaExp&quot;, $feature);&nbsp;</div></li><li><div>          if ($value) $out[] = $value;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function argValues(&$out) {&nbsp;</div></li><li><div>      if ($this-&gt;genericList($list, &quot;argValue&quot;, &quot;, &quot;, false)) {&nbsp;</div></li><li><div>          $out = $list[2];&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function argValue(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $keyword = null;&nbsp;</div></li><li><div>      if (!$this-&gt;variable($keyword) || !$this-&gt;literal(&quot;:&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          $keyword = null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;genericList($value, &quot;expression&quot;)) {&nbsp;</div></li><li><div>          $out = array($keyword, $value, false);&nbsp;</div></li><li><div>          $s = $this-&gt;seek();&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;...&quot;)) {&nbsp;</div></li><li><div>              $out[2] = true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parse list</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $out</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function valueList(&$out)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;genericList($out, 'spaceList', ', ');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function spaceList(&$out)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;genericList($out, 'expression');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function genericList(&$out, $parseItem, $delim=&quot;&quot;, $flatten=true) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $items = array();&nbsp;</div></li><li><div>      while ($this-&gt;$parseItem($value)) {&nbsp;</div></li><li><div>          $items[] = $value;&nbsp;</div></li><li><div>          if ($delim) {&nbsp;</div></li><li><div>              if (!$this-&gt;literal($delim)) break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($items) == 0) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($flatten && count($items) == 1) {&nbsp;</div></li><li><div>          $out = $items[0];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $out = array(&quot;list&quot;, $delim, $items);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function expression(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;(&quot;)) {&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>              $out = array(&quot;list&quot;, &quot;&quot;, array());&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;valueList($out) && $this-&gt;literal(')') && $out[0] == &quot;list&quot;) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;value($lhs)) {&nbsp;</div></li><li><div>          $out = $this-&gt;expHelper($lhs, 0);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function expHelper($lhs, $minP) {&nbsp;</div></li><li><div>      $opstr = self::$operatorStr;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ss = $this-&gt;seek();&nbsp;</div></li><li><div>      $whiteBefore = isset($this-&gt;buffer[$this-&gt;count - 1]) &&&nbsp;</div></li><li><div>          ctype_space($this-&gt;buffer[$this-&gt;count - 1]);&nbsp;</div></li><li><div>      while ($this-&gt;match($opstr, $m) && self::$precedence[$m[1]] &gt;= $minP) {&nbsp;</div></li><li><div>          $whiteAfter = isset($this-&gt;buffer[$this-&gt;count - 1]) &&&nbsp;</div></li><li><div>              ctype_space($this-&gt;buffer[$this-&gt;count - 1]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $op = $m[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// don't turn negative numbers into expressions</span>&nbsp;</div></li><li><div>          if ($op == &quot;-&quot; && $whiteBefore) {&nbsp;</div></li><li><div>              if (!$whiteAfter) break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$this-&gt;value($rhs)) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// peek and see if rhs belongs to next operator</span>&nbsp;</div></li><li><div>          if ($this-&gt;peek($opstr, $next) && self::$precedence[$next[1]] &gt; self::$precedence[$op]) {&nbsp;</div></li><li><div>              $rhs = $this-&gt;expHelper($rhs, self::$precedence[$next[1]]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lhs = array(&quot;exp&quot;, $op, $lhs, $rhs, $this-&gt;inParens, $whiteBefore, $whiteAfter);&nbsp;</div></li><li><div>          $ss = $this-&gt;seek();&nbsp;</div></li><li><div>          $whiteBefore = isset($this-&gt;buffer[$this-&gt;count - 1]) &&&nbsp;</div></li><li><div>              ctype_space($this-&gt;buffer[$this-&gt;count - 1]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($ss);&nbsp;</div></li><li><div>      return $lhs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function value(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;not&quot;, false) && $this-&gt;whitespace() && $this-&gt;value($inner)) {&nbsp;</div></li><li><div>          $out = array(&quot;unary&quot;, &quot;not&quot;, $inner, $this-&gt;inParens);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;+&quot;) && $this-&gt;value($inner)) {&nbsp;</div></li><li><div>          $out = array(&quot;unary&quot;, &quot;+&quot;, $inner, $this-&gt;inParens);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// negation</span>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;-&quot;, false) &&&nbsp;</div></li><li><div>          ($this-&gt;variable($inner) ||&nbsp;</div></li><li><div>          $this-&gt;unit($inner) ||&nbsp;</div></li><li><div>          $this-&gt;parenValue($inner)))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $out = array(&quot;unary&quot;, &quot;-&quot;, $inner, $this-&gt;inParens);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;parenValue($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;interpolation($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;variable($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;color($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;unit($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;string($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;func($out)) return true;&nbsp;</div></li><li><div>      if ($this-&gt;progid($out)) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;keyword($keyword)) {&nbsp;</div></li><li><div>          if ($keyword == &quot;null&quot;) {&nbsp;</div></li><li><div>              $out = array(&quot;null&quot;);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $out = array(&quot;keyword&quot;, $keyword);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// value wrappen in parentheses</span>&nbsp;</div></li><li><div>  protected function parenValue(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inParens = $this-&gt;inParens;&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;(&quot;) &&&nbsp;</div></li><li><div>          ($this-&gt;inParens = true) && $this-&gt;expression($exp) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;)&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $out = $exp;&nbsp;</div></li><li><div>          $this-&gt;inParens = $inParens;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;inParens = $inParens;&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function progid(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;progid:&quot;, false) &&&nbsp;</div></li><li><div>          $this-&gt;openString(&quot;(&quot;, $fn) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;(&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $this-&gt;openString(&quot;)&quot;, $args, &quot;(&quot;);&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>              $out = array(&quot;string&quot;, &quot;&quot;, array(&nbsp;</div></li><li><div>                  &quot;progid:&quot;, $fn, &quot;(&quot;, $args, &quot;)&quot;&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function func(&$func) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;keyword($name, false) &&&nbsp;</div></li><li><div>          $this-&gt;literal(&quot;(&quot;))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if ($name == &quot;alpha&quot; && $this-&gt;argumentList($args)) {&nbsp;</div></li><li><div>              $func = array(&quot;function&quot;, $name, array(&quot;string&quot;, &quot;&quot;, $args));&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($name != &quot;expression&quot; && !preg_match(&quot;/^(-[a-z]+-)?calc$/&quot;, $name)) {&nbsp;</div></li><li><div>              $ss = $this-&gt;seek();&nbsp;</div></li><li><div>              if ($this-&gt;argValues($args) && $this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>                  $func = array(&quot;fncall&quot;, $name, $args);&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;seek($ss);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (($this-&gt;openString(&quot;)&quot;, $str, &quot;(&quot;) || true ) &&&nbsp;</div></li><li><div>              $this-&gt;literal(&quot;)&quot;))&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $args = array();&nbsp;</div></li><li><div>              if (!empty($str)) {&nbsp;</div></li><li><div>                  $args[] = array(null, array(&quot;string&quot;, &quot;&quot;, array($str)));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $func = array(&quot;fncall&quot;, $name, $args);&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function argumentList(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $this-&gt;literal(&quot;(&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>      while ($this-&gt;keyword($var)) {&nbsp;</div></li><li><div>          $ss = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;=&quot;) && $this-&gt;expression($exp)) {&nbsp;</div></li><li><div>              $args[] = array(&quot;string&quot;, &quot;&quot;, array($var.&quot;=&quot;));&nbsp;</div></li><li><div>              $arg = $exp;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args[] = $arg;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$this-&gt;literal(&quot;, &quot;)) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args[] = array(&quot;string&quot;, &quot;&quot;, array(&quot;, &quot;));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;literal(&quot;)&quot;) || !count($args)) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $args;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function argumentDef(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $this-&gt;literal(&quot;(&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>      while ($this-&gt;variable($var)) {&nbsp;</div></li><li><div>          $arg = array($var[1], null, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ss = $this-&gt;seek();&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;:&quot;) && $this-&gt;genericList($defaultVal, &quot;expression&quot;)) {&nbsp;</div></li><li><div>              $arg[1] = $defaultVal;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($ss);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ss = $this-&gt;seek();&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;...&quot;)) {&nbsp;</div></li><li><div>              $sss = $this-&gt;seek();&nbsp;</div></li><li><div>              if (!$this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>                  $this-&gt;throwParseError(&quot;... has to be after the final argument&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $arg[2] = true;&nbsp;</div></li><li><div>              $this-&gt;seek($sss);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($ss);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args[] = $arg;&nbsp;</div></li><li><div>          if (!$this-&gt;literal(&quot;, &quot;)) break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$this-&gt;literal(&quot;)&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $args;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function color(&$out) {&nbsp;</div></li><li><div>      $color = array('color');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;match('(#([0-9a-f]{6})|#([0-9a-f]{3}))', $m)) {&nbsp;</div></li><li><div>          if (isset($m[3])) {&nbsp;</div></li><li><div>              $num = $m[3];&nbsp;</div></li><li><div>              $width = 16;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $num = $m[2];&nbsp;</div></li><li><div>              $width = 256;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $num = hexdec($num);&nbsp;</div></li><li><div>          foreach (array(3, 2, 1) as $i) {&nbsp;</div></li><li><div>              $t = $num % $width;&nbsp;</div></li><li><div>              $num /= $width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $color[$i] = $t * (256/$width) + $t * floor(16/$width);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $out = $color;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function unit(&$unit) {&nbsp;</div></li><li><div>      if ($this-&gt;match('([0-9]*(\.)?[0-9]+)([%a-zA-Z]+)?', $m)) {&nbsp;</div></li><li><div>          $unit = array(&quot;number&quot;, $m[1], empty($m[3]) ? &quot;&quot; : $m[3]);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function string(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal('&quot;', false)) {&nbsp;</div></li><li><div>          $delim = '&quot;';&nbsp;</div></li><li><div>      } elseif ($this-&gt;literal(&quot;'&quot;, false)) {&nbsp;</div></li><li><div>          $delim = &quot;'&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = array();&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ($this-&gt;matchString($m, $delim)) {&nbsp;</div></li><li><div>          $content[] = $m[1];&nbsp;</div></li><li><div>          if ($m[2] == &quot;#{&quot;) {&nbsp;</div></li><li><div>              $this-&gt;count -= strlen($m[2]);&nbsp;</div></li><li><div>              if ($this-&gt;interpolation($inter, false)) {&nbsp;</div></li><li><div>                  $content[] = $inter;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;count += strlen($m[2]);&nbsp;</div></li><li><div>                  $content[] = &quot;#{&quot;; <span class="comment">// ignore it</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif ($m[2] == '\\') {&nbsp;</div></li><li><div>              $content[] = $m[2];&nbsp;</div></li><li><div>              if ($this-&gt;literal($delim, false)) {&nbsp;</div></li><li><div>                  $content[] = $delim;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;count -= strlen($delim);&nbsp;</div></li><li><div>              break; <span class="comment">// delim</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal($delim)) {&nbsp;</div></li><li><div>          $out = array(&quot;string&quot;, $delim, $content);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function mixedKeyword(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          if ($this-&gt;keyword($key)) {&nbsp;</div></li><li><div>              $parts[] = $key;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;interpolation($inter)) {&nbsp;</div></li><li><div>              $parts[] = $inter;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($parts) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;eatWhiteDefault) {&nbsp;</div></li><li><div>          $this-&gt;whitespace();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $parts;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// an unbounded string stopped by $end</span>&nbsp;</div></li><li><div>  protected function openString($end, &$out, $nestingOpen=null) {&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stop = array(&quot;'&quot;, '&quot;', &quot;#{&quot;, $end);&nbsp;</div></li><li><div>      $stop = array_map(array($this, &quot;preg_quote&quot;), $stop);&nbsp;</div></li><li><div>      $stop[] = self::$commentMulti;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $patt = '(.*?)('.implode(&quot;|&quot;, $stop).')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $nestingLevel = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = array();&nbsp;</div></li><li><div>      while ($this-&gt;match($patt, $m, false)) {&nbsp;</div></li><li><div>          if (isset($m[1]) && $m[1] !== '') {&nbsp;</div></li><li><div>              $content[] = $m[1];&nbsp;</div></li><li><div>              if ($nestingOpen) {&nbsp;</div></li><li><div>                  $nestingLevel += substr_count($m[1], $nestingOpen);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tok = $m[2];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;count-= strlen($tok);&nbsp;</div></li><li><div>          if ($tok == $end) {&nbsp;</div></li><li><div>              if ($nestingLevel == 0) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $nestingLevel--;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (($tok == &quot;'&quot; || $tok == '&quot;') && $this-&gt;string($str)) {&nbsp;</div></li><li><div>              $content[] = $str;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($tok == &quot;#{&quot; && $this-&gt;interpolation($inter)) {&nbsp;</div></li><li><div>              $content[] = $inter;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $content[] = $tok;&nbsp;</div></li><li><div>          $this-&gt;count+= strlen($tok);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($content) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// trim the end</span>&nbsp;</div></li><li><div>      if (is_string(end($content))) {&nbsp;</div></li><li><div>          $content[count($content) - 1] = rtrim(end($content));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array(&quot;string&quot;, &quot;&quot;, $content);&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// $lookWhite: save information about whitespace before and after</span>&nbsp;</div></li><li><div>  protected function interpolation(&$out, $lookWhite=true) {&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;#{&quot;) && $this-&gt;valueList($value) && $this-&gt;literal(&quot;}&quot;, false)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// TODO: don't error if out of bounds</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($lookWhite) {&nbsp;</div></li><li><div>              $left = preg_match('/\s/', $this-&gt;buffer[$s - 1]) ? &quot; &quot; : &quot;&quot;;&nbsp;</div></li><li><div>              $right = preg_match('/\s/', $this-&gt;buffer[$this-&gt;count]) ? &quot; &quot;: &quot;&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $left = $right = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $out = array(&quot;interpolate&quot;, $value, $left, $right);&nbsp;</div></li><li><div>          $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>          if ($this-&gt;eatWhiteDefault) $this-&gt;whitespace();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// low level parsers</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// returns an array of parts or a string</span>&nbsp;</div></li><li><div>  protected function propertyName(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          if ($this-&gt;interpolation($inter)) {&nbsp;</div></li><li><div>              $parts[] = $inter;&nbsp;</div></li><li><div>          } elseif ($this-&gt;keyword($text)) {&nbsp;</div></li><li><div>              $parts[] = $text;&nbsp;</div></li><li><div>          } elseif (count($parts) == 0 && $this-&gt;match('[:.#]', $m, false)) {&nbsp;</div></li><li><div>              <span class="comment">// css hacks</span>&nbsp;</div></li><li><div>              $parts[] = $m[0];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>      if (count($parts) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// match comment hack</span>&nbsp;</div></li><li><div>      if (preg_match(self::$whitePattern, &nbsp;</div></li><li><div>          $this-&gt;buffer, $m, null, $this-&gt;count))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          if (!empty($m[0])) {&nbsp;</div></li><li><div>              $parts[] = $m[0];&nbsp;</div></li><li><div>              $this-&gt;count += strlen($m[0]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;whitespace(); <span class="comment">// get any extra whitespace</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = array(&quot;string&quot;, &quot;&quot;, $parts);&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// comma separated list of selectors</span>&nbsp;</div></li><li><div>  protected function selectors(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      $selectors = array();&nbsp;</div></li><li><div>      while ($this-&gt;selector($sel)) {&nbsp;</div></li><li><div>          $selectors[] = $sel;&nbsp;</div></li><li><div>          if (!$this-&gt;literal(&quot;, &quot;)) break;&nbsp;</div></li><li><div>          while ($this-&gt;literal(&quot;, &quot;)); <span class="comment">// ignore extra</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($selectors) == 0) {&nbsp;</div></li><li><div>          $this-&gt;seek($s);&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $selectors;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// whitespace separated list of selectorSingle</span>&nbsp;</div></li><li><div>  protected function selector(&$out) {&nbsp;</div></li><li><div>      $selector = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          if ($this-&gt;match('[&gt;+~]+', $m)) {&nbsp;</div></li><li><div>              $selector[] = array($m[0]);&nbsp;</div></li><li><div>          } elseif ($this-&gt;selectorSingle($part)) {&nbsp;</div></li><li><div>              $selector[] = $part;&nbsp;</div></li><li><div>              $this-&gt;whitespace();&nbsp;</div></li><li><div>          } elseif ($this-&gt;match('\/[^\/]+\/', $m)) {&nbsp;</div></li><li><div>              $selector[] = array($m[0]);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($selector) == 0) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $selector;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// the parts that make up</span>&nbsp;</div></li><li><div>  <span class="comment">// div[yes=no]#something.hello.world:nth-child(-2n+1)%placeholder</span>&nbsp;</div></li><li><div>  protected function selectorSingle(&$out) {&nbsp;</div></li><li><div>      $oldWhite = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;*&quot;, false)) {&nbsp;</div></li><li><div>          $parts[] = &quot;*&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while (true) {&nbsp;</div></li><li><div>          <span class="comment">// see if we can stop early</span>&nbsp;</div></li><li><div>          if ($this-&gt;match(&quot;\s*[{, ]&quot;, $m)) {&nbsp;</div></li><li><div>              $this-&gt;count--;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $s = $this-&gt;seek();&nbsp;</div></li><li><div>          <span class="comment">// self</span>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;&&quot;, false)) {&nbsp;</div></li><li><div>              $parts[] = scssc::$selfSelector;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;.&quot;, false)) {&nbsp;</div></li><li><div>              $parts[] = &quot;.&quot;;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;|&quot;, false)) {&nbsp;</div></li><li><div>              $parts[] = &quot;|&quot;;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// for keyframes</span>&nbsp;</div></li><li><div>          if ($this-&gt;unit($unit)) {&nbsp;</div></li><li><div>              $parts[] = $unit;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;keyword($name)) {&nbsp;</div></li><li><div>              $parts[] = $name;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;interpolation($inter)) {&nbsp;</div></li><li><div>              $parts[] = $inter;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal('%', false) && $this-&gt;placeholder($placeholder)) {&nbsp;</div></li><li><div>              $parts[] = '%';&nbsp;</div></li><li><div>              $parts[] = $placeholder;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;#&quot;, false)) {&nbsp;</div></li><li><div>              $parts[] = &quot;#&quot;;&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// a pseudo selector</span>&nbsp;</div></li><li><div>          if ($this-&gt;match(&quot;::?&quot;, $m) && $this-&gt;mixedKeyword($nameParts)) {&nbsp;</div></li><li><div>              $parts[] = $m[0];&nbsp;</div></li><li><div>              foreach ($nameParts as $sub) {&nbsp;</div></li><li><div>                  $parts[] = $sub;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ss = $this-&gt;seek();&nbsp;</div></li><li><div>              if ($this-&gt;literal(&quot;(&quot;) &&&nbsp;</div></li><li><div>                  ($this-&gt;openString(&quot;)&quot;, $str, &quot;(&quot;) || true ) &&&nbsp;</div></li><li><div>                  $this-&gt;literal(&quot;)&quot;))&nbsp;</div></li><li><div>              {&nbsp;</div></li><li><div>                  $parts[] = &quot;(&quot;;&nbsp;</div></li><li><div>                  if (!empty($str)) $parts[] = $str;&nbsp;</div></li><li><div>                  $parts[] = &quot;)&quot;;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;seek($ss);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// attribute selector</span>&nbsp;</div></li><li><div>          <span class="comment">// TODO: replace with open string?</span>&nbsp;</div></li><li><div>          if ($this-&gt;literal(&quot;[&quot;, false)) {&nbsp;</div></li><li><div>              $attrParts = array(&quot;[&quot;);&nbsp;</div></li><li><div>              <span class="comment">// keyword, string, operator</span>&nbsp;</div></li><li><div>              while (true) {&nbsp;</div></li><li><div>                  if ($this-&gt;literal(&quot;]&quot;, false)) {&nbsp;</div></li><li><div>                      $this-&gt;count--;&nbsp;</div></li><li><div>                      break; <span class="comment">// get out early</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($this-&gt;match('\s+', $m)) {&nbsp;</div></li><li><div>                      $attrParts[] = &quot; &quot;;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ($this-&gt;string($str)) {&nbsp;</div></li><li><div>                      $attrParts[] = $str;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($this-&gt;keyword($word)) {&nbsp;</div></li><li><div>                      $attrParts[] = $word;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ($this-&gt;interpolation($inter, false)) {&nbsp;</div></li><li><div>                      $attrParts[] = $inter;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// operator, handles attr namespace too</span>&nbsp;</div></li><li><div>                  if ($this-&gt;match('[|-~\$\*\^=]+', $m)) {&nbsp;</div></li><li><div>                      $attrParts[] = $m[0];&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($this-&gt;literal(&quot;]&quot;, false)) {&nbsp;</div></li><li><div>                  $attrParts[] = &quot;]&quot;;&nbsp;</div></li><li><div>                  foreach ($attrParts as $part) {&nbsp;</div></li><li><div>                      $parts[] = $part;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;seek($s);&nbsp;</div></li><li><div>              <span class="comment">// should just break here?</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;eatWhiteDefault = $oldWhite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (count($parts) == 0) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $out = $parts;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function variable(&$out) {&nbsp;</div></li><li><div>      $s = $this-&gt;seek();&nbsp;</div></li><li><div>      if ($this-&gt;literal(&quot;$&quot;, false) && $this-&gt;keyword($name)) {&nbsp;</div></li><li><div>          $out = array(&quot;var&quot;, $name);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;seek($s);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function keyword(&$word, $eatWhitespace = null) {&nbsp;</div></li><li><div>      if ($this-&gt;match('([\w_\-\*!&quot;\'\\\\][\w\-_&quot;\'\\\\]*)', &nbsp;</div></li><li><div>          $m, $eatWhitespace))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $word = $m[1];&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function placeholder(&$placeholder) {&nbsp;</div></li><li><div>      if ($this-&gt;match('([\w\-_]+)', $m)) {&nbsp;</div></li><li><div>          $placeholder = $m[1];&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// consume an end of statement delimiter</span>&nbsp;</div></li><li><div>  protected function end() {&nbsp;</div></li><li><div>      if ($this-&gt;literal(';')) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ($this-&gt;count == strlen($this-&gt;buffer) || $this-&gt;buffer[$this-&gt;count] == '}') {&nbsp;</div></li><li><div>          <span class="comment">// if there is end of file or a closing block next then we don't need a ;</span>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// advance counter to next occurrence of $what</span>&nbsp;</div></li><li><div>  <span class="comment">// $until - don't include $what in advance</span>&nbsp;</div></li><li><div>  <span class="comment">// $allowNewline, if string, will be used as valid char set</span>&nbsp;</div></li><li><div>  protected function to($what, &$out, $until = false, $allowNewline = false) {&nbsp;</div></li><li><div>      if (is_string($allowNewline)) {&nbsp;</div></li><li><div>          $validChars = $allowNewline;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $validChars = $allowNewline ? &quot;.&quot; : &quot;[^\n]&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$this-&gt;match('('.$validChars.'*?)'.$this-&gt;preg_quote($what), $m, !$until)) return false;&nbsp;</div></li><li><div>      if ($until) $this-&gt;count -= strlen($what); <span class="comment">// give back $what</span>&nbsp;</div></li><li><div>      $out = $m[1];&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function throwParseError($msg = &quot;parse error&quot;, $count = null) {&nbsp;</div></li><li><div>      $count = !isset($count) ? $this-&gt;count : $count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $line = $this-&gt;getLineNo($count);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($this-&gt;sourceName)) {&nbsp;</div></li><li><div>          $loc = &quot;$this-&gt;sourceName on line $line&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $loc = &quot;line: $line&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;peek(&quot;(.*?)(\n|$)&quot;, $m, $count)) {&nbsp;</div></li><li><div>          throw new Exception(&quot;$msg: failed at `$m[1]` $loc&quot;);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          throw new Exception(&quot;$msg: $loc&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function getLineNo($pos) {&nbsp;</div></li><li><div>      return 1 + substr_count(substr($this-&gt;buffer, 0, $pos), &quot;\n&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Match string looking for either ending delim, escape, or string interpolation</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * {@internal This is a workaround for preg_match's 250K string match limit. }}</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $m     Matches (passed by reference)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $delim Delimeter</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if match; false otherwise</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function matchString(&$m, $delim) {&nbsp;</div></li><li><div>      $token = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $end = strpos($this-&gt;buffer, &quot;\n&quot;, $this-&gt;count);&nbsp;</div></li><li><div>      if ($end === false || $this-&gt;buffer[$end - 1] == '\\' || $this-&gt;buffer[$end - 2] == '\\' && $this-&gt;buffer[$end - 1] == &quot;\r&quot;) {&nbsp;</div></li><li><div>          $end = strlen($this-&gt;buffer);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// look for either ending delim, escape, or string interpolation</span>&nbsp;</div></li><li><div>      foreach (array('#{', '\\', $delim) as $lookahead) {&nbsp;</div></li><li><div>          $pos = strpos($this-&gt;buffer, $lookahead, $this-&gt;count);&nbsp;</div></li><li><div>          if ($pos !== false && $pos &lt; $end) {&nbsp;</div></li><li><div>              $end = $pos;&nbsp;</div></li><li><div>              $token = $lookahead;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($token)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $match = substr($this-&gt;buffer, $this-&gt;count, $end - $this-&gt;count);&nbsp;</div></li><li><div>      $m = array(&nbsp;</div></li><li><div>          $match . $token, &nbsp;</div></li><li><div>          $match, &nbsp;</div></li><li><div>          $token&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $this-&gt;count = $end + strlen($token);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// try to match something on head of buffer</span>&nbsp;</div></li><li><div>  protected function match($regex, &$out, $eatWhitespace = null) {&nbsp;</div></li><li><div>      if (!isset($eatWhitespace)) $eatWhitespace = $this-&gt;eatWhiteDefault;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = '/'.$regex.'/Ais';&nbsp;</div></li><li><div>      if (preg_match($r, $this-&gt;buffer, $out, null, $this-&gt;count)) {&nbsp;</div></li><li><div>          $this-&gt;count += strlen($out[0]);&nbsp;</div></li><li><div>          if ($eatWhitespace) $this-&gt;whitespace();&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// match some whitespace</span>&nbsp;</div></li><li><div>  protected function whitespace() {&nbsp;</div></li><li><div>      $gotWhite = false;&nbsp;</div></li><li><div>      while (preg_match(self::$whitePattern, $this-&gt;buffer, $m, null, $this-&gt;count)) {&nbsp;</div></li><li><div>          if ($this-&gt;insertComments) {&nbsp;</div></li><li><div>              if (isset($m[1]) && empty($this-&gt;commentsSeen[$this-&gt;count])) {&nbsp;</div></li><li><div>                  $this-&gt;append(array(&quot;comment&quot;, $m[1]));&nbsp;</div></li><li><div>                  $this-&gt;commentsSeen[$this-&gt;count] = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;count += strlen($m[0]);&nbsp;</div></li><li><div>          $gotWhite = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $gotWhite;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function peek($regex, &$out, $from=null) {&nbsp;</div></li><li><div>      if (!isset($from)) $from = $this-&gt;count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $r = '/'.$regex.'/Ais';&nbsp;</div></li><li><div>      $result = preg_match($r, $this-&gt;buffer, $out, null, $from);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function seek($where = null) {&nbsp;</div></li><li><div>      if ($where === null) return $this-&gt;count;&nbsp;</div></li><li><div>      else $this-&gt;count = $where;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function preg_quote($what) {&nbsp;</div></li><li><div>      return preg_quote($what, '/');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function show() {&nbsp;</div></li><li><div>      if ($this-&gt;peek(&quot;(.*?)(\n|$)&quot;, $m, $this-&gt;count)) {&nbsp;</div></li><li><div>          return $m[1];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// turn list of length 1 into value type</span>&nbsp;</div></li><li><div>  protected function flattenList($value) {&nbsp;</div></li><li><div>      if ($value[0] == &quot;list&quot; && count($value[2]) == 1) {&nbsp;</div></li><li><div>          return $this-&gt;flattenList($value[2][0]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS base formatter</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class scss_formatter {&nbsp;</div></li><li><div>  public $indentChar = &quot;  &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $break = &quot;\n&quot;;&nbsp;</div></li><li><div>  public $open = &quot; {&quot;;&nbsp;</div></li><li><div>  public $close = &quot;}&quot;;&nbsp;</div></li><li><div>  public $tagSeparator = &quot;, &quot;;&nbsp;</div></li><li><div>  public $assignSeparator = &quot;: &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>      $this-&gt;indentLevel = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function indentStr($n = 0) {&nbsp;</div></li><li><div>      return str_repeat($this-&gt;indentChar, max($this-&gt;indentLevel + $n, 0));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function property($name, $value) {&nbsp;</div></li><li><div>      return $name . $this-&gt;assignSeparator . $value . &quot;;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function block($block) {&nbsp;</div></li><li><div>      if (empty($block-&gt;lines) && empty($block-&gt;children)) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inner = $pre = $this-&gt;indentStr();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;selectors)) {&nbsp;</div></li><li><div>          echo $pre .&nbsp;</div></li><li><div>              implode($this-&gt;tagSeparator, $block-&gt;selectors) .&nbsp;</div></li><li><div>              $this-&gt;open . $this-&gt;break;&nbsp;</div></li><li><div>          $this-&gt;indentLevel++;&nbsp;</div></li><li><div>          $inner = $this-&gt;indentStr();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;lines)) {&nbsp;</div></li><li><div>          $glue = $this-&gt;break.$inner;&nbsp;</div></li><li><div>          echo $inner . implode($glue, $block-&gt;lines);&nbsp;</div></li><li><div>          if (!empty($block-&gt;children)) {&nbsp;</div></li><li><div>              echo $this-&gt;break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($block-&gt;children as $child) {&nbsp;</div></li><li><div>          $this-&gt;block($child);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;selectors)) {&nbsp;</div></li><li><div>          $this-&gt;indentLevel--;&nbsp;</div></li><li><div>          if (empty($block-&gt;children)) echo $this-&gt;break;&nbsp;</div></li><li><div>          echo $pre . $this-&gt;close . $this-&gt;break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function format($block) {&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      $this-&gt;block($block);&nbsp;</div></li><li><div>      $out = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS nested formatter</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class scss_formatter_nested extends scss_formatter {&nbsp;</div></li><li><div>  public $close = &quot; }&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// adjust the depths of all children, depth first</span>&nbsp;</div></li><li><div>  public function adjustAllChildren($block) {&nbsp;</div></li><li><div>      <span class="comment">// flatten empty nested blocks</span>&nbsp;</div></li><li><div>      $children = array();&nbsp;</div></li><li><div>      foreach ($block-&gt;children as $i =&gt; $child) {&nbsp;</div></li><li><div>          if (empty($child-&gt;lines) && empty($child-&gt;children)) {&nbsp;</div></li><li><div>              if (isset($block-&gt;children[$i + 1])) {&nbsp;</div></li><li><div>                  $block-&gt;children[$i + 1]-&gt;depth = $child-&gt;depth;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $children[] = $child;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $count = count($children);&nbsp;</div></li><li><div>      for ($i = 0; $i &lt; $count; $i++) {&nbsp;</div></li><li><div>          $depth = $children[$i]-&gt;depth;&nbsp;</div></li><li><div>          $j = $i + 1;&nbsp;</div></li><li><div>          if (isset($children[$j]) && $depth &lt; $children[$j]-&gt;depth) {&nbsp;</div></li><li><div>              $childDepth = $children[$j]-&gt;depth;&nbsp;</div></li><li><div>              for (; $j &lt; $count; $j++) {&nbsp;</div></li><li><div>                  if ($depth &lt; $children[$j]-&gt;depth && $childDepth &gt;= $children[$j]-&gt;depth) {&nbsp;</div></li><li><div>                      $children[$j]-&gt;depth = $depth + 1;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $block-&gt;children = $children;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// make relative to parent</span>&nbsp;</div></li><li><div>      foreach ($block-&gt;children as $child) {&nbsp;</div></li><li><div>          $this-&gt;adjustAllChildren($child);&nbsp;</div></li><li><div>          $child-&gt;depth = $child-&gt;depth - $block-&gt;depth;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function block($block) {&nbsp;</div></li><li><div>      if ($block-&gt;type == &quot;root&quot;) {&nbsp;</div></li><li><div>          $this-&gt;adjustAllChildren($block);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inner = $pre = $this-&gt;indentStr($block-&gt;depth - 1);&nbsp;</div></li><li><div>      if (!empty($block-&gt;selectors)) {&nbsp;</div></li><li><div>          echo $pre .&nbsp;</div></li><li><div>              implode($this-&gt;tagSeparator, $block-&gt;selectors) .&nbsp;</div></li><li><div>              $this-&gt;open . $this-&gt;break;&nbsp;</div></li><li><div>          $this-&gt;indentLevel++;&nbsp;</div></li><li><div>          $inner = $this-&gt;indentStr($block-&gt;depth - 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;lines)) {&nbsp;</div></li><li><div>          $glue = $this-&gt;break.$inner;&nbsp;</div></li><li><div>          echo $inner . implode($glue, $block-&gt;lines);&nbsp;</div></li><li><div>          if (!empty($block-&gt;children)) echo $this-&gt;break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($block-&gt;children as $i =&gt; $child) {&nbsp;</div></li><li><div>          <span class="comment">// echo &quot;*** block: &quot;.$block-&gt;depth.&quot; child: &quot;.$child-&gt;depth.&quot;\n&quot;;</span>&nbsp;</div></li><li><div>          $this-&gt;block($child);&nbsp;</div></li><li><div>          if ($i &lt; count($block-&gt;children) - 1) {&nbsp;</div></li><li><div>              echo $this-&gt;break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (isset($block-&gt;children[$i + 1])) {&nbsp;</div></li><li><div>                  $next = $block-&gt;children[$i + 1];&nbsp;</div></li><li><div>                  if ($next-&gt;depth == max($block-&gt;depth, 1) && $child-&gt;depth &gt;= $next-&gt;depth) {&nbsp;</div></li><li><div>                      echo $this-&gt;break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!empty($block-&gt;selectors)) {&nbsp;</div></li><li><div>          $this-&gt;indentLevel--;&nbsp;</div></li><li><div>          echo $this-&gt;close;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($block-&gt;type == &quot;root&quot;) {&nbsp;</div></li><li><div>          echo $this-&gt;break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS compressed formatter</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class scss_formatter_compressed extends scss_formatter {&nbsp;</div></li><li><div>  public $open = &quot;{&quot;;&nbsp;</div></li><li><div>  public $tagSeparator = &quot;, &quot;;&nbsp;</div></li><li><div>  public $assignSeparator = &quot;:&quot;;&nbsp;</div></li><li><div>  public $break = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function indentStr($n = 0) {&nbsp;</div></li><li><div>      return &quot;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * SCSS server</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Leaf Corcoran &lt;leafot@gmail.com&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class scss_server {&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Join path components</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $left  Path component, left of the directory separator</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $right Path component, right of the directory separator</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function join($left, $right) {&nbsp;</div></li><li><div>      return rtrim($left, '/\\') . DIRECTORY_SEPARATOR . ltrim($right, '/\\');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get name of requested .scss file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string|null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function inputName() {&nbsp;</div></li><li><div>      switch (true) {&nbsp;</div></li><li><div>          case isset($_GET['p']):&nbsp;</div></li><li><div>              return $_GET['p'];&nbsp;</div></li><li><div>          case isset($_SERVER['PATH_INFO']):&nbsp;</div></li><li><div>              return $_SERVER['PATH_INFO'];&nbsp;</div></li><li><div>          case isset($_SERVER['DOCUMENT_URI']):&nbsp;</div></li><li><div>              return substr($_SERVER['DOCUMENT_URI'], strlen($_SERVER['SCRIPT_NAME']));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get path to requested .scss file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function findInput() {&nbsp;</div></li><li><div>      if (($input = $this-&gt;inputName())&nbsp;</div></li><li><div>          && strpos($input, '..') === false&nbsp;</div></li><li><div>          && substr($input, -5) === '.scss'&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          $name = $this-&gt;join($this-&gt;dir, $input);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (is_file($name) && is_readable($name)) {&nbsp;</div></li><li><div>              return $name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get path to cached .css file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function cacheName($fname) {&nbsp;</div></li><li><div>      return $this-&gt;join($this-&gt;cacheDir, md5($fname) . '.css');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get path to cached imports</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function importsCacheName($out) {&nbsp;</div></li><li><div>      return $out . '.imports';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determine whether .scss file needs to be re-compiled.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $in  Input path</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $out Output path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if compile required.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function needsCompile($in, $out) {&nbsp;</div></li><li><div>      if (!is_file($out)) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $mtime = filemtime($out);&nbsp;</div></li><li><div>      if (filemtime($in) &gt; $mtime) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// look for modified imports</span>&nbsp;</div></li><li><div>      $icache = $this-&gt;importsCacheName($out);&nbsp;</div></li><li><div>      if (is_readable($icache)) {&nbsp;</div></li><li><div>          $imports = unserialize( self::$parent-&gt;filesystem-&gt;execute( 'get_contents', $icache ));&nbsp;</div></li><li><div>          <span class="comment">//$imports = unserialize(file_get_contents($icache));</span>&nbsp;</div></li><li><div>          foreach ($imports as $import) {&nbsp;</div></li><li><div>              if (filemtime($import) &gt; $mtime) return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get If-Modified-Since header from client request</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function getModifiedSinceHeader()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $modifiedSince = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])) {&nbsp;</div></li><li><div>          $modifiedSince = $_SERVER['HTTP_IF_MODIFIED_SINCE'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (false !== ($semicolonPos = strpos($modifiedSince, ';'))) {&nbsp;</div></li><li><div>              $modifiedSince = substr($modifiedSince, 0, $semicolonPos);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $modifiedSince;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Compile .scss file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $in  Input path (.scss)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $out Output path (.css)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function compile($in, $out) {&nbsp;</div></li><li><div>      $start = microtime(true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = $this-&gt;scss-&gt;compile(self::$parent-&gt;filesystem-&gt;execute( 'get_contents', $in ), $in);&nbsp;</div></li><li><div>      <span class="comment">//$css = $this-&gt;scss-&gt;compile(file_get_contents($in), $in);</span>&nbsp;</div></li><li><div>      $elapsed = round((microtime(true) - $start), 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $v = scssc::$VERSION;&nbsp;</div></li><li><div>      $t = @date('r');&nbsp;</div></li><li><div>      $css = &quot;<span class="comment">/* compiled by scssphp $v on $t (${elapsed}s) */</span>\n\n&quot; . $css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::$parent-&gt;filesystem-&gt;execute( 'put_contents', $out, array('content'=&gt;$css) );&nbsp;</div></li><li><div>      self::$parent-&gt;filesystem-&gt;execute( 'put_contents', $this-&gt;importsCacheName($out), array('content'=&gt;serialize($this-&gt;scss-&gt;getParsedFiles())) );&nbsp;</div></li><li><div>      <span class="comment">//file_put_contents($out, $css);</span>&nbsp;</div></li><li><div>      <span class="comment">//file_put_contents($this-&gt;importsCacheName($out), </span>&nbsp;</div></li><li><div>      <span class="comment">//    serialize($this-&gt;scss-&gt;getParsedFiles()));</span>&nbsp;</div></li><li><div>      return $css;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Compile requested scss and serve css.  Outputs HTTP response.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $salt Prefix a string to the filename for creating the cache name hash</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function serve($salt = '') {&nbsp;</div></li><li><div>      $protocol = isset($_SERVER['SERVER_PROTOCOL'])&nbsp;</div></li><li><div>          ? $_SERVER['SERVER_PROTOCOL']&nbsp;</div></li><li><div>          : 'HTTP/1.0';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($input = $this-&gt;findInput()) {&nbsp;</div></li><li><div>          $output = $this-&gt;cacheName($salt . $input);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;needsCompile($input, $output)) {&nbsp;</div></li><li><div>              try {&nbsp;</div></li><li><div>                  $css = $this-&gt;compile($input, $output);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $lastModified = gmdate('D, d M Y H:i:s', filemtime($output)) . ' GMT';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  header('Last-Modified: ' . $lastModified);&nbsp;</div></li><li><div>                  header('Content-type: text/css');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  echo $css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              } catch (Exception $e) {&nbsp;</div></li><li><div>                  header($protocol . ' 500 Internal Server Error');&nbsp;</div></li><li><div>                  header('Content-type: text/plain');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  echo 'Parse error: ' . $e-&gt;getMessage() . &quot;\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          header('X-SCSS-Cache: true');&nbsp;</div></li><li><div>          header('Content-type: text/css');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $modifiedSince = $this-&gt;getModifiedSinceHeader();&nbsp;</div></li><li><div>          $mtime = filemtime($output);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (@strtotime($modifiedSince) === $mtime) {&nbsp;</div></li><li><div>              header($protocol . ' 304 Not Modified');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $lastModified = gmdate('D, d M Y H:i:s', $mtime) . ' GMT';&nbsp;</div></li><li><div>          header('Last-Modified: ' . $lastModified);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo self::$parent-&gt;filesystem-&gt;execute( 'get_contents', $output );&nbsp;</div></li><li><div>          <span class="comment">//echo file_get_contents($output);</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      header($protocol . ' 404 Not Found');&nbsp;</div></li><li><div>      header('Content-type: text/plain');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $v = scssc::$VERSION;&nbsp;</div></li><li><div>      echo &quot;<span class="comment">/* INPUT NOT FOUND scss $v */</span>\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $dir      Root directory to .scss files</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $cacheDir Cache directory</span>&nbsp;</div></li><li><div><span class="comment">   * @param \scssc|null $scss     SCSS compiler instance</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($dir, $cacheDir=null, $scss=null) {&nbsp;</div></li><li><div>      $this-&gt;dir = $dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($cacheDir)) {&nbsp;</div></li><li><div>          $cacheDir = $this-&gt;join($dir, 'scss_cache');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;cacheDir = $cacheDir;&nbsp;</div></li><li><div>      if (!is_dir($this-&gt;cacheDir)) mkdir($this-&gt;cacheDir, 0755, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($scss)) {&nbsp;</div></li><li><div>          $scss = new scssc();&nbsp;</div></li><li><div>          $scss-&gt;setImportPaths($this-&gt;dir);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;scss = $scss;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Helper method to serve compiled scss</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path Root path</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static public function serveFrom($path) {&nbsp;</div></li><li><div>      $server = new self($path);&nbsp;</div></li><li><div>      $server-&gt;serve();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>theme</li><li><span></span>file</li><li><span></span></li><li><span></span>evolve</li><li><span></span>3.7.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>