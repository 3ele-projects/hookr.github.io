<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7" data-type="file" data-id="4808"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-includes-ms-blogs | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.24"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=53e318715af30413d9f6f09240239d5c' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.24' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-includes-ms-blogs/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-ms-blogs%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-includes-ms-blogs%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7-file-wp-includes-ms-blogs","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-includes-ms-blogs" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7." href="http://hookr.io/4.7/" class="H_VERSION"><span property="name">4.7</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-includes-ms-blogs</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6307"><a href="http://hookr.io/4.7/all/" title="All">All <span class="count badge">6307</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/4.7/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2531"><a href="http://hookr.io/4.7/hooks/" title="Hooks">Hooks <span class="count badge">2531</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1667"><a href="http://hookr.io/4.7/filters/" title="Filters">Filters <span class="count badge">1667</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2851"><a href="http://hookr.io/4.7/functions/" title="Functions">Functions <span class="count badge">2851</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-includes/ms-blogs.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Site/blog functions that work with the blogs table and related data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Multisite</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the last_updated field for the current site.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpmu_update_blogs_date() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_blog_details( $wpdb-&gt;blogid, array('last_updated' =&gt; current_time('mysql', true)) );&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the blog details are updated.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $blog_id Site ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'wpmu_blog_updated', $wpdb-&gt;blogid );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a full blog URL, given a blog id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id Blog ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Full URL of the blog if found. Empty string if not.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blogaddress_by_id( $blog_id ) {&nbsp;</div></li><li><div>  $bloginfo = get_site( (int) $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $bloginfo ) ) {&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $scheme = parse_url( $bloginfo-&gt;home, PHP_URL_SCHEME );&nbsp;</div></li><li><div>  $scheme = empty( $scheme ) ? 'http' : $scheme;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return esc_url( $scheme . ':<span class="comment">//' . $bloginfo-&gt;domain . $bloginfo-&gt;path );</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a full blog URL, given a blog name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $blogname The (subdomain or directory) name</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blogaddress_by_name( $blogname ) {&nbsp;</div></li><li><div>  if ( is_subdomain_install() ) {&nbsp;</div></li><li><div>      if ( $blogname == 'main' )&nbsp;</div></li><li><div>          $blogname = 'www';&nbsp;</div></li><li><div>      $url = rtrim( network_home_url(), '/' );&nbsp;</div></li><li><div>      if ( !empty( $blogname ) )&nbsp;</div></li><li><div>          $url = preg_replace( '|^([^\.]+:<span class="comment">//)|', &quot;\${1}&quot; . $blogname . '.', $url );</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $url = network_home_url( $blogname );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return esc_url( $url . '/' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves a sites ID given its (subdomain or directory) slug.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.7.0 Converted to use get_sites().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $slug A site's slug.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|null The site ID, or null if no site is found for the given slug.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_id_from_blogname( $slug ) {&nbsp;</div></li><li><div>  $current_network = get_network();&nbsp;</div></li><li><div>  $slug = trim( $slug, '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_subdomain_install() ) {&nbsp;</div></li><li><div>      $domain = $slug . '.' . preg_replace( '|^www\.|', '', $current_network-&gt;domain );&nbsp;</div></li><li><div>      $path = $current_network-&gt;path;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $domain = $current_network-&gt;domain;&nbsp;</div></li><li><div>      $path = $current_network-&gt;path . $slug . '/';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $site_ids = get_sites( array(&nbsp;</div></li><li><div>      'number' =&gt; 1, &nbsp;</div></li><li><div>      'fields' =&gt; 'ids', &nbsp;</div></li><li><div>      'domain' =&gt; $domain, &nbsp;</div></li><li><div>      'path' =&gt; $path, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $site_ids ) ) {&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array_shift( $site_ids );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the details for a blog from the blogs table and blog options.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|string|array $fields  Optional. A blog ID, a blog slug, or an array of fields to query against.</span>&nbsp;</div></li><li><div><span class="comment"> *                                  If not specified the current blog ID is used.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool             $get_all Whether to retrieve all details or only the details in the blogs table.</span>&nbsp;</div></li><li><div><span class="comment"> *                                  Default is true.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Site|false Blog details on success. False on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_details( $fields = null, $get_all = true ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array($fields ) ) {&nbsp;</div></li><li><div>      if ( isset($fields['blog_id']) ) {&nbsp;</div></li><li><div>          $blog_id = $fields['blog_id'];&nbsp;</div></li><li><div>      } elseif ( isset($fields['domain']) && isset($fields['path']) ) {&nbsp;</div></li><li><div>          $key = md5( $fields['domain'] . $fields['path'] );&nbsp;</div></li><li><div>          $blog = wp_cache_get($key, 'blog-lookup');&nbsp;</div></li><li><div>          if ( false !== $blog )&nbsp;</div></li><li><div>              return $blog;&nbsp;</div></li><li><div>          if ( substr( $fields['domain'], 0, 4 ) == 'www.' ) {&nbsp;</div></li><li><div>              $nowww = substr( $fields['domain'], 4 );&nbsp;</div></li><li><div>              $blog = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;blogs WHERE domain IN (%s, %s) AND path = %s ORDER BY CHAR_LENGTH(domain) DESC&quot;, $nowww, $fields['domain'], $fields['path'] ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $blog = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;blogs WHERE domain = %s AND path = %s&quot;, $fields['domain'], $fields['path'] ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $blog ) {&nbsp;</div></li><li><div>              wp_cache_set($blog-&gt;blog_id . 'short', $blog, 'blog-details');&nbsp;</div></li><li><div>              $blog_id = $blog-&gt;blog_id;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( isset($fields['domain']) && is_subdomain_install() ) {&nbsp;</div></li><li><div>          $key = md5( $fields['domain'] );&nbsp;</div></li><li><div>          $blog = wp_cache_get($key, 'blog-lookup');&nbsp;</div></li><li><div>          if ( false !== $blog )&nbsp;</div></li><li><div>              return $blog;&nbsp;</div></li><li><div>          if ( substr( $fields['domain'], 0, 4 ) == 'www.' ) {&nbsp;</div></li><li><div>              $nowww = substr( $fields['domain'], 4 );&nbsp;</div></li><li><div>              $blog = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;blogs WHERE domain IN (%s, %s) ORDER BY CHAR_LENGTH(domain) DESC&quot;, $nowww, $fields['domain'] ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $blog = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;blogs WHERE domain = %s&quot;, $fields['domain'] ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $blog ) {&nbsp;</div></li><li><div>              wp_cache_set($blog-&gt;blog_id . 'short', $blog, 'blog-details');&nbsp;</div></li><li><div>              $blog_id = $blog-&gt;blog_id;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( ! $fields )&nbsp;</div></li><li><div>          $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>      elseif ( ! is_numeric( $fields ) )&nbsp;</div></li><li><div>          $blog_id = get_id_from_blogname( $fields );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $blog_id = $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_id = (int) $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $all = $get_all == true ? '' : 'short';&nbsp;</div></li><li><div>  $details = wp_cache_get( $blog_id . $all, 'blog-details' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $details ) {&nbsp;</div></li><li><div>      if ( ! is_object( $details ) ) {&nbsp;</div></li><li><div>          if ( $details == -1 ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Clear old pre-serialized objects. Cache clients do better with that.</span></span>&nbsp;</div></li><li><div>              wp_cache_delete( $blog_id . $all, 'blog-details' );&nbsp;</div></li><li><div>              unset($details);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $details;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Try the other cache.</span>&nbsp;</div></li><li><div>  if ( $get_all ) {&nbsp;</div></li><li><div>      $details = wp_cache_get( $blog_id . 'short', 'blog-details' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $details = wp_cache_get( $blog_id, 'blog-details' );&nbsp;</div></li><li><div>      <span class="comment">// If short was requested and full cache is set, we can return.</span>&nbsp;</div></li><li><div>      if ( $details ) {&nbsp;</div></li><li><div>          if ( ! is_object( $details ) ) {&nbsp;</div></li><li><div>              if ( $details == -1 ) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Clear old pre-serialized objects. Cache clients do better with that.</span></span>&nbsp;</div></li><li><div>                  wp_cache_delete( $blog_id, 'blog-details' );&nbsp;</div></li><li><div>                  unset($details);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $details;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($details) ) {&nbsp;</div></li><li><div>      $details = WP_Site::get_instance( $blog_id );&nbsp;</div></li><li><div>      if ( ! $details ) {&nbsp;</div></li><li><div>          <span class="comment">// Set the full cache.</span>&nbsp;</div></li><li><div>          wp_cache_set( $blog_id, -1, 'blog-details' );&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $details instanceof WP_Site ) {&nbsp;</div></li><li><div>      $details = new WP_Site( $details );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $get_all ) {&nbsp;</div></li><li><div>      wp_cache_set( $blog_id . $all, $details, 'blog-details' );&nbsp;</div></li><li><div>      return $details;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog( $blog_id );&nbsp;</div></li><li><div>  $details-&gt;blogname = get_option( 'blogname' );&nbsp;</div></li><li><div>  $details-&gt;siteurl = get_option( 'siteurl' );&nbsp;</div></li><li><div>  $details-&gt;post_count = get_option( 'post_count' );&nbsp;</div></li><li><div>  $details-&gt;home = get_option( 'home' );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a blog's details.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since MU</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 4.7.0 Use site_details</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $details The blog details.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $details = apply_filters_deprecated( 'blog_details', array( $details ), '4.7.0', 'site_details' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_set( $blog_id . $all, $details, 'blog-details' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $key = md5( $details-&gt;domain . $details-&gt;path );&nbsp;</div></li><li><div>  wp_cache_set( $key, $details, 'blog-lookup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $details;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clear the blog details cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $blog_id Optional. Blog ID. Defaults to current blog.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function refresh_blog_details( $blog_id = 0 ) {&nbsp;</div></li><li><div>  $blog_id = (int) $blog_id;&nbsp;</div></li><li><div>  if ( ! $blog_id ) {&nbsp;</div></li><li><div>      $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $details = get_site( $blog_id );&nbsp;</div></li><li><div>  if ( ! $details ) {&nbsp;</div></li><li><div>      <span class="comment">// Make sure clean_blog_cache() gets the blog ID</span>&nbsp;</div></li><li><div>      <span class="comment">// when the blog has been previously cached as</span>&nbsp;</div></li><li><div>      <span class="comment">// non-existent.</span>&nbsp;</div></li><li><div>      $details = (object) array(&nbsp;</div></li><li><div>          'blog_id' =&gt; $blog_id, &nbsp;</div></li><li><div>          'domain' =&gt; null, &nbsp;</div></li><li><div>          'path' =&gt; null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  clean_blog_cache( $details );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after the blog details cache is cleared.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'refresh_blog_details', $blog_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the details for a blog. Updates the blogs table for a given blog id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $blog_id Blog ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $details Array of details keyed by blogs table field names.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if update succeeds, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_blog_details( $blog_id, $details = array() ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($details) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_object($details) )&nbsp;</div></li><li><div>      $details = get_object_vars($details);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current_details = get_site( $blog_id );&nbsp;</div></li><li><div>  if ( empty($current_details) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current_details = get_object_vars($current_details);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $details = array_merge($current_details, $details);&nbsp;</div></li><li><div>  $details['last_updated'] = current_time('mysql', true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $update_details = array();&nbsp;</div></li><li><div>  $fields = array( 'site_id', 'domain', 'path', 'registered', 'last_updated', 'public', 'archived', 'mature', 'spam', 'deleted', 'lang_id');&nbsp;</div></li><li><div>  foreach ( array_intersect( array_keys( $details ), $fields ) as $field ) {&nbsp;</div></li><li><div>      if ( 'path' === $field ) {&nbsp;</div></li><li><div>          $details[ $field ] = trailingslashit( '/' . trim( $details[ $field ], '/' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $update_details[ $field ] = $details[ $field ];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = $wpdb-&gt;update( $wpdb-&gt;blogs, $update_details, array('blog_id' =&gt; $blog_id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $result )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If spam status changed, issue actions.</span>&nbsp;</div></li><li><div>  if ( $details['spam'] != $current_details['spam'] ) {&nbsp;</div></li><li><div>      if ( $details['spam'] == 1 ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'spam'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since MU</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'make_spam_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'ham'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since MU</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'make_ham_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If mature status changed, issue actions.</span>&nbsp;</div></li><li><div>  if ( $details['mature'] != $current_details['mature'] ) {&nbsp;</div></li><li><div>      if ( $details['mature'] == 1 ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'mature'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'mature_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'unmature'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'unmature_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If archived status changed, issue actions.</span>&nbsp;</div></li><li><div>  if ( $details['archived'] != $current_details['archived'] ) {&nbsp;</div></li><li><div>      if ( $details['archived'] == 1 ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'archived'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since MU</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'archive_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'unarchived'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since MU</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'unarchive_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If deleted status changed, issue actions.</span>&nbsp;</div></li><li><div>  if ( $details['deleted'] != $current_details['deleted'] ) {&nbsp;</div></li><li><div>      if ( $details['deleted'] == 1 ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'deleted'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'make_delete_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires when the blog status is changed to 'undeleted'.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'make_undelete_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $details['public'] ) ) {&nbsp;</div></li><li><div>      switch_to_blog( $blog_id );&nbsp;</div></li><li><div>      update_option( 'blog_public', $details['public'] );&nbsp;</div></li><li><div>      restore_current_blog();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  refresh_blog_details($blog_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clean the blog cache</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Site $blog The site object to be cleared from cache.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function clean_blog_cache( $blog ) {&nbsp;</div></li><li><div>  $blog_id = $blog-&gt;blog_id;&nbsp;</div></li><li><div>  $domain_path_key = md5( $blog-&gt;domain . $blog-&gt;path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_delete( $blog_id, 'sites' );&nbsp;</div></li><li><div>  wp_cache_delete( $blog_id, 'site-details' );&nbsp;</div></li><li><div>  wp_cache_delete( $blog_id , 'blog-details' );&nbsp;</div></li><li><div>  wp_cache_delete( $blog_id . 'short' , 'blog-details' );&nbsp;</div></li><li><div>  wp_cache_delete(  $domain_path_key, 'blog-lookup' );&nbsp;</div></li><li><div>  wp_cache_delete( 'current_blog_' . $blog-&gt;domain, 'site-options' );&nbsp;</div></li><li><div>  wp_cache_delete( 'current_blog_' . $blog-&gt;domain . $blog-&gt;path, 'site-options' );&nbsp;</div></li><li><div>  wp_cache_delete( $domain_path_key, 'blog-id-cache' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires immediately after a site has been removed from the object cache.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $id              Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Site $blog            Site object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $domain_path_key md5 hash of domain and path.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'clean_site_cache', $blog_id, $blog, $domain_path_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_set( 'last_changed', microtime(), 'sites' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves site data given a site ID or site object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Site data will be cached and returned after being passed through a filter.</span>&nbsp;</div></li><li><div><span class="comment"> * If the provided site is empty, the current site global will be used.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Site|int|null $site Optional. Site to retrieve. Default is the current site.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Site|null The site object or null if not found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_site( $site = null ) {&nbsp;</div></li><li><div>  if ( empty( $site ) ) {&nbsp;</div></li><li><div>      $site = get_current_blog_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $site instanceof WP_Site ) {&nbsp;</div></li><li><div>      $_site = $site;&nbsp;</div></li><li><div>  } elseif ( is_object( $site ) ) {&nbsp;</div></li><li><div>      $_site = new WP_Site( $site );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $_site = WP_Site::get_instance( $site );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $_site ) {&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a site is retrieved.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Site $_site Site data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $_site = apply_filters( 'get_site', $_site );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $_site;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds any sites from the given ids to the cache that do not already exist in cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see update_site_cache()</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $ids ID list.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _prime_site_caches( $ids ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $non_cached_ids = _get_non_cached_ids( $ids, 'sites' );&nbsp;</div></li><li><div>  if ( ! empty( $non_cached_ids ) ) {&nbsp;</div></li><li><div>      $fresh_sites = $wpdb-&gt;get_results( sprintf( &quot;SELECT * FROM $wpdb-&gt;blogs WHERE blog_id IN (%s)&quot;, join( &quot;, &quot;, array_map( 'intval', $non_cached_ids ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_site_cache( $fresh_sites );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Updates sites in cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $sites Array of site objects.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_site_cache( $sites ) {&nbsp;</div></li><li><div>  if ( ! $sites ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $sites as $site ) {&nbsp;</div></li><li><div>      wp_cache_add( $site-&gt;blog_id, $site, 'sites' );&nbsp;</div></li><li><div>      wp_cache_add( $site-&gt;blog_id . 'short', $site, 'blog-details' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves a list of sites matching requested arguments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see WP_Site_Query::parse_query()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $args {</span>&nbsp;</div></li><li><div><span class="comment"> *     Optional. Array or query string of site query parameters. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $site__in          Array of site IDs to include. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $site__not_in      Array of site IDs to exclude. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool         $count             Whether to return a site count (true) or array of site objects.</span>&nbsp;</div></li><li><div><span class="comment"> *                                           Default false.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $date_query        Date query clauses to limit sites by. See WP_Date_Query.</span>&nbsp;</div></li><li><div><span class="comment"> *                                           Default null.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $fields            Site fields to return. Accepts 'ids' (returns an array of site IDs)</span>&nbsp;</div></li><li><div><span class="comment"> *                                           or empty (returns an array of complete site objects). Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $ID                A site ID to only return that site. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $number            Maximum number of sites to retrieve. Default 100.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $offset            Number of sites to offset the query. Used to build LIMIT clause.</span>&nbsp;</div></li><li><div><span class="comment"> *                                           Default 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool         $no_found_rows     Whether to disable the `SQL_CALC_FOUND_ROWS` query. Default true.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string|array $orderby           Site status or array of statuses. Accepts 'id', 'domain', 'path', </span>&nbsp;</div></li><li><div><span class="comment"> *                                           'network_id', 'last_updated', 'registered', 'domain_length', </span>&nbsp;</div></li><li><div><span class="comment"> *                                           'path_length', 'site__in' and 'network__in'. Also accepts false, </span>&nbsp;</div></li><li><div><span class="comment"> *                                           an empty array, or 'none' to disable `ORDER BY` clause.</span>&nbsp;</div></li><li><div><span class="comment"> *                                           Default 'id'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $order             How to order retrieved sites. Accepts 'ASC', 'DESC'. Default 'ASC'.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $network_id        Limit results to those affiliated with a given network ID. If 0, </span>&nbsp;</div></li><li><div><span class="comment"> *                                           include all networks. Default 0.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $network__in       Array of network IDs to include affiliated sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $network__not_in   Array of network IDs to exclude affiliated sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $domain            Limit results to those affiliated with a given domain. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $domain__in        Array of domains to include affiliated sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $domain__not_in    Array of domains to exclude affiliated sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $path              Limit results to those affiliated with a given path. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $path__in          Array of paths to include affiliated sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $path__not_in      Array of paths to exclude affiliated sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $public            Limit results to public sites. Accepts '1' or '0'. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $archived          Limit results to archived sites. Accepts '1' or '0'. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $mature            Limit results to mature sites. Accepts '1' or '0'. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $spam              Limit results to spam sites. Accepts '1' or '0'. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type int          $deleted           Limit results to deleted sites. Accepts '1' or '0'. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type string       $search            Search term(s) to retrieve matching sites for. Default empty.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type array        $search_columns    Array of column names to be searched. Accepts 'domain' and 'path'.</span>&nbsp;</div></li><li><div><span class="comment"> *                                           Default empty array.</span>&nbsp;</div></li><li><div><span class="comment"> *     @type bool         $update_site_cache Whether to prime the cache for found sites. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> * }</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of sites.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_sites( $args = array() ) {&nbsp;</div></li><li><div>  $query = new WP_Site_Query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $query-&gt;query( $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve option value for a given blog id based on name of option.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the option does not exist or does not have a value, then the return value</span>&nbsp;</div></li><li><div><span class="comment"> * will be false. This is useful to check whether you need to install an option</span>&nbsp;</div></li><li><div><span class="comment"> * and is commonly used during installation of plugin options and to test</span>&nbsp;</div></li><li><div><span class="comment"> * whether upgrading is required.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the option was serialized then it will be unserialized when it is returned.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id      A blog ID. Can be null to refer to the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option  Name of option to retrieve. Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $default Optional. Default value to return if the option does not exist.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed Value set for the option.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_option( $id, $option, $default = false ) {&nbsp;</div></li><li><div>  $id = (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $id ) )&nbsp;</div></li><li><div>      $id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_current_blog_id() == $id )&nbsp;</div></li><li><div>      return get_option( $option, $default );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog( $id );&nbsp;</div></li><li><div>  $value = get_option( $option, $default );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters a blog option value.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portion of the hook name, `$option`, refers to the blog option name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $value The option value.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $id    Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( &quot;blog_option_{$option}&quot;, $value, $id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a new option for a given blog id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You do not need to serialize values. If the value needs to be serialized, then</span>&nbsp;</div></li><li><div><span class="comment"> * it will be serialized before it is inserted into the database. Remember, </span>&nbsp;</div></li><li><div><span class="comment"> * resources can not be serialized or added as an option.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * You can create options without values and then update the values later.</span>&nbsp;</div></li><li><div><span class="comment"> * Existing options will not be updated and checks are performed to ensure that you</span>&nbsp;</div></li><li><div><span class="comment"> * aren't adding a protected WordPress option. Care should be taken to not name</span>&nbsp;</div></li><li><div><span class="comment"> * options the same as the ones which are protected.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id     A blog ID. Can be null to refer to the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option Name of option to add. Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $value  Optional. Option value, can be anything. Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool False if option was not added and true if option was added.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_blog_option( $id, $option, $value ) {&nbsp;</div></li><li><div>  $id = (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $id ) )&nbsp;</div></li><li><div>      $id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_current_blog_id() == $id )&nbsp;</div></li><li><div>      return add_option( $option, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog( $id );&nbsp;</div></li><li><div>  $return = add_option( $option, $value );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Removes option by name for a given blog id. Prevents removal of protected WordPress options.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id     A blog ID. Can be null to refer to the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option Name of option to remove. Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True, if option is successfully deleted. False on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function delete_blog_option( $id, $option ) {&nbsp;</div></li><li><div>  $id = (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $id ) )&nbsp;</div></li><li><div>      $id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_current_blog_id() == $id )&nbsp;</div></li><li><div>      return delete_option( $option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog( $id );&nbsp;</div></li><li><div>  $return = delete_option( $option );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update an option for a particular blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id         The blog id.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $option     The option key.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $value      The option value.</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  $deprecated Not used.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false on failure.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_blog_option( $id, $option, $value, $deprecated = null ) {&nbsp;</div></li><li><div>  $id = (int) $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( null !== $deprecated )&nbsp;</div></li><li><div>      _deprecated_argument( __FUNCTION__, '3.1.0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_current_blog_id() == $id )&nbsp;</div></li><li><div>      return update_option( $option, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch_to_blog( $id );&nbsp;</div></li><li><div>  $return = update_option( $option, $value );&nbsp;</div></li><li><div>  restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  refresh_blog_details( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Switch the current blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is useful if you need to pull posts, or other information, </span>&nbsp;</div></li><li><div><span class="comment"> * from other blogs. You can switch back afterwards using restore_current_blog().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Things that aren't switched:</span>&nbsp;</div></li><li><div><span class="comment"> *  - autoloaded options. See #14992</span>&nbsp;</div></li><li><div><span class="comment"> *  - plugins. See #14941</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see restore_current_blog()</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb            $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global int             $blog_id</span>&nbsp;</div></li><li><div><span class="comment"> * @global array           $_wp_switched_stack</span>&nbsp;</div></li><li><div><span class="comment"> * @global bool            $switched</span>&nbsp;</div></li><li><div><span class="comment"> * @global string          $table_prefix</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Object_Cache $wp_object_cache</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int  $new_blog   The id of the blog you want to switch to. Default: current blog</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $deprecated Deprecated argument</span>&nbsp;</div></li><li><div><span class="comment"> * @return true Always returns True.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function switch_to_blog( $new_blog, $deprecated = null ) {&nbsp;</div></li><li><div>  global $wpdb, $wp_roles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>  if ( empty( $new_blog ) ) {&nbsp;</div></li><li><div>      $new_blog = $blog_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $GLOBALS['_wp_switched_stack'][] = $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If we're switching to the same blog id that we're on, </span>&nbsp;</div></li><li><div><span class="comment">   * set the right vars, do the associated actions, but skip</span>&nbsp;</div></li><li><div><span class="comment">   * the extra unnecessary work</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( $new_blog == $blog_id ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires when the blog is switched.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $new_blog New blog ID.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $new_blog Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'switch_blog', $new_blog, $new_blog );&nbsp;</div></li><li><div>      $GLOBALS['switched'] = true;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;set_blog_id( $new_blog );&nbsp;</div></li><li><div>  $GLOBALS['table_prefix'] = $wpdb-&gt;get_blog_prefix();&nbsp;</div></li><li><div>  $prev_blog_id = $blog_id;&nbsp;</div></li><li><div>  $GLOBALS['blog_id'] = $new_blog;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( function_exists( 'wp_cache_switch_to_blog' ) ) {&nbsp;</div></li><li><div>      wp_cache_switch_to_blog( $new_blog );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      global $wp_object_cache;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_object( $wp_object_cache ) && isset( $wp_object_cache-&gt;global_groups ) ) {&nbsp;</div></li><li><div>          $global_groups = $wp_object_cache-&gt;global_groups;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $global_groups = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_cache_init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wp_cache_add_global_groups' ) ) {&nbsp;</div></li><li><div>          if ( is_array( $global_groups ) ) {&nbsp;</div></li><li><div>              wp_cache_add_global_groups( $global_groups );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wp_cache_add_global_groups( array( 'users', 'userlogins', 'usermeta', 'user_meta', 'useremail', 'userslugs', 'site-transient', 'site-options', 'site-lookup', 'blog-lookup', 'blog-details', 'rss', 'global-posts', 'blog-id-cache', 'networks', 'sites', 'site-details' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_cache_add_non_persistent_groups( array( 'counts', 'plugins' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( did_action( 'init' ) ) {&nbsp;</div></li><li><div>      $wp_roles = new WP_Roles();&nbsp;</div></li><li><div>      $current_user = wp_get_current_user();&nbsp;</div></li><li><div>      $current_user-&gt;for_blog( $new_blog );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'switch_blog', $new_blog, $prev_blog_id );&nbsp;</div></li><li><div>  $GLOBALS['switched'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Restore the current blog, after calling switch_to_blog()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see switch_to_blog()</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb            $wpdb</span>&nbsp;</div></li><li><div><span class="comment"> * @global array           $_wp_switched_stack</span>&nbsp;</div></li><li><div><span class="comment"> * @global int             $blog_id</span>&nbsp;</div></li><li><div><span class="comment"> * @global bool            $switched</span>&nbsp;</div></li><li><div><span class="comment"> * @global string          $table_prefix</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Object_Cache $wp_object_cache</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false if we're already on the current blog</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function restore_current_blog() {&nbsp;</div></li><li><div>  global $wpdb, $wp_roles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $GLOBALS['_wp_switched_stack'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $blog = array_pop( $GLOBALS['_wp_switched_stack'] );&nbsp;</div></li><li><div>  $blog_id = get_current_blog_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $blog_id == $blog ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>      do_action( 'switch_blog', $blog, $blog );&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// If we still have items in the switched stack, consider ourselves still 'switched'</span></span>&nbsp;</div></li><li><div>      $GLOBALS['switched'] = ! empty( $GLOBALS['_wp_switched_stack'] );&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpdb-&gt;set_blog_id( $blog );&nbsp;</div></li><li><div>  $prev_blog_id = $blog_id;&nbsp;</div></li><li><div>  $GLOBALS['blog_id'] = $blog;&nbsp;</div></li><li><div>  $GLOBALS['table_prefix'] = $wpdb-&gt;get_blog_prefix();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( function_exists( 'wp_cache_switch_to_blog' ) ) {&nbsp;</div></li><li><div>      wp_cache_switch_to_blog( $blog );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      global $wp_object_cache;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_object( $wp_object_cache ) && isset( $wp_object_cache-&gt;global_groups ) ) {&nbsp;</div></li><li><div>          $global_groups = $wp_object_cache-&gt;global_groups;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $global_groups = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_cache_init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wp_cache_add_global_groups' ) ) {&nbsp;</div></li><li><div>          if ( is_array( $global_groups ) ) {&nbsp;</div></li><li><div>              wp_cache_add_global_groups( $global_groups );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wp_cache_add_global_groups( array( 'users', 'userlogins', 'usermeta', 'user_meta', 'useremail', 'userslugs', 'site-transient', 'site-options', 'site-lookup', 'blog-lookup', 'blog-details', 'rss', 'global-posts', 'blog-id-cache', 'networks', 'sites', 'site-details' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_cache_add_non_persistent_groups( array( 'counts', 'plugins' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( did_action( 'init' ) ) {&nbsp;</div></li><li><div>      $wp_roles = new WP_Roles();&nbsp;</div></li><li><div>      $current_user = wp_get_current_user();&nbsp;</div></li><li><div>      $current_user-&gt;for_blog( $blog );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>  do_action( 'switch_blog', $blog, $prev_blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// If we still have items in the switched stack, consider ourselves still 'switched'</span></span>&nbsp;</div></li><li><div>  $GLOBALS['switched'] = ! empty( $GLOBALS['_wp_switched_stack'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determines if switch_to_blog() is in effect</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $_wp_switched_stack</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True if switched, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ms_is_switched() {&nbsp;</div></li><li><div>  return ! empty( $GLOBALS['_wp_switched_stack'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if a particular blog is archived.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $id The blog id</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Whether the blog is archived or not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function is_archived( $id ) {&nbsp;</div></li><li><div>  return get_blog_status($id, 'archived');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the 'archived' status of a particular blog.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id       The blog id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $archived The new status</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $archived</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_archived( $id, $archived ) {&nbsp;</div></li><li><div>  update_blog_status($id, 'archived', $archived);&nbsp;</div></li><li><div>  return $archived;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update a blog details field.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $blog_id BLog ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $pref    A field name</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $value   Value for $pref</span>&nbsp;</div></li><li><div><span class="comment"> * @param null   $deprecated</span>&nbsp;</div></li><li><div><span class="comment"> * @return string|false $value</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_blog_status( $blog_id, $pref, $value, $deprecated = null ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( null !== $deprecated )&nbsp;</div></li><li><div>      _deprecated_argument( __FUNCTION__, '3.1.0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! in_array( $pref, array( 'site_id', 'domain', 'path', 'registered', 'last_updated', 'public', 'archived', 'mature', 'spam', 'deleted', 'lang_id') ) )&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = $wpdb-&gt;update( $wpdb-&gt;blogs, array($pref =&gt; $value, 'last_updated' =&gt; current_time('mysql', true)), array('blog_id' =&gt; $blog_id) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $result )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  refresh_blog_details( $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'spam' == $pref ) {&nbsp;</div></li><li><div>      if ( $value == 1 ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'make_spam_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'make_ham_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( 'mature' == $pref ) {&nbsp;</div></li><li><div>      if ( $value == 1 ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'mature_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'unmature_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( 'archived' == $pref ) {&nbsp;</div></li><li><div>      if ( $value == 1 ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'archive_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'unarchive_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( 'deleted' == $pref ) {&nbsp;</div></li><li><div>      if ( $value == 1 ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'make_delete_blog', $blog_id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-includes/ms-blogs.php */</span></span></span></span></span></span></span></span></span></span></span>&nbsp;</div></li><li><div>          do_action( 'make_undelete_blog', $blog_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( 'public' == $pref ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires after the current blog's 'public' setting is updated.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since MU</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int    $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $value   The value of blog status.</span>&nbsp;</div></li><li><div><span class="comment">        */</span>&nbsp;</div></li><li><div>      do_action( 'update_blog_public', $blog_id, $value ); <span class="comment">// Moved here from update_blog_public().</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $value;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a blog details field.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id   The blog id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $pref A field name</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|string|null $value</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_blog_status( $id, $pref ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $details = get_site( $id );&nbsp;</div></li><li><div>  if ( $details )&nbsp;</div></li><li><div>      return $details-&gt;$pref;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;SELECT %s FROM {$wpdb-&gt;blogs} WHERE blog_id = %d&quot;, $pref, $id) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a list of most recently updated blogs.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since MU</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $deprecated Not used</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $start      The offset</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $quantity   The maximum number of blogs to retrieve. Default is 40.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The list of blogs</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_last_updated( $deprecated = '', $start = 0, $quantity = 40 ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $deprecated ) )&nbsp;</div></li><li><div>      _deprecated_argument( __FUNCTION__, 'MU' ); <span class="comment">// never used</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $wpdb-&gt;get_results( $wpdb-&gt;prepare(&quot;SELECT blog_id, domain, path FROM $wpdb-&gt;blogs WHERE site_id = %d AND public = '1' AND archived = '0' AND mature = '0' AND spam = '0' AND deleted = '0' AND last_updated != '0000-00-00 00:00:00' ORDER BY last_updated DESC limit %d, %d&quot;, $wpdb-&gt;siteid, $start, $quantity ) , ARRAY_A );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves a list of networks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $args Optional. Array or string of arguments. See WP_Network_Query::parse_query()</span>&nbsp;</div></li><li><div><span class="comment"> *                           for information on accepted arguments. Default empty array.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|array List of networks or number of found networks if `$count` argument is true.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_networks( $args = array() ) {&nbsp;</div></li><li><div>  $query = new WP_Network_Query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $query-&gt;query( $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves network data given a network ID or network object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Network data will be cached and returned after being passed through a filter.</span>&nbsp;</div></li><li><div><span class="comment"> * If the provided network is empty, the current network global will be used.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Network $current_site</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param WP_Network|int|null $network Optional. Network to retrieve. Default is the current network.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Network|null The network object or null if not found.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_network( $network = null ) {&nbsp;</div></li><li><div>  global $current_site;&nbsp;</div></li><li><div>  if ( empty( $network ) && isset( $current_site ) ) {&nbsp;</div></li><li><div>      $network = $current_site;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $network instanceof WP_Network ) {&nbsp;</div></li><li><div>      $_network = $network;&nbsp;</div></li><li><div>  } elseif ( is_object( $network ) ) {&nbsp;</div></li><li><div>      $_network = new WP_Network( $network );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $_network = WP_Network::get_instance( $network );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $_network ) {&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires after a network is retrieved.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Network $_network Network data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $_network = apply_filters( 'get_network', $_network );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $_network;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Removes a network from the object cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|array $ids Network ID or an array of network IDs to remove from cache.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function clean_network_cache( $ids ) {&nbsp;</div></li><li><div>  foreach ( (array) $ids as $id ) {&nbsp;</div></li><li><div>      wp_cache_delete( $id, 'networks' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires immediately after a network has been removed from the object cache.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $id Network ID.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'clean_network_cache', $id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_set( 'last_changed', microtime(), 'networks' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Updates the network cache of given networks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Will add the networks in $networks to the cache. If network ID already exists</span>&nbsp;</div></li><li><div><span class="comment"> * in the network cache then it will not be updated. The network is added to the</span>&nbsp;</div></li><li><div><span class="comment"> * cache using the network group with the key using the ID of the networks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $networks Array of network row objects.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_network_cache( $networks ) {&nbsp;</div></li><li><div>  foreach ( (array) $networks as $network ) {&nbsp;</div></li><li><div>      wp_cache_add( $network-&gt;id, $network, 'networks' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds any networks from the given IDs to the cache that do not already exist in cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see update_network_cache()</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $network_ids Array of network IDs.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _prime_network_caches( $network_ids ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $non_cached_ids = _get_non_cached_ids( $network_ids, 'networks' );&nbsp;</div></li><li><div>  if ( !empty( $non_cached_ids ) ) {&nbsp;</div></li><li><div>      $fresh_networks = $wpdb-&gt;get_results( sprintf( &quot;SELECT $wpdb-&gt;site.* FROM $wpdb-&gt;site WHERE id IN (%s)&quot;, join( &quot;, &quot;, array_map( 'intval', $non_cached_ids ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_network_cache( $fresh_networks );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handler for updating the blog date when a post is published or an already published post is changed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $new_status The new post status</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $old_status The old post status</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $post       Post object</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _update_blog_date_on_post_publish( $new_status, $old_status, $post ) {&nbsp;</div></li><li><div>  $post_type_obj = get_post_type_object( $post-&gt;post_type );&nbsp;</div></li><li><div>  if ( ! $post_type_obj || ! $post_type_obj-&gt;public ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'publish' != $new_status && 'publish' != $old_status ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Post was freshly published, published post was saved, or published post was unpublished.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wpmu_update_blogs_date();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handler for updating the blog date when a published post is deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id Post ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _update_blog_date_on_post_delete( $post_id ) {&nbsp;</div></li><li><div>  $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_type_obj = get_post_type_object( $post-&gt;post_type );&nbsp;</div></li><li><div>  if ( ! $post_type_obj || ! $post_type_obj-&gt;public ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'publish' != $post-&gt;post_status ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wpmu_update_blogs_date();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handler for updating the blog posts count date when a post is deleted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id Post ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _update_posts_count_on_delete( $post_id ) {&nbsp;</div></li><li><div>  $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post || 'publish' !== $post-&gt;post_status ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_posts_count();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handler for updating the blog posts count date when a post status changes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $new_status The status the post is changing to.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $old_status The status the post is changing from.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _update_posts_count_on_transition_post_status( $new_status, $old_status ) {&nbsp;</div></li><li><div>  if ( $new_status === $old_status ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'publish' !== $new_status && 'publish' !== $old_status ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_posts_count();&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-include</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>