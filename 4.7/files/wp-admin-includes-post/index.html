<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7" data-type="file" data-id="4510"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-admin-includes-post | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=304682797f4755403e0e93355c0fa096' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-admin-includes-post/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-post%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-post%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7-file-wp-admin-includes-post","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-admin-includes-post" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7." href="http://hookr.io/4.7/" class="H_VERSION"><span property="name">4.7</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-admin-includes-post</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6307"><a href="http://hookr.io/4.7/all/" title="All">All <span class="count badge">6307</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/4.7/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2531"><a href="http://hookr.io/4.7/hooks/" title="Hooks">Hooks <span class="count badge">2531</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1667"><a href="http://hookr.io/4.7/filters/" title="Filters">Filters <span class="count badge">1667</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2851"><a href="http://hookr.io/4.7/functions/" title="Functions">Functions <span class="count badge">2851</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-admin/includes/post.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WordPress Post Administration API.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Rename $_POST data from form names to DB post columns.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Manipulates $_POST directly.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $update Are we updating a pre-existing post?</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post_data Array of post data. Defaults to the contents of $_POST.</span>&nbsp;</div></li><li><div><span class="comment"> * @return object|bool WP_Error on failure, true on success.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wp_translate_postdata( $update = false, $post_data = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($post_data) )&nbsp;</div></li><li><div>      $post_data = &$_POST;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $update )&nbsp;</div></li><li><div>      $post_data['ID'] = (int) $post_data['post_ID'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ptype = get_post_type_object( $post_data['post_type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $update && ! current_user_can( 'edit_post', $post_data['ID'] ) ) {&nbsp;</div></li><li><div>      if ( 'page' == $post_data['post_type'] )&nbsp;</div></li><li><div>          return new WP_Error( 'edit_others_pages', __( 'Sorry, you are not allowed to edit pages as this user.' ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return new WP_Error( 'edit_others_posts', __( 'Sorry, you are not allowed to edit posts as this user.' ) );&nbsp;</div></li><li><div>  } elseif ( ! $update && ! current_user_can( $ptype-&gt;cap-&gt;create_posts ) ) {&nbsp;</div></li><li><div>      if ( 'page' == $post_data['post_type'] )&nbsp;</div></li><li><div>          return new WP_Error( 'edit_others_pages', __( 'Sorry, you are not allowed to create pages as this user.' ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return new WP_Error( 'edit_others_posts', __( 'Sorry, you are not allowed to create posts as this user.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['content'] ) )&nbsp;</div></li><li><div>      $post_data['post_content'] = $post_data['content'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['excerpt'] ) )&nbsp;</div></li><li><div>      $post_data['post_excerpt'] = $post_data['excerpt'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['parent_id'] ) )&nbsp;</div></li><li><div>      $post_data['post_parent'] = (int) $post_data['parent_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($post_data['trackback_url']) )&nbsp;</div></li><li><div>      $post_data['to_ping'] = $post_data['trackback_url'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['user_ID'] = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!empty ( $post_data['post_author_override'] ) ) {&nbsp;</div></li><li><div>      $post_data['post_author'] = (int) $post_data['post_author_override'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if (!empty ( $post_data['post_author'] ) ) {&nbsp;</div></li><li><div>          $post_data['post_author'] = (int) $post_data['post_author'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $post_data['post_author'] = (int) $post_data['user_ID'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['user_ID'] ) && ( $post_data['post_author'] != $post_data['user_ID'] )&nbsp;</div></li><li><div>       && ! current_user_can( $ptype-&gt;cap-&gt;edit_others_posts ) ) {&nbsp;</div></li><li><div>      if ( $update ) {&nbsp;</div></li><li><div>          if ( 'page' == $post_data['post_type'] )&nbsp;</div></li><li><div>              return new WP_Error( 'edit_others_pages', __( 'Sorry, you are not allowed to edit pages as this user.' ) );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              return new WP_Error( 'edit_others_posts', __( 'Sorry, you are not allowed to edit posts as this user.' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( 'page' == $post_data['post_type'] )&nbsp;</div></li><li><div>              return new WP_Error( 'edit_others_pages', __( 'Sorry, you are not allowed to create pages as this user.' ) );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              return new WP_Error( 'edit_others_posts', __( 'Sorry, you are not allowed to create posts as this user.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $post_data['post_status'] ) ) {&nbsp;</div></li><li><div>      $post_data['post_status'] = sanitize_key( $post_data['post_status'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// No longer an auto-draft</span>&nbsp;</div></li><li><div>      if ( 'auto-draft' === $post_data['post_status'] ) {&nbsp;</div></li><li><div>          $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! get_post_status_object( $post_data['post_status'] ) ) {&nbsp;</div></li><li><div>          unset( $post_data['post_status'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// What to do based on which button they pressed</span>&nbsp;</div></li><li><div>  if ( isset($post_data['saveasdraft']) && '' != $post_data['saveasdraft'] )&nbsp;</div></li><li><div>      $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>  if ( isset($post_data['saveasprivate']) && '' != $post_data['saveasprivate'] )&nbsp;</div></li><li><div>      $post_data['post_status'] = 'private';&nbsp;</div></li><li><div>  if ( isset($post_data['publish']) && ( '' != $post_data['publish'] ) && ( !isset($post_data['post_status']) || $post_data['post_status'] != 'private' ) )&nbsp;</div></li><li><div>      $post_data['post_status'] = 'publish';&nbsp;</div></li><li><div>  if ( isset($post_data['advanced']) && '' != $post_data['advanced'] )&nbsp;</div></li><li><div>      $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>  if ( isset($post_data['pending']) && '' != $post_data['pending'] )&nbsp;</div></li><li><div>      $post_data['post_status'] = 'pending';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['ID'] ) )&nbsp;</div></li><li><div>      $post_id = $post_data['ID'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $post_id = false;&nbsp;</div></li><li><div>  $previous_status = $post_id ? get_post_field( 'post_status', $post_id ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['post_status'] ) && 'private' == $post_data['post_status'] && ! current_user_can( $ptype-&gt;cap-&gt;publish_posts ) ) {&nbsp;</div></li><li><div>      $post_data['post_status'] = $previous_status ? $previous_status : 'pending';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $published_statuses = array( 'publish', 'future' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Posts 'submitted for approval' present are submitted to $_POST the same as if they were being published.</span>&nbsp;</div></li><li><div>  <span class="comment">// Change status from 'publish' to 'pending' if user lacks permissions to publish or to resave published posts.</span>&nbsp;</div></li><li><div>  if ( isset($post_data['post_status']) && (in_array( $post_data['post_status'], $published_statuses ) && !current_user_can( $ptype-&gt;cap-&gt;publish_posts )) )&nbsp;</div></li><li><div>      if ( ! in_array( $previous_status, $published_statuses ) || !current_user_can( 'edit_post', $post_id ) )&nbsp;</div></li><li><div>          $post_data['post_status'] = 'pending';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $post_data['post_status'] ) ) {&nbsp;</div></li><li><div>      $post_data['post_status'] = 'auto-draft' === $previous_status ? 'draft' : $previous_status;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['post_password'] ) && ! current_user_can( $ptype-&gt;cap-&gt;publish_posts ) ) {&nbsp;</div></li><li><div>      unset( $post_data['post_password'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!isset( $post_data['comment_status'] ))&nbsp;</div></li><li><div>      $post_data['comment_status'] = 'closed';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!isset( $post_data['ping_status'] ))&nbsp;</div></li><li><div>      $post_data['ping_status'] = 'closed';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array('aa', 'mm', 'jj', 'hh', 'mn') as $timeunit ) {&nbsp;</div></li><li><div>      if ( !empty( $post_data['hidden_' . $timeunit] ) && $post_data['hidden_' . $timeunit] != $post_data[$timeunit] ) {&nbsp;</div></li><li><div>          $post_data['edit_date'] = '1';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $post_data['edit_date'] ) ) {&nbsp;</div></li><li><div>      $aa = $post_data['aa'];&nbsp;</div></li><li><div>      $mm = $post_data['mm'];&nbsp;</div></li><li><div>      $jj = $post_data['jj'];&nbsp;</div></li><li><div>      $hh = $post_data['hh'];&nbsp;</div></li><li><div>      $mn = $post_data['mn'];&nbsp;</div></li><li><div>      $ss = $post_data['ss'];&nbsp;</div></li><li><div>      $aa = ($aa &lt;= 0 ) ? date('Y') : $aa;&nbsp;</div></li><li><div>      $mm = ($mm &lt;= 0 ) ? date('n') : $mm;&nbsp;</div></li><li><div>      $jj = ($jj &gt; 31 ) ? 31 : $jj;&nbsp;</div></li><li><div>      $jj = ($jj &lt;= 0 ) ? date('j') : $jj;&nbsp;</div></li><li><div>      $hh = ($hh &gt; 23 ) ? $hh -24 : $hh;&nbsp;</div></li><li><div>      $mn = ($mn &gt; 59 ) ? $mn -60 : $mn;&nbsp;</div></li><li><div>      $ss = ($ss &gt; 59 ) ? $ss -60 : $ss;&nbsp;</div></li><li><div>      $post_data['post_date'] = sprintf( &quot;%04d-%02d-%02d %02d:%02d:%02d&quot;, $aa, $mm, $jj, $hh, $mn, $ss );&nbsp;</div></li><li><div>      $valid_date = wp_checkdate( $mm, $jj, $aa, $post_data['post_date'] );&nbsp;</div></li><li><div>      if ( !$valid_date ) {&nbsp;</div></li><li><div>          return new WP_Error( 'invalid_date', __( 'Invalid date.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $post_data['post_date_gmt'] = get_gmt_from_date( $post_data['post_date'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['post_category'] ) ) {&nbsp;</div></li><li><div>      $category_object = get_taxonomy( 'category' );&nbsp;</div></li><li><div>      if ( ! current_user_can( $category_object-&gt;cap-&gt;assign_terms ) ) {&nbsp;</div></li><li><div>          unset( $post_data['post_category'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update an existing post with values provided in $_POST.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post_data Optional.</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Post ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edit_post( $post_data = null ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($post_data) )&nbsp;</div></li><li><div>      $post_data = &$_POST;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Clear out any data in internal vars.</span></span>&nbsp;</div></li><li><div>  unset( $post_data['filter'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_ID = (int) $post_data['post_ID'];&nbsp;</div></li><li><div>  $post = get_post( $post_ID );&nbsp;</div></li><li><div>  $post_data['post_type'] = $post-&gt;post_type;&nbsp;</div></li><li><div>  $post_data['post_mime_type'] = $post-&gt;post_mime_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $post_data['post_status'] ) ) {&nbsp;</div></li><li><div>      $post_data['post_status'] = sanitize_key( $post_data['post_status'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'inherit' == $post_data['post_status'] ) {&nbsp;</div></li><li><div>          unset( $post_data['post_status'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ptype = get_post_type_object($post_data['post_type']);&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_post', $post_ID ) ) {&nbsp;</div></li><li><div>      if ( 'page' == $post_data['post_type'] )&nbsp;</div></li><li><div>          wp_die( __('Sorry, you are not allowed to edit this page.' ));&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          wp_die( __('Sorry, you are not allowed to edit this post.' ));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( post_type_supports( $ptype-&gt;name, 'revisions' ) ) {&nbsp;</div></li><li><div>      $revisions = wp_get_post_revisions( $post_ID, array( 'order' =&gt; 'ASC', 'posts_per_page' =&gt; 1 ) );&nbsp;</div></li><li><div>      $revision = current( $revisions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if the revisions have been upgraded</span>&nbsp;</div></li><li><div>      if ( $revisions && _wp_get_post_revision_version( $revision ) &lt; 1 )&nbsp;</div></li><li><div>          _wp_upgrade_revisions_of_post( $post, wp_get_post_revisions( $post_ID ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($post_data['visibility']) ) {&nbsp;</div></li><li><div>      switch ( $post_data['visibility'] ) {&nbsp;</div></li><li><div>          case 'public' :&nbsp;</div></li><li><div>              $post_data['post_password'] = '';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'password' :&nbsp;</div></li><li><div>              unset( $post_data['sticky'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'private' :&nbsp;</div></li><li><div>              $post_data['post_status'] = 'private';&nbsp;</div></li><li><div>              $post_data['post_password'] = '';&nbsp;</div></li><li><div>              unset( $post_data['sticky'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data = _wp_translate_postdata( true, $post_data );&nbsp;</div></li><li><div>  if ( is_wp_error($post_data) )&nbsp;</div></li><li><div>      wp_die( $post_data-&gt;get_error_message() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Post Formats</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['post_format'] ) )&nbsp;</div></li><li><div>      set_post_format( $post_ID, $post_data['post_format'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $format_meta_urls = array( 'url', 'link_url', 'quote_source_url' );&nbsp;</div></li><li><div>  foreach ( $format_meta_urls as $format_meta_url ) {&nbsp;</div></li><li><div>      $keyed = '_format_' . $format_meta_url;&nbsp;</div></li><li><div>      if ( isset( $post_data[ $keyed ] ) )&nbsp;</div></li><li><div>          update_post_meta( $post_ID, $keyed, wp_slash( esc_url_raw( wp_unslash( $post_data[ $keyed ] ) ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $format_keys = array( 'quote', 'quote_source_name', 'image', 'gallery', 'audio_embed', 'video_embed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $format_keys as $key ) {&nbsp;</div></li><li><div>      $keyed = '_format_' . $key;&nbsp;</div></li><li><div>      if ( isset( $post_data[ $keyed ] ) ) {&nbsp;</div></li><li><div>          if ( current_user_can( 'unfiltered_html' ) )&nbsp;</div></li><li><div>              update_post_meta( $post_ID, $keyed, $post_data[ $keyed ] );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              update_post_meta( $post_ID, $keyed, wp_filter_post_kses( $post_data[ $keyed ] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'attachment' === $post_data['post_type'] && preg_match( '#^(audio|video)/#', $post_data['post_mime_type'] ) ) {&nbsp;</div></li><li><div>      $id3data = wp_get_attachment_metadata( $post_ID );&nbsp;</div></li><li><div>      if ( ! is_array( $id3data ) ) {&nbsp;</div></li><li><div>          $id3data = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( wp_get_attachment_id3_keys( $post, 'edit' ) as $key =&gt; $label ) {&nbsp;</div></li><li><div>          if ( isset( $post_data[ 'id3_' . $key ] ) ) {&nbsp;</div></li><li><div>              $id3data[ $key ] = sanitize_text_field( wp_unslash( $post_data[ 'id3_' . $key ] ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_update_attachment_metadata( $post_ID, $id3data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Meta Stuff</span>&nbsp;</div></li><li><div>  if ( isset($post_data['meta']) && $post_data['meta'] ) {&nbsp;</div></li><li><div>      foreach ( $post_data['meta'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if ( !$meta = get_post_meta_by_id( $key ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( $meta-&gt;post_id != $post_ID )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( is_protected_meta( $meta-&gt;meta_key, 'post' ) || ! current_user_can( 'edit_post_meta', $post_ID, $meta-&gt;meta_key ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( is_protected_meta( $value['key'], 'post' ) || ! current_user_can( 'edit_post_meta', $post_ID, $value['key'] ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          update_meta( $key, $value['key'], $value['value'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($post_data['deletemeta']) && $post_data['deletemeta'] ) {&nbsp;</div></li><li><div>      foreach ( $post_data['deletemeta'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if ( !$meta = get_post_meta_by_id( $key ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( $meta-&gt;post_id != $post_ID )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( is_protected_meta( $meta-&gt;meta_key, 'post' ) || ! current_user_can( 'delete_post_meta', $post_ID, $meta-&gt;meta_key ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          delete_meta( $key );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Attachment stuff</span>&nbsp;</div></li><li><div>  if ( 'attachment' == $post_data['post_type'] ) {&nbsp;</div></li><li><div>      if ( isset( $post_data[ '_wp_attachment_image_alt' ] ) ) {&nbsp;</div></li><li><div>          $image_alt = wp_unslash( $post_data['_wp_attachment_image_alt'] );&nbsp;</div></li><li><div>          if ( $image_alt != get_post_meta( $post_ID, '_wp_attachment_image_alt', true ) ) {&nbsp;</div></li><li><div>              $image_alt = wp_strip_all_tags( $image_alt, true );&nbsp;</div></li><li><div>              <span class="comment">// update_meta expects slashed.</span>&nbsp;</div></li><li><div>              update_post_meta( $post_ID, '_wp_attachment_image_alt', wp_slash( $image_alt ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_data = isset( $post_data['attachments'][ $post_ID ] ) ? $post_data['attachments'][ $post_ID ] : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span>&nbsp;</div></li><li><div>      $post_data = apply_filters( 'attachment_fields_to_save', $post_data, $attachment_data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Convert taxonomy input to term IDs, to avoid ambiguity.</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['tax_input'] ) ) {&nbsp;</div></li><li><div>      foreach ( (array) $post_data['tax_input'] as $taxonomy =&gt; $terms ) {&nbsp;</div></li><li><div>          <span class="comment">// Hierarchical taxonomy data is already sent as term IDs, so no conversion is necessary.</span>&nbsp;</div></li><li><div>          if ( is_taxonomy_hierarchical( $taxonomy ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Assume that a 'tax_input' string is a comma-separated list of term names.</span>&nbsp;</div></li><li><div><span class="comment">           * Some languages may use a character other than a comma as a delimiter, so we standardize on</span>&nbsp;</div></li><li><div><span class="comment">           * commas before parsing the list.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! is_array( $terms ) ) {&nbsp;</div></li><li><div>              $comma = _x( ', ', 'tag delimiter' );&nbsp;</div></li><li><div>              if ( ', ' !== $comma ) {&nbsp;</div></li><li><div>                  $terms = str_replace( $comma, ', ', $terms );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $terms = explode( ', ', trim( $terms, &quot; \n\t\r\0\x0B, &quot; ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $clean_terms = array();&nbsp;</div></li><li><div>          foreach ( $terms as $term ) {&nbsp;</div></li><li><div>              <span class="comment">// Empty terms are invalid input.</span>&nbsp;</div></li><li><div>              if ( empty( $term ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $_term = get_terms( $taxonomy, array(&nbsp;</div></li><li><div>                  'name' =&gt; $term, &nbsp;</div></li><li><div>                  'fields' =&gt; 'ids', &nbsp;</div></li><li><div>                  'hide_empty' =&gt; false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $_term ) ) {&nbsp;</div></li><li><div>                  $clean_terms[] = intval( $_term[0] );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// No existing term was found, so pass the string. A new term will be created.</span>&nbsp;</div></li><li><div>                  $clean_terms[] = $term;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post_data['tax_input'][ $taxonomy ] = $clean_terms;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_meta( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $post_ID, '_edit_last', get_current_user_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $success = wp_update_post( $post_data );&nbsp;</div></li><li><div>  <span class="comment">// If the save failed, see if we can sanity check the main fields and try again</span>&nbsp;</div></li><li><div>  if ( ! $success && is_callable( array( $wpdb, 'strip_invalid_text_for_column' ) ) ) {&nbsp;</div></li><li><div>      $fields = array( 'post_title', 'post_content', 'post_excerpt' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $fields as $field ) {&nbsp;</div></li><li><div>          if ( isset( $post_data[ $field ] ) ) {&nbsp;</div></li><li><div>              $post_data[ $field ] = $wpdb-&gt;strip_invalid_text_for_column( $wpdb-&gt;posts, $field, $post_data[ $field ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_update_post( $post_data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Now that we have an ID we can fix any attachment anchor hrefs</span></span>&nbsp;</div></li><li><div>  _fix_attachment_links( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_post_lock( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( $ptype-&gt;cap-&gt;edit_others_posts ) && current_user_can( $ptype-&gt;cap-&gt;publish_posts ) ) {&nbsp;</div></li><li><div>      if ( ! empty( $post_data['sticky'] ) )&nbsp;</div></li><li><div>          stick_post( $post_ID );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          unstick_post( $post_ID );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post_ID;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process the post data for the bulk editing of posts.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Updates all bulk edited posts/pages, adding (but not removing) tags and</span>&nbsp;</div></li><li><div><span class="comment"> * categories. Skips pages when they would be their own parent or child.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post_data Optional, the array of post data to process if not provided will use $_POST superglobal.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function bulk_edit_posts( $post_data = null ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($post_data) )&nbsp;</div></li><li><div>      $post_data = &$_POST;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($post_data['post_type']) )&nbsp;</div></li><li><div>      $ptype = get_post_type_object($post_data['post_type']);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $ptype = get_post_type_object('post');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !current_user_can( $ptype-&gt;cap-&gt;edit_posts ) ) {&nbsp;</div></li><li><div>      if ( 'page' == $ptype-&gt;name )&nbsp;</div></li><li><div>          wp_die( __('Sorry, you are not allowed to edit pages.'));&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          wp_die( __('Sorry, you are not allowed to edit posts.'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( -1 == $post_data['_status'] ) {&nbsp;</div></li><li><div>      $post_data['post_status'] = null;&nbsp;</div></li><li><div>      unset($post_data['post_status']);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post_data['post_status'] = $post_data['_status'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  unset($post_data['_status']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $post_data['post_status'] ) ) {&nbsp;</div></li><li><div>      $post_data['post_status'] = sanitize_key( $post_data['post_status'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'inherit' == $post_data['post_status'] ) {&nbsp;</div></li><li><div>          unset( $post_data['post_status'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_IDs = array_map( 'intval', (array) $post_data['post'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $reset = array(&nbsp;</div></li><li><div>      'post_author', 'post_status', 'post_password', &nbsp;</div></li><li><div>      'post_parent', 'page_template', 'comment_status', &nbsp;</div></li><li><div>      'ping_status', 'keep_private', 'tax_input', &nbsp;</div></li><li><div>      'post_category', 'sticky', 'post_format', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $reset as $field ) {&nbsp;</div></li><li><div>      if ( isset($post_data[$field]) && ( '' == $post_data[$field] || -1 == $post_data[$field] ) )&nbsp;</div></li><li><div>          unset($post_data[$field]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($post_data['post_category']) ) {&nbsp;</div></li><li><div>      if ( is_array($post_data['post_category']) && ! empty($post_data['post_category']) )&nbsp;</div></li><li><div>          $new_cats = array_map( 'absint', $post_data['post_category'] );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          unset($post_data['post_category']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $tax_input = array();&nbsp;</div></li><li><div>  if ( isset($post_data['tax_input'])) {&nbsp;</div></li><li><div>      foreach ( $post_data['tax_input'] as $tax_name =&gt; $terms ) {&nbsp;</div></li><li><div>          if ( empty($terms) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          if ( is_taxonomy_hierarchical( $tax_name ) ) {&nbsp;</div></li><li><div>              $tax_input[ $tax_name ] = array_map( 'absint', $terms );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $comma = _x( ', ', 'tag delimiter' );&nbsp;</div></li><li><div>              if ( ', ' !== $comma )&nbsp;</div></li><li><div>                  $terms = str_replace( $comma, ', ', $terms );&nbsp;</div></li><li><div>              $tax_input[ $tax_name ] = explode( ', ', trim( $terms, &quot; \n\t\r\0\x0B, &quot; ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($post_data['post_parent']) && ($parent = (int) $post_data['post_parent']) ) {&nbsp;</div></li><li><div>      $pages = $wpdb-&gt;get_results(&quot;SELECT ID, post_parent FROM $wpdb-&gt;posts WHERE post_type = 'page'&quot;);&nbsp;</div></li><li><div>      $children = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      for ( $i = 0; $i &lt; 50 && $parent &gt; 0; $i++ ) {&nbsp;</div></li><li><div>          $children[] = $parent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $pages as $page ) {&nbsp;</div></li><li><div>              if ( $page-&gt;ID == $parent ) {&nbsp;</div></li><li><div>                  $parent = $page-&gt;post_parent;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $updated = $skipped = $locked = array();&nbsp;</div></li><li><div>  $shared_post_data = $post_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $post_IDs as $post_ID ) {&nbsp;</div></li><li><div>      <span class="comment">// Start with fresh post data with each iteration.</span>&nbsp;</div></li><li><div>      $post_data = $shared_post_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_type_object = get_post_type_object( get_post_type( $post_ID ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !isset( $post_type_object ) || ( isset($children) && in_array($post_ID, $children) ) || !current_user_can( 'edit_post', $post_ID ) ) {&nbsp;</div></li><li><div>          $skipped[] = $post_ID;&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wp_check_post_lock( $post_ID ) ) {&nbsp;</div></li><li><div>          $locked[] = $post_ID;&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post = get_post( $post_ID );&nbsp;</div></li><li><div>      $tax_names = get_object_taxonomies( $post );&nbsp;</div></li><li><div>      foreach ( $tax_names as $tax_name ) {&nbsp;</div></li><li><div>          $taxonomy_obj = get_taxonomy($tax_name);&nbsp;</div></li><li><div>          if ( isset( $tax_input[$tax_name]) && current_user_can( $taxonomy_obj-&gt;cap-&gt;assign_terms ) )&nbsp;</div></li><li><div>              $new_terms = $tax_input[$tax_name];&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $new_terms = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $taxonomy_obj-&gt;hierarchical )&nbsp;</div></li><li><div>              $current_terms = (array) wp_get_object_terms( $post_ID, $tax_name, array('fields' =&gt; 'ids') );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $current_terms = (array) wp_get_object_terms( $post_ID, $tax_name, array('fields' =&gt; 'names') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post_data['tax_input'][$tax_name] = array_merge( $current_terms, $new_terms );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($new_cats) && in_array( 'category', $tax_names ) ) {&nbsp;</div></li><li><div>          $cats = (array) wp_get_post_categories($post_ID);&nbsp;</div></li><li><div>          $post_data['post_category'] = array_unique( array_merge($cats, $new_cats) );&nbsp;</div></li><li><div>          unset( $post_data['tax_input']['category'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data['post_type'] = $post-&gt;post_type;&nbsp;</div></li><li><div>      $post_data['post_mime_type'] = $post-&gt;post_mime_type;&nbsp;</div></li><li><div>      $post_data['guid'] = $post-&gt;guid;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( array( 'comment_status', 'ping_status', 'post_author' ) as $field ) {&nbsp;</div></li><li><div>          if ( ! isset( $post_data[ $field ] ) ) {&nbsp;</div></li><li><div>              $post_data[ $field ] = $post-&gt;$field;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data['ID'] = $post_ID;&nbsp;</div></li><li><div>      $post_data['post_ID'] = $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data = _wp_translate_postdata( true, $post_data );&nbsp;</div></li><li><div>      if ( is_wp_error( $post_data ) ) {&nbsp;</div></li><li><div>          $skipped[] = $post_ID;&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $updated[] = wp_update_post( $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $post_data['sticky'] ) && current_user_can( $ptype-&gt;cap-&gt;edit_others_posts ) ) {&nbsp;</div></li><li><div>          if ( 'sticky' == $post_data['sticky'] )&nbsp;</div></li><li><div>              stick_post( $post_ID );&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              unstick_post( $post_ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $post_data['post_format'] ) )&nbsp;</div></li><li><div>          set_post_format( $post_ID, $post_data['post_format'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 'updated' =&gt; $updated, 'skipped' =&gt; $skipped, 'locked' =&gt; $locked );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Default post information to use when populating the &quot;Write Post&quot; form.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $post_type    Optional. A post type string. Default 'post'.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $create_in_db Optional. Whether to insert the post into database. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Post Post object containing all the default post data as attributes</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_default_post_to_edit( $post_type = 'post', $create_in_db = false ) {&nbsp;</div></li><li><div>  $post_title = '';&nbsp;</div></li><li><div>  if ( !empty( $_REQUEST['post_title'] ) )&nbsp;</div></li><li><div>      $post_title = esc_html( wp_unslash( $_REQUEST['post_title'] ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_content = '';&nbsp;</div></li><li><div>  if ( !empty( $_REQUEST['content'] ) )&nbsp;</div></li><li><div>      $post_content = esc_html( wp_unslash( $_REQUEST['content'] ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_excerpt = '';&nbsp;</div></li><li><div>  if ( !empty( $_REQUEST['excerpt'] ) )&nbsp;</div></li><li><div>      $post_excerpt = esc_html( wp_unslash( $_REQUEST['excerpt'] ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $create_in_db ) {&nbsp;</div></li><li><div>      $post_id = wp_insert_post( array( 'post_title' =&gt; __( 'Auto Draft' ), 'post_type' =&gt; $post_type, 'post_status' =&gt; 'auto-draft' ) );&nbsp;</div></li><li><div>      $post = get_post( $post_id );&nbsp;</div></li><li><div>      if ( current_theme_supports( 'post-formats' ) && post_type_supports( $post-&gt;post_type, 'post-formats' ) && get_option( 'default_post_format' ) )&nbsp;</div></li><li><div>          set_post_format( $post, get_option( 'default_post_format' ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post = new stdClass;&nbsp;</div></li><li><div>      $post-&gt;ID = 0;&nbsp;</div></li><li><div>      $post-&gt;post_author = '';&nbsp;</div></li><li><div>      $post-&gt;post_date = '';&nbsp;</div></li><li><div>      $post-&gt;post_date_gmt = '';&nbsp;</div></li><li><div>      $post-&gt;post_password = '';&nbsp;</div></li><li><div>      $post-&gt;post_name = '';&nbsp;</div></li><li><div>      $post-&gt;post_type = $post_type;&nbsp;</div></li><li><div>      $post-&gt;post_status = 'draft';&nbsp;</div></li><li><div>      $post-&gt;to_ping = '';&nbsp;</div></li><li><div>      $post-&gt;pinged = '';&nbsp;</div></li><li><div>      $post-&gt;comment_status = get_default_comment_status( $post_type );&nbsp;</div></li><li><div>      $post-&gt;ping_status = get_default_comment_status( $post_type, 'pingback' );&nbsp;</div></li><li><div>      $post-&gt;post_pingback = get_option( 'default_pingback_flag' );&nbsp;</div></li><li><div>      $post-&gt;post_category = get_option( 'default_category' );&nbsp;</div></li><li><div>      $post-&gt;page_template = 'default';&nbsp;</div></li><li><div>      $post-&gt;post_parent = 0;&nbsp;</div></li><li><div>      $post-&gt;menu_order = 0;&nbsp;</div></li><li><div>      $post = new WP_Post( $post );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the default post content initially used in the &quot;Write Post&quot; form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $post_content Default post content.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post         Post object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $post-&gt;post_content = apply_filters( 'default_content', $post_content, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the default post title initially used in the &quot;Write Post&quot; form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $post_title Default post title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post       Post object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $post-&gt;post_title = apply_filters( 'default_title', $post_title, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the default post excerpt initially used in the &quot;Write Post&quot; form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $post_excerpt Default post excerpt.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post         Post object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $post-&gt;post_excerpt = apply_filters( 'default_excerpt', $post_excerpt, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determine if a post exists based on title, content, and date</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title Post title</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $content Optional post content</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $date Optional post date</span>&nbsp;</div></li><li><div><span class="comment"> * @return int Post ID if post exists, 0 otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function post_exists($title, $content = '', $date = '') {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_title = wp_unslash( sanitize_post_field( 'post_title', $title, 0, 'db' ) );&nbsp;</div></li><li><div>  $post_content = wp_unslash( sanitize_post_field( 'post_content', $content, 0, 'db' ) );&nbsp;</div></li><li><div>  $post_date = wp_unslash( sanitize_post_field( 'post_date', $date, 0, 'db' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = &quot;SELECT ID FROM $wpdb-&gt;posts WHERE 1=1&quot;;&nbsp;</div></li><li><div>  $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty ( $date ) ) {&nbsp;</div></li><li><div>      $query .= ' AND post_date = %s';&nbsp;</div></li><li><div>      $args[] = $post_date;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty ( $title ) ) {&nbsp;</div></li><li><div>      $query .= ' AND post_title = %s';&nbsp;</div></li><li><div>      $args[] = $post_title;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty ( $content ) ) {&nbsp;</div></li><li><div>      $query .= ' AND post_content = %s';&nbsp;</div></li><li><div>      $args[] = $post_content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty ( $args ) )&nbsp;</div></li><li><div>      return (int) $wpdb-&gt;get_var( $wpdb-&gt;prepare($query, $args) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a new post from the &quot;Write Post&quot; form using $_POST information.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_User $current_user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_write_post() {&nbsp;</div></li><li><div>  if ( isset($_POST['post_type']) )&nbsp;</div></li><li><div>      $ptype = get_post_type_object($_POST['post_type']);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $ptype = get_post_type_object('post');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !current_user_can( $ptype-&gt;cap-&gt;edit_posts ) ) {&nbsp;</div></li><li><div>      if ( 'page' == $ptype-&gt;name )&nbsp;</div></li><li><div>          return new WP_Error( 'edit_pages', __( 'Sorry, you are not allowed to create pages on this site.' ) );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return new WP_Error( 'edit_posts', __( 'Sorry, you are not allowed to create posts or drafts on this site.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $_POST['post_mime_type'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Clear out any data in internal vars.</span></span>&nbsp;</div></li><li><div>  unset( $_POST['filter'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Edit don't write if we have a post id.</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['post_ID'] ) )&nbsp;</div></li><li><div>      return edit_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_POST['visibility']) ) {&nbsp;</div></li><li><div>      switch ( $_POST['visibility'] ) {&nbsp;</div></li><li><div>          case 'public' :&nbsp;</div></li><li><div>              $_POST['post_password'] = '';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'password' :&nbsp;</div></li><li><div>              unset( $_POST['sticky'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'private' :&nbsp;</div></li><li><div>              $_POST['post_status'] = 'private';&nbsp;</div></li><li><div>              $_POST['post_password'] = '';&nbsp;</div></li><li><div>              unset( $_POST['sticky'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $translated = _wp_translate_postdata( false );&nbsp;</div></li><li><div>  if ( is_wp_error($translated) )&nbsp;</div></li><li><div>      return $translated;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create the post.</span>&nbsp;</div></li><li><div>  $post_ID = wp_insert_post( $_POST );&nbsp;</div></li><li><div>  if ( is_wp_error( $post_ID ) )&nbsp;</div></li><li><div>      return $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($post_ID) )&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_meta( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_post_meta( $post_ID, '_edit_last', $GLOBALS['current_user']-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Now that we have an ID we can fix any attachment anchor hrefs</span></span>&nbsp;</div></li><li><div>  _fix_attachment_links( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_post_lock( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post_ID;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Calls wp_write_post() and handles the errors.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|null</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function write_post() {&nbsp;</div></li><li><div>  $result = wp_write_post();&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) )&nbsp;</div></li><li><div>      wp_die( $result-&gt;get_error_message() );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// Post Meta</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add post meta data defined in $_POST superglobal for post with given ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function add_meta( $post_ID ) {&nbsp;</div></li><li><div>  $post_ID = (int) $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $metakeyselect = isset($_POST['metakeyselect']) ? wp_unslash( trim( $_POST['metakeyselect'] ) ) : '';&nbsp;</div></li><li><div>  $metakeyinput = isset($_POST['metakeyinput']) ? wp_unslash( trim( $_POST['metakeyinput'] ) ) : '';&nbsp;</div></li><li><div>  $metavalue = isset($_POST['metavalue']) ? $_POST['metavalue'] : '';&nbsp;</div></li><li><div>  if ( is_string( $metavalue ) )&nbsp;</div></li><li><div>      $metavalue = trim( $metavalue );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ('0' === $metavalue || ! empty ( $metavalue ) ) && ( ( ( '#NONE#' != $metakeyselect ) && !empty ( $metakeyselect) ) || !empty ( $metakeyinput ) ) ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * We have a key/value pair. If both the select and the input</span>&nbsp;</div></li><li><div><span class="comment">       * for the key have data, the input takes precedence.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>       if ( '#NONE#' != $metakeyselect )&nbsp;</div></li><li><div>          $metakey = $metakeyselect;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $metakeyinput )&nbsp;</div></li><li><div>          $metakey = $metakeyinput; <span class="comment">// default</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_protected_meta( $metakey, 'post' ) || ! current_user_can( 'add_post_meta', $post_ID, $metakey ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $metakey = wp_slash( $metakey );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return add_post_meta( $post_ID, $metakey, $metavalue );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>} <span class="comment">// add_meta</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete post meta data by meta ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $mid</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function delete_meta( $mid ) {&nbsp;</div></li><li><div>  return delete_metadata_by_mid( 'post' , $mid );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a list of previously defined keys.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_meta_keys() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $keys = $wpdb-&gt;get_col( &quot;&nbsp;</div></li><li><div>          SELECT meta_key&nbsp;</div></li><li><div>          FROM $wpdb-&gt;postmeta&nbsp;</div></li><li><div>          GROUP BY meta_key&nbsp;</div></li><li><div>          ORDER BY meta_key&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $keys;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get post meta data by meta ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $mid</span>&nbsp;</div></li><li><div><span class="comment"> * @return object|bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_post_meta_by_id( $mid ) {&nbsp;</div></li><li><div>  return get_metadata_by_mid( 'post', $mid );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get meta data for the given post ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $postid</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function has_meta( $postid ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $wpdb-&gt;get_results( $wpdb-&gt;prepare(&quot;SELECT meta_key, meta_value, meta_id, post_id&nbsp;</div></li><li><div>          FROM $wpdb-&gt;postmeta WHERE post_id = %d&nbsp;</div></li><li><div>          ORDER BY meta_key, meta_id&quot;, $postid), ARRAY_A );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update post meta data by meta ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $meta_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key Expect Slashed</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_value Expect Slashed</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function update_meta( $meta_id, $meta_key, $meta_value ) {&nbsp;</div></li><li><div>  $meta_key = wp_unslash( $meta_key );&nbsp;</div></li><li><div>  $meta_value = wp_unslash( $meta_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return update_metadata_by_mid( 'post', $meta_id, $meta_value, $meta_key );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>// Private&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Replace hrefs of attachment anchors with up-to-date permalinks.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|object $post Post ID or post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @return void|int|WP_Error Void if nothing fixed. 0 or WP_Error on update failure. The post ID on update success.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _fix_attachment_links( $post ) {&nbsp;</div></li><li><div>  $post = get_post( $post, ARRAY_A );&nbsp;</div></li><li><div>  $content = $post['post_content'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Don't run if no pretty permalinks or post is not published, scheduled, or privately published.</span>&nbsp;</div></li><li><div>  if ( ! get_option( 'permalink_structure' ) || ! in_array( $post['post_status'], array( 'publish', 'future', 'private' ) ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Short if there aren't any links or no '?attachment_id=' strings (strpos cannot be zero)</span>&nbsp;</div></li><li><div>  if ( !strpos($content, '?attachment_id=') || !preg_match_all( '/&lt;a ([^&gt;]+)&gt;[\s\S]+?&lt;\/a&gt;/', $content, $link_matches ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $site_url = get_bloginfo('url');&nbsp;</div></li><li><div>  $site_url = substr( $site_url, (int) strpos($site_url, ':<span class="comment">//') ); // remove the http(s)</span>&nbsp;</div></li><li><div>  $replace = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $link_matches[1] as $key =&gt; $value ) {&nbsp;</div></li><li><div>      if ( !strpos($value, '?attachment_id=') || !strpos($value, 'wp-att-')&nbsp;</div></li><li><div>          || !preg_match( '/href=([&quot;\'])[^&quot;\']*\?attachment_id=(\d+)[^&quot;\']*\\1/', $value, $url_match )&nbsp;</div></li><li><div>          || !preg_match( '/rel=[&quot;\'][^&quot;\']*wp-att-(\d+)/', $value, $rel_match ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $quote = $url_match[1]; <span class="comment">// the quote (single or double)</span>&nbsp;</div></li><li><div>      $url_id = (int) $url_match[2];&nbsp;</div></li><li><div>      $rel_id = (int) $rel_match[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$url_id || !$rel_id || $url_id != $rel_id || strpos($url_match[0], $site_url) === false )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $link = $link_matches[0][$key];&nbsp;</div></li><li><div>      $replace = str_replace( $url_match[0], 'href=' . $quote . get_attachment_link( $url_id ) . $quote, $link );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = str_replace( $link, $replace, $content );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $replace ) {&nbsp;</div></li><li><div>      $post['post_content'] = $content;&nbsp;</div></li><li><div>      <span class="comment">// Escape data pulled from DB.</span>&nbsp;</div></li><li><div>      $post = add_magic_quotes($post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wp_update_post($post);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get all the possible statuses for a post_type</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type The post_type you want the statuses for</span>&nbsp;</div></li><li><div><span class="comment"> * @return array As array of all the statuses for the supplied post type</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_available_post_statuses($type = 'post') {&nbsp;</div></li><li><div>  $stati = wp_count_posts($type);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array_keys(get_object_vars($stati));&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Run the wp query to fetch the posts for listing on the edit posts page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|bool $q Array of query variables to use to build the query or false to use $_GET superglobal.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_edit_posts_query( $q = false ) {&nbsp;</div></li><li><div>  if ( false === $q )&nbsp;</div></li><li><div>      $q = $_GET;&nbsp;</div></li><li><div>  $q['m'] = isset($q['m']) ? (int) $q['m'] : 0;&nbsp;</div></li><li><div>  $q['cat'] = isset($q['cat']) ? (int) $q['cat'] : 0;&nbsp;</div></li><li><div>  $post_stati = get_post_stati();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($q['post_type']) && in_array( $q['post_type'], get_post_types() ) )&nbsp;</div></li><li><div>      $post_type = $q['post_type'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $post_type = 'post';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $avail_post_stati = get_available_post_statuses($post_type);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($q['post_status']) && in_array( $q['post_status'], $post_stati ) ) {&nbsp;</div></li><li><div>      $post_status = $q['post_status'];&nbsp;</div></li><li><div>      $perm = 'readable';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $q['orderby'] ) ) {&nbsp;</div></li><li><div>      $orderby = $q['orderby'];&nbsp;</div></li><li><div>  } elseif ( isset( $q['post_status'] ) && in_array( $q['post_status'], array( 'pending', 'draft' ) ) ) {&nbsp;</div></li><li><div>      $orderby = 'modified';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $q['order'] ) ) {&nbsp;</div></li><li><div>      $order = $q['order'];&nbsp;</div></li><li><div>  } elseif ( isset( $q['post_status'] ) && 'pending' == $q['post_status'] ) {&nbsp;</div></li><li><div>      $order = 'ASC';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $per_page = &quot;edit_{$post_type}_per_page&quot;;&nbsp;</div></li><li><div>  $posts_per_page = (int) get_user_option( $per_page );&nbsp;</div></li><li><div>  if ( empty( $posts_per_page ) || $posts_per_page &lt; 1 )&nbsp;</div></li><li><div>      $posts_per_page = 20;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the number of items per page to show for a specific 'per_page' type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portion of the hook name, `$post_type`, refers to the post type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Some examples of filter hooks generated here include: 'edit_attachment_per_page', </span>&nbsp;</div></li><li><div><span class="comment">   * 'edit_post_per_page', 'edit_page_per_page', etc.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $posts_per_page Number of posts to display per page for the given post</span>&nbsp;</div></li><li><div><span class="comment">   *                            type. Default 20.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $posts_per_page = apply_filters( &quot;edit_{$post_type}_per_page&quot;, $posts_per_page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the number of posts displayed per page when specifically listing &quot;posts&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $posts_per_page Number of posts to be displayed. Default 20.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $post_type      The post type.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $posts_per_page = apply_filters( 'edit_posts_per_page', $posts_per_page, $post_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = compact('post_type', 'post_status', 'perm', 'order', 'orderby', 'posts_per_page');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Hierarchical types require special args.</span>&nbsp;</div></li><li><div>  if ( is_post_type_hierarchical( $post_type ) && !isset($orderby) ) {&nbsp;</div></li><li><div>      $query['orderby'] = 'menu_order title';&nbsp;</div></li><li><div>      $query['order'] = 'asc';&nbsp;</div></li><li><div>      $query['posts_per_page'] = -1;&nbsp;</div></li><li><div>      $query['posts_per_archive_page'] = -1;&nbsp;</div></li><li><div>      $query['fields'] = 'id=&gt;parent';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $q['show_sticky'] ) )&nbsp;</div></li><li><div>      $query['post__in'] = (array) get_option( 'sticky_posts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $avail_post_stati;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get all available post MIME types for a given post type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_available_post_mime_types($type = 'attachment') {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $types = $wpdb-&gt;get_col($wpdb-&gt;prepare(&quot;SELECT DISTINCT post_mime_type FROM $wpdb-&gt;posts WHERE post_type = %s&quot;, $type));&nbsp;</div></li><li><div>  return $types;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the query variables for the current attachments request.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|false $q Optional. Array of query variables to use to build the query or false</span>&nbsp;</div></li><li><div><span class="comment"> *                       to use $_GET superglobal. Default false.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The parsed query vars.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_edit_attachments_query_vars( $q = false ) {&nbsp;</div></li><li><div>  if ( false === $q ) {&nbsp;</div></li><li><div>      $q = $_GET;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $q['m'] = isset( $q['m'] ) ? (int) $q['m'] : 0;&nbsp;</div></li><li><div>  $q['cat'] = isset( $q['cat'] ) ? (int) $q['cat'] : 0;&nbsp;</div></li><li><div>  $q['post_type'] = 'attachment';&nbsp;</div></li><li><div>  $post_type = get_post_type_object( 'attachment' );&nbsp;</div></li><li><div>  $states = 'inherit';&nbsp;</div></li><li><div>  if ( current_user_can( $post_type-&gt;cap-&gt;read_private_posts ) ) {&nbsp;</div></li><li><div>      $states .= ', private';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $q['post_status'] = isset( $q['status'] ) && 'trash' == $q['status'] ? 'trash' : $states;&nbsp;</div></li><li><div>  $q['post_status'] = isset( $q['attachment-filter'] ) && 'trash' == $q['attachment-filter'] ? 'trash' : $states;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $media_per_page = (int) get_user_option( 'upload_per_page' );&nbsp;</div></li><li><div>  if ( empty( $media_per_page ) || $media_per_page &lt; 1 ) {&nbsp;</div></li><li><div>      $media_per_page = 20;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the number of items to list per page when listing media items.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $media_per_page Number of media to list. Default 20.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $q['posts_per_page'] = apply_filters( 'upload_per_page', $media_per_page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_mime_types = get_post_mime_types();&nbsp;</div></li><li><div>  if ( isset($q['post_mime_type']) && !array_intersect( (array) $q['post_mime_type'], array_keys($post_mime_types) ) ) {&nbsp;</div></li><li><div>      unset($q['post_mime_type']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( array_keys( $post_mime_types ) as $type ) {&nbsp;</div></li><li><div>      if ( isset( $q['attachment-filter'] ) && &quot;post_mime_type:$type&quot; == $q['attachment-filter'] ) {&nbsp;</div></li><li><div>          $q['post_mime_type'] = $type;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $q['detached'] ) || ( isset( $q['attachment-filter'] ) && 'detached' == $q['attachment-filter'] ) ) {&nbsp;</div></li><li><div>      $q['post_parent'] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Filter query clauses to include filenames.</span>&nbsp;</div></li><li><div>  if ( isset( $q['s'] ) ) {&nbsp;</div></li><li><div>      add_filter( 'posts_clauses', '_filter_query_attachment_filenames' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $q;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filter the SQL clauses of an attachment query to include filenames.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.7.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global wpdb $wpdb WordPress database abstraction object.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $clauses An array including WHERE, GROUP BY, JOIN, ORDER BY, </span>&nbsp;</div></li><li><div><span class="comment"> *                       DISTINCT, fields (SELECT), and LIMITS clauses.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array The modified clauses.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _filter_query_attachment_filenames( $clauses ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  remove_filter( 'posts_clauses', __FUNCTION__ );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add a LEFT JOIN of the postmeta table so we don't trample existing JOINs.</span>&nbsp;</div></li><li><div>  $clauses['join'] .= &quot; LEFT JOIN {$wpdb-&gt;postmeta} AS sq1 ON ( {$wpdb-&gt;posts}.ID = sq1.post_id AND sq1.meta_key = '_wp_attached_file' )&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $clauses['groupby'] = &quot;{$wpdb-&gt;posts}.ID&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $clauses['where'] = preg_replace(&nbsp;</div></li><li><div>      &quot;/\({$wpdb-&gt;posts}.post_content (NOT LIKE|LIKE) (\'[^']+\')\)/&quot;, &nbsp;</div></li><li><div>      &quot;$0 OR ( sq1.meta_value $1 $2 )&quot;, &nbsp;</div></li><li><div>      $clauses['where'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $clauses;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Executes a query for attachments. An array of WP_Query arguments</span>&nbsp;</div></li><li><div><span class="comment"> * can be passed in, which will override the arguments set by this function.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array|false $q Array of query variables to use to build the query or false to use $_GET superglobal.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_edit_attachments_query( $q = false ) {&nbsp;</div></li><li><div>  wp( wp_edit_attachments_query_vars( $q ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_mime_types = get_post_mime_types();&nbsp;</div></li><li><div>  $avail_post_mime_types = get_available_post_mime_types( 'attachment' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( $post_mime_types, $avail_post_mime_types );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the list of classes to be used by a meta box.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $id</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $page</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function postbox_classes( $id, $page ) {&nbsp;</div></li><li><div>  if ( isset( $_GET['edit'] ) && $_GET['edit'] == $id ) {&nbsp;</div></li><li><div>      $classes = array( '' );&nbsp;</div></li><li><div>  } elseif ( $closed = get_user_option('closedpostboxes_'.$page ) ) {&nbsp;</div></li><li><div>      if ( !is_array( $closed ) ) {&nbsp;</div></li><li><div>          $classes = array( '' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $classes = in_array( $id, $closed ) ? array( 'closed' ) : array( '' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $classes = array( '' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the postbox classes for a specific screen and screen ID combo.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The dynamic portions of the hook name, `$page` and `$id`, refer to</span>&nbsp;</div></li><li><div><span class="comment">   * the screen and screen ID, respectively.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $classes An array of postbox classes.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $classes = apply_filters( &quot;postbox_classes_{$page}_{$id}&quot;, $classes );&nbsp;</div></li><li><div>  return implode( ' ', $classes );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get a sample permalink based off of the post name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id    Post ID or post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $title Optional. Title to override the post's current title when generating the post name. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $name  Optional. Name to override the post name. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array containing the sample permalink with placeholder for the post name, and the post name.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_sample_permalink($id, $title = null, $name = null) {&nbsp;</div></li><li><div>  $post = get_post( $id );&nbsp;</div></li><li><div>  if ( ! $post )&nbsp;</div></li><li><div>      return array( '', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ptype = get_post_type_object($post-&gt;post_type);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $original_status = $post-&gt;post_status;&nbsp;</div></li><li><div>  $original_date = $post-&gt;post_date;&nbsp;</div></li><li><div>  $original_name = $post-&gt;post_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Hack: get_permalink() would return ugly permalink for drafts, so we will fake that our post is published.</span>&nbsp;</div></li><li><div>  if ( in_array( $post-&gt;post_status, array( 'draft', 'pending', 'future' ) ) ) {&nbsp;</div></li><li><div>      $post-&gt;post_status = 'publish';&nbsp;</div></li><li><div>      $post-&gt;post_name = sanitize_title($post-&gt;post_name ? $post-&gt;post_name : $post-&gt;post_title, $post-&gt;ID);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the user wants to set a new name -- override the current one</span>&nbsp;</div></li><li><div>  <span class="comment">// Note: if empty name is supplied -- use the title instead, see #6072</span>&nbsp;</div></li><li><div>  if ( !is_null($name) )&nbsp;</div></li><li><div>      $post-&gt;post_name = sanitize_title($name ? $name : $title, $post-&gt;ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post-&gt;post_name = wp_unique_post_slug($post-&gt;post_name, $post-&gt;ID, $post-&gt;post_status, $post-&gt;post_type, $post-&gt;post_parent);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post-&gt;filter = 'sample';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $permalink = get_permalink($post, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Replace custom post_type Token with generic pagename token for ease of use.</span>&nbsp;</div></li><li><div>  $permalink = str_replace(&quot;%$post-&gt;post_type%&quot;, '%pagename%', $permalink);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle page hierarchy</span>&nbsp;</div></li><li><div>  if ( $ptype-&gt;hierarchical ) {&nbsp;</div></li><li><div>      $uri = get_page_uri($post);&nbsp;</div></li><li><div>      if ( $uri ) {&nbsp;</div></li><li><div>          $uri = untrailingslashit($uri);&nbsp;</div></li><li><div>          $uri = strrev( stristr( strrev( $uri ), '/' ) );&nbsp;</div></li><li><div>          $uri = untrailingslashit($uri);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** This filter is documented in wp-admin/edit-tag-form.php */</span></span>&nbsp;</div></li><li><div>      $uri = apply_filters( 'editable_slug', $uri, $post );&nbsp;</div></li><li><div>      if ( !empty($uri) )&nbsp;</div></li><li><div>          $uri .= '/';&nbsp;</div></li><li><div>      $permalink = str_replace('%pagename%', &quot;{$uri}%pagename%&quot;, $permalink);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in wp-admin/edit-tag-form.php */</span></span>&nbsp;</div></li><li><div>  $permalink = array( $permalink, apply_filters( 'editable_slug', $post-&gt;post_name, $post ) );&nbsp;</div></li><li><div>  $post-&gt;post_status = $original_status;&nbsp;</div></li><li><div>  $post-&gt;post_date = $original_date;&nbsp;</div></li><li><div>  $post-&gt;post_name = $original_name;&nbsp;</div></li><li><div>  unset($post-&gt;filter);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the sample permalink.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array   $permalink Array containing the sample permalink with placeholder for the post name, and the post name.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $post_id   Post ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $title     Post title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $name      Post name (slug).</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post      Post object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'get_sample_permalink', $permalink, $post-&gt;ID, $title, $name, $post );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the HTML of the sample permalink slug editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $id        Post ID or post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $new_title Optional. New title. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $new_slug  Optional. New slug. Default null.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The HTML of the sample permalink slug editor.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function get_sample_permalink_html( $id, $new_title = null, $new_slug = null ) {&nbsp;</div></li><li><div>  $post = get_post( $id );&nbsp;</div></li><li><div>  if ( ! $post )&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  list($permalink, $post_name) = get_sample_permalink($post-&gt;ID, $new_title, $new_slug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $view_link = false;&nbsp;</div></li><li><div>  $preview_target = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( 'read_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>      if ( 'draft' === $post-&gt;post_status || empty( $post-&gt;post_name ) ) {&nbsp;</div></li><li><div>          $view_link = get_preview_post_link( $post );&nbsp;</div></li><li><div>          $preview_target = &quot; target='wp-preview-{$post-&gt;ID}'&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( 'publish' === $post-&gt;post_status || 'attachment' === $post-&gt;post_type ) {&nbsp;</div></li><li><div>              $view_link = get_permalink( $post );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Allow non-published (private, future) to be viewed at a pretty permalink, in case $post-&gt;post_name is set</span>&nbsp;</div></li><li><div>              $view_link = str_replace( array( '%pagename%', '%postname%' ), $post-&gt;post_name, $permalink );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Permalinks without a post/page name placeholder don't have anything to edit</span>&nbsp;</div></li><li><div>  if ( false === strpos( $permalink, '%postname%' ) && false === strpos( $permalink, '%pagename%' ) ) {&nbsp;</div></li><li><div>      $return = '&lt;strong&gt;' . __( 'Permalink:' ) . &quot;&lt;/strong&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== $view_link ) {&nbsp;</div></li><li><div>          $display_link = urldecode( $view_link );&nbsp;</div></li><li><div>          $return .= '&lt;a id=&quot;sample-permalink&quot; href=&quot;' . esc_url( $view_link ) . '&quot;' . $preview_target . '&gt;' . esc_html( $display_link ) . &quot;&lt;/a&gt;\n&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $return .= '&lt;span id=&quot;sample-permalink&quot;&gt;' . $permalink . &quot;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Encourage a pretty permalink setting</span>&nbsp;</div></li><li><div>      if ( '' == get_option( 'permalink_structure' ) && current_user_can( 'manage_options' ) && !( 'page' == get_option('show_on_front') && $id == get_option('page_on_front') ) ) {&nbsp;</div></li><li><div>          $return .= '&lt;span id=&quot;change-permalinks&quot;&gt;&lt;a href=&quot;options-permalink.php&quot; class=&quot;button button-small&quot; target=&quot;_blank&quot;&gt;' . __('Change Permalinks') . &quot;&lt;/a&gt;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( mb_strlen( $post_name ) &gt; 34 ) {&nbsp;</div></li><li><div>          $post_name_abridged = mb_substr( $post_name, 0, 16 ) . '&hellip;' . mb_substr( $post_name, -16 );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $post_name_abridged = $post_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_name_html = '&lt;span id=&quot;editable-post-name&quot;&gt;' . esc_html( $post_name_abridged ) . '&lt;/span&gt;';&nbsp;</div></li><li><div>      $display_link = str_replace( array( '%pagename%', '%postname%' ), $post_name_html, esc_html( urldecode( $permalink ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return = '&lt;strong&gt;' . __( 'Permalink:' ) . &quot;&lt;/strong&gt;\n&quot;;&nbsp;</div></li><li><div>      $return .= '&lt;span id=&quot;sample-permalink&quot;&gt;&lt;a href=&quot;' . esc_url( $view_link ) . '&quot;' . $preview_target . '&gt;' . $display_link . &quot;&lt;/a&gt;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>      $return .= '&lrm;'; <span class="comment">// Fix bi-directional text display defect in RTL languages.</span>&nbsp;</div></li><li><div>      $return .= '&lt;span id=&quot;edit-slug-buttons&quot;&gt;&lt;button type=&quot;button&quot; class=&quot;edit-slug button button-small hide-if-no-js&quot; aria-label=&quot;' . __( 'Edit permalink' ) . '&quot;&gt;' . __( 'Edit' ) . &quot;&lt;/button&gt;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>      $return .= '&lt;span id=&quot;editable-post-name-full&quot;&gt;' . esc_html( $post_name ) . &quot;&lt;/span&gt;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the sample permalink HTML markup.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.4.0 Added `$post` parameter.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $return    Sample permalink HTML markup.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int     $post_id   Post ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $new_title New sample permalink title.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string  $new_slug  New sample permalink slug.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post      Post object.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $return = apply_filters( 'get_sample_permalink_html', $return, $post-&gt;ID, $new_title, $new_slug, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Output HTML for the post thumbnail meta-box.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $thumbnail_id ID of the attachment used for thumbnail</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $post The post ID or object associated with the thumbnail, defaults to global $post.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string html</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wp_post_thumbnail_html( $thumbnail_id = null, $post = null ) {&nbsp;</div></li><li><div>  $_wp_additional_image_sizes = wp_get_additional_image_sizes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post( $post );&nbsp;</div></li><li><div>  $post_type_object = get_post_type_object( $post-&gt;post_type );&nbsp;</div></li><li><div>  $set_thumbnail_link = '&lt;p class=&quot;hide-if-no-js&quot;&gt;&lt;a href=&quot;%s&quot; id=&quot;set-post-thumbnail&quot;%s class=&quot;thickbox&quot;&gt;%s&lt;/a&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>  $upload_iframe_src = get_upload_iframe_src( 'image', $post-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $content = sprintf( $set_thumbnail_link, &nbsp;</div></li><li><div>      esc_url( $upload_iframe_src ), &nbsp;</div></li><li><div>      '', <span class="comment">// Empty when there's no featured image set, `aria-describedby` attribute otherwise.</span>&nbsp;</div></li><li><div>      esc_html( $post_type_object-&gt;labels-&gt;set_featured_image )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $thumbnail_id && get_post( $thumbnail_id ) ) {&nbsp;</div></li><li><div>      $size = isset( $_wp_additional_image_sizes['post-thumbnail'] ) ? 'post-thumbnail' : array( 266, 266 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the size used to display the post thumbnail image in the 'Featured Image' meta box.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Note: When a theme adds 'post-thumbnail' support, a special 'post-thumbnail'</span>&nbsp;</div></li><li><div><span class="comment">       * image size is registered, which differs from the 'thumbnail' image size</span>&nbsp;</div></li><li><div><span class="comment">       * managed via the Settings &gt; Media screen. See the `$size` parameter description</span>&nbsp;</div></li><li><div><span class="comment">       * for more information on default values.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string|array $size         Post thumbnail image size to display in the meta box. Accepts any valid</span>&nbsp;</div></li><li><div><span class="comment">       *                                   image size, or an array of width and height values in pixels (in that order).</span>&nbsp;</div></li><li><div><span class="comment">       *                                   If the 'post-thumbnail' size is set, default is 'post-thumbnail'. Otherwise, </span>&nbsp;</div></li><li><div><span class="comment">       *                                   default is an array with 266 as both the height and width values.</span>&nbsp;</div></li><li><div><span class="comment">       * @param int          $thumbnail_id Post thumbnail attachment ID.</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_Post      $post         The post object associated with the thumbnail.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $size = apply_filters( 'admin_post_thumbnail_size', $size, $thumbnail_id, $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $thumbnail_html = wp_get_attachment_image( $thumbnail_id, $size );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $thumbnail_html ) ) {&nbsp;</div></li><li><div>          $content = sprintf( $set_thumbnail_link, &nbsp;</div></li><li><div>              esc_url( $upload_iframe_src ), &nbsp;</div></li><li><div>              ' aria-describedby=&quot;set-post-thumbnail-desc&quot;', &nbsp;</div></li><li><div>              $thumbnail_html&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $content .= '&lt;p class=&quot;hide-if-no-js howto&quot; id=&quot;set-post-thumbnail-desc&quot;&gt;' . __( 'Click the image to edit or update' ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>          $content .= '&lt;p class=&quot;hide-if-no-js&quot;&gt;&lt;a href=&quot;#&quot; id=&quot;remove-post-thumbnail&quot;&gt;' . esc_html( $post_type_object-&gt;labels-&gt;remove_featured_image ) . '&lt;/a&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $content .= '&lt;input type=&quot;hidden&quot; id=&quot;_thumbnail_id&quot; name=&quot;_thumbnail_id&quot; value=&quot;' . esc_attr( $thumbnail_id ? $thumbnail_id : '-1' ) . '&quot; /&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the admin post thumbnail HTML markup to return.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.5.0 Added the `$post_id` parameter.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.6.0 Added the `$thumbnail_id` parameter.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content      Admin post thumbnail HTML markup.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $post_id      Post ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $thumbnail_id Thumbnail ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'admin_post_thumbnail_html', $content, $post-&gt;ID, $thumbnail_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check to see if the post is currently being edited by another user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id ID of the post to check for editing</span>&nbsp;</div></li><li><div><span class="comment"> * @return integer False: not locked or locked by current user. Int: user ID of user with lock.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_check_post_lock( $post_id ) {&nbsp;</div></li><li><div>  if ( !$post = get_post( $post_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$lock = get_post_meta( $post-&gt;ID, '_edit_lock', true ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $lock = explode( ':', $lock );&nbsp;</div></li><li><div>  $time = $lock[0];&nbsp;</div></li><li><div>  $user = isset( $lock[1] ) ? $lock[1] : get_post_meta( $post-&gt;ID, '_edit_last', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** This filter is documented in wp-admin/includes/ajax-actions.php */</span>&nbsp;</div></li><li><div>  $time_window = apply_filters( 'wp_check_post_lock_window', 150 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $time && $time &gt; time() - $time_window && $user != get_current_user_id() )&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Mark the post as currently being edited by the current user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id ID of the post to being edited</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|array Returns false if the post doesn't exist of there is no current user, or</span>&nbsp;</div></li><li><div><span class="comment"> *     an array of the lock time and the user ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_set_post_lock( $post_id ) {&nbsp;</div></li><li><div>  if ( !$post = get_post( $post_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  if ( 0 == ($user_id = get_current_user_id()) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $now = time();&nbsp;</div></li><li><div>  $lock = &quot;$now:$user_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_post_meta( $post-&gt;ID, '_edit_lock', $lock );&nbsp;</div></li><li><div>  return array( $now, $user_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Outputs the HTML for the notice to say that someone else is editing or has taken over editing of this post.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.8.5</span>&nbsp;</div></li><li><div><span class="comment"> * @return none</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _admin_notice_post_locked() {&nbsp;</div></li><li><div>  if ( ! $post = get_post() )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = null;&nbsp;</div></li><li><div>  if (  $user_id = wp_check_post_lock( $post-&gt;ID ) )&nbsp;</div></li><li><div>      $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $user ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters whether to show the post locked dialog.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Returning a falsey value to the filter will short-circuit displaying the dialog.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool         $display Whether to display the dialog. Default true.</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_User|bool $user    WP_User object on success, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( ! apply_filters( 'show_post_locked_dialog', true, $post, $user ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $locked = true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $locked = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $locked && ( $sendback = wp_get_referer() ) &&&nbsp;</div></li><li><div>      false === strpos( $sendback, 'post.php' ) && false === strpos( $sendback, 'post-new.php' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sendback_text = __('Go back');&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $sendback = admin_url( 'edit.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'post' != $post-&gt;post_type )&nbsp;</div></li><li><div>          $sendback = add_query_arg( 'post_type', $post-&gt;post_type, $sendback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sendback_text = get_post_type_object( $post-&gt;post_type )-&gt;labels-&gt;all_items;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $hidden = $locked ? '' : ' hidden';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;div id=&quot;post-lock-dialog&quot; class=&quot;notification-dialog-wrap&lt;?php echo $hidden; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;notification-dialog-background&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;notification-dialog&quot;&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $locked ) {&nbsp;</div></li><li><div>      $query_args = array();&nbsp;</div></li><li><div>      if ( get_post_type_object( $post-&gt;post_type )-&gt;public ) {&nbsp;</div></li><li><div>          if ( 'publish' == $post-&gt;post_status || $user-&gt;ID != $post-&gt;post_author ) {&nbsp;</div></li><li><div>              <span class="comment">// Latest content is in autosave</span>&nbsp;</div></li><li><div>              $nonce = wp_create_nonce( 'post_preview_' . $post-&gt;ID );&nbsp;</div></li><li><div>              $query_args['preview_id'] = $post-&gt;ID;&nbsp;</div></li><li><div>              $query_args['preview_nonce'] = $nonce;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $preview_link = get_preview_post_link( $post-&gt;ID, $query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters whether to allow the post lock to be overridden.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Returning a falsey value to the filter will disable the ability</span>&nbsp;</div></li><li><div><span class="comment">       * to override the post lock.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool    $override Whether to allow overriding post locks. Default true.</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_Post $post     Post object.</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_User $user     User object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $override = apply_filters( 'override_post_lock', true, $post, $user );&nbsp;</div></li><li><div>      $tab_last = $override ? '' : ' wp-tab-last';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;post-locked-message&quot;&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;post-locked-avatar&quot;&gt;&lt;?php echo get_avatar( $user-&gt;ID, 64 ); ?&gt;&lt;/div&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;currently-editing wp-tab-first&quot; tabindex=&quot;0&quot;&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>          _e( 'This content is currently locked.' );&nbsp;</div></li><li><div>          if ( $override )&nbsp;</div></li><li><div>              printf( ' ' . __( 'If you take over, %s will be blocked from continuing to edit.' ), esc_html( $user-&gt;display_name ) );&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires inside the post locked dialog before the buttons are displayed.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param WP_Post $post Post object.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'post_locked_dialog', $post );&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&nbsp;</div></li><li><div>      &lt;a class=&quot;button&quot; href=&quot;&lt;?php echo esc_url( $sendback ); ?&gt;&quot;&gt;&lt;?php echo $sendback_text; ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;?php if ( $preview_link ) { ?&gt;&nbsp;</div></li><li><div>      &lt;a class=&quot;button&lt;?php echo $tab_last; ?&gt;&quot; href=&quot;&lt;?php echo esc_url( $preview_link ); ?&gt;&quot;&gt;&lt;?php _e('Preview'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Allow plugins to prevent some users overriding the post lock</span>&nbsp;</div></li><li><div>      if ( $override ) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;a class=&quot;button button-primary wp-tab-last&quot; href=&quot;&lt;?php echo esc_url( add_query_arg( 'get-post-lock', '1', wp_nonce_url( get_edit_post_link( $post-&gt;ID, 'url' ), 'lock-post_' . $post-&gt;ID ) ) ); ?&gt;&quot;&gt;&lt;?php _e('Take over'); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;/p&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;post-taken-over&quot;&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;post-locked-avatar&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;p class=&quot;wp-tab-first&quot; tabindex=&quot;0&quot;&gt;&nbsp;</div></li><li><div>          &lt;span class=&quot;currently-editing&quot;&gt;&lt;/span&gt;&lt;br /&gt;&nbsp;</div></li><li><div>          &lt;span class=&quot;locked-saving hidden&quot;&gt;&lt;img src=&quot;&lt;?php echo esc_url( admin_url( 'images/spinner-2x.gif' ) ); ?&gt;&quot; width=&quot;16&quot; height=&quot;16&quot; alt=&quot;&quot; /&gt; &lt;?php _e( 'Saving revision&hellip;' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>          &lt;span class=&quot;locked-saved hidden&quot;&gt;&lt;?php _e('Your latest changes were saved as a revision.'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires inside the dialog displayed when a user has lost the post lock.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param WP_Post $post Post object.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'post_lock_lost_dialog', $post );&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;p&gt;&lt;a class=&quot;button button-primary wp-tab-last&quot; href=&quot;&lt;?php echo esc_url( $sendback ); ?&gt;&quot;&gt;&lt;?php echo $sendback_text; ?&gt;&lt;/a&gt;&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates autosave data for the specified post from $_POST data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Post_Revisions</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $post_data Associative array containing the post data or int post ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed The autosave revision ID. WP_Error or 0 on error.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_create_post_autosave( $post_data ) {&nbsp;</div></li><li><div>  if ( is_numeric( $post_data ) ) {&nbsp;</div></li><li><div>      $post_id = $post_data;&nbsp;</div></li><li><div>      $post_data = $_POST;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post_id = (int) $post_data['post_ID'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data = _wp_translate_postdata( true, $post_data );&nbsp;</div></li><li><div>  if ( is_wp_error( $post_data ) )&nbsp;</div></li><li><div>      return $post_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_author = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Store one autosave per author. If there is already an autosave, overwrite it.</span>&nbsp;</div></li><li><div>  if ( $old_autosave = wp_get_post_autosave( $post_id, $post_author ) ) {&nbsp;</div></li><li><div>      $new_autosave = _wp_post_revision_data( $post_data, true );&nbsp;</div></li><li><div>      $new_autosave['ID'] = $old_autosave-&gt;ID;&nbsp;</div></li><li><div>      $new_autosave['post_author'] = $post_author;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the new autosave has the same content as the post, delete the autosave.</span>&nbsp;</div></li><li><div>      $post = get_post( $post_id );&nbsp;</div></li><li><div>      $autosave_is_different = false;&nbsp;</div></li><li><div>      foreach ( array_intersect( array_keys( $new_autosave ), array_keys( _wp_post_revision_fields( $post ) ) ) as $field ) {&nbsp;</div></li><li><div>          if ( normalize_whitespace( $new_autosave[ $field ] ) != normalize_whitespace( $post-&gt;$field ) ) {&nbsp;</div></li><li><div>              $autosave_is_different = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $autosave_is_different ) {&nbsp;</div></li><li><div>          wp_delete_post_revision( $old_autosave-&gt;ID );&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires before an autosave is stored.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 4.1.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $new_autosave Post array - the autosave that is about to be saved.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'wp_creating_autosave', $new_autosave );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wp_update_post( $new_autosave );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// _wp_put_post_revision() expects unescaped.</span>&nbsp;</div></li><li><div>  $post_data = wp_unslash( $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Otherwise create the new autosave as a special post revision</span>&nbsp;</div></li><li><div>  return _wp_put_post_revision( $post_data, true );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save draft or manually autosave for showing preview.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return str URL to redirect to show the preview</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function post_preview() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_ID = (int) $_POST['post_ID'];&nbsp;</div></li><li><div>  $_POST['ID'] = $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post = get_post( $post_ID ) ) {&nbsp;</div></li><li><div>      wp_die( __( 'Sorry, you are not allowed to edit this post.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>      wp_die( __( 'Sorry, you are not allowed to edit this post.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_autosave = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_check_post_lock( $post-&gt;ID ) && get_current_user_id() == $post-&gt;post_author && ( 'draft' == $post-&gt;post_status || 'auto-draft' == $post-&gt;post_status ) ) {&nbsp;</div></li><li><div>      $saved_post_id = edit_post();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $is_autosave = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['post_status'] ) && 'auto-draft' == $_POST['post_status'] )&nbsp;</div></li><li><div>          $_POST['post_status'] = 'draft';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $saved_post_id = wp_create_post_autosave( $post-&gt;ID );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $saved_post_id ) )&nbsp;</div></li><li><div>      wp_die( $saved_post_id-&gt;get_error_message() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query_args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_autosave && $saved_post_id ) {&nbsp;</div></li><li><div>      $query_args['preview_id'] = $post-&gt;ID;&nbsp;</div></li><li><div>      $query_args['preview_nonce'] = wp_create_nonce( 'post_preview_' . $post-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['post_format'] ) ) {&nbsp;</div></li><li><div>          $query_args['post_format'] = empty( $_POST['post_format'] ) ? 'standard' : sanitize_key( $_POST['post_format'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['_thumbnail_id'] ) ) {&nbsp;</div></li><li><div>          $query_args['_thumbnail_id'] = ( intval( $_POST['_thumbnail_id'] ) &lt;= 0 ) ? '-1' : intval( $_POST['_thumbnail_id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return get_preview_post_link( $post, $query_args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save a post submitted with XHR</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Intended for use with heartbeat and autosave.js</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $post_data Associative array of the submitted post data.</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed The value 0 or WP_Error on failure. The saved post ID on success.</span>&nbsp;</div></li><li><div><span class="comment"> *               The ID can be the draft post_id or the autosave revision post_id.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_autosave( $post_data ) {&nbsp;</div></li><li><div>  <span class="comment">// Back-compat</span>&nbsp;</div></li><li><div>  if ( ! defined( 'DOING_AUTOSAVE' ) )&nbsp;</div></li><li><div>      define( 'DOING_AUTOSAVE', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = (int) $post_data['post_id'];&nbsp;</div></li><li><div>  $post_data['ID'] = $post_data['post_ID'] = $post_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === wp_verify_nonce( $post_data['_wpnonce'], 'update-post_' . $post_id ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'invalid_nonce', __( 'Error while saving.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'edit_posts', __( 'Sorry, you are not allowed to edit this item.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'auto-draft' == $post-&gt;post_status )&nbsp;</div></li><li><div>      $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post_data['post_type'] != 'page' && ! empty( $post_data['catslist'] ) )&nbsp;</div></li><li><div>      $post_data['post_category'] = explode( ', ', $post_data['catslist'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_check_post_lock( $post-&gt;ID ) && get_current_user_id() == $post-&gt;post_author && ( 'auto-draft' == $post-&gt;post_status || 'draft' == $post-&gt;post_status ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Drafts and auto-drafts are just overwritten by autosave for the same user if the post is not locked</span>&nbsp;</div></li><li><div>      return edit_post( wp_slash( $post_data ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Non drafts or other users drafts are not overwritten. The autosave is stored in a special post revision for each user.</span>&nbsp;</div></li><li><div>      return wp_create_post_autosave( wp_slash( $post_data ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Redirect to previous page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id Optional. Post ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function redirect_post($post_id = '') {&nbsp;</div></li><li><div>  if ( isset($_POST['save']) || isset($_POST['publish']) ) {&nbsp;</div></li><li><div>      $status = get_post_status( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['publish'] ) ) {&nbsp;</div></li><li><div>          switch ( $status ) {&nbsp;</div></li><li><div>              case 'pending':&nbsp;</div></li><li><div>                  $message = 8;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'future':&nbsp;</div></li><li><div>                  $message = 9;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                  $message = 6;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $message = 'draft' == $status ? 10 : 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $location = add_query_arg( 'message', $message, get_edit_post_link( $post_id, 'url' ) );&nbsp;</div></li><li><div>  } elseif ( isset($_POST['addmeta']) && $_POST['addmeta'] ) {&nbsp;</div></li><li><div>      $location = add_query_arg( 'message', 2, wp_get_referer() );&nbsp;</div></li><li><div>      $location = explode('#', $location);&nbsp;</div></li><li><div>      $location = $location[0] . '#postcustom';&nbsp;</div></li><li><div>  } elseif ( isset($_POST['deletemeta']) && $_POST['deletemeta'] ) {&nbsp;</div></li><li><div>      $location = add_query_arg( 'message', 3, wp_get_referer() );&nbsp;</div></li><li><div>      $location = explode('#', $location);&nbsp;</div></li><li><div>      $location = $location[0] . '#postcustom';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $location = add_query_arg( 'message', 4, get_edit_post_link( $post_id, 'url' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the post redirect destination URL.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $location The destination URL.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $post_id  The post ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  wp_redirect( apply_filters( 'redirect_post_location', $location, $post_id ) );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-admin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>