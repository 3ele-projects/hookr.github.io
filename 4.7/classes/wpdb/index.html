<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="wordpress" data-version="4.7" data-type="class" data-id="5009"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpdb | class | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="wpdb, class, wordpress, 4.7" /><meta name="description" content="WordPress Database Access Abstraction Object" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=f3790b2a42c928be98afa1513e8451c2' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wpdb/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwpdb%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwpdb%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7-class-wpdb","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpdb" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7." href="http://hookr.io/4.7/" class="H_VERSION"><span property="name">4.7</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/4.7/classes/" class=""><span property="name">classes</span></a><meta property="position" content="3"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpdb</span><meta property="position" content="4"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="6307"><a href="http://hookr.io/4.7/all/" title="All">All <span class="count badge">6307</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/4.7/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2531"><a href="http://hookr.io/4.7/hooks/" title="Hooks">Hooks <span class="count badge">2531</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1667"><a href="http://hookr.io/4.7/filters/" title="Filters">Filters <span class="count badge">1667</span></a></li><li class="active" data-id="class" data-count="351"><a href="http://hookr.io/4.7/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2851"><a href="http://hookr.io/4.7/functions/" title="Functions">Functions <span class="count badge">2851</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>wpdb</strong></h1><p>WordPress Database Access Abstraction Object.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/4.7/files/wp-includes-wp-db/" class="file">/wp-includes/wp-db.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="51" class="block" start="52"><li><div>class wpdb {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether to show SQL/DB errors.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Default behavior is to show errors if both WP_DEBUG and WP_DEBUG_DISPLAY&nbsp;</div></li><li><div>     * evaluated to true.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $show_errors = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether to suppress errors during the DB bootstrapping.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $suppress_errors = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The last error during query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $last_error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Amount of queries made&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.2.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $num_queries = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Count of rows returned by previous query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $num_rows = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Count of affected rows by previous query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $rows_affected = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The ID generated for an AUTO_INCREMENT column by the previous query (usually INSERT).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $insert_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Last query made&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $last_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Results of the last query made&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var array|null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $last_result;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * MySQL result, which is either a resource or boolean.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $result;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cached column info, for sanity checking data before inserting&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $col_meta = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Calculated character sets on tables&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $table_charset = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether text fields in the current query need to be sanity checked.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $check_current_query = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Flag to ensure we don't run into recursion problems when checking the collation.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @see wpdb::check_safe_collation()&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $checking_collation = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Saved info on the table column&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $col_info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Saved queries that were executed&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $queries;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The number of times to retry reconnecting before dying.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @see wpdb::check_connection()&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $reconnect_retries = 5;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress table prefix&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * You can set this to have multiple WordPress installations&nbsp;</div></li><li><div>     * in a single database. The second reason is for possible&nbsp;</div></li><li><div>     * security precautions.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $prefix = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress base table prefix.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>     public $base_prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether the database queries are ready to start executing.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.2&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $ready = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Blog ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $blogid = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Site ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $siteid = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * List of WordPress per-blog tables&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @see wpdb::tables()&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $tables = array( 'posts', 'comments', 'links', 'options', 'postmeta', &nbsp;</div></li><li><div>        'terms', 'term_taxonomy', 'term_relationships', 'termmeta', 'commentmeta' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * List of deprecated WordPress tables&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * categories, post2cat, and link2cat were deprecated in 2.3.0, db version 5539&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @see wpdb::tables()&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $old_tables = array( 'categories', 'post2cat', 'link2cat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * List of WordPress global tables&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @see wpdb::tables()&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $global_tables = array( 'users', 'usermeta' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * List of Multisite global tables&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @see wpdb::tables()&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $ms_global_tables = array( 'blogs', 'signups', 'site', 'sitemeta', &nbsp;</div></li><li><div>        'sitecategories', 'registration_log', 'blog_versions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Comments table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $comments;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Comment Metadata table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $commentmeta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Links table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $links;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Options table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Post Metadata table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $postmeta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Posts table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Terms table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $terms;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Term Relationships table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $term_relationships;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Term Taxonomy table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $term_taxonomy;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Term Meta table.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.4.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $termmeta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>    // Global and Multisite tables&nbsp;</div></li><li><div>    //&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress User Metadata table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $usermeta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * WordPress Users table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $users;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Blogs table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $blogs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Blog Versions table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $blog_versions;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Registration Log table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $registration_log;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Signups table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $signups;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Sites table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $site;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Sitewide Terms table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $sitecategories;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Multisite Site Metadata table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $sitemeta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Format specifiers for DB columns. Columns not listed here default to %s. Initialized during WP load.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Keys are column names, values are format types: 'ID' =&gt; '%d'&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.8.0&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::insert()&nbsp;</div></li><li><div>     * @see wpdb::update()&nbsp;</div></li><li><div>     * @see wpdb::delete()&nbsp;</div></li><li><div>     * @see wp_set_wpdb_vars()&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $field_types = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database table columns charset&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $charset;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database table columns collate&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $collate;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database Username&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $dbuser;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database Password&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.1.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $dbpassword;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database Name&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.1.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $dbname;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database Host&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.1.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $dbhost;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Database Handle&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $dbh;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * A textual description of the last query/get_row/get_var call&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $func_call;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether MySQL is used as the database engine.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Set in WPDB::db_connect() to true, by default. This is used when checking&nbsp;</div></li><li><div>     * against the required MySQL version for WordPress. Normally, a replacement&nbsp;</div></li><li><div>     * database drop-in (db.php) will skip these checks, but setting this to true&nbsp;</div></li><li><div>     * will force the checks to occur.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.3.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $is_mysql = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * A list of incompatible SQL modes.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $incompatible_modes = array( 'NO_ZERO_DATE', 'ONLY_FULL_GROUP_BY', &nbsp;</div></li><li><div>        'STRICT_TRANS_TABLES', 'STRICT_ALL_TABLES', 'TRADITIONAL' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether to use mysqli over mysql.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $use_mysqli = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether we've managed to successfully connect at some point&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $has_connected = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Connects to the database server and selects a database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * PHP5 style constructor for compatibility with PHP5. Does&nbsp;</div></li><li><div>     * the actual setting up of the class properties and connection&nbsp;</div></li><li><div>     * to the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @link https://core.trac.wordpress.org/ticket/3354&nbsp;</div></li><li><div>     * @since 2.0.8&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @global string $wp_version&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $dbuser     MySQL database user&nbsp;</div></li><li><div>     * @param string $dbpassword MySQL database password&nbsp;</div></li><li><div>     * @param string $dbname     MySQL database name&nbsp;</div></li><li><div>     * @param string $dbhost     MySQL database host&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct( $dbuser, $dbpassword, $dbname, $dbhost ) {&nbsp;</div></li><li><div>        register_shutdown_function( array( $this, '__destruct' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( WP_DEBUG && WP_DEBUG_DISPLAY )&nbsp;</div></li><li><div>            $this-&gt;show_errors();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Use ext/mysqli if it exists and:&nbsp;</div></li><li><div>         *  - WP_USE_EXT_MYSQL is defined as false, or&nbsp;</div></li><li><div>         *  - We are a development version of WordPress, or&nbsp;</div></li><li><div>         *  - We are running PHP 5.5 or greater, or&nbsp;</div></li><li><div>         *  - ext/mysql is not loaded.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( function_exists( 'mysqli_connect' ) ) {&nbsp;</div></li><li><div>            if ( defined( 'WP_USE_EXT_MYSQL' ) ) {&nbsp;</div></li><li><div>                $this-&gt;use_mysqli = ! WP_USE_EXT_MYSQL;&nbsp;</div></li><li><div>            } elseif ( version_compare( phpversion(), '5.5', '&gt;=' ) || ! function_exists( 'mysql_connect' ) ) {&nbsp;</div></li><li><div>                $this-&gt;use_mysqli = true;&nbsp;</div></li><li><div>            } elseif ( false !== strpos( $GLOBALS['wp_version'], '-' ) ) {&nbsp;</div></li><li><div>                $this-&gt;use_mysqli = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;dbuser = $dbuser;&nbsp;</div></li><li><div>        $this-&gt;dbpassword = $dbpassword;&nbsp;</div></li><li><div>        $this-&gt;dbname = $dbname;&nbsp;</div></li><li><div>        $this-&gt;dbhost = $dbhost;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // wp-config.php creation will manually connect when ready.&nbsp;</div></li><li><div>        if ( defined( 'WP_SETUP_CONFIG' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;db_connect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * PHP5 style destructor and will run when database object is destroyed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see wpdb::__construct()&nbsp;</div></li><li><div>     * @since 2.0.8&nbsp;</div></li><li><div>     * @return true&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __destruct() {&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Makes private properties readable for backward compatibility.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name The private member to get, and optionally process&nbsp;</div></li><li><div>     * @return mixed The private member&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __get( $name ) {&nbsp;</div></li><li><div>        if ( 'col_info' === $name )&nbsp;</div></li><li><div>            $this-&gt;load_col_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;$name;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Makes private properties settable for backward compatibility.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name  The private member to set&nbsp;</div></li><li><div>     * @param mixed  $value The value to set&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __set( $name, $value ) {&nbsp;</div></li><li><div>        $protected_members = array(&nbsp;</div></li><li><div>            'col_meta', &nbsp;</div></li><li><div>            'table_charset', &nbsp;</div></li><li><div>            'check_current_query', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        if (  in_array( $name, $protected_members, true ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;$name = $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Makes private properties check-able for backward compatibility.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name  The private member to check&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool If the member is set or not&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __isset( $name ) {&nbsp;</div></li><li><div>        return isset( $this-&gt;$name );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Makes private properties un-settable for backward compatibility.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name  The private member to unset&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __unset( $name ) {&nbsp;</div></li><li><div>        unset( $this-&gt;$name );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set $this-&gt;charset and $this-&gt;collate&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.1.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function init_charset() {&nbsp;</div></li><li><div>        $charset = '';&nbsp;</div></li><li><div>        $collate = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( function_exists('is_multisite') && is_multisite() ) {&nbsp;</div></li><li><div>            $charset = 'utf8';&nbsp;</div></li><li><div>            if ( defined( 'DB_COLLATE' ) && DB_COLLATE ) {&nbsp;</div></li><li><div>                $collate = DB_COLLATE;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $collate = 'utf8_general_ci';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( defined( 'DB_COLLATE' ) ) {&nbsp;</div></li><li><div>            $collate = DB_COLLATE;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( defined( 'DB_CHARSET' ) ) {&nbsp;</div></li><li><div>            $charset = DB_CHARSET;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $charset_collate = $this-&gt;determine_charset( $charset, $collate );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;charset = $charset_collate['charset'];&nbsp;</div></li><li><div>        $this-&gt;collate = $charset_collate['collate'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines the best charset and collation to use given a charset and collation.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * For example, when able, utf8mb4 should be used instead of utf8.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.6.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $charset The character set to check.&nbsp;</div></li><li><div>     * @param string $collate The collation to check.&nbsp;</div></li><li><div>     * @return array The most appropriate character set and collation to use.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function determine_charset( $charset, $collate ) {&nbsp;</div></li><li><div>        if ( ( $this-&gt;use_mysqli && ! ( $this-&gt;dbh instanceof mysqli ) ) || empty( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>            return compact( 'charset', 'collate' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'utf8' === $charset && $this-&gt;has_cap( 'utf8mb4' ) ) {&nbsp;</div></li><li><div>            $charset = 'utf8mb4';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'utf8mb4' === $charset && ! $this-&gt;has_cap( 'utf8mb4' ) ) {&nbsp;</div></li><li><div>            $charset = 'utf8';&nbsp;</div></li><li><div>            $collate = str_replace( 'utf8mb4_', 'utf8_', $collate );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'utf8mb4' === $charset ) {&nbsp;</div></li><li><div>            // _general_ is outdated, so we can upgrade it to _unicode_, instead.&nbsp;</div></li><li><div>            if ( ! $collate || 'utf8_general_ci' === $collate ) {&nbsp;</div></li><li><div>                $collate = 'utf8mb4_unicode_ci';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $collate = str_replace( 'utf8_', 'utf8mb4_', $collate );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // _unicode_520_ is a better collation, we should use that when it's available.&nbsp;</div></li><li><div>        if ( $this-&gt;has_cap( 'utf8mb4_520' ) && 'utf8mb4_unicode_ci' === $collate ) {&nbsp;</div></li><li><div>            $collate = 'utf8mb4_unicode_520_ci';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return compact( 'charset', 'collate' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets the connection's character set.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.1.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param resource $dbh     The resource given by mysql_connect&nbsp;</div></li><li><div>     * @param string   $charset Optional. The character set. Default null.&nbsp;</div></li><li><div>     * @param string   $collate Optional. The collation. Default null.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_charset( $dbh, $charset = null, $collate = null ) {&nbsp;</div></li><li><div>        if ( ! isset( $charset ) )&nbsp;</div></li><li><div>            $charset = $this-&gt;charset;&nbsp;</div></li><li><div>        if ( ! isset( $collate ) )&nbsp;</div></li><li><div>            $collate = $this-&gt;collate;&nbsp;</div></li><li><div>        if ( $this-&gt;has_cap( 'collation' ) && ! empty( $charset ) ) {&nbsp;</div></li><li><div>            $set_charset_succeeded = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                if ( function_exists( 'mysqli_set_charset' ) && $this-&gt;has_cap( 'set_charset' ) ) {&nbsp;</div></li><li><div>                    $set_charset_succeeded = mysqli_set_charset( $dbh, $charset );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $set_charset_succeeded ) {&nbsp;</div></li><li><div>                    $query = $this-&gt;prepare( 'SET NAMES %s', $charset );&nbsp;</div></li><li><div>                    if ( ! empty( $collate ) )&nbsp;</div></li><li><div>                        $query .= $this-&gt;prepare( ' COLLATE %s', $collate );&nbsp;</div></li><li><div>                    mysqli_query( $dbh, $query );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( function_exists( 'mysql_set_charset' ) && $this-&gt;has_cap( 'set_charset' ) ) {&nbsp;</div></li><li><div>                    $set_charset_succeeded = mysql_set_charset( $charset, $dbh );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $set_charset_succeeded ) {&nbsp;</div></li><li><div>                    $query = $this-&gt;prepare( 'SET NAMES %s', $charset );&nbsp;</div></li><li><div>                    if ( ! empty( $collate ) )&nbsp;</div></li><li><div>                        $query .= $this-&gt;prepare( ' COLLATE %s', $collate );&nbsp;</div></li><li><div>                    mysql_query( $query, $dbh );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Change the current SQL mode, and ensure its WordPress compatibility.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If no modes are passed, it will ensure the current MySQL server&nbsp;</div></li><li><div>     * modes are compatible.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $modes Optional. A list of SQL modes to set.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_sql_mode( $modes = array() ) {&nbsp;</div></li><li><div>        if ( empty( $modes ) ) {&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                $res = mysqli_query( $this-&gt;dbh, 'SELECT @@SESSION.sql_mode' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $res = mysql_query( 'SELECT @@SESSION.sql_mode', $this-&gt;dbh );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $res ) ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                $modes_array = mysqli_fetch_array( $res );&nbsp;</div></li><li><div>                if ( empty( $modes_array[0] ) ) {&nbsp;</div></li><li><div>                    return;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $modes_str = $modes_array[0];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $modes_str = mysql_result( $res, 0 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $modes_str ) ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $modes = explode( ', ', $modes_str );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modes = array_change_key_case( $modes, CASE_UPPER );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the list of incompatible SQL modes to exclude.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $incompatible_modes An array of incompatible modes.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $incompatible_modes = (array) apply_filters( 'incompatible_sql_modes', $this-&gt;incompatible_modes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $modes as $i =&gt; $mode ) {&nbsp;</div></li><li><div>            if ( in_array( $mode, $incompatible_modes ) ) {&nbsp;</div></li><li><div>                unset( $modes[ $i ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modes_str = implode( ', ', $modes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            mysqli_query( $this-&gt;dbh, &quot;SET SESSION sql_mode='$modes_str'&quot; );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            mysql_query( &quot;SET SESSION sql_mode='$modes_str'&quot;, $this-&gt;dbh );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets the table prefix for the WordPress tables.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $prefix          Alphanumeric name for the new prefix.&nbsp;</div></li><li><div>     * @param bool   $set_table_names Optional. Whether the table names, e.g. wpdb::$posts, should be updated or not.&nbsp;</div></li><li><div>     * @return string|WP_Error Old prefix or WP_Error on error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_prefix( $prefix, $set_table_names = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( preg_match( '|[^a-z0-9_]|i', $prefix ) )&nbsp;</div></li><li><div>            return new WP_Error('invalid_db_prefix', 'Invalid database prefix' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $old_prefix = is_multisite() ? '' : $prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $this-&gt;base_prefix ) )&nbsp;</div></li><li><div>            $old_prefix = $this-&gt;base_prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;base_prefix = $prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $set_table_names ) {&nbsp;</div></li><li><div>            foreach ( $this-&gt;tables( 'global' ) as $table =&gt; $prefixed_table )&nbsp;</div></li><li><div>                $this-&gt;$table = $prefixed_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_multisite() && empty( $this-&gt;blogid ) )&nbsp;</div></li><li><div>                return $old_prefix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;prefix = $this-&gt;get_blog_prefix();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $this-&gt;tables( 'blog' ) as $table =&gt; $prefixed_table )&nbsp;</div></li><li><div>                $this-&gt;$table = $prefixed_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $this-&gt;tables( 'old' ) as $table =&gt; $prefixed_table )&nbsp;</div></li><li><div>                $this-&gt;$table = $prefixed_table;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $old_prefix;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets blog id.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $blog_id&nbsp;</div></li><li><div>     * @param int $site_id Optional.&nbsp;</div></li><li><div>     * @return int previous blog id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_blog_id( $blog_id, $site_id = 0 ) {&nbsp;</div></li><li><div>        if ( ! empty( $site_id ) )&nbsp;</div></li><li><div>            $this-&gt;siteid = $site_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $old_blog_id = $this-&gt;blogid;&nbsp;</div></li><li><div>        $this-&gt;blogid = $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;prefix = $this-&gt;get_blog_prefix();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;tables( 'blog' ) as $table =&gt; $prefixed_table )&nbsp;</div></li><li><div>            $this-&gt;$table = $prefixed_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;tables( 'old' ) as $table =&gt; $prefixed_table )&nbsp;</div></li><li><div>            $this-&gt;$table = $prefixed_table;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $old_blog_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Gets blog prefix.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param int $blog_id Optional.&nbsp;</div></li><li><div>     * @return string Blog prefix.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_blog_prefix( $blog_id = null ) {&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            if ( null === $blog_id )&nbsp;</div></li><li><div>                $blog_id = $this-&gt;blogid;&nbsp;</div></li><li><div>            $blog_id = (int) $blog_id;&nbsp;</div></li><li><div>            if ( defined( 'MULTISITE' ) && ( 0 == $blog_id || 1 == $blog_id ) )&nbsp;</div></li><li><div>                return $this-&gt;base_prefix;&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                return $this-&gt;base_prefix . $blog_id . '_';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $this-&gt;base_prefix;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of WordPress tables.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Also allows for the CUSTOM_USER_TABLE and CUSTOM_USER_META_TABLE to&nbsp;</div></li><li><div>     * override the WordPress users and usermeta tables that would otherwise&nbsp;</div></li><li><div>     * be determined by the prefix.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * The scope argument can take one of the following:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * 'all' - returns 'all' and 'global' tables. No old tables are returned.&nbsp;</div></li><li><div>     * 'blog' - returns the blog-level tables for the queried blog.&nbsp;</div></li><li><div>     * 'global' - returns the global tables for the installation, returning multisite tables only if running multisite.&nbsp;</div></li><li><div>     * 'ms_global' - returns the multisite global tables, regardless if current installation is multisite.&nbsp;</div></li><li><div>     * 'old' - returns tables which are deprecated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @uses wpdb::$tables&nbsp;</div></li><li><div>     * @uses wpdb::$old_tables&nbsp;</div></li><li><div>     * @uses wpdb::$global_tables&nbsp;</div></li><li><div>     * @uses wpdb::$ms_global_tables&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $scope   Optional. Can be all, global, ms_global, blog, or old tables. Defaults to all.&nbsp;</div></li><li><div>     * @param bool   $prefix  Optional. Whether to include table prefixes. Default true. If blog&nbsp;</div></li><li><div>     *                        prefix is requested, then the custom users and usermeta tables will be mapped.&nbsp;</div></li><li><div>     * @param int    $blog_id Optional. The blog_id to prefix. Defaults to wpdb::$blogid. Used only when prefix is requested.&nbsp;</div></li><li><div>     * @return array Table names. When a prefix is requested, the key is the unprefixed table name.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function tables( $scope = 'all', $prefix = true, $blog_id = 0 ) {&nbsp;</div></li><li><div>        switch ( $scope ) {&nbsp;</div></li><li><div>            case 'all' :&nbsp;</div></li><li><div>                $tables = array_merge( $this-&gt;global_tables, $this-&gt;tables );&nbsp;</div></li><li><div>                if ( is_multisite() )&nbsp;</div></li><li><div>                    $tables = array_merge( $tables, $this-&gt;ms_global_tables );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'blog' :&nbsp;</div></li><li><div>                $tables = $this-&gt;tables;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'global' :&nbsp;</div></li><li><div>                $tables = $this-&gt;global_tables;&nbsp;</div></li><li><div>                if ( is_multisite() )&nbsp;</div></li><li><div>                    $tables = array_merge( $tables, $this-&gt;ms_global_tables );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'ms_global' :&nbsp;</div></li><li><div>                $tables = $this-&gt;ms_global_tables;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'old' :&nbsp;</div></li><li><div>                $tables = $this-&gt;old_tables;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $prefix ) {&nbsp;</div></li><li><div>            if ( ! $blog_id )&nbsp;</div></li><li><div>                $blog_id = $this-&gt;blogid;&nbsp;</div></li><li><div>            $blog_prefix = $this-&gt;get_blog_prefix( $blog_id );&nbsp;</div></li><li><div>            $base_prefix = $this-&gt;base_prefix;&nbsp;</div></li><li><div>            $global_tables = array_merge( $this-&gt;global_tables, $this-&gt;ms_global_tables );&nbsp;</div></li><li><div>            foreach ( $tables as $k =&gt; $table ) {&nbsp;</div></li><li><div>                if ( in_array( $table, $global_tables ) )&nbsp;</div></li><li><div>                    $tables[ $table ] = $base_prefix . $table;&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $tables[ $table ] = $blog_prefix . $table;&nbsp;</div></li><li><div>                unset( $tables[ $k ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $tables['users'] ) && defined( 'CUSTOM_USER_TABLE' ) )&nbsp;</div></li><li><div>                $tables['users'] = CUSTOM_USER_TABLE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $tables['usermeta'] ) && defined( 'CUSTOM_USER_META_TABLE' ) )&nbsp;</div></li><li><div>                $tables['usermeta'] = CUSTOM_USER_META_TABLE;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $tables;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Selects a database using the current database connection.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * The database name will be changed based on the current database&nbsp;</div></li><li><div>     * connection. On failure, the execution will bail and display an DB error.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string        $db  MySQL database name&nbsp;</div></li><li><div>     * @param resource|null $dbh Optional link identifier.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function select( $db, $dbh = null ) {&nbsp;</div></li><li><div>        if ( is_null($dbh) )&nbsp;</div></li><li><div>            $dbh = $this-&gt;dbh;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            $success = mysqli_select_db( $dbh, $db );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $success = mysql_select_db( $db, $dbh );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! $success ) {&nbsp;</div></li><li><div>            $this-&gt;ready = false;&nbsp;</div></li><li><div>            if ( ! did_action( 'template_redirect' ) ) {&nbsp;</div></li><li><div>                wp_load_translations_early();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message = '&lt;h1&gt;' . __( 'Can&#8217;t select database' ) . &quot;&lt;/h1&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message .= '&lt;p&gt;' . sprintf(&nbsp;</div></li><li><div>                    /** translators: %s: database name */&nbsp;</div></li><li><div>                    __( 'We were able to connect to the database server (which means your username and password is okay) but not able to select the %s database.' ), &nbsp;</div></li><li><div>                    '&lt;code&gt;' . htmlspecialchars( $db, ENT_QUOTES ) . '&lt;/code&gt;'&nbsp;</div></li><li><div> ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message .= &quot;&lt;ul&gt;\n&quot;;&nbsp;</div></li><li><div>                $message .= '&lt;li&gt;' . __( 'Are you sure it exists?' ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message .= '&lt;li&gt;' . sprintf(&nbsp;</div></li><li><div>                    /** translators: 1: database user, 2: database name */&nbsp;</div></li><li><div>                    __( 'Does the user %1$s have permission to use the %2$s database?' ), &nbsp;</div></li><li><div>                    '&lt;code&gt;' . htmlspecialchars( $this-&gt;dbuser, ENT_QUOTES )  . '&lt;/code&gt;', &nbsp;</div></li><li><div>                    '&lt;code&gt;' . htmlspecialchars( $db, ENT_QUOTES ) . '&lt;/code&gt;'&nbsp;</div></li><li><div> ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message .= '&lt;li&gt;' . sprintf(&nbsp;</div></li><li><div>                    /** translators: %s: database name */&nbsp;</div></li><li><div>                    __( 'On some systems the name of your database is prefixed with your username, so it would be like &lt;code&gt;username_%1$s&lt;/code&gt;. Could that be the problem?' ), &nbsp;</div></li><li><div>                    htmlspecialchars( $db, ENT_QUOTES )&nbsp;</div></li><li><div> ). &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message .= &quot;&lt;/ul&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $message .= '&lt;p&gt;' . sprintf(&nbsp;</div></li><li><div>                    /** translators: %s: support forums URL */&nbsp;</div></li><li><div>                    __( 'If you don&#8217;t know how to set up a database you should &lt;strong&gt;contact your host&lt;/strong&gt;. If all else fails you may find help at the &lt;a href=&quot;%s&quot;&gt;WordPress Support Forums&lt;/a&gt;.' ), &nbsp;</div></li><li><div>                    __( 'https://wordpress.org/support/' )&nbsp;</div></li><li><div> ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;bail( $message, 'db_select_fail' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Do not use, deprecated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Use esc_sql() or wpdb::prepare() instead.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.8.0&nbsp;</div></li><li><div>     * @deprecated 3.6.0 Use wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::prepare&nbsp;</div></li><li><div>     * @see esc_sql()&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $string&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function _weak_escape( $string ) {&nbsp;</div></li><li><div>        if ( func_num_args() === 1 && function_exists( '_deprecated_function' ) )&nbsp;</div></li><li><div>            _deprecated_function( __METHOD__, '3.6.0', 'wpdb::prepare() or esc_sql()' );&nbsp;</div></li><li><div>        return addslashes( $string );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Real escape, using mysqli_real_escape_string() or mysql_real_escape_string()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see mysqli_real_escape_string()&nbsp;</div></li><li><div>     * @see mysql_real_escape_string()&nbsp;</div></li><li><div>     * @since 2.8.0&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $string to escape&nbsp;</div></li><li><div>     * @return string escaped&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function _real_escape( $string ) {&nbsp;</div></li><li><div>        if ( $this-&gt;dbh ) {&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                return mysqli_real_escape_string( $this-&gt;dbh, $string );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return mysql_real_escape_string( $string, $this-&gt;dbh );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $class = get_class( $this );&nbsp;</div></li><li><div>        if ( function_exists( '__' ) ) {&nbsp;</div></li><li><div>            /** translators: %s: database access abstraction class, usually wpdb or a class extending wpdb */&nbsp;</div></li><li><div>            _doing_it_wrong( $class, sprintf( __( '%s must set a database connection for use with escaping.' ), $class ), '3.6.0' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            _doing_it_wrong( $class, sprintf( '%s must set a database connection for use with escaping.', $class ), '3.6.0' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return addslashes( $string );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Escape data. Works on arrays.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses wpdb::_real_escape()&nbsp;</div></li><li><div>     * @since  2.8.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string|array $data&nbsp;</div></li><li><div>     * @return string|array escaped&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function _escape( $data ) {&nbsp;</div></li><li><div>        if ( is_array( $data ) ) {&nbsp;</div></li><li><div>            foreach ( $data as $k =&gt; $v ) {&nbsp;</div></li><li><div>                if ( is_array( $v ) ) {&nbsp;</div></li><li><div>                    $data[$k] = $this-&gt;_escape( $v );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $data[$k] = $this-&gt;_real_escape( $v );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $data = $this-&gt;_real_escape( $data );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Do not use, deprecated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Use esc_sql() or wpdb::prepare() instead.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @deprecated 3.6.0 Use wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see esc_sql()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed $data&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function escape( $data ) {&nbsp;</div></li><li><div>        if ( func_num_args() === 1 && function_exists( '_deprecated_function' ) )&nbsp;</div></li><li><div>            _deprecated_function( __METHOD__, '3.6.0', 'wpdb::prepare() or esc_sql()' );&nbsp;</div></li><li><div>        if ( is_array( $data ) ) {&nbsp;</div></li><li><div>            foreach ( $data as $k =&gt; $v ) {&nbsp;</div></li><li><div>                if ( is_array( $v ) )&nbsp;</div></li><li><div>                    $data[$k] = $this-&gt;escape( $v, 'recursive' );&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $data[$k] = $this-&gt;_weak_escape( $v, 'internal' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $data = $this-&gt;_weak_escape( $data, 'internal' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Escapes content by reference for insertion into the database, for security&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses wpdb::_real_escape()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $string to escape&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function escape_by_ref( &$string ) {&nbsp;</div></li><li><div>        if ( ! is_float( $string ) )&nbsp;</div></li><li><div>            $string = $this-&gt;_real_escape( $string );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prepares a SQL query for safe execution. Uses sprintf()-like syntax.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * The following directives can be used in the query format string:&nbsp;</div></li><li><div>     *   %d (integer)&nbsp;</div></li><li><div>     *   %f (float)&nbsp;</div></li><li><div>     *   %s (string)&nbsp;</div></li><li><div>     *   %% (literal percentage sign - no argument needed)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * All of %d, %f, and %s are to be left unquoted in the query string and they need an argument passed for them.&nbsp;</div></li><li><div>     * Literals (%) as parts of the query must be properly written as %%.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This function only supports a small subset of the sprintf syntax; it only supports %d (integer), %f (float), and %s (string).&nbsp;</div></li><li><div>     * Does not support sign, padding, alignment, width or precision specifiers.&nbsp;</div></li><li><div>     * Does not support argument numbering/swapping.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * May be called like {@link https://secure.php.net/sprintf sprintf()} or like {@link https://secure.php.net/vsprintf vsprintf()}.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Both %d and %s should be left unquoted in the query string.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     $wpdb-&gt;prepare( &quot;SELECT * FROM `table` WHERE `column` = %s AND `field` = %d&quot;, 'foo', 1337 );&nbsp;</div></li><li><div>     *     $wpdb-&gt;prepare( &quot;SELECT DATE_FORMAT(`field`, '%%c') FROM `table` WHERE `column` = %s&quot;, 'foo' );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @link https://secure.php.net/sprintf Description of syntax.&nbsp;</div></li><li><div>     * @since 2.3.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string      $query    Query statement with sprintf()-like placeholders&nbsp;</div></li><li><div>     * @param array|mixed $args     The array of variables to substitute into the query's placeholders if being called like&nbsp;</div></li><li><div>     *                              {@link https://secure.php.net/vsprintf vsprintf()}, or the first variable to substitute into the query's placeholders if&nbsp;</div></li><li><div>     *                              being called like {@link https://secure.php.net/sprintf sprintf()}.&nbsp;</div></li><li><div>     * @param mixed       $args, ... further variables to substitute into the query's placeholders if being called like&nbsp;</div></li><li><div>     *                              {@link https://secure.php.net/sprintf sprintf()}.&nbsp;</div></li><li><div>     * @return string|void Sanitized query string, if there is a query to prepare.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function prepare( $query, $args ) {&nbsp;</div></li><li><div>        if ( is_null( $query ) )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // This is not meant to be foolproof -- but it will catch obviously incorrect usage.&nbsp;</div></li><li><div>        if ( strpos( $query, '%' ) === false ) {&nbsp;</div></li><li><div>            _doing_it_wrong( 'wpdb::prepare', sprintf( __( 'The query argument of %s must have a placeholder.' ), 'wpdb::prepare()' ), '3.9.0' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = func_get_args();&nbsp;</div></li><li><div>        array_shift( $args );&nbsp;</div></li><li><div>        // If args were passed as an array (as in vsprintf), move them up&nbsp;</div></li><li><div>        if ( isset( $args[0] ) && is_array($args[0]) )&nbsp;</div></li><li><div>            $args = $args[0];&nbsp;</div></li><li><div>        $query = str_replace( &quot;'%s'&quot;, '%s', $query ); // in case someone mistakenly already singlequoted it&nbsp;</div></li><li><div>        $query = str_replace( '&quot;%s&quot;', '%s', $query ); // doublequote unquoting&nbsp;</div></li><li><div>        $query = preg_replace( '|(?&lt;!%)%f|' , '%F', $query ); // Force floats to be locale unaware&nbsp;</div></li><li><div>        $query = preg_replace( '|(?&lt;!%)%s|', &quot;'%s'&quot;, $query ); // quote the strings, avoiding escaped strings like %%s&nbsp;</div></li><li><div>        array_walk( $args, array( $this, 'escape_by_ref' ) );&nbsp;</div></li><li><div>        return @vsprintf( $query, $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * First half of escaping for LIKE special characters % and _ before preparing for MySQL.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Use this only before wpdb::prepare() or esc_sql().  Reversing the order is very bad for security.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Example Prepared Statement:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     $wild = '%';&nbsp;</div></li><li><div>     *     $find = 'only 43% of planets';&nbsp;</div></li><li><div>     *     $like = $wild . $wpdb-&gt;esc_like( $find ) . $wild;&nbsp;</div></li><li><div>     *     $sql = $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;posts WHERE post_content LIKE '%s'&quot;, $like );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Example Escape Chain:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     $sql = esc_sql( $wpdb-&gt;esc_like( $input ) );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.0.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $text The raw text to be escaped. The input typed by the user should have no&nbsp;</div></li><li><div>     *                     extra or deleted slashes.&nbsp;</div></li><li><div>     * @return string Text in the form of a LIKE phrase. The output is not SQL safe. Call $wpdb::prepare()&nbsp;</div></li><li><div>     *                or real_escape next.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function esc_like( $text ) {&nbsp;</div></li><li><div>        return addcslashes( $text, '_%\\' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Print SQL/DB error.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @global array $EZSQL_ERROR Stores error information of query and error string&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $str The error to display&nbsp;</div></li><li><div>     * @return false|void False if the showing of errors is disabled.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function print_error( $str = '' ) {&nbsp;</div></li><li><div>        global $EZSQL_ERROR;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$str ) {&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                $str = mysqli_error( $this-&gt;dbh );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $str = mysql_error( $this-&gt;dbh );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $EZSQL_ERROR[] = array( 'query' =&gt; $this-&gt;last_query, 'error_str' =&gt; $str );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;suppress_errors )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_load_translations_early();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $caller = $this-&gt;get_caller() ) {&nbsp;</div></li><li><div>            /** translators: 1: Database error message, 2: SQL query, 3: Name of the calling function */&nbsp;</div></li><li><div>            $error_str = sprintf( __( 'WordPress database error %1$s for query %2$s made by %3$s' ), $str, $this-&gt;last_query, $caller );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            /** translators: 1: Database error message, 2: SQL query */&nbsp;</div></li><li><div>            $error_str = sprintf( __( 'WordPress database error %1$s for query %2$s' ), $str, $this-&gt;last_query );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        error_log( $error_str );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Are we showing errors?&nbsp;</div></li><li><div>        if ( ! $this-&gt;show_errors )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If there is an error then take note of it&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            $msg = sprintf(&nbsp;</div></li><li><div>                &quot;%s [%s]\n%s\n&quot;, &nbsp;</div></li><li><div>                __( 'WordPress database error:' ), &nbsp;</div></li><li><div>                $str, &nbsp;</div></li><li><div>                $this-&gt;last_query&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( defined( 'ERRORLOGFILE' ) ) {&nbsp;</div></li><li><div>                error_log( $msg, 3, ERRORLOGFILE );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( defined( 'DIEONDBERROR' ) ) {&nbsp;</div></li><li><div>                wp_die( $msg );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $str = htmlspecialchars( $str, ENT_QUOTES );&nbsp;</div></li><li><div>            $query = htmlspecialchars( $this-&gt;last_query, ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            printf(&nbsp;</div></li><li><div>                '&lt;div id=&quot;error&quot;&gt;&lt;p class=&quot;wpdberror&quot;&gt;&lt;strong&gt;%s&lt;/strong&gt; [%s]&lt;br /&gt;&lt;code&gt;%s&lt;/code&gt;&lt;/p&gt;&lt;/div&gt;', &nbsp;</div></li><li><div>                __( 'WordPress database error:' ), &nbsp;</div></li><li><div>                $str, &nbsp;</div></li><li><div>                $query&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Enables showing of database errors.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This function should be used only to enable showing of errors.&nbsp;</div></li><li><div>     * wpdb::hide_errors() should be used instead for hiding of errors. However, &nbsp;</div></li><li><div>     * this function can be used to enable and disable showing of database&nbsp;</div></li><li><div>     * errors.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @see wpdb::hide_errors()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $show Whether to show or hide errors&nbsp;</div></li><li><div>     * @return bool Old value for showing errors.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function show_errors( $show = true ) {&nbsp;</div></li><li><div>        $errors = $this-&gt;show_errors;&nbsp;</div></li><li><div>        $this-&gt;show_errors = $show;&nbsp;</div></li><li><div>        return $errors;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Disables showing of database errors.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * By default database errors are not shown.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     * @see wpdb::show_errors()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool Whether showing of errors was active&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function hide_errors() {&nbsp;</div></li><li><div>        $show = $this-&gt;show_errors;&nbsp;</div></li><li><div>        $this-&gt;show_errors = false;&nbsp;</div></li><li><div>        return $show;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether to suppress database errors.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * By default database errors are suppressed, with a simple&nbsp;</div></li><li><div>     * call to this function they can be enabled.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @see wpdb::hide_errors()&nbsp;</div></li><li><div>     * @param bool $suppress Optional. New value. Defaults to true.&nbsp;</div></li><li><div>     * @return bool Old value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function suppress_errors( $suppress = true ) {&nbsp;</div></li><li><div>        $errors = $this-&gt;suppress_errors;&nbsp;</div></li><li><div>        $this-&gt;suppress_errors = (bool) $suppress;&nbsp;</div></li><li><div>        return $errors;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Kill cached query results.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function flush() {&nbsp;</div></li><li><div>        $this-&gt;last_result = array();&nbsp;</div></li><li><div>        $this-&gt;col_info = null;&nbsp;</div></li><li><div>        $this-&gt;last_query = null;&nbsp;</div></li><li><div>        $this-&gt;rows_affected = $this-&gt;num_rows = 0;&nbsp;</div></li><li><div>        $this-&gt;last_error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli && $this-&gt;result instanceof mysqli_result ) {&nbsp;</div></li><li><div>            mysqli_free_result( $this-&gt;result );&nbsp;</div></li><li><div>            $this-&gt;result = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sanity check before using the handle&nbsp;</div></li><li><div>            if ( empty( $this-&gt;dbh ) || !( $this-&gt;dbh instanceof mysqli ) ) {&nbsp;</div></li><li><div>                return;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear out any results from a multi-query&nbsp;</div></li><li><div>            while ( mysqli_more_results( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>                mysqli_next_result( $this-&gt;dbh );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( is_resource( $this-&gt;result ) ) {&nbsp;</div></li><li><div>            mysql_free_result( $this-&gt;result );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Connect to and select database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If $allow_bail is false, the lack of database connection will need&nbsp;</div></li><li><div>     * to be handled manually.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @since 3.9.0 $allow_bail parameter added.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $allow_bail Optional. Allows the function to bail. Default true.&nbsp;</div></li><li><div>     * @return bool True with a successful connection, false on failure.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function db_connect( $allow_bail = true ) {&nbsp;</div></li><li><div>        $this-&gt;is_mysql = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Deprecated in 3.9+ when using MySQLi. No equivalent&nbsp;</div></li><li><div>         * $new_link parameter exists for mysqli_* functions.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $new_link = defined( 'MYSQL_NEW_LINK' ) ? MYSQL_NEW_LINK : true;&nbsp;</div></li><li><div>        $client_flags = defined( 'MYSQL_CLIENT_FLAGS' ) ? MYSQL_CLIENT_FLAGS : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            $this-&gt;dbh = mysqli_init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // mysqli_real_connect doesn't support the host param including a port or socket&nbsp;</div></li><li><div>            // like mysql_connect does. This duplicates how mysql_connect detects a port and/or socket file.&nbsp;</div></li><li><div>            $port = null;&nbsp;</div></li><li><div>            $socket = null;&nbsp;</div></li><li><div>            $host = $this-&gt;dbhost;&nbsp;</div></li><li><div>            $port_or_socket = strstr( $host, ':' );&nbsp;</div></li><li><div>            if ( ! empty( $port_or_socket ) ) {&nbsp;</div></li><li><div>                $host = substr( $host, 0, strpos( $host, ':' ) );&nbsp;</div></li><li><div>                $port_or_socket = substr( $port_or_socket, 1 );&nbsp;</div></li><li><div>                if ( 0 !== strpos( $port_or_socket, '/' ) ) {&nbsp;</div></li><li><div>                    $port = intval( $port_or_socket );&nbsp;</div></li><li><div>                    $maybe_socket = strstr( $port_or_socket, ':' );&nbsp;</div></li><li><div>                    if ( ! empty( $maybe_socket ) ) {&nbsp;</div></li><li><div>                        $socket = substr( $maybe_socket, 1 );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $socket = $port_or_socket;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( WP_DEBUG ) {&nbsp;</div></li><li><div>                mysqli_real_connect( $this-&gt;dbh, $host, $this-&gt;dbuser, $this-&gt;dbpassword, null, $port, $socket, $client_flags );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                @mysqli_real_connect( $this-&gt;dbh, $host, $this-&gt;dbuser, $this-&gt;dbpassword, null, $port, $socket, $client_flags );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;dbh-&gt;connect_errno ) {&nbsp;</div></li><li><div>                $this-&gt;dbh = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /** It's possible ext/mysqli is misconfigured. Fall back to ext/mysql if:&nbsp;</div></li><li><div>                  *  - We haven't previously connected, and&nbsp;</div></li><li><div>                  *  - WP_USE_EXT_MYSQL isn't set to false, and&nbsp;</div></li><li><div>                  *  - ext/mysql is loaded.&nbsp;</div></li><li><div>                  */&nbsp;</div></li><li><div>                $attempt_fallback = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $this-&gt;has_connected ) {&nbsp;</div></li><li><div>                    $attempt_fallback = false;&nbsp;</div></li><li><div>                } elseif ( defined( 'WP_USE_EXT_MYSQL' ) && ! WP_USE_EXT_MYSQL ) {&nbsp;</div></li><li><div>                    $attempt_fallback = false;&nbsp;</div></li><li><div>                } elseif ( ! function_exists( 'mysql_connect' ) ) {&nbsp;</div></li><li><div>                    $attempt_fallback = false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $attempt_fallback ) {&nbsp;</div></li><li><div>                    $this-&gt;use_mysqli = false;&nbsp;</div></li><li><div>                    return $this-&gt;db_connect( $allow_bail );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( WP_DEBUG ) {&nbsp;</div></li><li><div>                $this-&gt;dbh = mysql_connect( $this-&gt;dbhost, $this-&gt;dbuser, $this-&gt;dbpassword, $new_link, $client_flags );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;dbh = @mysql_connect( $this-&gt;dbhost, $this-&gt;dbuser, $this-&gt;dbpassword, $new_link, $client_flags );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;dbh && $allow_bail ) {&nbsp;</div></li><li><div>            wp_load_translations_early();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Load custom DB error template, if present.&nbsp;</div></li><li><div>            if ( file_exists( WP_CONTENT_DIR . '/db-error.php' ) ) {&nbsp;</div></li><li><div>                require_once( WP_CONTENT_DIR . '/db-error.php' );&nbsp;</div></li><li><div>                die();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $message = '&lt;h1&gt;' . __( 'Error establishing a database connection' ) . &quot;&lt;/h1&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $message .= '&lt;p&gt;' . sprintf(&nbsp;</div></li><li><div>                /** translators: 1: wp-config.php. 2: database host */&nbsp;</div></li><li><div>                __( 'This either means that the username and password information in your %1$s file is incorrect or we can&#8217;t contact the database server at %2$s. This could mean your host&#8217;s database server is down.' ), &nbsp;</div></li><li><div>                '&lt;code&gt;wp-config.php&lt;/code&gt;', &nbsp;</div></li><li><div>                '&lt;code&gt;' . htmlspecialchars( $this-&gt;dbhost, ENT_QUOTES ) . '&lt;/code&gt;'&nbsp;</div></li><li><div> ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $message .= &quot;&lt;ul&gt;\n&quot;;&nbsp;</div></li><li><div>            $message .= '&lt;li&gt;' . __( 'Are you sure you have the correct username and password?' ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>            $message .= '&lt;li&gt;' . __( 'Are you sure that you have typed the correct hostname?' ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>            $message .= '&lt;li&gt;' . __( 'Are you sure that the database server is running?' ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>            $message .= &quot;&lt;/ul&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $message .= '&lt;p&gt;' . sprintf(&nbsp;</div></li><li><div>                /** translators: %s: support forums URL */&nbsp;</div></li><li><div>                __( 'If you&#8217;re unsure what these terms mean you should probably contact your host. If you still need help you can always visit the &lt;a href=&quot;%s&quot;&gt;WordPress Support Forums&lt;/a&gt;.' ), &nbsp;</div></li><li><div>                __( 'https://wordpress.org/support/' )&nbsp;</div></li><li><div> ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;bail( $message, 'db_connect_fail' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } elseif ( $this-&gt;dbh ) {&nbsp;</div></li><li><div>            if ( ! $this-&gt;has_connected ) {&nbsp;</div></li><li><div>                $this-&gt;init_charset();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;has_connected = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;set_charset( $this-&gt;dbh );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;ready = true;&nbsp;</div></li><li><div>            $this-&gt;set_sql_mode();&nbsp;</div></li><li><div>            $this-&gt;select( $this-&gt;dbname, $this-&gt;dbh );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks that the connection to the database is still up. If not, try to reconnect.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If this function is unable to reconnect, it will forcibly die, or if after the&nbsp;</div></li><li><div>     * the {@see 'template_redirect'} hook has been fired, return false instead.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * If $allow_bail is false, the lack of database connection will need&nbsp;</div></li><li><div>     * to be handled manually.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param bool $allow_bail Optional. Allows the function to bail. Default true.&nbsp;</div></li><li><div>     * @return bool|void True if the connection is up.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_connection( $allow_bail = true ) {&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            if ( ! empty( $this-&gt;dbh ) && mysqli_ping( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( ! empty( $this-&gt;dbh ) && mysql_ping( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error_reporting = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Disable warnings, as we don't want to see a multitude of &quot;unable to connect&quot; messages&nbsp;</div></li><li><div>        if ( WP_DEBUG ) {&nbsp;</div></li><li><div>            $error_reporting = error_reporting();&nbsp;</div></li><li><div>            error_reporting( $error_reporting & ~E_WARNING );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        for ( $tries = 1; $tries &lt;= $this-&gt;reconnect_retries; $tries++ ) {&nbsp;</div></li><li><div>            // On the last try, re-enable warnings. We want to see a single instance of the&nbsp;</div></li><li><div>            // &quot;unable to connect&quot; message on the bail() screen, if it appears.&nbsp;</div></li><li><div>            if ( $this-&gt;reconnect_retries === $tries && WP_DEBUG ) {&nbsp;</div></li><li><div>                error_reporting( $error_reporting );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;db_connect( false ) ) {&nbsp;</div></li><li><div>                if ( $error_reporting ) {&nbsp;</div></li><li><div>                    error_reporting( $error_reporting );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            sleep( 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If template_redirect has already happened, it's too late for wp_die()/dead_db().&nbsp;</div></li><li><div>        // Let's just return and hope for the best.&nbsp;</div></li><li><div>        if ( did_action( 'template_redirect' ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $allow_bail ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_load_translations_early();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message = '&lt;h1&gt;' . __( 'Error reconnecting to the database' ) . &quot;&lt;/h1&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message .= '&lt;p&gt;' . sprintf(&nbsp;</div></li><li><div>            /** translators: %s: database host */&nbsp;</div></li><li><div>            __( 'This means that we lost contact with the database server at %s. This could mean your host&#8217;s database server is down.' ), &nbsp;</div></li><li><div>            '&lt;code&gt;' . htmlspecialchars( $this-&gt;dbhost, ENT_QUOTES ) . '&lt;/code&gt;'&nbsp;</div></li><li><div> ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message .= &quot;&lt;ul&gt;\n&quot;;&nbsp;</div></li><li><div>        $message .= '&lt;li&gt;' . __( 'Are you sure that the database server is running?' ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>        $message .= '&lt;li&gt;' . __( 'Are you sure that the database server is not under particularly heavy load?' ) . &quot;&lt;/li&gt;\n&quot;;&nbsp;</div></li><li><div>        $message .= &quot;&lt;/ul&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $message .= '&lt;p&gt;' . sprintf(&nbsp;</div></li><li><div>            /** translators: %s: support forums URL */&nbsp;</div></li><li><div>            __( 'If you&#8217;re unsure what these terms mean you should probably contact your host. If you still need help you can always visit the &lt;a href=&quot;%s&quot;&gt;WordPress Support Forums&lt;/a&gt;.' ), &nbsp;</div></li><li><div>            __( 'https://wordpress.org/support/' )&nbsp;</div></li><li><div> ) . &quot;&lt;/p&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // We weren't able to reconnect, so we better bail.&nbsp;</div></li><li><div>        $this-&gt;bail( $message, 'db_connect_fail' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Call dead_db() if bail didn't die, because this database is no more. It has ceased to be (at least temporarily).&nbsp;</div></li><li><div>        dead_db();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Perform a MySQL database query, using current database connection.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * More information can be found on the codex page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $query Database query&nbsp;</div></li><li><div>     * @return int|false Number of rows affected/selected or false on error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function query( $query ) {&nbsp;</div></li><li><div>        if ( ! $this-&gt;ready ) {&nbsp;</div></li><li><div>            $this-&gt;check_current_query = true;&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the database query.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Some queries are made before the plugins have been loaded, &nbsp;</div></li><li><div>         * and thus cannot be filtered with this method.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.1.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $query Database query.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $query = apply_filters( 'query', $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;flush();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log how the function was called&nbsp;</div></li><li><div>        $this-&gt;func_call = &quot;\$db-&gt;query(\&quot;$query\&quot;)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If we're writing to the database, make sure the query will write safely.&nbsp;</div></li><li><div>        if ( $this-&gt;check_current_query && ! $this-&gt;check_ascii( $query ) ) {&nbsp;</div></li><li><div>            $stripped_query = $this-&gt;strip_invalid_text_from_query( $query );&nbsp;</div></li><li><div>            // strip_invalid_text_from_query() can perform queries, so we need&nbsp;</div></li><li><div>            // to flush again, just to make sure everything is clear.&nbsp;</div></li><li><div>            $this-&gt;flush();&nbsp;</div></li><li><div>            if ( $stripped_query !== $query ) {&nbsp;</div></li><li><div>                $this-&gt;insert_id = 0;&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;check_current_query = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Keep track of the last query for debug.&nbsp;</div></li><li><div>        $this-&gt;last_query = $query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_do_query( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // MySQL server has gone away, try to reconnect.&nbsp;</div></li><li><div>        $mysql_errno = 0;&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                if ( $this-&gt;dbh instanceof mysqli ) {&nbsp;</div></li><li><div>                    $mysql_errno = mysqli_errno( $this-&gt;dbh );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // $dbh is defined, but isn't a real connection.&nbsp;</div></li><li><div>                    // Something has gone horribly wrong, let's try a reconnect.&nbsp;</div></li><li><div>                    $mysql_errno = 2006;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( is_resource( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>                    $mysql_errno = mysql_errno( $this-&gt;dbh );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $mysql_errno = 2006;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;dbh ) || 2006 == $mysql_errno ) {&nbsp;</div></li><li><div>            if ( $this-&gt;check_connection() ) {&nbsp;</div></li><li><div>                $this-&gt;_do_query( $query );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;insert_id = 0;&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If there is an error then take note of it.&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            if ( $this-&gt;dbh instanceof mysqli ) {&nbsp;</div></li><li><div>                $this-&gt;last_error = mysqli_error( $this-&gt;dbh );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;last_error = __( 'Unable to retrieve the error message from MySQL' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( is_resource( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>                $this-&gt;last_error = mysql_error( $this-&gt;dbh );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;last_error = __( 'Unable to retrieve the error message from MySQL' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;last_error ) {&nbsp;</div></li><li><div>            // Clear insert_id on a subsequent failed insert.&nbsp;</div></li><li><div>            if ( $this-&gt;insert_id && preg_match( '/^\s*(insert|replace)\s/i', $query ) )&nbsp;</div></li><li><div>                $this-&gt;insert_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;print_error();&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( preg_match( '/^\s*(create|alter|truncate|drop)\s/i', $query ) ) {&nbsp;</div></li><li><div>            $return_val = $this-&gt;result;&nbsp;</div></li><li><div>        } elseif ( preg_match( '/^\s*(insert|delete|update|replace)\s/i', $query ) ) {&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                $this-&gt;rows_affected = mysqli_affected_rows( $this-&gt;dbh );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;rows_affected = mysql_affected_rows( $this-&gt;dbh );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // Take note of the insert_id&nbsp;</div></li><li><div>            if ( preg_match( '/^\s*(insert|replace)\s/i', $query ) ) {&nbsp;</div></li><li><div>                if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                    $this-&gt;insert_id = mysqli_insert_id( $this-&gt;dbh );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;insert_id = mysql_insert_id( $this-&gt;dbh );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // Return number of rows affected&nbsp;</div></li><li><div>            $return_val = $this-&gt;rows_affected;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $num_rows = 0;&nbsp;</div></li><li><div>            if ( $this-&gt;use_mysqli && $this-&gt;result instanceof mysqli_result ) {&nbsp;</div></li><li><div>                while ( $row = mysqli_fetch_object( $this-&gt;result ) ) {&nbsp;</div></li><li><div>                    $this-&gt;last_result[$num_rows] = $row;&nbsp;</div></li><li><div>                    $num_rows++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( is_resource( $this-&gt;result ) ) {&nbsp;</div></li><li><div>                while ( $row = mysql_fetch_object( $this-&gt;result ) ) {&nbsp;</div></li><li><div>                    $this-&gt;last_result[$num_rows] = $row;&nbsp;</div></li><li><div>                    $num_rows++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Log number of rows the query returned&nbsp;</div></li><li><div>            // and return number of rows selected&nbsp;</div></li><li><div>            $this-&gt;num_rows = $num_rows;&nbsp;</div></li><li><div>            $return_val = $num_rows;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $return_val;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Internal function to perform the mysql_query() call.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.9.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @see wpdb::query()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $query The query to run.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _do_query( $query ) {&nbsp;</div></li><li><div>        if ( defined( 'SAVEQUERIES' ) && SAVEQUERIES ) {&nbsp;</div></li><li><div>            $this-&gt;timer_start();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;dbh ) && $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            $this-&gt;result = mysqli_query( $this-&gt;dbh, $query );&nbsp;</div></li><li><div>        } elseif ( ! empty( $this-&gt;dbh ) ) {&nbsp;</div></li><li><div>            $this-&gt;result = mysql_query( $query, $this-&gt;dbh );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;num_queries++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( defined( 'SAVEQUERIES' ) && SAVEQUERIES ) {&nbsp;</div></li><li><div>            $this-&gt;queries[] = array( $query, $this-&gt;timer_stop(), $this-&gt;get_caller() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Insert a row into a table.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     wpdb::insert( 'table', array( 'column' =&gt; 'foo', 'field' =&gt; 'bar' ) )&nbsp;</div></li><li><div>     *     wpdb::insert( 'table', array( 'column' =&gt; 'foo', 'field' =&gt; 1337 ), array( '%s', '%d' ) )&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::$field_types&nbsp;</div></li><li><div>     * @see wp_set_wpdb_vars()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string       $table  Table name&nbsp;</div></li><li><div>     * @param array        $data   Data to insert (in column =&gt; value pairs).&nbsp;</div></li><li><div>     *                             Both $data columns and $data values should be &quot;raw&quot; (neither should be SQL escaped).&nbsp;</div></li><li><div>     *                             Sending a null value will cause the column to be set to NULL - the corresponding format is ignored in this case.&nbsp;</div></li><li><div>     * @param array|string $format Optional. An array of formats to be mapped to each of the value in $data.&nbsp;</div></li><li><div>     *                             If string, that format will be used for all of the values in $data.&nbsp;</div></li><li><div>     *                             A format is one of '%d', '%f', '%s' (integer, float, string).&nbsp;</div></li><li><div>     *                             If omitted, all values in $data will be treated as strings unless otherwise specified in wpdb::$field_types.&nbsp;</div></li><li><div>     * @return int|false The number of rows inserted, or false on error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function insert( $table, $data, $format = null ) {&nbsp;</div></li><li><div>        return $this-&gt;_insert_replace_helper( $table, $data, $format, 'INSERT' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Replace a row into a table.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     wpdb::replace( 'table', array( 'column' =&gt; 'foo', 'field' =&gt; 'bar' ) )&nbsp;</div></li><li><div>     *     wpdb::replace( 'table', array( 'column' =&gt; 'foo', 'field' =&gt; 1337 ), array( '%s', '%d' ) )&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::$field_types&nbsp;</div></li><li><div>     * @see wp_set_wpdb_vars()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string       $table  Table name&nbsp;</div></li><li><div>     * @param array        $data   Data to insert (in column =&gt; value pairs).&nbsp;</div></li><li><div>     *                             Both $data columns and $data values should be &quot;raw&quot; (neither should be SQL escaped).&nbsp;</div></li><li><div>     *                             Sending a null value will cause the column to be set to NULL - the corresponding format is ignored in this case.&nbsp;</div></li><li><div>     * @param array|string $format Optional. An array of formats to be mapped to each of the value in $data.&nbsp;</div></li><li><div>     *                             If string, that format will be used for all of the values in $data.&nbsp;</div></li><li><div>     *                             A format is one of '%d', '%f', '%s' (integer, float, string).&nbsp;</div></li><li><div>     *                             If omitted, all values in $data will be treated as strings unless otherwise specified in wpdb::$field_types.&nbsp;</div></li><li><div>     * @return int|false The number of rows affected, or false on error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function replace( $table, $data, $format = null ) {&nbsp;</div></li><li><div>        return $this-&gt;_insert_replace_helper( $table, $data, $format, 'REPLACE' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper function for insert and replace.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Runs an insert or replace query based on $type argument.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::$field_types&nbsp;</div></li><li><div>     * @see wp_set_wpdb_vars()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string       $table  Table name&nbsp;</div></li><li><div>     * @param array        $data   Data to insert (in column =&gt; value pairs).&nbsp;</div></li><li><div>     *                             Both $data columns and $data values should be &quot;raw&quot; (neither should be SQL escaped).&nbsp;</div></li><li><div>     *                             Sending a null value will cause the column to be set to NULL - the corresponding format is ignored in this case.&nbsp;</div></li><li><div>     * @param array|string $format Optional. An array of formats to be mapped to each of the value in $data.&nbsp;</div></li><li><div>     *                             If string, that format will be used for all of the values in $data.&nbsp;</div></li><li><div>     *                             A format is one of '%d', '%f', '%s' (integer, float, string).&nbsp;</div></li><li><div>     *                             If omitted, all values in $data will be treated as strings unless otherwise specified in wpdb::$field_types.&nbsp;</div></li><li><div>     * @param string $type         Optional. What type of operation is this? INSERT or REPLACE. Defaults to INSERT.&nbsp;</div></li><li><div>     * @return int|false The number of rows affected, or false on error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function _insert_replace_helper( $table, $data, $format = null, $type = 'INSERT' ) {&nbsp;</div></li><li><div>        $this-&gt;insert_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! in_array( strtoupper( $type ), array( 'REPLACE', 'INSERT' ) ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;process_fields( $table, $data, $format );&nbsp;</div></li><li><div>        if ( false === $data ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $formats = $values = array();&nbsp;</div></li><li><div>        foreach ( $data as $value ) {&nbsp;</div></li><li><div>            if ( is_null( $value['value'] ) ) {&nbsp;</div></li><li><div>                $formats[] = 'NULL';&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $formats[] = $value['format'];&nbsp;</div></li><li><div>            $values[] = $value['value'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = '`' . implode( '`, `', array_keys( $data ) ) . '`';&nbsp;</div></li><li><div>        $formats = implode( ', ', $formats );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;$type INTO `$table` ($fields) VALUES ($formats)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        return $this-&gt;query( $this-&gt;prepare( $sql, $values ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update a row in the table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     wpdb::update( 'table', array( 'column' =&gt; 'foo', 'field' =&gt; 'bar' ), array( 'ID' =&gt; 1 ) )&nbsp;</div></li><li><div>     *     wpdb::update( 'table', array( 'column' =&gt; 'foo', 'field' =&gt; 1337 ), array( 'ID' =&gt; 1 ), array( '%s', '%d' ), array( '%d' ) )&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::$field_types&nbsp;</div></li><li><div>     * @see wp_set_wpdb_vars()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string       $table        Table name&nbsp;</div></li><li><div>     * @param array        $data         Data to update (in column =&gt; value pairs).&nbsp;</div></li><li><div>     *                                   Both $data columns and $data values should be &quot;raw&quot; (neither should be SQL escaped).&nbsp;</div></li><li><div>     *                                   Sending a null value will cause the column to be set to NULL - the corresponding&nbsp;</div></li><li><div>     *                                   format is ignored in this case.&nbsp;</div></li><li><div>     * @param array        $where        A named array of WHERE clauses (in column =&gt; value pairs).&nbsp;</div></li><li><div>     *                                   Multiple clauses will be joined with ANDs.&nbsp;</div></li><li><div>     *                                   Both $where columns and $where values should be &quot;raw&quot;.&nbsp;</div></li><li><div>     *                                   Sending a null value will create an IS NULL comparison - the corresponding format will be ignored in this case.&nbsp;</div></li><li><div>     * @param array|string $format       Optional. An array of formats to be mapped to each of the values in $data.&nbsp;</div></li><li><div>     *                                   If string, that format will be used for all of the values in $data.&nbsp;</div></li><li><div>     *                                   A format is one of '%d', '%f', '%s' (integer, float, string).&nbsp;</div></li><li><div>     *                                   If omitted, all values in $data will be treated as strings unless otherwise specified in wpdb::$field_types.&nbsp;</div></li><li><div>     * @param array|string $where_format Optional. An array of formats to be mapped to each of the values in $where.&nbsp;</div></li><li><div>     *                                   If string, that format will be used for all of the items in $where.&nbsp;</div></li><li><div>     *                                   A format is one of '%d', '%f', '%s' (integer, float, string).&nbsp;</div></li><li><div>     *                                   If omitted, all values in $where will be treated as strings.&nbsp;</div></li><li><div>     * @return int|false The number of rows updated, or false on error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update( $table, $data, $where, $format = null, $where_format = null ) {&nbsp;</div></li><li><div>        if ( ! is_array( $data ) || ! is_array( $where ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;process_fields( $table, $data, $format );&nbsp;</div></li><li><div>        if ( false === $data ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $where = $this-&gt;process_fields( $table, $where, $where_format );&nbsp;</div></li><li><div>        if ( false === $where ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = $conditions = $values = array();&nbsp;</div></li><li><div>        foreach ( $data as $field =&gt; $value ) {&nbsp;</div></li><li><div>            if ( is_null( $value['value'] ) ) {&nbsp;</div></li><li><div>                $fields[] = &quot;`$field` = NULL&quot;;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fields[] = &quot;`$field` = &quot; . $value['format'];&nbsp;</div></li><li><div>            $values[] = $value['value'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ( $where as $field =&gt; $value ) {&nbsp;</div></li><li><div>            if ( is_null( $value['value'] ) ) {&nbsp;</div></li><li><div>                $conditions[] = &quot;`$field` IS NULL&quot;;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $conditions[] = &quot;`$field` = &quot; . $value['format'];&nbsp;</div></li><li><div>            $values[] = $value['value'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = implode( ', ', $fields );&nbsp;</div></li><li><div>        $conditions = implode( ' AND ', $conditions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;UPDATE `$table` SET $fields WHERE $conditions&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        return $this-&gt;query( $this-&gt;prepare( $sql, $values ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a row in the table&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     wpdb::delete( 'table', array( 'ID' =&gt; 1 ) )&nbsp;</div></li><li><div>     *     wpdb::delete( 'table', array( 'ID' =&gt; 1 ), array( '%d' ) )&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.4.0&nbsp;</div></li><li><div>     * @see wpdb::prepare()&nbsp;</div></li><li><div>     * @see wpdb::$field_types&nbsp;</div></li><li><div>     * @see wp_set_wpdb_vars()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string       $table        Table name&nbsp;</div></li><li><div>     * @param array        $where        A named array of WHERE clauses (in column =&gt; value pairs).&nbsp;</div></li><li><div>     *                                   Multiple clauses will be joined with ANDs.&nbsp;</div></li><li><div>     *                                   Both $where columns and $where values should be &quot;raw&quot;.&nbsp;</div></li><li><div>     *                                   Sending a null value will create an IS NULL comparison - the corresponding format will be ignored in this case.&nbsp;</div></li><li><div>     * @param array|string $where_format Optional. An array of formats to be mapped to each of the values in $where.&nbsp;</div></li><li><div>     *                                   If string, that format will be used for all of the items in $where.&nbsp;</div></li><li><div>     *                                   A format is one of '%d', '%f', '%s' (integer, float, string).&nbsp;</div></li><li><div>     *                                   If omitted, all values in $where will be treated as strings unless otherwise specified in wpdb::$field_types.&nbsp;</div></li><li><div>     * @return int|false The number of rows updated, or false on error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete( $table, $where, $where_format = null ) {&nbsp;</div></li><li><div>        if ( ! is_array( $where ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = $this-&gt;process_fields( $table, $where, $where_format );&nbsp;</div></li><li><div>        if ( false === $where ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $conditions = $values = array();&nbsp;</div></li><li><div>        foreach ( $where as $field =&gt; $value ) {&nbsp;</div></li><li><div>            if ( is_null( $value['value'] ) ) {&nbsp;</div></li><li><div>                $conditions[] = &quot;`$field` IS NULL&quot;;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $conditions[] = &quot;`$field` = &quot; . $value['format'];&nbsp;</div></li><li><div>            $values[] = $value['value'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $conditions = implode( ' AND ', $conditions );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;DELETE FROM `$table` WHERE $conditions&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        return $this-&gt;query( $this-&gt;prepare( $sql, $values ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Processes arrays of field/value pairs and field formats.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This is a helper method for wpdb's CRUD methods, which take field/value&nbsp;</div></li><li><div>     * pairs for inserts, updates, and where clauses. This method first pairs&nbsp;</div></li><li><div>     * each value with a format. Then it determines the charset of that field, &nbsp;</div></li><li><div>     * using that to determine if any invalid text would be stripped. If text is&nbsp;</div></li><li><div>     * stripped, then field processing is rejected and the query fails.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $table  Table name.&nbsp;</div></li><li><div>     * @param array  $data   Field/value pair.&nbsp;</div></li><li><div>     * @param mixed  $format Format for each field.&nbsp;</div></li><li><div>     * @return array|false Returns an array of fields that contain paired values&nbsp;</div></li><li><div>     *                    and formats. Returns false for invalid values.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function process_fields( $table, $data, $format ) {&nbsp;</div></li><li><div>        $data = $this-&gt;process_field_formats( $data, $format );&nbsp;</div></li><li><div>        if ( false === $data ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;process_field_charsets( $data, $table );&nbsp;</div></li><li><div>        if ( false === $data ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;process_field_lengths( $data, $table );&nbsp;</div></li><li><div>        if ( false === $data ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $converted_data = $this-&gt;strip_invalid_text( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $data !== $converted_data ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prepares arrays of value/format pairs as passed to wpdb CRUD methods.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $data   Array of fields to values.&nbsp;</div></li><li><div>     * @param mixed $format Formats to be mapped to the values in $data.&nbsp;</div></li><li><div>     * @return array Array, keyed by field names with values being an array&nbsp;</div></li><li><div>     *               of 'value' and 'format' keys.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function process_field_formats( $data, $format ) {&nbsp;</div></li><li><div>        $formats = $original_formats = (array) $format;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $data as $field =&gt; $value ) {&nbsp;</div></li><li><div>            $value = array(&nbsp;</div></li><li><div>                'value' =&gt; $value, &nbsp;</div></li><li><div>                'format' =&gt; '%s', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $format ) ) {&nbsp;</div></li><li><div>                $value['format'] = array_shift( $formats );&nbsp;</div></li><li><div>                if ( ! $value['format'] ) {&nbsp;</div></li><li><div>                    $value['format'] = reset( $original_formats );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( isset( $this-&gt;field_types[ $field ] ) ) {&nbsp;</div></li><li><div>                $value['format'] = $this-&gt;field_types[ $field ];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data[ $field ] = $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds field charsets to field/value/format arrays generated by&nbsp;</div></li><li><div>     * the wpdb::process_field_formats() method.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array  $data  As it comes from the wpdb::process_field_formats() method.&nbsp;</div></li><li><div>     * @param string $table Table name.&nbsp;</div></li><li><div>     * @return array|false The same array as $data with additional 'charset' keys.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function process_field_charsets( $data, $table ) {&nbsp;</div></li><li><div>        foreach ( $data as $field =&gt; $value ) {&nbsp;</div></li><li><div>            if ( '%d' === $value['format'] || '%f' === $value['format'] ) {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * We can skip this field if we know it isn't a string.&nbsp;</div></li><li><div>                 * This checks %d/%f versus ! %s because its sprintf() could take more.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $value['charset'] = false;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $value['charset'] = $this-&gt;get_col_charset( $table, $field );&nbsp;</div></li><li><div>                if ( is_wp_error( $value['charset'] ) ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data[ $field ] = $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * For string fields, record the maximum string length that field can safely save.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.1&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array  $data  As it comes from the wpdb::process_field_charsets() method.&nbsp;</div></li><li><div>     * @param string $table Table name.&nbsp;</div></li><li><div>     * @return array|false The same array as $data with additional 'length' keys, or false if&nbsp;</div></li><li><div>     *                     any of the values were too long for their corresponding field.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function process_field_lengths( $data, $table ) {&nbsp;</div></li><li><div>        foreach ( $data as $field =&gt; $value ) {&nbsp;</div></li><li><div>            if ( '%d' === $value['format'] || '%f' === $value['format'] ) {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * We can skip this field if we know it isn't a string.&nbsp;</div></li><li><div>                 * This checks %d/%f versus ! %s because its sprintf() could take more.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $value['length'] = false;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $value['length'] = $this-&gt;get_col_length( $table, $field );&nbsp;</div></li><li><div>                if ( is_wp_error( $value['length'] ) ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data[ $field ] = $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve one variable from the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Executes a SQL query and returns the value from the SQL result.&nbsp;</div></li><li><div>     * If the SQL result contains more than one column and/or more than one row, this function returns the value in the column and row specified.&nbsp;</div></li><li><div>     * If $query is null, this function returns the value in the specified column and row from the previous SQL result.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string|null $query Optional. SQL query. Defaults to null, use the result from the previous query.&nbsp;</div></li><li><div>     * @param int         $x     Optional. Column of value to return. Indexed from 0.&nbsp;</div></li><li><div>     * @param int         $y     Optional. Row of value to return. Indexed from 0.&nbsp;</div></li><li><div>     * @return string|null Database query result (as string), or null on failure&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_var( $query = null, $x = 0, $y = 0 ) {&nbsp;</div></li><li><div>        $this-&gt;func_call = &quot;\$db-&gt;get_var(\&quot;$query\&quot;, $x, $y)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;check_current_query && $this-&gt;check_safe_collation( $query ) ) {&nbsp;</div></li><li><div>            $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query ) {&nbsp;</div></li><li><div>            $this-&gt;query( $query );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Extract var out of cached results based x, y vals&nbsp;</div></li><li><div>        if ( !empty( $this-&gt;last_result[$y] ) ) {&nbsp;</div></li><li><div>            $values = array_values( get_object_vars( $this-&gt;last_result[$y] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If there is a value return it else return null&nbsp;</div></li><li><div>        return ( isset( $values[$x] ) && $values[$x] !== '' ) ? $values[$x] : null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve one row from the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Executes a SQL query and returns the row from the SQL result.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string|null $query  SQL query.&nbsp;</div></li><li><div>     * @param string      $output Optional. The required return type. One of OBJECT, ARRAY_A, or ARRAY_N, which correspond to&nbsp;</div></li><li><div>     *                            an stdClass object, an associative array, or a numeric array, respectively. Default OBJECT.&nbsp;</div></li><li><div>     * @param int         $y      Optional. Row to return. Indexed from 0.&nbsp;</div></li><li><div>     * @return array|object|null|void Database query result in format specified by $output or null on failure&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_row( $query = null, $output = OBJECT, $y = 0 ) {&nbsp;</div></li><li><div>        $this-&gt;func_call = &quot;\$db-&gt;get_row(\&quot;$query\&quot;, $output, $y)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;check_current_query && $this-&gt;check_safe_collation( $query ) ) {&nbsp;</div></li><li><div>            $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query ) {&nbsp;</div></li><li><div>            $this-&gt;query( $query );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !isset( $this-&gt;last_result[$y] ) )&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $output == OBJECT ) {&nbsp;</div></li><li><div>            return $this-&gt;last_result[$y] ? $this-&gt;last_result[$y] : null;&nbsp;</div></li><li><div>        } elseif ( $output == ARRAY_A ) {&nbsp;</div></li><li><div>            return $this-&gt;last_result[$y] ? get_object_vars( $this-&gt;last_result[$y] ) : null;&nbsp;</div></li><li><div>        } elseif ( $output == ARRAY_N ) {&nbsp;</div></li><li><div>            return $this-&gt;last_result[$y] ? array_values( get_object_vars( $this-&gt;last_result[$y] ) ) : null;&nbsp;</div></li><li><div>        } elseif ( strtoupper( $output ) === OBJECT ) {&nbsp;</div></li><li><div>            // Back compat for OBJECT being previously case insensitive.&nbsp;</div></li><li><div>            return $this-&gt;last_result[$y] ? $this-&gt;last_result[$y] : null;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;print_error( &quot; \$db-&gt;get_row(string query, output type, int offset) -- Output type must be one of: OBJECT, ARRAY_A, ARRAY_N&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve one column from the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Executes a SQL query and returns the column from the SQL result.&nbsp;</div></li><li><div>     * If the SQL result contains more than one column, this function returns the column specified.&nbsp;</div></li><li><div>     * If $query is null, this function returns the specified column from the previous SQL result.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string|null $query Optional. SQL query. Defaults to previous query.&nbsp;</div></li><li><div>     * @param int         $x     Optional. Column to return. Indexed from 0.&nbsp;</div></li><li><div>     * @return array Database query result. Array indexed from 0 by SQL result row number.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_col( $query = null , $x = 0 ) {&nbsp;</div></li><li><div>        if ( $this-&gt;check_current_query && $this-&gt;check_safe_collation( $query ) ) {&nbsp;</div></li><li><div>            $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query ) {&nbsp;</div></li><li><div>            $this-&gt;query( $query );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $new_array = array();&nbsp;</div></li><li><div>        // Extract the column values&nbsp;</div></li><li><div>        for ( $i = 0, $j = count( $this-&gt;last_result ); $i &lt; $j; $i++ ) {&nbsp;</div></li><li><div>            $new_array[$i] = $this-&gt;get_var( null, $x, $i );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $new_array;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve an entire SQL result set from the database (i.e., many rows)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Executes a SQL query and returns the entire SQL result.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $query  SQL query.&nbsp;</div></li><li><div>     * @param string $output Optional. Any of ARRAY_A | ARRAY_N | OBJECT | OBJECT_K constants.&nbsp;</div></li><li><div>     *                       With one of the first three, return an array of rows indexed from 0 by SQL result row number.&nbsp;</div></li><li><div>     *                       Each row is an associative array (column =&gt; value, ...), a numerically indexed array (0 =&gt; value, ...), or an object. ( -&gt;column = value ), respectively.&nbsp;</div></li><li><div>     *                       With OBJECT_K, return an associative array of row objects keyed by the value of each row's first column's value.&nbsp;</div></li><li><div>     *                       Duplicate keys are discarded.&nbsp;</div></li><li><div>     * @return array|object|null Database query results&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_results( $query = null, $output = OBJECT ) {&nbsp;</div></li><li><div>        $this-&gt;func_call = &quot;\$db-&gt;get_results(\&quot;$query\&quot;, $output)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;check_current_query && $this-&gt;check_safe_collation( $query ) ) {&nbsp;</div></li><li><div>            $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query ) {&nbsp;</div></li><li><div>            $this-&gt;query( $query );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $new_array = array();&nbsp;</div></li><li><div>        if ( $output == OBJECT ) {&nbsp;</div></li><li><div>            // Return an integer-keyed array of row objects&nbsp;</div></li><li><div>            return $this-&gt;last_result;&nbsp;</div></li><li><div>        } elseif ( $output == OBJECT_K ) {&nbsp;</div></li><li><div>            // Return an array of row objects with keys from column 1&nbsp;</div></li><li><div>            // (Duplicates are discarded)&nbsp;</div></li><li><div>            foreach ( $this-&gt;last_result as $row ) {&nbsp;</div></li><li><div>                $var_by_ref = get_object_vars( $row );&nbsp;</div></li><li><div>                $key = array_shift( $var_by_ref );&nbsp;</div></li><li><div>                if ( ! isset( $new_array[ $key ] ) )&nbsp;</div></li><li><div>                    $new_array[ $key ] = $row;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $new_array;&nbsp;</div></li><li><div>        } elseif ( $output == ARRAY_A || $output == ARRAY_N ) {&nbsp;</div></li><li><div>            // Return an integer-keyed array of...&nbsp;</div></li><li><div>            if ( $this-&gt;last_result ) {&nbsp;</div></li><li><div>                foreach ( (array) $this-&gt;last_result as $row ) {&nbsp;</div></li><li><div>                    if ( $output == ARRAY_N ) {&nbsp;</div></li><li><div>                        // ...integer-keyed row arrays&nbsp;</div></li><li><div>                        $new_array[] = array_values( get_object_vars( $row ) );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // ...column name-keyed row arrays&nbsp;</div></li><li><div>                        $new_array[] = get_object_vars( $row );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $new_array;&nbsp;</div></li><li><div>        } elseif ( strtoupper( $output ) === OBJECT ) {&nbsp;</div></li><li><div>            // Back compat for OBJECT being previously case insensitive.&nbsp;</div></li><li><div>            return $this-&gt;last_result;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the character set for the given table.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $table Table name.&nbsp;</div></li><li><div>     * @return string|WP_Error Table character set, WP_Error object if it couldn't be found.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_table_charset( $table ) {&nbsp;</div></li><li><div>        $tablekey = strtolower( $table );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the table charset value before the DB is checked.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Passing a non-null value to the filter will effectively short-circuit&nbsp;</div></li><li><div>         * checking the DB for the charset, returning that value instead.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 4.2.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $charset The character set to use. Default null.&nbsp;</div></li><li><div>         * @param string $table   The name of the table being checked.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $charset = apply_filters( 'pre_get_table_charset', null, $table );&nbsp;</div></li><li><div>        if ( null !== $charset ) {&nbsp;</div></li><li><div>            return $charset;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $this-&gt;table_charset[ $tablekey ] ) ) {&nbsp;</div></li><li><div>            return $this-&gt;table_charset[ $tablekey ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $charsets = $columns = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table_parts = explode( '.', $table );&nbsp;</div></li><li><div>        $table = '`' . implode( '`.`', $table_parts ) . '`';&nbsp;</div></li><li><div>        $results = $this-&gt;get_results( &quot;SHOW FULL COLUMNS FROM $table&quot; );&nbsp;</div></li><li><div>        if ( ! $results ) {&nbsp;</div></li><li><div>            return new WP_Error( 'wpdb_get_table_charset_failure' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $results as $column ) {&nbsp;</div></li><li><div>            $columns[ strtolower( $column-&gt;Field ) ] = $column;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;col_meta[ $tablekey ] = $columns;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $columns as $column ) {&nbsp;</div></li><li><div>            if ( ! empty( $column-&gt;Collation ) ) {&nbsp;</div></li><li><div>                list( $charset ) = explode( '_', $column-&gt;Collation );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If the current connection can't support utf8mb4 characters, let's only send 3-byte utf8 characters.&nbsp;</div></li><li><div>                if ( 'utf8mb4' === $charset && ! $this-&gt;has_cap( 'utf8mb4' ) ) {&nbsp;</div></li><li><div>                    $charset = 'utf8';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $charsets[ strtolower( $charset ) ] = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            list( $type ) = explode( '(', $column-&gt;Type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // A binary/blob means the whole query gets treated like this.&nbsp;</div></li><li><div>            if ( in_array( strtoupper( $type ), array( 'BINARY', 'VARBINARY', 'TINYBLOB', 'MEDIUMBLOB', 'BLOB', 'LONGBLOB' ) ) ) {&nbsp;</div></li><li><div>                $this-&gt;table_charset[ $tablekey ] = 'binary';&nbsp;</div></li><li><div>                return 'binary';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // utf8mb3 is an alias for utf8.&nbsp;</div></li><li><div>        if ( isset( $charsets['utf8mb3'] ) ) {&nbsp;</div></li><li><div>            $charsets['utf8'] = true;&nbsp;</div></li><li><div>            unset( $charsets['utf8mb3'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check if we have more than one charset in play.&nbsp;</div></li><li><div>        $count = count( $charsets );&nbsp;</div></li><li><div>        if ( 1 === $count ) {&nbsp;</div></li><li><div>            $charset = key( $charsets );&nbsp;</div></li><li><div>        } elseif ( 0 === $count ) {&nbsp;</div></li><li><div>            // No charsets, assume this table can store whatever.&nbsp;</div></li><li><div>            $charset = false;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // More than one charset. Remove latin1 if present and recalculate.&nbsp;</div></li><li><div>            unset( $charsets['latin1'] );&nbsp;</div></li><li><div>            $count = count( $charsets );&nbsp;</div></li><li><div>            if ( 1 === $count ) {&nbsp;</div></li><li><div>                // Only one charset (besides latin1).&nbsp;</div></li><li><div>                $charset = key( $charsets );&nbsp;</div></li><li><div>            } elseif ( 2 === $count && isset( $charsets['utf8'], $charsets['utf8mb4'] ) ) {&nbsp;</div></li><li><div>                // Two charsets, but they're utf8 and utf8mb4, use utf8.&nbsp;</div></li><li><div>                $charset = 'utf8';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // Two mixed character sets. ascii.&nbsp;</div></li><li><div>                $charset = 'ascii';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;table_charset[ $tablekey ] = $charset;&nbsp;</div></li><li><div>        return $charset;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the character set for the given column.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $table  Table name.&nbsp;</div></li><li><div>     * @param string $column Column name.&nbsp;</div></li><li><div>     * @return string|false|WP_Error Column character set as a string. False if the column has no&nbsp;</div></li><li><div>     *                               character set. WP_Error object if there was an error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_col_charset( $table, $column ) {&nbsp;</div></li><li><div>        $tablekey = strtolower( $table );&nbsp;</div></li><li><div>        $columnkey = strtolower( $column );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filters the column charset value before the DB is checked.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Passing a non-null value to the filter will short-circuit&nbsp;</div></li><li><div>         * checking the DB for the charset, returning that value instead.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 4.2.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $charset The character set to use. Default null.&nbsp;</div></li><li><div>         * @param string $table   The name of the table being checked.&nbsp;</div></li><li><div>         * @param string $column  The name of the column being checked.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $charset = apply_filters( 'pre_get_col_charset', null, $table, $column );&nbsp;</div></li><li><div>        if ( null !== $charset ) {&nbsp;</div></li><li><div>            return $charset;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Skip this entirely if this isn't a MySQL database.&nbsp;</div></li><li><div>        if ( empty( $this-&gt;is_mysql ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;table_charset[ $tablekey ] ) ) {&nbsp;</div></li><li><div>            // This primes column information for us.&nbsp;</div></li><li><div>            $table_charset = $this-&gt;get_table_charset( $table );&nbsp;</div></li><li><div>            if ( is_wp_error( $table_charset ) ) {&nbsp;</div></li><li><div>                return $table_charset;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If still no column information, return the table charset.&nbsp;</div></li><li><div>        if ( empty( $this-&gt;col_meta[ $tablekey ] ) ) {&nbsp;</div></li><li><div>            return $this-&gt;table_charset[ $tablekey ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If this column doesn't exist, return the table charset.&nbsp;</div></li><li><div>        if ( empty( $this-&gt;col_meta[ $tablekey ][ $columnkey ] ) ) {&nbsp;</div></li><li><div>            return $this-&gt;table_charset[ $tablekey ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return false when it's not a string column.&nbsp;</div></li><li><div>        if ( empty( $this-&gt;col_meta[ $tablekey ][ $columnkey ]-&gt;Collation ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list( $charset ) = explode( '_', $this-&gt;col_meta[ $tablekey ][ $columnkey ]-&gt;Collation );&nbsp;</div></li><li><div>        return $charset;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the maximum string length allowed in a given column.&nbsp;</div></li><li><div>     * The length may either be specified as a byte length or a character length.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.1&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $table  Table name.&nbsp;</div></li><li><div>     * @param string $column Column name.&nbsp;</div></li><li><div>     * @return array|false|WP_Error array( 'length' =&gt; (int), 'type' =&gt; 'byte' | 'char' )&nbsp;</div></li><li><div>     *                              false if the column has no length (for example, numeric column)&nbsp;</div></li><li><div>     *                              WP_Error object if there was an error.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_col_length( $table, $column ) {&nbsp;</div></li><li><div>        $tablekey = strtolower( $table );&nbsp;</div></li><li><div>        $columnkey = strtolower( $column );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Skip this entirely if this isn't a MySQL database.&nbsp;</div></li><li><div>        if ( empty( $this-&gt;is_mysql ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;col_meta[ $tablekey ] ) ) {&nbsp;</div></li><li><div>            // This primes column information for us.&nbsp;</div></li><li><div>            $table_charset = $this-&gt;get_table_charset( $table );&nbsp;</div></li><li><div>            if ( is_wp_error( $table_charset ) ) {&nbsp;</div></li><li><div>                return $table_charset;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $this-&gt;col_meta[ $tablekey ][ $columnkey ] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $typeinfo = explode( '(', $this-&gt;col_meta[ $tablekey ][ $columnkey ]-&gt;Type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $type = strtolower( $typeinfo[0] );&nbsp;</div></li><li><div>        if ( ! empty( $typeinfo[1] ) ) {&nbsp;</div></li><li><div>            $length = trim( $typeinfo[1], ')' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $length = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $type ) {&nbsp;</div></li><li><div>            case 'char':&nbsp;</div></li><li><div>            case 'varchar':&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'type' =&gt; 'char', &nbsp;</div></li><li><div>                    'length' =&gt; (int) $length, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'binary':&nbsp;</div></li><li><div>            case 'varbinary':&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'type' =&gt; 'byte', &nbsp;</div></li><li><div>                    'length' =&gt; (int) $length, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'tinyblob':&nbsp;</div></li><li><div>            case 'tinytext':&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'type' =&gt; 'byte', &nbsp;</div></li><li><div>                    'length' =&gt; 255, // 2^8 - 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'blob':&nbsp;</div></li><li><div>            case 'text':&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'type' =&gt; 'byte', &nbsp;</div></li><li><div>                    'length' =&gt; 65535, // 2^16 - 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'mediumblob':&nbsp;</div></li><li><div>            case 'mediumtext':&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'type' =&gt; 'byte', &nbsp;</div></li><li><div>                    'length' =&gt; 16777215, // 2^24 - 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'longblob':&nbsp;</div></li><li><div>            case 'longtext':&nbsp;</div></li><li><div>                return array(&nbsp;</div></li><li><div>                    'type' =&gt; 'byte', &nbsp;</div></li><li><div>                    'length' =&gt; 4294967295, // 2^32 - 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if a string is ASCII.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * The negative regex is faster for non-ASCII strings, as it allows&nbsp;</div></li><li><div>     * the search to finish as soon as it encounters a non-ASCII character.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $string String to check.&nbsp;</div></li><li><div>     * @return bool True if ASCII, false if not.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function check_ascii( $string ) {&nbsp;</div></li><li><div>        if ( function_exists( 'mb_check_encoding' ) ) {&nbsp;</div></li><li><div>            if ( mb_check_encoding( $string, 'ASCII' ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! preg_match( '/[^\x00-\x7F]/', $string ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if the query is accessing a collation considered safe on the current version of MySQL.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $query The query to check.&nbsp;</div></li><li><div>     * @return bool True if the collation is safe, false if it isn't.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function check_safe_collation( $query ) {&nbsp;</div></li><li><div>        if ( $this-&gt;checking_collation ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // We don't need to check the collation for queries that don't read data.&nbsp;</div></li><li><div>        $query = ltrim( $query, &quot;\r\n\t (&quot; );&nbsp;</div></li><li><div>        if ( preg_match( '/^(?:SHOW|DESCRIBE|DESC|EXPLAIN|CREATE)\s/i', $query ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // All-ASCII queries don't need extra checking.&nbsp;</div></li><li><div>        if ( $this-&gt;check_ascii( $query ) ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = $this-&gt;get_table_from_query( $query );&nbsp;</div></li><li><div>        if ( ! $table ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;checking_collation = true;&nbsp;</div></li><li><div>        $collation = $this-&gt;get_table_charset( $table );&nbsp;</div></li><li><div>        $this-&gt;checking_collation = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Tables with no collation, or latin1 only, don't need extra checking.&nbsp;</div></li><li><div>        if ( false === $collation || 'latin1' === $collation ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = strtolower( $table );&nbsp;</div></li><li><div>        if ( empty( $this-&gt;col_meta[ $table ] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If any of the columns don't have one of these collations, it needs more sanity checking.&nbsp;</div></li><li><div>        foreach ( $this-&gt;col_meta[ $table ] as $col ) {&nbsp;</div></li><li><div>            if ( empty( $col-&gt;Collation ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! in_array( $col-&gt;Collation, array( 'utf8_general_ci', 'utf8_bin', 'utf8mb4_general_ci', 'utf8mb4_bin' ), true ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Strips any invalid characters based on value/charset pairs.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $data Array of value arrays. Each value array has the keys&nbsp;</div></li><li><div>     *                    'value' and 'charset'. An optional 'ascii' key can be&nbsp;</div></li><li><div>     *                    set to false to avoid redundant ASCII checks.&nbsp;</div></li><li><div>     * @return array|WP_Error The $data parameter, with invalid characters removed from&nbsp;</div></li><li><div>     *                        each value. This works as a passthrough: any additional keys&nbsp;</div></li><li><div>     *                        such as 'field' are retained in each value array. If we cannot&nbsp;</div></li><li><div>     *                        remove invalid characters, a WP_Error object is returned.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function strip_invalid_text( $data ) {&nbsp;</div></li><li><div>        $db_check_string = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $data as &$value ) {&nbsp;</div></li><li><div>            $charset = $value['charset'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $value['length'] ) ) {&nbsp;</div></li><li><div>                $length = $value['length']['length'];&nbsp;</div></li><li><div>                $truncate_by_byte_length = 'byte' === $value['length']['type'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $length = false;&nbsp;</div></li><li><div>                // Since we have no length, we'll never truncate.&nbsp;</div></li><li><div>                // Initialize the variable to false. true would take us&nbsp;</div></li><li><div>                // through an unnecessary (for this case) codepath below.&nbsp;</div></li><li><div>                $truncate_by_byte_length = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // There's no charset to work with.&nbsp;</div></li><li><div>            if ( false === $charset ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Column isn't a string.&nbsp;</div></li><li><div>            if ( ! is_string( $value['value'] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $needs_validation = true;&nbsp;</div></li><li><div>            if (&nbsp;</div></li><li><div>                // latin1 can store any byte sequence&nbsp;</div></li><li><div>                'latin1' === $charset&nbsp;</div></li><li><div>            ||&nbsp;</div></li><li><div>                // ASCII is always OK.&nbsp;</div></li><li><div>                ( ! isset( $value['ascii'] ) && $this-&gt;check_ascii( $value['value'] ) )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $truncate_by_byte_length = true;&nbsp;</div></li><li><div>                $needs_validation = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $truncate_by_byte_length ) {&nbsp;</div></li><li><div>                mbstring_binary_safe_encoding();&nbsp;</div></li><li><div>                if ( false !== $length && strlen( $value['value'] ) &gt; $length ) {&nbsp;</div></li><li><div>                    $value['value'] = substr( $value['value'], 0, $length );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                reset_mbstring_encoding();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! $needs_validation ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // utf8 can be handled by regex, which is a bunch faster than a DB lookup.&nbsp;</div></li><li><div>            if ( ( 'utf8' === $charset || 'utf8mb3' === $charset || 'utf8mb4' === $charset ) && function_exists( 'mb_strlen' ) ) {&nbsp;</div></li><li><div>                $regex = '/&nbsp;</div></li><li><div>                    (&nbsp;</div></li><li><div>                        (?: [\x00-\x7F]                  # single-byte sequences   0xxxxxxx&nbsp;</div></li><li><div>                        |   [\xC2-\xDF][\x80-\xBF]       # double-byte sequences   110xxxxx 10xxxxxx&nbsp;</div></li><li><div>                        |   \xE0[\xA0-\xBF][\x80-\xBF]   # triple-byte sequences   1110xxxx 10xxxxxx * 2&nbsp;</div></li><li><div>                        |   [\xE1-\xEC][\x80-\xBF]{2}&nbsp;</div></li><li><div>                        |   \xED[\x80-\x9F][\x80-\xBF]&nbsp;</div></li><li><div>                        |   [\xEE-\xEF][\x80-\xBF]{2}';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 'utf8mb4' === $charset ) {&nbsp;</div></li><li><div>                    $regex .= '&nbsp;</div></li><li><div>                        |    \xF0[\x90-\xBF][\x80-\xBF]{2} # four-byte sequences   11110xxx 10xxxxxx * 3&nbsp;</div></li><li><div>                        |    [\xF1-\xF3][\x80-\xBF]{3}&nbsp;</div></li><li><div>                        |    \xF4[\x80-\x8F][\x80-\xBF]{2}&nbsp;</div></li><li><div>                    ';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $regex .= ') {1, 40}                          # ...one or more times&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div>                    | .                                  # anything else&nbsp;</div></li><li><div>                    /x';&nbsp;</div></li><li><div>                $value['value'] = preg_replace( $regex, '$1', $value['value'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( false !== $length && mb_strlen( $value['value'], 'UTF-8' ) &gt; $length ) {&nbsp;</div></li><li><div>                    $value['value'] = mb_substr( $value['value'], 0, $length, 'UTF-8' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // We couldn't use any local conversions, send it to the DB.&nbsp;</div></li><li><div>            $value['db'] = $db_check_string = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        unset( $value ); // Remove by reference.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $db_check_string ) {&nbsp;</div></li><li><div>            $queries = array();&nbsp;</div></li><li><div>            foreach ( $data as $col =&gt; $value ) {&nbsp;</div></li><li><div>                if ( ! empty( $value['db'] ) ) {&nbsp;</div></li><li><div>                    // We're going to need to truncate by characters or bytes, depending on the length value we have.&nbsp;</div></li><li><div>                    if ( 'byte' === $value['length']['type'] ) {&nbsp;</div></li><li><div>                        // Using binary causes LEFT() to truncate by bytes.&nbsp;</div></li><li><div>                        $charset = 'binary';&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $charset = $value['charset'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $this-&gt;charset ) {&nbsp;</div></li><li><div>                        $connection_charset = $this-&gt;charset;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                            $connection_charset = mysqli_character_set_name( $this-&gt;dbh );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $connection_charset = mysql_client_encoding();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_array( $value['length'] ) ) {&nbsp;</div></li><li><div>                        $queries[ $col ] = $this-&gt;prepare( &quot;CONVERT( LEFT( CONVERT( %s USING $charset ), %.0f ) USING $connection_charset )&quot;, $value['value'], $value['length']['length'] );&nbsp;</div></li><li><div>                    } else if ( 'binary' !== $charset ) {&nbsp;</div></li><li><div>                        // If we don't have a length, there's no need to convert binary - it will always return the same result.&nbsp;</div></li><li><div>                        $queries[ $col ] = $this-&gt;prepare( &quot;CONVERT( CONVERT( %s USING $charset ) USING $connection_charset )&quot;, $value['value'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    unset( $data[ $col ]['db'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $sql = array();&nbsp;</div></li><li><div>            foreach ( $queries as $column =&gt; $query ) {&nbsp;</div></li><li><div>                if ( ! $query ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $sql[] = $query . &quot; AS x_$column&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;check_current_query = false;&nbsp;</div></li><li><div>            $row = $this-&gt;get_row( &quot;SELECT &quot; . implode( ', ', $sql ), ARRAY_A );&nbsp;</div></li><li><div>            if ( ! $row ) {&nbsp;</div></li><li><div>                return new WP_Error( 'wpdb_strip_invalid_text_failure' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( array_keys( $data ) as $column ) {&nbsp;</div></li><li><div>                if ( isset( $row[&quot;x_$column&quot;] ) ) {&nbsp;</div></li><li><div>                    $data[ $column ]['value'] = $row[&quot;x_$column&quot;];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Strips any invalid characters from the query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $query Query to convert.&nbsp;</div></li><li><div>     * @return string|WP_Error The converted query, or a WP_Error object if the conversion fails.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function strip_invalid_text_from_query( $query ) {&nbsp;</div></li><li><div>        // We don't need to check the collation for queries that don't read data.&nbsp;</div></li><li><div>        $trimmed_query = ltrim( $query, &quot;\r\n\t (&quot; );&nbsp;</div></li><li><div>        if ( preg_match( '/^(?:SHOW|DESCRIBE|DESC|EXPLAIN|CREATE)\s/i', $trimmed_query ) ) {&nbsp;</div></li><li><div>            return $query;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = $this-&gt;get_table_from_query( $query );&nbsp;</div></li><li><div>        if ( $table ) {&nbsp;</div></li><li><div>            $charset = $this-&gt;get_table_charset( $table );&nbsp;</div></li><li><div>            if ( is_wp_error( $charset ) ) {&nbsp;</div></li><li><div>                return $charset;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // We can't reliably strip text from tables containing binary/blob columns&nbsp;</div></li><li><div>            if ( 'binary' === $charset ) {&nbsp;</div></li><li><div>                return $query;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $charset = $this-&gt;charset;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'value' =&gt; $query, &nbsp;</div></li><li><div>            'charset' =&gt; $charset, &nbsp;</div></li><li><div>            'ascii' =&gt; false, &nbsp;</div></li><li><div>            'length' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;strip_invalid_text( array( $data ) );&nbsp;</div></li><li><div>        if ( is_wp_error( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data[0]['value'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Strips any invalid characters from the string for a given table and column.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $table  Table name.&nbsp;</div></li><li><div>     * @param string $column Column name.&nbsp;</div></li><li><div>     * @param string $value  The text to check.&nbsp;</div></li><li><div>     * @return string|WP_Error The converted string, or a WP_Error object if the conversion fails.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function strip_invalid_text_for_column( $table, $column, $value ) {&nbsp;</div></li><li><div>        if ( ! is_string( $value ) ) {&nbsp;</div></li><li><div>            return $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $charset = $this-&gt;get_col_charset( $table, $column );&nbsp;</div></li><li><div>        if ( ! $charset ) {&nbsp;</div></li><li><div>            // Not a string column.&nbsp;</div></li><li><div>            return $value;&nbsp;</div></li><li><div>        } elseif ( is_wp_error( $charset ) ) {&nbsp;</div></li><li><div>            // Bail on real errors.&nbsp;</div></li><li><div>            return $charset;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            $column =&gt; array(&nbsp;</div></li><li><div>                'value' =&gt; $value, &nbsp;</div></li><li><div>                'charset' =&gt; $charset, &nbsp;</div></li><li><div>                'length' =&gt; $this-&gt;get_col_length( $table, $column ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;strip_invalid_text( $data );&nbsp;</div></li><li><div>        if ( is_wp_error( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data[ $column ]['value'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Find the first table name referenced in a query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.2.0&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $query The query to search.&nbsp;</div></li><li><div>     * @return string|false $table The table name found, or false if a table couldn't be found.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_table_from_query( $query ) {&nbsp;</div></li><li><div>        // Remove characters that can legally trail the table name.&nbsp;</div></li><li><div>        $query = rtrim( $query, ';/-#' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow (select...) union [...] style queries. Use the first query's table name.&nbsp;</div></li><li><div>        $query = ltrim( $query, &quot;\r\n\t (&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Strip everything between parentheses except nested selects.&nbsp;</div></li><li><div>        $query = preg_replace( '/\((?!\s*select)[^(]*?\)/is', '()', $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Quickly match most common queries.&nbsp;</div></li><li><div>        if ( preg_match( '/^\s*(?:'&nbsp;</div></li><li><div>                . 'SELECT.*?\s+FROM'&nbsp;</div></li><li><div>                . '|INSERT(?:\s+LOW_PRIORITY|\s+DELAYED|\s+HIGH_PRIORITY)?(?:\s+IGNORE)?(?:\s+INTO)?'&nbsp;</div></li><li><div>                . '|REPLACE(?:\s+LOW_PRIORITY|\s+DELAYED)?(?:\s+INTO)?'&nbsp;</div></li><li><div>                . '|UPDATE(?:\s+LOW_PRIORITY)?(?:\s+IGNORE)?'&nbsp;</div></li><li><div>                . '|DELETE(?:\s+LOW_PRIORITY|\s+QUICK|\s+IGNORE)*(?:.+?FROM)?'&nbsp;</div></li><li><div>                . ')\s+((?:[0-9a-zA-Z$_.`-]|[\xC2-\xDF][\x80-\xBF])+)/is', $query, $maybe ) ) {&nbsp;</div></li><li><div>            return str_replace( '`', '', $maybe[1] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // SHOW TABLE STATUS and SHOW TABLES WHERE Name = 'wp_posts'&nbsp;</div></li><li><div>        if ( preg_match( '/^\s*SHOW\s+(?:TABLE\s+STATUS|(?:FULL\s+)?TABLES).+WHERE\s+Name\s*=\s*(&quot;|\')((?:[0-9a-zA-Z$_.-]|[\xC2-\xDF][\x80-\xBF])+)\\1/is', $query, $maybe ) ) {&nbsp;</div></li><li><div>            return $maybe[2];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // SHOW TABLE STATUS LIKE and SHOW TABLES LIKE 'wp\_123\_%'&nbsp;</div></li><li><div>        // This quoted LIKE operand seldom holds a full table name.&nbsp;</div></li><li><div>        // It is usually a pattern for matching a prefix so we just&nbsp;</div></li><li><div>        // strip the trailing % and unescape the _ to get 'wp_123_'&nbsp;</div></li><li><div>        // which drop-ins can use for routing these SQL statements.&nbsp;</div></li><li><div>        if ( preg_match( '/^\s*SHOW\s+(?:TABLE\s+STATUS|(?:FULL\s+)?TABLES)\s+(?:WHERE\s+Name\s+)?LIKE\s*(&quot;|\')((?:[\\\\0-9a-zA-Z$_.-]|[\xC2-\xDF][\x80-\xBF])+)%?\\1/is', $query, $maybe ) ) {&nbsp;</div></li><li><div>            return str_replace( '\\_', '_', $maybe[2] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Big pattern for the rest of the table-related queries.&nbsp;</div></li><li><div>        if ( preg_match( '/^\s*(?:'&nbsp;</div></li><li><div>                . '(?:EXPLAIN\s+(?:EXTENDED\s+)?)?SELECT.*?\s+FROM'&nbsp;</div></li><li><div>                . '|DESCRIBE|DESC|EXPLAIN|HANDLER'&nbsp;</div></li><li><div>                . '|(?:LOCK|UNLOCK)\s+TABLE(?:S)?'&nbsp;</div></li><li><div>                . '|(?:RENAME|OPTIMIZE|BACKUP|RESTORE|CHECK|CHECKSUM|ANALYZE|REPAIR).*\s+TABLE'&nbsp;</div></li><li><div>                . '|TRUNCATE(?:\s+TABLE)?'&nbsp;</div></li><li><div>                . '|CREATE(?:\s+TEMPORARY)?\s+TABLE(?:\s+IF\s+NOT\s+EXISTS)?'&nbsp;</div></li><li><div>                . '|ALTER(?:\s+IGNORE)?\s+TABLE'&nbsp;</div></li><li><div>                . '|DROP\s+TABLE(?:\s+IF\s+EXISTS)?'&nbsp;</div></li><li><div>                . '|CREATE(?:\s+\w+)?\s+INDEX.*\s+ON'&nbsp;</div></li><li><div>                . '|DROP\s+INDEX.*\s+ON'&nbsp;</div></li><li><div>                . '|LOAD\s+DATA.*INFILE.*INTO\s+TABLE'&nbsp;</div></li><li><div>                . '|(?:GRANT|REVOKE).*ON\s+TABLE'&nbsp;</div></li><li><div>                . '|SHOW\s+(?:.*FROM|.*TABLE)'&nbsp;</div></li><li><div>                . ')\s+\(*\s*((?:[0-9a-zA-Z$_.`-]|[\xC2-\xDF][\x80-\xBF])+)\s*\)*/is', $query, $maybe ) ) {&nbsp;</div></li><li><div>            return str_replace( '`', '', $maybe[1] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load the column metadata from the last query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access protected&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function load_col_info() {&nbsp;</div></li><li><div>        if ( $this-&gt;col_info )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            $num_fields = mysqli_num_fields( $this-&gt;result );&nbsp;</div></li><li><div>            for ( $i = 0; $i &lt; $num_fields; $i++ ) {&nbsp;</div></li><li><div>                $this-&gt;col_info[ $i ] = mysqli_fetch_field( $this-&gt;result );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $num_fields = mysql_num_fields( $this-&gt;result );&nbsp;</div></li><li><div>            for ( $i = 0; $i &lt; $num_fields; $i++ ) {&nbsp;</div></li><li><div>                $this-&gt;col_info[ $i ] = mysql_fetch_field( $this-&gt;result, $i );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve column metadata from the last query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 0.71&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $info_type  Optional. Type one of name, table, def, max_length, not_null, primary_key, multiple_key, unique_key, numeric, blob, type, unsigned, zerofill&nbsp;</div></li><li><div>     * @param int    $col_offset Optional. 0: col name. 1: which table the col's in. 2: col's max length. 3: if the col is numeric. 4: col's type&nbsp;</div></li><li><div>     * @return mixed Column Results&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_col_info( $info_type = 'name', $col_offset = -1 ) {&nbsp;</div></li><li><div>        $this-&gt;load_col_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;col_info ) {&nbsp;</div></li><li><div>            if ( $col_offset == -1 ) {&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                $new_array = array();&nbsp;</div></li><li><div>                foreach ( (array) $this-&gt;col_info as $col ) {&nbsp;</div></li><li><div>                    $new_array[$i] = $col-&gt;{$info_type};&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return $new_array;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return $this-&gt;col_info[$col_offset]-&gt;{$info_type};&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Starts the timer, for debugging purposes.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return true&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function timer_start() {&nbsp;</div></li><li><div>        $this-&gt;time_start = microtime( true );&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stops the debugging timer.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return float Total time spent on the query, in seconds&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function timer_stop() {&nbsp;</div></li><li><div>        return ( microtime( true ) - $this-&gt;time_start );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Wraps errors in a nice header and footer and dies.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Will not die if wpdb::$show_errors is false.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $message    The Error message&nbsp;</div></li><li><div>     * @param string $error_code Optional. A Computer readable string to identify the error.&nbsp;</div></li><li><div>     * @return false|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function bail( $message, $error_code = '500' ) {&nbsp;</div></li><li><div>        if ( !$this-&gt;show_errors ) {&nbsp;</div></li><li><div>            if ( class_exists( 'WP_Error', false ) ) {&nbsp;</div></li><li><div>                $this-&gt;error = new WP_Error($error_code, $message);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;error = $message;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die($message);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Closes the current database connection.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 4.5.0&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool True if the connection was successfully closed, false if it wasn't, &nbsp;</div></li><li><div>     *              or the connection doesn't exist.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function close() {&nbsp;</div></li><li><div>        if ( ! $this-&gt;dbh ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            $closed = mysqli_close( $this-&gt;dbh );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $closed = mysql_close( $this-&gt;dbh );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $closed ) {&nbsp;</div></li><li><div>            $this-&gt;dbh = null;&nbsp;</div></li><li><div>            $this-&gt;ready = false;&nbsp;</div></li><li><div>            $this-&gt;has_connected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $closed;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether MySQL database is at least the required minimum version.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @global string $wp_version&nbsp;</div></li><li><div>     * @global string $required_mysql_version&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return WP_Error|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function check_database_version() {&nbsp;</div></li><li><div>        global $wp_version, $required_mysql_version;&nbsp;</div></li><li><div>        // Make sure the server has the required MySQL version&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;db_version(), $required_mysql_version, '&lt;') ) {&nbsp;</div></li><li><div>            /** translators: 1: WordPress version number, 2: Minimum required MySQL version number */&nbsp;</div></li><li><div>            return new WP_Error('database_version', sprintf( __( '&lt;strong&gt;ERROR&lt;/strong&gt;: WordPress %1$s requires MySQL %2$s or higher' ), $wp_version, $required_mysql_version ));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Whether the database supports collation.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Called when WordPress is generating the table scheme.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Use `wpdb::has_cap( 'collation' )`.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @deprecated 3.5.0 Use wpdb::has_cap()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool True if collation is supported, false if version does not&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function supports_collation() {&nbsp;</div></li><li><div>        _deprecated_function( __FUNCTION__, '3.5.0', 'wpdb::has_cap( \'collation\' )' );&nbsp;</div></li><li><div>        return $this-&gt;has_cap( 'collation' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * The database character collate.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string The database character collate.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_charset_collate() {&nbsp;</div></li><li><div>        $charset_collate = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;charset ) )&nbsp;</div></li><li><div>            $charset_collate = &quot;DEFAULT CHARACTER SET $this-&gt;charset&quot;;&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;collate ) )&nbsp;</div></li><li><div>            $charset_collate .= &quot; COLLATE $this-&gt;collate&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $charset_collate;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determine if a database supports a particular feature.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.7.0&nbsp;</div></li><li><div>     * @since 4.1.0 Added support for the 'utf8mb4' feature.&nbsp;</div></li><li><div>     * @since 4.6.0 Added support for the 'utf8mb4_520' feature.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see wpdb::db_version()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $db_cap The feature to check for. Accepts 'collation', &nbsp;</div></li><li><div>     *                       'group_concat', 'subqueries', 'set_charset', &nbsp;</div></li><li><div>     *                       or 'utf8mb4'.&nbsp;</div></li><li><div>     * @return int|false Whether the database feature is supported, false otherwise.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function has_cap( $db_cap ) {&nbsp;</div></li><li><div>        $version = $this-&gt;db_version();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( strtolower( $db_cap ) ) {&nbsp;</div></li><li><div>            case 'collation' :    // @since 2.5.0&nbsp;</div></li><li><div>            case 'group_concat' : // @since 2.7.0&nbsp;</div></li><li><div>            case 'subqueries' :   // @since 2.7.0&nbsp;</div></li><li><div>                return version_compare( $version, '4.1', '&gt;=' );&nbsp;</div></li><li><div>            case 'set_charset' :&nbsp;</div></li><li><div>                return version_compare( $version, '5.0.7', '&gt;=' );&nbsp;</div></li><li><div>            case 'utf8mb4' :      // @since 4.1.0&nbsp;</div></li><li><div>                if ( version_compare( $version, '5.5.3', '&lt;' ) ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>                    $client_version = mysqli_get_client_info();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $client_version = mysql_get_client_info();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * libmysql has supported utf8mb4 since 5.5.3, same as the MySQL server.&nbsp;</div></li><li><div>                 * mysqlnd has supported utf8mb4 since 5.0.9.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                if ( false !== strpos( $client_version, 'mysqlnd' ) ) {&nbsp;</div></li><li><div>                    $client_version = preg_replace( '/^\D+([\d.]+).*/', '$1', $client_version );&nbsp;</div></li><li><div>                    return version_compare( $client_version, '5.0.9', '&gt;=' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    return version_compare( $client_version, '5.5.3', '&gt;=' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            case 'utf8mb4_520' : // @since 4.6.0&nbsp;</div></li><li><div>                return version_compare( $version, '5.6', '&gt;=' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the name of the function that called wpdb.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Searches up the list of functions until it reaches&nbsp;</div></li><li><div>     * the one that would most logically had called this method.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string|array The name of the calling function&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_caller() {&nbsp;</div></li><li><div>        return wp_debug_backtrace_summary( __CLASS__ );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the MySQL server version.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.7.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null|string Null on failure, version number on success.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function db_version() {&nbsp;</div></li><li><div>        if ( $this-&gt;use_mysqli ) {&nbsp;</div></li><li><div>            $server_info = mysqli_get_server_info( $this-&gt;dbh );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $server_info = mysql_get_server_info( $this-&gt;dbh );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return preg_replace( '/[^0-9.].*/', '', $server_info );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 0.71</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/4.7.4/classes/wpdb/" class="">4.7.4</a></li><li><a href="http://hookr.io/4.7.3/classes/wpdb/" class="">4.7.3</a></li><li><a href="http://hookr.io/4.7.2/classes/wpdb/" class="">4.7.2</a></li><li><a href="http://hookr.io/4.7.1/classes/wpdb/" class="">4.7.1</a></li><li><a href="http://hookr.io/4.7/classes/wpdb/" class="active">4.7</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>class</li><li><span></span>wpdb</li><li><span></span>wp-include</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>