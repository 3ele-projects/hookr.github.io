<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="wordpress" data-version="4.7.3" data-type="file" data-id="4431"><head xmlns="http://www.w3.org/1999/xhtml"><title> wp-admin-includes-ajax-actions | file | WordPress | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, wordpress, 4.7.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d24bf1cb16c815e070f530f3f826197a' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wp-admin-includes-ajax-actions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-ajax-actions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwp-admin-includes-ajax-actions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"wordpress-4.7.3-file-wp-admin-includes-ajax-actions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wp-admin-includes-ajax-actions" class="blog single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.7.3." href="http://hookr.io/4.7.3/" class="H_VERSION"><span property="name">4.7.3</span></a><meta property="position" content="2"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wp-admin-includes-ajax-actions</span><meta property="position" content="3"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6309"><a href="http://hookr.io/4.7.3/all/" title="All">All <span class="count badge">6309</span></a></li><li class="" data-id="new" data-count="1"><a href="http://hookr.io/4.7.3/new/" title="New">New <span class="count badge">1</span></a></li><li class="" data-id="hooks" data-count="2532"><a href="http://hookr.io/4.7.3/hooks/" title="Hooks">Hooks <span class="count badge">2532</span></a></li><li class="" data-id="action" data-count="864"><a href="http://hookr.io/4.7.3/actions/" title="Actions">Actions <span class="count badge">864</span></a></li><li class="" data-id="filter" data-count="1668"><a href="http://hookr.io/4.7.3/filters/" title="Filters">Filters <span class="count badge">1668</span></a></li><li class="" data-id="class" data-count="351"><a href="http://hookr.io/4.7.3/classes/" title="Classes">Classes <span class="count badge">351</span></a></li><li class="" data-id="constant" data-count="566"><a href="http://hookr.io/4.7.3/constants/" title="Constants">Constants <span class="count badge">566</span></a></li><li class="" data-id="function" data-count="2852"><a href="http://hookr.io/4.7.3/functions/" title="Functions">Functions <span class="count badge">2852</span></a></li><li class="" data-id="shortcode" data-count="8"><a href="http://hookr.io/4.7.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">8</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class="active"><a href="http://hookr.io/all/" title="Core">Core</a></li><li class=""><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wp-admin/includes/ajax-actions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Administration API: Core Ajax handlers</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package WordPress</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage Administration</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">// No-privilege Ajax handlers.</span>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for the Heartbeat API in</span>&nbsp;</div></li><li><div><span class="comment"> * the no-privilege context.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Runs when the user is not logged in.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_nopriv_heartbeat() {&nbsp;</div></li><li><div>  $response = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// screen_id is the same as $current_screen-&gt;id and the JS global 'pagenow'.</span></span>&nbsp;</div></li><li><div>  if ( ! empty($_POST['screen_id']) )&nbsp;</div></li><li><div>      $screen_id = sanitize_key($_POST['screen_id']);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $screen_id = 'front';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty($_POST['data']) ) {&nbsp;</div></li><li><div>      $data = wp_unslash( (array) $_POST['data'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters Heartbeat Ajax response in no-privilege environments.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array|object $response  The no-priv Heartbeat response object or array.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array        $data      An array of data passed via $_POST.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string       $screen_id The screen id.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $response = apply_filters( 'heartbeat_nopriv_received', $response, $data, $screen_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters Heartbeat Ajax response when no data is passed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|object $response  The Heartbeat response object or array.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $screen_id The screen id.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $response = apply_filters( 'heartbeat_nopriv_send', $response, $screen_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when Heartbeat ticks in no-privilege environments.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Allows the transport to be easily replaced with long-polling.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|object $response  The no-priv Heartbeat response.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string       $screen_id The screen id.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'heartbeat_nopriv_tick', $response, $screen_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Send the current time according to the server</span>.</span>&nbsp;</div></li><li><div>  $response['server_time'] = time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json($response);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>// GET-based Ajax handlers.&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for fetching a list table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_fetch_list() {&nbsp;</div></li><li><div>  $list_class = $_GET['list_args']['class'];&nbsp;</div></li><li><div>  check_ajax_referer( &quot;fetch-list-$list_class&quot;, '_ajax_fetch_list_nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( $list_class, array( 'screen' =&gt; $_GET['list_args']['screen']['id'] ) );&nbsp;</div></li><li><div>  if ( ! $wp_list_table ) {&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $wp_list_table-&gt;ajax_user_can() ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table-&gt;ajax_response();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for tag search.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_ajax_tag_search() {&nbsp;</div></li><li><div>  if ( ! isset( $_GET['tax'] ) ) {&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $taxonomy = sanitize_key( $_GET['tax'] );&nbsp;</div></li><li><div>  $tax = get_taxonomy( $taxonomy );&nbsp;</div></li><li><div>  if ( ! $tax ) {&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( $tax-&gt;cap-&gt;assign_terms ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $s = wp_unslash( $_GET['q'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comma = _x( ', ', 'tag delimiter' );&nbsp;</div></li><li><div>  if ( ', ' !== $comma )&nbsp;</div></li><li><div>      $s = str_replace( $comma, ', ', $s );&nbsp;</div></li><li><div>  if ( false !== strpos( $s, ', ' ) ) {&nbsp;</div></li><li><div>      $s = explode( ', ', $s );&nbsp;</div></li><li><div>      $s = $s[count( $s ) - 1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $s = trim( $s );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the minimum number of characters required to fire a tag search via Ajax.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int         $characters The minimum number of characters required. Default 2.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Taxonomy $tax        The taxonomy object.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string      $s          The search term.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $term_search_min_chars = (int) apply_filters( 'term_search_min_chars', 2, $tax, $s );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Require $term_search_min_chars chars for matching (default: 2)</span>&nbsp;</div></li><li><div><span class="comment">   * ensure it's a non-negative, non-zero integer.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( ( $term_search_min_chars == 0 ) || ( strlen( $s ) &lt; $term_search_min_chars ) ) {&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $results = get_terms( $taxonomy, array( 'name__like' =&gt; $s, 'fields' =&gt; 'names', 'hide_empty' =&gt; false ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo join( $results, &quot;\n&quot; );&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for compression testing.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_wp_compression_test() {&nbsp;</div></li><li><div>  if ( !current_user_can( 'manage_options' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ini_get('zlib.output_compression') || 'ob_gzhandler' == ini_get('output_handler') ) {&nbsp;</div></li><li><div>      update_site_option('can_compress_scripts', 0);&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_GET['test']) ) {&nbsp;</div></li><li><div>      header( 'Expires: Wed, 11 Jan 1984 05:00:00 GMT' );&nbsp;</div></li><li><div>      header( 'Last-Modified: ' . gmdate( 'D, d M Y H:i:s' ) . ' GMT' );&nbsp;</div></li><li><div>      header( 'Cache-Control: no-cache, must-revalidate, max-age=0' );&nbsp;</div></li><li><div>      header('Content-Type: application/javascript; charset=UTF-8');&nbsp;</div></li><li><div>      $force_gzip = ( defined('ENFORCE_GZIP') && ENFORCE_GZIP );&nbsp;</div></li><li><div>      $test_str = '&quot;wpCompressionTest Lorem ipsum dolor sit amet consectetuer mollis sapien urna ut a. Eu nonummy condimentum fringilla tempor pretium platea vel nibh netus Maecenas. Hac molestie amet justo quis pellentesque est ultrices interdum nibh Morbi. Cras mattis pretium Phasellus ante ipsum ipsum ut sociis Suspendisse Lorem. Ante et non molestie. Porta urna Vestibulum egestas id congue nibh eu risus gravida sit. Ac augue auctor Ut et non a elit massa id sodales. Elit eu Nulla at nibh adipiscing mattis lacus mauris at tempus. Netus nibh quis suscipit nec feugiat eget sed lorem et urna. Pellentesque lacus at ut massa consectetuer ligula ut auctor semper Pellentesque. Ut metus massa nibh quam Curabitur molestie nec mauris congue. Volutpat molestie elit justo facilisis neque ac risus Ut nascetur tristique. Vitae sit lorem tellus et quis Phasellus lacus tincidunt nunc Fusce. Pharetra wisi Suspendisse mus sagittis libero lacinia Integer consequat ac Phasellus. Et urna ac cursus tortor aliquam Aliquam amet tellus volutpat Vestibulum. Justo interdum condimentum In augue congue tellus sollicitudin Quisque quis nibh.&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>       if ( 1 == $_GET['test'] ) {&nbsp;</div></li><li><div>           echo $test_str;&nbsp;</div></li><li><div>           wp_die();&nbsp;</div></li><li><div>       } elseif ( 2 == $_GET['test'] ) {&nbsp;</div></li><li><div>          if ( !isset($_SERVER['HTTP_ACCEPT_ENCODING']) )&nbsp;</div></li><li><div>              wp_die( -1 );&nbsp;</div></li><li><div>          if ( false !== stripos( $_SERVER['HTTP_ACCEPT_ENCODING'], 'deflate') && function_exists('gzdeflate') && ! $force_gzip ) {&nbsp;</div></li><li><div>              header('Content-Encoding: deflate');&nbsp;</div></li><li><div>              $out = gzdeflate( $test_str, 1 );&nbsp;</div></li><li><div>          } elseif ( false !== stripos( $_SERVER['HTTP_ACCEPT_ENCODING'], 'gzip') && function_exists('gzencode') ) {&nbsp;</div></li><li><div>              header('Content-Encoding: gzip');&nbsp;</div></li><li><div>              $out = gzencode( $test_str, 1 );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wp_die( -1 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo $out;&nbsp;</div></li><li><div>          wp_die();&nbsp;</div></li><li><div>      } elseif ( 'no' == $_GET['test'] ) {&nbsp;</div></li><li><div>          check_ajax_referer( 'update_can_compress_scripts' );&nbsp;</div></li><li><div>          update_site_option('can_compress_scripts', 0);&nbsp;</div></li><li><div>      } elseif ( 'yes' == $_GET['test'] ) {&nbsp;</div></li><li><div>          check_ajax_referer( 'update_can_compress_scripts' );&nbsp;</div></li><li><div>          update_site_option('can_compress_scripts', 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for image editor previews.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_imgedit_preview() {&nbsp;</div></li><li><div>  $post_id = intval($_GET['postid']);&nbsp;</div></li><li><div>  if ( empty($post_id) || !current_user_can('edit_post', $post_id) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;image_editor-$post_id&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/image-edit.php' );&nbsp;</div></li><li><div>  if ( ! stream_preview_image($post_id) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for oEmbed caching.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Embed $wp_embed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_oembed_cache() {&nbsp;</div></li><li><div>  $GLOBALS['wp_embed']-&gt;cache_oembed( $_GET['post'] );&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for user autocomplete.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_autocomplete_user() {&nbsp;</div></li><li><div>  if ( ! is_multisite() || ! current_user_can( 'promote_users' ) || wp_is_large_network( 'users' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** This filter is documented in wp-admin/user-new.php */</span>&nbsp;</div></li><li><div>  if ( ! is_super_admin() && ! apply_filters( 'autocomplete_users_for_site_admins', false ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the type of request</span>&nbsp;</div></li><li><div>  <span class="comment">// Current allowed values are `add` and `search`</span>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['autocomplete_type'] ) && 'search' === $_REQUEST['autocomplete_type'] ) {&nbsp;</div></li><li><div>      $type = $_REQUEST['autocomplete_type'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $type = 'add';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the desired field for value</span>&nbsp;</div></li><li><div>  <span class="comment">// Current allowed values are `user_email` and `user_login`</span>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['autocomplete_field'] ) && 'user_email' === $_REQUEST['autocomplete_field'] ) {&nbsp;</div></li><li><div>      $field = $_REQUEST['autocomplete_field'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $field = 'user_login';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Exclude current users of this blog</span>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['site_id'] ) ) {&nbsp;</div></li><li><div>      $id = absint( $_REQUEST['site_id'] );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $id = get_current_blog_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $include_blog_users = ( $type == 'search' ? get_users( array( 'blog_id' =&gt; $id, 'fields' =&gt; 'ID' ) ) : array() );&nbsp;</div></li><li><div>  $exclude_blog_users = ( $type == 'add' ? get_users( array( 'blog_id' =&gt; $id, 'fields' =&gt; 'ID' ) ) : array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $users = get_users( array(&nbsp;</div></li><li><div>      'blog_id' =&gt; false, &nbsp;</div></li><li><div>      'search' =&gt; '*' . $_REQUEST['term'] . '*', &nbsp;</div></li><li><div>      'include' =&gt; $include_blog_users, &nbsp;</div></li><li><div>      'exclude' =&gt; $exclude_blog_users, &nbsp;</div></li><li><div>      'search_columns' =&gt; array( 'user_login', 'user_nicename', 'user_email' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $users as $user ) {&nbsp;</div></li><li><div>      $return[] = array(&nbsp;</div></li><li><div>          <span class="comment">/** translators: 1: user_login, 2: user_email */</span>&nbsp;</div></li><li><div>          'label' =&gt; sprintf( _x( '%1$s (%2$s)', 'user autocomplete result' ), $user-&gt;user_login, $user-&gt;user_email ), &nbsp;</div></li><li><div>          'value' =&gt; $user-&gt;$field, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( wp_json_encode( $return ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for dashboard widgets.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_dashboard_widgets() {&nbsp;</div></li><li><div>  require_once ABSPATH . 'wp-admin/includes/dashboard.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pagenow = $_GET['pagenow'];&nbsp;</div></li><li><div>  if ( $pagenow === 'dashboard-user' || $pagenow === 'dashboard-network' || $pagenow === 'dashboard' ) {&nbsp;</div></li><li><div>      set_current_screen( $pagenow );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $_GET['widget'] ) {&nbsp;</div></li><li><div>      case 'dashboard_primary' :&nbsp;</div></li><li><div>          wp_dashboard_primary();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for Customizer preview logged-in status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_logged_in() {&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>// Ajax helpers.&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sends back current comment total and new page links if they need to be updated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Contrary to normal success Ajax response (&quot;1&quot;), die with time() on success.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $comment_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $delta</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wp_ajax_delete_comment_response( $comment_id, $delta = -1 ) {&nbsp;</div></li><li><div>  $total = isset( $_POST['_total'] )    ? (int) $_POST['_total']    : 0;&nbsp;</div></li><li><div>  $per_page = isset( $_POST['_per_page'] ) ? (int) $_POST['_per_page'] : 0;&nbsp;</div></li><li><div>  $page = isset( $_POST['_page'] )     ? (int) $_POST['_page']     : 0;&nbsp;</div></li><li><div>  $url = isset( $_POST['_url'] )      ? esc_url_raw( $_POST['_url'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// JS didn't send us everything we need to know. Just die with success message</span>&nbsp;</div></li><li><div>  if ( ! $total || ! $per_page || ! $page || ! $url ) {&nbsp;</div></li><li><div>      $time = time();&nbsp;</div></li><li><div>      $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>      $comment_status = '';&nbsp;</div></li><li><div>      $comment_link = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $comment ) {&nbsp;</div></li><li><div>          $comment_status = $comment-&gt;comment_approved;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 1 === (int) $comment_status ) {&nbsp;</div></li><li><div>          $comment_link = get_comment_link( $comment );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $counts = wp_count_comments();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>          'what' =&gt; 'comment', &nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Here for completeness - not used.</span></span>&nbsp;</div></li><li><div>          'id' =&gt; $comment_id, &nbsp;</div></li><li><div>          'supplemental' =&gt; array(&nbsp;</div></li><li><div>              'status' =&gt; $comment_status, &nbsp;</div></li><li><div>              'postId' =&gt; $comment ? $comment-&gt;comment_post_ID : '', &nbsp;</div></li><li><div>              'time' =&gt; $time, &nbsp;</div></li><li><div>              'in_moderation' =&gt; $counts-&gt;moderated, &nbsp;</div></li><li><div>              'i18n_comments_text' =&gt; sprintf(&nbsp;</div></li><li><div>                  _n( '%s Comment', '%s Comments', $counts-&gt;approved ), &nbsp;</div></li><li><div>                  number_format_i18n( $counts-&gt;approved )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'i18n_moderation_text' =&gt; sprintf(&nbsp;</div></li><li><div>                  _nx( '%s in moderation', '%s in moderation', $counts-&gt;moderated, 'comments' ), &nbsp;</div></li><li><div>                  number_format_i18n( $counts-&gt;moderated )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'comment_link' =&gt; $comment_link, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $x-&gt;send();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $total += $delta;&nbsp;</div></li><li><div>  if ( $total &lt; 0 )&nbsp;</div></li><li><div>      $total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only do the expensive stuff on a page-break, and about 1 other time per page</span>&nbsp;</div></li><li><div>  if ( 0 == $total % $per_page || 1 == mt_rand( 1, $per_page ) ) {&nbsp;</div></li><li><div>      $post_id = 0;&nbsp;</div></li><li><div>      <span class="comment">// What type of comment count are we looking for?</span>&nbsp;</div></li><li><div>      $status = 'all';&nbsp;</div></li><li><div>      $parsed = parse_url( $url );&nbsp;</div></li><li><div>      if ( isset( $parsed['query'] ) ) {&nbsp;</div></li><li><div>          parse_str( $parsed['query'], $query_vars );&nbsp;</div></li><li><div>          if ( !empty( $query_vars['comment_status'] ) )&nbsp;</div></li><li><div>              $status = $query_vars['comment_status'];&nbsp;</div></li><li><div>          if ( !empty( $query_vars['p'] ) )&nbsp;</div></li><li><div>              $post_id = (int) $query_vars['p'];&nbsp;</div></li><li><div>          if ( ! empty( $query_vars['comment_type'] ) )&nbsp;</div></li><li><div>              $type = $query_vars['comment_type'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $type ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Only use the comment count if not filtering by a comment_type.</span>&nbsp;</div></li><li><div>          $comment_count = wp_count_comments($post_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// We're looking for a known type of comment count.</span>&nbsp;</div></li><li><div>          if ( isset( $comment_count-&gt;$status ) ) {&nbsp;</div></li><li><div>              $total = $comment_count-&gt;$status;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Else use the decremented value from above.</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// The time since the last comment count.</span>&nbsp;</div></li><li><div>  $time = time();&nbsp;</div></li><li><div>  $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>      'what' =&gt; 'comment', &nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Here for completeness - not used.</span></span>&nbsp;</div></li><li><div>      'id' =&gt; $comment_id, &nbsp;</div></li><li><div>      'supplemental' =&gt; array(&nbsp;</div></li><li><div>          'status' =&gt; $comment ? $comment-&gt;comment_approved : '', &nbsp;</div></li><li><div>          'postId' =&gt; $comment ? $comment-&gt;comment_post_ID : '', &nbsp;</div></li><li><div>          'total_items_i18n' =&gt; sprintf( _n( '%s item', '%s items', $total ), number_format_i18n( $total ) ), &nbsp;</div></li><li><div>          'total_pages' =&gt; ceil( $total / $per_page ), &nbsp;</div></li><li><div>          'total_pages_i18n' =&gt; number_format_i18n( ceil( $total / $per_page ) ), &nbsp;</div></li><li><div>          'total' =&gt; $total, &nbsp;</div></li><li><div>          'time' =&gt; $time&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>// POST-based Ajax handlers.&nbsp;</div></li><li><div><span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for adding a hierarchical term.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wp_ajax_add_hierarchical_term() {&nbsp;</div></li><li><div>  $action = $_POST['action'];&nbsp;</div></li><li><div>  $taxonomy = get_taxonomy(substr($action, 4));&nbsp;</div></li><li><div>  check_ajax_referer( $action, '_ajax_nonce-add-' . $taxonomy-&gt;name );&nbsp;</div></li><li><div>  if ( !current_user_can( $taxonomy-&gt;cap-&gt;edit_terms ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  $names = explode(', ', $_POST['new'.$taxonomy-&gt;name]);&nbsp;</div></li><li><div>  $parent = isset($_POST['new'.$taxonomy-&gt;name.'_parent']) ? (int) $_POST['new'.$taxonomy-&gt;name.'_parent'] : 0;&nbsp;</div></li><li><div>  if ( 0 &gt; $parent )&nbsp;</div></li><li><div>      $parent = 0;&nbsp;</div></li><li><div>  if ( $taxonomy-&gt;name == 'category' )&nbsp;</div></li><li><div>      $post_category = isset($_POST['post_category']) ? (array) $_POST['post_category'] : array();&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $post_category = ( isset($_POST['tax_input']) && isset($_POST['tax_input'][$taxonomy-&gt;name]) ) ? (array) $_POST['tax_input'][$taxonomy-&gt;name] : array();&nbsp;</div></li><li><div>  $checked_categories = array_map( 'absint', (array) $post_category );&nbsp;</div></li><li><div>  $popular_ids = wp_popular_terms_checklist($taxonomy-&gt;name, 0, 10, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $names as $cat_name ) {&nbsp;</div></li><li><div>      $cat_name = trim($cat_name);&nbsp;</div></li><li><div>      $category_nicename = sanitize_title($cat_name);&nbsp;</div></li><li><div>      if ( '' === $category_nicename )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( !$cat_id = term_exists( $cat_name, $taxonomy-&gt;name, $parent ) )&nbsp;</div></li><li><div>          $cat_id = wp_insert_term( $cat_name, $taxonomy-&gt;name, array( 'parent' =&gt; $parent ) );&nbsp;</div></li><li><div>      if ( is_wp_error( $cat_id ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      } elseif ( is_array( $cat_id ) ) {&nbsp;</div></li><li><div>          $cat_id = $cat_id['term_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $checked_categories[] = $cat_id;&nbsp;</div></li><li><div>      if ( $parent ) <span class="comment">// Do these all at once in a second</span>&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_terms_checklist( 0, array( 'taxonomy' =&gt; $taxonomy-&gt;name, 'descendants_and_self' =&gt; $cat_id, 'selected_cats' =&gt; $checked_categories, 'popular_cats' =&gt; $popular_ids ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $add = array(&nbsp;</div></li><li><div>          'what' =&gt; $taxonomy-&gt;name, &nbsp;</div></li><li><div>          'id' =&gt; $cat_id, &nbsp;</div></li><li><div>          'data' =&gt; str_replace( array(&quot;\n&quot;, &quot;\t&quot;), '', $data), &nbsp;</div></li><li><div>          'position' =&gt; -1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $parent ) { <span class="comment">// Foncy - replace the parent and all its children</span>&nbsp;</div></li><li><div>      $parent = get_term( $parent, $taxonomy-&gt;name );&nbsp;</div></li><li><div>      $term_id = $parent-&gt;term_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ( $parent-&gt;parent ) { <span class="comment">// get the top parent</span>&nbsp;</div></li><li><div>          $parent = get_term( $parent-&gt;parent, $taxonomy-&gt;name );&nbsp;</div></li><li><div>          if ( is_wp_error( $parent ) )&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          $term_id = $parent-&gt;term_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_terms_checklist( 0, array('taxonomy' =&gt; $taxonomy-&gt;name, 'descendants_and_self' =&gt; $term_id, 'selected_cats' =&gt; $checked_categories, 'popular_cats' =&gt; $popular_ids));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $add = array(&nbsp;</div></li><li><div>          'what' =&gt; $taxonomy-&gt;name, &nbsp;</div></li><li><div>          'id' =&gt; $term_id, &nbsp;</div></li><li><div>          'data' =&gt; str_replace( array(&quot;\n&quot;, &quot;\t&quot;), '', $data), &nbsp;</div></li><li><div>          'position' =&gt; -1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_dropdown_categories( array(&nbsp;</div></li><li><div>      'taxonomy' =&gt; $taxonomy-&gt;name, 'hide_empty' =&gt; 0, 'name' =&gt; 'new'.$taxonomy-&gt;name.'_parent', 'orderby' =&gt; 'name', &nbsp;</div></li><li><div>      'hierarchical' =&gt; 1, 'show_option_none' =&gt; '&mdash; '.$taxonomy-&gt;labels-&gt;parent_item.' &mdash;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sup = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $add['supplemental'] = array( 'newcat_parent' =&gt; $sup );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response( $add );&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting a comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_comment() {&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$comment = get_comment( $id ) )&nbsp;</div></li><li><div>      wp_die( time() );&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_comment', $comment-&gt;comment_ID ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;delete-comment_$id&quot; );&nbsp;</div></li><li><div>  $status = wp_get_comment_status( $comment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $delta = -1;&nbsp;</div></li><li><div>  if ( isset($_POST['trash']) && 1 == $_POST['trash'] ) {&nbsp;</div></li><li><div>      if ( 'trash' == $status )&nbsp;</div></li><li><div>          wp_die( time() );&nbsp;</div></li><li><div>      $r = wp_trash_comment( $comment );&nbsp;</div></li><li><div>  } elseif ( isset($_POST['untrash']) && 1 == $_POST['untrash'] ) {&nbsp;</div></li><li><div>      if ( 'trash' != $status )&nbsp;</div></li><li><div>          wp_die( time() );&nbsp;</div></li><li><div>      $r = wp_untrash_comment( $comment );&nbsp;</div></li><li><div>      if ( ! isset( $_POST['comment_status'] ) || $_POST['comment_status'] != 'trash' ) <span class="comment">// undo trash, not in trash</span>&nbsp;</div></li><li><div>          $delta = 1;&nbsp;</div></li><li><div>  } elseif ( isset($_POST['spam']) && 1 == $_POST['spam'] ) {&nbsp;</div></li><li><div>      if ( 'spam' == $status )&nbsp;</div></li><li><div>          wp_die( time() );&nbsp;</div></li><li><div>      $r = wp_spam_comment( $comment );&nbsp;</div></li><li><div>  } elseif ( isset($_POST['unspam']) && 1 == $_POST['unspam'] ) {&nbsp;</div></li><li><div>      if ( 'spam' != $status )&nbsp;</div></li><li><div>          wp_die( time() );&nbsp;</div></li><li><div>      $r = wp_unspam_comment( $comment );&nbsp;</div></li><li><div>      if ( ! isset( $_POST['comment_status'] ) || $_POST['comment_status'] != 'spam' ) <span class="comment">// undo spam, not in spam</span>&nbsp;</div></li><li><div>          $delta = 1;&nbsp;</div></li><li><div>  } elseif ( isset($_POST['delete']) && 1 == $_POST['delete'] ) {&nbsp;</div></li><li><div>      $r = wp_delete_comment( $comment );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $r ) <span class="comment"><span class="comment">// Decide if we need to send back '1' or a more complicated response including page links and comment counts</span></span>&nbsp;</div></li><li><div>      _wp_ajax_delete_comment_response( $comment-&gt;comment_ID, $delta );&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting a tag.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_tag() {&nbsp;</div></li><li><div>  $tag_id = (int) $_POST['tag_ID'];&nbsp;</div></li><li><div>  check_ajax_referer( &quot;delete-tag_$tag_id&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'delete_term', $tag_id ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $taxonomy = !empty($_POST['taxonomy']) ? $_POST['taxonomy'] : 'post_tag';&nbsp;</div></li><li><div>  $tag = get_term( $tag_id, $taxonomy );&nbsp;</div></li><li><div>  if ( !$tag || is_wp_error( $tag ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wp_delete_term($tag_id, $taxonomy))&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting a link.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_link() {&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;delete-bookmark_$id&quot; );&nbsp;</div></li><li><div>  if ( !current_user_can( 'manage_links' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $link = get_bookmark( $id );&nbsp;</div></li><li><div>  if ( !$link || is_wp_error( $link ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wp_delete_link( $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting meta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_meta() {&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;delete-meta_$id&quot; );&nbsp;</div></li><li><div>  if ( !$meta = get_metadata_by_mid( 'post', $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_protected_meta( $meta-&gt;meta_key, 'post' ) || ! current_user_can( 'delete_post_meta', $meta-&gt;post_id, $meta-&gt;meta_key ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  if ( delete_meta( $meta-&gt;meta_id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting a post.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_post( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) )&nbsp;</div></li><li><div>      $action = 'delete-post';&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;{$action}_$id&quot; );&nbsp;</div></li><li><div>  if ( !current_user_can( 'delete_post', $id ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !get_post( $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wp_delete_post( $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for sending a post to the trash.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_trash_post( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) )&nbsp;</div></li><li><div>      $action = 'trash-post';&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;{$action}_$id&quot; );&nbsp;</div></li><li><div>  if ( !current_user_can( 'delete_post', $id ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !get_post( $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'trash-post' == $action )&nbsp;</div></li><li><div>      $done = wp_trash_post( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $done = wp_untrash_post( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $done )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler to restore a post from the trash.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_untrash_post( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) )&nbsp;</div></li><li><div>      $action = 'untrash-post';&nbsp;</div></li><li><div>  wp_ajax_trash_post( $action );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_page( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) )&nbsp;</div></li><li><div>      $action = 'delete-page';&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;{$action}_$id&quot; );&nbsp;</div></li><li><div>  if ( !current_user_can( 'delete_page', $id ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! get_post( $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wp_delete_post( $id ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler to dim a comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_dim_comment() {&nbsp;</div></li><li><div>  $id = isset( $_POST['id'] ) ? (int) $_POST['id'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$comment = get_comment( $id ) ) {&nbsp;</div></li><li><div>      $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>          'what' =&gt; 'comment', &nbsp;</div></li><li><div>          'id' =&gt; new WP_Error('invalid_comment', sprintf(__('Comment %d does not exist'), $id))&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $x-&gt;send();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_comment', $comment-&gt;comment_ID ) && ! current_user_can( 'moderate_comments' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current = wp_get_comment_status( $comment );&nbsp;</div></li><li><div>  if ( isset( $_POST['new'] ) && $_POST['new'] == $current )&nbsp;</div></li><li><div>      wp_die( time() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;approve-comment_$id&quot; );&nbsp;</div></li><li><div>  if ( in_array( $current, array( 'unapproved', 'spam' ) ) ) {&nbsp;</div></li><li><div>      $result = wp_set_comment_status( $comment, 'approve', true );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $result = wp_set_comment_status( $comment, 'hold', true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error($result) ) {&nbsp;</div></li><li><div>      $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>          'what' =&gt; 'comment', &nbsp;</div></li><li><div>          'id' =&gt; $result&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $x-&gt;send();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Decide if we need to send back '1' or a more complicated response including page links and comment counts</span></span>&nbsp;</div></li><li><div>  _wp_ajax_delete_comment_response( $comment-&gt;comment_ID );&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for adding a link category.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_add_link_category( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) )&nbsp;</div></li><li><div>      $action = 'add-link-category';&nbsp;</div></li><li><div>  check_ajax_referer( $action );&nbsp;</div></li><li><div>  $tax = get_taxonomy( 'link_category' );&nbsp;</div></li><li><div>  if ( ! current_user_can( $tax-&gt;cap-&gt;manage_terms ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $names = explode(', ', wp_unslash( $_POST['newcat'] ) );&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response();&nbsp;</div></li><li><div>  foreach ( $names as $cat_name ) {&nbsp;</div></li><li><div>      $cat_name = trim($cat_name);&nbsp;</div></li><li><div>      $slug = sanitize_title($cat_name);&nbsp;</div></li><li><div>      if ( '' === $slug )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( !$cat_id = term_exists( $cat_name, 'link_category' ) )&nbsp;</div></li><li><div>          $cat_id = wp_insert_term( $cat_name, 'link_category' );&nbsp;</div></li><li><div>      if ( is_wp_error( $cat_id ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      } elseif ( is_array( $cat_id ) ) {&nbsp;</div></li><li><div>          $cat_id = $cat_id['term_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $cat_name = esc_html( $cat_name );&nbsp;</div></li><li><div>      $x-&gt;add( array(&nbsp;</div></li><li><div>          'what' =&gt; 'link-category', &nbsp;</div></li><li><div>          'id' =&gt; $cat_id, &nbsp;</div></li><li><div>          'data' =&gt; &quot;&lt;li id='link-category-$cat_id'&gt;&lt;label for='in-link-category-$cat_id' class='selectit'&gt;&lt;input value='&quot; . esc_attr($cat_id) . &quot;' type='checkbox' checked='checked' name='link_category[]' id='in-link-category-$cat_id'/&gt; $cat_name&lt;/label&gt;&lt;/li&gt;&quot;, &nbsp;</div></li><li><div>          'position' =&gt; -1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler to add a tag.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_add_tag() {&nbsp;</div></li><li><div>  check_ajax_referer( 'add-tag', '_wpnonce_add-tag' );&nbsp;</div></li><li><div>  $taxonomy = !empty($_POST['taxonomy']) ? $_POST['taxonomy'] : 'post_tag';&nbsp;</div></li><li><div>  $tax = get_taxonomy($taxonomy);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !current_user_can( $tax-&gt;cap-&gt;edit_terms ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $tag = wp_insert_term($_POST['tag-name'], $taxonomy, $_POST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$tag || is_wp_error($tag) || (!$tag = get_term( $tag['term_id'], $taxonomy )) ) {&nbsp;</div></li><li><div>      $message = __('An error has occurred. Please reload the page and try again.');&nbsp;</div></li><li><div>      if ( is_wp_error($tag) && $tag-&gt;get_error_message() )&nbsp;</div></li><li><div>          $message = $tag-&gt;get_error_message();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $x-&gt;add( array(&nbsp;</div></li><li><div>          'what' =&gt; 'taxonomy', &nbsp;</div></li><li><div>          'data' =&gt; new WP_Error('error', $message )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $x-&gt;send();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( 'WP_Terms_List_Table', array( 'screen' =&gt; $_POST['screen'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $level = 0;&nbsp;</div></li><li><div>  if ( is_taxonomy_hierarchical($taxonomy) ) {&nbsp;</div></li><li><div>      $level = count( get_ancestors( $tag-&gt;term_id, $taxonomy, 'taxonomy' ) );&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      $wp_list_table-&gt;single_row( $tag, $level );&nbsp;</div></li><li><div>      $noparents = ob_get_clean();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $wp_list_table-&gt;single_row( $tag );&nbsp;</div></li><li><div>  $parents = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x-&gt;add( array(&nbsp;</div></li><li><div>      'what' =&gt; 'taxonomy', &nbsp;</div></li><li><div>      'supplemental' =&gt; compact('parents', 'noparents')&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  $x-&gt;add( array(&nbsp;</div></li><li><div>      'what' =&gt; 'term', &nbsp;</div></li><li><div>      'position' =&gt; $level, &nbsp;</div></li><li><div>      'supplemental' =&gt; (array) $tag&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for getting a tagcloud.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_get_tagcloud() {&nbsp;</div></li><li><div>  if ( ! isset( $_POST['tax'] ) ) {&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $taxonomy = sanitize_key( $_POST['tax'] );&nbsp;</div></li><li><div>  $tax = get_taxonomy( $taxonomy );&nbsp;</div></li><li><div>  if ( ! $tax ) {&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( $tax-&gt;cap-&gt;assign_terms ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $tags = get_terms( $taxonomy, array( 'number' =&gt; 45, 'orderby' =&gt; 'count', 'order' =&gt; 'DESC' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $tags ) )&nbsp;</div></li><li><div>      wp_die( $tax-&gt;labels-&gt;not_found );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $tags ) )&nbsp;</div></li><li><div>      wp_die( $tags-&gt;get_error_message() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $tags as $key =&gt; $tag ) {&nbsp;</div></li><li><div>      $tags[ $key ]-&gt;link = '#';&nbsp;</div></li><li><div>      $tags[ $key ]-&gt;id = $tag-&gt;term_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// We need raw tag names here, so don't filter the output</span>&nbsp;</div></li><li><div>  $return = wp_generate_tag_cloud( $tags, array('filter' =&gt; 0) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($return) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for getting comments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global int           $post_id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_get_comments( $action ) {&nbsp;</div></li><li><div>  global $post_id;&nbsp;</div></li><li><div>  if ( empty( $action ) ) {&nbsp;</div></li><li><div>      $action = 'get-comments';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  check_ajax_referer( $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post_id ) && ! empty( $_REQUEST['p'] ) ) {&nbsp;</div></li><li><div>      $id = absint( $_REQUEST['p'] );&nbsp;</div></li><li><div>      if ( ! empty( $id ) ) {&nbsp;</div></li><li><div>          $post_id = $id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post_id ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( 'WP_Post_Comments_List_Table', array( 'screen' =&gt; 'edit-comments' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post_id ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table-&gt;prepare_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $wp_list_table-&gt;has_items() ) {&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response();&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  foreach ( $wp_list_table-&gt;items as $comment ) {&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_comment', $comment-&gt;comment_ID ) && 0 === $comment-&gt;comment_approved )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      get_comment( $comment );&nbsp;</div></li><li><div>      $wp_list_table-&gt;single_row( $comment );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $comment_list_item = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x-&gt;add( array(&nbsp;</div></li><li><div>      'what' =&gt; 'comments', &nbsp;</div></li><li><div>      'data' =&gt; $comment_list_item&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for replying to a comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_replyto_comment( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) )&nbsp;</div></li><li><div>      $action = 'replyto-comment';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( $action, '_ajax_nonce-replyto-comment' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comment_post_ID = (int) $_POST['comment_post_ID'];&nbsp;</div></li><li><div>  $post = get_post( $comment_post_ID );&nbsp;</div></li><li><div>  if ( ! $post )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !current_user_can( 'edit_post', $comment_post_ID ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post-&gt;post_status ) )&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  elseif ( in_array($post-&gt;post_status, array('draft', 'pending', 'trash') ) )&nbsp;</div></li><li><div>      wp_die( __('ERROR: you are replying to a comment on a draft post.') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = wp_get_current_user();&nbsp;</div></li><li><div>  if ( $user-&gt;exists() ) {&nbsp;</div></li><li><div>      $user_ID = $user-&gt;ID;&nbsp;</div></li><li><div>      $comment_author = wp_slash( $user-&gt;display_name );&nbsp;</div></li><li><div>      $comment_author_email = wp_slash( $user-&gt;user_email );&nbsp;</div></li><li><div>      $comment_author_url = wp_slash( $user-&gt;user_url );&nbsp;</div></li><li><div>      $comment_content = trim( $_POST['content'] );&nbsp;</div></li><li><div>      $comment_type = isset( $_POST['comment_type'] ) ? trim( $_POST['comment_type'] ) : '';&nbsp;</div></li><li><div>      if ( current_user_can( 'unfiltered_html' ) ) {&nbsp;</div></li><li><div>          if ( ! isset( $_POST['_wp_unfiltered_html_comment'] ) )&nbsp;</div></li><li><div>              $_POST['_wp_unfiltered_html_comment'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( wp_create_nonce( 'unfiltered-html-comment' ) != $_POST['_wp_unfiltered_html_comment'] ) {&nbsp;</div></li><li><div>              kses_remove_filters(); <span class="comment">// start with a clean slate</span>&nbsp;</div></li><li><div>              kses_init_filters(); <span class="comment">// set up the filters</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_die( __( 'Sorry, you must be logged in to reply to a comment.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( '' == $comment_content )&nbsp;</div></li><li><div>      wp_die( __( 'ERROR: please type a comment.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comment_parent = 0;&nbsp;</div></li><li><div>  if ( isset( $_POST['comment_ID'] ) )&nbsp;</div></li><li><div>      $comment_parent = absint( $_POST['comment_ID'] );&nbsp;</div></li><li><div>  $comment_auto_approved = false;&nbsp;</div></li><li><div>  $commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_type', 'comment_parent', 'user_ID');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Automatically approve parent comment.</span>&nbsp;</div></li><li><div>  if ( !empty($_POST['approve_parent']) ) {&nbsp;</div></li><li><div>      $parent = get_comment( $comment_parent );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $parent && $parent-&gt;comment_approved === '0' && $parent-&gt;comment_post_ID == $comment_post_ID ) {&nbsp;</div></li><li><div>          if ( ! current_user_can( 'edit_comment', $parent-&gt;comment_ID ) ) {&nbsp;</div></li><li><div>              wp_die( -1 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( wp_set_comment_status( $parent, 'approve' ) )&nbsp;</div></li><li><div>              $comment_auto_approved = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comment_id = wp_new_comment( $commentdata );&nbsp;</div></li><li><div>  $comment = get_comment($comment_id);&nbsp;</div></li><li><div>  if ( ! $comment ) wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $position = ( isset($_POST['position']) && (int) $_POST['position'] ) ? (int) $_POST['position'] : '-1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['mode'] ) && 'dashboard' == $_REQUEST['mode'] ) {&nbsp;</div></li><li><div>      require_once( ABSPATH . 'wp-admin/includes/dashboard.php' );&nbsp;</div></li><li><div>      _wp_dashboard_recent_comments_row( $comment );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( isset( $_REQUEST['mode'] ) && 'single' == $_REQUEST['mode'] ) {&nbsp;</div></li><li><div>          $wp_list_table = _get_list_table('WP_Post_Comments_List_Table', array( 'screen' =&gt; 'edit-comments' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $wp_list_table = _get_list_table('WP_Comments_List_Table', array( 'screen' =&gt; 'edit-comments' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $wp_list_table-&gt;single_row( $comment );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $comment_list_item = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $response =  array(&nbsp;</div></li><li><div>      'what' =&gt; 'comment', &nbsp;</div></li><li><div>      'id' =&gt; $comment-&gt;comment_ID, &nbsp;</div></li><li><div>      'data' =&gt; $comment_list_item, &nbsp;</div></li><li><div>      'position' =&gt; $position&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $counts = wp_count_comments();&nbsp;</div></li><li><div>  $response['supplemental'] = array(&nbsp;</div></li><li><div>      'in_moderation' =&gt; $counts-&gt;moderated, &nbsp;</div></li><li><div>      'i18n_comments_text' =&gt; sprintf(&nbsp;</div></li><li><div>          _n( '%s Comment', '%s Comments', $counts-&gt;approved ), &nbsp;</div></li><li><div>          number_format_i18n( $counts-&gt;approved )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'i18n_moderation_text' =&gt; sprintf(&nbsp;</div></li><li><div>          _nx( '%s in moderation', '%s in moderation', $counts-&gt;moderated, 'comments' ), &nbsp;</div></li><li><div>          number_format_i18n( $counts-&gt;moderated )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $comment_auto_approved ) {&nbsp;</div></li><li><div>      $response['supplemental']['parent_approved'] = $parent-&gt;comment_ID;&nbsp;</div></li><li><div>      $response['supplemental']['parent_post_id'] = $parent-&gt;comment_post_ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response();&nbsp;</div></li><li><div>  $x-&gt;add( $response );&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for editing a comment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_edit_comment() {&nbsp;</div></li><li><div>  check_ajax_referer( 'replyto-comment', '_ajax_nonce-replyto-comment' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comment_id = (int) $_POST['comment_ID'];&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_comment', $comment_id ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( '' == $_POST['content'] )&nbsp;</div></li><li><div>      wp_die( __( 'ERROR: please type a comment.' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_POST['status'] ) )&nbsp;</div></li><li><div>      $_POST['comment_status'] = $_POST['status'];&nbsp;</div></li><li><div>  edit_comment();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $position = ( isset($_POST['position']) && (int) $_POST['position']) ? (int) $_POST['position'] : '-1';&nbsp;</div></li><li><div>  $checkbox = ( isset($_POST['checkbox']) && true == $_POST['checkbox'] ) ? 1 : 0;&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( $checkbox ? 'WP_Comments_List_Table' : 'WP_Post_Comments_List_Table', array( 'screen' =&gt; 'edit-comments' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>  if ( empty( $comment-&gt;comment_ID ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $wp_list_table-&gt;single_row( $comment );&nbsp;</div></li><li><div>  $comment_list_item = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x-&gt;add( array(&nbsp;</div></li><li><div>      'what' =&gt; 'edit_comment', &nbsp;</div></li><li><div>      'id' =&gt; $comment-&gt;comment_ID, &nbsp;</div></li><li><div>      'data' =&gt; $comment_list_item, &nbsp;</div></li><li><div>      'position' =&gt; $position&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for adding a menu item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_add_menu_item() {&nbsp;</div></li><li><div>  check_ajax_referer( 'add-menu_item', 'menu-settings-column-nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_theme_options' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once ABSPATH . 'wp-admin/includes/nav-menu.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For performance reasons, we omit some object properties from the checklist.</span>&nbsp;</div></li><li><div>  <span class="comment">// The following is a hacky way to restore them when adding non-custom items.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $menu_items_data = array();&nbsp;</div></li><li><div>  foreach ( (array) $_POST['menu-item'] as $menu_item_data ) {&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          ! empty( $menu_item_data['menu-item-type'] ) &&&nbsp;</div></li><li><div>          'custom' != $menu_item_data['menu-item-type'] &&&nbsp;</div></li><li><div>          ! empty( $menu_item_data['menu-item-object-id'] )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          switch( $menu_item_data['menu-item-type'] ) {&nbsp;</div></li><li><div>              case 'post_type' :&nbsp;</div></li><li><div>                  $_object = get_post( $menu_item_data['menu-item-object-id'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'post_type_archive' :&nbsp;</div></li><li><div>                  $_object = get_post_type_object( $menu_item_data['menu-item-object'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'taxonomy' :&nbsp;</div></li><li><div>                  $_object = get_term( $menu_item_data['menu-item-object-id'], $menu_item_data['menu-item-object'] );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $_menu_items = array_map( 'wp_setup_nav_menu_item', array( $_object ) );&nbsp;</div></li><li><div>          $_menu_item = reset( $_menu_items );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Restore the missing menu item properties</span>&nbsp;</div></li><li><div>          $menu_item_data['menu-item-description'] = $_menu_item-&gt;description;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $menu_items_data[] = $menu_item_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $item_ids = wp_save_nav_menu_items( 0, $menu_items_data );&nbsp;</div></li><li><div>  if ( is_wp_error( $item_ids ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $menu_items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) $item_ids as $menu_item_id ) {&nbsp;</div></li><li><div>      $menu_obj = get_post( $menu_item_id );&nbsp;</div></li><li><div>      if ( ! empty( $menu_obj-&gt;ID ) ) {&nbsp;</div></li><li><div>          $menu_obj = wp_setup_nav_menu_item( $menu_obj );&nbsp;</div></li><li><div>          $menu_obj-&gt;label = $menu_obj-&gt;title; <span class="comment">// don't show &quot;(pending)&quot; in ajax-added items</span>&nbsp;</div></li><li><div>          $menu_items[] = $menu_obj;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/nav-menu.php */</span></span>&nbsp;</div></li><li><div>  $walker_class_name = apply_filters( 'wp_edit_nav_menu_walker', 'Walker_Nav_Menu_Edit', $_POST['menu'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! class_exists( $walker_class_name ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $menu_items ) ) {&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'after' =&gt; '', &nbsp;</div></li><li><div>          'before' =&gt; '', &nbsp;</div></li><li><div>          'link_after' =&gt; '', &nbsp;</div></li><li><div>          'link_before' =&gt; '', &nbsp;</div></li><li><div>          'walker' =&gt; new $walker_class_name, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      echo walk_nav_menu_tree( $menu_items, 0, (object) $args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for adding meta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_add_meta() {&nbsp;</div></li><li><div>  check_ajax_referer( 'add-meta', '_ajax_nonce-add-meta' );&nbsp;</div></li><li><div>  $c = 0;&nbsp;</div></li><li><div>  $pid = (int) $_POST['post_id'];&nbsp;</div></li><li><div>  $post = get_post( $pid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_POST['metakeyselect']) || isset($_POST['metakeyinput']) ) {&nbsp;</div></li><li><div>      if ( !current_user_can( 'edit_post', $pid ) )&nbsp;</div></li><li><div>          wp_die( -1 );&nbsp;</div></li><li><div>      if ( isset($_POST['metakeyselect']) && '#NONE#' == $_POST['metakeyselect'] && empty($_POST['metakeyinput']) )&nbsp;</div></li><li><div>          wp_die( 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the post is an autodraft, save the post as a draft and then attempt to save the meta.</span>&nbsp;</div></li><li><div>      if ( $post-&gt;post_status == 'auto-draft' ) {&nbsp;</div></li><li><div>          $post_data = array();&nbsp;</div></li><li><div>          $post_data['action'] = 'draft'; <span class="comment">// Warning fix</span>&nbsp;</div></li><li><div>          $post_data['post_ID'] = $pid;&nbsp;</div></li><li><div>          $post_data['post_type'] = $post-&gt;post_type;&nbsp;</div></li><li><div>          $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>          $now = current_time('timestamp', 1);&nbsp;</div></li><li><div>          <span class="comment">/** translators: 1: Post creation date, 2: Post creation time */</span>&nbsp;</div></li><li><div>          $post_data['post_title'] = sprintf( __( 'Draft created on %1$s at %2$s' ), date( __( 'F j, Y' ), $now ), date( __( 'g:i a' ), $now ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $pid = edit_post( $post_data );&nbsp;</div></li><li><div>          if ( $pid ) {&nbsp;</div></li><li><div>              if ( is_wp_error( $pid ) ) {&nbsp;</div></li><li><div>                  $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>                      'what' =&gt; 'meta', &nbsp;</div></li><li><div>                      'data' =&gt; $pid&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                  $x-&gt;send();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !$mid = add_meta( $pid ) )&nbsp;</div></li><li><div>                  wp_die( __( 'Please provide a custom field value.' ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wp_die( 0 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( ! $mid = add_meta( $pid ) ) {&nbsp;</div></li><li><div>          wp_die( __( 'Please provide a custom field value.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $meta = get_metadata_by_mid( 'post', $mid );&nbsp;</div></li><li><div>      $pid = (int) $meta-&gt;post_id;&nbsp;</div></li><li><div>      $meta = get_object_vars( $meta );&nbsp;</div></li><li><div>      $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>          'what' =&gt; 'meta', &nbsp;</div></li><li><div>          'id' =&gt; $mid, &nbsp;</div></li><li><div>          'data' =&gt; _list_meta_row( $meta, $c ), &nbsp;</div></li><li><div>          'position' =&gt; 1, &nbsp;</div></li><li><div>          'supplemental' =&gt; array('postid' =&gt; $pid)&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  } else { <span class="comment">// Update?</span>&nbsp;</div></li><li><div>      $mid = (int) key( $_POST['meta'] );&nbsp;</div></li><li><div>      $key = wp_unslash( $_POST['meta'][$mid]['key'] );&nbsp;</div></li><li><div>      $value = wp_unslash( $_POST['meta'][$mid]['value'] );&nbsp;</div></li><li><div>      if ( '' == trim($key) )&nbsp;</div></li><li><div>          wp_die( __( 'Please provide a custom field name.' ) );&nbsp;</div></li><li><div>      if ( '' == trim($value) )&nbsp;</div></li><li><div>          wp_die( __( 'Please provide a custom field value.' ) );&nbsp;</div></li><li><div>      if ( ! $meta = get_metadata_by_mid( 'post', $mid ) )&nbsp;</div></li><li><div>          wp_die( 0 ); <span class="comment">// if meta doesn't exist</span>&nbsp;</div></li><li><div>      if ( is_protected_meta( $meta-&gt;meta_key, 'post' ) || is_protected_meta( $key, 'post' ) ||&nbsp;</div></li><li><div>          ! current_user_can( 'edit_post_meta', $meta-&gt;post_id, $meta-&gt;meta_key ) ||&nbsp;</div></li><li><div>          ! current_user_can( 'edit_post_meta', $meta-&gt;post_id, $key ) )&nbsp;</div></li><li><div>          wp_die( -1 );&nbsp;</div></li><li><div>      if ( $meta-&gt;meta_value != $value || $meta-&gt;meta_key != $key ) {&nbsp;</div></li><li><div>          if ( !$u = update_metadata_by_mid( 'post', $mid, $value, $key ) )&nbsp;</div></li><li><div>              wp_die( 0 ); <span class="comment">// We know meta exists; we also know it's unchanged (or DB error, in which case there are bigger problems).</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>          'what' =&gt; 'meta', &nbsp;</div></li><li><div>          'id' =&gt; $mid, 'old_id' =&gt; $mid, &nbsp;</div></li><li><div>          'data' =&gt; _list_meta_row( array(&nbsp;</div></li><li><div>              'meta_key' =&gt; $key, &nbsp;</div></li><li><div>              'meta_value' =&gt; $value, &nbsp;</div></li><li><div>              'meta_id' =&gt; $mid&nbsp;</div></li><li><div> ), $c ), &nbsp;</div></li><li><div>          'position' =&gt; 0, &nbsp;</div></li><li><div>          'supplemental' =&gt; array('postid' =&gt; $meta-&gt;post_id)&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for adding a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $action Action to perform.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_add_user( $action ) {&nbsp;</div></li><li><div>  if ( empty( $action ) ) {&nbsp;</div></li><li><div>      $action = 'add-user';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( $action );&nbsp;</div></li><li><div>  if ( ! current_user_can('create_users') )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  if ( ! $user_id = edit_user() ) {&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $user_id ) ) {&nbsp;</div></li><li><div>      $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>          'what' =&gt; 'user', &nbsp;</div></li><li><div>          'id' =&gt; $user_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $x-&gt;send();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $user_object = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table('WP_Users_List_Table');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $role = current( $user_object-&gt;roles );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $x = new WP_Ajax_Response( array(&nbsp;</div></li><li><div>      'what' =&gt; 'user', &nbsp;</div></li><li><div>      'id' =&gt; $user_id, &nbsp;</div></li><li><div>      'data' =&gt; $wp_list_table-&gt;single_row( $user_object, '', $role ), &nbsp;</div></li><li><div>      'supplemental' =&gt; array(&nbsp;</div></li><li><div>          'show-link' =&gt; sprintf(&nbsp;</div></li><li><div>              <span class="comment">/** translators: %s: the new user */</span>&nbsp;</div></li><li><div>              __( 'User %s added' ), &nbsp;</div></li><li><div>              '&lt;a href=&quot;#user-' . $user_id . '&quot;&gt;' . $user_object-&gt;user_login . '&lt;/a&gt;'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'role' =&gt; $role, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  $x-&gt;send();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for closed post boxes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_closed_postboxes() {&nbsp;</div></li><li><div>  check_ajax_referer( 'closedpostboxes', 'closedpostboxesnonce' );&nbsp;</div></li><li><div>  $closed = isset( $_POST['closed'] ) ? explode( ', ', $_POST['closed']) : array();&nbsp;</div></li><li><div>  $closed = array_filter($closed);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $hidden = isset( $_POST['hidden'] ) ? explode( ', ', $_POST['hidden']) : array();&nbsp;</div></li><li><div>  $hidden = array_filter($hidden);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $page = isset( $_POST['page'] ) ? $_POST['page'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page != sanitize_key( $page ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user = wp_get_current_user() )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array($closed) )&nbsp;</div></li><li><div>      update_user_option($user-&gt;ID, &quot;closedpostboxes_$page&quot;, $closed, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array($hidden) ) {&nbsp;</div></li><li><div>      $hidden = array_diff( $hidden, array('submitdiv', 'linksubmitdiv', 'manage-menu', 'create-menu') ); <span class="comment">// postboxes that are always shown</span>&nbsp;</div></li><li><div>      update_user_option($user-&gt;ID, &quot;metaboxhidden_$page&quot;, $hidden, true);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for hidden columns.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_hidden_columns() {&nbsp;</div></li><li><div>  check_ajax_referer( 'screen-options-nonce', 'screenoptionnonce' );&nbsp;</div></li><li><div>  $page = isset( $_POST['page'] ) ? $_POST['page'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page != sanitize_key( $page ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user = wp_get_current_user() )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $hidden = ! empty( $_POST['hidden'] ) ? explode( ', ', $_POST['hidden'] ) : array();&nbsp;</div></li><li><div>  update_user_option( $user-&gt;ID, &quot;manage{$page}columnshidden&quot;, $hidden, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for updating whether to display the welcome panel.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_update_welcome_panel() {&nbsp;</div></li><li><div>  check_ajax_referer( 'welcome-panel-nonce', 'welcomepanelnonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_theme_options' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_user_meta( get_current_user_id(), 'show_welcome_panel', empty( $_POST['visible'] ) ? 0 : 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for retrieving menu meta boxes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_menu_get_metabox() {&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_theme_options' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once ABSPATH . 'wp-admin/includes/nav-menu.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_POST['item-type'] ) && 'post_type' == $_POST['item-type'] ) {&nbsp;</div></li><li><div>      $type = 'posttype';&nbsp;</div></li><li><div>      $callback = 'wp_nav_menu_item_post_type_meta_box';&nbsp;</div></li><li><div>      $items = (array) get_post_types( array( 'show_in_nav_menus' =&gt; true ), 'object' );&nbsp;</div></li><li><div>  } elseif ( isset( $_POST['item-type'] ) && 'taxonomy' == $_POST['item-type'] ) {&nbsp;</div></li><li><div>      $type = 'taxonomy';&nbsp;</div></li><li><div>      $callback = 'wp_nav_menu_item_taxonomy_meta_box';&nbsp;</div></li><li><div>      $items = (array) get_taxonomies( array( 'show_ui' =&gt; true ), 'object' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['item-object'] ) && isset( $items[$_POST['item-object']] ) ) {&nbsp;</div></li><li><div>      $menus_meta_box_object = $items[ $_POST['item-object'] ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/nav-menu.php */</span></span>&nbsp;</div></li><li><div>      $item = apply_filters( 'nav_menu_meta_box_object', $menus_meta_box_object );&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      call_user_func_array($callback, array(&nbsp;</div></li><li><div>          null, &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'id' =&gt; 'add-' . $item-&gt;name, &nbsp;</div></li><li><div>              'title' =&gt; $item-&gt;labels-&gt;name, &nbsp;</div></li><li><div>              'callback' =&gt; $callback, &nbsp;</div></li><li><div>              'args' =&gt; $item, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $markup = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo wp_json_encode(array(&nbsp;</div></li><li><div>          'replace-id' =&gt; $type . '-' . $item-&gt;name, &nbsp;</div></li><li><div>          'markup' =&gt; $markup, &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for internal linking.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_wp_link_ajax() {&nbsp;</div></li><li><div>  check_ajax_referer( 'internal-linking', '_ajax_linking_nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_POST['search'] ) ) {&nbsp;</div></li><li><div>      $args['s'] = wp_unslash( $_POST['search'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_POST['term'] ) ) {&nbsp;</div></li><li><div>      $args['s'] = wp_unslash( $_POST['term'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args['pagenum'] = ! empty( $_POST['page'] ) ? absint( $_POST['page'] ) : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require(ABSPATH . WPINC . '/class-wp-editor.php');&nbsp;</div></li><li><div>  $results = _WP_Editors::wp_link_query( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $results ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo wp_json_encode( $results );&nbsp;</div></li><li><div>  echo &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for menu locations save.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_menu_locations_save() {&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_theme_options' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  check_ajax_referer( 'add-menu_item', 'menu-settings-column-nonce' );&nbsp;</div></li><li><div>  if ( ! isset( $_POST['menu-locations'] ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  set_theme_mod( 'nav_menu_locations', array_map( 'absint', $_POST['menu-locations'] ) );&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving the meta box order.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_meta_box_order() {&nbsp;</div></li><li><div>  check_ajax_referer( 'meta-box-order' );&nbsp;</div></li><li><div>  $order = isset( $_POST['order'] ) ? (array) $_POST['order'] : false;&nbsp;</div></li><li><div>  $page_columns = isset( $_POST['page_columns'] ) ? $_POST['page_columns'] : 'auto';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page_columns != 'auto' )&nbsp;</div></li><li><div>      $page_columns = (int) $page_columns;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $page = isset( $_POST['page'] ) ? $_POST['page'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page != sanitize_key( $page ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user = wp_get_current_user() )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $order )&nbsp;</div></li><li><div>      update_user_option($user-&gt;ID, &quot;meta-box-order_$page&quot;, $order, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page_columns )&nbsp;</div></li><li><div>      update_user_option($user-&gt;ID, &quot;screen_layout_$page&quot;, $page_columns, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for menu quick searching.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_menu_quick_search() {&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_theme_options' ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once ABSPATH . 'wp-admin/includes/nav-menu.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  _wp_ajax_menu_quick_search( $_POST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler to retrieve a permalink.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_get_permalink() {&nbsp;</div></li><li><div>  check_ajax_referer( 'getpermalink', 'getpermalinknonce' );&nbsp;</div></li><li><div>  $post_id = isset($_POST['post_id'])? intval($_POST['post_id']) : 0;&nbsp;</div></li><li><div>  wp_die( get_preview_post_link( $post_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler to retrieve a sample permalink.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_sample_permalink() {&nbsp;</div></li><li><div>  check_ajax_referer( 'samplepermalink', 'samplepermalinknonce' );&nbsp;</div></li><li><div>  $post_id = isset($_POST['post_id'])? intval($_POST['post_id']) : 0;&nbsp;</div></li><li><div>  $title = isset($_POST['new_title'])? $_POST['new_title'] : '';&nbsp;</div></li><li><div>  $slug = isset($_POST['new_slug'])? $_POST['new_slug'] : null;&nbsp;</div></li><li><div>  wp_die( get_sample_permalink_html( $post_id, $title, $slug ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for Quick Edit saving a post from a list table.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_inline_save() {&nbsp;</div></li><li><div>  global $mode;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'inlineeditnonce', '_inline_edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset($_POST['post_ID']) || ! ( $post_ID = (int) $_POST['post_ID'] ) )&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'page' == $_POST['post_type'] ) {&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_page', $post_ID ) )&nbsp;</div></li><li><div>          wp_die( __( 'Sorry, you are not allowed to edit this page.' ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_post', $post_ID ) )&nbsp;</div></li><li><div>          wp_die( __( 'Sorry, you are not allowed to edit this post.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $last = wp_check_post_lock( $post_ID ) ) {&nbsp;</div></li><li><div>      $last_user = get_userdata( $last );&nbsp;</div></li><li><div>      $last_user_name = $last_user ? $last_user-&gt;display_name : __( 'Someone' );&nbsp;</div></li><li><div>      printf( $_POST['post_type'] == 'page' ? __( 'Saving is disabled: %s is currently editing this page.' ) : __( 'Saving is disabled: %s is currently editing this post.' ), esc_html( $last_user_name ) );&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $data = &$_POST;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post( $post_ID, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Since it's coming from the database.</span>&nbsp;</div></li><li><div>  $post = wp_slash($post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $data['content'] = $post['post_content'];&nbsp;</div></li><li><div>  $data['excerpt'] = $post['post_excerpt'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Rename.</span>&nbsp;</div></li><li><div>  $data['user_ID'] = get_current_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($data['post_parent']) )&nbsp;</div></li><li><div>      $data['parent_id'] = $data['post_parent'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Status.</span>&nbsp;</div></li><li><div>  if ( isset( $data['keep_private'] ) && 'private' == $data['keep_private'] ) {&nbsp;</div></li><li><div>      $data['visibility'] = 'private';&nbsp;</div></li><li><div>      $data['post_status'] = 'private';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $data['post_status'] = $data['_status'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty($data['comment_status']) )&nbsp;</div></li><li><div>      $data['comment_status'] = 'closed';&nbsp;</div></li><li><div>  if ( empty($data['ping_status']) )&nbsp;</div></li><li><div>      $data['ping_status'] = 'closed';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Exclude terms from taxonomies that are not supposed to appear in Quick Edit.</span>&nbsp;</div></li><li><div>  if ( ! empty( $data['tax_input'] ) ) {&nbsp;</div></li><li><div>      foreach ( $data['tax_input'] as $taxonomy =&gt; $terms ) {&nbsp;</div></li><li><div>          $tax_object = get_taxonomy( $taxonomy );&nbsp;</div></li><li><div>          <span class="comment">/** This filter is documented in wp-admin/includes/class-wp-posts-list-table.php */</span>&nbsp;</div></li><li><div>          if ( ! apply_filters( 'quick_edit_show_taxonomy', $tax_object-&gt;show_in_quick_edit, $taxonomy, $post['post_type'] ) ) {&nbsp;</div></li><li><div>              unset( $data['tax_input'][ $taxonomy ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Hack: wp_unique_post_slug() doesn't work for drafts, so we will fake that our post is published.</span>&nbsp;</div></li><li><div>  if ( ! empty( $data['post_name'] ) && in_array( $post['post_status'], array( 'draft', 'pending' ) ) ) {&nbsp;</div></li><li><div>      $post['post_status'] = 'publish';&nbsp;</div></li><li><div>      $data['post_name'] = wp_unique_post_slug( $data['post_name'], $post['ID'], $post['post_status'], $post['post_type'], $post['post_parent'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the post.</span>&nbsp;</div></li><li><div>  edit_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( 'WP_Posts_List_Table', array( 'screen' =&gt; $_POST['screen'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $mode = $_POST['post_view'] === 'excerpt' ? 'excerpt' : 'list';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $level = 0;&nbsp;</div></li><li><div>  if ( is_post_type_hierarchical( $wp_list_table-&gt;screen-&gt;post_type ) ) {&nbsp;</div></li><li><div>      $request_post = array( get_post( $_POST['post_ID'] ) );&nbsp;</div></li><li><div>      $parent = $request_post[0]-&gt;post_parent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      while ( $parent &gt; 0 ) {&nbsp;</div></li><li><div>          $parent_post = get_post( $parent );&nbsp;</div></li><li><div>          $parent = $parent_post-&gt;post_parent;&nbsp;</div></li><li><div>          $level++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table-&gt;display_rows( array( get_post( $_POST['post_ID'] ) ), $level );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for quick edit saving for a term.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_inline_save_tax() {&nbsp;</div></li><li><div>  check_ajax_referer( 'taxinlineeditnonce', '_inline_edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $taxonomy = sanitize_key( $_POST['taxonomy'] );&nbsp;</div></li><li><div>  $tax = get_taxonomy( $taxonomy );&nbsp;</div></li><li><div>  if ( ! $tax )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $_POST['tax_ID'] ) || ! ( $id = (int) $_POST['tax_ID'] ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_term', $id ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( 'WP_Terms_List_Table', array( 'screen' =&gt; 'edit-' . $taxonomy ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $tag = get_term( $id, $taxonomy );&nbsp;</div></li><li><div>  $_POST['description'] = $tag-&gt;description;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $updated = wp_update_term($id, $taxonomy, $_POST);&nbsp;</div></li><li><div>  if ( $updated && !is_wp_error($updated) ) {&nbsp;</div></li><li><div>      $tag = get_term( $updated['term_id'], $taxonomy );&nbsp;</div></li><li><div>      if ( !$tag || is_wp_error( $tag ) ) {&nbsp;</div></li><li><div>          if ( is_wp_error($tag) && $tag-&gt;get_error_message() )&nbsp;</div></li><li><div>              wp_die( $tag-&gt;get_error_message() );&nbsp;</div></li><li><div>          wp_die( __( 'Item not updated.' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( is_wp_error($updated) && $updated-&gt;get_error_message() )&nbsp;</div></li><li><div>          wp_die( $updated-&gt;get_error_message() );&nbsp;</div></li><li><div>      wp_die( __( 'Item not updated.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $level = 0;&nbsp;</div></li><li><div>  $parent = $tag-&gt;parent;&nbsp;</div></li><li><div>  while ( $parent &gt; 0 ) {&nbsp;</div></li><li><div>      $parent_tag = get_term( $parent, $taxonomy );&nbsp;</div></li><li><div>      $parent = $parent_tag-&gt;parent;&nbsp;</div></li><li><div>      $level++;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $wp_list_table-&gt;single_row( $tag, $level );&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for querying posts for the Find Posts modal.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see window.findPosts</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_find_posts() {&nbsp;</div></li><li><div>  check_ajax_referer( 'find-posts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_types = get_post_types( array( 'public' =&gt; true ), 'objects' );&nbsp;</div></li><li><div>  unset( $post_types['attachment'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $s = wp_unslash( $_POST['ps'] );&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'post_type' =&gt; array_keys( $post_types ), &nbsp;</div></li><li><div>      'post_status' =&gt; 'any', &nbsp;</div></li><li><div>      'posts_per_page' =&gt; 50, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  if ( '' !== $s )&nbsp;</div></li><li><div>      $args['s'] = $s;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posts = get_posts( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $posts ) {&nbsp;</div></li><li><div>      wp_send_json_error( __( 'No items found.' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $html = '&lt;table class=&quot;widefat&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&quot;found-radio&quot;&gt;&lt;br /&gt;&lt;/th&gt;&lt;th&gt;'.__('Title').'&lt;/th&gt;&lt;th class=&quot;no-break&quot;&gt;'.__('Type').'&lt;/th&gt;&lt;th class=&quot;no-break&quot;&gt;'.__('Date').'&lt;/th&gt;&lt;th class=&quot;no-break&quot;&gt;'.__('Status').'&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;';&nbsp;</div></li><li><div>  $alt = '';&nbsp;</div></li><li><div>  foreach ( $posts as $post ) {&nbsp;</div></li><li><div>      $title = trim( $post-&gt;post_title ) ? $post-&gt;post_title : __( '(no title)' );&nbsp;</div></li><li><div>      $alt = ( 'alternate' == $alt ) ? '' : 'alternate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $post-&gt;post_status ) {&nbsp;</div></li><li><div>          case 'publish' :&nbsp;</div></li><li><div>          case 'private' :&nbsp;</div></li><li><div>              $stat = __('Published');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'future' :&nbsp;</div></li><li><div>              $stat = __('Scheduled');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'pending' :&nbsp;</div></li><li><div>              $stat = __('Pending Review');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'draft' :&nbsp;</div></li><li><div>              $stat = __('Draft');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '0000-00-00 00:00:00' == $post-&gt;post_date ) {&nbsp;</div></li><li><div>          $time = '';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">/** translators: date format in table columns, see https://secure.php.net/date */</span>&nbsp;</div></li><li><div>          $time = mysql2date(__('Y/m/d'), $post-&gt;post_date);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $html .= '&lt;tr class=&quot;' . trim( 'found-posts ' . $alt ) . '&quot;&gt;&lt;td class=&quot;found-radio&quot;&gt;&lt;input type=&quot;radio&quot; id=&quot;found-'.$post-&gt;ID.'&quot; name=&quot;found_post_id&quot; value=&quot;' . esc_attr($post-&gt;ID) . '&quot;&gt;&lt;/td&gt;';&nbsp;</div></li><li><div>      $html .= '&lt;td&gt;&lt;label for=&quot;found-'.$post-&gt;ID.'&quot;&gt;' . esc_html( $title ) . '&lt;/label&gt;&lt;/td&gt;&lt;td class=&quot;no-break&quot;&gt;' . esc_html( $post_types[$post-&gt;post_type]-&gt;labels-&gt;singular_name ) . '&lt;/td&gt;&lt;td class=&quot;no-break&quot;&gt;'.esc_html( $time ) . '&lt;/td&gt;&lt;td class=&quot;no-break&quot;&gt;' . esc_html( $stat ). ' &lt;/td&gt;&lt;/tr&gt;' . &quot;\n\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $html .= '&lt;/tbody&gt;&lt;/table&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $html );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving the widgets order.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_widgets_order() {&nbsp;</div></li><li><div>  check_ajax_referer( 'save-sidebar-widgets', 'savewidgets' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !current_user_can('edit_theme_options') )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset( $_POST['savewidgets'], $_POST['action'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Save widgets order for all sidebars.</span>&nbsp;</div></li><li><div>  if ( is_array($_POST['sidebars']) ) {&nbsp;</div></li><li><div>      $sidebars = array();&nbsp;</div></li><li><div>      foreach ( $_POST['sidebars'] as $key =&gt; $val ) {&nbsp;</div></li><li><div>          $sb = array();&nbsp;</div></li><li><div>          if ( !empty($val) ) {&nbsp;</div></li><li><div>              $val = explode(', ', $val);&nbsp;</div></li><li><div>              foreach ( $val as $k =&gt; $v ) {&nbsp;</div></li><li><div>                  if ( strpos($v, 'widget-') === false )&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $sb[$k] = substr($v, strpos($v, '_') + 1);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $sidebars[$key] = $sb;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_set_sidebars_widgets($sidebars);&nbsp;</div></li><li><div>      wp_die( 1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( -1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving a widget.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $wp_registered_widgets</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $wp_registered_widget_controls</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $wp_registered_widget_updates</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_save_widget() {&nbsp;</div></li><li><div>  global $wp_registered_widgets, $wp_registered_widget_controls, $wp_registered_widget_updates;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'save-sidebar-widgets', 'savewidgets' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !current_user_can('edit_theme_options') || !isset($_POST['id_base']) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset( $_POST['savewidgets'], $_POST['action'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires early when editing the widgets displayed in sidebars.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'load-widgets.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires early when editing the widgets displayed in sidebars.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'widgets.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">/** This action is documented in wp-admin/widgets.php */</span></span>&nbsp;</div></li><li><div>  do_action( 'sidebar_admin_setup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id_base = $_POST['id_base'];&nbsp;</div></li><li><div>  $widget_id = $_POST['widget-id'];&nbsp;</div></li><li><div>  $sidebar_id = $_POST['sidebar'];&nbsp;</div></li><li><div>  $multi_number = !empty($_POST['multi_number']) ? (int) $_POST['multi_number'] : 0;&nbsp;</div></li><li><div>  $settings = isset($_POST['widget-' . $id_base]) && is_array($_POST['widget-' . $id_base]) ? $_POST['widget-' . $id_base] : false;&nbsp;</div></li><li><div>  $error = '&lt;p&gt;' . __('An error has occurred. Please reload the page and try again.') . '&lt;/p&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sidebars = wp_get_sidebars_widgets();&nbsp;</div></li><li><div>  $sidebar = isset($sidebars[$sidebar_id]) ? $sidebars[$sidebar_id] : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Delete.</span>&nbsp;</div></li><li><div>  if ( isset($_POST['delete_widget']) && $_POST['delete_widget'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !isset($wp_registered_widgets[$widget_id]) )&nbsp;</div></li><li><div>          wp_die( $error );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sidebar = array_diff( $sidebar, array($widget_id) );&nbsp;</div></li><li><div>      $_POST = array('sidebar' =&gt; $sidebar_id, 'widget-' . $id_base =&gt; array(), 'the-widget-id' =&gt; $widget_id, 'delete_widget' =&gt; '1');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** This action is documented in wp-admin/widgets.php */</span></span>&nbsp;</div></li><li><div>      do_action( 'delete_widget', $widget_id, $sidebar_id, $id_base );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } elseif ( $settings && preg_match( '/__i__|%i%/', key($settings) ) ) {&nbsp;</div></li><li><div>      if ( !$multi_number )&nbsp;</div></li><li><div>          wp_die( $error );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $_POST[ 'widget-' . $id_base ] = array( $multi_number =&gt; reset( $settings ) );&nbsp;</div></li><li><div>      $widget_id = $id_base . '-' . $multi_number;&nbsp;</div></li><li><div>      $sidebar[] = $widget_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $_POST['widget-id'] = $sidebar;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) $wp_registered_widget_updates as $name =&gt; $control ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $name == $id_base ) {&nbsp;</div></li><li><div>          if ( !is_callable( $control['callback'] ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ob_start();&nbsp;</div></li><li><div>              call_user_func_array( $control['callback'], $control['params'] );&nbsp;</div></li><li><div>          ob_end_clean();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($_POST['delete_widget']) && $_POST['delete_widget'] ) {&nbsp;</div></li><li><div>      $sidebars[$sidebar_id] = $sidebar;&nbsp;</div></li><li><div>      wp_set_sidebars_widgets($sidebars);&nbsp;</div></li><li><div>      echo &quot;deleted:$widget_id&quot;;&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty($_POST['add_new']) )&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $form = $wp_registered_widget_controls[$widget_id] )&nbsp;</div></li><li><div>      call_user_func_array( $form['callback'], $form['params'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving a widget.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Customize_Manager $wp_customize</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_update_widget() {&nbsp;</div></li><li><div>  global $wp_customize;&nbsp;</div></li><li><div>  $wp_customize-&gt;widgets-&gt;wp_ajax_update_widget();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for removing inactive widgets.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_inactive_widgets() {&nbsp;</div></li><li><div>  check_ajax_referer( 'remove-inactive-widgets', 'removeinactivewidgets' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_theme_options' ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset( $_POST['removeinactivewidgets'], $_POST['action'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'load-widgets.php' );&nbsp;</div></li><li><div>  do_action( 'widgets.php' );&nbsp;</div></li><li><div>  do_action( 'sidebar_admin_setup' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sidebars_widgets = wp_get_sidebars_widgets();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $sidebars_widgets['wp_inactive_widgets'] as $key =&gt; $widget_id ) {&nbsp;</div></li><li><div>      $pieces = explode( '-', $widget_id );&nbsp;</div></li><li><div>      $multi_number = array_pop( $pieces );&nbsp;</div></li><li><div>      $id_base = implode( '-', $pieces );&nbsp;</div></li><li><div>      $widget = get_option( 'widget_' . $id_base );&nbsp;</div></li><li><div>      unset( $widget[$multi_number] );&nbsp;</div></li><li><div>      update_option( 'widget_' . $id_base, $widget );&nbsp;</div></li><li><div>      unset( $sidebars_widgets['wp_inactive_widgets'][$key] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_sidebars_widgets( $sidebars_widgets );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for uploading attachments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_upload_attachment() {&nbsp;</div></li><li><div>  check_ajax_referer( 'media-form' );&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * This function does not use wp_send_json_success() / wp_send_json_error()</span>&nbsp;</div></li><li><div><span class="comment">   * as the html4 Plupload handler requires a text/html content-type for older IE.</span>&nbsp;</div></li><li><div><span class="comment">   * See https://core.trac.wordpress.org/ticket/31037</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'upload_files' ) ) {&nbsp;</div></li><li><div>      echo wp_json_encode( array(&nbsp;</div></li><li><div>          'success' =&gt; false, &nbsp;</div></li><li><div>          'data' =&gt; array(&nbsp;</div></li><li><div>              'message' =&gt; __( 'Sorry, you are not allowed to upload files.' ), &nbsp;</div></li><li><div>              'filename' =&gt; $_FILES['async-upload']['name'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['post_id'] ) ) {&nbsp;</div></li><li><div>      $post_id = $_REQUEST['post_id'];&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_post', $post_id ) ) {&nbsp;</div></li><li><div>          echo wp_json_encode( array(&nbsp;</div></li><li><div>              'success' =&gt; false, &nbsp;</div></li><li><div>              'data' =&gt; array(&nbsp;</div></li><li><div>                  'message' =&gt; __( 'Sorry, you are not allowed to attach files to this post.' ), &nbsp;</div></li><li><div>                  'filename' =&gt; $_FILES['async-upload']['name'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post_id = null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data = isset( $_REQUEST['post_data'] ) ? $_REQUEST['post_data'] : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the context is custom header or background, make sure the uploaded file is an image.</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['context'] ) && in_array( $post_data['context'], array( 'custom-header', 'custom-background' ) ) ) {&nbsp;</div></li><li><div>      $wp_filetype = wp_check_filetype_and_ext( $_FILES['async-upload']['tmp_name'], $_FILES['async-upload']['name'] );&nbsp;</div></li><li><div>      if ( ! wp_match_mime_types( 'image', $wp_filetype['type'] ) ) {&nbsp;</div></li><li><div>          echo wp_json_encode( array(&nbsp;</div></li><li><div>              'success' =&gt; false, &nbsp;</div></li><li><div>              'data' =&gt; array(&nbsp;</div></li><li><div>                  'message' =&gt; __( 'The uploaded file is not a valid image. Please try again.' ), &nbsp;</div></li><li><div>                  'filename' =&gt; $_FILES['async-upload']['name'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $attachment_id = media_handle_upload( 'async-upload', $post_id, $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $attachment_id ) ) {&nbsp;</div></li><li><div>      echo wp_json_encode( array(&nbsp;</div></li><li><div>          'success' =&gt; false, &nbsp;</div></li><li><div>          'data' =&gt; array(&nbsp;</div></li><li><div>              'message' =&gt; $attachment_id-&gt;get_error_message(), &nbsp;</div></li><li><div>              'filename' =&gt; $_FILES['async-upload']['name'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['context'] ) && isset( $post_data['theme'] ) ) {&nbsp;</div></li><li><div>      if ( 'custom-background' === $post_data['context'] )&nbsp;</div></li><li><div>          update_post_meta( $attachment_id, '_wp_attachment_is_custom_background', $post_data['theme'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'custom-header' === $post_data['context'] )&nbsp;</div></li><li><div>          update_post_meta( $attachment_id, '_wp_attachment_is_custom_header', $post_data['theme'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $attachment = wp_prepare_attachment_for_js( $attachment_id ) )&nbsp;</div></li><li><div>      wp_die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo wp_json_encode( array(&nbsp;</div></li><li><div>      'success' =&gt; true, &nbsp;</div></li><li><div>      'data' =&gt; $attachment, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for image editing.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_image_editor() {&nbsp;</div></li><li><div>  $attachment_id = intval($_POST['postid']);&nbsp;</div></li><li><div>  if ( empty($attachment_id) || !current_user_can('edit_post', $attachment_id) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;image_editor-$attachment_id&quot; );&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/image-edit.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $msg = false;&nbsp;</div></li><li><div>  switch ( $_POST['do'] ) {&nbsp;</div></li><li><div>      case 'save' :&nbsp;</div></li><li><div>          $msg = wp_save_image($attachment_id);&nbsp;</div></li><li><div>          $msg = wp_json_encode($msg);&nbsp;</div></li><li><div>          wp_die( $msg );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'scale' :&nbsp;</div></li><li><div>          $msg = wp_save_image($attachment_id);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'restore' :&nbsp;</div></li><li><div>          $msg = wp_restore_image($attachment_id);&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_image_editor($attachment_id, $msg);&nbsp;</div></li><li><div>  wp_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for setting the featured image.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_set_post_thumbnail() {&nbsp;</div></li><li><div>  $json = ! empty( $_REQUEST['json'] ); <span class="comment">// New-style request</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_ID = intval( $_POST['post_id'] );&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post_ID ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thumbnail_id = intval( $_POST['thumbnail_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $json )&nbsp;</div></li><li><div>      check_ajax_referer( &quot;update-post_$post_ID&quot; );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      check_ajax_referer( &quot;set_post_thumbnail-$post_ID&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $thumbnail_id == '-1' ) {&nbsp;</div></li><li><div>      if ( delete_post_thumbnail( $post_ID ) ) {&nbsp;</div></li><li><div>          $return = _wp_post_thumbnail_html( null, $post_ID );&nbsp;</div></li><li><div>          $json ? wp_send_json_success( $return ) : wp_die( $return );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_die( 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( set_post_thumbnail( $post_ID, $thumbnail_id ) ) {&nbsp;</div></li><li><div>      $return = _wp_post_thumbnail_html( $thumbnail_id, $post_ID );&nbsp;</div></li><li><div>      $json ? wp_send_json_success( $return ) : wp_die( $return );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_die( 0 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for retrieving HTML for the featured image.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_get_post_thumbnail_html() {&nbsp;</div></li><li><div>  $post_ID = intval( $_POST['post_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( &quot;update-post_$post_ID&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post_ID ) ) {&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thumbnail_id = intval( $_POST['thumbnail_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For backward compatibility, -1 refers to no featured image.</span>&nbsp;</div></li><li><div>  if ( -1 === $thumbnail_id ) {&nbsp;</div></li><li><div>      $thumbnail_id = null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = _wp_post_thumbnail_html( $thumbnail_id, $post_ID );&nbsp;</div></li><li><div>  wp_send_json_success( $return );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for setting the featured image for an attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see set_post_thumbnail()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_set_attachment_thumbnail() {&nbsp;</div></li><li><div>  if ( empty( $_POST['urls'] ) || ! is_array( $_POST['urls'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thumbnail_id = (int) $_POST['thumbnail_id'];&nbsp;</div></li><li><div>  if ( empty( $thumbnail_id ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_ids = array();&nbsp;</div></li><li><div>  <span class="comment">// For each URL, try to find its corresponding post ID.</span>&nbsp;</div></li><li><div>  foreach ( $_POST['urls'] as $url ) {&nbsp;</div></li><li><div>      $post_id = attachment_url_to_postid( $url );&nbsp;</div></li><li><div>      if ( ! empty( $post_id ) ) {&nbsp;</div></li><li><div>          $post_ids[] = $post_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post_ids ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $success = 0;&nbsp;</div></li><li><div>  <span class="comment">// For each found attachment, set its thumbnail.</span>&nbsp;</div></li><li><div>  foreach ( $post_ids as $post_id ) {&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_post', $post_id ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( set_post_thumbnail( $post_id, $thumbnail_id ) ) {&nbsp;</div></li><li><div>          $success++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 0 === $success ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_send_json_success();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_error();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for date formatting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_date_format() {&nbsp;</div></li><li><div>  wp_die( date_i18n( sanitize_option( 'date_format', wp_unslash( $_POST['date'] ) ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for time formatting.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_time_format() {&nbsp;</div></li><li><div>  wp_die( date_i18n( sanitize_option( 'time_format', wp_unslash( $_POST['date'] ) ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving posts from the fullscreen editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @deprecated 4.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_wp_fullscreen_save_post() {&nbsp;</div></li><li><div>  $post_id = isset( $_POST['post_ID'] ) ? (int) $_POST['post_ID'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post_id )&nbsp;</div></li><li><div>      $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer('update-post_' . $post_id, '_wpnonce');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = edit_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $post_id ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post ) {&nbsp;</div></li><li><div>      $last_date = mysql2date( __( 'F j, Y' ), $post-&gt;post_modified );&nbsp;</div></li><li><div>      $last_time = mysql2date( __( 'g:i a' ), $post-&gt;post_modified );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $last_date = date_i18n( __( 'F j, Y' ) );&nbsp;</div></li><li><div>      $last_time = date_i18n( __( 'g:i a' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $last_id = get_post_meta( $post_id, '_edit_last', true ) ) {&nbsp;</div></li><li><div>      $last_user = get_userdata( $last_id );&nbsp;</div></li><li><div>      $last_edited = sprintf( __('Last edited by %1$s on %2$s at %3$s'), esc_html( $last_user-&gt;display_name ), $last_date, $last_time );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $last_edited = sprintf( __('Last edited on %1$s at %2$s'), $last_date, $last_time );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( array( 'last_edited' =&gt; $last_edited ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for removing a post lock.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_wp_remove_post_lock() {&nbsp;</div></li><li><div>  if ( empty( $_POST['post_ID'] ) || empty( $_POST['active_post_lock'] ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>  $post_id = (int) $_POST['post_ID'];&nbsp;</div></li><li><div>  if ( ! $post = get_post( $post_id ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'update-post_' . $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post_id ) )&nbsp;</div></li><li><div>      wp_die( -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $active_lock = array_map( 'absint', explode( ':', $_POST['active_post_lock'] ) );&nbsp;</div></li><li><div>  if ( $active_lock[1] != get_current_user_id() )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the post lock window duration.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $interval The interval in seconds the post lock duration</span>&nbsp;</div></li><li><div><span class="comment">   *                      should last, plus 5 seconds. Default 150.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $new_lock = ( time() - apply_filters( 'wp_check_post_lock_window', 150 ) + 5 ) . ':' . $active_lock[1];&nbsp;</div></li><li><div>  update_post_meta( $post_id, '_edit_lock', $new_lock, implode( ':', $active_lock ) );&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for dismissing a WordPress pointer.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_dismiss_wp_pointer() {&nbsp;</div></li><li><div>  $pointer = $_POST['pointer'];&nbsp;</div></li><li><div>  if ( $pointer != sanitize_key( $pointer ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//    check_ajax_referer( 'dismiss-pointer_' . $pointer );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $dismissed = array_filter( explode( ', ', (string) get_user_meta( get_current_user_id(), 'dismissed_wp_pointers', true ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( in_array( $pointer, $dismissed ) )&nbsp;</div></li><li><div>      wp_die( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $dismissed[] = $pointer;&nbsp;</div></li><li><div>  $dismissed = implode( ', ', $dismissed );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_user_meta( get_current_user_id(), 'dismissed_wp_pointers', $dismissed );&nbsp;</div></li><li><div>  wp_die( 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for getting an attachment.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_get_attachment() {&nbsp;</div></li><li><div>  if ( ! isset( $_REQUEST['id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $id = absint( $_REQUEST['id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post = get_post( $id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'attachment' != $post-&gt;post_type )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'upload_files' ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $attachment = wp_prepare_attachment_for_js( $id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $attachment );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for querying attachments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_query_attachments() {&nbsp;</div></li><li><div>  if ( ! current_user_can( 'upload_files' ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = isset( $_REQUEST['query'] ) ? (array) $_REQUEST['query'] : array();&nbsp;</div></li><li><div>  $keys = array(&nbsp;</div></li><li><div>      's', 'order', 'orderby', 'posts_per_page', 'paged', 'post_mime_type', &nbsp;</div></li><li><div>      'post_parent', 'post__in', 'post__not_in', 'year', 'monthnum'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  foreach ( get_taxonomies_for_attachments( 'objects' ) as $t ) {&nbsp;</div></li><li><div>      if ( $t-&gt;query_var && isset( $query[ $t-&gt;query_var ] ) ) {&nbsp;</div></li><li><div>          $keys[] = $t-&gt;query_var;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = array_intersect_key( $query, array_flip( $keys ) );&nbsp;</div></li><li><div>  $query['post_type'] = 'attachment';&nbsp;</div></li><li><div>  if ( MEDIA_TRASH&nbsp;</div></li><li><div>      && ! empty( $_REQUEST['query']['post_status'] )&nbsp;</div></li><li><div>      && 'trash' === $_REQUEST['query']['post_status'] ) {&nbsp;</div></li><li><div>      $query['post_status'] = 'trash';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $query['post_status'] = 'inherit';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( get_post_type_object( 'attachment' )-&gt;cap-&gt;read_private_posts ) )&nbsp;</div></li><li><div>      $query['post_status'] .= ', private';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Filter query clauses to include filenames.</span>&nbsp;</div></li><li><div>  if ( isset( $query['s'] ) ) {&nbsp;</div></li><li><div>      add_filter( 'posts_clauses', '_filter_query_attachment_filenames' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the arguments passed to WP_Query during an Ajax</span>&nbsp;</div></li><li><div><span class="comment">   * call for querying attachments.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_Query::parse_query()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $query An array of query variables.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $query = apply_filters( 'ajax_query_attachments_args', $query );&nbsp;</div></li><li><div>  $query = new WP_Query( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posts = array_map( 'wp_prepare_attachment_for_js', $query-&gt;posts );&nbsp;</div></li><li><div>  $posts = array_filter( $posts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $posts );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for updating attachment attributes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_save_attachment() {&nbsp;</div></li><li><div>  if ( ! isset( $_REQUEST['id'] ) || ! isset( $_REQUEST['changes'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $id = absint( $_REQUEST['id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'update-post_' . $id, 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $changes = $_REQUEST['changes'];&nbsp;</div></li><li><div>  $post = get_post( $id, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'attachment' != $post['post_type'] )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $changes['parent'] ) )&nbsp;</div></li><li><div>      $post['post_parent'] = $changes['parent'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $changes['title'] ) )&nbsp;</div></li><li><div>      $post['post_title'] = $changes['title'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $changes['caption'] ) )&nbsp;</div></li><li><div>      $post['post_excerpt'] = $changes['caption'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $changes['description'] ) )&nbsp;</div></li><li><div>      $post['post_content'] = $changes['description'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( MEDIA_TRASH && isset( $changes['status'] ) )&nbsp;</div></li><li><div>      $post['post_status'] = $changes['status'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $changes['alt'] ) ) {&nbsp;</div></li><li><div>      $alt = wp_unslash( $changes['alt'] );&nbsp;</div></li><li><div>      if ( $alt != get_post_meta( $id, '_wp_attachment_image_alt', true ) ) {&nbsp;</div></li><li><div>          $alt = wp_strip_all_tags( $alt, true );&nbsp;</div></li><li><div>          update_post_meta( $id, '_wp_attachment_image_alt', wp_slash( $alt ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wp_attachment_is( 'audio', $post['ID'] ) ) {&nbsp;</div></li><li><div>      $changed = false;&nbsp;</div></li><li><div>      $id3data = wp_get_attachment_metadata( $post['ID'] );&nbsp;</div></li><li><div>      if ( ! is_array( $id3data ) ) {&nbsp;</div></li><li><div>          $changed = true;&nbsp;</div></li><li><div>          $id3data = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach ( wp_get_attachment_id3_keys( (object) $post, 'edit' ) as $key =&gt; $label ) {&nbsp;</div></li><li><div>          if ( isset( $changes[ $key ] ) ) {&nbsp;</div></li><li><div>              $changed = true;&nbsp;</div></li><li><div>              $id3data[ $key ] = sanitize_text_field( wp_unslash( $changes[ $key ] ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $changed ) {&nbsp;</div></li><li><div>          wp_update_attachment_metadata( $id, $id3data );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( MEDIA_TRASH && isset( $changes['status'] ) && 'trash' === $changes['status'] ) {&nbsp;</div></li><li><div>      wp_delete_post( $id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_update_post( $post );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving backward compatible attachment attributes.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_save_attachment_compat() {&nbsp;</div></li><li><div>  if ( ! isset( $_REQUEST['id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $id = absint( $_REQUEST['id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_REQUEST['attachments'] ) || empty( $_REQUEST['attachments'][ $id ] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  $attachment_data = $_REQUEST['attachments'][ $id ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'update-post_' . $id, 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post( $id, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'attachment' != $post['post_type'] )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span>&nbsp;</div></li><li><div>  $post = apply_filters( 'attachment_fields_to_save', $post, $attachment_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post['errors'] ) ) {&nbsp;</div></li><li><div>      $errors = $post['errors']; <span class="comment">// @todo return me and display me!</span>&nbsp;</div></li><li><div>      unset( $post['errors'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_update_post( $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( get_attachment_taxonomies( $post ) as $taxonomy ) {&nbsp;</div></li><li><div>      if ( isset( $attachment_data[ $taxonomy ] ) )&nbsp;</div></li><li><div>          wp_set_object_terms( $id, array_map( 'trim', preg_split( '/, +/', $attachment_data[ $taxonomy ] ) ), $taxonomy, false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $attachment = wp_prepare_attachment_for_js( $id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $attachment );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving the attachment order.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_save_attachment_order() {&nbsp;</div></li><li><div>  if ( ! isset( $_REQUEST['post_id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post_id = absint( $_REQUEST['post_id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_REQUEST['attachments'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'update-post_' . $post_id, 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $attachments = $_REQUEST['attachments'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post_id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $attachments as $attachment_id =&gt; $menu_order ) {&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_post', $attachment_id ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( ! $attachment = get_post( $attachment_id ) )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( 'attachment' != $attachment-&gt;post_type )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_update_post( array( 'ID' =&gt; $attachment_id, 'menu_order' =&gt; $menu_order ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for sending an attachment to the editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Generates the HTML to send an attachment to the editor.</span>&nbsp;</div></li><li><div><span class="comment"> * Backward compatible with the {@see 'media_send_to_editor'} filter</span>&nbsp;</div></li><li><div><span class="comment"> * and the chain of filters that follow.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_send_attachment_to_editor() {&nbsp;</div></li><li><div>  check_ajax_referer( 'media-send-to-editor', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $attachment = wp_unslash( $_POST['attachment'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id = intval( $attachment['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post = get_post( $id ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'attachment' != $post-&gt;post_type )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( 'edit_post', $id ) ) {&nbsp;</div></li><li><div>      <span class="comment">// If this attachment is unattached, attach it. Primarily a back compat thing.</span>&nbsp;</div></li><li><div>      if ( 0 == $post-&gt;post_parent && $insert_into_post_id = intval( $_POST['post_id'] ) ) {&nbsp;</div></li><li><div>          wp_update_post( array( 'ID' =&gt; $id, 'post_parent' =&gt; $insert_into_post_id ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = empty( $attachment['url'] ) ? '' : $attachment['url'];&nbsp;</div></li><li><div>  $rel = ( strpos( $url, 'attachment_id') || get_attachment_link( $id ) == $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_filter( 'media_send_to_editor', 'image_media_send_to_editor' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'image' === substr( $post-&gt;post_mime_type, 0, 5 ) ) {&nbsp;</div></li><li><div>      $align = isset( $attachment['align'] ) ? $attachment['align'] : 'none';&nbsp;</div></li><li><div>      $size = isset( $attachment['image-size'] ) ? $attachment['image-size'] : 'medium';&nbsp;</div></li><li><div>      $alt = isset( $attachment['image_alt'] ) ? $attachment['image_alt'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// No whitespace-only captions.</span>&nbsp;</div></li><li><div>      $caption = isset( $attachment['post_excerpt'] ) ? $attachment['post_excerpt'] : '';&nbsp;</div></li><li><div>      if ( '' === trim( $caption ) ) {&nbsp;</div></li><li><div>          $caption = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $title = ''; <span class="comment">// We no longer insert title tags into &lt;img&gt; tags, as they are redundant.</span>&nbsp;</div></li><li><div>      $html = get_image_send_to_editor( $id, $caption, $title, $align, $url, $rel, $size, $alt );&nbsp;</div></li><li><div>  } elseif ( wp_attachment_is( 'video', $post ) || wp_attachment_is( 'audio', $post ) ) {&nbsp;</div></li><li><div>      $html = stripslashes_deep( $_POST['html'] );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $html = isset( $attachment['post_title'] ) ? $attachment['post_title'] : '';&nbsp;</div></li><li><div>      $rel = $rel ? ' rel=&quot;attachment wp-att-' . $id . '&quot;' : ''; <span class="comment">// Hard-coded string, $id is already sanitized</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $url ) ) {&nbsp;</div></li><li><div>          $html = '&lt;a href=&quot;' . esc_url( $url ) . '&quot;' . $rel . '&gt;' . $html . '&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span>&nbsp;</div></li><li><div>  $html = apply_filters( 'media_send_to_editor', $html, $id, $attachment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $html );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for sending a link to the editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Generates the HTML to send a non-image embed link to the editor.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Backward compatible with the following filters:</span>&nbsp;</div></li><li><div><span class="comment"> * - file_send_to_editor_url</span>&nbsp;</div></li><li><div><span class="comment"> * - audio_send_to_editor_url</span>&nbsp;</div></li><li><div><span class="comment"> * - video_send_to_editor_url</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.5.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Post  $post</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Embed $wp_embed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_send_link_to_editor() {&nbsp;</div></li><li><div>  global $post, $wp_embed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'media-send-to-editor', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $src = wp_unslash( $_POST['src'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! strpos( $src, ':<span class="comment">//' ) )</span>&nbsp;</div></li><li><div>      $src = 'http:<span class="comment">//' . $src;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $src = esc_url_raw( $src ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $link_text = trim( wp_unslash( $_POST['link_text'] ) ) )&nbsp;</div></li><li><div>      $link_text = wp_basename( $src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post = get_post( isset( $_POST['post_id'] ) ? $_POST['post_id'] : 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Ping WordPress for an embed.</span>&nbsp;</div></li><li><div>  $check_embed = $wp_embed-&gt;run_shortcode( '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fallback that WordPress creates when no oEmbed was found.</span>&nbsp;</div></li><li><div>  $fallback = $wp_embed-&gt;maybe_make_link( $src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $check_embed !== $fallback ) {&nbsp;</div></li><li><div>      <span class="comment">// TinyMCE view for ';&nbsp;</div></li><li><div>  } elseif ( $link_text ) {&nbsp;</div></li><li><div>      $html = '&lt;a href=&quot;' . esc_url( $src ) . '&quot;&gt;' . $link_text . '&lt;/a&gt;';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $html = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Figure out what filter to run:</span>&nbsp;</div></li><li><div>  $type = 'file';&nbsp;</div></li><li><div>  if ( ( $ext = preg_replace( '/^.+?\.([^.]+)$/', '$1', $src ) ) && ( $ext_type = wp_ext2type( $ext ) )&nbsp;</div></li><li><div>      && ( 'audio' == $ext_type || 'video' == $ext_type ) )&nbsp;</div></li><li><div>          $type = $ext_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span></span>&nbsp;</div></li><li><div>  $html = apply_filters( $type . '_send_to_editor_url', $html, $src, $link_text );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $html );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for the Heartbeat API.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Runs when the user is logged in.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_heartbeat() {&nbsp;</div></li><li><div>  if ( empty( $_POST['_nonce'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $response = $data = array();&nbsp;</div></li><li><div>  $nonce_state = wp_verify_nonce( $_POST['_nonce'], 'heartbeat-nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// screen_id is the same as $current_screen-&gt;id and the JS global 'pagenow'.</span></span>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['screen_id'] ) ) {&nbsp;</div></li><li><div>      $screen_id = sanitize_key($_POST['screen_id']);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $screen_id = 'front';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['data'] ) ) {&nbsp;</div></li><li><div>      $data = wp_unslash( (array) $_POST['data'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 1 !== $nonce_state ) {&nbsp;</div></li><li><div>      $response = apply_filters( 'wp_refresh_nonces', $response, $data, $screen_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === $nonce_state ) {&nbsp;</div></li><li><div>          <span class="comment">// User is logged in but nonces have expired.</span>&nbsp;</div></li><li><div>          $response['nonces_expired'] = true;&nbsp;</div></li><li><div>          wp_send_json( $response );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $data ) ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filters the Heartbeat response received.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $response  The Heartbeat response.</span>&nbsp;</div></li><li><div><span class="comment">       * @param array  $data      The $_POST data sent.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $screen_id The screen id.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $response = apply_filters( 'heartbeat_received', $response, $data, $screen_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filters the Heartbeat response sent.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $response  The Heartbeat response.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $screen_id The screen id.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $response = apply_filters( 'heartbeat_send', $response, $screen_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fires when Heartbeat ticks in logged-in environments.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Allows the transport to be easily replaced with long-polling.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $response  The Heartbeat response.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $screen_id The screen id.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'heartbeat_tick', $response, $screen_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Send the current time according to the server</span>&nbsp;</div></li><li><div>  $response['server_time'] = time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json( $response );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for getting revision diffs.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_get_revision_diffs() {&nbsp;</div></li><li><div>  require ABSPATH . 'wp-admin/includes/revision.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post = get_post( (int) $_REQUEST['post_id'] ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'edit_post', $post-&gt;ID ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Really just pre-loading the cache here.</span>&nbsp;</div></li><li><div>  if ( ! $revisions = wp_get_post_revisions( $post-&gt;ID, array( 'check_enabled' =&gt; false ) ) )&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>  @set_time_limit( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $_REQUEST['compare'] as $compare_key ) {&nbsp;</div></li><li><div>      list( $compare_from, $compare_to ) = explode( ':', $compare_key ); <span class="comment">// from:to</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return[] = array(&nbsp;</div></li><li><div>          'id' =&gt; $compare_key, &nbsp;</div></li><li><div>          'fields' =&gt; wp_get_revision_ui_diff( $post, $compare_from, $compare_to ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  wp_send_json_success( $return );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for auto-saving the selected color scheme for</span>&nbsp;</div></li><li><div><span class="comment"> * a user's own profile.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $_wp_admin_css_colors</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_save_user_color_scheme() {&nbsp;</div></li><li><div>  global $_wp_admin_css_colors;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'save-color-scheme', 'nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $color_scheme = sanitize_key( $_POST['color_scheme'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $_wp_admin_css_colors[ $color_scheme ] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $previous_color_scheme = get_user_meta( get_current_user_id(), 'admin_color', true );&nbsp;</div></li><li><div>  update_user_meta( get_current_user_id(), 'admin_color', $color_scheme );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( array(&nbsp;</div></li><li><div>      'previousScheme' =&gt; 'admin-color-' . $previous_color_scheme, &nbsp;</div></li><li><div>      'currentScheme' =&gt; 'admin-color-' . $color_scheme&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for getting themes from themes_api().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $themes_allowedtags</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $theme_field_defaults</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_query_themes() {&nbsp;</div></li><li><div>  global $themes_allowedtags, $theme_field_defaults;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'install_themes' ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( wp_unslash( $_REQUEST['request'] ), array(&nbsp;</div></li><li><div>      'per_page' =&gt; 20, &nbsp;</div></li><li><div>      'fields' =&gt; $theme_field_defaults&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $args['browse'] ) && 'favorites' === $args['browse'] && ! isset( $args['user'] ) ) {&nbsp;</div></li><li><div>      $user = get_user_option( 'wporg_favorites' );&nbsp;</div></li><li><div>      if ( $user ) {&nbsp;</div></li><li><div>          $args['user'] = $user;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $old_filter = isset( $args['browse'] ) ? $args['browse'] : 'search';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** This filter is documented in wp-admin/includes/class-wp-theme-install-list-table.php */</span>&nbsp;</div></li><li><div>  $args = apply_filters( 'install_themes_table_api_args_' . $old_filter, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $api = themes_api( 'query_themes', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $api ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $update_php = network_admin_url( 'update.php?action=install-theme' );&nbsp;</div></li><li><div>  foreach ( $api-&gt;themes as &$theme ) {&nbsp;</div></li><li><div>      $theme-&gt;install_url = add_query_arg( array(&nbsp;</div></li><li><div>          'theme' =&gt; $theme-&gt;slug, &nbsp;</div></li><li><div>          '_wpnonce' =&gt; wp_create_nonce( 'install-theme_' . $theme-&gt;slug )&nbsp;</div></li><li><div> ), $update_php );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( current_user_can( 'switch_themes' ) ) {&nbsp;</div></li><li><div>          if ( is_multisite() ) {&nbsp;</div></li><li><div>              $theme-&gt;activate_url = add_query_arg( array(&nbsp;</div></li><li><div>                  'action' =&gt; 'enable', &nbsp;</div></li><li><div>                  '_wpnonce' =&gt; wp_create_nonce( 'enable-theme_' . $theme-&gt;slug ), &nbsp;</div></li><li><div>                  'theme' =&gt; $theme-&gt;slug, &nbsp;</div></li><li><div> ), network_admin_url( 'themes.php' ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $theme-&gt;activate_url = add_query_arg( array(&nbsp;</div></li><li><div>                  'action' =&gt; 'activate', &nbsp;</div></li><li><div>                  '_wpnonce' =&gt; wp_create_nonce( 'switch-theme_' . $theme-&gt;slug ), &nbsp;</div></li><li><div>                  'stylesheet' =&gt; $theme-&gt;slug, &nbsp;</div></li><li><div> ), admin_url( 'themes.php' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_multisite() && current_user_can( 'edit_theme_options' ) && current_user_can( 'customize' ) ) {&nbsp;</div></li><li><div>          $theme-&gt;customize_url = add_query_arg( array(&nbsp;</div></li><li><div>              'return' =&gt; urlencode( network_admin_url( 'theme-install.php', 'relative' ) ), &nbsp;</div></li><li><div> ), wp_customize_url( $theme-&gt;slug ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme-&gt;name = wp_kses( $theme-&gt;name, $themes_allowedtags );&nbsp;</div></li><li><div>      $theme-&gt;author = wp_kses( $theme-&gt;author, $themes_allowedtags );&nbsp;</div></li><li><div>      $theme-&gt;version = wp_kses( $theme-&gt;version, $themes_allowedtags );&nbsp;</div></li><li><div>      $theme-&gt;description = wp_kses( $theme-&gt;description, $themes_allowedtags );&nbsp;</div></li><li><div>      $theme-&gt;stars = wp_star_rating( array( 'rating' =&gt; $theme-&gt;rating, 'type' =&gt; 'percent', 'number' =&gt; $theme-&gt;num_ratings, 'echo' =&gt; false ) );&nbsp;</div></li><li><div>      $theme-&gt;num_ratings = number_format_i18n( $theme-&gt;num_ratings );&nbsp;</div></li><li><div>      $theme-&gt;preview_url = set_url_scheme( $theme-&gt;preview_url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $api );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Apply  Ajax handlers to a string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Post    $post       Global $post.</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Embed   $wp_embed   Embed API instance.</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Scripts $wp_scripts</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_parse_embed() {&nbsp;</div></li><li><div>  global $post, $wp_embed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $post = get_post( (int) $_POST['post_ID'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['shortcode'] ) || ! current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $shortcode = wp_unslash( $_POST['shortcode'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  preg_match( '/' . get_shortcode_regex() . '/s', $shortcode, $matches );&nbsp;</div></li><li><div>  $atts = shortcode_parse_atts( $matches[3] );&nbsp;</div></li><li><div>  if ( ! empty( $matches[5] ) ) {&nbsp;</div></li><li><div>      $url = $matches[5];&nbsp;</div></li><li><div>  } elseif ( ! empty( $atts['src'] ) ) {&nbsp;</div></li><li><div>      $url = $atts['src'];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $url = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parsed = false;&nbsp;</div></li><li><div>  setup_postdata( $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_embed-&gt;return_false_on_fail = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_ssl() && 0 === strpos( $url, 'http:<span class="comment">//' ) )</span> {&nbsp;</div></li><li><div>      <span class="comment">// Admin is ssl and the user pasted non-ssl URL.</span>&nbsp;</div></li><li><div>      <span class="comment">// Check if the provider supports ssl embeds and use that for the preview.</span>&nbsp;</div></li><li><div>      $ssl_shortcode = preg_replace( '%^(\\]*\\])http:<span class="comment">//%i', '$1https://', $shortcode );</span>&nbsp;</div></li><li><div>      $parsed = $wp_embed-&gt;run_shortcode( $ssl_shortcode );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $parsed ) {&nbsp;</div></li><li><div>          $no_ssl_support = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $url && ! $parsed ) {&nbsp;</div></li><li><div>      $parsed = $wp_embed-&gt;run_shortcode( $shortcode );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $parsed ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'type' =&gt; 'not-embeddable', &nbsp;</div></li><li><div>          'message' =&gt; sprintf( __( '%s failed to embed.' ), '&lt;code&gt;' . esc_html( $url ) . '&lt;/code&gt;' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( has_shortcode( $parsed, 'audio' ) || has_shortcode( $parsed, 'video' ) ) {&nbsp;</div></li><li><div>      $styles = '';&nbsp;</div></li><li><div>      $mce_styles = wpview_media_sandbox_styles();&nbsp;</div></li><li><div>      foreach ( $mce_styles as $style ) {&nbsp;</div></li><li><div>          $styles .= sprintf( '&lt;link rel=&quot;stylesheet&quot; href=&quot;%s&quot;/&gt;', $style );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $html = do_shortcode( $parsed );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_scripts;&nbsp;</div></li><li><div>      if ( ! empty( $wp_scripts ) ) {&nbsp;</div></li><li><div>          $wp_scripts-&gt;done = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      wp_print_scripts( 'wp-mediaelement' );&nbsp;</div></li><li><div>      $scripts = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parsed = $styles . $html . $scripts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $no_ssl_support ) || ( is_ssl() && ( preg_match( '%&lt;(iframe|script|embed) [^&gt;]*src=&quot;http:<span class="comment">//%', $parsed ) ||</span>&nbsp;</div></li><li><div>      preg_match( '%&lt;link [^&gt;]*href=&quot;http:<span class="comment">//%', $parsed ) ) ) ) {</span>&nbsp;</div></li><li><div>      <span class="comment">// Admin is ssl and the embed is not. Iframes, scripts, and other &quot;active content&quot; will be blocked.</span>&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'type' =&gt; 'not-ssl', &nbsp;</div></li><li><div>          'message' =&gt; __( 'This preview is unavailable in the editor.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( array(&nbsp;</div></li><li><div>      'body' =&gt; $parsed, &nbsp;</div></li><li><div>      'attr' =&gt; $wp_embed-&gt;last_attr&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Post    $post</span>&nbsp;</div></li><li><div><span class="comment"> * @global WP_Scripts $wp_scripts</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_parse_media_shortcode() {&nbsp;</div></li><li><div>  global $post, $wp_scripts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['shortcode'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $shortcode = wp_unslash( $_POST['shortcode'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['post_ID'] ) ) {&nbsp;</div></li><li><div>      $post = get_post( (int) $_POST['post_ID'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// the embed shortcode requires a post</span>&nbsp;</div></li><li><div>  if ( ! $post || ! current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>      if ( 'embed' === $shortcode ) {&nbsp;</div></li><li><div>          wp_send_json_error();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      setup_postdata( $post );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parsed = do_shortcode( $shortcode );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $parsed ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'type' =&gt; 'no-items', &nbsp;</div></li><li><div>          'message' =&gt; __( 'No items found.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $head = '';&nbsp;</div></li><li><div>  $styles = wpview_media_sandbox_styles();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $styles as $style ) {&nbsp;</div></li><li><div>      $head .= '&lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;' . $style . '&quot;&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $wp_scripts ) ) {&nbsp;</div></li><li><div>      $wp_scripts-&gt;done = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo $parsed;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 'playlist' === $_REQUEST['type'] ) {&nbsp;</div></li><li><div>      wp_underscore_playlist_templates();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_print_scripts( 'wp-playlist' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_print_scripts( array( 'froogaloop', 'wp-mediaelement' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( array(&nbsp;</div></li><li><div>      'head' =&gt; $head, &nbsp;</div></li><li><div>      'body' =&gt; ob_get_clean()&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for destroying multiple open sessions for a user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_destroy_sessions() {&nbsp;</div></li><li><div>  $user = get_userdata( (int) $_POST['user_id'] );&nbsp;</div></li><li><div>  if ( $user ) {&nbsp;</div></li><li><div>      if ( ! current_user_can( 'edit_user', $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          $user = false;&nbsp;</div></li><li><div>      } elseif ( ! wp_verify_nonce( $_POST['nonce'], 'update-user_' . $user-&gt;ID ) ) {&nbsp;</div></li><li><div>          $user = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $user ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'message' =&gt; __( 'Could not log out user sessions. Please try again.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sessions = WP_Session_Tokens::get_instance( $user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $user-&gt;ID === get_current_user_id() ) {&nbsp;</div></li><li><div>      $sessions-&gt;destroy_others( wp_get_session_token() );&nbsp;</div></li><li><div>      $message = __( 'You are now logged out everywhere else.' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $sessions-&gt;destroy_all();&nbsp;</div></li><li><div>      <span class="comment">/** translators: 1: User's display name. */</span>&nbsp;</div></li><li><div>      $message = sprintf( __( '%s has been logged out.' ), $user-&gt;display_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( array( 'message' =&gt; $message ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving a post from Press This.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_press_this_save_post() {&nbsp;</div></li><li><div>  include( ABSPATH . 'wp-admin/includes/class-wp-press-this.php' );&nbsp;</div></li><li><div>  $wp_press_this = new WP_Press_This();&nbsp;</div></li><li><div>  $wp_press_this-&gt;save_post();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for creating new category from Press This.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_press_this_add_category() {&nbsp;</div></li><li><div>  include( ABSPATH . 'wp-admin/includes/class-wp-press-this.php' );&nbsp;</div></li><li><div>  $wp_press_this = new WP_Press_This();&nbsp;</div></li><li><div>  $wp_press_this-&gt;add_category();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for cropping an image.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_crop_image() {&nbsp;</div></li><li><div>  $attachment_id = absint( $_POST['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'image_editor-' . $attachment_id, 'nonce' );&nbsp;</div></li><li><div>  if ( ! current_user_can( 'customize' ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $context = str_replace( '_', '-', $_POST['context'] );&nbsp;</div></li><li><div>  $data = array_map( 'absint', $_POST['cropDetails'] );&nbsp;</div></li><li><div>  $cropped = wp_crop_image( $attachment_id, $data['x1'], $data['y1'], $data['width'], $data['height'], $data['dst_width'], $data['dst_height'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $cropped || is_wp_error( $cropped ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array( 'message' =&gt; __( 'Image could not be processed.' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $context ) {&nbsp;</div></li><li><div>      case 'site-icon':&nbsp;</div></li><li><div>          require_once ABSPATH . '/wp-admin/includes/class-wp-site-icon.php';&nbsp;</div></li><li><div>          $wp_site_icon = new WP_Site_Icon();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Skip creating a new attachment if the attachment is a Site Icon.</span>&nbsp;</div></li><li><div>          if ( get_post_meta( $attachment_id, '_wp_attachment_context', true ) == $context ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Delete the temporary cropped file, we don't need it.</span>&nbsp;</div></li><li><div>              wp_delete_file( $cropped );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Additional sizes in wp_prepare_attachment_for_js().</span></span>&nbsp;</div></li><li><div>              add_filter( 'image_size_names_choose', array( $wp_site_icon, 'additional_sizes' ) );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** This filter is documented in wp-admin/custom-header.php */</span></span>&nbsp;</div></li><li><div>          $cropped = apply_filters( 'wp_create_file_in_uploads', $cropped, $attachment_id ); <span class="comment"><span class="comment">// For replication.</span></span>&nbsp;</div></li><li><div>          $object = $wp_site_icon-&gt;create_attachment_object( $cropped, $attachment_id );&nbsp;</div></li><li><div>          unset( $object['ID'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Update the attachment.</span>&nbsp;</div></li><li><div>          add_filter( 'intermediate_image_sizes_advanced', array( $wp_site_icon, 'additional_sizes' ) );&nbsp;</div></li><li><div>          $attachment_id = $wp_site_icon-&gt;insert_attachment( $object, $cropped );&nbsp;</div></li><li><div>          remove_filter( 'intermediate_image_sizes_advanced', array( $wp_site_icon, 'additional_sizes' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Additional sizes in wp_prepare_attachment_for_js().</span></span>&nbsp;</div></li><li><div>          add_filter( 'image_size_names_choose', array( $wp_site_icon, 'additional_sizes' ) );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires before a cropped image is saved.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Allows to add filters to modify the way a cropped image is saved.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $context       The Customizer control requesting the cropped image.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $attachment_id The attachment ID of the original image.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $cropped       Path to the cropped image file.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'wp_ajax_crop_image_pre_save', $context, $attachment_id, $cropped );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** This filter is documented in wp-admin/custom-header.php */</span></span>&nbsp;</div></li><li><div>          $cropped = apply_filters( 'wp_create_file_in_uploads', $cropped, $attachment_id ); <span class="comment"><span class="comment">// For replication.</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parent_url = wp_get_attachment_url( $attachment_id );&nbsp;</div></li><li><div>          $url = str_replace( basename( $parent_url ), basename( $cropped ), $parent_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $size = @getimagesize( $cropped );&nbsp;</div></li><li><div>          $image_type = ( $size ) ? $size['mime'] : 'image/jpeg';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $object = array(&nbsp;</div></li><li><div>              'post_title' =&gt; basename( $cropped ), &nbsp;</div></li><li><div>              'post_content' =&gt; $url, &nbsp;</div></li><li><div>              'post_mime_type' =&gt; $image_type, &nbsp;</div></li><li><div>              'guid' =&gt; $url, &nbsp;</div></li><li><div>              'context' =&gt; $context, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $attachment_id = wp_insert_attachment( $object, $cropped );&nbsp;</div></li><li><div>          $metadata = wp_generate_attachment_metadata( $attachment_id, $cropped );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the cropped image attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @see wp_generate_attachment_metadata()</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $metadata Attachment metadata.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $metadata = apply_filters( 'wp_ajax_cropped_attachment_metadata', $metadata );&nbsp;</div></li><li><div>          wp_update_attachment_metadata( $attachment_id, $metadata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the attachment ID for a cropped image.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 4.3.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param int    $attachment_id The attachment ID of the cropped image.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $context       The Customizer control requesting the cropped image.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $attachment_id = apply_filters( 'wp_ajax_cropped_attachment_id', $attachment_id, $context );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( wp_prepare_attachment_for_js( $attachment_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for generating a password.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_generate_password() {&nbsp;</div></li><li><div>  wp_send_json_success( wp_generate_password( 24 ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for saving the user's WordPress.org username.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_save_wporg_username() {&nbsp;</div></li><li><div>  if ( ! current_user_can( 'install_themes' ) && ! current_user_can( 'install_plugins' ) ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  check_ajax_referer( 'save_wporg_username_' . get_current_user_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $username = isset( $_REQUEST['username'] ) ? wp_unslash( $_REQUEST['username'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $username ) {&nbsp;</div></li><li><div>      wp_send_json_error();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( update_user_meta( get_current_user_id(), 'wporg_favorites', $username ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for installing a theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see Theme_Upgrader</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_install_theme() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['slug'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'slug' =&gt; '', &nbsp;</div></li><li><div>          'errorCode' =&gt; 'no_theme_specified', &nbsp;</div></li><li><div>          'errorMessage' =&gt; __( 'No theme specified.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $slug = sanitize_key( wp_unslash( $_POST['slug'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = array(&nbsp;</div></li><li><div>      'install' =&gt; 'theme', &nbsp;</div></li><li><div>      'slug' =&gt; $slug, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'install_themes' ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to install themes on this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' );&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/theme.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $api = themes_api( 'theme_information', array(&nbsp;</div></li><li><div>      'slug' =&gt; $slug, &nbsp;</div></li><li><div>      'fields' =&gt; array( 'sections' =&gt; false ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $api ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $api-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $skin = new WP_Ajax_Upgrader_Skin();&nbsp;</div></li><li><div>  $upgrader = new Theme_Upgrader( $skin );&nbsp;</div></li><li><div>  $result = $upgrader-&gt;install( $api-&gt;download_link );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {&nbsp;</div></li><li><div>      $status['debug'] = $skin-&gt;get_upgrade_messages();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>      $status['errorCode'] = $result-&gt;get_error_code();&nbsp;</div></li><li><div>      $status['errorMessage'] = $result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $skin-&gt;result ) ) {&nbsp;</div></li><li><div>      $status['errorCode'] = $skin-&gt;result-&gt;get_error_code();&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( $skin-&gt;get_errors()-&gt;get_error_code() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;get_error_messages();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( is_null( $result ) ) {&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status['errorCode'] = 'unable_to_connect_to_filesystem';&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Unable to connect to the filesystem. Please confirm your credentials.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Pass through the error from WP_Filesystem if one was raised.</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ( $wp_filesystem instanceof WP_Filesystem_Base && is_wp_error( $wp_filesystem-&gt;errors ) && $wp_filesystem-&gt;errors-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = esc_html( $wp_filesystem-&gt;errors-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status['themeName'] = wp_get_theme( $slug )-&gt;get( 'Name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( 'switch_themes' ) ) {&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $status['activateUrl'] = add_query_arg( array(&nbsp;</div></li><li><div>              'action' =&gt; 'enable', &nbsp;</div></li><li><div>              '_wpnonce' =&gt; wp_create_nonce( 'enable-theme_' . $slug ), &nbsp;</div></li><li><div>              'theme' =&gt; $slug, &nbsp;</div></li><li><div> ), network_admin_url( 'themes.php' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $status['activateUrl'] = add_query_arg( array(&nbsp;</div></li><li><div>              'action' =&gt; 'activate', &nbsp;</div></li><li><div>              '_wpnonce' =&gt; wp_create_nonce( 'switch-theme_' . $slug ), &nbsp;</div></li><li><div>              'stylesheet' =&gt; $slug, &nbsp;</div></li><li><div> ), admin_url( 'themes.php' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_multisite() && current_user_can( 'edit_theme_options' ) && current_user_can( 'customize' ) ) {&nbsp;</div></li><li><div>      $status['customizeUrl'] = add_query_arg( array(&nbsp;</div></li><li><div>          'return' =&gt; urlencode( network_admin_url( 'theme-install.php', 'relative' ) ), &nbsp;</div></li><li><div> ), wp_customize_url( $slug ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * See WP_Theme_Install_List_Table::_get_theme_status() if we wanted to check</span>&nbsp;</div></li><li><div><span class="comment">   * on post-install status.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  wp_send_json_success( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for updating a theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see Theme_Upgrader</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_update_theme() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['slug'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'slug' =&gt; '', &nbsp;</div></li><li><div>          'errorCode' =&gt; 'no_theme_specified', &nbsp;</div></li><li><div>          'errorMessage' =&gt; __( 'No theme specified.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stylesheet = preg_replace( '/[^A-z0-9_\-]/', '', wp_unslash( $_POST['slug'] ) );&nbsp;</div></li><li><div>  $status = array(&nbsp;</div></li><li><div>      'update' =&gt; 'theme', &nbsp;</div></li><li><div>      'slug' =&gt; $stylesheet, &nbsp;</div></li><li><div>      'newVersion' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'update_themes' ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to update themes for this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current = get_site_transient( 'update_themes' );&nbsp;</div></li><li><div>  if ( empty( $current ) ) {&nbsp;</div></li><li><div>      wp_update_themes();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $skin = new WP_Ajax_Upgrader_Skin();&nbsp;</div></li><li><div>  $upgrader = new Theme_Upgrader( $skin );&nbsp;</div></li><li><div>  $result = $upgrader-&gt;bulk_upgrade( array( $stylesheet ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {&nbsp;</div></li><li><div>      $status['debug'] = $skin-&gt;get_upgrade_messages();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $skin-&gt;result ) ) {&nbsp;</div></li><li><div>      $status['errorCode'] = $skin-&gt;result-&gt;get_error_code();&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( $skin-&gt;get_errors()-&gt;get_error_code() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;get_error_messages();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( is_array( $result ) && ! empty( $result[ $stylesheet ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Theme is already at the latest version.</span>&nbsp;</div></li><li><div>      if ( true === $result[ $stylesheet ] ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = $upgrader-&gt;strings['up_to_date'];&nbsp;</div></li><li><div>          wp_send_json_error( $status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme = wp_get_theme( $stylesheet );&nbsp;</div></li><li><div>      if ( $theme-&gt;get( 'Version' ) ) {&nbsp;</div></li><li><div>          $status['newVersion'] = $theme-&gt;get( 'Version' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_success( $status );&nbsp;</div></li><li><div>  } elseif ( false === $result ) {&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status['errorCode'] = 'unable_to_connect_to_filesystem';&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Unable to connect to the filesystem. Please confirm your credentials.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Pass through the error from WP_Filesystem if one was raised.</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ( $wp_filesystem instanceof WP_Filesystem_Base && is_wp_error( $wp_filesystem-&gt;errors ) && $wp_filesystem-&gt;errors-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = esc_html( $wp_filesystem-&gt;errors-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// An unhandled error occurred.</span></span>&nbsp;</div></li><li><div>  $status['errorMessage'] = __( 'Update failed.' );&nbsp;</div></li><li><div>  wp_send_json_error( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting a theme.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see delete_theme()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_theme() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['slug'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'slug' =&gt; '', &nbsp;</div></li><li><div>          'errorCode' =&gt; 'no_theme_specified', &nbsp;</div></li><li><div>          'errorMessage' =&gt; __( 'No theme specified.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stylesheet = preg_replace( '/[^A-z0-9_\-]/', '', wp_unslash( $_POST['slug'] ) );&nbsp;</div></li><li><div>  $status = array(&nbsp;</div></li><li><div>      'delete' =&gt; 'theme', &nbsp;</div></li><li><div>      'slug' =&gt; $stylesheet, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'delete_themes' ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to delete themes on this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wp_get_theme( $stylesheet )-&gt;exists() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'The requested theme does not exist.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check filesystem credentials. `delete_theme()` will bail otherwise.</span>&nbsp;</div></li><li><div>  $url = wp_nonce_url( 'themes.php?action=delete&stylesheet=' . urlencode( $stylesheet ), 'delete-theme_' . $stylesheet );&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $credentials = request_filesystem_credentials( $url );&nbsp;</div></li><li><div>  ob_end_clean();&nbsp;</div></li><li><div>  if ( false === $credentials || ! WP_Filesystem( $credentials ) ) {&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status['errorCode'] = 'unable_to_connect_to_filesystem';&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Unable to connect to the filesystem. Please confirm your credentials.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Pass through the error from WP_Filesystem if one was raised.</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ( $wp_filesystem instanceof WP_Filesystem_Base && is_wp_error( $wp_filesystem-&gt;errors ) && $wp_filesystem-&gt;errors-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = esc_html( $wp_filesystem-&gt;errors-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/theme.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = delete_theme( $stylesheet );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( false === $result ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Theme could not be deleted.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for installing a plugin.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see Plugin_Upgrader</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_install_plugin() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['slug'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'slug' =&gt; '', &nbsp;</div></li><li><div>          'errorCode' =&gt; 'no_plugin_specified', &nbsp;</div></li><li><div>          'errorMessage' =&gt; __( 'No plugin specified.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = array(&nbsp;</div></li><li><div>      'install' =&gt; 'plugin', &nbsp;</div></li><li><div>      'slug' =&gt; sanitize_key( wp_unslash( $_POST['slug'] ) ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'install_plugins' ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to install plugins on this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' );&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/plugin-install.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $api = plugins_api( 'plugin_information', array(&nbsp;</div></li><li><div>      'slug' =&gt; sanitize_key( wp_unslash( $_POST['slug'] ) ), &nbsp;</div></li><li><div>      'fields' =&gt; array(&nbsp;</div></li><li><div>          'sections' =&gt; false, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $api ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $api-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status['pluginName'] = $api-&gt;name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $skin = new WP_Ajax_Upgrader_Skin();&nbsp;</div></li><li><div>  $upgrader = new Plugin_Upgrader( $skin );&nbsp;</div></li><li><div>  $result = $upgrader-&gt;install( $api-&gt;download_link );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {&nbsp;</div></li><li><div>      $status['debug'] = $skin-&gt;get_upgrade_messages();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>      $status['errorCode'] = $result-&gt;get_error_code();&nbsp;</div></li><li><div>      $status['errorMessage'] = $result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( is_wp_error( $skin-&gt;result ) ) {&nbsp;</div></li><li><div>      $status['errorCode'] = $skin-&gt;result-&gt;get_error_code();&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( $skin-&gt;get_errors()-&gt;get_error_code() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;get_error_messages();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( is_null( $result ) ) {&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status['errorCode'] = 'unable_to_connect_to_filesystem';&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Unable to connect to the filesystem. Please confirm your credentials.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Pass through the error from WP_Filesystem if one was raised.</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ( $wp_filesystem instanceof WP_Filesystem_Base && is_wp_error( $wp_filesystem-&gt;errors ) && $wp_filesystem-&gt;errors-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = esc_html( $wp_filesystem-&gt;errors-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $install_status = install_plugin_install_status( $api );&nbsp;</div></li><li><div>  $pagenow = isset( $_POST['pagenow'] ) ? sanitize_key( $_POST['pagenow'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If install request is coming from import page, do not return network activation link.</span>&nbsp;</div></li><li><div>  $plugins_url = ( 'import' === $pagenow ) ? admin_url( 'plugins.php' ) : network_admin_url( 'plugins.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( 'activate_plugins' ) && is_plugin_inactive( $install_status['file'] ) ) {&nbsp;</div></li><li><div>      $status['activateUrl'] = add_query_arg( array(&nbsp;</div></li><li><div>          '_wpnonce' =&gt; wp_create_nonce( 'activate-plugin_' . $install_status['file'] ), &nbsp;</div></li><li><div>          'action' =&gt; 'activate', &nbsp;</div></li><li><div>          'plugin' =&gt; $install_status['file'], &nbsp;</div></li><li><div> ), $plugins_url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_multisite() && current_user_can( 'manage_network_plugins' ) && 'import' !== $pagenow ) {&nbsp;</div></li><li><div>      $status['activateUrl'] = add_query_arg( array( 'networkwide' =&gt; 1 ), $status['activateUrl'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for updating a plugin.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see Plugin_Upgrader</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_update_plugin() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['plugin'] ) || empty( $_POST['slug'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'slug' =&gt; '', &nbsp;</div></li><li><div>          'errorCode' =&gt; 'no_plugin_specified', &nbsp;</div></li><li><div>          'errorMessage' =&gt; __( 'No plugin specified.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $plugin = plugin_basename( sanitize_text_field( wp_unslash( $_POST['plugin'] ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = array(&nbsp;</div></li><li><div>      'update' =&gt; 'plugin', &nbsp;</div></li><li><div>      'slug' =&gt; sanitize_key( wp_unslash( $_POST['slug'] ) ), &nbsp;</div></li><li><div>      'oldVersion' =&gt; '', &nbsp;</div></li><li><div>      'newVersion' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'update_plugins' ) || 0 !== validate_file( $plugin ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to update plugins for this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $plugin_data = get_plugin_data( WP_PLUGIN_DIR . '/' . $plugin );&nbsp;</div></li><li><div>  $status['plugin'] = $plugin;&nbsp;</div></li><li><div>  $status['pluginName'] = $plugin_data['Name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $plugin_data['Version'] ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** translators: %s: Plugin version */</span></span>&nbsp;</div></li><li><div>      $status['oldVersion'] = sprintf( __( 'Version %s' ), $plugin_data['Version'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_update_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $skin = new WP_Ajax_Upgrader_Skin();&nbsp;</div></li><li><div>  $upgrader = new Plugin_Upgrader( $skin );&nbsp;</div></li><li><div>  $result = $upgrader-&gt;bulk_upgrade( array( $plugin ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {&nbsp;</div></li><li><div>      $status['debug'] = $skin-&gt;get_upgrade_messages();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $skin-&gt;result ) ) {&nbsp;</div></li><li><div>      $status['errorCode'] = $skin-&gt;result-&gt;get_error_code();&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( $skin-&gt;get_errors()-&gt;get_error_code() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $skin-&gt;get_error_messages();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( is_array( $result ) && ! empty( $result[ $plugin ] ) ) {&nbsp;</div></li><li><div>      $plugin_update_data = current( $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * If the `update_plugins` site transient is empty (e.g. when you update</span>&nbsp;</div></li><li><div><span class="comment">       * two plugins in quick succession before the transient repopulates), </span>&nbsp;</div></li><li><div><span class="comment">       * this may be the return.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Preferably something can be done to ensure `update_plugins` isn't empty.</span>&nbsp;</div></li><li><div><span class="comment">       * For now, surface some sort of error here.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( true === $plugin_update_data ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = __( 'Plugin update failed.' );&nbsp;</div></li><li><div>          wp_send_json_error( $status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugin_data = get_plugins( '/' . $result[ $plugin ]['destination_name'] );&nbsp;</div></li><li><div>      $plugin_data = reset( $plugin_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $plugin_data['Version'] ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** translators: %s: Plugin version */</span></span>&nbsp;</div></li><li><div>          $status['newVersion'] = sprintf( __( 'Version %s' ), $plugin_data['Version'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_send_json_success( $status );&nbsp;</div></li><li><div>  } elseif ( false === $result ) {&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status['errorCode'] = 'unable_to_connect_to_filesystem';&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Unable to connect to the filesystem. Please confirm your credentials.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Pass through the error from WP_Filesystem if one was raised.</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ( $wp_filesystem instanceof WP_Filesystem_Base && is_wp_error( $wp_filesystem-&gt;errors ) && $wp_filesystem-&gt;errors-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = esc_html( $wp_filesystem-&gt;errors-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// An unhandled error occurred.</span></span>&nbsp;</div></li><li><div>  $status['errorMessage'] = __( 'Plugin update failed.' );&nbsp;</div></li><li><div>  wp_send_json_error( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for deleting a plugin.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see delete_plugins()</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_delete_plugin() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $_POST['slug'] ) || empty( $_POST['plugin'] ) ) {&nbsp;</div></li><li><div>      wp_send_json_error( array(&nbsp;</div></li><li><div>          'slug' =&gt; '', &nbsp;</div></li><li><div>          'errorCode' =&gt; 'no_plugin_specified', &nbsp;</div></li><li><div>          'errorMessage' =&gt; __( 'No plugin specified.' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $plugin = plugin_basename( sanitize_text_field( wp_unslash( $_POST['plugin'] ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = array(&nbsp;</div></li><li><div>      'delete' =&gt; 'plugin', &nbsp;</div></li><li><div>      'slug' =&gt; sanitize_key( wp_unslash( $_POST['slug'] ) ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! current_user_can( 'delete_plugins' ) || 0 !== validate_file( $plugin ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to delete plugins for this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $plugin_data = get_plugin_data( WP_PLUGIN_DIR . '/' . $plugin );&nbsp;</div></li><li><div>  $status['plugin'] = $plugin;&nbsp;</div></li><li><div>  $status['pluginName'] = $plugin_data['Name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_plugin_active( $plugin ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'You cannot delete a plugin while it is active on the main site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check filesystem credentials. `delete_plugins()` will bail otherwise.</span>&nbsp;</div></li><li><div>  $url = wp_nonce_url( 'plugins.php?action=delete-selected&verify-delete=1&checked[]=' . $plugin, 'bulk-plugins' );&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $credentials = request_filesystem_credentials( $url );&nbsp;</div></li><li><div>  ob_end_clean();&nbsp;</div></li><li><div>  if ( false === $credentials || ! WP_Filesystem( $credentials ) ) {&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $status['errorCode'] = 'unable_to_connect_to_filesystem';&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Unable to connect to the filesystem. Please confirm your credentials.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Pass through the error from WP_Filesystem if one was raised.</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ( $wp_filesystem instanceof WP_Filesystem_Base && is_wp_error( $wp_filesystem-&gt;errors ) && $wp_filesystem-&gt;errors-&gt;get_error_code() ) {&nbsp;</div></li><li><div>          $status['errorMessage'] = esc_html( $wp_filesystem-&gt;errors-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = delete_plugins( array( $plugin ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = $result-&gt;get_error_message();&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  } elseif ( false === $result ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Plugin could not be deleted.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for searching plugins.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global string $s Search term.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_search_plugins() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pagenow = isset( $_POST['pagenow'] ) ? sanitize_key( $_POST['pagenow'] ) : '';&nbsp;</div></li><li><div>  if ( 'plugins-network' === $pagenow || 'plugins' === $pagenow ) {&nbsp;</div></li><li><div>      set_current_screen( $pagenow );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var WP_Plugins_List_Table $wp_list_table */</span>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( 'WP_Plugins_List_Table', array(&nbsp;</div></li><li><div>      'screen' =&gt; get_current_screen(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $wp_list_table-&gt;ajax_user_can() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to manage plugins for this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Set the correct requester, so pagination works.</span></span>&nbsp;</div></li><li><div>  $_SERVER['REQUEST_URI'] = add_query_arg( array_diff_key( $_POST, array(&nbsp;</div></li><li><div>      '_ajax_nonce' =&gt; null, &nbsp;</div></li><li><div>      'action' =&gt; null, &nbsp;</div></li><li><div> ) ), network_admin_url( 'plugins.php', 'relative' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $GLOBALS['s'] = wp_unslash( $_POST['s'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table-&gt;prepare_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $wp_list_table-&gt;display();&nbsp;</div></li><li><div>  $status['count'] = count( $wp_list_table-&gt;items );&nbsp;</div></li><li><div>  $status['items'] = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Ajax handler for searching plugins to install.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.6.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wp_ajax_search_install_plugins() {&nbsp;</div></li><li><div>  check_ajax_referer( 'updates' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pagenow = isset( $_POST['pagenow'] ) ? sanitize_key( $_POST['pagenow'] ) : '';&nbsp;</div></li><li><div>  if ( 'plugin-install-network' === $pagenow || 'plugin-install' === $pagenow ) {&nbsp;</div></li><li><div>      set_current_screen( $pagenow );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var WP_Plugin_Install_List_Table $wp_list_table */</span>&nbsp;</div></li><li><div>  $wp_list_table = _get_list_table( 'WP_Plugin_Install_List_Table', array(&nbsp;</div></li><li><div>      'screen' =&gt; get_current_screen(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $status = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $wp_list_table-&gt;ajax_user_can() ) {&nbsp;</div></li><li><div>      $status['errorMessage'] = __( 'Sorry, you are not allowed to manage plugins for this site.' );&nbsp;</div></li><li><div>      wp_send_json_error( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Set the correct requester, so pagination works.</span></span>&nbsp;</div></li><li><div>  $_SERVER['REQUEST_URI'] = add_query_arg( array_diff_key( $_POST, array(&nbsp;</div></li><li><div>      '_ajax_nonce' =&gt; null, &nbsp;</div></li><li><div>      'action' =&gt; null, &nbsp;</div></li><li><div> ) ), network_admin_url( 'plugin-install.php', 'relative' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wp_list_table-&gt;prepare_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $wp_list_table-&gt;display();&nbsp;</div></li><li><div>  $status['count'] = (int) $wp_list_table-&gt;get_pagination_arg( 'total_items' );&nbsp;</div></li><li><div>  $status['items'] = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_send_json_success( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>wordpress</li><li><span></span>file</li><li><span></span></li><li><span></span>wp-admin</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>