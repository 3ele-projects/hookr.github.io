<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.6.5" data-slug="woocommerce-pdf-invoices-packing-slips" data-type="class" data-id="76851"><head xmlns="http://www.w3.org/1999/xhtml"><title> cpdf | class | Woocommerce Pdf Invoices Packing Slips | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Cpdf, class, plugin, woocommerce-pdf-invoices-packing-slips, 1.6.5" /><meta name="description" content="A PHP class to provide the basic functionality to create a pdf document without any requirement for additional modules." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=37a4264dd350a2fe5205de3f3d57eb6b' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/cpdf/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fcpdf%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fcpdf%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-pdf-invoices-packing-slips-1.6.5-class-cpdf","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="cpdf" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-pdf-invoices-pack&hellip;." href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/" class="plugin"><span property="name">woocommerce-pdf-invoices-pack&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.6.5." href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/" class="H_VERSION"><span property="name">1.6.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">cpdf</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="269"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/all/" title="All">All <span class="count badge">269</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="132"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/hooks/" title="Hooks">Hooks <span class="count badge">132</span></a></li><li class="" data-id="action" data-count="38"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/actions/" title="Actions">Actions <span class="count badge">38</span></a></li><li class="" data-id="filter" data-count="94"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/filters/" title="Filters">Filters <span class="count badge">94</span></a></li><li class="active" data-id="class" data-count="121"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/classes/" title="Classes">Classes <span class="count badge">121</span></a></li><li class="" data-id="constant" data-count="9"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/constants/" title="Constants">Constants <span class="count badge">9</span></a></li><li class="" data-id="function" data-count="7"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/functions/" title="Functions">Functions <span class="count badge">7</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Cpdf</strong></h1><p>A PHP class to provide the basic functionality to create a pdf document without any requirement for additional modules.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/files/lib-dompdf-lib-class-pdf/" class="file">/lib/dompdf/lib/class.pdf.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class Cpdf {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The current number of pdf objects in the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $numObj = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array This array contains all of the pdf objects, ready for final assembly&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $objects = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The objectId (number within the objects array) of the document catalog&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $catalogId;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Array carrying information about the fonts that the system currently knows about&nbsp;</div></li><li><div>   * Used to ensure that a font is not loaded twice, among other things&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $fonts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string The default font metrics file to use if no other font has been loaded.&nbsp;</div></li><li><div>   * The path to the directory containing the font metrics should be included&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $defaultFont = './fonts/Helvetica.afm';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @string A record of the current font&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentFont = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string The current base font&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentBaseFont = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The number of the current font within the font array&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentFontNum = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentNode;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Object number of the current page&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentPage;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Object number of the currently active contents block&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentContents;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Number of fonts within the system&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $numFonts = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Number of graphic state resources used&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private $numStates = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Current color for fill operations, defaults to inactive value, &nbsp;</div></li><li><div>   * all three components should be between 0 and 1 inclusive when active&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentColor = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Current color for stroke operations (lines etc.)&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentStrokeColor = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string Current style that lines are drawn in&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentLineStyle = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Current line transparency (partial graphics state)&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentLineTransparency = array(&quot;mode&quot; =&gt; &quot;Normal&quot;, &quot;opacity&quot; =&gt; 1.0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * array Current fill transparency (partial graphics state)&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentFillTransparency = array(&quot;mode&quot; =&gt; &quot;Normal&quot;, &quot;opacity&quot; =&gt; 1.0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array An array which is used to save the state of the document, mainly the colors and styles&nbsp;</div></li><li><div>   * it is used to temporarily change to another state, the change back to what it was before&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $stateStack = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Number of elements within the state stack&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $nStateStack = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Number of page objects within the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $numPages = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Object Id storage stack&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $stack = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Number of elements within the object Id storage stack&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $nStack = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * an array which contains information about the objects which are not firmly attached to pages&nbsp;</div></li><li><div>   * these have been added with the addObject function&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $looseObjects = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * array contains infomation about how the loose objects are to be added to the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $addLooseObjects = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The objectId of the information object for the document&nbsp;</div></li><li><div>   * this contains authorship, title etc.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $infoObject = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer Number of images being tracked within the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $numImages = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array An array containing options about the document&nbsp;</div></li><li><div>   * it defaults to turning on the compression of the objects&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $options = array('compression' =&gt; true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The objectId of the first page of the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $firstPageId;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var float Used to track the last used value of the inter-word spacing, this is so that it is known&nbsp;</div></li><li><div>   * when the spacing is changed.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $wordSpaceAdjust = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var float Used to track the last used value of the inter-letter spacing, this is so that it is known&nbsp;</div></li><li><div>   * when the spacing is changed.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $charSpaceAdjust = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The object Id of the procset object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $procsetObjectId;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Store the information about the relationship between font families&nbsp;</div></li><li><div>   * this used so that the code knows which font is the bold version of another font, etc.&nbsp;</div></li><li><div>   * the value of this array is initialised in the constuctor function.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $fontFamilies = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string Folder for php serialized formats of font metrics files.&nbsp;</div></li><li><div>   * If empty string, use same folder as original metrics files.&nbsp;</div></li><li><div>   * This can be passed in from class creator.&nbsp;</div></li><li><div>   * If this folder does not exist or is not writable, Cpdf will be **much** slower.&nbsp;</div></li><li><div>   * Because of potential trouble with php safe mode, folder cannot be created at runtime.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $fontcache = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The version of the font metrics cache file.&nbsp;</div></li><li><div>   * This value must be manually incremented whenever the internal font data structure is modified.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $fontcacheVersion = 6;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string Temporary folder.&nbsp;</div></li><li><div>   * If empty string, will attempty system tmp folder.&nbsp;</div></li><li><div>   * This can be passed in from class creator.&nbsp;</div></li><li><div>   * Only used for conversion of gd images to jpeg images.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $tmp = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string Track if the current font is bolded or italicised&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $currentTextState = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string Messages are stored here during processing, these can be selected afterwards to give some useful debug information&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $messages = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string The ancryption array for the document encryption is stored here&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $arc4 = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The object Id of the encryption information&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $arc4_objnum = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string The file identifier, used to uniquely identify a pdf document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $fileIdentifier = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var boolean A flag to say if a document is to be encrypted or not&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $encrypted = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string The encryption key for the encryption of all the document content (structure is not encrypted)&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $encryptionKey = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Array which forms a stack to keep track of nested callback functions&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $callback = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var integer The number of callback functions in the callback array&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $nCallback = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Store label-&gt;id pairs for named destinations, these will be used to replace internal links&nbsp;</div></li><li><div>   * done this way so that destinations can be defined after the location that links to them&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $destinations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Store the stack for the transaction commands, each item in here is a record of the values of all the&nbsp;</div></li><li><div>   * publiciables within the class, so that the user can rollback at will (from each 'start' command)&nbsp;</div></li><li><div>   * note that this includes the objects array, so these can be large.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $checkpoint = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Table of Image origin filenames and image labels which were already added with o_image().&nbsp;</div></li><li><div>   * Allows to merge identical images&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $imagelist = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var boolean Whether the text passed in should be treated as Unicode or just local character set.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $isUnicode = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string the JavaScript code of the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  public $javascript = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var boolean whether the compression is possible&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected $compressionReady = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array Current page size&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected $currentPageSize = array(&quot;width&quot; =&gt; 0, &quot;height&quot; =&gt; 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array All the chars that will be required in the font subsets&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected $stringSubsets = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var string The target internal encoding&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  static protected $targetEncoding = 'iso-8859-1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * @var array The list of the core fonts&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  static protected $coreFonts = array(&nbsp;</div></li><li><div>    'courier', 'courier-bold', 'courier-oblique', 'courier-boldoblique', &nbsp;</div></li><li><div>    'helvetica', 'helvetica-bold', 'helvetica-oblique', 'helvetica-boldoblique', &nbsp;</div></li><li><div>    'times-roman', 'times-bold', 'times-italic', 'times-bolditalic', &nbsp;</div></li><li><div>    'symbol', 'zapfdingbats'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Class constructor&nbsp;</div></li><li><div>   * This will start a new document&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @param array   $pageSize  Array of 4 numbers, defining the bottom left and upper right corner of the page. first two are normally zero.&nbsp;</div></li><li><div>   * @param boolean $isUnicode Whether text will be treated as Unicode or not.&nbsp;</div></li><li><div>   * @param string  $fontcache The font cache folder&nbsp;</div></li><li><div>   * @param string  $tmp       The temporary folder&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function __construct($pageSize = array(0, 0, 612, 792), $isUnicode = false, $fontcache = '', $tmp = '') {&nbsp;</div></li><li><div>    $this-&gt;isUnicode = $isUnicode;&nbsp;</div></li><li><div>    $this-&gt;fontcache = $fontcache;&nbsp;</div></li><li><div>    $this-&gt;tmp = $tmp;&nbsp;</div></li><li><div>    $this-&gt;newDocument($pageSize);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;compressionReady = function_exists('gzcompress');&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    if ( in_array('Windows-1252', mb_list_encodings()) ) {&nbsp;</div></li><li><div>      self::$targetEncoding = 'Windows-1252';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // also initialize the font families that are known about already&nbsp;</div></li><li><div>    $this-&gt;setFontFamily('init');&nbsp;</div></li><li><div>    //  $this-&gt;fileIdentifier = md5('xxxxxxxx'.time());&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Document object methods (internal use only)&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * There is about one object method for each type of object in the pdf document&nbsp;</div></li><li><div>   * Each function has the same call list ($id, $action, $options).&nbsp;</div></li><li><div>   * $id = the object ID of the object, or what it is to be if it is being created&nbsp;</div></li><li><div>   * $action = a string specifying the action to be performed, though ALL must support:&nbsp;</div></li><li><div>   *           'new' - create the object with the id $id&nbsp;</div></li><li><div>   *           'out' - produce the output for the pdf object&nbsp;</div></li><li><div>   * $options = optional, a string or array containing the various parameters for the object&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * These, in conjunction with the output function are the ONLY way for output to be produced&nbsp;</div></li><li><div>   * within the pdf 'file'.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Destination object, used to specify the location for the user to jump to, presently on opening&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_destination($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = &$this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'destination', 'info' =&gt; array());&nbsp;</div></li><li><div>      $tmp = '';&nbsp;</div></li><li><div>      switch ($options['type']) {&nbsp;</div></li><li><div>        case 'XYZ':&nbsp;</div></li><li><div>        case 'FitR':&nbsp;</div></li><li><div>          $tmp = ' '.$options['p3'].$tmp;&nbsp;</div></li><li><div>        case 'FitH':&nbsp;</div></li><li><div>        case 'FitV':&nbsp;</div></li><li><div>        case 'FitBH':&nbsp;</div></li><li><div>        case 'FitBV':&nbsp;</div></li><li><div>          $tmp = ' '.$options['p1'].' '.$options['p2'].$tmp;&nbsp;</div></li><li><div>        case 'Fit':&nbsp;</div></li><li><div>        case 'FitB':&nbsp;</div></li><li><div>          $tmp = $options['type'].$tmp;&nbsp;</div></li><li><div>          $this-&gt;objects[$id]['info']['string'] = $tmp;&nbsp;</div></li><li><div>          $this-&gt;objects[$id]['info']['page'] = $options['page'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $tmp = $o['info'];&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&quot;.'['.$tmp['page'].' 0 R /'.$tmp['string'].&quot;]\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * set the viewer preferences&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_viewerPreferences($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'viewerPreferences', 'info' =&gt; array());&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'add':&nbsp;</div></li><li><div>      foreach ($options as $k =&gt; $v) {&nbsp;</div></li><li><div>        switch ($k) {&nbsp;</div></li><li><div>          case 'HideToolbar':&nbsp;</div></li><li><div>          case 'HideMenubar':&nbsp;</div></li><li><div>          case 'HideWindowUI':&nbsp;</div></li><li><div>          case 'FitWindow':&nbsp;</div></li><li><div>          case 'CenterWindow':&nbsp;</div></li><li><div>          case 'NonFullScreenPageMode':&nbsp;</div></li><li><div>          case 'Direction':&nbsp;</div></li><li><div>            $o['info'][$k] = $v;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt; &quot;;&nbsp;</div></li><li><div>      foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>        $res.= &quot;\n/$k $v&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $res.= &quot;\n&gt;&gt;\n&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * define the document catalog, the overall controller for the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_catalog($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        $this-&gt;objects[$id] = array('t' =&gt; 'catalog', 'info' =&gt; array());&nbsp;</div></li><li><div>        $this-&gt;catalogId = $id;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'outlines':&nbsp;</div></li><li><div>      case 'pages':&nbsp;</div></li><li><div>      case 'openHere':&nbsp;</div></li><li><div>      case 'javascript':&nbsp;</div></li><li><div>        $o['info'][$action] = $options;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'viewerPreferences':&nbsp;</div></li><li><div>        if (!isset($o['info']['viewerPreferences'])) {&nbsp;</div></li><li><div>          $this-&gt;numObj++;&nbsp;</div></li><li><div>          $this-&gt;o_viewerPreferences($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>          $o['info']['viewerPreferences'] = $this-&gt;numObj;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $vp = $o['info']['viewerPreferences'];&nbsp;</div></li><li><div>        $this-&gt;o_viewerPreferences($vp, 'add', $options);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Catalog&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>          switch ($k) {&nbsp;</div></li><li><div>            case 'outlines':&nbsp;</div></li><li><div>              $res.= &quot;\n/Outlines $v 0 R&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'pages':&nbsp;</div></li><li><div>              $res.= &quot;\n/Pages $v 0 R&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'viewerPreferences':&nbsp;</div></li><li><div>              $res.= &quot;\n/ViewerPreferences $v 0 R&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'openHere':&nbsp;</div></li><li><div>              $res.= &quot;\n/OpenAction $v 0 R&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'javascript':&nbsp;</div></li><li><div>              $res.= &quot;\n/Names &lt;&lt;/JavaScript $v 0 R&gt;&gt;&quot;;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot; &gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * object which is a parent to the pages in the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_pages($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'pages', 'info' =&gt; array());&nbsp;</div></li><li><div>      $this-&gt;o_catalog($this-&gt;catalogId, 'pages', $id);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'page':&nbsp;</div></li><li><div>      if (!is_array($options)) {&nbsp;</div></li><li><div>        // then it will just be the id of the new page&nbsp;</div></li><li><div>        $o['info']['pages'][] = $options;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>        // then it should be an array having 'id', 'rid', 'pos', where rid=the page to which this one will be placed relative&nbsp;</div></li><li><div>        // and pos is either 'before' or 'after', saying where this page will fit.&nbsp;</div></li><li><div>        if (isset($options['id']) && isset($options['rid']) && isset($options['pos'])) {&nbsp;</div></li><li><div>          $i = array_search($options['rid'], $o['info']['pages']);&nbsp;</div></li><li><div>          if (isset($o['info']['pages'][$i]) && $o['info']['pages'][$i] == $options['rid']) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // then there is a match&nbsp;</div></li><li><div>            // make a space&nbsp;</div></li><li><div>            switch ($options['pos']) {&nbsp;</div></li><li><div>              case 'before':&nbsp;</div></li><li><div>                $k = $i;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'after':&nbsp;</div></li><li><div>                $k = $i+1;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                $k = -1;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($k &gt;= 0) {&nbsp;</div></li><li><div>              for ($j = count($o['info']['pages'])-1; $j &gt;= $k; $j--) {&nbsp;</div></li><li><div>                $o['info']['pages'][$j+1] = $o['info']['pages'][$j];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $o['info']['pages'][$k] = $options['id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'procset':&nbsp;</div></li><li><div>      $o['info']['procset'] = $options;&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'mediaBox':&nbsp;</div></li><li><div>      $o['info']['mediaBox'] = $options;&nbsp;</div></li><li><div>      // which should be an array of 4 numbers&nbsp;</div></li><li><div>      $this-&gt;currentPageSize = array('width' =&gt; $options[2], 'height' =&gt; $options[3]);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'font':&nbsp;</div></li><li><div>      $o['info']['fonts'][] = array('objNum' =&gt; $options['objNum'], 'fontNum' =&gt; $options['fontNum']);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'extGState':&nbsp;</div></li><li><div>      $o['info']['extGStates'][] = array('objNum' =&gt; $options['objNum'], 'stateNum' =&gt; $options['stateNum']);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'xObject':&nbsp;</div></li><li><div>      $o['info']['xObjects'][] = array('objNum' =&gt; $options['objNum'], 'label' =&gt; $options['label']);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      if (count($o['info']['pages'])) {&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Pages\n/Kids [&quot;;&nbsp;</div></li><li><div>        foreach ($o['info']['pages'] as $v) {&nbsp;</div></li><li><div>          $res.= &quot;$v 0 R\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;]\n/Count &quot;.count($this-&gt;objects[$id]['info']['pages']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( (isset($o['info']['fonts']) && count($o['info']['fonts'])) ||&nbsp;</div></li><li><div>              isset($o['info']['procset']) ||&nbsp;</div></li><li><div>              (isset($o['info']['extGStates']) && count($o['info']['extGStates']))) {&nbsp;</div></li><li><div>          $res.= &quot;\n/Resources &lt;&lt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($o['info']['procset'])) {&nbsp;</div></li><li><div>            $res.= &quot;\n/ProcSet &quot;.$o['info']['procset'].&quot; 0 R&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($o['info']['fonts']) && count($o['info']['fonts'])) {&nbsp;</div></li><li><div>            $res.= &quot;\n/Font &lt;&lt; &quot;;&nbsp;</div></li><li><div>            foreach ($o['info']['fonts'] as $finfo) {&nbsp;</div></li><li><div>              $res.= &quot;\n/F&quot;.$finfo['fontNum'].&quot; &quot;.$finfo['objNum'].&quot; 0 R&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $res.= &quot;\n&gt;&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($o['info']['xObjects']) && count($o['info']['xObjects'])) {&nbsp;</div></li><li><div>            $res.= &quot;\n/XObject &lt;&lt; &quot;;&nbsp;</div></li><li><div>            foreach ($o['info']['xObjects'] as $finfo) {&nbsp;</div></li><li><div>              $res.= &quot;\n/&quot;.$finfo['label'].&quot; &quot;.$finfo['objNum'].&quot; 0 R&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $res.= &quot;\n&gt;&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset($o['info']['extGStates']) && count($o['info']['extGStates'])) {&nbsp;</div></li><li><div>            $res.= &quot;\n/ExtGState &lt;&lt; &quot;;&nbsp;</div></li><li><div>            foreach ($o['info']['extGStates'] as $gstate) {&nbsp;</div></li><li><div>              $res.= &quot;\n/GS&quot; . $gstate['stateNum'] . &quot; &quot; . $gstate['objNum'] . &quot; 0 R&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $res.= &quot;\n&gt;&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $res.= &quot;\n&gt;&gt;&quot;;&nbsp;</div></li><li><div>          if (isset($o['info']['mediaBox'])) {&nbsp;</div></li><li><div>            $tmp = $o['info']['mediaBox'];&nbsp;</div></li><li><div>            $res.= &quot;\n/MediaBox [&quot;.sprintf('%.3F %.3F %.3F %.3F', $tmp[0], $tmp[1], $tmp[2], $tmp[3]) .']';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;\n &gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Pages\n/Count 0\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * define the outlines in the doc, empty for now&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_outlines($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = &$this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        $this-&gt;objects[$id] = array('t' =&gt; 'outlines', 'info' =&gt; array('outlines' =&gt; array()));&nbsp;</div></li><li><div>        $this-&gt;o_catalog($this-&gt;catalogId, 'outlines', $id);&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'outline':&nbsp;</div></li><li><div>        $o['info']['outlines'][] = $options;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        if (count($o['info']['outlines'])) {&nbsp;</div></li><li><div>          $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Outlines /Kids [&quot;;&nbsp;</div></li><li><div>          foreach ($o['info']['outlines'] as $v) {&nbsp;</div></li><li><div>            $res.= &quot;$v 0 R &quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $res.= &quot;] /Count &quot;.count($o['info']['outlines']) .&quot; &gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Outlines /Count 0 &gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * an object to hold the font description&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_font($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = &$this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'font', 'info' =&gt; array('name' =&gt; $options['name'], 'fontFileName' =&gt; $options['fontFileName'], 'SubType' =&gt; 'Type1'));&nbsp;</div></li><li><div>      $fontNum = $this-&gt;numFonts;&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['fontNum'] = $fontNum;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // deal with the encoding and the differences&nbsp;</div></li><li><div>      if (isset($options['differences'])) {&nbsp;</div></li><li><div>        // then we'll need an encoding dictionary&nbsp;</div></li><li><div>        $this-&gt;numObj++;&nbsp;</div></li><li><div>        $this-&gt;o_fontEncoding($this-&gt;numObj, 'new', $options);&nbsp;</div></li><li><div>        $this-&gt;objects[$id]['info']['encodingDictionary'] = $this-&gt;numObj;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if (isset($options['encoding'])) {&nbsp;</div></li><li><div>        // we can specify encoding here&nbsp;</div></li><li><div>        switch ($options['encoding']) {&nbsp;</div></li><li><div>          case 'WinAnsiEncoding':&nbsp;</div></li><li><div>          case 'MacRomanEncoding':&nbsp;</div></li><li><div>          case 'MacExpertEncoding':&nbsp;</div></li><li><div>            $this-&gt;objects[$id]['info']['encoding'] = $options['encoding'];&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'none':&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>            $this-&gt;objects[$id]['info']['encoding'] = 'WinAnsiEncoding';&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>        $this-&gt;objects[$id]['info']['encoding'] = 'WinAnsiEncoding';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;fonts[$options['fontFileName']]['isUnicode']) {&nbsp;</div></li><li><div>        // For Unicode fonts, we need to incorporate font data into&nbsp;</div></li><li><div>        // sub-sections that are linked from the primary font section.&nbsp;</div></li><li><div>        // Look at o_fontGIDtoCID and o_fontDescendentCID functions&nbsp;</div></li><li><div>        // for more informaiton.&nbsp;</div></li><li><div>        //&nbsp;</div></li><li><div>        // All of this code is adapted from the excellent changes made to&nbsp;</div></li><li><div>        // transform FPDF to TCPDF (http://tcpdf.sourceforge.net/)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $toUnicodeId = ++$this-&gt;numObj;&nbsp;</div></li><li><div>        $this-&gt;o_contents($toUnicodeId, 'new', 'raw');&nbsp;</div></li><li><div>        $this-&gt;objects[$id]['info']['toUnicode'] = $toUnicodeId;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stream = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>/CIDInit /ProcSet findresource begin&nbsp;</div></li><li><div>12 dict begin&nbsp;</div></li><li><div>begincmap&nbsp;</div></li><li><div>/CIDSystemInfo&nbsp;</div></li><li><div>&lt;&lt;/Registry (Adobe)&nbsp;</div></li><li><div>/Ordering (UCS)&nbsp;</div></li><li><div>/Supplement 0&nbsp;</div></li><li><div>&gt;&gt; def&nbsp;</div></li><li><div>/CMapName /Adobe-Identity-UCS def&nbsp;</div></li><li><div>/CMapType 2 def&nbsp;</div></li><li><div>1 begincodespacerange&nbsp;</div></li><li><div>&lt;0000&gt; &lt;FFFF&gt;&nbsp;</div></li><li><div>endcodespacerange&nbsp;</div></li><li><div>1 beginbfrange&nbsp;</div></li><li><div>&lt;0000&gt; &lt;FFFF&gt; &lt;0000&gt;&nbsp;</div></li><li><div>endbfrange&nbsp;</div></li><li><div>endcmap&nbsp;</div></li><li><div>CMapName currentdict /CMap defineresource pop&nbsp;</div></li><li><div>end&nbsp;</div></li><li><div>end&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res = &quot;&lt;&lt;/Length &quot; . mb_strlen($stream, '8bit') . &quot; &gt;&gt;\n&quot;;&nbsp;</div></li><li><div>        $res .= &quot;stream\n&quot; . $stream . &quot;endstream&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;objects[$toUnicodeId]['c'] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cidFontId = ++$this-&gt;numObj;&nbsp;</div></li><li><div>        $this-&gt;o_fontDescendentCID($cidFontId, 'new', $options);&nbsp;</div></li><li><div>        $this-&gt;objects[$id]['info']['cidFont'] = $cidFontId;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // also tell the pages node about the new font&nbsp;</div></li><li><div>      $this-&gt;o_pages($this-&gt;currentNode, 'font', array('fontNum' =&gt; $fontNum, 'objNum' =&gt; $id));&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'add':&nbsp;</div></li><li><div>      foreach ($options as $k =&gt; $v) {&nbsp;</div></li><li><div>        switch ($k) {&nbsp;</div></li><li><div>          case 'BaseFont':&nbsp;</div></li><li><div>            $o['info']['name'] = $v;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>          case 'FirstChar':&nbsp;</div></li><li><div>          case 'LastChar':&nbsp;</div></li><li><div>          case 'Widths':&nbsp;</div></li><li><div>          case 'FontDescriptor':&nbsp;</div></li><li><div>          case 'SubType':&nbsp;</div></li><li><div>            $this-&gt;addMessage('o_font '.$k.&quot; : &quot;.$v);&nbsp;</div></li><li><div>            $o['info'][$k] = $v;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // pass values down to descendent font&nbsp;</div></li><li><div>      if (isset($o['info']['cidFont'])) {&nbsp;</div></li><li><div>        $this-&gt;o_fontDescendentCID($o['info']['cidFont'], 'add', $options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      if ($this-&gt;fonts[$this-&gt;objects[$id]['info']['fontFileName']]['isUnicode']) {&nbsp;</div></li><li><div>        // For Unicode fonts, we need to incorporate font data into&nbsp;</div></li><li><div>        // sub-sections that are linked from the primary font section.&nbsp;</div></li><li><div>        // Look at o_fontGIDtoCID and o_fontDescendentCID functions&nbsp;</div></li><li><div>        // for more informaiton.&nbsp;</div></li><li><div>        //&nbsp;</div></li><li><div>        // All of this code is adapted from the excellent changes made to&nbsp;</div></li><li><div>        // transform FPDF to TCPDF (http://tcpdf.sourceforge.net/)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt;/Type /Font\n/Subtype /Type0\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;/BaseFont /&quot;.$o['info']['name'].&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The horizontal identity mapping for 2-byte CIDs; may be used&nbsp;</div></li><li><div>        // with CIDFonts using any Registry, Ordering, and Supplement values.&nbsp;</div></li><li><div>        $res.= &quot;/Encoding /Identity-H\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;/DescendantFonts [&quot;.$o['info']['cidFont'].&quot; 0 R]\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;/ToUnicode &quot;.$o['info']['toUnicode'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;&gt;&gt;\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;endobj&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Font\n/Subtype /&quot;.$o['info']['SubType'].&quot;\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;/Name /F&quot;.$o['info']['fontNum'].&quot;\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;/BaseFont /&quot;.$o['info']['name'].&quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($o['info']['encodingDictionary'])) {&nbsp;</div></li><li><div>          // then place a reference to the dictionary&nbsp;</div></li><li><div>          $res.= &quot;/Encoding &quot;.$o['info']['encodingDictionary'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>        } else if (isset($o['info']['encoding'])) {&nbsp;</div></li><li><div>          // use the specified encoding&nbsp;</div></li><li><div>          $res.= &quot;/Encoding /&quot;.$o['info']['encoding'].&quot;\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($o['info']['FirstChar'])) {&nbsp;</div></li><li><div>          $res.= &quot;/FirstChar &quot;.$o['info']['FirstChar'].&quot;\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($o['info']['LastChar'])) {&nbsp;</div></li><li><div>          $res.= &quot;/LastChar &quot;.$o['info']['LastChar'].&quot;\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($o['info']['Widths'])) {&nbsp;</div></li><li><div>          $res.= &quot;/Widths &quot;.$o['info']['Widths'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($o['info']['FontDescriptor'])) {&nbsp;</div></li><li><div>          $res.= &quot;/FontDescriptor &quot;.$o['info']['FontDescriptor'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;&gt;&gt;\n&quot;;&nbsp;</div></li><li><div>        $res.= &quot;endobj&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * a font descriptor, needed for including additional fonts&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_fontDescriptor($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        $this-&gt;objects[$id] = array('t' =&gt; 'fontDescriptor', 'info' =&gt; $options);&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /FontDescriptor\n&quot;;&nbsp;</div></li><li><div>        foreach ($o['info'] as $label =&gt; $value) {&nbsp;</div></li><li><div>          switch ($label) {&nbsp;</div></li><li><div>          case 'Ascent':&nbsp;</div></li><li><div>          case 'CapHeight':&nbsp;</div></li><li><div>          case 'Descent':&nbsp;</div></li><li><div>          case 'Flags':&nbsp;</div></li><li><div>          case 'ItalicAngle':&nbsp;</div></li><li><div>          case 'StemV':&nbsp;</div></li><li><div>          case 'AvgWidth':&nbsp;</div></li><li><div>          case 'Leading':&nbsp;</div></li><li><div>          case 'MaxWidth':&nbsp;</div></li><li><div>          case 'MissingWidth':&nbsp;</div></li><li><div>          case 'StemH':&nbsp;</div></li><li><div>          case 'XHeight':&nbsp;</div></li><li><div>          case 'CharSet':&nbsp;</div></li><li><div>            if (mb_strlen($value, '8bit')) {&nbsp;</div></li><li><div>              $res.= &quot;/$label $value\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>          case 'FontFile':&nbsp;</div></li><li><div>          case 'FontFile2':&nbsp;</div></li><li><div>          case 'FontFile3':&nbsp;</div></li><li><div>            $res.= &quot;/$label $value 0 R\n&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'FontBBox':&nbsp;</div></li><li><div>            $res.= &quot;/$label [$value[0] $value[1] $value[2] $value[3]]\n&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'FontName':&nbsp;</div></li><li><div>            $res.= &quot;/$label /$value\n&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * the font encoding&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_fontEncoding($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      // the options array should contain 'differences' and maybe 'encoding'&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'fontEncoding', 'info' =&gt; $options);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Encoding\n&quot;;&nbsp;</div></li><li><div>      if (!isset($o['info']['encoding'])) {&nbsp;</div></li><li><div>        $o['info']['encoding'] = 'WinAnsiEncoding';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($o['info']['encoding'] !== 'none') {&nbsp;</div></li><li><div>        $res.= &quot;/BaseEncoding /&quot;.$o['info']['encoding'].&quot;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;/Differences \n[&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $onum = -100;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($o['info']['differences'] as $num =&gt; $label) {&nbsp;</div></li><li><div>        if ($num != $onum+1) {&nbsp;</div></li><li><div>          // we cannot make use of consecutive numbering&nbsp;</div></li><li><div>          $res.= &quot;\n$num /$label&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          $res.= &quot; /$label&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $onum = $num;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;\n]\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * a descendent cid font, needed for unicode fonts&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_fontDescendentCID($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'fontDescendentCID', 'info' =&gt; $options);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // we need a CID system info section&nbsp;</div></li><li><div>      $cidSystemInfoId = ++$this-&gt;numObj;&nbsp;</div></li><li><div>      $this-&gt;o_contents($cidSystemInfoId, 'new', 'raw');&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['cidSystemInfo'] = $cidSystemInfoId;&nbsp;</div></li><li><div>      $res = &quot;&lt;&lt;/Registry (Adobe)\n&quot;; // A string identifying an issuer of character collections&nbsp;</div></li><li><div>      $res.= &quot;/Ordering (UCS)\n&quot;; // A string that uniquely names a character collection issued by a specific registry&nbsp;</div></li><li><div>      $res.= &quot;/Supplement 0\n&quot;; // The supplement number of the character collection.&nbsp;</div></li><li><div>      $res.= &quot;&gt;&gt;&quot;;&nbsp;</div></li><li><div>      $this-&gt;objects[$cidSystemInfoId]['c'] = $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // and a CID to GID map&nbsp;</div></li><li><div>      $cidToGidMapId = ++$this-&gt;numObj;&nbsp;</div></li><li><div>      $this-&gt;o_fontGIDtoCIDMap($cidToGidMapId, 'new', $options);&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['cidToGidMap'] = $cidToGidMapId;&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'add':&nbsp;</div></li><li><div>      foreach ($options as $k =&gt; $v) {&nbsp;</div></li><li><div>        switch ($k) {&nbsp;</div></li><li><div>        case 'BaseFont':&nbsp;</div></li><li><div>          $o['info']['name'] = $v;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 'FirstChar':&nbsp;</div></li><li><div>        case 'LastChar':&nbsp;</div></li><li><div>        case 'MissingWidth':&nbsp;</div></li><li><div>        case 'FontDescriptor':&nbsp;</div></li><li><div>        case 'SubType':&nbsp;</div></li><li><div>          $this-&gt;addMessage(&quot;o_fontDescendentCID $k : $v&quot;);&nbsp;</div></li><li><div>          $o['info'][$k] = $v;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // pass values down to cid to gid map&nbsp;</div></li><li><div>      $this-&gt;o_fontGIDtoCIDMap($o['info']['cidToGidMap'], 'add', $options);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&quot;;&nbsp;</div></li><li><div>      $res.= &quot;&lt;&lt;/Type /Font\n&quot;;&nbsp;</div></li><li><div>      $res.= &quot;/Subtype /CIDFontType2\n&quot;;&nbsp;</div></li><li><div>      $res.= &quot;/BaseFont /&quot;.$o['info']['name'].&quot;\n&quot;;&nbsp;</div></li><li><div>      $res.= &quot;/CIDSystemInfo &quot;.$o['info']['cidSystemInfo'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>//      if (isset($o['info']['FirstChar'])) {&nbsp;</div></li><li><div>//        $res.= &quot;/FirstChar &quot;.$o['info']['FirstChar'].&quot;\n&quot;;&nbsp;</div></li><li><div>//      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//      if (isset($o['info']['LastChar'])) {&nbsp;</div></li><li><div>//        $res.= &quot;/LastChar &quot;.$o['info']['LastChar'].&quot;\n&quot;;&nbsp;</div></li><li><div>//      }&nbsp;</div></li><li><div>      if (isset($o['info']['FontDescriptor'])) {&nbsp;</div></li><li><div>        $res.= &quot;/FontDescriptor &quot;.$o['info']['FontDescriptor'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($o['info']['MissingWidth'])) {&nbsp;</div></li><li><div>        $res.= &quot;/DW &quot;.$o['info']['MissingWidth'].&quot;\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($o['info']['fontFileName']) && isset($this-&gt;fonts[$o['info']['fontFileName']]['CIDWidths'])) {&nbsp;</div></li><li><div>        $cid_widths = &$this-&gt;fonts[$o['info']['fontFileName']]['CIDWidths'];&nbsp;</div></li><li><div>        $w = '';&nbsp;</div></li><li><div>        foreach ($cid_widths as $cid =&gt; $width) {&nbsp;</div></li><li><div>          $w .= &quot;$cid [$width] &quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $res.= &quot;/W [$w]\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;/CIDToGIDMap &quot;.$o['info']['cidToGidMap'].&quot; 0 R\n&quot;;&nbsp;</div></li><li><div>      $res.= &quot;&gt;&gt;\n&quot;;&nbsp;</div></li><li><div>      $res.= &quot;endobj&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * a font glyph to character map, needed for unicode fonts&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_fontGIDtoCIDMap($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'fontGIDtoCIDMap', 'info' =&gt; $options);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&quot;;&nbsp;</div></li><li><div>      $fontFileName = $o['info']['fontFileName'];&nbsp;</div></li><li><div>      $tmp = $this-&gt;fonts[$fontFileName]['CIDtoGID'] = base64_decode($this-&gt;fonts[$fontFileName]['CIDtoGID']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $compressed = isset($this-&gt;fonts[$fontFileName]['CIDtoGID_Compressed']) &&&nbsp;</div></li><li><div>                    $this-&gt;fonts[$fontFileName]['CIDtoGID_Compressed'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$compressed && isset($o['raw'])) {&nbsp;</div></li><li><div>        $res.= $tmp;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $res.= &quot;&lt;&lt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$compressed && $this-&gt;compressionReady && $this-&gt;options['compression']) {&nbsp;</div></li><li><div>          // then implement ZLIB based compression on this content stream&nbsp;</div></li><li><div>          $compressed = true;&nbsp;</div></li><li><div>          $tmp = gzcompress($tmp, 6);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($compressed) {&nbsp;</div></li><li><div>          $res.= &quot;\n/Filter /FlateDecode&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;\n/Length &quot;.mb_strlen($tmp, '8bit') .&quot;&gt;&gt;\nstream\n$tmp\nendstream&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * the document procset, solves some problems with printing to old PS printers&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_procset($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        $this-&gt;objects[$id] = array('t' =&gt; 'procset', 'info' =&gt; array('PDF' =&gt; 1, 'Text' =&gt; 1));&nbsp;</div></li><li><div>        $this-&gt;o_pages($this-&gt;currentNode, 'procset', $id);&nbsp;</div></li><li><div>        $this-&gt;procsetObjectId = $id;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'add':&nbsp;</div></li><li><div>        // this is to add new items to the procset list, despite the fact that this is considered&nbsp;</div></li><li><div>        // obselete, the items are required for printing to some postscript printers&nbsp;</div></li><li><div>        switch ($options) {&nbsp;</div></li><li><div>        case 'ImageB':&nbsp;</div></li><li><div>        case 'ImageC':&nbsp;</div></li><li><div>        case 'ImageI':&nbsp;</div></li><li><div>          $o['info'][$options] = 1;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n[&quot;;&nbsp;</div></li><li><div>        foreach ($o['info'] as $label =&gt; $val) {&nbsp;</div></li><li><div>          $res.= &quot;/$label &quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $res.= &quot;]\nendobj&quot;;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * define the document information&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_info($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        $this-&gt;infoObject = $id;&nbsp;</div></li><li><div>        $date = 'D:'.@date('Ymd');&nbsp;</div></li><li><div>        $this-&gt;objects[$id] = array('t' =&gt; 'info', 'info' =&gt; array('Creator' =&gt; 'R and OS php pdf writer, http://www.ros.co.nz', 'CreationDate' =&gt; $date));&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>      case 'Title':&nbsp;</div></li><li><div>      case 'Author':&nbsp;</div></li><li><div>      case 'Subject':&nbsp;</div></li><li><div>      case 'Keywords':&nbsp;</div></li><li><div>      case 'Creator':&nbsp;</div></li><li><div>      case 'Producer':&nbsp;</div></li><li><div>      case 'CreationDate':&nbsp;</div></li><li><div>      case 'ModDate':&nbsp;</div></li><li><div>      case 'Trapped':&nbsp;</div></li><li><div>        $o['info'][$action] = $options;&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        if ($this-&gt;encrypted) {&nbsp;</div></li><li><div>          $this-&gt;encryptInit($id);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt;\n&quot;;&nbsp;</div></li><li><div>        foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>          $res.= &quot;/$k (&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($this-&gt;encrypted) {&nbsp;</div></li><li><div>            $v = $this-&gt;ARC4($v);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // dates must be outputted as-is, without Unicode transformations&nbsp;</div></li><li><div>          elseif (!in_array($k, array('CreationDate', 'ModDate'))) {&nbsp;</div></li><li><div>            $v = $this-&gt;filterText($v);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $res.= $v;&nbsp;</div></li><li><div>          $res.= &quot;)\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * an action object, used to link to URLS initially&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_action($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        if (is_array($options)) {&nbsp;</div></li><li><div>          $this-&gt;objects[$id] = array('t' =&gt; 'action', 'info' =&gt; $options, 'type' =&gt; $options['type']);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          // then assume a URI action&nbsp;</div></li><li><div>          $this-&gt;objects[$id] = array('t' =&gt; 'action', 'info' =&gt; $options, 'type' =&gt; 'URI');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        if ($this-&gt;encrypted) {&nbsp;</div></li><li><div>          $this-&gt;encryptInit($id);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Action&quot;;&nbsp;</div></li><li><div>        switch ($o['type']) {&nbsp;</div></li><li><div>          case 'ilink':&nbsp;</div></li><li><div>            if (!isset($this-&gt;destinations[(string)$o['info']['label']])) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // there will be an 'label' setting, this is the name of the destination&nbsp;</div></li><li><div>            $res.= &quot;\n/S /GoTo\n/D &quot;.$this-&gt;destinations[(string)$o['info']['label']].&quot; 0 R&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'URI':&nbsp;</div></li><li><div>            $res.= &quot;\n/S /URI\n/URI (&quot;;&nbsp;</div></li><li><div>            if ($this-&gt;encrypted) {&nbsp;</div></li><li><div>              $res.= $this-&gt;filterText($this-&gt;ARC4($o['info']), true, false);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              $res.= $this-&gt;filterText($o['info'], true, false);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $res.= &quot;)&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * an annotation object, this will add an annotation to the current page.&nbsp;</div></li><li><div>   * initially will support just link annotations&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_annotation($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>      case 'new':&nbsp;</div></li><li><div>        // add the annotation to the current page&nbsp;</div></li><li><div>        $pageId = $this-&gt;currentPage;&nbsp;</div></li><li><div>        $this-&gt;o_page($pageId, 'annot', $id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // and add the action object which is going to be required&nbsp;</div></li><li><div>        switch ($options['type']) {&nbsp;</div></li><li><div>          case 'link':&nbsp;</div></li><li><div>            $this-&gt;objects[$id] = array('t' =&gt; 'annotation', 'info' =&gt; $options);&nbsp;</div></li><li><div>            $this-&gt;numObj++;&nbsp;</div></li><li><div>            $this-&gt;o_action($this-&gt;numObj, 'new', $options['url']);&nbsp;</div></li><li><div>            $this-&gt;objects[$id]['info']['actionId'] = $this-&gt;numObj;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'ilink':&nbsp;</div></li><li><div>            // this is to a named internal link&nbsp;</div></li><li><div>            $label = $options['label'];&nbsp;</div></li><li><div>            $this-&gt;objects[$id] = array('t' =&gt; 'annotation', 'info' =&gt; $options);&nbsp;</div></li><li><div>            $this-&gt;numObj++;&nbsp;</div></li><li><div>            $this-&gt;o_action($this-&gt;numObj, 'new', array('type' =&gt; 'ilink', 'label' =&gt; $label));&nbsp;</div></li><li><div>            $this-&gt;objects[$id]['info']['actionId'] = $this-&gt;numObj;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'out':&nbsp;</div></li><li><div>        $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Annot&quot;;&nbsp;</div></li><li><div>        switch ($o['info']['type']) {&nbsp;</div></li><li><div>          case 'link':&nbsp;</div></li><li><div>          case 'ilink':&nbsp;</div></li><li><div>            $res.= &quot;\n/Subtype /Link&quot;;&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $res.= &quot;\n/A &quot;.$o['info']['actionId'].&quot; 0 R&quot;;&nbsp;</div></li><li><div>        $res.= &quot;\n/Border [0 0 0]&quot;;&nbsp;</div></li><li><div>        $res.= &quot;\n/H /I&quot;;&nbsp;</div></li><li><div>        $res.= &quot;\n/Rect [ &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($o['info']['rect'] as $v) {&nbsp;</div></li><li><div>          $res.= sprintf(&quot;%.4F &quot;, $v);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;]&quot;;&nbsp;</div></li><li><div>        $res.= &quot;\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>        return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * a page object, it also creates a contents object to hold its contents&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_page($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;numPages++;&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'page', 'info' =&gt; array('parent' =&gt; $this-&gt;currentNode, 'pageNum' =&gt; $this-&gt;numPages));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (is_array($options)) {&nbsp;</div></li><li><div>        // then this must be a page insertion, array should contain 'rid', 'pos'=[before|after]&nbsp;</div></li><li><div>        $options['id'] = $id;&nbsp;</div></li><li><div>        $this-&gt;o_pages($this-&gt;currentNode, 'page', $options);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $this-&gt;o_pages($this-&gt;currentNode, 'page', $id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;currentPage = $id;&nbsp;</div></li><li><div>      //make a contents object to go with this page&nbsp;</div></li><li><div>      $this-&gt;numObj++;&nbsp;</div></li><li><div>      $this-&gt;o_contents($this-&gt;numObj, 'new', $id);&nbsp;</div></li><li><div>      $this-&gt;currentContents = $this-&gt;numObj;&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['contents'] = array();&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['contents'][] = $this-&gt;numObj;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $match = ($this-&gt;numPages%2 ? 'odd' : 'even');&nbsp;</div></li><li><div>      foreach ($this-&gt;addLooseObjects as $oId =&gt; $target) {&nbsp;</div></li><li><div>        if ($target === 'all' || $match === $target) {&nbsp;</div></li><li><div>          $this-&gt;objects[$id]['info']['contents'][] = $oId;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'content':&nbsp;</div></li><li><div>      $o['info']['contents'][] = $options;&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'annot':&nbsp;</div></li><li><div>      // add an annotation to this page&nbsp;</div></li><li><div>      if (!isset($o['info']['annot'])) {&nbsp;</div></li><li><div>        $o['info']['annot'] = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // $options should contain the id of the annotation dictionary&nbsp;</div></li><li><div>      $o['info']['annot'][] = $options;&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /Page&quot;;&nbsp;</div></li><li><div>      $res.= &quot;\n/Parent &quot;.$o['info']['parent'].&quot; 0 R&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($o['info']['annot'])) {&nbsp;</div></li><li><div>        $res.= &quot;\n/Annots [&quot;;&nbsp;</div></li><li><div>        foreach ($o['info']['annot'] as $aId) {&nbsp;</div></li><li><div>          $res.= &quot; $aId 0 R&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $res.= &quot; ]&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $count = count($o['info']['contents']);&nbsp;</div></li><li><div>      if ($count == 1) {&nbsp;</div></li><li><div>        $res.= &quot;\n/Contents &quot;.$o['info']['contents'][0].&quot; 0 R&quot;;&nbsp;</div></li><li><div>      } else if ($count &gt; 1) {&nbsp;</div></li><li><div>        $res.= &quot;\n/Contents [\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // reverse the page contents so added objects are below normal content&nbsp;</div></li><li><div>        //foreach (array_reverse($o['info']['contents']) as $cId) {&nbsp;</div></li><li><div>        // Back to normal now that I've got transparency working --Benj&nbsp;</div></li><li><div>        foreach ($o['info']['contents'] as $cId) {&nbsp;</div></li><li><div>          $res.= &quot;$cId 0 R\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $res.= &quot;]&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * the contents objects hold all of the content which appears on pages&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_contents($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'contents', 'c' =&gt; '', 'info' =&gt; array());&nbsp;</div></li><li><div>      if (mb_strlen($options, '8bit') && intval($options)) {&nbsp;</div></li><li><div>        // then this contents is the primary for a page&nbsp;</div></li><li><div>        $this-&gt;objects[$id]['onPage'] = $options;&nbsp;</div></li><li><div>      } else if ($options === 'raw') {&nbsp;</div></li><li><div>        // then this page contains some other type of system object&nbsp;</div></li><li><div>        $this-&gt;objects[$id]['raw'] = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'add':&nbsp;</div></li><li><div>      // add more options to the decleration&nbsp;</div></li><li><div>      foreach ($options as $k =&gt; $v) {&nbsp;</div></li><li><div>        $o['info'][$k] = $v;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $tmp = $o['c'];&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($this-&gt;objects[$id]['raw'])) {&nbsp;</div></li><li><div>        $res.= $tmp;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $res.= &quot;&lt;&lt;&quot;;&nbsp;</div></li><li><div>        if ($this-&gt;compressionReady && $this-&gt;options['compression']) {&nbsp;</div></li><li><div>          // then implement ZLIB based compression on this content stream&nbsp;</div></li><li><div>          $res.= &quot; /Filter /FlateDecode&quot;;&nbsp;</div></li><li><div>          $tmp = gzcompress($tmp, 6);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($this-&gt;encrypted) {&nbsp;</div></li><li><div>          $this-&gt;encryptInit($id);&nbsp;</div></li><li><div>          $tmp = $this-&gt;ARC4($tmp);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>          $res.= &quot;\n/$k $v&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $res.= &quot;\n/Length &quot;.mb_strlen($tmp, '8bit') .&quot; &gt;&gt;\nstream\n$tmp\nendstream&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function o_embedjs($id, $action) {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'embedjs', 'info' =&gt; array(&nbsp;</div></li><li><div>        'Names' =&gt; '[(EmbeddedJS) '.($id+1).' 0 R]'&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt; &quot;;&nbsp;</div></li><li><div>      foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>        $res.= &quot;\n/$k $v&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $res.= &quot;\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function o_javascript($id, $action, $code = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'javascript', 'info' =&gt; array(&nbsp;</div></li><li><div>        'S' =&gt; '/JavaScript', &nbsp;</div></li><li><div>        'JS' =&gt; '('.$this-&gt;filterText($code).')', &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt; &quot;;&nbsp;</div></li><li><div>      foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>        $res.= &quot;\n/$k $v&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $res.= &quot;\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * an image object, will be an XObject in the document, includes description and data&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_image($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      // make the new object&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'image', 'data' =&gt; &$options['data'], 'info' =&gt; array());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info =& $this-&gt;objects[$id]['info'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $info['Type'] = '/XObject';&nbsp;</div></li><li><div>      $info['Subtype'] = '/Image';&nbsp;</div></li><li><div>      $info['Width'] = $options['iw'];&nbsp;</div></li><li><div>      $info['Height'] = $options['ih'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($options['masked']) && $options['masked']) {&nbsp;</div></li><li><div>        $info['SMask'] = ($this-&gt;numObj-1).' 0 R';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($options['type']) || $options['type'] === 'jpg') {&nbsp;</div></li><li><div>        if (!isset($options['channels'])) {&nbsp;</div></li><li><div>          $options['channels'] = 3;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ($options['channels']) {&nbsp;</div></li><li><div>          case  1: $info['ColorSpace'] = '/DeviceGray'; break;&nbsp;</div></li><li><div>          case  4: $info['ColorSpace'] = '/DeviceCMYK'; break;&nbsp;</div></li><li><div>          default: $info['ColorSpace'] = '/DeviceRGB'; break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($info['ColorSpace'] === '/DeviceCMYK') {&nbsp;</div></li><li><div>          $info['Decode'] = '[1 0 1 0 1 0 1 0]';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $info['Filter'] = '/DCTDecode';&nbsp;</div></li><li><div>        $info['BitsPerComponent'] = 8;&nbsp;</div></li><li><div>      } &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      else if ($options['type'] === 'png') {&nbsp;</div></li><li><div>        $info['Filter'] = '/FlateDecode';&nbsp;</div></li><li><div>        $info['DecodeParms'] = '&lt;&lt; /Predictor 15 /Colors '.$options['ncolor'].' /Columns '.$options['iw'].' /BitsPerComponent '.$options['bitsPerComponent'].'&gt;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($options['isMask']) {&nbsp;</div></li><li><div>          $info['ColorSpace'] = '/DeviceGray';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>          if (mb_strlen($options['pdata'], '8bit')) {&nbsp;</div></li><li><div>            $tmp = ' [ /Indexed /DeviceRGB '.(mb_strlen($options['pdata'], '8bit') /3-1) .' ';&nbsp;</div></li><li><div>            $this-&gt;numObj++;&nbsp;</div></li><li><div>            $this-&gt;o_contents($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>            $this-&gt;objects[$this-&gt;numObj]['c'] = $options['pdata'];&nbsp;</div></li><li><div>            $tmp.= $this-&gt;numObj.' 0 R';&nbsp;</div></li><li><div>            $tmp.= ' ]';&nbsp;</div></li><li><div>            $info['ColorSpace'] = $tmp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (isset($options['transparency'])) {&nbsp;</div></li><li><div>              $transparency = $options['transparency'];&nbsp;</div></li><li><div>              switch ($transparency['type']) {&nbsp;</div></li><li><div>              case 'indexed':&nbsp;</div></li><li><div>                $tmp = ' [ '.$transparency['data'].' '.$transparency['data'].'] ';&nbsp;</div></li><li><div>                $info['Mask'] = $tmp;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'color-key':&nbsp;</div></li><li><div>                $tmp = ' [ '.&nbsp;</div></li><li><div>                  $transparency['r'] . ' ' . $transparency['r'] .&nbsp;</div></li><li><div>                  $transparency['g'] . ' ' . $transparency['g'] .&nbsp;</div></li><li><div>                  $transparency['b'] . ' ' . $transparency['b'] .&nbsp;</div></li><li><div>                  ' ] ';&nbsp;</div></li><li><div>                $info['Mask'] = $tmp;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>            if (isset($options['transparency'])) {&nbsp;</div></li><li><div>              $transparency = $options['transparency'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              switch ($transparency['type']) {&nbsp;</div></li><li><div>              case 'indexed':&nbsp;</div></li><li><div>                $tmp = ' [ '.$transparency['data'].' '.$transparency['data'].'] ';&nbsp;</div></li><li><div>                $info['Mask'] = $tmp;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'color-key':&nbsp;</div></li><li><div>                $tmp = ' [ '.&nbsp;</div></li><li><div>                  $transparency['r'] . ' ' . $transparency['r'] . ' ' .&nbsp;</div></li><li><div>                  $transparency['g'] . ' ' . $transparency['g'] . ' ' .&nbsp;</div></li><li><div>                  $transparency['b'] . ' ' . $transparency['b'] .&nbsp;</div></li><li><div>                  ' ] ';&nbsp;</div></li><li><div>                $info['Mask'] = $tmp;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $info['ColorSpace'] = '/'.$options['color'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $info['BitsPerComponent'] = $options['bitsPerComponent'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // assign it a place in the named resource dictionary as an external object, according to&nbsp;</div></li><li><div>      // the label passed in with it.&nbsp;</div></li><li><div>      $this-&gt;o_pages($this-&gt;currentNode, 'xObject', array('label' =&gt; $options['label'], 'objNum' =&gt; $id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // also make sure that we have the right procset object for it.&nbsp;</div></li><li><div>      $this-&gt;o_procset($this-&gt;procsetObjectId, 'add', 'ImageC');&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $tmp = &$o['data'];&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($o['info'] as $k =&gt; $v) {&nbsp;</div></li><li><div>        $res.= &quot;\n/$k $v&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;encrypted) {&nbsp;</div></li><li><div>        $this-&gt;encryptInit($id);&nbsp;</div></li><li><div>        $tmp = $this-&gt;ARC4($tmp);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;\n/Length &quot;.mb_strlen($tmp, '8bit') .&quot;&gt;&gt;\nstream\n$tmp\nendstream\nendobj&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * graphics state object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_extGState($id, $action, $options = &quot;&quot;) {&nbsp;</div></li><li><div>    static $valid_params = array(&quot;LW&quot;, &quot;LC&quot;, &quot;LC&quot;, &quot;LJ&quot;, &quot;ML&quot;, &nbsp;</div></li><li><div>                                   &quot;D&quot;, &quot;RI&quot;, &quot;OP&quot;, &quot;op&quot;, &quot;OPM&quot;, &nbsp;</div></li><li><div>                                   &quot;Font&quot;, &quot;BG&quot;, &quot;BG2&quot;, &quot;UCR&quot;, &nbsp;</div></li><li><div>                                   &quot;TR&quot;, &quot;TR2&quot;, &quot;HT&quot;, &quot;FL&quot;, &nbsp;</div></li><li><div>                                   &quot;SM&quot;, &quot;SA&quot;, &quot;BM&quot;, &quot;SMask&quot;, &nbsp;</div></li><li><div>                                   &quot;CA&quot;, &quot;ca&quot;, &quot;AIS&quot;, &quot;TK&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($action !== &quot;new&quot;) {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case &quot;new&quot;:&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'extGState', 'info' =&gt; $options);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Tell the pages about the new resource&nbsp;</div></li><li><div>      $this-&gt;numStates++;&nbsp;</div></li><li><div>      $this-&gt;o_pages($this-&gt;currentNode, 'extGState', array(&quot;objNum&quot; =&gt; $id, &quot;stateNum&quot; =&gt; $this-&gt;numStates));&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case &quot;out&quot;:&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt; /Type /ExtGState\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($o[&quot;info&quot;] as $k =&gt; $v) {&nbsp;</div></li><li><div>        if ( !in_array($k, $valid_params))&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>        $res.= &quot;/$k $v\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $res.= &quot;&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * encryption object.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  protected function o_encryption($id, $action, $options = '') {&nbsp;</div></li><li><div>    if ($action !== 'new') {&nbsp;</div></li><li><div>      $o = & $this-&gt;objects[$id];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'new':&nbsp;</div></li><li><div>      // make the new object&nbsp;</div></li><li><div>      $this-&gt;objects[$id] = array('t' =&gt; 'encryption', 'info' =&gt; $options);&nbsp;</div></li><li><div>      $this-&gt;arc4_objnum = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // figure out the additional paramaters required&nbsp;</div></li><li><div>      $pad = chr(0x28) .chr(0xBF) .chr(0x4E) .chr(0x5E) .chr(0x4E) .chr(0x75) .chr(0x8A) .chr(0x41)&nbsp;</div></li><li><div>             .chr(0x64) .chr(0x00) .chr(0x4E) .chr(0x56) .chr(0xFF) .chr(0xFA) .chr(0x01) .chr(0x08)&nbsp;</div></li><li><div>             .chr(0x2E) .chr(0x2E) .chr(0x00) .chr(0xB6) .chr(0xD0) .chr(0x68) .chr(0x3E) .chr(0x80)&nbsp;</div></li><li><div>             .chr(0x2F) .chr(0x0C) .chr(0xA9) .chr(0xFE) .chr(0x64) .chr(0x53) .chr(0x69) .chr(0x7A);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $len = mb_strlen($options['owner'], '8bit');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($len &gt; 32) {&nbsp;</div></li><li><div>        $owner = substr($options['owner'], 0, 32);&nbsp;</div></li><li><div>      } else if ($len &lt; 32) {&nbsp;</div></li><li><div>        $owner = $options['owner'].substr($pad, 0, 32-$len);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $owner = $options['owner'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $len = mb_strlen($options['user'], '8bit');&nbsp;</div></li><li><div>      if ($len &gt; 32) {&nbsp;</div></li><li><div>        $user = substr($options['user'], 0, 32);&nbsp;</div></li><li><div>      } else if ($len &lt; 32) {&nbsp;</div></li><li><div>        $user = $options['user'].substr($pad, 0, 32-$len);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $user = $options['user'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tmp = $this-&gt;md5_16($owner);&nbsp;</div></li><li><div>      $okey = substr($tmp, 0, 5);&nbsp;</div></li><li><div>      $this-&gt;ARC4_init($okey);&nbsp;</div></li><li><div>      $ovalue = $this-&gt;ARC4($user);&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['O'] = $ovalue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // now make the u value, phew.&nbsp;</div></li><li><div>      $tmp = $this-&gt;md5_16($user.$ovalue.chr($options['p']) .chr(255) .chr(255) .chr(255) .$this-&gt;fileIdentifier);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ukey = substr($tmp, 0, 5);&nbsp;</div></li><li><div>      $this-&gt;ARC4_init($ukey);&nbsp;</div></li><li><div>      $this-&gt;encryptionKey = $ukey;&nbsp;</div></li><li><div>      $this-&gt;encrypted = true;&nbsp;</div></li><li><div>      $uvalue = $this-&gt;ARC4($pad);&nbsp;</div></li><li><div>      $this-&gt;objects[$id]['info']['U'] = $uvalue;&nbsp;</div></li><li><div>      $this-&gt;encryptionKey = $ukey;&nbsp;</div></li><li><div>      // initialize the arc4 array&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'out':&nbsp;</div></li><li><div>      $res = &quot;\n$id 0 obj\n&lt;&lt;&quot;;&nbsp;</div></li><li><div>      $res.= &quot;\n/Filter /Standard&quot;;&nbsp;</div></li><li><div>      $res.= &quot;\n/V 1&quot;;&nbsp;</div></li><li><div>      $res.= &quot;\n/R 2&quot;;&nbsp;</div></li><li><div>      $res.= &quot;\n/O (&quot;.$this-&gt;filterText($o['info']['O'], true, false) .')';&nbsp;</div></li><li><div>      $res.= &quot;\n/U (&quot;.$this-&gt;filterText($o['info']['U'], true, false) .')';&nbsp;</div></li><li><div>      // and the p-value needs to be converted to account for the twos-complement approach&nbsp;</div></li><li><div>      $o['info']['p'] = (($o['info']['p']^255) +1) *-1;&nbsp;</div></li><li><div>      $res.= &quot;\n/P &quot;.($o['info']['p']);&nbsp;</div></li><li><div>      $res.= &quot;\n&gt;&gt;\nendobj&quot;;&nbsp;</div></li><li><div>      return $res;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * ARC4 functions&nbsp;</div></li><li><div>   * A series of function to implement ARC4 encoding in PHP&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * calculate the 16 byte version of the 128 bit md5 digest of the string&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function md5_16($string) {&nbsp;</div></li><li><div>    $tmp = md5($string);&nbsp;</div></li><li><div>    $out = '';&nbsp;</div></li><li><div>    for ($i = 0; $i &lt;= 30; $i = $i+2) {&nbsp;</div></li><li><div>      $out.= chr(hexdec(substr($tmp, $i, 2)));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * initialize the encryption for processing a particular object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function encryptInit($id) {&nbsp;</div></li><li><div>    $tmp = $this-&gt;encryptionKey;&nbsp;</div></li><li><div>    $hex = dechex($id);&nbsp;</div></li><li><div>    if (mb_strlen($hex, '8bit') &lt; 6) {&nbsp;</div></li><li><div>      $hex = substr('000000', 0, 6-mb_strlen($hex, '8bit')) .$hex;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $tmp.= chr(hexdec(substr($hex, 4, 2))) .chr(hexdec(substr($hex, 2, 2))) .chr(hexdec(substr($hex, 0, 2))) .chr(0) .chr(0);&nbsp;</div></li><li><div>    $key = $this-&gt;md5_16($tmp);&nbsp;</div></li><li><div>    $this-&gt;ARC4_init(substr($key, 0, 10));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * initialize the ARC4 encryption&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function ARC4_init($key = '') {&nbsp;</div></li><li><div>    $this-&gt;arc4 = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // setup the control array&nbsp;</div></li><li><div>    if (mb_strlen($key, '8bit') == 0) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $k = '';&nbsp;</div></li><li><div>    while (mb_strlen($k, '8bit') &lt; 256) {&nbsp;</div></li><li><div>      $k.= $key;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $k = substr($k, 0, 256);&nbsp;</div></li><li><div>    for ($i = 0; $i &lt; 256; $i++) {&nbsp;</div></li><li><div>      $this-&gt;arc4.= chr($i);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $j = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    for ($i = 0; $i &lt; 256; $i++) {&nbsp;</div></li><li><div>      $t = $this-&gt;arc4[$i];&nbsp;</div></li><li><div>      $j = ($j + ord($t) + ord($k[$i])) %256;&nbsp;</div></li><li><div>      $this-&gt;arc4[$i] = $this-&gt;arc4[$j];&nbsp;</div></li><li><div>      $this-&gt;arc4[$j] = $t;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * ARC4 encrypt a text string&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function ARC4($text) {&nbsp;</div></li><li><div>    $len = mb_strlen($text, '8bit');&nbsp;</div></li><li><div>    $a = 0;&nbsp;</div></li><li><div>    $b = 0;&nbsp;</div></li><li><div>    $c = $this-&gt;arc4;&nbsp;</div></li><li><div>    $out = '';&nbsp;</div></li><li><div>    for ($i = 0; $i &lt; $len; $i++) {&nbsp;</div></li><li><div>      $a = ($a+1) %256;&nbsp;</div></li><li><div>      $t = $c[$a];&nbsp;</div></li><li><div>      $b = ($b+ord($t)) %256;&nbsp;</div></li><li><div>      $c[$a] = $c[$b];&nbsp;</div></li><li><div>      $c[$b] = $t;&nbsp;</div></li><li><div>      $k = ord($c[(ord($c[$a]) + ord($c[$b])) %256]);&nbsp;</div></li><li><div>      $out.= chr(ord($text[$i]) ^ $k);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * functions which can be called to adjust or add to the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a link in the document to an external URL&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addLink($url, $x0, $y0, $x1, $y1) {&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $info = array('type' =&gt; 'link', 'url' =&gt; $url, 'rect' =&gt; array($x0, $y0, $x1, $y1));&nbsp;</div></li><li><div>    $this-&gt;o_annotation($this-&gt;numObj, 'new', $info);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a link in the document to an internal destination (ie. within the document)&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addInternalLink($label, $x0, $y0, $x1, $y1) {&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $info = array('type' =&gt; 'ilink', 'label' =&gt; $label, 'rect' =&gt; array($x0, $y0, $x1, $y1));&nbsp;</div></li><li><div>    $this-&gt;o_annotation($this-&gt;numObj, 'new', $info);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * set the encryption of the document&nbsp;</div></li><li><div>   * can be used to turn it on and/or set the passwords which it will have.&nbsp;</div></li><li><div>   * also the functions that the user will have are set here, such as print, modify, add&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setEncryption($userPass = '', $ownerPass = '', $pc = array()) {&nbsp;</div></li><li><div>    $p = bindec(&quot;11000000&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $options = array('print' =&gt; 4, 'modify' =&gt; 8, 'copy' =&gt; 16, 'add' =&gt; 32);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    foreach ($pc as $k =&gt; $v) {&nbsp;</div></li><li><div>      if ($v && isset($options[$k])) {&nbsp;</div></li><li><div>        $p+= $options[$k];&nbsp;</div></li><li><div>      } else if (isset($options[$v])) {&nbsp;</div></li><li><div>        $p+= $options[$v];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // implement encryption on the document&nbsp;</div></li><li><div>    if ($this-&gt;arc4_objnum == 0) {&nbsp;</div></li><li><div>      // then the block does not exist already, add it.&nbsp;</div></li><li><div>      $this-&gt;numObj++;&nbsp;</div></li><li><div>      if (mb_strlen($ownerPass) == 0) {&nbsp;</div></li><li><div>        $ownerPass = $userPass;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;o_encryption($this-&gt;numObj, 'new', array('user' =&gt; $userPass, 'owner' =&gt; $ownerPass, 'p' =&gt; $p));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * should be used for internal checks, not implemented as yet&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function checkAllHere() {&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * return the pdf stream as a string returned from the function&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function output($debug = false) {&nbsp;</div></li><li><div>    if ($debug) {&nbsp;</div></li><li><div>      // turn compression off&nbsp;</div></li><li><div>      $this-&gt;options['compression'] = false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;javascript) {&nbsp;</div></li><li><div>      $this-&gt;numObj++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $js_id = $this-&gt;numObj;&nbsp;</div></li><li><div>      $this-&gt;o_embedjs($js_id, 'new');&nbsp;</div></li><li><div>      $this-&gt;o_javascript(++$this-&gt;numObj, 'new', $this-&gt;javascript);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = $this-&gt;catalogId;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;o_catalog($id, 'javascript', $js_id);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;arc4_objnum) {&nbsp;</div></li><li><div>      $this-&gt;ARC4_init($this-&gt;encryptionKey);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;checkAllHere();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $xref = array();&nbsp;</div></li><li><div>    $content = '%PDF-1.3';&nbsp;</div></li><li><div>    $pos = mb_strlen($content, '8bit');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    foreach ($this-&gt;objects as $k =&gt; $v) {&nbsp;</div></li><li><div>      $tmp = 'o_'.$v['t'];&nbsp;</div></li><li><div>      $cont = $this-&gt;$tmp($k, 'out');&nbsp;</div></li><li><div>      $content.= $cont;&nbsp;</div></li><li><div>      $xref[] = $pos;&nbsp;</div></li><li><div>      $pos+= mb_strlen($cont, '8bit');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $content.= &quot;\nxref\n0 &quot;.(count($xref) +1) .&quot;\n0000000000 65535 f \n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    foreach ($xref as $p) {&nbsp;</div></li><li><div>      $content.= str_pad($p, 10, &quot;0&quot;, STR_PAD_LEFT) . &quot; 00000 n \n&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $content.= &quot;trailer\n&lt;&lt;\n/Size &quot;.(count($xref) +1) .&quot;\n/Root 1 0 R\n/Info $this-&gt;infoObject 0 R\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // if encryption has been applied to this document then add the marker for this dictionary&nbsp;</div></li><li><div>    if ($this-&gt;arc4_objnum &gt; 0) {&nbsp;</div></li><li><div>      $content.= &quot;/Encrypt $this-&gt;arc4_objnum 0 R\n&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (mb_strlen($this-&gt;fileIdentifier, '8bit')) {&nbsp;</div></li><li><div>      $content.= &quot;/ID[&lt;$this-&gt;fileIdentifier&gt;&lt;$this-&gt;fileIdentifier&gt;]\n&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // account for \n added at start of xref table&nbsp;</div></li><li><div>    $pos++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $content.= &quot;&gt;&gt;\nstartxref\n$pos\n%%EOF\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * intialize a new document&nbsp;</div></li><li><div>   * if this is called on an existing document results may be unpredictable, but the existing document would be lost at minimum&nbsp;</div></li><li><div>   * this function is called automatically by the constructor function&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function newDocument($pageSize = array(0, 0, 612, 792)) {&nbsp;</div></li><li><div>    $this-&gt;numObj = 0;&nbsp;</div></li><li><div>    $this-&gt;objects = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_catalog($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_outlines($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_pages($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;o_pages($this-&gt;numObj, 'mediaBox', $pageSize);&nbsp;</div></li><li><div>    $this-&gt;currentNode = 3;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_procset($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_info($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_page($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // need to store the first page id as there is no way to get it to the user during&nbsp;</div></li><li><div>    // startup&nbsp;</div></li><li><div>    $this-&gt;firstPageId = $this-&gt;currentContents;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * open the font file and return a php structure containing it.&nbsp;</div></li><li><div>   * first check if this one has been done before and saved in a form more suited to php&nbsp;</div></li><li><div>   * note that if a php serialized version does not exist it will try and make one, but will&nbsp;</div></li><li><div>   * require write access to the directory to do it... it is MUCH faster to have these serialized&nbsp;</div></li><li><div>   * files.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function openFont($font) {&nbsp;</div></li><li><div>    // assume that $font contains the path and file but not the extension&nbsp;</div></li><li><div>    $pos = strrpos($font, '/');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($pos === false) {&nbsp;</div></li><li><div>      $dir = './';&nbsp;</div></li><li><div>      $name = $font;&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $dir = substr($font, 0, $pos+1);&nbsp;</div></li><li><div>      $name = substr($font, $pos+1);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $fontcache = $this-&gt;fontcache;&nbsp;</div></li><li><div>    if ($fontcache == '') {&nbsp;</div></li><li><div>      $fontcache = $dir;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //$name       filename without folder and extension of font metrics&nbsp;</div></li><li><div>    //$dir      folder of font metrics&nbsp;</div></li><li><div>    //$fontcache  folder of runtime created php serialized version of font metrics.&nbsp;</div></li><li><div>    //            If this is not given, the same folder as the font metrics will be used.&nbsp;</div></li><li><div>    //            Storing and reusing serialized versions improves speed much&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;addMessage(&quot;openFont: $font - $name&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( !$this-&gt;isUnicode || in_array(mb_strtolower(basename($name)), self::$coreFonts) ) {&nbsp;</div></li><li><div>      $metrics_name = &quot;$name.afm&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      $metrics_name = &quot;$name.ufm&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $cache_name = &quot;$metrics_name.php&quot;;&nbsp;</div></li><li><div>    $this-&gt;addMessage(&quot;metrics: $metrics_name, cache: $cache_name&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (file_exists($fontcache . $cache_name)) {&nbsp;</div></li><li><div>      $this-&gt;addMessage(&quot;openFont: php file exists $fontcache$cache_name&quot;);&nbsp;</div></li><li><div>      $this-&gt;fonts[$font] = require($fontcache . $cache_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!isset($this-&gt;fonts[$font]['_version_']) || $this-&gt;fonts[$font]['_version_'] != $this-&gt;fontcacheVersion) {&nbsp;</div></li><li><div>        // if the font file is old, then clear it out and prepare for re-creation&nbsp;</div></li><li><div>        $this-&gt;addMessage('openFont: clear out, make way for new version.');&nbsp;</div></li><li><div>        $this-&gt;fonts[$font] = null;&nbsp;</div></li><li><div>        unset($this-&gt;fonts[$font]);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      $old_cache_name = &quot;php_$metrics_name&quot;;&nbsp;</div></li><li><div>      if (file_exists($fontcache . $old_cache_name)) {&nbsp;</div></li><li><div>        $this-&gt;addMessage(&quot;openFont: php file doesn't exist $fontcache$cache_name, creating it from the old format&quot;);&nbsp;</div></li><li><div>        $old_cache = file_get_contents($fontcache . $old_cache_name);&nbsp;</div></li><li><div>        file_put_contents($fontcache . $cache_name, '&lt;?php return ' . $old_cache . ';');&nbsp;</div></li><li><div>        return $this-&gt;openFont($font);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!isset($this-&gt;fonts[$font]) && file_exists($dir . $metrics_name)) {&nbsp;</div></li><li><div>      // then rebuild the php_&lt;font&gt;.afm file from the &lt;font&gt;.afm file&nbsp;</div></li><li><div>      $this-&gt;addMessage(&quot;openFont: build php file from $dir$metrics_name&quot;);&nbsp;</div></li><li><div>      $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // 20 =&gt; 'space'&nbsp;</div></li><li><div>      $data['codeToName'] = array(); &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Since we're not going to enable Unicode for the core fonts we need to use a font-based&nbsp;</div></li><li><div>      // setting for Unicode support rather than a global setting.&nbsp;</div></li><li><div>      $data['isUnicode'] = (strtolower(substr($metrics_name, -3)) !== 'afm');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cidtogid = '';&nbsp;</div></li><li><div>      if ($data['isUnicode']) {&nbsp;</div></li><li><div>        $cidtogid = str_pad('', 256*256*2, &quot;\x00&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file = file($dir . $metrics_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($file as $rowA) {&nbsp;</div></li><li><div>        $row = trim($rowA);&nbsp;</div></li><li><div>        $pos = strpos($row, ' ');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($pos) {&nbsp;</div></li><li><div>          // then there must be some keyword&nbsp;</div></li><li><div>          $key = substr($row, 0, $pos);&nbsp;</div></li><li><div>          switch ($key) {&nbsp;</div></li><li><div>          case 'FontName':&nbsp;</div></li><li><div>          case 'FullName':&nbsp;</div></li><li><div>          case 'FamilyName':&nbsp;</div></li><li><div>          case 'PostScriptName':&nbsp;</div></li><li><div>          case 'Weight':&nbsp;</div></li><li><div>          case 'ItalicAngle':&nbsp;</div></li><li><div>          case 'IsFixedPitch':&nbsp;</div></li><li><div>          case 'CharacterSet':&nbsp;</div></li><li><div>          case 'UnderlinePosition':&nbsp;</div></li><li><div>          case 'UnderlineThickness':&nbsp;</div></li><li><div>          case 'Version':&nbsp;</div></li><li><div>          case 'EncodingScheme':&nbsp;</div></li><li><div>          case 'CapHeight':&nbsp;</div></li><li><div>          case 'XHeight':&nbsp;</div></li><li><div>          case 'Ascender':&nbsp;</div></li><li><div>          case 'Descender':&nbsp;</div></li><li><div>          case 'StdHW':&nbsp;</div></li><li><div>          case 'StdVW':&nbsp;</div></li><li><div>          case 'StartCharMetrics':&nbsp;</div></li><li><div>          case 'FontHeightOffset': // OAR - Added so we can offset the height calculation of a Windows font.  Otherwise it's too big.&nbsp;</div></li><li><div>            $data[$key] = trim(substr($row, $pos));&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'FontBBox':&nbsp;</div></li><li><div>            $data[$key] = explode(' ', trim(substr($row, $pos)));&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          //C 39 ; WX 222 ; N quoteright ; B 53 463 157 718 ;&nbsp;</div></li><li><div>          case 'C': // Found in AFM files&nbsp;</div></li><li><div>            $bits = explode(';', trim($row));&nbsp;</div></li><li><div>            $dtmp = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($bits as $bit) {&nbsp;</div></li><li><div>              $bits2 = explode(' ', trim($bit));&nbsp;</div></li><li><div>              if (mb_strlen($bits2[0], '8bit') == 0) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (count($bits2) &gt; 2) {&nbsp;</div></li><li><div>                $dtmp[$bits2[0]] = array();&nbsp;</div></li><li><div>                for ($i = 1; $i &lt; count($bits2); $i++) {&nbsp;</div></li><li><div>                  $dtmp[$bits2[0]][] = $bits2[$i];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>              } else if (count($bits2) == 2) {&nbsp;</div></li><li><div>                $dtmp[$bits2[0]] = $bits2[1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $c = (int)$dtmp['C'];&nbsp;</div></li><li><div>            $n = $dtmp['N'];&nbsp;</div></li><li><div>            $width = floatval($dtmp['WX']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($c &gt;= 0) {&nbsp;</div></li><li><div>              if ($c != hexdec($n)) {&nbsp;</div></li><li><div>                $data['codeToName'][$c] = $n;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $data['C'][$c] = $width;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              $data['C'][$n] = $width;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!isset($data['MissingWidth']) && $c == -1 && $n === '.notdef') {&nbsp;</div></li><li><div>              $data['MissingWidth'] = $width;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // U 827 ; WX 0 ; N squaresubnosp ; G 675 ;&nbsp;</div></li><li><div>          case 'U': // Found in UFM files&nbsp;</div></li><li><div>            if (!$data['isUnicode']) break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $bits = explode(';', trim($row));&nbsp;</div></li><li><div>            $dtmp = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($bits as $bit) {&nbsp;</div></li><li><div>              $bits2 = explode(' ', trim($bit));&nbsp;</div></li><li><div>              if (mb_strlen($bits2[0], '8bit') === 0) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (count($bits2) &gt; 2) {&nbsp;</div></li><li><div>                $dtmp[$bits2[0]] = array();&nbsp;</div></li><li><div>                for ($i = 1; $i &lt; count($bits2); $i++) {&nbsp;</div></li><li><div>                  $dtmp[$bits2[0]][] = $bits2[$i];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>              } else if (count($bits2) == 2) {&nbsp;</div></li><li><div>                $dtmp[$bits2[0]] = $bits2[1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $c = (int)$dtmp['U'];&nbsp;</div></li><li><div>            $n = $dtmp['N'];&nbsp;</div></li><li><div>            $glyph = $dtmp['G'];&nbsp;</div></li><li><div>            $width = floatval($dtmp['WX']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($c &gt;= 0) {&nbsp;</div></li><li><div>              // Set values in CID to GID map&nbsp;</div></li><li><div>              if ($c &gt;= 0 && $c &lt; 0xFFFF && $glyph) {&nbsp;</div></li><li><div>                $cidtogid[$c*2] = chr($glyph &gt;&gt; 8);&nbsp;</div></li><li><div>                $cidtogid[$c*2 + 1] = chr($glyph & 0xFF);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($c != hexdec($n)) {&nbsp;</div></li><li><div>                $data['codeToName'][$c] = $n;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $data['C'][$c] = $width;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>              $data['C'][$n] = $width;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!isset($data['MissingWidth']) && $c == -1 && $n === '.notdef') {&nbsp;</div></li><li><div>              $data['MissingWidth'] = $width;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'KPX':&nbsp;</div></li><li><div>            break; // don't include them as they are not used yet&nbsp;</div></li><li><div>            //KPX Adieresis yacute -40&nbsp;</div></li><li><div>            $bits = explode(' ', trim($row));&nbsp;</div></li><li><div>            $data['KPX'][$bits[1]][$bits[2]] = $bits[3];&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($this-&gt;compressionReady && $this-&gt;options['compression']) {&nbsp;</div></li><li><div>        // then implement ZLIB based compression on CIDtoGID string&nbsp;</div></li><li><div>        $data['CIDtoGID_Compressed'] = true;&nbsp;</div></li><li><div>        $cidtogid = gzcompress($cidtogid, 6);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $data['CIDtoGID'] = base64_encode($cidtogid);&nbsp;</div></li><li><div>      $data['_version_'] = $this-&gt;fontcacheVersion;&nbsp;</div></li><li><div>      $this-&gt;fonts[$font] = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //Because of potential trouble with php safe mode, expect that the folder already exists.&nbsp;</div></li><li><div>      //If not existing, this will hit performance because of missing cached results.&nbsp;</div></li><li><div>      if ( is_dir(substr($fontcache, 0, -1)) && is_writable(substr($fontcache, 0, -1)) ) {&nbsp;</div></li><li><div>        file_put_contents($fontcache . $cache_name, '&lt;?php return ' . var_export($data, true) . ';');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $data = null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!isset($this-&gt;fonts[$font])) {&nbsp;</div></li><li><div>      $this-&gt;addMessage(&quot;openFont: no font file found for $font. Do you need to run load_font.php?&quot;);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //pre_r($this-&gt;messages);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * if the font is not loaded then load it and make the required object&nbsp;</div></li><li><div>   * else just make it the current font&nbsp;</div></li><li><div>   * the encoding array can contain 'encoding'=&gt; 'none', 'WinAnsiEncoding', 'MacRomanEncoding' or 'MacExpertEncoding'&nbsp;</div></li><li><div>   * note that encoding='none' will need to be used for symbolic fonts&nbsp;</div></li><li><div>   * and 'differences' =&gt; an array of mappings between numbers 0-&gt;255 and character names.&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function selectFont($fontName, $encoding = '', $set = true) {&nbsp;</div></li><li><div>    $ext = substr($fontName, -4);&nbsp;</div></li><li><div>    if ($ext === '.afm' || $ext === '.ufm') {&nbsp;</div></li><li><div>      $fontName = substr($fontName, 0, mb_strlen($fontName)-4);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!isset($this-&gt;fonts[$fontName])) {&nbsp;</div></li><li><div>      $this-&gt;addMessage(&quot;selectFont: selecting - $fontName - $encoding, $set&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // load the file&nbsp;</div></li><li><div>      $this-&gt;openFont($fontName);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($this-&gt;fonts[$fontName])) {&nbsp;</div></li><li><div>        $this-&gt;numObj++;&nbsp;</div></li><li><div>        $this-&gt;numFonts++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $font = &$this-&gt;fonts[$fontName];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //$this-&gt;numFonts = md5($fontName);&nbsp;</div></li><li><div>        $pos = strrpos($fontName, '/');&nbsp;</div></li><li><div>        //      $dir = substr($fontName, 0, $pos+1);&nbsp;</div></li><li><div>        $name = substr($fontName, $pos+1);&nbsp;</div></li><li><div>        $options = array('name' =&gt; $name, 'fontFileName' =&gt; $fontName);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (is_array($encoding)) {&nbsp;</div></li><li><div>          // then encoding and differences might be set&nbsp;</div></li><li><div>          if (isset($encoding['encoding'])) {&nbsp;</div></li><li><div>            $options['encoding'] = $encoding['encoding'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($encoding['differences'])) {&nbsp;</div></li><li><div>            $options['differences'] = $encoding['differences'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        } else if (mb_strlen($encoding, '8bit')) {&nbsp;</div></li><li><div>          // then perhaps only the encoding has been set&nbsp;</div></li><li><div>          $options['encoding'] = $encoding;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fontObj = $this-&gt;numObj;&nbsp;</div></li><li><div>        $this-&gt;o_font($this-&gt;numObj, 'new', $options);&nbsp;</div></li><li><div>        $font['fontNum'] = $this-&gt;numFonts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if this is a '.afm' font, and there is a '.pfa' file to go with it ( as there&nbsp;</div></li><li><div>        // should be for all non-basic fonts), then load it into an object and put the&nbsp;</div></li><li><div>        // references into the font object&nbsp;</div></li><li><div>        $basefile = $fontName;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fbtype = '';&nbsp;</div></li><li><div>        if (file_exists(&quot;$basefile.pfb&quot;)) {&nbsp;</div></li><li><div>          $fbtype = 'pfb';&nbsp;</div></li><li><div>        } &nbsp;</div></li><li><div>        else if (file_exists(&quot;$basefile.ttf&quot;)) {&nbsp;</div></li><li><div>          $fbtype = 'ttf';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fbfile = &quot;$basefile.$fbtype&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //      $pfbfile = substr($fontName, 0, strlen($fontName)-4).'.pfb';&nbsp;</div></li><li><div>        //      $ttffile = substr($fontName, 0, strlen($fontName)-4).'.ttf';&nbsp;</div></li><li><div>        $this-&gt;addMessage('selectFont: checking for - '.$fbfile);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // OAR - I don't understand this old check&nbsp;</div></li><li><div>        // if (substr($fontName, -4) ===  '.afm' &&  strlen($fbtype)) {&nbsp;</div></li><li><div>        if ($fbtype) {&nbsp;</div></li><li><div>          $adobeFontName = isset($font['PostScriptName']) ? $font['PostScriptName'] : $font['FontName'];&nbsp;</div></li><li><div>          //        $fontObj = $this-&gt;numObj;&nbsp;</div></li><li><div>          $this-&gt;addMessage(&quot;selectFont: adding font file - $fbfile - $adobeFontName&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // find the array of font widths, and put that into an object.&nbsp;</div></li><li><div>          $firstChar = -1;&nbsp;</div></li><li><div>          $lastChar = 0;&nbsp;</div></li><li><div>          $widths = array();&nbsp;</div></li><li><div>          $cid_widths = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($font['C'] as $num =&gt; $d) {&nbsp;</div></li><li><div>            if (intval($num) &gt; 0 || $num == '0') {&nbsp;</div></li><li><div>              if (!$font['isUnicode']) {&nbsp;</div></li><li><div>                // With Unicode, widths array isn't used&nbsp;</div></li><li><div>                if ($lastChar&gt;0 && $num&gt;$lastChar+1) {&nbsp;</div></li><li><div>                  for ($i = $lastChar+1; $i&lt;$num; $i++) {&nbsp;</div></li><li><div>                    $widths[] = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $widths[] = $d;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($font['isUnicode']) {&nbsp;</div></li><li><div>                $cid_widths[$num] = $d;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($firstChar == -1) {&nbsp;</div></li><li><div>                $firstChar = $num;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $lastChar = $num;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // also need to adjust the widths for the differences array&nbsp;</div></li><li><div>          if (isset($options['differences'])) {&nbsp;</div></li><li><div>            foreach ($options['differences'] as $charNum =&gt; $charName) {&nbsp;</div></li><li><div>              if ($charNum &gt; $lastChar) {&nbsp;</div></li><li><div>                if (!$font['isUnicode']) {&nbsp;</div></li><li><div>                  // With Unicode, widths array isn't used&nbsp;</div></li><li><div>                  for ($i = $lastChar + 1; $i &lt;= $charNum; $i++) {&nbsp;</div></li><li><div>                    $widths[] = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $lastChar = $charNum;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (isset($font['C'][$charName])) {&nbsp;</div></li><li><div>                $widths[$charNum-$firstChar] = $font['C'][$charName];&nbsp;</div></li><li><div>                if ($font['isUnicode']) {&nbsp;</div></li><li><div>                  $cid_widths[$charName] = $font['C'][$charName];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($font['isUnicode']) {&nbsp;</div></li><li><div>            $font['CIDWidths'] = $cid_widths;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;addMessage('selectFont: FirstChar = '.$firstChar);&nbsp;</div></li><li><div>          $this-&gt;addMessage('selectFont: LastChar = '.$lastChar);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $widthid = -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (!$font['isUnicode']) {&nbsp;</div></li><li><div>            // With Unicode, widths array isn't used&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;numObj++;&nbsp;</div></li><li><div>            $this-&gt;o_contents($this-&gt;numObj, 'new', 'raw');&nbsp;</div></li><li><div>            $this-&gt;objects[$this-&gt;numObj]['c'].= '['.implode(' ', $widths).']';&nbsp;</div></li><li><div>            $widthid = $this-&gt;numObj;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $missing_width = 500;&nbsp;</div></li><li><div>          $stemV = 70;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (isset($font['MissingWidth'])) {&nbsp;</div></li><li><div>            $missing_width = $font['MissingWidth'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (isset($font['StdVW'])) {&nbsp;</div></li><li><div>            $stemV = $font['StdVW'];&nbsp;</div></li><li><div>          } else if (isset($font['Weight']) && preg_match('!(bold|black)!i', $font['Weight'])) {&nbsp;</div></li><li><div>            $stemV = 120;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // load the pfb file, and put that into an object too.&nbsp;</div></li><li><div>          // note that pdf supports only binary format type 1 font files, though there is a&nbsp;</div></li><li><div>          // simple utility to convert them from pfa to pfb.&nbsp;</div></li><li><div>          // FIXME: should we move font subset creation to CPDF::output? See notes in issue #750.&nbsp;</div></li><li><div>          if (!$this-&gt;isUnicode || $fbtype !== 'ttf' || empty($this-&gt;stringSubsets)) {&nbsp;</div></li><li><div>            $data = file_get_contents($fbfile);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>            $this-&gt;stringSubsets[$fontName][] = 32; // Force space if not in yet&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subset = $this-&gt;stringSubsets[$fontName];&nbsp;</div></li><li><div>            sort($subset);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Load font&nbsp;</div></li><li><div>            $font_obj = Font::load($fbfile);&nbsp;</div></li><li><div>            $font_obj-&gt;parse();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Define subset&nbsp;</div></li><li><div>            $font_obj-&gt;setSubset($subset);&nbsp;</div></li><li><div>            $font_obj-&gt;reduce();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Write new font&nbsp;</div></li><li><div>            $tmp_name = &quot;$fbfile.tmp.&quot;.uniqid();&nbsp;</div></li><li><div>            $font_obj-&gt;open($tmp_name, Font_Binary_Stream::modeWrite);&nbsp;</div></li><li><div>            $font_obj-&gt;encode(array(&quot;OS/2&quot;));&nbsp;</div></li><li><div>            $font_obj-&gt;close();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Parse the new font to get cid2gid and widths&nbsp;</div></li><li><div>            $font_obj = Font::load($tmp_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Find Unicode char map table&nbsp;</div></li><li><div>            $subtable = null;&nbsp;</div></li><li><div>            foreach ($font_obj-&gt;getData(&quot;cmap&quot;, &quot;subtables&quot;) as $_subtable) {&nbsp;</div></li><li><div>              if ($_subtable[&quot;platformID&quot;] == 0 || $_subtable[&quot;platformID&quot;] == 3 && $_subtable[&quot;platformSpecificID&quot;] == 1) {&nbsp;</div></li><li><div>                $subtable = $_subtable;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($subtable) {&nbsp;</div></li><li><div>              $glyphIndexArray = $subtable[&quot;glyphIndexArray&quot;];&nbsp;</div></li><li><div>              $hmtx = $font_obj-&gt;getData(&quot;hmtx&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              unset($glyphIndexArray[0xFFFF]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $cidtogid = str_pad('', max(array_keys($glyphIndexArray))*2+1, &quot;\x00&quot;);&nbsp;</div></li><li><div>              $font['CIDWidths'] = array();&nbsp;</div></li><li><div>              foreach ($glyphIndexArray as $cid =&gt; $gid) {&nbsp;</div></li><li><div>                if ($cid &gt;= 0 && $cid &lt; 0xFFFF && $gid) {&nbsp;</div></li><li><div>                  $cidtogid[$cid*2] = chr($gid &gt;&gt; 8);&nbsp;</div></li><li><div>                  $cidtogid[$cid*2 + 1] = chr($gid & 0xFF);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $width = $font_obj-&gt;normalizeFUnit(isset($hmtx[$gid]) ? $hmtx[$gid][0] : $hmtx[0][0]);&nbsp;</div></li><li><div>                $font['CIDWidths'][$cid] = $width;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $font['CIDtoGID'] = base64_encode(gzcompress($cidtogid));&nbsp;</div></li><li><div>              $font['CIDtoGID_Compressed'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $data = file_get_contents($tmp_name);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            else {&nbsp;</div></li><li><div>              $data = file_get_contents($fbfile);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $font_obj-&gt;close();&nbsp;</div></li><li><div>            unlink($tmp_name);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // create the font descriptor&nbsp;</div></li><li><div>          $this-&gt;numObj++;&nbsp;</div></li><li><div>          $fontDescriptorId = $this-&gt;numObj;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;numObj++;&nbsp;</div></li><li><div>          $pfbid = $this-&gt;numObj;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // determine flags (more than a little flakey, hopefully will not matter much)&nbsp;</div></li><li><div>          $flags = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($font['ItalicAngle'] != 0) {&nbsp;</div></li><li><div>            $flags+= pow(2, 6);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($font['IsFixedPitch'] === 'true') {&nbsp;</div></li><li><div>            $flags+= 1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $flags+= pow(2, 5); // assume non-sybolic&nbsp;</div></li><li><div>          $list = array(&nbsp;</div></li><li><div>            'Ascent' =&gt; 'Ascender', &nbsp;</div></li><li><div>            'CapHeight' =&gt; 'CapHeight', &nbsp;</div></li><li><div>            'MissingWidth' =&gt; 'MissingWidth', &nbsp;</div></li><li><div>            'Descent' =&gt; 'Descender', &nbsp;</div></li><li><div>            'FontBBox' =&gt; 'FontBBox', &nbsp;</div></li><li><div>            'ItalicAngle' =&gt; 'ItalicAngle'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $fdopt = array(&nbsp;</div></li><li><div>            'Flags' =&gt; $flags, &nbsp;</div></li><li><div>            'FontName' =&gt; $adobeFontName, &nbsp;</div></li><li><div>            'StemV' =&gt; $stemV&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($list as $k =&gt; $v) {&nbsp;</div></li><li><div>            if (isset($font[$v])) {&nbsp;</div></li><li><div>              $fdopt[$k] = $font[$v];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($fbtype === 'pfb') {&nbsp;</div></li><li><div>            $fdopt['FontFile'] = $pfbid;&nbsp;</div></li><li><div>          } else if ($fbtype === 'ttf') {&nbsp;</div></li><li><div>            $fdopt['FontFile2'] = $pfbid;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;o_fontDescriptor($fontDescriptorId, 'new', $fdopt);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // embed the font program&nbsp;</div></li><li><div>          $this-&gt;o_contents($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>          $this-&gt;objects[$pfbid]['c'].= $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // determine the cruicial lengths within this file&nbsp;</div></li><li><div>          if ($fbtype === 'pfb') {&nbsp;</div></li><li><div>            $l1 = strpos($data, 'eexec') +6;&nbsp;</div></li><li><div>            $l2 = strpos($data, '00000000') -$l1;&nbsp;</div></li><li><div>            $l3 = mb_strlen($data, '8bit') -$l2-$l1;&nbsp;</div></li><li><div>            $this-&gt;o_contents($this-&gt;numObj, 'add', array('Length1' =&gt; $l1, 'Length2' =&gt; $l2, 'Length3' =&gt; $l3));&nbsp;</div></li><li><div>          } else if ($fbtype == 'ttf') {&nbsp;</div></li><li><div>            $l1 = mb_strlen($data, '8bit');&nbsp;</div></li><li><div>            $this-&gt;o_contents($this-&gt;numObj, 'add', array('Length1' =&gt; $l1));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // tell the font object about all this new stuff&nbsp;</div></li><li><div>          $tmp = array(&nbsp;</div></li><li><div>            'BaseFont' =&gt; $adobeFontName, &nbsp;</div></li><li><div>            'MissingWidth' =&gt; $missing_width, &nbsp;</div></li><li><div>            'Widths' =&gt; $widthid, &nbsp;</div></li><li><div>            'FirstChar' =&gt; $firstChar, &nbsp;</div></li><li><div>            'LastChar' =&gt; $lastChar, &nbsp;</div></li><li><div>            'FontDescriptor' =&gt; $fontDescriptorId&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($fbtype === 'ttf') {&nbsp;</div></li><li><div>            $tmp['SubType'] = 'TrueType';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;addMessage(&quot;adding extra info to font.($fontObj)&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($tmp as $fk =&gt; $fv) {&nbsp;</div></li><li><div>            $this-&gt;addMessage(&quot;$fk : $fv&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;o_font($fontObj, 'add', $tmp);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          $this-&gt;addMessage('selectFont: pfb or ttf file not found, ok if this is one of the 14 standard fonts');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // also set the differences here, note that this means that these will take effect only the&nbsp;</div></li><li><div>        //first time that a font is selected, else they are ignored&nbsp;</div></li><li><div>        if (isset($options['differences'])) {&nbsp;</div></li><li><div>          $font['differences'] = $options['differences'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($set && isset($this-&gt;fonts[$fontName])) {&nbsp;</div></li><li><div>      // so if for some reason the font was not set in the last one then it will not be selected&nbsp;</div></li><li><div>      $this-&gt;currentBaseFont = $fontName;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // the next lines mean that if a new font is selected, then the current text state will be&nbsp;</div></li><li><div>      // applied to it as well.&nbsp;</div></li><li><div>      $this-&gt;currentFont = $this-&gt;currentBaseFont;&nbsp;</div></li><li><div>      $this-&gt;currentFontNum = $this-&gt;fonts[$this-&gt;currentFont]['fontNum'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //$this-&gt;setCurrentFont();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $this-&gt;currentFontNum;&nbsp;</div></li><li><div>    //return $this-&gt;numObj;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * sets up the current font, based on the font families, and the current text state&nbsp;</div></li><li><div>   * note that this system is quite flexible, a bold-italic font can be completely different to a&nbsp;</div></li><li><div>   * italic-bold font, and even bold-bold will have to be defined within the family to have meaning&nbsp;</div></li><li><div>   * This function is to be called whenever the currentTextState is changed, it will update&nbsp;</div></li><li><div>   * the currentFont setting to whatever the appropriatte family one is.&nbsp;</div></li><li><div>   * If the user calls selectFont themselves then that will reset the currentBaseFont, and the currentFont&nbsp;</div></li><li><div>   * This function will change the currentFont to whatever it should be, but will not change the&nbsp;</div></li><li><div>   * currentBaseFont.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function setCurrentFont() {&nbsp;</div></li><li><div>    //   if (strlen($this-&gt;currentBaseFont) == 0) {&nbsp;</div></li><li><div>    //     // then assume an initial font&nbsp;</div></li><li><div>    //     $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    //   }&nbsp;</div></li><li><div>    //   $cf = substr($this-&gt;currentBaseFont, strrpos($this-&gt;currentBaseFont, '/')+1);&nbsp;</div></li><li><div>    //   if (strlen($this-&gt;currentTextState)&nbsp;</div></li><li><div>    //     && isset($this-&gt;fontFamilies[$cf])&nbsp;</div></li><li><div>    //       && isset($this-&gt;fontFamilies[$cf][$this-&gt;currentTextState])) {&nbsp;</div></li><li><div>    //     // then we are in some state or another&nbsp;</div></li><li><div>    //     // and this font has a family, and the current setting exists within it&nbsp;</div></li><li><div>    //     // select the font, then return it&nbsp;</div></li><li><div>    //     $nf = substr($this-&gt;currentBaseFont, 0, strrpos($this-&gt;currentBaseFont, '/')+1).$this-&gt;fontFamilies[$cf][$this-&gt;currentTextState];&nbsp;</div></li><li><div>    //     $this-&gt;selectFont($nf, '', 0);&nbsp;</div></li><li><div>    //     $this-&gt;currentFont = $nf;&nbsp;</div></li><li><div>    //     $this-&gt;currentFontNum = $this-&gt;fonts[$nf]['fontNum'];&nbsp;</div></li><li><div>    //   } else {&nbsp;</div></li><li><div>    //     // the this font must not have the right family member for the current state&nbsp;</div></li><li><div>    //     // simply assume the base font&nbsp;</div></li><li><div>    $this-&gt;currentFont = $this-&gt;currentBaseFont;&nbsp;</div></li><li><div>    $this-&gt;currentFontNum = $this-&gt;fonts[$this-&gt;currentFont]['fontNum'];&nbsp;</div></li><li><div>    //  }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * function for the user to find out what the ID is of the first page that was created during&nbsp;</div></li><li><div>   * startup - useful if they wish to add something to it later.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function getFirstPageId() {&nbsp;</div></li><li><div>    return $this-&gt;firstPageId;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add content to the currently active object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function addContent($content) {&nbsp;</div></li><li><div>    $this-&gt;objects[$this-&gt;currentContents]['c'] .=  $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * sets the color for fill operations&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setColor($color, $force = false) {&nbsp;</div></li><li><div>    $new_color = array($color[0], $color[1], $color[2], isset($color[3]) ? $color[3] : null);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!$force && $this-&gt;currentColor == $new_color) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($new_color[3])) {&nbsp;</div></li><li><div>      $this-&gt;currentColor = $new_color;&nbsp;</div></li><li><div>      $this-&gt;addContent(vsprintf(&quot;\n%.3F %.3F %.3F %.3F k&quot;, $this-&gt;currentColor));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    else if (isset($new_color[2])) {&nbsp;</div></li><li><div>      $this-&gt;currentColor = $new_color;&nbsp;</div></li><li><div>      $this-&gt;addContent(vsprintf(&quot;\n%.3F %.3F %.3F rg&quot;, $this-&gt;currentColor));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * sets the color for stroke operations&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setStrokeColor($color, $force = false) {&nbsp;</div></li><li><div>    $new_color = array($color[0], $color[1], $color[2], isset($color[3]) ? $color[3] : null);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!$force && $this-&gt;currentStrokeColor == $new_color) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($new_color[3])) {&nbsp;</div></li><li><div>      $this-&gt;currentStrokeColor = $new_color;&nbsp;</div></li><li><div>      $this-&gt;addContent(vsprintf(&quot;\n%.3F %.3F %.3F %.3F K&quot;, $this-&gt;currentStrokeColor));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    else if (isset($new_color[2])) {&nbsp;</div></li><li><div>      $this-&gt;currentStrokeColor = $new_color;&nbsp;</div></li><li><div>      $this-&gt;addContent(vsprintf(&quot;\n%.3F %.3F %.3F RG&quot;, $this-&gt;currentStrokeColor));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Set the graphics state for compositions&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setGraphicsState($parameters) {&nbsp;</div></li><li><div>    // Create a new graphics state object&nbsp;</div></li><li><div>    // FIXME: should actually keep track of states that have already been created...&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_extGState($this-&gt;numObj, 'new', $parameters);&nbsp;</div></li><li><div>    $this-&gt;addContent(&quot;\n/GS$this-&gt;numStates gs&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Set current blend mode & opacity for lines.&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * Valid blend modes are:&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * Normal, Multiply, Screen, Overlay, Darken, Lighten, &nbsp;</div></li><li><div>   * ColorDogde, ColorBurn, HardLight, SoftLight, Difference, &nbsp;</div></li><li><div>   * Exclusion&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @param string $mode the blend mode to use&nbsp;</div></li><li><div>   * @param float $opacity 0.0 fully transparent, 1.0 fully opaque&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setLineTransparency($mode, $opacity) {&nbsp;</div></li><li><div>    static $blend_modes = array(&quot;Normal&quot;, &quot;Multiply&quot;, &quot;Screen&quot;, &nbsp;</div></li><li><div>                                &quot;Overlay&quot;, &quot;Darken&quot;, &quot;Lighten&quot;, &nbsp;</div></li><li><div>                                &quot;ColorDogde&quot;, &quot;ColorBurn&quot;, &quot;HardLight&quot;, &nbsp;</div></li><li><div>                                &quot;SoftLight&quot;, &quot;Difference&quot;, &quot;Exclusion&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( !in_array($mode, $blend_modes) )&nbsp;</div></li><li><div>      $mode = &quot;Normal&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Only create a new graphics state if required&nbsp;</div></li><li><div>    if ( $mode === $this-&gt;currentLineTransparency[&quot;mode&quot;] &&&nbsp;</div></li><li><div>         $opacity == $this-&gt;currentLineTransparency[&quot;opacity&quot;] )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;currentLineTransparency[&quot;mode&quot;] = $mode;&nbsp;</div></li><li><div>    $this-&gt;currentLineTransparency[&quot;opacity&quot;] = $opacity;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $options = array(&quot;BM&quot; =&gt; &quot;/$mode&quot;, &nbsp;</div></li><li><div>                     &quot;CA&quot; =&gt; (float)$opacity);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;setGraphicsState($options);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Set current blend mode & opacity for filled objects.&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * Valid blend modes are:&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * Normal, Multiply, Screen, Overlay, Darken, Lighten, &nbsp;</div></li><li><div>   * ColorDogde, ColorBurn, HardLight, SoftLight, Difference, &nbsp;</div></li><li><div>   * Exclusion&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @param string $mode the blend mode to use&nbsp;</div></li><li><div>   * @param float $opacity 0.0 fully transparent, 1.0 fully opaque&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setFillTransparency($mode, $opacity) {&nbsp;</div></li><li><div>    static $blend_modes = array(&quot;Normal&quot;, &quot;Multiply&quot;, &quot;Screen&quot;, &nbsp;</div></li><li><div>                                &quot;Overlay&quot;, &quot;Darken&quot;, &quot;Lighten&quot;, &nbsp;</div></li><li><div>                                &quot;ColorDogde&quot;, &quot;ColorBurn&quot;, &quot;HardLight&quot;, &nbsp;</div></li><li><div>                                &quot;SoftLight&quot;, &quot;Difference&quot;, &quot;Exclusion&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( !in_array($mode, $blend_modes) ) {&nbsp;</div></li><li><div>      $mode = &quot;Normal&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $mode === $this-&gt;currentFillTransparency[&quot;mode&quot;] &&&nbsp;</div></li><li><div>         $opacity == $this-&gt;currentFillTransparency[&quot;opacity&quot;] ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;currentFillTransparency[&quot;mode&quot;] = $mode;&nbsp;</div></li><li><div>    $this-&gt;currentFillTransparency[&quot;opacity&quot;] = $opacity;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $options = array(&nbsp;</div></li><li><div>      &quot;BM&quot; =&gt; &quot;/$mode&quot;, &nbsp;</div></li><li><div>      &quot;ca&quot; =&gt; (float)$opacity, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;setGraphicsState($options);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a line from one set of coordinates to another&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function line($x1, $y1, $x2, $y2, $stroke = true) {&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F m %.3F %.3F l&quot;, $x1, $y1, $x2, $y2));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($stroke) {&nbsp;</div></li><li><div>      $this-&gt;addContent(' S');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a bezier curve based on 4 control points&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function curve($x0, $y0, $x1, $y1, $x2, $y2, $x3, $y3) {&nbsp;</div></li><li><div>    // in the current line style, draw a bezier curve from (x0, y0) to (x3, y3) using the other two points&nbsp;</div></li><li><div>    // as the control points for the curve.&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F m %.3F %.3F %.3F %.3F %.3F %.3F c S&quot;, $x0, $y0, $x1, $y1, $x2, $y2, $x3, $y3));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a part of an ellipse&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function partEllipse($x0, $y0, $astart, $afinish, $r1, $r2 = 0, $angle = 0, $nSeg = 8) {&nbsp;</div></li><li><div>    $this-&gt;ellipse($x0, $y0, $r1, $r2, $angle, $nSeg, $astart, $afinish, false);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a filled ellipse&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function filledEllipse($x0, $y0, $r1, $r2 = 0, $angle = 0, $nSeg = 8, $astart = 0, $afinish = 360) {&nbsp;</div></li><li><div>    return $this-&gt;ellipse($x0, $y0, $r1, $r2, $angle, $nSeg, $astart, $afinish, true, true);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw an ellipse&nbsp;</div></li><li><div>   * note that the part and filled ellipse are just special cases of this function&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * draws an ellipse in the current line style&nbsp;</div></li><li><div>   * centered at $x0, $y0, radii $r1, $r2&nbsp;</div></li><li><div>   * if $r2 is not set, then a circle is drawn&nbsp;</div></li><li><div>   * from $astart to $afinish, measured in degrees, running anti-clockwise from the right hand side of the ellipse.&nbsp;</div></li><li><div>   * nSeg is not allowed to be less than 2, as this will simply draw a line (and will even draw a&nbsp;</div></li><li><div>   * pretty crappy shape at 2, as we are approximating with bezier curves.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function ellipse($x0, $y0, $r1, $r2 = 0, $angle = 0, $nSeg = 8, $astart = 0, $afinish = 360, $close = true, $fill = false, $stroke = true, $incomplete = false) {&nbsp;</div></li><li><div>    if ($r1 == 0) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($r2 == 0) {&nbsp;</div></li><li><div>      $r2 = $r1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($nSeg &lt; 2) {&nbsp;</div></li><li><div>      $nSeg = 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $astart = deg2rad((float)$astart);&nbsp;</div></li><li><div>    $afinish = deg2rad((float)$afinish);&nbsp;</div></li><li><div>    $totalAngle = $afinish-$astart;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $dt = $totalAngle/$nSeg;&nbsp;</div></li><li><div>    $dtm = $dt/3;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($angle != 0) {&nbsp;</div></li><li><div>      $a = -1*deg2rad((float)$angle);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot;\n q %.3F %.3F %.3F %.3F %.3F %.3F cm&quot;, cos($a), -sin($a), sin($a), cos($a), $x0, $y0));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $x0 = 0;&nbsp;</div></li><li><div>      $y0 = 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $t1 = $astart;&nbsp;</div></li><li><div>    $a0 = $x0 + $r1*cos($t1);&nbsp;</div></li><li><div>    $b0 = $y0 + $r2*sin($t1);&nbsp;</div></li><li><div>    $c0 = -$r1 * sin($t1);&nbsp;</div></li><li><div>    $d0 = $r2 * cos($t1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!$incomplete) {&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F m &quot;, $a0, $b0));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    for ($i = 1; $i &lt;= $nSeg; $i++) {&nbsp;</div></li><li><div>      // draw this bit of the total curve&nbsp;</div></li><li><div>      $t1 = $i * $dt + $astart;&nbsp;</div></li><li><div>      $a1 = $x0 + $r1 * cos($t1);&nbsp;</div></li><li><div>      $b1 = $y0 + $r2 * sin($t1);&nbsp;</div></li><li><div>      $c1 = -$r1 * sin($t1);&nbsp;</div></li><li><div>      $d1 = $r2 * cos($t1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F %.3F %.3F %.3F %.3F c&quot;, ($a0+$c0*$dtm), ($b0+$d0*$dtm), ($a1-$c1*$dtm), ($b1-$d1*$dtm), $a1, $b1));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $a0 = $a1;&nbsp;</div></li><li><div>      $b0 = $b1;&nbsp;</div></li><li><div>      $c0 = $c1;&nbsp;</div></li><li><div>      $d0 = $d1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!$incomplete) {&nbsp;</div></li><li><div>      if ($fill) {&nbsp;</div></li><li><div>        $this-&gt;addContent(' f');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if ($close) {&nbsp;</div></li><li><div>        $this-&gt;addContent(' s'); // small 's' signifies closing the path as well&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if ($stroke) {&nbsp;</div></li><li><div>        $this-&gt;addContent(' S');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($angle != 0) {&nbsp;</div></li><li><div>      $this-&gt;addContent(' Q');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * this sets the line drawing style.&nbsp;</div></li><li><div>   * width, is the thickness of the line in user units&nbsp;</div></li><li><div>   * cap is the type of cap to put on the line, values can be 'butt', 'round', 'square'&nbsp;</div></li><li><div>   *    where the diffference between 'square' and 'butt' is that 'square' projects a flat end past the&nbsp;</div></li><li><div>   *    end of the line.&nbsp;</div></li><li><div>   * join can be 'miter', 'round', 'bevel'&nbsp;</div></li><li><div>   * dash is an array which sets the dash pattern, is a series of length values, which are the lengths of the&nbsp;</div></li><li><div>   *   on and off dashes.&nbsp;</div></li><li><div>   *   (2) represents 2 on, 2 off, 2 on , 2 off ...&nbsp;</div></li><li><div>   *   (2, 1) is 2 on, 1 off, 2 on, 1 off.. etc&nbsp;</div></li><li><div>   * phase is a modifier on the dash pattern which is used to shift the point at which the pattern starts.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setLineStyle($width = 1, $cap = '', $join = '', $dash = '', $phase = 0) {&nbsp;</div></li><li><div>    // this is quite inefficient in that it sets all the parameters whenever 1 is changed, but will fix another day&nbsp;</div></li><li><div>    $string = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($width &gt; 0) {&nbsp;</div></li><li><div>      $string.= &quot;$width w&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $ca = array('butt' =&gt; 0, 'round' =&gt; 1, 'square' =&gt; 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($ca[$cap])) {&nbsp;</div></li><li><div>      $string.= &quot; $ca[$cap] J&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $ja = array('miter' =&gt; 0, 'round' =&gt; 1, 'bevel' =&gt; 2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($ja[$join])) {&nbsp;</div></li><li><div>      $string.= &quot; $ja[$join] j&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (is_array($dash)) {&nbsp;</div></li><li><div>      $string.= ' [ ' . implode(' ', $dash) . &quot; ] $phase d&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;currentLineStyle = $string;&nbsp;</div></li><li><div>    $this-&gt;addContent(&quot;\n$string&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a polygon, the syntax for this is similar to the GD polygon command&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function polygon($p, $np, $f = false) {&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F m &quot;, $p[0], $p[1]));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    for ($i = 2; $i &lt; $np * 2; $i = $i + 2) {&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot;%.3F %.3F l &quot;, $p[$i], $p[$i+1]));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($f) {&nbsp;</div></li><li><div>      $this-&gt;addContent(' f');&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;addContent(' S');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * a filled rectangle, note that it is the width and height of the rectangle which are the secondary paramaters, not&nbsp;</div></li><li><div>   * the coordinates of the upper-right corner&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function filledRectangle($x1, $y1, $width, $height) {&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F %.3F %.3F re f&quot;, $x1, $y1, $width, $height));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a rectangle, note that it is the width and height of the rectangle which are the secondary paramaters, not&nbsp;</div></li><li><div>   * the coordinates of the upper-right corner&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function rectangle($x1, $y1, $width, $height) {&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F %.3F %.3F re S&quot;, $x1, $y1, $width, $height));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * save the current graphic state&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function save() {&nbsp;</div></li><li><div>    // we must reset the color cache or it will keep bad colors after clipping&nbsp;</div></li><li><div>    $this-&gt;currentColor = null;&nbsp;</div></li><li><div>    $this-&gt;currentStrokeColor = null;&nbsp;</div></li><li><div>    $this-&gt;addContent(&quot;\nq&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * restore the last graphic state&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function restore() {&nbsp;</div></li><li><div>    // we must reset the color cache or it will keep bad colors after clipping&nbsp;</div></li><li><div>    $this-&gt;currentColor = null;&nbsp;</div></li><li><div>    $this-&gt;currentStrokeColor = null;&nbsp;</div></li><li><div>    $this-&gt;addContent(&quot;\nQ&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a clipping rectangle, all the elements added after this will be clipped&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function clippingRectangle($x1, $y1, $width, $height) {&nbsp;</div></li><li><div>    $this-&gt;save();&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F %.3F %.3F re W n&quot;, $x1, $y1, $width, $height));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * draw a clipping rounded rectangle, all the elements added after this will be clipped&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function clippingRectangleRounded($x1, $y1, $w, $h, $rTL, $rTR, $rBR, $rBL) {&nbsp;</div></li><li><div>    $this-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // start: top edge, left end&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F m &quot;, $x1, $y1 - $rTL + $h));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // curve: bottom-left corner&nbsp;</div></li><li><div>    $this-&gt;ellipse($x1 + $rBL, $y1 + $rBL, $rBL, 0, 0, 8, 180, 270, false, false, false, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // line: right edge, bottom end&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F l &quot;, $x1 + $w - $rBR, $y1));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // curve: bottom-right corner&nbsp;</div></li><li><div>    $this-&gt;ellipse($x1 + $w - $rBR, $y1 + $rBR, $rBR, 0, 0, 8, 270, 360, false, false, false, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // line: right edge, top end&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F l &quot;, $x1 + $w, $y1 + $h - $rTR));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // curve: bottom-right corner&nbsp;</div></li><li><div>    $this-&gt;ellipse($x1 + $w - $rTR, $y1 + $h - $rTR, $rTR, 0, 0, 8, 0, 90, false, false, false, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // line: bottom edge, right end&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F l &quot;, $x1 + $rTL, $y1 + $h));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // curve: top-right corner&nbsp;</div></li><li><div>    $this-&gt;ellipse($x1 + $rTL, $y1 + $h - $rTL, $rTL, 0, 0, 8, 90, 180, false, false, false, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // line: top edge, left end&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\n%.3F %.3F l &quot;, $x1 + $rBL, $y1));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Close & clip&nbsp;</div></li><li><div>    $this-&gt;addContent(&quot; W n&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * ends the last clipping shape&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function clippingEnd() {&nbsp;</div></li><li><div>    $this-&gt;restore();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * scale&nbsp;</div></li><li><div>   * @param float $s_x scaling factor for width as percent&nbsp;</div></li><li><div>   * @param float $s_y scaling factor for height as percent&nbsp;</div></li><li><div>   * @param float $x Origin abscisse&nbsp;</div></li><li><div>   * @param float $y Origin ordinate&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function scale($s_x, $s_y, $x, $y) {&nbsp;</div></li><li><div>    $y = $this-&gt;currentPageSize[&quot;height&quot;] - $y;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $tm = array(&nbsp;</div></li><li><div>      $s_x, 0, &nbsp;</div></li><li><div>      0, $s_y, &nbsp;</div></li><li><div>      $x*(1-$s_x), $y*(1-$s_y)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;transform($tm);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * translate&nbsp;</div></li><li><div>   * @param float $t_x movement to the right&nbsp;</div></li><li><div>   * @param float $t_y movement to the bottom&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function translate($t_x, $t_y) {&nbsp;</div></li><li><div>    $tm = array(&nbsp;</div></li><li><div>      1, 0, &nbsp;</div></li><li><div>      0, 1, &nbsp;</div></li><li><div>      $t_x, -$t_y&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;transform($tm);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * rotate&nbsp;</div></li><li><div>   * @param float $angle angle in degrees for counter-clockwise rotation&nbsp;</div></li><li><div>   * @param float $x Origin abscisse&nbsp;</div></li><li><div>   * @param float $y Origin ordinate&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function rotate($angle, $x, $y) {&nbsp;</div></li><li><div>    $y = $this-&gt;currentPageSize[&quot;height&quot;] - $y;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $a = deg2rad($angle);&nbsp;</div></li><li><div>    $cos_a = cos($a);&nbsp;</div></li><li><div>    $sin_a = sin($a);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $tm = array(&nbsp;</div></li><li><div>      $cos_a, -$sin_a, &nbsp;</div></li><li><div>      $sin_a, $cos_a, &nbsp;</div></li><li><div>      $x - $sin_a*$y - $cos_a*$x, $y - $cos_a*$y + $sin_a*$x, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;transform($tm);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * skew&nbsp;</div></li><li><div>   * @param float $angle_x&nbsp;</div></li><li><div>   * @param float $angle_y&nbsp;</div></li><li><div>   * @param float $x Origin abscisse&nbsp;</div></li><li><div>   * @param float $y Origin ordinate&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function skew($angle_x, $angle_y, $x, $y) {&nbsp;</div></li><li><div>    $y = $this-&gt;currentPageSize[&quot;height&quot;] - $y;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $tan_x = tan(deg2rad($angle_x));&nbsp;</div></li><li><div>    $tan_y = tan(deg2rad($angle_y));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $tm = array(&nbsp;</div></li><li><div>      1, -$tan_y, &nbsp;</div></li><li><div>      -$tan_x, 1, &nbsp;</div></li><li><div>      $tan_x*$y, $tan_y*$x, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;transform($tm);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * apply graphic transformations&nbsp;</div></li><li><div>   * @param array $tm transformation matrix&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function transform($tm) {&nbsp;</div></li><li><div>    $this-&gt;addContent(vsprintf(&quot;\n %.3F %.3F %.3F %.3F %.3F %.3F cm&quot;, $tm));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a new page to the document&nbsp;</div></li><li><div>   * this also makes the new page the current active object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function newPage($insert = 0, $id = 0, $pos = 'after') {&nbsp;</div></li><li><div>    // if there is a state saved, then go up the stack closing them&nbsp;</div></li><li><div>    // then on the new page, re-open them with the right setings&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($this-&gt;nStateStack) {&nbsp;</div></li><li><div>      for ($i = $this-&gt;nStateStack; $i &gt;= 1; $i--) {&nbsp;</div></li><li><div>        $this-&gt;restoreState($i);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($insert) {&nbsp;</div></li><li><div>      // the id from the ezPdf class is the id of the contents of the page, not the page object itself&nbsp;</div></li><li><div>      // query that object to find the parent&nbsp;</div></li><li><div>      $rid = $this-&gt;objects[$id]['onPage'];&nbsp;</div></li><li><div>      $opt = array('rid' =&gt; $rid, 'pos' =&gt; $pos);&nbsp;</div></li><li><div>      $this-&gt;o_page($this-&gt;numObj, 'new', $opt);&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;o_page($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // if there is a stack saved, then put that onto the page&nbsp;</div></li><li><div>    if ($this-&gt;nStateStack) {&nbsp;</div></li><li><div>      for ($i = 1; $i &lt;= $this-&gt;nStateStack; $i++) {&nbsp;</div></li><li><div>        $this-&gt;saveState($i);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // and if there has been a stroke or fill color set, then transfer them&nbsp;</div></li><li><div>    if (isset($this-&gt;currentColor)) {&nbsp;</div></li><li><div>      $this-&gt;setColor($this-&gt;currentColor, true);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($this-&gt;currentStrokeColor)) {&nbsp;</div></li><li><div>      $this-&gt;setStrokeColor($this-&gt;currentStrokeColor, true);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // if there is a line style set, then put this in too&nbsp;</div></li><li><div>    if (mb_strlen($this-&gt;currentLineStyle, '8bit')) {&nbsp;</div></li><li><div>      $this-&gt;addContent(&quot;\n$this-&gt;currentLineStyle&quot;);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // the call to the o_page object set currentContents to the present page, so this can be returned as the page id&nbsp;</div></li><li><div>    return $this-&gt;currentContents;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * output the pdf code, streaming it to the browser&nbsp;</div></li><li><div>   * the relevant headers are set so that hopefully the browser will recognise it&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function stream($options = '') {&nbsp;</div></li><li><div>    // setting the options allows the adjustment of the headers&nbsp;</div></li><li><div>    // values at the moment are:&nbsp;</div></li><li><div>    // 'Content-Disposition' =&gt; 'filename'  - sets the filename, though not too sure how well this will&nbsp;</div></li><li><div>    //        work as in my trial the browser seems to use the filename of the php file with .pdf on the end&nbsp;</div></li><li><div>    // 'Accept-Ranges' =&gt; 1 or 0 - if this is not set to 1, then this header is not included, off by default&nbsp;</div></li><li><div>    //    this header seems to have caused some problems despite tha fact that it is supposed to solve&nbsp;</div></li><li><div>    //    them, so I am leaving it off by default.&nbsp;</div></li><li><div>    // 'compress' = &gt; 1 or 0 - apply content stream compression, this is on (1) by default&nbsp;</div></li><li><div>    // 'Attachment' =&gt; 1 or 0 - if 1, force the browser to open a download dialog&nbsp;</div></li><li><div>    if (!is_array($options)) {&nbsp;</div></li><li><div>      $options = array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( headers_sent()) {&nbsp;</div></li><li><div>      die(&quot;Unable to stream pdf: headers already sent&quot;);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $debug = empty($options['compression']);&nbsp;</div></li><li><div>    $tmp = ltrim($this-&gt;output($debug));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    header(&quot;Cache-Control: private&quot;);&nbsp;</div></li><li><div>    header(&quot;Content-type: application/pdf&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //FIXME: I don't know that this is sufficient for determining content length (i.e. what about transport compression?)&nbsp;</div></li><li><div>    header(&quot;Content-Length: &quot; . mb_strlen($tmp, '8bit'));&nbsp;</div></li><li><div>    $fileName = (isset($options['Content-Disposition']) ?  $options['Content-Disposition'] :  'file.pdf');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( !isset($options[&quot;Attachment&quot;]))&nbsp;</div></li><li><div>      $options[&quot;Attachment&quot;] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $attachment = $options[&quot;Attachment&quot;] ? &quot;attachment&quot; : &quot;inline&quot;;&nbsp;</div></li><li><div>    &nbsp;</div></li><li><div>    // detect the character encoding of the incoming file&nbsp;</div></li><li><div>    $encoding = mb_detect_encoding($fileName);&nbsp;</div></li><li><div>    $fallbackfilename = mb_convert_encoding($fileName, &quot;ISO-8859-1&quot;, $encoding); &nbsp;</div></li><li><div>    $encodedfallbackfilename = rawurlencode($fallbackfilename);&nbsp;</div></li><li><div>    $encodedfilename = rawurlencode($fileName);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    header(&quot;Content-Disposition: $attachment; filename=&quot;. $encodedfallbackfilename .&quot;; filename*=UTF-8''$encodedfilename&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (isset($options['Accept-Ranges']) && $options['Accept-Ranges'] == 1) {&nbsp;</div></li><li><div>      //FIXME: Is this the correct value ... spec says 1#range-unit&nbsp;</div></li><li><div>      header(&quot;Accept-Ranges: &quot; . mb_strlen($tmp, '8bit'));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    echo $tmp;&nbsp;</div></li><li><div>    flush();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * return the height in units of the current font in the given size&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function getFontHeight($size) {&nbsp;</div></li><li><div>    if (!$this-&gt;numFonts) {&nbsp;</div></li><li><div>      $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $font = $this-&gt;fonts[$this-&gt;currentFont];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // for the current font, and the given size, what is the height of the font in user units&nbsp;</div></li><li><div>    if ( isset($font['Ascender']) && isset($font['Descender']) ) {&nbsp;</div></li><li><div>      $h = $font['Ascender']-$font['Descender'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      $h = $font['FontBBox'][3]-$font['FontBBox'][1];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // have to adjust by a font offset for Windows fonts.  unfortunately it looks like&nbsp;</div></li><li><div>    // the bounding box calculations are wrong and I don't know why.&nbsp;</div></li><li><div>    if (isset($font['FontHeightOffset'])) {&nbsp;</div></li><li><div>      // For CourierNew from Windows this needs to be -646 to match the&nbsp;</div></li><li><div>      // Adobe native Courier font.&nbsp;</div></li><li><div>      //&nbsp;</div></li><li><div>      // For FreeMono from GNU this needs to be -337 to match the&nbsp;</div></li><li><div>      // Courier font.&nbsp;</div></li><li><div>      //&nbsp;</div></li><li><div>      // Both have been added manually to the .afm and .ufm files.&nbsp;</div></li><li><div>      $h += (int)$font['FontHeightOffset'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $size*$h/1000;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function getFontXHeight($size) {&nbsp;</div></li><li><div>    if (!$this-&gt;numFonts) {&nbsp;</div></li><li><div>      $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $font = $this-&gt;fonts[$this-&gt;currentFont];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // for the current font, and the given size, what is the height of the font in user units&nbsp;</div></li><li><div>    if ( isset($font['XHeight']) ) {&nbsp;</div></li><li><div>      $xh = $font['Ascender']-$font['Descender'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      $xh = $this-&gt;getFontHeight($size) / 2;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $size*$xh/1000;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * return the font descender, this will normally return a negative number&nbsp;</div></li><li><div>   * if you add this number to the baseline, you get the level of the bottom of the font&nbsp;</div></li><li><div>   * it is in the pdf user units&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function getFontDescender($size) {&nbsp;</div></li><li><div>    // note that this will most likely return a negative value&nbsp;</div></li><li><div>    if (!$this-&gt;numFonts) {&nbsp;</div></li><li><div>      $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //$h = $this-&gt;fonts[$this-&gt;currentFont]['FontBBox'][1];&nbsp;</div></li><li><div>    $h = $this-&gt;fonts[$this-&gt;currentFont]['Descender'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $size*$h/1000;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * filter the text, this is applied to all text just before being inserted into the pdf document&nbsp;</div></li><li><div>   * it escapes the various things that need to be escaped, and so on&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @access private&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function filterText($text, $bom = true, $convert_encoding = true) {&nbsp;</div></li><li><div>    if (!$this-&gt;numFonts) {&nbsp;</div></li><li><div>      $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($convert_encoding) {&nbsp;</div></li><li><div>      $cf = $this-&gt;currentFont;&nbsp;</div></li><li><div>      if (isset($this-&gt;fonts[$cf]) && $this-&gt;fonts[$cf]['isUnicode']) {&nbsp;</div></li><li><div>        //$text = html_entity_decode($text, ENT_QUOTES, 'UTF-8');&nbsp;</div></li><li><div>        $text = $this-&gt;utf8toUtf16BE($text, $bom);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        //$text = html_entity_decode($text, ENT_QUOTES);&nbsp;</div></li><li><div>        $text = mb_convert_encoding($text, self::$targetEncoding, 'UTF-8');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // the chr(13) substitution fixes a bug seen in TCPDF (bug #1421290)&nbsp;</div></li><li><div>    return strtr($text, array(')' =&gt; '\\)', '(' =&gt; '\\(', '\\' =&gt; '\\\\', chr(13) =&gt; '\r'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * return array containing codepoints (UTF-8 character values) for the&nbsp;</div></li><li><div>   * string passed in.&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * based on the excellent TCPDF code by Nicola Asuni and the&nbsp;</div></li><li><div>   * RFC for UTF-8 at http://www.faqs.org/rfcs/rfc3629.html&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @access private&nbsp;</div></li><li><div>   * @author Orion Richardson&nbsp;</div></li><li><div>   * @since January 5, 2008&nbsp;</div></li><li><div>   * @param string $text UTF-8 string to process&nbsp;</div></li><li><div>   * @return array UTF-8 codepoints array for the string&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function utf8toCodePointsArray(&$text) {&nbsp;</div></li><li><div>    $length = mb_strlen($text, '8bit'); // http://www.php.net/manual/en/function.mb-strlen.php#77040&nbsp;</div></li><li><div>    $unicode = array(); // array containing unicode values&nbsp;</div></li><li><div>    $bytes = array(); // array containing single character byte sequences&nbsp;</div></li><li><div>    $numbytes = 1; // number of octetc needed to represent the UTF-8 character&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    for ($i = 0; $i &lt; $length; $i++) {&nbsp;</div></li><li><div>      $c = ord($text[$i]); // get one string character at time&nbsp;</div></li><li><div>      if (count($bytes) === 0) { // get starting octect&nbsp;</div></li><li><div>        if ($c &lt;= 0x7F) {&nbsp;</div></li><li><div>          $unicode[] = $c; // use the character &quot;as is&quot; because is ASCII&nbsp;</div></li><li><div>          $numbytes = 1;&nbsp;</div></li><li><div>        } elseif (($c &gt;&gt; 0x05) === 0x06) { // 2 bytes character (0x06 = 110 BIN)&nbsp;</div></li><li><div>          $bytes[] = ($c - 0xC0) &lt;&lt; 0x06;&nbsp;</div></li><li><div>          $numbytes = 2;&nbsp;</div></li><li><div>        } elseif (($c &gt;&gt; 0x04) === 0x0E) { // 3 bytes character (0x0E = 1110 BIN)&nbsp;</div></li><li><div>          $bytes[] = ($c - 0xE0) &lt;&lt; 0x0C;&nbsp;</div></li><li><div>          $numbytes = 3;&nbsp;</div></li><li><div>        } elseif (($c &gt;&gt; 0x03) === 0x1E) { // 4 bytes character (0x1E = 11110 BIN)&nbsp;</div></li><li><div>          $bytes[] = ($c - 0xF0) &lt;&lt; 0x12;&nbsp;</div></li><li><div>          $numbytes = 4;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>          // use replacement character for other invalid sequences&nbsp;</div></li><li><div>          $unicode[] = 0xFFFD;&nbsp;</div></li><li><div>          $bytes = array();&nbsp;</div></li><li><div>          $numbytes = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      } elseif (($c &gt;&gt; 0x06) === 0x02) { // bytes 2, 3 and 4 must start with 0x02 = 10 BIN&nbsp;</div></li><li><div>        $bytes[] = $c - 0x80;&nbsp;</div></li><li><div>        if (count($bytes) === $numbytes) {&nbsp;</div></li><li><div>          // compose UTF-8 bytes to a single unicode value&nbsp;</div></li><li><div>          $c = $bytes[0];&nbsp;</div></li><li><div>          for ($j = 1; $j &lt; $numbytes; $j++) {&nbsp;</div></li><li><div>            $c += ($bytes[$j] &lt;&lt; (($numbytes - $j - 1) * 0x06));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ((($c &gt;= 0xD800) AND ($c &lt;= 0xDFFF)) OR ($c &gt;= 0x10FFFF)) {&nbsp;</div></li><li><div>            // The definition of UTF-8 prohibits encoding character numbers between&nbsp;</div></li><li><div>            // U+D800 and U+DFFF, which are reserved for use with the UTF-16&nbsp;</div></li><li><div>            // encoding form (as surrogate pairs) and do not directly represent&nbsp;</div></li><li><div>            // characters.&nbsp;</div></li><li><div>            $unicode[] = 0xFFFD; // use replacement character&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>            $unicode[] = $c; // add char to array&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          // reset data for next char&nbsp;</div></li><li><div>          $bytes = array();&nbsp;</div></li><li><div>          $numbytes = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        // use replacement character for other invalid sequences&nbsp;</div></li><li><div>        $unicode[] = 0xFFFD;&nbsp;</div></li><li><div>        $bytes = array();&nbsp;</div></li><li><div>        $numbytes = 1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $unicode;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * convert UTF-8 to UTF-16 with an additional byte order marker&nbsp;</div></li><li><div>   * at the front if required.&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * based on the excellent TCPDF code by Nicola Asuni and the&nbsp;</div></li><li><div>   * RFC for UTF-8 at http://www.faqs.org/rfcs/rfc3629.html&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @access private&nbsp;</div></li><li><div>   * @author Orion Richardson&nbsp;</div></li><li><div>   * @since January 5, 2008&nbsp;</div></li><li><div>   * @param string $text UTF-8 string to process&nbsp;</div></li><li><div>   * @param boolean $bom whether to add the byte order marker&nbsp;</div></li><li><div>   * @return string UTF-16 result string&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function utf8toUtf16BE(&$text, $bom = true) {&nbsp;</div></li><li><div>    $cf = $this-&gt;currentFont;&nbsp;</div></li><li><div>    if (!$this-&gt;fonts[$cf]['isUnicode']) return $text;&nbsp;</div></li><li><div>    $out = $bom ? &quot;\xFE\xFF&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $unicode = $this-&gt;utf8toCodePointsArray($text);&nbsp;</div></li><li><div>    foreach ($unicode as $c) {&nbsp;</div></li><li><div>      if ($c === 0xFFFD) {&nbsp;</div></li><li><div>        $out .= &quot;\xFF\xFD&quot;; // replacement character&nbsp;</div></li><li><div>      } elseif ($c &lt; 0x10000) {&nbsp;</div></li><li><div>        $out .= chr($c &gt;&gt; 0x08) . chr($c & 0xFF);&nbsp;</div></li><li><div>       } else {&nbsp;</div></li><li><div>        $c -= 0x10000;&nbsp;</div></li><li><div>        $w1 = 0xD800 | ($c &gt;&gt; 0x10);&nbsp;</div></li><li><div>        $w2 = 0xDC00 | ($c & 0x3FF);&nbsp;</div></li><li><div>        $out .= chr($w1 &gt;&gt; 0x08) . chr($w1 & 0xFF) . chr($w2 &gt;&gt; 0x08) . chr($w2 & 0xFF);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * given a start position and information about how text is to be laid out, calculate where&nbsp;</div></li><li><div>   * on the page the text will end&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function getTextPosition($x, $y, $angle, $size, $wa, $text) {&nbsp;</div></li><li><div>    // given this information return an array containing x and y for the end position as elements 0 and 1&nbsp;</div></li><li><div>    $w = $this-&gt;getTextWidth($size, $text);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // need to adjust for the number of spaces in this text&nbsp;</div></li><li><div>    $words = explode(' ', $text);&nbsp;</div></li><li><div>    $nspaces = count($words) -1;&nbsp;</div></li><li><div>    $w+= $wa*$nspaces;&nbsp;</div></li><li><div>    $a = deg2rad((float)$angle);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return array(cos($a) *$w+$x, -sin($a) *$w+$y);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Callback method used by smallCaps&nbsp;</div></li><li><div>   * &nbsp;</div></li><li><div>   * @param array $matches&nbsp;</div></li><li><div>   * @return string&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function toUpper($matches) {&nbsp;</div></li><li><div>    return mb_strtoupper($matches[0]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function concatMatches($matches) {&nbsp;</div></li><li><div>    $str = &quot;&quot;;&nbsp;</div></li><li><div>    foreach ($matches as $match) {&nbsp;</div></li><li><div>      $str .= $match[0];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add text to the document, at a specified location, size and angle on the page&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function registerText($font, $text) {&nbsp;</div></li><li><div>    if ( !$this-&gt;isUnicode || in_array(mb_strtolower(basename($font)), self::$coreFonts) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( !isset($this-&gt;stringSubsets[$font]) ) {&nbsp;</div></li><li><div>      $this-&gt;stringSubsets[$font] = array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;stringSubsets[$font] = array_unique(array_merge($this-&gt;stringSubsets[$font], $this-&gt;utf8toCodePointsArray($text)));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add text to the document, at a specified location, size and angle on the page&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addText($x, $y, $size, $text, $angle = 0, $wordSpaceAdjust = 0, $charSpaceAdjust = 0, $smallCaps = false) {&nbsp;</div></li><li><div>    if (!$this-&gt;numFonts) {&nbsp;</div></li><li><div>      $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $text = str_replace(array(&quot;\r&quot;, &quot;\n&quot;), &quot;&quot;, $text);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $smallCaps ) {&nbsp;</div></li><li><div>      preg_match_all(&quot;/(\P{Ll}+)/u&quot;, $text, $matches, PREG_SET_ORDER);&nbsp;</div></li><li><div>      $lower = $this-&gt;concatMatches($matches);&nbsp;</div></li><li><div>      d($lower);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      preg_match_all(&quot;/(\p{Ll}+)/u&quot;, $text, $matches, PREG_SET_ORDER);&nbsp;</div></li><li><div>      $other = $this-&gt;concatMatches($matches);&nbsp;</div></li><li><div>      d($other);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //$text = preg_replace_callback(&quot;/\p{Ll}/u&quot;, array($this, &quot;toUpper&quot;), $text);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // if there are any open callbacks, then they should be called, to show the start of the line&nbsp;</div></li><li><div>    if ($this-&gt;nCallback &gt; 0) {&nbsp;</div></li><li><div>      for ($i = $this-&gt;nCallback; $i &gt; 0; $i--) {&nbsp;</div></li><li><div>        // call each function&nbsp;</div></li><li><div>        $info = array(&nbsp;</div></li><li><div>          'x' =&gt; $x, &nbsp;</div></li><li><div>          'y' =&gt; $y, &nbsp;</div></li><li><div>          'angle' =&gt; $angle, &nbsp;</div></li><li><div>          'status' =&gt; 'sol', &nbsp;</div></li><li><div>          'p' =&gt; $this-&gt;callback[$i]['p'], &nbsp;</div></li><li><div>          'nCallback' =&gt; $this-&gt;callback[$i]['nCallback'], &nbsp;</div></li><li><div>          'height' =&gt; $this-&gt;callback[$i]['height'], &nbsp;</div></li><li><div>          'descender' =&gt; $this-&gt;callback[$i]['descender']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $func = $this-&gt;callback[$i]['f'];&nbsp;</div></li><li><div>        $this-&gt;$func($info);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($angle == 0) {&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot;\nBT %.3F %.3F Td&quot;, $x, $y));&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $a = deg2rad((float)$angle);&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot;\nBT %.3F %.3F %.3F %.3F %.3F %.3F Tm&quot;, cos($a), -sin($a), sin($a), cos($a), $x, $y));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($wordSpaceAdjust != 0 || $wordSpaceAdjust != $this-&gt;wordSpaceAdjust) {&nbsp;</div></li><li><div>      $this-&gt;wordSpaceAdjust = $wordSpaceAdjust;&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot; %.3F Tw&quot;, $wordSpaceAdjust));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($charSpaceAdjust != 0 || $charSpaceAdjust != $this-&gt;charSpaceAdjust) {&nbsp;</div></li><li><div>      $this-&gt;charSpaceAdjust = $charSpaceAdjust;&nbsp;</div></li><li><div>      $this-&gt;addContent(sprintf(&quot; %.3F Tc&quot;, $charSpaceAdjust));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $len = mb_strlen($text);&nbsp;</div></li><li><div>    $start = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($start &lt; $len) {&nbsp;</div></li><li><div>      $part = $text; // OAR - Don't need this anymore, given that $start always equals zero.  substr($text, $start);&nbsp;</div></li><li><div>      $place_text = $this-&gt;filterText($part, false);&nbsp;</div></li><li><div>      // modify unicode text so that extra word spacing is manually implemented (bug #)&nbsp;</div></li><li><div>      $cf = $this-&gt;currentFont;&nbsp;</div></li><li><div>      if ($this-&gt;fonts[$cf]['isUnicode'] && $wordSpaceAdjust != 0) {&nbsp;</div></li><li><div>        $space_scale = 1000 / $size;&nbsp;</div></li><li><div>        //$place_text = str_replace(' ', ') ( ) '.($this-&gt;getTextWidth($size, chr(32), $wordSpaceAdjust)*-75).' (', $place_text);&nbsp;</div></li><li><div>        $place_text = str_replace(' ', ' ) '.(-round($space_scale*$wordSpaceAdjust)).' (', $place_text);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;addContent(&quot; /F$this-&gt;currentFontNum &quot;.sprintf('%.1F Tf ', $size));&nbsp;</div></li><li><div>      $this-&gt;addContent(&quot; [($place_text)] TJ&quot;);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;addContent(' ET');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // if there are any open callbacks, then they should be called, to show the end of the line&nbsp;</div></li><li><div>    if ($this-&gt;nCallback &gt; 0) {&nbsp;</div></li><li><div>      for ($i = $this-&gt;nCallback; $i &gt; 0; $i--) {&nbsp;</div></li><li><div>        // call each function&nbsp;</div></li><li><div>        $tmp = $this-&gt;getTextPosition($x, $y, $angle, $size, $wordSpaceAdjust, $text);&nbsp;</div></li><li><div>        $info = array(&nbsp;</div></li><li><div>          'x' =&gt; $tmp[0], &nbsp;</div></li><li><div>          'y' =&gt; $tmp[1], &nbsp;</div></li><li><div>          'angle' =&gt; $angle, &nbsp;</div></li><li><div>          'status' =&gt; 'eol', &nbsp;</div></li><li><div>          'p' =&gt; $this-&gt;callback[$i]['p'], &nbsp;</div></li><li><div>          'nCallback' =&gt; $this-&gt;callback[$i]['nCallback'], &nbsp;</div></li><li><div>          'height' =&gt; $this-&gt;callback[$i]['height'], &nbsp;</div></li><li><div>          'descender' =&gt; $this-&gt;callback[$i]['descender']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $func = $this-&gt;callback[$i]['f'];&nbsp;</div></li><li><div>        $this-&gt;$func($info);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * calculate how wide a given text string will be on a page, at a given size.&nbsp;</div></li><li><div>   * this can be called externally, but is also used by the other class functions&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function getTextWidth($size, $text, $word_spacing = 0, $char_spacing = 0) {&nbsp;</div></li><li><div>    static $ord_cache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // this function should not change any of the settings, though it will need to&nbsp;</div></li><li><div>    // track any directives which change during calculation, so copy them at the start&nbsp;</div></li><li><div>    // and put them back at the end.&nbsp;</div></li><li><div>    $store_currentTextState = $this-&gt;currentTextState;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!$this-&gt;numFonts) {&nbsp;</div></li><li><div>      $this-&gt;selectFont($this-&gt;defaultFont);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $text = str_replace(array(&quot;\r&quot;, &quot;\n&quot;), &quot;&quot;, $text);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // converts a number or a float to a string so it can get the width&nbsp;</div></li><li><div>    $text = &quot;$text&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // hmm, this is where it all starts to get tricky - use the font information to&nbsp;</div></li><li><div>    // calculate the width of each character, add them up and convert to user units&nbsp;</div></li><li><div>    $w = 0;&nbsp;</div></li><li><div>    $cf = $this-&gt;currentFont;&nbsp;</div></li><li><div>    $current_font = $this-&gt;fonts[$cf];&nbsp;</div></li><li><div>    $space_scale = 1000 / ( $size &gt; 0 ? $size : 1 );&nbsp;</div></li><li><div>    $n_spaces = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $current_font['isUnicode']) {&nbsp;</div></li><li><div>      // for Unicode, use the code points array to calculate width rather&nbsp;</div></li><li><div>      // than just the string itself&nbsp;</div></li><li><div>      $unicode = $this-&gt;utf8toCodePointsArray($text);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($unicode as $char) {&nbsp;</div></li><li><div>        // check if we have to replace character&nbsp;</div></li><li><div>        if ( isset($current_font['differences'][$char])) {&nbsp;</div></li><li><div>          $char = $current_font['differences'][$char];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset($current_font['C'][$char]) ) {&nbsp;</div></li><li><div>          $char_width = $current_font['C'][$char];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // add the character width&nbsp;</div></li><li><div>          $w += $char_width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // add additional padding for space&nbsp;</div></li><li><div>          if ( isset($current_font['codeToName'][$char]) && $current_font['codeToName'][$char] === 'space' ) {  // Space&nbsp;</div></li><li><div>            $w += $word_spacing * $space_scale;&nbsp;</div></li><li><div>            $n_spaces++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // add additionnal char spacing&nbsp;</div></li><li><div>      if ( $char_spacing != 0 ) {&nbsp;</div></li><li><div>        $w += $char_spacing * $space_scale * (count($unicode) + $n_spaces);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      // If CPDF is in Unicode mode but the current font does not support Unicode we need to convert the character set to Windows-1252&nbsp;</div></li><li><div>      if ( $this-&gt;isUnicode ) { &nbsp;</div></li><li><div>        $text = mb_convert_encoding($text, 'Windows-1252', 'UTF-8');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $len = mb_strlen($text, 'Windows-1252');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      for ($i = 0; $i &lt; $len; $i++) {&nbsp;</div></li><li><div>        $c = $text[$i];&nbsp;</div></li><li><div>        $char = isset($ord_cache[$c]) ? $ord_cache[$c] : ($ord_cache[$c] = ord($c));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check if we have to replace character&nbsp;</div></li><li><div>        if ( isset($current_font['differences'][$char])) {&nbsp;</div></li><li><div>          $char = $current_font['differences'][$char];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset($current_font['C'][$char]) ) {&nbsp;</div></li><li><div>          $char_width = $current_font['C'][$char];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // add the character width&nbsp;</div></li><li><div>          $w += $char_width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          // add additional padding for space&nbsp;</div></li><li><div>          if ( isset($current_font['codeToName'][$char]) && $current_font['codeToName'][$char] === 'space' ) {  // Space&nbsp;</div></li><li><div>            $w += $word_spacing * $space_scale;&nbsp;</div></li><li><div>            $n_spaces++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // add additionnal char spacing&nbsp;</div></li><li><div>      if ( $char_spacing != 0 )  {&nbsp;</div></li><li><div>        $w += $char_spacing * $space_scale * ($len + $n_spaces);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;currentTextState = $store_currentTextState;&nbsp;</div></li><li><div>    $this-&gt;setCurrentFont();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $w*$size/1000;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * this will be called at a new page to return the state to what it was on the&nbsp;</div></li><li><div>   * end of the previous page, before the stack was closed down&nbsp;</div></li><li><div>   * This is to get around not being able to have open 'q' across pages&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function saveState($pageEnd = 0) {&nbsp;</div></li><li><div>    if ($pageEnd) {&nbsp;</div></li><li><div>      // this will be called at a new page to return the state to what it was on the&nbsp;</div></li><li><div>      // end of the previous page, before the stack was closed down&nbsp;</div></li><li><div>      // This is to get around not being able to have open 'q' across pages&nbsp;</div></li><li><div>      $opt = $this-&gt;stateStack[$pageEnd];&nbsp;</div></li><li><div>      // ok to use this as stack starts numbering at 1&nbsp;</div></li><li><div>      $this-&gt;setColor($opt['col'], true);&nbsp;</div></li><li><div>      $this-&gt;setStrokeColor($opt['str'], true);&nbsp;</div></li><li><div>      $this-&gt;addContent(&quot;\n&quot;.$opt['lin']);&nbsp;</div></li><li><div>      //    $this-&gt;currentLineStyle = $opt['lin'];&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;nStateStack++;&nbsp;</div></li><li><div>      $this-&gt;stateStack[$this-&gt;nStateStack] = array(&nbsp;</div></li><li><div>        'col' =&gt; $this-&gt;currentColor, &nbsp;</div></li><li><div>        'str' =&gt; $this-&gt;currentStrokeColor, &nbsp;</div></li><li><div>        'lin' =&gt; $this-&gt;currentLineStyle&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;save();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * restore a previously saved state&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function restoreState($pageEnd = 0) {&nbsp;</div></li><li><div>    if (!$pageEnd) {&nbsp;</div></li><li><div>      $n = $this-&gt;nStateStack;&nbsp;</div></li><li><div>      $this-&gt;currentColor =       $this-&gt;stateStack[$n]['col'];&nbsp;</div></li><li><div>      $this-&gt;currentStrokeColor = $this-&gt;stateStack[$n]['str'];&nbsp;</div></li><li><div>      $this-&gt;addContent(&quot;\n&quot;.$this-&gt;stateStack[$n]['lin']);&nbsp;</div></li><li><div>      $this-&gt;currentLineStyle =    $this-&gt;stateStack[$n]['lin'];&nbsp;</div></li><li><div>      $this-&gt;stateStack[$n] = null;&nbsp;</div></li><li><div>      unset($this-&gt;stateStack[$n]);&nbsp;</div></li><li><div>      $this-&gt;nStateStack--;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;restore();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * make a loose object, the output will go into this object, until it is closed, then will revert to&nbsp;</div></li><li><div>   * the current one.&nbsp;</div></li><li><div>   * this object will not appear until it is included within a page.&nbsp;</div></li><li><div>   * the function will return the object number&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function openObject() {&nbsp;</div></li><li><div>    $this-&gt;nStack++;&nbsp;</div></li><li><div>    $this-&gt;stack[$this-&gt;nStack] = array('c' =&gt; $this-&gt;currentContents, 'p' =&gt; $this-&gt;currentPage);&nbsp;</div></li><li><div>    // add a new object of the content type, to hold the data flow&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_contents($this-&gt;numObj, 'new');&nbsp;</div></li><li><div>    $this-&gt;currentContents = $this-&gt;numObj;&nbsp;</div></li><li><div>    $this-&gt;looseObjects[$this-&gt;numObj] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $this-&gt;numObj;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * open an existing object for editing&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function reopenObject($id) {&nbsp;</div></li><li><div>    $this-&gt;nStack++;&nbsp;</div></li><li><div>    $this-&gt;stack[$this-&gt;nStack] = array('c' =&gt; $this-&gt;currentContents, 'p' =&gt; $this-&gt;currentPage);&nbsp;</div></li><li><div>    $this-&gt;currentContents = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // also if this object is the primary contents for a page, then set the current page to its parent&nbsp;</div></li><li><div>    if (isset($this-&gt;objects[$id]['onPage'])) {&nbsp;</div></li><li><div>      $this-&gt;currentPage = $this-&gt;objects[$id]['onPage'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * close an object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function closeObject() {&nbsp;</div></li><li><div>    // close the object, as long as there was one open in the first place, which will be indicated by&nbsp;</div></li><li><div>    // an objectId on the stack.&nbsp;</div></li><li><div>    if ($this-&gt;nStack &gt; 0) {&nbsp;</div></li><li><div>      $this-&gt;currentContents = $this-&gt;stack[$this-&gt;nStack]['c'];&nbsp;</div></li><li><div>      $this-&gt;currentPage = $this-&gt;stack[$this-&gt;nStack]['p'];&nbsp;</div></li><li><div>      $this-&gt;nStack--;&nbsp;</div></li><li><div>      // easier to probably not worry about removing the old entries, they will be overwritten&nbsp;</div></li><li><div>      // if there are new ones.&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * stop an object from appearing on pages from this point on&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function stopObject($id) {&nbsp;</div></li><li><div>    // if an object has been appearing on pages up to now, then stop it, this page will&nbsp;</div></li><li><div>    // be the last one that could contian it.&nbsp;</div></li><li><div>    if (isset($this-&gt;addLooseObjects[$id])) {&nbsp;</div></li><li><div>      $this-&gt;addLooseObjects[$id] = '';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * after an object has been created, it wil only show if it has been added, using this function.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addObject($id, $options = 'add') {&nbsp;</div></li><li><div>    // add the specified object to the page&nbsp;</div></li><li><div>    if (isset($this-&gt;looseObjects[$id]) && $this-&gt;currentContents != $id) {&nbsp;</div></li><li><div>      // then it is a valid object, and it is not being added to itself&nbsp;</div></li><li><div>      switch ($options) {&nbsp;</div></li><li><div>      case 'all':&nbsp;</div></li><li><div>        // then this object is to be added to this page (done in the next block) and&nbsp;</div></li><li><div>        // all future new pages.&nbsp;</div></li><li><div>        $this-&gt;addLooseObjects[$id] = 'all';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'add':&nbsp;</div></li><li><div>        if (isset($this-&gt;objects[$this-&gt;currentContents]['onPage'])) {&nbsp;</div></li><li><div>          // then the destination contents is the primary for the page&nbsp;</div></li><li><div>          // (though this object is actually added to that page)&nbsp;</div></li><li><div>          $this-&gt;o_page($this-&gt;objects[$this-&gt;currentContents]['onPage'], 'content', $id);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'even':&nbsp;</div></li><li><div>        $this-&gt;addLooseObjects[$id] = 'even';&nbsp;</div></li><li><div>        $pageObjectId = $this-&gt;objects[$this-&gt;currentContents]['onPage'];&nbsp;</div></li><li><div>        if ($this-&gt;objects[$pageObjectId]['info']['pageNum']%2 == 0) {&nbsp;</div></li><li><div>          $this-&gt;addObject($id);&nbsp;</div></li><li><div>          // hacky huh :)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'odd':&nbsp;</div></li><li><div>        $this-&gt;addLooseObjects[$id] = 'odd';&nbsp;</div></li><li><div>        $pageObjectId = $this-&gt;objects[$this-&gt;currentContents]['onPage'];&nbsp;</div></li><li><div>        if ($this-&gt;objects[$pageObjectId]['info']['pageNum']%2 == 1) {&nbsp;</div></li><li><div>          $this-&gt;addObject($id);&nbsp;</div></li><li><div>          // hacky huh :)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'next':&nbsp;</div></li><li><div>        $this-&gt;addLooseObjects[$id] = 'all';&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'nexteven':&nbsp;</div></li><li><div>        $this-&gt;addLooseObjects[$id] = 'even';&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case 'nextodd':&nbsp;</div></li><li><div>        $this-&gt;addLooseObjects[$id] = 'odd';&nbsp;</div></li><li><div>        break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * return a storable representation of a specific object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function serializeObject($id) {&nbsp;</div></li><li><div>    if ( array_key_exists($id, $this-&gt;objects)) {&nbsp;</div></li><li><div>      return serialize($this-&gt;objects[$id]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * restore an object from its stored representation.  returns its new object id.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function restoreSerializedObject($obj) {&nbsp;</div></li><li><div>    $obj_id = $this-&gt;openObject();&nbsp;</div></li><li><div>    $this-&gt;objects[$obj_id] = unserialize($obj);&nbsp;</div></li><li><div>    $this-&gt;closeObject();&nbsp;</div></li><li><div>    return $obj_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add content to the documents info object&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addInfo($label, $value = 0) {&nbsp;</div></li><li><div>    // this will only work if the label is one of the valid ones.&nbsp;</div></li><li><div>    // modify this so that arrays can be passed as well.&nbsp;</div></li><li><div>    // if $label is an array then assume that it is key =&gt; value pairs&nbsp;</div></li><li><div>    // else assume that they are both scalar, anything else will probably error&nbsp;</div></li><li><div>    if (is_array($label)) {&nbsp;</div></li><li><div>      foreach ($label as $l =&gt; $v) {&nbsp;</div></li><li><div>        $this-&gt;o_info($this-&gt;infoObject, $l, $v);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;o_info($this-&gt;infoObject, $label, $value);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * set the viewer preferences of the document, it is up to the browser to obey these.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setPreferences($label, $value = 0) {&nbsp;</div></li><li><div>    // this will only work if the label is one of the valid ones.&nbsp;</div></li><li><div>    if (is_array($label)) {&nbsp;</div></li><li><div>      foreach ($label as $l =&gt; $v) {&nbsp;</div></li><li><div>        $this-&gt;o_catalog($this-&gt;catalogId, 'viewerPreferences', array($l =&gt; $v));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      $this-&gt;o_catalog($this-&gt;catalogId, 'viewerPreferences', array($label =&gt; $value));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * extract an integer from a position in a byte stream&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function getBytes(&$data, $pos, $num) {&nbsp;</div></li><li><div>    // return the integer represented by $num bytes from $pos within $data&nbsp;</div></li><li><div>    $ret = 0;&nbsp;</div></li><li><div>    for ($i = 0; $i &lt; $num; $i++) {&nbsp;</div></li><li><div>      $ret *= 256;&nbsp;</div></li><li><div>      $ret += ord($data[$pos+$i]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    return $ret;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Check if image already added to pdf image directory.&nbsp;</div></li><li><div>   * If yes, need not to create again (pass empty data)&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function image_iscached($imgname) {&nbsp;</div></li><li><div>    return isset($this-&gt;imagelist[$imgname]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a PNG image into the document, from a GD object&nbsp;</div></li><li><div>   * this should work with remote files&nbsp;</div></li><li><div>   *&nbsp;</div></li><li><div>   * @param string   $file    The PNG file&nbsp;</div></li><li><div>   * @param float    $x       X position&nbsp;</div></li><li><div>   * @param float    $y       Y position&nbsp;</div></li><li><div>   * @param float    $w       Width&nbsp;</div></li><li><div>   * @param float    $h       Height&nbsp;</div></li><li><div>   * @param resource $img     A GD resource&nbsp;</div></li><li><div>   * @param bool     $is_mask true if the image is a mask&nbsp;</div></li><li><div>   * @param bool     $mask    true if the image is masked&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addImagePng($file, $x, $y, $w = 0.0, $h = 0.0, &$img, $is_mask = false, $mask = null) {&nbsp;</div></li><li><div>    if (!function_exists(&quot;imagepng&quot;)) {&nbsp;</div></li><li><div>      throw new Exception(&quot;The PHP GD extension is required, but is not installed.&quot;);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //if already cached, need not to read again&nbsp;</div></li><li><div>    if ( isset($this-&gt;imagelist[$file]) ) {&nbsp;</div></li><li><div>      $data = null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      // Example for transparency handling on new image. Retain for current image&nbsp;</div></li><li><div>      // $tIndex = imagecolortransparent($img);&nbsp;</div></li><li><div>      // if ($tIndex &gt; 0) {&nbsp;</div></li><li><div>      //   $tColor = imagecolorsforindex($img, $tIndex);&nbsp;</div></li><li><div>      //   $new_tIndex = imagecolorallocate($new_img, $tColor['red'], $tColor['green'], $tColor['blue']);&nbsp;</div></li><li><div>      //   imagefill($new_img, 0, 0, $new_tIndex);&nbsp;</div></li><li><div>      //   imagecolortransparent($new_img, $new_tIndex);&nbsp;</div></li><li><div>      // }&nbsp;</div></li><li><div>      // blending mode (literal/blending) on drawing into current image. not relevant when not saved or not drawn&nbsp;</div></li><li><div>      //imagealphablending($img, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //default, but explicitely set to ensure pdf compatibility&nbsp;</div></li><li><div>      imagesavealpha($img, false/**!$is_mask && !$mask*/);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = 0;&nbsp;</div></li><li><div>      //DEBUG_IMG_TEMP&nbsp;</div></li><li><div>      //debugpng&nbsp;</div></li><li><div>      if (DEBUGPNG) print '[addImagePng '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      @imagepng($img);&nbsp;</div></li><li><div>      $data = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($data == '') {&nbsp;</div></li><li><div>        $error = 1;&nbsp;</div></li><li><div>        $errormsg = 'trouble writing file from GD';&nbsp;</div></li><li><div>        //DEBUG_IMG_TEMP&nbsp;</div></li><li><div>        //debugpng&nbsp;</div></li><li><div>        if (DEBUGPNG) print 'trouble writing file from GD';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($error) {&nbsp;</div></li><li><div>        $this-&gt;addMessage('PNG error - ('.$file.') '.$errormsg);&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }  //End isset($this-&gt;imagelist[$file]) (png Duplicate removal)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;addPngFromBuf($file, $x, $y, $w, $h, $data, $is_mask, $mask);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function addImagePngAlpha($file, $x, $y, $w, $h, $byte) {&nbsp;</div></li><li><div>    // generate images&nbsp;</div></li><li><div>    $img = imagecreatefrompng($file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($img === false) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // FIXME The pixel transformation doesn't work well with 8bit PNGs&nbsp;</div></li><li><div>    $eight_bit = ($byte & 4) !== 4;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $wpx = imagesx($img);&nbsp;</div></li><li><div>    $hpx = imagesy($img);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    imagesavealpha($img, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // create temp alpha file&nbsp;</div></li><li><div>    $tempfile_alpha = tempnam($this-&gt;tmp, &quot;cpdf_img_&quot;);&nbsp;</div></li><li><div>    @unlink($tempfile_alpha);&nbsp;</div></li><li><div>    $tempfile_alpha = &quot;$tempfile_alpha.png&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // create temp plain file&nbsp;</div></li><li><div>    $tempfile_plain = tempnam($this-&gt;tmp, &quot;cpdf_img_&quot;);&nbsp;</div></li><li><div>    @unlink($tempfile_plain);&nbsp;</div></li><li><div>    $tempfile_plain = &quot;$tempfile_plain.png&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $imgalpha = imagecreate($wpx, $hpx);&nbsp;</div></li><li><div>    imagesavealpha($imgalpha, false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // generate gray scale palette (0 -&gt; 255)&nbsp;</div></li><li><div>    for ($c = 0; $c &lt; 256; ++$c) {&nbsp;</div></li><li><div>      imagecolorallocate($imgalpha, $c, $c, $c);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Use PECL gmagick + Graphics Magic to process transparent PNG images&nbsp;</div></li><li><div>    if (extension_loaded(&quot;gmagick&quot;)) {&nbsp;</div></li><li><div>      $gmagick = new Gmagick($file);&nbsp;</div></li><li><div>      $gmagick-&gt;setimageformat('png');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Get opacity channel (negative of alpha channel)&nbsp;</div></li><li><div>      $alpha_channel_neg = clone $gmagick;&nbsp;</div></li><li><div>      $alpha_channel_neg-&gt;separateimagechannel(Gmagick::CHANNEL_OPACITY);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Negate opacity channel&nbsp;</div></li><li><div>      $alpha_channel = new Gmagick();&nbsp;</div></li><li><div>      $alpha_channel-&gt;newimage($wpx, $hpx, &quot;#FFFFFF&quot;, &quot;png&quot;);&nbsp;</div></li><li><div>      $alpha_channel-&gt;compositeimage($alpha_channel_neg, Gmagick::COMPOSITE_DIFFERENCE, 0, 0);&nbsp;</div></li><li><div>      $alpha_channel-&gt;separateimagechannel(Gmagick::CHANNEL_RED);&nbsp;</div></li><li><div>      $alpha_channel-&gt;writeimage($tempfile_alpha);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Cast to 8bit+palette&nbsp;</div></li><li><div>      $imgalpha_ = imagecreatefrompng($tempfile_alpha);&nbsp;</div></li><li><div>      imagecopy($imgalpha, $imgalpha_, 0, 0, 0, 0, $wpx, $hpx);&nbsp;</div></li><li><div>      imagedestroy($imgalpha_);&nbsp;</div></li><li><div>      imagepng($imgalpha, $tempfile_alpha);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Make opaque image&nbsp;</div></li><li><div>      $color_channels = new Gmagick();&nbsp;</div></li><li><div>      $color_channels-&gt;newimage($wpx, $hpx, &quot;#FFFFFF&quot;, &quot;png&quot;);&nbsp;</div></li><li><div>      $color_channels-&gt;compositeimage($gmagick, Gmagick::COMPOSITE_COPYRED, 0, 0);&nbsp;</div></li><li><div>      $color_channels-&gt;compositeimage($gmagick, Gmagick::COMPOSITE_COPYGREEN, 0, 0);&nbsp;</div></li><li><div>      $color_channels-&gt;compositeimage($gmagick, Gmagick::COMPOSITE_COPYBLUE, 0, 0);&nbsp;</div></li><li><div>      $color_channels-&gt;writeimage($tempfile_plain);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $imgplain = imagecreatefrompng($tempfile_plain);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Use PECL imagick + ImageMagic to process transparent PNG images&nbsp;</div></li><li><div>    elseif (extension_loaded(&quot;imagick&quot;)) {&nbsp;</div></li><li><div>      // Native cloning was added to pecl-imagick in svn commit 263814&nbsp;</div></li><li><div>      // the first version containing it was 3.0.1RC1&nbsp;</div></li><li><div>      static $imagickClonable = null;&nbsp;</div></li><li><div>      if($imagickClonable === null) {&nbsp;</div></li><li><div>        $imagickClonable = version_compare(phpversion('imagick'), '3.0.1rc1') &gt; 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $imagick = new Imagick($file);&nbsp;</div></li><li><div>      $imagick-&gt;setFormat('png');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Get opacity channel (negative of alpha channel)&nbsp;</div></li><li><div>      $alpha_channel = $imagickClonable ? clone $imagick : $imagick-&gt;clone();&nbsp;</div></li><li><div>      $alpha_channel-&gt;separateImageChannel(Imagick::CHANNEL_ALPHA);&nbsp;</div></li><li><div>      $alpha_channel-&gt;negateImage(true);&nbsp;</div></li><li><div>      $alpha_channel-&gt;writeImage($tempfile_alpha);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Cast to 8bit+palette&nbsp;</div></li><li><div>      $imgalpha_ = imagecreatefrompng($tempfile_alpha);&nbsp;</div></li><li><div>      imagecopy($imgalpha, $imgalpha_, 0, 0, 0, 0, $wpx, $hpx);&nbsp;</div></li><li><div>      imagedestroy($imgalpha_);&nbsp;</div></li><li><div>      imagepng($imgalpha, $tempfile_alpha);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // Make opaque image&nbsp;</div></li><li><div>      $color_channels = new Imagick();&nbsp;</div></li><li><div>      $color_channels-&gt;newImage($wpx, $hpx, &quot;#FFFFFF&quot;, &quot;png&quot;);&nbsp;</div></li><li><div>      $color_channels-&gt;compositeImage($imagick, Imagick::COMPOSITE_COPYRED, 0, 0);&nbsp;</div></li><li><div>      $color_channels-&gt;compositeImage($imagick, Imagick::COMPOSITE_COPYGREEN, 0, 0);&nbsp;</div></li><li><div>      $color_channels-&gt;compositeImage($imagick, Imagick::COMPOSITE_COPYBLUE, 0, 0);&nbsp;</div></li><li><div>      $color_channels-&gt;writeImage($tempfile_plain);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $imgplain = imagecreatefrompng($tempfile_plain);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      // allocated colors cache&nbsp;</div></li><li><div>      $allocated_colors = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // extract alpha channel&nbsp;</div></li><li><div>      for ($xpx = 0; $xpx &lt; $wpx; ++$xpx) {&nbsp;</div></li><li><div>        for ($ypx = 0; $ypx &lt; $hpx; ++$ypx) {&nbsp;</div></li><li><div>          $color = imagecolorat($img, $xpx, $ypx);&nbsp;</div></li><li><div>          $col = imagecolorsforindex($img, $color);&nbsp;</div></li><li><div>          $alpha = $col['alpha'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($eight_bit) {&nbsp;</div></li><li><div>            // with gamma correction&nbsp;</div></li><li><div>            $gammacorr = 2.2;&nbsp;</div></li><li><div>            $pixel = pow((((127 - $alpha) * 255 / 127) / 255), $gammacorr) * 255;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>            // without gamma correction&nbsp;</div></li><li><div>            $pixel = (127 - $alpha) * 2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $key = $col['red'].$col['green'].$col['blue'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!isset($allocated_colors[$key])) {&nbsp;</div></li><li><div>              $pixel_img = imagecolorallocate($img, $col['red'], $col['green'], $col['blue']);&nbsp;</div></li><li><div>              $allocated_colors[$key] = $pixel_img;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            else {&nbsp;</div></li><li><div>              $pixel_img = $allocated_colors[$key]; &nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            imagesetpixel($img, $xpx, $ypx, $pixel_img);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          imagesetpixel($imgalpha, $xpx, $ypx, $pixel);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // extract image without alpha channel&nbsp;</div></li><li><div>      $imgplain = imagecreatetruecolor($wpx, $hpx);&nbsp;</div></li><li><div>      imagecopy($imgplain, $img, 0, 0, 0, 0, $wpx, $hpx);&nbsp;</div></li><li><div>      imagedestroy($img);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      imagepng($imgalpha, $tempfile_alpha);&nbsp;</div></li><li><div>      imagepng($imgplain, $tempfile_plain);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // embed mask image&nbsp;</div></li><li><div>    $this-&gt;addImagePng($tempfile_alpha, $x, $y, $w, $h, $imgalpha, true);&nbsp;</div></li><li><div>    imagedestroy($imgalpha);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // embed image, masked with previously embedded mask&nbsp;</div></li><li><div>    $this-&gt;addImagePng($tempfile_plain, $x, $y, $w, $h, $imgplain, false, true);&nbsp;</div></li><li><div>    imagedestroy($imgplain);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // remove temp files&nbsp;</div></li><li><div>    unlink($tempfile_alpha);&nbsp;</div></li><li><div>    unlink($tempfile_plain);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a PNG image into the document, from a file&nbsp;</div></li><li><div>   * this should work with remote files&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addPngFromFile($file, $x, $y, $w = 0, $h = 0) {&nbsp;</div></li><li><div>    if (!function_exists(&quot;imagecreatefrompng&quot;)) {&nbsp;</div></li><li><div>      throw new Exception(&quot;The PHP GD extension is required, but is not installed.&quot;);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //if already cached, need not to read again&nbsp;</div></li><li><div>    if ( isset($this-&gt;imagelist[$file]) ) {&nbsp;</div></li><li><div>      $img = null;&nbsp;</div></li><li><div>    } &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      $info = file_get_contents ($file, false, null, 24, 5);&nbsp;</div></li><li><div>      $meta = unpack(&quot;CbitDepth/CcolorType/CcompressionMethod/CfilterMethod/CinterlaceMethod&quot;, $info);&nbsp;</div></li><li><div>      $bit_depth = $meta[&quot;bitDepth&quot;];&nbsp;</div></li><li><div>      $color_type = $meta[&quot;colorType&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // http://www.w3.org/TR/PNG/#11IHDR&nbsp;</div></li><li><div>      // 3 =&gt; indexed&nbsp;</div></li><li><div>      // 4 =&gt; greyscale with alpha&nbsp;</div></li><li><div>      // 6 =&gt; fullcolor with alpha&nbsp;</div></li><li><div>      $is_alpha = in_array($color_type, array(4, 6)) || ($color_type == 3 && $bit_depth != 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($is_alpha) { // exclude grayscale alpha&nbsp;</div></li><li><div>        return $this-&gt;addImagePngAlpha($file, $x, $y, $w, $h, $color_type);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //png files typically contain an alpha channel.&nbsp;</div></li><li><div>      //pdf file format or class.pdf does not support alpha blending.&nbsp;</div></li><li><div>      //on alpha blended images, more transparent areas have a color near black.&nbsp;</div></li><li><div>      //This appears in the result on not storing the alpha channel.&nbsp;</div></li><li><div>      //Correct would be the box background image or its parent when transparent.&nbsp;</div></li><li><div>      //But this would make the image dependent on the background.&nbsp;</div></li><li><div>      //Therefore create an image with white background and copy in&nbsp;</div></li><li><div>      //A more natural background than black is white.&nbsp;</div></li><li><div>      //Therefore create an empty image with white background and merge the&nbsp;</div></li><li><div>      //image in with alpha blending.&nbsp;</div></li><li><div>      $imgtmp = @imagecreatefrompng($file);&nbsp;</div></li><li><div>      if (!$imgtmp) {&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $sx = imagesx($imgtmp);&nbsp;</div></li><li><div>      $sy = imagesy($imgtmp);&nbsp;</div></li><li><div>      $img = imagecreatetruecolor($sx, $sy);&nbsp;</div></li><li><div>      imagealphablending($img, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // @todo is it still needed ??&nbsp;</div></li><li><div>      $ti = imagecolortransparent($imgtmp);&nbsp;</div></li><li><div>      if ($ti &gt;= 0) {&nbsp;</div></li><li><div>        $tc = imagecolorsforindex($imgtmp, $ti);&nbsp;</div></li><li><div>        $ti = imagecolorallocate($img, $tc['red'], $tc['green'], $tc['blue']);&nbsp;</div></li><li><div>        imagefill($img, 0, 0, $ti);&nbsp;</div></li><li><div>        imagecolortransparent($img, $ti);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        imagefill($img, 1, 1, imagecolorallocate($img, 255, 255, 255));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      imagecopy($img, $imgtmp, 0, 0, 0, 0, $sx, $sy);&nbsp;</div></li><li><div>      imagedestroy($imgtmp);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    $this-&gt;addImagePng($file, $x, $y, $w, $h, $img);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $img ) {&nbsp;</div></li><li><div>      imagedestroy($img);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a PNG image into the document, from a memory buffer of the file&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addPngFromBuf($file, $x, $y, $w = 0.0, $h = 0.0, &$data, $is_mask = false, $mask = null) {&nbsp;</div></li><li><div>    if ( isset($this-&gt;imagelist[$file]) ) {&nbsp;</div></li><li><div>      $data = null;&nbsp;</div></li><li><div>      $info['width'] = $this-&gt;imagelist[$file]['w'];&nbsp;</div></li><li><div>      $info['height'] = $this-&gt;imagelist[$file]['h'];&nbsp;</div></li><li><div>      $label = $this-&gt;imagelist[$file]['label'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      if ($data == null) {&nbsp;</div></li><li><div>        $this-&gt;addMessage('addPngFromBuf error - data not present!');&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$error) {&nbsp;</div></li><li><div>        $header = chr(137) .chr(80) .chr(78) .chr(71) .chr(13) .chr(10) .chr(26) .chr(10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (mb_substr($data, 0, 8, '8bit') != $header) {&nbsp;</div></li><li><div>          $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (DEBUGPNG) print '[addPngFromFile this file does not have a valid header '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $errormsg = 'this file does not have a valid header';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$error) {&nbsp;</div></li><li><div>        // set pointer&nbsp;</div></li><li><div>        $p = 8;&nbsp;</div></li><li><div>        $len = mb_strlen($data, '8bit');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // cycle through the file, identifying chunks&nbsp;</div></li><li><div>        $haveHeader = 0;&nbsp;</div></li><li><div>        $info = array();&nbsp;</div></li><li><div>        $idata = '';&nbsp;</div></li><li><div>        $pdata = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        while ($p &lt; $len) {&nbsp;</div></li><li><div>          $chunkLen = $this-&gt;getBytes($data, $p, 4);&nbsp;</div></li><li><div>          $chunkType = mb_substr($data, $p+4, 4, '8bit');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ($chunkType) {&nbsp;</div></li><li><div>          case 'IHDR':&nbsp;</div></li><li><div>            // this is where all the file information comes from&nbsp;</div></li><li><div>            $info['width'] = $this-&gt;getBytes($data, $p+8, 4);&nbsp;</div></li><li><div>            $info['height'] = $this-&gt;getBytes($data, $p+12, 4);&nbsp;</div></li><li><div>            $info['bitDepth'] = ord($data[$p+16]);&nbsp;</div></li><li><div>            $info['colorType'] = ord($data[$p+17]);&nbsp;</div></li><li><div>            $info['compressionMethod'] = ord($data[$p+18]);&nbsp;</div></li><li><div>            $info['filterMethod'] = ord($data[$p+19]);&nbsp;</div></li><li><div>            $info['interlaceMethod'] = ord($data[$p+20]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //print_r($info);&nbsp;</div></li><li><div>            $haveHeader = 1;&nbsp;</div></li><li><div>            if ($info['compressionMethod'] != 0) {&nbsp;</div></li><li><div>              $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              //debugpng&nbsp;</div></li><li><div>              if (DEBUGPNG) print '[addPngFromFile unsupported compression method '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $errormsg = 'unsupported compression method';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($info['filterMethod'] != 0) {&nbsp;</div></li><li><div>              $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              //debugpng&nbsp;</div></li><li><div>              if (DEBUGPNG) print '[addPngFromFile unsupported filter method '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $errormsg = 'unsupported filter method';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'PLTE':&nbsp;</div></li><li><div>            $pdata.= mb_substr($data, $p+8, $chunkLen, '8bit');&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'IDAT':&nbsp;</div></li><li><div>            $idata.= mb_substr($data, $p+8, $chunkLen, '8bit');&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'tRNS':&nbsp;</div></li><li><div>            //this chunk can only occur once and it must occur after the PLTE chunk and before IDAT chunk&nbsp;</div></li><li><div>            //print &quot;tRNS found, color type = &quot;.$info['colorType'].&quot;\n&quot;;&nbsp;</div></li><li><div>            $transparency = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ($info['colorType']) {&nbsp;</div></li><li><div>              // indexed color, rbg&nbsp;</div></li><li><div>              case 3:&nbsp;</div></li><li><div>                /** corresponding to entries in the plte chunk&nbsp;</div></li><li><div>                 Alpha for palette index 0: 1 byte&nbsp;</div></li><li><div>                 Alpha for palette index 1: 1 byte&nbsp;</div></li><li><div>                 ...etc...&nbsp;</div></li><li><div>                */&nbsp;</div></li><li><div>                // there will be one entry for each palette entry. up until the last non-opaque entry.&nbsp;</div></li><li><div>                // set up an array, stretching over all palette entries which will be o (opaque) or 1 (transparent)&nbsp;</div></li><li><div>                $transparency['type'] = 'indexed';&nbsp;</div></li><li><div>                $trans = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                for ($i = $chunkLen; $i &gt;= 0; $i--) {&nbsp;</div></li><li><div>                  if (ord($data[$p+8+$i]) == 0) {&nbsp;</div></li><li><div>                    $trans = $i;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $transparency['data'] = $trans;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              // grayscale&nbsp;</div></li><li><div>              case 0:&nbsp;</div></li><li><div>                /** corresponding to entries in the plte chunk&nbsp;</div></li><li><div>                 Gray: 2 bytes, range 0 .. (2^bitdepth)-1&nbsp;</div></li><li><div>                */&nbsp;</div></li><li><div>                //            $transparency['grayscale'] = $this-&gt;PRVT_getBytes($data, $p+8, 2); // g = grayscale&nbsp;</div></li><li><div>                $transparency['type'] = 'indexed';&nbsp;</div></li><li><div>                $transparency['data'] = ord($data[$p+8+1]);&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              // truecolor&nbsp;</div></li><li><div>              case 2:      &nbsp;</div></li><li><div>                /** corresponding to entries in the plte chunk&nbsp;</div></li><li><div>                 Red: 2 bytes, range 0 .. (2^bitdepth)-1&nbsp;</div></li><li><div>                 Green: 2 bytes, range 0 .. (2^bitdepth)-1&nbsp;</div></li><li><div>                 Blue: 2 bytes, range 0 .. (2^bitdepth)-1&nbsp;</div></li><li><div>                */&nbsp;</div></li><li><div>                $transparency['r'] = $this-&gt;getBytes($data, $p+8, 2);&nbsp;</div></li><li><div>                // r from truecolor&nbsp;</div></li><li><div>                $transparency['g'] = $this-&gt;getBytes($data, $p+10, 2);&nbsp;</div></li><li><div>                // g from truecolor&nbsp;</div></li><li><div>                $transparency['b'] = $this-&gt;getBytes($data, $p+12, 2);&nbsp;</div></li><li><div>                // b from truecolor&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $transparency['type'] = 'color-key';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              //unsupported transparency type&nbsp;</div></li><li><div>              default:&nbsp;</div></li><li><div>                if (DEBUGPNG) print '[addPngFromFile unsupported transparency type '.$file.']';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // KS End new code&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $p += $chunkLen+12;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$haveHeader) {&nbsp;</div></li><li><div>          $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          //debugpng&nbsp;</div></li><li><div>          if (DEBUGPNG) print '[addPngFromFile information header is missing '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $errormsg = 'information header is missing';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (isset($info['interlaceMethod']) && $info['interlaceMethod']) {&nbsp;</div></li><li><div>          $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          //debugpng&nbsp;</div></li><li><div>          if (DEBUGPNG) print '[addPngFromFile no support for interlaced images in pdf '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $errormsg = 'There appears to be no support for interlaced images in pdf.';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$error && $info['bitDepth'] &gt; 8) {&nbsp;</div></li><li><div>        $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //debugpng&nbsp;</div></li><li><div>        if (DEBUGPNG) print '[addPngFromFile bit depth of 8 or less is supported '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $errormsg = 'only bit depth of 8 or less is supported';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  &nbsp;</div></li><li><div>      if (!$error) {&nbsp;</div></li><li><div>        switch ($info['colorType']) {&nbsp;</div></li><li><div>        case 3:&nbsp;</div></li><li><div>          $color = 'DeviceRGB';&nbsp;</div></li><li><div>          $ncolor = 1;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 2:&nbsp;</div></li><li><div>          $color = 'DeviceRGB';&nbsp;</div></li><li><div>          $ncolor = 3;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        case 0:&nbsp;</div></li><li><div>          $color = 'DeviceGray';&nbsp;</div></li><li><div>          $ncolor = 1;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        default: &nbsp;</div></li><li><div>          $error = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          //debugpng&nbsp;</div></li><li><div>          if (DEBUGPNG) print '[addPngFromFile alpha channel not supported: '.$info['colorType'].' '.$file.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $errormsg = 'transparancey alpha channel not supported, transparency only supported for palette images.';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($error) {&nbsp;</div></li><li><div>        $this-&gt;addMessage('PNG error - ('.$file.') '.$errormsg);&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //print_r($info);&nbsp;</div></li><li><div>      // so this image is ok... add it in.&nbsp;</div></li><li><div>      $this-&gt;numImages++;&nbsp;</div></li><li><div>      $im = $this-&gt;numImages;&nbsp;</div></li><li><div>      $label = &quot;I$im&quot;;&nbsp;</div></li><li><div>      $this-&gt;numObj++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      //  $this-&gt;o_image($this-&gt;numObj, 'new', array('label' =&gt; $label, 'data' =&gt; $idata, 'iw' =&gt; $w, 'ih' =&gt; $h, 'type' =&gt; 'png', 'ic' =&gt; $info['width']));&nbsp;</div></li><li><div>      $options = array(&nbsp;</div></li><li><div>        'label' =&gt; $label, &nbsp;</div></li><li><div>        'data' =&gt; $idata, &nbsp;</div></li><li><div>        'bitsPerComponent' =&gt; $info['bitDepth'], &nbsp;</div></li><li><div>        'pdata' =&gt; $pdata, &nbsp;</div></li><li><div>        'iw' =&gt; $info['width'], &nbsp;</div></li><li><div>        'ih' =&gt; $info['height'], &nbsp;</div></li><li><div>        'type' =&gt; 'png', &nbsp;</div></li><li><div>        'color' =&gt; $color, &nbsp;</div></li><li><div>        'ncolor' =&gt; $ncolor, &nbsp;</div></li><li><div>        'masked' =&gt; $mask, &nbsp;</div></li><li><div>        'isMask' =&gt; $is_mask&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($transparency)) {&nbsp;</div></li><li><div>        $options['transparency'] = $transparency;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;o_image($this-&gt;numObj, 'new', $options);&nbsp;</div></li><li><div>      $this-&gt;imagelist[$file] = array('label' =&gt;$label, 'w' =&gt; $info['width'], 'h' =&gt; $info['height']);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($is_mask) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($w &lt;= 0 && $h &lt;= 0) {&nbsp;</div></li><li><div>      $w = $info['width'];&nbsp;</div></li><li><div>      $h = $info['height'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($w &lt;= 0) {&nbsp;</div></li><li><div>      $w = $h/$info['height']*$info['width'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($h &lt;= 0) {&nbsp;</div></li><li><div>      $h = $w*$info['height']/$info['width'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\nq\n%.3F 0 0 %.3F %.3F %.3F cm /%s Do\nQ&quot;, $w, $h, $x, $y, $label));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * add a JPEG image into the document, from a file&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addJpegFromFile($img, $x, $y, $w = 0, $h = 0) {&nbsp;</div></li><li><div>    // attempt to add a jpeg image straight from a file, using no GD commands&nbsp;</div></li><li><div>    // note that this function is unable to operate on a remote file.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if (!file_exists($img)) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ( $this-&gt;image_iscached($img) ) {&nbsp;</div></li><li><div>      $data = null;&nbsp;</div></li><li><div>      $imageWidth = $this-&gt;imagelist[$img]['w'];&nbsp;</div></li><li><div>      $imageHeight = $this-&gt;imagelist[$img]['h'];&nbsp;</div></li><li><div>      $channels = $this-&gt;imagelist[$img]['c'];&nbsp;</div></li><li><div>    } &nbsp;</div></li><li><div>    else {&nbsp;</div></li><li><div>      $tmp = getimagesize($img);&nbsp;</div></li><li><div>      $imageWidth = $tmp[0];&nbsp;</div></li><li><div>      $imageHeight = $tmp[1];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($tmp['channels']) ) {&nbsp;</div></li><li><div>        $channels = $tmp['channels'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $channels = 3;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = file_get_contents($img);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($w &lt;= 0 && $h &lt;= 0) {&nbsp;</div></li><li><div>      $w = $imageWidth;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($w == 0) {&nbsp;</div></li><li><div>      $w = $h/$imageHeight*$imageWidth;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    if ($h == 0) {&nbsp;</div></li><li><div>      $h = $w*$imageHeight/$imageWidth;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;addJpegImage_common($data, $x, $y, $w, $h, $imageWidth, $imageHeight, $channels, $img);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * common code used by the two JPEG adding functions&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  private function addJpegImage_common(&$data, $x, $y, $w = 0, $h = 0, $imageWidth, $imageHeight, $channels = 3, $imgname) {&nbsp;</div></li><li><div>    if ( $this-&gt;image_iscached($imgname) ) {&nbsp;</div></li><li><div>      $label = $this-&gt;imagelist[$imgname]['label'];&nbsp;</div></li><li><div>      //debugpng&nbsp;</div></li><li><div>      //if (DEBUGPNG) print '[addJpegImage_common Duplicate '.$imgname.']';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>      if ($data == null) {&nbsp;</div></li><li><div>        $this-&gt;addMessage('addJpegImage_common error - ('.$imgname.') data not present!');&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // note that this function is not to be called externally&nbsp;</div></li><li><div>      // it is just the common code between the GD and the file options&nbsp;</div></li><li><div>      $this-&gt;numImages++;&nbsp;</div></li><li><div>      $im = $this-&gt;numImages;&nbsp;</div></li><li><div>      $label = &quot;I$im&quot;;&nbsp;</div></li><li><div>      $this-&gt;numObj++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;o_image($this-&gt;numObj, 'new', array(&nbsp;</div></li><li><div>        'label' =&gt; $label, &nbsp;</div></li><li><div>        'data' =&gt; &$data, &nbsp;</div></li><li><div>        'iw' =&gt; $imageWidth, &nbsp;</div></li><li><div>        'ih' =&gt; $imageHeight, &nbsp;</div></li><li><div>        'channels' =&gt; $channels&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;imagelist[$imgname] = array('label' =&gt;$label, 'w' =&gt; $imageWidth, 'h' =&gt; $imageHeight, 'c'=&gt; $channels);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    $this-&gt;addContent(sprintf(&quot;\nq\n%.3F 0 0 %.3F %.3F %.3F cm /%s Do\nQ &quot;, $w, $h, $x, $y, $label));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * specify where the document should open when it first starts&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function openHere($style, $a = 0, $b = 0, $c = 0) {&nbsp;</div></li><li><div>    // this function will open the document at a specified page, in a specified style&nbsp;</div></li><li><div>    // the values for style, and the required paramters are:&nbsp;</div></li><li><div>    // 'XYZ'  left, top, zoom&nbsp;</div></li><li><div>    // 'Fit'&nbsp;</div></li><li><div>    // 'FitH' top&nbsp;</div></li><li><div>    // 'FitV' left&nbsp;</div></li><li><div>    // 'FitR' left, bottom, right&nbsp;</div></li><li><div>    // 'FitB'&nbsp;</div></li><li><div>    // 'FitBH' top&nbsp;</div></li><li><div>    // 'FitBV' left&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_destination($this-&gt;numObj, 'new', array('page' =&gt; $this-&gt;currentPage, 'type' =&gt; $style, 'p1' =&gt; $a, 'p2' =&gt; $b, 'p3' =&gt; $c));&nbsp;</div></li><li><div>    $id = $this-&gt;catalogId;&nbsp;</div></li><li><div>    $this-&gt;o_catalog($id, 'openHere', $this-&gt;numObj);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * Add JavaScript code to the PDF document&nbsp;</div></li><li><div>   * &nbsp;</div></li><li><div>   * @param string $code&nbsp;</div></li><li><div>   * @return void&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addJavascript($code) {&nbsp;</div></li><li><div>    $this-&gt;javascript .= $code;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * create a labelled destination within the document&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addDestination($label, $style, $a = 0, $b = 0, $c = 0) {&nbsp;</div></li><li><div>    // associates the given label with the destination, it is done this way so that a destination can be specified after&nbsp;</div></li><li><div>    // it has been linked to&nbsp;</div></li><li><div>    // styles are the same as the 'openHere' function&nbsp;</div></li><li><div>    $this-&gt;numObj++;&nbsp;</div></li><li><div>    $this-&gt;o_destination($this-&gt;numObj, 'new', array('page' =&gt; $this-&gt;currentPage, 'type' =&gt; $style, 'p1' =&gt; $a, 'p2' =&gt; $b, 'p3' =&gt; $c));&nbsp;</div></li><li><div>    $id = $this-&gt;numObj;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // store the label-&gt;idf relationship, note that this means that labels can be used only once&nbsp;</div></li><li><div>    $this-&gt;destinations[&quot;$label&quot;] = $id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * define font families, this is used to initialize the font families for the default fonts&nbsp;</div></li><li><div>   * and for the user to add new ones for their fonts. The default bahavious can be overridden should&nbsp;</div></li><li><div>   * that be desired.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function setFontFamily($family, $options = '') {&nbsp;</div></li><li><div>    if (!is_array($options)) {&nbsp;</div></li><li><div>      if ($family === 'init') {&nbsp;</div></li><li><div>        // set the known family groups&nbsp;</div></li><li><div>        // these font families will be used to enable bold and italic markers to be included&nbsp;</div></li><li><div>        // within text streams. html forms will be used... &lt;b&gt;&lt;/b&gt; &lt;i&gt;&lt;/i&gt;&nbsp;</div></li><li><div>        $this-&gt;fontFamilies['Helvetica.afm'] =&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>            'b' =&gt; 'Helvetica-Bold.afm', &nbsp;</div></li><li><div>            'i' =&gt; 'Helvetica-Oblique.afm', &nbsp;</div></li><li><div>            'bi' =&gt; 'Helvetica-BoldOblique.afm', &nbsp;</div></li><li><div>            'ib' =&gt; 'Helvetica-BoldOblique.afm'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;fontFamilies['Courier.afm'] =&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>            'b' =&gt; 'Courier-Bold.afm', &nbsp;</div></li><li><div>            'i' =&gt; 'Courier-Oblique.afm', &nbsp;</div></li><li><div>            'bi' =&gt; 'Courier-BoldOblique.afm', &nbsp;</div></li><li><div>            'ib' =&gt; 'Courier-BoldOblique.afm'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;fontFamilies['Times-Roman.afm'] =&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>            'b' =&gt; 'Times-Bold.afm', &nbsp;</div></li><li><div>            'i' =&gt; 'Times-Italic.afm', &nbsp;</div></li><li><div>            'bi' =&gt; 'Times-BoldItalic.afm', &nbsp;</div></li><li><div>            'ib' =&gt; 'Times-BoldItalic.afm'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      // the user is trying to set a font family&nbsp;</div></li><li><div>      // note that this can also be used to set the base ones to something else&nbsp;</div></li><li><div>      if (mb_strlen($family)) {&nbsp;</div></li><li><div>        $this-&gt;fontFamilies[$family] = $options;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * used to add messages for use in debugging&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function addMessage($message) {&nbsp;</div></li><li><div>    $this-&gt;messages.=  $message.&quot;\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  /**&nbsp;</div></li><li><div>   * a few functions which should allow the document to be treated transactionally.&nbsp;</div></li><li><div>   */&nbsp;</div></li><li><div>  function transaction($action) {&nbsp;</div></li><li><div>    switch ($action) {&nbsp;</div></li><li><div>    case 'start':&nbsp;</div></li><li><div>      // store all the data away into the checkpoint variable&nbsp;</div></li><li><div>      $data = get_object_vars($this);&nbsp;</div></li><li><div>      $this-&gt;checkpoint = $data;&nbsp;</div></li><li><div>      unset($data);&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'commit':&nbsp;</div></li><li><div>      if (is_array($this-&gt;checkpoint) && isset($this-&gt;checkpoint['checkpoint'])) {&nbsp;</div></li><li><div>        $tmp = $this-&gt;checkpoint['checkpoint'];&nbsp;</div></li><li><div>        $this-&gt;checkpoint = $tmp;&nbsp;</div></li><li><div>        unset($tmp);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>        $this-&gt;checkpoint = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'rewind':&nbsp;</div></li><li><div>      // do not destroy the current checkpoint, but move us back to the state then, so that we can try again&nbsp;</div></li><li><div>      if (is_array($this-&gt;checkpoint)) {&nbsp;</div></li><li><div>        // can only abort if were inside a checkpoint&nbsp;</div></li><li><div>        $tmp = $this-&gt;checkpoint;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($tmp as $k =&gt; $v) {&nbsp;</div></li><li><div>          if ($k !== 'checkpoint') {&nbsp;</div></li><li><div>            $this-&gt;$k = $v;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        unset($tmp);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    case 'abort':&nbsp;</div></li><li><div>      if (is_array($this-&gt;checkpoint)) {&nbsp;</div></li><li><div>        // can only abort if were inside a checkpoint&nbsp;</div></li><li><div>        $tmp = $this-&gt;checkpoint;&nbsp;</div></li><li><div>        foreach ($tmp as $k =&gt; $v) {&nbsp;</div></li><li><div>          $this-&gt;$k = $v;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        unset($tmp);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.6.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.5/classes/cpdf/" class="active">1.6.5</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.4/classes/cpdf/" class="">1.6.4</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.3/classes/cpdf/" class="">1.6.3</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.2/classes/cpdf/" class="">1.6.2</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices-packing-slips/1.6.1/classes/cpdf/" class="">1.6.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Cpdf</li><li><span></span>WooCommerce PDF Invoices &amp; Packing Slips</li><li><span></span>1.6.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>