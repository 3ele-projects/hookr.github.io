<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.8.1" data-slug="woocommerce-pdf-invoices" data-type="class" data-id="21087"><head xmlns="http://www.w3.org/1999/xhtml"><title> ttfontfile | class | Woocommerce Pdf Invoices | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="TTFontFile, class, plugin, woocommerce-pdf-invoices, 2.8.1" /><meta name="description" content="The WooCommerce PDF Invoices TTFontFile class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=9bf48a30dd8367b609a39b1b4d96950c' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/ttfont_file/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fttfont_file%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fttfont_file%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-pdf-invoices-2.8.1-class-ttfont_file","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="ttfont_file" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-pdf-invoices." href="http://hookr.io/plugins/woocommerce-pdf-invoices/" class="plugin"><span property="name">woocommerce-pdf-invoices</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.8.1." href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/" class="H_VERSION"><span property="name">2.8.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">ttfont_file</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="211"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/all/" title="All">All <span class="count badge">211</span></a></li><li class="" data-id="new" data-count="24"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/new/" title="New">New <span class="count badge">24</span></a></li><li class="" data-id="hooks" data-count="41"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/hooks/" title="Hooks">Hooks <span class="count badge">41</span></a></li><li class="" data-id="action" data-count="13"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/actions/" title="Actions">Actions <span class="count badge">13</span></a></li><li class="" data-id="filter" data-count="28"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/filters/" title="Filters">Filters <span class="count badge">28</span></a></li><li class="active" data-id="class" data-count="63"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/classes/" title="Classes">Classes <span class="count badge">63</span></a></li><li class="" data-id="constant" data-count="66"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/constants/" title="Constants">Constants <span class="count badge">66</span></a></li><li class="" data-id="function" data-count="40"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/functions/" title="Functions">Functions <span class="count badge">40</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>TTFontFile</strong></h1><p>The WooCommerce PDF Invoices <strong>TTFontFile</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/files/vendor-mpdf-mpdf-classes-ttfontsuni/" class="file">/vendor/mpdf/mpdf/classes/ttfontsuni.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="51" class="block" start="56"><li><div>class TTFontFile&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    var $GPOSFeatures; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $GPOSLookups; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $GPOSScriptLang; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $MarkAttachmentType; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $MarkGlyphSets; // mPDF 7.5.1&nbsp;</div></li><li><div>    var $GlyphClassMarks; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $GlyphClassLigatures; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $GlyphClassBases; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $GlyphClassComponents; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $GSUBScriptLang; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $rtlPUAstr; // mPDF 5.7.1&nbsp;</div></li><li><div>    //var $rtlPUAarr;    // mPDF 5.7.1&nbsp;</div></li><li><div>    var $fontkey; // mPDF 5.7.1&nbsp;</div></li><li><div>    var $useOTL; // mPDF 5.7.1    var $panose;&nbsp;</div></li><li><div>    var $maxUni;&nbsp;</div></li><li><div>    var $sFamilyClass;&nbsp;</div></li><li><div>    var $sFamilySubClass;&nbsp;</div></li><li><div>    var $sipset;&nbsp;</div></li><li><div>    var $smpset;&nbsp;</div></li><li><div>    var $_pos;&nbsp;</div></li><li><div>    var $numTables;&nbsp;</div></li><li><div>    var $searchRange;&nbsp;</div></li><li><div>    var $entrySelector;&nbsp;</div></li><li><div>    var $rangeShift;&nbsp;</div></li><li><div>    var $tables;&nbsp;</div></li><li><div>    var $otables;&nbsp;</div></li><li><div>    var $filename;&nbsp;</div></li><li><div>    var $fh;&nbsp;</div></li><li><div>    var $glyphPos;&nbsp;</div></li><li><div>    var $charToGlyph;&nbsp;</div></li><li><div>    var $ascent;&nbsp;</div></li><li><div>    var $descent;&nbsp;</div></li><li><div>    var $lineGap; // mPDF 6&nbsp;</div></li><li><div>    var $hheaascent;&nbsp;</div></li><li><div>    var $hheadescent;&nbsp;</div></li><li><div>    var $hhealineGap; // mPDF 6&nbsp;</div></li><li><div>    var $advanceWidthMax; // mPDF 6&nbsp;</div></li><li><div>    var $typoAscender; // mPDF 6&nbsp;</div></li><li><div>    var $typoDescender; // mPDF 6&nbsp;</div></li><li><div>    var $typoLineGap; // mPDF 6&nbsp;</div></li><li><div>    var $usWinAscent; // mPDF 6&nbsp;</div></li><li><div>    var $usWinDescent; // mPDF 6&nbsp;</div></li><li><div>    var $strikeoutSize;&nbsp;</div></li><li><div>    var $strikeoutPosition;&nbsp;</div></li><li><div>    var $name;&nbsp;</div></li><li><div>    var $familyName;&nbsp;</div></li><li><div>    var $styleName;&nbsp;</div></li><li><div>    var $fullName;&nbsp;</div></li><li><div>    var $uniqueFontID;&nbsp;</div></li><li><div>    var $unitsPerEm;&nbsp;</div></li><li><div>    var $bbox;&nbsp;</div></li><li><div>    var $capHeight;&nbsp;</div></li><li><div>    var $xHeight; // mPDF 6&nbsp;</div></li><li><div>    var $stemV;&nbsp;</div></li><li><div>    var $italicAngle;&nbsp;</div></li><li><div>    var $flags;&nbsp;</div></li><li><div>    var $underlinePosition;&nbsp;</div></li><li><div>    var $underlineThickness;&nbsp;</div></li><li><div>    var $charWidths;&nbsp;</div></li><li><div>    var $defaultWidth;&nbsp;</div></li><li><div>    var $maxStrLenRead;&nbsp;</div></li><li><div>    var $numTTCFonts;&nbsp;</div></li><li><div>    var $TTCFonts;&nbsp;</div></li><li><div>    var $maxUniChar;&nbsp;</div></li><li><div>    var $kerninfo;&nbsp;</div></li><li><div>    var $haskernGPOS;&nbsp;</div></li><li><div>    var $hassmallcapsGSUB;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function __construct()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;maxStrLenRead = 200000; // Maximum size of glyf table to read in as string (otherwise reads each glyph from file)&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getMetrics($file, $fontkey, $TTCfontID = 0, $debug = false, $BMPonly = false, $useOTL = 0)&nbsp;</div></li><li><div>    { // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;useOTL = $useOTL; // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;fontkey = $fontkey; // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;filename = $file;&nbsp;</div></li><li><div>        $this-&gt;fh = fopen($file, 'rb');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;fh) {&nbsp;</div></li><li><div>            throw new MpdfException('Can\'t open file ' . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_pos = 0;&nbsp;</div></li><li><div>        $this-&gt;charWidths = '';&nbsp;</div></li><li><div>        $this-&gt;glyphPos = array();&nbsp;</div></li><li><div>        $this-&gt;charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;tables = array();&nbsp;</div></li><li><div>        $this-&gt;otables = array();&nbsp;</div></li><li><div>        $this-&gt;kerninfo = array();&nbsp;</div></li><li><div>        $this-&gt;haskernGPOS = array();&nbsp;</div></li><li><div>        $this-&gt;hassmallcapsGSUB = array();&nbsp;</div></li><li><div>        $this-&gt;ascent = 0;&nbsp;</div></li><li><div>        $this-&gt;descent = 0;&nbsp;</div></li><li><div>        $this-&gt;lineGap = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;hheaascent = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;hheadescent = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;hhealineGap = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;xHeight = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;capHeight = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;panose = array();&nbsp;</div></li><li><div>        $this-&gt;sFamilyClass = 0;&nbsp;</div></li><li><div>        $this-&gt;sFamilySubClass = 0;&nbsp;</div></li><li><div>        $this-&gt;typoAscender = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;typoDescender = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;typoLineGap = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;usWinAscent = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;usWinDescent = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;advanceWidthMax = 0; // mPDF 6&nbsp;</div></li><li><div>        $this-&gt;strikeoutSize = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutPosition = 0;&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = 0;&nbsp;</div></li><li><div>        $this-&gt;TTCFonts = array();&nbsp;</div></li><li><div>        $this-&gt;version = $version = $this-&gt;read_ulong();&nbsp;</div></li><li><div>        $this-&gt;panose = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($version == 0x4F54544F) {&nbsp;</div></li><li><div>            throw new MpdfException(&quot;Postscript outlines are not supported&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($version == 0x74746366 && !$TTCfontID) {&nbsp;</div></li><li><div>            throw new MpdfException(&quot;ERROR - You must define the TTCfontID for a TrueType Collection in config_fonts.php (&quot; . $file . &quot;)&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!in_array($version, array(0x00010000, 0x74727565)) && !$TTCfontID) {&nbsp;</div></li><li><div>            throw new MpdfException(&quot;Not a TrueType font: version=&quot; . $version);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($TTCfontID &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTC Header version now&nbsp;</div></li><li><div>            if (!in_array($version, array(0x00010000, 0x00020000))) {&nbsp;</div></li><li><div>                throw new MpdfException(&quot;ERROR - Error parsing TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;numTTCFonts = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            for ($i = 1; $i &lt;= $this-&gt;numTTCFonts; $i++) {&nbsp;</div></li><li><div>                $this-&gt;TTCFonts[$i]['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($this-&gt;TTCFonts[$TTCfontID]['offset']);&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTFont version again now&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;readTableDirectory($debug);&nbsp;</div></li><li><div>        $this-&gt;extractInfo($debug, $BMPonly, $useOTL);&nbsp;</div></li><li><div>        fclose($this-&gt;fh);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function readTableDirectory($debug = false)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;numTables = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $this-&gt;searchRange = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $this-&gt;entrySelector = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $this-&gt;rangeShift = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $this-&gt;tables = array();&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $this-&gt;numTables; $i++) {&nbsp;</div></li><li><div>            $record = array();&nbsp;</div></li><li><div>            $record['tag'] = $this-&gt;read_tag();&nbsp;</div></li><li><div>            $record['checksum'] = array($this-&gt;read_ushort(), $this-&gt;read_ushort());&nbsp;</div></li><li><div>            $record['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $record['length'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $this-&gt;tables[$record['tag']] = $record;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($debug)&nbsp;</div></li><li><div>            $this-&gt;checksumTables();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function checksumTables()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // Check the checksums for all tables&nbsp;</div></li><li><div>        foreach ($this-&gt;tables AS $t) {&nbsp;</div></li><li><div>            if ($t['length'] &gt; 0 && $t['length'] &lt; $this-&gt;maxStrLenRead) { // 1.02&nbsp;</div></li><li><div>                $table = $this-&gt;get_chunk($t['offset'], $t['length']);&nbsp;</div></li><li><div>                $checksum = $this-&gt;calcChecksum($table);&nbsp;</div></li><li><div>                if ($t['tag'] == 'head') {&nbsp;</div></li><li><div>                    $up = unpack('n*', substr($table, 8, 4));&nbsp;</div></li><li><div>                    $adjustment[0] = $up[1];&nbsp;</div></li><li><div>                    $adjustment[1] = $up[2];&nbsp;</div></li><li><div>                    $checksum = $this-&gt;sub32($checksum, $adjustment);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $xchecksum = $t['checksum'];&nbsp;</div></li><li><div>                if ($xchecksum != $checksum) {&nbsp;</div></li><li><div>                    throw new MpdfException(sprintf('TTF file &quot;%s&quot;: invalid checksum %s table: %s (expected %s)', $this-&gt;filename, dechex($checksum[0]) . dechex($checksum[1]), $t['tag'], dechex($xchecksum[0]) . dechex($xchecksum[1])));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sub32($x, $y)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $xlo = $x[1];&nbsp;</div></li><li><div>        $xhi = $x[0];&nbsp;</div></li><li><div>        $ylo = $y[1];&nbsp;</div></li><li><div>        $yhi = $y[0];&nbsp;</div></li><li><div>        if ($ylo &gt; $xlo) {&nbsp;</div></li><li><div>            $xlo += 1 &lt;&lt; 16;&nbsp;</div></li><li><div>            $yhi += 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $reslo = $xlo - $ylo;&nbsp;</div></li><li><div>        if ($yhi &gt; $xhi) {&nbsp;</div></li><li><div>            $xhi += 1 &lt;&lt; 16;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $reshi = $xhi - $yhi;&nbsp;</div></li><li><div>        $reshi = $reshi & 0xFFFF;&nbsp;</div></li><li><div>        return array($reshi, $reslo);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function calcChecksum($data)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (strlen($data) % 4) {&nbsp;</div></li><li><div>            $data .= str_repeat(&quot;\0&quot;, (4 - (strlen($data) % 4)));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $len = strlen($data);&nbsp;</div></li><li><div>        $hi = 0x0000;&nbsp;</div></li><li><div>        $lo = 0x0000;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $len; $i+=4) {&nbsp;</div></li><li><div>            $hi += (ord($data[$i]) &lt;&lt; 8) + ord($data[$i + 1]);&nbsp;</div></li><li><div>            $lo += (ord($data[$i + 2]) &lt;&lt; 8) + ord($data[$i + 3]);&nbsp;</div></li><li><div>            $hi += ($lo &gt;&gt; 16) & 0xFFFF;&nbsp;</div></li><li><div>            $lo = $lo & 0xFFFF;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $hi = $hi & 0xFFFF; // mPDF 5.7.1&nbsp;</div></li><li><div>        return array($hi, $lo);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_table_pos($tag)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if (!isset($this-&gt;tables[$tag])) {&nbsp;</div></li><li><div>            return array(0, 0);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $offset = $this-&gt;tables[$tag]['offset'];&nbsp;</div></li><li><div>        $length = $this-&gt;tables[$tag]['length'];&nbsp;</div></li><li><div>        return array($offset, $length);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function seek($pos)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_pos = $pos;&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $this-&gt;_pos);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function skip($delta)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_pos = $this-&gt;_pos + $delta;&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $delta, SEEK_CUR);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function seek_table($tag, $offset_in_table = 0)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $tpos = $this-&gt;get_table_pos($tag);&nbsp;</div></li><li><div>        $this-&gt;_pos = $tpos[0] + $offset_in_table;&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $this-&gt;_pos);&nbsp;</div></li><li><div>        return $this-&gt;_pos;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function read_tag()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_pos += 4;&nbsp;</div></li><li><div>        return fread($this-&gt;fh, 4);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function read_short()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_pos += 2;&nbsp;</div></li><li><div>        $s = fread($this-&gt;fh, 2);&nbsp;</div></li><li><div>        $a = (ord($s[0]) &lt;&lt; 8) + ord($s[1]);&nbsp;</div></li><li><div>        if ($a & (1 &lt;&lt; 15)) {&nbsp;</div></li><li><div>            $a = ($a - (1 &lt;&lt; 16));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $a;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function unpack_short($s)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $a = (ord($s[0]) &lt;&lt; 8) + ord($s[1]);&nbsp;</div></li><li><div>        if ($a & (1 &lt;&lt; 15)) {&nbsp;</div></li><li><div>            $a = ($a - (1 &lt;&lt; 16));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $a;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function read_ushort()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_pos += 2;&nbsp;</div></li><li><div>        $s = fread($this-&gt;fh, 2);&nbsp;</div></li><li><div>        return (ord($s[0]) &lt;&lt; 8) + ord($s[1]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function read_ulong()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;_pos += 4;&nbsp;</div></li><li><div>        $s = fread($this-&gt;fh, 4);&nbsp;</div></li><li><div>        // if large uInt32 as an integer, PHP converts it to -ve&nbsp;</div></li><li><div>        return (ord($s[0]) * 16777216) + (ord($s[1]) &lt;&lt; 16) + (ord($s[2]) &lt;&lt; 8) + ord($s[3]); //     16777216 = 1&lt;&lt;24&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_ushort($pos)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $pos);&nbsp;</div></li><li><div>        $s = fread($this-&gt;fh, 2);&nbsp;</div></li><li><div>        return (ord($s[0]) &lt;&lt; 8) + ord($s[1]);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_ulong($pos)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $pos);&nbsp;</div></li><li><div>        $s = fread($this-&gt;fh, 4);&nbsp;</div></li><li><div>        // iF large uInt32 as an integer, PHP converts it to -ve&nbsp;</div></li><li><div>        return (ord($s[0]) * 16777216) + (ord($s[1]) &lt;&lt; 16) + (ord($s[2]) &lt;&lt; 8) + ord($s[3]); //     16777216 = 1&lt;&lt;24&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function pack_short($val)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if ($val &lt; 0) {&nbsp;</div></li><li><div>            $val = abs($val);&nbsp;</div></li><li><div>            $val = ~$val;&nbsp;</div></li><li><div>            $val += 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return pack(&quot;n&quot;, $val);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function splice($stream, $offset, $value)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        return substr($stream, 0, $offset) . $value . substr($stream, $offset + strlen($value));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _set_ushort($stream, $offset, $value)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $up = pack(&quot;n&quot;, $value);&nbsp;</div></li><li><div>        return $this-&gt;splice($stream, $offset, $up);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _set_short($stream, $offset, $val)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if ($val &lt; 0) {&nbsp;</div></li><li><div>            $val = abs($val);&nbsp;</div></li><li><div>            $val = ~$val;&nbsp;</div></li><li><div>            $val += 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $up = pack(&quot;n&quot;, $val);&nbsp;</div></li><li><div>        return $this-&gt;splice($stream, $offset, $up);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_chunk($pos, $length)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $pos);&nbsp;</div></li><li><div>        if ($length &lt; 1) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return (fread($this-&gt;fh, $length));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_table($tag)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        list($pos, $length) = $this-&gt;get_table_pos($tag);&nbsp;</div></li><li><div>        if ($length == 0) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        fseek($this-&gt;fh, $pos);&nbsp;</div></li><li><div>        return (fread($this-&gt;fh, $length));&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add($tag, $data)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        if ($tag == 'head') {&nbsp;</div></li><li><div>            $data = $this-&gt;splice($data, 8, &quot;\0\0\0\0&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;otables[$tag] = $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /////////////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    function getCTG($file, $TTCfontID = 0, $debug = false, $useOTL = false)&nbsp;</div></li><li><div>    { // mPDF 5.7.1&nbsp;</div></li><li><div>        // Only called if font is not to be used as embedded subset i.e. NOT called for SIP/SMP fonts&nbsp;</div></li><li><div>        $this-&gt;useOTL = $useOTL; // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;filename = $file;&nbsp;</div></li><li><div>        $this-&gt;fh = fopen($file, 'rb');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;fh) {&nbsp;</div></li><li><div>            throw new MpdfException('Can\'t open file ' . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_pos = 0;&nbsp;</div></li><li><div>        $this-&gt;charWidths = '';&nbsp;</div></li><li><div>        $this-&gt;glyphPos = array();&nbsp;</div></li><li><div>        $this-&gt;charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;tables = array();&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = 0;&nbsp;</div></li><li><div>        $this-&gt;TTCFonts = array();&nbsp;</div></li><li><div>        $this-&gt;skip(4);&nbsp;</div></li><li><div>        if ($TTCfontID &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTC Header version now&nbsp;</div></li><li><div>            if (!in_array($version, array(0x00010000, 0x00020000))) {&nbsp;</div></li><li><div>                throw new MpdfException(&quot;ERROR - Error parsing TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;numTTCFonts = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            for ($i = 1; $i &lt;= $this-&gt;numTTCFonts; $i++) {&nbsp;</div></li><li><div>                $this-&gt;TTCFonts[$i]['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($this-&gt;TTCFonts[$TTCfontID]['offset']);&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTFont version again now&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;readTableDirectory($debug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // cmap - Character to glyph index mapping table&nbsp;</div></li><li><div>        $cmap_offset = $this-&gt;seek_table(&quot;cmap&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(2);&nbsp;</div></li><li><div>        $cmapTableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $unicode_cmap_offset = 0;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $cmapTableCount; $i++) {&nbsp;</div></li><li><div>            $platformID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $encodingID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $offset = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $save_pos = $this-&gt;_pos;&nbsp;</div></li><li><div>            if ($platformID == 3 && $encodingID == 1) { // Microsoft, Unicode&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 4) {&nbsp;</div></li><li><div>                    $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else if ($platformID == 0) { // Unicode -- assume all encodings are compatible&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 4) {&nbsp;</div></li><li><div>                    $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($save_pos);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $glyphToChar = array();&nbsp;</div></li><li><div>        $charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;getCMAP4($unicode_cmap_offset, $glyphToChar, $charToGlyph);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        // Map Unmapped glyphs - from $numGlyphs&nbsp;</div></li><li><div>        if ($useOTL) {&nbsp;</div></li><li><div>            $this-&gt;seek_table(&quot;maxp&quot;);&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>            $numGlyphs = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $bctr = 0xE000;&nbsp;</div></li><li><div>            for ($gid = 1; $gid &lt; $numGlyphs; $gid++) {&nbsp;</div></li><li><div>                if (!isset($glyphToChar[$gid])) {&nbsp;</div></li><li><div>                    while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                        $bctr++;&nbsp;</div></li><li><div>                    } // Avoid overwriting a glyph already mapped in PUA&nbsp;</div></li><li><div>                    if ($bctr &gt; 0xF8FF) {&nbsp;</div></li><li><div>                        throw new MpdfException($file . &quot; : WARNING - Font cannot map all included glyphs into Private Use Area U+E000 - U+F8FF; cannot use useOTL on this font&quot;);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $glyphToChar[$gid][] = $bctr;&nbsp;</div></li><li><div>                    $charToGlyph[$bctr] = $gid;&nbsp;</div></li><li><div>                    $bctr++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        fclose($this-&gt;fh);&nbsp;</div></li><li><div>        return ($charToGlyph);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /////////////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    function getTTCFonts($file)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;filename = $file;&nbsp;</div></li><li><div>        $this-&gt;fh = fopen($file, 'rb');&nbsp;</div></li><li><div>        if (!$this-&gt;fh) {&nbsp;</div></li><li><div>            return ('ERROR - Can\'t open file ' . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = 0;&nbsp;</div></li><li><div>        $this-&gt;TTCFonts = array();&nbsp;</div></li><li><div>        $this-&gt;version = $version = $this-&gt;read_ulong();&nbsp;</div></li><li><div>        if ($version == 0x74746366) {&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTC Header version now&nbsp;</div></li><li><div>            if (!in_array($version, array(0x00010000, 0x00020000)))&nbsp;</div></li><li><div>                return(&quot;ERROR - Error parsing TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            return(&quot;ERROR - Not a TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = $this-&gt;read_ulong();&nbsp;</div></li><li><div>        for ($i = 1; $i &lt;= $this-&gt;numTTCFonts; $i++) {&nbsp;</div></li><li><div>            $this-&gt;TTCFonts[$i]['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /////////////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    /////////////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function extractInfo($debug = false, $BMPonly = false, $useOTL = 0)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // Values are all set to 0 or blank at start of getMetrics&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // name - Naming table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $name_offset = $this-&gt;seek_table(&quot;name&quot;);&nbsp;</div></li><li><div>        $format = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        if ($format != 0 && $format != 1)&nbsp;</div></li><li><div>            throw new MpdfException(&quot;Unknown name table format &quot; . $format);&nbsp;</div></li><li><div>        $numRecords = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $string_data_offset = $name_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $names = array(1 =&gt; '', 2 =&gt; '', 3 =&gt; '', 4 =&gt; '', 6 =&gt; '');&nbsp;</div></li><li><div>        $K = array_keys($names);&nbsp;</div></li><li><div>        $nameCount = count($names);&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $numRecords; $i++) {&nbsp;</div></li><li><div>            $platformId = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $encodingId = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $languageId = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $nameId = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $length = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if (!in_array($nameId, $K))&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            $N = '';&nbsp;</div></li><li><div>            if ($platformId == 3 && $encodingId == 1 && $languageId == 0x409) { // Microsoft, Unicode, US English, PS Name&nbsp;</div></li><li><div>                $opos = $this-&gt;_pos;&nbsp;</div></li><li><div>                $this-&gt;seek($string_data_offset + $offset);&nbsp;</div></li><li><div>                if ($length % 2 != 0)&nbsp;</div></li><li><div>                    throw new MpdfException(&quot;PostScript name is UTF-16BE string of odd length&quot;);&nbsp;</div></li><li><div>                $length /= 2;&nbsp;</div></li><li><div>                $N = '';&nbsp;</div></li><li><div>                while ($length &gt; 0) {&nbsp;</div></li><li><div>                    $char = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $N .= (chr($char));&nbsp;</div></li><li><div>                    $length -= 1;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;_pos = $opos;&nbsp;</div></li><li><div>                $this-&gt;seek($opos);&nbsp;</div></li><li><div>            } else if ($platformId == 1 && $encodingId == 0 && $languageId == 0) { // Macintosh, Roman, English, PS Name&nbsp;</div></li><li><div>                $opos = $this-&gt;_pos;&nbsp;</div></li><li><div>                $N = $this-&gt;get_chunk($string_data_offset + $offset, $length);&nbsp;</div></li><li><div>                $this-&gt;_pos = $opos;&nbsp;</div></li><li><div>                $this-&gt;seek($opos);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ($N && $names[$nameId] == '') {&nbsp;</div></li><li><div>                $names[$nameId] = $N;&nbsp;</div></li><li><div>                $nameCount -= 1;&nbsp;</div></li><li><div>                if ($nameCount == 0)&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($names[6])&nbsp;</div></li><li><div>            $psName = $names[6];&nbsp;</div></li><li><div>        else if ($names[4])&nbsp;</div></li><li><div>            $psName = preg_replace('/ /', '-', $names[4]);&nbsp;</div></li><li><div>        else if ($names[1])&nbsp;</div></li><li><div>            $psName = preg_replace('/ /', '-', $names[1]);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $psName = '';&nbsp;</div></li><li><div>        if (!$psName)&nbsp;</div></li><li><div>            throw new MpdfException(&quot;Could not find PostScript font name: &quot; . $this-&gt;filename);&nbsp;</div></li><li><div>        // CHECK IF psName valid (PadaukBook contains illegal characters in Name ID 6 i.e. Postscript Name)&nbsp;</div></li><li><div>        $psNameInvalid = false;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; count($psName); $i++) {&nbsp;</div></li><li><div>            $c = $psName[$i];&nbsp;</div></li><li><div>            $oc = ord($c);&nbsp;</div></li><li><div>            if ($oc &gt; 126 || strpos(' []() {}&lt;&gt;/%', $c) !== false) {&nbsp;</div></li><li><div>                //throw new MpdfException(&quot;psName=&quot;.$psName.&quot; contains invalid character &quot;.$c.&quot; ie U+&quot;.ord(c));&nbsp;</div></li><li><div>                $psNameInvalid = true;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($psNameInvalid && $names[4])&nbsp;</div></li><li><div>            $psName = preg_replace('/ /', '-', $names[4]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;name = $psName;&nbsp;</div></li><li><div>        if ($names[1]) {&nbsp;</div></li><li><div>            $this-&gt;familyName = $names[1];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;familyName = $psName;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($names[2]) {&nbsp;</div></li><li><div>            $this-&gt;styleName = $names[2];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;styleName = 'Regular';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($names[4]) {&nbsp;</div></li><li><div>            $this-&gt;fullName = $names[4];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;fullName = $psName;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($names[3]) {&nbsp;</div></li><li><div>            $this-&gt;uniqueFontID = $names[3];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;uniqueFontID = $psName;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$psNameInvalid && $names[6]) {&nbsp;</div></li><li><div>            $this-&gt;fullName = $names[6];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // head - Font header table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;head&quot;);&nbsp;</div></li><li><div>        if ($debug) {&nbsp;</div></li><li><div>            $ver_maj = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $ver_min = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if ($ver_maj != 1)&nbsp;</div></li><li><div>                throw new MpdfException('Unknown head table version ' . $ver_maj . '.' . $ver_min);&nbsp;</div></li><li><div>            $this-&gt;fontRevision = $this-&gt;read_ushort() . $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>            $magic = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            if ($magic != 0x5F0F3CF5)&nbsp;</div></li><li><div>                throw new MpdfException('Invalid head table magic ' . $magic);&nbsp;</div></li><li><div>            $this-&gt;skip(2);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;skip(18);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;unitsPerEm = $unitsPerEm = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $scale = 1000 / $unitsPerEm;&nbsp;</div></li><li><div>        $this-&gt;skip(16);&nbsp;</div></li><li><div>        $xMin = $this-&gt;read_short();&nbsp;</div></li><li><div>        $yMin = $this-&gt;read_short();&nbsp;</div></li><li><div>        $xMax = $this-&gt;read_short();&nbsp;</div></li><li><div>        $yMax = $this-&gt;read_short();&nbsp;</div></li><li><div>        $this-&gt;bbox = array(($xMin * $scale), ($yMin * $scale), ($xMax * $scale), ($yMax * $scale));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;skip(3 * 2);&nbsp;</div></li><li><div>        $indexToLocFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $glyphDataFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        if ($glyphDataFormat != 0) {&nbsp;</div></li><li><div>            throw new MpdfException('Unknown glyph data format ' . $glyphDataFormat);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hhea metrics table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;hhea&quot;])) {&nbsp;</div></li><li><div>            $this-&gt;seek_table(&quot;hhea&quot;);&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>            $hheaAscender = $this-&gt;read_short();&nbsp;</div></li><li><div>            $hheaDescender = $this-&gt;read_short();&nbsp;</div></li><li><div>            $hheaLineGap = $this-&gt;read_short(); // mPDF 6&nbsp;</div></li><li><div>            $hheaAdvanceWidthMax = $this-&gt;read_ushort(); // mPDF 6&nbsp;</div></li><li><div>            $this-&gt;hheaascent = ($hheaAscender * $scale);&nbsp;</div></li><li><div>            $this-&gt;hheadescent = ($hheaDescender * $scale);&nbsp;</div></li><li><div>            $this-&gt;hhealineGap = ($hheaLineGap * $scale); // mPDF 6&nbsp;</div></li><li><div>            $this-&gt;advanceWidthMax = ($hheaAdvanceWidthMax * $scale); // mPDF 6&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // OS/2 - OS/2 and Windows metrics table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $use_typo_metrics = false;&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;OS/2&quot;])) {&nbsp;</div></li><li><div>            $this-&gt;seek_table(&quot;OS/2&quot;);&nbsp;</div></li><li><div>            $version = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $this-&gt;skip(2);&nbsp;</div></li><li><div>            $usWeightClass = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $this-&gt;skip(2);&nbsp;</div></li><li><div>            $fsType = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if ($fsType == 0x0002 || ($fsType & 0x0300) != 0) {&nbsp;</div></li><li><div>                $this-&gt;restrictedUse = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // mPDF 6&nbsp;</div></li><li><div>            $this-&gt;skip(16);&nbsp;</div></li><li><div>            $yStrikeoutSize = $this-&gt;read_short();&nbsp;</div></li><li><div>            $yStrikeoutPosition = $this-&gt;read_short();&nbsp;</div></li><li><div>            $this-&gt;strikeoutSize = ($yStrikeoutSize * $scale);&nbsp;</div></li><li><div>            $this-&gt;strikeoutPosition = ($yStrikeoutPosition * $scale);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $sF = $this-&gt;read_short();&nbsp;</div></li><li><div>            $this-&gt;sFamilyClass = ($sF &gt;&gt; 8);&nbsp;</div></li><li><div>            $this-&gt;sFamilySubClass = ($sF & 0xFF);&nbsp;</div></li><li><div>            $this-&gt;_pos += 10; //PANOSE = 10 byte length&nbsp;</div></li><li><div>            $panose = fread($this-&gt;fh, 10);&nbsp;</div></li><li><div>            $this-&gt;panose = array();&nbsp;</div></li><li><div>            for ($p = 0; $p &lt; strlen($panose); $p++) {&nbsp;</div></li><li><div>                $this-&gt;panose[] = ord($panose[$p]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //$this-&gt;skip(26);&nbsp;</div></li><li><div>            // mPDF 6&nbsp;</div></li><li><div>            $this-&gt;skip(20);&nbsp;</div></li><li><div>            $fsSelection = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $use_typo_metrics = (($fsSelection & 0x80) == 0x80); // bit#7 = USE_TYPO_METRICS&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $sTypoAscender = $this-&gt;read_short();&nbsp;</div></li><li><div>            $sTypoDescender = $this-&gt;read_short();&nbsp;</div></li><li><div>            $sTypoLineGap = $this-&gt;read_short(); // mPDF 6&nbsp;</div></li><li><div>            if ($sTypoAscender)&nbsp;</div></li><li><div>                $this-&gt;typoAscender = ($sTypoAscender * $scale); // mPDF 6&nbsp;</div></li><li><div>            if ($sTypoDescender)&nbsp;</div></li><li><div>                $this-&gt;typoDescender = ($sTypoDescender * $scale); // mPDF 6&nbsp;</div></li><li><div>            if ($sTypoLineGap)&nbsp;</div></li><li><div>                $this-&gt;typoLineGap = ($sTypoLineGap * $scale); // mPDF 6&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $usWinAscent = $this-&gt;read_ushort(); // mPDF 6&nbsp;</div></li><li><div>            $usWinDescent = $this-&gt;read_ushort(); // mPDF 6&nbsp;</div></li><li><div>            if ($usWinAscent)&nbsp;</div></li><li><div>                $this-&gt;usWinAscent = ($usWinAscent * $scale); // mPDF 6&nbsp;</div></li><li><div>            if ($usWinDescent)&nbsp;</div></li><li><div>                $this-&gt;usWinDescent = ($usWinDescent * $scale); // mPDF 6&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($version &gt; 1) {&nbsp;</div></li><li><div>                $this-&gt;skip(8); // mPDF 6&nbsp;</div></li><li><div>                $sxHeight = $this-&gt;read_short();&nbsp;</div></li><li><div>                $this-&gt;xHeight = ($sxHeight * $scale);&nbsp;</div></li><li><div>                $sCapHeight = $this-&gt;read_short();&nbsp;</div></li><li><div>                $this-&gt;capHeight = ($sCapHeight * $scale);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $usWeightClass = 400;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;stemV = 50 + intval(pow(($usWeightClass / 65.0), 2));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // FONT DESCRIPTOR METRICS&nbsp;</div></li><li><div>        if (_FONT_DESCRIPTOR == 'winTypo') {&nbsp;</div></li><li><div>            $this-&gt;ascent = $this-&gt;typoAscender;&nbsp;</div></li><li><div>            $this-&gt;descent = $this-&gt;typoDescender;&nbsp;</div></li><li><div>            $this-&gt;lineGap = $this-&gt;typoLineGap;&nbsp;</div></li><li><div>        } else if (_FONT_DESCRIPTOR == 'mac') {&nbsp;</div></li><li><div>            $this-&gt;ascent = $this-&gt;hheaascent;&nbsp;</div></li><li><div>            $this-&gt;descent = $this-&gt;hheadescent;&nbsp;</div></li><li><div>            $this-&gt;lineGap = $this-&gt;hhealineGap;&nbsp;</div></li><li><div>        } else { // if (_FONT_DESCRIPTOR == 'win') {    // default&nbsp;</div></li><li><div>            $this-&gt;ascent = $this-&gt;usWinAscent;&nbsp;</div></li><li><div>            $this-&gt;descent = -$this-&gt;usWinDescent;&nbsp;</div></li><li><div>            $this-&gt;lineGap = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** Special case - if either the winAscent or winDescent are greater than the&nbsp;</div></li><li><div>              font bounding box yMin yMax, then reduce them accordingly.&nbsp;</div></li><li><div>              This works with Myanmar Text (Windows 8 version) to give a&nbsp;</div></li><li><div>              line-height normal that is equivalent to that produced in browsers.&nbsp;</div></li><li><div>              Also Khmer OS = compatible with MSWord, Wordpad and browser. */&nbsp;</div></li><li><div>            if ($this-&gt;ascent &gt; $this-&gt;bbox[3]) {&nbsp;</div></li><li><div>                $this-&gt;ascent = $this-&gt;bbox[3];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ($this-&gt;descent &lt; $this-&gt;bbox[1]) {&nbsp;</div></li><li><div>                $this-&gt;descent = $this-&gt;bbox[1];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** Override case - if the USE_TYPO_METRICS bit is set on OS/2 fsSelection&nbsp;</div></li><li><div>              this is telling the font to use the sTypo values and not the usWinAscent values.&nbsp;</div></li><li><div>              This works as a fix with Cambria Math to give a normal line-height;&nbsp;</div></li><li><div>              at present, this is the only font I have found with this bit set;&nbsp;</div></li><li><div>              although note that MS WordPad and windows FF browser uses the big line-height from winAscent&nbsp;</div></li><li><div>              but Word 2007 get it right . */&nbsp;</div></li><li><div>            if ($use_typo_metrics && $this-&gt;typoAscender) {&nbsp;</div></li><li><div>                $this-&gt;ascent = $this-&gt;typoAscender;&nbsp;</div></li><li><div>                $this-&gt;descent = $this-&gt;typoDescender;&nbsp;</div></li><li><div>                $this-&gt;lineGap = $this-&gt;typoLineGap;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // post - PostScript table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;post&quot;);&nbsp;</div></li><li><div>        if ($debug) {&nbsp;</div></li><li><div>            $ver_maj = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $ver_min = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if ($ver_maj &lt; 1 || $ver_maj &gt; 4)&nbsp;</div></li><li><div>                throw new MpdfException('Unknown post table version ' . $ver_maj);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;italicAngle = $this-&gt;read_short() + $this-&gt;read_ushort() / 65536.0;&nbsp;</div></li><li><div>        $this-&gt;underlinePosition = $this-&gt;read_short() * $scale;&nbsp;</div></li><li><div>        $this-&gt;underlineThickness = $this-&gt;read_short() * $scale;&nbsp;</div></li><li><div>        $isFixedPitch = $this-&gt;read_ulong();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;flags = 4;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($this-&gt;italicAngle != 0)&nbsp;</div></li><li><div>            $this-&gt;flags = $this-&gt;flags | 64;&nbsp;</div></li><li><div>        if ($usWeightClass &gt;= 600)&nbsp;</div></li><li><div>            $this-&gt;flags = $this-&gt;flags | 262144;&nbsp;</div></li><li><div>        if ($isFixedPitch)&nbsp;</div></li><li><div>            $this-&gt;flags = $this-&gt;flags | 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hhea - Horizontal header table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;hhea&quot;);&nbsp;</div></li><li><div>        if ($debug) {&nbsp;</div></li><li><div>            $ver_maj = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $ver_min = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if ($ver_maj != 1)&nbsp;</div></li><li><div>                throw new MpdfException('Unknown hhea table version ' . $ver_maj);&nbsp;</div></li><li><div>            $this-&gt;skip(28);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;skip(32);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $metricDataFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($metricDataFormat != 0) {&nbsp;</div></li><li><div>            throw new MpdfException('Unknown horizontal metric data format ' . $metricDataFormat);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $numberOfHMetrics = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($numberOfHMetrics == 0) {&nbsp;</div></li><li><div>            throw new MpdfException('Number of horizontal metrics is 0');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // maxp - Maximum profile table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;maxp&quot;);&nbsp;</div></li><li><div>        if ($debug) {&nbsp;</div></li><li><div>            $ver_maj = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $ver_min = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if ($ver_maj != 1) {&nbsp;</div></li><li><div>                throw new MpdfException('Unknown maxp table version ' . $ver_maj);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $numGlyphs = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // cmap - Character to glyph index mapping table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $cmap_offset = $this-&gt;seek_table(&quot;cmap&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(2);&nbsp;</div></li><li><div>        $cmapTableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $unicode_cmap_offset = 0;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $cmapTableCount; $i++) {&nbsp;</div></li><li><div>            $platformID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $encodingID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $offset = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $save_pos = $this-&gt;_pos;&nbsp;</div></li><li><div>            if (($platformID == 3 && $encodingID == 1) || $platformID == 0) { // Microsoft, Unicode&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 4) {&nbsp;</div></li><li><div>                    if (!$unicode_cmap_offset)&nbsp;</div></li><li><div>                        $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                    if ($BMPonly)&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // Microsoft, Unicode Format 12 table HKCS&nbsp;</div></li><li><div>            else if ((($platformID == 3 && $encodingID == 10) || $platformID == 0) && !$BMPonly) {&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 12) {&nbsp;</div></li><li><div>                    $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($save_pos);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$unicode_cmap_offset) {&nbsp;</div></li><li><div>            throw new MpdfException('Font (' . $this-&gt;filename . ') does not have cmap for Unicode (platform 3, encoding 1, format 4, or platform 0, any encoding, format 4)');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sipset = false;&nbsp;</div></li><li><div>        $smpset = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;rtlPUAstr = '';&nbsp;</div></li><li><div>        //$this-&gt;rtlPUAarr = array();&nbsp;</div></li><li><div>        $this-&gt;GSUBScriptLang = array();&nbsp;</div></li><li><div>        $this-&gt;GSUBFeatures = array();&nbsp;</div></li><li><div>        $this-&gt;GSUBLookups = array();&nbsp;</div></li><li><div>        $this-&gt;GPOSScriptLang = array();&nbsp;</div></li><li><div>        $this-&gt;GPOSFeatures = array();&nbsp;</div></li><li><div>        $this-&gt;GPOSLookups = array();&nbsp;</div></li><li><div>        $this-&gt;glyphIDtoUni = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Format 12 CMAP does characters above Unicode BMP i.e. some HKCS characters U+20000 and above&nbsp;</div></li><li><div>        if ($format == 12 && !$BMPonly) {&nbsp;</div></li><li><div>            $this-&gt;maxUniChar = 0;&nbsp;</div></li><li><div>            $this-&gt;seek($unicode_cmap_offset + 4);&nbsp;</div></li><li><div>            $length = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $limit = $unicode_cmap_offset + $length;&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $nGroups = $this-&gt;read_ulong();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $glyphToChar = array();&nbsp;</div></li><li><div>            $charToGlyph = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $nGroups; $i++) {&nbsp;</div></li><li><div>                $startCharCode = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                $endCharCode = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                $startGlyphCode = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                // ZZZ98&nbsp;</div></li><li><div>                if ($endCharCode &gt; 0x20000 && $endCharCode &lt; 0x2FFFF) {&nbsp;</div></li><li><div>                    $sipset = true;&nbsp;</div></li><li><div>                } else if ($endCharCode &gt; 0x10000 && $endCharCode &lt; 0x1FFFF) {&nbsp;</div></li><li><div>                    $smpset = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $offset = 0;&nbsp;</div></li><li><div>                for ($unichar = $startCharCode; $unichar &lt;= $endCharCode; $unichar++) {&nbsp;</div></li><li><div>                    $glyph = $startGlyphCode + $offset;&nbsp;</div></li><li><div>                    $offset++;&nbsp;</div></li><li><div>                    // ZZZ98&nbsp;</div></li><li><div>                    if ($unichar &lt; 0x30000) {&nbsp;</div></li><li><div>                        $charToGlyph[$unichar] = $glyph;&nbsp;</div></li><li><div>                        $this-&gt;maxUniChar = max($unichar, $this-&gt;maxUniChar);&nbsp;</div></li><li><div>                        $glyphToChar[$glyph][] = $unichar;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $glyphToChar = array();&nbsp;</div></li><li><div>            $charToGlyph = array();&nbsp;</div></li><li><div>            $this-&gt;getCMAP4($unicode_cmap_offset, $glyphToChar, $charToGlyph);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;sipset = $sipset;&nbsp;</div></li><li><div>        $this-&gt;smpset = $smpset;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        // Map Unmapped glyphs (or glyphs mapped to upper PUA U+F00000 onwards i.e. &gt; U+2FFFF) - from $numGlyphs&nbsp;</div></li><li><div>        if ($this-&gt;useOTL) {&nbsp;</div></li><li><div>            $bctr = 0xE000;&nbsp;</div></li><li><div>            for ($gid = 1; $gid &lt; $numGlyphs; $gid++) {&nbsp;</div></li><li><div>                if (!isset($glyphToChar[$gid])) {&nbsp;</div></li><li><div>                    while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                        $bctr++;&nbsp;</div></li><li><div>                    } // Avoid overwriting a glyph already mapped in PUA&nbsp;</div></li><li><div>                    // ZZZ98&nbsp;</div></li><li><div>                    if (($bctr &gt; 0xF8FF) && ($bctr &lt; 0x2CEB0)) {&nbsp;</div></li><li><div>                        if (!$BMPonly) {&nbsp;</div></li><li><div>                            $bctr = 0x2CEB0; // Use unassigned area 0x2CEB0 to 0x2F7FF (space for 10, 000 characters)&nbsp;</div></li><li><div>                            $this-&gt;sipset = $sipset = true; // forces subsetting; also ensure charwidths are saved&nbsp;</div></li><li><div>                            while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                                $bctr++;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            throw new MpdfException($names[1] . &quot; : WARNING - The font does not have enough space to map all (unmapped) included glyphs into Private Use Area U+E000 - U+F8FF&quot;);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $glyphToChar[$gid][] = $bctr;&nbsp;</div></li><li><div>                    $charToGlyph[$bctr] = $gid;&nbsp;</div></li><li><div>                    $this-&gt;maxUniChar = max($bctr, $this-&gt;maxUniChar);&nbsp;</div></li><li><div>                    $bctr++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;glyphToChar = $glyphToChar;&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // mPDF 5.7.1    OpenType Layout tables&nbsp;</div></li><li><div>        $this-&gt;GSUBScriptLang = array();&nbsp;</div></li><li><div>        $this-&gt;rtlPUAstr = '';&nbsp;</div></li><li><div>        //$this-&gt;rtlPUAarr = array();&nbsp;</div></li><li><div>        if ($useOTL) {&nbsp;</div></li><li><div>            $this-&gt;_getGDEFtables();&nbsp;</div></li><li><div>            list($this-&gt;GSUBScriptLang, $this-&gt;GSUBFeatures, $this-&gt;GSUBLookups, $this-&gt;rtlPUAstr) = $this-&gt;_getGSUBtables();&nbsp;</div></li><li><div>            // , $this-&gt;rtlPUAarr not needed&nbsp;</div></li><li><div>            list($this-&gt;GPOSScriptLang, $this-&gt;GPOSFeatures, $this-&gt;GPOSLookups) = $this-&gt;_getGPOStables();&nbsp;</div></li><li><div>            $this-&gt;glyphIDtoUni = str_pad('', 256 * 256 * 3, &quot;\x00&quot;);&nbsp;</div></li><li><div>            foreach ($glyphToChar AS $gid =&gt; $arr) {&nbsp;</div></li><li><div>                if (isset($glyphToChar[$gid][0])) {&nbsp;</div></li><li><div>                    $char = $glyphToChar[$gid][0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($char != 0 && $char != 65535) {&nbsp;</div></li><li><div>                        $this-&gt;glyphIDtoUni[$gid * 3] = chr($char &gt;&gt; 16);&nbsp;</div></li><li><div>                        $this-&gt;glyphIDtoUni[$gid * 3 + 1] = chr(($char &gt;&gt; 8) & 0xFF);&nbsp;</div></li><li><div>                        $this-&gt;glyphIDtoUni[$gid * 3 + 2] = chr($char & 0xFF);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // if xHeight and/or CapHeight are not available from OS/2 (e.g. eraly versions)&nbsp;</div></li><li><div>        // Calculate from yMax of 'x' or 'H' Glyphs...&nbsp;</div></li><li><div>        if ($this-&gt;xHeight == 0) {&nbsp;</div></li><li><div>            if (isset($charToGlyph[0x78])) {&nbsp;</div></li><li><div>                $gidx = $charToGlyph[0x78]; // U+0078 (LATIN SMALL LETTER X)&nbsp;</div></li><li><div>                $start = $this-&gt;seek_table('loca');&nbsp;</div></li><li><div>                if ($indexToLocFormat == 0) {&nbsp;</div></li><li><div>                    $this-&gt;skip($gidx * 2);&nbsp;</div></li><li><div>                    $locax = $this-&gt;read_ushort() * 2;&nbsp;</div></li><li><div>                } else if ($indexToLocFormat == 1) {&nbsp;</div></li><li><div>                    $this-&gt;skip($gidx * 4);&nbsp;</div></li><li><div>                    $locax = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $start = $this-&gt;seek_table('glyf');&nbsp;</div></li><li><div>                $this-&gt;skip($locax);&nbsp;</div></li><li><div>                $this-&gt;skip(8);&nbsp;</div></li><li><div>                $yMaxx = $this-&gt;read_short();&nbsp;</div></li><li><div>                $this-&gt;xHeight = $yMaxx * $scale;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($this-&gt;capHeight == 0) {&nbsp;</div></li><li><div>            if (isset($charToGlyph[0x48])) {&nbsp;</div></li><li><div>                $gidH = $charToGlyph[0x48]; // U+0048 (LATIN CAPITAL LETTER H)&nbsp;</div></li><li><div>                $start = $this-&gt;seek_table('loca');&nbsp;</div></li><li><div>                if ($indexToLocFormat == 0) {&nbsp;</div></li><li><div>                    $this-&gt;skip($gidH * 2);&nbsp;</div></li><li><div>                    $locaH = $this-&gt;read_ushort() * 2;&nbsp;</div></li><li><div>                } else if ($indexToLocFormat == 1) {&nbsp;</div></li><li><div>                    $this-&gt;skip($gidH * 4);&nbsp;</div></li><li><div>                    $locaH = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $start = $this-&gt;seek_table('glyf');&nbsp;</div></li><li><div>                $this-&gt;skip($locaH);&nbsp;</div></li><li><div>                $this-&gt;skip(8);&nbsp;</div></li><li><div>                $yMaxH = $this-&gt;read_short();&nbsp;</div></li><li><div>                $this-&gt;capHeight = $yMaxH * $scale;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;capHeight = $this-&gt;ascent;&nbsp;</div></li><li><div>            } // final default is to set it = to Ascent&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hmtx - Horizontal metrics table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;getHMTX($numberOfHMetrics, $numGlyphs, $glyphToChar, $scale);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // kern - Kerning pair table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // Recognises old form of Kerning table - as required by Windows - Format 0 only&nbsp;</div></li><li><div>        $kern_offset = $this-&gt;seek_table(&quot;kern&quot;);&nbsp;</div></li><li><div>        $version = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $nTables = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        // subtable header&nbsp;</div></li><li><div>        $sversion = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $slength = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $scoverage = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $format = $scoverage &gt;&gt; 8;&nbsp;</div></li><li><div>        if ($kern_offset && $version == 0 && $format == 0) {&nbsp;</div></li><li><div>            // Format 0&nbsp;</div></li><li><div>            $nPairs = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $this-&gt;skip(6);&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $nPairs; $i++) {&nbsp;</div></li><li><div>                $left = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $right = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $val = $this-&gt;read_short();&nbsp;</div></li><li><div>                if (count($glyphToChar[$left]) == 1 && count($glyphToChar[$right]) == 1) {&nbsp;</div></li><li><div>                    if ($left != 32 && $right != 32) {&nbsp;</div></li><li><div>                        $this-&gt;kerninfo[$glyphToChar[$left][0]][$glyphToChar[$right][0]] = intval($val * $scale);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /////////////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    function _getGDEFtables()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // GDEF - Glyph Definition&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // http://www.microsoft.com/typography/otspec/gdef.htm&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;GDEF&quot;])) {&nbsp;</div></li><li><div>            $gdef_offset = $this-&gt;seek_table(&quot;GDEF&quot;);&nbsp;</div></li><li><div>            // ULONG Version of the GDEF table-currently 0x00010000&nbsp;</div></li><li><div>            $ver_maj = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $ver_min = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $GlyphClassDef_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $AttachList_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $LigCaretList_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $MarkAttachClassDef_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            // Version 0x00010002 of GDEF header contains additional Offset to a list defining mark glyph set definitions (MarkGlyphSetDef)&nbsp;</div></li><li><div>            if ($ver_min == 2) {&nbsp;</div></li><li><div>                $MarkGlyphSetsDef_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // GlyphClassDef&nbsp;</div></li><li><div>            if ($GlyphClassDef_offset) {&nbsp;</div></li><li><div>                $this-&gt;seek($gdef_offset + $GlyphClassDef_offset);&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                  1    Base glyph (single character, spacing glyph)&nbsp;</div></li><li><div>                  2    Ligature glyph (multiple character, spacing glyph)&nbsp;</div></li><li><div>                  3    Mark glyph (non-spacing combining glyph)&nbsp;</div></li><li><div>                  4    Component glyph (part of single character, spacing glyph)&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $GlyphByClass = $this-&gt;_getClassDefinitionTable();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $GlyphByClass = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (isset($GlyphByClass[1]) && count($GlyphByClass[1]) &gt; 0) {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassBases = ' ' . implode('| ', $GlyphByClass[1]);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassBases = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (isset($GlyphByClass[2]) && count($GlyphByClass[2]) &gt; 0) {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassLigatures = ' ' . implode('| ', $GlyphByClass[2]);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassLigatures = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (isset($GlyphByClass[3]) && count($GlyphByClass[3]) &gt; 0) {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassMarks = ' ' . implode('| ', $GlyphByClass[3]);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassMarks = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (isset($GlyphByClass[4]) && count($GlyphByClass[4]) &gt; 0) {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassComponents = ' ' . implode('| ', $GlyphByClass[4]);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;GlyphClassComponents = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (isset($GlyphByClass[3]) && count($GlyphByClass[3]) &gt; 0) {&nbsp;</div></li><li><div>                $Marks = $GlyphByClass[3];&nbsp;</div></li><li><div>            } // to use for MarkAttachmentType&nbsp;</div></li><li><div>            else {&nbsp;</div></li><li><div>                $Marks = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** Required for GPOS&nbsp;</div></li><li><div>              // Attachment List&nbsp;</div></li><li><div>              if ($AttachList_offset) {&nbsp;</div></li><li><div>              $this-&gt;seek($gdef_offset+$AttachList_offset );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              The Attachment Point List table (AttachmentList) identifies all the attachment points defined in the GPOS table and their associated glyphs so a client can quickly access coordinates for each glyph's attachment points. As a result, the client can cache coordinates for attachment points along with glyph bitmaps and avoid recalculating the attachment points each time it displays a glyph. Without this table, processing speed would be slower because the client would have to decode the GPOS lookups that define attachment points and compile the points in a list.&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>              The Attachment List table (AttachList) may be used to cache attachment point coordinates along with glyph bitmaps.&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>              The table consists of an offset to a Coverage table (Coverage) listing all glyphs that define attachment points in the GPOS table, a count of the glyphs with attachment points (GlyphCount), and an array of offsets to AttachPoint tables (AttachPoint). The array lists the AttachPoint tables, one for each glyph in the Coverage table, in the same order as the Coverage Index.&nbsp;</div></li><li><div>              AttachList table&nbsp;</div></li><li><div>              Type     Name     Description&nbsp;</div></li><li><div>              Offset     Coverage     Offset to Coverage table - from beginning of AttachList table&nbsp;</div></li><li><div>              uint16     GlyphCount     Number of glyphs with attachment points&nbsp;</div></li><li><div>              Offset     AttachPoint[GlyphCount]     Array of offsets to AttachPoint tables-from beginning of AttachList table-in Coverage Index order&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>              An AttachPoint table consists of a count of the attachment points on a single glyph (PointCount) and an array of contour indices of those points (PointIndex), listed in increasing numerical order.&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>              AttachPoint table&nbsp;</div></li><li><div>              Type     Name     Description&nbsp;</div></li><li><div>              uint16     PointCount     Number of attachment points on this glyph&nbsp;</div></li><li><div>              uint16     PointIndex[PointCount]     Array of contour point indices -in increasing numerical order&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>              See Example 3 - http://www.microsoft.com/typography/otspec/gdef.htm&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ligature Caret List&nbsp;</div></li><li><div>            // The Ligature Caret List table (LigCaretList) defines caret positions for all the ligatures in a font.&nbsp;</div></li><li><div>            // Not required for mDPF&nbsp;</div></li><li><div>            // MarkAttachmentType&nbsp;</div></li><li><div>            if ($MarkAttachClassDef_offset) {&nbsp;</div></li><li><div>                $this-&gt;seek($gdef_offset + $MarkAttachClassDef_offset);&nbsp;</div></li><li><div>                $MarkAttachmentTypes = $this-&gt;_getClassDefinitionTable();&nbsp;</div></li><li><div>                foreach ($MarkAttachmentTypes AS $class =&gt; $glyphs) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if (is_array($Marks) && count($Marks)) {&nbsp;</div></li><li><div>                        $mat = array_diff($Marks, $MarkAttachmentTypes[$class]);&nbsp;</div></li><li><div>                        sort($mat, SORT_STRING);&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $mat = array();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;MarkAttachmentType[$class] = ' ' . implode('| ', $mat);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;MarkAttachmentType = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // MarkGlyphSets only in Version 0x00010002 of GDEF&nbsp;</div></li><li><div>            if ($ver_min == 2 && $MarkGlyphSetsDef_offset) {&nbsp;</div></li><li><div>                $this-&gt;seek($gdef_offset + $MarkGlyphSetsDef_offset);&nbsp;</div></li><li><div>                $MarkSetTableFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $MarkSetCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $MarkSetOffset = array();&nbsp;</div></li><li><div>                for ($i = 0; $i &lt; $MarkSetCount; $i++) {&nbsp;</div></li><li><div>                    $MarkSetOffset[] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                for ($i = 0; $i &lt; $MarkSetCount; $i++) {&nbsp;</div></li><li><div>                    $this-&gt;seek($MarkSetOffset[$i]);&nbsp;</div></li><li><div>                    $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                    $this-&gt;MarkGlyphSets[$i] = ' ' . implode('| ', $glyphs);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;MarkGlyphSets = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            throw new MpdfException('Warning - You cannot set this font (' . $this-&gt;filename . ') to use OTL, as it does not include OTL tables (or at least, not a GDEF table).');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //=====================================================================================&nbsp;</div></li><li><div>        //=====================================================================================&nbsp;</div></li><li><div>        //=====================================================================================&nbsp;</div></li><li><div>        $GSUB_offset = 0;&nbsp;</div></li><li><div>        $GPOS_offset = 0;&nbsp;</div></li><li><div>        $GSUB_length = 0;&nbsp;</div></li><li><div>        $s = '';&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;GSUB&quot;])) {&nbsp;</div></li><li><div>            $GSUB_offset = $this-&gt;seek_table(&quot;GSUB&quot;);&nbsp;</div></li><li><div>            $GSUB_length = $this-&gt;tables[&quot;GSUB&quot;]['length'];&nbsp;</div></li><li><div>            $s .= fread($this-&gt;fh, $this-&gt;tables[&quot;GSUB&quot;]['length']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;GPOS&quot;])) {&nbsp;</div></li><li><div>            $GPOS_offset = $this-&gt;seek_table(&quot;GPOS&quot;);&nbsp;</div></li><li><div>            $s .= fread($this-&gt;fh, $this-&gt;tables[&quot;GPOS&quot;]['length']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($s)&nbsp;</div></li><li><div>            file_put_contents(_MPDF_TTFONTDATAPATH . $this-&gt;fontkey . '.GSUBGPOStables.dat', $s);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //=====================================================================================&nbsp;</div></li><li><div>        //=====================================================================================&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $s = '&lt;?php&nbsp;</div></li><li><div>$GSUB_offset = ' . $GSUB_offset . ';&nbsp;</div></li><li><div>$GPOS_offset = ' . $GPOS_offset . ';&nbsp;</div></li><li><div>$GSUB_length = ' . $GSUB_length . ';&nbsp;</div></li><li><div>$GlyphClassBases = \'' . $this-&gt;GlyphClassBases . '\';&nbsp;</div></li><li><div>$GlyphClassMarks = \'' . $this-&gt;GlyphClassMarks . '\';&nbsp;</div></li><li><div>$GlyphClassLigatures = \'' . $this-&gt;GlyphClassLigatures . '\';&nbsp;</div></li><li><div>$GlyphClassComponents = \'' . $this-&gt;GlyphClassComponents . '\';&nbsp;</div></li><li><div>$MarkGlyphSets = ' . var_export($this-&gt;MarkGlyphSets, true) . ';&nbsp;</div></li><li><div>$MarkAttachmentType = ' . var_export($this-&gt;MarkAttachmentType, true) . ';&nbsp;</div></li><li><div>?&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        file_put_contents(_MPDF_TTFONTDATAPATH . $this-&gt;fontkey . '.GDEFdata.php', $s);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //=====================================================================================&nbsp;</div></li><li><div>//echo $this-&gt;GlyphClassMarks ; exit;&nbsp;</div></li><li><div>//print_r($GlyphClass); exit;&nbsp;</div></li><li><div>//print_r($GlyphByClass); exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _getClassDefinitionTable()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // NB Any glyph not included in the range of covered GlyphIDs automatically belongs to Class 0. This is not returned by this function&nbsp;</div></li><li><div>        $ClassFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $GlyphByClass = array();&nbsp;</div></li><li><div>        if ($ClassFormat == 1) {&nbsp;</div></li><li><div>            $StartGlyph = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $GlyphCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $GlyphCount; $i++) {&nbsp;</div></li><li><div>                $gid = $StartGlyph + $i;&nbsp;</div></li><li><div>                $class = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                // Several fonts  (mainly dejavu.../Freeserif etc) have a MarkAttachClassDef Format 1, where StartGlyph is 0 and GlyphCount is 1&nbsp;</div></li><li><div>                // This doesn't seem to do anything useful?&nbsp;</div></li><li><div>                // Freeserif does not have $this-&gt;glyphToChar[0] allocated and would throw an error, so check if isset:&nbsp;</div></li><li><div>                if (isset($this-&gt;glyphToChar[$gid][0])) {&nbsp;</div></li><li><div>                    $GlyphByClass[$class][] = unicode_hex($this-&gt;glyphToChar[$gid][0]);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if ($ClassFormat == 2) {&nbsp;</div></li><li><div>            $tableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $tableCount; $i++) {&nbsp;</div></li><li><div>                $startGlyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $endGlyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $class = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($gid = $startGlyphID; $gid &lt;= $endGlyphID; $gid++) {&nbsp;</div></li><li><div>                    if (isset($this-&gt;glyphToChar[$gid][0])) {&nbsp;</div></li><li><div>                        $GlyphByClass[$class][] = unicode_hex($this-&gt;glyphToChar[$gid][0]);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ($GlyphByClass AS $class =&gt; $glyphs) {&nbsp;</div></li><li><div>            sort($GlyphByClass[$class], SORT_STRING); // SORT makes it easier to read in development ? order not important ???&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ksort($GlyphByClass);&nbsp;</div></li><li><div>        return $GlyphByClass;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _getGSUBtables()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // GSUB - Glyph Substitution&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;GSUB&quot;])) {&nbsp;</div></li><li><div>            $ffeats = array();&nbsp;</div></li><li><div>            $gsub_offset = $this-&gt;seek_table(&quot;GSUB&quot;);&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>            $ScriptList_offset = $gsub_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $FeatureList_offset = $gsub_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $LookupList_offset = $gsub_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // ScriptList&nbsp;</div></li><li><div>            $this-&gt;seek($ScriptList_offset);&nbsp;</div></li><li><div>            $ScriptCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $ScriptCount; $i++) {&nbsp;</div></li><li><div>                $ScriptTag = $this-&gt;read_tag(); // = &quot;beng&quot;, &quot;deva&quot; etc.&nbsp;</div></li><li><div>                $ScriptTableOffset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $ffeats[$ScriptTag] = $ScriptList_offset + $ScriptTableOffset;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Script Table&nbsp;</div></li><li><div>            foreach ($ffeats AS $t =&gt; $o) {&nbsp;</div></li><li><div>                $ls = array();&nbsp;</div></li><li><div>                $this-&gt;seek($o);&nbsp;</div></li><li><div>                $DefLangSys_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                if ($DefLangSys_offset &gt; 0) {&nbsp;</div></li><li><div>                    $ls['DFLT'] = $DefLangSys_offset + $o;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $LangSysCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($i = 0; $i &lt; $LangSysCount; $i++) {&nbsp;</div></li><li><div>                    $LangTag = $this-&gt;read_tag(); // =&nbsp;</div></li><li><div>                    $LangTableOffset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $ls[$LangTag] = $o + $LangTableOffset;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $ffeats[$t] = $ls;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>//print_r($ffeats); exit;&nbsp;</div></li><li><div>            // Get FeatureIndexList&nbsp;</div></li><li><div>            // LangSys Table - from first listed langsys&nbsp;</div></li><li><div>            foreach ($ffeats AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $o) {&nbsp;</div></li><li><div>                    $FeatureIndex = array();&nbsp;</div></li><li><div>                    $langsystable_offset = $o;&nbsp;</div></li><li><div>                    $this-&gt;seek($langsystable_offset);&nbsp;</div></li><li><div>                    $LookUpOrder = $this-&gt;read_ushort(); //==NULL&nbsp;</div></li><li><div>                    $ReqFeatureIndex = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    if ($ReqFeatureIndex != 0xFFFF) {&nbsp;</div></li><li><div>                        $FeatureIndex[] = $ReqFeatureIndex;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $FeatureCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    for ($i = 0; $i &lt; $FeatureCount; $i++) {&nbsp;</div></li><li><div>                        $FeatureIndex[] = $this-&gt;read_ushort(); // = index of feature&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $ffeats[$st][$t] = $FeatureIndex;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>//print_r($ffeats); exit;&nbsp;</div></li><li><div>            // Feauture List =&gt; LookupListIndex es&nbsp;</div></li><li><div>            $this-&gt;seek($FeatureList_offset);&nbsp;</div></li><li><div>            $FeatureCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $Feature = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $FeatureCount; $i++) {&nbsp;</div></li><li><div>                $tag = $this-&gt;read_tag();&nbsp;</div></li><li><div>                if ($tag == 'smcp') {&nbsp;</div></li><li><div>                    $this-&gt;hassmallcapsGSUB = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $Feature[$i] = array('tag' =&gt; $tag);&nbsp;</div></li><li><div>                $Feature[$i]['offset'] = $FeatureList_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $FeatureCount; $i++) {&nbsp;</div></li><li><div>                $this-&gt;seek($Feature[$i]['offset']);&nbsp;</div></li><li><div>                $this-&gt;read_ushort(); // null [FeatureParams]&nbsp;</div></li><li><div>                $Feature[$i]['LookupCount'] = $Lookupcount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $Feature[$i]['LookupListIndex'] = array();&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $Lookupcount; $c++) {&nbsp;</div></li><li><div>                    $Feature[$i]['LookupListIndex'][] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//print_r($Feature); exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($ffeats AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $o) {&nbsp;</div></li><li><div>                    $FeatureIndex = $ffeats[$st][$t];&nbsp;</div></li><li><div>                    foreach ($FeatureIndex AS $k =&gt; $fi) {&nbsp;</div></li><li><div>                        $ffeats[$st][$t][$k] = $Feature[$fi];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            $gsub = array();&nbsp;</div></li><li><div>            $GSUBScriptLang = array();&nbsp;</div></li><li><div>            foreach ($ffeats AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $langsys) {&nbsp;</div></li><li><div>                    $lg = array();&nbsp;</div></li><li><div>                    foreach ($langsys AS $ft) {&nbsp;</div></li><li><div>                        $lg[$ft['LookupListIndex'][0]] = $ft;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // list of Lookups in order they need to be run i.e. order listed in Lookup table&nbsp;</div></li><li><div>                    ksort($lg);&nbsp;</div></li><li><div>                    foreach ($lg AS $ft) {&nbsp;</div></li><li><div>                        $gsub[$st][$t][$ft['tag']] = $ft['LookupListIndex'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if (!isset($GSUBScriptLang[$st])) {&nbsp;</div></li><li><div>                        $GSUBScriptLang[$st] = '';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $GSUBScriptLang[$st] .= $t . ' ';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//print_r($gsub); exit;&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Get metadata and offsets for whole Lookup List table&nbsp;</div></li><li><div>            $this-&gt;seek($LookupList_offset);&nbsp;</div></li><li><div>            $LookupCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $GSLookup = array();&nbsp;</div></li><li><div>            $Offsets = array();&nbsp;</div></li><li><div>            $SubtableCount = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                $Offsets[$i] = $LookupList_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                $this-&gt;seek($Offsets[$i]);&nbsp;</div></li><li><div>                $GSLookup[$i]['Type'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $GSLookup[$i]['Flag'] = $flag = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $GSLookup[$i]['SubtableCount'] = $SubtableCount[$i] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $SubtableCount[$i]; $c++) {&nbsp;</div></li><li><div>                    $GSLookup[$i]['Subtables'][$c] = $Offsets[$i] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // MarkFilteringSet = Index (base 0) into GDEF mark glyph sets structure&nbsp;</div></li><li><div>                if (($flag & 0x0010) == 0x0010) {&nbsp;</div></li><li><div>                    $GSLookup[$i]['MarkFilteringSet'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $GSLookup[$i]['MarkFilteringSet'] = '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Lookup Type 7: Extension&nbsp;</div></li><li><div>                if ($GSLookup[$i]['Type'] == 7) {&nbsp;</div></li><li><div>                    // Overwrites new offset (32-bit) for each subtable, and a new lookup Type&nbsp;</div></li><li><div>                    for ($c = 0; $c &lt; $SubtableCount[$i]; $c++) {&nbsp;</div></li><li><div>                        $this-&gt;seek($GSLookup[$i]['Subtables'][$c]);&nbsp;</div></li><li><div>                        $ExtensionPosFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $type = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $ext_offset = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                        $GSLookup[$i]['Subtables'][$c] = $GSLookup[$i]['Subtables'][$c] + $ext_offset;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $GSLookup[$i]['Type'] = $type;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//print_r($GSLookup); exit;&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Process Whole LookupList - Get LuCoverage = Lookup coverage just for first glyph&nbsp;</div></li><li><div>            $this-&gt;GSLuCoverage = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $GSLookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;seek($GSLookup[$i]['Subtables'][$c]);&nbsp;</div></li><li><div>                    $PosFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($GSLookup[$i]['Type'] == 5 && $PosFormat == 3) {&nbsp;</div></li><li><div>                        $this-&gt;skip(4);&nbsp;</div></li><li><div>                    } else if ($GSLookup[$i]['Type'] == 6 && $PosFormat == 3) {&nbsp;</div></li><li><div>                        $BacktrackGlyphCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $this-&gt;skip(2 * $BacktrackGlyphCount + 2);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // NB Coverage only looks at glyphs for position 1 (i.e. 5.3 and 6.3)    // NEEDS TO READ ALL ********************&nbsp;</div></li><li><div>                    $Coverage = $GSLookup[$i]['Subtables'][$c] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $this-&gt;seek($Coverage);&nbsp;</div></li><li><div>                    $glyphs = $this-&gt;_getCoverage(false, 2);&nbsp;</div></li><li><div>                    $this-&gt;GSLuCoverage[$i][$c] = $glyphs;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>// $this-&gt;GSLuCoverage and $GSLookup&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            $s = '&lt;?php&nbsp;</div></li><li><div>$GSLuCoverage = ' . var_export($this-&gt;GSLuCoverage, true) . ';&nbsp;</div></li><li><div>?&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            file_put_contents(_MPDF_TTFONTDATAPATH . $this-&gt;fontkey . '.GSUBdata.php', $s);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>// Now repeats as original to get Substitution rules&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Get metadata and offsets for whole Lookup List table&nbsp;</div></li><li><div>            $this-&gt;seek($LookupList_offset);&nbsp;</div></li><li><div>            $LookupCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $Lookup = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                $Lookup[$i]['offset'] = $LookupList_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                $this-&gt;seek($Lookup[$i]['offset']);&nbsp;</div></li><li><div>                $Lookup[$i]['Type'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $Lookup[$i]['Flag'] = $flag = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $Lookup[$i]['SubtableCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $Lookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>                    $Lookup[$i]['Subtable'][$c]['Offset'] = $Lookup[$i]['offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // MarkFilteringSet = Index (base 0) into GDEF mark glyph sets structure&nbsp;</div></li><li><div>                if (($flag & 0x0010) == 0x0010) {&nbsp;</div></li><li><div>                    $Lookup[$i]['MarkFilteringSet'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $Lookup[$i]['MarkFilteringSet'] = '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Lookup Type 7: Extension&nbsp;</div></li><li><div>                if ($Lookup[$i]['Type'] == 7) {&nbsp;</div></li><li><div>                    // Overwrites new offset (32-bit) for each subtable, and a new lookup Type&nbsp;</div></li><li><div>                    for ($c = 0; $c &lt; $Lookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['Offset']);&nbsp;</div></li><li><div>                        $ExtensionPosFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $type = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['Offset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ulong();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $Lookup[$i]['Type'] = $type;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//print_r($Lookup); exit;&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Process (1) Whole LookupList&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $Lookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;seek($Lookup[$i]['Subtable'][$c]['Offset']);&nbsp;</div></li><li><div>                    $SubstFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $Lookup[$i]['Subtable'][$c]['Format'] = $SubstFormat;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                      Lookup['Type'] Enumeration table for glyph substitution&nbsp;</div></li><li><div>                      Value    Type    Description&nbsp;</div></li><li><div>                      1    Single    Replace one glyph with one glyph&nbsp;</div></li><li><div>                      2    Multiple    Replace one glyph with more than one glyph&nbsp;</div></li><li><div>                      3    Alternate    Replace one glyph with one of many glyphs&nbsp;</div></li><li><div>                      4    Ligature    Replace multiple glyphs with one glyph&nbsp;</div></li><li><div>                      5    Context    Replace one or more glyphs in context&nbsp;</div></li><li><div>                      6    Chaining Context    Replace one or more glyphs in chained context&nbsp;</div></li><li><div>                      7    Extension Substitution    Extension mechanism for other substitutions (i.e. this excludes the Extension type substitution itself)&nbsp;</div></li><li><div>                      8    Reverse chaining context single     Applied in reverse order, replace single glyph in chaining context&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 1: Single Substitution Subtable&nbsp;</div></li><li><div>                    if ($Lookup[$i]['Type'] == 1) {&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        if ($SubstFormat == 1) { // Calculated output glyph indices&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['DeltaGlyphID'] = $this-&gt;read_short();&nbsp;</div></li><li><div>                        } else if ($SubstFormat == 2) { // Specified output glyph indices&nbsp;</div></li><li><div>                            $GlyphCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($g = 0; $g &lt; $GlyphCount; $g++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['Glyphs'][] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // LookupType 2: Multiple Substitution Subtable&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 2) {&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['SequenceCount'] = $SequenceCount = $this-&gt;read_short();&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $SequenceCount; $s++) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['Sequences'][$s]['Offset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_short();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $SequenceCount; $s++) {&nbsp;</div></li><li><div>                            // Sequence Tables&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['Sequences'][$s]['Offset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['Sequences'][$s]['GlyphCount'] = $this-&gt;read_short();&nbsp;</div></li><li><div>                            for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['Sequences'][$s]['GlyphCount']; $g++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['Sequences'][$s]['SubstituteGlyphID'][] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // LookupType 3: Alternate Forms&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 3) {&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['AlternateSetCount'] = $AlternateSetCount = $this-&gt;read_short();&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $AlternateSetCount; $s++) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['AlternateSets'][$s]['Offset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_short();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $AlternateSetCount; $s++) {&nbsp;</div></li><li><div>                            // AlternateSet Tables&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['AlternateSets'][$s]['Offset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['AlternateSets'][$s]['GlyphCount'] = $this-&gt;read_short();&nbsp;</div></li><li><div>                            for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['AlternateSets'][$s]['GlyphCount']; $g++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['AlternateSets'][$s]['SubstituteGlyphID'][] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // LookupType 4: Ligature Substitution Subtable&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 4) {&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtable'][$c]['LigSetCount'] = $LigSetCount = $this-&gt;read_short();&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $LigSetCount; $s++) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Offset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_short();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $LigSetCount; $s++) {&nbsp;</div></li><li><div>                            // LigatureSet Tables&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Offset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['LigCount'] = $this-&gt;read_short();&nbsp;</div></li><li><div>                            for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['LigCount']; $g++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['LigatureOffset'][$g] = $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $LigSetCount; $s++) {&nbsp;</div></li><li><div>                            for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['LigCount']; $g++) {&nbsp;</div></li><li><div>                                // Ligature tables&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['LigSet'][$s]['LigatureOffset'][$g]);&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['LigGlyph'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['CompCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                for ($l = 1; $l &lt; $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['CompCount']; $l++) {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['GlyphID'][$l] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 5: Contextual Substitution Subtable&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 5) {&nbsp;</div></li><li><div>                        // Format 1: Context Substitution&nbsp;</div></li><li><div>                        if ($SubstFormat == 1) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['SubRuleSetCount'] = $SubRuleSetCount = $this-&gt;read_short();&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $SubRuleSetCount; $s++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['Offset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_short();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $SubRuleSetCount; $s++) {&nbsp;</div></li><li><div>                                // SubRuleSet Tables&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['Offset']);&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRuleCount'] = $this-&gt;read_short();&nbsp;</div></li><li><div>                                for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRuleCount']; $g++) {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRuleOffset'][$g] = $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $SubRuleSetCount; $s++) {&nbsp;</div></li><li><div>                                // SubRule Tables&nbsp;</div></li><li><div>                                for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRuleCount']; $g++) {&nbsp;</div></li><li><div>                                    // Ligature tables&nbsp;</div></li><li><div>                                    $this-&gt;seek($Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRuleOffset'][$g]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['GlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['SubstCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    // &quot;Input&quot;::[GlyphCount - 1]::Array of input GlyphIDs-start with second glyph&nbsp;</div></li><li><div>                                    for ($l = 1; $l &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['GlyphCount']; $l++) {&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['Input'][$l] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    // &quot;SubstLookupRecord&quot;::[SubstCount]::Array of SubstLookupRecords-in design order&nbsp;</div></li><li><div>                                    for ($l = 0; $l &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['SubstCount']; $l++) {&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['SubstLookupRecord'][$l]['SequenceIndex'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$g]['SubstLookupRecord'][$l]['LookupListIndex'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 2: Class-based Context Glyph Substitution&nbsp;</div></li><li><div>                        else if ($SubstFormat == 2) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['ClassDefOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['SubClassSetCnt'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['SubClassSetCnt']; $b++) {&nbsp;</div></li><li><div>                                $offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                if ($offset == 0x0000) {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['SubClassSetOffset'][] = 0;&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['SubClassSetOffset'][] = $Lookup[$i]['Subtable'][$c]['Offset'] + $offset;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            throw new MpdfException(&quot;GPOS Lookup Type &quot; . $Lookup[$i]['Type'] . &quot;, Format &quot; . $SubstFormat . &quot; not supported (ttfontsuni.php).&quot;);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 6: Chaining Contextual Substitution Subtable&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 6) {&nbsp;</div></li><li><div>                        // Format 1: Simple Chaining Context Glyph Substitution  p255&nbsp;</div></li><li><div>                        if ($SubstFormat == 1) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['ChainSubRuleSetCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['ChainSubRuleSetCount']; $b++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['ChainSubRuleSetOffset'][] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 2: Class-based Chaining Context Glyph Substitution  p257&nbsp;</div></li><li><div>                        else if ($SubstFormat == 2) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageTableOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['BacktrackClassDefOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['InputClassDefOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['LookaheadClassDefOffset'] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['ChainSubClassSetCnt'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['ChainSubClassSetCnt']; $b++) {&nbsp;</div></li><li><div>                                $offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                if ($offset == 0x0000) {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['ChainSubClassSetOffset'][] = $offset;&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['ChainSubClassSetOffset'][] = $Lookup[$i]['Subtable'][$c]['Offset'] + $offset;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 3: Coverage-based Chaining Context Glyph Substitution  p259&nbsp;</div></li><li><div>                        else if ($SubstFormat == 3) {&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['BacktrackGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['BacktrackGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageBacktrack'][] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['InputGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['InputGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageInput'][] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['LookaheadGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['LookaheadGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageLookahead'][] = $Lookup[$i]['Subtable'][$c]['Offset'] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['SubstCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['SubstCount']; $b++) {&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['SubstLookupRecord'][$b]['SequenceIndex'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['SubstLookupRecord'][$b]['LookupListIndex'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                /**&nbsp;</div></li><li><div>                                  Substitution Lookup Record&nbsp;</div></li><li><div>                                  All contextual substitution subtables specify the substitution data in a Substitution Lookup Record (SubstLookupRecord). Each record contains a SequenceIndex, which indicates the position where the substitution will occur in the glyph sequence. In addition, a LookupListIndex identifies the lookup to be applied at the glyph position specified by the SequenceIndex.&nbsp;</div></li><li><div>                                 */&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        throw new MpdfException(&quot;Lookup Type &quot; . $Lookup[$i]['Type'] . &quot; not supported.&quot;);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>//print_r($Lookup); exit;&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Process (2) Whole LookupList&nbsp;</div></li><li><div>            // Get Coverage tables and prepare preg_replace&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $Lookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>                    $SubstFormat = $Lookup[$i]['Subtable'][$c]['Format'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 1: Single Substitution Subtable 1 =&gt; 1&nbsp;</div></li><li><div>                    if ($Lookup[$i]['Type'] == 1) {&nbsp;</div></li><li><div>                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                        $glyphs = $this-&gt;_getCoverage(false);&nbsp;</div></li><li><div>                        for ($g = 0; $g &lt; count($glyphs); $g++) {&nbsp;</div></li><li><div>                            $replace = array();&nbsp;</div></li><li><div>                            $substitute = array();&nbsp;</div></li><li><div>                            $replace[] = unicode_hex($this-&gt;glyphToChar[$glyphs[$g]][0]);&nbsp;</div></li><li><div>                            // Flag = Ignore&nbsp;</div></li><li><div>                            if ($this-&gt;_checkGSUBignore($Lookup[$i]['Flag'], $replace[0], $Lookup[$i]['MarkFilteringSet'])) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            if (isset($Lookup[$i]['Subtable'][$c]['DeltaGlyphID'])) { // Format 1&nbsp;</div></li><li><div>                                $substitute[] = unicode_hex($this-&gt;glyphToChar[($glyphs[$g] + $Lookup[$i]['Subtable'][$c]['DeltaGlyphID'])][0]);&nbsp;</div></li><li><div>                            } else { // Format 2&nbsp;</div></li><li><div>                                $substitute[] = unicode_hex($this-&gt;glyphToChar[($Lookup[$i]['Subtable'][$c]['Glyphs'][$g])][0]);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['subs'][] = array('Replace' =&gt; $replace, 'substitute' =&gt; $substitute);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 2: Multiple Substitution Subtable 1 =&gt; n&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 2) {&nbsp;</div></li><li><div>                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                        $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                        for ($g = 0; $g &lt; count($glyphs); $g++) {&nbsp;</div></li><li><div>                            $replace = array();&nbsp;</div></li><li><div>                            $substitute = array();&nbsp;</div></li><li><div>                            $replace[] = $glyphs[$g];&nbsp;</div></li><li><div>                            // Flag = Ignore&nbsp;</div></li><li><div>                            if ($this-&gt;_checkGSUBignore($Lookup[$i]['Flag'], $replace[0], $Lookup[$i]['MarkFilteringSet'])) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            if (!isset($Lookup[$i]['Subtable'][$c]['Sequences'][$g]['SubstituteGlyphID']) || count($Lookup[$i]['Subtable'][$c]['Sequences'][$g]['SubstituteGlyphID']) == 0) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            } // Illegal for GlyphCount to be 0; either error in font, or something has gone wrong - lets carry on for now!&nbsp;</div></li><li><div>                            foreach ($Lookup[$i]['Subtable'][$c]['Sequences'][$g]['SubstituteGlyphID'] AS $sub) {&nbsp;</div></li><li><div>                                $substitute[] = unicode_hex($this-&gt;glyphToChar[$sub][0]);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['subs'][] = array('Replace' =&gt; $replace, 'substitute' =&gt; $substitute);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // LookupType 3: Alternate Forms 1 =&gt; 1 (only first alternate form is used)&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 3) {&nbsp;</div></li><li><div>                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                        $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                        for ($g = 0; $g &lt; count($glyphs); $g++) {&nbsp;</div></li><li><div>                            $replace = array();&nbsp;</div></li><li><div>                            $substitute = array();&nbsp;</div></li><li><div>                            $replace[] = $glyphs[$g];&nbsp;</div></li><li><div>                            // Flag = Ignore&nbsp;</div></li><li><div>                            if ($this-&gt;_checkGSUBignore($Lookup[$i]['Flag'], $replace[0], $Lookup[$i]['MarkFilteringSet'])) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $gid = $Lookup[$i]['Subtable'][$c]['AlternateSets'][$g]['SubstituteGlyphID'][0];&nbsp;</div></li><li><div>                            if (!isset($this-&gt;glyphToChar[$gid][0])) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            $substitute[] = unicode_hex($this-&gt;glyphToChar[$gid][0]);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['subs'][] = array('Replace' =&gt; $replace, 'substitute' =&gt; $substitute);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // LookupType 4: Ligature Substitution Subtable n =&gt; 1&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 4) {&nbsp;</div></li><li><div>                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                        $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                        $LigSetCount = $Lookup[$i]['Subtable'][$c]['LigSetCount'];&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $LigSetCount; $s++) {&nbsp;</div></li><li><div>                            for ($g = 0; $g &lt; $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['LigCount']; $g++) {&nbsp;</div></li><li><div>                                $replace = array();&nbsp;</div></li><li><div>                                $substitute = array();&nbsp;</div></li><li><div>                                $replace[] = $glyphs[$s];&nbsp;</div></li><li><div>                                // Flag = Ignore&nbsp;</div></li><li><div>                                if ($this-&gt;_checkGSUBignore($Lookup[$i]['Flag'], $replace[0], $Lookup[$i]['MarkFilteringSet'])) {&nbsp;</div></li><li><div>                                    continue;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                for ($l = 1; $l &lt; $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['CompCount']; $l++) {&nbsp;</div></li><li><div>                                    $gid = $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['GlyphID'][$l];&nbsp;</div></li><li><div>                                    $rpl = unicode_hex($this-&gt;glyphToChar[$gid][0]);&nbsp;</div></li><li><div>                                    // Flag = Ignore&nbsp;</div></li><li><div>                                    if ($this-&gt;_checkGSUBignore($Lookup[$i]['Flag'], $rpl, $Lookup[$i]['MarkFilteringSet'])) {&nbsp;</div></li><li><div>                                        continue 2;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                    $replace[] = $rpl;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $gid = $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['LigGlyph'];&nbsp;</div></li><li><div>                                if (!isset($this-&gt;glyphToChar[$gid][0])) {&nbsp;</div></li><li><div>                                    continue;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $substitute[] = unicode_hex($this-&gt;glyphToChar[$gid][0]);&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['subs'][] = array('Replace' =&gt; $replace, 'substitute' =&gt; $substitute, 'CompCount' =&gt; $Lookup[$i]['Subtable'][$c]['LigSet'][$s]['Ligature'][$g]['CompCount']);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 5: Contextual Substitution Subtable&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 5) {&nbsp;</div></li><li><div>                        // Format 1: Context Substitution&nbsp;</div></li><li><div>                        if ($SubstFormat == 1) {&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageGlyphs'] = $CoverageGlyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSetCount']; $s++) {&nbsp;</div></li><li><div>                                $SubRuleSet = $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s];&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['FirstGlyph'] = $CoverageGlyphs[$s];&nbsp;</div></li><li><div>                                for ($r = 0; $r &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRuleCount']; $r++) {&nbsp;</div></li><li><div>                                    $GlyphCount = $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$r]['GlyphCount'];&nbsp;</div></li><li><div>                                    for ($g = 1; $g &lt; $GlyphCount; $g++) {&nbsp;</div></li><li><div>                                        $glyphID = $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$r]['Input'][$g];&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'][$r]['InputGlyphs'][$g] = unicode_hex($this-&gt;glyphToChar[$glyphID][0]);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 2: Class-based Context Glyph Substitution&nbsp;</div></li><li><div>                        else if ($SubstFormat == 2) {&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageGlyphs'] = $CoverageGlyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $InputClasses = $this-&gt;_getClasses($Lookup[$i]['Subtable'][$c]['ClassDefOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['InputClasses'] = $InputClasses;&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['SubClassSetCnt']; $s++) {&nbsp;</div></li><li><div>                                if ($Lookup[$i]['Subtable'][$c]['SubClassSetOffset'][$s] &gt; 0) {&nbsp;</div></li><li><div>                                    $this-&gt;seek($Lookup[$i]['Subtable'][$c]['SubClassSetOffset'][$s]);&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['SubClassSet'][$s]['SubClassRuleCnt'] = $SubClassRuleCnt = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    $SubClassRule = array();&nbsp;</div></li><li><div>                                    for ($b = 0; $b &lt; $SubClassRuleCnt; $b++) {&nbsp;</div></li><li><div>                                        $SubClassRule[$b] = $Lookup[$i]['Subtable'][$c]['SubClassSetOffset'][$s] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['SubClassSet'][$s]['SubClassRule'][$b] = $SubClassRule[$b];&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['SubClassSetCnt']; $s++) {&nbsp;</div></li><li><div>                                if ($Lookup[$i]['Subtable'][$c]['SubClassSetOffset'][$s] &gt; 0) {&nbsp;</div></li><li><div>                                    $SubClassRuleCnt = $Lookup[$i]['Subtable'][$c]['SubClassSet'][$s]['SubClassRuleCnt'];&nbsp;</div></li><li><div>                                    for ($b = 0; $b &lt; $SubClassRuleCnt; $b++) {&nbsp;</div></li><li><div>                                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['SubClassSet'][$s]['SubClassRule'][$b]);&nbsp;</div></li><li><div>                                        $Rule = array();&nbsp;</div></li><li><div>                                        $Rule['InputGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Rule['SubstCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        for ($r = 1; $r &lt; $Rule['InputGlyphCount']; $r++) {&nbsp;</div></li><li><div>                                            $Rule['Input'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        for ($r = 0; $r &lt; $Rule['SubstCount']; $r++) {&nbsp;</div></li><li><div>                                            $Rule['SequenceIndex'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                            $Rule['LookupListIndex'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['SubClassSet'][$s]['SubClassRule'][$b] = $Rule;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 3: Coverage-based Context Glyph Substitution&nbsp;</div></li><li><div>                        else if ($SubstFormat == 3) {&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['InputGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageInput'][$b]);&nbsp;</div></li><li><div>                                $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageInputGlyphs'][] = implode(&quot;|&quot;, $glyphs);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            throw new MpdfException(&quot;Lookup Type 5, SubstFormat 3 not tested. Please report this with the name of font used - &quot; . $this-&gt;fontkey);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // LookupType 6: Chaining Contextual Substitution Subtable&nbsp;</div></li><li><div>                    else if ($Lookup[$i]['Type'] == 6) {&nbsp;</div></li><li><div>                        // Format 1: Simple Chaining Context Glyph Substitution  p255&nbsp;</div></li><li><div>                        if ($SubstFormat == 1) {&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageGlyphs'] = $CoverageGlyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $ChainSubRuleSetCnt = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSetCount'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $ChainSubRuleSetCnt; $s++) {&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['ChainSubRuleSetOffset'][$s]);&nbsp;</div></li><li><div>                                $ChainSubRuleCnt = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRuleCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                for ($r = 0; $r &lt; $ChainSubRuleCnt; $r++) {&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRuleOffset'][$r] = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSetOffset'][$s] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $ChainSubRuleSetCnt; $s++) {&nbsp;</div></li><li><div>                                $ChainSubRuleCnt = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRuleCount'];&nbsp;</div></li><li><div>                                for ($r = 0; $r &lt; $ChainSubRuleCnt; $r++) {&nbsp;</div></li><li><div>                                    // ChainSubRule&nbsp;</div></li><li><div>                                    $this-&gt;seek($Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRuleOffset'][$r]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $BacktrackGlyphCount = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['BacktrackGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    for ($g = 0; $g &lt; $BacktrackGlyphCount; $g++) {&nbsp;</div></li><li><div>                                        $glyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['BacktrackGlyphs'][$g] = unicode_hex($this-&gt;glyphToChar[$glyphID][0]);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $InputGlyphCount = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['InputGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    for ($g = 1; $g &lt; $InputGlyphCount; $g++) {&nbsp;</div></li><li><div>                                        $glyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['InputGlyphs'][$g] = unicode_hex($this-&gt;glyphToChar[$glyphID][0]);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $LookaheadGlyphCount = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['LookaheadGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    for ($g = 0; $g &lt; $LookaheadGlyphCount; $g++) {&nbsp;</div></li><li><div>                                        $glyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['LookaheadGlyphs'][$g] = unicode_hex($this-&gt;glyphToChar[$glyphID][0]);&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    $SubstCount = $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['SubstCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    for ($lu = 0; $lu &lt; $SubstCount; $lu++) {&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['SequenceIndex'][$lu] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'][$r]['LookupListIndex'][$lu] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 2: Class-based Chaining Context Glyph Substitution  p257&nbsp;</div></li><li><div>                        else if ($SubstFormat == 2) {&nbsp;</div></li><li><div>                            $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageTableOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['CoverageGlyphs'] = $CoverageGlyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $BacktrackClasses = $this-&gt;_getClasses($Lookup[$i]['Subtable'][$c]['BacktrackClassDefOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['BacktrackClasses'] = $BacktrackClasses;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $InputClasses = $this-&gt;_getClasses($Lookup[$i]['Subtable'][$c]['InputClassDefOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['InputClasses'] = $InputClasses;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $LookaheadClasses = $this-&gt;_getClasses($Lookup[$i]['Subtable'][$c]['LookaheadClassDefOffset']);&nbsp;</div></li><li><div>                            $Lookup[$i]['Subtable'][$c]['LookaheadClasses'] = $LookaheadClasses;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['ChainSubClassSetCnt']; $s++) {&nbsp;</div></li><li><div>                                if ($Lookup[$i]['Subtable'][$c]['ChainSubClassSetOffset'][$s] &gt; 0) {&nbsp;</div></li><li><div>                                    $this-&gt;seek($Lookup[$i]['Subtable'][$c]['ChainSubClassSetOffset'][$s]);&nbsp;</div></li><li><div>                                    $Lookup[$i]['Subtable'][$c]['ChainSubClassSet'][$s]['ChainSubClassRuleCnt'] = $ChainSubClassRuleCnt = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                    $ChainSubClassRule = array();&nbsp;</div></li><li><div>                                    for ($b = 0; $b &lt; $ChainSubClassRuleCnt; $b++) {&nbsp;</div></li><li><div>                                        $ChainSubClassRule[$b] = $Lookup[$i]['Subtable'][$c]['ChainSubClassSetOffset'][$s] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubClassSet'][$s]['ChainSubClassRule'][$b] = $ChainSubClassRule[$b];&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['ChainSubClassSetCnt']; $s++) {&nbsp;</div></li><li><div>                                if (isset($Lookup[$i]['Subtable'][$c]['ChainSubClassSet'][$s]['ChainSubClassRuleCnt'])) {&nbsp;</div></li><li><div>                                    $ChainSubClassRuleCnt = $Lookup[$i]['Subtable'][$c]['ChainSubClassSet'][$s]['ChainSubClassRuleCnt'];&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $ChainSubClassRuleCnt = 0;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                for ($b = 0; $b &lt; $ChainSubClassRuleCnt; $b++) {&nbsp;</div></li><li><div>                                    if ($Lookup[$i]['Subtable'][$c]['ChainSubClassSetOffset'][$s] &gt; 0) {&nbsp;</div></li><li><div>                                        $this-&gt;seek($Lookup[$i]['Subtable'][$c]['ChainSubClassSet'][$s]['ChainSubClassRule'][$b]);&nbsp;</div></li><li><div>                                        $Rule = array();&nbsp;</div></li><li><div>                                        $Rule['BacktrackGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        for ($r = 0; $r &lt; $Rule['BacktrackGlyphCount']; $r++) {&nbsp;</div></li><li><div>                                            $Rule['Backtrack'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        $Rule['InputGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        for ($r = 1; $r &lt; $Rule['InputGlyphCount']; $r++) {&nbsp;</div></li><li><div>                                            $Rule['Input'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        $Rule['LookaheadGlyphCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        for ($r = 0; $r &lt; $Rule['LookaheadGlyphCount']; $r++) {&nbsp;</div></li><li><div>                                            $Rule['Lookahead'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        $Rule['SubstCount'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        for ($r = 0; $r &lt; $Rule['SubstCount']; $r++) {&nbsp;</div></li><li><div>                                            $Rule['SequenceIndex'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                            $Rule['LookupListIndex'][$r] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        $Lookup[$i]['Subtable'][$c]['ChainSubClassSet'][$s]['ChainSubClassRule'][$b] = $Rule;&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format 3: Coverage-based Chaining Context Glyph Substitution  p259&nbsp;</div></li><li><div>                        else if ($SubstFormat == 3) {&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['BacktrackGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageBacktrack'][$b]);&nbsp;</div></li><li><div>                                $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageBacktrackGlyphs'][] = implode(&quot;|&quot;, $glyphs);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['InputGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageInput'][$b]);&nbsp;</div></li><li><div>                                $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageInputGlyphs'][] = implode(&quot;|&quot;, $glyphs);&nbsp;</div></li><li><div>                                // Don't use above value as these are ordered numerically not as need to process&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['LookaheadGlyphCount']; $b++) {&nbsp;</div></li><li><div>                                $this-&gt;seek($Lookup[$i]['Subtable'][$c]['CoverageLookahead'][$b]);&nbsp;</div></li><li><div>                                $glyphs = $this-&gt;_getCoverage();&nbsp;</div></li><li><div>                                $Lookup[$i]['Subtable'][$c]['CoverageLookaheadGlyphs'][] = implode(&quot;|&quot;, $glyphs);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $GSUBScriptLang = array();&nbsp;</div></li><li><div>            $rtlpua = array(); // All glyphs added to PUA [for magic_reverse]&nbsp;</div></li><li><div>            foreach ($gsub AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $langsys) {&nbsp;</div></li><li><div>                    $lul = array(); // array of LookupListIndexes&nbsp;</div></li><li><div>                    $tags = array(); // corresponding array of feature tags e.g. 'ccmp'&nbsp;</div></li><li><div>//print_r($langsys ); exit;&nbsp;</div></li><li><div>                    foreach ($langsys AS $tag =&gt; $ft) {&nbsp;</div></li><li><div>                        foreach ($ft AS $ll) {&nbsp;</div></li><li><div>                            $lul[$ll] = $tag;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    ksort($lul); // Order the Lookups in the order they are in the GUSB table, regardless of Feature order&nbsp;</div></li><li><div>                    $volt = $this-&gt;_getGSUBarray($Lookup, $lul, $st);&nbsp;</div></li><li><div>//print_r($lul); exit;&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    // Interrogate $volt&nbsp;</div></li><li><div>                    // isol, fin, medi, init(arab syrc) into $rtlSUB for use in ArabJoin&nbsp;</div></li><li><div>                    // but also identify all RTL chars in PUA for magic_reverse (arab syrc hebr thaa nko  samr)&nbsp;</div></li><li><div>                    // identify reph, matras, vatu, half forms etc for Indic for final re-ordering&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    $rtl = array();&nbsp;</div></li><li><div>                    $rtlSUB = &quot;array()&quot;;&nbsp;</div></li><li><div>                    $finals = '';&nbsp;</div></li><li><div>                    if (strpos('arab syrc hebr thaa nko  samr', $st) !== false) { // all RTL scripts [any/all languages] ? Mandaic&nbsp;</div></li><li><div>//print_r($volt); exit;&nbsp;</div></li><li><div>                        foreach ($volt AS $v) {&nbsp;</div></li><li><div>                            // isol fina fin2 fin3 medi med2 for Syriac&nbsp;</div></li><li><div>                            // ISOLATED FORM :: FINAL :: INITIAL :: MEDIAL :: MED2 :: FIN2 :: FIN3&nbsp;</div></li><li><div>                            if (strpos('isol fina init medi fin2 fin3 med2', $v['tag']) !== false) {&nbsp;</div></li><li><div>                                $key = $v['match'];&nbsp;</div></li><li><div>                                $key = preg_replace('/[\(\)]*/', '', $key);&nbsp;</div></li><li><div>                                $sub = $v['replace'];&nbsp;</div></li><li><div>                                if ($v['tag'] == 'isol')&nbsp;</div></li><li><div>                                    $kk = 0;&nbsp;</div></li><li><div>                                else if ($v['tag'] == 'fina')&nbsp;</div></li><li><div>                                    $kk = 1;&nbsp;</div></li><li><div>                                else if ($v['tag'] == 'init')&nbsp;</div></li><li><div>                                    $kk = 2;&nbsp;</div></li><li><div>                                else if ($v['tag'] == 'medi')&nbsp;</div></li><li><div>                                    $kk = 3;&nbsp;</div></li><li><div>                                else if ($v['tag'] == 'med2')&nbsp;</div></li><li><div>                                    $kk = 4;&nbsp;</div></li><li><div>                                else if ($v['tag'] == 'fin2')&nbsp;</div></li><li><div>                                    $kk = 5;&nbsp;</div></li><li><div>                                else if ($v['tag'] == 'fin3')&nbsp;</div></li><li><div>                                    $kk = 6;&nbsp;</div></li><li><div>                                $rtl[$key][$kk] = $sub;&nbsp;</div></li><li><div>                                if (isset($v['prel']) && count($v['prel']))&nbsp;</div></li><li><div>                                    $rtl[$key]['prel'][$kk] = $v['prel'];&nbsp;</div></li><li><div>                                if (isset($v['postl']) && count($v['postl']))&nbsp;</div></li><li><div>                                    $rtl[$key]['postl'][$kk] = $v['postl'];&nbsp;</div></li><li><div>                                if (isset($v['ignore']) && $v['ignore']) {&nbsp;</div></li><li><div>                                    $rtl[$key]['ignore'][$kk] = $v['ignore'];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $rtlpua[] = $sub;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                            // Add any other glyphs which are in PUA&nbsp;</div></li><li><div>                            else {&nbsp;</div></li><li><div>                                if (isset($v['context']) && $v['context']) {&nbsp;</div></li><li><div>                                    foreach ($v['rules'] AS $vs) {&nbsp;</div></li><li><div>                                        for ($i = 0; $i &lt; count($vs['match']); $i++) {&nbsp;</div></li><li><div>                                            if (isset($vs['replace'][$i]) && preg_match('/^0[A-F0-9]{4}$/', $vs['match'][$i])) {&nbsp;</div></li><li><div>                                                if (preg_match('/^0[EF][A-F0-9]{3}$/', $vs['replace'][$i])) {&nbsp;</div></li><li><div>                                                    $rtlpua[] = $vs['replace'][$i];&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    preg_match_all('/\((0[A-F0-9]{4})\)/', $v['match'], $m);&nbsp;</div></li><li><div>                                    for ($i = 0; $i &lt; count($m[0]); $i++) {&nbsp;</div></li><li><div>                                        $sb = explode(' ', $v['replace']);&nbsp;</div></li><li><div>                                        foreach ($sb AS $sbg) {&nbsp;</div></li><li><div>                                            if (preg_match('/(0[EF][A-F0-9]{3})/', $sbg, $mr)) {&nbsp;</div></li><li><div>                                                $rtlpua[] = $mr[1];&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>//print_r($rtl); exit;&nbsp;</div></li><li><div>                        // For kashida, need to determine all final forms except ones already identified by kashida&nbsp;</div></li><li><div>                        // priority rules (see otl.php)&nbsp;</div></li><li><div>                        foreach ($rtl AS $base =&gt; $variants) {&nbsp;</div></li><li><div>                            if (isset($variants[1])) { // i.e. final form&nbsp;</div></li><li><div>                                if (strpos('0FE8E 0FE94 0FEA2 0FEAA 0FEAE 0FEC2 0FEDA 0FEDE 0FB93 0FECA 0FED2 0FED6 0FEEE 0FEF0 0FEF2', $variants[1]) === false) { // not already included&nbsp;</div></li><li><div>                                    // This version does not exclude RA (0631) FEAE; Ya (064A)  FEF2; Alef Maqsurah (0649) FEF0 which&nbsp;</div></li><li><div>                                    // are selected in priority if connected to a medial Bah&nbsp;</div></li><li><div>                                    //if (strpos('0FE8E 0FE94 0FEA2 0FEAA 0FEC2 0FEDA 0FEDE 0FB93 0FECA 0FED2 0FED6 0FEEE', $variants[1])===false) {    // not already included&nbsp;</div></li><li><div>                                    $finals .= $variants[1] . ' ';&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>//echo $finals ; exit;&nbsp;</div></li><li><div>//print_r($rtlpua); exit;&nbsp;</div></li><li><div>                        ksort($rtl);&nbsp;</div></li><li><div>                        $a = var_export($rtl, true);&nbsp;</div></li><li><div>                        $a = preg_replace('/\\\\\\\\/', &quot;\\&quot;, $a);&nbsp;</div></li><li><div>                        $a = preg_replace('/\'/', '&quot;', $a);&nbsp;</div></li><li><div>                        $a = preg_replace('/\r/', '', $a);&nbsp;</div></li><li><div>                        $a = preg_replace('/&gt; \n/', '&gt;', $a);&nbsp;</div></li><li><div>                        $a = preg_replace('/\n  \)/', ')', $a);&nbsp;</div></li><li><div>                        $a = preg_replace('/\n    /', ' ', $a);&nbsp;</div></li><li><div>                        $a = preg_replace('/\[IGNORE(\d+)\]/', '&quot;.$ignore[\\1].&quot;', $a);&nbsp;</div></li><li><div>                        $rtlSUB = preg_replace('/[ ]+/', ' ', $a);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    // INDIC - Dynamic properties&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    $rphf = array();&nbsp;</div></li><li><div>                    $half = array();&nbsp;</div></li><li><div>                    $pref = array();&nbsp;</div></li><li><div>                    $blwf = array();&nbsp;</div></li><li><div>                    $pstf = array();&nbsp;</div></li><li><div>                    if (strpos('dev2 bng2 gur2 gjr2 ory2 tml2 tel2 knd2 mlm2 deva beng guru gujr orya taml telu knda mlym', $st) !== false) { // all INDIC scripts [any/all languages]&nbsp;</div></li><li><div>                        if (strpos('deva beng guru gujr orya taml telu knda mlym', $st) !== false) {&nbsp;</div></li><li><div>                            $is_old_spec = true;&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $is_old_spec = false;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // First get 'locl' substitutions (reversed!)&nbsp;</div></li><li><div>                        $loclsubs = array();&nbsp;</div></li><li><div>                        foreach ($volt AS $v) {&nbsp;</div></li><li><div>                            if (strpos('locl', $v['tag']) !== false) {&nbsp;</div></li><li><div>                                $key = $v['match'];&nbsp;</div></li><li><div>                                $key = preg_replace('/[\(\)]*/', '', $key);&nbsp;</div></li><li><div>                                $sub = $v['replace'];&nbsp;</div></li><li><div>                                if ($key && strlen(trim($key)) == 5 && $sub) {&nbsp;</div></li><li><div>                                    $loclsubs[$sub] = $key;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>//if (count($loclsubs)) { print_r($loclsubs); exit; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        foreach ($volt AS $v) {&nbsp;</div></li><li><div>                            // &lt;rphf&gt; &lt;half&gt; &lt;pref&gt; &lt;blwf&gt; &lt;pstf&gt;&nbsp;</div></li><li><div>                            // defines consonant types:&nbsp;</div></li><li><div>                            //     Reph &lt;rphf&gt;&nbsp;</div></li><li><div>                            //     Half forms &lt;half&gt;&nbsp;</div></li><li><div>                            //     Pre-base-reordering forms of Ra/Rra &lt;pref&gt;&nbsp;</div></li><li><div>                            //     Below-base forms &lt;blwf&gt;&nbsp;</div></li><li><div>                            //     Post-base forms &lt;pstf&gt;&nbsp;</div></li><li><div>                            // applied together with &lt;locl&gt; feature to input sequences consisting of two characters&nbsp;</div></li><li><div>                            // This is done for each consonant&nbsp;</div></li><li><div>                            // for &lt;rphf&gt; and &lt;half&gt;, features are applied to Consonant + Halant combinations&nbsp;</div></li><li><div>                            // for &lt;pref&gt;, &lt;blwf&gt; and &lt;pstf&gt;, features are applied to Halant + Consonant combinations&nbsp;</div></li><li><div>                            // Old version eg 'deva' &lt;pref&gt;, &lt;blwf&gt; and &lt;pstf&gt;, features are applied to Consonant + Halant&nbsp;</div></li><li><div>                            // Some malformed fonts still do Consonant + Halant for these - so match both??&nbsp;</div></li><li><div>                            // If these two glyphs form a ligature, with no additional glyphs in context&nbsp;</div></li><li><div>                            // this means the consonant has the corresponding form&nbsp;</div></li><li><div>                            // Currently set to cope with both&nbsp;</div></li><li><div>                            // See also classes/otl.php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if (strpos('rphf half pref blwf pstf', $v['tag']) !== false) {&nbsp;</div></li><li><div>                                if (isset($v['context']) && $v['context'] && $v['nBacktrack'] == 0 && $v['nLookahead'] == 0) {&nbsp;</div></li><li><div>                                    foreach ($v['rules'] AS $vs) {&nbsp;</div></li><li><div>                                        if (count($vs['match']) == 2 && count($vs['replace']) == 1) {&nbsp;</div></li><li><div>                                            $sub = $vs['replace'][0];&nbsp;</div></li><li><div>                                            // If Halant Cons   &lt;pref&gt;, &lt;blwf&gt; and &lt;pstf&gt; in New version only&nbsp;</div></li><li><div>                                            if (strpos('0094D 009CD 00A4D 00ACD 00B4D 00BCD 00C4D 00CCD 00D4D', $vs['match'][0]) !== false && strpos('pref blwf pstf', $v['tag']) !== false && !$is_old_spec) {&nbsp;</div></li><li><div>                                                $key = $vs['match'][1];&nbsp;</div></li><li><div>                                                $tag = $v['tag'];&nbsp;</div></li><li><div>                                                if (isset($loclsubs[$key])) {&nbsp;</div></li><li><div>                                                    $$tag[$loclsubs[$key]] = $sub;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                                $tmp = &$$tag;&nbsp;</div></li><li><div>                                                $tmp[hexdec($key)] = hexdec($sub);&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                            // If Cons Halant    &lt;rphf&gt; and &lt;half&gt; always&nbsp;</div></li><li><div>                                            // and &lt;pref&gt;, &lt;blwf&gt; and &lt;pstf&gt; in Old version&nbsp;</div></li><li><div>                                            else if (strpos('0094D 009CD 00A4D 00ACD 00B4D 00BCD 00C4D 00CCD 00D4D', $vs['match'][1]) !== false && (strpos('rphf half', $v['tag']) !== false || (strpos('pref blwf pstf', $v['tag']) !== false && ($is_old_spec || _OTL_OLD_SPEC_COMPAT_2)))) {&nbsp;</div></li><li><div>                                                $key = $vs['match'][0];&nbsp;</div></li><li><div>                                                $tag = $v['tag'];&nbsp;</div></li><li><div>                                                if (isset($loclsubs[$key])) {&nbsp;</div></li><li><div>                                                    $$tag[$loclsubs[$key]] = $sub;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                                $tmp = &$$tag;&nbsp;</div></li><li><div>                                                $tmp[hexdec($key)] = hexdec($sub);&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else if (!isset($v['context'])) {&nbsp;</div></li><li><div>                                    $key = $v['match'];&nbsp;</div></li><li><div>                                    $key = preg_replace('/[\(\)]*/', '', $key);&nbsp;</div></li><li><div>                                    $sub = $v['replace'];&nbsp;</div></li><li><div>                                    if ($key && strlen(trim($key)) == 11 && $sub) {&nbsp;</div></li><li><div>                                        // If Cons Halant    &lt;rphf&gt; and &lt;half&gt; always&nbsp;</div></li><li><div>                                        // and &lt;pref&gt;, &lt;blwf&gt; and &lt;pstf&gt; in Old version&nbsp;</div></li><li><div>                                        // If Halant Cons   &lt;pref&gt;, &lt;blwf&gt; and &lt;pstf&gt; in New version only&nbsp;</div></li><li><div>                                        if (strpos('0094D 009CD 00A4D 00ACD 00B4D 00BCD 00C4D 00CCD 00D4D', substr($key, 0, 5)) !== false && strpos('pref blwf pstf', $v['tag']) !== false && !$is_old_spec) {&nbsp;</div></li><li><div>                                            $key = substr($key, 6, 5);&nbsp;</div></li><li><div>                                            $tag = $v['tag'];&nbsp;</div></li><li><div>                                            if (isset($loclsubs[$key])) {&nbsp;</div></li><li><div>                                                $$tag[$loclsubs[$key]] = $sub;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                            $tmp = &$$tag;&nbsp;</div></li><li><div>                                            $tmp[hexdec($key)] = hexdec($sub);&nbsp;</div></li><li><div>                                        } else if (strpos('0094D 009CD 00A4D 00ACD 00B4D 00BCD 00C4D 00CCD 00D4D', substr($key, 6, 5)) !== false && (strpos('rphf half', $v['tag']) !== false || (strpos('pref blwf pstf', $v['tag']) !== false && ($is_old_spec || _OTL_OLD_SPEC_COMPAT_2)))) {&nbsp;</div></li><li><div>                                            $key = substr($key, 0, 5);&nbsp;</div></li><li><div>                                            $tag = $v['tag'];&nbsp;</div></li><li><div>                                            if (isset($loclsubs[$key])) {&nbsp;</div></li><li><div>                                                $$tag[$loclsubs[$key]] = $sub;&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                            $tmp = &$$tag;&nbsp;</div></li><li><div>                                            $tmp[hexdec($key)] = hexdec($sub);&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        /**&nbsp;</div></li><li><div>                          print_r($rphf );&nbsp;</div></li><li><div>                          print_r($half );&nbsp;</div></li><li><div>                          print_r($pref );&nbsp;</div></li><li><div>                          print_r($blwf );&nbsp;</div></li><li><div>                          print_r($pstf ); exit;&nbsp;</div></li><li><div>                         */&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>//print_r($rtlpua); exit;&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    if (count($rtl) || count($rphf) || count($half) || count($pref) || count($blwf) || count($pstf) || $finals) {&nbsp;</div></li><li><div>                        // SAVE LOOKUPS TO FILE fontname.GSUB.scripttag.langtag.php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $s = '&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$rtlSUB = ' . $rtlSUB . ';&nbsp;</div></li><li><div>$finals = \'' . $finals . '\';&nbsp;</div></li><li><div>$rphf = ' . var_export($rphf, true) . ';&nbsp;</div></li><li><div>$half = ' . var_export($half, true) . ';&nbsp;</div></li><li><div>$pref = ' . var_export($pref, true) . ';&nbsp;</div></li><li><div>$blwf = ' . var_export($blwf, true) . ';&nbsp;</div></li><li><div>$pstf = ' . var_export($pstf, true) . ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ' . &quot;\n&quot; . '?&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        file_put_contents(_MPDF_TTFONTDATAPATH . $this-&gt;fontkey . '.GSUB.' . $st . '.' . $t . '.php', $s);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                    if (!isset($GSUBScriptLang[$st])) {&nbsp;</div></li><li><div>                        $GSUBScriptLang[$st] = '';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $GSUBScriptLang[$st] .= $t . ' ';&nbsp;</div></li><li><div>                    //=====================================================================================&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //print_r($rtlpua); exit;&nbsp;</div></li><li><div>            // All RTL glyphs from font added to (or already in) PUA [reqd for magic_reverse]&nbsp;</div></li><li><div>            $rtlPUAstr = &quot;&quot;;&nbsp;</div></li><li><div>            if (count($rtlpua)) {&nbsp;</div></li><li><div>                $rtlpua = array_unique($rtlpua);&nbsp;</div></li><li><div>                sort($rtlpua);&nbsp;</div></li><li><div>                $n = count($rtlpua);&nbsp;</div></li><li><div>                for ($i = 0; $i &lt; $n; $i++) {&nbsp;</div></li><li><div>                    if (hexdec($rtlpua[$i]) &lt; hexdec('E000') || hexdec($rtlpua[$i]) &gt; hexdec('F8FF')) {&nbsp;</div></li><li><div>                        unset($rtlpua[$i]);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                sort($rtlpua, SORT_STRING);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $rangeid = -1;&nbsp;</div></li><li><div>                $range = array();&nbsp;</div></li><li><div>                $prevgid = -2;&nbsp;</div></li><li><div>                // for each character&nbsp;</div></li><li><div>                foreach ($rtlpua as $gidhex) {&nbsp;</div></li><li><div>                    $gid = hexdec($gidhex);&nbsp;</div></li><li><div>                    if ($gid == ($prevgid + 1)) {&nbsp;</div></li><li><div>                        $range[$rangeid]['end'] = $gidhex;&nbsp;</div></li><li><div>                        $range[$rangeid]['count'] ++;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        // new range&nbsp;</div></li><li><div>                        $rangeid++;&nbsp;</div></li><li><div>                        $range[$rangeid] = array();&nbsp;</div></li><li><div>                        $range[$rangeid]['start'] = $gidhex;&nbsp;</div></li><li><div>                        $range[$rangeid]['end'] = $gidhex;&nbsp;</div></li><li><div>                        $range[$rangeid]['count'] = 1;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $prevgid = $gid;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                foreach ($range AS $rg) {&nbsp;</div></li><li><div>                    if ($rg['count'] == 1) {&nbsp;</div></li><li><div>                        $rtlPUAstr .= &quot;\x{&quot; . $rg['start'] . &quot;}&quot;;&nbsp;</div></li><li><div>                    } else if ($rg['count'] == 2) {&nbsp;</div></li><li><div>                        $rtlPUAstr .= &quot;\x{&quot; . $rg['start'] . &quot;}\x{&quot; . $rg['end'] . &quot;}&quot;;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $rtlPUAstr .= &quot;\x{&quot; . $rg['start'] . &quot;}-\x{&quot; . $rg['end'] . &quot;}&quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //print_r($rtlPUAstr ); exit;&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            //print_r($rtlpua); exit;&nbsp;</div></li><li><div>            //print_r($GSUBScriptLang); exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>//print_r($Lookup); exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array($GSUBScriptLang, $gsub, $GSLookup, $rtlPUAstr); // , $rtlPUAarr Not needed&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /////////////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    // GSUB functions&nbsp;</div></li><li><div>    function _getGSUBarray(&$Lookup, &$lul, $scripttag)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // Process (3) LookupList for specific Script-LangSys&nbsp;</div></li><li><div>        // Generate preg_replace&nbsp;</div></li><li><div>        $volt = array();&nbsp;</div></li><li><div>        $reph = '';&nbsp;</div></li><li><div>        $matraE = '';&nbsp;</div></li><li><div>        $vatu = '';&nbsp;</div></li><li><div>        foreach ($lul AS $i =&gt; $tag) {&nbsp;</div></li><li><div>            for ($c = 0; $c &lt; $Lookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $SubstFormat = $Lookup[$i]['Subtable'][$c]['Format'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // LookupType 1: Single Substitution Subtable&nbsp;</div></li><li><div>                if ($Lookup[$i]['Type'] == 1) {&nbsp;</div></li><li><div>                    for ($s = 0; $s &lt; count($Lookup[$i]['Subtable'][$c]['subs']); $s++) {&nbsp;</div></li><li><div>                        $inputGlyphs = $Lookup[$i]['Subtable'][$c]['subs'][$s]['Replace'];&nbsp;</div></li><li><div>                        $substitute = $Lookup[$i]['Subtable'][$c]['subs'][$s]['substitute'][0];&nbsp;</div></li><li><div>                        // Ignore has already been applied earlier on&nbsp;</div></li><li><div>                        $repl = $this-&gt;_makeGSUBinputMatch($inputGlyphs, &quot;()&quot;);&nbsp;</div></li><li><div>                        $subs = $this-&gt;_makeGSUBinputReplacement(1, $substitute, &quot;()&quot;, 0, 1, 0);&nbsp;</div></li><li><div>                        $volt[] = array('match' =&gt; $repl, 'replace' =&gt; $subs, 'tag' =&gt; $tag, 'key' =&gt; $inputGlyphs[0], 'type' =&gt; 1);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // LookupType 2: Multiple Substitution Subtable&nbsp;</div></li><li><div>                else if ($Lookup[$i]['Type'] == 2) {&nbsp;</div></li><li><div>                    for ($s = 0; $s &lt; count($Lookup[$i]['Subtable'][$c]['subs']); $s++) {&nbsp;</div></li><li><div>                        $inputGlyphs = $Lookup[$i]['Subtable'][$c]['subs'][$s]['Replace'];&nbsp;</div></li><li><div>                        $substitute = implode(&quot; &quot;, $Lookup[$i]['Subtable'][$c]['subs'][$s]['substitute']);&nbsp;</div></li><li><div>                        // Ignore has already been applied earlier on&nbsp;</div></li><li><div>                        $repl = $this-&gt;_makeGSUBinputMatch($inputGlyphs, &quot;()&quot;);&nbsp;</div></li><li><div>                        $subs = $this-&gt;_makeGSUBinputReplacement(1, $substitute, &quot;()&quot;, 0, 1, 0);&nbsp;</div></li><li><div>                        $volt[] = array('match' =&gt; $repl, 'replace' =&gt; $subs, 'tag' =&gt; $tag, 'key' =&gt; $inputGlyphs[0], 'type' =&gt; 2);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // LookupType 3: Alternate Forms&nbsp;</div></li><li><div>                else if ($Lookup[$i]['Type'] == 3) {&nbsp;</div></li><li><div>                    for ($s = 0; $s &lt; count($Lookup[$i]['Subtable'][$c]['subs']); $s++) {&nbsp;</div></li><li><div>                        $inputGlyphs = $Lookup[$i]['Subtable'][$c]['subs'][$s]['Replace'];&nbsp;</div></li><li><div>                        $substitute = $Lookup[$i]['Subtable'][$c]['subs'][$s]['substitute'][0];&nbsp;</div></li><li><div>                        // Ignore has already been applied earlier on&nbsp;</div></li><li><div>                        $repl = $this-&gt;_makeGSUBinputMatch($inputGlyphs, &quot;()&quot;);&nbsp;</div></li><li><div>                        $subs = $this-&gt;_makeGSUBinputReplacement(1, $substitute, &quot;()&quot;, 0, 1, 0);&nbsp;</div></li><li><div>                        $volt[] = array('match' =&gt; $repl, 'replace' =&gt; $subs, 'tag' =&gt; $tag, 'key' =&gt; $inputGlyphs[0], 'type' =&gt; 3);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // LookupType 4: Ligature Substitution Subtable&nbsp;</div></li><li><div>                else if ($Lookup[$i]['Type'] == 4) {&nbsp;</div></li><li><div>                    for ($s = 0; $s &lt; count($Lookup[$i]['Subtable'][$c]['subs']); $s++) {&nbsp;</div></li><li><div>                        $inputGlyphs = $Lookup[$i]['Subtable'][$c]['subs'][$s]['Replace'];&nbsp;</div></li><li><div>                        $substitute = $Lookup[$i]['Subtable'][$c]['subs'][$s]['substitute'][0];&nbsp;</div></li><li><div>                        // Ignore has already been applied earlier on&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        $repl = $this-&gt;_makeGSUBinputMatch($inputGlyphs, $ignore);&nbsp;</div></li><li><div>                        $subs = $this-&gt;_makeGSUBinputReplacement(count($inputGlyphs), $substitute, $ignore, 0, count($inputGlyphs), 0);&nbsp;</div></li><li><div>                        $volt[] = array('match' =&gt; $repl, 'replace' =&gt; $subs, 'tag' =&gt; $tag, 'key' =&gt; $inputGlyphs[0], 'type' =&gt; 4, 'CompCount' =&gt; $Lookup[$i]['Subtable'][$c]['subs'][$s]['CompCount'], 'Lig' =&gt; $substitute);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // LookupType 5: Chaining Contextual Substitution Subtable&nbsp;</div></li><li><div>                else if ($Lookup[$i]['Type'] == 5) {&nbsp;</div></li><li><div>                    // Format 1: Context Substitution&nbsp;</div></li><li><div>                    if ($SubstFormat == 1) {&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['SubRuleSetCount']; $s++) {&nbsp;</div></li><li><div>                            // SubRuleSet&nbsp;</div></li><li><div>                            $subRule = array();&nbsp;</div></li><li><div>                            foreach ($Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['SubRule'] AS $rule) {&nbsp;</div></li><li><div>                                // SubRule&nbsp;</div></li><li><div>                                $inputGlyphs = array();&nbsp;</div></li><li><div>                                if ($rule['GlyphCount'] &gt; 1) {&nbsp;</div></li><li><div>                                    $inputGlyphs = $rule['InputGlyphs'];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $inputGlyphs[0] = $Lookup[$i]['Subtable'][$c]['SubRuleSet'][$s]['FirstGlyph'];&nbsp;</div></li><li><div>                                ksort($inputGlyphs);&nbsp;</div></li><li><div>                                $nInput = count($inputGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, array(), 0);&nbsp;</div></li><li><div>                                $subRule = array('context' =&gt; 1, 'tag' =&gt; $tag, 'matchback' =&gt; '', 'match' =&gt; $contextInputMatch, 'nBacktrack' =&gt; 0, 'nInput' =&gt; $nInput, 'nLookahead' =&gt; 0, 'rules' =&gt; array(), );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                for ($b = 0; $b &lt; $rule['SubstCount']; $b++) {&nbsp;</div></li><li><div>                                    $lup = $rule['SubstLookupRecord'][$b]['LookupListIndex'];&nbsp;</div></li><li><div>                                    $seqIndex = $rule['SubstLookupRecord'][$b]['SequenceIndex'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // $Lookup[$lup] = secondary Lookup&nbsp;</div></li><li><div>                                    for ($lus = 0; $lus &lt; $Lookup[$lup]['SubtableCount']; $lus++) {&nbsp;</div></li><li><div>                                        if (count($Lookup[$lup]['Subtable'][$lus]['subs'])) {&nbsp;</div></li><li><div>                                            foreach ($Lookup[$lup]['Subtable'][$lus]['subs'] AS $luss) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                $lookupGlyphs = $luss['Replace'];&nbsp;</div></li><li><div>                                                $mLen = count($lookupGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Only apply if the (first) 'Replace' glyph from the&nbsp;</div></li><li><div>                                                // Lookup list is in the [inputGlyphs] at ['SequenceIndex']&nbsp;</div></li><li><div>                                                // then apply the substitution&nbsp;</div></li><li><div>                                                if (strpos($inputGlyphs[$seqIndex], $lookupGlyphs[0]) === false) {&nbsp;</div></li><li><div>                                                    continue;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                                $REPL = implode(&quot; &quot;, $luss['substitute']);&nbsp;</div></li><li><div>                                                if (strpos(&quot;isol fina fin2 fin3 medi med2 init &quot;, $tag) !== false && $scripttag == 'arab') {&nbsp;</div></li><li><div>                                                    $volt[] = array('match' =&gt; $lookupGlyphs[0], 'replace' =&gt; $REPL, 'tag' =&gt; $tag, 'prel' =&gt; $backtrackGlyphs, 'postl' =&gt; $lookaheadGlyphs, 'ignore' =&gt; $ignore);&nbsp;</div></li><li><div>                                                } else {&nbsp;</div></li><li><div>                                                    $subRule['rules'][] = array('type' =&gt; $Lookup[$lup]['Type'], 'match' =&gt; $lookupGlyphs, 'replace' =&gt; $luss['substitute'], 'seqIndex' =&gt; $seqIndex, 'key' =&gt; $lookupGlyphs[0], );&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if (count($subRule['rules']))&nbsp;</div></li><li><div>                                    $volt[] = $subRule;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // Format 2: Class-based Context Glyph Substitution&nbsp;</div></li><li><div>                    else if ($SubstFormat == 2) {&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        foreach ($Lookup[$i]['Subtable'][$c]['SubClassSet'] AS $inputClass =&gt; $cscs) {&nbsp;</div></li><li><div>                            for ($cscrule = 0; $cscrule &lt; $cscs['SubClassRuleCnt']; $cscrule++) {&nbsp;</div></li><li><div>                                $rule = $cscs['SubClassRule'][$cscrule];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $inputGlyphs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $inputGlyphs[0] = $Lookup[$i]['Subtable'][$c]['InputClasses'][$inputClass];&nbsp;</div></li><li><div>                                if ($rule['InputGlyphCount'] &gt; 1) {&nbsp;</div></li><li><div>                                    //  NB starts at 1&nbsp;</div></li><li><div>                                    for ($gcl = 1; $gcl &lt; $rule['InputGlyphCount']; $gcl++) {&nbsp;</div></li><li><div>                                        $classindex = $rule['Input'][$gcl];&nbsp;</div></li><li><div>                                        if (isset($Lookup[$i]['Subtable'][$c]['InputClasses'][$classindex])) {&nbsp;</div></li><li><div>                                            $inputGlyphs[$gcl] = $Lookup[$i]['Subtable'][$c]['InputClasses'][$classindex];&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        // if class[0] = all glyphs excluding those specified in all other classes&nbsp;</div></li><li><div>                                        // set to blank '' for now&nbsp;</div></li><li><div>                                        else {&nbsp;</div></li><li><div>                                            $inputGlyphs[$gcl] = '';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $nInput = $rule['InputGlyphCount'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $nIsubs = (2 * $nInput) - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, array(), 0);&nbsp;</div></li><li><div>                                $subRule = array('context' =&gt; 1, 'tag' =&gt; $tag, 'matchback' =&gt; '', 'match' =&gt; $contextInputMatch, 'nBacktrack' =&gt; 0, 'nInput' =&gt; $nInput, 'nLookahead' =&gt; 0, 'rules' =&gt; array(), );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                for ($b = 0; $b &lt; $rule['SubstCount']; $b++) {&nbsp;</div></li><li><div>                                    $lup = $rule['LookupListIndex'][$b];&nbsp;</div></li><li><div>                                    $seqIndex = $rule['SequenceIndex'][$b];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // $Lookup[$lup] = secondary Lookup&nbsp;</div></li><li><div>                                    for ($lus = 0; $lus &lt; $Lookup[$lup]['SubtableCount']; $lus++) {&nbsp;</div></li><li><div>                                        if (isset($Lookup[$lup]['Subtable'][$lus]['subs']) && count($Lookup[$lup]['Subtable'][$lus]['subs'])) {&nbsp;</div></li><li><div>                                            foreach ($Lookup[$lup]['Subtable'][$lus]['subs'] AS $luss) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                $lookupGlyphs = $luss['Replace'];&nbsp;</div></li><li><div>                                                $mLen = count($lookupGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Only apply if the (first) 'Replace' glyph from the&nbsp;</div></li><li><div>                                                // Lookup list is in the [inputGlyphs] at ['SequenceIndex']&nbsp;</div></li><li><div>                                                // then apply the substitution&nbsp;</div></li><li><div>                                                if (strpos($inputGlyphs[$seqIndex], $lookupGlyphs[0]) === false) {&nbsp;</div></li><li><div>                                                    continue;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>                                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, $lookupGlyphs, $seqIndex);&nbsp;</div></li><li><div>                                                $REPL = implode(&quot; &quot;, $luss['substitute']);&nbsp;</div></li><li><div>                                                // Returns e.g. &quot;REPL\${6}\${8}&quot; or &quot;\${1}\${2} \${3} REPL\${4}\${6}\${8} \${9}&quot;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                if (strpos(&quot;isol fina fin2 fin3 medi med2 init &quot;, $tag) !== false && $scripttag == 'arab') {&nbsp;</div></li><li><div>                                                    $volt[] = array('match' =&gt; $lookupGlyphs[0], 'replace' =&gt; $REPL, 'tag' =&gt; $tag, 'prel' =&gt; $backtrackGlyphs, 'postl' =&gt; $lookaheadGlyphs, 'ignore' =&gt; $ignore);&nbsp;</div></li><li><div>                                                } else {&nbsp;</div></li><li><div>                                                    $subRule['rules'][] = array('type' =&gt; $Lookup[$lup]['Type'], 'match' =&gt; $lookupGlyphs, 'replace' =&gt; $luss['substitute'], 'seqIndex' =&gt; $seqIndex, 'key' =&gt; $lookupGlyphs[0], );&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                if (count($subRule['rules']))&nbsp;</div></li><li><div>                                    $volt[] = $subRule;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // Format 3: Coverage-based Context Glyph Substitution  p259&nbsp;</div></li><li><div>                    else if ($SubstFormat == 3) {&nbsp;</div></li><li><div>                        // IgnoreMarks flag set on main Lookup table&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        $inputGlyphs = $Lookup[$i]['Subtable'][$c]['CoverageInputGlyphs'];&nbsp;</div></li><li><div>                        $CoverageInputGlyphs = implode('|', $inputGlyphs);&nbsp;</div></li><li><div>                        $nInput = $Lookup[$i]['Subtable'][$c]['InputGlyphCount'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($Lookup[$i]['Subtable'][$c]['BacktrackGlyphCount']) {&nbsp;</div></li><li><div>                            $backtrackGlyphs = $Lookup[$i]['Subtable'][$c]['CoverageBacktrackGlyphs'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $backtrackGlyphs = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Returns e.g. (FEEB|FEEC)(ignore) (FD12|FD13)(ignore) &nbsp;</div></li><li><div>                        $backtrackMatch = $this-&gt;_makeGSUBbacktrackMatch($backtrackGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($Lookup[$i]['Subtable'][$c]['LookaheadGlyphCount']) {&nbsp;</div></li><li><div>                            $lookaheadGlyphs = $Lookup[$i]['Subtable'][$c]['CoverageLookaheadGlyphs'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $lookaheadGlyphs = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Returns e.g. (ignore) (FD12|FD13)(ignore) (FEEB|FEEC)&nbsp;</div></li><li><div>                        $lookaheadMatch = $this-&gt;_makeGSUBlookaheadMatch($lookaheadGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $nBsubs = 2 * count($backtrackGlyphs);&nbsp;</div></li><li><div>                        $nIsubs = (2 * $nInput) - 1;&nbsp;</div></li><li><div>                        $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, array(), 0);&nbsp;</div></li><li><div>                        $subRule = array('context' =&gt; 1, 'tag' =&gt; $tag, 'matchback' =&gt; $backtrackMatch, 'match' =&gt; ($contextInputMatch . $lookaheadMatch), 'nBacktrack' =&gt; count($backtrackGlyphs), 'nInput' =&gt; $nInput, 'nLookahead' =&gt; count($lookaheadGlyphs), 'rules' =&gt; array(), );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['SubstCount']; $b++) {&nbsp;</div></li><li><div>                            $lup = $Lookup[$i]['Subtable'][$c]['SubstLookupRecord'][$b]['LookupListIndex'];&nbsp;</div></li><li><div>                            $seqIndex = $Lookup[$i]['Subtable'][$c]['SubstLookupRecord'][$b]['SequenceIndex'];&nbsp;</div></li><li><div>                            for ($lus = 0; $lus &lt; $Lookup[$lup]['SubtableCount']; $lus++) {&nbsp;</div></li><li><div>                                if (count($Lookup[$lup]['Subtable'][$lus]['subs'])) {&nbsp;</div></li><li><div>                                    foreach ($Lookup[$lup]['Subtable'][$lus]['subs'] AS $luss) {&nbsp;</div></li><li><div>                                        $lookupGlyphs = $luss['Replace'];&nbsp;</div></li><li><div>                                        $mLen = count($lookupGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        // Only apply if the (first) 'Replace' glyph from the&nbsp;</div></li><li><div>                                        // Lookup list is in the [inputGlyphs] at ['SequenceIndex']&nbsp;</div></li><li><div>                                        // then apply the substitution&nbsp;</div></li><li><div>                                        if (strpos($inputGlyphs[$seqIndex], $lookupGlyphs[0]) === false) {&nbsp;</div></li><li><div>                                            continue;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>                                        $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, $lookupGlyphs, $seqIndex);&nbsp;</div></li><li><div>                                        $REPL = implode(&quot; &quot;, $luss['substitute']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        if (strpos(&quot;isol fina fin2 fin3 medi med2 init &quot;, $tag) !== false && $scripttag == 'arab') {&nbsp;</div></li><li><div>                                            $volt[] = array('match' =&gt; $lookupGlyphs[0], 'replace' =&gt; $REPL, 'tag' =&gt; $tag, 'prel' =&gt; $backtrackGlyphs, 'postl' =&gt; $lookaheadGlyphs, 'ignore' =&gt; $ignore);&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            $subRule['rules'][] = array('type' =&gt; $Lookup[$lup]['Type'], 'match' =&gt; $lookupGlyphs, 'replace' =&gt; $luss['substitute'], 'seqIndex' =&gt; $seqIndex, 'key' =&gt; $lookupGlyphs[0], );&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if (count($subRule['rules']))&nbsp;</div></li><li><div>                            $volt[] = $subRule;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//print_r($Lookup[$i]);&nbsp;</div></li><li><div>//print_r($volt[(count($volt)-1)]); exit;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // LookupType 6: ing Contextual Substitution Subtable&nbsp;</div></li><li><div>                else if ($Lookup[$i]['Type'] == 6) {&nbsp;</div></li><li><div>                    // Format 1: Simple Chaining Context Glyph Substitution  p255&nbsp;</div></li><li><div>                    if ($SubstFormat == 1) {&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        for ($s = 0; $s &lt; $Lookup[$i]['Subtable'][$c]['ChainSubRuleSetCount']; $s++) {&nbsp;</div></li><li><div>                            // ChainSubRuleSet&nbsp;</div></li><li><div>                            $subRule = array();&nbsp;</div></li><li><div>                            $firstInputGlyph = $Lookup[$i]['Subtable'][$c]['CoverageGlyphs'][$s]; // First input gyyph&nbsp;</div></li><li><div>                            foreach ($Lookup[$i]['Subtable'][$c]['ChainSubRuleSet'][$s]['ChainSubRule'] AS $rule) {&nbsp;</div></li><li><div>                                // ChainSubRule&nbsp;</div></li><li><div>                                $inputGlyphs = array();&nbsp;</div></li><li><div>                                if ($rule['InputGlyphCount'] &gt; 1) {&nbsp;</div></li><li><div>                                    $inputGlyphs = $rule['InputGlyphs'];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $inputGlyphs[0] = $firstInputGlyph;&nbsp;</div></li><li><div>                                ksort($inputGlyphs);&nbsp;</div></li><li><div>                                $nInput = count($inputGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ($rule['BacktrackGlyphCount']) {&nbsp;</div></li><li><div>                                    $backtrackGlyphs = $rule['BacktrackGlyphs'];&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $backtrackGlyphs = array();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $backtrackMatch = $this-&gt;_makeGSUBbacktrackMatch($backtrackGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ($rule['LookaheadGlyphCount']) {&nbsp;</div></li><li><div>                                    $lookaheadGlyphs = $rule['LookaheadGlyphs'];&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $lookaheadGlyphs = array();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $lookaheadMatch = $this-&gt;_makeGSUBlookaheadMatch($lookaheadGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $nBsubs = 2 * count($backtrackGlyphs);&nbsp;</div></li><li><div>                                $nIsubs = (2 * $nInput) - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, array(), 0);&nbsp;</div></li><li><div>                                $subRule = array('context' =&gt; 1, 'tag' =&gt; $tag, 'matchback' =&gt; $backtrackMatch, 'match' =&gt; ($contextInputMatch . $lookaheadMatch), 'nBacktrack' =&gt; count($backtrackGlyphs), 'nInput' =&gt; $nInput, 'nLookahead' =&gt; count($lookaheadGlyphs), 'rules' =&gt; array(), );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                for ($b = 0; $b &lt; $rule['SubstCount']; $b++) {&nbsp;</div></li><li><div>                                    $lup = $rule['LookupListIndex'][$b];&nbsp;</div></li><li><div>                                    $seqIndex = $rule['SequenceIndex'][$b];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // $Lookup[$lup] = secondary Lookup&nbsp;</div></li><li><div>                                    for ($lus = 0; $lus &lt; $Lookup[$lup]['SubtableCount']; $lus++) {&nbsp;</div></li><li><div>                                        if (count($Lookup[$lup]['Subtable'][$lus]['subs'])) {&nbsp;</div></li><li><div>                                            foreach ($Lookup[$lup]['Subtable'][$lus]['subs'] AS $luss) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                $lookupGlyphs = $luss['Replace'];&nbsp;</div></li><li><div>                                                $mLen = count($lookupGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Only apply if the (first) 'Replace' glyph from the&nbsp;</div></li><li><div>                                                // Lookup list is in the [inputGlyphs] at ['SequenceIndex']&nbsp;</div></li><li><div>                                                // then apply the substitution&nbsp;</div></li><li><div>                                                if (strpos($inputGlyphs[$seqIndex], $lookupGlyphs[0]) === false) {&nbsp;</div></li><li><div>                                                    continue;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>                                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, $lookupGlyphs, $seqIndex);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                $REPL = implode(&quot; &quot;, $luss['substitute']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                if (strpos(&quot;isol fina fin2 fin3 medi med2 init &quot;, $tag) !== false && $scripttag == 'arab') {&nbsp;</div></li><li><div>                                                    $volt[] = array('match' =&gt; $lookupGlyphs[0], 'replace' =&gt; $REPL, 'tag' =&gt; $tag, 'prel' =&gt; $backtrackGlyphs, 'postl' =&gt; $lookaheadGlyphs, 'ignore' =&gt; $ignore);&nbsp;</div></li><li><div>                                                } else {&nbsp;</div></li><li><div>                                                    $subRule['rules'][] = array('type' =&gt; $Lookup[$lup]['Type'], 'match' =&gt; $lookupGlyphs, 'replace' =&gt; $luss['substitute'], 'seqIndex' =&gt; $seqIndex, 'key' =&gt; $lookupGlyphs[0], );&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if (count($subRule['rules']))&nbsp;</div></li><li><div>                                    $volt[] = $subRule;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // Format 2: Class-based Chaining Context Glyph Substitution  p257&nbsp;</div></li><li><div>                    else if ($SubstFormat == 2) {&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        foreach ($Lookup[$i]['Subtable'][$c]['ChainSubClassSet'] AS $inputClass =&gt; $cscs) {&nbsp;</div></li><li><div>                            for ($cscrule = 0; $cscrule &lt; $cscs['ChainSubClassRuleCnt']; $cscrule++) {&nbsp;</div></li><li><div>                                $rule = $cscs['ChainSubClassRule'][$cscrule];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                // These contain classes of glyphs as strings&nbsp;</div></li><li><div>                                // $Lookup[$i]['Subtable'][$c]['InputClasses'][(class)] e.g. 02E6|02E7|02E8&nbsp;</div></li><li><div>                                // $Lookup[$i]['Subtable'][$c]['LookaheadClasses'][(class)]&nbsp;</div></li><li><div>                                // $Lookup[$i]['Subtable'][$c]['BacktrackClasses'][(class)]&nbsp;</div></li><li><div>                                // These contain arrays of classIndexes&nbsp;</div></li><li><div>                                // [Backtrack] [Lookahead] and [Input] (Input is from the second position only)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $inputGlyphs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if (isset($Lookup[$i]['Subtable'][$c]['InputClasses'][$inputClass])) {&nbsp;</div></li><li><div>                                    $inputGlyphs[0] = $Lookup[$i]['Subtable'][$c]['InputClasses'][$inputClass];&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $inputGlyphs[0] = '';&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                if ($rule['InputGlyphCount'] &gt; 1) {&nbsp;</div></li><li><div>                                    //  NB starts at 1&nbsp;</div></li><li><div>                                    for ($gcl = 1; $gcl &lt; $rule['InputGlyphCount']; $gcl++) {&nbsp;</div></li><li><div>                                        $classindex = $rule['Input'][$gcl];&nbsp;</div></li><li><div>                                        if (isset($Lookup[$i]['Subtable'][$c]['InputClasses'][$classindex])) {&nbsp;</div></li><li><div>                                            $inputGlyphs[$gcl] = $Lookup[$i]['Subtable'][$c]['InputClasses'][$classindex];&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        // if class[0] = all glyphs excluding those specified in all other classes&nbsp;</div></li><li><div>                                        // set to blank '' for now&nbsp;</div></li><li><div>                                        else {&nbsp;</div></li><li><div>                                            $inputGlyphs[$gcl] = '';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $nInput = $rule['InputGlyphCount'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ($rule['BacktrackGlyphCount']) {&nbsp;</div></li><li><div>                                    for ($gcl = 0; $gcl &lt; $rule['BacktrackGlyphCount']; $gcl++) {&nbsp;</div></li><li><div>                                        $classindex = $rule['Backtrack'][$gcl];&nbsp;</div></li><li><div>                                        if (isset($Lookup[$i]['Subtable'][$c]['BacktrackClasses'][$classindex])) {&nbsp;</div></li><li><div>                                            $backtrackGlyphs[$gcl] = $Lookup[$i]['Subtable'][$c]['BacktrackClasses'][$classindex];&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        // if class[0] = all glyphs excluding those specified in all other classes&nbsp;</div></li><li><div>                                        // set to blank '' for now&nbsp;</div></li><li><div>                                        else {&nbsp;</div></li><li><div>                                            $backtrackGlyphs[$gcl] = '';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $backtrackGlyphs = array();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                // Returns e.g. (FEEB|FEEC)(ignore) (FD12|FD13)(ignore) &nbsp;</div></li><li><div>                                $backtrackMatch = $this-&gt;_makeGSUBbacktrackMatch($backtrackGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ($rule['LookaheadGlyphCount']) {&nbsp;</div></li><li><div>                                    for ($gcl = 0; $gcl &lt; $rule['LookaheadGlyphCount']; $gcl++) {&nbsp;</div></li><li><div>                                        $classindex = $rule['Lookahead'][$gcl];&nbsp;</div></li><li><div>                                        if (isset($Lookup[$i]['Subtable'][$c]['LookaheadClasses'][$classindex])) {&nbsp;</div></li><li><div>                                            $lookaheadGlyphs[$gcl] = $Lookup[$i]['Subtable'][$c]['LookaheadClasses'][$classindex];&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                        // if class[0] = all glyphs excluding those specified in all other classes&nbsp;</div></li><li><div>                                        // set to blank '' for now&nbsp;</div></li><li><div>                                        else {&nbsp;</div></li><li><div>                                            $lookaheadGlyphs[$gcl] = '';&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                } else {&nbsp;</div></li><li><div>                                    $lookaheadGlyphs = array();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                // Returns e.g. (ignore) (FD12|FD13)(ignore) (FEEB|FEEC)&nbsp;</div></li><li><div>                                $lookaheadMatch = $this-&gt;_makeGSUBlookaheadMatch($lookaheadGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $nBsubs = 2 * count($backtrackGlyphs);&nbsp;</div></li><li><div>                                $nIsubs = (2 * $nInput) - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, array(), 0);&nbsp;</div></li><li><div>                                $subRule = array('context' =&gt; 1, 'tag' =&gt; $tag, 'matchback' =&gt; $backtrackMatch, 'match' =&gt; ($contextInputMatch . $lookaheadMatch), 'nBacktrack' =&gt; count($backtrackGlyphs), 'nInput' =&gt; $nInput, 'nLookahead' =&gt; count($lookaheadGlyphs), 'rules' =&gt; array(), );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                for ($b = 0; $b &lt; $rule['SubstCount']; $b++) {&nbsp;</div></li><li><div>                                    $lup = $rule['LookupListIndex'][$b];&nbsp;</div></li><li><div>                                    $seqIndex = $rule['SequenceIndex'][$b];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                    // $Lookup[$lup] = secondary Lookup&nbsp;</div></li><li><div>                                    for ($lus = 0; $lus &lt; $Lookup[$lup]['SubtableCount']; $lus++) {&nbsp;</div></li><li><div>                                        if (count($Lookup[$lup]['Subtable'][$lus]['subs'])) {&nbsp;</div></li><li><div>                                            foreach ($Lookup[$lup]['Subtable'][$lus]['subs'] AS $luss) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                $lookupGlyphs = $luss['Replace'];&nbsp;</div></li><li><div>                                                $mLen = count($lookupGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Only apply if the (first) 'Replace' glyph from the&nbsp;</div></li><li><div>                                                // Lookup list is in the [inputGlyphs] at ['SequenceIndex']&nbsp;</div></li><li><div>                                                // then apply the substitution&nbsp;</div></li><li><div>                                                if (strpos($inputGlyphs[$seqIndex], $lookupGlyphs[0]) === false) {&nbsp;</div></li><li><div>                                                    continue;&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>                                                $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, $lookupGlyphs, $seqIndex);&nbsp;</div></li><li><div>                                                $REPL = implode(&quot; &quot;, $luss['substitute']);&nbsp;</div></li><li><div>                                                // Returns e.g. &quot;REPL\${6}\${8}&quot; or &quot;\${1}\${2} \${3} REPL\${4}\${6}\${8} \${9}&quot;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                                if (strpos(&quot;isol fina fin2 fin3 medi med2 init &quot;, $tag) !== false && $scripttag == 'arab') {&nbsp;</div></li><li><div>                                                    $volt[] = array('match' =&gt; $lookupGlyphs[0], 'replace' =&gt; $REPL, 'tag' =&gt; $tag, 'prel' =&gt; $backtrackGlyphs, 'postl' =&gt; $lookaheadGlyphs, 'ignore' =&gt; $ignore);&nbsp;</div></li><li><div>                                                } else {&nbsp;</div></li><li><div>                                                    $subRule['rules'][] = array('type' =&gt; $Lookup[$lup]['Type'], 'match' =&gt; $lookupGlyphs, 'replace' =&gt; $luss['substitute'], 'seqIndex' =&gt; $seqIndex, 'key' =&gt; $lookupGlyphs[0], );&nbsp;</div></li><li><div>                                                }&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                if (count($subRule['rules']))&nbsp;</div></li><li><div>                                    $volt[] = $subRule;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>//print_r($Lookup[$i]['Subtable'][$c]); exit;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // Format 3: Coverage-based Chaining Context Glyph Substitution  p259&nbsp;</div></li><li><div>                    else if ($SubstFormat == 3) {&nbsp;</div></li><li><div>                        // IgnoreMarks flag set on main Lookup table&nbsp;</div></li><li><div>                        $ignore = $this-&gt;_getGSUBignoreString($Lookup[$i]['Flag'], $Lookup[$i]['MarkFilteringSet']);&nbsp;</div></li><li><div>                        $inputGlyphs = $Lookup[$i]['Subtable'][$c]['CoverageInputGlyphs'];&nbsp;</div></li><li><div>                        $CoverageInputGlyphs = implode('|', $inputGlyphs);&nbsp;</div></li><li><div>                        $nInput = $Lookup[$i]['Subtable'][$c]['InputGlyphCount'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($Lookup[$i]['Subtable'][$c]['BacktrackGlyphCount']) {&nbsp;</div></li><li><div>                            $backtrackGlyphs = $Lookup[$i]['Subtable'][$c]['CoverageBacktrackGlyphs'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $backtrackGlyphs = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Returns e.g. (FEEB|FEEC)(ignore) (FD12|FD13)(ignore) &nbsp;</div></li><li><div>                        $backtrackMatch = $this-&gt;_makeGSUBbacktrackMatch($backtrackGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ($Lookup[$i]['Subtable'][$c]['LookaheadGlyphCount']) {&nbsp;</div></li><li><div>                            $lookaheadGlyphs = $Lookup[$i]['Subtable'][$c]['CoverageLookaheadGlyphs'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $lookaheadGlyphs = array();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Returns e.g. (ignore) (FD12|FD13)(ignore) (FEEB|FEEC)&nbsp;</div></li><li><div>                        $lookaheadMatch = $this-&gt;_makeGSUBlookaheadMatch($lookaheadGlyphs, $ignore);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $nBsubs = 2 * count($backtrackGlyphs);&nbsp;</div></li><li><div>                        $nIsubs = (2 * $nInput) - 1;&nbsp;</div></li><li><div>                        $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, array(), 0);&nbsp;</div></li><li><div>                        $subRule = array('context' =&gt; 1, 'tag' =&gt; $tag, 'matchback' =&gt; $backtrackMatch, 'match' =&gt; ($contextInputMatch . $lookaheadMatch), 'nBacktrack' =&gt; count($backtrackGlyphs), 'nInput' =&gt; $nInput, 'nLookahead' =&gt; count($lookaheadGlyphs), 'rules' =&gt; array(), );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        for ($b = 0; $b &lt; $Lookup[$i]['Subtable'][$c]['SubstCount']; $b++) {&nbsp;</div></li><li><div>                            $lup = $Lookup[$i]['Subtable'][$c]['SubstLookupRecord'][$b]['LookupListIndex'];&nbsp;</div></li><li><div>                            $seqIndex = $Lookup[$i]['Subtable'][$c]['SubstLookupRecord'][$b]['SequenceIndex'];&nbsp;</div></li><li><div>                            for ($lus = 0; $lus &lt; $Lookup[$lup]['SubtableCount']; $lus++) {&nbsp;</div></li><li><div>                                if (count($Lookup[$lup]['Subtable'][$lus]['subs'])) {&nbsp;</div></li><li><div>                                    foreach ($Lookup[$lup]['Subtable'][$lus]['subs'] AS $luss) {&nbsp;</div></li><li><div>                                        $lookupGlyphs = $luss['Replace'];&nbsp;</div></li><li><div>                                        $mLen = count($lookupGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        // Only apply if the (first) 'Replace' glyph from the&nbsp;</div></li><li><div>                                        // Lookup list is in the [inputGlyphs] at ['SequenceIndex']&nbsp;</div></li><li><div>                                        // then apply the substitution&nbsp;</div></li><li><div>                                        if (strpos($inputGlyphs[$seqIndex], $lookupGlyphs[0]) === false) {&nbsp;</div></li><li><div>                                            continue;&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>                                        $contextInputMatch = $this-&gt;_makeGSUBcontextInputMatch($inputGlyphs, $ignore, $lookupGlyphs, $seqIndex);&nbsp;</div></li><li><div>                                        $REPL = implode(&quot; &quot;, $luss['substitute']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                        if (strpos(&quot;isol fina fin2 fin3 medi med2 init &quot;, $tag) !== false && $scripttag == 'arab') {&nbsp;</div></li><li><div>                                            $volt[] = array('match' =&gt; $lookupGlyphs[0], 'replace' =&gt; $REPL, 'tag' =&gt; $tag, 'prel' =&gt; $backtrackGlyphs, 'postl' =&gt; $lookaheadGlyphs, 'ignore' =&gt; $ignore);&nbsp;</div></li><li><div>                                        } else {&nbsp;</div></li><li><div>                                            $subRule['rules'][] = array('type' =&gt; $Lookup[$lup]['Type'], 'match' =&gt; $lookupGlyphs, 'replace' =&gt; $luss['substitute'], 'seqIndex' =&gt; $seqIndex, 'key' =&gt; $lookupGlyphs[0], );&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if (count($subRule['rules']))&nbsp;</div></li><li><div>                            $volt[] = $subRule;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>//print_r($Lookup); exit;&nbsp;</div></li><li><div>        return $volt;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    // mPDF 5.7.1&nbsp;</div></li><li><div>    function _checkGSUBignore($flag, $glyph, $MarkFilteringSet)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $ignore = false;&nbsp;</div></li><li><div>        // Flag & 0x0008 = Ignore Marks - (unless already done with MarkAttachmentType)&nbsp;</div></li><li><div>        if ((($flag & 0x0008) == 0x0008 && ($flag & 0xFF00) == 0) && strpos($this-&gt;GlyphClassMarks, $glyph)) {&nbsp;</div></li><li><div>            $ignore = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ((($flag & 0x0004) == 0x0004) && strpos($this-&gt;GlyphClassLigatures, $glyph)) {&nbsp;</div></li><li><div>            $ignore = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ((($flag & 0x0002) == 0x0002) && strpos($this-&gt;GlyphClassBases, $glyph)) {&nbsp;</div></li><li><div>            $ignore = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Flag & 0xFF?? = MarkAttachmentType&nbsp;</div></li><li><div>        if ($flag & 0xFF00) {&nbsp;</div></li><li><div>            // &quot;a lookup must ignore any mark glyphs that are not in the specified mark attachment class&quot;&nbsp;</div></li><li><div>            // $this-&gt;MarkAttachmentType is already adjusted for this i.e. contains all Marks except those in the MarkAttachmentClassDef table&nbsp;</div></li><li><div>            if (strpos($this-&gt;MarkAttachmentType[($flag &gt;&gt; 8)], $glyph)) {&nbsp;</div></li><li><div>                $ignore = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Flag & 0x0010 = UseMarkFilteringSet&nbsp;</div></li><li><div>        if (($flag & 0x0010) && strpos($this-&gt;MarkGlyphSets[$MarkFilteringSet], $glyph)) {&nbsp;</div></li><li><div>            $ignore = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $ignore;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _getGSUBignoreString($flag, $MarkFilteringSet)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // If ignoreFlag set, combine all ignore glyphs into -&gt; &quot;((?:(?: FBA1| FBA2| FBA3))*)&quot;&nbsp;</div></li><li><div>        // else &quot;()&quot;&nbsp;</div></li><li><div>        // for Input - set on secondary Lookup table if in Context, and set Backtrack and Lookahead on Context Lookup&nbsp;</div></li><li><div>        $str = &quot;&quot;;&nbsp;</div></li><li><div>        $ignoreflag = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Flag & 0xFF?? = MarkAttachmentType&nbsp;</div></li><li><div>        if ($flag & 0xFF00) {&nbsp;</div></li><li><div>            // &quot;a lookup must ignore any mark glyphs that are not in the specified mark attachment class&quot;&nbsp;</div></li><li><div>            // $this-&gt;MarkAttachmentType is already adjusted for this i.e. contains all Marks except those in the MarkAttachmentClassDef table&nbsp;</div></li><li><div>            $MarkAttachmentType = $flag &gt;&gt; 8;&nbsp;</div></li><li><div>            $ignoreflag = $flag;&nbsp;</div></li><li><div>            $str = $this-&gt;MarkAttachmentType[$MarkAttachmentType];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Flag & 0x0010 = UseMarkFilteringSet&nbsp;</div></li><li><div>        if ($flag & 0x0010) {&nbsp;</div></li><li><div>            throw new MpdfException(&quot;This font &quot; . $this-&gt;fontkey . &quot; contains MarkGlyphSets - Not tested yet&quot;);&nbsp;</div></li><li><div>            $str = $this-&gt;MarkGlyphSets[$MarkFilteringSet];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If Ignore Marks set, supercedes any above&nbsp;</div></li><li><div>        // Flag & 0x0008 = Ignore Marks - (unless already done with MarkAttachmentType)&nbsp;</div></li><li><div>        if (($flag & 0x0008) == 0x0008 && ($flag & 0xFF00) == 0) {&nbsp;</div></li><li><div>            $ignoreflag = 8;&nbsp;</div></li><li><div>            $str = $this-&gt;GlyphClassMarks;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Flag & 0x0004 = Ignore Ligatures&nbsp;</div></li><li><div>        if (($flag & 0x0004) == 0x0004) {&nbsp;</div></li><li><div>            $ignoreflag += 4;&nbsp;</div></li><li><div>            if ($str) {&nbsp;</div></li><li><div>                $str .= &quot;|&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $str .= $this-&gt;GlyphClassLigatures;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Flag & 0x0002 = Ignore BaseGlyphs&nbsp;</div></li><li><div>        if (($flag & 0x0002) == 0x0002) {&nbsp;</div></li><li><div>            $ignoreflag += 2;&nbsp;</div></li><li><div>            if ($str) {&nbsp;</div></li><li><div>                $str .= &quot;|&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $str .= $this-&gt;GlyphClassBases;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($str) {&nbsp;</div></li><li><div>            // This originally returned e.g. ((?:(?:[IGNORE8]))*) when NOT specific to a Lookup e.g. rtlSub in&nbsp;</div></li><li><div>            // arabictypesetting.GSUB.arab.DFLT.php&nbsp;</div></li><li><div>            // This would save repeatedly saving long text strings if used multiple times&nbsp;</div></li><li><div>            // When writing e.g. arabictypesetting.GSUB.arab.DFLT.php to file, included as $ignore[8]&nbsp;</div></li><li><div>            // Would need to also write the $ignore array to that file&nbsp;</div></li><li><div>            //        // If UseMarkFilteringSet (specific to the Lookup) return the string&nbsp;</div></li><li><div>            //        if (($flag & 0x0010) && ($flag & 0x0008) != 0x0008) {&nbsp;</div></li><li><div>            //            return &quot;((?:(?:&quot; . $str . &quot;))*)&quot;;&nbsp;</div></li><li><div>            //        }&nbsp;</div></li><li><div>            //        else { return &quot;((?:(?:&quot; . &quot;[IGNORE&quot;.$ignoreflag.&quot;]&quot; . &quot;))*)&quot;; }&nbsp;</div></li><li><div>            //        // e.g. ((?:(?: 0031| 0032| 0033| 0034| 0045))*)&nbsp;</div></li><li><div>            // But never finished coding it to add the $ignore array to the file, and it doesn't seem to occur often enough to be worth&nbsp;</div></li><li><div>            // writing. So just output it as a string:&nbsp;</div></li><li><div>            return &quot;((?:(?:&quot; . $str . &quot;))*)&quot;;&nbsp;</div></li><li><div>        } else&nbsp;</div></li><li><div>            return &quot;()&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // GSUB Patterns&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>      BACKTRACK                        INPUT                   LOOKAHEAD&nbsp;</div></li><li><div> ================================== ================== ==================================&nbsp;</div></li><li><div>      (FEEB|FEEC)(ign) (FD12|FD13)(ign) (0612)(ign) (0613)(ign) (FD12|FD13)(ign) (FEEB|FEEC)&nbsp;</div></li><li><div>      ----------------  ----------------  -----  ------------  ---------------   ---------------&nbsp;</div></li><li><div>      Backtrack 1       Backtrack 2     Input 1   Input 2       Lookahead 1      Lookahead 2&nbsp;</div></li><li><div>      --------   ---    ---------  ---    ----   ---   ----   ---   ---------   ---    -------&nbsp;</div></li><li><div>      \${1}  \${2}     \${3}   \${4}                      \${5+}  \${6+}    \${7+}  \${8+}&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>      nBacktrack = 2               nInput = 2                 nLookahead = 2&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>      nBsubs = 2xnBack          nIsubs = (nBsubs+)    nLsubs = (nBsubs+nIsubs+) 2xnLookahead&nbsp;</div></li><li><div>      &quot;\${1}\${2} &quot;                 (nInput*2)-1               &quot;\${5+} \${6+}&quot;&nbsp;</div></li><li><div>      &quot;REPL&quot;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>      \${1}\${2} \${3}\${4} REPL\${5+} \${6+}\${7+} \${8+}&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>      INPUT nInput = 5&nbsp;</div></li><li><div> ============================================================&nbsp;</div></li><li><div>      (0612)(ign) (0613)(ign) (0614)(ign) (0615)(ign) (0615)&nbsp;</div></li><li><div>      \${1}  \${2}  \${3}  \${4} \${5} \${6}  \${7} \${8}  \${9} (All backreference numbers are + nBsubs)&nbsp;</div></li><li><div>      -----  ------------ ------------ ------------ ------------&nbsp;</div></li><li><div>      Input 1   Input 2      Input 3      Input 4      Input 5&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>      A======  SequenceIndex=1 ; Lookup match nGlyphs=1&nbsp;</div></li><li><div>      B===================  SequenceIndex=1 ; Lookup match nGlyphs=2&nbsp;</div></li><li><div>      C===============================  SequenceIndex=1 ; Lookup match nGlyphs=3&nbsp;</div></li><li><div>      D=======================  SequenceIndex=2 ; Lookup match nGlyphs=2&nbsp;</div></li><li><div>      E=====================================  SequenceIndex=2 ; Lookup match nGlyphs=3&nbsp;</div></li><li><div>      F======================  SequenceIndex=4 ; Lookup match nGlyphs=2&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>      All backreference numbers are + nBsubs&nbsp;</div></li><li><div>      A - &quot;REPL\${2} \${3}\${4} \${5}\${6} \${7}\${8} \${9}&quot;&nbsp;</div></li><li><div>      B - &quot;REPL\${2}\${4} \${5}\${6} \${7}\${8} \${9}&quot;&nbsp;</div></li><li><div>      C - &quot;REPL\${2}\${4}\${6} \${7}\${8} \${9}&quot;&nbsp;</div></li><li><div>      D - &quot;\${1} REPL\${2}\${4}\${6} \${7}\${8} \${9}&quot;&nbsp;</div></li><li><div>      E - &quot;\${1} REPL\${2}\${4}\${6}\${8} \${9}&quot;&nbsp;</div></li><li><div>      F - &quot;\${1}\${2} \${3}\${4} \${5} REPL\${6}\${8}&quot;&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _makeGSUBcontextInputMatch($inputGlyphs, $ignore, $lookupGlyphs, $seqIndex)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // $ignore = &quot;((?:(?: FBA1| FBA2| FBA3))*)&quot; or &quot;()&quot;&nbsp;</div></li><li><div>        // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>        // $inputGlyphs = array of glyphs(glyphstrings) making up Input sequence in Context&nbsp;</div></li><li><div>        // $lookupGlyphs = array of glyphs (single Glyphs) making up Lookup Input sequence&nbsp;</div></li><li><div>        $mLen = count($lookupGlyphs); // nGlyphs in the secondary Lookup match&nbsp;</div></li><li><div>        $nInput = count($inputGlyphs); // nGlyphs in the Primary Input sequence&nbsp;</div></li><li><div>        $str = &quot;&quot;;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $nInput; $i++) {&nbsp;</div></li><li><div>            if ($i &gt; 0) {&nbsp;</div></li><li><div>                $str .= $ignore . &quot; &quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ($i &gt;= $seqIndex && $i &lt; ($seqIndex + $mLen)) {&nbsp;</div></li><li><div>                $str .= &quot;(&quot; . $lookupGlyphs[($i - $seqIndex)] . &quot;)&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $str .= &quot;(&quot; . $inputGlyphs[($i)] . &quot;)&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _makeGSUBinputMatch($inputGlyphs, $ignore)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // $ignore = &quot;((?:(?: FBA1| FBA2| FBA3))*)&quot; or &quot;()&quot;&nbsp;</div></li><li><div>        // Returns e.g. (0612)(ignore) (0613)(ignore) (0614)&nbsp;</div></li><li><div>        // $inputGlyphs = array of glyphs(glyphstrings) making up Input sequence in Context&nbsp;</div></li><li><div>        // $lookupGlyphs = array of glyphs making up Lookup Input sequence - if applicable&nbsp;</div></li><li><div>        $str = &quot;&quot;;&nbsp;</div></li><li><div>        for ($i = 1; $i &lt;= count($inputGlyphs); $i++) {&nbsp;</div></li><li><div>            if ($i &gt; 1) {&nbsp;</div></li><li><div>                $str .= $ignore . &quot; &quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $str .= &quot;(&quot; . $inputGlyphs[($i - 1)] . &quot;)&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _makeGSUBbacktrackMatch($backtrackGlyphs, $ignore)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // $ignore = &quot;((?:(?: FBA1| FBA2| FBA3))*)&quot; or &quot;()&quot;&nbsp;</div></li><li><div>        // Returns e.g. (FEEB|FEEC)(ignore) (FD12|FD13)(ignore) &nbsp;</div></li><li><div>        // $backtrackGlyphs = array of glyphstrings making up Backtrack sequence&nbsp;</div></li><li><div>        // 3  2  1  0&nbsp;</div></li><li><div>        // each item being e.g. E0AD|E0AF|F1FD&nbsp;</div></li><li><div>        $str = &quot;&quot;;&nbsp;</div></li><li><div>        for ($i = (count($backtrackGlyphs) - 1); $i &gt;= 0; $i--) {&nbsp;</div></li><li><div>            $str .= &quot;(&quot; . $backtrackGlyphs[$i] . &quot;)&quot; . $ignore . &quot; &quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _makeGSUBlookaheadMatch($lookaheadGlyphs, $ignore)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // $ignore = &quot;((?:(?: FBA1| FBA2| FBA3))*)&quot; or &quot;()&quot;&nbsp;</div></li><li><div>        // Returns e.g. (ignore) (FD12|FD13)(ignore) (FEEB|FEEC)&nbsp;</div></li><li><div>        // $lookaheadGlyphs = array of glyphstrings making up Lookahead sequence&nbsp;</div></li><li><div>        // 0  1  2  3&nbsp;</div></li><li><div>        // each item being e.g. E0AD|E0AF|F1FD&nbsp;</div></li><li><div>        $str = &quot;&quot;;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; count($lookaheadGlyphs); $i++) {&nbsp;</div></li><li><div>            $str .= $ignore . &quot; (&quot; . $lookaheadGlyphs[$i] . &quot;)&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function _makeGSUBinputReplacement($nInput, $REPL, $ignore, $nBsubs, $mLen, $seqIndex)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        // Returns e.g. &quot;REPL\${6}\${8}&quot; or &quot;\${1}\${2} \${3} REPL\${4}\${6}\${8} \${9}&quot;&nbsp;</div></li><li><div>        // $nInput    nGlyphs in the Primary Input sequence&nbsp;</div></li><li><div>        // $REPL     replacement glyphs from secondary lookup&nbsp;</div></li><li><div>        // $ignore = &quot;((?:(?: FBA1| FBA2| FBA3))*)&quot; or &quot;()&quot;&nbsp;</div></li><li><div>        // $nBsubs    Number of Backtrack substitutions (= 2x Number of Backtrack glyphs)&nbsp;</div></li><li><div>        // $mLen     nGlyphs in the secondary Lookup match - if no secondary lookup, should=$nInput&nbsp;</div></li><li><div>        // $seqIndex    Sequence Index to apply the secondary match&nbsp;</div></li><li><div>        if ($ignore == &quot;()&quot;) {&nbsp;</div></li><li><div>            $ign = false;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $ign = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $str = &quot;&quot;;&nbsp;</div></li><li><div>        if ($nInput == 1) {&nbsp;</div></li><li><div>            $str = $REPL;&nbsp;</div></li><li><div>        } else if ($nInput &gt; 1) {&nbsp;</div></li><li><div>            if ($mLen == $nInput) { // whole string replaced&nbsp;</div></li><li><div>                $str = $REPL;&nbsp;</div></li><li><div>                if ($ign) {&nbsp;</div></li><li><div>                    // for every nInput over 1, add another replacement backreference, to move IGNORES after replacement&nbsp;</div></li><li><div>                    for ($x = 2; $x &lt;= $nInput; $x++) {&nbsp;</div></li><li><div>                        $str .= '\\' . ($nBsubs + (2 * ($x - 1)));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else { // if only part of string replaced:&nbsp;</div></li><li><div>                for ($x = 1; $x &lt; ($seqIndex + 1); $x++) {&nbsp;</div></li><li><div>                    if ($x == 1) {&nbsp;</div></li><li><div>                        $str .= '\\' . ($nBsubs + 1);&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        if ($ign) {&nbsp;</div></li><li><div>                            $str .= '\\' . ($nBsubs + (2 * ($x - 1)));&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $str .= ' \\' . ($nBsubs + 1 + (2 * ($x - 1)));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ($seqIndex &gt; 0) {&nbsp;</div></li><li><div>                    $str .= &quot; &quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $str .= $REPL;&nbsp;</div></li><li><div>                if ($ign) {&nbsp;</div></li><li><div>                    for ($x = (max(($seqIndex + 1), 2)); $x &lt; ($seqIndex + 1 + $mLen); $x++) { //  move IGNORES after replacement&nbsp;</div></li><li><div>                        $str .= '\\' . ($nBsubs + (2 * ($x - 1)));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                for ($x = ($seqIndex + 1 + $mLen); $x &lt;= $nInput; $x++) {&nbsp;</div></li><li><div>                    if ($ign) {&nbsp;</div></li><li><div>                        $str .= '\\' . ($nBsubs + (2 * ($x - 1)));&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $str .= ' \\' . ($nBsubs + 1 + (2 * ($x - 1)));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    function _getCoverage($convert2hex = true, $mode = 1)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $g = array();&nbsp;</div></li><li><div>        $ctr = 0;&nbsp;</div></li><li><div>        $CoverageFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        if ($CoverageFormat == 1) {&nbsp;</div></li><li><div>            $CoverageGlyphCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($gid = 0; $gid &lt; $CoverageGlyphCount; $gid++) {&nbsp;</div></li><li><div>                $glyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $uni = $this-&gt;glyphToChar[$glyphID][0];&nbsp;</div></li><li><div>                if ($convert2hex) {&nbsp;</div></li><li><div>                    $g[] = unicode_hex($uni);&nbsp;</div></li><li><div>                } else if ($mode == 2) {&nbsp;</div></li><li><div>                    $g[$uni] = $ctr;&nbsp;</div></li><li><div>                    $ctr++;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $g[] = $glyphID;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ($CoverageFormat == 2) {&nbsp;</div></li><li><div>            $RangeCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($r = 0; $r &lt; $RangeCount; $r++) {&nbsp;</div></li><li><div>                $start = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $end = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $StartCoverageIndex = $this-&gt;read_ushort(); // n/a&nbsp;</div></li><li><div>                for ($glyphID = $start; $glyphID &lt;= $end; $glyphID++) {&nbsp;</div></li><li><div>                    $uni = $this-&gt;glyphToChar[$glyphID][0];&nbsp;</div></li><li><div>                    if ($convert2hex) {&nbsp;</div></li><li><div>                        $g[] = unicode_hex($uni);&nbsp;</div></li><li><div>                    } else if ($mode == 2) {&nbsp;</div></li><li><div>                        $uni = $g[$uni] = $ctr;&nbsp;</div></li><li><div>                        $ctr++;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $g[] = $glyphID;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $g;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    function _getClasses($offset)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;seek($offset);&nbsp;</div></li><li><div>        $ClassFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $GlyphByClass = array();&nbsp;</div></li><li><div>        if ($ClassFormat == 1) {&nbsp;</div></li><li><div>            $StartGlyph = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $GlyphCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $GlyphCount; $i++) {&nbsp;</div></li><li><div>                $startGlyphID = $StartGlyph + $i;&nbsp;</div></li><li><div>                $endGlyphID = $StartGlyph + $i;&nbsp;</div></li><li><div>                $class = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($g = $startGlyphID; $g &lt;= $endGlyphID; $g++) {&nbsp;</div></li><li><div>                    if (isset($this-&gt;glyphToChar[$g][0])) {&nbsp;</div></li><li><div>                        $GlyphByClass[$class][] = unicode_hex($this-&gt;glyphToChar[$g][0]);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if ($ClassFormat == 2) {&nbsp;</div></li><li><div>            $tableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $tableCount; $i++) {&nbsp;</div></li><li><div>                $startGlyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $endGlyphID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $class = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($g = $startGlyphID; $g &lt;= $endGlyphID; $g++) {&nbsp;</div></li><li><div>                    if ($this-&gt;glyphToChar[$g][0]) {&nbsp;</div></li><li><div>                        $GlyphByClass[$class][] = unicode_hex($this-&gt;glyphToChar[$g][0]);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gbc = array();&nbsp;</div></li><li><div>        foreach ($GlyphByClass AS $class =&gt; $garr) {&nbsp;</div></li><li><div>            $gbc[$class] = implode('|', $garr);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gbc;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    function _getGPOStables()&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // GPOS - Glyph Positioning&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables[&quot;GPOS&quot;])) {&nbsp;</div></li><li><div>            $ffeats = array();&nbsp;</div></li><li><div>            $gpos_offset = $this-&gt;seek_table(&quot;GPOS&quot;);&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>            $ScriptList_offset = $gpos_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $FeatureList_offset = $gpos_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $LookupList_offset = $gpos_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // ScriptList&nbsp;</div></li><li><div>            $this-&gt;seek($ScriptList_offset);&nbsp;</div></li><li><div>            $ScriptCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $ScriptCount; $i++) {&nbsp;</div></li><li><div>                $ScriptTag = $this-&gt;read_tag(); // = &quot;beng&quot;, &quot;deva&quot; etc.&nbsp;</div></li><li><div>                $ScriptTableOffset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $ffeats[$ScriptTag] = $ScriptList_offset + $ScriptTableOffset;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Script Table&nbsp;</div></li><li><div>            foreach ($ffeats AS $t =&gt; $o) {&nbsp;</div></li><li><div>                $ls = array();&nbsp;</div></li><li><div>                $this-&gt;seek($o);&nbsp;</div></li><li><div>                $DefLangSys_offset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                if ($DefLangSys_offset &gt; 0) {&nbsp;</div></li><li><div>                    $ls['DFLT'] = $DefLangSys_offset + $o;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $LangSysCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($i = 0; $i &lt; $LangSysCount; $i++) {&nbsp;</div></li><li><div>                    $LangTag = $this-&gt;read_tag(); // =&nbsp;</div></li><li><div>                    $LangTableOffset = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $ls[$LangTag] = $o + $LangTableOffset;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $ffeats[$t] = $ls;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get FeatureIndexList&nbsp;</div></li><li><div>            // LangSys Table - from first listed langsys&nbsp;</div></li><li><div>            foreach ($ffeats AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $o) {&nbsp;</div></li><li><div>                    $FeatureIndex = array();&nbsp;</div></li><li><div>                    $langsystable_offset = $o;&nbsp;</div></li><li><div>                    $this-&gt;seek($langsystable_offset);&nbsp;</div></li><li><div>                    $LookUpOrder = $this-&gt;read_ushort(); //==NULL&nbsp;</div></li><li><div>                    $ReqFeatureIndex = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    if ($ReqFeatureIndex != 0xFFFF) {&nbsp;</div></li><li><div>                        $FeatureIndex[] = $ReqFeatureIndex;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $FeatureCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    for ($i = 0; $i &lt; $FeatureCount; $i++) {&nbsp;</div></li><li><div>                        $FeatureIndex[] = $this-&gt;read_ushort(); // = index of feature&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $ffeats[$st][$t] = $FeatureIndex;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>//print_r($ffeats); exit;&nbsp;</div></li><li><div>            // Feauture List =&gt; LookupListIndex es&nbsp;</div></li><li><div>            $this-&gt;seek($FeatureList_offset);&nbsp;</div></li><li><div>            $FeatureCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $Feature = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $FeatureCount; $i++) {&nbsp;</div></li><li><div>                $tag = $this-&gt;read_tag();&nbsp;</div></li><li><div>                if ($tag == 'kern') {&nbsp;</div></li><li><div>                    $this-&gt;haskernGPOS = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $Feature[$i] = array('tag' =&gt; $tag);&nbsp;</div></li><li><div>                $Feature[$i]['offset'] = $FeatureList_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $FeatureCount; $i++) {&nbsp;</div></li><li><div>                $this-&gt;seek($Feature[$i]['offset']);&nbsp;</div></li><li><div>                $this-&gt;read_ushort(); // null&nbsp;</div></li><li><div>                $Feature[$i]['LookupCount'] = $Lookupcount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $Feature[$i]['LookupListIndex'] = array();&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $Lookupcount; $c++) {&nbsp;</div></li><li><div>                    $Feature[$i]['LookupListIndex'][] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ($ffeats AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $o) {&nbsp;</div></li><li><div>                    $FeatureIndex = $ffeats[$st][$t];&nbsp;</div></li><li><div>                    foreach ($FeatureIndex AS $k =&gt; $fi) {&nbsp;</div></li><li><div>                        $ffeats[$st][$t][$k] = $Feature[$fi];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>//print_r($ffeats); exit;&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            $gpos = array();&nbsp;</div></li><li><div>            $GPOSScriptLang = array();&nbsp;</div></li><li><div>            foreach ($ffeats AS $st =&gt; $scripts) {&nbsp;</div></li><li><div>                foreach ($scripts AS $t =&gt; $langsys) {&nbsp;</div></li><li><div>                    $lg = array();&nbsp;</div></li><li><div>                    foreach ($langsys AS $ft) {&nbsp;</div></li><li><div>                        $lg[$ft['LookupListIndex'][0]] = $ft;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // list of Lookups in order they need to be run i.e. order listed in Lookup table&nbsp;</div></li><li><div>                    ksort($lg);&nbsp;</div></li><li><div>                    foreach ($lg AS $ft) {&nbsp;</div></li><li><div>                        $gpos[$st][$t][$ft['tag']] = $ft['LookupListIndex'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if (!isset($GPOSScriptLang[$st])) {&nbsp;</div></li><li><div>                        $GPOSScriptLang[$st] = '';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $GPOSScriptLang[$st] .= $t . ' ';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Get metadata and offsets for whole Lookup List table&nbsp;</div></li><li><div>            $this-&gt;seek($LookupList_offset);&nbsp;</div></li><li><div>            $LookupCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $Lookup = array();&nbsp;</div></li><li><div>            $Offsets = array();&nbsp;</div></li><li><div>            $SubtableCount = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                $Offsets[$i] = $LookupList_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                $this-&gt;seek($Offsets[$i]);&nbsp;</div></li><li><div>                $Lookup[$i]['Type'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $Lookup[$i]['Flag'] = $flag = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $Lookup[$i]['SubtableCount'] = $SubtableCount[$i] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $SubtableCount[$i]; $c++) {&nbsp;</div></li><li><div>                    $Lookup[$i]['Subtables'][$c] = $Offsets[$i] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // MarkFilteringSet = Index (base 0) into GDEF mark glyph sets structure&nbsp;</div></li><li><div>                if (($flag & 0x0010) == 0x0010) {&nbsp;</div></li><li><div>                    $Lookup[$i]['MarkFilteringSet'] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $Lookup[$i]['MarkFilteringSet'] = '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Lookup Type 9: Extension&nbsp;</div></li><li><div>                if ($Lookup[$i]['Type'] == 9) {&nbsp;</div></li><li><div>                    // Overwrites new offset (32-bit) for each subtable, and a new lookup Type&nbsp;</div></li><li><div>                    for ($c = 0; $c &lt; $SubtableCount[$i]; $c++) {&nbsp;</div></li><li><div>                        $this-&gt;seek($Lookup[$i]['Subtables'][$c]);&nbsp;</div></li><li><div>                        $ExtensionPosFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $type = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $Lookup[$i]['Subtables'][$c] = $Lookup[$i]['Subtables'][$c] + $this-&gt;read_ulong();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $Lookup[$i]['Type'] = $type;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>            // Process Whole LookupList - Get LuCoverage = Lookup coverage just for first glyph&nbsp;</div></li><li><div>            $this-&gt;LuCoverage = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $LookupCount; $i++) {&nbsp;</div></li><li><div>                for ($c = 0; $c &lt; $Lookup[$i]['SubtableCount']; $c++) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;seek($Lookup[$i]['Subtables'][$c]);&nbsp;</div></li><li><div>                    $PosFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ($Lookup[$i]['Type'] == 7 && $PosFormat == 3) {&nbsp;</div></li><li><div>                        $this-&gt;skip(4);&nbsp;</div></li><li><div>                    } else if ($Lookup[$i]['Type'] == 8 && $PosFormat == 3) {&nbsp;</div></li><li><div>                        $BacktrackGlyphCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                        $this-&gt;skip(2 * $BacktrackGlyphCount + 2);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // NB Coverage only looks at glyphs for position 1 (i.e. 7.3 and 8.3)    // NEEDS TO READ ALL ********************&nbsp;</div></li><li><div>                    // NB For e.g. Type 4, this may be the Coverage for the Mark&nbsp;</div></li><li><div>                    $Coverage = $Lookup[$i]['Subtables'][$c] + $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $this-&gt;seek($Coverage);&nbsp;</div></li><li><div>                    $glyphs = $this-&gt;_getCoverage(false, 2);&nbsp;</div></li><li><div>                    $this-&gt;LuCoverage[$i][$c] = $glyphs;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //=====================================================================================&nbsp;</div></li><li><div>//print_r($GPOSScriptLang); exit;&nbsp;</div></li><li><div>//print_r($gpos); exit;&nbsp;</div></li><li><div>//print_r($Lookup); exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $s = '&lt;?php&nbsp;</div></li><li><div>$LuCoverage = ' . var_export($this-&gt;LuCoverage, true) . ';&nbsp;</div></li><li><div>?&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            file_put_contents(_MPDF_TTFONTDATAPATH . $this-&gt;fontkey . '.GPOSdata.php', $s);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array($GPOSScriptLang, $gpos, $Lookup);&nbsp;</div></li><li><div>        } // end if GPOS&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>    //=====================================================================================&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function makeSubset($file, &$subset, $TTCfontID = 0, $debug = false, $useOTL = false)&nbsp;</div></li><li><div>    { // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;useOTL = $useOTL; // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;filename = $file;&nbsp;</div></li><li><div>        $this-&gt;fh = fopen($file, 'rb');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;fh) {&nbsp;</div></li><li><div>            throw new MpdfException('Can\'t open file ' . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_pos = 0;&nbsp;</div></li><li><div>        $this-&gt;charWidths = '';&nbsp;</div></li><li><div>        $this-&gt;glyphPos = array();&nbsp;</div></li><li><div>        $this-&gt;charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;tables = array();&nbsp;</div></li><li><div>        $this-&gt;otables = array();&nbsp;</div></li><li><div>        $this-&gt;ascent = 0;&nbsp;</div></li><li><div>        $this-&gt;descent = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutSize = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutPosition = 0;&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = 0;&nbsp;</div></li><li><div>        $this-&gt;TTCFonts = array();&nbsp;</div></li><li><div>        $this-&gt;skip(4);&nbsp;</div></li><li><div>        $this-&gt;maxUni = 0;&nbsp;</div></li><li><div>        if ($TTCfontID &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTC Header version now&nbsp;</div></li><li><div>            if (!in_array($version, array(0x00010000, 0x00020000))) {&nbsp;</div></li><li><div>                throw new MpdfException(&quot;ERROR - Error parsing TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;numTTCFonts = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            for ($i = 1; $i &lt;= $this-&gt;numTTCFonts; $i++) {&nbsp;</div></li><li><div>                $this-&gt;TTCFonts[$i]['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($this-&gt;TTCFonts[$TTCfontID]['offset']);&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTFont version again now&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;readTableDirectory($debug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // head - Font header table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;head&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(50);&nbsp;</div></li><li><div>        $indexToLocFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $glyphDataFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hhea - Horizontal header table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;hhea&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(32);&nbsp;</div></li><li><div>        $metricDataFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $orignHmetrics = $numberOfHMetrics = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // maxp - Maximum profile table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;maxp&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(4);&nbsp;</div></li><li><div>        $numGlyphs = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // cmap - Character to glyph index mapping table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $cmap_offset = $this-&gt;seek_table(&quot;cmap&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(2);&nbsp;</div></li><li><div>        $cmapTableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $unicode_cmap_offset = 0;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $cmapTableCount; $i++) {&nbsp;</div></li><li><div>            $platformID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $encodingID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $offset = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $save_pos = $this-&gt;_pos;&nbsp;</div></li><li><div>            if (($platformID == 3 && $encodingID == 1) || $platformID == 0) { // Microsoft, Unicode&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 4) {&nbsp;</div></li><li><div>                    $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($save_pos);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$unicode_cmap_offset) {&nbsp;</div></li><li><div>            throw new MpdfException('Font (' . $this-&gt;filename . ') does not have Unicode cmap (platform 3, encoding 1, format 4, or platform 0 [any encoding] format 4)');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $glyphToChar = array();&nbsp;</div></li><li><div>        $charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;getCMAP4($unicode_cmap_offset, $glyphToChar, $charToGlyph);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        // Map Unmapped glyphs - from $numGlyphs&nbsp;</div></li><li><div>        if ($useOTL) {&nbsp;</div></li><li><div>            $bctr = 0xE000;&nbsp;</div></li><li><div>            for ($gid = 1; $gid &lt; $numGlyphs; $gid++) {&nbsp;</div></li><li><div>                if (!isset($glyphToChar[$gid])) {&nbsp;</div></li><li><div>                    while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                        $bctr++;&nbsp;</div></li><li><div>                    } // Avoid overwriting a glyph already mapped in PUA&nbsp;</div></li><li><div>                    if ($bctr &gt; 0xF8FF) {&nbsp;</div></li><li><div>                        throw new MpdfException($file . &quot; : WARNING - Font cannot map all included glyphs into Private Use Area U+E000 - U+F8FF; cannot use useOTL on this font&quot;);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $glyphToChar[$gid][] = $bctr;&nbsp;</div></li><li><div>                    $charToGlyph[$bctr] = $gid;&nbsp;</div></li><li><div>                    $bctr++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;charToGlyph = $charToGlyph;&nbsp;</div></li><li><div>        $this-&gt;glyphToChar = $glyphToChar;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hmtx - Horizontal metrics table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $scale = 1; // not used&nbsp;</div></li><li><div>        $this-&gt;getHMTX($numberOfHMetrics, $numGlyphs, $glyphToChar, $scale);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // loca - Index to location&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;getLOCA($indexToLocFormat, $numGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subsetglyphs = array(0 =&gt; 0, 1 =&gt; 1, 2 =&gt; 2);&nbsp;</div></li><li><div>        $subsetCharToGlyph = array();&nbsp;</div></li><li><div>        foreach ($subset AS $code) {&nbsp;</div></li><li><div>            if (isset($this-&gt;charToGlyph[$code])) {&nbsp;</div></li><li><div>                $subsetglyphs[$this-&gt;charToGlyph[$code]] = $code; // Old Glyph ID =&gt; Unicode&nbsp;</div></li><li><div>                $subsetCharToGlyph[$code] = $this-&gt;charToGlyph[$code]; // Unicode to old GlyphID&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;maxUni = max($this-&gt;maxUni, $code);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list($start, $dummy) = $this-&gt;get_table_pos('glyf');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $glyphSet = array();&nbsp;</div></li><li><div>        ksort($subsetglyphs);&nbsp;</div></li><li><div>        $n = 0;&nbsp;</div></li><li><div>        $fsLastCharIndex = 0; // maximum Unicode index (character code) in this font, according to the cmap subtable for platform ID 3 and platform- specific encoding ID 0 or 1.&nbsp;</div></li><li><div>        foreach ($subsetglyphs AS $originalGlyphIdx =&gt; $uni) {&nbsp;</div></li><li><div>            $fsLastCharIndex = max($fsLastCharIndex, $uni);&nbsp;</div></li><li><div>            $glyphSet[$originalGlyphIdx] = $n; // old glyphID to new glyphID&nbsp;</div></li><li><div>            $n++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ksort($subsetCharToGlyph);&nbsp;</div></li><li><div>        foreach ($subsetCharToGlyph AS $uni =&gt; $originalGlyphIdx) {&nbsp;</div></li><li><div>            $codeToGlyph[$uni] = $glyphSet[$originalGlyphIdx];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;codeToGlyph = $codeToGlyph;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ksort($subsetglyphs);&nbsp;</div></li><li><div>        foreach ($subsetglyphs AS $originalGlyphIdx =&gt; $uni) {&nbsp;</div></li><li><div>            $this-&gt;getGlyphs($originalGlyphIdx, $start, $glyphSet, $subsetglyphs);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $numGlyphs = $numberOfHMetrics = count($subsetglyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // name - table copied from the original&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // MS spec says that &quot;Platform and encoding ID's in the name table should be consistent with those in the cmap table.&nbsp;</div></li><li><div>        // If they are not, the font will not load in Windows&quot;&nbsp;</div></li><li><div>        // Doesn't seem to be a problem?&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;add('name', $this-&gt;get_table('name'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        //tables copied from the original&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $tags = array('cvt ', 'fpgm', 'prep', 'gasp');&nbsp;</div></li><li><div>        foreach ($tags AS $tag) {&nbsp;</div></li><li><div>            if (isset($this-&gt;tables[$tag])) {&nbsp;</div></li><li><div>                $this-&gt;add($tag, $this-&gt;get_table($tag));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // post - PostScript&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables['post'])) {&nbsp;</div></li><li><div>            $opost = $this-&gt;get_table('post');&nbsp;</div></li><li><div>            $post = &quot;\x00\x03\x00\x00&quot; . substr($opost, 4, 12) . &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;;&nbsp;</div></li><li><div>            $this-&gt;add('post', $post);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // Sort CID2GID map into segments of contiguous codes&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        ksort($codeToGlyph);&nbsp;</div></li><li><div>        unset($codeToGlyph[0]);&nbsp;</div></li><li><div>        //unset($codeToGlyph[65535]);&nbsp;</div></li><li><div>        $rangeid = 0;&nbsp;</div></li><li><div>        $range = array();&nbsp;</div></li><li><div>        $prevcid = -2;&nbsp;</div></li><li><div>        $prevglidx = -1;&nbsp;</div></li><li><div>        // for each character&nbsp;</div></li><li><div>        foreach ($codeToGlyph as $cid =&gt; $glidx) {&nbsp;</div></li><li><div>            if ($cid == ($prevcid + 1) && $glidx == ($prevglidx + 1)) {&nbsp;</div></li><li><div>                $range[$rangeid][] = $glidx;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // new range&nbsp;</div></li><li><div>                $rangeid = $cid;&nbsp;</div></li><li><div>                $range[$rangeid] = array();&nbsp;</div></li><li><div>                $range[$rangeid][] = $glidx;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $prevcid = $cid;&nbsp;</div></li><li><div>            $prevglidx = $glidx;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // CMap table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // cmap - Character to glyph mapping&nbsp;</div></li><li><div>        $segCount = count($range) + 1; // + 1 Last segment has missing character 0xFFFF&nbsp;</div></li><li><div>        $searchRange = 1;&nbsp;</div></li><li><div>        $entrySelector = 0;&nbsp;</div></li><li><div>        while ($searchRange * 2 &lt;= $segCount) {&nbsp;</div></li><li><div>            $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>            $entrySelector = $entrySelector + 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>        $rangeShift = $segCount * 2 - $searchRange;&nbsp;</div></li><li><div>        $length = 16 + (8 * $segCount ) + ($numGlyphs + 1);&nbsp;</div></li><li><div>        $cmap = array(0, 3, // Index : version, number of encoding subtables&nbsp;</div></li><li><div>            0, 0, // Encoding Subtable : platform (UNI=0), encoding 0&nbsp;</div></li><li><div>            0, 28, // Encoding Subtable : offset (hi, lo)&nbsp;</div></li><li><div>            0, 3, // Encoding Subtable : platform (UNI=0), encoding 3&nbsp;</div></li><li><div>            0, 28, // Encoding Subtable : offset (hi, lo)&nbsp;</div></li><li><div>            3, 1, // Encoding Subtable : platform (MS=3), encoding 1&nbsp;</div></li><li><div>            0, 28, // Encoding Subtable : offset (hi, lo)&nbsp;</div></li><li><div>            4, $length, 0, // Format 4 Mapping subtable: format, length, language&nbsp;</div></li><li><div>            $segCount * 2, &nbsp;</div></li><li><div>            $searchRange, &nbsp;</div></li><li><div>            $entrySelector, &nbsp;</div></li><li><div>            $rangeShift);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // endCode(s)&nbsp;</div></li><li><div>        foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>            $endCode = $start + (count($subrange) - 1);&nbsp;</div></li><li><div>            $cmap[] = $endCode; // endCode(s)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0xFFFF; // endCode of last Segment&nbsp;</div></li><li><div>        $cmap[] = 0; // reservedPad&nbsp;</div></li><li><div>        // startCode(s)&nbsp;</div></li><li><div>        foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>            $cmap[] = $start; // startCode(s)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0xFFFF; // startCode of last Segment&nbsp;</div></li><li><div>        // idDelta(s)&nbsp;</div></li><li><div>        foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>            $idDelta = -($start - $subrange[0]);&nbsp;</div></li><li><div>            $n += count($subrange);&nbsp;</div></li><li><div>            $cmap[] = $idDelta; // idDelta(s)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 1; // idDelta of last Segment&nbsp;</div></li><li><div>        // idRangeOffset(s)&nbsp;</div></li><li><div>        foreach ($range AS $subrange) {&nbsp;</div></li><li><div>            $cmap[] = 0; // idRangeOffset[segCount]      Offset in bytes to glyph indexArray, or 0&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0; // idRangeOffset of last Segment&nbsp;</div></li><li><div>        foreach ($range AS $subrange) {&nbsp;</div></li><li><div>            foreach ($subrange AS $glidx) {&nbsp;</div></li><li><div>                $cmap[] = $glidx;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0; // Mapping for last character&nbsp;</div></li><li><div>        $cmapstr = '';&nbsp;</div></li><li><div>        foreach ($cmap AS $cm) {&nbsp;</div></li><li><div>            $cmapstr .= pack(&quot;n&quot;, $cm);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('cmap', $cmapstr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // glyf - Glyph data&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        list($glyfOffset, $glyfLength) = $this-&gt;get_table_pos('glyf');&nbsp;</div></li><li><div>        if ($glyfLength &lt; $this-&gt;maxStrLenRead) {&nbsp;</div></li><li><div>            $glyphData = $this-&gt;get_table('glyf');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $offsets = array();&nbsp;</div></li><li><div>        $glyf = '';&nbsp;</div></li><li><div>        $pos = 0;&nbsp;</div></li><li><div>        $hmtxstr = '';&nbsp;</div></li><li><div>        $xMinT = 0;&nbsp;</div></li><li><div>        $yMinT = 0;&nbsp;</div></li><li><div>        $xMaxT = 0;&nbsp;</div></li><li><div>        $yMaxT = 0;&nbsp;</div></li><li><div>        $advanceWidthMax = 0;&nbsp;</div></li><li><div>        $minLeftSideBearing = 0;&nbsp;</div></li><li><div>        $minRightSideBearing = 0;&nbsp;</div></li><li><div>        $xMaxExtent = 0;&nbsp;</div></li><li><div>        $maxPoints = 0; // points in non-compound glyph&nbsp;</div></li><li><div>        $maxContours = 0; // contours in non-compound glyph&nbsp;</div></li><li><div>        $maxComponentPoints = 0; // points in compound glyph&nbsp;</div></li><li><div>        $maxComponentContours = 0; // contours in compound glyph&nbsp;</div></li><li><div>        $maxComponentElements = 0; // number of glyphs referenced at top level&nbsp;</div></li><li><div>        $maxComponentDepth = 0; // levels of recursion, set to 0 if font has only simple glyphs&nbsp;</div></li><li><div>        $this-&gt;glyphdata = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($subsetglyphs AS $originalGlyphIdx =&gt; $uni) {&nbsp;</div></li><li><div>            // hmtx - Horizontal Metrics&nbsp;</div></li><li><div>            $hm = $this-&gt;getHMetric($orignHmetrics, $originalGlyphIdx);&nbsp;</div></li><li><div>            $hmtxstr .= $hm;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $offsets[] = $pos;&nbsp;</div></li><li><div>            $glyphPos = $this-&gt;glyphPos[$originalGlyphIdx];&nbsp;</div></li><li><div>            $glyphLen = $this-&gt;glyphPos[$originalGlyphIdx + 1] - $glyphPos;&nbsp;</div></li><li><div>            if ($glyfLength &lt; $this-&gt;maxStrLenRead) {&nbsp;</div></li><li><div>                $data = substr($glyphData, $glyphPos, $glyphLen);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ($glyphLen &gt; 0)&nbsp;</div></li><li><div>                    $data = $this-&gt;get_chunk($glyfOffset + $glyphPos, $glyphLen);&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $data = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ($glyphLen &gt; 0) {&nbsp;</div></li><li><div>                if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>                    $xMin = $this-&gt;unpack_short(substr($data, 2, 2));&nbsp;</div></li><li><div>                    $yMin = $this-&gt;unpack_short(substr($data, 4, 2));&nbsp;</div></li><li><div>                    $xMax = $this-&gt;unpack_short(substr($data, 6, 2));&nbsp;</div></li><li><div>                    $yMax = $this-&gt;unpack_short(substr($data, 8, 2));&nbsp;</div></li><li><div>                    $xMinT = min($xMinT, $xMin);&nbsp;</div></li><li><div>                    $yMinT = min($yMinT, $yMin);&nbsp;</div></li><li><div>                    $xMaxT = max($xMaxT, $xMax);&nbsp;</div></li><li><div>                    $yMaxT = max($yMaxT, $yMax);&nbsp;</div></li><li><div>                    $aw = $this-&gt;unpack_short(substr($hm, 0, 2));&nbsp;</div></li><li><div>                    $lsb = $this-&gt;unpack_short(substr($hm, 2, 2));&nbsp;</div></li><li><div>                    $advanceWidthMax = max($advanceWidthMax, $aw);&nbsp;</div></li><li><div>                    $minLeftSideBearing = min($minLeftSideBearing, $lsb);&nbsp;</div></li><li><div>                    $minRightSideBearing = min($minRightSideBearing, ($aw - $lsb - ($xMax - $xMin)));&nbsp;</div></li><li><div>                    $xMaxExtent = max($xMaxExtent, ($lsb + ($xMax - $xMin)));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $up = unpack(&quot;n&quot;, substr($data, 0, 2));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ($glyphLen &gt; 2 && ($up[1] & (1 &lt;&lt; 15))) { // If number of contours &lt;= -1 i.e. composiste glyph&nbsp;</div></li><li><div>                $pos_in_glyph = 10;&nbsp;</div></li><li><div>                $flags = GF_MORE;&nbsp;</div></li><li><div>                $nComponentElements = 0;&nbsp;</div></li><li><div>                while ($flags & GF_MORE) {&nbsp;</div></li><li><div>                    $nComponentElements += 1; // number of glyphs referenced at top level&nbsp;</div></li><li><div>                    $up = unpack(&quot;n&quot;, substr($data, $pos_in_glyph, 2));&nbsp;</div></li><li><div>                    $flags = $up[1];&nbsp;</div></li><li><div>                    $up = unpack(&quot;n&quot;, substr($data, $pos_in_glyph + 2, 2));&nbsp;</div></li><li><div>                    $glyphIdx = $up[1];&nbsp;</div></li><li><div>                    $this-&gt;glyphdata[$originalGlyphIdx]['compGlyphs'][] = $glyphIdx;&nbsp;</div></li><li><div>                    $data = $this-&gt;_set_ushort($data, $pos_in_glyph + 2, $glyphSet[$glyphIdx]);&nbsp;</div></li><li><div>                    $pos_in_glyph += 4;&nbsp;</div></li><li><div>                    if ($flags & GF_WORDS) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 4;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $pos_in_glyph += 2;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ($flags & GF_SCALE) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 2;&nbsp;</div></li><li><div>                    } else if ($flags & GF_XYSCALE) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 4;&nbsp;</div></li><li><div>                    } else if ($flags & GF_TWOBYTWO) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 8;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $maxComponentElements = max($maxComponentElements, $nComponentElements);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // Simple Glyph&nbsp;</div></li><li><div>            else if (_RECALC_PROFILE && $glyphLen &gt; 2 && $up[1] &lt; (1 &lt;&lt; 15) && $up[1] &gt; 0) {  // Number of contours &gt; 0 simple glyph&nbsp;</div></li><li><div>                $nContours = $up[1];&nbsp;</div></li><li><div>                $this-&gt;glyphdata[$originalGlyphIdx]['nContours'] = $nContours;&nbsp;</div></li><li><div>                $maxContours = max($maxContours, $nContours);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Count number of points in simple glyph&nbsp;</div></li><li><div>                $pos_in_glyph = 10 + ($nContours * 2) - 2; // Last endContourPoint&nbsp;</div></li><li><div>                $up = unpack(&quot;n&quot;, substr($data, $pos_in_glyph, 2));&nbsp;</div></li><li><div>                $points = $up[1] + 1;&nbsp;</div></li><li><div>                $this-&gt;glyphdata[$originalGlyphIdx]['nPoints'] = $points;&nbsp;</div></li><li><div>                $maxPoints = max($maxPoints, $points);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $glyf .= $data;&nbsp;</div></li><li><div>            $pos += $glyphLen;&nbsp;</div></li><li><div>            if ($pos % 4 != 0) {&nbsp;</div></li><li><div>                $padding = 4 - ($pos % 4);&nbsp;</div></li><li><div>                $glyf .= str_repeat(&quot;\0&quot;, $padding);&nbsp;</div></li><li><div>                $pos += $padding;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>            foreach ($this-&gt;glyphdata AS $originalGlyphIdx =&gt; $val) {&nbsp;</div></li><li><div>                $maxdepth = $depth = -1;&nbsp;</div></li><li><div>                $points = 0;&nbsp;</div></li><li><div>                $contours = 0;&nbsp;</div></li><li><div>                $this-&gt;getGlyphData($originalGlyphIdx, $maxdepth, $depth, $points, $contours);&nbsp;</div></li><li><div>                $maxComponentDepth = max($maxComponentDepth, $maxdepth);&nbsp;</div></li><li><div>                $maxComponentPoints = max($maxComponentPoints, $points);&nbsp;</div></li><li><div>                $maxComponentContours = max($maxComponentContours, $contours);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $offsets[] = $pos;&nbsp;</div></li><li><div>        $this-&gt;add('glyf', $glyf);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hmtx - Horizontal Metrics&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;add('hmtx', $hmtxstr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // loca - Index to location&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $locastr = '';&nbsp;</div></li><li><div>        if ((($pos + 1) &gt;&gt; 1) &gt; 0xFFFF) {&nbsp;</div></li><li><div>            $indexToLocFormat = 1;        // long format&nbsp;</div></li><li><div>            foreach ($offsets AS $offset) {&nbsp;</div></li><li><div>                $locastr .= pack(&quot;N&quot;, $offset);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $indexToLocFormat = 0;        // short format&nbsp;</div></li><li><div>            foreach ($offsets AS $offset) {&nbsp;</div></li><li><div>                $locastr .= pack(&quot;n&quot;, ($offset / 2));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('loca', $locastr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // head - Font header&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $head = $this-&gt;get_table('head');&nbsp;</div></li><li><div>        $head = $this-&gt;_set_ushort($head, 50, $indexToLocFormat);&nbsp;</div></li><li><div>        if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>            $head = $this-&gt;_set_short($head, 36, $xMinT); // for all glyph bounding boxes&nbsp;</div></li><li><div>            $head = $this-&gt;_set_short($head, 38, $yMinT); // for all glyph bounding boxes&nbsp;</div></li><li><div>            $head = $this-&gt;_set_short($head, 40, $xMaxT); // for all glyph bounding boxes&nbsp;</div></li><li><div>            $head = $this-&gt;_set_short($head, 42, $yMaxT); // for all glyph bounding boxes&nbsp;</div></li><li><div>            $head[17] = chr($head[17] & ~(1 &lt;&lt; 4)); // Unset Bit 4 (as hdmx/LTSH tables not included)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('head', $head);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hhea - Horizontal Header&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $hhea = $this-&gt;get_table('hhea');&nbsp;</div></li><li><div>        $hhea = $this-&gt;_set_ushort($hhea, 34, $numberOfHMetrics);&nbsp;</div></li><li><div>        if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>            $hhea = $this-&gt;_set_ushort($hhea, 10, $advanceWidthMax);&nbsp;</div></li><li><div>            $hhea = $this-&gt;_set_short($hhea, 12, $minLeftSideBearing);&nbsp;</div></li><li><div>            $hhea = $this-&gt;_set_short($hhea, 14, $minRightSideBearing);&nbsp;</div></li><li><div>            $hhea = $this-&gt;_set_short($hhea, 16, $xMaxExtent);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('hhea', $hhea);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // maxp - Maximum Profile&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $maxp = $this-&gt;get_table('maxp');&nbsp;</div></li><li><div>        $maxp = $this-&gt;_set_ushort($maxp, 4, $numGlyphs);&nbsp;</div></li><li><div>        if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>            $maxp = $this-&gt;_set_ushort($maxp, 6, $maxPoints); // points in non-compound glyph&nbsp;</div></li><li><div>            $maxp = $this-&gt;_set_ushort($maxp, 8, $maxContours); // contours in non-compound glyph&nbsp;</div></li><li><div>            $maxp = $this-&gt;_set_ushort($maxp, 10, $maxComponentPoints); // points in compound glyph&nbsp;</div></li><li><div>            $maxp = $this-&gt;_set_ushort($maxp, 12, $maxComponentContours); // contours in compound glyph&nbsp;</div></li><li><div>            $maxp = $this-&gt;_set_ushort($maxp, 28, $maxComponentElements); // number of glyphs referenced at top level&nbsp;</div></li><li><div>            $maxp = $this-&gt;_set_ushort($maxp, 30, $maxComponentDepth); // levels of recursion, set to 0 if font has only simple glyphs&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('maxp', $maxp);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // OS/2 - OS/2&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables['OS/2'])) {&nbsp;</div></li><li><div>            $os2_offset = $this-&gt;seek_table(&quot;OS/2&quot;);&nbsp;</div></li><li><div>            if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>                $fsSelection = $this-&gt;get_ushort($os2_offset + 62);&nbsp;</div></li><li><div>                $fsSelection = ($fsSelection & ~(1 &lt;&lt; 6)); // 2-byte bit field containing information concerning the nature of the font patterns&nbsp;</div></li><li><div>                // bit#0 = Italic; bit#5=Bold&nbsp;</div></li><li><div>                // Match name table's font subfamily string&nbsp;</div></li><li><div>                // Clear bit#6 used for 'Regular' and optional&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // NB Currently this method never subsets characters above BMP&nbsp;</div></li><li><div>            // Could set nonBMP bit according to $this-&gt;maxUni&nbsp;</div></li><li><div>            $nonBMP = $this-&gt;get_ushort($os2_offset + 46);&nbsp;</div></li><li><div>            $nonBMP = ($nonBMP & ~(1 &lt;&lt; 9)); // Unset Bit 57 (indicates non-BMP) - for interactive forms&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $os2 = $this-&gt;get_table('OS/2');&nbsp;</div></li><li><div>            if (_RECALC_PROFILE) {&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 62, $fsSelection);&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 66, $fsLastCharIndex);&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 42, 0x0000); // ulCharRange (ulUnicodeRange) bits 24-31 | 16-23&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 44, 0x0000); // ulCharRange (Unicode ranges) bits  8-15 |  0-7&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 46, $nonBMP); // ulCharRange (Unicode ranges) bits 56-63 | 48-55&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 48, 0x0000); // ulCharRange (Unicode ranges) bits 40-47 | 32-39&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 50, 0x0000); // ulCharRange (Unicode ranges) bits  88-95 | 80-87&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 52, 0x0000); // ulCharRange (Unicode ranges) bits  72-79 | 64-71&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 54, 0x0000); // ulCharRange (Unicode ranges) bits  120-127 | 112-119&nbsp;</div></li><li><div>                $os2 = $this-&gt;_set_ushort($os2, 56, 0x0000); // ulCharRange (Unicode ranges) bits  104-111 | 96-103&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 46, $nonBMP); // Unset Bit 57 (indicates non-BMP) - for interactive forms&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;add('OS/2', $os2);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        fclose($this-&gt;fh);&nbsp;</div></li><li><div>        // Put the TTF file together&nbsp;</div></li><li><div>        $stm = '';&nbsp;</div></li><li><div>        $this-&gt;endTTFile($stm);&nbsp;</div></li><li><div>        //file_put_contents('testfont.ttf', $stm); exit;&nbsp;</div></li><li><div>        return $stm;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //================================================================================&nbsp;</div></li><li><div>    // Also does SMP&nbsp;</div></li><li><div>    function makeSubsetSIP($file, &$subset, $TTCfontID = 0, $debug = false, $useOTL = 0)&nbsp;</div></li><li><div>    { // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;fh = fopen($file, 'rb');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;fh) {&nbsp;</div></li><li><div>            throw new MpdfException('Can\'t open file ' . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;filename = $file;&nbsp;</div></li><li><div>        $this-&gt;_pos = 0;&nbsp;</div></li><li><div>        $this-&gt;useOTL = $useOTL; // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;charWidths = '';&nbsp;</div></li><li><div>        $this-&gt;glyphPos = array();&nbsp;</div></li><li><div>        $this-&gt;charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;tables = array();&nbsp;</div></li><li><div>        $this-&gt;otables = array();&nbsp;</div></li><li><div>        $this-&gt;ascent = 0;&nbsp;</div></li><li><div>        $this-&gt;descent = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutSize = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutPosition = 0;&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = 0;&nbsp;</div></li><li><div>        $this-&gt;TTCFonts = array();&nbsp;</div></li><li><div>        $this-&gt;skip(4);&nbsp;</div></li><li><div>        if ($TTCfontID &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTC Header version now&nbsp;</div></li><li><div>            if (!in_array($version, array(0x00010000, 0x00020000))) {&nbsp;</div></li><li><div>                throw new MpdfException(&quot;ERROR - Error parsing TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;numTTCFonts = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            for ($i = 1; $i &lt;= $this-&gt;numTTCFonts; $i++) {&nbsp;</div></li><li><div>                $this-&gt;TTCFonts[$i]['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($this-&gt;TTCFonts[$TTCfontID]['offset']);&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTFont version again now&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;readTableDirectory($debug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // head - Font header table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;head&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(50);&nbsp;</div></li><li><div>        $indexToLocFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $glyphDataFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hhea - Horizontal header table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;hhea&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(32);&nbsp;</div></li><li><div>        $metricDataFormat = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $orignHmetrics = $numberOfHMetrics = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // maxp - Maximum profile table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;seek_table(&quot;maxp&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(4);&nbsp;</div></li><li><div>        $numGlyphs = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // cmap - Character to glyph index mapping table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cmap_offset = $this-&gt;seek_table(&quot;cmap&quot;);&nbsp;</div></li><li><div>        $this-&gt;skip(2);&nbsp;</div></li><li><div>        $cmapTableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $unicode_cmap_offset = 0;&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $cmapTableCount; $i++) {&nbsp;</div></li><li><div>            $platformID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $encodingID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $offset = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $save_pos = $this-&gt;_pos;&nbsp;</div></li><li><div>            if (($platformID == 3 && $encodingID == 10) || $platformID == 0) { // Microsoft, Unicode Format 12 table HKCS&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 12) {&nbsp;</div></li><li><div>                    $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // mPDF 5.7.1&nbsp;</div></li><li><div>            if (($platformID == 3 && $encodingID == 1) || $platformID == 0) { // Microsoft, Unicode&nbsp;</div></li><li><div>                $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                if ($format == 4) {&nbsp;</div></li><li><div>                    $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($save_pos);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$unicode_cmap_offset) {&nbsp;</div></li><li><div>            throw new MpdfException('Font does not have cmap for Unicode (platform 3, encoding 1, format 4, or platform 0, any encoding, format 4)');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Format 12 CMAP does characters above Unicode BMP i.e. some HKCS characters U+20000 and above&nbsp;</div></li><li><div>        if ($format == 12) {&nbsp;</div></li><li><div>            $this-&gt;maxUniChar = 0;&nbsp;</div></li><li><div>            $this-&gt;seek($unicode_cmap_offset + 4);&nbsp;</div></li><li><div>            $length = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            $limit = $unicode_cmap_offset + $length;&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $nGroups = $this-&gt;read_ulong();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $glyphToChar = array();&nbsp;</div></li><li><div>            $charToGlyph = array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $nGroups; $i++) {&nbsp;</div></li><li><div>                $startCharCode = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                $endCharCode = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                $startGlyphCode = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                $offset = 0;&nbsp;</div></li><li><div>                for ($unichar = $startCharCode; $unichar &lt;= $endCharCode; $unichar++) {&nbsp;</div></li><li><div>                    $glyph = $startGlyphCode + $offset;&nbsp;</div></li><li><div>                    $offset++;&nbsp;</div></li><li><div>                    // ZZZ98&nbsp;</div></li><li><div>                    if ($unichar &lt; 0x30000) {&nbsp;</div></li><li><div>                        $charToGlyph[$unichar] = $glyph;&nbsp;</div></li><li><div>                        $this-&gt;maxUniChar = max($unichar, $this-&gt;maxUniChar);&nbsp;</div></li><li><div>                        $glyphToChar[$glyph][] = $unichar;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $glyphToChar = array();&nbsp;</div></li><li><div>            $charToGlyph = array();&nbsp;</div></li><li><div>            $this-&gt;getCMAP4($unicode_cmap_offset, $glyphToChar, $charToGlyph);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        // Map Unmapped glyphs - from $numGlyphs&nbsp;</div></li><li><div>        if ($useOTL) {&nbsp;</div></li><li><div>            $bctr = 0xE000;&nbsp;</div></li><li><div>            for ($gid = 1; $gid &lt; $numGlyphs; $gid++) {&nbsp;</div></li><li><div>                if (!isset($glyphToChar[$gid])) {&nbsp;</div></li><li><div>                    while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                        $bctr++;&nbsp;</div></li><li><div>                    } // Avoid overwriting a glyph already mapped in PUA&nbsp;</div></li><li><div>                    // ZZZ98&nbsp;</div></li><li><div>                    if ($bctr &gt; 0xF8FF && $bctr &lt; 0x2CEB0) {&nbsp;</div></li><li><div>                        $bctr = 0x2CEB0;&nbsp;</div></li><li><div>                        while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                            $bctr++;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $glyphToChar[$gid][] = $bctr;&nbsp;</div></li><li><div>                    $charToGlyph[$bctr] = $gid;&nbsp;</div></li><li><div>                    $this-&gt;maxUniChar = max($bctr, $this-&gt;maxUniChar);&nbsp;</div></li><li><div>                    $bctr++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hmtx - Horizontal metrics table&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $scale = 1; // not used here&nbsp;</div></li><li><div>        $this-&gt;getHMTX($numberOfHMetrics, $numGlyphs, $glyphToChar, $scale);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // loca - Index to location&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $this-&gt;getLOCA($indexToLocFormat, $numGlyphs);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $glyphMap = array(0 =&gt; 0);&nbsp;</div></li><li><div>        $glyphSet = array(0 =&gt; 0);&nbsp;</div></li><li><div>        $codeToGlyph = array();&nbsp;</div></li><li><div>        // Set a substitute if ASCII characters do not have glyphs&nbsp;</div></li><li><div>        if (isset($charToGlyph[0x3F])) {&nbsp;</div></li><li><div>            $subs = $charToGlyph[0x3F];&nbsp;</div></li><li><div>        } // Question mark&nbsp;</div></li><li><div>        else {&nbsp;</div></li><li><div>            $subs = $charToGlyph[32];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ($subset AS $code) {&nbsp;</div></li><li><div>            if (isset($charToGlyph[$code]))&nbsp;</div></li><li><div>                $originalGlyphIdx = $charToGlyph[$code];&nbsp;</div></li><li><div>            else if ($code &lt; 128) {&nbsp;</div></li><li><div>                $originalGlyphIdx = $subs;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $originalGlyphIdx = 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (!isset($glyphSet[$originalGlyphIdx])) {&nbsp;</div></li><li><div>                $glyphSet[$originalGlyphIdx] = count($glyphMap);&nbsp;</div></li><li><div>                $glyphMap[] = $originalGlyphIdx;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $codeToGlyph[$code] = $glyphSet[$originalGlyphIdx];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        list($start, $dummy) = $this-&gt;get_table_pos('glyf');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $n = 0;&nbsp;</div></li><li><div>        while ($n &lt; count($glyphMap)) {&nbsp;</div></li><li><div>            $originalGlyphIdx = $glyphMap[$n];&nbsp;</div></li><li><div>            $glyphPos = $this-&gt;glyphPos[$originalGlyphIdx];&nbsp;</div></li><li><div>            $glyphLen = $this-&gt;glyphPos[$originalGlyphIdx + 1] - $glyphPos;&nbsp;</div></li><li><div>            $n += 1;&nbsp;</div></li><li><div>            if (!$glyphLen)&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            $this-&gt;seek($start + $glyphPos);&nbsp;</div></li><li><div>            $numberOfContours = $this-&gt;read_short();&nbsp;</div></li><li><div>            if ($numberOfContours &lt; 0) {&nbsp;</div></li><li><div>                $this-&gt;skip(8);&nbsp;</div></li><li><div>                $flags = GF_MORE;&nbsp;</div></li><li><div>                while ($flags & GF_MORE) {&nbsp;</div></li><li><div>                    $flags = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    $glyphIdx = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                    if (!isset($glyphSet[$glyphIdx])) {&nbsp;</div></li><li><div>                        $glyphSet[$glyphIdx] = count($glyphMap);&nbsp;</div></li><li><div>                        $glyphMap[] = $glyphIdx;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ($flags & GF_WORDS)&nbsp;</div></li><li><div>                        $this-&gt;skip(4);&nbsp;</div></li><li><div>                    else&nbsp;</div></li><li><div>                        $this-&gt;skip(2);&nbsp;</div></li><li><div>                    if ($flags & GF_SCALE)&nbsp;</div></li><li><div>                        $this-&gt;skip(2);&nbsp;</div></li><li><div>                    else if ($flags & GF_XYSCALE)&nbsp;</div></li><li><div>                        $this-&gt;skip(4);&nbsp;</div></li><li><div>                    else if ($flags & GF_TWOBYTWO)&nbsp;</div></li><li><div>                        $this-&gt;skip(8);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $numGlyphs = $n = count($glyphMap);&nbsp;</div></li><li><div>        $numberOfHMetrics = $n;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // name&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // MS spec says that &quot;Platform and encoding ID's in the name table should be consistent with those in the cmap table.&nbsp;</div></li><li><div>        // If they are not, the font will not load in Windows&quot;&nbsp;</div></li><li><div>        // Doesn't seem to be a problem?&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // Needs to have a name entry in 3, 0 (e.g. symbol) - original font will be 3, 1 (i.e. Unicode)&nbsp;</div></li><li><div>        $name = $this-&gt;get_table('name');&nbsp;</div></li><li><div>        $name_offset = $this-&gt;seek_table(&quot;name&quot;);&nbsp;</div></li><li><div>        $format = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $numRecords = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $string_data_offset = $name_offset + $this-&gt;read_ushort();&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $numRecords; $i++) {&nbsp;</div></li><li><div>            $platformId = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $encodingId = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            if ($platformId == 3 && $encodingId == 1) {&nbsp;</div></li><li><div>                $pos = 6 + ($i * 12) + 2;&nbsp;</div></li><li><div>                $name = $this-&gt;_set_ushort($name, $pos, 0x00); // Change encoding to 3, 0 rather than 3, 1&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;skip(8);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('name', $name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // OS/2&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables['OS/2'])) {&nbsp;</div></li><li><div>            $os2 = $this-&gt;get_table('OS/2');&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 42, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 44, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 46, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 48, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 50, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 52, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 54, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 56, 0x00); // ulCharRange (Unicode ranges)&nbsp;</div></li><li><div>            // Set Symbol character only in ulCodePageRange&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 78, 0x8000); // ulCodePageRange = Bit #31 Symbol ****  78 = Bit 16-31&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 80, 0x0000); // ulCodePageRange = Bit #31 Symbol ****  80 = Bit 0-15&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 82, 0x0000); // ulCodePageRange = Bit #32- Symbol **** 82 = Bits 48-63&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 84, 0x0000); // ulCodePageRange = Bit #32- Symbol **** 84 = Bits 32-47&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 64, 0x01); // FirstCharIndex&nbsp;</div></li><li><div>            $os2 = $this-&gt;_set_ushort($os2, 66, count($subset)); // LastCharIndex&nbsp;</div></li><li><div>            // Set PANOSE first bit to 5 for Symbol&nbsp;</div></li><li><div>            $os2 = $this-&gt;splice($os2, 32, chr(5) . chr(0) . chr(1) . chr(0) . chr(1) . chr(0) . chr(0) . chr(0) . chr(0) . chr(0));&nbsp;</div></li><li><div>            $this-&gt;add('OS/2', $os2);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        //tables copied from the original&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $tags = array('cvt ', 'fpgm', 'prep', 'gasp');&nbsp;</div></li><li><div>        foreach ($tags AS $tag) {  // 1.02&nbsp;</div></li><li><div>            if (isset($this-&gt;tables[$tag])) {&nbsp;</div></li><li><div>                $this-&gt;add($tag, $this-&gt;get_table($tag));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // post - PostScript&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        if (isset($this-&gt;tables['post'])) {&nbsp;</div></li><li><div>            $opost = $this-&gt;get_table('post');&nbsp;</div></li><li><div>            $post = &quot;\x00\x03\x00\x00&quot; . substr($opost, 4, 12) . &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('post', $post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hhea - Horizontal Header&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $hhea = $this-&gt;get_table('hhea');&nbsp;</div></li><li><div>        $hhea = $this-&gt;_set_ushort($hhea, 34, $numberOfHMetrics);&nbsp;</div></li><li><div>        $this-&gt;add('hhea', $hhea);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // maxp - Maximum Profile&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $maxp = $this-&gt;get_table('maxp');&nbsp;</div></li><li><div>        $maxp = $this-&gt;_set_ushort($maxp, 4, $numGlyphs);&nbsp;</div></li><li><div>        $this-&gt;add('maxp', $maxp);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // CMap table Formats [1, 0, ]6 and [3, 0, ]4&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // Sort CID2GID map into segments of contiguous codes&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $rangeid = 0;&nbsp;</div></li><li><div>        $range = array();&nbsp;</div></li><li><div>        $prevcid = -2;&nbsp;</div></li><li><div>        $prevglidx = -1;&nbsp;</div></li><li><div>        // for each character&nbsp;</div></li><li><div>        foreach ($subset as $cid =&gt; $code) {&nbsp;</div></li><li><div>            $glidx = $codeToGlyph[$code];&nbsp;</div></li><li><div>            if ($cid == ($prevcid + 1) && $glidx == ($prevglidx + 1)) {&nbsp;</div></li><li><div>                $range[$rangeid][] = $glidx;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // new range&nbsp;</div></li><li><div>                $rangeid = $cid;&nbsp;</div></li><li><div>                $range[$rangeid] = array();&nbsp;</div></li><li><div>                $range[$rangeid][] = $glidx;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $prevcid = $cid;&nbsp;</div></li><li><div>            $prevglidx = $glidx;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // cmap - Character to glyph mapping&nbsp;</div></li><li><div>        $segCount = count($range) + 1; // + 1 Last segment has missing character 0xFFFF&nbsp;</div></li><li><div>        $searchRange = 1;&nbsp;</div></li><li><div>        $entrySelector = 0;&nbsp;</div></li><li><div>        while ($searchRange * 2 &lt;= $segCount) {&nbsp;</div></li><li><div>            $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>            $entrySelector = $entrySelector + 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>        $rangeShift = $segCount * 2 - $searchRange;&nbsp;</div></li><li><div>        $length = 16 + (8 * $segCount ) + ($numGlyphs + 1);&nbsp;</div></li><li><div>        $cmap = array(&nbsp;</div></li><li><div>            4, $length, 0, // Format 4 Mapping subtable: format, length, language&nbsp;</div></li><li><div>            $segCount * 2, &nbsp;</div></li><li><div>            $searchRange, &nbsp;</div></li><li><div>            $entrySelector, &nbsp;</div></li><li><div>            $rangeShift);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // endCode(s)&nbsp;</div></li><li><div>        foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>            $endCode = $start + (count($subrange) - 1);&nbsp;</div></li><li><div>            $cmap[] = $endCode; // endCode(s)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0xFFFF; // endCode of last Segment&nbsp;</div></li><li><div>        $cmap[] = 0; // reservedPad&nbsp;</div></li><li><div>        // startCode(s)&nbsp;</div></li><li><div>        foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>            $cmap[] = $start; // startCode(s)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0xFFFF; // startCode of last Segment&nbsp;</div></li><li><div>        // idDelta(s)&nbsp;</div></li><li><div>        foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>            $idDelta = -($start - $subrange[0]);&nbsp;</div></li><li><div>            $n += count($subrange);&nbsp;</div></li><li><div>            $cmap[] = $idDelta; // idDelta(s)&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 1; // idDelta of last Segment&nbsp;</div></li><li><div>        // idRangeOffset(s)&nbsp;</div></li><li><div>        foreach ($range AS $subrange) {&nbsp;</div></li><li><div>            $cmap[] = 0; // idRangeOffset[segCount]      Offset in bytes to glyph indexArray, or 0&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0; // idRangeOffset of last Segment&nbsp;</div></li><li><div>        foreach ($range AS $subrange) {&nbsp;</div></li><li><div>            foreach ($subrange AS $glidx) {&nbsp;</div></li><li><div>                $cmap[] = $glidx;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmap[] = 0; // Mapping for last character&nbsp;</div></li><li><div>        $cmapstr4 = '';&nbsp;</div></li><li><div>        foreach ($cmap AS $cm) {&nbsp;</div></li><li><div>            $cmapstr4 .= pack(&quot;n&quot;, $cm);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // cmap - Character to glyph mapping&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $entryCount = count($subset);&nbsp;</div></li><li><div>        $length = 10 + $entryCount * 2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $off = 20 + $length;&nbsp;</div></li><li><div>        $hoff = $off &gt;&gt; 16;&nbsp;</div></li><li><div>        $loff = $off & 0xFFFF;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cmap = array(0, 2, // Index : version, number of subtables&nbsp;</div></li><li><div>            1, 0, // Subtable : platform, encoding&nbsp;</div></li><li><div>            0, 20, // offset (hi, lo)&nbsp;</div></li><li><div>            3, 0, // Subtable : platform, encoding    // See note above for 'name'&nbsp;</div></li><li><div>            $hoff, $loff, // offset (hi, lo)&nbsp;</div></li><li><div>            6, $length, // Format 6 Mapping table: format, length&nbsp;</div></li><li><div>            0, 1, // language, First char code&nbsp;</div></li><li><div>            $entryCount&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $cmapstr = '';&nbsp;</div></li><li><div>        foreach ($subset AS $code) {&nbsp;</div></li><li><div>            $cmap[] = $codeToGlyph[$code];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ($cmap AS $cm) {&nbsp;</div></li><li><div>            $cmapstr .= pack(&quot;n&quot;, $cm);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $cmapstr .= $cmapstr4;&nbsp;</div></li><li><div>        $this-&gt;add('cmap', $cmapstr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // hmtx - Horizontal Metrics&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $hmtxstr = '';&nbsp;</div></li><li><div>        for ($n = 0; $n &lt; $numGlyphs; $n++) {&nbsp;</div></li><li><div>            $originalGlyphIdx = $glyphMap[$n];&nbsp;</div></li><li><div>            $hm = $this-&gt;getHMetric($orignHmetrics, $originalGlyphIdx);&nbsp;</div></li><li><div>            $hmtxstr .= $hm;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('hmtx', $hmtxstr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // glyf - Glyph data&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        list($glyfOffset, $glyfLength) = $this-&gt;get_table_pos('glyf');&nbsp;</div></li><li><div>        if ($glyfLength &lt; $this-&gt;maxStrLenRead) {&nbsp;</div></li><li><div>            $glyphData = $this-&gt;get_table('glyf');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $offsets = array();&nbsp;</div></li><li><div>        $glyf = '';&nbsp;</div></li><li><div>        $pos = 0;&nbsp;</div></li><li><div>        for ($n = 0; $n &lt; $numGlyphs; $n++) {&nbsp;</div></li><li><div>            $offsets[] = $pos;&nbsp;</div></li><li><div>            $originalGlyphIdx = $glyphMap[$n];&nbsp;</div></li><li><div>            $glyphPos = $this-&gt;glyphPos[$originalGlyphIdx];&nbsp;</div></li><li><div>            $glyphLen = $this-&gt;glyphPos[$originalGlyphIdx + 1] - $glyphPos;&nbsp;</div></li><li><div>            if ($glyfLength &lt; $this-&gt;maxStrLenRead) {&nbsp;</div></li><li><div>                $data = substr($glyphData, $glyphPos, $glyphLen);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ($glyphLen &gt; 0)&nbsp;</div></li><li><div>                    $data = $this-&gt;get_chunk($glyfOffset + $glyphPos, $glyphLen);&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $data = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ($glyphLen &gt; 0)&nbsp;</div></li><li><div>                $up = unpack(&quot;n&quot;, substr($data, 0, 2));&nbsp;</div></li><li><div>            if ($glyphLen &gt; 2 && ($up[1] & (1 &lt;&lt; 15))) {&nbsp;</div></li><li><div>                $pos_in_glyph = 10;&nbsp;</div></li><li><div>                $flags = GF_MORE;&nbsp;</div></li><li><div>                while ($flags & GF_MORE) {&nbsp;</div></li><li><div>                    $up = unpack(&quot;n&quot;, substr($data, $pos_in_glyph, 2));&nbsp;</div></li><li><div>                    $flags = $up[1];&nbsp;</div></li><li><div>                    $up = unpack(&quot;n&quot;, substr($data, $pos_in_glyph + 2, 2));&nbsp;</div></li><li><div>                    $glyphIdx = $up[1];&nbsp;</div></li><li><div>                    $data = $this-&gt;_set_ushort($data, $pos_in_glyph + 2, $glyphSet[$glyphIdx]);&nbsp;</div></li><li><div>                    $pos_in_glyph += 4;&nbsp;</div></li><li><div>                    if ($flags & GF_WORDS) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 4;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $pos_in_glyph += 2;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ($flags & GF_SCALE) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 2;&nbsp;</div></li><li><div>                    } else if ($flags & GF_XYSCALE) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 4;&nbsp;</div></li><li><div>                    } else if ($flags & GF_TWOBYTWO) {&nbsp;</div></li><li><div>                        $pos_in_glyph += 8;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $glyf .= $data;&nbsp;</div></li><li><div>            $pos += $glyphLen;&nbsp;</div></li><li><div>            if ($pos % 4 != 0) {&nbsp;</div></li><li><div>                $padding = 4 - ($pos % 4);&nbsp;</div></li><li><div>                $glyf .= str_repeat(&quot;\0&quot;, $padding);&nbsp;</div></li><li><div>                $pos += $padding;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $offsets[] = $pos;&nbsp;</div></li><li><div>        $this-&gt;add('glyf', $glyf);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // loca - Index to location&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $locastr = '';&nbsp;</div></li><li><div>        if ((($pos + 1) &gt;&gt; 1) &gt; 0xFFFF) {&nbsp;</div></li><li><div>            $indexToLocFormat = 1;        // long format&nbsp;</div></li><li><div>            foreach ($offsets AS $offset) {&nbsp;</div></li><li><div>                $locastr .= pack(&quot;N&quot;, $offset);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $indexToLocFormat = 0;        // short format&nbsp;</div></li><li><div>            foreach ($offsets AS $offset) {&nbsp;</div></li><li><div>                $locastr .= pack(&quot;n&quot;, ($offset / 2));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;add('loca', $locastr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        // head - Font header&nbsp;</div></li><li><div>        ///////////////////////////////////&nbsp;</div></li><li><div>        $head = $this-&gt;get_table('head');&nbsp;</div></li><li><div>        $head = $this-&gt;_set_ushort($head, 50, $indexToLocFormat);&nbsp;</div></li><li><div>        $this-&gt;add('head', $head);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        fclose($this-&gt;fh);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Put the TTF file together&nbsp;</div></li><li><div>        $stm = '';&nbsp;</div></li><li><div>        $this-&gt;endTTFile($stm);&nbsp;</div></li><li><div>        //file_put_contents('testfont.ttf', $stm); exit;&nbsp;</div></li><li><div>        return $stm;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    // Recursively get composite glyph data&nbsp;</div></li><li><div>    function getGlyphData($originalGlyphIdx, &$maxdepth, &$depth, &$points, &$contours)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $depth++;&nbsp;</div></li><li><div>        $maxdepth = max($maxdepth, $depth);&nbsp;</div></li><li><div>        if (count($this-&gt;glyphdata[$originalGlyphIdx]['compGlyphs'])) {&nbsp;</div></li><li><div>            foreach ($this-&gt;glyphdata[$originalGlyphIdx]['compGlyphs'] AS $glyphIdx) {&nbsp;</div></li><li><div>                $this-&gt;getGlyphData($glyphIdx, $maxdepth, $depth, $points, $contours);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if (($this-&gt;glyphdata[$originalGlyphIdx]['nContours'] &gt; 0) && $depth &gt; 0) { // simple&nbsp;</div></li><li><div>            $contours += $this-&gt;glyphdata[$originalGlyphIdx]['nContours'];&nbsp;</div></li><li><div>            $points += $this-&gt;glyphdata[$originalGlyphIdx]['nPoints'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $depth--;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>    // Recursively get composite glyphs&nbsp;</div></li><li><div>    function getGlyphs($originalGlyphIdx, &$start, &$glyphSet, &$subsetglyphs)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $glyphPos = $this-&gt;glyphPos[$originalGlyphIdx];&nbsp;</div></li><li><div>        $glyphLen = $this-&gt;glyphPos[$originalGlyphIdx + 1] - $glyphPos;&nbsp;</div></li><li><div>        if (!$glyphLen) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;seek($start + $glyphPos);&nbsp;</div></li><li><div>        $numberOfContours = $this-&gt;read_short();&nbsp;</div></li><li><div>        if ($numberOfContours &lt; 0) {&nbsp;</div></li><li><div>            $this-&gt;skip(8);&nbsp;</div></li><li><div>            $flags = GF_MORE;&nbsp;</div></li><li><div>            while ($flags & GF_MORE) {&nbsp;</div></li><li><div>                $flags = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $glyphIdx = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                if (!isset($glyphSet[$glyphIdx])) {&nbsp;</div></li><li><div>                    $glyphSet[$glyphIdx] = count($subsetglyphs); // old glyphID to new glyphID&nbsp;</div></li><li><div>                    $subsetglyphs[$glyphIdx] = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $savepos = ftell($this-&gt;fh);&nbsp;</div></li><li><div>                $this-&gt;getGlyphs($glyphIdx, $start, $glyphSet, $subsetglyphs);&nbsp;</div></li><li><div>                $this-&gt;seek($savepos);&nbsp;</div></li><li><div>                if ($flags & GF_WORDS)&nbsp;</div></li><li><div>                    $this-&gt;skip(4);&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $this-&gt;skip(2);&nbsp;</div></li><li><div>                if ($flags & GF_SCALE)&nbsp;</div></li><li><div>                    $this-&gt;skip(2);&nbsp;</div></li><li><div>                else if ($flags & GF_XYSCALE)&nbsp;</div></li><li><div>                    $this-&gt;skip(4);&nbsp;</div></li><li><div>                else if ($flags & GF_TWOBYTWO)&nbsp;</div></li><li><div>                    $this-&gt;skip(8);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //////////////////////////////////////////////////////////////////////////////////&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getHMTX($numberOfHMetrics, $numGlyphs, &$glyphToChar, $scale)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $start = $this-&gt;seek_table(&quot;hmtx&quot;);&nbsp;</div></li><li><div>        $aw = 0;&nbsp;</div></li><li><div>        $this-&gt;charWidths = str_pad('', 256 * 256 * 2, &quot;\x00&quot;);&nbsp;</div></li><li><div>        if ($this-&gt;maxUniChar &gt; 65536) {&nbsp;</div></li><li><div>            $this-&gt;charWidths .= str_pad('', 256 * 256 * 2, &quot;\x00&quot;);&nbsp;</div></li><li><div>        } // Plane 1 SMP&nbsp;</div></li><li><div>        if ($this-&gt;maxUniChar &gt; 131072) {&nbsp;</div></li><li><div>            $this-&gt;charWidths .= str_pad('', 256 * 256 * 2, &quot;\x00&quot;);&nbsp;</div></li><li><div>        } // Plane 2 SMP&nbsp;</div></li><li><div>        $nCharWidths = 0;&nbsp;</div></li><li><div>        if (($numberOfHMetrics * 4) &lt; $this-&gt;maxStrLenRead) {&nbsp;</div></li><li><div>            $data = $this-&gt;get_chunk($start, ($numberOfHMetrics * 4));&nbsp;</div></li><li><div>            $arr = unpack(&quot;n*&quot;, $data);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;seek($start);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        for ($glyph = 0; $glyph &lt; $numberOfHMetrics; $glyph++) {&nbsp;</div></li><li><div>            if (($numberOfHMetrics * 4) &lt; $this-&gt;maxStrLenRead) {&nbsp;</div></li><li><div>                $aw = $arr[($glyph * 2) + 1];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $aw = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $lsb = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (isset($glyphToChar[$glyph]) || $glyph == 0) {&nbsp;</div></li><li><div>                if ($aw &gt;= (1 &lt;&lt; 15)) {&nbsp;</div></li><li><div>                    $aw = 0;&nbsp;</div></li><li><div>                } // 1.03 Some (arabic) fonts have -ve values for width&nbsp;</div></li><li><div>                // although should be unsigned value - comes out as e.g. 65108 (intended -50)&nbsp;</div></li><li><div>                if ($glyph == 0) {&nbsp;</div></li><li><div>                    $this-&gt;defaultWidth = $scale * $aw;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                foreach ($glyphToChar[$glyph] AS $char) {&nbsp;</div></li><li><div>                    if ($char != 0 && $char != 65535) {&nbsp;</div></li><li><div>                        $w = intval(round($scale * $aw));&nbsp;</div></li><li><div>                        if ($w == 0) {&nbsp;</div></li><li><div>                            $w = 65535;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if ($char &lt; 196608) {&nbsp;</div></li><li><div>                            $this-&gt;charWidths[$char * 2] = chr($w &gt;&gt; 8);&nbsp;</div></li><li><div>                            $this-&gt;charWidths[$char * 2 + 1] = chr($w & 0xFF);&nbsp;</div></li><li><div>                            $nCharWidths++;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $this-&gt;get_chunk(($start + $numberOfHMetrics * 4), ($numGlyphs * 2));&nbsp;</div></li><li><div>        $arr = unpack(&quot;n*&quot;, $data);&nbsp;</div></li><li><div>        $diff = $numGlyphs - $numberOfHMetrics;&nbsp;</div></li><li><div>        $w = intval(round($scale * $aw));&nbsp;</div></li><li><div>        if ($w == 0) {&nbsp;</div></li><li><div>            $w = 65535;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        for ($pos = 0; $pos &lt; $diff; $pos++) {&nbsp;</div></li><li><div>            $glyph = $pos + $numberOfHMetrics;&nbsp;</div></li><li><div>            if (isset($glyphToChar[$glyph])) {&nbsp;</div></li><li><div>                foreach ($glyphToChar[$glyph] AS $char) {&nbsp;</div></li><li><div>                    if ($char != 0 && $char != 65535) {&nbsp;</div></li><li><div>                        if ($char &lt; 196608) {&nbsp;</div></li><li><div>                            $this-&gt;charWidths[$char * 2] = chr($w &gt;&gt; 8);&nbsp;</div></li><li><div>                            $this-&gt;charWidths[$char * 2 + 1] = chr($w & 0xFF);&nbsp;</div></li><li><div>                            $nCharWidths++;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // NB 65535 is a set width of 0&nbsp;</div></li><li><div>        // First bytes define number of chars in font&nbsp;</div></li><li><div>        $this-&gt;charWidths[0] = chr($nCharWidths &gt;&gt; 8);&nbsp;</div></li><li><div>        $this-&gt;charWidths[1] = chr($nCharWidths & 0xFF);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getHMetric($numberOfHMetrics, $gid)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $start = $this-&gt;seek_table(&quot;hmtx&quot;);&nbsp;</div></li><li><div>        if ($gid &lt; $numberOfHMetrics) {&nbsp;</div></li><li><div>            $this-&gt;seek($start + ($gid * 4));&nbsp;</div></li><li><div>            $hm = fread($this-&gt;fh, 4);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;seek($start + (($numberOfHMetrics - 1) * 4));&nbsp;</div></li><li><div>            $hm = fread($this-&gt;fh, 2);&nbsp;</div></li><li><div>            $this-&gt;seek($start + ($numberOfHMetrics * 2) + ($gid * 2));&nbsp;</div></li><li><div>            $hm .= fread($this-&gt;fh, 2);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $hm;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getLOCA($indexToLocFormat, $numGlyphs)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $start = $this-&gt;seek_table('loca');&nbsp;</div></li><li><div>        $this-&gt;glyphPos = array();&nbsp;</div></li><li><div>        if ($indexToLocFormat == 0) {&nbsp;</div></li><li><div>            $data = $this-&gt;get_chunk($start, ($numGlyphs * 2) + 2);&nbsp;</div></li><li><div>            $arr = unpack(&quot;n*&quot;, $data);&nbsp;</div></li><li><div>            for ($n = 0; $n &lt;= $numGlyphs; $n++) {&nbsp;</div></li><li><div>                $this-&gt;glyphPos[] = ($arr[$n + 1] * 2);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if ($indexToLocFormat == 1) {&nbsp;</div></li><li><div>            $data = $this-&gt;get_chunk($start, ($numGlyphs * 4) + 4);&nbsp;</div></li><li><div>            $arr = unpack(&quot;N*&quot;, $data);&nbsp;</div></li><li><div>            for ($n = 0; $n &lt;= $numGlyphs; $n++) {&nbsp;</div></li><li><div>                $this-&gt;glyphPos[] = ($arr[$n + 1]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            throw new MpdfException('Unknown location table format ' . $indexToLocFormat);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // CMAP Format 4&nbsp;</div></li><li><div>    function getCMAP4($unicode_cmap_offset, &$glyphToChar, &$charToGlyph)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $this-&gt;maxUniChar = 0;&nbsp;</div></li><li><div>        $this-&gt;seek($unicode_cmap_offset + 2);&nbsp;</div></li><li><div>        $length = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        $limit = $unicode_cmap_offset + $length;&nbsp;</div></li><li><div>        $this-&gt;skip(2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $segCount = $this-&gt;read_ushort() / 2;&nbsp;</div></li><li><div>        $this-&gt;skip(6);&nbsp;</div></li><li><div>        $endCount = array();&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $segCount; $i++) {&nbsp;</div></li><li><div>            $endCount[] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;skip(2);&nbsp;</div></li><li><div>        $startCount = array();&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $segCount; $i++) {&nbsp;</div></li><li><div>            $startCount[] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $idDelta = array();&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $segCount; $i++) {&nbsp;</div></li><li><div>            $idDelta[] = $this-&gt;read_short();&nbsp;</div></li><li><div>        }  // ???? was unsigned short&nbsp;</div></li><li><div>        $idRangeOffset_start = $this-&gt;_pos;&nbsp;</div></li><li><div>        $idRangeOffset = array();&nbsp;</div></li><li><div>        for ($i = 0; $i &lt; $segCount; $i++) {&nbsp;</div></li><li><div>            $idRangeOffset[] = $this-&gt;read_ushort();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        for ($n = 0; $n &lt; $segCount; $n++) {&nbsp;</div></li><li><div>            $endpoint = ($endCount[$n] + 1);&nbsp;</div></li><li><div>            for ($unichar = $startCount[$n]; $unichar &lt; $endpoint; $unichar++) {&nbsp;</div></li><li><div>                if ($idRangeOffset[$n] == 0)&nbsp;</div></li><li><div>                    $glyph = ($unichar + $idDelta[$n]) & 0xFFFF;&nbsp;</div></li><li><div>                else {&nbsp;</div></li><li><div>                    $offset = ($unichar - $startCount[$n]) * 2 + $idRangeOffset[$n];&nbsp;</div></li><li><div>                    $offset = $idRangeOffset_start + 2 * $n + $offset;&nbsp;</div></li><li><div>                    if ($offset &gt;= $limit)&nbsp;</div></li><li><div>                        $glyph = 0;&nbsp;</div></li><li><div>                    else {&nbsp;</div></li><li><div>                        $glyph = $this-&gt;get_ushort($offset);&nbsp;</div></li><li><div>                        if ($glyph != 0)&nbsp;</div></li><li><div>                            $glyph = ($glyph + $idDelta[$n]) & 0xFFFF;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $charToGlyph[$unichar] = $glyph;&nbsp;</div></li><li><div>                if ($unichar &lt; 196608) {&nbsp;</div></li><li><div>                    $this-&gt;maxUniChar = max($unichar, $this-&gt;maxUniChar);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $glyphToChar[$glyph][] = $unichar;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Put the TTF file together&nbsp;</div></li><li><div>    function endTTFile(&$stm)&nbsp;</div></li><li><div>    {&nbsp;</div></li><li><div>        $stm = '';&nbsp;</div></li><li><div>        $numTables = count($this-&gt;otables);&nbsp;</div></li><li><div>        $searchRange = 1;&nbsp;</div></li><li><div>        $entrySelector = 0;&nbsp;</div></li><li><div>        while ($searchRange * 2 &lt;= $numTables) {&nbsp;</div></li><li><div>            $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>            $entrySelector = $entrySelector + 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $searchRange = $searchRange * 16;&nbsp;</div></li><li><div>        $rangeShift = $numTables * 16 - $searchRange;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Header&nbsp;</div></li><li><div>        if (_TTF_MAC_HEADER) {&nbsp;</div></li><li><div>            $stm .= (pack(&quot;Nnnnn&quot;, 0x74727565, $numTables, $searchRange, $entrySelector, $rangeShift)); // Mac&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $stm .= (pack(&quot;Nnnnn&quot;, 0x00010000, $numTables, $searchRange, $entrySelector, $rangeShift)); // Windows&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Table directory&nbsp;</div></li><li><div>        $tables = $this-&gt;otables;&nbsp;</div></li><li><div>        ksort($tables);&nbsp;</div></li><li><div>        $offset = 12 + $numTables * 16;&nbsp;</div></li><li><div>        foreach ($tables AS $tag =&gt; $data) {&nbsp;</div></li><li><div>            if ($tag == 'head') {&nbsp;</div></li><li><div>                $head_start = $offset;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $stm .= $tag;&nbsp;</div></li><li><div>            $checksum = $this-&gt;calcChecksum($data);&nbsp;</div></li><li><div>            $stm .= pack(&quot;nn&quot;, $checksum[0], $checksum[1]);&nbsp;</div></li><li><div>            $stm .= pack(&quot;NN&quot;, $offset, strlen($data));&nbsp;</div></li><li><div>            $paddedLength = (strlen($data) + 3) & ~3;&nbsp;</div></li><li><div>            $offset = $offset + $paddedLength;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Table data&nbsp;</div></li><li><div>        foreach ($tables AS $tag =&gt; $data) {&nbsp;</div></li><li><div>            $data .= &quot;\0\0\0&quot;;&nbsp;</div></li><li><div>            $stm .= substr($data, 0, (strlen($data) & ~3));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $checksum = $this-&gt;calcChecksum($stm);&nbsp;</div></li><li><div>        $checksum = $this-&gt;sub32(array(0xB1B0, 0xAFBA), $checksum);&nbsp;</div></li><li><div>        $chk = pack(&quot;nn&quot;, $checksum[0], $checksum[1]);&nbsp;</div></li><li><div>        $stm = $this-&gt;splice($stm, ($head_start + 8), $chk);&nbsp;</div></li><li><div>        return $stm;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function repackageTTF($file, $TTCfontID = 0, $debug = false, $useOTL = false)&nbsp;</div></li><li><div>    { // mPDF 5.7.1&nbsp;</div></li><li><div>        // (Does not called for subsets)&nbsp;</div></li><li><div>        $this-&gt;useOTL = $useOTL; // mPDF 5.7.1&nbsp;</div></li><li><div>        $this-&gt;filename = $file;&nbsp;</div></li><li><div>        $this-&gt;fh = fopen($file, 'rb');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!$this-&gt;fh) {&nbsp;</div></li><li><div>            throw new MpdfException('Can\'t open file ' . $file);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;_pos = 0;&nbsp;</div></li><li><div>        $this-&gt;charWidths = '';&nbsp;</div></li><li><div>        $this-&gt;glyphPos = array();&nbsp;</div></li><li><div>        $this-&gt;charToGlyph = array();&nbsp;</div></li><li><div>        $this-&gt;tables = array();&nbsp;</div></li><li><div>        $this-&gt;otables = array();&nbsp;</div></li><li><div>        $this-&gt;ascent = 0;&nbsp;</div></li><li><div>        $this-&gt;descent = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutSize = 0;&nbsp;</div></li><li><div>        $this-&gt;strikeoutPosition = 0;&nbsp;</div></li><li><div>        $this-&gt;numTTCFonts = 0;&nbsp;</div></li><li><div>        $this-&gt;TTCFonts = array();&nbsp;</div></li><li><div>        $this-&gt;skip(4);&nbsp;</div></li><li><div>        $this-&gt;maxUni = 0;&nbsp;</div></li><li><div>        if ($TTCfontID &gt; 0) {&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTC Header version now&nbsp;</div></li><li><div>            if (!in_array($version, array(0x00010000, 0x00020000))) {&nbsp;</div></li><li><div>                throw new MpdfException(&quot;ERROR - Error parsing TrueType Collection: version=&quot; . $version . &quot; - &quot; . $file);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;numTTCFonts = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            for ($i = 1; $i &lt;= $this-&gt;numTTCFonts; $i++) {&nbsp;</div></li><li><div>                $this-&gt;TTCFonts[$i]['offset'] = $this-&gt;read_ulong();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;seek($this-&gt;TTCFonts[$TTCfontID]['offset']);&nbsp;</div></li><li><div>            $this-&gt;version = $version = $this-&gt;read_ulong(); // TTFont version again now&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;readTableDirectory($debug);&nbsp;</div></li><li><div>        $tags = array('OS/2', 'glyf', 'head', 'hhea', 'hmtx', 'loca', 'maxp', 'name', 'post', 'cvt ', 'fpgm', 'gasp', 'prep');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($tags AS $tag) {&nbsp;</div></li><li><div>            if (isset($this-&gt;tables[$tag])) {&nbsp;</div></li><li><div>                $this-&gt;add($tag, $this-&gt;get_table($tag));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // mPDF 5.7.1&nbsp;</div></li><li><div>        if ($useOTL) {&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            // maxp - Maximum profile table&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            $this-&gt;seek_table(&quot;maxp&quot;);&nbsp;</div></li><li><div>            $this-&gt;skip(4);&nbsp;</div></li><li><div>            $numGlyphs = $this-&gt;read_ushort();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            // cmap - Character to glyph index mapping table&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            $cmap_offset = $this-&gt;seek_table(&quot;cmap&quot;);&nbsp;</div></li><li><div>            $this-&gt;skip(2);&nbsp;</div></li><li><div>            $cmapTableCount = $this-&gt;read_ushort();&nbsp;</div></li><li><div>            $unicode_cmap_offset = 0;&nbsp;</div></li><li><div>            for ($i = 0; $i &lt; $cmapTableCount; $i++) {&nbsp;</div></li><li><div>                $platformID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $encodingID = $this-&gt;read_ushort();&nbsp;</div></li><li><div>                $offset = $this-&gt;read_ulong();&nbsp;</div></li><li><div>                $save_pos = $this-&gt;_pos;&nbsp;</div></li><li><div>                if (($platformID == 3 && $encodingID == 1) || $platformID == 0) { // Microsoft, Unicode&nbsp;</div></li><li><div>                    $format = $this-&gt;get_ushort($cmap_offset + $offset);&nbsp;</div></li><li><div>                    if ($format == 4) {&nbsp;</div></li><li><div>                        $unicode_cmap_offset = $cmap_offset + $offset;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;seek($save_pos);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!$unicode_cmap_offset) {&nbsp;</div></li><li><div>                throw new MpdfException('Font (' . $this-&gt;filename . ') does not have cmap for Unicode (platform 3, encoding 1, format 4, or platform 0, any encoding, format 4)');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $glyphToChar = array();&nbsp;</div></li><li><div>            $charToGlyph = array();&nbsp;</div></li><li><div>            $this-&gt;getCMAP4($unicode_cmap_offset, $glyphToChar, $charToGlyph);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            // Map Unmapped glyphs - from $numGlyphs&nbsp;</div></li><li><div>            $bctr = 0xE000;&nbsp;</div></li><li><div>            for ($gid = 1; $gid &lt; $numGlyphs; $gid++) {&nbsp;</div></li><li><div>                if (!isset($glyphToChar[$gid])) {&nbsp;</div></li><li><div>                    while (isset($charToGlyph[$bctr])) {&nbsp;</div></li><li><div>                        $bctr++;&nbsp;</div></li><li><div>                    } // Avoid overwriting a glyph already mapped in PUA (6, 400)&nbsp;</div></li><li><div>                    if ($bctr &gt; 0xF8FF) {&nbsp;</div></li><li><div>                        throw new MpdfException(&quot;Problem. Trying to repackage TF file; not enough space for unmapped glyphs&quot;);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $glyphToChar[$gid][] = $bctr;&nbsp;</div></li><li><div>                    $charToGlyph[$bctr] = $gid;&nbsp;</div></li><li><div>                    $bctr++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            // Sort CID2GID map into segments of contiguous codes&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            unset($charToGlyph[65535]);&nbsp;</div></li><li><div>            unset($charToGlyph[0]);&nbsp;</div></li><li><div>            ksort($charToGlyph);&nbsp;</div></li><li><div>            $rangeid = 0;&nbsp;</div></li><li><div>            $range = array();&nbsp;</div></li><li><div>            $prevcid = -2;&nbsp;</div></li><li><div>            $prevglidx = -1;&nbsp;</div></li><li><div>            // for each character&nbsp;</div></li><li><div>            foreach ($charToGlyph as $cid =&gt; $glidx) {&nbsp;</div></li><li><div>                if ($cid == ($prevcid + 1) && $glidx == ($prevglidx + 1)) {&nbsp;</div></li><li><div>                    $range[$rangeid][] = $glidx;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // new range&nbsp;</div></li><li><div>                    $rangeid = $cid;&nbsp;</div></li><li><div>                    $range[$rangeid] = array();&nbsp;</div></li><li><div>                    $range[$rangeid][] = $glidx;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $prevcid = $cid;&nbsp;</div></li><li><div>                $prevglidx = $glidx;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            // CMap table&nbsp;</div></li><li><div>            ///////////////////////////////////&nbsp;</div></li><li><div>            // cmap - Character to glyph mapping&nbsp;</div></li><li><div>            $segCount = count($range) + 1; // + 1 Last segment has missing character 0xFFFF&nbsp;</div></li><li><div>            $searchRange = 1;&nbsp;</div></li><li><div>            $entrySelector = 0;&nbsp;</div></li><li><div>            while ($searchRange * 2 &lt;= $segCount) {&nbsp;</div></li><li><div>                $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>                $entrySelector = $entrySelector + 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $searchRange = $searchRange * 2;&nbsp;</div></li><li><div>            $rangeShift = $segCount * 2 - $searchRange;&nbsp;</div></li><li><div>            $length = 16 + (8 * $segCount ) + ($numGlyphs + 1);&nbsp;</div></li><li><div>            $cmap = array(0, 3, // Index : version, number of encoding subtables&nbsp;</div></li><li><div>                0, 0, // Encoding Subtable : platform (UNI=0), encoding 0&nbsp;</div></li><li><div>                0, 28, // Encoding Subtable : offset (hi, lo)&nbsp;</div></li><li><div>                0, 3, // Encoding Subtable : platform (UNI=0), encoding 3&nbsp;</div></li><li><div>                0, 28, // Encoding Subtable : offset (hi, lo)&nbsp;</div></li><li><div>                3, 1, // Encoding Subtable : platform (MS=3), encoding 1&nbsp;</div></li><li><div>                0, 28, // Encoding Subtable : offset (hi, lo)&nbsp;</div></li><li><div>                4, $length, 0, // Format 4 Mapping subtable: format, length, language&nbsp;</div></li><li><div>                $segCount * 2, &nbsp;</div></li><li><div>                $searchRange, &nbsp;</div></li><li><div>                $entrySelector, &nbsp;</div></li><li><div>                $rangeShift);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // endCode(s)&nbsp;</div></li><li><div>            foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>                $endCode = $start + (count($subrange) - 1);&nbsp;</div></li><li><div>                $cmap[] = $endCode; // endCode(s)&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $cmap[] = 0xFFFF; // endCode of last Segment&nbsp;</div></li><li><div>            $cmap[] = 0; // reservedPad&nbsp;</div></li><li><div>            // startCode(s)&nbsp;</div></li><li><div>            foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>                $cmap[] = $start; // startCode(s)&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $cmap[] = 0xFFFF; // startCode of last Segment&nbsp;</div></li><li><div>            // idDelta(s)&nbsp;</div></li><li><div>            foreach ($range AS $start =&gt; $subrange) {&nbsp;</div></li><li><div>                $idDelta = -($start - $subrange[0]);&nbsp;</div></li><li><div>                //$n += count($subrange);    // ?? Line not required&nbsp;</div></li><li><div>                $cmap[] = $idDelta; // idDelta(s)&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $cmap[] = 1; // idDelta of last Segment&nbsp;</div></li><li><div>            // idRangeOffset(s)&nbsp;</div></li><li><div>            foreach ($range AS $subrange) {&nbsp;</div></li><li><div>                $cmap[] = 0; // idRangeOffset[segCount]      Offset in bytes to glyph indexArray, or 0&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $cmap[] = 0; // idRangeOffset of last Segment&nbsp;</div></li><li><div>            foreach ($range AS $subrange) {&nbsp;</div></li><li><div>                foreach ($subrange AS $glidx) {&nbsp;</div></li><li><div>                    $cmap[] = $glidx;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $cmap[] = 0; // Mapping for last character&nbsp;</div></li><li><div>            $cmapstr = '';&nbsp;</div></li><li><div>            foreach ($cmap AS $cm) {&nbsp;</div></li><li><div>                $cmapstr .= pack(&quot;n&quot;, $cm);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $this-&gt;add('cmap', $cmapstr);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;add('cmap', $this-&gt;get_table('cmap'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        fclose($this-&gt;fh);&nbsp;</div></li><li><div>        $stm = '';&nbsp;</div></li><li><div>        $this-&gt;endTTFile($stm);&nbsp;</div></li><li><div>        return $stm;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.1/classes/ttfont_file/" class="active">2.8.1</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.8.0/classes/ttfont_file/" class="">2.8.0</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.7.3/classes/ttfont_file/" class="">2.7.3</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.7.2/classes/ttfont_file/" class="">2.7.2</a></li><li><a href="http://hookr.io/plugins/woocommerce-pdf-invoices/2.7.1/classes/ttfont_file/" class="">2.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>TTFontFile</li><li><span></span>WooCommerce PDF Invoices</li><li><span></span>2.8.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>