<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="class" data-id="12505"><head xmlns="http://www.w3.org/1999/xhtml"><title> jetpack_subscriptions | class | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Jetpack_Subscriptions, class, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The Jetpack by WordPress.com Jetpack Subscriptions class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=c04cf93e0b4bff9902ccead39f61d5d1' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/jetpack_subscriptions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_subscriptions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_subscriptions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-class-jetpack_subscriptions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="jetpack_subscriptions" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">jetpack_subscriptions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="active" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Jetpack_Subscriptions</strong></h1><p>The Jetpack by WordPress.com <strong>Jetpack Subscriptions</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/modules-subscriptions/" class="file">/modules/subscriptions.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="46" class="block" start="46"><li><div>class Jetpack_Subscriptions {&nbsp;</div></li><li><div>    public $jetpack = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static $hash;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Singleton&nbsp;</div></li><li><div>     * @static&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function init() {&nbsp;</div></li><li><div>        static $instance = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$instance ) {&nbsp;</div></li><li><div>            $instance = new Jetpack_Subscriptions;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        $this-&gt;jetpack = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Don't use COOKIEHASH as it could be shared across installs && is non-unique in multisite.&nbsp;</div></li><li><div>        // @see: https://twitter.com/nacin/status/378246957451333632&nbsp;</div></li><li><div>        self::$hash = md5( get_option( 'siteurl' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'jetpack_xmlrpc_methods', array( $this, 'xmlrpc_methods' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // @todo remove sync from subscriptions and move elsewhere...&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add Configuration Page&nbsp;</div></li><li><div>        add_action( 'admin_init', array( $this, 'configure' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set up the subscription widget.&nbsp;</div></li><li><div>        add_action( 'widgets_init', array( $this, 'widget_init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Catch subscription widget submits&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['jetpack_subscriptions_widget'] ) )&nbsp;</div></li><li><div>            add_action( 'template_redirect', array( $this, 'widget_submit' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set up the comment subscription checkboxes&nbsp;</div></li><li><div>        add_action( 'comment_form', array( $this, 'comment_subscribe_init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Catch comment posts and check for subscriptions.&nbsp;</div></li><li><div>        add_action( 'comment_post', array( $this, 'comment_subscribe_submit' ), 50, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Adds post meta checkbox in the post submit metabox&nbsp;</div></li><li><div>        if (&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter whether or not to show the per-post subscription option.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module subscriptions&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 3.7.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param bool true = show checkbox option on all new posts | false = hide the option.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            apply_filters( 'jetpack_allow_per_post_subscriptions', false ) )&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>            add_action( 'post_submitbox_misc_actions', array( $this, 'subscription_post_page_metabox' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'transition_post_status', array( $this, 'maybe_send_subscription_email' ), 10, 3 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function post_is_public( $the_post ) {&nbsp;</div></li><li><div>        if ( !$post = get_post( $the_post ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'publish' === $post-&gt;post_status && strlen( (string) $post-&gt;post_password ) &lt; 1 ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter whether posts can be emailed to subscribers.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module subscriptions&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 2.4.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param bool true Can the post be emailed to Subscribers. Default to true.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            return apply_filters( 'jetpack_is_post_mailable', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::xmlrpc_methods()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Register subscriptions methods with the Jetpack XML-RPC server.&nbsp;</div></li><li><div>     * @param array $methods&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function xmlrpc_methods( $methods ) {&nbsp;</div></li><li><div>        return array_merge(&nbsp;</div></li><li><div>            $methods, &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'jetpack.subscriptions.subscribe' =&gt; array( $this, 'subscribe' ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Disable Subscribe on Single Post&nbsp;</div></li><li><div>     * Register post meta&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function subscription_post_page_metabox() {&nbsp;</div></li><li><div>        if ( has_filter( 'jetpack_subscriptions_exclude_these_categories' ) || has_filter( 'jetpack_subscriptions_include_only_these_categories' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>        $disable_subscribe_value = get_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', true );&nbsp;</div></li><li><div>        // Nonce it&nbsp;</div></li><li><div>        wp_nonce_field( 'disable_subscribe', 'disable_subscribe_nonce' );&nbsp;</div></li><li><div>        // only show checkbox if post hasn't been published and is a 'post' post type.&nbsp;</div></li><li><div>        if ( get_post_status( $post-&gt;ID ) !== 'publish' && get_post_type( $post-&gt;ID ) == 'post' ) : ?&gt;&nbsp;</div></li><li><div>            &lt;div class=&quot;misc-pub-section&quot;&gt;&nbsp;</div></li><li><div>                &lt;label for=&quot;_jetpack_dont_email_post_to_subs&quot;&gt;&lt;?php _e( 'Jetpack Subscriptions:', 'jetpack' ); ?&gt;&lt;/label&gt;&lt;br&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;checkbox&quot; name=&quot;_jetpack_dont_email_post_to_subs&quot; id=&quot;jetpack-per-post-subscribe&quot; value=&quot;1&quot; &lt;?php checked( $disable_subscribe_value, 1, true ); ?&gt; /&gt;&nbsp;</div></li><li><div>                &lt;?php _e( 'Don&#8217;t send this to subscribers', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;?php endif;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks whether or not the post should be emailed to subscribers&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * It checks for the following things in order:&nbsp;</div></li><li><div>     * - Usage of filter jetpack_subscriptions_exclude_these_categories&nbsp;</div></li><li><div>     * - Usage of filter jetpack_subscriptions_include_only_these_categories&nbsp;</div></li><li><div>     * - Existence of the per-post checkbox option&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Only one of these can be used at any given time.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param $new_status string - the &quot;new&quot; post status of the transition when saved&nbsp;</div></li><li><div>     * @param $old_status string - the &quot;old&quot; post status of the transition when saved&nbsp;</div></li><li><div>     * @param $post obj - The post object&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function maybe_send_subscription_email( $new_status, $old_status, $post ) {&nbsp;</div></li><li><div>        // Only do things on publish&nbsp;</div></li><li><div>        if ( 'publish' !== $new_status ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Array of categories that will never trigger subscription emails.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Will not send subscription emails from any post from within these categories.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.7.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args Array of category slugs or ID's.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $excluded_categories = apply_filters( 'jetpack_subscriptions_exclude_these_categories', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Never email posts from these categories&nbsp;</div></li><li><div>        if ( ! empty( $excluded_categories ) && in_category( $excluded_categories, $post-&gt;ID ) ) {&nbsp;</div></li><li><div>            update_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * ONLY send subscription emails for these categories&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Will ONLY send subscription emails to these categories.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.7.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args Array of category slugs or ID's.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $only_these_categories = apply_filters( 'jetpack_subscriptions_exclude_all_categories_except', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only emails posts from these categories&nbsp;</div></li><li><div>        if ( ! empty( $only_these_categories ) && ! in_category( $only_these_categories, $post-&gt;ID ) ) {&nbsp;</div></li><li><div>            update_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Email the post, depending on the checkbox option&nbsp;</div></li><li><div>        if ( ! empty( $_POST['disable_subscribe_nonce'] ) && wp_verify_nonce( $_POST['disable_subscribe_nonce'], 'disable_subscribe' ) ) {&nbsp;</div></li><li><div>            if ( isset( $_POST['_jetpack_dont_email_post_to_subs'] ) ) {&nbsp;</div></li><li><div>                update_post_meta( $post-&gt;ID, '_jetpack_dont_email_post_to_subs', $_POST['_jetpack_dont_email_post_to_subs'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::configure()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Jetpack Subscriptions configuration screen.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function configure() {&nbsp;</div></li><li><div>        // Create the section&nbsp;</div></li><li><div>        add_settings_section(&nbsp;</div></li><li><div>            'jetpack_subscriptions', &nbsp;</div></li><li><div>            __( 'Jetpack Subscriptions Settings', 'jetpack' ), &nbsp;</div></li><li><div>            array( $this, 'subscriptions_settings_section' ), &nbsp;</div></li><li><div>            'discussion'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Subscribe to Posts ***************************************************/&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_settings_field(&nbsp;</div></li><li><div>            'jetpack_subscriptions_post_subscribe', &nbsp;</div></li><li><div>            __( 'Follow Blog', 'jetpack' ), &nbsp;</div></li><li><div>            array( $this, 'subscription_post_subscribe_setting' ), &nbsp;</div></li><li><div>            'discussion', &nbsp;</div></li><li><div>            'jetpack_subscriptions'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        register_setting(&nbsp;</div></li><li><div>            'discussion', &nbsp;</div></li><li><div>            'stb_enabled'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Subscribe to Comments ******************************************************/&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_settings_field(&nbsp;</div></li><li><div>            'jetpack_subscriptions_comment_subscribe', &nbsp;</div></li><li><div>            __( 'Follow Comments', 'jetpack' ), &nbsp;</div></li><li><div>            array( $this, 'subscription_comment_subscribe_setting' ), &nbsp;</div></li><li><div>            'discussion', &nbsp;</div></li><li><div>            'jetpack_subscriptions'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        register_setting(&nbsp;</div></li><li><div>            'discussion', &nbsp;</div></li><li><div>            'stc_enabled'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Subscription Messaging Options ******************************************************/&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        register_setting(&nbsp;</div></li><li><div>            'reading', &nbsp;</div></li><li><div>            'subscription_options', &nbsp;</div></li><li><div>            array( $this, 'validate_settings' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_settings_section(&nbsp;</div></li><li><div>            'email_settings', &nbsp;</div></li><li><div>            __( 'Follower Settings', 'jetpack' ), &nbsp;</div></li><li><div>            array( $this, 'reading_section' ), &nbsp;</div></li><li><div>            'reading'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_settings_field(&nbsp;</div></li><li><div>            'invitation', &nbsp;</div></li><li><div>            __( 'Blog follow email text', 'jetpack' ), &nbsp;</div></li><li><div>            array( $this, 'setting_invitation' ), &nbsp;</div></li><li><div>            'reading', &nbsp;</div></li><li><div>            'email_settings'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_settings_field(&nbsp;</div></li><li><div>            'comment-follow', &nbsp;</div></li><li><div>            __( 'Comment follow email text', 'jetpack' ), &nbsp;</div></li><li><div>            array( $this, 'setting_comment_follow' ), &nbsp;</div></li><li><div>            'reading', &nbsp;</div></li><li><div>            'email_settings'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Discussions setting section blurb&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function subscriptions_settings_section() {&nbsp;</div></li><li><div>    ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;p id=&quot;jetpack-subscriptions-settings&quot;&gt;&lt;?php _e( 'Change whether your visitors can subscribe to your posts or comments or both.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Post Subscriptions Toggle&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function subscription_post_subscribe_setting() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stb_enabled = get_option( 'stb_enabled', 1 ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;p class=&quot;description&quot;&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;checkbox&quot; name=&quot;stb_enabled&quot; id=&quot;jetpack-post-subscribe&quot; value=&quot;1&quot; &lt;?php checked( $stb_enabled, 1 ); ?&gt; /&gt;&nbsp;</div></li><li><div>            &lt;?php _e( &quot;Show a &lt;em&gt;'follow blog'&lt;/em&gt; option in the comment form&quot;, 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>        &lt;/p&gt;&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Comments Subscriptions Toggle&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function subscription_comment_subscribe_setting() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stc_enabled = get_option( 'stc_enabled', 1 ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;p class=&quot;description&quot;&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;checkbox&quot; name=&quot;stc_enabled&quot; id=&quot;jetpack-comment-subscribe&quot; value=&quot;1&quot; &lt;?php checked( $stc_enabled, 1 ); ?&gt; /&gt;&nbsp;</div></li><li><div>            &lt;?php _e( &quot;Show a &lt;em&gt;'follow comments'&lt;/em&gt; option in the comment form&quot;, 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>        &lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function validate_settings( $settings ) {&nbsp;</div></li><li><div>        global $allowedposttags;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $default = $this-&gt;get_default_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Blog Follow&nbsp;</div></li><li><div>        $settings['invitation'] = trim( wp_kses( $settings['invitation'], $allowedposttags ) );&nbsp;</div></li><li><div>        if ( empty( $settings['invitation'] ) )&nbsp;</div></li><li><div>            $settings['invitation'] = $default['invitation'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Comments Follow (single post)&nbsp;</div></li><li><div>        $settings['comment_follow'] = trim( wp_kses( $settings['comment_follow'], $allowedposttags ) );&nbsp;</div></li><li><div>        if ( empty( $settings['comment_follow'] ) )&nbsp;</div></li><li><div>            $settings['comment_follow'] = $default['comment_follow'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $settings;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function reading_section() {&nbsp;</div></li><li><div>        echo '&lt;p id=&quot;follower-settings&quot;&gt;';&nbsp;</div></li><li><div>        _e( 'These settings change emails sent from your blog to followers.', 'jetpack' );&nbsp;</div></li><li><div>        echo '&lt;/p&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function setting_invitation() {&nbsp;</div></li><li><div>        $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>        echo '&lt;textarea name=&quot;subscription_options[invitation]&quot; class=&quot;large-text&quot; cols=&quot;50&quot; rows=&quot;5&quot;&gt;' . esc_textarea( $settings['invitation'] ) . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>        echo '&lt;p&gt;&lt;span class=&quot;description&quot;&gt;'.__( 'Introduction text sent when someone follows your blog. (Site and confirmation details will be automatically added for you.)', 'jetpack' ).'&lt;/span&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function setting_comment_follow() {&nbsp;</div></li><li><div>        $settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>        echo '&lt;textarea name=&quot;subscription_options[comment_follow]&quot; class=&quot;large-text&quot; cols=&quot;50&quot; rows=&quot;5&quot;&gt;' . esc_textarea( $settings['comment_follow'] ) . '&lt;/textarea&gt;';&nbsp;</div></li><li><div>        echo '&lt;p&gt;&lt;span class=&quot;description&quot;&gt;'.__( 'Introduction text sent when someone follows a post on your blog. (Site and confirmation details will be automatically added for you.)', 'jetpack' ).'&lt;/span&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_default_settings() {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'invitation' =&gt; __( &quot;Howdy.\n\nYou recently followed this blog's posts. This means you will receive each new post by email.\n\nTo activate, click confirm below. If you believe this is an error, ignore this message and we'll never bother you again.&quot;, 'jetpack' ), &nbsp;</div></li><li><div>            'comment_follow' =&gt; __( &quot;Howdy.\n\nYou recently followed one of my posts. This means you will receive an email when new comments are posted.\n\nTo activate, click confirm below. If you believe this is an error, ignore this message and we'll never bother you again.&quot;, 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_settings() {&nbsp;</div></li><li><div>        return wp_parse_args( (array) get_option( 'subscription_options', array() ), $this-&gt;get_default_settings() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::subscribe()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Send a synchronous XML-RPC subscribe to blog posts or subscribe to post comments request.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $email&nbsp;</div></li><li><div>     * @param array  $post_ids (optional) defaults to 0 for blog posts only: array of post IDs to subscribe to blog's posts&nbsp;</div></li><li><div>     * @param bool   $async    (optional) Should the subscription be performed asynchronously?  Defaults to true.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return true|Jetpack_Error true on success&nbsp;</div></li><li><div>     *    invalid_email   : not a valid email address&nbsp;</div></li><li><div>     *    invalid_post_id : not a valid post ID&nbsp;</div></li><li><div>     *    unknown_post_id : unknown post&nbsp;</div></li><li><div>     *    not_subscribed  : strange error.  Jetpack servers at WordPress.com could subscribe the email.&nbsp;</div></li><li><div>     *    disabled        : Site owner has disabled subscriptions.&nbsp;</div></li><li><div>     *    active          : Already subscribed.&nbsp;</div></li><li><div>     *    unknown         : strange error.  Jetpack servers at WordPress.com returned something malformed.&nbsp;</div></li><li><div>     *    unknown_status  : strange error.  Jetpack servers at WordPress.com returned something I didn't understand.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function subscribe( $email, $post_ids = 0, $async = true, $extra_data = array() ) {&nbsp;</div></li><li><div>        if ( !is_email( $email ) ) {&nbsp;</div></li><li><div>            return new Jetpack_Error( 'invalid_email' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$async ) {&nbsp;</div></li><li><div>            Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>            $xml = new Jetpack_IXR_ClientMulticall();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( (array) $post_ids as $post_id ) {&nbsp;</div></li><li><div>            $post_id = (int) $post_id;&nbsp;</div></li><li><div>            if ( $post_id &lt; 0 ) {&nbsp;</div></li><li><div>                return new Jetpack_Error( 'invalid_post_id' );&nbsp;</div></li><li><div>            } else if ( $post_id && !$post = get_post( $post_id ) ) {&nbsp;</div></li><li><div>                return new Jetpack_Error( 'unknown_post_id' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $async ) {&nbsp;</div></li><li><div>                Jetpack::xmlrpc_async_call( 'jetpack.subscribeToSite', $email, $post_id, serialize( $extra_data ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $xml-&gt;addCall( 'jetpack.subscribeToSite', $email, $post_id, serialize( $extra_data ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $async ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Call&nbsp;</div></li><li><div>        $xml-&gt;query();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $xml-&gt;isError() ) {&nbsp;</div></li><li><div>            return $xml-&gt;get_jetpack_error();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $responses = $xml-&gt;getResponse();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = array();&nbsp;</div></li><li><div>        foreach ( (array) $responses as $response ) {&nbsp;</div></li><li><div>            if ( isset( $response['faultCode'] ) || isset( $response['faultString'] ) ) {&nbsp;</div></li><li><div>                $r[] = $xml-&gt;get_jetpack_error( $response['faultCode'], $response['faultString'] );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !is_array( $response[0] ) || empty( $response[0]['status'] ) ) {&nbsp;</div></li><li><div>                $r[] = new Jetpack_Error( 'unknown' );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $response[0]['status'] ) {&nbsp;</div></li><li><div>            case 'error' :&nbsp;</div></li><li><div>                $r[] = new Jetpack_Error( 'not_subscribed' );&nbsp;</div></li><li><div>                continue 2;&nbsp;</div></li><li><div>            case 'disabled' :&nbsp;</div></li><li><div>                $r[] = new Jetpack_Error( 'disabled' );&nbsp;</div></li><li><div>                continue 2;&nbsp;</div></li><li><div>            case 'active' :&nbsp;</div></li><li><div>                $r[] = new Jetpack_Error( 'active' );&nbsp;</div></li><li><div>                continue 2;&nbsp;</div></li><li><div>            case 'pending' :&nbsp;</div></li><li><div>                $r[] = true;&nbsp;</div></li><li><div>                continue 2;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $r[] = new Jetpack_Error( 'unknown_status', (string) $response[0]['status'] );&nbsp;</div></li><li><div>                continue 2;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $r;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::widget_init()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Initialize and register the Jetpack Subscriptions widget.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function widget_init() {&nbsp;</div></li><li><div>        register_widget( 'Jetpack_Subscriptions_Widget' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::widget_submit()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * When a user submits their email via the blog subscription widget, check the details and call the subsribe() method.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function widget_submit() {&nbsp;</div></li><li><div>        // Check the nonce.&nbsp;</div></li><li><div>        if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>            check_admin_referer( 'blogsub_subscribe_' . get_current_blog_id() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $_REQUEST['email'] ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $redirect_fragment = false;&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['redirect_fragment'] ) ) {&nbsp;</div></li><li><div>            $redirect_fragment = preg_replace( '/[^a-z0-9_-]/i', '', $_REQUEST['redirect_fragment'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( !$redirect_fragment ) {&nbsp;</div></li><li><div>            $redirect_fragment = 'subscribe-blog';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $subscribe = Jetpack_Subscriptions::subscribe(&nbsp;</div></li><li><div>                                                $_REQUEST['email'], &nbsp;</div></li><li><div>                                                0, &nbsp;</div></li><li><div>                                                false, &nbsp;</div></li><li><div>                                                array(&nbsp;</div></li><li><div>                                                    'source' =&gt; 'widget', &nbsp;</div></li><li><div>                                                    'widget-in-use' =&gt; is_active_widget( false, false, 'blog_subscription', true ) ? 'yes' : 'no', &nbsp;</div></li><li><div>                                                    'comment_status' =&gt; '', &nbsp;</div></li><li><div>                                                    'server_data' =&gt; $_SERVER, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $subscribe ) ) {&nbsp;</div></li><li><div>            $error = $subscribe-&gt;get_error_code();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $error = false;&nbsp;</div></li><li><div>            foreach ( $subscribe as $response ) {&nbsp;</div></li><li><div>                if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>                    $error = $response-&gt;get_error_code();&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $error ) {&nbsp;</div></li><li><div>            case false:&nbsp;</div></li><li><div>                $result = 'success';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'invalid_email':&nbsp;</div></li><li><div>                $result = $error;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'active':&nbsp;</div></li><li><div>            case 'blocked_email':&nbsp;</div></li><li><div>                $result = 'opted_out';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'pending':&nbsp;</div></li><li><div>                $result = 'already';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                $result = 'error';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $redirect = add_query_arg( 'subscribe', $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires on each subscription form submission.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.7.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $result Result of form submission: success, invalid_email, already, error.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'jetpack_subscriptions_form_submission', $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_safe_redirect( &quot;$redirect#$redirect_fragment&quot; );&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::comment_subscribe_init()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Set up and add the comment subscription checkbox to the comment form.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function comment_subscribe_init() {&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comments_checked = '';&nbsp;</div></li><li><div>        $blog_checked = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for a comment / blog submission and set a cookie to retain the setting and check the boxes.&nbsp;</div></li><li><div>        if ( isset( $_COOKIE[ 'jetpack_comments_subscribe_' . self::$hash ] ) && $_COOKIE[ 'jetpack_comments_subscribe_' . self::$hash ] == $post-&gt;ID )&nbsp;</div></li><li><div>            $comments_checked = ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_COOKIE[ 'jetpack_blog_subscribe_' . self::$hash ] ) )&nbsp;</div></li><li><div>            $blog_checked = ' checked=&quot;checked&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Some themes call this function, don't show the checkbox again&nbsp;</div></li><li><div>        remove_action( 'comment_form', 'subscription_comment_form' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check if Mark Jaquith's Subscribe to Comments plugin is active - if so, suppress Jetpack checkbox&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $str = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( FALSE === has_filter( 'comment_form', 'show_subscription_checkbox' ) && 1 == get_option( 'stc_enabled', 1 ) && empty( $post-&gt;post_password ) ) {&nbsp;</div></li><li><div>            // Subscribe to comments checkbox&nbsp;</div></li><li><div>            $str .= '&lt;p class=&quot;comment-subscription-form&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;subscribe_comments&quot; id=&quot;subscribe_comments&quot; value=&quot;subscribe&quot; style=&quot;width: auto; -moz-appearance: checkbox; -webkit-appearance: checkbox;&quot;' . $comments_checked . ' /&gt; ';&nbsp;</div></li><li><div>            $comment_sub_text = __( 'Notify me of follow-up comments by email.', 'jetpack' );&nbsp;</div></li><li><div>            $str .=    '&lt;label class=&quot;subscribe-label&quot; id=&quot;subscribe-label&quot; for=&quot;subscribe_comments&quot;&gt;' . esc_html(&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Filter the Subscribe to comments text appearing below the comment form.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @module subscriptions&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.4.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param string $comment_sub_text Subscribe to comments text.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                apply_filters( 'jetpack_subscribe_comment_label', $comment_sub_text )&nbsp;</div></li><li><div> ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>            $str .= '&lt;/p&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 1 == get_option( 'stb_enabled', 1 ) ) {&nbsp;</div></li><li><div>            // Subscribe to blog checkbox&nbsp;</div></li><li><div>            $str .= '&lt;p class=&quot;comment-subscription-form&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;subscribe_blog&quot; id=&quot;subscribe_blog&quot; value=&quot;subscribe&quot; style=&quot;width: auto; -moz-appearance: checkbox; -webkit-appearance: checkbox;&quot;' . $blog_checked . ' /&gt; ';&nbsp;</div></li><li><div>            $blog_sub_text = __( 'Notify me of new posts by email.', 'jetpack' );&nbsp;</div></li><li><div>            $str .=    '&lt;label class=&quot;subscribe-label&quot; id=&quot;subscribe-blog-label&quot; for=&quot;subscribe_blog&quot;&gt;' . esc_html(&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Filter the Subscribe to blog text appearing below the comment form.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @module subscriptions&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.4.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param string $comment_sub_text Subscribe to blog text.&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                apply_filters( 'jetpack_subscribe_blog_label', $blog_sub_text )&nbsp;</div></li><li><div> ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>            $str .= '&lt;/p&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the output of the subscription options appearing below the comment form.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.2.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $str Comment Subscription form HTML output.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        echo apply_filters( 'jetpack_comment_subscription_form', $str );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::comment_subscribe_init()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * When a user checks the comment subscribe box and submits a comment, subscribe them to the comment thread.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function comment_subscribe_submit( $comment_id, $approved ) {&nbsp;</div></li><li><div>        if ( 'spam' === $approved ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set cookies for this post/comment&nbsp;</div></li><li><div>        $this-&gt;set_cookies( isset( $_REQUEST['subscribe_comments'] ), isset( $_REQUEST['subscribe_blog'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !isset( $_REQUEST['subscribe_comments'] ) && !isset( $_REQUEST['subscribe_blog'] ) )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>        $post_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['subscribe_comments'] ) )&nbsp;</div></li><li><div>            $post_ids[] = $comment-&gt;comment_post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['subscribe_blog'] ) )&nbsp;</div></li><li><div>            $post_ids[] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Subscriptions::subscribe(&nbsp;</div></li><li><div>                                    $comment-&gt;comment_author_email, &nbsp;</div></li><li><div>                                    $post_ids, &nbsp;</div></li><li><div>                                    true, &nbsp;</div></li><li><div>                                    array(&nbsp;</div></li><li><div>                                        'source' =&gt; 'comment-form', &nbsp;</div></li><li><div>                                        'widget-in-use' =&gt; is_active_widget( false, false, 'blog_subscription', true ) ? 'yes' : 'no', &nbsp;</div></li><li><div>                                        'comment_status' =&gt; $approved, &nbsp;</div></li><li><div>                                        'server_data' =&gt; $_SERVER, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Jetpack_Subscriptions::set_cookies()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Set a cookie to save state on the comment and post subscription checkboxes.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function set_cookies( $comments = true, $posts = true ) {&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** This filter is already documented in core/wp-includes/comment-functions.php */&nbsp;</div></li><li><div>        $cookie_lifetime = apply_filters( 'comment_cookie_lifetime', 30000000 );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Jetpack Comment cookie path.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.5.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string COOKIEPATH Cookie path.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $cookie_path = apply_filters( 'jetpack_comment_cookie_path', COOKIEPATH );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Jetpack Comment cookie domain.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module subscriptions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.5.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string COOKIE_DOMAIN Cookie domain.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $cookie_domain = apply_filters( 'jetpack_comment_cookie_domain', COOKIE_DOMAIN );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $comments )&nbsp;</div></li><li><div>            setcookie( 'jetpack_comments_subscribe_' . self::$hash, $post-&gt;ID, time() + $cookie_lifetime, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            setcookie( 'jetpack_comments_subscribe_' . self::$hash, '', time() - 3600, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $posts )&nbsp;</div></li><li><div>            setcookie( 'jetpack_blog_subscribe_' . self::$hash, 1, time() + $cookie_lifetime, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            setcookie( 'jetpack_blog_subscribe_' . self::$hash, '', time() - 3600, $cookie_path, $cookie_domain );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/classes/jetpack_subscriptions/" class="">3.8.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.1/classes/jetpack_subscriptions/" class="">3.8.1</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/jetpack_subscriptions/" class="active">3.8.0</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.2/classes/jetpack_subscriptions/" class="">3.7.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.1/classes/jetpack_subscriptions/" class="">3.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Jetpack_Subscriptions</li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>