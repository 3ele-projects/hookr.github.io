<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="class" data-id="12341"><head xmlns="http://www.w3.org/1999/xhtml"><title> jetpack_relatedposts | class | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Jetpack_RelatedPosts, class, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The Jetpack by WordPress.com Jetpack RelatedPosts class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=40e22eecc5ec2ebcfa2eb5bdbcb98527' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/jetpack_related_posts/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_related_posts%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_related_posts%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-class-jetpack_related_posts","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="jetpack_related_posts" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">jetpack_related_posts</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="active" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Jetpack_RelatedPosts</strong></h1><p>The Jetpack by WordPress.com <strong>Jetpack RelatedPosts</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/modules-related-posts-jetpack-related-posts/" class="file">/modules/related-posts/jetpack-related-posts.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="2" class="block" start="2"><li><div>class Jetpack_RelatedPosts {&nbsp;</div></li><li><div>    const VERSION = '20150408';&nbsp;</div></li><li><div>    const SHORTCODE = 'jetpack-related-posts';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates and returns a static instance of Jetpack_RelatedPosts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return Jetpack_RelatedPosts&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init() {&nbsp;</div></li><li><div>        static $instance = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $instance ) {&nbsp;</div></li><li><div>            if ( class_exists('WPCOM_RelatedPosts') && method_exists( 'WPCOM_RelatedPosts', 'init' ) ) {&nbsp;</div></li><li><div>                $instance = WPCOM_RelatedPosts::init();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $instance = new Jetpack_RelatedPosts(&nbsp;</div></li><li><div>                    get_current_blog_id(), &nbsp;</div></li><li><div>                    Jetpack_Options::get_option( 'id' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates and returns a static instance of Jetpack_RelatedPosts_Raw.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return Jetpack_RelatedPosts&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init_raw() {&nbsp;</div></li><li><div>        static $instance = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $instance ) {&nbsp;</div></li><li><div>            if ( class_exists('WPCOM_RelatedPosts') && method_exists( 'WPCOM_RelatedPosts', 'init_raw' ) ) {&nbsp;</div></li><li><div>                $instance = WPCOM_RelatedPosts::init_raw();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $instance = new Jetpack_RelatedPosts_Raw(&nbsp;</div></li><li><div>                    get_current_blog_id(), &nbsp;</div></li><li><div>                    Jetpack_Options::get_option( 'id' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    protected $_blog_id_local;&nbsp;</div></li><li><div>    protected $_blog_id_wpcom;&nbsp;</div></li><li><div>    protected $_options;&nbsp;</div></li><li><div>    protected $_allow_feature_toggle;&nbsp;</div></li><li><div>    protected $_blog_charset;&nbsp;</div></li><li><div>    protected $_convert_charset;&nbsp;</div></li><li><div>    protected $_previous_post_id;&nbsp;</div></li><li><div>    protected $_found_shortcode = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Constructor for Jetpack_RelatedPosts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $blog_id_local&nbsp;</div></li><li><div>     * @param int $blog_id_wpcom&nbsp;</div></li><li><div>     * @uses get_option, add_action, apply_filters&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct( $blog_id_local, $blog_id_wpcom ) {&nbsp;</div></li><li><div>        $this-&gt;_blog_id_local = $blog_id_local;&nbsp;</div></li><li><div>        $this-&gt;_blog_id_wpcom = $blog_id_wpcom;&nbsp;</div></li><li><div>        $this-&gt;_blog_charset = get_option( 'blog_charset' );&nbsp;</div></li><li><div>        $this-&gt;_convert_charset = ( function_exists( 'iconv' ) && ! preg_match( '/^utf\-?8$/i', $this-&gt;_blog_charset ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'admin_init', array( $this, 'action_admin_init' ) );&nbsp;</div></li><li><div>        add_action( 'wp', array( $this, 'action_frontend_init' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * =================&nbsp;</div></li><li><div>     * ACTIONS & FILTERS&nbsp;</div></li><li><div>     * =================&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add a checkbox field to Settings &gt; Reading for enabling related posts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @action admin_init&nbsp;</div></li><li><div>     * @uses add_settings_field, __, register_setting, add_action&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function action_admin_init() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add the setting field [jetpack_relatedposts] and place it in Settings &gt; Reading&nbsp;</div></li><li><div>        add_settings_field( 'jetpack_relatedposts', '&lt;span id=&quot;jetpack_relatedposts&quot;&gt;' . __( 'Related posts', 'jetpack' ) . '&lt;/span&gt;', array( $this, 'print_setting_html' ), 'reading' );&nbsp;</div></li><li><div>        register_setting( 'reading', 'jetpack_relatedposts', array( $this, 'parse_options' ) );&nbsp;</div></li><li><div>        add_action('admin_head', array( $this, 'print_setting_head' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( 'options-reading.php' == $GLOBALS['pagenow'] ) {&nbsp;</div></li><li><div>            // Enqueue style for live preview on the reading settings page&nbsp;</div></li><li><div>            $this-&gt;_enqueue_assets( false, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load related posts assets if it's a elegiable frontend page or execute search and return JSON if it's an endpoint request.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @global $_GET&nbsp;</div></li><li><div>     * @action wp&nbsp;</div></li><li><div>     * @uses add_shortcode, get_the_ID&nbsp;</div></li><li><div>     * @returns null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function action_frontend_init() {&nbsp;</div></li><li><div>        // Add a shortcode handler that outputs nothing, this gets overridden later if we can display related content&nbsp;</div></li><li><div>        add_shortcode( self::SHORTCODE, array( $this, 'get_target_html_unsupported' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $this-&gt;_enabled_for_request() )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['relatedposts'] ) ) {&nbsp;</div></li><li><div>            $excludes = array();&nbsp;</div></li><li><div>            if ( isset( $_GET['relatedposts_exclude'] ) ) {&nbsp;</div></li><li><div>                $excludes = explode( ', ', $_GET['relatedposts_exclude'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;_action_frontend_init_ajax( $excludes );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( isset( $_GET['relatedposts_hit'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;_log_click( $_GET['relatedposts_origin'], get_the_ID(), $_GET['relatedposts_position'] );&nbsp;</div></li><li><div>                $this-&gt;_previous_post_id = (int) $_GET['relatedposts_origin'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;_action_frontend_init_page();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds a target to the post content to load related posts into if a shortcode for it did not already exist.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @filter the_content&nbsp;</div></li><li><div>     * @param string $content&nbsp;</div></li><li><div>     * @returns string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function filter_add_target_to_dom( $content ) {&nbsp;</div></li><li><div>        if ( !$this-&gt;_found_shortcode ) {&nbsp;</div></li><li><div>            $content .= &quot;\n&quot; . $this-&gt;get_target_html();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $content;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Looks for our shortcode on the unfiltered content, this has to execute early.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @filter the_content&nbsp;</div></li><li><div>     * @param string $content&nbsp;</div></li><li><div>     * @uses has_shortcode&nbsp;</div></li><li><div>     * @returns string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function test_for_shortcode( $content ) {&nbsp;</div></li><li><div>        $this-&gt;_found_shortcode = has_shortcode( $content, self::SHORTCODE );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $content;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the HTML for the related posts section.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses esc_html__, apply_filters&nbsp;</div></li><li><div>     * @returns string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_target_html() {&nbsp;</div></li><li><div>        $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $options['show_headline'] ) {&nbsp;</div></li><li><div>            $headline = sprintf(&nbsp;</div></li><li><div>                '&lt;h3 class=&quot;jp-relatedposts-headline&quot;&gt;&lt;em&gt;%s&lt;/em&gt;&lt;/h3&gt;', &nbsp;</div></li><li><div>                esc_html__( 'Related', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $headline = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Related Posts headline.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.0.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $headline Related Posts heading.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $headline = apply_filters( 'jetpack_relatedposts_filter_headline', $headline );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;_previous_post_id ) {&nbsp;</div></li><li><div>            $exclude = &quot;data-exclude='{$this-&gt;_previous_post_id}'&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $exclude = &quot;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;div id='jp-relatedposts' class='jp-relatedposts' $exclude&gt;&nbsp;</div></li><li><div>    $headline&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the HTML for the related posts section if it's running in the loop or other instances where we don't support related posts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @returns string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_target_html_unsupported() {&nbsp;</div></li><li><div>        return &quot;\n\n&lt;!-- Jetpack Related Posts is not supported in this context. --&gt;\n\n&quot;;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * ========================&nbsp;</div></li><li><div>     * PUBLIC UTILITY FUNCTIONS&nbsp;</div></li><li><div>     * ========================&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Gets options set for Jetpack_RelatedPosts and merge with defaults.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses Jetpack_Options::get_option, apply_filters&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_options() {&nbsp;</div></li><li><div>        if ( null === $this-&gt;_options ) {&nbsp;</div></li><li><div>            $this-&gt;_options = Jetpack_Options::get_option( 'relatedposts' );&nbsp;</div></li><li><div>            if ( ! is_array( $this-&gt;_options ) )&nbsp;</div></li><li><div>                $this-&gt;_options = array();&nbsp;</div></li><li><div>            if ( ! isset( $this-&gt;_options['enabled'] ) )&nbsp;</div></li><li><div>                $this-&gt;_options['enabled'] = true;&nbsp;</div></li><li><div>            if ( ! isset( $this-&gt;_options['show_headline'] ) )&nbsp;</div></li><li><div>                $this-&gt;_options['show_headline'] = true;&nbsp;</div></li><li><div>            if ( ! isset( $this-&gt;_options['show_thumbnails'] ) )&nbsp;</div></li><li><div>                $this-&gt;_options['show_thumbnails'] = false;&nbsp;</div></li><li><div>            if ( empty( $this-&gt;_options['size'] ) || (int)$this-&gt;_options['size'] &lt; 1 )&nbsp;</div></li><li><div>                $this-&gt;_options['size'] = 3;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter Related Posts basic options.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module related-posts&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 2.8.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param array $this-&gt;_options Array of basic Related Posts options.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $this-&gt;_options = apply_filters( 'jetpack_relatedposts_filter_options', $this-&gt;_options );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;_options;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Parses input and returnes normalized options array.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $input&nbsp;</div></li><li><div>     * @uses self::get_options&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function parse_options( $input ) {&nbsp;</div></li><li><div>        $current = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !is_array( $input ) )&nbsp;</div></li><li><div>            $input = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $input['enabled'] ) && '1' == $input['enabled'] ) {&nbsp;</div></li><li><div>            $current['enabled'] = true;&nbsp;</div></li><li><div>            $current['show_headline'] = ( isset( $input['show_headline'] ) && '1' == $input['show_headline'] );&nbsp;</div></li><li><div>            $current['show_thumbnails'] = ( isset( $input['show_thumbnails'] ) && '1' == $input['show_thumbnails'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $current['enabled'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $input['size'] ) && (int)$input['size'] &gt; 0 )&nbsp;</div></li><li><div>            $current['size'] = (int)$input['size'];&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $current['size'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $current;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * HTML for admin settings page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses self::get_options, checked, esc_html__&nbsp;</div></li><li><div>     * @returns null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function print_setting_html() {&nbsp;</div></li><li><div>        $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ui_settings_template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;ul id=&quot;settings-reading-relatedposts-customize&quot;&gt;&nbsp;</div></li><li><div>    &lt;li&gt;&nbsp;</div></li><li><div>        &lt;label&gt;&lt;input name=&quot;jetpack_relatedposts[show_headline]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>    &lt;/li&gt;&nbsp;</div></li><li><div>    &lt;li&gt;&nbsp;</div></li><li><div>        &lt;label&gt;&lt;input name=&quot;jetpack_relatedposts[show_thumbnails]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>    &lt;/li&gt;&nbsp;</div></li><li><div>&lt;/ul&gt;&nbsp;</div></li><li><div>&lt;div id='settings-reading-relatedposts-preview'&gt;&nbsp;</div></li><li><div>    %s&nbsp;</div></li><li><div>    &lt;div id=&quot;jp-relatedposts&quot; class=&quot;jp-relatedposts&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>        $ui_settings = sprintf(&nbsp;</div></li><li><div>            $ui_settings_template, &nbsp;</div></li><li><div>            checked( $options['show_headline'], true, false ), &nbsp;</div></li><li><div>            esc_html__( 'Show a &quot;Related&quot; header to more clearly separate the related section from posts', 'jetpack' ), &nbsp;</div></li><li><div>            checked( $options['show_thumbnails'], true, false ), &nbsp;</div></li><li><div>            esc_html__( 'Use a large and visually striking layout', 'jetpack' ), &nbsp;</div></li><li><div>            esc_html__( 'Preview:', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$this-&gt;_allow_feature_toggle() ) {&nbsp;</div></li><li><div>            $template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;jetpack_relatedposts[enabled]&quot; value=&quot;1&quot; /&gt;&nbsp;</div></li><li><div>%s&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>            printf(&nbsp;</div></li><li><div>                $template, &nbsp;</div></li><li><div>                $ui_settings&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;ul id=&quot;settings-reading-relatedposts&quot;&gt;&nbsp;</div></li><li><div>    &lt;li&gt;&nbsp;</div></li><li><div>        &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;jetpack_relatedposts[enabled]&quot; value=&quot;0&quot; class=&quot;tog&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>    &lt;/li&gt;&nbsp;</div></li><li><div>    &lt;li&gt;&nbsp;</div></li><li><div>        &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;jetpack_relatedposts[enabled]&quot; value=&quot;1&quot; class=&quot;tog&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>        %s&nbsp;</div></li><li><div>    &lt;/li&gt;&nbsp;</div></li><li><div>&lt;/ul&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>            printf(&nbsp;</div></li><li><div>                $template, &nbsp;</div></li><li><div>                checked( $options['enabled'], false, false ), &nbsp;</div></li><li><div>                esc_html__( 'Hide related content after posts', 'jetpack' ), &nbsp;</div></li><li><div>                checked( $options['enabled'], true, false ), &nbsp;</div></li><li><div>                esc_html__( 'Show related content after posts', 'jetpack' ), &nbsp;</div></li><li><div>                $ui_settings&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Head JS/CSS for admin settings page.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses esc_html__&nbsp;</div></li><li><div>     * @returns null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function print_setting_head() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // only dislay the Related Posts JavaScript on the Reading Settings Admin Page&nbsp;</div></li><li><div>        $current_screen =  get_current_screen();&nbsp;</div></li><li><div>        if( 'options-reading' != $current_screen-&gt;id )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $related_headline = sprintf(&nbsp;</div></li><li><div>            '&lt;h3 class=&quot;jp-relatedposts-headline&quot;&gt;&lt;em&gt;%s&lt;/em&gt;&lt;/h3&gt;', &nbsp;</div></li><li><div>            esc_html__( 'Related', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $href_params = 'class=&quot;jp-relatedposts-post-a&quot; href=&quot;#jetpack_relatedposts&quot; rel=&quot;nofollow&quot; data-origin=&quot;0&quot; data-position=&quot;0&quot;';&nbsp;</div></li><li><div>        $related_with_images = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;div class=&quot;jp-relatedposts-items jp-relatedposts-items-visual&quot;&gt;&nbsp;</div></li><li><div>    &lt;div class=&quot;jp-relatedposts-post jp-relatedposts-post0 jp-relatedposts-post-thumbs&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>        &lt;a $href_params&gt;&nbsp;</div></li><li><div>            &lt;img class=&quot;jp-relatedposts-post-img&quot; src=&quot;http://jetpackme.files.wordpress.com/2014/08/1-wpios-ipad-3-1-viewsite.png?w=350&amp;h=200&amp;crop=1&quot; width=&quot;350&quot; alt=&quot;Big iPhone/iPad Update Now Available&quot; scale=&quot;0&quot;&gt;&nbsp;</div></li><li><div>        &lt;/a&gt;&nbsp;</div></li><li><div>        &lt;h4 class=&quot;jp-relatedposts-post-title&quot;&gt;&nbsp;</div></li><li><div>            &lt;a $href_params&gt;Big iPhone/iPad Update Now Available&lt;/a&gt;&nbsp;</div></li><li><div>        &lt;/h4&gt;&nbsp;</div></li><li><div>        &lt;p class=&quot;jp-relatedposts-post-excerpt&quot;&gt;Big iPhone/iPad Update Now Available&lt;/p&gt;&nbsp;</div></li><li><div>        &lt;p class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;/div&gt;&nbsp;</div></li><li><div>    &lt;div class=&quot;jp-relatedposts-post jp-relatedposts-post1 jp-relatedposts-post-thumbs&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>        &lt;a $href_params&gt;&nbsp;</div></li><li><div>            &lt;img class=&quot;jp-relatedposts-post-img&quot; src=&quot;http://jetpackme.files.wordpress.com/2014/08/wordpress-com-news-wordpress-for-android-ui-update2.jpg?w=350&amp;h=200&amp;crop=1&quot; width=&quot;350&quot; alt=&quot;The WordPress for Android App Gets a Big Facelift&quot; scale=&quot;0&quot;&gt;&nbsp;</div></li><li><div>        &lt;/a&gt;&nbsp;</div></li><li><div>        &lt;h4 class=&quot;jp-relatedposts-post-title&quot;&gt;&nbsp;</div></li><li><div>            &lt;a $href_params&gt;The WordPress for Android App Gets a Big Facelift&lt;/a&gt;&nbsp;</div></li><li><div>        &lt;/h4&gt;&nbsp;</div></li><li><div>        &lt;p class=&quot;jp-relatedposts-post-excerpt&quot;&gt;The WordPress for Android App Gets a Big Facelift&lt;/p&gt;&nbsp;</div></li><li><div>        &lt;p class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;/div&gt;&nbsp;</div></li><li><div>    &lt;div class=&quot;jp-relatedposts-post jp-relatedposts-post2 jp-relatedposts-post-thumbs&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>        &lt;a $href_params&gt;&nbsp;</div></li><li><div>            &lt;img class=&quot;jp-relatedposts-post-img&quot; src=&quot;http://jetpackme.files.wordpress.com/2014/08/videopresswedding.jpg?w=350&amp;h=200&amp;crop=1&quot; width=&quot;350&quot; alt=&quot;Upgrade Focus: VideoPress For Weddings&quot; scale=&quot;0&quot;&gt;&nbsp;</div></li><li><div>        &lt;/a&gt;&nbsp;</div></li><li><div>        &lt;h4 class=&quot;jp-relatedposts-post-title&quot;&gt;&nbsp;</div></li><li><div>            &lt;a $href_params&gt;Upgrade Focus: VideoPress For Weddings&lt;/a&gt;&nbsp;</div></li><li><div>        &lt;/h4&gt;&nbsp;</div></li><li><div>        &lt;p class=&quot;jp-relatedposts-post-excerpt&quot;&gt;Upgrade Focus: VideoPress For Weddings&lt;/p&gt;&nbsp;</div></li><li><div>        &lt;p class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Upgrade&quot;&lt;/p&gt;&nbsp;</div></li><li><div>    &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>        $related_with_images = str_replace( &quot;\n&quot;, '', $related_with_images );&nbsp;</div></li><li><div>        $related_without_images = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;div class=&quot;jp-relatedposts-items jp-relatedposts-items-minimal&quot;&gt;&nbsp;</div></li><li><div>    &lt;p class=&quot;jp-relatedposts-post jp-relatedposts-post0&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;jp-relatedposts-post-title&quot;&gt;&lt;a $href_params&gt;Big iPhone/iPad Update Now Available&lt;/a&gt;&lt;/span&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/span&gt;&nbsp;</div></li><li><div>    &lt;/p&gt;&nbsp;</div></li><li><div>    &lt;p class=&quot;jp-relatedposts-post jp-relatedposts-post1&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;jp-relatedposts-post-title&quot;&gt;&lt;a $href_params&gt;The WordPress for Android App Gets a Big Facelift&lt;/a&gt;&lt;/span&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/span&gt;&nbsp;</div></li><li><div>    &lt;/p&gt;&nbsp;</div></li><li><div>    &lt;p class=&quot;jp-relatedposts-post jp-relatedposts-post2&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;jp-relatedposts-post-title&quot;&gt;&lt;a $href_params&gt;Upgrade Focus: VideoPress For Weddings&lt;/a&gt;&lt;/span&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Upgrade&quot;&lt;/span&gt;&nbsp;</div></li><li><div>    &lt;/p&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>        $related_without_images = str_replace( &quot;\n&quot;, '', $related_without_images );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;_allow_feature_toggle() ) {&nbsp;</div></li><li><div>            $extra_css = '#settings-reading-relatedposts-customize { padding-left:2em; margin-top:.5em; }';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $extra_css = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;style type=&quot;text/css&quot;&gt;&nbsp;</div></li><li><div>    #settings-reading-relatedposts .disabled { opacity:.5; filter:Alpha(opacity=50); }&nbsp;</div></li><li><div>    #settings-reading-relatedposts-preview .jp-relatedposts { background:#fff; padding:.5em; width:75%; }&nbsp;</div></li><li><div>    $extra_css&nbsp;</div></li><li><div>&lt;/style&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>    jQuery( document ).ready( function($) {&nbsp;</div></li><li><div>        var update_ui = function() {&nbsp;</div></li><li><div>            var is_enabled = true;&nbsp;</div></li><li><div>            if ( 'radio' == $( 'input[name=&quot;jetpack_relatedposts[enabled]&quot;]' ).attr('type') ) {&nbsp;</div></li><li><div>                if ( '0' == $( 'input[name=&quot;jetpack_relatedposts[enabled]&quot;]:checked' ).val() ) {&nbsp;</div></li><li><div>                    is_enabled = false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( is_enabled ) {&nbsp;</div></li><li><div>                $( '#settings-reading-relatedposts-customize' )&nbsp;</div></li><li><div>                    .removeClass( 'disabled' )&nbsp;</div></li><li><div>                    .find( 'input' )&nbsp;</div></li><li><div>                    .attr( 'disabled', false );&nbsp;</div></li><li><div>                $( '#settings-reading-relatedposts-preview' )&nbsp;</div></li><li><div>                    .removeClass( 'disabled' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $( '#settings-reading-relatedposts-customize' )&nbsp;</div></li><li><div>                    .addClass( 'disabled' )&nbsp;</div></li><li><div>                    .find( 'input' )&nbsp;</div></li><li><div>                    .attr( 'disabled', true );&nbsp;</div></li><li><div>                $( '#settings-reading-relatedposts-preview' )&nbsp;</div></li><li><div>                    .addClass( 'disabled' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        var update_preview = function() {&nbsp;</div></li><li><div>            var html = '';&nbsp;</div></li><li><div>            if ( $( 'input[name=&quot;jetpack_relatedposts[show_headline]&quot;]:checked' ).size() ) {&nbsp;</div></li><li><div>                html += '$related_headline';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $( 'input[name=&quot;jetpack_relatedposts[show_thumbnails]&quot;]:checked' ).size() ) {&nbsp;</div></li><li><div>                html += '$related_with_images';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                html += '$related_without_images';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $( '#settings-reading-relatedposts-preview .jp-relatedposts' )&nbsp;</div></li><li><div>                .html( html )&nbsp;</div></li><li><div>                .show();&nbsp;</div></li><li><div>        };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update on load&nbsp;</div></li><li><div>        update_preview();&nbsp;</div></li><li><div>        update_ui();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update on change&nbsp;</div></li><li><div>        $( '#settings-reading-relatedposts-customize input' )&nbsp;</div></li><li><div>            .change( update_preview );&nbsp;</div></li><li><div>        $( '#settings-reading-relatedposts' )&nbsp;</div></li><li><div>            .find( 'input.tog' )&nbsp;</div></li><li><div>            .change( update_ui );&nbsp;</div></li><li><div>    });&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Gets an array of related posts that match the given post_id.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @param array $args - params to use when building ElasticSearch filters to narrow down the search domain.&nbsp;</div></li><li><div>     * @uses self::get_options, get_post_type, wp_parse_args, apply_filters&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_for_post_id( $post_id, array $args ) {&nbsp;</div></li><li><div>        $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['size'] ) )&nbsp;</div></li><li><div>            $options['size'] = $args['size'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $options['enabled'] || 0 == (int)$post_id || empty( $options['size'] ) )&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'size' =&gt; (int)$options['size'], &nbsp;</div></li><li><div>            'post_type' =&gt; get_post_type( $post_id ), &nbsp;</div></li><li><div>            'post_formats' =&gt; array(), &nbsp;</div></li><li><div>            'has_terms' =&gt; array(), &nbsp;</div></li><li><div>            'date_range' =&gt; array(), &nbsp;</div></li><li><div>            'exclude_post_ids' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the arguments used to retrieve a list of Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args Array of options to retrieve Related Posts.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $args = apply_filters( 'jetpack_relatedposts_filter_args', $args, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filters = $this-&gt;_get_es_filters_from_args( $post_id, $args );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter ElasticSearch options used to calculate Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $filters Array of ElasticSearch filters based on the post_id and args.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $filters = apply_filters( 'jetpack_relatedposts_filter_filters', $filters, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;_get_related_posts( $post_id, $args['size'], $filters );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the array of related posts matched by ElasticSearch.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $results Array of related posts matched by ElasticSearch.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_relatedposts_returned_results', $results, $post_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * =========================&nbsp;</div></li><li><div>     * PRIVATE UTILITY FUNCTIONS&nbsp;</div></li><li><div>     * =========================&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates an array of ElasticSearch filters based on the post_id and args.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @param array $args&nbsp;</div></li><li><div>     * @uses apply_filters, get_post_types, get_post_format_strings&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_es_filters_from_args( $post_id, array $args ) {&nbsp;</div></li><li><div>        $filters = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the terms used to search for Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args['has_terms'] Array of terms associated to the Related Posts.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $args['has_terms'] = apply_filters( 'jetpack_relatedposts_filter_has_terms', $args['has_terms'], $post_id );&nbsp;</div></li><li><div>        if ( ! empty( $args['has_terms'] ) ) {&nbsp;</div></li><li><div>            foreach( (array)$args['has_terms'] as $term ) {&nbsp;</div></li><li><div>                if ( mb_strlen( $term-&gt;taxonomy ) ) {&nbsp;</div></li><li><div>                    switch ( $term-&gt;taxonomy ) {&nbsp;</div></li><li><div>                        case 'post_tag':&nbsp;</div></li><li><div>                            $tax_fld = 'tag.slug';&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>                        case 'category':&nbsp;</div></li><li><div>                            $tax_fld = 'category.slug';&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>                        default:&nbsp;</div></li><li><div>                            $tax_fld = 'taxonomy.' . $term-&gt;taxonomy . '.slug';&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $filters[] = array( 'term' =&gt; array( $tax_fld =&gt; $term-&gt;slug ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Post Types where we search Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args['post_type'] Array of Post Types.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $args['post_type'] = apply_filters( 'jetpack_relatedposts_filter_post_type', $args['post_type'], $post_id );&nbsp;</div></li><li><div>        $valid_post_types = get_post_types();&nbsp;</div></li><li><div>        if ( is_array( $args['post_type'] ) ) {&nbsp;</div></li><li><div>            $sanitized_post_types = array();&nbsp;</div></li><li><div>            foreach ( $args['post_type'] as $pt ) {&nbsp;</div></li><li><div>                if ( in_array( $pt, $valid_post_types ) )&nbsp;</div></li><li><div>                    $sanitized_post_types[] = $pt;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! empty( $sanitized_post_types ) )&nbsp;</div></li><li><div>                $filters[] = array( 'terms' =&gt; array( 'post_type' =&gt; $sanitized_post_types ) );&nbsp;</div></li><li><div>        } else if ( in_array( $args['post_type'], $valid_post_types ) && 'all' != $args['post_type'] ) {&nbsp;</div></li><li><div>            $filters[] = array( 'term' =&gt; array( 'post_type' =&gt; $args['post_type'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Post Formats where we search Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.3.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args['post_formats'] Array of Post Formats.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $args['post_formats'] = apply_filters( 'jetpack_relatedposts_filter_post_formats', $args['post_formats'], $post_id );&nbsp;</div></li><li><div>        $valid_post_formats = get_post_format_strings();&nbsp;</div></li><li><div>        $sanitized_post_formats = array();&nbsp;</div></li><li><div>        foreach ( $args['post_formats'] as $pf ) {&nbsp;</div></li><li><div>            if ( array_key_exists( $pf, $valid_post_formats ) ) {&nbsp;</div></li><li><div>                $sanitized_post_formats[] = $pf;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! empty( $sanitized_post_formats ) ) {&nbsp;</div></li><li><div>            $filters[] = array( 'terms' =&gt; array( 'post_format' =&gt; $sanitized_post_formats ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the date range used to search Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args['date_range'] Array of a month interval where we search Related Posts.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $args['date_range'] = apply_filters( 'jetpack_relatedposts_filter_date_range', $args['date_range'], $post_id );&nbsp;</div></li><li><div>        if ( is_array( $args['date_range'] ) && ! empty( $args['date_range'] ) ) {&nbsp;</div></li><li><div>            $args['date_range'] = array_map( 'intval', $args['date_range'] );&nbsp;</div></li><li><div>            if ( !empty( $args['date_range']['from'] ) && !empty( $args['date_range']['to'] ) ) {&nbsp;</div></li><li><div>                $filters[] = array(&nbsp;</div></li><li><div>                    'range' =&gt; array(&nbsp;</div></li><li><div>                        'date_gmt' =&gt; $this-&gt;_get_coalesced_range( $args['date_range'] ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Post IDs excluded from appearing in Related Posts.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args['exclude_post_ids'] Array of Post IDs.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $args['exclude_post_ids'] = apply_filters( 'jetpack_relatedposts_filter_exclude_post_ids', $args['exclude_post_ids'], $post_id );&nbsp;</div></li><li><div>        if ( !empty( $args['exclude_post_ids'] ) && is_array( $args['exclude_post_ids'] ) ) {&nbsp;</div></li><li><div>            foreach ( $args['exclude_post_ids'] as $exclude_post_id) {&nbsp;</div></li><li><div>                $exclude_post_id = (int)$exclude_post_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $exclude_post_id &gt; 0 )&nbsp;</div></li><li><div>                    $filters[] = array( 'not' =&gt; array( 'term' =&gt; array( 'post_id' =&gt; $exclude_post_id ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $filters;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Takes a range and coalesces it into a month interval bracketed by a time as determined by the blog_id to enhance caching.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $date_range&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_coalesced_range( array $date_range ) {&nbsp;</div></li><li><div>        $now = time();&nbsp;</div></li><li><div>        $coalesce_time = $this-&gt;_blog_id_wpcom % 86400;&nbsp;</div></li><li><div>        $current_time = $now - strtotime( 'today', $now );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $current_time &lt; $coalesce_time && '01' == date( 'd', $now ) ) {&nbsp;</div></li><li><div>            // Move back 1 period&nbsp;</div></li><li><div>            return array(&nbsp;</div></li><li><div>                'from' =&gt; date( 'Y-m-01', strtotime( '-1 month', $date_range['from'] ) ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div>                'to' =&gt; date( 'Y-m-01', $date_range['to'] ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Use current period&nbsp;</div></li><li><div>            return array(&nbsp;</div></li><li><div>                'from' =&gt; date( 'Y-m-01', $date_range['from'] ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div>                'to' =&gt; date( 'Y-m-01', strtotime( '+1 month', $date_range['to'] ) ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate and output ajax response for related posts API call.&nbsp;</div></li><li><div>     * NOTE: Calls exit() to end all further processing after payload has been outputed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $excludes array of post_ids to exclude&nbsp;</div></li><li><div>     * @uses send_nosniff_header, self::get_for_post_id, get_the_ID&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _action_frontend_init_ajax( array $excludes ) {&nbsp;</div></li><li><div>        define( 'DOING_AJAX', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        header( 'Content-type: application/json; charset=utf-8' ); // JSON can only be UTF-8&nbsp;</div></li><li><div>        send_nosniff_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $related_posts = $this-&gt;get_for_post_id(&nbsp;</div></li><li><div>            get_the_ID(), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'exclude_post_ids' =&gt; $excludes, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response = array(&nbsp;</div></li><li><div>            'version' =&gt; self::VERSION, &nbsp;</div></li><li><div>            'show_thumbnails' =&gt; (bool) $options['show_thumbnails'], &nbsp;</div></li><li><div>            'items' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( count( $related_posts ) == $options['size'] )&nbsp;</div></li><li><div>            $response['items'] = $related_posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo json_encode( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        exit();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a UTF-8 encoded array of post information for the given post_id&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @param int $position&nbsp;</div></li><li><div>     * @param int $origin The post id that this is related to&nbsp;</div></li><li><div>     * @uses get_post, get_permalink, remove_query_arg, get_post_format, apply_filters&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_related_post_data_for_post( $post_id, $position, $origin ) {&nbsp;</div></li><li><div>        $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'id' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div>            'url' =&gt; get_permalink( $post-&gt;ID ), &nbsp;</div></li><li><div>            'url_meta' =&gt; array( 'origin' =&gt; $origin, 'position' =&gt; $position ), &nbsp;</div></li><li><div>            'title' =&gt; $this-&gt;_to_utf8( $this-&gt;_get_title( $post-&gt;post_title, $post-&gt;post_content ) ), &nbsp;</div></li><li><div>            'date' =&gt; get_the_date( '', $post-&gt;ID ), &nbsp;</div></li><li><div>            'format' =&gt; get_post_format( $post-&gt;ID ), &nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filters the rel attribute for the Related Posts' links.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module related-posts&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 3.7.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string nofollow Link rel attribute for Related Posts' link. Default is nofollow.&nbsp;</div></li><li><div>             * @param int $post-&gt;ID Post ID.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            'rel' =&gt; apply_filters( 'jetpack_relatedposts_filter_post_link_rel', 'nofollow', $post-&gt;ID ), &nbsp;</div></li><li><div>            'excerpt' =&gt; html_entity_decode( $this-&gt;_to_utf8( $this-&gt;_get_excerpt( $post-&gt;post_excerpt, $post-&gt;post_content ) ), ENT_QUOTES, 'UTF-8' ), &nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter the context displayed below each Related Post.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module related-posts&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 3.0.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string $this-&gt;_to_utf8( $this-&gt;_generate_related_post_context( $post-&gt;ID ) ) Context displayed below each related post.&nbsp;</div></li><li><div>             * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            'context' =&gt; apply_filters(&nbsp;</div></li><li><div>                'jetpack_relatedposts_filter_post_context', &nbsp;</div></li><li><div>                $this-&gt;_to_utf8( $this-&gt;_generate_related_post_context( $post-&gt;ID ) ), &nbsp;</div></li><li><div>                $post-&gt;ID&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'img' =&gt; $this-&gt;_generate_related_post_image_params( $post-&gt;ID ), &nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter the post css classes added on HTML markup.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module related-posts&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 3.8.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param array array() CSS classes added on post HTML markup.&nbsp;</div></li><li><div>             * @param string $post_id Post ID.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            'classes' =&gt; apply_filters(&nbsp;</div></li><li><div>                'jetpack_relatedposts_filter_post_css_classes', &nbsp;</div></li><li><div>                array(), &nbsp;</div></li><li><div>                $post-&gt;ID&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns either the title or a small excerpt to use as title for post.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $post_title&nbsp;</div></li><li><div>     * @param string $post_content&nbsp;</div></li><li><div>     * @uses strip_shortcodes, wp_trim_words, __&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_title( $post_title, $post_content ) {&nbsp;</div></li><li><div>        if ( ! empty( $post_title ) ) {&nbsp;</div></li><li><div>            return wp_strip_all_tags( $post_title );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_title = wp_trim_words( wp_strip_all_tags( strip_shortcodes( $post_content ) ), 5, '*' );&nbsp;</div></li><li><div>        if ( ! empty( $post_title ) ) {&nbsp;</div></li><li><div>            return $post_title;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return __( 'Untitled Post', 'jetpack' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a plain text post excerpt for title attribute of links.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $post_excerpt&nbsp;</div></li><li><div>     * @param string $post_content&nbsp;</div></li><li><div>     * @uses strip_shortcodes, wp_strip_all_tags, wp_trim_words&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_excerpt( $post_excerpt, $post_content ) {&nbsp;</div></li><li><div>        if ( empty( $post_excerpt ) )&nbsp;</div></li><li><div>            $excerpt = $post_content;&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $excerpt = $post_excerpt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return wp_trim_words( wp_strip_all_tags( strip_shortcodes( $excerpt ) ), 50, '*' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates the thumbnail image to be used for the post. Uses the&nbsp;</div></li><li><div>     * image as returned by Jetpack_PostImages::get_image()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @uses self::get_options, apply_filters, Jetpack_PostImages::get_image, Jetpack_PostImages::fit_image_url&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _generate_related_post_image_params( $post_id ) {&nbsp;</div></li><li><div>        $options = $this-&gt;get_options();&nbsp;</div></li><li><div>        $image_params = array(&nbsp;</div></li><li><div>            'src' =&gt; '', &nbsp;</div></li><li><div>            'width' =&gt; 0, &nbsp;</div></li><li><div>            'height' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $options['show_thumbnails'] ) {&nbsp;</div></li><li><div>            return $image_params;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the size of the Related Posts images.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array array( 'width' =&gt; 350, 'height' =&gt; 200 ) Size of the images displayed below each Related Post.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $thumbnail_size = apply_filters(&nbsp;</div></li><li><div>            'jetpack_relatedposts_filter_thumbnail_size', &nbsp;</div></li><li><div>            array( 'width' =&gt; 350, 'height' =&gt; 200 )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        if ( !is_array( $thumbnail_size ) ) {&nbsp;</div></li><li><div>            $thumbnail_size = array(&nbsp;</div></li><li><div>                'width' =&gt; (int)$thumbnail_size, &nbsp;</div></li><li><div>                'height' =&gt; (int)$thumbnail_size&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Try to get post image&nbsp;</div></li><li><div>        if ( class_exists( 'Jetpack_PostImages' ) ) {&nbsp;</div></li><li><div>            $img_url = '';&nbsp;</div></li><li><div>            $post_image = Jetpack_PostImages::get_image(&nbsp;</div></li><li><div>                $post_id, &nbsp;</div></li><li><div>                $thumbnail_size&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array($post_image) ) {&nbsp;</div></li><li><div>                $img_url = $post_image['src'];&nbsp;</div></li><li><div>            } elseif ( class_exists( 'Jetpack_Media_Summary' ) ) {&nbsp;</div></li><li><div>                $media = Jetpack_Media_Summary::get( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_array($media) && !empty( $media['image'] ) ) {&nbsp;</div></li><li><div>                    $img_url = $media['image'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !empty( $img_url ) ) {&nbsp;</div></li><li><div>                $image_params['width'] = $thumbnail_size['width'];&nbsp;</div></li><li><div>                $image_params['height'] = $thumbnail_size['height'];&nbsp;</div></li><li><div>                $image_params['src'] = Jetpack_PostImages::fit_image_url(&nbsp;</div></li><li><div>                    $img_url, &nbsp;</div></li><li><div>                    $thumbnail_size['width'], &nbsp;</div></li><li><div>                    $thumbnail_size['height']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $image_params;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the string UTF-8 encoded&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $text&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _to_utf8( $text ) {&nbsp;</div></li><li><div>        if ( $this-&gt;_convert_charset ) {&nbsp;</div></li><li><div>            return iconv( $this-&gt;_blog_charset, 'UTF-8', $text );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $text;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * =============================================&nbsp;</div></li><li><div>     * PROTECTED UTILITY FUNCTIONS EXTENDED BY WPCOM&nbsp;</div></li><li><div>     * =============================================&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Workhorse method to return array of related posts matched by ElasticSearch.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @param int $size&nbsp;</div></li><li><div>     * @param array $filters&nbsp;</div></li><li><div>     * @uses wp_remote_post, is_wp_error, get_option, wp_remote_retrieve_body, get_post, add_query_arg, remove_query_arg, get_permalink, get_post_format, apply_filters&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_related_posts( $post_id, $size, array $filters ) {&nbsp;</div></li><li><div>        $hits = $this-&gt;_filter_non_public_posts(&nbsp;</div></li><li><div>            $this-&gt;_get_related_post_ids(&nbsp;</div></li><li><div>                $post_id, &nbsp;</div></li><li><div>                $size, &nbsp;</div></li><li><div>                $filters&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Related Posts matched by ElasticSearch.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.9.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $hits Array of Post IDs matched by ElasticSearch.&nbsp;</div></li><li><div>         * @param string $post_id Post ID of the post for which we are retrieving Related Posts.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $hits = apply_filters( 'jetpack_relatedposts_filter_hits', $hits, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $related_posts = array();&nbsp;</div></li><li><div>        foreach ( $hits as $i =&gt; $hit ) {&nbsp;</div></li><li><div>            $related_posts[] = $this-&gt;_get_related_post_data_for_post( $hit['id'], $i, $post_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $related_posts;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get array of related posts matched by ElasticSearch.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @param int $size&nbsp;</div></li><li><div>     * @param array $filters&nbsp;</div></li><li><div>     * @uses wp_remote_post, is_wp_error, wp_remote_retrieve_body, get_post_meta, update_post_meta&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _get_related_post_ids( $post_id, $size, array $filters ) {&nbsp;</div></li><li><div>        $now_ts = time();&nbsp;</div></li><li><div>        $cache_meta_key = '_jetpack_related_posts_cache';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $body = array(&nbsp;</div></li><li><div>            'size' =&gt; (int) $size, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty( $filters ) )&nbsp;</div></li><li><div>            $body['filter'] = array( 'and' =&gt; $filters );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Load all cached values&nbsp;</div></li><li><div>        $cache = get_post_meta( $post_id, $cache_meta_key, true );&nbsp;</div></li><li><div>        if ( empty( $cache ) )&nbsp;</div></li><li><div>            $cache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build cache key&nbsp;</div></li><li><div>        $cache_key = md5( serialize( $body ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cache is valid! Return cached value.&nbsp;</div></li><li><div>        if ( isset( $cache[ $cache_key ] ) && is_array( $cache[ $cache_key ] ) && $cache[ $cache_key ][ 'expires' ] &gt; $now_ts ) {&nbsp;</div></li><li><div>            return $cache[ $cache_key ][ 'payload' ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response = wp_remote_post(&nbsp;</div></li><li><div>            &quot;https://public-api.wordpress.com/rest/v1/sites/{$this-&gt;_blog_id_wpcom}/posts/$post_id/related/&quot;, &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'timeout' =&gt; 10, &nbsp;</div></li><li><div>                'user-agent' =&gt; 'jetpack_related_posts', &nbsp;</div></li><li><div>                'sslverify' =&gt; true, &nbsp;</div></li><li><div>                'body' =&gt; $body, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Oh no... return nothing don't cache errors.&nbsp;</div></li><li><div>        if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>            if ( isset( $cache[ $cache_key ] ) && is_array( $cache[ $cache_key ] ) )&nbsp;</div></li><li><div>                return $cache[ $cache_key ][ 'payload' ]; // return stale&nbsp;</div></li><li><div>            else&nbsp;</div></li><li><div>                return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = json_decode( wp_remote_retrieve_body( $response ), true );&nbsp;</div></li><li><div>        $related_posts = array();&nbsp;</div></li><li><div>        if ( is_array( $results ) && !empty( $results['hits'] ) ) {&nbsp;</div></li><li><div>            foreach( $results['hits'] as $hit ) {&nbsp;</div></li><li><div>                $related_posts[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $hit['fields']['post_id'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Copy all valid cache values&nbsp;</div></li><li><div>        $new_cache = array();&nbsp;</div></li><li><div>        foreach ( $cache as $k =&gt; $v ) {&nbsp;</div></li><li><div>            if ( is_array( $v ) && $v[ 'expires' ] &gt; $now_ts ) {&nbsp;</div></li><li><div>                $new_cache[ $k ] = $v;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set new cache value if valid&nbsp;</div></li><li><div>        if ( ! empty( $related_posts ) ) {&nbsp;</div></li><li><div>            $new_cache[ $cache_key ] = array(&nbsp;</div></li><li><div>                'expires' =&gt; 12 * HOUR_IN_SECONDS + $now_ts, &nbsp;</div></li><li><div>                'payload' =&gt; $related_posts, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update cache&nbsp;</div></li><li><div>        update_post_meta( $post_id, $cache_meta_key, $new_cache );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $related_posts;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Filter out any hits that are not public anymore.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $related_posts&nbsp;</div></li><li><div>     * @uses get_post_stati, get_post_status&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _filter_non_public_posts( array $related_posts ) {&nbsp;</div></li><li><div>        $public_stati = get_post_stati( array( 'public' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filtered = array();&nbsp;</div></li><li><div>        foreach ( $related_posts as $hit ) {&nbsp;</div></li><li><div>            if ( in_array( get_post_status( $hit['id'] ), $public_stati ) ) {&nbsp;</div></li><li><div>                $filtered[] = $hit;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $filtered;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates a context for the related content (second line in related post output).&nbsp;</div></li><li><div>     * Order of importance:&nbsp;</div></li><li><div>     *   - First category (Not 'Uncategorized')&nbsp;</div></li><li><div>     *   - First post tag&nbsp;</div></li><li><div>     *   - Number of comments&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $post_id&nbsp;</div></li><li><div>     * @uses get_the_category, get_the_terms, get_comments_number, number_format_i18n, __, _n&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _generate_related_post_context( $post_id ) {&nbsp;</div></li><li><div>        $categories = get_the_category( $post_id );&nbsp;</div></li><li><div>        if ( is_array( $categories ) ) {&nbsp;</div></li><li><div>            foreach ( $categories as $category ) {&nbsp;</div></li><li><div>                if ( 'uncategorized' != $category-&gt;slug && '' != trim( $category-&gt;name ) ) {&nbsp;</div></li><li><div>                    $post_cat_context = sprintf(&nbsp;</div></li><li><div>                        _x( 'In &quot;%s&quot;', 'in {category/tag name}', 'jetpack' ), &nbsp;</div></li><li><div>                        $category-&gt;name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Filter the &quot;In Category&quot; line displayed in the post context below each Related Post.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @module related-posts&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since 3.2.0&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param string $post_cat_context &quot;In Category&quot; line displayed in the post context below each Related Post.&nbsp;</div></li><li><div>                     * @param array $category Array containing information about the category.&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    return apply_filters( 'jetpack_relatedposts_post_category_context', $post_cat_context, $category );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tags = get_the_terms( $post_id, 'post_tag' );&nbsp;</div></li><li><div>        if ( is_array( $tags ) ) {&nbsp;</div></li><li><div>            foreach ( $tags as $tag ) {&nbsp;</div></li><li><div>                if ( '' != trim( $tag-&gt;name ) ) {&nbsp;</div></li><li><div>                    $post_tag_context = sprintf(&nbsp;</div></li><li><div>                        _x( 'In &quot;%s&quot;', 'in {category/tag name}', 'jetpack' ), &nbsp;</div></li><li><div>                        $tag-&gt;name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * Filter the &quot;In Tag&quot; line displayed in the post context below each Related Post.&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @module related-posts&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @since 3.2.0&nbsp;</div></li><li><div>                     *&nbsp;</div></li><li><div>                     * @param string $post_tag_context &quot;In Tag&quot; line displayed in the post context below each Related Post.&nbsp;</div></li><li><div>                     * @param array $tag Array containing information about the tag.&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    return apply_filters( 'jetpack_relatedposts_post_tag_context', $post_tag_context, $tag );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comment_count = get_comments_number( $post_id );&nbsp;</div></li><li><div>        if ( $comment_count &gt; 0 ) {&nbsp;</div></li><li><div>            return sprintf(&nbsp;</div></li><li><div>                _n( 'With 1 comment', 'With %s comments', $comment_count, 'jetpack' ), &nbsp;</div></li><li><div>                number_format_i18n( $comment_count )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return __( 'Similar post', 'jetpack' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Logs clicks for clickthrough analysis and related result tuning.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _log_click( $post_id, $to_post_id, $link_position ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines if the current post is able to use related posts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses self::get_options, is_admin, is_single, apply_filters&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _enabled_for_request() {&nbsp;</div></li><li><div>        // Default to enabled&nbsp;</div></li><li><div>        $enabled = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Must have feature enabled&nbsp;</div></li><li><div>        $options = $this-&gt;get_options();&nbsp;</div></li><li><div>        if ( ! $options['enabled'] ) {&nbsp;</div></li><li><div>            $enabled = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only run for frontend pages&nbsp;</div></li><li><div>        if ( is_admin() ) {&nbsp;</div></li><li><div>            $enabled = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only run for standalone posts&nbsp;</div></li><li><div>        if ( ! is_single() ) {&nbsp;</div></li><li><div>            $enabled = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the Enabled value to allow related posts to be shown on pages as well.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @module related-posts&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 3.3.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $enabled Should Related Posts be enabled on the current page.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'jetpack_relatedposts_filter_enabled_for_request', $enabled );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds filters and enqueues assets.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses self::_enqueue_assets, self::_setup_shortcode, add_filter&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _action_frontend_init_page() {&nbsp;</div></li><li><div>        $this-&gt;_enqueue_assets( true, true );&nbsp;</div></li><li><div>        $this-&gt;_setup_shortcode();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'the_content', array( $this, 'filter_add_target_to_dom' ), 40 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Enqueues assets needed to do async loading of related posts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses wp_enqueue_script, wp_enqueue_style, plugins_url&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _enqueue_assets( $script, $style ) {&nbsp;</div></li><li><div>        if ( $script )&nbsp;</div></li><li><div>            wp_enqueue_script( 'jetpack_related-posts', plugins_url( 'related-posts.js', __FILE__ ), array( 'jquery' ), self::VERSION );&nbsp;</div></li><li><div>        if ( $style ) {&nbsp;</div></li><li><div>            if( is_rtl() ) {&nbsp;</div></li><li><div>                wp_enqueue_style( 'jetpack_related-posts', plugins_url( 'rtl/related-posts-rtl.css', __FILE__ ), array(), self::VERSION );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                wp_enqueue_style( 'jetpack_related-posts', plugins_url( 'related-posts.css', __FILE__ ), array(), self::VERSION );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets up the shortcode processing.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @uses add_filter, add_shortcode&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function _setup_shortcode() {&nbsp;</div></li><li><div>        add_filter( 'the_content', array( $this, 'test_for_shortcode' ), 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_shortcode( self::SHORTCODE, array( $this, 'get_target_html' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    protected function _allow_feature_toggle() {&nbsp;</div></li><li><div>        if ( null === $this-&gt;_allow_feature_toggle ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Filter the display of the Related Posts toggle in Settings &gt; Reading.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @module related-posts&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @since 2.8.0&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param bool false Display a feature toggle. Default to false.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $this-&gt;_allow_feature_toggle = apply_filters( 'jetpack_relatedposts_filter_allow_feature_toggle', false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $this-&gt;_allow_feature_toggle;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/classes/jetpack_related_posts/" class="">3.8.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.1/classes/jetpack_related_posts/" class="">3.8.1</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/jetpack_related_posts/" class="active">3.8.0</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.2/classes/jetpack_related_posts/" class="">3.7.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.1/classes/jetpack_related_posts/" class="">3.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Jetpack_RelatedPosts</li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>