<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="class" data-id="12516"><head xmlns="http://www.w3.org/1999/xhtml"><title> jetpack_sync | class | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Jetpack_Sync, class, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The Jetpack by WordPress.com Jetpack Sync class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=1e7670e04410a4dc475debbbdbecd7b0' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/jetpack_sync/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_sync%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_sync%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-class-jetpack_sync","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="jetpack_sync" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">jetpack_sync</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="active" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Jetpack_Sync</strong></h1><p>Request that a piece of data on this WordPress install be synced back to the Jetpack server for remote processing/notifications/etc.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/class-jetpack-sync/" class="file">/class.jetpack-sync.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="7" class="block" start="7"><li><div>class Jetpack_Sync {&nbsp;</div></li><li><div>    // What modules want to sync what content&nbsp;</div></li><li><div>    public $sync_conditions = array( 'posts' =&gt; array(), 'comments' =&gt; array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // We keep track of all the options registered for sync so that we can sync them all if needed&nbsp;</div></li><li><div>    public $sync_options = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $sync_constants = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Keep trac of status transitions, which we wouldn't always know about on the Jetpack Servers but are important when deciding what to do with the sync.&nbsp;</div></li><li><div>    public $post_transitions = array();&nbsp;</div></li><li><div>    public $comment_transitions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Objects to sync&nbsp;</div></li><li><div>    public $sync = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        // WP Cron action.  Only used on upgrade&nbsp;</div></li><li><div>        add_action( 'jetpack_sync_all_registered_options', array( $this, 'sync_all_registered_options' ) );&nbsp;</div></li><li><div>        add_action( 'jetpack_heartbeat', array( $this, 'sync_all_registered_options' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sync constants on heartbeat and plugin upgrade and connects&nbsp;</div></li><li><div>        add_action( 'jetpack_sync_all_registered_options', array( $this, 'sync_all_constants' ) );&nbsp;</div></li><li><div>        add_action( 'jetpack_heartbeat', array( $this, 'sync_all_constants' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'jetpack_activate_module', array( $this, 'sync_module_constants' ), 10, 1 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Static Methods for Modules */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $file __FILE__&nbsp;</div></li><li><div>     * @param array settings:&nbsp;</div></li><li><div>     *     post_types =&gt; array( post_type slugs ): The post types to sync.  Default: post, page&nbsp;</div></li><li><div>     *    post_stati =&gt; array( post_status slugs ): The post stati to sync.  Default: publish&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function sync_posts( $file, array $settings = null ) {&nbsp;</div></li><li><div>        if ( is_network_admin() ) return;&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>        $args = func_get_args();&nbsp;</div></li><li><div>        return call_user_func_array( array( $jetpack-&gt;sync, 'posts' ), $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $file __FILE__&nbsp;</div></li><li><div>     * @param array settings:&nbsp;</div></li><li><div>     *     post_types =&gt; array( post_type slugs ): The post types to sync.     Default: post, page&nbsp;</div></li><li><div>     *    post_stati =&gt; array( post_status slugs ): The post stati to sync.     Default: publish&nbsp;</div></li><li><div>     *    comment_types =&gt; array( comment_type slugs ): The comment types to sync.  Default: '', comment, trackback, pingback&nbsp;</div></li><li><div>     *     comment_stati =&gt; array( comment_status slugs ): The comment stati to sync.  Default: approved&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function sync_comments( $file, array $settings = null ) {&nbsp;</div></li><li><div>        if ( is_network_admin() ) return;&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>        $args = func_get_args();&nbsp;</div></li><li><div>        return call_user_func_array( array( $jetpack-&gt;sync, 'comments' ), $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $file __FILE__&nbsp;</div></li><li><div>     * @param string $option, Option name to sync&nbsp;</div></li><li><div>     * @param string $option ...&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function sync_options( $file, $option /**, $option, ... */ ) {&nbsp;</div></li><li><div>        if ( is_network_admin() ) return;&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>        $args = func_get_args();&nbsp;</div></li><li><div>        return call_user_func_array( array( $jetpack-&gt;sync, 'options' ), $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param string $file __FILE__&nbsp;</div></li><li><div>     * @param string $option, Option name to sync&nbsp;</div></li><li><div>     * @param string $option ...&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function sync_constant( $file, $constant ) {&nbsp;</div></li><li><div>        if ( is_network_admin() ) return;&nbsp;</div></li><li><div>        $jetpack = Jetpack::init();&nbsp;</div></li><li><div>        $args = func_get_args();&nbsp;</div></li><li><div>        return call_user_func_array( array( $jetpack-&gt;sync, 'constant' ), $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Internal Methods */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a sync object/request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $object Type of object to sync -- [ post | comment | option ]&nbsp;</div></li><li><div>     * @param int $id Unique identifier&nbsp;</div></li><li><div>     * @param array $settings&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function register( $object, $id = false, array $settings = null ) {&nbsp;</div></li><li><div>        // Since we've registered something for sync, hook it up to execute on shutdown if we haven't already&nbsp;</div></li><li><div>        if ( !$this-&gt;sync ) {&nbsp;</div></li><li><div>            if ( function_exists( 'ignore_user_abort' ) ) {&nbsp;</div></li><li><div>                ignore_user_abort( true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            add_action( 'shutdown', array( $this, 'sync' ), 9 ); // Right before async XML-RPC&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'on_behalf_of' =&gt; array(), // What modules want this data&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $settings = wp_parse_args( $settings, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !isset( $this-&gt;sync[$object] ) ) {&nbsp;</div></li><li><div>            $this-&gt;sync[$object] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Store the settings for this object&nbsp;</div></li><li><div>        if (&nbsp;</div></li><li><div>            // First time for this object&nbsp;</div></li><li><div>            !isset( $this-&gt;sync[$object][$id] )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>            // Easy: store the current settings&nbsp;</div></li><li><div>            $this-&gt;sync[$object][$id] = $settings;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Not as easy:  we have to manually merge the settings from previous runs for this object with the settings for this run&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;sync[$object][$id]['on_behalf_of'] = array_unique( array_merge( $this-&gt;sync[$object][$id]['on_behalf_of'], $settings['on_behalf_of'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $delete_prefix = 'delete_';&nbsp;</div></li><li><div>        if ( 0 === strpos( $object, $delete_prefix ) ) {&nbsp;</div></li><li><div>            $unset_object = substr( $object, strlen( $delete_prefix ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $unset_object = &quot;{$delete_prefix}{$object}&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure post ... delete_post yields a delete operation&nbsp;</div></li><li><div>        // Ensure delete_post ... post yields a sync post operation&nbsp;</div></li><li><div>        // Ensure update_option() ... delete_option() ends up as a delete&nbsp;</div></li><li><div>        // Ensure delete_option() ... update_option() ends up as an update&nbsp;</div></li><li><div>        // Etc.&nbsp;</div></li><li><div>        unset( $this-&gt;sync[$unset_object][$id] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_common_sync_data() {&nbsp;</div></li><li><div>        $available_modules = Jetpack::get_available_modules();&nbsp;</div></li><li><div>        $active_modules = Jetpack::get_active_modules();&nbsp;</div></li><li><div>        $modules = array();&nbsp;</div></li><li><div>        foreach ( $available_modules as $available_module ) {&nbsp;</div></li><li><div>            $modules[$available_module] = in_array( $available_module, $active_modules );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $modules['vaultpress'] = class_exists( 'VaultPress' ) || function_exists( 'vaultpress_contact_service' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sync_data = array(&nbsp;</div></li><li><div>            'modules' =&gt; $modules, &nbsp;</div></li><li><div>            'version' =&gt; JETPACK__VERSION, &nbsp;</div></li><li><div>            'is_multisite' =&gt; is_multisite(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sync_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set up all the data and queue it for the outgoing XML-RPC request&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function sync() {&nbsp;</div></li><li><div>        if ( !$this-&gt;sync ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Don't sync anything from a staging site.&nbsp;</div></li><li><div>        if ( Jetpack::is_development_mode() || Jetpack::jetpack_is_staging_site() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sync_data = $this-&gt;get_common_sync_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wp_importing = defined( 'WP_IMPORTING' ) && WP_IMPORTING;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;sync as $sync_operation_type =&gt; $sync_operations ) {&nbsp;</div></li><li><div>            switch ( $sync_operation_type ) {&nbsp;</div></li><li><div>            case 'post':&nbsp;</div></li><li><div>                if ( $wp_importing ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $global_post = isset( $GLOBALS['post'] ) ? $GLOBALS['post'] : null;&nbsp;</div></li><li><div>                $GLOBALS['post'] = null;&nbsp;</div></li><li><div>                foreach ( $sync_operations as $post_id =&gt; $settings ) {&nbsp;</div></li><li><div>                    $sync_data['post'][$post_id] = $this-&gt;get_post( $post_id );&nbsp;</div></li><li><div>                    if ( isset( $this-&gt;post_transitions[$post_id] ) ) {&nbsp;</div></li><li><div>                        $sync_data['post'][$post_id]['transitions'] = $this-&gt;post_transitions[$post_id];&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $sync_data['post'][$post_id]['transitions'] = array( false, false );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $sync_data['post'][$post_id]['on_behalf_of'] = $settings['on_behalf_of'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $GLOBALS['post'] = $global_post;&nbsp;</div></li><li><div>                unset( $global_post );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'comment':&nbsp;</div></li><li><div>                if ( $wp_importing ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $global_comment = isset( $GLOBALS['comment'] ) ? $GLOBALS['comment'] : null;&nbsp;</div></li><li><div>                unset( $GLOBALS['comment'] );&nbsp;</div></li><li><div>                foreach ( $sync_operations as $comment_id =&gt; $settings ) {&nbsp;</div></li><li><div>                    $sync_data['comment'][$comment_id] = $this-&gt;get_comment( $comment_id );&nbsp;</div></li><li><div>                    if ( isset( $this-&gt;comment_transitions[$comment_id] ) ) {&nbsp;</div></li><li><div>                        $sync_data['comment'][$comment_id]['transitions'] = $this-&gt;comment_transitions[$comment_id];&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $sync_data['comment'][$comment_id]['transitions'] = array( false, false );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $sync_data['comment'][$comment_id]['on_behalf_of'] = $settings['on_behalf_of'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $GLOBALS['comment'] = $global_comment;&nbsp;</div></li><li><div>                unset( $global_comment );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'option' :&nbsp;</div></li><li><div>                foreach ( $sync_operations as $option =&gt; $settings ) {&nbsp;</div></li><li><div>                    $sync_data['option'][ $option ] = array( 'value' =&gt; get_option( $option ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'constant' :&nbsp;</div></li><li><div>                foreach( $sync_operations as $constant =&gt; $settings ) {&nbsp;</div></li><li><div>                    $sync_data['constant'][ $constant ] = array( 'value' =&gt; $this-&gt;get_constant( $constant ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'delete_post':&nbsp;</div></li><li><div>            case 'delete_comment':&nbsp;</div></li><li><div>                foreach ( $sync_operations as $object_id =&gt; $settings ) {&nbsp;</div></li><li><div>                    $sync_data[$sync_operation_type][$object_id] = array( 'on_behalf_of' =&gt; $settings['on_behalf_of'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'delete_option' :&nbsp;</div></li><li><div>                foreach ( $sync_operations as $object_id =&gt; $settings ) {&nbsp;</div></li><li><div>                    $sync_data[$sync_operation_type][$object_id] = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        Jetpack::xmlrpc_async_call( 'jetpack.syncContent', $sync_data );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Format and return content data from a direct xmlrpc request for it.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $content_ids: array( 'posts' =&gt; array of ids, 'comments' =&gt; array of ids, 'options' =&gt; array of options )&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_content( $content_ids ) {&nbsp;</div></li><li><div>        $sync_data = $this-&gt;get_common_sync_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $content_ids['posts'] ) ) {&nbsp;</div></li><li><div>            foreach ( $content_ids['posts'] as $id ) {&nbsp;</div></li><li><div>                $sync_data['post'][$id] = $this-&gt;get_post( $id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $content_ids['comments'] ) ) {&nbsp;</div></li><li><div>            foreach ( $content_ids['comments'] as $id ) {&nbsp;</div></li><li><div>                $sync_data['comment'][$id] = $this-&gt;get_post( $id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $content_ids['options'] ) ) {&nbsp;</div></li><li><div>            foreach ( $content_ids['options'] as $option ) {&nbsp;</div></li><li><div>                $sync_data['option'][$option] = array( 'value' =&gt; get_option( $option ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sync_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method for registering a post for sync&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id wp_posts.ID&nbsp;</div></li><li><div>     * @param array $settings Sync data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function register_post( $id, array $settings = null ) {&nbsp;</div></li><li><div>        $id = (int) $id;&nbsp;</div></li><li><div>        if ( !$id ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post = get_post( $id );&nbsp;</div></li><li><div>        if ( !$post ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $settings = wp_parse_args( $settings, array(&nbsp;</div></li><li><div>            'on_behalf_of' =&gt; array(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;register( 'post', $id, $settings );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method for registering a comment for sync&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id wp_comments.comment_ID&nbsp;</div></li><li><div>     * @param array $settings Sync data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function register_comment( $id, array $settings = null ) {&nbsp;</div></li><li><div>        $id = (int) $id;&nbsp;</div></li><li><div>        if ( !$id ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comment = get_comment( $id );&nbsp;</div></li><li><div>        if ( !$comment || empty( $comment-&gt;comment_post_ID ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post = get_post( $comment-&gt;comment_post_ID );&nbsp;</div></li><li><div>        if ( !$post ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $settings = wp_parse_args( $settings, array(&nbsp;</div></li><li><div>            'on_behalf_of' =&gt; array(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;register( 'comment', $id, $settings );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Posts Sync */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function posts( $file, array $settings = null ) {&nbsp;</div></li><li><div>        $module_slug = Jetpack::get_module_slug( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'post_types' =&gt; array( 'post', 'page' ), &nbsp;</div></li><li><div>            'post_stati' =&gt; array( 'publish' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;sync_conditions['posts'][$module_slug] = wp_parse_args( $settings, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'transition_post_status', array( $this, 'transition_post_status_action' ), 10, 3 );&nbsp;</div></li><li><div>        add_action( 'delete_post', array( $this, 'delete_post_action' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function delete_post_action( $post_id ) {&nbsp;</div></li><li><div>        $post = get_post( $post_id );&nbsp;</div></li><li><div>        if ( !$post ) {&nbsp;</div></li><li><div>            return $this-&gt;register( 'delete_post', (int) $post_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;transition_post_status_action( 'delete', $post-&gt;post_status, $post );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function transition_post_status_action( $new_status, $old_status, $post ) {&nbsp;</div></li><li><div>        $sync = $this-&gt;get_post_sync_operation( $new_status, $old_status, $post, $this-&gt;sync_conditions['posts'] );&nbsp;</div></li><li><div>        if ( !$sync ) {&nbsp;</div></li><li><div>            // No module wants to sync this post&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Track post transitions&nbsp;</div></li><li><div>        if ( isset( $this-&gt;post_transitions[$post-&gt;ID] ) ) {&nbsp;</div></li><li><div>            // status changed more than once - keep tha most recent $new_status&nbsp;</div></li><li><div>            $this-&gt;post_transitions[$post-&gt;ID][0] = $new_status;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;post_transitions[$post-&gt;ID] = array( $new_status, $old_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $operation = $sync['operation'];&nbsp;</div></li><li><div>        unset( $sync['operation'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $operation ) {&nbsp;</div></li><li><div>        case 'delete' :&nbsp;</div></li><li><div>            return $this-&gt;register( 'delete_post', (int) $post-&gt;ID, $sync );&nbsp;</div></li><li><div>        case 'submit' :&nbsp;</div></li><li><div>            return $this-&gt;register_post( (int) $post-&gt;ID, $sync );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function get_post_sync_operation( $new_status, $old_status, $post, $module_conditions ) {&nbsp;</div></li><li><div>        $delete_on_behalf_of = array();&nbsp;</div></li><li><div>        $submit_on_behalf_of = array();&nbsp;</div></li><li><div>        $delete_stati = array( 'delete' );&nbsp;</div></li><li><div>        $cache_cleared = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $module_conditions as $module =&gt; $conditions ) {&nbsp;</div></li><li><div>            if ( !in_array( $post-&gt;post_type, $conditions['post_types'] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $deleted_post = in_array( $new_status, $delete_stati );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $deleted_post ) {&nbsp;</div></li><li><div>                $delete_on_behalf_of[] = $module;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( ! $cache_cleared ) {&nbsp;</div></li><li><div>                    // inefficient to clear cache more than once&nbsp;</div></li><li><div>                    clean_post_cache( $post-&gt;ID );&nbsp;</div></li><li><div>                    $cache_cleared = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $new_status = get_post_status( $post-&gt;ID ); // Inherited status is resolved here&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $old_status_in_stati = in_array( $old_status, $conditions['post_stati'] );&nbsp;</div></li><li><div>            $new_status_in_stati = in_array( $new_status, $conditions['post_stati'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $old_status_in_stati && !$new_status_in_stati ) {&nbsp;</div></li><li><div>                // Jetpack no longer needs the post&nbsp;</div></li><li><div>                if ( !$deleted_post ) {&nbsp;</div></li><li><div>                    $delete_on_behalf_of[] = $module;&nbsp;</div></li><li><div>                } // else, we've already flagged it above&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !$new_status_in_stati ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // At this point, we know we want to sync the post, not delete it&nbsp;</div></li><li><div>            $submit_on_behalf_of[] = $module;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty( $submit_on_behalf_of ) ) {&nbsp;</div></li><li><div>            return array( 'operation' =&gt; 'submit', 'on_behalf_of' =&gt; $submit_on_behalf_of );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty( $delete_on_behalf_of ) ) {&nbsp;</div></li><li><div>            return array( 'operation' =&gt; 'delete', 'on_behalf_of' =&gt; $delete_on_behalf_of );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a post and associated data in the standard JP format.&nbsp;</div></li><li><div>     * Cannot be called statically&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id Post ID&nbsp;</div></li><li><div>     * @return Array containing full post details&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_post( $id ) {&nbsp;</div></li><li><div>        $post_obj = get_post( $id );&nbsp;</div></li><li><div>        if ( !$post_obj )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_callable( $post_obj, 'to_array' ) ) {&nbsp;</div></li><li><div>            // WP &gt;= 3.5&nbsp;</div></li><li><div>            $post = $post_obj-&gt;to_array();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // WP &lt; 3.5&nbsp;</div></li><li><div>            $post = get_object_vars( $post_obj );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 0 &lt; strlen( $post['post_password'] ) ) {&nbsp;</div></li><li><div>            $post['post_password'] = 'auto-' . wp_generate_password( 10, false ); // We don't want the real password.  Just pass something random.&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // local optimizations&nbsp;</div></li><li><div>        unset(&nbsp;</div></li><li><div>            $post['filter'], &nbsp;</div></li><li><div>            $post['ancestors'], &nbsp;</div></li><li><div>            $post['post_content_filtered'], &nbsp;</div></li><li><div>            $post['to_ping'], &nbsp;</div></li><li><div>            $post['pinged']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;is_post_public( $post ) ) {&nbsp;</div></li><li><div>            $post['post_is_public'] = Jetpack_Options::get_option( 'public' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            //obscure content&nbsp;</div></li><li><div>            $post['post_content'] = '';&nbsp;</div></li><li><div>            $post['post_excerpt'] = '';&nbsp;</div></li><li><div>            $post['post_is_public'] = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $post_type_obj = get_post_type_object( $post['post_type'] );&nbsp;</div></li><li><div>        $post['post_is_excluded_from_search'] = $post_type_obj-&gt;exclude_from_search;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post['tax'] = array();&nbsp;</div></li><li><div>        $taxonomies = get_object_taxonomies( $post_obj );&nbsp;</div></li><li><div>        foreach ( $taxonomies as $taxonomy ) {&nbsp;</div></li><li><div>            $terms = get_object_term_cache( $post_obj-&gt;ID, $taxonomy );&nbsp;</div></li><li><div>            if ( empty( $terms ) )&nbsp;</div></li><li><div>                $terms = wp_get_object_terms( $post_obj-&gt;ID, $taxonomy );&nbsp;</div></li><li><div>            $term_names = array();&nbsp;</div></li><li><div>            foreach ( $terms as $term ) {&nbsp;</div></li><li><div>                $term_names[] = $term-&gt;name;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $post['tax'][$taxonomy] = $term_names;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $meta = get_post_meta( $post_obj-&gt;ID, false );&nbsp;</div></li><li><div>        $post['meta'] = array();&nbsp;</div></li><li><div>        foreach ( $meta as $key =&gt; $value ) {&nbsp;</div></li><li><div>            $post['meta'][$key] = array_map( 'maybe_unserialize', $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post['extra'] = array(&nbsp;</div></li><li><div>            'author' =&gt; get_the_author_meta( 'display_name', $post_obj-&gt;post_author ), &nbsp;</div></li><li><div>            'author_email' =&gt; get_the_author_meta( 'email', $post_obj-&gt;post_author ), &nbsp;</div></li><li><div>            'dont_email_post_to_subs' =&gt; get_post_meta( $post_obj-&gt;ID, '_jetpack_dont_email_post_to_subs', true ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $fid = get_post_thumbnail_id( $id ) ) {&nbsp;</div></li><li><div>            $feature = wp_get_attachment_image_src( $fid, 'large' );&nbsp;</div></li><li><div>            if ( ! empty( $feature[0] ) ) {&nbsp;</div></li><li><div>                $post['extra']['featured_image'] = $feature[0];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment = get_post( $fid );&nbsp;</div></li><li><div>            if ( ! empty( $attachment ) ) {&nbsp;</div></li><li><div>                $metadata = wp_get_attachment_metadata( $fid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $post['extra']['post_thumbnail'] = array(&nbsp;</div></li><li><div>                    'ID' =&gt; (int) $fid, &nbsp;</div></li><li><div>                    'URL' =&gt; (string) wp_get_attachment_url( $fid ), &nbsp;</div></li><li><div>                    'guid' =&gt; (string) $attachment-&gt;guid, &nbsp;</div></li><li><div>                    'mime_type' =&gt; (string) $attachment-&gt;post_mime_type, &nbsp;</div></li><li><div>                    'width' =&gt; (int) isset( $metadata['width'] ) ? $metadata['width'] : 0, &nbsp;</div></li><li><div>                    'height' =&gt; (int) isset( $metadata['height'] ) ? $metadata['height'] : 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $metadata['duration'] ) ) {&nbsp;</div></li><li><div>                    $post['extra']['post_thumbnail'] = (int) $metadata['duration'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * Filters the Post Thumbnail information returned for a specific post.&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @since 3.3.0&nbsp;</div></li><li><div>                 *&nbsp;</div></li><li><div>                 * @param array $post['extra']['post_thumbnail'] {&nbsp;</div></li><li><div>                 *     Array of details about the Post Thumbnail.&nbsp;</div></li><li><div>                 *    @param int ID Post Thumbnail ID.&nbsp;</div></li><li><div>                 *    @param string URL Post thumbnail URL.&nbsp;</div></li><li><div>                 *    @param string guid Post thumbnail guid.&nbsp;</div></li><li><div>                 *    @param string mime_type Post thumbnail mime type.&nbsp;</div></li><li><div>                 *    @param int width Post thumbnail width.&nbsp;</div></li><li><div>                 *    @param int height Post thumbnail height.&nbsp;</div></li><li><div>                 * }&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $post['extra']['post_thumbnail'] = (object) apply_filters( 'get_attachment', $post['extra']['post_thumbnail'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post['permalink'] = get_permalink( $post_obj-&gt;ID );&nbsp;</div></li><li><div>        $post['shortlink'] = wp_get_shortlink( $post_obj-&gt;ID );&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allow modules to send extra info on the sync post process.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 2.8.0&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $args Array of custom data to attach to a post.&nbsp;</div></li><li><div>         * @param Object $post_obj Object returned by get_post() for a given post ID.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $post['module_custom_data'] = apply_filters( 'jetpack_sync_post_module_custom_data', array(), $post_obj );&nbsp;</div></li><li><div>        return $post;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Decide whether a post/page/attachment is visible to the public.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $post&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function is_post_public( $post ) {&nbsp;</div></li><li><div>        if ( !is_array( $post ) ) {&nbsp;</div></li><li><div>            $post = (array) $post;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 0 &lt; strlen( $post['post_password'] ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        if ( ! in_array( $post['post_type'], get_post_types( array( 'public' =&gt; true ) ) ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        $post_status = get_post_status( $post['ID'] ); // Inherited status is resolved here.&nbsp;</div></li><li><div>        if ( ! in_array( $post_status, get_post_stati( array( 'public' =&gt; true ) ) ) )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Comments Sync */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function comments( $file, array $settings = null ) {&nbsp;</div></li><li><div>        $module_slug = Jetpack::get_module_slug( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'post_types' =&gt; array( 'post', 'page' ), // For what post types will we sync comments?&nbsp;</div></li><li><div>            'post_stati' =&gt; array( 'publish' ), // For what post stati will we sync comments?&nbsp;</div></li><li><div>            'comment_types' =&gt; array( '', 'comment', 'trackback', 'pingback' ), // What comment types will we sync?&nbsp;</div></li><li><div>            'comment_stati' =&gt; array( 'approved' ), // What comment stati will we sync?&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $settings = wp_parse_args( $settings, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;sync_conditions['comments'][$module_slug] = $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wp_insert_comment', array( $this, 'wp_insert_comment_action' ), 10, 2 );&nbsp;</div></li><li><div>        add_action( 'transition_comment_status', array( $this, 'transition_comment_status_action' ), 10, 3 );&nbsp;</div></li><li><div>        add_action( 'edit_comment', array( $this, 'edit_comment_action' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This is really annoying.  If you edit a comment, but don't change the status, WordPress doesn't fire the transition_comment_status hook.&nbsp;</div></li><li><div>     * That means we have to catch these comments on the edit_comment hook, but ignore comments on that hook when the transition_comment_status does fire.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function edit_comment_action( $comment_id ) {&nbsp;</div></li><li><div>        $comment = get_comment( $comment_id );&nbsp;</div></li><li><div>        $new_status = $this-&gt;translate_comment_status( $comment-&gt;comment_approved );&nbsp;</div></li><li><div>        add_action( &quot;comment_{$new_status}_{$comment-&gt;comment_type}&quot;, array( $this, 'transition_comment_status_for_comments_whose_status_does_not_change' ), 10, 2 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function wp_insert_comment_action( $comment_id, $comment ) {&nbsp;</div></li><li><div>        $this-&gt;transition_comment_status_action( $comment-&gt;comment_approved, 'new', $comment );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function transition_comment_status_for_comments_whose_status_does_not_change( $comment_id, $comment ) {&nbsp;</div></li><li><div>        if ( isset( $this-&gt;comment_transitions[$comment_id] ) ) {&nbsp;</div></li><li><div>            return $this-&gt;transition_comment_status_action( $comment-&gt;comment_approved, $this-&gt;comment_transitions[$comment_id][1], $comment );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;transition_comment_status_action( $comment-&gt;comment_approved, $comment-&gt;comment_approved, $comment );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function translate_comment_status( $status ) {&nbsp;</div></li><li><div>        switch ( (string) $status ) {&nbsp;</div></li><li><div>        case '0' :&nbsp;</div></li><li><div>        case 'hold' :&nbsp;</div></li><li><div>            return 'unapproved';&nbsp;</div></li><li><div>        case '1' :&nbsp;</div></li><li><div>        case 'approve' :&nbsp;</div></li><li><div>            return 'approved';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $status;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function transition_comment_status_action( $new_status, $old_status, $comment ) {&nbsp;</div></li><li><div>        $post = get_post( $comment-&gt;comment_post_ID );&nbsp;</div></li><li><div>        if ( !$post ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( array( 'new_status', 'old_status' ) as $_status ) {&nbsp;</div></li><li><div>            $$_status = $this-&gt;translate_comment_status( $$_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Track comment transitions&nbsp;</div></li><li><div>        if ( isset( $this-&gt;comment_transitions[$comment-&gt;comment_ID] ) ) {&nbsp;</div></li><li><div>            // status changed more than once - keep tha most recent $new_status&nbsp;</div></li><li><div>            $this-&gt;comment_transitions[$comment-&gt;comment_ID][0] = $new_status;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;comment_transitions[$comment-&gt;comment_ID] = array( $new_status, $old_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_sync = $this-&gt;get_post_sync_operation( $post-&gt;post_status, '_jetpack_test_sync', $post, $this-&gt;sync_conditions['comments'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$post_sync ) {&nbsp;</div></li><li><div>            // No module wants to sync this comment because its post doesn't match any sync conditions&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'delete' == $post_sync['operation'] ) {&nbsp;</div></li><li><div>            // Had we been looking at post sync operations (instead of comment sync operations), &nbsp;</div></li><li><div>            // this comment's post would have been deleted.  Don't sync the comment.&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $delete_on_behalf_of = array();&nbsp;</div></li><li><div>        $submit_on_behalf_of = array();&nbsp;</div></li><li><div>        $delete_stati = array( 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;sync_conditions['comments'] as $module =&gt; $conditions ) {&nbsp;</div></li><li><div>            if ( !in_array( $comment-&gt;comment_type, $conditions['comment_types'] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $deleted_comment = in_array( $new_status, $delete_stati );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $deleted_comment ) {&nbsp;</div></li><li><div>                $delete_on_behalf_of[] = $module;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $old_status_in_stati = in_array( $old_status, $conditions['comment_stati'] );&nbsp;</div></li><li><div>            $new_status_in_stati = in_array( $new_status, $conditions['comment_stati'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $old_status_in_stati && !$new_status_in_stati ) {&nbsp;</div></li><li><div>                // Jetpack no longer needs the comment&nbsp;</div></li><li><div>                if ( !$deleted_comment ) {&nbsp;</div></li><li><div>                    $delete_on_behalf_of[] = $module;&nbsp;</div></li><li><div>                } // else, we've already flagged it above&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( !$new_status_in_stati ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // At this point, we know we want to sync the comment, not delete it&nbsp;</div></li><li><div>            $submit_on_behalf_of[] = $module;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $submit_on_behalf_of ) ) {&nbsp;</div></li><li><div>            $this-&gt;register_post( $comment-&gt;comment_post_ID, array( 'on_behalf_of' =&gt; $submit_on_behalf_of ) );&nbsp;</div></li><li><div>            return $this-&gt;register_comment( $comment-&gt;comment_ID, array( 'on_behalf_of' =&gt; $submit_on_behalf_of ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !empty( $delete_on_behalf_of ) ) {&nbsp;</div></li><li><div>            return $this-&gt;register( 'delete_comment', $comment-&gt;comment_ID, array( 'on_behalf_of' =&gt; $delete_on_behalf_of ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a comment and associated data in the standard JP format.&nbsp;</div></li><li><div>     * Cannot be called statically&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id Comment ID&nbsp;</div></li><li><div>     * @return Array containing full comment details&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_comment( $id ) {&nbsp;</div></li><li><div>        $comment_obj = get_comment( $id );&nbsp;</div></li><li><div>        if ( !$comment_obj )&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        $comment = get_object_vars( $comment_obj );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $meta = get_comment_meta( $id, false );&nbsp;</div></li><li><div>        $comment['meta'] = array();&nbsp;</div></li><li><div>        foreach ( $meta as $key =&gt; $value ) {&nbsp;</div></li><li><div>            $comment['meta'][$key] = array_map( 'maybe_unserialize', $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $comment;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Options Sync */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** Ah... so much simpler than Posts and Comments :) */&nbsp;</div></li><li><div>    function options( $file, $option /**, $option, ... */ ) {&nbsp;</div></li><li><div>        $options = func_get_args();&nbsp;</div></li><li><div>        $file = array_shift( $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $module_slug = Jetpack::get_module_slug( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !isset( $this-&gt;sync_options[$module_slug] ) ) {&nbsp;</div></li><li><div>            $this-&gt;sync_options[$module_slug] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $options as $option ) {&nbsp;</div></li><li><div>            $this-&gt;sync_options[$module_slug][] = $option;&nbsp;</div></li><li><div>            add_action( &quot;delete_option_{$option}&quot;, array( $this, 'deleted_option_action' ) );&nbsp;</div></li><li><div>            add_action( &quot;update_option_{$option}&quot;, array( $this, 'updated_option_action' ) );&nbsp;</div></li><li><div>            add_action( &quot;add_option_{$option}&quot;, array( $this, 'added_option_action' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;sync_options[$module_slug] = array_unique( $this-&gt;sync_options[$module_slug] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function deleted_option_action( $option ) {&nbsp;</div></li><li><div>        $this-&gt;register( 'delete_option', $option );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function updated_option_action() {&nbsp;</div></li><li><div>        // The value of $option isn't passed to the filter&nbsp;</div></li><li><div>        // Calculate it&nbsp;</div></li><li><div>        $option = current_filter();&nbsp;</div></li><li><div>        $prefix = 'update_option_';&nbsp;</div></li><li><div>        if ( 0 !== strpos( $option, $prefix ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $option = substr( $option, strlen( $prefix ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;added_option_action( $option );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function added_option_action( $option ) {&nbsp;</div></li><li><div>        $this-&gt;register( 'option', $option );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sync_all_module_options( $module_slug ) {&nbsp;</div></li><li><div>        if ( empty( $this-&gt;sync_options[$module_slug] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;sync_options[$module_slug] as $option ) {&nbsp;</div></li><li><div>            $this-&gt;added_option_action( $option );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sync_all_registered_options() {&nbsp;</div></li><li><div>        if ( 'jetpack_sync_all_registered_options' == current_filter() ) {&nbsp;</div></li><li><div>            add_action( 'shutdown', array( $this, 'register_all_options' ), 8 );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wp_schedule_single_event( time(), 'jetpack_sync_all_registered_options', array( $this-&gt;sync_options ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * All the options that are defined in modules as well as class.jetpack.php will get synced.&nbsp;</div></li><li><div>     * Registers all options to be synced.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function register_all_options() {&nbsp;</div></li><li><div>        $all_registered_options = array_unique( call_user_func_array( 'array_merge', $this-&gt;sync_options ) );&nbsp;</div></li><li><div>        foreach ( $all_registered_options as $option ) {&nbsp;</div></li><li><div>            $this-&gt;added_option_action( $option );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** Constants Sync */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function sync_all_constants() {&nbsp;</div></li><li><div>        // list of contants to sync needed by Jetpack&nbsp;</div></li><li><div>        $constants = array(&nbsp;</div></li><li><div>            'EMPTY_TRASH_DAYS', &nbsp;</div></li><li><div>            'WP_POST_REVISIONS', &nbsp;</div></li><li><div>            'UPDATER_DISABLED', &nbsp;</div></li><li><div>            'AUTOMATIC_UPDATER_DISABLED', &nbsp;</div></li><li><div>            'ABSPATH', &nbsp;</div></li><li><div>            'WP_CONTENT_DIR', &nbsp;</div></li><li><div>            'FS_METHOD', &nbsp;</div></li><li><div>            'DISALLOW_FILE_EDIT', &nbsp;</div></li><li><div>            'DISALLOW_FILE_MODS', &nbsp;</div></li><li><div>            'WP_AUTO_UPDATE_CORE', &nbsp;</div></li><li><div>            'AUTOMATIC_UPDATER_DISABLED', &nbsp;</div></li><li><div>            'WP_HTTP_BLOCK_EXTERNAL', &nbsp;</div></li><li><div>            'WP_ACCESSIBLE_HOSTS', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add the constant to sync.&nbsp;</div></li><li><div>        foreach( $constants as $contant ) {&nbsp;</div></li><li><div>            $this-&gt;register_constant( $contant );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'shutdown', array( $this, 'register_all_module_constants' ), 8 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function register_all_module_constants() {&nbsp;</div></li><li><div>        // also add the contstants from each module to be synced.&nbsp;</div></li><li><div>        foreach( $this-&gt;sync_constants as $module ) {&nbsp;</div></li><li><div>            foreach( $module as $constant ) {&nbsp;</div></li><li><div>                $this-&gt;register_constant( $constant );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sync constants required by the module that was just activated.&nbsp;</div></li><li><div>      * If you add Jetpack_Sync::sync_constant( __FILE__, 'HELLO_WORLD' );&nbsp;</div></li><li><div>     * to the module it will start syncing the constant after the constant has been updated.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This function gets called on module activation.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function sync_module_constants( $module ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $this-&gt;sync_constants[ $module ] ) && is_array( $this-&gt;sync_constants[ $module ] ) ) {&nbsp;</div></li><li><div>            // also add the contstants from each module to be synced.&nbsp;</div></li><li><div>            foreach( $this-&gt;sync_constants[ $module ] as $constant ) {&nbsp;</div></li><li><div>                $this-&gt;register_constant(  $constant );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function reindex_needed() {&nbsp;</div></li><li><div>        return ( $this-&gt;_get_post_count_local() != $this-&gt;_get_post_count_cloud() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function reindex_trigger() {&nbsp;</div></li><li><div>        $response = array( 'status' =&gt; 'ERROR' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Force a privacy check&nbsp;</div></li><li><div>        Jetpack::check_privacy( JETPACK__PLUGIN_FILE );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $client = new Jetpack_IXR_Client( array(&nbsp;</div></li><li><div>            'user_id' =&gt; JETPACK_MASTER_USER, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $client-&gt;query( 'jetpack.reindexTrigger' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$client-&gt;isError() ) {&nbsp;</div></li><li><div>            $response = $client-&gt;getResponse();&nbsp;</div></li><li><div>            Jetpack_Options::update_option( 'sync_bulk_reindexing', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $response;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function reindex_status() {&nbsp;</div></li><li><div>        $response = array( 'status' =&gt; 'ERROR' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Assume reindexing is done if it was not triggered in the first place&nbsp;</div></li><li><div>        if ( false === Jetpack_Options::get_option( 'sync_bulk_reindexing' ) ) {&nbsp;</div></li><li><div>            return array( 'status' =&gt; 'DONE' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>        $client = new Jetpack_IXR_Client( array(&nbsp;</div></li><li><div>            'user_id' =&gt; JETPACK_MASTER_USER, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $client-&gt;query( 'jetpack.reindexStatus' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$client-&gt;isError() ) {&nbsp;</div></li><li><div>            $response = $client-&gt;getResponse();&nbsp;</div></li><li><div>            if ( 'DONE' == $response['status'] ) {&nbsp;</div></li><li><div>                Jetpack_Options::delete_option( 'sync_bulk_reindexing' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $response;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function reindex_ui() {&nbsp;</div></li><li><div>        $strings = json_encode( array(&nbsp;</div></li><li><div>            'WAITING' =&gt; array(&nbsp;</div></li><li><div>                'action' =&gt; __( 'Refresh Status', 'jetpack' ), &nbsp;</div></li><li><div>                'status' =&gt; __( 'Indexing request queued and waiting&hellip;', 'jetpack' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'INDEXING' =&gt; array(&nbsp;</div></li><li><div>                'action' =&gt; __( 'Refresh Status', 'jetpack' ), &nbsp;</div></li><li><div>                'status' =&gt; __( 'Indexing posts', 'jetpack' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'DONE' =&gt; array(&nbsp;</div></li><li><div>                'action' =&gt; __( 'Reindex Posts', 'jetpack' ), &nbsp;</div></li><li><div>                'status' =&gt; __( 'Posts indexed.', 'jetpack' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'ERROR' =&gt; array(&nbsp;</div></li><li><div>                'action' =&gt; __( 'Refresh Status', 'jetpack' ), &nbsp;</div></li><li><div>                'status' =&gt; __( 'Status unknown.', 'jetpack' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'ERROR:LARGE' =&gt; array(&nbsp;</div></li><li><div>                'action' =&gt; __( 'Refresh Status', 'jetpack' ), &nbsp;</div></li><li><div>                'status' =&gt; __( 'This site is too large, please contact Jetpack support to sync.', 'jetpack' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_script(&nbsp;</div></li><li><div>            'jetpack_sync_reindex_control', &nbsp;</div></li><li><div>            plugins_url( '_inc/jquery.jetpack-sync.js', JETPACK__PLUGIN_FILE ), &nbsp;</div></li><li><div>            array( 'jquery' ), &nbsp;</div></li><li><div>            JETPACK__VERSION&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>            &lt;p class=&quot;jetpack_sync_reindex_control&quot; id=&quot;jetpack_sync_reindex_control&quot; data-strings=&quot;%s&quot;&gt;&nbsp;</div></li><li><div>                &lt;input type=&quot;submit&quot; class=&quot;jetpack_sync_reindex_control_action button&quot; value=&quot;%s&quot; disabled /&gt;&nbsp;</div></li><li><div>                &lt;span class=&quot;jetpack_sync_reindex_control_status&quot;&gt;&hellip;&lt;/span&gt;&nbsp;</div></li><li><div>            &lt;/p&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return sprintf(&nbsp;</div></li><li><div>            $template, &nbsp;</div></li><li><div>            esc_attr( $strings ), &nbsp;</div></li><li><div>            esc_attr__( 'Refresh Status', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _get_post_count_local() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return (int) $wpdb-&gt;get_var(&nbsp;</div></li><li><div>            &quot;SELECT count(*)&nbsp;</div></li><li><div>                FROM {$wpdb-&gt;posts}&nbsp;</div></li><li><div>                WHERE post_status = 'publish' AND post_password = ''&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _get_post_count_cloud() {&nbsp;</div></li><li><div>        $blog_id = Jetpack::init()-&gt;get_option( 'id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $body = array(&nbsp;</div></li><li><div>            'size' =&gt; 1, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response = wp_remote_post(&nbsp;</div></li><li><div>            &quot;https://public-api.wordpress.com/rest/v1/sites/$blog_id/search&quot;, &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'timeout' =&gt; 10, &nbsp;</div></li><li><div>                'user-agent' =&gt; 'jetpack_related_posts', &nbsp;</div></li><li><div>                'sslverify' =&gt; true, &nbsp;</div></li><li><div>                'body' =&gt; $body, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>            return 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = json_decode( wp_remote_retrieve_body( $response ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return (int) $results['results']['total'];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sometimes we need to fake options to be able to sync data with .com&nbsp;</div></li><li><div>     * This is a helper function. That will make it easier to do just that.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * It will make sure that the options are synced when do_action( 'jetpack_sync_all_registered_options' );&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Which should happen everytime we update Jetpack to a new version or daily by Jetpack_Heartbeat.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * $callback is a function that is passed into a filter that returns the value of the option.&nbsp;</div></li><li><div>     * This value should never be false. Since we want to short circuit the get_option function&nbsp;</div></li><li><div>     * to return the value of the our callback.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * You can also trigger an update when a something else changes by calling the&nbsp;</div></li><li><div>     * do_action( 'add_option_jetpack_' . $option, 'jetpack_'.$option, $callback_function );&nbsp;</div></li><li><div>     * on the action that should that would trigger the update.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $option   Option will always be prefixed with Jetpack and be saved on .com side&nbsp;</div></li><li><div>     * @param  string or array  $callback&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function mock_option( $option , $callback ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'pre_option_jetpack_'. $option, $callback );&nbsp;</div></li><li><div>        // This shouldn't happen but if it does we return the same as before.&nbsp;</div></li><li><div>        add_filter( 'option_jetpack_'. $option, $callback );&nbsp;</div></li><li><div>        // Instead of passing a file we just pass in a string.&nbsp;</div></li><li><div>        $this-&gt;options( 'mock-option' , 'jetpack_' . $option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sometimes you need to sync constants to .com&nbsp;</div></li><li><div>     * Using the function will allow you to do just that.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  'string' $constant Constants defined in code.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function register_constant( $constant ) {&nbsp;</div></li><li><div>        $this-&gt;register( 'constant', $constant );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Simular to $this-&gt;options() function.&nbsp;</div></li><li><div>     * Add the constant to be synced to .com when we activate the module.&nbsp;</div></li><li><div>     * As well as on heartbeat and plugin upgrade and connection to .com.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $file&nbsp;</div></li><li><div>     * @param string $constant&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function constant( $file, $constant ) {&nbsp;</div></li><li><div>        $constants = func_get_args();&nbsp;</div></li><li><div>        $file = array_shift( $constants );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $module_slug = Jetpack::get_module_slug( $file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;sync_constants[ $module_slug ] ) ) {&nbsp;</div></li><li><div>            $this-&gt;sync_constants[ $module_slug ] = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $constants as $constant ) {&nbsp;</div></li><li><div>            $this-&gt;sync_constants[ $module_slug ][] = $constant;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper function to return the constants value.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $constant&nbsp;</div></li><li><div>     * @return value of the constant or null if the constant is set to false or doesn't exits.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    static function get_constant( $constant ) {&nbsp;</div></li><li><div>        if ( defined( $constant ) ) {&nbsp;</div></li><li><div>            return constant( $constant );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.7.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/classes/jetpack_sync/" class="">3.8.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.1/classes/jetpack_sync/" class="">3.8.1</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/jetpack_sync/" class="active">3.8.0</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.2/classes/jetpack_sync/" class="">3.7.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.1/classes/jetpack_sync/" class="">3.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Jetpack_Sync</li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>