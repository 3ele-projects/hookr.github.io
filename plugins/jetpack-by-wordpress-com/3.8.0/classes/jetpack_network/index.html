<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="class" data-id="12207"><head xmlns="http://www.w3.org/1999/xhtml"><title> jetpack_network | class | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="Jetpack_Network, class, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="Used to manage Jetpack installation on Multisite Network installs" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=4a46b1e284682b77888d17a9548fba07' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/jetpack_network/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_network%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fjetpack_network%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-class-jetpack_network","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="jetpack_network" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">jetpack_network</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="active" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>Jetpack_Network</strong></h1><p>Used to manage Jetpack installation on Multisite Network installs.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/class-jetpack-network/" class="file">/class.jetpack-network.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="12" class="block" start="12"><li><div>class Jetpack_Network {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Holds a static copy of Jetpack_Network for the singleton&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @var Jetpack_Network&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static $instance = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Name of the network wide settings&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $settings_name = 'jetpack-network-settings';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Defaults for settings found on the Jetpack &gt; Settings page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $setting_defaults = array(&nbsp;</div></li><li><div>        'auto-connect' =&gt; 0, &nbsp;</div></li><li><div>        'sub-site-connection-override' =&gt; 1, &nbsp;</div></li><li><div>        //'manage_auto_activated_modules' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Constructor&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function __construct() {&nbsp;</div></li><li><div>        require_once( ABSPATH . '/wp-admin/includes/plugin.php' ); // For the is_plugin... check&nbsp;</div></li><li><div>        require_once( JETPACK__PLUGIN_DIR . 'modules/protect/shared-functions.php' ); // For managing the global whitelist&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Sanity check to ensure the install is Multisite and we&nbsp;</div></li><li><div>         * are in Network Admin&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( is_multisite() && is_network_admin() ) {&nbsp;</div></li><li><div>            add_action( 'network_admin_menu', array( $this, 'add_network_admin_menu' ) );&nbsp;</div></li><li><div>            add_action( 'network_admin_edit_jetpack-network-settings', array( $this, 'save_network_settings_page' ), 10, 0 );&nbsp;</div></li><li><div>            add_filter( 'admin_body_class', array( $this, 'body_class' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $_GET['page'] ) && 'jetpack' == $_GET['page'] ) {&nbsp;</div></li><li><div>                add_action( 'admin_init', array( $this, 'jetpack_sites_list' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Things that should only run on multisite&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( is_multisite() && is_plugin_active_for_network( 'jetpack/jetpack.php' ) ) {&nbsp;</div></li><li><div>            add_action( 'wp_before_admin_bar_render', array( $this, 'add_to_menubar' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * If admin wants to automagically register new sites set the hook here&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * This is a hacky way because xmlrpc is not available on wpmu_new_blog&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            if ( $this-&gt;get_option( 'auto-connect' ) == 1 ) {&nbsp;</div></li><li><div>                add_action( 'wpmu_new_blog', array( $this, 'do_automatically_add_new_site' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remove the toggles for 2.9, re-evaluate how they're done and added for a 3.0 release. They don't feel quite right yet.&nbsp;</div></li><li><div>        // add_filter( 'jetpack_get_default_modules', array( $this, 'set_auto_activated_modules' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets which modules get activated by default on subsite connection.&nbsp;</div></li><li><div>     * Modules can be set in Network Admin &gt; Jetpack &gt; Settings&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $modules&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function set_auto_activated_modules( $modules ) {&nbsp;</div></li><li><div>        return $modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Remove the toggles for 2.9, re-evaluate how they're done and added for a 3.0 release. They don't feel quite right yet.&nbsp;</div></li><li><div>        if( 1 == $this-&gt;get_option( 'manage_auto_activated_modules' ) ) {&nbsp;</div></li><li><div>            return (array) $this-&gt;get_option( 'modules' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $modules;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        */&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers new sites upon creation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @uses  wpmu_new_blog&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $blog_id&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function do_automatically_add_new_site( $blog_id ) {&nbsp;</div></li><li><div>        $this-&gt;do_subsiteregister( $blog_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds .network-admin class to the body tag&nbsp;</div></li><li><div>     * Helps distinguish network admin JP styles from regular site JP styles&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function body_class( $classes ) {&nbsp;</div></li><li><div>        return trim( $classes ) . ' network-admin ';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Provides access to an instance of Jetpack_Network&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * This is how the Jetpack_Network object should *always* be accessed&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @return Jetpack_Network&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init() {&nbsp;</div></li><li><div>        if ( ! self::$instance || ! is_a( self::$instance, 'Jetpack_Network' ) ) {&nbsp;</div></li><li><div>            self::$instance = new Jetpack_Network;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$instance;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers the Multisite admin bar menu item shortcut.&nbsp;</div></li><li><div>     * This shortcut helps users quickly and easily navigate to the Jetpack Network Admin&nbsp;</div></li><li><div>     * menu from anywhere in their network.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_menubar() {&nbsp;</div></li><li><div>        add_action( 'wp_before_admin_bar_render', array( $this, 'add_to_menubar' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Runs when Jetpack is deactivated from the network admin plugins menu.&nbsp;</div></li><li><div>     * Each individual site will need to have Jetpack::disconnect called on it.&nbsp;</div></li><li><div>     * Site that had Jetpack individually enabled will not be disconnected as&nbsp;</div></li><li><div>     * on Multisite individually activated plugins are still activated when&nbsp;</div></li><li><div>     * a plugin is deactivated network wide.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function deactivate() {&nbsp;</div></li><li><div>        // Only fire if in network admin&nbsp;</div></li><li><div>        if ( ! is_network_admin() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sites = $this-&gt;wp_get_sites();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $sites as $s ) {&nbsp;</div></li><li><div>            switch_to_blog( $s-&gt;blog_id );&nbsp;</div></li><li><div>            $active_plugins = get_option( 'active_plugins' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * If this plugin was activated in the subsite individually&nbsp;</div></li><li><div>             * we do not want to call disconnect. Plugins activated&nbsp;</div></li><li><div>              * individually (before network activation) stay activated&nbsp;</div></li><li><div>              * when the network deactivation occurs&nbsp;</div></li><li><div>              */&nbsp;</div></li><li><div>            if ( ! in_array( 'jetpack/jetpack.php', $active_plugins ) ) {&nbsp;</div></li><li><div>                Jetpack::disconnect();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        restore_current_blog();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds a link to the Jetpack Network Admin page in the network admin menu bar.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function add_to_menubar() {&nbsp;</div></li><li><div>        global $wp_admin_bar;&nbsp;</div></li><li><div>        // Don't show for logged out users or single site mode.&nbsp;</div></li><li><div>        if ( ! is_user_logged_in() || ! is_multisite() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wp_admin_bar-&gt;add_node( array(&nbsp;</div></li><li><div>            'parent' =&gt; 'network-admin', &nbsp;</div></li><li><div>            'id' =&gt; 'network-admin-jetpack', &nbsp;</div></li><li><div>            'title' =&gt; __( 'Jetpack', 'jetpack' ), &nbsp;</div></li><li><div>            'href' =&gt; $this-&gt;get_url( 'network_admin_page' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns various URL strings. Factory like&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * $args can be a string or an array.&nbsp;</div></li><li><div>     * If $args is an array there must be an element called name for the switch statement&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Currently supports:&nbsp;</div></li><li><div>     * - subsiteregister: Pass array( 'name' =&gt; 'subsiteregister', 'site_id' =&gt; SITE_ID )&nbsp;</div></li><li><div>     * - network_admin_page: Provides link to /wp-admin/network/JETPACK&nbsp;</div></li><li><div>     * - subsitedisconnect: Pass array( 'name' =&gt; 'subsitedisconnect', 'site_id' =&gt; SITE_ID )&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param Mixed $args&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return String&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function get_url( $args ) {&nbsp;</div></li><li><div>        $url = null; // Default url value&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_string( $args ) ) {&nbsp;</div></li><li><div>            $name = $args;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $name = $args['name'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $name ) {&nbsp;</div></li><li><div>            case 'subsiteregister':&nbsp;</div></li><li><div>                if ( ! isset( $args['site_id'] ) ) {&nbsp;</div></li><li><div>                    break; // If there is not a site id present we cannot go further&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $url = network_admin_url(&nbsp;</div></li><li><div>                    'admin.php?page=jetpack&action=subsiteregister&site_id='&nbsp;</div></li><li><div>                    . $args['site_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'network_admin_page':&nbsp;</div></li><li><div>                $url = network_admin_url( 'admin.php?page=jetpack' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'subsitedisconnect':&nbsp;</div></li><li><div>                if ( ! isset( $args['site_id'] ) ) {&nbsp;</div></li><li><div>                    break; // If there is not a site id present we cannot go further&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $url = network_admin_url(&nbsp;</div></li><li><div>                    'admin.php?page=jetpack&action=subsitedisconnect&site_id='&nbsp;</div></li><li><div>                    . $args['site_id']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $url;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds the Jetpack  menu item to the Network Admin area&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_network_admin_menu() {&nbsp;</div></li><li><div>        add_menu_page( __( 'Jetpack', 'jetpack' ), __( 'Jetpack', 'jetpack' ), 'jetpack_network_admin_page', 'jetpack', array( $this, 'network_admin_page' ), 'div', 3 );&nbsp;</div></li><li><div>        add_submenu_page( 'jetpack', __( 'Jetpack Sites', 'jetpack' ), __( 'Sites', 'jetpack' ), 'jetpack_network_sites_page', 'jetpack', array( $this, 'network_admin_page' ) );&nbsp;</div></li><li><div>        add_submenu_page( 'jetpack', __( 'Settings', 'jetpack' ), __( 'Settings', 'jetpack' ), 'jetpack_network_settings_page', 'jetpack-settings', array( $this, 'render_network_admin_settings_page' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * As jetpack_register_genericons is by default fired off a hook, &nbsp;</div></li><li><div>         * the hook may have already fired by this point.&nbsp;</div></li><li><div>         * So, let's just trigger it manually.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        require_once( JETPACK__PLUGIN_DIR . '_inc/genericons.php' );&nbsp;</div></li><li><div>        jetpack_register_genericons();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_style_is( 'jetpack-icons', 'registered' ) ) {&nbsp;</div></li><li><div>            wp_register_style( 'jetpack-icons', plugins_url( 'css/jetpack-icons.min.css', JETPACK__PLUGIN_FILE ), false, JETPACK__VERSION );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'admin_enqueue_scripts', array( $this, 'admin_menu_css' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Adds JP menu icon&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    function admin_menu_css() {&nbsp;</div></li><li><div>        wp_enqueue_style( 'jetpack-icons' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Provides functionality for the Jetpack &gt; Sites page.&nbsp;</div></li><li><div>     * Does not do the display!&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function jetpack_sites_list() {&nbsp;</div></li><li><div>        Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['action'] ) ) {&nbsp;</div></li><li><div>            switch ( $_GET['action'] ) {&nbsp;</div></li><li><div>                case 'subsiteregister':&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                     * @todo check_admin_referer( 'jetpack-subsite-register' );&nbsp;</div></li><li><div>                     */&nbsp;</div></li><li><div>                    Jetpack::log( 'subsiteregister' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // If !$_GET['site_id'] stop registration and error&nbsp;</div></li><li><div>                    if ( ! isset( $_GET['site_id'] ) || empty( $_GET['site_id'] ) ) {&nbsp;</div></li><li><div>                        // Log error to state cookie for display later&nbsp;</div></li><li><div>                        /**&nbsp;</div></li><li><div>                         * @todo Make state messages show on Jetpack NA pages&nbsp;</div></li><li><div>                         **/&nbsp;</div></li><li><div>                        Jetpack::state( 'missing_site_id', 'Site ID must be provided to register a sub-site' );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Send data to register endpoint and retrieve shadow blog details&nbsp;</div></li><li><div>                    $result = $this-&gt;do_subsiteregister();&nbsp;</div></li><li><div>                    $url = $this-&gt;get_url( 'network_admin_page' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                        $url = add_query_arg( 'action', 'connection_failed', $url );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $url = add_query_arg( 'action', 'connected', $url );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    wp_safe_redirect( $url );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'subsitedisconnect':&nbsp;</div></li><li><div>                    Jetpack::log( 'subsitedisconnect' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $_GET['site_id'] ) || empty( $_GET['site_id'] ) ) {&nbsp;</div></li><li><div>                        Jetpack::state( 'missing_site_id', 'Site ID must be provided to disconnect a sub-site' );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;do_subsitedisconnect();&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'connected':&nbsp;</div></li><li><div>                case 'connection_failed':&nbsp;</div></li><li><div>                    add_action( 'jetpack_notices', array( $this, 'show_jetpack_notice' ) );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function show_jetpack_notice() {&nbsp;</div></li><li><div>        if ( isset( $_GET['action'] ) && 'connected' == $_GET['action'] ) {&nbsp;</div></li><li><div>            $notice = __( 'Site successfully connected.', 'jetpack' );&nbsp;</div></li><li><div>        } else if ( isset( $_GET['action'] ) && 'connection_failed' == $_GET['action'] ) {&nbsp;</div></li><li><div>            $notice = __( 'Site connection &lt;strong&gt;failed&lt;/strong&gt;', 'jetpack' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::init()-&gt;load_view( 'admin/network-admin-alert.php', array( 'notice' =&gt; $notice ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Disconnect functionality for an individual site&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @see   Jetpack_Network::jetpack_sites_list()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function do_subsitedisconnect( $site_id = null ) {&nbsp;</div></li><li><div>        if ( ! current_user_can( 'jetpack_disconnect' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $site_id = ( is_null( $site_id ) ) ? $_GET['site_id'] : $site_id;&nbsp;</div></li><li><div>        switch_to_blog( $site_id );&nbsp;</div></li><li><div>        Jetpack::disconnect();&nbsp;</div></li><li><div>        restore_current_blog();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers a subsite with the Jetpack servers&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @todo  Break apart into easier to manage chunks that can be unit tested&nbsp;</div></li><li><div>     * @see   Jetpack_Network::jetpack_sites_list();&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function do_subsiteregister( $site_id = null ) {&nbsp;</div></li><li><div>        if ( ! current_user_can( 'jetpack_disconnect' ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jp = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Figure out what site we are working on&nbsp;</div></li><li><div>        $site_id = ( is_null( $site_id ) ) ? $_GET['site_id'] : $site_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build secrets to sent to wpcom for verification&nbsp;</div></li><li><div>        $secrets = $jp-&gt;generate_secrets();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Remote query timeout limit&nbsp;</div></li><li><div>        $timeout = $jp-&gt;get_remote_query_timeout_limit();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The blog id on WordPress.com of the primary network site&nbsp;</div></li><li><div>        $network_wpcom_blog_id = Jetpack_Options::get_option( 'id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Here we need to switch to the subsite&nbsp;</div></li><li><div>         * For the registration process we really only hijack how it&nbsp;</div></li><li><div>         * works for an individual site and pass in some extra data here&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        switch_to_blog( $site_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save the secrets in the subsite so when the wpcom server does a pingback it&nbsp;</div></li><li><div>        // will be able to validate the connection&nbsp;</div></li><li><div>        Jetpack_Options::update_option( 'register', &nbsp;</div></li><li><div>            $secrets[0] . ':' . $secrets[1] . ':' . $secrets[2]&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Gra info for gmt offset&nbsp;</div></li><li><div>        $gmt_offset = get_option( 'gmt_offset' );&nbsp;</div></li><li><div>        if ( ! $gmt_offset ) {&nbsp;</div></li><li><div>            $gmt_offset = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Get the stats_option option from the db.&nbsp;</div></li><li><div>         * It looks like the server strips this out so maybe it is not necessary?&nbsp;</div></li><li><div>         * Does it match the Jetpack site with the old stats plugin id?&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @todo Find out if sending the stats_id is necessary&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $stat_options = get_option( 'stats_options' );&nbsp;</div></li><li><div>        $stat_id = $stat_options = isset( $stats_options['blog_id'] ) ? $stats_options['blog_id'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'method' =&gt; 'POST', &nbsp;</div></li><li><div>            'body' =&gt; array(&nbsp;</div></li><li><div>                'network_url' =&gt; $this-&gt;get_url( 'network_admin_page' ), &nbsp;</div></li><li><div>                'network_wpcom_blog_id' =&gt; $network_wpcom_blog_id, &nbsp;</div></li><li><div>                'siteurl' =&gt; site_url(), &nbsp;</div></li><li><div>                'home' =&gt; home_url(), &nbsp;</div></li><li><div>                'gmt_offset' =&gt; $gmt_offset, &nbsp;</div></li><li><div>                'timezone_string' =&gt; (string) get_option( 'timezone_string' ), &nbsp;</div></li><li><div>                'site_name' =&gt; (string) get_option( 'blogname' ), &nbsp;</div></li><li><div>                'secret_1' =&gt; $secrets[0], &nbsp;</div></li><li><div>                'secret_2' =&gt; $secrets[1], &nbsp;</div></li><li><div>                'site_lang' =&gt; get_locale(), &nbsp;</div></li><li><div>                'timeout' =&gt; $timeout, &nbsp;</div></li><li><div>                'stats_id' =&gt; $stat_id, // Is this still required?&nbsp;</div></li><li><div>                'user_id' =&gt; get_current_user_id(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'headers' =&gt; array(&nbsp;</div></li><li><div>                'Accept' =&gt; 'application/json', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'timeout' =&gt; $timeout, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Attempt to retrieve shadow blog details&nbsp;</div></li><li><div>        $response = Jetpack_Client::_wp_remote_request(&nbsp;</div></li><li><div>            Jetpack::fix_url_for_bad_hosts( Jetpack::api_url( 'subsiteregister' ) ), $args, true&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * $response should either be invalid or contain:&nbsp;</div></li><li><div>         * - jetpack_id =&gt; id&nbsp;</div></li><li><div>         * - jetpack_secret =&gt; blog_token&nbsp;</div></li><li><div>         * - jetpack_public&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * Store the wpcom site details&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $valid_response = $jp-&gt;validate_remote_register_response( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $valid_response ) || ! $valid_response ) {&nbsp;</div></li><li><div>            restore_current_blog();&nbsp;</div></li><li><div>            return $valid_response;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Grab the response values to work with&nbsp;</div></li><li><div>        $code = wp_remote_retrieve_response_code( $response );&nbsp;</div></li><li><div>        $entity = wp_remote_retrieve_body( $response );&nbsp;</div></li><li><div>        if ( $entity ) {&nbsp;</div></li><li><div>            $json = json_decode( $entity );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $json = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $json-&gt;jetpack_secret ) || ! is_string( $json-&gt;jetpack_secret ) ) {&nbsp;</div></li><li><div>            restore_current_blog();&nbsp;</div></li><li><div>            return new Jetpack_Error( 'jetpack_secret', '', $code );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $json-&gt;jetpack_public ) ) {&nbsp;</div></li><li><div>            $jetpack_public = (int) $json-&gt;jetpack_public;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $jetpack_public = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack_Options::update_options( array(&nbsp;</div></li><li><div>            'id' =&gt; (int) $json-&gt;jetpack_id, &nbsp;</div></li><li><div>            'blog_token' =&gt; (string) $json-&gt;jetpack_secret, &nbsp;</div></li><li><div>            'public' =&gt; $jetpack_public, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Update the subsiteregister method on wpcom so that it also sends back the&nbsp;</div></li><li><div>         * token in this same request&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $is_master_user = ! Jetpack::is_active();&nbsp;</div></li><li><div>        Jetpack::update_user_token(&nbsp;</div></li><li><div>            get_current_user_id(), &nbsp;</div></li><li><div>            sprintf( '%s.%d', $json-&gt;token-&gt;secret, get_current_user_id() ), &nbsp;</div></li><li><div>            $is_master_user&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::activate_default_modules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        restore_current_blog();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles the displaying of all sites on the network that are&nbsp;</div></li><li><div>     * dis/connected to Jetpack&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @see   Jetpack_Network::jetpack_sites_list()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function network_admin_page() {&nbsp;</div></li><li><div>        global $current_site;&nbsp;</div></li><li><div>        $this-&gt;network_admin_page_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $jp = Jetpack::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // We should be, but ensure we are on the main blog&nbsp;</div></li><li><div>        switch_to_blog( $current_site-&gt;blog_id );&nbsp;</div></li><li><div>        $main_active = $jp-&gt;is_active();&nbsp;</div></li><li><div>        restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If we are in dev mode, just show the notice and bail&nbsp;</div></li><li><div>        if ( Jetpack::is_development_mode() ) {&nbsp;</div></li><li><div>            Jetpack::show_development_mode_notice();&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Ensure the main blog is connected as all other subsite blog&nbsp;</div></li><li><div>         * connections will feed off this one&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if ( ! $main_active ) {&nbsp;</div></li><li><div>            $url = $this-&gt;get_url( array(&nbsp;</div></li><li><div>                'name' =&gt; 'subsiteregister', &nbsp;</div></li><li><div>                'site_id' =&gt; 1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            $data = array( 'url' =&gt; $jp-&gt;build_connect_url() );&nbsp;</div></li><li><div>            Jetpack::init()-&gt;load_view( 'admin/must-connect-main-blog.php', $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once( 'class.jetpack-network-sites-list-table.php' );&nbsp;</div></li><li><div>        $myListTable = new Jetpack_Network_Sites_List_Table();&nbsp;</div></li><li><div>        echo '&lt;div class=&quot;wrap&quot;&gt;&lt;h2&gt;' . __( 'Sites', 'jetpack' ) . '&lt;/h2&gt;';&nbsp;</div></li><li><div>        echo '&lt;form method=&quot;post&quot;&gt;';&nbsp;</div></li><li><div>        $myListTable-&gt;prepare_items();&nbsp;</div></li><li><div>        $myListTable-&gt;display();&nbsp;</div></li><li><div>        echo '&lt;/form&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;network_admin_page_footer();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stylized JP header formatting&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function network_admin_page_header() {&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_connected = Jetpack::is_active();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'is_connected' =&gt; $is_connected&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        Jetpack::init()-&gt;load_view( 'admin/network-admin-header.php', $data );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stylized JP footer formatting&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function network_admin_page_footer() {&nbsp;</div></li><li><div>        Jetpack::init()-&gt;load_view( 'admin/network-admin-footer.php' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Fires when the Jetpack &gt; Settings page is saved.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function save_network_settings_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['_wpnonce'], 'jetpack-network-settings' ) ) {&nbsp;</div></li><li><div>            // no nonce, push back to settings page&nbsp;</div></li><li><div>            wp_safe_redirect(&nbsp;</div></li><li><div>                add_query_arg(&nbsp;</div></li><li><div>                    array( 'page' =&gt; 'jetpack-settings' ), &nbsp;</div></li><li><div>                    network_admin_url( 'admin.php' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            exit();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // try to save the Protect whitelist before anything else, since that action can result in errors&nbsp;</div></li><li><div>        $whitelist = str_replace( ' ', '', $_POST['global-whitelist'] );&nbsp;</div></li><li><div>        $whitelist = explode( PHP_EOL, $whitelist );&nbsp;</div></li><li><div>        $result = jetpack_protect_save_whitelist( $whitelist, $global = true );&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            wp_safe_redirect(&nbsp;</div></li><li><div>                add_query_arg(&nbsp;</div></li><li><div>                    array( 'page' =&gt; 'jetpack-settings', 'error' =&gt; 'jetpack_protect_whitelist' ), &nbsp;</div></li><li><div>                    network_admin_url( 'admin.php' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            exit();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fields&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * auto-connect - Checkbox for global Jetpack connection&nbsp;</div></li><li><div>         * sub-site-connection-override - Allow sub-site admins to (dis)reconnect with their own Jetpack account&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $auto_connect = 0;&nbsp;</div></li><li><div>        if ( isset( $_POST['auto-connect'] ) ) {&nbsp;</div></li><li><div>            $auto_connect = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sub_site_connection_override = 0;&nbsp;</div></li><li><div>        if ( isset( $_POST['sub-site-connection-override'] ) ) {&nbsp;</div></li><li><div>            $sub_site_connection_override = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** Remove the toggles for 2.9, re-evaluate how they're done and added for a 3.0 release. They don't feel quite right yet.&nbsp;</div></li><li><div>        $manage_auto_activated_modules = 0;&nbsp;</div></li><li><div>        if ( isset( $_POST['manage_auto_activated_modules'] ) ) {&nbsp;</div></li><li><div>            $manage_auto_activated_modules = 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        $modules = array();&nbsp;</div></li><li><div>        if ( isset( $_POST['modules'] ) ) {&nbsp;</div></li><li><div>            $modules = $_POST['modules'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'auto-connect' =&gt; $auto_connect, &nbsp;</div></li><li><div>            'sub-site-connection-override' =&gt; $sub_site_connection_override, &nbsp;</div></li><li><div>            //'manage_auto_activated_modules' =&gt; $manage_auto_activated_modules, &nbsp;</div></li><li><div>            //'modules' =&gt; $modules, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_site_option( $this-&gt;settings_name, $data );&nbsp;</div></li><li><div>        wp_safe_redirect(&nbsp;</div></li><li><div>            add_query_arg(&nbsp;</div></li><li><div>                array( 'page' =&gt; 'jetpack-settings', 'updated' =&gt; 'true' ), &nbsp;</div></li><li><div>                network_admin_url( 'admin.php' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        exit();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function render_network_admin_settings_page() {&nbsp;</div></li><li><div>        $this-&gt;network_admin_page_header();&nbsp;</div></li><li><div>        $options = wp_parse_args( get_site_option( $this-&gt;settings_name ), $this-&gt;setting_defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $modules = array();&nbsp;</div></li><li><div>        $module_slugs = Jetpack::get_available_modules();&nbsp;</div></li><li><div>        foreach ( $module_slugs as $slug ) {&nbsp;</div></li><li><div>            $module = Jetpack::get_module( $slug );&nbsp;</div></li><li><div>            $module['module'] = $slug;&nbsp;</div></li><li><div>            $modules[] = $module;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        usort( $modules, array( 'Jetpack', 'sort_modules' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $options['modules'] ) ) {&nbsp;</div></li><li><div>            $options['modules'] = $modules;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'modules' =&gt; $modules, &nbsp;</div></li><li><div>            'options' =&gt; $options, &nbsp;</div></li><li><div>            'jetpack_protect_whitelist' =&gt; jetpack_protect_format_whitelist(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        Jetpack::init()-&gt;load_view( 'admin/network-settings.php', $data );&nbsp;</div></li><li><div>        $this-&gt;network_admin_page_footer();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates a site wide option&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key&nbsp;</div></li><li><div>     * @param mixed  $value&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function update_option( $key, $value ) {&nbsp;</div></li><li><div>        $options = get_site_option( $this-&gt;settings_name, $this-&gt;setting_defaults );&nbsp;</div></li><li><div>        $options[ $key ] = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return update_site_option( $this-&gt;settings_name, $options );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves a site wide option&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $name - Name of the option in the database&nbsp;</div></li><li><div>     **/&nbsp;</div></li><li><div>    public function get_option( $name ) {&nbsp;</div></li><li><div>        $options = get_site_option( $this-&gt;settings_name, $this-&gt;setting_defaults );&nbsp;</div></li><li><div>        $options = wp_parse_args( $options, $this-&gt;setting_defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $options[ $name ] ) ) {&nbsp;</div></li><li><div>            $options[ $name ] = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $options[ $name ];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return an array of sites on the specified network. If no network is specified, &nbsp;</div></li><li><div>     * return all sites, regardless of network.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @todo REMOVE THIS FUNCTION! This function is moving to core. Use that one in favor of this. WordPress::wp_get_sites(). http://codex.wordpress.org/Function_Reference/wp_get_sites NOTE, This returns an array instead of stdClass. Be sure to update class.network-sites-list-table.php&nbsp;</div></li><li><div>     * @since 2.9&nbsp;</div></li><li><div>     * @deprecated 2.4.5&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array|string $args Optional. Specify the status of the sites to return.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array An array of site data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function wp_get_sites( $args = array() ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( wp_is_large_network() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array( 'network_id' =&gt; $wpdb-&gt;siteid );&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>        $query = &quot;SELECT * FROM $wpdb-&gt;blogs WHERE 1=1 &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['network_id'] ) && ( is_array( $args['network_id'] ) || is_numeric( $args['network_id'] ) ) ) {&nbsp;</div></li><li><div>            $network_ids = array_map( 'intval', (array) $args['network_id'] );&nbsp;</div></li><li><div>            $network_ids = implode( ', ', $network_ids );&nbsp;</div></li><li><div>            $query .= &quot;AND site_id IN ($network_ids) &quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['public'] ) ) {&nbsp;</div></li><li><div>            $query .= $wpdb-&gt;prepare( &quot;AND public = %s &quot;, $args['public'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['archived'] ) ) {&nbsp;</div></li><li><div>            $query .= $wpdb-&gt;prepare( &quot;AND archived = %s &quot;, $args['archived'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['mature'] ) ) {&nbsp;</div></li><li><div>            $query .= $wpdb-&gt;prepare( &quot;AND mature = %s &quot;, $args['mature'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['spam'] ) ) {&nbsp;</div></li><li><div>            $query .= $wpdb-&gt;prepare( &quot;AND spam = %s &quot;, $args['spam'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['deleted'] ) ) {&nbsp;</div></li><li><div>            $query .= $wpdb-&gt;prepare( &quot;AND deleted = %s &quot;, $args['deleted'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $args['exclude_blogs'] ) ) {&nbsp;</div></li><li><div>            $query .= &quot;AND blog_id NOT IN (&quot; . implode( ', ', $args['exclude_blogs'] ) . &quot;)&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = 'wp_get_sites:' . md5( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $site_results = wp_cache_get( $key, 'site-id-cache' ) ) {&nbsp;</div></li><li><div>            $site_results = (array) $wpdb-&gt;get_results( $query );&nbsp;</div></li><li><div>            wp_cache_set( $key, $site_results, 'site-id-cache' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $site_results;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.9</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/classes/jetpack_network/" class="">3.8.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.1/classes/jetpack_network/" class="">3.8.1</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/jetpack_network/" class="active">3.8.0</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.2/classes/jetpack_network/" class="">3.7.2</a></li><li><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.7.1/classes/jetpack_network/" class="">3.7.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>Jetpack_Network</li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>