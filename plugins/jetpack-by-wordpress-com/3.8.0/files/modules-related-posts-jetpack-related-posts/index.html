<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="file" data-id="13115"><head xmlns="http://www.w3.org/1999/xhtml"><title> modules-related-posts-jetpack-related-posts | file | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d0bcf098c17b7246c34123b8aaa2b30e' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/modules-related-posts-jetpack-related-posts/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-related-posts-jetpack-related-posts%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-related-posts-jetpack-related-posts%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-file-modules-related-posts-jetpack-related-posts","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="modules-related-posts-jetpack-related-posts" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">modules-related-posts-jetpack&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/modules/related-posts/jetpack-related-posts.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>class Jetpack_RelatedPosts {&nbsp;</div></li><li><div>  const VERSION = '20150408';&nbsp;</div></li><li><div>  const SHORTCODE = 'jetpack-related-posts';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates and returns a static instance of Jetpack_RelatedPosts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return Jetpack_RelatedPosts</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function init() {&nbsp;</div></li><li><div>      static $instance = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $instance ) {&nbsp;</div></li><li><div>          if ( class_exists('WPCOM_RelatedPosts') && method_exists( 'WPCOM_RelatedPosts', 'init' ) ) {&nbsp;</div></li><li><div>              $instance = WPCOM_RelatedPosts::init();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $instance = new Jetpack_RelatedPosts(&nbsp;</div></li><li><div>                  get_current_blog_id(), &nbsp;</div></li><li><div>                  Jetpack_Options::get_option( 'id' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates and returns a static instance of Jetpack_RelatedPosts_Raw.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return Jetpack_RelatedPosts</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function init_raw() {&nbsp;</div></li><li><div>      static $instance = NULL;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $instance ) {&nbsp;</div></li><li><div>          if ( class_exists('WPCOM_RelatedPosts') && method_exists( 'WPCOM_RelatedPosts', 'init_raw' ) ) {&nbsp;</div></li><li><div>              $instance = WPCOM_RelatedPosts::init_raw();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $instance = new Jetpack_RelatedPosts_Raw(&nbsp;</div></li><li><div>                  get_current_blog_id(), &nbsp;</div></li><li><div>                  Jetpack_Options::get_option( 'id' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $_blog_id_local;&nbsp;</div></li><li><div>  protected $_blog_id_wpcom;&nbsp;</div></li><li><div>  protected $_options;&nbsp;</div></li><li><div>  protected $_allow_feature_toggle;&nbsp;</div></li><li><div>  protected $_blog_charset;&nbsp;</div></li><li><div>  protected $_convert_charset;&nbsp;</div></li><li><div>  protected $_previous_post_id;&nbsp;</div></li><li><div>  protected $_found_shortcode = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor for Jetpack_RelatedPosts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $blog_id_local</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $blog_id_wpcom</span>&nbsp;</div></li><li><div><span class="comment">   * @uses get_option, add_action, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct( $blog_id_local, $blog_id_wpcom ) {&nbsp;</div></li><li><div>      $this-&gt;_blog_id_local = $blog_id_local;&nbsp;</div></li><li><div>      $this-&gt;_blog_id_wpcom = $blog_id_wpcom;&nbsp;</div></li><li><div>      $this-&gt;_blog_charset = get_option( 'blog_charset' );&nbsp;</div></li><li><div>      $this-&gt;_convert_charset = ( function_exists( 'iconv' ) && ! preg_match( '/^utf\-?8$/i', $this-&gt;_blog_charset ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'admin_init', array( $this, 'action_admin_init' ) );&nbsp;</div></li><li><div>      add_action( 'wp', array( $this, 'action_frontend_init' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * =================</span>&nbsp;</div></li><li><div><span class="comment">   * ACTIONS & FILTERS</span>&nbsp;</div></li><li><div><span class="comment">   * =================</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a checkbox field to Settings &gt; Reading for enabling related posts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @action admin_init</span>&nbsp;</div></li><li><div><span class="comment">   * @uses add_settings_field, __, register_setting, add_action</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function action_admin_init() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the setting field [jetpack_relatedposts] and place it in Settings &gt; Reading</span>&nbsp;</div></li><li><div>      add_settings_field( 'jetpack_relatedposts', '&lt;span id=&quot;jetpack_relatedposts&quot;&gt;' . __( 'Related posts', 'jetpack' ) . '&lt;/span&gt;', array( $this, 'print_setting_html' ), 'reading' );&nbsp;</div></li><li><div>      register_setting( 'reading', 'jetpack_relatedposts', array( $this, 'parse_options' ) );&nbsp;</div></li><li><div>      add_action('admin_head', array( $this, 'print_setting_head' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'options-reading.php' == $GLOBALS['pagenow'] ) {&nbsp;</div></li><li><div>          <span class="comment">// Enqueue style for live preview on the reading settings page</span>&nbsp;</div></li><li><div>          $this-&gt;_enqueue_assets( false, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Load related posts assets if it's a elegiable frontend page or execute search and return JSON if it's an endpoint request.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @global $_GET</span>&nbsp;</div></li><li><div><span class="comment">   * @action wp</span>&nbsp;</div></li><li><div><span class="comment">   * @uses add_shortcode, get_the_ID</span>&nbsp;</div></li><li><div><span class="comment">   * @returns null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function action_frontend_init() {&nbsp;</div></li><li><div>      <span class="comment">// Add a shortcode handler that outputs nothing, this gets overridden later if we can display related content</span>&nbsp;</div></li><li><div>      add_shortcode( self::SHORTCODE, array( $this, 'get_target_html_unsupported' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;_enabled_for_request() )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['relatedposts'] ) ) {&nbsp;</div></li><li><div>          $excludes = array();&nbsp;</div></li><li><div>          if ( isset( $_GET['relatedposts_exclude'] ) ) {&nbsp;</div></li><li><div>              $excludes = explode( ', ', $_GET['relatedposts_exclude'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;_action_frontend_init_ajax( $excludes );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( isset( $_GET['relatedposts_hit'] ) ) {&nbsp;</div></li><li><div>              $this-&gt;_log_click( $_GET['relatedposts_origin'], get_the_ID(), $_GET['relatedposts_position'] );&nbsp;</div></li><li><div>              $this-&gt;_previous_post_id = (int) $_GET['relatedposts_origin'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;_action_frontend_init_page();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds a target to the post content to load related posts into if a shortcode for it did not already exist.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @filter the_content</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content</span>&nbsp;</div></li><li><div><span class="comment">   * @returns string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function filter_add_target_to_dom( $content ) {&nbsp;</div></li><li><div>      if ( !$this-&gt;_found_shortcode ) {&nbsp;</div></li><li><div>          $content .= &quot;\n&quot; . $this-&gt;get_target_html();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Looks for our shortcode on the unfiltered content, this has to execute early.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @filter the_content</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $content</span>&nbsp;</div></li><li><div><span class="comment">   * @uses has_shortcode</span>&nbsp;</div></li><li><div><span class="comment">   * @returns string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function test_for_shortcode( $content ) {&nbsp;</div></li><li><div>      $this-&gt;_found_shortcode = has_shortcode( $content, self::SHORTCODE );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the HTML for the related posts section.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses esc_html__, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @returns string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_target_html() {&nbsp;</div></li><li><div>      $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $options['show_headline'] ) {&nbsp;</div></li><li><div>          $headline = sprintf(&nbsp;</div></li><li><div>              '&lt;h3 class=&quot;jp-relatedposts-headline&quot;&gt;&lt;em&gt;%s&lt;/em&gt;&lt;/h3&gt;', &nbsp;</div></li><li><div>              esc_html__( 'Related', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $headline = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Related Posts headline.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $headline Related Posts heading.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $headline = apply_filters( 'jetpack_relatedposts_filter_headline', $headline );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_previous_post_id ) {&nbsp;</div></li><li><div>          $exclude = &quot;data-exclude='{$this-&gt;_previous_post_id}'&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $exclude = &quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;div id='jp-relatedposts' class='jp-relatedposts' $exclude&gt;&nbsp;</div></li><li><div>  $headline&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the HTML for the related posts section if it's running in the loop or other instances where we don't support related posts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @returns string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_target_html_unsupported() {&nbsp;</div></li><li><div>      return &quot;\n\n&lt;!-- Jetpack Related Posts is not supported in this context. --&gt;\n\n&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * ========================</span>&nbsp;</div></li><li><div><span class="comment">   * PUBLIC UTILITY FUNCTIONS</span>&nbsp;</div></li><li><div><span class="comment">   * ========================</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets options set for Jetpack_RelatedPosts and merge with defaults.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses Jetpack_Options::get_option, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_options() {&nbsp;</div></li><li><div>      if ( null === $this-&gt;_options ) {&nbsp;</div></li><li><div>          $this-&gt;_options = Jetpack_Options::get_option( 'relatedposts' );&nbsp;</div></li><li><div>          if ( ! is_array( $this-&gt;_options ) )&nbsp;</div></li><li><div>              $this-&gt;_options = array();&nbsp;</div></li><li><div>          if ( ! isset( $this-&gt;_options['enabled'] ) )&nbsp;</div></li><li><div>              $this-&gt;_options['enabled'] = true;&nbsp;</div></li><li><div>          if ( ! isset( $this-&gt;_options['show_headline'] ) )&nbsp;</div></li><li><div>              $this-&gt;_options['show_headline'] = true;&nbsp;</div></li><li><div>          if ( ! isset( $this-&gt;_options['show_thumbnails'] ) )&nbsp;</div></li><li><div>              $this-&gt;_options['show_thumbnails'] = false;&nbsp;</div></li><li><div>          if ( empty( $this-&gt;_options['size'] ) || (int)$this-&gt;_options['size'] &lt; 1 )&nbsp;</div></li><li><div>              $this-&gt;_options['size'] = 3;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter Related Posts basic options.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $this-&gt;_options Array of basic Related Posts options.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $this-&gt;_options = apply_filters( 'jetpack_relatedposts_filter_options', $this-&gt;_options );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;_options;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parses input and returnes normalized options array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $input</span>&nbsp;</div></li><li><div><span class="comment">   * @uses self::get_options</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function parse_options( $input ) {&nbsp;</div></li><li><div>      $current = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !is_array( $input ) )&nbsp;</div></li><li><div>          $input = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $input['enabled'] ) && '1' == $input['enabled'] ) {&nbsp;</div></li><li><div>          $current['enabled'] = true;&nbsp;</div></li><li><div>          $current['show_headline'] = ( isset( $input['show_headline'] ) && '1' == $input['show_headline'] );&nbsp;</div></li><li><div>          $current['show_thumbnails'] = ( isset( $input['show_thumbnails'] ) && '1' == $input['show_thumbnails'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $current['enabled'] = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $input['size'] ) && (int)$input['size'] &gt; 0 )&nbsp;</div></li><li><div>          $current['size'] = (int)$input['size'];&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $current['size'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $current;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * HTML for admin settings page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses self::get_options, checked, esc_html__</span>&nbsp;</div></li><li><div><span class="comment">   * @returns null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function print_setting_html() {&nbsp;</div></li><li><div>      $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ui_settings_template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;ul id=&quot;settings-reading-relatedposts-customize&quot;&gt;&nbsp;</div></li><li><div>  &lt;li&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&lt;input name=&quot;jetpack_relatedposts[show_headline]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/li&gt;&nbsp;</div></li><li><div>  &lt;li&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&lt;input name=&quot;jetpack_relatedposts[show_thumbnails]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/li&gt;&nbsp;</div></li><li><div>&lt;/ul&gt;&nbsp;</div></li><li><div>&lt;div id='settings-reading-relatedposts-preview'&gt;&nbsp;</div></li><li><div>  %s&nbsp;</div></li><li><div>  &lt;div id=&quot;jp-relatedposts&quot; class=&quot;jp-relatedposts&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>      $ui_settings = sprintf(&nbsp;</div></li><li><div>          $ui_settings_template, &nbsp;</div></li><li><div>          checked( $options['show_headline'], true, false ), &nbsp;</div></li><li><div>          esc_html__( 'Show a &quot;Related&quot; header to more clearly separate the related section from posts', 'jetpack' ), &nbsp;</div></li><li><div>          checked( $options['show_thumbnails'], true, false ), &nbsp;</div></li><li><div>          esc_html__( 'Use a large and visually striking layout', 'jetpack' ), &nbsp;</div></li><li><div>          esc_html__( 'Preview:', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$this-&gt;_allow_feature_toggle() ) {&nbsp;</div></li><li><div>          $template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;input type=&quot;hidden&quot; name=&quot;jetpack_relatedposts[enabled]&quot; value=&quot;1&quot; /&gt;&nbsp;</div></li><li><div>%s&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>          printf(&nbsp;</div></li><li><div>              $template, &nbsp;</div></li><li><div>              $ui_settings&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $template = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;ul id=&quot;settings-reading-relatedposts&quot;&gt;&nbsp;</div></li><li><div>  &lt;li&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;jetpack_relatedposts[enabled]&quot; value=&quot;0&quot; class=&quot;tog&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>  &lt;/li&gt;&nbsp;</div></li><li><div>  &lt;li&gt;&nbsp;</div></li><li><div>      &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;jetpack_relatedposts[enabled]&quot; value=&quot;1&quot; class=&quot;tog&quot; %s /&gt; %s&lt;/label&gt;&nbsp;</div></li><li><div>      %s&nbsp;</div></li><li><div>  &lt;/li&gt;&nbsp;</div></li><li><div>&lt;/ul&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>          printf(&nbsp;</div></li><li><div>              $template, &nbsp;</div></li><li><div>              checked( $options['enabled'], false, false ), &nbsp;</div></li><li><div>              esc_html__( 'Hide related content after posts', 'jetpack' ), &nbsp;</div></li><li><div>              checked( $options['enabled'], true, false ), &nbsp;</div></li><li><div>              esc_html__( 'Show related content after posts', 'jetpack' ), &nbsp;</div></li><li><div>              $ui_settings&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Head JS/CSS for admin settings page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses esc_html__</span>&nbsp;</div></li><li><div><span class="comment">   * @returns null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function print_setting_head() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// only dislay the Related Posts JavaScript on the Reading Settings Admin Page</span>&nbsp;</div></li><li><div>      $current_screen =  get_current_screen();&nbsp;</div></li><li><div>      if( 'options-reading' != $current_screen-&gt;id )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $related_headline = sprintf(&nbsp;</div></li><li><div>          '&lt;h3 class=&quot;jp-relatedposts-headline&quot;&gt;&lt;em&gt;%s&lt;/em&gt;&lt;/h3&gt;', &nbsp;</div></li><li><div>          esc_html__( 'Related', 'jetpack' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $href_params = 'class=&quot;jp-relatedposts-post-a&quot; href=&quot;#jetpack_relatedposts&quot; rel=&quot;nofollow&quot; data-origin=&quot;0&quot; data-position=&quot;0&quot;';&nbsp;</div></li><li><div>      $related_with_images = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;div class=&quot;jp-relatedposts-items jp-relatedposts-items-visual&quot;&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;jp-relatedposts-post jp-relatedposts-post0 jp-relatedposts-post-thumbs&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>      &lt;a $href_params&gt;&nbsp;</div></li><li><div>          &lt;img class=&quot;jp-relatedposts-post-img&quot; src=&quot;http:<span class="comment">//jetpackme.files.wordpress.com/2014/08/1-wpios-ipad-3-1-viewsite.png?w=350&amp;h=200&amp;crop=1&quot; width=&quot;350&quot; alt=&quot;Big iPhone/iPad Update Now Available&quot; scale=&quot;0&quot;&gt;</span>&nbsp;</div></li><li><div>      &lt;/a&gt;&nbsp;</div></li><li><div>      &lt;h4 class=&quot;jp-relatedposts-post-title&quot;&gt;&nbsp;</div></li><li><div>          &lt;a $href_params&gt;Big iPhone/iPad Update Now Available&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/h4&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;jp-relatedposts-post-excerpt&quot;&gt;Big iPhone/iPad Update Now Available&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;jp-relatedposts-post jp-relatedposts-post1 jp-relatedposts-post-thumbs&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>      &lt;a $href_params&gt;&nbsp;</div></li><li><div>          &lt;img class=&quot;jp-relatedposts-post-img&quot; src=&quot;http:<span class="comment">//jetpackme.files.wordpress.com/2014/08/wordpress-com-news-wordpress-for-android-ui-update2.jpg?w=350&amp;h=200&amp;crop=1&quot; width=&quot;350&quot; alt=&quot;The WordPress for Android App Gets a Big Facelift&quot; scale=&quot;0&quot;&gt;</span>&nbsp;</div></li><li><div>      &lt;/a&gt;&nbsp;</div></li><li><div>      &lt;h4 class=&quot;jp-relatedposts-post-title&quot;&gt;&nbsp;</div></li><li><div>          &lt;a $href_params&gt;The WordPress for Android App Gets a Big Facelift&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/h4&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;jp-relatedposts-post-excerpt&quot;&gt;The WordPress for Android App Gets a Big Facelift&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>  &lt;div class=&quot;jp-relatedposts-post jp-relatedposts-post2 jp-relatedposts-post-thumbs&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>      &lt;a $href_params&gt;&nbsp;</div></li><li><div>          &lt;img class=&quot;jp-relatedposts-post-img&quot; src=&quot;http:<span class="comment">//jetpackme.files.wordpress.com/2014/08/videopresswedding.jpg?w=350&amp;h=200&amp;crop=1&quot; width=&quot;350&quot; alt=&quot;Upgrade Focus: VideoPress For Weddings&quot; scale=&quot;0&quot;&gt;</span>&nbsp;</div></li><li><div>      &lt;/a&gt;&nbsp;</div></li><li><div>      &lt;h4 class=&quot;jp-relatedposts-post-title&quot;&gt;&nbsp;</div></li><li><div>          &lt;a $href_params&gt;Upgrade Focus: VideoPress For Weddings&lt;/a&gt;&nbsp;</div></li><li><div>      &lt;/h4&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;jp-relatedposts-post-excerpt&quot;&gt;Upgrade Focus: VideoPress For Weddings&lt;/p&gt;&nbsp;</div></li><li><div>      &lt;p class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Upgrade&quot;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>      $related_with_images = str_replace( &quot;\n&quot;, '', $related_with_images );&nbsp;</div></li><li><div>      $related_without_images = &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;div class=&quot;jp-relatedposts-items jp-relatedposts-items-minimal&quot;&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;jp-relatedposts-post jp-relatedposts-post0&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;jp-relatedposts-post-title&quot;&gt;&lt;a $href_params&gt;Big iPhone/iPad Update Now Available&lt;/a&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/span&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;jp-relatedposts-post jp-relatedposts-post1&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;jp-relatedposts-post-title&quot;&gt;&lt;a $href_params&gt;The WordPress for Android App Gets a Big Facelift&lt;/a&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Mobile&quot;&lt;/span&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>  &lt;p class=&quot;jp-relatedposts-post jp-relatedposts-post2&quot; data-post-id=&quot;0&quot; data-post-format=&quot;image&quot;&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;jp-relatedposts-post-title&quot;&gt;&lt;a $href_params&gt;Upgrade Focus: VideoPress For Weddings&lt;/a&gt;&lt;/span&gt;&nbsp;</div></li><li><div>      &lt;span class=&quot;jp-relatedposts-post-context&quot;&gt;In &quot;Upgrade&quot;&lt;/span&gt;&nbsp;</div></li><li><div>  &lt;/p&gt;&nbsp;</div></li><li><div>&lt;/div&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>      $related_without_images = str_replace( &quot;\n&quot;, '', $related_without_images );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;_allow_feature_toggle() ) {&nbsp;</div></li><li><div>          $extra_css = '#settings-reading-relatedposts-customize { padding-left:2em; margin-top:.5em; }';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $extra_css = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &lt;&lt;&lt;EOT&nbsp;</div></li><li><div>&lt;style type=&quot;text/css&quot;&gt;&nbsp;</div></li><li><div>  #settings-reading-relatedposts .disabled { opacity:.5; filter:Alpha(opacity=50); }&nbsp;</div></li><li><div>  #settings-reading-relatedposts-preview .jp-relatedposts { background:#fff; padding:.5em; width:75%; }&nbsp;</div></li><li><div>  $extra_css&nbsp;</div></li><li><div>&lt;/style&gt;&nbsp;</div></li><li><div>&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>  jQuery( document ).ready( function($) {&nbsp;</div></li><li><div>      var update_ui = function() {&nbsp;</div></li><li><div>          var is_enabled = true;&nbsp;</div></li><li><div>          if ( 'radio' == $( 'input[name=&quot;jetpack_relatedposts[enabled]&quot;]' ).attr('type') ) {&nbsp;</div></li><li><div>              if ( '0' == $( 'input[name=&quot;jetpack_relatedposts[enabled]&quot;]:checked' ).val() ) {&nbsp;</div></li><li><div>                  is_enabled = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( is_enabled ) {&nbsp;</div></li><li><div>              $( '#settings-reading-relatedposts-customize' )&nbsp;</div></li><li><div>                  .removeClass( 'disabled' )&nbsp;</div></li><li><div>                  .find( 'input' )&nbsp;</div></li><li><div>                  .attr( 'disabled', false );&nbsp;</div></li><li><div>              $( '#settings-reading-relatedposts-preview' )&nbsp;</div></li><li><div>                  .removeClass( 'disabled' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $( '#settings-reading-relatedposts-customize' )&nbsp;</div></li><li><div>                  .addClass( 'disabled' )&nbsp;</div></li><li><div>                  .find( 'input' )&nbsp;</div></li><li><div>                  .attr( 'disabled', true );&nbsp;</div></li><li><div>              $( '#settings-reading-relatedposts-preview' )&nbsp;</div></li><li><div>                  .addClass( 'disabled' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      var update_preview = function() {&nbsp;</div></li><li><div>          var html = '';&nbsp;</div></li><li><div>          if ( $( 'input[name=&quot;jetpack_relatedposts[show_headline]&quot;]:checked' ).size() ) {&nbsp;</div></li><li><div>              html += '$related_headline';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $( 'input[name=&quot;jetpack_relatedposts[show_thumbnails]&quot;]:checked' ).size() ) {&nbsp;</div></li><li><div>              html += '$related_with_images';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              html += '$related_without_images';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $( '#settings-reading-relatedposts-preview .jp-relatedposts' )&nbsp;</div></li><li><div>              .html( html )&nbsp;</div></li><li><div>              .show();&nbsp;</div></li><li><div>      };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update on load</span>&nbsp;</div></li><li><div>      update_preview();&nbsp;</div></li><li><div>      update_ui();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update on change</span>&nbsp;</div></li><li><div>      $( '#settings-reading-relatedposts-customize input' )&nbsp;</div></li><li><div>          .change( update_preview );&nbsp;</div></li><li><div>      $( '#settings-reading-relatedposts' )&nbsp;</div></li><li><div>          .find( 'input.tog' )&nbsp;</div></li><li><div>          .change( update_ui );&nbsp;</div></li><li><div>  });&nbsp;</div></li><li><div>&lt;/script&gt;&nbsp;</div></li><li><div>EOT;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets an array of related posts that match the given post_id.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args - params to use when building ElasticSearch filters to narrow down the search domain.</span>&nbsp;</div></li><li><div><span class="comment">   * @uses self::get_options, get_post_type, wp_parse_args, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_for_post_id( $post_id, array $args ) {&nbsp;</div></li><li><div>      $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $args['size'] ) )&nbsp;</div></li><li><div>          $options['size'] = $args['size'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $options['enabled'] || 0 == (int)$post_id || empty( $options['size'] ) )&nbsp;</div></li><li><div>          return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'size' =&gt; (int)$options['size'], &nbsp;</div></li><li><div>          'post_type' =&gt; get_post_type( $post_id ), &nbsp;</div></li><li><div>          'post_formats' =&gt; array(), &nbsp;</div></li><li><div>          'has_terms' =&gt; array(), &nbsp;</div></li><li><div>          'date_range' =&gt; array(), &nbsp;</div></li><li><div>          'exclude_post_ids' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the arguments used to retrieve a list of Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args Array of options to retrieve Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args = apply_filters( 'jetpack_relatedposts_filter_args', $args, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $filters = $this-&gt;_get_es_filters_from_args( $post_id, $args );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter ElasticSearch options used to calculate Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $filters Array of ElasticSearch filters based on the post_id and args.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $filters = apply_filters( 'jetpack_relatedposts_filter_filters', $filters, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = $this-&gt;_get_related_posts( $post_id, $args['size'], $filters );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the array of related posts matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $results Array of related posts matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters( 'jetpack_relatedposts_returned_results', $results, $post_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * =========================</span>&nbsp;</div></li><li><div><span class="comment">   * PRIVATE UTILITY FUNCTIONS</span>&nbsp;</div></li><li><div><span class="comment">   * =========================</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates an array of ElasticSearch filters based on the post_id and args.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters, get_post_types, get_post_format_strings</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_es_filters_from_args( $post_id, array $args ) {&nbsp;</div></li><li><div>      $filters = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the terms used to search for Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args['has_terms'] Array of terms associated to the Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args['has_terms'] = apply_filters( 'jetpack_relatedposts_filter_has_terms', $args['has_terms'], $post_id );&nbsp;</div></li><li><div>      if ( ! empty( $args['has_terms'] ) ) {&nbsp;</div></li><li><div>          foreach( (array)$args['has_terms'] as $term ) {&nbsp;</div></li><li><div>              if ( mb_strlen( $term-&gt;taxonomy ) ) {&nbsp;</div></li><li><div>                  switch ( $term-&gt;taxonomy ) {&nbsp;</div></li><li><div>                      case 'post_tag':&nbsp;</div></li><li><div>                          $tax_fld = 'tag.slug';&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      case 'category':&nbsp;</div></li><li><div>                          $tax_fld = 'category.slug';&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      default:&nbsp;</div></li><li><div>                          $tax_fld = 'taxonomy.' . $term-&gt;taxonomy . '.slug';&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $filters[] = array( 'term' =&gt; array( $tax_fld =&gt; $term-&gt;slug ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Post Types where we search Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args['post_type'] Array of Post Types.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args['post_type'] = apply_filters( 'jetpack_relatedposts_filter_post_type', $args['post_type'], $post_id );&nbsp;</div></li><li><div>      $valid_post_types = get_post_types();&nbsp;</div></li><li><div>      if ( is_array( $args['post_type'] ) ) {&nbsp;</div></li><li><div>          $sanitized_post_types = array();&nbsp;</div></li><li><div>          foreach ( $args['post_type'] as $pt ) {&nbsp;</div></li><li><div>              if ( in_array( $pt, $valid_post_types ) )&nbsp;</div></li><li><div>                  $sanitized_post_types[] = $pt;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( ! empty( $sanitized_post_types ) )&nbsp;</div></li><li><div>              $filters[] = array( 'terms' =&gt; array( 'post_type' =&gt; $sanitized_post_types ) );&nbsp;</div></li><li><div>      } else if ( in_array( $args['post_type'], $valid_post_types ) && 'all' != $args['post_type'] ) {&nbsp;</div></li><li><div>          $filters[] = array( 'term' =&gt; array( 'post_type' =&gt; $args['post_type'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Post Formats where we search Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args['post_formats'] Array of Post Formats.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args['post_formats'] = apply_filters( 'jetpack_relatedposts_filter_post_formats', $args['post_formats'], $post_id );&nbsp;</div></li><li><div>      $valid_post_formats = get_post_format_strings();&nbsp;</div></li><li><div>      $sanitized_post_formats = array();&nbsp;</div></li><li><div>      foreach ( $args['post_formats'] as $pf ) {&nbsp;</div></li><li><div>          if ( array_key_exists( $pf, $valid_post_formats ) ) {&nbsp;</div></li><li><div>              $sanitized_post_formats[] = $pf;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! empty( $sanitized_post_formats ) ) {&nbsp;</div></li><li><div>          $filters[] = array( 'terms' =&gt; array( 'post_format' =&gt; $sanitized_post_formats ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the date range used to search Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args['date_range'] Array of a month interval where we search Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args['date_range'] = apply_filters( 'jetpack_relatedposts_filter_date_range', $args['date_range'], $post_id );&nbsp;</div></li><li><div>      if ( is_array( $args['date_range'] ) && ! empty( $args['date_range'] ) ) {&nbsp;</div></li><li><div>          $args['date_range'] = array_map( 'intval', $args['date_range'] );&nbsp;</div></li><li><div>          if ( !empty( $args['date_range']['from'] ) && !empty( $args['date_range']['to'] ) ) {&nbsp;</div></li><li><div>              $filters[] = array(&nbsp;</div></li><li><div>                  'range' =&gt; array(&nbsp;</div></li><li><div>                      'date_gmt' =&gt; $this-&gt;_get_coalesced_range( $args['date_range'] ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Post IDs excluded from appearing in Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args['exclude_post_ids'] Array of Post IDs.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $args['exclude_post_ids'] = apply_filters( 'jetpack_relatedposts_filter_exclude_post_ids', $args['exclude_post_ids'], $post_id );&nbsp;</div></li><li><div>      if ( !empty( $args['exclude_post_ids'] ) && is_array( $args['exclude_post_ids'] ) ) {&nbsp;</div></li><li><div>          foreach ( $args['exclude_post_ids'] as $exclude_post_id) {&nbsp;</div></li><li><div>              $exclude_post_id = (int)$exclude_post_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $exclude_post_id &gt; 0 )&nbsp;</div></li><li><div>                  $filters[] = array( 'not' =&gt; array( 'term' =&gt; array( 'post_id' =&gt; $exclude_post_id ) ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $filters;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Takes a range and coalesces it into a month interval bracketed by a time as determined by the blog_id to enhance caching.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $date_range</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_coalesced_range( array $date_range ) {&nbsp;</div></li><li><div>      $now = time();&nbsp;</div></li><li><div>      $coalesce_time = $this-&gt;_blog_id_wpcom % 86400;&nbsp;</div></li><li><div>      $current_time = $now - strtotime( 'today', $now );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $current_time &lt; $coalesce_time && '01' == date( 'd', $now ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Move back 1 period</span>&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'from' =&gt; date( 'Y-m-01', strtotime( '-1 month', $date_range['from'] ) ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div>              'to' =&gt; date( 'Y-m-01', $date_range['to'] ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Use current period</span>&nbsp;</div></li><li><div>          return array(&nbsp;</div></li><li><div>              'from' =&gt; date( 'Y-m-01', $date_range['from'] ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div>              'to' =&gt; date( 'Y-m-01', strtotime( '+1 month', $date_range['to'] ) ) . ' ' . date( 'H:i:s', $coalesce_time ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate and output ajax response for related posts API call.</span>&nbsp;</div></li><li><div><span class="comment">   * NOTE: Calls exit() to end all further processing after payload has been outputed.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $excludes array of post_ids to exclude</span>&nbsp;</div></li><li><div><span class="comment">   * @uses send_nosniff_header, self::get_for_post_id, get_the_ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _action_frontend_init_ajax( array $excludes ) {&nbsp;</div></li><li><div>      define( 'DOING_AJAX', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      header( 'Content-type: application/json; charset=utf-8' ); <span class="comment">// JSON can only be UTF-8</span>&nbsp;</div></li><li><div>      send_nosniff_header();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $related_posts = $this-&gt;get_for_post_id(&nbsp;</div></li><li><div>          get_the_ID(), &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'exclude_post_ids' =&gt; $excludes, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $options = $this-&gt;get_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = array(&nbsp;</div></li><li><div>          'version' =&gt; self::VERSION, &nbsp;</div></li><li><div>          'show_thumbnails' =&gt; (bool) $options['show_thumbnails'], &nbsp;</div></li><li><div>          'items' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count( $related_posts ) == $options['size'] )&nbsp;</div></li><li><div>          $response['items'] = $related_posts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      exit();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a UTF-8 encoded array of post information for the given post_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $position</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $origin The post id that this is related to</span>&nbsp;</div></li><li><div><span class="comment">   * @uses get_post, get_permalink, remove_query_arg, get_post_format, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_related_post_data_for_post( $post_id, $position, $origin ) {&nbsp;</div></li><li><div>      $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'id' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div>          'url' =&gt; get_permalink( $post-&gt;ID ), &nbsp;</div></li><li><div>          'url_meta' =&gt; array( 'origin' =&gt; $origin, 'position' =&gt; $position ), &nbsp;</div></li><li><div>          'title' =&gt; $this-&gt;_to_utf8( $this-&gt;_get_title( $post-&gt;post_title, $post-&gt;post_content ) ), &nbsp;</div></li><li><div>          'date' =&gt; get_the_date( '', $post-&gt;ID ), &nbsp;</div></li><li><div>          'format' =&gt; get_post_format( $post-&gt;ID ), &nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filters the rel attribute for the Related Posts' links.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string nofollow Link rel attribute for Related Posts' link. Default is nofollow.</span>&nbsp;</div></li><li><div><span class="comment">           * @param int $post-&gt;ID Post ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          'rel' =&gt; apply_filters( 'jetpack_relatedposts_filter_post_link_rel', 'nofollow', $post-&gt;ID ), &nbsp;</div></li><li><div>          'excerpt' =&gt; html_entity_decode( $this-&gt;_to_utf8( $this-&gt;_get_excerpt( $post-&gt;post_excerpt, $post-&gt;post_content ) ), ENT_QUOTES, 'UTF-8' ), &nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter the context displayed below each Related Post.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $this-&gt;_to_utf8( $this-&gt;_generate_related_post_context( $post-&gt;ID ) ) Context displayed below each related post.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          'context' =&gt; apply_filters(&nbsp;</div></li><li><div>              'jetpack_relatedposts_filter_post_context', &nbsp;</div></li><li><div>              $this-&gt;_to_utf8( $this-&gt;_generate_related_post_context( $post-&gt;ID ) ), &nbsp;</div></li><li><div>              $post-&gt;ID&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'img' =&gt; $this-&gt;_generate_related_post_image_params( $post-&gt;ID ), &nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter the post css classes added on HTML markup.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.8.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array array() CSS classes added on post HTML markup.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $post_id Post ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          'classes' =&gt; apply_filters(&nbsp;</div></li><li><div>              'jetpack_relatedposts_filter_post_css_classes', &nbsp;</div></li><li><div>              array(), &nbsp;</div></li><li><div>              $post-&gt;ID&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns either the title or a small excerpt to use as title for post.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $post_title</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $post_content</span>&nbsp;</div></li><li><div><span class="comment">   * @uses strip_shortcodes, wp_trim_words, __</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_title( $post_title, $post_content ) {&nbsp;</div></li><li><div>      if ( ! empty( $post_title ) ) {&nbsp;</div></li><li><div>          return wp_strip_all_tags( $post_title );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_title = wp_trim_words( wp_strip_all_tags( strip_shortcodes( $post_content ) ), 5, '*' );&nbsp;</div></li><li><div>      if ( ! empty( $post_title ) ) {&nbsp;</div></li><li><div>          return $post_title;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return __( 'Untitled Post', 'jetpack' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a plain text post excerpt for title attribute of links.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $post_excerpt</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $post_content</span>&nbsp;</div></li><li><div><span class="comment">   * @uses strip_shortcodes, wp_strip_all_tags, wp_trim_words</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_excerpt( $post_excerpt, $post_content ) {&nbsp;</div></li><li><div>      if ( empty( $post_excerpt ) )&nbsp;</div></li><li><div>          $excerpt = $post_content;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $excerpt = $post_excerpt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wp_trim_words( wp_strip_all_tags( strip_shortcodes( $excerpt ) ), 50, '*' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates the thumbnail image to be used for the post. Uses the</span>&nbsp;</div></li><li><div><span class="comment">   * image as returned by Jetpack_PostImages::get_image()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @uses self::get_options, apply_filters, Jetpack_PostImages::get_image, Jetpack_PostImages::fit_image_url</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _generate_related_post_image_params( $post_id ) {&nbsp;</div></li><li><div>      $options = $this-&gt;get_options();&nbsp;</div></li><li><div>      $image_params = array(&nbsp;</div></li><li><div>          'src' =&gt; '', &nbsp;</div></li><li><div>          'width' =&gt; 0, &nbsp;</div></li><li><div>          'height' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $options['show_thumbnails'] ) {&nbsp;</div></li><li><div>          return $image_params;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the size of the Related Posts images.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array array( 'width' =&gt; 350, 'height' =&gt; 200 ) Size of the images displayed below each Related Post.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $thumbnail_size = apply_filters(&nbsp;</div></li><li><div>          'jetpack_relatedposts_filter_thumbnail_size', &nbsp;</div></li><li><div>          array( 'width' =&gt; 350, 'height' =&gt; 200 )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      if ( !is_array( $thumbnail_size ) ) {&nbsp;</div></li><li><div>          $thumbnail_size = array(&nbsp;</div></li><li><div>              'width' =&gt; (int)$thumbnail_size, &nbsp;</div></li><li><div>              'height' =&gt; (int)$thumbnail_size&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Try to get post image</span>&nbsp;</div></li><li><div>      if ( class_exists( 'Jetpack_PostImages' ) ) {&nbsp;</div></li><li><div>          $img_url = '';&nbsp;</div></li><li><div>          $post_image = Jetpack_PostImages::get_image(&nbsp;</div></li><li><div>              $post_id, &nbsp;</div></li><li><div>              $thumbnail_size&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_array($post_image) ) {&nbsp;</div></li><li><div>              $img_url = $post_image['src'];&nbsp;</div></li><li><div>          } elseif ( class_exists( 'Jetpack_Media_Summary' ) ) {&nbsp;</div></li><li><div>              $media = Jetpack_Media_Summary::get( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_array($media) && !empty( $media['image'] ) ) {&nbsp;</div></li><li><div>                  $img_url = $media['image'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $img_url ) ) {&nbsp;</div></li><li><div>              $image_params['width'] = $thumbnail_size['width'];&nbsp;</div></li><li><div>              $image_params['height'] = $thumbnail_size['height'];&nbsp;</div></li><li><div>              $image_params['src'] = Jetpack_PostImages::fit_image_url(&nbsp;</div></li><li><div>                  $img_url, &nbsp;</div></li><li><div>                  $thumbnail_size['width'], &nbsp;</div></li><li><div>                  $thumbnail_size['height']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $image_params;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the string UTF-8 encoded</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $text</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _to_utf8( $text ) {&nbsp;</div></li><li><div>      if ( $this-&gt;_convert_charset ) {&nbsp;</div></li><li><div>          return iconv( $this-&gt;_blog_charset, 'UTF-8', $text );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $text;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * =============================================</span>&nbsp;</div></li><li><div><span class="comment">   * PROTECTED UTILITY FUNCTIONS EXTENDED BY WPCOM</span>&nbsp;</div></li><li><div><span class="comment">   * =============================================</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Workhorse method to return array of related posts matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $size</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $filters</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_remote_post, is_wp_error, get_option, wp_remote_retrieve_body, get_post, add_query_arg, remove_query_arg, get_permalink, get_post_format, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_related_posts( $post_id, $size, array $filters ) {&nbsp;</div></li><li><div>      $hits = $this-&gt;_filter_non_public_posts(&nbsp;</div></li><li><div>          $this-&gt;_get_related_post_ids(&nbsp;</div></li><li><div>              $post_id, &nbsp;</div></li><li><div>              $size, &nbsp;</div></li><li><div>              $filters&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Related Posts matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.9.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $hits Array of Post IDs matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $post_id Post ID of the post for which we are retrieving Related Posts.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $hits = apply_filters( 'jetpack_relatedposts_filter_hits', $hits, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $related_posts = array();&nbsp;</div></li><li><div>      foreach ( $hits as $i =&gt; $hit ) {&nbsp;</div></li><li><div>          $related_posts[] = $this-&gt;_get_related_post_data_for_post( $hit['id'], $i, $post_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $related_posts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get array of related posts matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $size</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $filters</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_remote_post, is_wp_error, wp_remote_retrieve_body, get_post_meta, update_post_meta</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_related_post_ids( $post_id, $size, array $filters ) {&nbsp;</div></li><li><div>      $now_ts = time();&nbsp;</div></li><li><div>      $cache_meta_key = '_jetpack_related_posts_cache';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $body = array(&nbsp;</div></li><li><div>          'size' =&gt; (int) $size, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $filters ) )&nbsp;</div></li><li><div>          $body['filter'] = array( 'and' =&gt; $filters );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load all cached values</span>&nbsp;</div></li><li><div>      $cache = get_post_meta( $post_id, $cache_meta_key, true );&nbsp;</div></li><li><div>      if ( empty( $cache ) )&nbsp;</div></li><li><div>          $cache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Build cache key</span>&nbsp;</div></li><li><div>      $cache_key = md5( serialize( $body ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cache is valid! Return cached value.</span>&nbsp;</div></li><li><div>      if ( isset( $cache[ $cache_key ] ) && is_array( $cache[ $cache_key ] ) && $cache[ $cache_key ][ 'expires' ] &gt; $now_ts ) {&nbsp;</div></li><li><div>          return $cache[ $cache_key ][ 'payload' ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = wp_remote_post(&nbsp;</div></li><li><div>          &quot;https:<span class="comment">//public-api.wordpress.com/rest/v1/sites/{$this-&gt;_blog_id_wpcom}/posts/$post_id/related/&quot;, </span>&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'timeout' =&gt; 10, &nbsp;</div></li><li><div>              'user-agent' =&gt; 'jetpack_related_posts', &nbsp;</div></li><li><div>              'sslverify' =&gt; true, &nbsp;</div></li><li><div>              'body' =&gt; $body, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Oh no... return nothing don't cache errors.</span>&nbsp;</div></li><li><div>      if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>          if ( isset( $cache[ $cache_key ] ) && is_array( $cache[ $cache_key ] ) )&nbsp;</div></li><li><div>              return $cache[ $cache_key ][ 'payload' ]; <span class="comment">// return stale</span>&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              return array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = json_decode( wp_remote_retrieve_body( $response ), true );&nbsp;</div></li><li><div>      $related_posts = array();&nbsp;</div></li><li><div>      if ( is_array( $results ) && !empty( $results['hits'] ) ) {&nbsp;</div></li><li><div>          foreach( $results['hits'] as $hit ) {&nbsp;</div></li><li><div>              $related_posts[] = array(&nbsp;</div></li><li><div>                  'id' =&gt; $hit['fields']['post_id'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Copy all valid cache values</span>&nbsp;</div></li><li><div>      $new_cache = array();&nbsp;</div></li><li><div>      foreach ( $cache as $k =&gt; $v ) {&nbsp;</div></li><li><div>          if ( is_array( $v ) && $v[ 'expires' ] &gt; $now_ts ) {&nbsp;</div></li><li><div>              $new_cache[ $k ] = $v;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set new cache value if valid</span>&nbsp;</div></li><li><div>      if ( ! empty( $related_posts ) ) {&nbsp;</div></li><li><div>          $new_cache[ $cache_key ] = array(&nbsp;</div></li><li><div>              'expires' =&gt; 12 * HOUR_IN_SECONDS + $now_ts, &nbsp;</div></li><li><div>              'payload' =&gt; $related_posts, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update cache</span>&nbsp;</div></li><li><div>      update_post_meta( $post_id, $cache_meta_key, $new_cache );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $related_posts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter out any hits that are not public anymore.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $related_posts</span>&nbsp;</div></li><li><div><span class="comment">   * @uses get_post_stati, get_post_status</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _filter_non_public_posts( array $related_posts ) {&nbsp;</div></li><li><div>      $public_stati = get_post_stati( array( 'public' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $filtered = array();&nbsp;</div></li><li><div>      foreach ( $related_posts as $hit ) {&nbsp;</div></li><li><div>          if ( in_array( get_post_status( $hit['id'] ), $public_stati ) ) {&nbsp;</div></li><li><div>              $filtered[] = $hit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $filtered;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a context for the related content (second line in related post output).</span>&nbsp;</div></li><li><div><span class="comment">   * Order of importance:</span>&nbsp;</div></li><li><div><span class="comment">   *   - First category (Not 'Uncategorized')</span>&nbsp;</div></li><li><div><span class="comment">   *   - First post tag</span>&nbsp;</div></li><li><div><span class="comment">   *   - Number of comments</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @uses get_the_category, get_the_terms, get_comments_number, number_format_i18n, __, _n</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _generate_related_post_context( $post_id ) {&nbsp;</div></li><li><div>      $categories = get_the_category( $post_id );&nbsp;</div></li><li><div>      if ( is_array( $categories ) ) {&nbsp;</div></li><li><div>          foreach ( $categories as $category ) {&nbsp;</div></li><li><div>              if ( 'uncategorized' != $category-&gt;slug && '' != trim( $category-&gt;name ) ) {&nbsp;</div></li><li><div>                  $post_cat_context = sprintf(&nbsp;</div></li><li><div>                      _x( 'In &quot;%s&quot;', 'in {category/tag name}', 'jetpack' ), &nbsp;</div></li><li><div>                      $category-&gt;name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                   * Filter the &quot;In Category&quot; line displayed in the post context below each Related Post.</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @param string $post_cat_context &quot;In Category&quot; line displayed in the post context below each Related Post.</span>&nbsp;</div></li><li><div><span class="comment">                   * @param array $category Array containing information about the category.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>                  return apply_filters( 'jetpack_relatedposts_post_category_context', $post_cat_context, $category );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tags = get_the_terms( $post_id, 'post_tag' );&nbsp;</div></li><li><div>      if ( is_array( $tags ) ) {&nbsp;</div></li><li><div>          foreach ( $tags as $tag ) {&nbsp;</div></li><li><div>              if ( '' != trim( $tag-&gt;name ) ) {&nbsp;</div></li><li><div>                  $post_tag_context = sprintf(&nbsp;</div></li><li><div>                      _x( 'In &quot;%s&quot;', 'in {category/tag name}', 'jetpack' ), &nbsp;</div></li><li><div>                      $tag-&gt;name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                   * Filter the &quot;In Tag&quot; line displayed in the post context below each Related Post.</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @param string $post_tag_context &quot;In Tag&quot; line displayed in the post context below each Related Post.</span>&nbsp;</div></li><li><div><span class="comment">                   * @param array $tag Array containing information about the tag.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>                  return apply_filters( 'jetpack_relatedposts_post_tag_context', $post_tag_context, $tag );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $comment_count = get_comments_number( $post_id );&nbsp;</div></li><li><div>      if ( $comment_count &gt; 0 ) {&nbsp;</div></li><li><div>          return sprintf(&nbsp;</div></li><li><div>              _n( 'With 1 comment', 'With %s comments', $comment_count, 'jetpack' ), &nbsp;</div></li><li><div>              number_format_i18n( $comment_count )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return __( 'Similar post', 'jetpack' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Logs clicks for clickthrough analysis and related result tuning.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _log_click( $post_id, $to_post_id, $link_position ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determines if the current post is able to use related posts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses self::get_options, is_admin, is_single, apply_filters</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _enabled_for_request() {&nbsp;</div></li><li><div>      <span class="comment">// Default to enabled</span>&nbsp;</div></li><li><div>      $enabled = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Must have feature enabled</span>&nbsp;</div></li><li><div>      $options = $this-&gt;get_options();&nbsp;</div></li><li><div>      if ( ! $options['enabled'] ) {&nbsp;</div></li><li><div>          $enabled = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only run for frontend pages</span>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          $enabled = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only run for standalone posts</span>&nbsp;</div></li><li><div>      if ( ! is_single() ) {&nbsp;</div></li><li><div>          $enabled = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Enabled value to allow related posts to be shown on pages as well.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool $enabled Should Related Posts be enabled on the current page.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters( 'jetpack_relatedposts_filter_enabled_for_request', $enabled );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds filters and enqueues assets.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses self::_enqueue_assets, self::_setup_shortcode, add_filter</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _action_frontend_init_page() {&nbsp;</div></li><li><div>      $this-&gt;_enqueue_assets( true, true );&nbsp;</div></li><li><div>      $this-&gt;_setup_shortcode();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'the_content', array( $this, 'filter_add_target_to_dom' ), 40 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Enqueues assets needed to do async loading of related posts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_enqueue_script, wp_enqueue_style, plugins_url</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _enqueue_assets( $script, $style ) {&nbsp;</div></li><li><div>      if ( $script )&nbsp;</div></li><li><div>          wp_enqueue_script( 'jetpack_related-posts', plugins_url( 'related-posts.js', __FILE__ ), array( 'jquery' ), self::VERSION );&nbsp;</div></li><li><div>      if ( $style ) {&nbsp;</div></li><li><div>          if( is_rtl() ) {&nbsp;</div></li><li><div>              wp_enqueue_style( 'jetpack_related-posts', plugins_url( 'rtl/related-posts-rtl.css', __FILE__ ), array(), self::VERSION );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wp_enqueue_style( 'jetpack_related-posts', plugins_url( 'related-posts.css', __FILE__ ), array(), self::VERSION );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets up the shortcode processing.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses add_filter, add_shortcode</span>&nbsp;</div></li><li><div><span class="comment">   * @return null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _setup_shortcode() {&nbsp;</div></li><li><div>      add_filter( 'the_content', array( $this, 'test_for_shortcode' ), 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_shortcode( self::SHORTCODE, array( $this, 'get_target_html' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function _allow_feature_toggle() {&nbsp;</div></li><li><div>      if ( null === $this-&gt;_allow_feature_toggle ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter the display of the Related Posts toggle in Settings &gt; Reading.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module related-posts</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.8.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool false Display a feature toggle. Default to false.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $this-&gt;_allow_feature_toggle = apply_filters( 'jetpack_relatedposts_filter_allow_feature_toggle', false );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;_allow_feature_toggle;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Jetpack_RelatedPosts_Raw extends Jetpack_RelatedPosts {&nbsp;</div></li><li><div>  protected $_query_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Allows callers of this class to tag each query with a unique name for tracking purposes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   * @return Jetpack_RelatedPosts_Raw</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_query_name( $name ) {&nbsp;</div></li><li><div>      $this-&gt;_query_name = (string) $name;&nbsp;</div></li><li><div>      return $this;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The raw related posts class can be used by other plugins or themes</span>&nbsp;</div></li><li><div><span class="comment">   * to get related content. This class wraps the existing RelatedPosts</span>&nbsp;</div></li><li><div><span class="comment">   * logic thus we never want to add anything to the DOM or do anything</span>&nbsp;</div></li><li><div><span class="comment">   * for event hooks. We will also not present any settings for this</span>&nbsp;</div></li><li><div><span class="comment">   * class and keep it enabled as calls to this class is done</span>&nbsp;</div></li><li><div><span class="comment">   * programmatically.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function action_admin_init() {}&nbsp;</div></li><li><div>  public function action_frontend_init() {}&nbsp;</div></li><li><div>  public function get_options() {&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          'enabled' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Workhorse method to return array of related posts ids matched by ElasticSearch.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $size</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $filters</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_remote_post, is_wp_error, wp_remote_retrieve_body</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_related_posts( $post_id, $size, array $filters ) {&nbsp;</div></li><li><div>      $hits = $this-&gt;_filter_non_public_posts(&nbsp;</div></li><li><div>          $this-&gt;_get_related_post_ids(&nbsp;</div></li><li><div>              $post_id, &nbsp;</div></li><li><div>              $size, &nbsp;</div></li><li><div>              $filters&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** This filter is already documented in modules/related-posts/related-posts.php */</span>&nbsp;</div></li><li><div>      $hits = apply_filters( 'jetpack_relatedposts_filter_hits', $hits, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $hits;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>