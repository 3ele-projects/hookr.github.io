<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="file" data-id="13034"><head xmlns="http://www.w3.org/1999/xhtml"><title> modules-custom-css-custom-css | file | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=643123773219f683c04ccc35c96e2189' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/modules-custom-css-custom-css/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-custom-css-custom-css%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-custom-css-custom-css%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-file-modules-custom-css-custom-css","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="modules-custom-css-custom-css" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">modules-custom-css-custom-css</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/modules/custom-css/custom-css.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Jetpack_Custom_CSS {&nbsp;</div></li><li><div>  static function init() {&nbsp;</div></li><li><div>      add_action( 'switch_theme', array( __CLASS__, 'reset' ) );&nbsp;</div></li><li><div>      add_action( 'wp_restore_post_revision', array( __CLASS__, 'restore_revision' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save revisions for posts of type safecss.</span>&nbsp;</div></li><li><div>      add_filter( 'revision_redirect', array( __CLASS__, 'revision_redirect' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Override the edit link, the default link causes a redirect loop</span>&nbsp;</div></li><li><div>      add_filter( 'get_edit_post_link', array( __CLASS__, 'revision_post_link' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Overwrite the content width global variable if one is set in the custom css</span>&nbsp;</div></li><li><div>      add_action( 'template_redirect', array( __CLASS__, 'set_content_width' ) );&nbsp;</div></li><li><div>      add_action( 'admin_init', array( __CLASS__, 'set_content_width' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_admin() )&nbsp;</div></li><li><div>          add_filter( 'stylesheet_uri', array( __CLASS__, 'style_filter' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      define(&nbsp;</div></li><li><div>          'SAFECSS_USE_ACE', &nbsp;</div></li><li><div>          ! jetpack_is_mobile() &&&nbsp;</div></li><li><div>          ! Jetpack_User_Agent_Info::is_ipad() &&&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Should the Custom CSS module use ACE to process CSS.</span>&nbsp;</div></li><li><div><span class="comment">           * @see http://ace.c9.io/</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool true Use ACE to process the Custom CSS. Default to true.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          apply_filters( 'safecss_use_ace', true )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Register safecss as a custom post_type</span>&nbsp;</div></li><li><div>      <span class="comment">// Explicit capability definitions are largely unnecessary because the posts are manipulated in code via an options page, managing CSS revisions does check the capabilities, so let's ensure that the proper caps are checked.</span>&nbsp;</div></li><li><div>      register_post_type( 'safecss', array(&nbsp;</div></li><li><div>  <span class="comment">//        These are the defaults</span>&nbsp;</div></li><li><div>  <span class="comment">//        'exclude_from_search' =&gt; true, </span>&nbsp;</div></li><li><div>  <span class="comment">//        'public' =&gt; false, </span>&nbsp;</div></li><li><div>  <span class="comment">//        'publicly_queryable' =&gt; false, </span>&nbsp;</div></li><li><div>  <span class="comment">//        'show_ui' =&gt; false, </span>&nbsp;</div></li><li><div>          'supports' =&gt; array( 'revisions' ), &nbsp;</div></li><li><div>          'label' =&gt; 'Custom CSS', &nbsp;</div></li><li><div>          'can_export' =&gt; false, &nbsp;</div></li><li><div>          'rewrite' =&gt; false, &nbsp;</div></li><li><div>          'capabilities' =&gt; array(&nbsp;</div></li><li><div>              'edit_post' =&gt; 'edit_theme_options', &nbsp;</div></li><li><div>              'read_post' =&gt; 'read', &nbsp;</div></li><li><div>              'delete_post' =&gt; 'edit_theme_options', &nbsp;</div></li><li><div>              'edit_posts' =&gt; 'edit_theme_options', &nbsp;</div></li><li><div>              'edit_others_posts' =&gt; 'edit_theme_options', &nbsp;</div></li><li><div>              'publish_posts' =&gt; 'edit_theme_options', &nbsp;</div></li><li><div>              'read_private_posts' =&gt; 'read'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Short-circuit WP if this is a CSS stylesheet request</span>&nbsp;</div></li><li><div>      if ( isset( $_GET['custom-css'] ) ) {&nbsp;</div></li><li><div>          header( 'Content-Type: text/css', true, 200 );&nbsp;</div></li><li><div>          header( 'Expires: ' . gmdate( 'D, d M Y H:i:s', time() + 31536000) . ' GMT' ); <span class="comment">// 1 year</span>&nbsp;</div></li><li><div>          Jetpack_Custom_CSS::print_css();&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'admin_enqueue_scripts', array( 'Jetpack_Custom_CSS', 'enqueue_scripts' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['page'] ) && 'editcss' == $_GET['page'] && is_admin() ) {&nbsp;</div></li><li><div>          <span class="comment">// Do migration routine if necessary</span>&nbsp;</div></li><li><div>          Jetpack_Custom_CSS::upgrade();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Allows additional work when migrating safecss from wp_options to wp_post.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'safecss_migrate_post' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Never embed the style in the head on wpcom.</span>&nbsp;</div></li><li><div><span class="comment">       * Yes, this filter should be added to an unsynced file on wpcom, but</span>&nbsp;</div></li><li><div><span class="comment">       * there is no good syntactically-correct location to put it yet.</span>&nbsp;</div></li><li><div><span class="comment">       * @link https://github.com/Automattic/jetpack/commit/a1be114e9179f64d147124727a58e2cf76c7e5a1#commitcomment-7763921</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( defined( 'IS_WPCOM' ) && IS_WPCOM ) {&nbsp;</div></li><li><div>          add_filter( 'safecss_embed_style', '__return_false' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          add_filter( 'safecss_embed_style', array( 'Jetpack_Custom_CSS', 'should_we_inline_custom_css' ), 10, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wp_head', array( 'Jetpack_Custom_CSS', 'link_tag' ), 101 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'jetpack_content_width', array( 'Jetpack_Custom_CSS', 'jetpack_content_width' ) );&nbsp;</div></li><li><div>      add_filter( 'editor_max_image_size', array( 'Jetpack_Custom_CSS', 'editor_max_image_size' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !current_user_can( 'switch_themes' ) && !is_super_admin() )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'admin_menu', array( 'Jetpack_Custom_CSS', 'menu' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['safecss'] ) && false == strstr( $_SERVER[ 'REQUEST_URI' ], 'options.php' ) ) {&nbsp;</div></li><li><div>          check_admin_referer( 'safecss' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $save_result = self::save( array(&nbsp;</div></li><li><div>              'css' =&gt; stripslashes( $_POST['safecss'] ), &nbsp;</div></li><li><div>              'is_preview' =&gt; isset( $_POST['action'] ) && $_POST['action'] == 'preview', &nbsp;</div></li><li><div>              'preprocessor' =&gt; isset( $_POST['custom_css_preprocessor'] ) ? $_POST['custom_css_preprocessor'] : '', &nbsp;</div></li><li><div>              'add_to_existing' =&gt; isset( $_POST['add_to_existing'] ) ? $_POST['add_to_existing'] == 'true' : true, &nbsp;</div></li><li><div>              'content_width' =&gt; isset( $_POST['custom_content_width'] ) ? $_POST['custom_content_width'] : false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $_POST['action'] == 'preview' ) {&nbsp;</div></li><li><div>              wp_safe_redirect( add_query_arg( 'csspreview', 'true', get_option( 'home' ) ) );&nbsp;</div></li><li><div>              exit;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $save_result )&nbsp;</div></li><li><div>              add_action( 'admin_notices', array( 'Jetpack_Custom_CSS', 'saved_message' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prevent content filters running on CSS when restoring revisions</span>&nbsp;</div></li><li><div>      if ( isset( $_REQUEST[ 'action' ] ) && 'restore' === $_REQUEST[ 'action' ] && false !== strstr( $_SERVER[ 'REQUEST_URI' ], 'revision.php' ) ) {&nbsp;</div></li><li><div>          $parent_post = get_post( wp_get_post_parent_id( intval( $_REQUEST[ 'revision' ] ) ) );&nbsp;</div></li><li><div>          if ( $parent_post && ! is_wp_error( $parent_post ) && 'safecss' === $parent_post-&gt;post_type ) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Remove wp_filter_post_kses, this causes CSS escaping issues</span></span>&nbsp;</div></li><li><div>              remove_filter( 'content_save_pre', 'wp_filter_post_kses' );&nbsp;</div></li><li><div>              remove_filter( 'content_filtered_save_pre', 'wp_filter_post_kses' );&nbsp;</div></li><li><div>              remove_all_filters( 'content_save_pre' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Modify all internal links so that preview state persists</span>&nbsp;</div></li><li><div>      if ( Jetpack_Custom_CSS::is_preview() )&nbsp;</div></li><li><div>          ob_start( array( 'Jetpack_Custom_CSS', 'buffer' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Save new custom CSS. This should be the entry point for any third-party code using Jetpack_Custom_CSS</span>&nbsp;</div></li><li><div><span class="comment">   * to save CSS.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args Array of arguments:</span>&nbsp;</div></li><li><div><span class="comment">   *        string $css The CSS (or LESS or Sass)</span>&nbsp;</div></li><li><div><span class="comment">   *        bool $is_preview Whether this CSS is preview or published</span>&nbsp;</div></li><li><div><span class="comment">   *        string preprocessor Which CSS preprocessor to use</span>&nbsp;</div></li><li><div><span class="comment">   *        bool $add_to_existing Whether this CSS replaces the theme's CSS or supplements it.</span>&nbsp;</div></li><li><div><span class="comment">   *        int $content_width A custom $content_width to go along with this CSS.</span>&nbsp;</div></li><li><div><span class="comment">   * @return int The post ID of the saved Custom CSS post.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function save( $args = array() ) {&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'css' =&gt; '', &nbsp;</div></li><li><div>          'is_preview' =&gt; false, &nbsp;</div></li><li><div>          'preprocessor' =&gt; '', &nbsp;</div></li><li><div>          'add_to_existing' =&gt; true, &nbsp;</div></li><li><div>          'content_width' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $args['content_width'] && intval( $args['content_width']) &gt; 0 && ( ! isset( $GLOBALS['content_width'] ) || $args['content_width'] != $GLOBALS['content_width'] ) )&nbsp;</div></li><li><div>          $args['content_width'] = intval( $args['content_width'] );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $args['content_width'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Remove wp_filter_post_kses, this causes CSS escaping issues</span></span>&nbsp;</div></li><li><div>      remove_filter( 'content_save_pre', 'wp_filter_post_kses' );&nbsp;</div></li><li><div>      remove_filter( 'content_filtered_save_pre', 'wp_filter_post_kses' );&nbsp;</div></li><li><div>      remove_all_filters( 'content_save_pre' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires prior to saving custom css values. Necessitated because the</span>&nbsp;</div></li><li><div><span class="comment">       * core WordPress save_pre filters were removed:</span>&nbsp;</div></li><li><div><span class="comment">       * - content_save_pre</span>&nbsp;</div></li><li><div><span class="comment">       * - content_filtered_save_pre</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $args {</span>&nbsp;</div></li><li><div><span class="comment">       * Array of custom CSS arguments.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type string $css The CSS (or LESS or Sass).</span>&nbsp;</div></li><li><div><span class="comment">       *     @type bool $is_preview Whether this CSS is preview or published.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type string preprocessor Which CSS preprocessor to use.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type bool $add_to_existing Whether this CSS replaces the theme's CSS or supplements it.</span>&nbsp;</div></li><li><div><span class="comment">       *     @type int $content_width A custom $content_width to go along with this CSS.</span>&nbsp;</div></li><li><div><span class="comment">       * }</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'safecss_save_pre', $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $warnings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      safecss_class();&nbsp;</div></li><li><div>      $csstidy = new csstidy();&nbsp;</div></li><li><div>      $csstidy-&gt;optimise = new safecss( $csstidy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'remove_bslash', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'compress_colors', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'compress_font-weight', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'optimise_shorthands', 0 );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'remove_last_;', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'case_properties', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'discard_invalid_properties', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'css_level', 'CSS3.0' );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'preserve_css', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'template', dirname( __FILE__ ) . '/csstidy/wordpress-standard.tpl' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = $orig = $args['css'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = preg_replace( '/\\\\([0-9a-fA-F]{4})/', '\\\\\\\\$1', $prev = $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $css != $prev )&nbsp;</div></li><li><div>          $warnings[] = 'preg_replace found stuff';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Some people put weird stuff in their CSS, KSES tends to be greedy</span>&nbsp;</div></li><li><div>      $css = str_replace( '&lt;=', '&lt;=', $css );&nbsp;</div></li><li><div>      <span class="comment">// Why KSES instead of strip_tags?  Who knows?</span>&nbsp;</div></li><li><div>      $css = wp_kses_split( $prev = $css, array(), array() );&nbsp;</div></li><li><div>      $css = str_replace( '&gt;', '&gt;', $css ); <span class="comment">// kses replaces lone '&gt;' with &gt;</span>&nbsp;</div></li><li><div>      <span class="comment">// Why both KSES and strip_tags?  Because we just added some '&gt;'.</span>&nbsp;</div></li><li><div>      $css = strip_tags( $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $css != $prev )&nbsp;</div></li><li><div>          $warnings[] = 'kses found stuff';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we're not using a preprocessor</span>&nbsp;</div></li><li><div>      if ( ! $args['preprocessor'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires before parsing the css with CSSTidy, but only if</span>&nbsp;</div></li><li><div><span class="comment">           * the preprocessor is not configured for use.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param obj $csstidy The csstidy object.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $css Custom CSS.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $args Array of custom CSS arguments.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'safecss_parse_pre', $csstidy, $css, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $csstidy-&gt;parse( $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires after parsing the css with CSSTidy, but only if</span>&nbsp;</div></li><li><div><span class="comment">           * the preprocessor is not cinfigured for use.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param obj $csstidy The csstidy object.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $warnings Array of warnings.</span>&nbsp;</div></li><li><div><span class="comment">           * @param array $args Array of custom CSS arguments.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'safecss_parse_post', $csstidy, $warnings, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $css = $csstidy-&gt;print-&gt;plain();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $args['add_to_existing'] )&nbsp;</div></li><li><div>          $add_to_existing = 'yes';&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $add_to_existing = 'no';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $args['is_preview'] || Jetpack_Custom_CSS::is_freetrial() ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Save the CSS</span></span>&nbsp;</div></li><li><div>          $safecss_revision_id = Jetpack_Custom_CSS::save_revision( $css, true, $args['preprocessor'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Cache Buster</span>&nbsp;</div></li><li><div>          update_option( 'safecss_preview_rev', intval( get_option( 'safecss_preview_rev' ) ) + 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_metadata( 'post', $safecss_revision_id, 'custom_css_add', $add_to_existing );&nbsp;</div></li><li><div>          update_metadata( 'post', $safecss_revision_id, 'content_width', $args['content_width'] );&nbsp;</div></li><li><div>          update_metadata( 'post', $safecss_revision_id, 'custom_css_preprocessor', $args['preprocessor'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          delete_option( 'safecss_add' );&nbsp;</div></li><li><div>          delete_option( 'safecss_content_width' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $args['is_preview'] ) {&nbsp;</div></li><li><div>              return $safecss_revision_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires after saving Custom CSS.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'safecss_save_preview_post' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Save the CSS</span></span>&nbsp;</div></li><li><div>      $safecss_post_id = Jetpack_Custom_CSS::save_revision( $css, false, $args['preprocessor'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $safecss_post_revision = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_option( 'safecss_rev', intval( get_option( 'safecss_rev' ) ) + 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $safecss_post_id, 'custom_css_add', $add_to_existing );&nbsp;</div></li><li><div>      update_post_meta( $safecss_post_id, 'content_width', $args['content_width'] );&nbsp;</div></li><li><div>      update_post_meta( $safecss_post_id, 'custom_css_preprocessor', $args['preprocessor'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option( 'safecss_add' );&nbsp;</div></li><li><div>      delete_option( 'safecss_content_width' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_post_revision['ID'], 'custom_css_add', $add_to_existing );&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_post_revision['ID'], 'content_width', $args['content_width'] );&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_post_revision['ID'], 'custom_css_preprocessor', $args['preprocessor'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option( 'safecss_preview_add' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $safecss_post_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the published custom CSS post.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_post() {&nbsp;</div></li><li><div>      $custom_css_post_id = Jetpack_Custom_CSS::post_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $custom_css_post_id )&nbsp;</div></li><li><div>          return get_post( $custom_css_post_id, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the post ID of the published custom CSS post.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|bool The post ID if it exists; false otherwise.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function post_id() {&nbsp;</div></li><li><div>      $custom_css_post_id = wp_cache_get( 'custom_css_post_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === $custom_css_post_id ) {&nbsp;</div></li><li><div>          $custom_css_posts = get_posts( array(&nbsp;</div></li><li><div>              'posts_per_page' =&gt; 1, &nbsp;</div></li><li><div>              'post_type' =&gt; 'safecss', &nbsp;</div></li><li><div>              'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>              'orderby' =&gt; 'date', &nbsp;</div></li><li><div>              'order' =&gt; 'DESC'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( count( $custom_css_posts ) &gt; 0 )&nbsp;</div></li><li><div>              $custom_css_post_id = $custom_css_posts[0]-&gt;ID;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $custom_css_post_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Save post_id=0 to note that no safecss post exists.</span>&nbsp;</div></li><li><div>          wp_cache_set( 'custom_css_post_id', $custom_css_post_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $custom_css_post_id )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $custom_css_post_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the current revision of the original safecss record</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_current_revision() {&nbsp;</div></li><li><div>      $safecss_post = Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $safecss_post ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $revisions = wp_get_post_revisions( $safecss_post['ID'], array( 'posts_per_page' =&gt; 1, 'orderby' =&gt; 'date', 'order' =&gt; 'DESC' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Empty array if no revisions exist</span>&nbsp;</div></li><li><div>      if ( empty( $revisions ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Return original post</span>&nbsp;</div></li><li><div>          return $safecss_post;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Return the first entry in $revisions, this will be the current revision</span>&nbsp;</div></li><li><div>          $current_revision = get_object_vars( array_shift( $revisions ) );&nbsp;</div></li><li><div>          return $current_revision;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Save new revision of CSS</span>&nbsp;</div></li><li><div><span class="comment">   * Checks to see if content was modified before really saving</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $css</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $is_preview</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool|int If nothing was saved, returns false. If a post</span>&nbsp;</div></li><li><div><span class="comment">   *                  or revision was saved, returns the post ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function save_revision( $css, $is_preview = false, $preprocessor = '' ) {&nbsp;</div></li><li><div>      $safecss_post = Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $compressed_css = Jetpack_Custom_CSS::minify( $css, $preprocessor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If null, there was no original safecss record, so create one</span>&nbsp;</div></li><li><div>      if ( null == $safecss_post ) {&nbsp;</div></li><li><div>          if ( ! $css )&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post = array();&nbsp;</div></li><li><div>          $post['post_content'] = $css;&nbsp;</div></li><li><div>          $post['post_title'] = 'safecss';&nbsp;</div></li><li><div>          $post['post_status'] = 'publish';&nbsp;</div></li><li><div>          $post['post_type'] = 'safecss';&nbsp;</div></li><li><div>          $post['post_content_filtered'] = $compressed_css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Set excerpt to current theme, for display in revisions list</span></span>&nbsp;</div></li><li><div>          if ( function_exists( 'wp_get_theme' ) ) {&nbsp;</div></li><li><div>              $current_theme = wp_get_theme();&nbsp;</div></li><li><div>              $post['post_excerpt'] = $current_theme-&gt;Name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $post['post_excerpt'] = get_current_theme();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Insert the CSS into wp_posts</span></span>&nbsp;</div></li><li><div>          $post_id = wp_insert_post( $post );&nbsp;</div></li><li><div>          wp_cache_set( 'custom_css_post_id', $post_id );&nbsp;</div></li><li><div>          return $post_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update CSS in post array with new value passed to this function</span>&nbsp;</div></li><li><div>      $safecss_post['post_content'] = $css;&nbsp;</div></li><li><div>      $safecss_post['post_content_filtered'] = $compressed_css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Set excerpt to current theme, for display in revisions list</span></span>&nbsp;</div></li><li><div>      if ( function_exists( 'wp_get_theme' ) ) {&nbsp;</div></li><li><div>          $current_theme = wp_get_theme();&nbsp;</div></li><li><div>          $safecss_post['post_excerpt'] = $current_theme-&gt;Name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else {&nbsp;</div></li><li><div>          $safecss_post['post_excerpt'] = get_current_theme();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Don't carry over last revision's timestamps, otherwise revisions all have matching timestamps</span>&nbsp;</div></li><li><div>      unset( $safecss_post['post_date'] );&nbsp;</div></li><li><div>      unset( $safecss_post['post_date_gmt'] );&nbsp;</div></li><li><div>      unset( $safecss_post['post_modified'] );&nbsp;</div></li><li><div>      unset( $safecss_post['post_modified_gmt'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Do not update post if we are only saving a preview</span>&nbsp;</div></li><li><div>      if ( false === $is_preview ) {&nbsp;</div></li><li><div>          $post_id = wp_update_post( $safecss_post );&nbsp;</div></li><li><div>          wp_cache_set( 'custom_css_post_id', $post_id );&nbsp;</div></li><li><div>          return $post_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if ( ! defined( 'DOING_MIGRATE' ) ) {&nbsp;</div></li><li><div>          return _wp_put_post_revision( $safecss_post );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function skip_stylesheet() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Prevent the Custom CSS stylesheet from being enqueued.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.2.1</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param null Should the stylesheet be skipped. Default to null. Anything else will force the stylesheet to be skipped.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $skip_stylesheet = apply_filters( 'safecss_skip_stylesheet', null );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( null !== $skip_stylesheet ) {&nbsp;</div></li><li><div>          return $skip_stylesheet;&nbsp;</div></li><li><div>      } elseif ( Jetpack_Custom_CSS::is_customizer_preview() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( Jetpack_Custom_CSS::is_preview() ) {&nbsp;</div></li><li><div>              $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $safecss_post )&nbsp;</div></li><li><div>                  return (bool) ( get_post_meta( $safecss_post['ID'], 'custom_css_add', true ) == 'no' );&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  return (bool) ( get_option( 'safecss_preview_add' ) == 'no' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          else {&nbsp;</div></li><li><div>              $custom_css_post_id = Jetpack_Custom_CSS::post_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $custom_css_post_id ) {&nbsp;</div></li><li><div>                  $custom_css_add = get_post_meta( $custom_css_post_id, 'custom_css_add', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// It is possible for the CSS to be stored in a post but for the safecss_add option</span>&nbsp;</div></li><li><div>                  <span class="comment">// to have not been upgraded yet if the user hasn't opened their Custom CSS editor</span>&nbsp;</div></li><li><div>                  <span class="comment">// since October 2012.</span>&nbsp;</div></li><li><div>                  if ( ! empty( $custom_css_add ) )&nbsp;</div></li><li><div>                      return (bool) ( $custom_css_add === 'no' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return (bool) ( get_option( 'safecss_add' ) == 'no' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function is_preview() {&nbsp;</div></li><li><div>      return isset( $_GET['csspreview'] ) && $_GET['csspreview'] === 'true';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Currently this filter function gets called on</span>&nbsp;</div></li><li><div><span class="comment">   * 'template_redirect' action and</span>&nbsp;</div></li><li><div><span class="comment">   * 'admin_init' action</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function set_content_width() {&nbsp;</div></li><li><div>      <span class="comment">// Don't apply this filter on the Edit CSS page</span>&nbsp;</div></li><li><div>      if ( isset( $_GET ) && isset( $_GET['page'] ) &&  'editcss' == $_GET['page'] && is_admin() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $GLOBALS['content_width'] = Jetpack::get_content_width();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * False when the site has the Custom Design upgrade.</span>&nbsp;</div></li><li><div><span class="comment">   * Used only on WordPress.com.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function is_freetrial() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Determine if a WordPress.com site uses a Free trial of the Custom Design Upgrade.</span>&nbsp;</div></li><li><div><span class="comment">       * Used only on WordPress.com.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool false Does the site use a Free trial of the Custom Design Upgrade. Default to false.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters( 'safecss_is_freetrial', false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function get_preprocessor_key() {&nbsp;</div></li><li><div>      $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>      return get_post_meta( $safecss_post['ID'], 'custom_css_preprocessor', true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function get_preprocessor() {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** This filter is documented in modules/custom-css/custom-css.php */</span></span>&nbsp;</div></li><li><div>      $preprocessors = apply_filters( 'jetpack_custom_css_preprocessors', array() );&nbsp;</div></li><li><div>      $selected_preprocessor_key = self::get_preprocessor_key();&nbsp;</div></li><li><div>      $selected_preprocessor = isset( $preprocessors[ $selected_preprocessor_key ] ) ? $preprocessors[ $selected_preprocessor_key ] : null;&nbsp;</div></li><li><div>      return $selected_preprocessor;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function get_css( $compressed = false ) {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Custom CSS returned.</span>&nbsp;</div></li><li><div><span class="comment">       * Can be used to return an error, or no CSS at all.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool false Should we return an error instead of the Custom CSS. Default to false.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $default_css = apply_filters( 'safecss_get_css_error', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $default_css !== false )&nbsp;</div></li><li><div>          return $default_css;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $option = ( Jetpack_Custom_CSS::is_preview() || Jetpack_Custom_CSS::is_freetrial() ) ? 'safecss_preview' : 'safecss';&nbsp;</div></li><li><div>      $css = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss' == $option ) {&nbsp;</div></li><li><div>          <span class="comment">// Don't bother checking for a migrated 'safecss' option if it never existed.</span>&nbsp;</div></li><li><div>          if ( false === get_option( 'safecss' ) || get_option( 'safecss_revision_migrated' ) ) {&nbsp;</div></li><li><div>              $safecss_post = Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>              if ( ! empty( $safecss_post ) ) {&nbsp;</div></li><li><div>                  $css = ( $compressed && $safecss_post['post_content_filtered'] ) ? $safecss_post['post_content_filtered'] : $safecss_post['post_content'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $current_revision = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>              if ( false === $current_revision ) {&nbsp;</div></li><li><div>                  $css = '';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $css = ( $compressed && $current_revision['post_content_filtered'] ) ? $current_revision['post_content_filtered'] : $current_revision['post_content'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Fix for un-migrated Custom CSS</span></span>&nbsp;</div></li><li><div>          if ( empty( $safecss_post ) ) {&nbsp;</div></li><li><div>              $_css = get_option( 'safecss' );&nbsp;</div></li><li><div>              if ( !empty( $_css ) ) {&nbsp;</div></li><li><div>                  $css = $_css;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else if ( 'safecss_preview' == $option ) {&nbsp;</div></li><li><div>          $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>          $css = $safecss_post['post_content'];&nbsp;</div></li><li><div>          $css = stripslashes( $css );&nbsp;</div></li><li><div>          $css = Jetpack_Custom_CSS::minify( $css, get_post_meta( $safecss_post['ID'], 'custom_css_preprocessor', true ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = str_replace( array( '\\\00BB \\\0020', '\0BB \020', '0BB 020' ), '\00BB \0020', $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $css ) ) {&nbsp;</div></li><li><div>          $css = &quot;<span class="comment">/*\n&quot;</span>&nbsp;</div></li><li><div><span class="comment">              . wordwrap(</span>&nbsp;</div></li><li><div><span class="comment">                  /**</span>&nbsp;</div></li><li><div><span class="comment">                   * Filter the default message displayed in the Custom CSS editor.</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">                   *</span>&nbsp;</div></li><li><div><span class="comment">                   * @param string $str Default Custom CSS editor content.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>                  apply_filters(&nbsp;</div></li><li><div>                      'safecss_default_css', &nbsp;</div></li><li><div>                      __(&nbsp;</div></li><li><div>                          &quot;Welcome to Custom CSS!\n\nTo learn how this works, see http:<span class="comment">//wp.me/PEmnE-Bt&quot;, </span>&nbsp;</div></li><li><div>                          'jetpack'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div>              . &quot;\n*/&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Custom CSS returned from the editor.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $css Custom CSS.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $css = apply_filters( 'safecss_css', $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $css;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function replace_insecure_urls( $css ) {&nbsp;</div></li><li><div>      if ( ! function_exists( '_sa_get_frontend_https_url_replacement_map' ) ) {&nbsp;</div></li><li><div>          return $css;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      list( $http_urls, $secure_urls ) = _sa_get_frontend_https_url_replacement_map();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return str_replace( $http_urls, $secure_urls, $css );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function print_css() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires right before printing the custom CSS inside the &lt;head&gt; element.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'safecss_print_pre' );&nbsp;</div></li><li><div>      $css = Jetpack_Custom_CSS::get_css( true );&nbsp;</div></li><li><div>      echo self::replace_insecure_urls( $css );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function should_we_inline_custom_css( $should_we, $css ) {&nbsp;</div></li><li><div>      <span class="comment">// If the CSS is less than 2, 000 characters, inline it! otherwise return what was passed in.</span>&nbsp;</div></li><li><div>      return ( strlen( $css ) &lt; 2000 ) ? true : $should_we;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function link_tag() {&nbsp;</div></li><li><div>      global $blog_id, $current_blog;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Do not include any CSS on the page if the CSS includes an error.</span>&nbsp;</div></li><li><div><span class="comment">           * Setting this filter to true stops any Custom CSS from being enqueued.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool false Does the CSS include an error. Default to false.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          apply_filters( 'safecss_style_error', false )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_super_admin() && isset( $current_blog ) && ( 1 == $current_blog-&gt;spam || 1 == $current_blog-&gt;deleted ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Jetpack_Custom_CSS::is_customizer_preview() )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = '';&nbsp;</div></li><li><div>      $option = Jetpack_Custom_CSS::is_preview() ? 'safecss_preview' : 'safecss';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss' == $option ) {&nbsp;</div></li><li><div>          if ( get_option( 'safecss_revision_migrated' ) ) {&nbsp;</div></li><li><div>              $safecss_post = Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $safecss_post['post_content'] ) ) {&nbsp;</div></li><li><div>                  $css = $safecss_post['post_content'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $current_revision = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $current_revision['post_content'] ) ) {&nbsp;</div></li><li><div>                  $css = $current_revision['post_content'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Fix for un-migrated Custom CSS</span></span>&nbsp;</div></li><li><div>          if ( empty( $safecss_post ) ) {&nbsp;</div></li><li><div>              $_css = get_option( 'safecss' );&nbsp;</div></li><li><div>              if ( !empty( $_css ) ) {&nbsp;</div></li><li><div>                  $css = $_css;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss_preview' == $option ) {&nbsp;</div></li><li><div>          $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !empty( $safecss_post['post_content'] ) ) {&nbsp;</div></li><li><div>              $css = $safecss_post['post_content'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = str_replace( array( '\\\00BB \\\0020', '\0BB \020', '0BB 020' ), '\00BB \0020', $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $css == '' )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Allow inserting CSS inline instead of through a separate file.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool false Should the CSS be added inline instead of through a separate file. Default to false.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $css Custom CSS.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          apply_filters( 'safecss_embed_style', false, $css )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;\r\n&quot; . '&lt;style id=&quot;custom-css-css&quot;&gt;' . Jetpack_Custom_CSS::get_css( true ) . &quot;&lt;/style&gt;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $href = home_url( '/' );&nbsp;</div></li><li><div>          $href = add_query_arg( 'custom-css', 1, $href );&nbsp;</div></li><li><div>          $href = add_query_arg( 'csblog', $blog_id, $href );&nbsp;</div></li><li><div>          $href = add_query_arg( 'cscache', 6, $href );&nbsp;</div></li><li><div>          $href = add_query_arg( 'csrev', (int) get_option( $option . '_rev' ), $href );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter the Custom CSS link enqueued in the head.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $href Custom CSS link enqueued in the head.</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $blog_id Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $href = apply_filters( 'safecss_href', $href, $blog_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( Jetpack_Custom_CSS::is_preview() )&nbsp;</div></li><li><div>              $href = add_query_arg( 'csspreview', 'true', $href );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;link rel=&quot;stylesheet&quot; id=&quot;custom-css-css&quot; type=&quot;text/css&quot; href=&quot;&lt;?php echo esc_url( $href ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires after creating the &lt;link&gt; in the &lt;head&gt; element for the custom css stylesheet.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.2.2</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'safecss_link_tag_post' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function style_filter( $current ) {&nbsp;</div></li><li><div>      if ( Jetpack_Custom_CSS::is_freetrial() && ( ! Jetpack_Custom_CSS::is_preview() || ! current_user_can( 'switch_themes' ) ) )&nbsp;</div></li><li><div>          return $current;&nbsp;</div></li><li><div>      else if ( Jetpack_Custom_CSS::skip_stylesheet() )&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter the default blank Custom CSS URL.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 2.2.1</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param string $url Default blank Custom CSS URL.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          return apply_filters( 'safecss_style_filter_url', plugins_url( 'custom-css/css/blank.css', __FILE__ ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $current;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function buffer( $html ) {&nbsp;</div></li><li><div>      $html = str_replace( '&lt;/body&gt;', Jetpack_Custom_CSS::preview_flag(), $html );&nbsp;</div></li><li><div>      return preg_replace_callback( '!href=([\'&quot;])(.*?)\\1!', array( 'Jetpack_Custom_CSS', 'preview_links' ), $html );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function preview_links( $matches ) {&nbsp;</div></li><li><div>      if ( 0 !== strpos( $matches[2], get_option( 'home' ) ) )&nbsp;</div></li><li><div>          return $matches[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $link = wp_specialchars_decode( $matches[2] );&nbsp;</div></li><li><div>      $link = add_query_arg( 'csspreview', 'true', $link );&nbsp;</div></li><li><div>      $link = esc_url( $link );&nbsp;</div></li><li><div>      return &quot;href={$matches[1]}$link{$matches[1]}&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Places a black bar above every preview page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function preview_flag() {&nbsp;</div></li><li><div>      if ( is_admin() )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message = esc_html__( 'Preview: changes must be saved or they will be lost', 'jetpack' );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Preview message displayed on the site when previewing custom CSS, before to save it.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $message Custom CSS preview message.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $message = apply_filters( 'safecss_preview_message', $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $preview_flag_js = &quot;var flag = document.createElement('div');&nbsp;</div></li><li><div>      flag.innerHTML = &quot; . json_encode( $message ) . &quot;;&nbsp;</div></li><li><div>      flag.style.background = '#FF6600';&nbsp;</div></li><li><div>      flag.style.color = 'white';&nbsp;</div></li><li><div>      flag.style.textAlign = 'center';&nbsp;</div></li><li><div>      flag.style.fontSize = '15px';&nbsp;</div></li><li><div>      flag.style.padding = '2px';&nbsp;</div></li><li><div>      flag.style.fontFamily = 'sans-serif';&nbsp;</div></li><li><div>      document.body.style.paddingTop = '0px';&nbsp;</div></li><li><div>      document.body.insertBefore(flag, document.body.childNodes[0]);&nbsp;</div></li><li><div>      &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the Custom CSS preview message JS styling.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $preview_flag_js Custom CSS preview message JS styling.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $preview_flag_js = apply_filters( 'safecss_preview_flag_js', $preview_flag_js );&nbsp;</div></li><li><div>      if ( $preview_flag_js ) {&nbsp;</div></li><li><div>          $preview_flag_js = '&lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>  <span class="comment">// &lt;![CDATA[</span>&nbsp;</div></li><li><div>  ' . $preview_flag_js . '&nbsp;</div></li><li><div>  <span class="comment">// ]]&gt;</span>&nbsp;</div></li><li><div>  &lt;/script&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $preview_flag_js;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function menu() {&nbsp;</div></li><li><div>      $parent = 'themes.php';&nbsp;</div></li><li><div>      $title = __( 'Edit CSS', 'jetpack' );&nbsp;</div></li><li><div>      $hook = add_theme_page( $title, $title, 'edit_theme_options', 'editcss', array( 'Jetpack_Custom_CSS', 'admin' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( &quot;load-revision.php&quot;, array( 'Jetpack_Custom_CSS', 'prettify_post_revisions' ) );&nbsp;</div></li><li><div>      add_action( &quot;load-$hook&quot;, array( 'Jetpack_Custom_CSS', 'update_title' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds a menu item in the appearance section for this plugin's administration</span>&nbsp;</div></li><li><div><span class="comment">   * page. Also adds hooks to enqueue the CSS and JS for the admin page.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function update_title() {&nbsp;</div></li><li><div>      global $title;&nbsp;</div></li><li><div>      $title = __( 'CSS', 'jetpack' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function prettify_post_revisions() {&nbsp;</div></li><li><div>      add_filter( 'the_title', array( 'Jetpack_Custom_CSS', 'post_title' ), 10, 2 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function post_title( $title, $post_id ) {&nbsp;</div></li><li><div>      if ( !$post_id = (int) $post_id ) {&nbsp;</div></li><li><div>          return $title;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$post = get_post( $post_id ) ) {&nbsp;</div></li><li><div>          return $title;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss' != $post-&gt;post_type ) {&nbsp;</div></li><li><div>          return $title;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return __( 'Custom CSS Stylesheet', 'jetpack' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function enqueue_scripts( $hook ) {&nbsp;</div></li><li><div>      if ( 'appearance_page_editcss' != $hook )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script( 'postbox' );&nbsp;</div></li><li><div>      wp_enqueue_script( 'custom-css-editor', plugins_url( 'custom-css/js/css-editor.js', __FILE__ ), 'jquery', '20130325', true );&nbsp;</div></li><li><div>      wp_enqueue_style( 'custom-css-editor', plugins_url( 'custom-css/css/css-editor.css', __FILE__ ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'SAFECSS_USE_ACE' ) && SAFECSS_USE_ACE ) {&nbsp;</div></li><li><div>          wp_register_style( 'jetpack-css-codemirror', plugins_url( 'custom-css/css/codemirror.css', __FILE__ ), array(), '20120905' );&nbsp;</div></li><li><div>          wp_enqueue_style( 'jetpack-css-use-codemirror', plugins_url( 'custom-css/css/use-codemirror.css', __FILE__ ), array( 'jetpack-css-codemirror' ), '20120905' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_register_script( 'jetpack-css-codemirror', plugins_url( 'custom-css/js/codemirror.min.js', __FILE__ ), array(), '3.16', true );&nbsp;</div></li><li><div>          wp_enqueue_script( 'jetpack-css-use-codemirror', plugins_url( 'custom-css/js/use-codemirror.js', __FILE__ ), array( 'jquery', 'underscore', 'jetpack-css-codemirror' ), '20131009', true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function saved_message() {&nbsp;</div></li><li><div>      echo '&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;&lt;strong&gt;' . __( 'Stylesheet saved.', 'jetpack' ) . '&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function admin() {&nbsp;</div></li><li><div>      add_meta_box( 'submitdiv', __( 'Publish', 'jetpack' ), array( __CLASS__, 'publish_box' ), 'editcss', 'side' );&nbsp;</div></li><li><div>      add_action( 'custom_css_submitbox_misc_actions', array( __CLASS__, 'content_width_settings' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $safecss_post = Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $safecss_post ) && 0 &lt; $safecss_post['ID'] && wp_get_post_revisions( $safecss_post['ID'] ) )&nbsp;</div></li><li><div>          add_meta_box( 'revisionsdiv', __( 'CSS Revisions', 'jetpack' ), array( __CLASS__, 'revisions_meta_box' ), 'editcss', 'side' );&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;wrap&quot;&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires right before the custom css page begins.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'custom_design_header' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;h1&gt;&lt;?php _e( 'CSS Stylesheet Editor', 'jetpack' ); ?&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>          &lt;form id=&quot;safecssform&quot; action=&quot;&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field( 'safecss' ) ?&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field( 'meta-box-order', 'meta-box-order-nonce', false ); ?&gt;&nbsp;</div></li><li><div>              &lt;?php wp_nonce_field( 'closedpostboxes', 'closedpostboxesnonce', false ); ?&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;save&quot; /&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;poststuff&quot;&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;css-support&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                       * Filter the intro text appearing above the Custom CSS Editor.</span>&nbsp;</div></li><li><div><span class="comment">                       *</span>&nbsp;</div></li><li><div><span class="comment">                       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">                       *</span>&nbsp;</div></li><li><div><span class="comment">                       * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">                       *</span>&nbsp;</div></li><li><div><span class="comment">                       * @param string $str Intro text appearing above the Custom CSS editor.</span>&nbsp;</div></li><li><div><span class="comment">                       */</span>&nbsp;</div></li><li><div>                      echo apply_filters( 'safecss_intro_text', __( 'New to CSS? Start with a &lt;a href=&quot;http:<span class="comment">//www.htmldog.com/guides/cssbeginner/&quot;&gt;beginner tutorial&lt;/a&gt;. Questions?</span>&nbsp;</div></li><li><div>      Ask in the &lt;a href=&quot;http:<span class="comment">//wordpress.org/support/forum/themes-and-templates&quot;&gt;Themes and Templates forum&lt;/a&gt;.', 'jetpack' ) );</span>&nbsp;</div></li><li><div>                  ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                  &lt;p class=&quot;css-support&quot;&gt;&lt;?php echo __( 'Note: Custom CSS will be reset when changing themes.', 'jetpack' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;div id=&quot;post-body&quot; class=&quot;metabox-holder columns-2&quot;&gt;&nbsp;</div></li><li><div>                      &lt;div id=&quot;post-body-content&quot;&gt;&nbsp;</div></li><li><div>                          &lt;div class=&quot;postarea&quot;&gt;&nbsp;</div></li><li><div>                              &lt;textarea id=&quot;safecss&quot; name=&quot;safecss&quot;&lt;?php if ( SAFECSS_USE_ACE ) echo ' class=&quot;hide-if-js&quot;'; ?&gt;&gt;&lt;?php echo esc_textarea( Jetpack_Custom_CSS::get_css() ); ?&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                              &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>                          &lt;/div&gt;&nbsp;</div></li><li><div>                      &lt;/div&gt;&nbsp;</div></li><li><div>                      &lt;div id=&quot;postbox-container-1&quot; class=&quot;postbox-container&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php do_meta_boxes( 'editcss', 'side', $safecss_post ); ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;br class=&quot;clear&quot; /&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;/form&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Content width setting callback</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function content_width_settings() {&nbsp;</div></li><li><div>      $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $custom_content_width = get_post_meta( $safecss_post['ID'], 'content_width', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If custom content width hasn't been overridden and the theme has a content_width value, use that as a default.</span>&nbsp;</div></li><li><div>      if ( $custom_content_width &lt;= 0 && ! empty( $GLOBALS['content_width'] ) )&nbsp;</div></li><li><div>          $custom_content_width = $GLOBALS['content_width'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $custom_content_width || ( isset( $GLOBALS['content_width'] ) && $custom_content_width == $GLOBALS['content_width'] ) )&nbsp;</div></li><li><div>          $custom_content_width = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div class=&quot;misc-pub-section&quot;&gt;&nbsp;</div></li><li><div>          &lt;label&gt;&lt;?php esc_html_e( 'Media Width:', 'jetpack' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>          &lt;span id=&quot;content-width-display&quot; data-default-text=&quot;&lt;?php esc_attr_e( 'Default', 'jetpack' ); ?&gt;&quot; data-custom-text=&quot;&lt;?php esc_attr_e( '%s px', 'jetpack' ); ?&gt;&quot;&gt;&lt;?php echo $custom_content_width ? sprintf( esc_html__( '%s px', 'jetpack' ), $custom_content_width ) : esc_html_e( 'Default', 'jetpack' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>          &lt;a class=&quot;edit-content-width hide-if-no-js&quot; href=&quot;#content-width&quot;&gt;&lt;?php echo esc_html_e( 'Edit', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;content-width-select&quot; class=&quot;hide-if-js&quot;&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;custom_content_width&quot; id=&quot;custom_content_width&quot; value=&quot;&lt;?php echo esc_attr( $custom_content_width ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  printf(&nbsp;</div></li><li><div>                      __( 'Limit width to %1$s pixels for full size images. (&lt;a href=&quot;%2$s&quot;&gt;More info&lt;/a&gt;.)', 'jetpack' ), &nbsp;</div></li><li><div>                      '&lt;input type=&quot;text&quot; id=&quot;custom_content_width_visible&quot; value=&quot;' . esc_attr( $custom_content_width ) . '&quot; size=&quot;4&quot; /&gt;', &nbsp;</div></li><li><div>                      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                       * Filter the Custom CSS limited width's support doc URL.</span>&nbsp;</div></li><li><div><span class="comment">                       *</span>&nbsp;</div></li><li><div><span class="comment">                       * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">                       *</span>&nbsp;</div></li><li><div><span class="comment">                       * @since 2.2.3</span>&nbsp;</div></li><li><div><span class="comment">                       *</span>&nbsp;</div></li><li><div><span class="comment">                       * @param string $url Custom CSS limited width's support doc URL.</span>&nbsp;</div></li><li><div><span class="comment">                       */</span>&nbsp;</div></li><li><div>                      apply_filters( 'safecss_limit_width_link', 'http:<span class="comment">//jetpack.me/support/custom-css/#limited-width' )</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>              &lt;/p&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( !empty( $GLOBALS['content_width'] ) && $custom_content_width != $GLOBALS['content_width'] ) {&nbsp;</div></li><li><div>                  if ( function_exists( 'wp_get_theme' ) )&nbsp;</div></li><li><div>                      $current_theme = wp_get_theme()-&gt;Name;&nbsp;</div></li><li><div>                  else&nbsp;</div></li><li><div>                      $current_theme = get_current_theme();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;p&gt;&lt;?php printf( __( 'The default content width for the %s theme is %d pixels.', 'jetpack' ), $current_theme, intval( $GLOBALS['content_width'] ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;a class=&quot;save-content-width hide-if-no-js button&quot; href=&quot;#content-width&quot;&gt;&lt;?php esc_html_e( 'OK', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>              &lt;a class=&quot;cancel-content-width hide-if-no-js&quot; href=&quot;#content-width&quot;&gt;&lt;?php esc_html_e( 'Cancel', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>              jQuery( function ( $ ) {&nbsp;</div></li><li><div>                  var defaultContentWidth = &lt;?php echo isset( $GLOBALS['content_width'] ) ? json_encode( intval( $GLOBALS['content_width'] ) ) : 0; ?&gt;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $( '.edit-content-width' ).bind( 'click', function ( e ) {&nbsp;</div></li><li><div>                      e.preventDefault();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $( '#content-width-select' ).slideDown();&nbsp;</div></li><li><div>                      $( this ).hide();&nbsp;</div></li><li><div>                  } );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $( '.cancel-content-width' ).bind( 'click', function ( e ) {&nbsp;</div></li><li><div>                      e.preventDefault();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $( '#content-width-select' ).slideUp( function () {&nbsp;</div></li><li><div>                          $( '.edit-content-width' ).show();&nbsp;</div></li><li><div>                          $( '#custom_content_width_visible' ).val( $( '#custom_content_width' ).val() );&nbsp;</div></li><li><div>                      } );&nbsp;</div></li><li><div>                  } );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $( '.save-content-width' ).bind( 'click', function ( e ) {&nbsp;</div></li><li><div>                      e.preventDefault();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $( '#content-width-select' ).slideUp();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      var newContentWidth = parseInt( $( '#custom_content_width_visible' ).val(), 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( newContentWidth && newContentWidth != defaultContentWidth ) {&nbsp;</div></li><li><div>                          $( '#content-width-display' ).text(&nbsp;</div></li><li><div>                              $( '#content-width-display' )&nbsp;</div></li><li><div>                                  .data( 'custom-text' )&nbsp;</div></li><li><div>                                      .replace( '%s', $( '#custom_content_width_visible' ).val() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      else {&nbsp;</div></li><li><div>                          $( '#content-width-display' ).text( $( '#content-width-display' ).data( 'default-text' ) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $( '#custom_content_width' ).val( $( '#custom_content_width_visible' ).val() );&nbsp;</div></li><li><div>                      $( '.edit-content-width' ).show();&nbsp;</div></li><li><div>                  } );&nbsp;</div></li><li><div>              } );&nbsp;</div></li><li><div>          &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function publish_box() {&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div id=&quot;minor-publishing&quot;&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;misc-publishing-actions&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filter the array of available Custom CSS preprocessors.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param array array() Empty by default.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              $preprocessors = apply_filters( 'jetpack_custom_css_preprocessors', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $preprocessors ) ) {&nbsp;</div></li><li><div>                  $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>                  $selected_preprocessor_key = get_post_meta( $safecss_post['ID'], 'custom_css_preprocessor', true );&nbsp;</div></li><li><div>                  $selected_preprocessor = isset( $preprocessors[$selected_preprocessor_key] ) ? $preprocessors[$selected_preprocessor_key] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;misc-pub-section&quot;&gt;&nbsp;</div></li><li><div>                      &lt;label&gt;&lt;?php esc_html_e( 'Preprocessor:', 'jetpack' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;span id=&quot;preprocessor-display&quot;&gt;&lt;?php echo esc_html( $selected_preprocessor ? $selected_preprocessor['name'] : __( 'None', 'jetpack' ) ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                      &lt;a class=&quot;edit-preprocessor hide-if-no-js&quot; href=&quot;#preprocessor&quot;&gt;&lt;?php echo esc_html_e( 'Edit', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                      &lt;div id=&quot;preprocessor-select&quot; class=&quot;hide-if-js&quot;&gt;&nbsp;</div></li><li><div>                          &lt;input type=&quot;hidden&quot; name=&quot;custom_css_preprocessor&quot; id=&quot;custom_css_preprocessor&quot; value=&quot;&lt;?php echo esc_attr( $selected_preprocessor_key ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                          &lt;select id=&quot;preprocessor_choices&quot;&gt;&nbsp;</div></li><li><div>                              &lt;option value=&quot;&quot;&gt;&lt;?php esc_html_e( 'None', 'jetpack' ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              foreach ( $preprocessors as $preprocessor_key =&gt; $preprocessor ) {&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                                  &lt;option value=&quot;&lt;?php echo esc_attr( $preprocessor_key ); ?&gt;&quot; &lt;?php selected( $selected_preprocessor_key, $preprocessor_key ); ?&gt;&gt;&lt;?php echo esc_html( $preprocessor['name'] ); ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>                                  &lt;?php&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              ?&gt;&nbsp;</div></li><li><div>                          &lt;/select&gt;&nbsp;</div></li><li><div>                          &lt;a class=&quot;save-preprocessor hide-if-no-js button&quot; href=&quot;#preprocessor&quot;&gt;&lt;?php esc_html_e( 'OK', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                          &lt;a class=&quot;cancel-preprocessor hide-if-no-js&quot; href=&quot;#preprocessor&quot;&gt;&lt;?php esc_html_e( 'Cancel', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                      &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $add_css = ( get_post_meta( $safecss_post['ID'], 'custom_css_add', true ) != 'no' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;misc-pub-section&quot;&gt;&nbsp;</div></li><li><div>                  &lt;label&gt;&lt;?php esc_html_e( 'Mode:', 'jetpack' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                  &lt;span id=&quot;css-mode-display&quot;&gt;&lt;?php echo esc_html( $add_css ? __( 'Add-on', 'jetpack' ) : __( 'Replacement', 'jetpack' ) ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;a class=&quot;edit-css-mode hide-if-no-js&quot; href=&quot;#css-mode&quot;&gt;&lt;?php echo esc_html_e( 'Edit', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                  &lt;div id=&quot;css-mode-select&quot; class=&quot;hide-if-js&quot;&gt;&nbsp;</div></li><li><div>                      &lt;input type=&quot;hidden&quot; name=&quot;add_to_existing&quot; id=&quot;add_to_existing&quot; value=&quot;&lt;?php echo $add_css ? 'true' : 'false'; ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;p&gt;&nbsp;</div></li><li><div>                          &lt;label&gt;&nbsp;</div></li><li><div>                              &lt;input type=&quot;radio&quot; name=&quot;add_to_existing_display&quot; value=&quot;true&quot; &lt;?php checked( $add_css ); ?&gt;/&gt;&nbsp;</div></li><li><div>                              &lt;?php _e( 'Add-on CSS &lt;b&gt;(Recommended)&lt;/b&gt;', 'jetpack' ); ?&gt;&nbsp;</div></li><li><div>                          &lt;/label&gt;&nbsp;</div></li><li><div>                          &lt;br /&gt;&nbsp;</div></li><li><div>                          &lt;label&gt;&nbsp;</div></li><li><div>                              &lt;input type=&quot;radio&quot; name=&quot;add_to_existing_display&quot; value=&quot;false&quot; &lt;?php checked( ! $add_css ); ?&gt;/&gt;&nbsp;</div></li><li><div>                              &lt;?php printf(&nbsp;</div></li><li><div>                                  __( 'Replace &lt;a href=&quot;%s&quot;&gt;theme\'s CSS&lt;/a&gt; &lt;b&gt;(Advanced)&lt;/b&gt;', 'jetpack' ), &nbsp;</div></li><li><div>                                  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                                   * Filter the theme's stylesheet URL.</span>&nbsp;</div></li><li><div><span class="comment">                                   *</span>&nbsp;</div></li><li><div><span class="comment">                                   * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">                                   *</span>&nbsp;</div></li><li><div><span class="comment">                                   * @since 1.7.0</span>&nbsp;</div></li><li><div><span class="comment">                                   *</span>&nbsp;</div></li><li><div><span class="comment">                                   * @param string $url Active theme's stylesheet URL. Default to get_stylesheet_uri().</span>&nbsp;</div></li><li><div><span class="comment">                                   */</span>&nbsp;</div></li><li><div>                                  apply_filters( 'safecss_theme_stylesheet_url', get_stylesheet_uri() )&nbsp;</div></li><li><div> ); ?&gt;&nbsp;</div></li><li><div>                          &lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;/p&gt;&nbsp;</div></li><li><div>                      &lt;a class=&quot;save-css-mode hide-if-no-js button&quot; href=&quot;#css-mode&quot;&gt;&lt;?php esc_html_e( 'OK', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                      &lt;a class=&quot;cancel-css-mode hide-if-no-js&quot; href=&quot;#css-mode&quot;&gt;&lt;?php esc_html_e( 'Cancel', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Allows addition of elements to the submit box for custom css on the wp-admin side.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 2.0.3</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              do_action( 'custom_css_submitbox_misc_actions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;div id=&quot;major-publishing-actions&quot;&gt;&nbsp;</div></li><li><div>          &lt;input type=&quot;button&quot; class=&quot;button&quot; id=&quot;preview&quot; name=&quot;preview&quot; value=&quot;&lt;?php esc_attr_e( 'Preview', 'jetpack' ) ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;publishing-action&quot;&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;submit&quot; class=&quot;button-primary&quot; id=&quot;save&quot; name=&quot;save&quot; value=&quot;&lt;?php ( Jetpack_Custom_CSS::is_freetrial() ) ? esc_attr_e( 'Save &amp; Buy Upgrade', 'jetpack' ) : esc_attr_e( 'Save Stylesheet', 'jetpack' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Render metabox listing CSS revisions and the themes that correspond to the revisions.</span>&nbsp;</div></li><li><div><span class="comment">   * Called by safecss_admin</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @global $post</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $safecss_post</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_revisions_to_keep</span>&nbsp;</div></li><li><div><span class="comment">   * @uses WP_Query</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_post_revision_title</span>&nbsp;</div></li><li><div><span class="comment">   * @uses esc_html</span>&nbsp;</div></li><li><div><span class="comment">   * @uses add_query_arg</span>&nbsp;</div></li><li><div><span class="comment">   * @uses menu_page_url</span>&nbsp;</div></li><li><div><span class="comment">   * @uses wp_reset_query</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function revisions_meta_box( $safecss_post ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $show_all_revisions = isset( $_GET['show_all_rev'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wp_revisions_to_keep' ) ) {&nbsp;</div></li><li><div>          $max_revisions = wp_revisions_to_keep( (object) $safecss_post );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $max_revisions = defined( 'WP_POST_REVISIONS' ) && is_numeric( WP_POST_REVISIONS ) ? (int) WP_POST_REVISIONS : 25;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $posts_per_page = $show_all_revisions ? $max_revisions : 6;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $revisions = new WP_Query( array(&nbsp;</div></li><li><div>          'posts_per_page' =&gt; $posts_per_page, &nbsp;</div></li><li><div>          'post_type' =&gt; 'revision', &nbsp;</div></li><li><div>          'post_status' =&gt; 'inherit', &nbsp;</div></li><li><div>          'post_parent' =&gt; $safecss_post['ID'], &nbsp;</div></li><li><div>          'orderby' =&gt; 'date', &nbsp;</div></li><li><div>          'order' =&gt; 'DESC'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $revisions-&gt;have_posts() ) { ?&gt;&nbsp;</div></li><li><div>          &lt;ul class=&quot;post-revisions&quot;&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          while ( $revisions-&gt;have_posts() ) :&nbsp;</div></li><li><div>              $revisions-&gt;the_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              ?&gt;&lt;li&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                      echo wp_post_revision_title( $post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! empty( $post-&gt;post_excerpt ) )&nbsp;</div></li><li><div>                          echo ' (' . esc_html( $post-&gt;post_excerpt ) . ')';&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>              &lt;/li&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&lt;/ul&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $revisions-&gt;found_posts &gt; 6 && !$show_all_revisions ) {&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;br&gt;&nbsp;</div></li><li><div>              &lt;a href=&quot;&lt;?php echo add_query_arg( 'show_all_rev', 'true', menu_page_url( 'editcss', false ) ); ?&gt;&quot;&gt;&lt;?php esc_html_e( 'Show all', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_reset_query();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hook in init at priority 11 to disable custom CSS.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function disable() {&nbsp;</div></li><li><div>      remove_action( 'wp_head', array( 'Jetpack_Custom_CSS', 'link_tag' ), 101 );&nbsp;</div></li><li><div>      remove_filter( 'stylesheet_uri', array( 'Jetpack_Custom_CSS', 'style_filter' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Reset all aspects of Custom CSS on a theme switch so that changing</span>&nbsp;</div></li><li><div><span class="comment">   * themes is a sure-fire way to get a clean start.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function reset() {&nbsp;</div></li><li><div>      $safecss_post_id = Jetpack_Custom_CSS::save_revision( '' );&nbsp;</div></li><li><div>      $safecss_revision = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_option( 'safecss_rev', intval( get_option( 'safecss_rev' ) ) + 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $safecss_post_id, 'custom_css_add', 'yes' );&nbsp;</div></li><li><div>      update_post_meta( $safecss_post_id, 'content_width', false );&nbsp;</div></li><li><div>      update_post_meta( $safecss_post_id, 'custom_css_preprocessor', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option( 'safecss_add' );&nbsp;</div></li><li><div>      delete_option( 'safecss_content_width' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_revision['ID'], 'custom_css_add', 'yes' );&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_revision['ID'], 'content_width', false );&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_revision['ID'], 'custom_css_preprocessor', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option( 'safecss_preview_add' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function is_customizer_preview() {&nbsp;</div></li><li><div>      if ( isset ( $GLOBALS['wp_customize'] ) )&nbsp;</div></li><li><div>          return ! $GLOBALS['wp_customize']-&gt;is_theme_active();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function minify( $css, $preprocessor = '' ) {&nbsp;</div></li><li><div>      if ( ! $css )&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $preprocessor ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** This filter is documented in modules/custom-css/custom-css.php */</span></span>&nbsp;</div></li><li><div>          $preprocessors = apply_filters( 'jetpack_custom_css_preprocessors', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $preprocessors[$preprocessor] ) ) {&nbsp;</div></li><li><div>              $css = call_user_func( $preprocessors[$preprocessor]['callback'], $css );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      safecss_class();&nbsp;</div></li><li><div>      $csstidy = new csstidy();&nbsp;</div></li><li><div>      $csstidy-&gt;optimise = new safecss( $csstidy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'remove_bslash', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'compress_colors', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'compress_font-weight', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'remove_last_;', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'case_properties', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'discard_invalid_properties', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'css_level', 'CSS3.0' );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'template', 'highest');&nbsp;</div></li><li><div>      $csstidy-&gt;parse( $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $csstidy-&gt;print-&gt;plain();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * When restoring a SafeCSS post revision, also copy over the</span>&nbsp;</div></li><li><div><span class="comment">   * content_width and custom_css_add post metadata.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function restore_revision( $_post_id, $_revision_id ) {&nbsp;</div></li><li><div>      $_post = get_post( $_post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss' != $_post-&gt;post_type )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $safecss_revision = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content_width = get_post_meta( $_revision_id, 'content_width', true );&nbsp;</div></li><li><div>      $custom_css_add = get_post_meta( $_revision_id, 'custom_css_add', true );&nbsp;</div></li><li><div>      $preprocessor = get_post_meta( $_revision_id, 'custom_css_preprocessor', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_revision['ID'], 'content_width', $content_width );&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_revision['ID'], 'custom_css_add', $custom_css_add );&nbsp;</div></li><li><div>      update_metadata( 'post', $safecss_revision['ID'], 'custom_css_preprocessor', $preprocessor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option( 'safecss_add' );&nbsp;</div></li><li><div>      delete_option( 'safecss_content_width' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $_post-&gt;ID, 'content_width', $content_width );&nbsp;</div></li><li><div>      update_post_meta( $_post-&gt;ID, 'custom_css_add', $custom_css_add );&nbsp;</div></li><li><div>      update_post_meta( $_post-&gt;ID, 'custom_css_preprocessor', $preprocessor );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option( 'safecss_preview_add' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Migration routine for moving safecss from wp_options to wp_posts to support revisions</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function upgrade() {&nbsp;</div></li><li><div>      $css = get_option( 'safecss' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_option( 'safecss_revision_migrated' ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if CSS is stored in wp_options</span>&nbsp;</div></li><li><div>      if ( $css ) {&nbsp;</div></li><li><div>          <span class="comment">// Remove the async actions from publish_post</span>&nbsp;</div></li><li><div>          remove_action( 'publish_post', 'queue_publish_post' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post = array();&nbsp;</div></li><li><div>          $post['post_content'] = $css;&nbsp;</div></li><li><div>          $post['post_title'] = 'safecss';&nbsp;</div></li><li><div>          $post['post_status'] = 'publish';&nbsp;</div></li><li><div>          $post['post_type'] = 'safecss';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Insert the CSS into wp_posts</span></span>&nbsp;</div></li><li><div>          $post_id = wp_insert_post( $post );&nbsp;</div></li><li><div>          <span class="comment">// Check for errors</span>&nbsp;</div></li><li><div>          if ( !$post_id or is_wp_error( $post_id ) )&nbsp;</div></li><li><div>              die( $post_id-&gt;get_error_message() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Delete safecss option</span>&nbsp;</div></li><li><div>          delete_option( 'safecss' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if we have already done this</span>&nbsp;</div></li><li><div>      if ( !get_option( 'safecss_revision_migrated' ) ) {&nbsp;</div></li><li><div>          define( 'DOING_MIGRATE', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get hashes of safecss post and current revision</span>&nbsp;</div></li><li><div>          $safecss_post = Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $safecss_post ) )&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $safecss_post_hash = md5( $safecss_post['post_content'] );&nbsp;</div></li><li><div>          $current_revision = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( null == $current_revision )&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $current_revision_hash = md5( $current_revision['post_content'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If hashes are not equal, set safecss post with content from current revision</span>&nbsp;</div></li><li><div>          if ( $safecss_post_hash !== $current_revision_hash ) {&nbsp;</div></li><li><div>              Jetpack_Custom_CSS::save_revision( $current_revision['post_content'] );&nbsp;</div></li><li><div>              <span class="comment">// Reset post_content to display the migrated revsion</span>&nbsp;</div></li><li><div>              $safecss_post['post_content'] = $current_revision['post_content'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set option so that we dont keep doing this</span>&nbsp;</div></li><li><div>          update_option( 'safecss_revision_migrated', time() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $newest_safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $newest_safecss_post ) {&nbsp;</div></li><li><div>          if ( get_option( 'safecss_content_width' ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Add the meta to the post and the latest revision.</span>&nbsp;</div></li><li><div>              update_post_meta( $newest_safecss_post['ID'], 'content_width', get_option( 'safecss_content_width' ) );&nbsp;</div></li><li><div>              update_metadata( 'post', $newest_safecss_post['ID'], 'content_width', get_option( 'safecss_content_width' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              delete_option( 'safecss_content_width' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( get_option( 'safecss_add' ) ) {&nbsp;</div></li><li><div>              update_post_meta( $newest_safecss_post['ID'], 'custom_css_add', get_option( 'safecss_add' ) );&nbsp;</div></li><li><div>              update_metadata( 'post', $newest_safecss_post['ID'], 'custom_css_add', get_option( 'safecss_add' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              delete_option( 'safecss_add' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function revision_redirect( $redirect ) {&nbsp;</div></li><li><div>      global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss' == $post-&gt;post_type ) {&nbsp;</div></li><li><div>          if ( strstr( $redirect, 'action=edit' ) ) {&nbsp;</div></li><li><div>              return 'themes.php?page=editcss';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'edit.php' == $redirect ) {&nbsp;</div></li><li><div>              return '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $redirect;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function revision_post_link( $post_link, $post_id, $context ) {&nbsp;</div></li><li><div>      if ( !$post_id = (int) $post_id ) {&nbsp;</div></li><li><div>          return $post_link;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$post = get_post( $post_id ) ) {&nbsp;</div></li><li><div>          return $post_link;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'safecss' != $post-&gt;post_type ) {&nbsp;</div></li><li><div>          return $post_link;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_link = admin_url( 'themes.php?page=editcss' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'display' == $context ) {&nbsp;</div></li><li><div>          return esc_url( $post_link );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return esc_url_raw( $post_link );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * When on the edit screen, make sure the custom content width</span>&nbsp;</div></li><li><div><span class="comment">   * setting is applied to the large image size.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function editor_max_image_size( $dims, $size = 'medium', $context = null ) {&nbsp;</div></li><li><div>      list( $width, $height ) = $dims;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'large' == $size && 'edit' == $context )&nbsp;</div></li><li><div>          $width = Jetpack::get_content_width();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array( $width, $height );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Override the content_width with a custom value if one is set.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function jetpack_content_width( $content_width ) {&nbsp;</div></li><li><div>      $custom_content_width = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( Jetpack_Custom_CSS::is_preview() ) {&nbsp;</div></li><li><div>          $safecss_post = Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>          $custom_content_width = intval( get_post_meta( $safecss_post['ID'], 'content_width', true ) );&nbsp;</div></li><li><div>      } else if ( ! Jetpack_Custom_CSS::is_freetrial() ) {&nbsp;</div></li><li><div>          $custom_css_post_id = Jetpack_Custom_CSS::post_id();&nbsp;</div></li><li><div>          if ( $custom_css_post_id )&nbsp;</div></li><li><div>              $custom_content_width = intval( get_post_meta( $custom_css_post_id, 'content_width', true ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $custom_content_width &gt; 0 )&nbsp;</div></li><li><div>          $content_width = $custom_content_width;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $content_width;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Jetpack_Safe_CSS {&nbsp;</div></li><li><div>  static function filter_attr( $css, $element = 'div' ) {&nbsp;</div></li><li><div>      safecss_class();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = $element . ' {' . $css . '}';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $csstidy = new csstidy();&nbsp;</div></li><li><div>      $csstidy-&gt;optimise = new safecss( $csstidy );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'remove_bslash', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'compress_colors', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'compress_font-weight', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'discard_invalid_properties', true );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'merge_selectors', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'remove_last_;', false );&nbsp;</div></li><li><div>      $csstidy-&gt;set_cfg( 'css_level', 'CSS3.0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = preg_replace( '/\\\\([0-9a-fA-F]{4})/', '\\\\\\\\$1', $css );&nbsp;</div></li><li><div>      $css = wp_kses_split( $css, array(), array() );&nbsp;</div></li><li><div>      $csstidy-&gt;parse( $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = $csstidy-&gt;print-&gt;plain();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $css = str_replace( array( &quot;\n&quot;, &quot;\r&quot;, &quot;\t&quot; ), '', $css );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      preg_match( &quot;/^{$element}\s*{(.*)}\s*$/&quot;, $css, $matches );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $matches[1] ) )&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $matches[1];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function migrate() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::upgrade()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::upgrade();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_revision_redirect( $redirect ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::revision_redirect()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::revision_redirect( $redirect );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_revision_post_link( $post_link, $post_id, $context ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::revision_post_link()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::revision_post_link( $post_link, $post_id, $context );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function get_safecss_post() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::get_post()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::get_post();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_post_id() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::post_id()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::post_id();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function get_current_revision() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::get_current_revision()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::get_current_revision();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function save_revision( $css, $is_preview = false, $preprocessor = '' ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::save_revision()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::save_revision( $css, $is_preview, $preprocessor );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_skip_stylesheet() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::skip_stylesheet()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::skip_stylesheet();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_init() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::init()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::init();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_is_preview() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::is_preview()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::is_preview();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_is_freetrial() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::is_freetrial()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::is_freetrial();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss( $compressed = false ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::get_css()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::get_css( $compressed );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_print() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::print_css()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::print_css();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_style() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::link_tag()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::link_tag();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_style_filter( $current ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::style_filter()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::style_filter( $current );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_buffer( $html ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::buffer()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::buffer( $html );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_preview_links( $matches ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::preview_links()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::preview_links( $matches );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_preview_flag() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::preview_flag()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::preview_flag();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_menu() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::menu()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::menu();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function update_title() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::update_title()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::update_title();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_prettify_post_revisions() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::prettify_post_revisions()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::prettify_post_revisions();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_remove_title_excerpt_from_revisions() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::remove_title_excerpt_from_revisions()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::remove_title_excerpt_from_revisions();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_post_title( $title, $post_id ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::post_title()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::post_title( $title, $post_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safe_css_enqueue_scripts() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::enqueue_scripts()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::enqueue_scripts();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_admin_head() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::admin_head()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::admin_head();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_saved() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::saved_message()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::saved_message();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_admin() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::admin()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::admin();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_meta_box() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'add_meta_box( $id, $title, $callback, \'editcss\', \'side\' )' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_post_revisions_meta_box( $safecss_post ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::revisions_meta_box()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::revisions_meta_box( $safecss_post );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function disable_safecss_style() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::disable()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::disable();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_reset() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::reset()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::reset();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_is_customizer_preview() {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::is_customizer_preview()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::is_customizer_preview();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_minify( $css, $preprocessor = '' ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::minify()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::minify( $css, $preprocessor );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function custom_css_restore_revision( $_post_id, $_revision_id ) {&nbsp;</div></li><li><div>  _deprecated_function( __FUNCTION__, '2.1', 'Jetpack_Custom_CSS::restore_revision()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return Jetpack_Custom_CSS::restore_revision( $_post_id, $_revision_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function safecss_class() {&nbsp;</div></li><li><div>  <span class="comment">// Wrapped so we don't need the parent class just to load the plugin</span>&nbsp;</div></li><li><div>  if ( class_exists('safecss') )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once( dirname( __FILE__ ) . '/csstidy/class.csstidy.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  class safecss extends csstidy_optimise {&nbsp;</div></li><li><div>      function __construct( &$css ) {&nbsp;</div></li><li><div>          return $this-&gt;csstidy_optimise( $css );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function postparse() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires after parsing the css.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param obj $this CSSTidy object.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          do_action( 'csstidy_optimize_postparse', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return parent::postparse();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function subvalue() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Fires before optimizing the Custom CSS subvalue.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module custom-css</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 1.8.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param obj $this CSSTidy object.</span>&nbsp;</div></li><li><div><span class="comment">           **/</span>&nbsp;</div></li><li><div>          do_action( 'csstidy_optimize_subvalue', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return parent::subvalue();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! function_exists( 'safecss_filter_attr' ) ) {&nbsp;</div></li><li><div>  function safecss_filter_attr( $css, $element = 'div' ) {&nbsp;</div></li><li><div>      return Jetpack_Safe_CSS::filter_attr( $css, $element );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'init', array( 'Jetpack_Custom_CSS', 'init' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>include dirname( __FILE__ ) . '/custom-css/preprocessors.php';&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>