<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.2" data-slug="jetpack-by-wordpress-com" data-type="file" data-id="11468"><head xmlns="http://www.w3.org/1999/xhtml"><title> class-json-api-endpoints | file | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, jetpack-by-wordpress-com, 3.8.2" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.17"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=fbc0ddc75b9ba43d8916474c458acd98' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.17' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/class-json-api-endpoints/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-json-api-endpoints%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclass-json-api-endpoints%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.2-file-class-json-api-endpoints","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="class-json-api-endpoints" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.2." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/" class="H_VERSION"><span property="name">3.8.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">class-json-api-endpoints</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1518"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/all/" title="All">All <span class="count badge">1518</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="605"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/hooks/" title="Hooks">Hooks <span class="count badge">605</span></a></li><li class="" data-id="action" data-count="196"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/actions/" title="Actions">Actions <span class="count badge">196</span></a></li><li class="" data-id="filter" data-count="409"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/filters/" title="Filters">Filters <span class="count badge">409</span></a></li><li class="" data-id="class" data-count="267"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/classes/" title="Classes">Classes <span class="count badge">267</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="538"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/functions/" title="Functions">Functions <span class="count badge">538</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/class.json-api-endpoints.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>require_once( dirname( __FILE__ ) . '/json-api-config.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Endpoint</span>&nbsp;</div></li><li><div>abstract class WPCOM_JSON_API_Endpoint {&nbsp;</div></li><li><div>  <span class="comment">// The API Object</span>&nbsp;</div></li><li><div>  public $api;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $pass_wpcom_user_details = false;&nbsp;</div></li><li><div>  public $can_use_user_details_instead_of_blog_membership = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// One liner.</span>&nbsp;</div></li><li><div>  public $description;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Object Grouping For Documentation (Users, Posts, Comments)</span>&nbsp;</div></li><li><div>  public $group;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Stats extra value to bump</span>&nbsp;</div></li><li><div>  public $stat;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// HTTP Method</span>&nbsp;</div></li><li><div>  public $method = 'GET';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Minimum version of the api for which to serve this endpoint</span>&nbsp;</div></li><li><div>  public $min_version = '0';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Maximum version of the api for which to serve this endpoint</span>&nbsp;</div></li><li><div>  public $max_version = WPCOM_JSON_API__CURRENT_VERSION;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Path at which to serve this endpoint: sprintf() format.</span>&nbsp;</div></li><li><div>  public $path = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Identifiers to fill sprintf() formatted $path</span>&nbsp;</div></li><li><div>  public $path_labels = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Accepted query parameters</span>&nbsp;</div></li><li><div>  public $query = array(&nbsp;</div></li><li><div>      <span class="comment">// Parameter name</span>&nbsp;</div></li><li><div>      'context' =&gt; array(&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Default value</span> =&gt; description</span>&nbsp;</div></li><li><div>          'display' =&gt; 'Formats the output as HTML for display.  Shortcodes are parsed, paragraph tags are added, etc..', &nbsp;</div></li><li><div>          <span class="comment">// Other possible values =&gt; description</span>&nbsp;</div></li><li><div>          'edit' =&gt; 'Formats the output for editing.  Shortcodes are left unparsed, significant whitespace is kept, etc..', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'http_envelope' =&gt; array(&nbsp;</div></li><li><div>          'false' =&gt; '', &nbsp;</div></li><li><div>          'true' =&gt; 'Some environments (like in-browser Javascript or Flash) block or divert responses with a non-200 HTTP status code.  Setting this parameter will force the HTTP status code to always be 200.  The JSON response is wrapped in an &quot;envelope&quot; containing the &quot;real&quot; HTTP status code and headers.', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'pretty' =&gt; array(&nbsp;</div></li><li><div>          'false' =&gt; '', &nbsp;</div></li><li><div>          'true' =&gt; 'Output pretty JSON', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'meta' =&gt; &quot;(string) Optional. Loads data from the endpoints found in the 'meta' part of the response. Comma-separated list. Example: meta=site, likes&quot;, &nbsp;</div></li><li><div>      'fields' =&gt; '(string) Optional. Returns specified fields only. Comma-separated list. Example: fields=ID, title', &nbsp;</div></li><li><div>      <span class="comment">// Parameter name</span> =&gt; description (default value is empty)&nbsp;</div></li><li><div>      'callback' =&gt; '(string) An optional JSONP callback function.', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Response format</span>&nbsp;</div></li><li><div>  public $response_format = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Request format</span>&nbsp;</div></li><li><div>  public $request_format = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is this endpoint still in testing phase?  If so, not available to the public.</span>&nbsp;</div></li><li><div>  public $in_testing = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Is this endpoint still allowed if the site in question is flagged?</span>&nbsp;</div></li><li><div>  public $allowed_if_flagged = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var string Version of the API</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $version = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var string Example request to make</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $example_request = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var string Example request data (for POST methods)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $example_request_data = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var string Example response from $example_request</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $example_response = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool Set to true if the endpoint implements its own filtering instead of the standard `fields` query method</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $custom_fields_filtering = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool Set to true if the endpoint accepts all cross origin requests. You probably should not set this flag.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $allow_cross_origin_request = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool Set to true if the endpoint can recieve unauthorized POST requests.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $allow_unauthorized_request = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var bool Set to true if the endpoint should accept site based (not user based) authentication.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $allow_jetpack_site_auth = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct( $args ) {&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'in_testing' =&gt; false, &nbsp;</div></li><li><div>          'allowed_if_flagged' =&gt; false, &nbsp;</div></li><li><div>          'description' =&gt; '', &nbsp;</div></li><li><div>          'group' =&gt; '', &nbsp;</div></li><li><div>          'method' =&gt; 'GET', &nbsp;</div></li><li><div>          'path' =&gt; '/', &nbsp;</div></li><li><div>          'min_version' =&gt; '0', &nbsp;</div></li><li><div>          'max_version' =&gt; WPCOM_JSON_API__CURRENT_VERSION, &nbsp;</div></li><li><div>          'force' =&gt; '', &nbsp;</div></li><li><div>          'deprecated' =&gt; false, &nbsp;</div></li><li><div>          'new_version' =&gt; WPCOM_JSON_API__CURRENT_VERSION, &nbsp;</div></li><li><div>          'jp_disabled' =&gt; false, &nbsp;</div></li><li><div>          'path_labels' =&gt; array(), &nbsp;</div></li><li><div>          'request_format' =&gt; array(), &nbsp;</div></li><li><div>          'response_format' =&gt; array(), &nbsp;</div></li><li><div>          'query_parameters' =&gt; array(), &nbsp;</div></li><li><div>          'version' =&gt; 'v1', &nbsp;</div></li><li><div>          'example_request' =&gt; '', &nbsp;</div></li><li><div>          'example_request_data' =&gt; '', &nbsp;</div></li><li><div>          'example_response' =&gt; '', &nbsp;</div></li><li><div>          'required_scope' =&gt; '', &nbsp;</div></li><li><div>          'pass_wpcom_user_details' =&gt; false, &nbsp;</div></li><li><div>          'can_use_user_details_instead_of_blog_membership' =&gt; false, &nbsp;</div></li><li><div>          'custom_fields_filtering' =&gt; false, &nbsp;</div></li><li><div>          'allow_cross_origin_request' =&gt; false, &nbsp;</div></li><li><div>          'allow_unauthorized_request' =&gt; false, &nbsp;</div></li><li><div>          'allow_jetpack_site_auth' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;in_testing = $args['in_testing'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;allowed_if_flagged = $args['allowed_if_flagged'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;description = $args['description'];&nbsp;</div></li><li><div>      $this-&gt;group = $args['group'];&nbsp;</div></li><li><div>      $this-&gt;stat = $args['stat'];&nbsp;</div></li><li><div>      $this-&gt;force = $args['force'];&nbsp;</div></li><li><div>      $this-&gt;jp_disabled = $args['jp_disabled'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;method = $args['method'];&nbsp;</div></li><li><div>      $this-&gt;path = $args['path'];&nbsp;</div></li><li><div>      $this-&gt;path_labels = $args['path_labels'];&nbsp;</div></li><li><div>      $this-&gt;min_version = $args['min_version'];&nbsp;</div></li><li><div>      $this-&gt;max_version = $args['max_version'];&nbsp;</div></li><li><div>      $this-&gt;deprecated = $args['deprecated'];&nbsp;</div></li><li><div>      $this-&gt;new_version = $args['new_version'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;pass_wpcom_user_details = $args['pass_wpcom_user_details'];&nbsp;</div></li><li><div>      $this-&gt;custom_fields_filtering = (bool) $args['custom_fields_filtering'];&nbsp;</div></li><li><div>      $this-&gt;can_use_user_details_instead_of_blog_membership = $args['can_use_user_details_instead_of_blog_membership'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;allow_cross_origin_request = (bool) $args['allow_cross_origin_request'];&nbsp;</div></li><li><div>      $this-&gt;allow_unauthorized_request = (bool) $args['allow_unauthorized_request'];&nbsp;</div></li><li><div>      $this-&gt;allow_jetpack_site_auth = (bool) $args['allow_jetpack_site_auth'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;version = $args['version'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;required_scope = $args['required_scope'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;request_format ) {&nbsp;</div></li><li><div>          $this-&gt;request_format = array_filter( array_merge( $this-&gt;request_format, $args['request_format'] ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;request_format = $args['request_format'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;response_format ) {&nbsp;</div></li><li><div>          $this-&gt;response_format = array_filter( array_merge( $this-&gt;response_format, $args['response_format'] ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;response_format = $args['response_format'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === $args['query_parameters'] ) {&nbsp;</div></li><li><div>          $this-&gt;query = array();&nbsp;</div></li><li><div>      } elseif ( is_array( $args['query_parameters'] ) ) {&nbsp;</div></li><li><div>          $this-&gt;query = array_filter( array_merge( $this-&gt;query, $args['query_parameters'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;api = WPCOM_JSON_API::init(); <span class="comment">// Auto-add to WPCOM_JSON_API</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Example Request/Response ******************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Examples for endpoint documentation request</span>&nbsp;</div></li><li><div>      $this-&gt;example_request = $args['example_request'];&nbsp;</div></li><li><div>      $this-&gt;example_request_data = $args['example_request_data'];&nbsp;</div></li><li><div>      $this-&gt;example_response = $args['example_response'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;api-&gt;add( $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get all query args.  Prefill with defaults</span>&nbsp;</div></li><li><div>  function query_args( $return_default_values = true, $cast_and_filter = true ) {&nbsp;</div></li><li><div>      $args = array_intersect_key( $this-&gt;api-&gt;query, $this-&gt;query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$cast_and_filter ) {&nbsp;</div></li><li><div>          return $args;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;cast_and_filter( $args, $this-&gt;query, $return_default_values );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get POST body data</span>&nbsp;</div></li><li><div>  function input( $return_default_values = true, $cast_and_filter = true ) {&nbsp;</div></li><li><div>      $input = trim( $this-&gt;api-&gt;post_body );&nbsp;</div></li><li><div>      $content_type = $this-&gt;api-&gt;content_type;&nbsp;</div></li><li><div>      if ( $content_type ) {&nbsp;</div></li><li><div>          list ( $content_type ) = explode( ';', $content_type );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $content_type = trim( $content_type );&nbsp;</div></li><li><div>      switch ( $content_type ) {&nbsp;</div></li><li><div>      case 'application/json' :&nbsp;</div></li><li><div>      case 'application/x-javascript' :&nbsp;</div></li><li><div>      case 'text/javascript' :&nbsp;</div></li><li><div>      case 'text/x-javascript' :&nbsp;</div></li><li><div>      case 'text/x-json' :&nbsp;</div></li><li><div>      case 'text/json' :&nbsp;</div></li><li><div>          $return = json_decode( $input, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( function_exists( 'json_last_error' ) ) {&nbsp;</div></li><li><div>              if ( JSON_ERROR_NONE !== json_last_error() ) {&nbsp;</div></li><li><div>                  return null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( is_null( $return ) && json_encode( null ) !== $input ) {&nbsp;</div></li><li><div>                  return null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'multipart/form-data' :&nbsp;</div></li><li><div>          $return = array_merge( stripslashes_deep( $_POST ), $_FILES );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'application/x-www-form-urlencoded' :&nbsp;</div></li><li><div>          <span class="comment">//attempt JSON first, since probably a curl command</span>&nbsp;</div></li><li><div>          $return = json_decode( $input, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_null( $return ) ) {&nbsp;</div></li><li><div>              wp_parse_str( $input, $return );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          wp_parse_str( $input, $return );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$cast_and_filter ) {&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;cast_and_filter( $return, $this-&gt;request_format, $return_default_values );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function cast_and_filter( $data, $documentation, $return_default_values = false, $for_output = false ) {&nbsp;</div></li><li><div>      $return_as_object = false;&nbsp;</div></li><li><div>      if ( is_object( $data ) ) {&nbsp;</div></li><li><div>          <span class="comment">// @todo this should probably be a deep copy if $data can ever have nested objects</span>&nbsp;</div></li><li><div>          $data = (array) $data;&nbsp;</div></li><li><div>          $return_as_object = true;&nbsp;</div></li><li><div>      } elseif ( !is_array( $data ) ) {&nbsp;</div></li><li><div>          return $data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $boolean_arg = array( 'false', 'true' );&nbsp;</div></li><li><div>      $naeloob_arg = array( 'true', 'false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $documentation as $key =&gt; $description ) {&nbsp;</div></li><li><div>          if ( is_array( $description ) ) {&nbsp;</div></li><li><div>              <span class="comment">// String or boolean array keys only</span>&nbsp;</div></li><li><div>              $whitelist = array_keys( $description );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $whitelist === $boolean_arg || $whitelist === $naeloob_arg ) {&nbsp;</div></li><li><div>                  <span class="comment">// Truthiness</span>&nbsp;</div></li><li><div>                  if ( isset( $data[$key] ) ) {&nbsp;</div></li><li><div>                      $return[$key] = (bool) WPCOM_JSON_API::is_truthy( $data[$key] );&nbsp;</div></li><li><div>                  } elseif ( $return_default_values ) {&nbsp;</div></li><li><div>                      $return[$key] = $whitelist === $naeloob_arg; <span class="comment">// Default to true for naeloob_arg and false for boolean_arg.</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( isset( $data[$key] ) && isset( $description[$data[$key]] ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// String Key</span>&nbsp;</div></li><li><div>                  $return[$key] = (string) $data[$key];&nbsp;</div></li><li><div>              } elseif ( $return_default_values ) {&nbsp;</div></li><li><div>                  <span class="comment">// Default value</span>&nbsp;</div></li><li><div>                  $return[$key] = (string) current( $whitelist );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $types = $this-&gt;parse_types( $description );&nbsp;</div></li><li><div>          $type = array_shift( $types );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Explicit default - string and int only for now.  Always set these reguardless of $return_default_values</span>&nbsp;</div></li><li><div>          if ( isset( $type['default'] ) ) {&nbsp;</div></li><li><div>              if ( !isset( $data[$key] ) ) {&nbsp;</div></li><li><div>                  $data[$key] = $type['default'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( !isset( $data[$key] ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;cast_and_filter_item( $return, $type, $key, $data[$key], $types, $for_output );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $return_as_object ) {&nbsp;</div></li><li><div>          return (object) $return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Casts $value according to $type.</span>&nbsp;</div></li><li><div><span class="comment">   * Handles fallbacks for certain values of $type when $value is not that $type</span>&nbsp;</div></li><li><div><span class="comment">   * Currently, only handles fallback between string &lt;-&gt; array (two way), from string -&gt; false (one way), and from object -&gt; false (one way)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Handles &quot;child types&quot; - array:URL, object:category</span>&nbsp;</div></li><li><div><span class="comment">   * array:URL means an array of URLs</span>&nbsp;</div></li><li><div><span class="comment">   * object:category means a hash of categories</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Handles object typing - object&gt;post means an object of type post</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cast_and_filter_item( &$return, $type, $key, $value, $types = array(), $for_output = false ) {&nbsp;</div></li><li><div>      if ( is_string( $type ) ) {&nbsp;</div></li><li><div>          $type = compact( 'type' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $type['type'] ) {&nbsp;</div></li><li><div>      case 'false' :&nbsp;</div></li><li><div>          $return[$key] = false;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'url' :&nbsp;</div></li><li><div>          $return[$key] = (string) esc_url_raw( $value );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'string' :&nbsp;</div></li><li><div>          <span class="comment">// Fallback string -&gt; array</span>&nbsp;</div></li><li><div>          if ( is_array( $value ) ) {&nbsp;</div></li><li><div>              if ( !empty( $types[0] ) ) {&nbsp;</div></li><li><div>                  $next_type = array_shift( $types );&nbsp;</div></li><li><div>                  return $this-&gt;cast_and_filter_item( $return, $next_type, $key, $value, $types, $for_output );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Fallback string -&gt; false</span>&nbsp;</div></li><li><div>          if ( !is_string( $value ) ) {&nbsp;</div></li><li><div>              if ( !empty( $types[0] ) && 'false' === $types[0]['type'] ) {&nbsp;</div></li><li><div>                  $next_type = array_shift( $types );&nbsp;</div></li><li><div>                  return $this-&gt;cast_and_filter_item( $return, $next_type, $key, $value, $types, $for_output );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $return[$key] = (string) $value;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'html' :&nbsp;</div></li><li><div>          $return[$key] = (string) $value;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'safehtml' :&nbsp;</div></li><li><div>          $return[$key] = wp_kses( (string) $value, wp_kses_allowed_html() );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'media' :&nbsp;</div></li><li><div>          if ( is_array( $value ) ) {&nbsp;</div></li><li><div>              if ( isset( $value['name'] ) ) {&nbsp;</div></li><li><div>                  <span class="comment">// It's a $_FILES array</span>&nbsp;</div></li><li><div>                  <span class="comment">// Reformat into array of $_FILES items</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $files = array();&nbsp;</div></li><li><div>                  foreach ( $value['name'] as $k =&gt; $v ) {&nbsp;</div></li><li><div>                      $files[$k] = array();&nbsp;</div></li><li><div>                      foreach ( array_keys( $value ) as $file_key ) {&nbsp;</div></li><li><div>                          $files[$k][$file_key] = $value[$file_key][$k];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $return[$key] = $files;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// no break - treat as 'array'</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// nobreak</span>&nbsp;</div></li><li><div>      case 'array' :&nbsp;</div></li><li><div>          <span class="comment">// Fallback array -&gt; string</span>&nbsp;</div></li><li><div>          if ( is_string( $value ) ) {&nbsp;</div></li><li><div>              if ( !empty( $types[0] ) ) {&nbsp;</div></li><li><div>                  $next_type = array_shift( $types );&nbsp;</div></li><li><div>                  return $this-&gt;cast_and_filter_item( $return, $next_type, $key, $value, $types, $for_output );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $type['children'] ) ) {&nbsp;</div></li><li><div>              $children = array();&nbsp;</div></li><li><div>              foreach ( (array) $value as $k =&gt; $child ) {&nbsp;</div></li><li><div>                  $this-&gt;cast_and_filter_item( $children, $type['children'], $k, $child, array(), $for_output );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $return[$key] = (array) $children;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $return[$key] = (array) $value;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'iso 8601 datetime' :&nbsp;</div></li><li><div>      case 'datetime' :&nbsp;</div></li><li><div>          <span class="comment">// (string)s</span>&nbsp;</div></li><li><div>          $dates = $this-&gt;parse_date( (string) $value );&nbsp;</div></li><li><div>          if ( $for_output ) {&nbsp;</div></li><li><div>              $return[$key] = $this-&gt;format_date( $dates[1], $dates[0] );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              list( $return[$key], $return[&quot;{$key}_gmt&quot;] ) = $dates;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'float' :&nbsp;</div></li><li><div>          $return[$key] = (float) $value;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'int' :&nbsp;</div></li><li><div>      case 'integer' :&nbsp;</div></li><li><div>          $return[$key] = (int) $value;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'bool' :&nbsp;</div></li><li><div>      case 'boolean' :&nbsp;</div></li><li><div>          $return[$key] = (bool) WPCOM_JSON_API::is_truthy( $value );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'object' :&nbsp;</div></li><li><div>          <span class="comment">// Fallback object -&gt; false</span>&nbsp;</div></li><li><div>          if ( is_scalar( $value ) || is_null( $value ) ) {&nbsp;</div></li><li><div>              if ( !empty( $types[0] ) && 'false' === $types[0]['type'] ) {&nbsp;</div></li><li><div>                  return $this-&gt;cast_and_filter_item( $return, 'false', $key, $value, $types, $for_output );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $type['children'] ) ) {&nbsp;</div></li><li><div>              $children = array();&nbsp;</div></li><li><div>              foreach ( (array) $value as $k =&gt; $child ) {&nbsp;</div></li><li><div>                  $this-&gt;cast_and_filter_item( $children, $type['children'], $k, $child, array(), $for_output );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $return[$key] = (object) $children;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $type['subtype'] ) ) {&nbsp;</div></li><li><div>              return $this-&gt;cast_and_filter_item( $return, $type['subtype'], $key, $value, $types, $for_output );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $return[$key] = (object) $value;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'post' :&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $this-&gt;post_object_format, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'comment' :&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $this-&gt;comment_object_format, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'tag' :&nbsp;</div></li><li><div>      case 'category' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'ID' =&gt; '(int)', &nbsp;</div></li><li><div>              'name' =&gt; '(string)', &nbsp;</div></li><li><div>              'slug' =&gt; '(string)', &nbsp;</div></li><li><div>              'description' =&gt; '(HTML)', &nbsp;</div></li><li><div>              'post_count' =&gt; '(int)', &nbsp;</div></li><li><div>              'meta' =&gt; '(object)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          if ( 'category' === $type['type'] ) {&nbsp;</div></li><li><div>              $docs['parent'] = '(int)';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'post_reference' :&nbsp;</div></li><li><div>      case 'comment_reference' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'ID' =&gt; '(int)', &nbsp;</div></li><li><div>              'type' =&gt; '(string)', &nbsp;</div></li><li><div>              'title' =&gt; '(string)', &nbsp;</div></li><li><div>              'link' =&gt; '(URL)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'geo' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'latitude' =&gt; '(float)', &nbsp;</div></li><li><div>              'longitude' =&gt; '(float)', &nbsp;</div></li><li><div>              'address' =&gt; '(string)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'author' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'ID' =&gt; '(int)', &nbsp;</div></li><li><div>              'user_login' =&gt; '(string)', &nbsp;</div></li><li><div>              'login' =&gt; '(string)', &nbsp;</div></li><li><div>              'email' =&gt; '(string|false)', &nbsp;</div></li><li><div>              'name' =&gt; '(string)', &nbsp;</div></li><li><div>              'first_name' =&gt; '(string)', &nbsp;</div></li><li><div>              'last_name' =&gt; '(string)', &nbsp;</div></li><li><div>              'nice_name' =&gt; '(string)', &nbsp;</div></li><li><div>              'URL' =&gt; '(URL)', &nbsp;</div></li><li><div>              'avatar_URL' =&gt; '(URL)', &nbsp;</div></li><li><div>              'profile_URL' =&gt; '(URL)', &nbsp;</div></li><li><div>              'is_super_admin' =&gt; '(bool)', &nbsp;</div></li><li><div>              'roles' =&gt; '(array:string)'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'role' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'name' =&gt; '(string)', &nbsp;</div></li><li><div>              'display_name' =&gt; '(string)', &nbsp;</div></li><li><div>              'capabilities' =&gt; '(object:boolean)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'attachment' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'ID' =&gt; '(int)', &nbsp;</div></li><li><div>              'URL' =&gt; '(URL)', &nbsp;</div></li><li><div>              'guid' =&gt; '(string)', &nbsp;</div></li><li><div>              'mime_type' =&gt; '(string)', &nbsp;</div></li><li><div>              'width' =&gt; '(int)', &nbsp;</div></li><li><div>              'height' =&gt; '(int)', &nbsp;</div></li><li><div>              'duration' =&gt; '(int)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter(&nbsp;</div></li><li><div>              $value, &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filter the documentation returned for a post attachment.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param array $docs Array of documentation about a post attachment.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              apply_filters( 'wpcom_json_api_attachment_cast_and_filter', $docs ), &nbsp;</div></li><li><div>              false, &nbsp;</div></li><li><div>              $for_output&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'metadata' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'id' =&gt; '(int)', &nbsp;</div></li><li><div>              'key' =&gt; '(string)', &nbsp;</div></li><li><div>              'value' =&gt; '(string|false|float|int|array|object)', &nbsp;</div></li><li><div>              'previous_value' =&gt; '(string)', &nbsp;</div></li><li><div>              'operation' =&gt; '(string)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter(&nbsp;</div></li><li><div>              $value, &nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in class.json-api-endpoints.php */</span></span></span>&nbsp;</div></li><li><div>              apply_filters( 'wpcom_json_api_attachment_cast_and_filter', $docs ), &nbsp;</div></li><li><div>              false, &nbsp;</div></li><li><div>              $for_output&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'plugin' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'id' =&gt; '(safehtml) The plugin\'s ID', &nbsp;</div></li><li><div>              'slug' =&gt; '(safehtml) The plugin\'s Slug', &nbsp;</div></li><li><div>              'active' =&gt; '(boolean)  The plugin status.', &nbsp;</div></li><li><div>              'update' =&gt; '(object)   The plugin update info.', &nbsp;</div></li><li><div>              'name' =&gt; '(safehtml) The name of the plugin.', &nbsp;</div></li><li><div>              'plugin_url' =&gt; '(url)      Link to the plugin\'s web site.', &nbsp;</div></li><li><div>              'version' =&gt; '(safehtml) The plugin version number.', &nbsp;</div></li><li><div>              'description' =&gt; '(safehtml) Description of what the plugin does and/or notes from the author', &nbsp;</div></li><li><div>              'author' =&gt; '(safehtml) The plugin author\'s name', &nbsp;</div></li><li><div>              'author_url' =&gt; '(url)      The plugin author web site address', &nbsp;</div></li><li><div>              'network' =&gt; '(boolean)  Whether the plugin can only be activated network wide.', &nbsp;</div></li><li><div>              'autoupdate' =&gt; '(boolean)  Whether the plugin is auto updated', &nbsp;</div></li><li><div>              'log' =&gt; '(array:safehtml) An array of update log strings.', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter(&nbsp;</div></li><li><div>              $value, &nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filter the documentation returned for a plugin.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 3.1.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param array $docs Array of documentation about a plugin.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              apply_filters( 'wpcom_json_api_plugin_cast_and_filter', $docs ), &nbsp;</div></li><li><div>              false, &nbsp;</div></li><li><div>              $for_output&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'jetpackmodule' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'id' =&gt; '(string)   The module\'s ID', &nbsp;</div></li><li><div>              'active' =&gt; '(boolean)  The module\'s status.', &nbsp;</div></li><li><div>              'name' =&gt; '(string)   The module\'s name.', &nbsp;</div></li><li><div>              'description' =&gt; '(safehtml) The module\'s description.', &nbsp;</div></li><li><div>              'sort' =&gt; '(int)      The module\'s display order.', &nbsp;</div></li><li><div>              'introduced' =&gt; '(string)   The Jetpack version when the module was introduced.', &nbsp;</div></li><li><div>              'changed' =&gt; '(string)   The Jetpack version when the module was changed.', &nbsp;</div></li><li><div>              'free' =&gt; '(boolean)  The module\'s Free or Paid status.', &nbsp;</div></li><li><div>              'module_tags' =&gt; '(array)    The module\'s tags.'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (object) $this-&gt;cast_and_filter(&nbsp;</div></li><li><div>              $value, &nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in class.json-api-endpoints.php */</span></span></span>&nbsp;</div></li><li><div>              apply_filters( 'wpcom_json_api_plugin_cast_and_filter', $docs ), &nbsp;</div></li><li><div>              false, &nbsp;</div></li><li><div>              $for_output&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'sharing_button' :&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'ID' =&gt; '(string)', &nbsp;</div></li><li><div>              'name' =&gt; '(string)', &nbsp;</div></li><li><div>              'URL' =&gt; '(string)', &nbsp;</div></li><li><div>              'icon' =&gt; '(string)', &nbsp;</div></li><li><div>              'enabled' =&gt; '(bool)', &nbsp;</div></li><li><div>              'visibility' =&gt; '(string)', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (array) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'sharing_button_service':&nbsp;</div></li><li><div>          $docs = array(&nbsp;</div></li><li><div>              'ID' =&gt; '(string) The service identifier', &nbsp;</div></li><li><div>              'name' =&gt; '(string) The service name', &nbsp;</div></li><li><div>              'class_name' =&gt; '(string) Class name for custom style sharing button elements', &nbsp;</div></li><li><div>              'genericon' =&gt; '(string) The Genericon unicode character for the custom style sharing button icon', &nbsp;</div></li><li><div>              'preview_smart' =&gt; '(string) An HTML snippet of a rendered sharing button smart preview', &nbsp;</div></li><li><div>              'preview_smart_js' =&gt; '(string) An HTML snippet of the page-wide initialization scripts used for rendering the sharing button smart preview'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $return[$key] = (array) $this-&gt;cast_and_filter( $value, $docs, false, $for_output );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          $method_name = $type['type'] . '_docs';&nbsp;</div></li><li><div>          if ( method_exists( WPCOM_JSON_API_Jetpack_Overrides, $method_name ) ) {&nbsp;</div></li><li><div>              $docs = WPCOM_JSON_API_Jetpack_Overrides::$method_name();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $docs ) ) {&nbsp;</div></li><li><div>              $return[$key] = (object) $this-&gt;cast_and_filter(&nbsp;</div></li><li><div>                  $value, &nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">/** This filter is documented in class.json-api-endpoints.php */</span></span></span>&nbsp;</div></li><li><div>                  apply_filters( 'wpcom_json_api_plugin_cast_and_filter', $docs ), &nbsp;</div></li><li><div>                  false, &nbsp;</div></li><li><div>                  $for_output&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              trigger_error( &quot;Unknown API casting type {$type['type']}&quot;, E_USER_WARNING );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function parse_types( $text ) {&nbsp;</div></li><li><div>      if ( !preg_match( '#^\(([^)]+)\)#', ltrim( $text ), $matches ) ) {&nbsp;</div></li><li><div>          return 'none';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $types = explode( '|', strtolower( $matches[1] ) );&nbsp;</div></li><li><div>      $return = array();&nbsp;</div></li><li><div>      foreach ( $types as $type ) {&nbsp;</div></li><li><div>          foreach ( array( ':' =&gt; 'children', '&gt;' =&gt; 'subtype', '=' =&gt; 'default' ) as $operator =&gt; $meaning ) {&nbsp;</div></li><li><div>              if ( false !== strpos( $type, $operator ) ) {&nbsp;</div></li><li><div>                  $item = explode( $operator, $type, 2 );&nbsp;</div></li><li><div>                  $return[] = array( 'type' =&gt; $item[0], $meaning =&gt; $item[1] );&nbsp;</div></li><li><div>                  continue 2;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $return[] = compact( 'type' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if the endpoint is publicly displayable</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function is_publicly_documentable() {&nbsp;</div></li><li><div>      return '__do_not_document' !== $this-&gt;group && true !== $this-&gt;in_testing;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Auto generates documentation based on description, method, path, path_labels, and query parameters.</span>&nbsp;</div></li><li><div><span class="comment">   * Echoes HTML.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function document( $show_description = true ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $original_post = isset( $GLOBALS['post'] ) ? $GLOBALS['post'] : 'unset';&nbsp;</div></li><li><div>      unset( $GLOBALS['post'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $doc = $this-&gt;generate_documentation();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $show_description ) :&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&lt;caption&gt;&nbsp;</div></li><li><div>  &lt;h1&gt;&lt;?php echo wp_kses_post( $doc['method'] ); ?&gt; &lt;?php echo wp_kses_post( $doc['path_labeled'] ); ?&gt;&lt;/h1&gt;&nbsp;</div></li><li><div>  &lt;p&gt;&lt;?php echo wp_kses_post( $doc['description'] ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;/caption&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php if ( true === $this-&gt;deprecated ) { ?&gt;&nbsp;</div></li><li><div>&lt;p&gt;&lt;strong&gt;This endpoint is deprecated in favor of version &lt;?php echo floatval( $this-&gt;new_version ); ?&gt;&lt;/strong&gt;&lt;/p&gt;&nbsp;</div></li><li><div>&lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;section class=&quot;resource-info&quot;&gt;&nbsp;</div></li><li><div>  &lt;h2 id=&quot;apidoc-resource-info&quot;&gt;Resource Information&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;table class=&quot;api-doc api-doc-resource-parameters api-doc-resource&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;thead&gt;&nbsp;</div></li><li><div>      &lt;tr&gt;&nbsp;</div></li><li><div>          &lt;th class=&quot;api-index-title&quot; scope=&quot;column&quot;&gt;&nbsp;&lt;/th&gt;&nbsp;</div></li><li><div>          &lt;th class=&quot;api-index-title&quot; scope=&quot;column&quot;&gt;&nbsp;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>  &lt;/thead&gt;&nbsp;</div></li><li><div>  &lt;tbody&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;api-index-item&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;parameter api-index-item-title&quot;&gt;Method&lt;/th&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;type api-index-item-title&quot;&gt;&lt;?php echo wp_kses_post( $doc['method'] ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;api-index-item&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;parameter api-index-item-title&quot;&gt;URL&lt;/th&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          $version = WPCOM_JSON_API__CURRENT_VERSION;&nbsp;</div></li><li><div>          if ( !empty( $this-&gt;max_version ) ) {&nbsp;</div></li><li><div>              $version = $this-&gt;max_version;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;type api-index-item-title&quot;&gt;https:<span class="comment">//public-api.wordpress.com/rest/v&lt;?php echo floatval( $version ); ?&gt;&lt;?php echo wp_kses_post( $doc['path_labeled'] ); ?&gt;&lt;/td&gt;</span>&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;api-index-item&quot;&gt;&nbsp;</div></li><li><div>          &lt;th scope=&quot;row&quot; class=&quot;parameter api-index-item-title&quot;&gt;Requires authentication?&lt;/th&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>          $requires_auth = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT requires_authentication FROM rest_api_documentation WHERE `version` = %s AND `path` = %s AND `method` = %s LIMIT 1&quot;, $version, untrailingslashit( $doc['path_labeled'] ), $doc['method'] ) );&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;td class=&quot;type api-index-item-title&quot;&gt;&lt;?php echo ( true === (bool) $requires_auth-&gt;requires_authentication ? 'Yes' : 'No' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;/tbody&gt;&nbsp;</div></li><li><div>  &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;/section&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( array(&nbsp;</div></li><li><div>          'path' =&gt; 'Method Parameters', &nbsp;</div></li><li><div>          'query' =&gt; 'Query Parameters', &nbsp;</div></li><li><div>          'body' =&gt; 'Request Parameters', &nbsp;</div></li><li><div>          'response' =&gt; 'Response Parameters', &nbsp;</div></li><li><div> ) as $doc_section_key =&gt; $label ) :&nbsp;</div></li><li><div>          $doc_section = 'response' === $doc_section_key ? $doc['response']['body'] : $doc['request'][$doc_section_key];&nbsp;</div></li><li><div>          if ( !$doc_section ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $param_label = strtolower( str_replace( ' ', '-', $label ) );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;section class=&quot;&lt;?php echo $param_label; ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;h2 id=&quot;apidoc-&lt;?php echo esc_attr( $doc_section_key ); ?&gt;&quot;&gt;&lt;?php echo wp_kses_post( $label ); ?&gt;&lt;/h2&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;table class=&quot;api-doc api-doc-&lt;?php echo $param_label; ?&gt;-parameters api-doc-&lt;?php echo strtolower( str_replace( ' ', '-', $doc['group'] ) ); ?&gt;&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;thead&gt;&nbsp;</div></li><li><div>  &lt;tr&gt;&nbsp;</div></li><li><div>      &lt;th class=&quot;api-index-title&quot; scope=&quot;column&quot;&gt;Parameter&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th class=&quot;api-index-title&quot; scope=&quot;column&quot;&gt;Type&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;th class=&quot;api-index-title&quot; scope=&quot;column&quot;&gt;Description&lt;/th&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&lt;/thead&gt;&nbsp;</div></li><li><div>&lt;tbody&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php foreach ( $doc_section as $key =&gt; $item ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;tr class=&quot;api-index-item&quot;&gt;&nbsp;</div></li><li><div>      &lt;th scope=&quot;row&quot; class=&quot;parameter api-index-item-title&quot;&gt;&lt;?php echo wp_kses_post( $key ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>      &lt;td class=&quot;type api-index-item-title&quot;&gt;&lt;?php echo wp_kses_post( $item['type'] ); <span class="comment">// @todo auto-link? ?&gt;&lt;/td&gt;</span>&nbsp;</div></li><li><div>      &lt;td class=&quot;description api-index-item-body&quot;&gt;&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;generate_doc_description( $item['description'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>  &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>&lt;/tbody&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&lt;/section&gt;&nbsp;</div></li><li><div>&lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>      if ( 'unset' !== $original_post ) {&nbsp;</div></li><li><div>          $GLOBALS['post'] = $original_post;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function add_http_build_query_to_php_content_example( $matches ) {&nbsp;</div></li><li><div>      $trimmed_match = ltrim( $matches[0] );&nbsp;</div></li><li><div>      $pad = substr( $matches[0], 0, -1 * strlen( $trimmed_match ) );&nbsp;</div></li><li><div>      $pad = ltrim( $pad, ' ' );&nbsp;</div></li><li><div>      $return = '  ' . str_replace( &quot;\n&quot;, &quot;\n  &quot;, $matches[0] );&nbsp;</div></li><li><div>      return &quot; http_build_query({$return}{$pad})&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Recursively generates the &lt;dl&gt;'s to document item descriptions.</span>&nbsp;</div></li><li><div><span class="comment">   * Echoes HTML.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function generate_doc_description( $item ) {&nbsp;</div></li><li><div>      if ( is_array( $item ) ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;dl&gt;&nbsp;</div></li><li><div>&lt;?php            foreach ( $item as $description_key =&gt; $description_value ) : ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;dt&gt;&lt;?php echo wp_kses_post( $description_key . ':' ); ?&gt;&lt;/dt&gt;&nbsp;</div></li><li><div>          &lt;dd&gt;&lt;?php $this-&gt;generate_doc_description( $description_value ); ?&gt;&lt;/dd&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php            endforeach; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;/dl&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>      else :&nbsp;</div></li><li><div>          echo wp_kses_post( $item );&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Auto generates documentation based on description, method, path, path_labels, and query parameters.</span>&nbsp;</div></li><li><div><span class="comment">   * Echoes HTML.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function generate_documentation() {&nbsp;</div></li><li><div>      $format = str_replace( '%d', '%s', $this-&gt;path );&nbsp;</div></li><li><div>      $path_labeled = $format;&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;path_labels ) ) {&nbsp;</div></li><li><div>          $path_labeled = vsprintf( $format, array_keys( $this-&gt;path_labels ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $boolean_arg = array( 'false', 'true' );&nbsp;</div></li><li><div>      $naeloob_arg = array( 'true', 'false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $doc = array(&nbsp;</div></li><li><div>          'description' =&gt; $this-&gt;description, &nbsp;</div></li><li><div>          'method' =&gt; $this-&gt;method, &nbsp;</div></li><li><div>          'path_format' =&gt; $this-&gt;path, &nbsp;</div></li><li><div>          'path_labeled' =&gt; $path_labeled, &nbsp;</div></li><li><div>          'group' =&gt; $this-&gt;group, &nbsp;</div></li><li><div>          'request' =&gt; array(&nbsp;</div></li><li><div>              'path' =&gt; array(), &nbsp;</div></li><li><div>              'query' =&gt; array(), &nbsp;</div></li><li><div>              'body' =&gt; array(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'response' =&gt; array(&nbsp;</div></li><li><div>              'body' =&gt; array(), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( array( 'path_labels' =&gt; 'path', 'query' =&gt; 'query', 'request_format' =&gt; 'body', 'response_format' =&gt; 'body' ) as $_property =&gt; $doc_item ) {&nbsp;</div></li><li><div>          foreach ( (array) $this-&gt;$_property as $key =&gt; $description ) {&nbsp;</div></li><li><div>              if ( is_array( $description ) ) {&nbsp;</div></li><li><div>                  $description_keys = array_keys( $description );&nbsp;</div></li><li><div>                  if ( $boolean_arg === $description_keys || $naeloob_arg === $description_keys ) {&nbsp;</div></li><li><div>                      $type = '(bool)';&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $type = '(string)';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( 'response_format' !== $_property ) {&nbsp;</div></li><li><div>                      <span class="comment">// hack - don't show &quot;(default)&quot; in response format</span>&nbsp;</div></li><li><div>                      reset( $description );&nbsp;</div></li><li><div>                      $description_key = key( $description );&nbsp;</div></li><li><div>                      $description[$description_key] = &quot;(default) {$description[$description_key]}&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $types = $this-&gt;parse_types( $description );&nbsp;</div></li><li><div>                  $type = array();&nbsp;</div></li><li><div>                  $default = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( 'none' == $types ) {&nbsp;</div></li><li><div>                      $types = array();&nbsp;</div></li><li><div>                      $types[]['type'] = 'none';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ( $types as $type_array ) {&nbsp;</div></li><li><div>                      $type[] = $type_array['type'];&nbsp;</div></li><li><div>                      if ( isset( $type_array['default'] ) ) {&nbsp;</div></li><li><div>                          $default = $type_array['default'];&nbsp;</div></li><li><div>                          if ( 'string' === $type_array['type'] ) {&nbsp;</div></li><li><div>                              $default = &quot;'$default'&quot;;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $type = '(' . join( '|', $type ) . ')';&nbsp;</div></li><li><div>                  $noop = ''; <span class="comment">// skip an index in list below</span>&nbsp;</div></li><li><div>                  list( $noop, $description ) = explode( ')', $description, 2 );&nbsp;</div></li><li><div>                  $description = trim( $description );&nbsp;</div></li><li><div>                  if ( $default ) {&nbsp;</div></li><li><div>                      $description .= &quot; Default: $default.&quot;;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $item = compact( 'type', 'description' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 'response_format' === $_property ) {&nbsp;</div></li><li><div>                  $doc['response'][$doc_item][$key] = $item;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $doc['request'][$doc_item][$key] = $item;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $doc;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function user_can_view_post( $post_id ) {&nbsp;</div></li><li><div>      $post = get_post( $post_id );&nbsp;</div></li><li><div>      if ( !$post || is_wp_error( $post ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'inherit' === $post-&gt;post_status ) {&nbsp;</div></li><li><div>          $parent_post = get_post( $post-&gt;post_parent );&nbsp;</div></li><li><div>          $post_status_obj = get_post_status_object( $parent_post-&gt;post_status );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $post_status_obj = get_post_status_object( $post-&gt;post_status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$post_status_obj-&gt;public ) {&nbsp;</div></li><li><div>          if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>              if ( $post_status_obj-&gt;protected ) {&nbsp;</div></li><li><div>                  if ( !current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>                      return new WP_Error( 'unauthorized', 'User cannot view post', 403 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( $post_status_obj-&gt;private ) {&nbsp;</div></li><li><div>                  if ( !current_user_can( 'read_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>                      return new WP_Error( 'unauthorized', 'User cannot view post', 403 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( 'trash' === $post-&gt;post_status ) {&nbsp;</div></li><li><div>                  if ( !current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>                      return new WP_Error( 'unauthorized', 'User cannot view post', 403 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ( 'auto-draft' === $post-&gt;post_status ) {&nbsp;</div></li><li><div>                  <span class="comment">//allow auto-drafts</span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return new WP_Error( 'unauthorized', 'User cannot view post', 403 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return new WP_Error( 'unauthorized', 'User cannot view post', 403 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          -1 == get_option( 'blog_public' ) &&&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter access to a specific post.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param bool current_user_can( 'read_post', $post-&gt;ID ) Can the current user access the post.</span>&nbsp;</div></li><li><div><span class="comment">           * @param WP_Post $post Post data.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          ! apply_filters(&nbsp;</div></li><li><div>              'wpcom_json_api_user_can_view_post', &nbsp;</div></li><li><div>              current_user_can( 'read_post', $post-&gt;ID ), &nbsp;</div></li><li><div>              $post&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          return new WP_Error( 'unauthorized', 'User cannot view post', array( 'status_code' =&gt; 403, 'error' =&gt; 'private_blog' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strlen( $post-&gt;post_password ) && !current_user_can( 'edit_post', $post-&gt;ID ) ) {&nbsp;</div></li><li><div>          return new WP_Error( 'unauthorized', 'User cannot view password protected post', array( 'status_code' =&gt; 403, 'error' =&gt; 'password_protected' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns author object.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $author user ID, user row, WP_User object, comment row, post row</span>&nbsp;</div></li><li><div><span class="comment">   * @param $show_email output the author's email address?</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return (object)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_author( $author, $show_email = false ) {&nbsp;</div></li><li><div>      if ( isset( $author-&gt;comment_author_email ) && !$author-&gt;user_id ) {&nbsp;</div></li><li><div>          $ID = 0;&nbsp;</div></li><li><div>          $login = '';&nbsp;</div></li><li><div>          $email = $author-&gt;comment_author_email;&nbsp;</div></li><li><div>          $name = $author-&gt;comment_author;&nbsp;</div></li><li><div>          $first_name = '';&nbsp;</div></li><li><div>          $last_name = '';&nbsp;</div></li><li><div>          $URL = $author-&gt;comment_author_url;&nbsp;</div></li><li><div>          $profile_URL = 'http:<span class="comment"><span class="comment">//en.gravatar.com/' . md5( strtolower( trim( $email ) ) );</span></span>&nbsp;</div></li><li><div>          $nice = '';&nbsp;</div></li><li><div>          $site_id = -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Comment author URLs and Emails are sent through wp_kses() on save, which replaces &quot;&&quot; with &quot;&amp;&quot;</span>&nbsp;</div></li><li><div>          <span class="comment">// &quot;&&quot; is the only email/URL character altered by wp_kses()</span>&nbsp;</div></li><li><div>          foreach ( array( 'email', 'URL' ) as $field ) {&nbsp;</div></li><li><div>              $$field = str_replace( '&amp;', '&', $$field );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( isset( $author-&gt;post_author ) ) {&nbsp;</div></li><li><div>              <span class="comment">// then $author is a Post Object.</span>&nbsp;</div></li><li><div>              if ( 0 == $author-&gt;post_author )&nbsp;</div></li><li><div>                  return null;&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Filter whether the current site is a Jetpack site.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @since 3.3.0</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * @param bool false Is the current site a Jetpack site. Default to false.</span>&nbsp;</div></li><li><div><span class="comment">               * @param int get_current_blog_id() Blog ID.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              $is_jetpack = true === apply_filters( 'is_jetpack_site', false, get_current_blog_id() );&nbsp;</div></li><li><div>              $post_id = $author-&gt;ID;&nbsp;</div></li><li><div>              if ( $is_jetpack && ( defined( 'IS_WPCOM' ) && IS_WPCOM ) ) {&nbsp;</div></li><li><div>                  $ID = get_post_meta( $post_id, '_jetpack_post_author_external_id', true );&nbsp;</div></li><li><div>                  $email = get_post_meta( $post_id, '_jetpack_author_email', true );&nbsp;</div></li><li><div>                  $login = '';&nbsp;</div></li><li><div>                  $name = get_post_meta( $post_id, '_jetpack_author', true );&nbsp;</div></li><li><div>                  $first_name = '';&nbsp;</div></li><li><div>                  $last_name = '';&nbsp;</div></li><li><div>                  $URL = '';&nbsp;</div></li><li><div>                  $nice = '';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $author = $author-&gt;post_author;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif ( isset( $author-&gt;user_id ) && $author-&gt;user_id ) {&nbsp;</div></li><li><div>              $author = $author-&gt;user_id;&nbsp;</div></li><li><div>          } elseif ( isset( $author-&gt;user_email ) ) {&nbsp;</div></li><li><div>              $author = $author-&gt;ID;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! isset( $ID ) ) {&nbsp;</div></li><li><div>              $user = get_user_by( 'id', $author );&nbsp;</div></li><li><div>              if ( ! $user || is_wp_error( $user ) ) {&nbsp;</div></li><li><div>                  trigger_error( 'Unknown user', E_USER_WARNING );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $ID = $user-&gt;ID;&nbsp;</div></li><li><div>              $email = $user-&gt;user_email;&nbsp;</div></li><li><div>              $login = $user-&gt;user_login;&nbsp;</div></li><li><div>              $name = $user-&gt;display_name;&nbsp;</div></li><li><div>              $first_name = $user-&gt;first_name;&nbsp;</div></li><li><div>              $last_name = $user-&gt;last_name;&nbsp;</div></li><li><div>              $URL = $user-&gt;user_url;&nbsp;</div></li><li><div>              $nice = $user-&gt;user_nicename;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( defined( 'IS_WPCOM' ) && IS_WPCOM && ! $is_jetpack ) {&nbsp;</div></li><li><div>              $active_blog = get_active_blog_for_user( $ID );&nbsp;</div></li><li><div>              $site_id = $active_blog-&gt;blog_id;&nbsp;</div></li><li><div>              $profile_URL = &quot;http:<span class="comment">//en.gravatar.com/{$login}&quot;;</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $profile_URL = 'http:<span class="comment"><span class="comment">//en.gravatar.com/' . md5( strtolower( trim( $email ) ) );</span></span>&nbsp;</div></li><li><div>              $site_id = -1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $avatar_URL = $this-&gt;api-&gt;get_avatar_url( $email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $email = $show_email ? (string) $email : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $author = array(&nbsp;</div></li><li><div>          'ID' =&gt; (int) $ID, &nbsp;</div></li><li><div>          'login' =&gt; (string) $login, &nbsp;</div></li><li><div>          'email' =&gt; $email, <span class="comment">// (string|bool)</span>&nbsp;</div></li><li><div>          'name' =&gt; (string) $name, &nbsp;</div></li><li><div>          'first_name' =&gt; (string) $first_name, &nbsp;</div></li><li><div>          'last_name' =&gt; (string) $last_name, &nbsp;</div></li><li><div>          'nice_name' =&gt; (string) $nice, &nbsp;</div></li><li><div>          'URL' =&gt; (string) esc_url_raw( $URL ), &nbsp;</div></li><li><div>          'avatar_URL' =&gt; (string) esc_url_raw( $avatar_URL ), &nbsp;</div></li><li><div>          'profile_URL' =&gt; (string) esc_url_raw( $profile_URL ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($site_id &gt; -1) {&nbsp;</div></li><li><div>          $author['site_ID'] = (int) $site_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (object) $author;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_media_item( $media_id ) {&nbsp;</div></li><li><div>      $media_item = get_post( $media_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$media_item || is_wp_error( $media_item ) )&nbsp;</div></li><li><div>          return new WP_Error( 'unknown_media', 'Unknown Media', 404 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = array(&nbsp;</div></li><li><div>          'id' =&gt; strval( $media_item-&gt;ID ), &nbsp;</div></li><li><div>          'date' =&gt;  (string) $this-&gt;format_date( $media_item-&gt;post_date_gmt, $media_item-&gt;post_date ), &nbsp;</div></li><li><div>          'parent' =&gt; $media_item-&gt;post_parent, &nbsp;</div></li><li><div>          'link' =&gt; wp_get_attachment_url( $media_item-&gt;ID ), &nbsp;</div></li><li><div>          'title' =&gt; $media_item-&gt;post_title, &nbsp;</div></li><li><div>          'caption' =&gt; $media_item-&gt;post_excerpt, &nbsp;</div></li><li><div>          'description' =&gt; $media_item-&gt;post_content, &nbsp;</div></li><li><div>          'metadata' =&gt; wp_get_attachment_metadata( $media_item-&gt;ID ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'IS_WPCOM' ) && IS_WPCOM && is_array( $response['metadata'] ) && ! empty( $response['metadata']['file'] ) ) {&nbsp;</div></li><li><div>          remove_filter( '_wp_relative_upload_path', 'wpcom_wp_relative_upload_path', 10 );&nbsp;</div></li><li><div>          $response['metadata']['file'] = _wp_relative_upload_path( $response['metadata']['file'] );&nbsp;</div></li><li><div>          add_filter( '_wp_relative_upload_path', 'wpcom_wp_relative_upload_path', 10, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response['meta'] = (object) array(&nbsp;</div></li><li><div>          'links' =&gt; (object) array(&nbsp;</div></li><li><div>              'self' =&gt; (string) $this-&gt;get_media_link( $this-&gt;api-&gt;get_blog_id_for_output(), $media_id ), &nbsp;</div></li><li><div>              'help' =&gt; (string) $this-&gt;get_media_link( $this-&gt;api-&gt;get_blog_id_for_output(), $media_id, 'help' ), &nbsp;</div></li><li><div>              'site' =&gt; (string) $this-&gt;get_site_link( $this-&gt;api-&gt;get_blog_id_for_output() ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (object) $response;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_media_item_v1_1( $media_id ) {&nbsp;</div></li><li><div>      $media_item = get_post( $media_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $media_item || is_wp_error( $media_item ) )&nbsp;</div></li><li><div>          return new WP_Error( 'unknown_media', 'Unknown Media', 404 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $file = basename( wp_get_attachment_url( $media_item-&gt;ID ) );&nbsp;</div></li><li><div>      $file_info = pathinfo( $file );&nbsp;</div></li><li><div>      $ext = $file_info['extension'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = array(&nbsp;</div></li><li><div>          'ID' =&gt; $media_item-&gt;ID, &nbsp;</div></li><li><div>          'URL' =&gt; wp_get_attachment_url( $media_item-&gt;ID ), &nbsp;</div></li><li><div>          'guid' =&gt; $media_item-&gt;guid, &nbsp;</div></li><li><div>          'date' =&gt; (string) $this-&gt;format_date( $media_item-&gt;post_date_gmt, $media_item-&gt;post_date ), &nbsp;</div></li><li><div>          'post_ID' =&gt; $media_item-&gt;post_parent, &nbsp;</div></li><li><div>          'file' =&gt; $file, &nbsp;</div></li><li><div>          'mime_type' =&gt; $media_item-&gt;post_mime_type, &nbsp;</div></li><li><div>          'extension' =&gt; $ext, &nbsp;</div></li><li><div>          'title' =&gt; $media_item-&gt;post_title, &nbsp;</div></li><li><div>          'caption' =&gt; $media_item-&gt;post_excerpt, &nbsp;</div></li><li><div>          'description' =&gt; $media_item-&gt;post_content, &nbsp;</div></li><li><div>          'alt' =&gt; get_post_meta( $media_item-&gt;ID, '_wp_attachment_image_alt', true ), &nbsp;</div></li><li><div>          'thumbnails' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $ext, array( 'jpg', 'jpeg', 'png', 'gif' ) ) ) {&nbsp;</div></li><li><div>          $metadata = wp_get_attachment_metadata( $media_item-&gt;ID );&nbsp;</div></li><li><div>          if ( isset( $metadata['height'], $metadata['width'] ) ) {&nbsp;</div></li><li><div>              $response['height'] = $metadata['height'];&nbsp;</div></li><li><div>              $response['width'] = $metadata['width'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( is_array( $metadata['sizes'] ) ) {&nbsp;</div></li><li><div>                    foreach ( $metadata['sizes'] as $size =&gt; $size_details ) {&nbsp;</div></li><li><div>                              $response['thumbnails'][ $size ] = dirname( $response['URL'] ) . '/' . $size_details['file'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $response['exif'] = $metadata['image_meta'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $ext, array( 'mp3', 'm4a', 'wav', 'ogg' ) ) ) {&nbsp;</div></li><li><div>          $metadata = wp_get_attachment_metadata( $media_item-&gt;ID );&nbsp;</div></li><li><div>          $response['length'] = $metadata['length'];&nbsp;</div></li><li><div>          $response['exif'] = $metadata;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $ext, array( 'ogv', 'mp4', 'mov', 'wmv', 'avi', 'mpg', '3gp', '3g2', 'm4v' ) ) ) {&nbsp;</div></li><li><div>          $metadata = wp_get_attachment_metadata( $media_item-&gt;ID );&nbsp;</div></li><li><div>          if ( isset( $metadata['height'], $metadata['width'] ) ) {&nbsp;</div></li><li><div>              $response['height'] = $metadata['height'];&nbsp;</div></li><li><div>              $response['width'] = $metadata['width'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $metadata['length'] ) ) {&nbsp;</div></li><li><div>              $response['length'] = $metadata['length'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add VideoPress info</span>&nbsp;</div></li><li><div>          if ( function_exists( 'video_get_info_by_blogpostid' ) ) {&nbsp;</div></li><li><div>              $info = video_get_info_by_blogpostid( $this-&gt;api-&gt;get_blog_id_for_output(), $media_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Thumbnails</span>&nbsp;</div></li><li><div>              if ( function_exists( 'video_format_done' ) && function_exists( 'video_image_url_by_guid' ) ) {&nbsp;</div></li><li><div>                  $response['thumbnails'] = array( 'fmt_hd' =&gt; '', 'fmt_dvd' =&gt; '', 'fmt_std' =&gt; '' );&nbsp;</div></li><li><div>                  foreach ( $response['thumbnails'] as $size =&gt; $thumbnail_url ) {&nbsp;</div></li><li><div>                      if ( video_format_done( $info, $size ) ) {&nbsp;</div></li><li><div>                          $response['thumbnails'][ $size ] = video_image_url_by_guid( $info-&gt;guid, $size );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          unset( $response['thumbnails'][ $size ] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $response['videopress_guid'] = $info-&gt;guid;&nbsp;</div></li><li><div>              $response['videopress_processing_done'] = true;&nbsp;</div></li><li><div>              if ( '0000-00-00 00:00:00' == $info-&gt;finish_date_gmt ) {&nbsp;</div></li><li><div>                  $response['videopress_processing_done'] = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response['thumbnails'] = (object) $response['thumbnails'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response['meta'] = (object) array(&nbsp;</div></li><li><div>          'links' =&gt; (object) array(&nbsp;</div></li><li><div>              'self' =&gt; (string) $this-&gt;get_media_link( $this-&gt;api-&gt;get_blog_id_for_output(), $media_id ), &nbsp;</div></li><li><div>              'help' =&gt; (string) $this-&gt;get_media_link( $this-&gt;api-&gt;get_blog_id_for_output(), $media_id, 'help' ), &nbsp;</div></li><li><div>              'site' =&gt; (string) $this-&gt;get_site_link( $this-&gt;api-&gt;get_blog_id_for_output() ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add VideoPress link to the meta</span>&nbsp;</div></li><li><div>      if ( in_array( $ext, array( 'ogv', 'mp4', 'mov', 'wmv', 'avi', 'mpg', '3gp', '3g2', 'm4v' ) ) ) {&nbsp;</div></li><li><div>          if ( function_exists( 'video_get_info_by_blogpostid' ) ) {&nbsp;</div></li><li><div>              $response['meta']-&gt;links-&gt;videopress = (string) $this-&gt;get_link( '/videos/%s', $response['videopress_guid'], '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $media_item-&gt;post_parent &gt; 0 ) {&nbsp;</div></li><li><div>          $response['meta']-&gt;links-&gt;parent = (string) $this-&gt;get_post_link( $this-&gt;api-&gt;get_blog_id_for_output(), $media_item-&gt;post_parent );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (object) $response;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_taxonomy( $taxonomy_id, $taxonomy_type, $context ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $taxonomy = get_term_by( 'slug', $taxonomy_id, $taxonomy_type );&nbsp;</div></li><li><div>      <span class="comment">/// keep updating this function</span>&nbsp;</div></li><li><div>      if ( !$taxonomy || is_wp_error( $taxonomy ) ) {&nbsp;</div></li><li><div>          return new WP_Error( 'unknown_taxonomy', 'Unknown taxonomy', 404 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;format_taxonomy( $taxonomy, $taxonomy_type, $context );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function format_taxonomy( $taxonomy, $taxonomy_type, $context ) {&nbsp;</div></li><li><div>      <span class="comment">// Permissions</span>&nbsp;</div></li><li><div>      switch ( $context ) {&nbsp;</div></li><li><div>      case 'edit' :&nbsp;</div></li><li><div>          $tax = get_taxonomy( $taxonomy_type );&nbsp;</div></li><li><div>          if ( !current_user_can( $tax-&gt;cap-&gt;edit_terms ) )&nbsp;</div></li><li><div>              return new WP_Error( 'unauthorized', 'User cannot edit taxonomy', 403 );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'display' :&nbsp;</div></li><li><div>          if ( -1 == get_option( 'blog_public' ) && ! current_user_can( 'read' ) ) {&nbsp;</div></li><li><div>              return new WP_Error( 'unauthorized', 'User cannot view taxonomy', 403 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          return new WP_Error( 'invalid_context', 'Invalid API CONTEXT', 400 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = array();&nbsp;</div></li><li><div>      $response['ID'] = (int) $taxonomy-&gt;term_id;&nbsp;</div></li><li><div>      $response['name'] = (string) $taxonomy-&gt;name;&nbsp;</div></li><li><div>      $response['slug'] = (string) $taxonomy-&gt;slug;&nbsp;</div></li><li><div>      $response['description'] = (string) $taxonomy-&gt;description;&nbsp;</div></li><li><div>      $response['post_count'] = (int) $taxonomy-&gt;count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'category' === $taxonomy_type )&nbsp;</div></li><li><div>          $response['parent'] = (int) $taxonomy-&gt;parent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response['meta'] = (object) array(&nbsp;</div></li><li><div>          'links' =&gt; (object) array(&nbsp;</div></li><li><div>              'self' =&gt; (string) $this-&gt;get_taxonomy_link( $this-&gt;api-&gt;get_blog_id_for_output(), $taxonomy-&gt;slug, $taxonomy_type ), &nbsp;</div></li><li><div>              'help' =&gt; (string) $this-&gt;get_taxonomy_link( $this-&gt;api-&gt;get_blog_id_for_output(), $taxonomy-&gt;slug, $taxonomy_type, 'help' ), &nbsp;</div></li><li><div>              'site' =&gt; (string) $this-&gt;get_site_link( $this-&gt;api-&gt;get_blog_id_for_output() ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (object) $response;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns ISO 8601 formatted datetime: 2011-12-08T01:15:36-08:00</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $date_gmt (string) GMT datetime string.</span>&nbsp;</div></li><li><div><span class="comment">   * @param $date (string) Optional.  Used to calculate the offset from GMT.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function format_date( $date_gmt, $date = null ) {&nbsp;</div></li><li><div>      $timestamp_gmt = strtotime( &quot;$date_gmt+0000&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( null === $date ) {&nbsp;</div></li><li><div>          $timestamp = $timestamp_gmt;&nbsp;</div></li><li><div>          $hours = $minutes = $west = 0;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $date_time = date_create( &quot;$date+0000&quot; );&nbsp;</div></li><li><div>          if ( $date_time ) {&nbsp;</div></li><li><div>              $timestamp = date_format(  $date_time, 'U' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $timestamp = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// &quot;0000-00-00 00:00:00&quot; == -62169984000</span>&nbsp;</div></li><li><div>          if ( -62169984000 == $timestamp_gmt ) {&nbsp;</div></li><li><div>              <span class="comment">// WordPress sets post_date=now, post_date_gmt=&quot;0000-00-00 00:00:00&quot; for all drafts</span>&nbsp;</div></li><li><div>              <span class="comment">// WordPress sets post_modified=now, post_modified_gmt=&quot;0000-00-00 00:00:00&quot; for new drafts</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Try to guess the correct offset from the blog's options.</span>&nbsp;</div></li><li><div>              $timezone_string = get_option( 'timezone_string' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $timezone_string && $date_time ) {&nbsp;</div></li><li><div>                  $timezone = timezone_open( $timezone_string );&nbsp;</div></li><li><div>                  if ( $timezone ) {&nbsp;</div></li><li><div>                      $offset = $timezone-&gt;getOffset( $date_time );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $offset = 3600 * get_option( 'gmt_offset' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $offset = $timestamp - $timestamp_gmt;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $west = $offset &lt; 0;&nbsp;</div></li><li><div>          $offset = abs( $offset );&nbsp;</div></li><li><div>          $hours = (int) floor( $offset / 3600 );&nbsp;</div></li><li><div>          $offset   -= $hours * 3600;&nbsp;</div></li><li><div>          $minutes = (int) floor( $offset / 60 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (string) gmdate( 'Y-m-d\\TH:i:s', $timestamp ) . sprintf( '%s%02d:%02d', $west ? '-' : '+', $hours, $minutes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parses a date string and returns the local and GMT representations</span>&nbsp;</div></li><li><div><span class="comment">   * of that date & time in 'YYYY-MM-DD HH:MM:SS' format without</span>&nbsp;</div></li><li><div><span class="comment">   * timezones or offsets. If the parsed datetime was not localized to a</span>&nbsp;</div></li><li><div><span class="comment">   * particular timezone or offset we will assume it was given in GMT</span>&nbsp;</div></li><li><div><span class="comment">   * relative to now and will convert it to local time using either the</span>&nbsp;</div></li><li><div><span class="comment">   * timezone set in the options table for the blog or the GMT offset.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param datetime string</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array( $local_time_string, $gmt_time_string )</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function parse_date( $date_string ) {&nbsp;</div></li><li><div>      $date_string_info = date_parse( $date_string );&nbsp;</div></li><li><div>      if ( is_array( $date_string_info ) && 0 === $date_string_info['error_count'] ) {&nbsp;</div></li><li><div>          <span class="comment">// Check if it's already localized. Can't just check is_localtime because date_parse('oppossum') returns true; WTF, PHP.</span>&nbsp;</div></li><li><div>          if ( isset( $date_string_info['zone'] ) && true === $date_string_info['is_localtime'] ) {&nbsp;</div></li><li><div>              $dt_local = clone $dt_utc = new DateTime( $date_string );&nbsp;</div></li><li><div>              $dt_utc-&gt;setTimezone( new DateTimeZone( 'UTC' ) );&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  (string) $dt_local-&gt;format( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div>                  (string) $dt_utc-&gt;format( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// It's parseable but no TZ info so assume UTC</span>&nbsp;</div></li><li><div>          $dt_local = clone $dt_utc = new DateTime( $date_string, new DateTimeZone( 'UTC' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Could not parse time, use now in UTC</span>&nbsp;</div></li><li><div>          $dt_local = clone $dt_utc = new DateTime( 'now', new DateTimeZone( 'UTC' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// First try to use timezone as it's daylight savings aware.</span>&nbsp;</div></li><li><div>      $timezone_string = get_option( 'timezone_string' );&nbsp;</div></li><li><div>      if ( $timezone_string ) {&nbsp;</div></li><li><div>          $tz = timezone_open( $timezone_string );&nbsp;</div></li><li><div>          if ( $tz ) {&nbsp;</div></li><li><div>              $dt_local-&gt;setTimezone( $tz );&nbsp;</div></li><li><div>              return array(&nbsp;</div></li><li><div>                  (string) $dt_local-&gt;format( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div>                  (string) $dt_utc-&gt;format( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fallback to GMT offset (in hours)</span>&nbsp;</div></li><li><div>      <span class="comment">// NOTE: TZ of $dt_local is still UTC, we simply modified the timestamp with an offset.</span>&nbsp;</div></li><li><div>      $gmt_offset_seconds = intval( get_option( 'gmt_offset' ) * 3600 );&nbsp;</div></li><li><div>      $dt_local-&gt;modify(&quot;+{$gmt_offset_seconds} seconds&quot;);&nbsp;</div></li><li><div>      return array(&nbsp;</div></li><li><div>          (string) $dt_local-&gt;format( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div>          (string) $dt_utc-&gt;format( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load the functions.php file for the current theme to get its post formats, CPTs, etc.</span>&nbsp;</div></li><li><div>  function load_theme_functions() {&nbsp;</div></li><li><div>      <span class="comment">// bail if we've done this already (can happen when calling /batch endpoint)</span>&nbsp;</div></li><li><div>      if ( defined( 'REST_API_THEME_FUNCTIONS_LOADED' ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      define( 'REST_API_THEME_FUNCTIONS_LOADED', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// the theme info we care about is found either within functions.php or one of the jetpack files.</span>&nbsp;</div></li><li><div>      $function_files = array( '/functions.php', '/inc/jetpack.compat.php', '/inc/jetpack.php', '/includes/jetpack.compat.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $copy_dirs = array( get_template_directory() );&nbsp;</div></li><li><div>      if ( wpcom_is_vip() ) {&nbsp;</div></li><li><div>          $copy_dirs[] = WP_CONTENT_DIR . '/themes/vip/plugins/';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Is this a child theme? Load the child theme's functions file.</span>&nbsp;</div></li><li><div>      if ( get_stylesheet_directory() !== get_template_directory() && wpcom_is_child_theme() ) {&nbsp;</div></li><li><div>          foreach ( $function_files as $function_file ) {&nbsp;</div></li><li><div>              if ( file_exists( get_stylesheet_directory() . $function_file ) ) {&nbsp;</div></li><li><div>                  require_once(  get_stylesheet_directory() . $function_file );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $copy_dirs[] = get_stylesheet_directory();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $function_files as $function_file ) {&nbsp;</div></li><li><div>          if ( file_exists( get_template_directory() . $function_file ) ) {&nbsp;</div></li><li><div>              require_once(  get_template_directory() . $function_file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add inc/wpcom.php and/or includes/wpcom.php</span>&nbsp;</div></li><li><div>      wpcom_load_theme_compat_file();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// since the stuff we care about (CPTS, post formats, are usually on setup or init hooks, we want to load those)</span>&nbsp;</div></li><li><div>      $this-&gt;copy_hooks( 'after_setup_theme', 'restapi_theme_after_setup_theme', $copy_dirs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires functions hooked onto `after_setup_theme` by the theme for the purpose of the REST API.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * The REST API does not load the theme when processing requests.</span>&nbsp;</div></li><li><div><span class="comment">       * To enable theme-based functionality, the API will load the '/functions.php', </span>&nbsp;</div></li><li><div><span class="comment">       * '/inc/jetpack.compat.php', '/inc/jetpack.php', '/includes/jetpack.compat.php files</span>&nbsp;</div></li><li><div><span class="comment">       * of the theme (parent and child) and copy functions hooked onto 'after_setup_theme' within those files.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'restapi_theme_after_setup_theme' );&nbsp;</div></li><li><div>      $this-&gt;copy_hooks( 'init', 'restapi_theme_init', $copy_dirs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires functions hooked onto `init` by the theme for the purpose of the REST API.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * The REST API does not load the theme when processing requests.</span>&nbsp;</div></li><li><div><span class="comment">       * To enable theme-based functionality, the API will load the '/functions.php', </span>&nbsp;</div></li><li><div><span class="comment">       * '/inc/jetpack.compat.php', '/inc/jetpack.php', '/includes/jetpack.compat.php files</span>&nbsp;</div></li><li><div><span class="comment">       * of the theme (parent and child) and copy functions hooked onto 'init' within those files.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'restapi_theme_init' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function copy_hooks( $from_hook, $to_hook, $base_paths ) {&nbsp;</div></li><li><div>      global $wp_filter;&nbsp;</div></li><li><div>      foreach ( $wp_filter as $hook =&gt; $actions ) {&nbsp;</div></li><li><div>          if ( $from_hook &lt;&gt; $hook )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          foreach ( (array) $actions as $priority =&gt; $callbacks ) {&nbsp;</div></li><li><div>              foreach( $callbacks as $callback_key =&gt; $callback_data ) {&nbsp;</div></li><li><div>                  $callback = $callback_data['function'];&nbsp;</div></li><li><div>                  $reflection = $this-&gt;get_reflection( $callback ); <span class="comment">// use reflection api to determine filename where function is defined</span>&nbsp;</div></li><li><div>                  if ( false !== $reflection ) {&nbsp;</div></li><li><div>                      $file_name = $reflection-&gt;getFileName();&nbsp;</div></li><li><div>                      foreach( $base_paths as $base_path ) {&nbsp;</div></li><li><div>                          if ( 0 === strpos( $file_name, $base_path ) ) { <span class="comment">// only copy hooks with functions which are part of the specified files</span>&nbsp;</div></li><li><div>                              $wp_filter[ $to_hook ][ $priority ][ 'cph' . $callback_key ] = $callback_data;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_reflection( $callback ) {&nbsp;</div></li><li><div>      if ( is_array( $callback ) ) {&nbsp;</div></li><li><div>          list( $class, $method ) = $callback;&nbsp;</div></li><li><div>          return new ReflectionMethod( $class, $method );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_string( $callback ) && strpos( $callback, &quot;::&quot; ) !== false ) {&nbsp;</div></li><li><div>          list( $class, $method ) = explode( &quot;::&quot;, $callback );&nbsp;</div></li><li><div>          return new ReflectionMethod( $class, $method );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( version_compare( PHP_VERSION, &quot;5.3.0&quot;, &quot;&gt;=&quot; ) && method_exists( $callback, &quot;__invoke&quot; ) ) {&nbsp;</div></li><li><div>          return new ReflectionMethod( $callback, &quot;__invoke&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_string( $callback ) && strpos( $callback, &quot;::&quot; ) == false && function_exists( $callback ) ) {&nbsp;</div></li><li><div>          return new ReflectionFunction( $callback );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Try to find the closest supported version of an endpoint to the current endpoint</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * For example, if we were looking at the path /animals/panda:</span>&nbsp;</div></li><li><div><span class="comment">   * - if the current endpoint is v1.3 and there is a v1.3 of /animals/%s available, we return 1.3</span>&nbsp;</div></li><li><div><span class="comment">   * - if the current endpoint is v1.3 and there is no v1.3 of /animals/%s known, we fall back to the</span>&nbsp;</div></li><li><div><span class="comment">   *   maximum available version of /animals/%s, e.g. 1.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This method is used in get_link() to construct meta links for API responses.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param $path string The current endpoint path, relative to the version</span>&nbsp;</div></li><li><div><span class="comment">   * @param $method string Request method used to access the endpoint path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string The current version, or otherwise the maximum version available</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_closest_version_of_endpoint( $path, $request_method = 'GET' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $path = untrailingslashit( $path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// /help is a special case - always use the current request version</span>&nbsp;</div></li><li><div>      if ( wp_endswith( $path, '/help' ) ) {&nbsp;</div></li><li><div>          return $this-&gt;api-&gt;version;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $endpoint_path_versions = $this-&gt;get_endpoint_path_versions();&nbsp;</div></li><li><div>      $last_path_segment = $this-&gt;get_last_segment_of_relative_path( $path );&nbsp;</div></li><li><div>      $max_version_found = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $endpoint_path_versions as $endpoint_last_path_segment =&gt; $endpoints ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Does the last part of the path match the path key? (e.g. 'posts')</span>&nbsp;</div></li><li><div>          <span class="comment">// If the last part contains a placeholder (e.g. %s), we want to carry on</span>&nbsp;</div></li><li><div>          if ( $last_path_segment != $endpoint_last_path_segment && ! strstr( $endpoint_last_path_segment, '%' ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $endpoints as $endpoint ) {&nbsp;</div></li><li><div>              <span class="comment">// Does the request method match?</span>&nbsp;</div></li><li><div>              if ( ! in_array( $request_method, $endpoint['request_methods'] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $endpoint_path = untrailingslashit( $endpoint['path'] );&nbsp;</div></li><li><div>              $endpoint_path_regex = str_replace( array( '%s', '%d' ), array( '([^/?&]+)', '(\d+)' ), $endpoint_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! preg_match( &quot;#^$endpoint_path_regex\$#&quot;, $path, $matches ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Make sure the endpoint exists at the same version</span>&nbsp;</div></li><li><div>              if ( version_compare( $this-&gt;api-&gt;version, $endpoint['min_version'], '&gt;=') &&&nbsp;</div></li><li><div>                   version_compare( $this-&gt;api-&gt;version, $endpoint['max_version'], '&lt;=') ) {&nbsp;</div></li><li><div>                  return $this-&gt;api-&gt;version;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If the endpoint doesn't exist at the same version, record the max version we found</span>&nbsp;</div></li><li><div>              if ( empty( $max_version_found ) || version_compare( $max_version_found, $endpoint['max_version'], '&lt;' ) ) {&nbsp;</div></li><li><div>                  $max_version_found = $endpoint['max_version'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the endpoint version is less than the requested endpoint version, return the max version found</span>&nbsp;</div></li><li><div>      if ( ! empty( $max_version_found ) ) {&nbsp;</div></li><li><div>          return $max_version_found;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Otherwise, use the API version of the current request</span>&nbsp;</div></li><li><div>      return $this-&gt;api-&gt;version;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get an array of endpoint paths with their associated versions</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The result is cached for 30 minutes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Array of endpoint paths, min_versions and max_versions, keyed by last segment of path</span>&nbsp;</div></li><li><div><span class="comment">   **/</span>&nbsp;</div></li><li><div>  protected function get_endpoint_path_versions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Do we already have the result of this method in the cache?</span>&nbsp;</div></li><li><div>      $cache_result = get_transient( 'endpoint_path_versions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty ( $cache_result ) ) {&nbsp;</div></li><li><div>          return $cache_result;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create a map of endpoints and their min/max versions keyed by the last segment of the path (e.g. 'posts')</span>&nbsp;</div></li><li><div><span class="comment">       * This reduces the search space when finding endpoint matches in get_closest_version_of_endpoint()</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $endpoint_path_versions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;api-&gt;endpoints as $key =&gt; $endpoint_objects ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// The key contains a serialized path, min_version and max_version</span>&nbsp;</div></li><li><div>          list( $path, $min_version, $max_version ) = unserialize( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Grab the last component of the relative path to use as the top-level key</span>&nbsp;</div></li><li><div>          $last_path_segment = $this-&gt;get_last_segment_of_relative_path( $path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $endpoint_path_versions[ $last_path_segment ][] = array(&nbsp;</div></li><li><div>              'path' =&gt; $path, &nbsp;</div></li><li><div>              'min_version' =&gt; $min_version, &nbsp;</div></li><li><div>              'max_version' =&gt; $max_version, &nbsp;</div></li><li><div>              'request_methods' =&gt; array_keys( $endpoint_objects )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_transient(&nbsp;</div></li><li><div>          'endpoint_path_versions', &nbsp;</div></li><li><div>          $endpoint_path_versions, &nbsp;</div></li><li><div>          (HOUR_IN_SECONDS / 2)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $endpoint_path_versions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Grab the last segment of a relative path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path Path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Last path segment</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function get_last_segment_of_relative_path( $path) {&nbsp;</div></li><li><div>      $path_parts = array_filter( explode( '/', $path ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $path_parts ) ) {&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return end( $path_parts );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate a URL to an endpoint</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Used to construct meta links in API responses</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $args Optional arguments to be appended to URL</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Endpoint URL</span>&nbsp;</div></li><li><div><span class="comment">   **/</span>&nbsp;</div></li><li><div>  function get_link() {&nbsp;</div></li><li><div>      $args = func_get_args();&nbsp;</div></li><li><div>      $format = array_shift( $args );&nbsp;</div></li><li><div>      $base = WPCOM_JSON_API__BASE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $path = array_pop( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $path ) {&nbsp;</div></li><li><div>          $path = '/' . ltrim( $path, '/' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args[] = $path;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Escape any % in args before using sprintf</span>&nbsp;</div></li><li><div>      $escaped_args = array();&nbsp;</div></li><li><div>      foreach ( $args as $arg_key =&gt; $arg_value ) {&nbsp;</div></li><li><div>          $escaped_args[ $arg_key ] = str_replace( '%', '%%', $arg_value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $relative_path = vsprintf( &quot;$format%s&quot;, $escaped_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! wp_startswith( $relative_path, '.' ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Generic version. Match the requested version as best we can</span>&nbsp;</div></li><li><div>          $api_version = $this-&gt;get_closest_version_of_endpoint( $relative_path );&nbsp;</div></li><li><div>          $base = substr( $base, 0, - 1 ) . $api_version;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// escape any % in the relative path before running it through sprintf again</span>&nbsp;</div></li><li><div>      $relative_path = str_replace( '%', '%%', $relative_path );&nbsp;</div></li><li><div>      <span class="comment">// http, WPCOM_JSON_API__BASE, ... , path</span>&nbsp;</div></li><li><div>      <span class="comment">// %s , %s , $format, %s</span>&nbsp;</div></li><li><div>      return esc_url_raw( sprintf( &quot;%s:<span class="comment">//%s$relative_path&quot;, $this-&gt;api-&gt;public_api_scheme, $base ) );</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_me_link( $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '/me', $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_taxonomy_link( $blog_id, $taxonomy_id, $taxonomy_type, $path = '' ) {&nbsp;</div></li><li><div>      if ( 'category' === $taxonomy_type )&nbsp;</div></li><li><div>          return $this-&gt;get_link( '/sites/%d/categories/slug:%s', $blog_id, $taxonomy_id, $path );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          return $this-&gt;get_link( '/sites/%d/tags/slug:%s', $blog_id, $taxonomy_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_media_link( $blog_id, $media_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '/sites/%d/media/%d', $blog_id, $media_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_site_link( $blog_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '/sites/%d', $blog_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_post_link( $blog_id, $post_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '/sites/%d/posts/%d', $blog_id, $post_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_comment_link( $blog_id, $comment_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '/sites/%d/comments/%d', $blog_id, $comment_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_publicize_connection_link( $blog_id, $publicize_connection_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '.1/sites/%d/publicize-connections/%d', $blog_id, $publicize_connection_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_publicize_connections_link( $keyring_token_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '.1/me/publicize-connections/?keyring_connection_ID=%d', $keyring_token_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_keyring_connection_link( $keyring_token_id, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '.1/me/keyring-connections/%d', $keyring_token_id, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_external_service_link( $external_service, $path = '' ) {&nbsp;</div></li><li><div>      return $this-&gt;get_link( '.1/meta/external-services/%s', $external_service, $path );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  * Check whether a user can view or edit a post type</span>&nbsp;</div></li><li><div><span class="comment">  * @param string $post_type              post type to check</span>&nbsp;</div></li><li><div><span class="comment">  * @param string $context                'display' or 'edit'</span>&nbsp;</div></li><li><div><span class="comment">  * @return bool</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function current_user_can_access_post_type( $post_type, $context='display' ) {&nbsp;</div></li><li><div>      $post_type_object = get_post_type_object( $post_type );&nbsp;</div></li><li><div>      if ( ! $post_type_object ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch( $context ) {&nbsp;</div></li><li><div>          case 'edit':&nbsp;</div></li><li><div>              return current_user_can( $post_type_object-&gt;cap-&gt;edit_posts );&nbsp;</div></li><li><div>          case 'display':&nbsp;</div></li><li><div>              return $post_type_object-&gt;public || current_user_can( $post_type_object-&gt;cap-&gt;read_private_posts );&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_post_type_allowed( $post_type ) {&nbsp;</div></li><li><div>      <span class="comment">// if the post type is empty, that's fine, WordPress will default to post</span>&nbsp;</div></li><li><div>      if ( empty( $post_type ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// allow special 'any' type</span>&nbsp;</div></li><li><div>      if ( 'any' == $post_type )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check for allowed types</span>&nbsp;</div></li><li><div>      if ( in_array( $post_type, $this-&gt;_get_whitelisted_post_types() ) )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the whitelisted post types that JP should allow access to.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Whitelisted post types.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function _get_whitelisted_post_types() {&nbsp;</div></li><li><div>      $allowed_types = array( 'post', 'page', 'revision' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the post types Jetpack has access to, and can synchronize with WordPress.com.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 2.2.3</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $allowed_types Array of whitelisted post types. Default to `array( 'post', 'page', 'revision' )`.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $allowed_types = apply_filters( 'rest_api_allowed_post_types', $allowed_types );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_unique( $allowed_types );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_media_creation_v1_1( $media_files, $media_urls, $media_attrs = array(), $force_parent_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'upload_mimes', array( $this, 'allow_video_uploads' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $media_ids = $errors = array();&nbsp;</div></li><li><div>      $user_can_upload_files = current_user_can( 'upload_files' );&nbsp;</div></li><li><div>      $media_attrs = array_values( $media_attrs ); <span class="comment">// reset the keys</span>&nbsp;</div></li><li><div>      $i = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $media_files ) ) {&nbsp;</div></li><li><div>          $this-&gt;api-&gt;trap_wp_die( 'upload_error' );&nbsp;</div></li><li><div>          foreach ( $media_files as $media_item ) {&nbsp;</div></li><li><div>              $_FILES['.api.media.item.'] = $media_item;&nbsp;</div></li><li><div>              if ( ! $user_can_upload_files ) {&nbsp;</div></li><li><div>                  $media_id = new WP_Error( 'unauthorized', 'User cannot upload media.', 403 );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ( $force_parent_id ) {&nbsp;</div></li><li><div>                      $parent_id = absint( $force_parent_id );&nbsp;</div></li><li><div>                  } elseif ( ! empty( $media_attrs[$i] ) && ! empty( $media_attrs[$i]['parent_id'] ) ) {&nbsp;</div></li><li><div>                      $parent_id = absint( $media_attrs[$i]['parent_id'] );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $parent_id = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $media_id = media_handle_upload( '.api.media.item.', $parent_id );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( is_wp_error( $media_id ) ) {&nbsp;</div></li><li><div>                  $errors[$i]['file'] = $media_item['name'];&nbsp;</div></li><li><div>                  $errors[$i]['error'] = $media_id-&gt;get_error_code();&nbsp;</div></li><li><div>                  $errors[$i]['message'] = $media_id-&gt;get_error_message();&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $media_ids[$i] = $media_id;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;api-&gt;trap_wp_die( null );&nbsp;</div></li><li><div>          unset( $_FILES['.api.media.item.'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $media_urls ) ) {&nbsp;</div></li><li><div>          foreach ( $media_urls as $url ) {&nbsp;</div></li><li><div>              if ( ! $user_can_upload_files ) {&nbsp;</div></li><li><div>                  $media_id = new WP_Error( 'unauthorized', 'User cannot upload media.', 403 );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ( $force_parent_id ) {&nbsp;</div></li><li><div>                      $parent_id = absint( $force_parent_id );&nbsp;</div></li><li><div>                  } else if ( ! empty( $media_attrs[$i] ) && ! empty( $media_attrs[$i]['parent_id'] ) ) {&nbsp;</div></li><li><div>                      $parent_id = absint( $media_attrs[$i]['parent_id'] );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $parent_id = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $media_id = $this-&gt;handle_media_sideload( $url, $parent_id );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( is_wp_error( $media_id ) ) {&nbsp;</div></li><li><div>                  $errors[$i] = array(&nbsp;</div></li><li><div>                      'file' =&gt; $url, &nbsp;</div></li><li><div>                      'error' =&gt; $media_id-&gt;get_error_code(), &nbsp;</div></li><li><div>                      'message' =&gt; $media_id-&gt;get_error_message(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              } elseif ( ! empty( $media_id ) ) {&nbsp;</div></li><li><div>                  $media_ids[$i] = $media_id;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $media_attrs ) ) {&nbsp;</div></li><li><div>          foreach ( $media_ids as $index =&gt; $media_id ) {&nbsp;</div></li><li><div>              if ( empty( $media_attrs[$index] ) )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $attrs = $media_attrs[$index];&nbsp;</div></li><li><div>              $insert = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $attrs['title'] ) ) {&nbsp;</div></li><li><div>                  $insert['post_title'] = $attrs['title'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $attrs['caption'] ) )&nbsp;</div></li><li><div>                  $insert['post_excerpt'] = $attrs['caption'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $attrs['description'] ) )&nbsp;</div></li><li><div>                  $insert['post_content'] = $attrs['description'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( empty( $insert ) )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $insert['ID'] = $media_id;&nbsp;</div></li><li><div>              wp_update_post( (object) $insert );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array( 'media_ids' =&gt; $media_ids, 'errors' =&gt; $errors );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function handle_media_sideload( $url, $parent_post_id = 0 ) {&nbsp;</div></li><li><div>      if ( ! function_exists( 'download_url' ) || ! function_exists( 'media_handle_sideload' ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we didn't get a URL, let's bail</span>&nbsp;</div></li><li><div>      $parsed = @parse_url( $url );&nbsp;</div></li><li><div>      if ( empty( $parsed ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tmp = download_url( $url );&nbsp;</div></li><li><div>      if ( is_wp_error( $tmp ) ) {&nbsp;</div></li><li><div>          return $tmp;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! file_is_displayable_image( $tmp ) ) {&nbsp;</div></li><li><div>          @unlink( $tmp );&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// emulate a $_FILES entry</span>&nbsp;</div></li><li><div>      $file_array = array(&nbsp;</div></li><li><div>          'name' =&gt; basename( parse_url( $url, PHP_URL_PATH ) ), &nbsp;</div></li><li><div>          'tmp_name' =&gt; $tmp, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = media_handle_sideload( $file_array, $parent_post_id );&nbsp;</div></li><li><div>      @unlink( $tmp );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>          return $id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $id || ! is_int( $id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function allow_video_uploads( $mimes ) {&nbsp;</div></li><li><div>      <span class="comment">// if we are on Jetpack, bail - Videos are already allowed</span>&nbsp;</div></li><li><div>      if ( ! defined( 'IS_WPCOM' ) || !IS_WPCOM ) {&nbsp;</div></li><li><div>          return $mimes;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// extra check that this filter is only ever applied during REST API requests</span>&nbsp;</div></li><li><div>      if ( ! defined( 'REST_API_REQUEST' ) || ! REST_API_REQUEST ) {&nbsp;</div></li><li><div>          return $mimes;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// bail early if they already have the upgrade..</span>&nbsp;</div></li><li><div>      if ( get_option( 'video_upgrade' ) == '1' ) {&nbsp;</div></li><li><div>          return $mimes;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// lets whitelist to only specific clients right now</span>&nbsp;</div></li><li><div>      $clients_allowed_video_uploads = array();&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the list of whitelisted video clients.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $clients_allowed_video_uploads Array of whitelisted Video clients.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $clients_allowed_video_uploads = apply_filters( 'rest_api_clients_allowed_video_uploads', $clients_allowed_video_uploads );&nbsp;</div></li><li><div>      if ( !in_array( $this-&gt;api-&gt;token_details['client_id'], $clients_allowed_video_uploads ) ) {&nbsp;</div></li><li><div>          return $mimes;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $mime_list = wp_get_mime_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $video_exts = explode( ' ', get_site_option( 'video_upload_filetypes', false, false ) );&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Filter the video filetypes allowed on the site.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module json-api</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.2.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $video_exts Array of video filetypes allowed on the site.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $video_exts = apply_filters( 'video_upload_filetypes', $video_exts );&nbsp;</div></li><li><div>      $video_mimes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $video_exts ) ) {&nbsp;</div></li><li><div>          foreach ( $video_exts as $ext ) {&nbsp;</div></li><li><div>              foreach ( $mime_list as $ext_pattern =&gt; $mime ) {&nbsp;</div></li><li><div>                  if ( $ext != '' && strpos( $ext_pattern, $ext ) !== false )&nbsp;</div></li><li><div>                      $video_mimes[$ext_pattern] = $mime;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $mimes = array_merge( $mimes, $video_mimes );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $mimes;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_current_site_multi_user() {&nbsp;</div></li><li><div>      $users = wp_cache_get( 'site_user_count', 'WPCOM_JSON_API_Endpoint' );&nbsp;</div></li><li><div>      if ( false === $users ) {&nbsp;</div></li><li><div>          $user_query = new WP_User_Query( array(&nbsp;</div></li><li><div>              'blog_id' =&gt; get_current_blog_id(), &nbsp;</div></li><li><div>              'fields' =&gt; 'ID', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          $users = (int) $user_query-&gt;get_total();&nbsp;</div></li><li><div>          wp_cache_set( 'site_user_count', $users, 'WPCOM_JSON_API_Endpoint', DAY_IN_SECONDS );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $users &gt; 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function allows_cross_origin_requests() {&nbsp;</div></li><li><div>      return 'GET' == $this-&gt;method || $this-&gt;allow_cross_origin_request;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function allows_unauthorized_requests( $origin, $complete_access_origins ) {&nbsp;</div></li><li><div>      return 'GET' == $this-&gt;method || ( $this-&gt;allow_unauthorized_request && in_array( $origin, $complete_access_origins ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return endpoint response</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param ... determined by -&gt;$path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return</span>&nbsp;</div></li><li><div><span class="comment">   *     falsy: HTTP 500, no response body</span>&nbsp;</div></li><li><div><span class="comment">   *    WP_Error( $error_code, $error_message, $http_status_code ): HTTP $status_code, json_encode( array( 'error' =&gt; $error_code, 'message' =&gt; $error_message ) ) response body</span>&nbsp;</div></li><li><div><span class="comment">   *    $data: HTTP 200, json_encode( $data ) response body</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  abstract function callback( $path = '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>require_once( dirname( __FILE__ ) . '/json-endpoints.php' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>