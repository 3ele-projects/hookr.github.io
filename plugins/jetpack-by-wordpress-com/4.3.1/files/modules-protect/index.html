<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.8.0" data-slug="jetpack-by-wordpress-com" data-type="file" data-id="13102"><head xmlns="http://www.w3.org/1999/xhtml"><title> modules-protect | file | Jetpack By WordPress Com | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, jetpack-by-wordpress-com, 3.8.0" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=e24a06f34ddb3170cf6fc23e927b6608' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/modules-protect/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-protect%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fmodules-protect%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-jetpack-by-wordpress-com-3.8.0-file-modules-protect","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="modules-protect" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to jetpack-by-wordpress-com." href="http://hookr.io/plugins/jetpack-by-wordpress-com/" class="plugin"><span property="name">jetpack-by-wordpress-com</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.8.0." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/" class="H_VERSION"><span property="name">3.8.0</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">modules-protect</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="1499"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/all/" title="All">All <span class="count badge">1499</span></a></li><li class="" data-id="new" data-count="17"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/new/" title="New">New <span class="count badge">17</span></a></li><li class="" data-id="hooks" data-count="599"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/hooks/" title="Hooks">Hooks <span class="count badge">599</span></a></li><li class="" data-id="action" data-count="195"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/actions/" title="Actions">Actions <span class="count badge">195</span></a></li><li class="" data-id="filter" data-count="404"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/filters/" title="Filters">Filters <span class="count badge">404</span></a></li><li class="" data-id="class" data-count="262"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/classes/" title="Classes">Classes <span class="count badge">262</span></a></li><li class="" data-id="constant" data-count="62"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/constants/" title="Constants">Constants <span class="count badge">62</span></a></li><li class="" data-id="function" data-count="530"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/functions/" title="Functions">Functions <span class="count badge">530</span></a></li><li class="" data-id="shortcode" data-count="46"><a href="http://hookr.io/plugins/jetpack-by-wordpress-com/3.8.0/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">46</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/modules/protect.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Module Name: Protect</span>&nbsp;</div></li><li><div><span class="comment"> * Module Description: Prevent brute force attacks.</span>&nbsp;</div></li><li><div><span class="comment"> * Sort Order: 1</span>&nbsp;</div></li><li><div><span class="comment"> * Recommendation Order: 4</span>&nbsp;</div></li><li><div><span class="comment"> * First Introduced: 3.4</span>&nbsp;</div></li><li><div><span class="comment"> * Requires Connection: Yes</span>&nbsp;</div></li><li><div><span class="comment"> * Auto Activate: Yes</span>&nbsp;</div></li><li><div><span class="comment"> * Module Tags: Recommended</span>&nbsp;</div></li><li><div><span class="comment"> * Feature: Recommended, Performance-Security</span>&nbsp;</div></li><li><div><span class="comment"> * Additional Search Queries: security, secure, protection, botnet, brute force, protect, login</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>include_once JETPACK__PLUGIN_DIR . 'modules/protect/shared-functions.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class Jetpack_Protect_Module {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static $__instance = null;&nbsp;</div></li><li><div>  public $api_key;&nbsp;</div></li><li><div>  public $api_key_error;&nbsp;</div></li><li><div>  public $whitelist;&nbsp;</div></li><li><div>  public $whitelist_error;&nbsp;</div></li><li><div>  public $whitelist_saved;&nbsp;</div></li><li><div>  private $user_ip;&nbsp;</div></li><li><div>  private $local_host;&nbsp;</div></li><li><div>  private $api_endpoint;&nbsp;</div></li><li><div>  public $last_request;&nbsp;</div></li><li><div>  public $last_response_raw;&nbsp;</div></li><li><div>  public $last_response;&nbsp;</div></li><li><div>  private $block_login_with_math;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Singleton implementation</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function instance() {&nbsp;</div></li><li><div>      if ( ! is_a( self::$__instance, 'Jetpack_Protect_Module' ) ) {&nbsp;</div></li><li><div>          self::$__instance = new Jetpack_Protect_Module();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$__instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Registers actions</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function __construct() {&nbsp;</div></li><li><div>      add_action( 'jetpack_activate_module_protect', array ( $this, 'on_activation' ) );&nbsp;</div></li><li><div>      add_action( 'jetpack_deactivate_module_protect', array ( $this, 'on_deactivation' ) );&nbsp;</div></li><li><div>      add_action( 'init', array ( $this, 'maybe_get_protect_key' ) );&nbsp;</div></li><li><div>      add_action( 'jetpack_modules_loaded', array ( $this, 'modules_loaded' ) );&nbsp;</div></li><li><div>      add_action( 'login_head', array ( $this, 'check_use_math' ) );&nbsp;</div></li><li><div>      add_filter( 'authenticate', array ( $this, 'check_preauth' ), 10, 3 );&nbsp;</div></li><li><div>      add_action( 'wp_login', array ( $this, 'log_successful_login' ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'wp_login_failed', array ( $this, 'log_failed_attempt' ) );&nbsp;</div></li><li><div>      add_action( 'admin_init', array ( $this, 'maybe_update_headers' ) );&nbsp;</div></li><li><div>      add_action( 'admin_init', array ( $this, 'maybe_display_security_warning' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This is a backup in case $pagenow fails for some reason</span>&nbsp;</div></li><li><div>      add_action( 'login_head', array ( $this, 'check_login_ability' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Runs a script every day to clean up expired transients so they don't</span>&nbsp;</div></li><li><div>      <span class="comment">// clog up our users' databases</span>&nbsp;</div></li><li><div>      require_once( JETPACK__PLUGIN_DIR . '/modules/protect/transient-cleanup.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//this should move into on_activation in 3.8, but, for now, we want to make sure all sites get this option set</span>&nbsp;</div></li><li><div>      if ( is_multisite() && is_main_site() ) {&nbsp;</div></li><li><div>          update_site_option( 'jetpack_protect_active', 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * On module activation, try to get an api key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function on_activation() {&nbsp;</div></li><li><div>      update_site_option( 'jetpack_protect_activating', 'activating' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get BruteProtect's counter number</span>&nbsp;</div></li><li><div>      Jetpack_Protect_Module::protect_call( 'check_key' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * On module deactivation, unset protect_active</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function on_deactivation() {&nbsp;</div></li><li><div>      if ( is_multisite() && is_main_site() ) {&nbsp;</div></li><li><div>          update_site_option( 'jetpack_protect_active', 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function maybe_get_protect_key() {&nbsp;</div></li><li><div>      if ( get_site_option( 'jetpack_protect_activating', false ) && ! get_site_option( 'jetpack_protect_key', false ) ) {&nbsp;</div></li><li><div>          $this-&gt;get_protect_key();&nbsp;</div></li><li><div>          delete_site_option( 'jetpack_protect_activating' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sends a &quot;check_key&quot; API call once a day.  This call allows us to track IP-related</span>&nbsp;</div></li><li><div><span class="comment">   * headers for this server via the Protect API, in order to better identify the source</span>&nbsp;</div></li><li><div><span class="comment">   * IP for login attempts</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_update_headers( $force = false ) {&nbsp;</div></li><li><div>      $updated_recently = $this-&gt;get_transient( 'jpp_headers_updated_recently' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $force ) {&nbsp;</div></li><li><div>          if ( isset( $_GET['protect_update_headers'] ) ) {&nbsp;</div></li><li><div>              $force = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check that current user is admin so we prevent a lower level user from adding</span>&nbsp;</div></li><li><div>      <span class="comment">// a trusted header, allowing them to brute force an admin account</span>&nbsp;</div></li><li><div>      if ( ( $updated_recently && ! $force ) || ! current_user_can( 'update_plugins' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = Jetpack_Protect_Module::protect_call( 'check_key' );&nbsp;</div></li><li><div>      $this-&gt;set_transient( 'jpp_headers_updated_recently', 1, DAY_IN_SECONDS );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['msg'] ) && $response['msg'] ) {&nbsp;</div></li><li><div>          update_site_option( 'trusted_ip_header', json_decode( $response['msg'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function maybe_display_security_warning() {&nbsp;</div></li><li><div>      if ( is_multisite() && current_user_can( 'manage_network' ) ) {&nbsp;</div></li><li><div>          if ( ! function_exists( 'is_plugin_active_for_network' ) ) {&nbsp;</div></li><li><div>              require_once( ABSPATH . '/wp-admin/includes/plugin.php' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! is_plugin_active_for_network( 'jetpack/jetpack.php' ) ) {&nbsp;</div></li><li><div>              add_action( 'load-index.php', array ( $this, 'prepare_jetpack_protect_multisite_notice' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function prepare_jetpack_protect_multisite_notice() {&nbsp;</div></li><li><div>      add_action( 'admin_print_styles', array ( $this, 'admin_banner_styles' ) );&nbsp;</div></li><li><div>      add_action( 'admin_notices', array ( $this, 'admin_jetpack_manage_notice' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function admin_banner_styles() {&nbsp;</div></li><li><div>      global $wp_styles;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $min = ( defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ) ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_style( 'jetpack', plugins_url( &quot;css/jetpack-banners{$min}.css&quot;, JETPACK__PLUGIN_FILE ), false, JETPACK__VERSION );&nbsp;</div></li><li><div>      $wp_styles-&gt;add_data( 'jetpack', 'rtl', true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function admin_jetpack_manage_notice() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $dismissed = get_site_option( 'jetpack_dismissed_protect_multisite_banner' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $dismissed ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $referer = '&_wp_http_referer=' . add_query_arg( '_wp_http_referer', null );&nbsp;</div></li><li><div>      $opt_out_url = wp_nonce_url( Jetpack::admin_url( 'jetpack-notice=jetpack-protect-multisite-opt-out' . $referer ), 'jetpack_protect_multisite_banner_opt_out' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;div id=&quot;message&quot; class=&quot;updated jetpack-message jp-banner is-opt-in protect-error&quot;&nbsp;</div></li><li><div>           style=&quot;display:block !important;&quot;&gt;&nbsp;</div></li><li><div>          &lt;a class=&quot;jp-banner__dismiss&quot; href=&quot;&lt;?php echo esc_url( $opt_out_url ); ?&gt;&quot;&nbsp;</div></li><li><div>             title=&quot;&lt;?php esc_attr_e( 'Dismiss this notice.', 'jetpack' ); ?&gt;&quot;&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;div class=&quot;jp-banner__content&quot;&gt;&nbsp;</div></li><li><div>              &lt;h4&gt;&lt;?php esc_html_e( 'Protect cannot keep your site secure.', 'jetpack' ); ?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;p&gt;&lt;?php printf( __( 'Thanks for activating Protect! To start protecting your site, please network activate Jetpack on your Multisite installation and activate Protect on your primary site. Due to the way logins are handled on WordPress Multisite, Jetpack must be network-enabled in order for Protect to work properly. &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;Learn More&lt;/a&gt;', 'jetpack' ), 'http:<span class="comment">//jetpack.me/support/multisite-protect' ); ?&gt;&lt;/p&gt;</span>&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>          &lt;div class=&quot;jp-banner__action-container is-opt-in&quot;&gt;&nbsp;</div></li><li><div>              &lt;a href=&quot;&lt;?php echo network_admin_url( 'plugins.php' ); ?&gt;&quot; class=&quot;jp-banner__button&quot;&nbsp;</div></li><li><div>                 id=&quot;wpcom-connect&quot;&gt;&lt;?php _e( 'View Network Admin', 'jetpack' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Request an api key from wordpress.com</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool | string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_protect_key() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $protect_blog_id = Jetpack_Protect_Module::get_main_blog_jetpack_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we can't find the the blog id, that means we are on multisite, and the main site never connected</span>&nbsp;</div></li><li><div>      <span class="comment">// the protect api key is linked to the main blog id - instruct the user to connect their main blog</span>&nbsp;</div></li><li><div>      if ( ! $protect_blog_id ) {&nbsp;</div></li><li><div>          $this-&gt;api_key_error = __( 'Your main blog is not connected to WordPress.com. Please connect to get an API key.', 'jetpack' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $request = array (&nbsp;</div></li><li><div>          'jetpack_blog_id' =&gt; $protect_blog_id, &nbsp;</div></li><li><div>          'bruteprotect_api_key' =&gt; get_site_option( 'bruteprotect_api_key' ), &nbsp;</div></li><li><div>          'multisite' =&gt; '0', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Send the number of blogs on the network if we are on multisite</span>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $request['multisite'] = get_blog_count();&nbsp;</div></li><li><div>          if ( ! $request['multisite'] ) {&nbsp;</div></li><li><div>              global $wpdb;&nbsp;</div></li><li><div>              $request['multisite'] = $wpdb-&gt;get_var( &quot;SELECT COUNT(blog_id) as c FROM $wpdb-&gt;blogs WHERE spam = '0' AND deleted = '0' and archived = '0'&quot; );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Request the key</span>&nbsp;</div></li><li><div>      Jetpack::load_xml_rpc_client();&nbsp;</div></li><li><div>      $xml = new Jetpack_IXR_Client( array (&nbsp;</div></li><li><div>          'user_id' =&gt; get_current_user_id()&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $xml-&gt;query( 'jetpack.protect.requestKey', $request );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hmm, can't talk to wordpress.com</span>&nbsp;</div></li><li><div>      if ( $xml-&gt;isError() ) {&nbsp;</div></li><li><div>          $code = $xml-&gt;getErrorCode();&nbsp;</div></li><li><div>          $message = $xml-&gt;getErrorMessage();&nbsp;</div></li><li><div>          $this-&gt;api_key_error = sprintf( __( 'Error connecting to WordPress.com. Code: %1$s, %2$s', 'jetpack' ), $code, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = $xml-&gt;getResponse();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Hmm. Can't talk to the protect servers ( api.bruteprotect.com )</span>&nbsp;</div></li><li><div>      if ( ! isset( $response['data'] ) ) {&nbsp;</div></li><li><div>          $this-&gt;api_key_error = __( 'No reply from Jetpack servers', 'jetpack' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// There was an issue generating the key</span>&nbsp;</div></li><li><div>      if ( empty( $response['success'] ) ) {&nbsp;</div></li><li><div>          $this-&gt;api_key_error = $response['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Key generation successful!</span>&nbsp;</div></li><li><div>      $active_plugins = Jetpack::get_active_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We only want to deactivate BruteProtect if we successfully get a key</span>&nbsp;</div></li><li><div>      if ( in_array( 'bruteprotect/bruteprotect.php', $active_plugins ) ) {&nbsp;</div></li><li><div>          Jetpack_Client_Server::deactivate_plugin( 'bruteprotect/bruteprotect.php', 'BruteProtect' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $key = $response['data'];&nbsp;</div></li><li><div>      update_site_option( 'jetpack_protect_key', $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $key;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Called via WP action wp_login_failed to log failed attempt with the api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Fires custom, plugable action jpp_log_failed_attempt with the IP</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function log_failed_attempt() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires before every failed login attempt.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module protect</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string jetpack_protect_get_ip IP stored by Protect.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'jpp_log_failed_attempt', jetpack_protect_get_ip() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_COOKIE['jpp_math_pass'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $transient = $this-&gt;get_transient( 'jpp_math_pass_' . $_COOKIE['jpp_math_pass'] );&nbsp;</div></li><li><div>          $transient--;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $transient || $transient &lt; 1 ) {&nbsp;</div></li><li><div>              $this-&gt;delete_transient( 'jpp_math_pass_' . $_COOKIE['jpp_math_pass'] );&nbsp;</div></li><li><div>              setcookie( 'jpp_math_pass', 0, time() - DAY_IN_SECONDS, COOKIEPATH, COOKIE_DOMAIN, false );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;set_transient( 'jpp_math_pass_' . $_COOKIE['jpp_math_pass'], $transient, DAY_IN_SECONDS );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;protect_call( 'failed_attempt' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set up the Protect configuration page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function modules_loaded() {&nbsp;</div></li><li><div>      Jetpack::enable_module_configurable( __FILE__ );&nbsp;</div></li><li><div>      Jetpack::module_configuration_load( __FILE__, array ( $this, 'configuration_load' ) );&nbsp;</div></li><li><div>      Jetpack::module_configuration_head( __FILE__, array ( $this, 'configuration_head' ) );&nbsp;</div></li><li><div>      Jetpack::module_configuration_screen( __FILE__, array ( $this, 'configuration_screen' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Logs a successful login back to our servers, this allows us to make sure we're not blocking</span>&nbsp;</div></li><li><div><span class="comment">   * a busy IP that has a lot of good logins along with some forgotten passwords. Also saves current user's ip</span>&nbsp;</div></li><li><div><span class="comment">   * to the ip address whitelist</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function log_successful_login( $user_login, $user ) {&nbsp;</div></li><li><div>      $this-&gt;protect_call( 'successful_login', array ( 'roles' =&gt; $user-&gt;roles ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks for loginability BEFORE authentication so that bots don't get to go around the log in form.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If we are using our math fallback, authenticate via math-fallback.php</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $user</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $username</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $password</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $user</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function check_preauth( $user = 'Not Used By Protect', $username = 'Not Used By Protect', $password = 'Not Used By Protect' ) {&nbsp;</div></li><li><div>      $allow_login = $this-&gt;check_login_ability( true );&nbsp;</div></li><li><div>      $use_math = $this-&gt;get_transient( 'brute_use_math' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $allow_login ) {&nbsp;</div></li><li><div>          $this-&gt;block_with_math();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( 1 == $use_math || 1 == $this-&gt;block_login_with_math ) && isset( $_POST['log'] ) ) {&nbsp;</div></li><li><div>          include_once dirname( __FILE__ ) . '/protect/math-fallback.php';&nbsp;</div></li><li><div>          Jetpack_Protect_Math_Authenticate::math_authenticate();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get all IP headers so that we can process on our server...</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_headers() {&nbsp;</div></li><li><div>      $ip_related_headers = array (&nbsp;</div></li><li><div>          'GD_PHP_HANDLER', &nbsp;</div></li><li><div>          'HTTP_AKAMAI_ORIGIN_HOP', &nbsp;</div></li><li><div>          'HTTP_CF_CONNECTING_IP', &nbsp;</div></li><li><div>          'HTTP_CLIENT_IP', &nbsp;</div></li><li><div>          'HTTP_FASTLY_CLIENT_IP', &nbsp;</div></li><li><div>          'HTTP_FORWARDED', &nbsp;</div></li><li><div>          'HTTP_FORWARDED_FOR', &nbsp;</div></li><li><div>          'HTTP_INCAP_CLIENT_IP', &nbsp;</div></li><li><div>          'HTTP_TRUE_CLIENT_IP', &nbsp;</div></li><li><div>          'HTTP_X_CLIENTIP', &nbsp;</div></li><li><div>          'HTTP_X_CLUSTER_CLIENT_IP', &nbsp;</div></li><li><div>          'HTTP_X_FORWARDED', &nbsp;</div></li><li><div>          'HTTP_X_FORWARDED_FOR', &nbsp;</div></li><li><div>          'HTTP_X_IP_TRAIL', &nbsp;</div></li><li><div>          'HTTP_X_REAL_IP', &nbsp;</div></li><li><div>          'HTTP_X_VARNISH', &nbsp;</div></li><li><div>          'REMOTE_ADDR'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $ip_related_headers as $header ) {&nbsp;</div></li><li><div>          if ( isset( $_SERVER[ $header ] ) ) {&nbsp;</div></li><li><div>              $output[ $header ] = $_SERVER[ $header ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $output;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if the IP address has been whitelisted</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $ip</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function ip_is_whitelisted( $ip ) {&nbsp;</div></li><li><div>      <span class="comment">// If we found an exact match in wp-config</span>&nbsp;</div></li><li><div>      if ( defined( 'JETPACK_IP_ADDRESS_OK' ) && JETPACK_IP_ADDRESS_OK == $ip ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $whitelist = jetpack_protect_get_local_whitelist();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $whitelist = array_merge( $whitelist, get_site_option( 'jetpack_protect_global_whitelist', array () ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $whitelist ) ) :&nbsp;</div></li><li><div>          foreach ( $whitelist as $item ) :&nbsp;</div></li><li><div>              <span class="comment">// If the IPs are an exact match</span>&nbsp;</div></li><li><div>              if ( ! $item-&gt;range && isset( $item-&gt;ip_address ) && $item-&gt;ip_address == $ip ) {&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $item-&gt;range && isset( $item-&gt;range_low ) && isset( $item-&gt;range_high ) ) {&nbsp;</div></li><li><div>                  if ( jetpack_protect_ip_address_is_in_range( $ip, $item-&gt;range_low, $item-&gt;range_high ) ) {&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          endforeach;&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks the status for a given IP. API results are cached as transients</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $preauth Whether or not we are checking prior to authorization</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool Either returns true, fires $this-&gt;kill_login, or includes a math fallback and returns false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function check_login_ability( $preauth = false ) {&nbsp;</div></li><li><div>      $headers = $this-&gt;get_headers();&nbsp;</div></li><li><div>      $header_hash = md5( json_encode( $headers ) );&nbsp;</div></li><li><div>      $transient_name = 'jpp_li_' . $header_hash;&nbsp;</div></li><li><div>      $transient_value = $this-&gt;get_transient( $transient_name );&nbsp;</div></li><li><div>      $ip = jetpack_protect_get_ip();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( jetpack_protect_ip_is_private( $ip ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;ip_is_whitelisted( $ip ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check out our transients</span>&nbsp;</div></li><li><div>      if ( isset( $transient_value ) && 'ok' == $transient_value['status'] ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $transient_value ) && 'blocked' == $transient_value['status'] ) {&nbsp;</div></li><li><div>          $this-&gt;block_with_math();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $transient_value ) && 'blocked-hard' == $transient_value['status'] ) {&nbsp;</div></li><li><div>          $this-&gt;kill_login();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we've reached this point, this means that the IP isn't cached.</span>&nbsp;</div></li><li><div>      <span class="comment">// Now we check with the Protect API to see if we should allow login</span>&nbsp;</div></li><li><div>      $response = $this-&gt;protect_call( $action = 'check_ip' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['math'] ) && ! function_exists( 'brute_math_authenticate' ) ) {&nbsp;</div></li><li><div>          include_once dirname( __FILE__ ) . '/protect/math-fallback.php';&nbsp;</div></li><li><div>          new Jetpack_Protect_Math_Authenticate;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'blocked' == $response['status'] ) {&nbsp;</div></li><li><div>          $this-&gt;block_with_math();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'blocked-hard' == $response['status'] ) {&nbsp;</div></li><li><div>          $this-&gt;kill_login();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function block_with_math() {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * By default, Protect will allow a user who has been blocked for too</span>&nbsp;</div></li><li><div><span class="comment">       * many failed logins to start answering math questions to continue logging in</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * For added security, you can disable this.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module protect</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool Whether to allow math for blocked users or not.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;block_login_with_math = 1;&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Allow Math fallback for blocked IPs.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module protect</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.6.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param bool true Should we fallback to the Math questions when an IP is blocked. Default to true.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $allow_math_fallback_on_fail = apply_filters( 'jpp_use_captcha_when_blocked', true );&nbsp;</div></li><li><div>      if ( ! $allow_math_fallback_on_fail ) {&nbsp;</div></li><li><div>          $this-&gt;kill_login();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      include_once dirname( __FILE__ ) . '/protect/math-fallback.php';&nbsp;</div></li><li><div>      new Jetpack_Protect_Math_Authenticate;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Kill a login attempt</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function kill_login() {&nbsp;</div></li><li><div>      $ip = jetpack_protect_get_ip();&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Fires before every killed login.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @module protect</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.4.0</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $ip IP flagged by Protect.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'jpp_kill_login', $ip );&nbsp;</div></li><li><div>      $help_url = 'http:<span class="comment">//jetpack.me/support/security/';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_die(&nbsp;</div></li><li><div>          sprintf( __( 'Your IP (%1$s) has been flagged for potential security violations.  &lt;a href=&quot;%2$s&quot;&gt;Find out more...&lt;/a&gt;', 'jetpack' ), str_replace( 'http:<span class="comment">//', '', esc_url( 'http://' . $ip ) ), esc_url( $help_url ) ), </span>&nbsp;</div></li><li><div>          __( 'Login Blocked by Jetpack', 'jetpack' ), &nbsp;</div></li><li><div>          array ( 'response' =&gt; 403 )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if the protect API call has failed, and if so initiates the math captcha fallback.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_use_math() {&nbsp;</div></li><li><div>      $use_math = $this-&gt;get_transient( 'brute_use_math' );&nbsp;</div></li><li><div>      if ( $use_math ) {&nbsp;</div></li><li><div>          include_once dirname( __FILE__ ) . '/protect/math-fallback.php';&nbsp;</div></li><li><div>          new Jetpack_Protect_Math_Authenticate;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get or delete API key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function configuration_load() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['action'] ) && $_POST['action'] == 'jetpack_protect_save_whitelist' && wp_verify_nonce( $_POST['_wpnonce'], 'jetpack-protect' ) ) {&nbsp;</div></li><li><div>          $whitelist = str_replace( ' ', '', $_POST['whitelist'] );&nbsp;</div></li><li><div>          $whitelist = explode( PHP_EOL, $whitelist );&nbsp;</div></li><li><div>          $result = jetpack_protect_save_whitelist( $whitelist );&nbsp;</div></li><li><div>          $this-&gt;whitelist_saved = ! is_wp_error( $result );&nbsp;</div></li><li><div>          $this-&gt;whitelist_error = is_wp_error( $result );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['action'] ) && 'get_protect_key' == $_POST['action'] && wp_verify_nonce( $_POST['_wpnonce'], 'jetpack-protect' ) ) {&nbsp;</div></li><li><div>          $result = $this-&gt;get_protect_key();&nbsp;</div></li><li><div>          <span class="comment">// Only redirect on success</span>&nbsp;</div></li><li><div>          <span class="comment">// If it fails we need access to $this-&gt;api_key_error</span>&nbsp;</div></li><li><div>          if ( $result ) {&nbsp;</div></li><li><div>              wp_safe_redirect( Jetpack::module_configuration_url( 'protect' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;api_key = get_site_option( 'jetpack_protect_key', false );&nbsp;</div></li><li><div>      $this-&gt;user_ip = jetpack_protect_get_ip();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function configuration_head() {&nbsp;</div></li><li><div>      wp_enqueue_style( 'jetpack-protect' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Prints the configuration screen</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function configuration_screen() {&nbsp;</div></li><li><div>      require_once dirname( __FILE__ ) . '/protect/config-ui.php';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If we're in a multisite network, return the blog ID of the primary blog</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_main_blog_id() {&nbsp;</div></li><li><div>      if ( ! is_multisite() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $current_site;&nbsp;</div></li><li><div>      $primary_blog_id = $current_site-&gt;blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $primary_blog_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get jetpack blog id, or the jetpack blog id of the main blog in the main network</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_main_blog_jetpack_id() {&nbsp;</div></li><li><div>      if ( ! is_main_site() ) {&nbsp;</div></li><li><div>          switch_to_blog( $this-&gt;get_main_blog_id() );&nbsp;</div></li><li><div>          $id = Jetpack::get_option( 'id', false );&nbsp;</div></li><li><div>          restore_current_blog();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $id = Jetpack::get_option( 'id' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function check_api_key() {&nbsp;</div></li><li><div>      $response = $this-&gt;protect_call( 'check_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['ckval'] ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['error'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $response['error'] == 'Invalid API Key' ) {&nbsp;</div></li><li><div>              $this-&gt;api_key_error = __( 'Your API key is invalid', 'jetpack' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $response['error'] == 'API Key Required' ) {&nbsp;</div></li><li><div>              $this-&gt;api_key_error = __( 'No API key', 'jetpack' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;api_key_error = __( 'There was an error contacting Jetpack servers.', 'jetpack' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calls over to the api using wp_remote_post</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $action 'check_ip', 'check_key', or 'failed_attempt'</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $request Any custom data to post to the api</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function protect_call( $action = 'check_ip', $request = array () ) {&nbsp;</div></li><li><div>      global $wp_version, $wpdb, $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api_key = get_site_option( 'jetpack_protect_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_agent = &quot;WordPress/{$wp_version} | Jetpack/&quot; . constant( 'JETPACK__VERSION' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $request['action'] = $action;&nbsp;</div></li><li><div>      $request['ip'] = jetpack_protect_get_ip();&nbsp;</div></li><li><div>      $request['host'] = $this-&gt;get_local_host();&nbsp;</div></li><li><div>      $request['headers'] = json_encode( $this-&gt;get_headers() );&nbsp;</div></li><li><div>      $request['jetpack_version'] = constant( 'JETPACK__VERSION' );&nbsp;</div></li><li><div>      $request['wordpress_version'] = strval( $wp_version );&nbsp;</div></li><li><div>      $request['api_key'] = $api_key;&nbsp;</div></li><li><div>      $request['multisite'] = &quot;0&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $request['multisite'] = get_blog_count();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array (&nbsp;</div></li><li><div>          'body' =&gt; $request, &nbsp;</div></li><li><div>          'user-agent' =&gt; $user_agent, &nbsp;</div></li><li><div>          'httpversion' =&gt; '1.0', &nbsp;</div></li><li><div>          'timeout' =&gt; 15&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response_json = wp_remote_post( $this-&gt;get_api_host(), $args );&nbsp;</div></li><li><div>      $this-&gt;last_response_raw = $response_json;&nbsp;</div></li><li><div>      $headers = $this-&gt;get_headers();&nbsp;</div></li><li><div>      $header_hash = md5( json_encode( $headers ) );&nbsp;</div></li><li><div>      $transient_name = 'jpp_li_' . $header_hash;&nbsp;</div></li><li><div>      $this-&gt;delete_transient( $transient_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $response_json ) ) {&nbsp;</div></li><li><div>          $response = json_decode( $response_json['body'], true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['blocked_attempts'] ) && $response['blocked_attempts'] ) {&nbsp;</div></li><li><div>          update_site_option( 'jetpack_protect_blocked_attempts', $response['blocked_attempts'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['status'] ) && ! isset( $response['error'] ) ) {&nbsp;</div></li><li><div>          $response['expire'] = time() + $response['seconds_remaining'];&nbsp;</div></li><li><div>          $this-&gt;set_transient( $transient_name, $response, $response['seconds_remaining'] );&nbsp;</div></li><li><div>          $this-&gt;delete_transient( 'brute_use_math' );&nbsp;</div></li><li><div>      } else { <span class="comment">// Fallback to Math Captcha if no response from API host</span>&nbsp;</div></li><li><div>          $this-&gt;set_transient( 'brute_use_math', 1, 600 );&nbsp;</div></li><li><div>          $response['status'] = 'ok';&nbsp;</div></li><li><div>          $response['math'] = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $response['error'] ) ) {&nbsp;</div></li><li><div>          update_site_option( 'jetpack_protect_error', $response['error'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          delete_site_option( 'jetpack_protect_error' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $response;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Wrapper for WordPress set_transient function, our version sets</span>&nbsp;</div></li><li><div><span class="comment">   * the transient on the main site in the network if this is a multisite network</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We do it this way (instead of set_site_transient) because of an issue where</span>&nbsp;</div></li><li><div><span class="comment">   * sitewide transients are always autoloaded</span>&nbsp;</div></li><li><div><span class="comment">   * https://core.trac.wordpress.org/ticket/22846</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $transient Transient name. Expected to not be SQL-escaped. Must be</span>&nbsp;</div></li><li><div><span class="comment">   *                           45 characters or fewer in length.</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $value Transient value. Must be serializable if non-scalar.</span>&nbsp;</div></li><li><div><span class="comment">   *                           Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $expiration Optional. Time until expiration in seconds. Default 0.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool False if value was not set and true if value was set.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function set_transient( $transient, $value, $expiration ) {&nbsp;</div></li><li><div>      if ( is_multisite() && ! is_main_site() ) {&nbsp;</div></li><li><div>          switch_to_blog( $this-&gt;get_main_blog_id() );&nbsp;</div></li><li><div>          $return = set_transient( $transient, $value, $expiration );&nbsp;</div></li><li><div>          restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return set_transient( $transient, $value, $expiration );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Wrapper for WordPress delete_transient function, our version deletes</span>&nbsp;</div></li><li><div><span class="comment">   * the transient on the main site in the network if this is a multisite network</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $transient Transient name. Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool true if successful, false otherwise</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function delete_transient( $transient ) {&nbsp;</div></li><li><div>      if ( is_multisite() && ! is_main_site() ) {&nbsp;</div></li><li><div>          switch_to_blog( $this-&gt;get_main_blog_id() );&nbsp;</div></li><li><div>          $return = delete_transient( $transient );&nbsp;</div></li><li><div>          restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return delete_transient( $transient );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Wrapper for WordPress get_transient function, our version gets</span>&nbsp;</div></li><li><div><span class="comment">   * the transient on the main site in the network if this is a multisite network</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $transient Transient name. Expected to not be SQL-escaped.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed Value of transient.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_transient( $transient ) {&nbsp;</div></li><li><div>      if ( is_multisite() && ! is_main_site() ) {&nbsp;</div></li><li><div>          switch_to_blog( $this-&gt;get_main_blog_id() );&nbsp;</div></li><li><div>          $return = get_transient( $transient );&nbsp;</div></li><li><div>          restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return get_transient( $transient );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_api_host() {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;api_endpoint ) ) {&nbsp;</div></li><li><div>          return $this-&gt;api_endpoint;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Check to see if we can use SSL</span>&nbsp;</div></li><li><div>      $this-&gt;api_endpoint = Jetpack::fix_url_for_bad_hosts( JETPACK_PROTECT__API_HOST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;api_endpoint;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_local_host() {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;local_host ) ) {&nbsp;</div></li><li><div>          return $this-&gt;local_host;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $uri = 'http:<span class="comment">//' . strtolower( $_SERVER['HTTP_HOST'] );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_multisite() ) {&nbsp;</div></li><li><div>          $uri = network_home_url();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $uridata = parse_url( $uri );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $domain = $uridata['host'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If we still don't have the site_url, get it</span>&nbsp;</div></li><li><div>      if ( ! $domain ) {&nbsp;</div></li><li><div>          $uri = get_site_url( 1 );&nbsp;</div></li><li><div>          $uridata = parse_url( $uri );&nbsp;</div></li><li><div>          $domain = $uridata['host'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;local_host = $domain;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;local_host;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>Jetpack_Protect_Module::instance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $pagenow ) && 'wp-login.php' == $pagenow ) {&nbsp;</div></li><li><div>  Jetpack_Protect_Module::check_login_ability();&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Jetpack by WordPress.com</li><li><span></span>3.8.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>