<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="0.6.4" data-slug="bp-xprofile-wordpress-user-sync" data-type="file" data-id="96441"><head xmlns="http://www.w3.org/1999/xhtml"><title> bp-xprofile-wp-user-sync | file | Bp Xprofile WordPress User Sync | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, bp-xprofile-wordpress-user-sync, 0.6.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=ce9ec11478e95d113ba2a320c5a262ef' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/bp-xprofile-wp-user-sync/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-xprofile-wp-user-sync%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fbp-xprofile-wp-user-sync%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-bp-xprofile-wordpress-user-sync-0.6.4-file-bp-xprofile-wp-user-sync","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="bp-xprofile-wp-user-sync" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to bp-xprofile-wordpress-user-sy&hellip;." href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/" class="plugin"><span property="name">bp-xprofile-wordpress-user-sy&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 0.6.4." href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/" class="H_VERSION"><span property="name">0.6.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">bp-xprofile-wp-user-sync</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="6"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/all/" title="All">All <span class="count badge">6</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="1"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/hooks/" title="Hooks">Hooks <span class="count badge">1</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="1"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/filters/" title="Filters">Filters <span class="count badge">1</span></a></li><li class="" data-id="class" data-count="1"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/classes/" title="Classes">Classes <span class="count badge">1</span></a></li><li class="" data-id="constant" data-count="4"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/constants/" title="Constants">Constants <span class="count badge">4</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/bp-xprofile-wordpress-user-sync/0.6.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/bp-xprofile-wp-user-sync.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">--------------------------------------------------------------------------------</span>&nbsp;</div></li><li><div><span class="comment">Plugin Name: BP XProfile WordPress User Sync</span>&nbsp;</div></li><li><div><span class="comment">Plugin URI: https://github.com/christianwach/bp-xprofile-wp-user-sync</span>&nbsp;</div></li><li><div><span class="comment">Description: Map BuddyPress xProfile fields to WordPress User fields. &lt;strong&gt;Note:&lt;/strong&gt; because there is no way to hide xProfile fields, all field definitions are deleted when it is deactivated. The plugin tries to reconnect on reactivation, but always backup before deactivating. &lt;strong&gt;The best way to update this plugin is to replace the folder with the latest version via FTP or similar. This avoids the deactivate-reactivate process.&lt;/strong&gt;</span>&nbsp;</div></li><li><div><span class="comment">Author: Christian Wach</span>&nbsp;</div></li><li><div><span class="comment">Version: 0.6.4</span>&nbsp;</div></li><li><div><span class="comment">Author URI: http://haystack.co.uk</span>&nbsp;</div></li><li><div><span class="comment">Text Domain: bp-xprofile-wp-user-sync</span>&nbsp;</div></li><li><div><span class="comment">Domain Path: /languages</span>&nbsp;</div></li><li><div><span class="comment">--------------------------------------------------------------------------------</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// set our version here</span>&nbsp;</div></li><li><div>define( 'BP_XPROFILE_WP_USER_SYNC_VERSION', '0.6.4' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// store reference to this file</span>&nbsp;</div></li><li><div>if ( ! defined( 'BP_XPROFILE_WP_USER_SYNC_FILE' ) ) {&nbsp;</div></li><li><div>  define( 'BP_XPROFILE_WP_USER_SYNC_FILE', __FILE__ );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// store URL to this plugin's directory</span>&nbsp;</div></li><li><div>if ( ! defined( 'BP_XPROFILE_WP_USER_SYNC_URL' ) ) {&nbsp;</div></li><li><div>  define( 'BP_XPROFILE_WP_USER_SYNC_URL', plugin_dir_url( BP_XPROFILE_WP_USER_SYNC_FILE ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">// store PATH to this plugin's directory</span>&nbsp;</div></li><li><div>if ( ! defined( 'BP_XPROFILE_WP_USER_SYNC_PATH' ) ) {&nbsp;</div></li><li><div>  define( 'BP_XPROFILE_WP_USER_SYNC_PATH', plugin_dir_path( BP_XPROFILE_WP_USER_SYNC_FILE ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * BP XProfile WordPress User Sync Plugin Class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * A class that encapsulates plugin functionality.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class BpXProfileWordPressUserSync {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Plugin Options.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @var array $options The plugin options array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $options = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// get options array, if it exists</span></span>&nbsp;</div></li><li><div>      $this-&gt;options = get_option( 'bp_xp_wp_sync_options', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add action for plugin init</span>&nbsp;</div></li><li><div>      add_action( 'bp_init', array( $this, 'register_hooks' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// use translation</span>&nbsp;</div></li><li><div>      add_action( 'plugins_loaded', array( $this, 'translation' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Loads translation, if present.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function translation() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// only use, if we have it...</span>&nbsp;</div></li><li><div>      if ( function_exists( 'load_plugin_textdomain' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// not used, as there are no translations as yet</span>&nbsp;</div></li><li><div>          load_plugin_textdomain(&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// unique name</span>&nbsp;</div></li><li><div>              'bp-xprofile-wp-user-sync', &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// deprecated argument</span>&nbsp;</div></li><li><div>              false, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// relative path to directory containing translation files</span>&nbsp;</div></li><li><div>              dirname( plugin_basename( BP_XPROFILE_WP_USER_SYNC_FILE ) ) . '/languages/'&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//##########################################################################</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Insert xProfile fields for &quot;First Name&quot; and &quot;Last Name&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function activate() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// bail if BuddyPress xProfile not active</span></span>&nbsp;</div></li><li><div>      if ( ! bp_is_active( 'xprofile' ) ) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// are we re-activating?</span></span>&nbsp;</div></li><li><div>      $reactivating = ( get_option( 'bp_xp_wp_sync_installed', 'false' ) === 'true' ) ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// before we create our fields, test if we're reactivating...</span>&nbsp;</div></li><li><div>      if ( $reactivating ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// yes, get existing field data</span>&nbsp;</div></li><li><div>          $existing_fields = get_option( 'bp_xp_wp_sync_options_store', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// if we're reactivating after an upgrade from a version that does not</span>&nbsp;</div></li><li><div>          <span class="comment">// have the code to salvage the connection between fields and data...</span>&nbsp;</div></li><li><div>          if ( empty( $existing_fields ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// hmm...</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// first name field</span></span>&nbsp;</div></li><li><div>              $existing_first_name_field_id = $existing_fields['first_name_field_id'];&nbsp;</div></li><li><div>              $existing_first_name_field_name = $existing_fields['first_name_field_name'];&nbsp;</div></li><li><div>              $existing_first_name_field_desc = $existing_fields['first_name_field_desc'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// first name field</span></span>&nbsp;</div></li><li><div>              $existing_last_name_field_id = $existing_fields['last_name_field_id'];&nbsp;</div></li><li><div>              $existing_last_name_field_name = $existing_fields['last_name_field_name'];&nbsp;</div></li><li><div>              $existing_last_name_field_desc = $existing_fields['last_name_field_desc'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// &quot;First Name&quot; field</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set field name</span></span>&nbsp;</div></li><li><div>      $name = __( 'First Name', 'bp-xprofile-wp-user-sync' );&nbsp;</div></li><li><div>      if ( isset( $existing_first_name_field_name ) ) {&nbsp;</div></li><li><div>          $name = $existing_first_name_field_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set field description</span></span>&nbsp;</div></li><li><div>      $description = '';&nbsp;</div></li><li><div>      if ( isset( $existing_first_name_field_desc ) ) {&nbsp;</div></li><li><div>          $description = $existing_first_name_field_desc;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// get id of field</span></span>&nbsp;</div></li><li><div>      $first_name_field_id = $this-&gt;_create_field( $name, $description );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// &quot;Last Name&quot; field</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set field name</span></span>&nbsp;</div></li><li><div>      $name = __( 'Last Name', 'bp-xprofile-wp-user-sync' );&nbsp;</div></li><li><div>      if ( isset( $existing_last_name_field_name ) ) {&nbsp;</div></li><li><div>          $name = $existing_last_name_field_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set field description</span></span>&nbsp;</div></li><li><div>      $description = '';&nbsp;</div></li><li><div>      if ( isset( $existing_last_name_field_desc ) ) {&nbsp;</div></li><li><div>          $description = $existing_last_name_field_desc;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// get id of field</span></span>&nbsp;</div></li><li><div>      $last_name_field_id = $this-&gt;_create_field( $name, $description );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// are we re-activating?</span></span>&nbsp;</div></li><li><div>      if ( $reactivating ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// reconnect data to fields</span>&nbsp;</div></li><li><div>          $this-&gt;_reconnect_field( $existing_first_name_field_id, $first_name_field_id );&nbsp;</div></li><li><div>          $this-&gt;_reconnect_field( $existing_last_name_field_id, $last_name_field_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// delete storage array</span>&nbsp;</div></li><li><div>          delete_option( 'bp_xp_wp_sync_options_store' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// add to options</span></span>&nbsp;</div></li><li><div>          $this-&gt;options['first_name_field_id'] = $existing_first_name_field_id;&nbsp;</div></li><li><div>          $this-&gt;options['last_name_field_id'] = $existing_last_name_field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// update options array</span>&nbsp;</div></li><li><div>          update_option( 'bp_xp_wp_sync_options', $this-&gt;options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// add to options</span></span>&nbsp;</div></li><li><div>          $this-&gt;options['first_name_field_id'] = $first_name_field_id;&nbsp;</div></li><li><div>          $this-&gt;options['last_name_field_id'] = $last_name_field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// save options array</span>&nbsp;</div></li><li><div>          add_option( 'bp_xp_wp_sync_options', $this-&gt;options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Set installed flag</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * We can't retain fields when the plugin is deactivated, but the field</span>&nbsp;</div></li><li><div><span class="comment">           * data does survive and we'll try and reconnect it when the plugin is</span>&nbsp;</div></li><li><div><span class="comment">           * reactivated.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          add_option( 'bp_xp_wp_sync_installed', 'true' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Actions to perform on plugin deactivation. (NOT deletion)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function deactivate() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * There seems to be no way to hide the xProfile fields once they have</span>&nbsp;</div></li><li><div><span class="comment">       * been created, so we're left with no option but to lose the data when</span>&nbsp;</div></li><li><div><span class="comment">       * we deactivate the plugin :-(</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * The 'bp_xp_wp_sync_options_store' option is an attempt at a workaround</span>&nbsp;</div></li><li><div><span class="comment">       * but will not work if an older version of the plugin is deactivated and</span>&nbsp;</div></li><li><div><span class="comment">       * a newer one is then activated, since no bridging data will have been</span>&nbsp;</div></li><li><div><span class="comment">       * saved. Have updated the readme to flag this.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Also, we can't use BP's API because we can't set 'can_delete' in BP 1.7</span>&nbsp;</div></li><li><div><span class="comment">       * so we bypass it and manipulate the field directly</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// init storage array</span>&nbsp;</div></li><li><div>      $options = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// bail if BuddyPress xProfile not active</span></span>&nbsp;</div></li><li><div>      if ( ! bp_is_active( 'xprofile' ) ) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get first_name xProfile field</span>&nbsp;</div></li><li><div>      $field = new BP_XProfile_Field( $this-&gt;options['first_name_field_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// store data about first name field</span></span>&nbsp;</div></li><li><div>      $options['first_name_field_id'] = $field-&gt;id;&nbsp;</div></li><li><div>      $options['first_name_field_name'] = $field-&gt;name;&nbsp;</div></li><li><div>      $options['first_name_field_desc'] = $field-&gt;description;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// delete first_name xProfile field</span>&nbsp;</div></li><li><div>      $field-&gt;can_delete = 1;&nbsp;</div></li><li><div>      $field-&gt;delete();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get last_name xProfile field</span>&nbsp;</div></li><li><div>      $field = new BP_XProfile_Field( $this-&gt;options['last_name_field_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// store data about first name field</span></span>&nbsp;</div></li><li><div>      $options['last_name_field_id'] = $field-&gt;id;&nbsp;</div></li><li><div>      $options['last_name_field_name'] = $field-&gt;name;&nbsp;</div></li><li><div>      $options['last_name_field_desc'] = $field-&gt;description;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// delete last_name xProfile field</span>&nbsp;</div></li><li><div>      $field-&gt;can_delete = 1;&nbsp;</div></li><li><div>      $field-&gt;delete();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// save our storage array</span>&nbsp;</div></li><li><div>      add_option( 'bp_xp_wp_sync_options_store', $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// delete our options array</span>&nbsp;</div></li><li><div>      delete_option( 'bp_xp_wp_sync_options' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Register hooks when BuddyPress has initialised.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function register_hooks() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// do we have a version of BuddyPress capable of pre-filtering?</span>&nbsp;</div></li><li><div>      if ( function_exists( 'bp_parse_args' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// use bp_parse_args post-parse filter (available since BP 2.0)</span>&nbsp;</div></li><li><div>          add_filter( 'bp_after_has_profile_parse_args', array( $this, 'intercept_profile_query_args' ), 30, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// exclude the default name field type on profile edit and registration</span>&nbsp;</div></li><li><div>          <span class="comment">// screens and exclude our fields on profile view screen</span>&nbsp;</div></li><li><div>          add_filter( 'bp_has_profile', array( $this, 'intercept_profile_query' ), 30, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// exclude the default name field type on profile fields admin screen (available since BP 2.1)</span>&nbsp;</div></li><li><div>      add_filter( 'bp_xprofile_get_groups', array( $this, 'intercept_profile_fields_query' ), 30, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// populate our fields on user registration and update by admins</span>&nbsp;</div></li><li><div>      add_action( 'user_register', array( $this, 'intercept_wp_user_update' ), 30, 1 );&nbsp;</div></li><li><div>      add_action( 'profile_update', array( $this, 'intercept_wp_user_update' ), 30, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// remove 'user_register' and 'profile_update' hooks and add post-update hooks</span>&nbsp;</div></li><li><div>      add_action( 'xprofile_updated_profile', array( $this, 'intercept_wp_profile_sync' ), 9, 3 );&nbsp;</div></li><li><div>      add_action( 'bp_core_signup_user', array( $this, 'intercept_wp_profile_sync' ), 9, 3 );&nbsp;</div></li><li><div>      add_action( 'bp_core_activated_user', array( $this, 'intercept_wp_profile_sync' ), 9, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// compatibility with &quot;WP FB AutoConnect Premium&quot;</span>&nbsp;</div></li><li><div>      add_filter( 'wpfb_xprofile_fields_received', array( $this, 'intercept_wp_fb_profile_sync' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// compatibility with &quot;WooCommerce&quot;</span>&nbsp;</div></li><li><div>      add_action( 'woocommerce_save_account_details', array( $this, 'intercept_woo_user_update' ), 30, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Intercept xProfile query process and manage display of fields.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args The existing arguments used to query for fields</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $args The modified arguments used to query for fields</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_profile_query_args( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// if on profile view screen</span></span>&nbsp;</div></li><li><div>      if ( bp_is_user_profile() AND ! bp_is_user_profile_edit() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// get fields to exclude on profile view screen</span></span>&nbsp;</div></li><li><div>          $exclude_fields = $this-&gt;_get_excluded_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// merge with existing if populated</span></span></span></span>&nbsp;</div></li><li><div>          $args['exclude_fields'] = $this-&gt;_merge_excluded_fields( $args['exclude_fields'], $exclude_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// if on profile edit screen</span></span>&nbsp;</div></li><li><div>      if ( bp_is_user_profile_edit() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// exclude name field</span></span></span></span> (bp_xprofile_fullname_field_id is available since BP 2.0)</span></span>&nbsp;</div></li><li><div>          $exclude_fields = bp_xprofile_fullname_field_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// merge with existing if populated</span></span></span></span>&nbsp;</div></li><li><div>          $args['exclude_fields'] = $this-&gt;_merge_excluded_fields( $args['exclude_fields'], $exclude_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Apply to registration form whichever page it is displayed on, whilst avoiding</span>&nbsp;</div></li><li><div><span class="comment">       * splitting the Name field into First Name and Last Name fields in the profile</span>&nbsp;</div></li><li><div><span class="comment">       * display loop of the user. Note that we cannot determine if we are in the loop</span>&nbsp;</div></li><li><div><span class="comment">       * prior to the query, so we test for an empty user ID instead.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if (&nbsp;</div></li><li><div>          ! is_user_logged_in() <span class="comment">// user must be logged out</span>&nbsp;</div></li><li><div>          AND&nbsp;</div></li><li><div>          ( ! bp_is_user_profile() OR ( bp_is_user_profile() AND empty( $args['user_id'] ) ) )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// query only group 1</span></span></span></span>&nbsp;</div></li><li><div>          $args['profile_group_id'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// exclude name field</span></span></span></span> (bp_xprofile_fullname_field_id is available since BP 2.0)</span></span>&nbsp;</div></li><li><div>          $exclude_fields = bp_xprofile_fullname_field_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// merge with existing if populated</span></span></span></span>&nbsp;</div></li><li><div>          $args['exclude_fields'] = $this-&gt;_merge_excluded_fields( $args['exclude_fields'], $exclude_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// --&lt;</span></span></span></span></span></span>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Intercept xProfile query process and manage display of fields.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $has_groups</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $profile_template</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean $has_groups</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_profile_query( $has_groups, $profile_template ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// init args</span>&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// if on profile view screen</span></span>&nbsp;</div></li><li><div>      if ( bp_is_user_profile() AND ! bp_is_user_profile_edit() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// get fields to exclude on profile view screen</span></span>&nbsp;</div></li><li><div>          $args['exclude_fields'] = $this-&gt;_get_excluded_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// if on profile edit screen</span></span>&nbsp;</div></li><li><div>      if ( bp_is_user_profile_edit() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// check which profile group is being queried</span></span>&nbsp;</div></li><li><div>          if (&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              isset( $profile_template-&gt;groups ) AND&nbsp;</div></li><li><div>              is_array( $profile_template-&gt;groups ) AND&nbsp;</div></li><li><div>              count( $profile_template-&gt;groups ) &gt; 0&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// don't want to pop, so loop through them</span></span>&nbsp;</div></li><li><div>              foreach( $profile_template-&gt;groups AS $group ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// is this the base group?</span></span>&nbsp;</div></li><li><div>                  if ( $group-&gt;id == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// query only group 1</span></span></span></span>&nbsp;</div></li><li><div>                      $args['profile_group_id'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">// get field id from name</span></span></span>&nbsp;</div></li><li><div>                      $fullname_field_id = xprofile_get_field_id_from_name( bp_xprofile_fullname_field_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// exclude name field</span></span></span></span>&nbsp;</div></li><li><div>                      $args['exclude_fields'] = $fullname_field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// only the first</span></span>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// determine if we are currently in the profile display loop</span>&nbsp;</div></li><li><div>      $in_loop = false;&nbsp;</div></li><li><div>      if ( isset( $profile_template-&gt;in_the_loop ) AND $profile_template-&gt;in_the_loop === true ) {&nbsp;</div></li><li><div>          $in_loop = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Apply to registration form whichever page it is displayed on, whilst avoiding</span>&nbsp;</div></li><li><div><span class="comment">       * splitting the Name field into First Name and Last Name fields in the profile</span>&nbsp;</div></li><li><div><span class="comment">       * display loop of the user. Props https://github.com/sbrajesh</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( ! is_user_logged_in() AND ( ! bp_is_user_profile() OR bp_is_user_profile() AND ! $in_loop ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// query only group 1</span></span></span></span>&nbsp;</div></li><li><div>          $args['profile_group_id'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// get field id from name</span></span></span>&nbsp;</div></li><li><div>          $fullname_field_id = xprofile_get_field_id_from_name( bp_xprofile_fullname_field_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// exclude name field</span></span></span></span>&nbsp;</div></li><li><div>          $args['exclude_fields'] = $fullname_field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// test for new BP xProfile admin screen</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get BuddyPress instance</span>&nbsp;</div></li><li><div>      $bp = buddypress();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// test for new BP_Members_Admin object</span>&nbsp;</div></li><li><div>      if( isset( $bp-&gt;profile-&gt;admin ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// check which profile group is being queried</span></span>&nbsp;</div></li><li><div>          if (&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              isset( $profile_template-&gt;groups ) AND&nbsp;</div></li><li><div>              is_array( $profile_template-&gt;groups ) AND&nbsp;</div></li><li><div>              count( $profile_template-&gt;groups ) &gt; 0&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// don't want to pop, so loop through them</span></span>&nbsp;</div></li><li><div>              foreach( $profile_template-&gt;groups AS $group ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// is this the base group?</span></span>&nbsp;</div></li><li><div>                  if ( $group-&gt;id == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                       * BP_XProfile_User_Admin queries prior to the loop, so</span>&nbsp;</div></li><li><div><span class="comment">                       * do we have the fields populated?</span>&nbsp;</div></li><li><div><span class="comment">                       * see BP_XProfile_User_Admin-&gt;register_metaboxes()</span>&nbsp;</div></li><li><div><span class="comment">                       */</span>&nbsp;</div></li><li><div>                      if ( isset( $group-&gt;fields ) AND is_array( $group-&gt;fields ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// get user ID</span>&nbsp;</div></li><li><div>                          $user_id = isset( $_GET['user_id'] ) ? intval( $_GET['user_id'] ) : 0 ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// only edit other users profiles</span>&nbsp;</div></li><li><div>                          if ( $user_id AND get_current_user_id() != $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// query only group 1</span></span></span></span>&nbsp;</div></li><li><div>                              $args['profile_group_id'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment">// query only for this user</span>&nbsp;</div></li><li><div>                              $args['user_id'] = $user_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment"><span class="comment"><span class="comment">// get field id from name</span></span></span>&nbsp;</div></li><li><div>                              $fullname_field_id = xprofile_get_field_id_from_name( bp_xprofile_fullname_field_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// exclude name field</span></span></span></span>&nbsp;</div></li><li><div>                              $args['exclude_fields'] = $fullname_field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// only the first</span></span>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// do we need to recreate query?</span>&nbsp;</div></li><li><div>      if ( count( $args ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// ditch our filter so we don't create an endless loop</span>&nbsp;</div></li><li><div>          remove_filter( 'bp_has_profile', array( $this, 'intercept_profile_query' ), 30 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// recreate profile_template</span>&nbsp;</div></li><li><div>          $has_groups = bp_has_profile( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add our filter again in case there are any other calls to bp_has_profile</span>&nbsp;</div></li><li><div>          add_filter( 'bp_has_profile', array( $this, 'intercept_profile_query' ), 30, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// --&lt;</span></span></span></span></span></span>&nbsp;</div></li><li><div>      return $has_groups;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Intercept xprofile query process and manage display of fields.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $groups The xProfile groups</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args The arguments</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_profile_fields_query( $groups, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// bail if not in admin</span>&nbsp;</div></li><li><div>      if ( ! is_admin() ) return $groups;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// exclude name field</span></span></span></span>&nbsp;</div></li><li><div>      $args['exclude_fields'] = bp_xprofile_fullname_field_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// re-query the groups</span>&nbsp;</div></li><li><div>      $groups = BP_XProfile_Group::get( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// --&lt;</span></span></span></span></span></span>&nbsp;</div></li><li><div>      return $groups;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Intercept WP user registration and profile updates in WP Admin screens.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param integer $user_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_wp_user_update( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// only map data when the site admin is adding users, not on registration.</span>&nbsp;</div></li><li><div>      if ( ! is_admin() ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// pass to method</span></span>&nbsp;</div></li><li><div>      $this-&gt;_user_update( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Intercept WooCommerce profile updates.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.6.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param integer $user_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_woo_user_update( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// pass to method</span></span>&nbsp;</div></li><li><div>      $this-&gt;_user_update( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Intercept BP core's attempt to sync to WP user profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param integer $user_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $posted_field_ids</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $errors</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_wp_profile_sync( $user_id = 0, $posted_field_ids, $errors ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// bail if profile syncing is disabled</span></span>&nbsp;</div></li><li><div>      if ( bp_disable_profile_sync() ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>          $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// remove our hooks</span></span></span>&nbsp;</div></li><li><div>      remove_action( 'user_register', array( $this, 'intercept_wp_user_update' ), 30 );&nbsp;</div></li><li><div>      remove_action( 'profile_update', array( $this, 'intercept_wp_user_update' ), 30 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// after xprofile_sync_wp_profile runs, re-sync with correct values</span>&nbsp;</div></li><li><div>      add_action( 'xprofile_updated_profile', array( $this, 'intercept_wp_profile_sync_patch' ), 11, 3 );&nbsp;</div></li><li><div>      add_action( 'bp_core_signup_user', array( $this, 'intercept_wp_profile_sync_patch' ), 11, 3 );&nbsp;</div></li><li><div>      add_action( 'bp_core_activated_user', array( $this, 'intercept_wp_profile_sync_patch' ), 11, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Overwrite BP core's attempt to sync to WP user profile.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.6.4</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param integer $user_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $posted_field_ids</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $errors</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_wp_profile_sync_patch( $user_id = 0, $posted_field_ids, $errors ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// bail if profile syncing is disabled</span></span>&nbsp;</div></li><li><div>      if ( bp_disable_profile_sync() ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>          $user_id = bp_loggedin_user_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get our user's first name</span>&nbsp;</div></li><li><div>      $first_name = xprofile_get_field_data(&nbsp;</div></li><li><div>          $this-&gt;options['first_name_field_id'], &nbsp;</div></li><li><div>          $user_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get our user's last name</span>&nbsp;</div></li><li><div>      $last_name = xprofile_get_field_data(&nbsp;</div></li><li><div>          $this-&gt;options['last_name_field_id'], &nbsp;</div></li><li><div>          $user_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// concatenate as per BP core</span>&nbsp;</div></li><li><div>      $name = $first_name . ' ' . $last_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Overwrite default name field for this user.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * We have to do this because the BuddyPress sync routine does not always</span>&nbsp;</div></li><li><div><span class="comment">       * split names correctly, particularly when either the first name or the</span>&nbsp;</div></li><li><div><span class="comment">       * last name consists of multipe words, e.g. &quot;Michael John&quot; &quot;Smith&quot;.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      xprofile_set_field_data( bp_xprofile_fullname_field_name(), $user_id, $name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// remove our hooks</span></span></span>&nbsp;</div></li><li><div>      remove_action( 'user_register', array( $this, 'intercept_wp_user_update' ), 30 );&nbsp;</div></li><li><div>      remove_action( 'profile_update', array( $this, 'intercept_wp_user_update' ), 30 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// now replicate BuddyPress sync procedure</span>&nbsp;</div></li><li><div>      bp_update_user_meta( $user_id, 'nickname', $name );&nbsp;</div></li><li><div>      bp_update_user_meta( $user_id, 'first_name', $first_name );&nbsp;</div></li><li><div>      bp_update_user_meta( $user_id, 'last_name', $last_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_update_user( array( 'ID' =&gt; $user_id, 'display_name' =&gt; $name ) );&nbsp;</div></li><li><div>      wp_cache_delete( 'bp_core_userdata_' . $user_id, 'bp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Compatibility with &quot;WP FB AutoConnect Premium&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $facebook_user</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $facebook_user</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function intercept_wp_fb_profile_sync( $facebook_user, $wp_user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * When xProfiles are updated, BuddyPress sets user nickname and display name</span>&nbsp;</div></li><li><div><span class="comment">       * so WP FB AutoConnect Premium should do too. To do so, alter line 1315 or so:</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * //A filter so 3rd party plugins can process any extra fields they might need</span>&nbsp;</div></li><li><div><span class="comment">       * $fbuser = apply_filters('wpfb_xprofile_fields_received', $fbuser, $args['WP_ID']);</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set user nickname</span></span>&nbsp;</div></li><li><div>      bp_update_user_meta( $wp_user_id, 'nickname', $facebook_user['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// access db</span>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// set user display name - see xprofile_sync_wp_profile()</span></span>&nbsp;</div></li><li><div>      $wpdb-&gt;query(&nbsp;</div></li><li><div>          $wpdb-&gt;prepare(&nbsp;</div></li><li><div>              &quot;UPDATE {$wpdb-&gt;users} SET display_name = %s WHERE ID = %d&quot;, &nbsp;</div></li><li><div>              $facebook_user['name'], &nbsp;</div></li><li><div>              $wp_user_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// pass it on</span>&nbsp;</div></li><li><div>      return $facebook_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">//##########################################################################</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Do WP user update process and populate our fields.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note that BuddyPress updates the &quot;Name&quot; field before wp_insert_user or</span>&nbsp;</div></li><li><div><span class="comment">   * wp_update_user get called - it hooks into 'user_profile_update_errors'</span>&nbsp;</div></li><li><div><span class="comment">   * instead. So, there are two options: either hook into the same action or</span>&nbsp;</div></li><li><div><span class="comment">   * call the same function below. Until I raise this as an issue (ie, why do</span>&nbsp;</div></li><li><div><span class="comment">   * database operations via an action designed to collate errors) I'll</span>&nbsp;</div></li><li><div><span class="comment">   * temporarily call the same function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.6.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param integer $user_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function _user_update( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// populate the user's first and last names</span>&nbsp;</div></li><li><div>      if ( bp_is_active( 'xprofile' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// get first name</span>&nbsp;</div></li><li><div>          $first_name = bp_get_user_meta( $user_id, 'first_name', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// get last name</span>&nbsp;</div></li><li><div>          $last_name = bp_get_user_meta( $user_id, 'last_name', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// if nothing set...</span>&nbsp;</div></li><li><div>          if ( empty( $first_name ) AND empty( $last_name ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// get nickname instead</span>&nbsp;</div></li><li><div>              $nickname = bp_get_user_meta( $user_id, 'nickname', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// does it have a space in it? (use core BP logic)</span>&nbsp;</div></li><li><div>              $space = strpos( $nickname, ' ' );&nbsp;</div></li><li><div>              if ( false === $space ) {&nbsp;</div></li><li><div>                  $first_name = $nickname;&nbsp;</div></li><li><div>                  $last_name = '';&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $first_name = substr( $nickname, 0, $space );&nbsp;</div></li><li><div>                  $last_name = trim( substr( $nickname, $space, strlen( $nickname ) ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * In multisite when not on the main blog, our options are not loaded</span>&nbsp;</div></li><li><div><span class="comment">           * because I mistakenly failed to use a site_option instead of a blog</span>&nbsp;</div></li><li><div><span class="comment">           * option. At the moment, there's little I can do except to switch to</span>&nbsp;</div></li><li><div><span class="comment">           * the BP root blog and grab the values from there. I assume this</span>&nbsp;</div></li><li><div><span class="comment">           * won't be a common occurrence and therefore that this won't cause</span>&nbsp;</div></li><li><div><span class="comment">           * too much of an overhead.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// test for site other than main site</span>&nbsp;</div></li><li><div>          if ( is_multisite() AND ! is_main_site() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// switch to main blog</span>&nbsp;</div></li><li><div>              switch_to_blog( bp_get_root_blog_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// get options array, if it exists</span></span>&nbsp;</div></li><li><div>              $this-&gt;options = get_option( 'bp_xp_wp_sync_options', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// switch back</span>&nbsp;</div></li><li><div>              restore_current_blog();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// test for one of our options</span>&nbsp;</div></li><li><div>          if ( isset( $this-&gt;options['first_name_field_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// update first_name field</span>&nbsp;</div></li><li><div>              xprofile_set_field_data(&nbsp;</div></li><li><div>                  $this-&gt;options['first_name_field_id'], &nbsp;</div></li><li><div>                  $user_id, &nbsp;</div></li><li><div>                  $first_name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// update last_name field</span>&nbsp;</div></li><li><div>              xprofile_set_field_data(&nbsp;</div></li><li><div>                  $this-&gt;options['last_name_field_id'], &nbsp;</div></li><li><div>                  $user_id, &nbsp;</div></li><li><div>                  $last_name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * When xProfiles are updated, BuddyPress sets user nickname and</span>&nbsp;</div></li><li><div><span class="comment">           * display name so we should too...</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// construct full name</span>&nbsp;</div></li><li><div>          $full_name = $first_name . ' ' . $last_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// set user nickname</span></span>&nbsp;</div></li><li><div>          bp_update_user_meta( $user_id, 'nickname', $full_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// remove our hooks</span></span></span>&nbsp;</div></li><li><div>          remove_action( 'user_register', array( $this, 'intercept_wp_user_update' ), 30 );&nbsp;</div></li><li><div>          remove_action( 'profile_update', array( $this, 'intercept_wp_user_update' ), 30 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// set user display name - see xprofile_sync_wp_profile()</span></span>&nbsp;</div></li><li><div>          wp_update_user( array( 'ID' =&gt; $user_id, 'display_name' =&gt; $full_name ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// see notes above regarding when BuddyPress updates the &quot;Name&quot; field</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// update BuddyPress &quot;Name&quot; field directly</span>&nbsp;</div></li><li><div>          xprofile_set_field_data(&nbsp;</div></li><li><div>              bp_xprofile_fullname_field_name(), &nbsp;</div></li><li><div>              $user_id, &nbsp;</div></li><li><div>              $full_name&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create a field with a given name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.1</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param str $field_name The name of the field</span>&nbsp;</div></li><li><div><span class="comment">   * @param str $field_description The field description</span>&nbsp;</div></li><li><div><span class="comment">   * @return int $field_id True on success, false on failure</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function _create_field( $field_name, $field_description = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// common field attributes</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// default group</span>&nbsp;</div></li><li><div>      $field_group_id = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// no parent</span>&nbsp;</div></li><li><div>      $parent_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// text</span>&nbsp;</div></li><li><div>      $type = 'textbox';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// name from passed value</span>&nbsp;</div></li><li><div>      $name = $field_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// description</span>&nbsp;</div></li><li><div>      $description = $field_description;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// required (note: super admins can always edit)</span>&nbsp;</div></li><li><div>      $is_required = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// cannot be deleted</span>&nbsp;</div></li><li><div>      $can_delete = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// construct data to save</span>&nbsp;</div></li><li><div>      $data = compact(&nbsp;</div></li><li><div>          array( 'field_group_id', 'parent_id', 'type', 'name', 'description', 'is_required', 'can_delete' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// use bp function to get new field ID</span>&nbsp;</div></li><li><div>      $field_id = xprofile_insert_field( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// die if unsuccessful</span>&nbsp;</div></li><li><div>      if ( ! is_numeric( $field_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// construct message</span></span></span></span>&nbsp;</div></li><li><div>          $msg = __(&nbsp;</div></li><li><div>              'BP XProfile WordPress User Sync plugin: Could not create xProfile field', &nbsp;</div></li><li><div>              'bp-xprofile-wp-user-sync'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// use var_dump as this seems to display in the iframe</span></span></span></span>&nbsp;</div></li><li><div>          var_dump( $msg ); die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// disable custom visibility</span>&nbsp;</div></li><li><div>      bp_xprofile_update_field_meta(&nbsp;</div></li><li><div>          $field_id, &nbsp;</div></li><li><div>          'allow_custom_visibility', &nbsp;</div></li><li><div>          'disabled'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// BuddyPress 1.7 seems to overlook our 'can_delete' setting</span>&nbsp;</div></li><li><div>      <span class="comment">// Fixed in BuddyPress 1.9, but leave the check below for older versions</span>&nbsp;</div></li><li><div>      $field = new BP_XProfile_Field( $field_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// let's see if our new field is correctly set</span>&nbsp;</div></li><li><div>      if ( $field-&gt;can_delete != 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// we'll need these to manually update</span>, because the API can't do it</span>&nbsp;</div></li><li><div>          global $wpdb, $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// construct query</span></span>&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>              &quot;UPDATE {$bp-&gt;profile-&gt;table_name_fields} SET can_delete = %d WHERE id = %d&quot;, &nbsp;</div></li><li><div>              0, &nbsp;</div></li><li><div>              $field_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// we must have one row affected</span></span>&nbsp;</div></li><li><div>          if ( $wpdb-&gt;query( $sql ) !== 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// construct message</span></span></span></span>&nbsp;</div></li><li><div>              $msg = __(&nbsp;</div></li><li><div>                  'BP XProfile WordPress User Sync plugin: Could not set &quot;can_delete&quot; for xProfile field', &nbsp;</div></li><li><div>                  'bp-xprofile-wp-user-sync'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment"><span class="comment">// use var_dump as this seems to display in the iframe</span></span></span></span>&nbsp;</div></li><li><div>              var_dump( $msg ); die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// --&lt;</span></span></span></span></span></span>&nbsp;</div></li><li><div>      return $field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update a field with a given ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * The idea here is to try and reconnect the &quot;orphaned&quot; field data with the</span>&nbsp;</div></li><li><div><span class="comment">   * field definition by changing the auto-incremented ID of the field back to</span>&nbsp;</div></li><li><div><span class="comment">   * its original value. This should work because the original value should not</span>&nbsp;</div></li><li><div><span class="comment">   * have been reused unless the table has been truncated and the auto-increment</span>&nbsp;</div></li><li><div><span class="comment">   * value reset.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.5</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $old_field_id The previous ID of the field</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $new_field_id The new ID of the field</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True if update successful</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function _reconnect_field( $old_field_id, $new_field_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// we'll need these to manually update</span>&nbsp;</div></li><li><div>      global $wpdb, $bp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check if old field exists</span>&nbsp;</div></li><li><div>      $field = new BP_XProfile_Field( $old_field_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if it does, we've got a bigger problem...</span>&nbsp;</div></li><li><div>      if ( isset( $field-&gt;id ) AND $field-&gt;id == $old_field_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// construct message</span></span></span></span>&nbsp;</div></li><li><div>          $msg = __(&nbsp;</div></li><li><div>              'BP XProfile WordPress User Sync plugin: An xProfile field with that ID already exists. Cannot reconnect data.', &nbsp;</div></li><li><div>              'bp-xprofile-wp-user-sync'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// use var_dump as this seems to display in the iframe</span></span></span></span>&nbsp;</div></li><li><div>          var_dump( $msg ); die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// construct query</span></span>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>          &quot;UPDATE {$bp-&gt;profile-&gt;table_name_fields} SET id = %d WHERE id = %d&quot;, &nbsp;</div></li><li><div>          $old_field_id, &nbsp;</div></li><li><div>          $new_field_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// we must have one row affected</span></span>&nbsp;</div></li><li><div>      if ( $wpdb-&gt;query( $sql ) !== 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// construct message</span></span></span></span>&nbsp;</div></li><li><div>          $msg = __(&nbsp;</div></li><li><div>              'BP XProfile WordPress User Sync plugin: Could not update &quot;ID&quot; for xProfile field. SQL = ' . $sql, &nbsp;</div></li><li><div>              'bp-xprofile-wp-user-sync'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment"><span class="comment">// use var_dump as this seems to display in the iframe</span></span></span></span>&nbsp;</div></li><li><div>          var_dump( $msg ); die();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// --&lt;</span></span></span></span></span></span>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get excluded fields on Profile View.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.5.2</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $exclude_fields Comma-separated list of field IDs</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function _get_excluded_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// comma-delimit our fields</span>&nbsp;</div></li><li><div>      $exclude_fields = implode( ', ', $this-&gt;options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Exclude our xprofile fields, but allow filtering. The relevant params</span>&nbsp;</div></li><li><div><span class="comment">       * are passed to the filter so that other plugins can make an informed</span>&nbsp;</div></li><li><div><span class="comment">       * choice of what to return.</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * To retain the first name and last name fields, an appropriate way to</span>&nbsp;</div></li><li><div><span class="comment">       * do this would look something like:</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * add_filter( 'bp_xprofile_wp_user_sync_exclude_fields', 'my_function' );</span>&nbsp;</div></li><li><div><span class="comment">       * function my_function( $exclude_fields ) {</span>&nbsp;</div></li><li><div><span class="comment">       *     return bp_xprofile_fullname_field_id();</span>&nbsp;</div></li><li><div><span class="comment">       * }</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param string $exclude_fields Comma-delimited pseudo-array of custom fields</span>&nbsp;</div></li><li><div><span class="comment">       * @param array $options Array of custom field IDs</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      return apply_filters(&nbsp;</div></li><li><div>          'bp_xprofile_wp_user_sync_exclude_fields', &nbsp;</div></li><li><div>          $exclude_fields, &nbsp;</div></li><li><div>          $this-&gt;options&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Merge excluded fields on Profile View.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 0.5.3</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $excluded_fields Comma-delimited list of fields already excluded</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $exclude_fields Comma-delimited list of fields requiring exclusion</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $excluded_fields Comma-delimited list of all fields to be excluded</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function _merge_excluded_fields( $excluded_fields, $exclude_fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if params are not arrays already, convert them</span>&nbsp;</div></li><li><div>      if ( ! is_array( $excluded_fields ) ) $excluded_fields = explode( ', ', $excluded_fields );&nbsp;</div></li><li><div>      if ( ! is_array( $exclude_fields ) ) $exclude_fields = explode( ', ', $exclude_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// merge with existing if populated</span></span></span></span>&nbsp;</div></li><li><div>      if ( ! empty( $excluded_fields ) ) {&nbsp;</div></li><li><div>          $excluded_fields = array_unique( array_merge( $excluded_fields, $exclude_fields ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $excluded_fields = $exclude_fields;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// --&lt;</span></span></span></span></span></span>&nbsp;</div></li><li><div>      return implode( ', ', $excluded_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>} <span class="comment">// class ends</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// declare as global</span>&nbsp;</div></li><li><div>global $bp_xprofile_wordpress_user_sync;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// init plugin</span>&nbsp;</div></li><li><div>$bp_xprofile_wordpress_user_sync = new BpXProfileWordPressUserSync;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// activation</span>&nbsp;</div></li><li><div>register_activation_hook( __FILE__, array( $bp_xprofile_wordpress_user_sync, 'activate' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// deactivation</span>&nbsp;</div></li><li><div>register_deactivation_hook( __FILE__, array( $bp_xprofile_wordpress_user_sync, 'deactivate' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// uninstall will use the 'uninstall.php' method when xProfile fields can be &quot;deactivated&quot;</span>&nbsp;</div></li><li><div><span class="comment">// see: http://codex.wordpress.org/Function_Reference/register_uninstall_hook</span>&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>BP XProfile WordPress User Sync</li><li><span></span>0.6.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>