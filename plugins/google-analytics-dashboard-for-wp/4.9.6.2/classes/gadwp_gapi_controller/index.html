<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="4.9.6.2" data-slug="google-analytics-dashboard-for-wp" data-type="class" data-id="11146"><head xmlns="http://www.w3.org/1999/xhtml"><title> gadwp_gapi_controller | class | Google Analytics Dashboard For Wp | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="GADWP_GAPI_Controller, class, plugin, google-analytics-dashboard-for-wp, 4.9.6.2" /><meta name="description" content="The Google Analytics Dashboard for WP GADWP GAPI Controller class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=091df2a606186ac4fd9e0bb2ee0cdab3' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/gadwp_gapi_controller/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgadwp_gapi_controller%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgadwp_gapi_controller%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-google-analytics-dashboard-for-wp-4.9.6.2-class-gadwp_gapi_controller","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gadwp_gapi_controller" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to google-analytics-dashboard-fo&hellip;." href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/" class="plugin"><span property="name">google-analytics-dashboard-fo&hellip;</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.9.6.2." href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/" class="H_VERSION"><span property="name">4.9.6.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gadwp_gapi_controller</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="196"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/all/" title="All">All <span class="count badge">196</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="9"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/hooks/" title="Hooks">Hooks <span class="count badge">9</span></a></li><li class="" data-id="action" data-count="1"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/actions/" title="Actions">Actions <span class="count badge">1</span></a></li><li class="" data-id="filter" data-count="8"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/filters/" title="Filters">Filters <span class="count badge">8</span></a></li><li class="active" data-id="class" data-count="181"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/classes/" title="Classes">Classes <span class="count badge">181</span></a></li><li class="" data-id="constant" data-count="4"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/constants/" title="Constants">Constants <span class="count badge">4</span></a></li><li class="" data-id="function" data-count="2"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/functions/" title="Functions">Functions <span class="count badge">2</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>GADWP_GAPI_Controller</strong></h1><p>The Google Analytics Dashboard for WP <strong>GADWP GAPI Controller</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/files/tools-gapi/" class="file">/tools/gapi.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="16" class="block" start="16"><li><div>final class GADWP_GAPI_Controller {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $client;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $service;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $timeshift;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $error_timeout;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $managequota;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $gadwp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $access = array( '65556128672.apps.googleusercontent.com', 'Kc7888wgbc_JbeCmApbFjnYpwE' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function __construct() {&nbsp;</div></li><li><div>        $this-&gt;gadwp = GADWP();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        include_once ( GADWP_DIR . 'tools/autoload.php' );&nbsp;</div></li><li><div>        $config = new Google_Config();&nbsp;</div></li><li><div>        $config-&gt;setCacheClass( 'Google_Cache_Null' );&nbsp;</div></li><li><div>        if ( function_exists( 'curl_version' ) ) {&nbsp;</div></li><li><div>            $curlversion = curl_version();&nbsp;</div></li><li><div>            $curl_options = array();&nbsp;</div></li><li><div>            if ( isset( $curlversion['version'] ) && ( version_compare( PHP_VERSION, '5.3.0' ) &gt;= 0 ) && version_compare( $curlversion['version'], '7.10.8' ) &gt;= 0 && defined( 'GADWP_IP_VERSION' ) && GADWP_IP_VERSION ) {&nbsp;</div></li><li><div>                $curl_options[CURLOPT_IPRESOLVE] = GADWP_IP_VERSION; // Force CURL_IPRESOLVE_V4 or CURL_IPRESOLVE_V6&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $curl_options = apply_filters( 'gadwp_curl_options', $curl_options );&nbsp;</div></li><li><div>            if ( ! empty( $curl_options ) ) {&nbsp;</div></li><li><div>                $config-&gt;setClassConfig( 'Google_IO_Curl', array( 'options' =&gt; $curl_options ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;client = new Google_Client( $config );&nbsp;</div></li><li><div>        $this-&gt;client-&gt;setScopes( 'https://www.googleapis.com/auth/analytics.readonly' );&nbsp;</div></li><li><div>        $this-&gt;client-&gt;setAccessType( 'offline' );&nbsp;</div></li><li><div>        $this-&gt;client-&gt;setApplicationName( 'Google Analytics Dashboard' );&nbsp;</div></li><li><div>        $this-&gt;client-&gt;setRedirectUri( 'urn:ietf:wg:oauth:2.0:oob' );&nbsp;</div></li><li><div>        $this-&gt;set_error_timeout();&nbsp;</div></li><li><div>        $this-&gt;managequota = 'u' . get_current_user_id() . 's' . get_current_blog_id();&nbsp;</div></li><li><div>        $this-&gt;access = array_map( array( $this, 'map' ), $this-&gt;access );&nbsp;</div></li><li><div>        if ( $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_userapi'] ) {&nbsp;</div></li><li><div>            $this-&gt;client-&gt;setClientId( $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_clientid'] );&nbsp;</div></li><li><div>            $this-&gt;client-&gt;setClientSecret( $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_clientsecret'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;client-&gt;setClientId( $this-&gt;access[0] );&nbsp;</div></li><li><div>            $this-&gt;client-&gt;setClientSecret( $this-&gt;access[1] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;service = new Google_Service_Analytics( $this-&gt;client );&nbsp;</div></li><li><div>        if ( $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_token'] ) {&nbsp;</div></li><li><div>            $token = $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_token'];&nbsp;</div></li><li><div>            if ( $token ) {&nbsp;</div></li><li><div>                try {&nbsp;</div></li><li><div>                    $this-&gt;client-&gt;setAccessToken( $token );&nbsp;</div></li><li><div>                    $gadwp-&gt;config-&gt;options['ga_dash_token'] = $this-&gt;client-&gt;getAccessToken();&nbsp;</div></li><li><div>                } catch ( Google_IO_Exception $e ) {&nbsp;</div></li><li><div>                    GADWP_Tools::set_cache( 'ga_dash_lasterror', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( $e ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>                } catch ( Google_Service_Exception $e ) {&nbsp;</div></li><li><div>                    GADWP_Tools::set_cache( 'ga_dash_lasterror', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( &quot;(&quot; . $e-&gt;getCode() . &quot;) &quot; . $e-&gt;getMessage() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>                    GADWP_Tools::set_cache( 'ga_dash_gapi_errors', array( $e-&gt;getCode(), (array) $e-&gt;getErrors() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>                    $this-&gt;reset_token();&nbsp;</div></li><li><div>                } catch ( Exception $e ) {&nbsp;</div></li><li><div>                    GADWP_Tools::set_cache( 'ga_dash_lasterror', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( $e ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>                    $this-&gt;reset_token();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_multisite() && $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_network'] ) {&nbsp;</div></li><li><div>                    $this-&gt;gadwp-&gt;config-&gt;set_plugin_options( true );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;gadwp-&gt;config-&gt;set_plugin_options();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function set_error_timeout() {&nbsp;</div></li><li><div>        $midnight = strtotime( &quot;tomorrow 00:00:00&quot; ); // UTC midnight&nbsp;</div></li><li><div>        $midnight = $midnight + 8 * 3600; // UTC 8 AM&nbsp;</div></li><li><div>        $this-&gt;error_timeout = $midnight - time();&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles errors returned by GAPI Library&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function gapi_errors_handler() {&nbsp;</div></li><li><div>        $errors = GADWP_Tools::get_cache( 'gapi_errors' );&nbsp;</div></li><li><div>        if ( $errors === false || ! isset( $errors[0] ) ) { // invalid error&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $errors[1][0]['reason'] ) && ( $errors[1][0]['reason'] == 'invalidCredentials' || $errors[1][0]['reason'] == 'authError' || $errors[1][0]['reason'] == 'insufficientPermissions' || $errors[1][0]['reason'] == 'required' || $errors[1][0]['reason'] == 'keyExpired' ) ) {&nbsp;</div></li><li><div>            $this-&gt;reset_token( false );&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $errors[1][0]['reason'] ) && ( $errors[1][0]['reason'] == 'userRateLimitExceeded' || $errors[1][0]['reason'] == 'quotaExceeded' ) ) {&nbsp;</div></li><li><div>            if ( $this-&gt;gadwp-&gt;config-&gt;options['api_backoff'] &lt;= 5 ) {&nbsp;</div></li><li><div>                usleep( rand( 100000, 1500000 ) );&nbsp;</div></li><li><div>                $this-&gt;gadwp-&gt;config-&gt;options['api_backoff'] = $this-&gt;gadwp-&gt;config-&gt;options['api_backoff'] + 1;&nbsp;</div></li><li><div>                $this-&gt;gadwp-&gt;config-&gt;set_plugin_options();&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $errors[0] == 400 || $errors[0] == 401 || $errors[0] == 403 ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Calculates proper timeouts for each GAPI query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $daily&nbsp;</div></li><li><div>     * @return number&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_timeouts( $daily ) {&nbsp;</div></li><li><div>        $local_time = time() + $this-&gt;timeshift;&nbsp;</div></li><li><div>        if ( $daily ) {&nbsp;</div></li><li><div>            $nextday = explode( '-', date( 'n-j-Y', strtotime( ' +1 day', $local_time ) ) );&nbsp;</div></li><li><div>            $midnight = mktime( 0, 0, 0, $nextday[0], $nextday[1], $nextday[2] );&nbsp;</div></li><li><div>            return $midnight - $local_time;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $nexthour = explode( '-', date( 'H-n-j-Y', strtotime( ' +1 hour', $local_time ) ) );&nbsp;</div></li><li><div>            $newhour = mktime( $nexthour[0], 0, 0, $nexthour[1], $nexthour[2], $nexthour[3] );&nbsp;</div></li><li><div>            return $newhour - $local_time;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates and retrieves the Access Code&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function token_request() {&nbsp;</div></li><li><div>        $authUrl = $this-&gt;client-&gt;createAuthUrl();&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>&lt;form name=&quot;input&quot; action=&quot;&lt;?php echo esc_url($_SERVER['REQUEST_URI']); ?&gt;&quot; method=&quot;post&quot;&gt;&nbsp;</div></li><li><div>&lt;table class=&quot;gadwp-settings-options&quot;&gt;&nbsp;</div></li><li><div>    &lt;tr&gt;&nbsp;</div></li><li><div>        &lt;td colspan=&quot;2&quot; class=&quot;gadwp-settings-info&quot;&gt;&nbsp;</div></li><li><div>                    &lt;?php echo __( &quot;Use this link to get your access code:&quot;, 'google-analytics-dashboard-for-wp' ) . ' &lt;a href=&quot;' . $authUrl . '&quot; id=&quot;gapi-access-code&quot; target=&quot;_blank&quot;&gt;' . __ ( &quot;Get Access Code&quot;, 'google-analytics-dashboard-for-wp' ) . '&lt;/a&gt;.'; ?&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>    &lt;/tr&gt;&nbsp;</div></li><li><div>    &lt;tr&gt;&nbsp;</div></li><li><div>        &lt;td class=&quot;gadwp-settings-title&quot;&gt;&nbsp;</div></li><li><div>            &lt;label for=&quot;ga_dash_code&quot; title=&quot;&lt;?php _e(&quot;Use the red link to get your access code!&quot;, 'google-analytics-dashboard-for-wp')?&gt;&quot;&gt;&lt;?php echo _e( &quot;Access Code:&quot;, 'google-analytics-dashboard-for-wp' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>        &lt;/td&gt;&nbsp;</div></li><li><div>        &lt;td&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;text&quot; id=&quot;ga_dash_code&quot; name=&quot;ga_dash_code&quot; value=&quot;&quot; size=&quot;61&quot; required=&quot;required&quot; title=&quot;&lt;?php _e(&quot;Use the red link to get your access code!&quot;, 'google-analytics-dashboard-for-wp')?&gt;&quot;&gt;&nbsp;</div></li><li><div>        &lt;/td&gt;&nbsp;</div></li><li><div>    &lt;/tr&gt;&nbsp;</div></li><li><div>    &lt;tr&gt;&nbsp;</div></li><li><div>        &lt;td colspan=&quot;2&quot;&gt;&nbsp;</div></li><li><div>            &lt;hr&gt;&nbsp;</div></li><li><div>        &lt;/td&gt;&nbsp;</div></li><li><div>    &lt;/tr&gt;&nbsp;</div></li><li><div>    &lt;tr&gt;&nbsp;</div></li><li><div>        &lt;td colspan=&quot;2&quot;&gt;&nbsp;</div></li><li><div>            &lt;input type=&quot;submit&quot; class=&quot;button button-secondary&quot; name=&quot;ga_dash_authorize&quot; value=&quot;&lt;?php _e( &quot;Save Access Code&quot;, 'google-analytics-dashboard-for-wp' ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>        &lt;/td&gt;&nbsp;</div></li><li><div>    &lt;/tr&gt;&nbsp;</div></li><li><div>&lt;/table&gt;&nbsp;</div></li><li><div>&lt;/form&gt;&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves all Google Analytics Views with details&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function refresh_profiles() {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $ga_dash_profile_list = array();&nbsp;</div></li><li><div>            $startindex = 1;&nbsp;</div></li><li><div>            $totalresults = 65535; // use something big&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            while ( $startindex &lt; $totalresults ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $profiles = $this-&gt;service-&gt;management_profiles-&gt;listManagementProfiles( '~all', '~all', array( 'start-index' =&gt; $startindex ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $items = $profiles-&gt;getItems();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $totalresults = $profiles-&gt;getTotalResults();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $totalresults &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $items as $profile ) {&nbsp;</div></li><li><div>                        $timetz = new DateTimeZone( $profile-&gt;getTimezone() );&nbsp;</div></li><li><div>                        $localtime = new DateTime( 'now', $timetz );&nbsp;</div></li><li><div>                        $timeshift = strtotime( $localtime-&gt;format( 'Y-m-d H:i:s' ) ) - time();&nbsp;</div></li><li><div>                        $ga_dash_profile_list[] = array( $profile-&gt;getName(), $profile-&gt;getId(), $profile-&gt;getwebPropertyId(), $profile-&gt;getwebsiteUrl(), $timeshift, $profile-&gt;getTimezone(), $profile-&gt;getDefaultPage() );&nbsp;</div></li><li><div>                        $startindex++;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $ga_dash_profile_list ) ) {&nbsp;</div></li><li><div>                GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': No properties were found in this account!', $this-&gt;error_timeout );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                GADWP_Tools::delete_cache( 'last_error' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $ga_dash_profile_list;&nbsp;</div></li><li><div>        } catch ( Google_IO_Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( $e ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            return $ga_dash_profile_list;&nbsp;</div></li><li><div>        } catch ( Google_Service_Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( &quot;(&quot; . $e-&gt;getCode() . &quot;) &quot; . $e-&gt;getMessage() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'gapi_errors', array( $e-&gt;getCode(), (array) $e-&gt;getErrors() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( $e ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            return $ga_dash_profile_list;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles the token reset process&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $all&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function reset_token( $all = true ) {&nbsp;</div></li><li><div>        $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_token'] = &quot;&quot;;&nbsp;</div></li><li><div>        if ( $all ) {&nbsp;</div></li><li><div>            $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_tableid_jail'] = &quot;&quot;;&nbsp;</div></li><li><div>            $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_profile_list'] = array();&nbsp;</div></li><li><div>            try {&nbsp;</div></li><li><div>                $this-&gt;client-&gt;revokeToken();&nbsp;</div></li><li><div>            } catch ( Exception $e ) {&nbsp;</div></li><li><div>                if ( is_multisite() && $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_network'] ) {&nbsp;</div></li><li><div>                    $this-&gt;gadwp-&gt;config-&gt;set_plugin_options( true );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;gadwp-&gt;config-&gt;set_plugin_options();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( is_multisite() && $this-&gt;gadwp-&gt;config-&gt;options['ga_dash_network'] ) {&nbsp;</div></li><li><div>            $this-&gt;gadwp-&gt;config-&gt;set_plugin_options( true );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;gadwp-&gt;config-&gt;set_plugin_options();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get and cache Core Reports&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projecId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $metrics&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $options&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $serial&nbsp;</div></li><li><div>     * @return int|Google_Service_Analytics_GaData&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function handle_corereports( $projectId, $from, $to, $metrics, $options, $serial ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( $from == &quot;today&quot; ) {&nbsp;</div></li><li><div>                $timeouts = 0;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $timeouts = 1;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $transient = GADWP_Tools::get_cache( $serial );&nbsp;</div></li><li><div>            if ( $transient === false ) {&nbsp;</div></li><li><div>                if ( $this-&gt;gapi_errors_handler() ) {&nbsp;</div></li><li><div>                    return - 23;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $options['samplingLevel'] = 'HIGHER_PRECISION';&nbsp;</div></li><li><div>                $data = $this-&gt;service-&gt;data_ga-&gt;get( 'ga:' . $projectId, $from, $to, $metrics, $options );&nbsp;</div></li><li><div>                GADWP_Tools::set_cache( $serial, $data, $this-&gt;get_timeouts( $timeouts ) );&nbsp;</div></li><li><div>                $this-&gt;gadwp-&gt;config-&gt;options['api_backoff'] = 0;&nbsp;</div></li><li><div>                $this-&gt;gadwp-&gt;config-&gt;set_plugin_options();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $data = $transient;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } catch ( Google_Service_Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( &quot;(&quot; . $e-&gt;getCode() . &quot;) &quot; . $e-&gt;getMessage() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'gapi_errors', array( $e-&gt;getCode(), (array) $e-&gt;getErrors() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            return $e-&gt;getCode();&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( $e ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            return $e-&gt;getCode();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $data-&gt;getRows() &gt; 0 ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return - 21;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generates serials for transients&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $serial&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_serial( $serial ) {&nbsp;</div></li><li><div>        return sprintf( &quot;%u&quot;, crc32( $serial ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Area Charts (Admin Dashboard Widget report)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $query&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_areachart_data( $projectId, $from, $to, $query, $filter = '' ) {&nbsp;</div></li><li><div>        switch ( $query ) {&nbsp;</div></li><li><div>            case 'users' :&nbsp;</div></li><li><div>                $title = __( &quot;Users&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'pageviews' :&nbsp;</div></li><li><div>                $title = __( &quot;Page Views&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'visitBounceRate' :&nbsp;</div></li><li><div>                $title = __( &quot;Bounce Rate&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'organicSearches' :&nbsp;</div></li><li><div>                $title = __( &quot;Organic Searches&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'uniquePageviews' :&nbsp;</div></li><li><div>                $title = __( &quot;Unique Page Views&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $title = __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $metrics = 'ga:' . $query;&nbsp;</div></li><li><div>        if ( $from == &quot;today&quot; || $from == &quot;yesterday&quot; ) {&nbsp;</div></li><li><div>            $dimensions = 'ga:hour';&nbsp;</div></li><li><div>            $dayorhour = __( &quot;Hour&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>        } else if ( $from == &quot;365daysAgo&quot; || $from == &quot;1095daysAgo&quot; ) {&nbsp;</div></li><li><div>            $dimensions = 'ga:yearMonth, ga:month';&nbsp;</div></li><li><div>            $dayorhour = __( &quot;Date&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $dimensions = 'ga:date, ga:dayOfWeekName';&nbsp;</div></li><li><div>            $dayorhour = __( &quot;Date&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:pagePath==' . $filter;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr2_' . $this-&gt;get_serial( $projectId . $from . $metrics . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( $dayorhour, $title ) );&nbsp;</div></li><li><div>        if ( $from == &quot;today&quot; || $from == &quot;yesterday&quot; ) {&nbsp;</div></li><li><div>            foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>                $gadwp_data[] = array( (int) $row[0] . ':00', round( $row[1], 2 ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if ( $from == &quot;365daysAgo&quot; || $from == &quot;1095daysAgo&quot; ) {&nbsp;</div></li><li><div>            foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * translators:&nbsp;</div></li><li><div>                 * Example: 'F, Y' will become 'November, 2015'&nbsp;</div></li><li><div>                 * For details see: http://php.net/manual/en/function.date.php#refsect1-function.date-parameters&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $gadwp_data[] = array( date_i18n( __( 'F, Y', 'google-analytics-dashboard-for-wp' ), strtotime( $row[0] . '01' ) ), round( $row[2], 2 ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>                /**&nbsp;</div></li><li><div>                 * translators:&nbsp;</div></li><li><div>                 * Example: 'l, F j, Y' will become 'Thusday, November 17, 2015'&nbsp;</div></li><li><div>                 * For details see: http://php.net/manual/en/function.date.php#refsect1-function.date-parameters&nbsp;</div></li><li><div>                 */&nbsp;</div></li><li><div>                $gadwp_data[] = array( date_i18n( __( 'l, F j, Y', 'google-analytics-dashboard-for-wp' ), strtotime( $row[0] ) ), round( $row[2], 2 ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Bottom Stats (bottom stats on main report)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_bottomstats( $projectId, $from, $to, $filter = '' ) {&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; null, 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:pagePath==' . $filter;&nbsp;</div></li><li><div>            $metrics = 'ga:uniquePageviews, ga:users, ga:pageviews, ga:BounceRate, ga:organicSearches, ga:pageviewsPerSession, ga:avgTimeOnPage, ga:avgPageLoadTime, ga:exitRate';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $metrics = 'ga:sessions, ga:users, ga:pageviews, ga:BounceRate, ga:organicSearches, ga:pageviewsPerSession, ga:avgTimeOnPage, ga:avgPageLoadTime, ga:avgSessionDuration';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr3_' . $this-&gt;get_serial( $projectId . $from . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            if ( $data == - 21 ) {&nbsp;</div></li><li><div>                return array_fill( 0, 9, 0 );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return $data;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array();&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $gadwp_data = array_map( 'floatval', $row );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // i18n support&nbsp;</div></li><li><div>        $gadwp_data[0] = number_format_i18n( $gadwp_data[0] );&nbsp;</div></li><li><div>        $gadwp_data[1] = number_format_i18n( $gadwp_data[1] );&nbsp;</div></li><li><div>        $gadwp_data[2] = number_format_i18n( $gadwp_data[2] );&nbsp;</div></li><li><div>        $gadwp_data[3] = number_format_i18n( $gadwp_data[3], 2 ) . '%';&nbsp;</div></li><li><div>        $gadwp_data[4] = number_format_i18n( $gadwp_data[4] );&nbsp;</div></li><li><div>        $gadwp_data[5] = number_format_i18n( $gadwp_data[5], 2 );&nbsp;</div></li><li><div>        $gadwp_data[6] = gmdate( &quot;H:i:s&quot;, $gadwp_data[6] );&nbsp;</div></li><li><div>        $gadwp_data[7] = gmdate( &quot;H:i:s&quot;, $gadwp_data[7] );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $gadwp_data[8] = number_format_i18n( $gadwp_data[8], 2 ) . '%';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $gadwp_data[8] = gmdate( &quot;H:i:s&quot;, $gadwp_data[8] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Org Charts & Table Charts (content pages)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_contentpages( $projectId, $from, $to, $filter = '' ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:pageTitle';&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:pagePath==' . $filter;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr4_' . $this-&gt;get_serial( $projectId . $from . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( __( &quot;Pages&quot;, 'google-analytics-dashboard-for-wp' ), __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $gadwp_data[] = array( esc_html( $row[0] ), (int) $row[1] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for 404 Errors&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_404errors( $projectId, $from, $to, $filter = &quot;Page Not Found&quot; ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:pagePath, ga:fullReferrer';&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        $options['filters'] = 'ga:pageTitle=@' . $filter;&nbsp;</div></li><li><div>        $serial = 'qr4_' . $this-&gt;get_serial( $projectId . $from . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( __( &quot;404 Errors&quot;, 'google-analytics-dashboard-for-wp' ), __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $path = esc_html( $row[0] );&nbsp;</div></li><li><div>            $source = esc_html( $row[1] );&nbsp;</div></li><li><div>            $gadwp_data[] = array( &quot;&lt;strong&gt;&quot; . __( &quot;URI:&quot;, 'google-analytics-dashboard-for-wp' ) . &quot;&lt;/strong&gt; &quot; . $path . &quot;&lt;br&gt;&lt;strong&gt;&quot; . __( &quot;Source:&quot;, 'google-analytics-dashboard-for-wp' ) . &quot;&lt;/strong&gt; &quot; . $source, (int) $row[2] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Org Charts & Table Charts (referrers)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_referrers( $projectId, $from, $to, $filter = '' ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:source';&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:medium==referral;ga:pagePath==' . $filter;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:medium==referral';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr5_' . $this-&gt;get_serial( $projectId . $from . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( __( &quot;Referrers&quot;, 'google-analytics-dashboard-for-wp' ), __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $gadwp_data[] = array( esc_html( $row[0] ), (int) $row[1] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Org Charts & Table Charts (searches)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_searches( $projectId, $from, $to, $filter = '' ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:keyword';&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:keyword!=(not set);ga:pagePath==' . $filter;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:keyword!=(not set)';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr6_' . $this-&gt;get_serial( $projectId . $from . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $gadwp_data = array( array( __( &quot;Searches&quot;, 'google-analytics-dashboard-for-wp' ), __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $gadwp_data[] = array( esc_html( $row[0] ), (int) $row[1] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Org Charts & Table Charts (location reports)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_locations( $projectId, $from, $to, $filter = '' ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $options = &quot;&quot;;&nbsp;</div></li><li><div>        $title = __( &quot;Countries&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>        $serial = 'qr7_' . $this-&gt;get_serial( $projectId . $from . $filter );&nbsp;</div></li><li><div>        $dimensions = 'ga:country';&nbsp;</div></li><li><div>        $local_filter = '';&nbsp;</div></li><li><div>        if ( $this-&gt;gadwp-&gt;config-&gt;options['ga_target_geomap'] ) {&nbsp;</div></li><li><div>            $dimensions = 'ga:city, ga:region';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $country_codes = GADWP_Tools::get_countrycodes();&nbsp;</div></li><li><div>            if ( isset( $country_codes[$this-&gt;gadwp-&gt;config-&gt;options['ga_target_geomap']] ) ) {&nbsp;</div></li><li><div>                $local_filter = 'ga:country==' . ( $country_codes[$this-&gt;gadwp-&gt;config-&gt;options['ga_target_geomap']] );&nbsp;</div></li><li><div>                $title = __( &quot;Cities from&quot;, 'google-analytics-dashboard-for-wp' ) . ' ' . __( $country_codes[$this-&gt;gadwp-&gt;config-&gt;options['ga_target_geomap']] );&nbsp;</div></li><li><div>                $serial = 'qr7_' . $this-&gt;get_serial( $projectId . $from . $this-&gt;gadwp-&gt;config-&gt;options['ga_target_geomap'] . $filter );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:pagePath==' . $filter;&nbsp;</div></li><li><div>            if ( $local_filter ) {&nbsp;</div></li><li><div>                $options['filters'] .= ';' . $local_filter;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( $local_filter ) {&nbsp;</div></li><li><div>                $options['filters'] = $local_filter;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( $title, __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            if ( isset( $row[2] ) ) {&nbsp;</div></li><li><div>                $gadwp_data[] = array( esc_html( $row[0] ) . ', ' . esc_html( $row[1] ), (int) $row[2] );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $gadwp_data[] = array( esc_html( $row[0] ), (int) $row[1] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Org Charts (traffic channels, device categories)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $query&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_orgchart_data( $projectId, $from, $to, $query, $filter = '' ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:' . $query;&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        if ( $filter ) {&nbsp;</div></li><li><div>            $options['filters'] = 'ga:pagePath==' . $filter;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr8_' . $this-&gt;get_serial( $projectId . $from . $query . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $block = ( $query == 'channelGrouping' ) ? __( &quot;Channels&quot;, 'google-analytics-dashboard-for-wp' ) : __( &quot;Devices&quot;, 'google-analytics-dashboard-for-wp' );&nbsp;</div></li><li><div>        $gadwp_data = array( array( '&lt;div style=&quot;color:black; font-size:1.1em&quot;&gt;' . $block . '&lt;/div&gt;&lt;div style=&quot;color:darkblue; font-size:1.2em&quot;&gt;' . (int) $data['totalsForAllResults'][&quot;ga:sessions&quot;] . '&lt;/div&gt;', &quot;&quot; ) );&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $shrink = explode( &quot; &quot;, $row[0] );&nbsp;</div></li><li><div>            $gadwp_data[] = array( '&lt;div style=&quot;color:black; font-size:1.1em&quot;&gt;' . esc_html( $shrink[0] ) . '&lt;/div&gt;&lt;div style=&quot;color:darkblue; font-size:1.2em&quot;&gt;' . (int) $row[1] . '&lt;/div&gt;', '&lt;div style=&quot;color:black; font-size:1.1em&quot;&gt;' . $block . '&lt;/div&gt;&lt;div style=&quot;color:darkblue; font-size:1.2em&quot;&gt;' . (int) $data['totalsForAllResults'][&quot;ga:sessions&quot;] . '&lt;/div&gt;' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Pie Charts (traffic mediums, serach engines, social networks, browsers, screen rsolutions, etc.)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $query&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $filter&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_piechart_data( $projectId, $from, $to, $query, $filter = '' ) {&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:' . $query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query == 'source' ) {&nbsp;</div></li><li><div>            $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>            if ( $filter ) {&nbsp;</div></li><li><div>                $options['filters'] = 'ga:medium==organic;ga:keyword!=(not set);ga:pagePath==' . $filter;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $options['filters'] = 'ga:medium==organic;ga:keyword!=(not set)';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $options = array( 'dimensions' =&gt; $dimensions, 'sort' =&gt; '-ga:sessions', 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>            if ( $filter ) {&nbsp;</div></li><li><div>                $options['filters'] = 'ga:' . $query . '!=(not set);ga:pagePath==' . $filter;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $options['filters'] = 'ga:' . $query . '!=(not set)';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $serial = 'qr10_' . $this-&gt;get_serial( $projectId . $from . $query . $filter );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( __( &quot;Type&quot;, 'google-analytics-dashboard-for-wp' ), __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        $i = 0;&nbsp;</div></li><li><div>        $included = 0;&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            if ( $i &lt; 20 ) {&nbsp;</div></li><li><div>                $gadwp_data[] = array( str_replace( &quot;(none)&quot;, &quot;direct&quot;, esc_html( $row[0] ) ), (int) $row[1] );&nbsp;</div></li><li><div>                $included += $row[1];&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $totals = $data-&gt;getTotalsForAllResults();&nbsp;</div></li><li><div>        $others = $totals['ga:sessions'] - $included;&nbsp;</div></li><li><div>        if ( $others &gt; 0 ) {&nbsp;</div></li><li><div>            $gadwp_data[] = array( __( 'Other', 'google-analytics-dashboard-for-wp' ), $others );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $gadwp_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Frontend Widget (chart data and totals)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $period&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $anonim&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function frontend_widget_stats( $projectId, $from, $anonim ) {&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>        $to = 'yesterday';&nbsp;</div></li><li><div>        $metrics = 'ga:sessions';&nbsp;</div></li><li><div>        $dimensions = 'ga:date, ga:dayOfWeekName';&nbsp;</div></li><li><div>        $options = array( 'dimensions' =&gt; $dimensions, 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId );&nbsp;</div></li><li><div>        $serial = 'qr2_' . $this-&gt;get_serial( $projectId . $from . $metrics );&nbsp;</div></li><li><div>        $data = $this-&gt;handle_corereports( $projectId, $from, $to, $metrics, $options, $serial );&nbsp;</div></li><li><div>        if ( is_numeric( $data ) ) {&nbsp;</div></li><li><div>            return $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $gadwp_data = array( array( __( &quot;Date&quot;, 'google-analytics-dashboard-for-wp' ), __( &quot;Sessions&quot;, 'google-analytics-dashboard-for-wp' ) ) );&nbsp;</div></li><li><div>        if ( $anonim ) {&nbsp;</div></li><li><div>            $max_array = array();&nbsp;</div></li><li><div>            foreach ( $data-&gt;getRows() as $item ) {&nbsp;</div></li><li><div>                $max_array[] = $item[2];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $max = max( $max_array ) ? max( $max_array ) : 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $gadwp_data[] = array( date_i18n( __( 'l, F j, Y', 'google-analytics-dashboard-for-wp' ), strtotime( $row[0] ) ), ( $anonim ? round( $row[2] * 100 / $max, 2 ) : (int) $row[2] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $totals = $data-&gt;getTotalsForAllResults();&nbsp;</div></li><li><div>        return array( $gadwp_data, $anonim ? 0 : number_format_i18n( $totals['ga:sessions'] ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Analytics data for Realtime component (the real-time report)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *            $projectId&nbsp;</div></li><li><div>     * @return array|int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_realtime( $projectId ) {&nbsp;</div></li><li><div>        $metrics = 'rt:activeUsers';&nbsp;</div></li><li><div>        $dimensions = 'rt:pagePath, rt:source, rt:keyword, rt:trafficType, rt:visitorType, rt:pageTitle';&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $serial = 'qr_realtimecache_' . $this-&gt;get_serial( $projectId );&nbsp;</div></li><li><div>            $transient = GADWP_Tools::get_cache( $serial );&nbsp;</div></li><li><div>            if ( $transient === false ) {&nbsp;</div></li><li><div>                if ( $this-&gt;gapi_errors_handler() ) {&nbsp;</div></li><li><div>                    return - 23;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $data = $this-&gt;service-&gt;data_realtime-&gt;get( 'ga:' . $projectId, $metrics, array( 'dimensions' =&gt; $dimensions, 'quotaUser' =&gt; $this-&gt;managequota . 'p' . $projectId ) );&nbsp;</div></li><li><div>                GADWP_Tools::set_cache( $serial, $data, 55 );&nbsp;</div></li><li><div>                $this-&gt;gadwp-&gt;config-&gt;options['api_backoff'] = 0;&nbsp;</div></li><li><div>                $this-&gt;gadwp-&gt;config-&gt;set_plugin_options();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $data = $transient;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } catch ( Google_Service_Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( &quot;(&quot; . $e-&gt;getCode() . &quot;) &quot; . $e-&gt;getMessage() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'gapi_errors', array( $e-&gt;getCode(), (array) $e-&gt;getErrors() ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            return $e-&gt;getCode();&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            GADWP_Tools::set_cache( 'last_error', date( 'Y-m-d H:i:s' ) . ': ' . esc_html( $e ), $this-&gt;error_timeout );&nbsp;</div></li><li><div>            return $e-&gt;getCode();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $data-&gt;getRows() &lt; 1 ) {&nbsp;</div></li><li><div>            return - 21;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $i = 0;&nbsp;</div></li><li><div>        $gadwp_data = $data;&nbsp;</div></li><li><div>        foreach ( $data-&gt;getRows() as $row ) {&nbsp;</div></li><li><div>            $gadwp_data-&gt;rows[$i] = array_map( 'esc_html', $row );&nbsp;</div></li><li><div>            $i++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return array( $gadwp_data );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function map( $map ) {&nbsp;</div></li><li><div>        $map = explode( '.', $map );&nbsp;</div></li><li><div>        if ( isset( $map[1] ) ) {&nbsp;</div></li><li><div>            $map[0] += ord( 'map' );&nbsp;</div></li><li><div>            return implode( '.', $map );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return str_ireplace( 'map', chr( 112 ), $map[0] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handles ajax requests and calls the needed methods&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *         $projectId&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *         $query&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *         $from&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *         $to&nbsp;</div></li><li><div>     * @param&nbsp;</div></li><li><div>     *         $filter&nbsp;</div></li><li><div>     * @return number|Google_Service_Analytics_GaData&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get( $projectId, $query, $from = false, $to = false, $filter = '' ) {&nbsp;</div></li><li><div>        if ( empty( $projectId ) || ! is_numeric( $projectId ) ) {&nbsp;</div></li><li><div>            wp_die( - 26 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( in_array( $query, array( 'sessions', 'users', 'organicSearches', 'visitBounceRate', 'pageviews', 'uniquePageviews' ) ) ) {&nbsp;</div></li><li><div>            return $this-&gt;get_areachart_data( $projectId, $from, $to, $query, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'bottomstats' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_bottomstats( $projectId, $from, $to, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'locations' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_locations( $projectId, $from, $to, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'referrers' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_referrers( $projectId, $from, $to, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'contentpages' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_contentpages( $projectId, $from, $to, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == '404errors' ) {&nbsp;</div></li><li><div>            $filter = $this-&gt;gadwp-&gt;config-&gt;options['pagetitle_404'];&nbsp;</div></li><li><div>            return $this-&gt;get_404errors( $projectId, $from, $to, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'searches' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_searches( $projectId, $from, $to, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'realtime' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_realtime( $projectId );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $query == 'channelGrouping' || $query == 'deviceCategory' ) {&nbsp;</div></li><li><div>            return $this-&gt;get_orgchart_data( $projectId, $from, $to, $query, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( in_array( $query, array( 'medium', 'visitorType', 'socialNetwork', 'source', 'browser', 'operatingSystem', 'screenResolution', 'mobileDeviceBranding' ) ) ) {&nbsp;</div></li><li><div>            return $this-&gt;get_piechart_data( $projectId, $from, $to, $query, $filter );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die( - 27 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 4.9.3.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.2/classes/gadwp_gapi_controller/" class="active">4.9.6.2</a></li><li><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.6.1/classes/gadwp_gapi_controller/" class="">4.9.6.1</a></li><li><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.5/classes/gadwp_gapi_controller/" class="">4.9.5</a></li><li><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.4/classes/gadwp_gapi_controller/" class="">4.9.4</a></li><li><a href="http://hookr.io/plugins/google-analytics-dashboard-for-wp/4.9.3.2/classes/gadwp_gapi_controller/" class="">4.9.3.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>GADWP_GAPI_Controller</li><li><span></span>Google Analytics Dashboard for WP</li><li><span></span>4.9.6.2</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>