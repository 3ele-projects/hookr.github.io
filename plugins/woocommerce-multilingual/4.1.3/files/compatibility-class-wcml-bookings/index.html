<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.1.3" data-slug="woocommerce-multilingual" data-type="file" data-id="18651"><head xmlns="http://www.w3.org/1999/xhtml"><title> compatibility-class-wcml-bookings | file | Woocommerce Multilingual | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-multilingual, 4.1.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=e9e354f61770faf0d8649b863b73d67e' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/compatibility-class-wcml-bookings/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcompatibility-class-wcml-bookings%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcompatibility-class-wcml-bookings%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-multilingual-4.1.3-file-compatibility-class-wcml-bookings","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="compatibility-class-wcml-bookings" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-multilingual." href="http://hookr.io/plugins/woocommerce-multilingual/" class="plugin"><span property="name">woocommerce-multilingual</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.1.3." href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/" class="H_VERSION"><span property="name">4.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">compatibility-class-wcml-book&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="810"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/all/" title="All">All <span class="count badge">810</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="350"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/hooks/" title="Hooks">Hooks <span class="count badge">350</span></a></li><li class="" data-id="action" data-count="47"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/actions/" title="Actions">Actions <span class="count badge">47</span></a></li><li class="" data-id="filter" data-count="303"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/filters/" title="Filters">Filters <span class="count badge">303</span></a></li><li class="" data-id="class" data-count="429"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/classes/" title="Classes">Classes <span class="count badge">429</span></a></li><li class="" data-id="constant" data-count="16"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/constants/" title="Constants">Constants <span class="count badge">16</span></a></li><li class="" data-id="function" data-count="14"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/functions/" title="Functions">Functions <span class="count badge">14</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/compatibility/class-wcml-bookings.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class WCML_Bookings.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WCML_Bookings {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var WPML_Element_Translation_Package</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $tp;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var SitePress</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $sitepress;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var woocommerce_wpml</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $woocommerce_wpml;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var wpdb</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * WCML_Bookings constructor.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct( &$sitepress, &$woocommerce_wpml, &$wpdb ) {&nbsp;</div></li><li><div>      $this-&gt;sitepress = $sitepress;&nbsp;</div></li><li><div>      $this-&gt;woocommerce_wpml = $woocommerce_wpml;&nbsp;</div></li><li><div>      $this-&gt;wpdb = $wpdb;&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_booking_base_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_booking_base_cost'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_booking_block_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_booking_block_cost'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_display_cost', array( $this, 'wcml_price_field_after_display_cost' ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_booking_pricing_base_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_booking_pricing_base_cost'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_booking_pricing_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_booking_pricing_cost'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_person_cost', array( $this, 'wcml_price_field_after_person_cost' ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_person_block_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_person_block_cost'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_resource_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_resource_cost'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_resource_block_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wcml_price_field_after_resource_block_cost'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_bookings_pricing', array( $this, 'after_bookings_pricing' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'load_assets' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'save_post', array( $this, 'save_custom_costs' ), 110, 1 );&nbsp;</div></li><li><div>      add_action( 'wcml_before_sync_product_data', array( $this, 'sync_bookings' ), 10, 3 );&nbsp;</div></li><li><div>      add_action( 'wcml_before_sync_product', array( $this, 'sync_booking_data' ), 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'woocommerce_bookings_process_cost_rules_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wc_bookings_process_cost_rules_cost'&nbsp;</div></li><li><div> ), 10, 3 );&nbsp;</div></li><li><div>      add_filter( 'woocommerce_bookings_process_cost_rules_base_cost', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wc_bookings_process_cost_rules_base_cost'&nbsp;</div></li><li><div> ), 10, 3 );&nbsp;</div></li><li><div>      add_filter( 'woocommerce_bookings_process_cost_rules_override_block', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'wc_bookings_process_cost_rules_override_block_cost'&nbsp;</div></li><li><div> ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wcml_multi_currency_ajax_actions', array( $this, 'wcml_multi_currency_is_ajax' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wcml_cart_contents_not_changed', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'filter_bundled_product_in_cart_contents'&nbsp;</div></li><li><div> ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_after_create_booking_page', array( $this, 'booking_currency_dropdown' ) );&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'set_booking_currency' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wp_ajax_wcml_booking_set_currency', array( $this, 'set_booking_currency_ajax' ) );&nbsp;</div></li><li><div>      add_action( 'woocommerce_bookings_create_booking_page_add_order_item', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'set_order_currency_on_create_booking_page'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      add_filter( 'woocommerce_currency_symbol', array( $this, 'filter_booking_currency_symbol' ) );&nbsp;</div></li><li><div>      add_filter( 'get_booking_products_args', array( $this, 'filter_get_booking_products_args' ) );&nbsp;</div></li><li><div>      add_filter( 'wcml_filter_currency_position', array( $this, 'create_booking_page_client_currency' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wcml_client_currency', array( $this, 'create_booking_page_client_currency' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wcml_gui_additional_box_html', array( $this, 'custom_box_html' ), 10, 3 );&nbsp;</div></li><li><div>      add_filter( 'wcml_gui_additional_box_data', array( $this, 'custom_box_html_data' ), 10, 4 );&nbsp;</div></li><li><div>      add_filter( 'wcml_check_is_single', array( $this, 'show_custom_blocks_for_resources_and_persons' ), 10, 3 );&nbsp;</div></li><li><div>      add_filter( 'wcml_product_content_exception', array( $this, 'remove_custom_fields_to_translate' ), 10, 3 );&nbsp;</div></li><li><div>      add_filter( 'wcml_not_display_single_fields_to_translate', array(&nbsp;</div></li><li><div>          $this, &nbsp;</div></li><li><div>          'remove_single_custom_fields_to_translate'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      add_filter( 'wcml_product_content_label', array( $this, 'product_content_resource_label' ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'wcml_update_extra_fields', array( $this, 'wcml_products_tab_sync_resources_and_persons' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'woocommerce_new_booking', array( $this, 'duplicate_booking_for_translations' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $bookings_statuses = array(&nbsp;</div></li><li><div>          'unpaid', &nbsp;</div></li><li><div>          'pending-confirmation', &nbsp;</div></li><li><div>          'confirmed', &nbsp;</div></li><li><div>          'paid', &nbsp;</div></li><li><div>          'cancelled', &nbsp;</div></li><li><div>          'complete', &nbsp;</div></li><li><div>          'in-cart', &nbsp;</div></li><li><div>          'was-in-cart'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      foreach ( $bookings_statuses as $status ) {&nbsp;</div></li><li><div>          add_action( 'woocommerce_booking_' . $status, array( $this, 'update_status_for_translations' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'parse_query', array( $this, 'booking_filters_query' ) );&nbsp;</div></li><li><div>      add_filter( 'woocommerce_bookings_in_date_range_query', array( $this, 'bookings_in_date_range_query' ) );&nbsp;</div></li><li><div>      add_action( 'before_delete_post', array( $this, 'delete_bookings' ) );&nbsp;</div></li><li><div>      add_action( 'wp_trash_post', array( $this, 'trash_bookings' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;tp = new WPML_Element_Translation_Package;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'wpml_tm_translation_job_data', array(&nbsp;</div></li><li><div>              $this, &nbsp;</div></li><li><div>              'append_persons_to_translation_package'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>          add_action( 'wpml_translation_job_saved', array( $this, 'save_person_translation' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'wpml_tm_translation_job_data', array(&nbsp;</div></li><li><div>              $this, &nbsp;</div></li><li><div>              'append_resources_to_translation_package'&nbsp;</div></li><li><div> ), 10, 2 );&nbsp;</div></li><li><div>          add_action( 'wpml_translation_job_saved', array( $this, 'save_resource_translation' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//lock fields on translations pages</span>&nbsp;</div></li><li><div>          add_filter( 'wcml_js_lock_fields_ids', array( $this, 'wcml_js_lock_fields_ids' ) );&nbsp;</div></li><li><div>          add_filter( 'wcml_after_load_lock_fields_js', array( $this, 'localize_lock_fields_js' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//allow filtering resources by language</span>&nbsp;</div></li><li><div>          add_filter( 'get_booking_resources_args', array( $this, 'filter_get_booking_resources_args' ) );&nbsp;</div></li><li><div>          add_filter( 'get_translatable_documents', array( $this, 'filter_translatable_documents' ) );&nbsp;</div></li><li><div>          add_filter( 'pre_wpml_is_translated_post_type', array( $this, 'filter_is_translated_post_type' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'woocommerce_product_data_panels', array( $this, 'show_pointer_info' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'save_post', array( $this, 'sync_booking_status' ), 10, 3 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_admin() || isset( $_POST['action'] ) && $_POST['action'] == 'wc_bookings_calculate_costs' ) {&nbsp;</div></li><li><div>          add_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//@TODO review after WPML 3.6</span>&nbsp;</div></li><li><div>      if ( version_compare( ICL_SITEPRESS_VERSION, '3.6', '&lt;' ) ) {&nbsp;</div></li><li><div>          add_action( 'added_post_meta', array(&nbsp;</div></li><li><div>              $this, &nbsp;</div></li><li><div>              'maybe_fix_double_serialized_wc_booking_availability'&nbsp;</div></li><li><div> ), 10, 4 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wpml_language_filter_extra_conditions_snippet', array( $this, 'extra_conditions_to_filter_bookings' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;clear_transient_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wpml_tm_dashboard_translatable_types', array(    $this, 'hide_bookings_type_on_tm_dashboard' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wcml_add_to_cart_sold_individually', array( $this, 'add_to_cart_sold_individually' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_booking_base_cost( $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_booking_cost' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_booking_block_cost( $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_booking_base_cost' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_display_cost( $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_display_cost' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_booking_pricing_base_cost( $pricing, $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_booking_pricing_base_cost', $pricing );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_booking_pricing_cost( $pricing, $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_booking_pricing_cost', $pricing );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_person_cost( $person_type_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $person_type_id, 'wcml_wc_booking_person_cost', false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_person_block_cost( $person_type_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $person_type_id, 'wcml_wc_booking_person_block_cost', false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_resource_cost( $resource_id, $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_booking_resource_cost', false, true, $resource_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_price_field_after_resource_block_cost( $resource_id, $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;echo_wcml_price_field( $post_id, 'wcml_wc_booking_resource_block_cost', false, true, $resource_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function echo_wcml_price_field( $post_id, $field, $pricing = false, $check = true, $resource_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( ! $check || $this-&gt;woocommerce_wpml-&gt;products-&gt;is_original_product( $post_id ) ) && $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $currencies = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wc_currencies = get_woocommerce_currencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;wcml_custom_cost_field&quot; &gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $currencies as $currency_code =&gt; $currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              switch ( $field ) {&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_cost':&nbsp;</div></li><li><div>                      woocommerce_wp_text_input( array(&nbsp;</div></li><li><div>                          'id' =&gt; 'wcml_wc_booking_cost', &nbsp;</div></li><li><div>                          'class' =&gt; 'wcml_bookings_custom_price', &nbsp;</div></li><li><div>                          'name' =&gt; 'wcml_wc_booking_cost[' . $currency_code . ']', &nbsp;</div></li><li><div>                          'label' =&gt; get_woocommerce_currency_symbol( $currency_code ), &nbsp;</div></li><li><div>                          'description' =&gt; __( 'One-off cost for the booking as a whole.', 'woocommerce-bookings' ), &nbsp;</div></li><li><div>                          'value' =&gt; get_post_meta( $post_id, '_wc_booking_cost_' . $currency_code, true ), &nbsp;</div></li><li><div>                          'type' =&gt; 'number', &nbsp;</div></li><li><div>                          'desc_tip' =&gt; true, &nbsp;</div></li><li><div>                          'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                              'min' =&gt; '', &nbsp;</div></li><li><div>                              'step' =&gt; '0.01'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_base_cost':&nbsp;</div></li><li><div>                      woocommerce_wp_text_input( array(&nbsp;</div></li><li><div>                          'id' =&gt; 'wcml_wc_booking_base_cost', &nbsp;</div></li><li><div>                          'class' =&gt; 'wcml_bookings_custom_price', &nbsp;</div></li><li><div>                          'name' =&gt; 'wcml_wc_booking_base_cost[' . $currency_code . ']', &nbsp;</div></li><li><div>                          'label' =&gt; get_woocommerce_currency_symbol( $currency_code ), &nbsp;</div></li><li><div>                          'description' =&gt; __( 'This is the cost per block booked. All other costs (for resources and persons) are added to this.', 'woocommerce-bookings' ), &nbsp;</div></li><li><div>                          'value' =&gt; get_post_meta( $post_id, '_wc_booking_base_cost_' . $currency_code, true ), &nbsp;</div></li><li><div>                          'type' =&gt; 'number', &nbsp;</div></li><li><div>                          'desc_tip' =&gt; true, &nbsp;</div></li><li><div>                          'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                              'min' =&gt; '', &nbsp;</div></li><li><div>                              'step' =&gt; '0.01'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'wcml_wc_display_cost':&nbsp;</div></li><li><div>                      woocommerce_wp_text_input( array(&nbsp;</div></li><li><div>                          'id' =&gt; 'wcml_wc_display_cost', &nbsp;</div></li><li><div>                          'class' =&gt; 'wcml_bookings_custom_price', &nbsp;</div></li><li><div>                          'name' =&gt; 'wcml_wc_display_cost[' . $currency_code . ']', &nbsp;</div></li><li><div>                          'label' =&gt; get_woocommerce_currency_symbol( $currency_code ), &nbsp;</div></li><li><div>                          'description' =&gt; __( 'The cost is displayed to the user on the frontend. Leave blank to have it calculated for you. If a booking has varying costs, this will be prefixed with the word &quot;from:&quot;.', 'woocommerce-bookings' ), &nbsp;</div></li><li><div>                          'value' =&gt; get_post_meta( $post_id, '_wc_display_cost_' . $currency_code, true ), &nbsp;</div></li><li><div>                          'type' =&gt; 'number', &nbsp;</div></li><li><div>                          'desc_tip' =&gt; true, &nbsp;</div></li><li><div>                          'custom_attributes' =&gt; array(&nbsp;</div></li><li><div>                              'min' =&gt; '', &nbsp;</div></li><li><div>                              'step' =&gt; '0.01'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_pricing_base_cost':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $pricing[ 'base_cost_' . $currency_code ] ) ) {&nbsp;</div></li><li><div>                          $value = $pricing[ 'base_cost_' . $currency_code ];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $value = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;wcml_bookings_range_block&quot; &gt;';&nbsp;</div></li><li><div>                      echo '&lt;label&gt;' . get_woocommerce_currency_symbol( $currency_code ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;wcml_wc_booking_pricing_base_cost[' . $currency_code . '][]&quot; class=&quot;wcml_bookings_custom_price&quot; value=&quot;' . $value . '&quot; placeholder=&quot;0&quot; /&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_pricing_cost':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $pricing[ 'cost_' . $currency_code ] ) ) {&nbsp;</div></li><li><div>                          $value = $pricing[ 'cost_' . $currency_code ];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $value = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;wcml_bookings_range_block&quot; &gt;';&nbsp;</div></li><li><div>                      echo '&lt;label&gt;' . get_woocommerce_currency_symbol( $currency_code ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;wcml_wc_booking_pricing_cost[' . $currency_code . '][]&quot; class=&quot;wcml_bookings_custom_price&quot; value=&quot;' . $value . '&quot; placeholder=&quot;0&quot; /&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_person_cost':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $value = get_post_meta( $post_id, 'cost_' . $currency_code, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;wcml_bookings_person_block&quot; &gt;';&nbsp;</div></li><li><div>                      echo '&lt;label&gt;' . get_woocommerce_currency_symbol( $currency_code ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;wcml_wc_booking_person_cost[' . $post_id . '][' . $currency_code . ']&quot; class=&quot;wcml_bookings_custom_price&quot; value=&quot;' . $value . '&quot; placeholder=&quot;0&quot; /&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_person_block_cost':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $value = get_post_meta( $post_id, 'block_cost_' . $currency_code, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;wcml_bookings_person_block&quot; &gt;';&nbsp;</div></li><li><div>                      echo '&lt;label&gt;' . get_woocommerce_currency_symbol( $currency_code ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;wcml_wc_booking_person_block_cost[' . $post_id . '][' . $currency_code . ']&quot; class=&quot;wcml_bookings_custom_price&quot; value=&quot;' . $value . '&quot; placeholder=&quot;0&quot; /&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_resource_cost':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $resource_base_costs = maybe_unserialize( get_post_meta( $post_id, '_resource_base_costs', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $resource_base_costs['custom_costs'][ $currency_code ][ $resource_id ] ) ) {&nbsp;</div></li><li><div>                          $value = $resource_base_costs['custom_costs'][ $currency_code ][ $resource_id ];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $value = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;wcml_bookings_resource_block&quot; &gt;';&nbsp;</div></li><li><div>                      echo '&lt;label&gt;' . get_woocommerce_currency_symbol( $currency_code ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;wcml_wc_booking_resource_cost[' . $resource_id . '][' . $currency_code . ']&quot; class=&quot;wcml_bookings_custom_price&quot; value=&quot;' . $value . '&quot; placeholder=&quot;0&quot; /&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  case 'wcml_wc_booking_resource_block_cost':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $resource_block_costs = maybe_unserialize( get_post_meta( $post_id, '_resource_block_costs', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $resource_block_costs['custom_costs'][ $currency_code ][ $resource_id ] ) ) {&nbsp;</div></li><li><div>                          $value = $resource_block_costs['custom_costs'][ $currency_code ][ $resource_id ];&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $value = '';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;wcml_bookings_resource_block&quot; &gt;';&nbsp;</div></li><li><div>                      echo '&lt;label&gt;' . get_woocommerce_currency_symbol( $currency_code ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>                      echo '&lt;input type=&quot;number&quot; step=&quot;0.01&quot; name=&quot;wcml_wc_booking_resource_block_cost[' . $resource_id . '][' . $currency_code . ']&quot; class=&quot;wcml_bookings_custom_price&quot; value=&quot;' . $value . '&quot; placeholder=&quot;0&quot; /&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  default:&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function after_bookings_pricing( $post_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( 'booking', wp_get_post_terms( $post_id, 'product_type', array( &quot;fields&quot; =&gt; &quot;names&quot; ) ) ) && $this-&gt;woocommerce_wpml-&gt;products-&gt;is_original_product( $post_id ) && $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $custom_costs_status = get_post_meta( $post_id, '_wcml_custom_costs_status', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $checked = ! $custom_costs_status ? 'checked=&quot;checked&quot;' : ' ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;wcml_custom_costs&quot;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;input type=&quot;radio&quot; name=&quot;_wcml_custom_costs&quot; id=&quot;wcml_custom_costs_auto&quot; value=&quot;0&quot; class=&quot;wcml_custom_costs_input&quot; ' . $checked . ' /&gt;';&nbsp;</div></li><li><div>          echo '&lt;label for=&quot;wcml_custom_costs_auto&quot;&gt;' . __( 'Calculate costs in other currencies automatically', 'woocommerce-multilingual' ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $checked = $custom_costs_status == 1 ? 'checked=&quot;checked&quot;' : ' ';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;input type=&quot;radio&quot; name=&quot;_wcml_custom_costs&quot; value=&quot;1&quot; id=&quot;wcml_custom_costs_manually&quot; class=&quot;wcml_custom_costs_input&quot; ' . $checked . ' /&gt;';&nbsp;</div></li><li><div>          echo '&lt;label for=&quot;wcml_custom_costs_manually&quot;&gt;' . __( 'Set costs in other currencies manually', 'woocommerce-multilingual' ) . '&lt;/label&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_nonce_field( 'wcml_save_custom_costs', '_wcml_custom_costs_nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_custom_costs( $post_id ) {&nbsp;</div></li><li><div>      $nonce = filter_var( isset( $_POST['_wcml_custom_costs_nonce'] ) ? $_POST['_wcml_custom_costs_nonce'] : '', FILTER_SANITIZE_FULL_SPECIAL_CHARS );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['_wcml_custom_costs'] ) && isset( $nonce ) && wp_verify_nonce( $nonce, 'wcml_save_custom_costs' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_post_meta( $post_id, '_wcml_custom_costs_status', $_POST['_wcml_custom_costs'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 1 === (int) $_POST['_wcml_custom_costs'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $currencies = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currencies();&nbsp;</div></li><li><div>              if ( empty( $currencies ) || 0 === $post_id ) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;update_booking_costs( $currencies, $post_id );&nbsp;</div></li><li><div>              $this-&gt;update_booking_pricing( $currencies, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_POST['wcml_wc_booking_person_cost'] ) && is_array( $_POST['wcml_wc_booking_person_cost'] ) ) {&nbsp;</div></li><li><div>                  $this-&gt;update_booking_person_cost( $currencies, $_POST['wcml_wc_booking_person_cost'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_POST['wcml_wc_booking_person_block_cost'] ) && is_array( $_POST['wcml_wc_booking_person_block_cost'] ) ) {&nbsp;</div></li><li><div>                  $this-&gt;update_booking_person_block_cost( $currencies, $_POST['wcml_wc_booking_person_block_cost'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_POST['wcml_wc_booking_resource_cost'] ) && is_array( $_POST['wcml_wc_booking_resource_cost'] ) ) {&nbsp;</div></li><li><div>                  $this-&gt;update_booking_resource_cost( $currencies, $post_id, $_POST['wcml_wc_booking_resource_cost'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $_POST['wcml_wc_booking_resource_block_cost'] ) && is_array( $_POST['wcml_wc_booking_resource_block_cost'] ) ) {&nbsp;</div></li><li><div>                  $this-&gt;update_booking_resource_block_cost( $currencies, $post_id, $_POST['wcml_wc_booking_resource_block_cost'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              update_post_meta( $post_id, '_price', '' );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// sync existing product bookings for translations</span>&nbsp;</div></li><li><div>  function sync_bookings( $original_product_id, $product_id, $lang ) {&nbsp;</div></li><li><div>      $all_bookings_for_product = $this-&gt;wpdb-&gt;get_results( $this-&gt;wpdb-&gt;prepare( &quot;SELECT post_id as id FROM {$this-&gt;wpdb-&gt;postmeta} WHERE meta_key = '_booking_product_id' AND meta_value = %d&quot;, $original_product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $all_bookings_for_product as $booking ) {&nbsp;</div></li><li><div>          $check_if_exists = $this-&gt;wpdb-&gt;get_row( $this-&gt;wpdb-&gt;prepare( &quot;SELECT pm3.* FROM {$this-&gt;wpdb-&gt;postmeta} AS pm1&nbsp;</div></li><li><div>                                          LEFT JOIN {$this-&gt;wpdb-&gt;postmeta} AS pm2 ON pm1.post_id = pm2.post_id&nbsp;</div></li><li><div>                                          LEFT JOIN {$this-&gt;wpdb-&gt;postmeta} AS pm3 ON pm1.post_id = pm3.post_id&nbsp;</div></li><li><div>                                          WHERE pm1.meta_key = '_booking_duplicate_of' AND pm1.meta_value = %s AND pm2.meta_key = '_language_code' AND pm2.meta_value = %s AND pm3.meta_key = '_booking_product_id'&quot;&nbsp;</div></li><li><div> , $booking-&gt;id, $lang ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_null( $check_if_exists ) ) {&nbsp;</div></li><li><div>              $this-&gt;duplicate_booking_for_translations( $booking-&gt;id, $lang );&nbsp;</div></li><li><div>          } elseif ( '' === $check_if_exists-&gt;meta_value ) {&nbsp;</div></li><li><div>              update_post_meta( $check_if_exists-&gt;post_id, '_booking_product_id', $this-&gt;get_translated_booking_product_id( $booking-&gt;id, $lang ) );&nbsp;</div></li><li><div>              update_post_meta( $check_if_exists-&gt;post_id, '_booking_resource_id', $this-&gt;get_translated_booking_resource_id( $booking-&gt;id, $lang ) );&nbsp;</div></li><li><div>              update_post_meta( $check_if_exists-&gt;post_id, '_booking_persons', $this-&gt;get_translated_booking_persons_ids( $booking-&gt;id, $lang ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function sync_booking_data( $original_product_id, $current_product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( has_term( 'booking', 'product_type', $original_product_id ) ) {&nbsp;</div></li><li><div>          global $pagenow, $iclTranslationManagement;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// get language code</span>&nbsp;</div></li><li><div>          $language_details = $this-&gt;sitepress-&gt;get_element_language_details( $original_product_id, 'post_product' );&nbsp;</div></li><li><div>          if ( $pagenow == 'admin.php' && empty( $language_details ) ) {&nbsp;</div></li><li><div>              <span class="comment">//translation editor support: sidestep icl_translations_cache</span>&nbsp;</div></li><li><div>              $language_details = $this-&gt;wpdb-&gt;get_row( $this-&gt;wpdb-&gt;prepare( &quot;SELECT element_id, trid, language_code, source_language_code FROM {$this-&gt;wpdb-&gt;prefix}icl_translations WHERE element_id = %d AND element_type = 'post_product'&quot;, $original_product_id ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( empty( $language_details ) ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// pick posts to sync</span>&nbsp;</div></li><li><div>          $posts = array();&nbsp;</div></li><li><div>          $translations = $this-&gt;sitepress-&gt;get_element_translations( $language_details-&gt;trid, 'post_product' );&nbsp;</div></li><li><div>          foreach ( $translations as $translation ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $translation-&gt;original ) {&nbsp;</div></li><li><div>                  $posts[ $translation-&gt;element_id ] = $translation;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $posts as $post_id =&gt; $translation ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $trn_lang = $this-&gt;sitepress-&gt;get_language_for_element( $post_id, 'post_product' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//sync_resources</span>&nbsp;</div></li><li><div>              $this-&gt;sync_resources( $original_product_id, $post_id, $trn_lang );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//sync_persons</span>&nbsp;</div></li><li><div>              $this-&gt;sync_persons( $original_product_id, $post_id, $trn_lang );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function sync_resources( $original_product_id, $translated_product_id, $lang_code, $duplicate = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_resources = $this-&gt;wpdb-&gt;get_results( $this-&gt;wpdb-&gt;prepare(&nbsp;</div></li><li><div>          &quot;SELECT resource_id, sort_order FROM {$this-&gt;wpdb-&gt;prefix}wc_booking_relationships WHERE product_id = %d&quot;, &nbsp;</div></li><li><div>          $original_product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $translated_resources = $this-&gt;wpdb-&gt;get_col( $this-&gt;wpdb-&gt;prepare(&nbsp;</div></li><li><div>          &quot;SELECT resource_id FROM {$this-&gt;wpdb-&gt;prefix}wc_booking_relationships WHERE product_id = %d&quot;, &nbsp;</div></li><li><div>          $translated_product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $used_translated_resources = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $original_resources as $resource ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $translated_resource_id = apply_filters( 'translate_object_id', $resource-&gt;resource_id, 'bookable_resource', false, $lang_code );&nbsp;</div></li><li><div>          if ( ! is_null( $translated_resource_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( in_array( $translated_resource_id, $translated_resources ) ) {&nbsp;</div></li><li><div>                  $this-&gt;update_product_resource( $translated_product_id, $translated_resource_id, $resource );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;add_product_resource( $translated_product_id, $translated_resource_id, $resource );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $used_translated_resources[] = $translated_resource_id;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $duplicate ) {&nbsp;</div></li><li><div>                  $this-&gt;duplicate_resource( $translated_product_id, $resource, $lang_code );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $removed_translated_resources_id = array_diff( $translated_resources, $used_translated_resources );&nbsp;</div></li><li><div>      foreach ( $removed_translated_resources_id as $resource_id ) {&nbsp;</div></li><li><div>          $this-&gt;remove_resource_from_product( $translated_product_id, $resource_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;sync_resource_costs( $original_product_id, $translated_product_id, '_resource_base_costs', $lang_code );&nbsp;</div></li><li><div>      $this-&gt;sync_resource_costs( $original_product_id, $translated_product_id, '_resource_block_costs', $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function duplicate_resource( $tr_product_id, $resource, $lang_code ) {&nbsp;</div></li><li><div>      global $iclTranslationManagement;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( method_exists( $this-&gt;sitepress, 'make_duplicate' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trns_resource_id = $this-&gt;sitepress-&gt;make_duplicate( $resource-&gt;resource_id, $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! isset( $iclTranslationManagement ) ) {&nbsp;</div></li><li><div>              $iclTranslationManagement = new TranslationManagement;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trns_resource_id = $iclTranslationManagement-&gt;make_duplicate( $resource-&gt;resource_id, $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;wpdb-&gt;insert(&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'product_id' =&gt; $tr_product_id, &nbsp;</div></li><li><div>              'resource_id' =&gt; $trns_resource_id, &nbsp;</div></li><li><div>              'sort_order' =&gt; $resource-&gt;sort_order&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_post_meta( $trns_resource_id, '_icl_lang_duplicate_of' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $trns_resource_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_product_resource( $product_id, $resource_id, $resource_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;wpdb-&gt;insert(&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'sort_order' =&gt; $resource_data-&gt;sort_order, &nbsp;</div></li><li><div>              'product_id' =&gt; $product_id, &nbsp;</div></li><li><div>              'resource_id' =&gt; $resource_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $resource_id, 'qty', get_post_meta( $resource_data-&gt;resource_id, 'qty', true ) );&nbsp;</div></li><li><div>      update_post_meta( $resource_id, '_wc_booking_availability', get_post_meta( $resource_data-&gt;resource_id, '_wc_booking_availability', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function remove_resource_from_product( $product_id, $resource_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;wpdb-&gt;delete(&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'product_id' =&gt; $product_id, &nbsp;</div></li><li><div>              'resource_id' =&gt; $resource_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function update_product_resource( $product_id, $resource_id, $resource_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'sort_order' =&gt; $resource_data-&gt;sort_order&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'product_id' =&gt; $product_id, &nbsp;</div></li><li><div>              'resource_id' =&gt; $resource_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $resource_id, 'qty', get_post_meta( $resource_data-&gt;resource_id, 'qty', true ) );&nbsp;</div></li><li><div>      update_post_meta( $resource_id, '_wc_booking_availability', get_post_meta( $resource_data-&gt;resource_id, '_wc_booking_availability', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function sync_persons( $original_product_id, $tr_product_id, $lang_code, $duplicate = true ) {&nbsp;</div></li><li><div>      $orig_persons = $this-&gt;wpdb-&gt;get_col( $this-&gt;wpdb-&gt;prepare( &quot;SELECT ID FROM {$this-&gt;wpdb-&gt;posts} WHERE post_parent = %d AND post_type = 'bookable_person'&quot;, $original_product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $trnsl_persons = $this-&gt;wpdb-&gt;get_col( $this-&gt;wpdb-&gt;prepare( &quot;SELECT ID FROM {$this-&gt;wpdb-&gt;posts} WHERE post_parent = %d AND post_type = 'bookable_person'&quot;, $tr_product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $orig_persons as $person ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trnsl_person_id = apply_filters( 'translate_object_id', $person, 'bookable_person', false, $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! is_null( $trnsl_person_id ) && in_array( $trnsl_person_id, $trnsl_persons ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ( $key = array_search( $trnsl_person_id, $trnsl_persons ) ) !== false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  unset( $trnsl_persons[ $key ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  update_post_meta( $trnsl_person_id, 'block_cost', get_post_meta( $person, 'block_cost', true ) );&nbsp;</div></li><li><div>                  update_post_meta( $trnsl_person_id, 'cost', get_post_meta( $person, 'cost', true ) );&nbsp;</div></li><li><div>                  update_post_meta( $trnsl_person_id, 'max', get_post_meta( $person, 'max', true ) );&nbsp;</div></li><li><div>                  update_post_meta( $trnsl_person_id, 'min', get_post_meta( $person, 'min', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( get_post_meta( $person, '_wcml_custom_costs_status', true ) && $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>                      $currencies = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          update_post_meta( $trnsl_person_id, 'block_cost_' . $code, get_post_meta( $person, 'block_cost_' . $code, true ) );&nbsp;</div></li><li><div>                          update_post_meta( $trnsl_person_id, 'cost_' . $code, get_post_meta( $person, 'cost_' . $code, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $duplicate ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;duplicate_person( $tr_product_id, $person, $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $trnsl_persons as $trnsl_person ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_delete_post( $trnsl_person );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function duplicate_person( $tr_product_id, $person_id, $lang_code ) {&nbsp;</div></li><li><div>      global $iclTranslationManagement;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( method_exists( $this-&gt;sitepress, 'make_duplicate' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $new_person_id = $this-&gt;sitepress-&gt;make_duplicate( $person_id, $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! isset( $iclTranslationManagement ) ) {&nbsp;</div></li><li><div>              $iclTranslationManagement = new TranslationManagement;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $new_person_id = $iclTranslationManagement-&gt;make_duplicate( $person_id, $lang_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'post_parent' =&gt; $tr_product_id&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'ID' =&gt; $new_person_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_post_meta( $new_person_id, '_icl_lang_duplicate_of' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $new_person_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_wc_booking_cost( $check, $object_id, $meta_key, $single ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $meta_key, array(&nbsp;</div></li><li><div>          '_wc_booking_cost', &nbsp;</div></li><li><div>          '_wc_booking_base_cost', &nbsp;</div></li><li><div>          '_wc_display_cost', &nbsp;</div></li><li><div>          '_wc_booking_pricing', &nbsp;</div></li><li><div>          'cost', &nbsp;</div></li><li><div>          'block_cost', &nbsp;</div></li><li><div>          '_resource_base_costs', &nbsp;</div></li><li><div>          '_resource_block_costs'&nbsp;</div></li><li><div> ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $original_id = $this-&gt;woocommerce_wpml-&gt;products-&gt;get_original_product_id( $object_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $cost_status = get_post_meta( $original_id, '_wcml_custom_costs_status', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $currency = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $currency == get_option( 'woocommerce_currency' ) ) {&nbsp;</div></li><li><div>                  return $check;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( in_array( $meta_key, array( 'cost', 'block_cost' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( get_post_type( $object_id ) == 'bookable_person' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $original_id = apply_filters( 'translate_object_id', wp_get_post_parent_id( $object_id ), 'product', true, $this-&gt;woocommerce_wpml-&gt;products-&gt;get_original_product_language( wp_get_post_parent_id( $object_id ) ) );&nbsp;</div></li><li><div>                      $cost_status = get_post_meta( $original_id, '_wcml_custom_costs_status', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $value = get_post_meta( $object_id, $meta_key . '_' . $currency, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $cost_status && $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          remove_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $cost = get_post_meta( $object_id, $meta_key, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          add_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          return $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices-&gt;convert_price_amount( $cost, $currency );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      return $check;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( in_array( $meta_key, array(&nbsp;</div></li><li><div>                  '_wc_booking_pricing', &nbsp;</div></li><li><div>                  '_resource_base_costs', &nbsp;</div></li><li><div>                  '_resource_block_costs'&nbsp;</div></li><li><div> ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  remove_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $meta_key == '_wc_booking_pricing' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $original_id != $object_id ) {&nbsp;</div></li><li><div>                          $value = get_post_meta( $original_id, $meta_key );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $value = $check;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $costs = maybe_unserialize( get_post_meta( $object_id, $meta_key, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( ! $costs ) {&nbsp;</div></li><li><div>                          $value = $check;&nbsp;</div></li><li><div>                      } elseif ( $cost_status && isset( $costs['custom_costs'][ $currency ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $res_costs = array();&nbsp;</div></li><li><div>                          foreach ( $costs['custom_costs'][ $currency ] as $resource_id =&gt; $cost ) {&nbsp;</div></li><li><div>                              $trns_resource_id = apply_filters( 'translate_object_id', $resource_id, 'bookable_resource', true, $this-&gt;sitepress-&gt;get_current_language() );&nbsp;</div></li><li><div>                              $res_costs[ $trns_resource_id ] = $cost;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $value = array( 0 =&gt; $res_costs );&nbsp;</div></li><li><div>                      } elseif ( $cost_status && isset( $costs[0]['custom_costs'][ $currency ] ) ) {&nbsp;</div></li><li><div>                          $value = array( 0 =&gt; $costs[0]['custom_costs'][ $currency ] );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $converted_values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach ( $costs as $resource_id =&gt; $cost ) {&nbsp;</div></li><li><div>                              $converted_values[0][ $resource_id ] = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices-&gt;convert_price_amount( $cost, $currency );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $value = $converted_values;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  add_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $value = get_post_meta( $original_id, $meta_key . '_' . $currency, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $cost_status && ( ! empty( $value ) || ( empty( $value ) && $meta_key == '_wc_display_cost' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  remove_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $value = get_post_meta( $original_id, $meta_key, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $value = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices-&gt;convert_price_amount( $value, $currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  add_filter( 'get_post_metadata', array( $this, 'filter_wc_booking_cost' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $check;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function sync_resource_costs_with_translations( $object_id, $meta_key, $check = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_product_id = $this-&gt;woocommerce_wpml-&gt;products-&gt;get_original_product_id( $object_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $object_id == $original_product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trid = $this-&gt;sitepress-&gt;get_element_trid( $object_id, 'post_product' );&nbsp;</div></li><li><div>          $translations = $this-&gt;sitepress-&gt;get_element_translations( $trid, 'post_product' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $translations as $translation ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $translation-&gt;original ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;sync_resource_costs( $original_product_id, $translation-&gt;element_id, $meta_key, $translation-&gt;language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $check;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $language_code = $this-&gt;sitepress-&gt;get_language_for_element( $object_id, 'post_product' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;sync_resource_costs( $original_product_id, $object_id, $meta_key, $language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function sync_resource_costs( $original_product_id, $object_id, $meta_key, $language_code ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_costs = maybe_unserialize( get_post_meta( $original_product_id, $meta_key, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wc_booking_resource_costs = array();&nbsp;</div></li><li><div>      if ( ! empty( $original_costs ) ) {&nbsp;</div></li><li><div>          foreach ( $original_costs as $resource_id =&gt; $costs ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $resource_id == 'custom_costs' && isset( $costs['custom_costs'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ( $costs['custom_costs'] as $code =&gt; $currencies ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $currencies as $custom_costs_resource_id =&gt; $custom_cost ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $trns_resource_id = apply_filters( 'translate_object_id', $custom_costs_resource_id, 'bookable_resource', true, $language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $wc_booking_resource_costs['custom_costs'][ $code ][ $trns_resource_id ] = $custom_cost;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $trns_resource_id = apply_filters( 'translate_object_id', $resource_id, 'bookable_resource', true, $language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $wc_booking_resource_costs[ $trns_resource_id ] = $costs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $object_id, $meta_key, $wc_booking_resource_costs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wc_bookings_process_cost_rules_cost( $cost, $fields, $key ) {&nbsp;</div></li><li><div>      return $this-&gt;filter_pricing_cost( $cost, $fields, 'cost_', $key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wc_bookings_process_cost_rules_base_cost( $base_cost, $fields, $key ) {&nbsp;</div></li><li><div>      return $this-&gt;filter_pricing_cost( $base_cost, $fields, 'base_cost_', $key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wc_bookings_process_cost_rules_override_block_cost( $override_cost, $fields, $key ) {&nbsp;</div></li><li><div>      return $this-&gt;filter_pricing_cost( $override_cost, $fields, 'override_block_', $key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_pricing_cost( $cost, $fields, $name, $key ) {&nbsp;</div></li><li><div>      global $product;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $currency = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $currency == get_option( 'woocommerce_currency' ) ) {&nbsp;</div></li><li><div>              return $cost;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $_POST['form'] ) ) {&nbsp;</div></li><li><div>              parse_str( $_POST['form'], $posted );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $booking_id = $posted['add-to-cart'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } elseif ( isset( $_POST['add-to-cart'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $booking_id = $_POST['add-to-cart'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $booking_id ) ) {&nbsp;</div></li><li><div>              $original_id = $this-&gt;woocommerce_wpml-&gt;products-&gt;get_original_product_id( $booking_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $booking_id != $original_id ) {&nbsp;</div></li><li><div>                  $fields = maybe_unserialize( get_post_meta( $original_id, '_wc_booking_pricing', true ) );&nbsp;</div></li><li><div>                  $fields = $fields[ $key ];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $needs_filter_pricing_cost = $this-&gt;needs_filter_pricing_cost( $name, $fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( $needs_filter_pricing_cost ) {&nbsp;</div></li><li><div>              if ( isset( $fields[ $name . $currency ] ) ) {&nbsp;</div></li><li><div>                  return $fields[ $name . $currency ];&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  return $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices-&gt;convert_price_amount( $cost, $currency );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cost;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function needs_filter_pricing_cost( $name, $fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $modifier_skip_values = array( 'divide', 'times' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(&nbsp;</div></li><li><div>          'override_block_' === $name ||&nbsp;</div></li><li><div>          ( 'cost_' === $name && !in_array( $fields[ 'modifier' ], $modifier_skip_values ) ) ||&nbsp;</div></li><li><div>          ( 'base_cost_' === $name && !in_array( $fields[ 'base_modifier' ], $modifier_skip_values ) )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function load_assets( $external_product_type = false ) {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_id = $pagenow == 'post.php' && isset( $_GET['post'] ) ? (int)$_GET['post'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $product_id && get_post_type( $product_id ) === 'product' ) {&nbsp;</div></li><li><div>          $product_type = WooCommerce_Functions_Wrapper::get_product_type( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ( $product_type === 'booking' || $product_type === $external_product_type ) || $pagenow == 'post-new.php' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_register_style( 'wcml-bookings-css', WCML_PLUGIN_URL . '/compatibility/res/css/wcml-bookings.css', array(), WCML_VERSION );&nbsp;</div></li><li><div>              wp_enqueue_style( 'wcml-bookings-css' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_register_script( 'wcml-bookings-js', WCML_PLUGIN_URL . '/compatibility/res/js/wcml-bookings.js', array( 'jquery' ), WCML_VERSION );&nbsp;</div></li><li><div>              wp_enqueue_script( 'wcml-bookings-js' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function localize_lock_fields_js() {&nbsp;</div></li><li><div>      wp_localize_script( 'wcml-bookings-js', 'lock_settings', array( 'lock_fields' =&gt; 1 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_multi_currency_is_ajax( $actions ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $actions[] = 'wc_bookings_calculate_costs';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $actions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_bundled_product_in_cart_contents( $cart_item, $key, $current_language ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $cart_item['data'] instanceof WC_Product_Booking && isset( $cart_item['booking'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $current_id = apply_filters( 'translate_object_id', $cart_item['product_id'], 'product', true, $current_language );&nbsp;</div></li><li><div>          $cart_product_id = $cart_item['product_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $current_id != $cart_product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $cart_item['data'] = new WC_Product_Booking( $current_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT || $current_id != $cart_product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $booking_info = array(&nbsp;</div></li><li><div>                  'wc_bookings_field_start_date_year' =&gt; $cart_item['booking']['_year'], &nbsp;</div></li><li><div>                  'wc_bookings_field_start_date_month' =&gt; $cart_item['booking']['_month'], &nbsp;</div></li><li><div>                  'wc_bookings_field_start_date_day' =&gt; $cart_item['booking']['_day'], &nbsp;</div></li><li><div>                  'add-to-cart' =&gt; $current_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $cart_item['booking']['_persons'] ) ) {&nbsp;</div></li><li><div>                  foreach ( $cart_item['booking']['_persons'] as $person_id =&gt; $value ) {&nbsp;</div></li><li><div>                      $booking_info[ 'wc_bookings_field_persons_' . apply_filters( 'translate_object_id', $person_id, 'bookable_person', false, $current_language ) ] = $value;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $cart_item['booking']['_resource_id'] ) ) {&nbsp;</div></li><li><div>                  $booking_info['wc_bookings_field_resource'] = apply_filters( 'translate_object_id', $cart_item['booking']['_resource_id'], 'bookable_resource', false, $current_language );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $cart_item['booking']['_duration'] ) ) {&nbsp;</div></li><li><div>                  $booking_info['wc_bookings_field_duration'] = $cart_item['booking']['_duration'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $cart_item['booking']['_time'] ) ) {&nbsp;</div></li><li><div>                  $booking_info['wc_bookings_field_start_date_time'] = $cart_item['booking']['_time'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $booking_form = new WC_Booking_Form( wc_get_product( $current_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $prod_qty = get_post_meta( $current_id, '_wc_booking_qty', true );&nbsp;</div></li><li><div>              update_post_meta( $current_id, '_wc_booking_qty', intval( $prod_qty + $cart_item['booking']['_qty'] ) );&nbsp;</div></li><li><div>              $cost = $booking_form-&gt;calculate_booking_cost( $booking_info );&nbsp;</div></li><li><div>              update_post_meta( $current_id, '_wc_booking_qty', $prod_qty );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! is_wp_error( $cost ) ) {&nbsp;</div></li><li><div>                  $cart_item['data']-&gt;set_price( $cost );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cart_item;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function booking_currency_dropdown() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>          $current_booking_currency = $this-&gt;get_cookie_booking_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wc_currencies = get_woocommerce_currencies();&nbsp;</div></li><li><div>          $currencies = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currencies( $include_default = true );&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;tr valign=&quot;top&quot;&gt;&nbsp;</div></li><li><div>              &lt;th scope=&quot;row&quot;&gt;&lt;?php _e( 'Booking currency', 'woocommerce-multilingual' ); ?&gt;&lt;/th&gt;&nbsp;</div></li><li><div>              &lt;td&gt;&nbsp;</div></li><li><div>                  &lt;select id=&quot;dropdown_booking_currency&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;?php foreach ( $currencies as $currency =&gt; $count ): ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          &lt;option&nbsp;</div></li><li><div>                              value=&quot;&lt;?php echo $currency ?&gt;&quot; &lt;?php echo $current_booking_currency == $currency ? 'selected=&quot;selected&quot;' : ''; ?&gt;&gt;&lt;?php echo $wc_currencies[ $currency ]; ?&gt;&lt;/option&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  &lt;/select&gt;&nbsp;</div></li><li><div>              &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wcml_booking_set_currency_nonce = wp_create_nonce( 'booking_set_currency' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wc_enqueue_js( &quot;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          jQuery(document).on('change', '#dropdown_booking_currency', function() {&nbsp;</div></li><li><div>             jQuery.ajax({&nbsp;</div></li><li><div>                  url: ajaxurl, &nbsp;</div></li><li><div>                  type: 'post', &nbsp;</div></li><li><div>                  data: {&nbsp;</div></li><li><div>                      action: 'wcml_booking_set_currency', &nbsp;</div></li><li><div>                      currency: jQuery('#dropdown_booking_currency').val(), &nbsp;</div></li><li><div>                      wcml_nonce: '&quot; . $wcml_booking_set_currency_nonce . &quot;'&nbsp;</div></li><li><div>                  }, &nbsp;</div></li><li><div>                  success: function( response ) {&nbsp;</div></li><li><div>                      if(typeof response.error !== 'undefined') {&nbsp;</div></li><li><div>                          alert(response.error);&nbsp;</div></li><li><div>                      }else{&nbsp;</div></li><li><div>                         window.location = window.location.href;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              })&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>      &quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function set_booking_currency_ajax() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $nonce = filter_input( INPUT_POST, 'wcml_nonce', FILTER_SANITIZE_FULL_SPECIAL_CHARS );&nbsp;</div></li><li><div>      if ( ! $nonce || ! wp_verify_nonce( $nonce, 'booking_set_currency' ) ) {&nbsp;</div></li><li><div>          echo json_encode( array( 'error' =&gt; __( 'Invalid nonce', 'woocommerce-multilingual' ) ) );&nbsp;</div></li><li><div>          die();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;set_booking_currency( filter_input( INPUT_POST, 'currency', FILTER_SANITIZE_FULL_SPECIAL_CHARS ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function set_booking_currency( $currency_code = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $_COOKIE ['_wcml_booking_currency'] ) && ! headers_sent() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $currency_code = get_woocommerce_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;woocommerce_wpml-&gt;settings['enable_multi_currency'] == WCML_MULTI_CURRENCIES_INDEPENDENT ) {&nbsp;</div></li><li><div>              $order_currencies = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;orders-&gt;get_orders_currencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! isset( $order_currencies[ $currency_code ] ) ) {&nbsp;</div></li><li><div>                  foreach ( $order_currencies as $currency_code =&gt; $count ) {&nbsp;</div></li><li><div>                      $currency_code = $currency_code;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $currency_code ) {&nbsp;</div></li><li><div>          setcookie( '_wcml_booking_currency', $currency_code, time() + 86400, COOKIEPATH, COOKIE_DOMAIN );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_cookie_booking_currency() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_COOKIE ['_wcml_booking_currency'] ) ) {&nbsp;</div></li><li><div>          $currency = $_COOKIE['_wcml_booking_currency'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $currency = get_woocommerce_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $currency;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_booking_currency_symbol( $currency ) {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_filter( 'woocommerce_currency_symbol', array( $this, 'filter_booking_currency_symbol' ) );&nbsp;</div></li><li><div>      if ( isset( $_COOKIE ['_wcml_booking_currency'] ) && $pagenow == 'edit.php' && isset( $_GET['page'] ) && $_GET['page'] == 'create_booking' ) {&nbsp;</div></li><li><div>          $currency = get_woocommerce_currency_symbol( $_COOKIE ['_wcml_booking_currency'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      add_filter( 'woocommerce_currency_symbol', array( $this, 'filter_booking_currency_symbol' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $currency;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function create_booking_page_client_currency( $currency ) {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wpml_is_ajax() && isset( $_POST['form'] ) ) {&nbsp;</div></li><li><div>          parse_str( $_POST['form'], $posted );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( $pagenow == 'edit.php' && isset( $_GET['page'] ) && $_GET['page'] == 'create_booking' ) || ( isset( $posted['_wp_http_referer'] ) && strpos( $posted['_wp_http_referer'], 'page=create_booking' ) !== false ) ) {&nbsp;</div></li><li><div>          $currency = $this-&gt;get_cookie_booking_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $currency;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function set_order_currency_on_create_booking_page( $order_id ) {&nbsp;</div></li><li><div>      update_post_meta( $order_id, '_order_currency', $this-&gt;get_cookie_booking_currency() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $order_id, 'wpml_language', $this-&gt;sitepress-&gt;get_current_language() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function filter_get_booking_products_args( $args ) {&nbsp;</div></li><li><div>      if ( isset( $args['suppress_filters'] ) ) {&nbsp;</div></li><li><div>          $args['suppress_filters'] = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function custom_box_html( $obj, $product_id, $data ) {&nbsp;</div></li><li><div>      if ( WooCommerce_Functions_Wrapper::get_product_type( $product_id ) !== 'booking' ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $bookings_section = new WPML_Editor_UI_Field_Section( __( 'Bookings', 'woocommerce-multilingual' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_post_meta( $product_id, '_wc_booking_has_resources', true ) == 'yes' ) {&nbsp;</div></li><li><div>          $group = new WPML_Editor_UI_Field_Group( '', true );&nbsp;</div></li><li><div>          $booking_field = new WPML_Editor_UI_Single_Line_Field( '_wc_booking_resouce_label', __( 'Resources Label', 'woocommerce-multilingual' ), $data, true );&nbsp;</div></li><li><div>          $group-&gt;add_field( $booking_field );&nbsp;</div></li><li><div>          $bookings_section-&gt;add_field( $group );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $orig_resources = maybe_unserialize( get_post_meta( $product_id, '_resource_base_costs', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $orig_resources ) {&nbsp;</div></li><li><div>          $group = new WPML_Editor_UI_Field_Group( __( 'Resources', 'woocommerce-multilingual' ) );&nbsp;</div></li><li><div>          $group_title = __( 'Resources', 'woocommerce-multilingual' );&nbsp;</div></li><li><div>          foreach ( $orig_resources as $resource_id =&gt; $cost ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $resource_id == 'custom_costs' ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $group = new WPML_Editor_UI_Field_Group( $group_title );&nbsp;</div></li><li><div>              $group_title = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $resource_field = new WPML_Editor_UI_Single_Line_Field( 'bookings-resource_' . $resource_id . '_title', __( 'Title', 'woocommerce-multilingual' ), $data, true );&nbsp;</div></li><li><div>              $group-&gt;add_field( $resource_field );&nbsp;</div></li><li><div>              $bookings_section-&gt;add_field( $group );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_persons = $this-&gt;get_original_persons( $product_id );&nbsp;</div></li><li><div>      end( $original_persons );&nbsp;</div></li><li><div>      $last_key = key( $original_persons );&nbsp;</div></li><li><div>      $divider = true;&nbsp;</div></li><li><div>      $group_title = __( 'Person Types', 'woocommerce-multilingual' );&nbsp;</div></li><li><div>      foreach ( $original_persons as $person_id ) {&nbsp;</div></li><li><div>          if ( $person_id == $last_key ) {&nbsp;</div></li><li><div>              $divider = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $group = new WPML_Editor_UI_Field_Group( $group_title, $divider );&nbsp;</div></li><li><div>          $group_title = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $person_field = new WPML_Editor_UI_Single_Line_Field( 'bookings-person_' . $person_id . '_title', __( 'Person Type Name', 'woocommerce-multilingual' ), $data, false );&nbsp;</div></li><li><div>          $group-&gt;add_field( $person_field );&nbsp;</div></li><li><div>          $person_field = new WPML_Editor_UI_Single_Line_Field( 'bookings-person_' . $person_id . '_description', __( 'Description', 'woocommerce-multilingual' ), $data, false );&nbsp;</div></li><li><div>          $group-&gt;add_field( $person_field );&nbsp;</div></li><li><div>          $bookings_section-&gt;add_field( $group );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $orig_resources || $original_persons ) {&nbsp;</div></li><li><div>          $obj-&gt;add_field( $bookings_section );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function custom_box_html_data( $data, $product_id, $translation, $lang ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( WooCommerce_Functions_Wrapper::get_product_type( $product_id ) !== 'booking' ) {&nbsp;</div></li><li><div>          return $data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_post_meta( $product_id, '_wc_booking_has_resources', true ) == 'yes' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data['_wc_booking_resouce_label'] = array( 'original' =&gt; get_post_meta( $product_id, '_wc_booking_resouce_label', true ) );&nbsp;</div></li><li><div>          $data['_wc_booking_resouce_label']['translation'] = $translation ? get_post_meta( $translation-&gt;ID, '_wc_booking_resouce_label', true ) : '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $orig_resources = $this-&gt;get_original_resources( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $orig_resources && is_array( $orig_resources ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $orig_resources as $resource_id =&gt; $cost ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 'custom_costs' === $resource_id ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $data[ 'bookings-resource_' . $resource_id . '_title' ] = array( 'original' =&gt; get_the_title( $resource_id ) );&nbsp;</div></li><li><div>              global $sitepress;&nbsp;</div></li><li><div>              $trns_resource_id = apply_filters( 'translate_object_id', $resource_id, 'bookable_resource', false, $lang );&nbsp;</div></li><li><div>              $data[ 'bookings-resource_' . $resource_id . '_title' ]['translation'] = $trns_resource_id ? get_the_title( $trns_resource_id ) : '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_persons = $this-&gt;get_original_persons( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $original_persons as $person_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data[ 'bookings-person_' . $person_id . '_title' ]       = array( 'original' =&gt; get_the_title( $person_id ) );&nbsp;</div></li><li><div>          $data[ 'bookings-person_' . $person_id . '_description' ] = array( 'original' =&gt; get_post( $person_id )-&gt;post_excerpt );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trnsl_person_id = apply_filters( 'translate_object_id', $person_id, 'bookable_person', false, $lang );&nbsp;</div></li><li><div>          $data[ 'bookings-person_' . $person_id . '_title' ]['translation'] = $trnsl_person_id ? get_the_title( $trnsl_person_id ) : '';&nbsp;</div></li><li><div>          $data[ 'bookings-person_' . $person_id . '_description' ]['translation'] = $trnsl_person_id ? get_post( $trnsl_person_id )-&gt;post_excerpt : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_original_resources( $product_id ) {&nbsp;</div></li><li><div>      $orig_resources = maybe_unserialize( get_post_meta( $product_id, '_resource_base_costs', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $orig_resources;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_original_persons( $product_id ) {&nbsp;</div></li><li><div>      $original_persons = $this-&gt;wpdb-&gt;get_col( $this-&gt;wpdb-&gt;prepare( &quot;SELECT ID FROM {$this-&gt;wpdb-&gt;posts} WHERE post_parent = %d AND post_type = 'bookable_person' AND post_status = 'publish'&quot;, $product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $original_persons;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function show_custom_blocks_for_resources_and_persons( $check, $product_id, $product_content ) {&nbsp;</div></li><li><div>      if ( in_array( $product_content, array( 'wc_booking_resources', 'wc_booking_persons' ) ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $check;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function remove_custom_fields_to_translate( $exception, $product_id, $meta_key ) {&nbsp;</div></li><li><div>      if ( in_array( $meta_key, array( '_resource_base_costs', '_resource_block_costs' ) ) ) {&nbsp;</div></li><li><div>          $exception = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $exception;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function remove_single_custom_fields_to_translate( $fields ) {&nbsp;</div></li><li><div>      $fields[] = '_wc_booking_resouce_label';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $fields;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function product_content_resource_label( $meta_key, $product_id ) {&nbsp;</div></li><li><div>      if ( $meta_key == '_wc_booking_resouce_label' ) {&nbsp;</div></li><li><div>          return __( 'Resources label', 'woocommerce-multilingual' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $meta_key;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_products_tab_sync_resources_and_persons( $original_product_id, $tr_product_id, $data, $language ) {&nbsp;</div></li><li><div>      global $wpml_post_translations;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_action( 'save_post', array( $wpml_post_translations, 'save_post_actions' ), 100, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $orig_resources = $orig_resources = $this-&gt;get_original_resources( $original_product_id );;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $orig_resources ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $orig_resources as $orig_resource_id =&gt; $cost ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $resource_id = apply_filters( 'translate_object_id', $orig_resource_id, 'bookable_resource', false, $language );&nbsp;</div></li><li><div>              $orig_resource = $this-&gt;wpdb-&gt;get_row( $this-&gt;wpdb-&gt;prepare( &quot;SELECT resource_id, sort_order FROM {$this-&gt;wpdb-&gt;prefix}wc_booking_relationships WHERE resource_id = %d AND product_id = %d&quot;, $orig_resource_id, $original_product_id ), OBJECT );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_null( $resource_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $orig_resource ) {&nbsp;</div></li><li><div>                      $resource_id = $this-&gt;duplicate_resource( $tr_product_id, $orig_resource, $language );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">//update_relationship</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $exist = $this-&gt;wpdb-&gt;get_var( $this-&gt;wpdb-&gt;prepare( &quot;SELECT ID FROM {$this-&gt;wpdb-&gt;prefix}wc_booking_relationships WHERE resource_id = %d AND product_id = %d&quot;, $resource_id, $tr_product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! $exist ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this-&gt;wpdb-&gt;insert(&nbsp;</div></li><li><div>                          $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', &nbsp;</div></li><li><div>                          array(&nbsp;</div></li><li><div>                              'product_id' =&gt; $tr_product_id, &nbsp;</div></li><li><div>                              'resource_id' =&gt; $resource_id, &nbsp;</div></li><li><div>                              'sort_order' =&gt; $orig_resource-&gt;sort_order&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>                  $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'post_title' =&gt; $data[ md5( 'bookings-resource_' . $orig_resource_id . '_title' ) ]&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'ID' =&gt; $resource_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              update_post_meta( $resource_id, 'wcml_is_translated', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//sync resources data</span>&nbsp;</div></li><li><div>          $this-&gt;sync_resources( $original_product_id, $tr_product_id, $language, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_persons = $this-&gt;get_original_persons( $original_product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//sync persons</span>&nbsp;</div></li><li><div>      if ( $original_persons ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $original_persons as $original_person_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $person_id = apply_filters( 'translate_object_id', $original_person_id, 'bookable_person', false, $language );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_null( $person_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $person_id = $this-&gt;duplicate_person( $tr_product_id, $original_person_id, $language );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>                      $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>                      array(&nbsp;</div></li><li><div>                          'post_parent' =&gt; $tr_product_id&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                      array(&nbsp;</div></li><li><div>                          'ID' =&gt; $person_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>                  $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'post_title' =&gt; $data[ md5( 'bookings-person_' . $original_person_id . '_title' ) ], &nbsp;</div></li><li><div>                      'post_excerpt' =&gt; $data[ md5( 'bookings-person_' . $original_person_id . '_description' ) ], &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'ID' =&gt; $person_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              update_post_meta( $person_id, 'wcml_is_translated', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//sync persons</span> data&nbsp;</div></li><li><div>          $this-&gt;sync_persons( $original_product_id, $tr_product_id, $language, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'save_post', array( $wpml_post_translations, 'save_post_actions' ), 100, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function duplicate_booking_for_translations( $booking_id, $lang = false ) {&nbsp;</div></li><li><div>      $booking_object = get_post( $booking_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $booking_data = array(&nbsp;</div></li><li><div>          'post_type' =&gt; 'wc_booking', &nbsp;</div></li><li><div>          'post_title' =&gt; $booking_object-&gt;post_title, &nbsp;</div></li><li><div>          'post_status' =&gt; $booking_object-&gt;post_status, &nbsp;</div></li><li><div>          'ping_status' =&gt; 'closed'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $booking_object-&gt;post_parent && $lang ) {&nbsp;</div></li><li><div>          $translated_parent = apply_filters( 'translate_object_id', $booking_object-&gt;post_parent, get_post_type( $booking_object-&gt;post_parent ), false, $lang );&nbsp;</div></li><li><div>          if( $translated_parent ) $booking_data[ 'post_parent' ] = $translated_parent;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $active_languages = $this-&gt;sitepress-&gt;get_active_languages();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $active_languages as $language ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $booking_product_id = get_post_meta( $booking_id, '_booking_product_id', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $lang ) {&nbsp;</div></li><li><div>              $booking_language = $this-&gt;sitepress-&gt;get_element_language_details( $booking_product_id, 'post_product' );&nbsp;</div></li><li><div>              if ( $booking_language-&gt;language_code == $language['code'] ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif ( $lang != $language['code'] ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $booking_persons = maybe_unserialize( get_post_meta( $booking_id, '_booking_persons', true ) );&nbsp;</div></li><li><div>          $trnsl_booking_persons = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_array( $booking_persons ) && ! empty( $booking_persons ) ) {&nbsp;</div></li><li><div>              foreach ( $booking_persons as $person_id =&gt; $person_count ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $trnsl_person_id = apply_filters( 'translate_object_id', $person_id, 'bookable_person', false, $language['code'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( is_null( $trnsl_person_id ) ) {&nbsp;</div></li><li><div>                      $trnsl_booking_persons[] = $person_count;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $trnsl_booking_persons[ $trnsl_person_id ] = $person_count;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trnsl_booking_id = wp_insert_post( $booking_data );&nbsp;</div></li><li><div>          $trid = $this-&gt;sitepress-&gt;get_element_trid( $booking_id );&nbsp;</div></li><li><div>          $this-&gt;sitepress-&gt;set_element_language_details( $trnsl_booking_id, 'post_wc_booking', $trid, $language['code'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta_args = array(&nbsp;</div></li><li><div>              '_booking_order_item_id' =&gt; 0, &nbsp;</div></li><li><div>              '_booking_product_id' =&gt; $this-&gt;get_translated_booking_product_id( $booking_id, $language['code'] ), &nbsp;</div></li><li><div>              '_booking_resource_id' =&gt; $this-&gt;get_translated_booking_resource_id( $booking_id, $language['code'] ), &nbsp;</div></li><li><div>              '_booking_persons' =&gt; $this-&gt;get_translated_booking_persons_ids( $booking_id, $language['code'] ), &nbsp;</div></li><li><div>              '_booking_cost' =&gt; get_post_meta( $booking_id, '_booking_cost', true ), &nbsp;</div></li><li><div>              '_booking_start' =&gt; get_post_meta( $booking_id, '_booking_start', true ), &nbsp;</div></li><li><div>              '_booking_end' =&gt; get_post_meta( $booking_id, '_booking_end', true ), &nbsp;</div></li><li><div>              '_booking_all_day' =&gt; intval( get_post_meta( $booking_id, '_booking_all_day', true ) ), &nbsp;</div></li><li><div>              '_booking_parent_id' =&gt; get_post_meta( $booking_id, '_booking_parent_id', true ), &nbsp;</div></li><li><div>              '_booking_customer_id' =&gt; get_post_meta( $booking_id, '_booking_customer_id', true ), &nbsp;</div></li><li><div>              '_booking_duplicate_of' =&gt; $booking_id, &nbsp;</div></li><li><div>              '_language_code' =&gt; $language['code'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $meta_args as $key =&gt; $value ) {&nbsp;</div></li><li><div>              update_post_meta( $trnsl_booking_id, $key, $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          WC_Cache_Helper::get_transient_version( 'bookings', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_translated_booking_product_id( $booking_id, $language ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $booking_product_id = get_post_meta( $booking_id, '_booking_product_id', true );&nbsp;</div></li><li><div>      $trnsl_booking_product_id = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $booking_product_id ) {&nbsp;</div></li><li><div>          $trnsl_booking_product_id = apply_filters( 'translate_object_id', $booking_product_id, 'product', false, $language );&nbsp;</div></li><li><div>          if ( is_null( $trnsl_booking_product_id ) ) {&nbsp;</div></li><li><div>              $trnsl_booking_product_id = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $trnsl_booking_product_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_translated_booking_resource_id( $booking_id, $language ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $booking_resource_id = get_post_meta( $booking_id, '_booking_resource_id', true );&nbsp;</div></li><li><div>      $trnsl_booking_resource_id = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $booking_resource_id ) {&nbsp;</div></li><li><div>          $trnsl_booking_resource_id = apply_filters( 'translate_object_id', $booking_resource_id, 'bookable_resource', false, $language );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_null( $trnsl_booking_resource_id ) ) {&nbsp;</div></li><li><div>              $trnsl_booking_resource_id = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $trnsl_booking_resource_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_translated_booking_persons_ids( $booking_id, $language ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $booking_persons = maybe_unserialize( get_post_meta( $booking_id, '_booking_persons', true ) );&nbsp;</div></li><li><div>      $trnsl_booking_persons = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $booking_persons ) && ! empty( $booking_persons ) ) {&nbsp;</div></li><li><div>          foreach ( $booking_persons as $person_id =&gt; $person_count ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $trnsl_person_id = apply_filters( 'translate_object_id', $person_id, 'bookable_person', false, $language );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_null( $trnsl_person_id ) ) {&nbsp;</div></li><li><div>                  $trnsl_booking_persons[] = $person_count;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $trnsl_booking_persons[ $trnsl_person_id ] = $person_count;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $trnsl_booking_persons;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function update_status_for_translations( $booking_id ) {&nbsp;</div></li><li><div>      $translated_bookings = $this-&gt;get_translated_bookings( $booking_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $translated_bookings as $booking ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $status = $this-&gt;wpdb-&gt;get_var( $this-&gt;wpdb-&gt;prepare( &quot;SELECT post_status FROM {$this-&gt;wpdb-&gt;posts} WHERE ID = %d&quot;, $booking_id ) ); <span class="comment">//get_post_status( $booking_id );</span>&nbsp;</div></li><li><div>          $language = get_post_meta( $booking-&gt;post_id, '_language_code', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>              $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'post_status' =&gt; $status, &nbsp;</div></li><li><div>                  'post_parent' =&gt; wp_get_post_parent_id( $booking_id ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'ID' =&gt; $booking-&gt;post_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_post_meta( $booking-&gt;post_id, '_booking_product_id', $this-&gt;get_translated_booking_product_id( $booking_id, $language ) );&nbsp;</div></li><li><div>          update_post_meta( $booking-&gt;post_id, '_booking_resource_id', $this-&gt;get_translated_booking_resource_id( $booking_id, $language ) );&nbsp;</div></li><li><div>          update_post_meta( $booking-&gt;post_id, '_booking_persons', $this-&gt;get_translated_booking_persons_ids( $booking_id, $language ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_translated_bookings( $booking_id ) {&nbsp;</div></li><li><div>      $translated_bookings = $this-&gt;wpdb-&gt;get_results( $this-&gt;wpdb-&gt;prepare( &quot;SELECT post_id FROM {$this-&gt;wpdb-&gt;postmeta} WHERE meta_key = '_booking_duplicate_of' AND meta_value = %d&quot;, $booking_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $translated_bookings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function booking_filters_query( $query ) {&nbsp;</div></li><li><div>      global $typenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ( isset( $query-&gt;query_vars['post_type'] ) && $query-&gt;query_vars['post_type'] == 'wc_booking' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $current_lang = $this-&gt;sitepress-&gt;get_current_language();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $product_ids = $this-&gt;wpdb-&gt;get_col( $this-&gt;wpdb-&gt;prepare(&nbsp;</div></li><li><div>              &quot;SELECT element_id&nbsp;</div></li><li><div>                  FROM {$this-&gt;wpdb-&gt;prefix}icl_translations&nbsp;</div></li><li><div>                  WHERE language_code = %s AND element_type = 'post_product'&quot;, $current_lang ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $product_ids = array_diff( $product_ids, array( null ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ( ! isset( $_GET['lang'] ) || ( isset( $_GET['lang'] ) && $_GET['lang'] != 'all' ) ) ) {&nbsp;</div></li><li><div>              $query-&gt;query_vars['meta_query'][] = array(&nbsp;</div></li><li><div>                  'relation' =&gt; 'OR', &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'key' =&gt; '_language_code', &nbsp;</div></li><li><div>                      'value' =&gt; $current_lang, &nbsp;</div></li><li><div>                      'compare ' =&gt; '='&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'key' =&gt; '_booking_product_id', &nbsp;</div></li><li><div>                      'value' =&gt; $product_ids, &nbsp;</div></li><li><div>                      'compare ' =&gt; 'IN'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $query;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function bookings_in_date_range_query( $booking_ids ) {&nbsp;</div></li><li><div>      foreach ( $booking_ids as $key =&gt; $booking_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $language_code = $this-&gt;sitepress-&gt;get_language_for_element( get_post_meta( $booking_id, '_booking_product_id', true ), 'post_product' );&nbsp;</div></li><li><div>          $current_language = $this-&gt;sitepress-&gt;get_current_language();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $language_code != $current_language ) {&nbsp;</div></li><li><div>              unset( $booking_ids[ $key ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $booking_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function clear_transient_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['post_type'] ) && $_GET['post_type'] == 'wc_booking' && isset( $_GET['page'] ) && $_GET['page'] == 'booking_calendar' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//delete transient fields</span>&nbsp;</div></li><li><div>          $this-&gt;wpdb-&gt;query( &quot;&nbsp;</div></li><li><div>              DELETE FROM {$this-&gt;wpdb-&gt;options}&nbsp;</div></li><li><div>              WHERE option_name LIKE '%book_dr_%'&nbsp;</div></li><li><div>          &quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function delete_bookings( $booking_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $booking_id &gt; 0 && get_post_type( $booking_id ) == 'wc_booking' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $translated_bookings = $this-&gt;get_translated_bookings( $booking_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          remove_action( 'before_delete_post', array( $this, 'delete_bookings' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $translated_bookings as $booking ) {&nbsp;</div></li><li><div>              $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>                  $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'post_parent' =&gt; 0&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'ID' =&gt; $booking-&gt;post_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_delete_post( $booking-&gt;post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'before_delete_post', array( $this, 'delete_bookings' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function trash_bookings( $booking_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $booking_id &gt; 0 && get_post_type( $booking_id ) == 'wc_booking' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $translated_bookings = $this-&gt;get_translated_bookings( $booking_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $translated_bookings as $booking ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>                  $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'post_status' =&gt; 'trash'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'ID' =&gt; $booking-&gt;post_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function append_persons_to_translation_package( $package, $post ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $post-&gt;post_type == 'product' ) {&nbsp;</div></li><li><div>          $product_type = WooCommerce_Functions_Wrapper::get_product_type( $post-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $product_type === 'booking' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $bookable_product = new WC_Product_Booking( $post-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $person_types = $bookable_product-&gt;get_person_types();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $person_types as $person_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $bookable_person = get_post( $person_type-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $package['contents'][ 'wc_bookings:person:' . $bookable_person-&gt;ID . ':name' ] = array(&nbsp;</div></li><li><div>                      'translate' =&gt; 1, &nbsp;</div></li><li><div>                      'data' =&gt; $this-&gt;tp-&gt;encode_field_data( $bookable_person-&gt;post_title, 'base64' ), &nbsp;</div></li><li><div>                      'format' =&gt; 'base64'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $package['contents'][ 'wc_bookings:person:' . $bookable_person-&gt;ID . ':description' ] = array(&nbsp;</div></li><li><div>                      'translate' =&gt; 1, &nbsp;</div></li><li><div>                      'data' =&gt; $this-&gt;tp-&gt;encode_field_data( $bookable_person-&gt;post_excerpt, 'base64' ), &nbsp;</div></li><li><div>                      'format' =&gt; 'base64'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $package;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_person_translation( $post_id, $data, $job ) {&nbsp;</div></li><li><div>      $person_translations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( WooCommerce_Functions_Wrapper::get_product_type( $post_id ) === 'booking' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $data as $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $value['finished'] && strpos( $value['field_type'], 'wc_bookings:person:' ) === 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $exp = explode( ':', $value['field_type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $person_id = $exp[2];&nbsp;</div></li><li><div>                  $field = $exp[3];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $person_translations[ $person_id ][ $field ] = $value['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $person_translations ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $person_translations as $person_id =&gt; $pt ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $person_trid = $this-&gt;sitepress-&gt;get_element_trid( $person_id, 'post_bookable_person' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $person_id_translated = apply_filters( 'translate_object_id', $person_id, 'bookable_person', false, $job-&gt;language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( empty( $person_id_translated ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $person_post = array(&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          'post_type' =&gt; 'bookable_person', &nbsp;</div></li><li><div>                          'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>                          'post_title' =&gt; $pt['name'], &nbsp;</div></li><li><div>                          'post_parent' =&gt; $post_id, &nbsp;</div></li><li><div>                          'post_excerpt' =&gt; isset( $pt['description'] ) ? $pt['description'] : ''&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $person_id_translated = wp_insert_post( $person_post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this-&gt;sitepress-&gt;set_element_language_details( $person_id_translated, 'post_bookable_person', $person_trid, $job-&gt;language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $person_post = array(&nbsp;</div></li><li><div>                          'ID' =&gt; $person_id_translated, &nbsp;</div></li><li><div>                          'post_title' =&gt; $pt['name'], &nbsp;</div></li><li><div>                          'post_excerpt' =&gt; isset( $pt['description'] ) ? $pt['description'] : ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      wp_update_post( $person_post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function append_resources_to_translation_package( $package, $post ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $post-&gt;post_type == 'product' ) {&nbsp;</div></li><li><div>          $product = wc_get_product( $post-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $product_type = WooCommerce_Functions_Wrapper::get_product_type( $post-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $product_type === 'booking' && $product-&gt;has_resources() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $resources = $product-&gt;get_resources();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $resources as $resource ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $package['contents'][ 'wc_bookings:resource:' . $resource-&gt;ID . ':name' ] = array(&nbsp;</div></li><li><div>                      'translate' =&gt; 1, &nbsp;</div></li><li><div>                      'data' =&gt; $this-&gt;tp-&gt;encode_field_data( $resource-&gt;post_title, 'base64' ), &nbsp;</div></li><li><div>                      'format' =&gt; 'base64'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $package;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function save_resource_translation( $post_id, $data, $job ) {&nbsp;</div></li><li><div>      $resource_translations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( WooCommerce_Functions_Wrapper::get_product_type( $post_id ) === 'booking' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $data as $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $value['finished'] && strpos( $value['field_type'], 'wc_bookings:resource:' ) === 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $exp = explode( ':', $value['field_type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $resource_id = $exp[2];&nbsp;</div></li><li><div>                  $field = $exp[3];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $resource_translations[ $resource_id ][ $field ] = $value['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $resource_translations ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $resource_translations as $resource_id =&gt; $rt ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $resource_trid = $this-&gt;sitepress-&gt;get_element_trid( $resource_id, 'post_bookable_resource' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $resource_id_translated = apply_filters( 'translate_object_id', $resource_id, 'bookable_resource', false, $job-&gt;language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( empty( $resource_id_translated ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $resource_post = array(&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          'post_type' =&gt; 'bookable_resource', &nbsp;</div></li><li><div>                          'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>                          'post_title' =&gt; $rt['name'], &nbsp;</div></li><li><div>                          'post_parent' =&gt; $post_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $resource_id_translated = wp_insert_post( $resource_post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this-&gt;sitepress-&gt;set_element_language_details( $resource_id_translated, 'post_bookable_resource', $resource_trid, $job-&gt;language_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $sort_order = $this-&gt;wpdb-&gt;get_var( $this-&gt;wpdb-&gt;prepare( &quot;SELECT sort_order FROM {$this-&gt;wpdb-&gt;prefix}wc_booking_relationships WHERE resource_id=%d&quot;, $resource_id ) );&nbsp;</div></li><li><div>                      $relationship = array(&nbsp;</div></li><li><div>                          'product_id' =&gt; $post_id, &nbsp;</div></li><li><div>                          'resource_id' =&gt; $resource_id_translated, &nbsp;</div></li><li><div>                          'sort_order' =&gt; $sort_order&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                      $this-&gt;wpdb-&gt;insert( $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', $relationship );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $resource_post = array(&nbsp;</div></li><li><div>                          'ID' =&gt; $resource_id_translated, &nbsp;</div></li><li><div>                          'post_title' =&gt; $rt['name']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      wp_update_post( $resource_post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $sort_order = $this-&gt;wpdb-&gt;get_var( $this-&gt;wpdb-&gt;prepare( &quot;SELECT sort_order FROM {$this-&gt;wpdb-&gt;prefix}wc_booking_relationships WHERE resource_id=%d&quot;, $resource_id ) );&nbsp;</div></li><li><div>                      $this-&gt;wpdb-&gt;update( $this-&gt;wpdb-&gt;prefix . 'wc_booking_relationships', array( 'sort_order' =&gt; $sort_order ), &nbsp;</div></li><li><div>                          array( 'product_id' =&gt; $post_id, 'resource_id' =&gt; $resource_id_translated ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wcml_js_lock_fields_ids( $ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ids = array_merge( $ids, array(&nbsp;</div></li><li><div>          '_wc_booking_has_resources', &nbsp;</div></li><li><div>          '_wc_booking_has_persons', &nbsp;</div></li><li><div>          '_wc_booking_duration_type', &nbsp;</div></li><li><div>          '_wc_booking_duration', &nbsp;</div></li><li><div>          '_wc_booking_duration_unit', &nbsp;</div></li><li><div>          '_wc_booking_calendar_display_mode', &nbsp;</div></li><li><div>          '_wc_booking_requires_confirmation', &nbsp;</div></li><li><div>          '_wc_booking_user_can_cancel', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_min_duration', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_max_duration', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_max_duration', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_calendar_display_mode', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_requires_confirmation', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_user_can_cancel', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_cancel_limit', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_cancel_limit_unit', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_qty', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_min_date', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_min_date_unit', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_max_date', &nbsp;</div></li><li><div>          '_wc_accommodation_booking_max_date_unit', &nbsp;</div></li><li><div>          'bookings_pricing select', &nbsp;</div></li><li><div>          'bookings_resources select', &nbsp;</div></li><li><div>          'bookings_availability select', &nbsp;</div></li><li><div>          'bookings_persons input[type=&quot;checkbox&quot;]'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $ids;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function filter_get_booking_resources_args( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $screen = get_current_screen();&nbsp;</div></li><li><div>      if ( $screen-&gt;id == 'product' ) {&nbsp;</div></li><li><div>          $args['suppress_filters'] = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $currencies</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function update_booking_costs( $currencies = array(), $post_id = 0 ) {&nbsp;</div></li><li><div>      $booking_options = array(&nbsp;</div></li><li><div>          'wcml_wc_booking_cost' =&gt; '_wc_booking_cost_', &nbsp;</div></li><li><div>          'wcml_wc_booking_base_cost' =&gt; '_wc_booking_base_cost_', &nbsp;</div></li><li><div>          'wcml_wc_display_cost' =&gt; '_wc_display_cost_', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>          foreach ( $booking_options as $booking_options_post_key =&gt; $booking_options_meta_key_prefix ) {&nbsp;</div></li><li><div>              if ( isset( $_POST[ $booking_options_post_key ][ $code ] ) ) {&nbsp;</div></li><li><div>                  update_post_meta( $post_id, $booking_options_meta_key_prefix . $code, sanitize_text_field( $_POST[ $booking_options_post_key ][ $code ] ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $currencies</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function update_booking_pricing( $currencies = array(), $post_id = 0 ) {&nbsp;</div></li><li><div>      $updated_meta = array();&nbsp;</div></li><li><div>      $booking_pricing = get_post_meta( $post_id, '_wc_booking_pricing', true );&nbsp;</div></li><li><div>      if ( empty( $booking_pricing ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $booking_pricing as $key =&gt; $prices ) {&nbsp;</div></li><li><div>          $updated_meta[ $key ] = $prices;&nbsp;</div></li><li><div>          foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>              if ( isset( $_POST['wcml_wc_booking_pricing_base_cost'][ $code ][ $key ] ) ) {&nbsp;</div></li><li><div>                  $updated_meta[ $key ][ 'base_cost_' . $code ] = sanitize_text_field( $_POST['wcml_wc_booking_pricing_base_cost'][ $code ][ $key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( isset( $_POST['wcml_wc_booking_pricing_cost'][ $code ][ $key ] ) ) {&nbsp;</div></li><li><div>                  $updated_meta[ $key ][ 'cost_' . $code ] = sanitize_text_field( $_POST['wcml_wc_booking_pricing_cost'][ $code ][ $key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $post_id, '_wc_booking_pricing', $updated_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $currencies</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $person_costs</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function update_booking_person_cost( $currencies = array(), $person_costs = array() ) {&nbsp;</div></li><li><div>      if ( empty( $person_costs ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $person_costs as $person_id =&gt; $costs ) {&nbsp;</div></li><li><div>          foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>              if ( isset( $costs[ $code ] ) ) {&nbsp;</div></li><li><div>                  update_post_meta( $person_id, 'cost_' . $code, sanitize_text_field( $costs[ $code ] ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $currencies</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $block_costs</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function update_booking_person_block_cost( $currencies = array(), $block_costs = array() ) {&nbsp;</div></li><li><div>      if ( empty( $block_costs ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $block_costs as $person_id =&gt; $costs ) {&nbsp;</div></li><li><div>          foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>              if ( isset( $costs[ $code ] ) ) {&nbsp;</div></li><li><div>                  update_post_meta( $person_id, 'block_cost_' . $code, sanitize_text_field( $costs[ $code ] ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $currencies</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $resource_cost</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function update_booking_resource_cost( $currencies = array(), $post_id = 0, $resource_cost = array() ) {&nbsp;</div></li><li><div>      if ( empty( $resource_cost ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $updated_meta = get_post_meta( $post_id, '_resource_base_costs', true );&nbsp;</div></li><li><div>      if ( ! is_array( $updated_meta ) ) {&nbsp;</div></li><li><div>          $updated_meta = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wc_booking_resource_costs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $resource_cost as $resource_id =&gt; $costs ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $costs[ $code ] ) ) {&nbsp;</div></li><li><div>                  $wc_booking_resource_costs[ $code ][ $resource_id ] = sanitize_text_field( $costs[ $code ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $updated_meta['custom_costs'] = $wc_booking_resource_costs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $post_id, '_resource_base_costs', $updated_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;sync_resource_costs_with_translations( $post_id, '_resource_base_costs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $currencies</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function update_booking_resource_block_cost( $currencies = array(), $post_id = 0, $resource_block_cost = array() ) {&nbsp;</div></li><li><div>      if ( empty( $resource_block_cost ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $updated_meta = get_post_meta( $post_id, '_resource_block_costs', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wc_booking_resource_block_costs = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $resource_block_cost as $resource_id =&gt; $costs ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $currencies as $code =&gt; $currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $costs[ $code ] ) ) {&nbsp;</div></li><li><div>                  $wc_booking_resource_block_costs[ $code ][ $resource_id ] = sanitize_text_field( $costs[ $code ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $updated_meta['custom_costs'] = $wc_booking_resource_block_costs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $post_id, '_resource_block_costs', $updated_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;sync_resource_costs_with_translations( $post_id, '_resource_block_costs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function maybe_fix_double_serialized_wc_booking_availability( $mid, $object_id, $meta_key, $_meta_value ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( version_compare( ICL_SITEPRESS_VERSION, '3.6', '&lt;' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta_keys_to_fix = array(&nbsp;</div></li><li><div>              '_wc_booking_availability', &nbsp;</div></li><li><div>              '_wc_booking_pricing'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( in_array( $meta_key, $meta_keys_to_fix ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_string( $_meta_value ) ) {&nbsp;</div></li><li><div>                  $wpdb-&gt;update( $wpdb-&gt;postmeta, array( 'meta_value' =&gt; $_meta_value ), array( 'meta_id' =&gt; $mid ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function extra_conditions_to_filter_bookings( $extra_conditions ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $_GET[ 'post_type' ] ) && $_GET[ 'post_type' ] == 'wc_booking' && !isset( $_GET[ 'post_status' ] ) ) {&nbsp;</div></li><li><div>          $extra_conditions = str_replace( &quot;GROUP BY&quot;, &quot; AND post_status = 'confirmed' GROUP BY&quot;, $extra_conditions );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $extra_conditions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function hide_bookings_type_on_tm_dashboard( $types ) {&nbsp;</div></li><li><div>      unset( $types[ 'wc_booking' ] );&nbsp;</div></li><li><div>      return $types;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function show_pointer_info() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pointer_ui = new WCML_Pointer_UI(&nbsp;</div></li><li><div>          sprintf( __( 'You can translate the titles of your custom Resources on the %sWooCommerce product translation page%s', 'woocommerce-multilingual' ), '&lt;a href=&quot;'.admin_url('admin.php?page=wpml-wcml').'&quot;&gt;', '&lt;/a&gt;' ), &nbsp;</div></li><li><div>          'https:<span class="comment"><span class="comment">//wpml.org/documentation/woocommerce-extensions-compatibility/translating-woocommerce-bookings-woocommerce-multilingual/', </span></span>&nbsp;</div></li><li><div>          'bookings_resources .woocommerce_bookable_resources #message'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pointer_ui-&gt;show();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pointer_ui = new WCML_Pointer_UI(&nbsp;</div></li><li><div>          sprintf( __( 'You can translate the Person Type Name and Description on the  %sWooCommerce product translation page%s', 'woocommerce-multilingual' ), '&lt;a href=&quot;'.admin_url('admin.php?page=wpml-wcml').'&quot;&gt;', '&lt;/a&gt;' ), &nbsp;</div></li><li><div>          'https:<span class="comment"><span class="comment">//wpml.org/documentation/woocommerce-extensions-compatibility/translating-woocommerce-bookings-woocommerce-multilingual/', </span></span>&nbsp;</div></li><li><div>          'bookings_persons #persons-types&gt;div.toolbar'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pointer_ui-&gt;show();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_to_cart_sold_individually( $sold_indiv, $cart_item_data, $product_id, $quantity ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset(  $cart_item_data[ 'booking' ] ) ) {&nbsp;</div></li><li><div>          $sold_indiv = false;&nbsp;</div></li><li><div>          foreach( WC()-&gt;cart-&gt;cart_contents as $cart_item ) {&nbsp;</div></li><li><div>              if(&nbsp;</div></li><li><div>                  isset( $cart_item[ 'booking' ] ) && isset( $cart_item[ 'booking' ][ '_booking_id' ] ) &&&nbsp;</div></li><li><div>                  $cart_item[ 'booking' ][ '_start_date' ] == $cart_item_data[ 'booking' ][ '_start_date' ] &&&nbsp;</div></li><li><div>                  $cart_item[ 'booking' ][ '_end_date' ] == $cart_item_data[ 'booking' ][ '_end_date' ] &&&nbsp;</div></li><li><div>                  $cart_item[ 'booking' ][ '_booking_id' ] == $cart_item_data[ 'booking' ][ '_booking_id' ]&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                  $sold_indiv = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $sold_indiv;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// unset &quot;bookings&quot; from translatable documents to hide WPML languages section from booking edit page</span>&nbsp;</div></li><li><div>  public function filter_translatable_documents( $icl_post_types ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(&nbsp;</div></li><li><div>          ( isset( $_GET[ 'post' ] ) && get_post_type( $_GET[ 'post' ] ) == 'wc_booking' ) ||&nbsp;</div></li><li><div>          ( isset( $_GET[ 'post_type' ] ) && $_GET[ 'post_type' ] == 'wc_booking' )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          unset( $icl_post_types[ 'wc_booking' ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $icl_post_types;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// hide WPML languages links section from bookings list page</span>&nbsp;</div></li><li><div>  public function filter_is_translated_post_type( $type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $_GET[ 'post_type' ] ) && $_GET[ 'post_type' ] == 'wc_booking' ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $type;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $post_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param WP_Post $post</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $update</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function sync_booking_status( $post_id, $post, $update ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $post-&gt;post_type === 'wc_booking' && $update ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $trid = $this-&gt;sitepress-&gt;get_element_trid( $post_id, 'post_wc_booking' );&nbsp;</div></li><li><div>          $translations = $this-&gt;sitepress-&gt;get_element_translations( $trid, 'post_wc_booking' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach( $translations as $translation ) {&nbsp;</div></li><li><div>              if( $translation-&gt;element_id != $post_id ) {&nbsp;</div></li><li><div>                  $this-&gt;wpdb-&gt;update(&nbsp;</div></li><li><div>                      $this-&gt;wpdb-&gt;posts, &nbsp;</div></li><li><div>                      array( 'post_status' =&gt; $post-&gt;post_status ), &nbsp;</div></li><li><div>                      array( 'ID' =&gt; $translation-&gt;element_id )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Multilingual</li><li><span></span>4.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>