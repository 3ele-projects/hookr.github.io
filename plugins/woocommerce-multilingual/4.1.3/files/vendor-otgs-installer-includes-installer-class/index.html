<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.1.3" data-slug="woocommerce-multilingual" data-type="file" data-id="19100"><head xmlns="http://www.w3.org/1999/xhtml"><title> vendor-otgs-installer-includes-installer-class | file | Woocommerce Multilingual | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-multilingual, 4.1.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=10e38f7ea687dd516658912c47a46d9d' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/vendor-otgs-installer-includes-installer-class/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fvendor-otgs-installer-includes-installer-class%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fvendor-otgs-installer-includes-installer-class%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-multilingual-4.1.3-file-vendor-otgs-installer-includes-installer-class","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="vendor-otgs-installer-includes-installer-class" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-multilingual." href="http://hookr.io/plugins/woocommerce-multilingual/" class="plugin"><span property="name">woocommerce-multilingual</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.1.3." href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/" class="H_VERSION"><span property="name">4.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">vendor-otgs-installer-include&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="810"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/all/" title="All">All <span class="count badge">810</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="350"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/hooks/" title="Hooks">Hooks <span class="count badge">350</span></a></li><li class="" data-id="action" data-count="47"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/actions/" title="Actions">Actions <span class="count badge">47</span></a></li><li class="" data-id="filter" data-count="303"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/filters/" title="Filters">Filters <span class="count badge">303</span></a></li><li class="" data-id="class" data-count="429"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/classes/" title="Classes">Classes <span class="count badge">429</span></a></li><li class="" data-id="constant" data-count="16"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/constants/" title="Constants">Constants <span class="count badge">16</span></a></li><li class="" data-id="function" data-count="14"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/functions/" title="Functions">Functions <span class="count badge">14</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/vendor/otgs/installer/includes/installer.class.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>final class WP_Installer{&nbsp;</div></li><li><div>  protected static $_instance = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $settings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $repositories = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $api_debug = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $config = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $_plugins_renew_warnings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected $_gz_on = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $admin_messages = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $_using_icl = false;&nbsp;</div></li><li><div>  private $_wpml_version = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $package_source = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  const SITE_KEY_VALIDATION_SOURCE_OTHER = 0;&nbsp;</div></li><li><div>  const SITE_KEY_VALIDATION_SOURCE_DOWNLOAD_SPECIFIC = 1;&nbsp;</div></li><li><div>  const SITE_KEY_VALIDATION_SOURCE_DOWNLOAD_REPORT = 2;&nbsp;</div></li><li><div>  const SITE_KEY_VALIDATION_SOURCE_REGISTRATION = 3;&nbsp;</div></li><li><div>  const SITE_KEY_VALIDATION_SOURCE_REVALIDATION = 4;&nbsp;</div></li><li><div>  const SITE_KEY_VALIDATION_SOURCE_UPDATES_CHECK = 5;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public $dependencies;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function instance() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( self::$_instance ) ) {&nbsp;</div></li><li><div>          self::$_instance = new self();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$_instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!is_admin() || !is_user_logged_in()) return; <span class="comment">//Only for admin</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;_gz_on = function_exists('gzuncompress') && function_exists('gzcompress');&nbsp;</div></li><li><div>      $this-&gt;settings = $this-&gt;get_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('admin_notices', array($this, 'show_site_key_nags'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('admin_notices', array($this, 'show_admin_messages'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('admin_init', array($this, 'load_embedded_plugins'), 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('admin_menu', array($this, 'menu_setup'));&nbsp;</div></li><li><div>      add_action('network_admin_menu', array($this, 'menu_setup'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(defined('DOING_AJAX') && isset($_POST['action']) && $_POST['action'] == 'installer_download_plugin') {&nbsp;</div></li><li><div>          add_filter( 'site_transient_update_plugins', array( $this, 'plugins_upgrade_check') );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      add_filter('plugins_api', array( $this, 'custom_plugins_api_call'), 10, 3);&nbsp;</div></li><li><div>      add_filter('pre_set_site_transient_update_plugins', array( $this, 'plugins_upgrade_check'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// register repositories</span>&nbsp;</div></li><li><div>      $this-&gt;load_repositories_list();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty($this-&gt;settings['last_repositories_update']) || time() - $this-&gt;settings['last_repositories_update'] &gt; 86400&nbsp;</div></li><li><div>          || ( isset($_GET['force-check']) && $_GET['force-check'] == 1 ) ) {&nbsp;</div></li><li><div>          $this-&gt;refresh_repositories_data();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// default config</span>&nbsp;</div></li><li><div>      $this-&gt;config['plugins_install_tab'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('init', array($this, 'init'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//add_filter('wp_installer_buy_url', array($this, 'append_parameters_to_buy_url'));</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action('init', array($this, 'load_locale'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_repositories() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;repositories;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function set_config($key, $value) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;config[$key] = $value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function init() {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;dependencies = new Installer_Dependencies;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($this-&gt;settings['_pre_1_0_clean_up'])) {&nbsp;</div></li><li><div>          $this-&gt;_pre_1_0_clean_up();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;settings = $this-&gt;_old_products_format_backwards_compatibility($this-&gt;settings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !function_exists( 'get_plugins' ) ) {&nbsp;</div></li><li><div>          require_once ABSPATH . 'wp-admin/includes/plugin.php';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;_using_icl = function_exists('wpml_site_uses_icl') && wpml_site_uses_icl();&nbsp;</div></li><li><div>      $this-&gt;_wpml_version = defined('ICL_SITEPRESS_VERSION') ? ICL_SITEPRESS_VERSION : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script('installer-admin', $this-&gt;res_url() . '/res/js/admin.js', array('jquery'), $this-&gt;version());&nbsp;</div></li><li><div>      wp_enqueue_style('installer-admin', $this-&gt;res_url() . '/res/css/admin.css', array(), $this-&gt;version());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $translation_array = array(&nbsp;</div></li><li><div>          'installing' =&gt; __( 'Installing %s', 'installer' ), &nbsp;</div></li><li><div>          'updating' =&gt; __( 'Updating %s', 'installer' ), &nbsp;</div></li><li><div>          'activating' =&gt; __( 'Activating %s', 'installer' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_localize_script( 'installer-admin', 'installer_strings', $translation_array );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($pagenow == 'plugins.php') {&nbsp;</div></li><li><div>          add_action('admin_notices', array($this, 'setup_plugins_page_notices'));&nbsp;</div></li><li><div>          add_action('admin_notices', array($this, 'setup_plugins_renew_warnings'), 10);&nbsp;</div></li><li><div>          add_action('admin_notices', array($this, 'queue_plugins_renew_warnings'), 20);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action('admin_init', array($this, 'setup_plugins_action_links'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($this-&gt;is_repositories_page()) {&nbsp;</div></li><li><div>          add_action('admin_init', array($this, 'validate_repository_subscription'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(defined('DOING_AJAX')) {&nbsp;</div></li><li><div>          add_action('wp_ajax_save_site_key', array($this, 'save_site_key'));&nbsp;</div></li><li><div>          add_action('wp_ajax_remove_site_key', array($this, 'remove_site_key_ajax'));&nbsp;</div></li><li><div>          add_action('wp_ajax_update_site_key', array($this, 'update_site_key'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action('wp_ajax_installer_download_plugin', array($this, 'download_plugin_ajax_handler'));&nbsp;</div></li><li><div>          add_action('wp_ajax_installer_activate_plugin', array($this, 'activate_plugin'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action('wp_ajax_installer_dismiss_nag', array($this, 'dismiss_nag'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($pagenow == 'update.php') {&nbsp;</div></li><li><div>          if(isset($_GET['action']) && $_GET['action'] == 'update-selected') {&nbsp;</div></li><li><div>              add_action('admin_head', array($this, 'plugin_upgrade_custom_errors'));         <span class="comment">//iframe/bulk</span>&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              add_action('all_admin_notices', array($this, 'plugin_upgrade_custom_errors'));  <span class="comment">//regular/singular</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// WP 4.2</span>&nbsp;</div></li><li><div>      if(defined('DOING_AJAX')) {&nbsp;</div></li><li><div>          add_action('wp_ajax_update-plugin', array($this, 'plugin_upgrade_custom_errors'), 0); <span class="comment">// high priority, before WP</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Include theme support</span>&nbsp;</div></li><li><div>      include_once $this-&gt;plugin_path() . '/includes/class-installer-theme.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Extra information about the source of Installer</span>&nbsp;</div></li><li><div>      $package_source_file = $this-&gt;plugin_path() . '/installer-source.json';&nbsp;</div></li><li><div>      if( file_exists( $package_source_file ) ) {&nbsp;</div></li><li><div>          WP_Filesystem();&nbsp;</div></li><li><div>          global $wp_filesystem;&nbsp;</div></li><li><div>          $this-&gt;package_source = json_decode( $wp_filesystem-&gt;get_contents( $package_source_file ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  protected function log($message) {&nbsp;</div></li><li><div>      require_once ABSPATH . 'wp-admin/includes/file.php';&nbsp;</div></li><li><div>      WP_Filesystem();&nbsp;</div></li><li><div>      global $wp_filesystem;&nbsp;</div></li><li><div>      if( defined('WPML_INSTALLER_LOGGING') && WPML_INSTALLER_LOGGING ) {&nbsp;</div></li><li><div>          $wp_filesystem-&gt;put_contents( $this-&gt;plugin_path() . '/installer.log', current_time( 'mysql' ) . &quot;\t&quot; . $message . &quot;\n&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function register_admin_message($text, $type = 'updated') {&nbsp;</div></li><li><div>      $this-&gt;admin_messages[] = array('text' =&gt; $text, 'type' =&gt; $type);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function show_admin_messages() {&nbsp;</div></li><li><div>      if(!empty($this-&gt;admin_messages)) {&nbsp;</div></li><li><div>          $types = array( 'error', 'updated', 'notice' );&nbsp;</div></li><li><div>          foreach($this-&gt;admin_messages as $message) {&nbsp;</div></li><li><div>              $class = in_array( $message['type'], $types ) ? $message['type'] : 'updated';&nbsp;</div></li><li><div>              ?&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;&lt;?php echo $class ?&gt;&quot;&gt;&nbsp;</div></li><li><div>                  &lt;p&gt;&nbsp;</div></li><li><div>                      &lt;?php echo $message['text'] ?&gt;&nbsp;</div></li><li><div>                  &lt;/p&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;?php&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function load_locale() {&nbsp;</div></li><li><div>      if( function_exists('get_user_locale') ) {&nbsp;</div></li><li><div>          $locale = get_user_locale();&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $locale = get_locale();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $locale = apply_filters( 'plugin_locale', $locale, 'installer' );&nbsp;</div></li><li><div>      $mo_file = $this-&gt;plugin_path() . '/locale/installer-' . $locale . '.mo';&nbsp;</div></li><li><div>      if(file_exists($mo_file)) {&nbsp;</div></li><li><div>          load_textdomain( 'installer', $mo_file );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function load_embedded_plugins() {&nbsp;</div></li><li><div>      if(file_exists($this-&gt;plugin_path() . '/embedded-plugins' )) {&nbsp;</div></li><li><div>          include_once $this-&gt;plugin_path() . '/embedded-plugins/embedded-plugins.class.php';&nbsp;</div></li><li><div>          $this-&gt;installer_embedded_plugins = new Installer_Embedded_Plugins();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function menu_setup() {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_multisite() && !is_network_admin()) {&nbsp;</div></li><li><div>          $this-&gt;menu_multisite_redirect();&nbsp;</div></li><li><div>          add_options_page(__('Installer', 'installer'), __('Installer', 'installer'), 'manage_options', 'installer', array($this, 'show_products'))            ;&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          if($this-&gt;config['plugins_install_tab'] && is_admin() && $pagenow == 'plugin-install.php') {&nbsp;</div></li><li><div>              <span class="comment">// Default GUI, under Plugins -&gt; Install</span>&nbsp;</div></li><li><div>              add_filter('install_plugins_tabs', array($this, 'add_install_plugins_tab'));&nbsp;</div></li><li><div>              add_action('install_plugins_commercial', array($this, 'show_products'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function menu_url() {&nbsp;</div></li><li><div>      if(is_multisite()) {&nbsp;</div></li><li><div>          if(is_network_admin()) {&nbsp;</div></li><li><div>              $url = network_admin_url('plugin-install.php?tab=commercial');&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $url = admin_url('options-general.php?page=installer');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $url = admin_url('plugin-install.php?tab=commercial');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function menu_multisite_redirect() {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($pagenow == 'plugin-install.php' && isset($_GET['tab']) && $_GET['tab'] == 'commercial') {&nbsp;</div></li><li><div>          wp_redirect($this-&gt;menu_url());&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function _pre_1_0_clean_up() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!defined('WPRC_VERSION')) {&nbsp;</div></li><li><div>          $old_tables = array(&nbsp;</div></li><li><div>              $wpdb-&gt;prefix . 'wprc_cached_requests', &nbsp;</div></li><li><div>              $wpdb-&gt;prefix . 'wprc_extension_types', &nbsp;</div></li><li><div>              $wpdb-&gt;prefix . 'wprc_extensions', &nbsp;</div></li><li><div>              $wpdb-&gt;prefix . 'wprc_repositories', &nbsp;</div></li><li><div>              $wpdb-&gt;prefix . 'wprc_repositories_relationships', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($old_tables as $table) {&nbsp;</div></li><li><div>              $wpdb-&gt;query(sprintf(&quot;DROP TABLE IF EXISTS %s&quot;, $table));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;settings['_pre_1_0_clean_up'] = true;&nbsp;</div></li><li><div>      $this-&gt;save_settings();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setup_plugins_action_links() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $repositories_plugins = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !empty($this-&gt;settings['repositories']) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;settings['repositories'] as $repository_id =&gt; $repository ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $repository['data']['packages'] as $package ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ( $package['products'] as $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $product['plugins'] as $plugin_slug ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( !isset($repositories_plugins[$repository_id][$download['slug']]) ) {&nbsp;</div></li><li><div>                              $repositories_plugins[$repository_id][$download['slug']] = array(&nbsp;</div></li><li><div>                                  'name' =&gt; $download['name'], &nbsp;</div></li><li><div>                                  'registered' =&gt; $this-&gt;plugin_is_registered( $repository_id, $download['slug'] ) ? 1 : 0&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $plugins as $plugin_id =&gt; $plugin ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $wp_plugin_slug = dirname( $plugin_id );&nbsp;</div></li><li><div>                  if ( empty($wp_plugin_slug) ) {&nbsp;</div></li><li><div>                      $wp_plugin_slug = basename( $plugin_id, '.php' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ( $repositories_plugins as $repository_id =&gt; $r_plugins ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $r_plugins as $slug =&gt; $r_plugin ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if ( $wp_plugin_slug == $slug || $r_plugin['name'] == $plugin['Name'] || $r_plugin['name'] == $plugin['Title'] ) { <span class="comment"><span class="comment">//match order: slug, name, title</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if ( $r_plugin['registered'] ) {&nbsp;</div></li><li><div>                                  add_filter( 'plugin_action_links_' . $plugin_id, array($this, 'plugins_action_links_registered') );&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  add_filter( 'plugin_action_links_' . $plugin_id, array($this, 'plugins_action_links_not_registered') );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugins_action_links_registered($links) {&nbsp;</div></li><li><div>      $links[] = '&lt;a href=&quot;' . $this-&gt;menu_url() . '&quot;&gt;' . __('Registered', 'installer') . '&lt;/a&gt;';&nbsp;</div></li><li><div>      return $links;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugins_action_links_not_registered($links) {&nbsp;</div></li><li><div>      $links[] = '&lt;a href=&quot;' . $this-&gt;menu_url() . '&quot;&gt;' . __('Register', 'installer') . '&lt;/a&gt;';&nbsp;</div></li><li><div>      return $links;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugin_is_registered($repository_id, $slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $registered = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $this-&gt;repository_has_valid_subscription($repository_id) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $subscription_type = $this-&gt;get_subscription_type_for_repository($repository_id);&nbsp;</div></li><li><div>          $r_plugins = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'][$repository_id]['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if( $product['subscription_type'] == $subscription_type || $this-&gt;have_superior_subscription($subscription_type, $product) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if (!isset($rep_plugins[$download['slug']])) {&nbsp;</div></li><li><div>                              $r_plugins[$download['slug']] = $download['slug'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $registered = isset($r_plugins[$slug]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $registered;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function version() {&nbsp;</div></li><li><div>      return WP_INSTALLER_VERSION;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugin_path() {&nbsp;</div></li><li><div>      return untrailingslashit( plugin_dir_path( dirname(__FILE__) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugin_url() {&nbsp;</div></li><li><div>      if(isset($this-&gt;config['in_theme_folder']) && !empty($this-&gt;config['in_theme_folder'])) {&nbsp;</div></li><li><div>          $url = untrailingslashit(get_template_directory_uri() . '/' . $this-&gt;config['in_theme_folder']);&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $url = untrailingslashit( plugins_url( '/', dirname(__FILE__) ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_repositories_page() {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $pagenow == 'plugin-install.php' && isset($_GET['tab']) && $_GET['tab'] == 'commercial';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function res_url() {&nbsp;</div></li><li><div>      if(isset($this-&gt;config['in_theme_folder']) && !empty($this-&gt;config['in_theme_folder'])) {&nbsp;</div></li><li><div>          $url = untrailingslashit(get_template_directory_uri() . '/' . $this-&gt;config['in_theme_folder']);&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $url = $this-&gt;plugin_url();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function save_settings() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $_settings = serialize($this-&gt;settings);&nbsp;</div></li><li><div>      if($this-&gt;_gz_on) {&nbsp;</div></li><li><div>          $_settings =  gzcompress($_settings);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $_settings = base64_encode($_settings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_option( 'wp_installer_settings', $_settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( is_multisite() && is_main_site() && isset($this-&gt;settings['repositories']) ) {&nbsp;</div></li><li><div>          $network_settings = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach( $this-&gt;settings['repositories'] as $rep_id =&gt; $repository ) {&nbsp;</div></li><li><div>              if( isset($repository['subscription']) )&nbsp;</div></li><li><div>                  $network_settings[$rep_id] = $repository['subscription'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_site_option( 'wp_installer_network', $network_settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_settings($refresh = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($refresh || empty($this-&gt;settings)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $_settings = get_option('wp_installer_settings');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (is_array($_settings) || empty($_settings)) { <span class="comment">//backward compatibility 1.1</span>&nbsp;</div></li><li><div>              $this-&gt;settings = $_settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $_settings = base64_decode($_settings);&nbsp;</div></li><li><div>              if ($this-&gt;_gz_on) {&nbsp;</div></li><li><div>                  $_settings = gzuncompress($_settings);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;settings = unserialize($_settings);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! array_key_exists( 'repositories', $this-&gt;settings ) ) {&nbsp;</div></li><li><div>              $this-&gt;settings['repositories'] = array();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (is_multisite() && isset($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>              $network_settings = maybe_unserialize(get_site_option('wp_installer_network'));&nbsp;</div></li><li><div>              if ($network_settings) {&nbsp;</div></li><li><div>                  foreach ($this-&gt;settings['repositories'] as $rep_id =&gt; $repository) {&nbsp;</div></li><li><div>                      if (isset($network_settings[$rep_id])) {&nbsp;</div></li><li><div>                          $this-&gt;settings['repositories'][$rep_id]['subscription'] = $network_settings[$rep_id];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;load_hardcoded_site_keys();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;settings = $this-&gt;_pre_1_6_backwards_compatibility($this-&gt;settings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;settings = $this-&gt;_old_products_format_backwards_compatibility($this-&gt;settings);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function load_hardcoded_site_keys() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !empty( $this-&gt;settings['repositories'] ) ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;settings['repositories'] as $repository_id =&gt; $repository ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $site_key = self::get_repository_hardcoded_site_key( $repository_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $site_key_missing = empty($this-&gt;settings['repositories'][$repository_id]['subscription']['data']);&nbsp;</div></li><li><div>                  $site_key_changed = !$site_key_missing &&&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['subscription']['key'] != $site_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $site_key_missing || $site_key_changed ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( !function_exists( 'get_plugins' ) ) {&nbsp;</div></li><li><div>                          require_once ABSPATH . 'wp-admin/includes/plugin.php';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $this-&gt;load_repositories_list();&nbsp;</div></li><li><div>                      $response = $this-&gt;save_site_key(&nbsp;</div></li><li><div>                          array(&nbsp;</div></li><li><div>                              'repository_id' =&gt; $repository_id, &nbsp;</div></li><li><div>                              'site_key' =&gt; $site_key, &nbsp;</div></li><li><div>                              'return' =&gt; true, &nbsp;</div></li><li><div>                              'nonce' =&gt; wp_create_nonce( 'save_site_key_' . $repository_id )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( !empty($response['error']) ) {&nbsp;</div></li><li><div>                          $this-&gt;remove_site_key( $repository_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $this-&gt;admin_messages[] = array(&nbsp;</div></li><li><div>                              'type' =&gt; 'error', &nbsp;</div></li><li><div>                              'text' =&gt; sprintf( __( 'You are using an invalid site key defined as the constant %s (most likely in wp-config.php). &nbsp;</div></li><li><div>                                              Please remove it or use the correct value in order to be able to register correctly.', 'installer' ), 'OTGS_INSTALLER_SITE_KEY_' . strtoupper( $repository_id ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function get_repository_hardcoded_site_key( $repository_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $site_key = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $site_key_constant = 'OTGS_INSTALLER_SITE_KEY_' . strtoupper( $repository_id );&nbsp;</div></li><li><div>      if( defined( $site_key_constant ) ) {&nbsp;</div></li><li><div>          $site_key = constant( $site_key_constant );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $site_key;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//backward compatibility, will remove 'basename' in version 1.8</span>&nbsp;</div></li><li><div>  private function _pre_1_6_backwards_compatibility($settings) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( version_compare($this-&gt;version(), '1.8', '&lt;') && !empty($settings['repositories']) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ($repository['data']['downloads']['plugins'] as $slug =&gt; $download) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $settings['repositories'][$repository_id]['data']['downloads']['plugins'][$slug]['slug'] = $download['basename'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//backward compatibility - support old products list format (downloads under products instead of global downloads list)</span>&nbsp;</div></li><li><div>  private function _old_products_format_backwards_compatibility($settings) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( version_compare($this-&gt;version(), '1.8', '&lt;') && !empty($settings['repositories']) && empty($this-&gt;_old_products_format_backwards_compatibility) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $populate_downloads = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ($repository['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ($package['products'] as $product_id =&gt; $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if (!isset($product['plugins'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $populate_downloads = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach ($product['downloads'] as $download_id =&gt; $download) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['plugins'][] = $download['slug'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ($populate_downloads) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Add downloads branch</span>&nbsp;</div></li><li><div>                  foreach ($repository['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ($package['products'] as $product_id =&gt; $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach ($product['downloads'] as $download_id =&gt; $download) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if (!isset($settings['repositories'][$repository_id]['data']['downloads']['plugins'][$download['slug']])) {&nbsp;</div></li><li><div>                                  $settings['repositories'][$repository_id]['data']['downloads']['plugins'][$download['slug']] = $download;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['plugins'][] = $download['slug'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          unset($settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['downloads']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;_old_products_format_backwards_compatibility = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_installer_site_url( $repository_id = false ) {&nbsp;</div></li><li><div>      global $current_site;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $site_url = get_site_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $repository_id && is_multisite() && isset( $this-&gt;settings['repositories'] ) ) {&nbsp;</div></li><li><div>          $network_settings = maybe_unserialize( get_site_option('wp_installer_network') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $network_settings[$repository_id] ) ) {&nbsp;</div></li><li><div>              $site_url = get_site_url( $current_site-&gt;blog_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $site_url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function show_site_key_nags() {&nbsp;</div></li><li><div>      $screen = get_current_screen();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($screen-&gt;base == 'settings_page_installer' || ($screen-&gt;base == 'plugin-install' && isset($_GET['tab']) && $_GET['tab'] == 'commercial')) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;config['site_key_nags'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;config['site_key_nags'] as $nag) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!$this-&gt;repository_has_subscription($nag['repository_id'] )) {&nbsp;</div></li><li><div>                  $show = true;&nbsp;</div></li><li><div>                  if(!empty($nag['condition_cb'])) {&nbsp;</div></li><li><div>                      $show = call_user_func($nag['condition_cb']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(empty($this-&gt;settings['dismissed_nags'][$nag['repository_id']]) && $show) {&nbsp;</div></li><li><div>                      echo '&lt;div class=&quot;updated error otgs-is-dismissible&quot;&gt;&lt;p&gt;';&nbsp;</div></li><li><div>                      printf(__(&quot;To get automatic updates, you need to register %s for this site. %sRegister %s%s&quot;, 'sitepress'), &nbsp;</div></li><li><div>                          $nag['product_name'], '&lt;a class=&quot;button-primary&quot; href=&quot;' . $this-&gt;menu_url() . '&quot;&gt;', $nag['product_name'], '&lt;/a&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      echo '&lt;/p&gt;';&nbsp;</div></li><li><div>                      echo '&lt;span class=&quot;installer-dismiss-nag notice-dismiss&quot; data-repository=&quot;' . $nag['repository_id']  . '&quot;&gt;&lt;span class=&quot;screen-reader-text&quot;&gt;' . __('Dismiss', 'sitepress') . '&lt;/span&gt;&lt;/span&gt;';&nbsp;</div></li><li><div>                      echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function dismiss_nag() {&nbsp;</div></li><li><div>      $this-&gt;settings['dismissed_nags'][$_POST['repository']] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;save_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode(array());&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_install_plugins_tab($tabs) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tabs['commercial'] = __('Commercial', 'installer');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $tabs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function load_repositories_list() {&nbsp;</div></li><li><div>      global $wp_installer_instances;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ($wp_installer_instances as $instance) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if (file_exists(dirname($instance['bootfile']) . '/repositories.xml')) {&nbsp;</div></li><li><div>              $config_file = dirname($instance['bootfile']) . '/repositories.xml';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if (file_exists(dirname($instance['bootfile']) . '/repositories.sandbox.xml')) {&nbsp;</div></li><li><div>                  $config_file = dirname($instance['bootfile']) . '/repositories.sandbox.xml';&nbsp;</div></li><li><div>                  add_filter('https_ssl_verify', '__return_false');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $repos = simplexml_load_file($config_file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($repos) {&nbsp;</div></li><li><div>                  foreach ($repos as $repo) {&nbsp;</div></li><li><div>                      $id = strval($repo-&gt;id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $data['api-url'] = strval($repo-&gt;apiurl);&nbsp;</div></li><li><div>                      $data['products'] = strval($repo-&gt;products);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// excludes rule;</span></span>&nbsp;</div></li><li><div>                      if (isset($this-&gt;config['repositories_exclude']) && in_array($id, $this-&gt;config['repositories_exclude'])) {&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// includes rule;</span></span>&nbsp;</div></li><li><div>                      if (isset($this-&gt;config['repositories_include']) && !in_array($id, $this-&gt;config['repositories_include'])) {&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this-&gt;repositories[$id] = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_repositories_list() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>          foreach ($this-&gt;settings['repositories'] as $id =&gt; $repo_data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// excludes rule;</span></span>&nbsp;</div></li><li><div>              if (isset($this-&gt;config['repositories_exclude']) && in_array($id, $this-&gt;config['repositories_exclude'])) {&nbsp;</div></li><li><div>                  unset($this-&gt;settings['repositories'][$id]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// includes rule;</span></span>&nbsp;</div></li><li><div>              if (isset($this-&gt;config['repositories_include']) && !in_array($id, $this-&gt;config['repositories_include'])) {&nbsp;</div></li><li><div>                  unset($this-&gt;settings['repositories'][$id]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function refresh_repositories_data() {&nbsp;</div></li><li><div>      static $checked = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( defined('OTGS_DISABLE_AUTO_UPDATES') && OTGS_DISABLE_AUTO_UPDATES && empty($_GET['force-check']) || $checked ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(empty($this-&gt;settings['repositories']) && $this-&gt;is_repositories_page()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($this-&gt;repositories as $id =&gt; $data) {&nbsp;</div></li><li><div>                  $repository_names[] = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $error = sprintf(__(&quot;Installer cannot display the products information because the automatic updating for %s was explicitly disabled with the configuration below (usually in wp-config.php):&quot;, 'installer'), strtoupper( join(', ', $repository_names) ));&nbsp;</div></li><li><div>              $error .= '&lt;br /&gt;&lt;br /&gt;&lt;code&gt;define(&quot;OTGS_DISABLE_AUTO_UPDATES&quot;, true);&lt;/code&gt;&lt;br /&gt;&lt;br /&gt;';&nbsp;</div></li><li><div>              $error .= sprintf(__(&quot;In order to see the products information, please run the %smanual updates check%s to initialize the products list or (temporarily) remove the above code.&quot;, 'installer'), '&lt;a href=&quot;' . admin_url('update-core.php') . '&quot;&gt;', '&lt;/a&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;register_admin_message($error, 'error');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $checked = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($this-&gt;repositories as $id =&gt; $data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $response = wp_remote_get($data['products']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(is_wp_error($response)) {&nbsp;</div></li><li><div>              <span class="comment">// http fallback</span>&nbsp;</div></li><li><div>              $data['products'] = preg_replace(&quot;@^https:<span class="comment">//@&quot;, 'http://', $data['products']);</span>&nbsp;</div></li><li><div>              $response = wp_remote_get($data['products']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(is_wp_error($response)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $error = sprintf(__(&quot;Installer cannot contact our updates server to get information about the available products and check for new versions. If you are seeing this message for the first time, you can ignore it, as it may be a temporary communication problem. If the problem persists and your WordPress admin is slowing down, you can disable automated version checks. Add the following line to your wp-config.php file:&quot;, 'installer'), strtoupper($id));&nbsp;</div></li><li><div>              $error .= '&lt;br /&gt;&lt;br /&gt;&lt;code&gt;define(&quot;OTGS_DISABLE_AUTO_UPDATES&quot;, true);&lt;/code&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;register_admin_message($error, 'error');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($response && isset($response['response']['code']) && $response['response']['code'] == 200) {&nbsp;</div></li><li><div>              $body = wp_remote_retrieve_body($response);&nbsp;</div></li><li><div>              if($body) {&nbsp;</div></li><li><div>                  $products = json_decode($body, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(is_array($products)) {&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$id]['data'] = $products;&nbsp;</div></li><li><div>                      $this-&gt;settings = $this-&gt;_pre_1_6_backwards_compatibility($this-&gt;settings);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log( sprintf(&quot;Checked for %s updates: %s&quot;, $id, $data['products']) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// cleanup</span>&nbsp;</div></li><li><div>      if(empty($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>          $this-&gt;settings['repositories'] = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach($this-&gt;settings['repositories'] as $id =&gt; $data) {&nbsp;</div></li><li><div>          if(!in_array($id, array_keys($this-&gt;repositories))) {&nbsp;</div></li><li><div>              unset($this-&gt;settings['repositories'][$id]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;settings['last_repositories_update']= time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;save_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function show_products($args = array()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $screen = get_current_screen();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($screen-&gt;base == 'settings_page_installer') { <span class="comment"><span class="comment">// settings page</span></span>&nbsp;</div></li><li><div>          echo '&lt;div class=&quot;wrap&quot;&gt;';&nbsp;</div></li><li><div>          echo '&lt;h2&gt;' . __('Installer', 'installer') . '&lt;/h2&gt;';&nbsp;</div></li><li><div>          echo '&lt;br /&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!is_array($args)) $args = array();&nbsp;</div></li><li><div>      if(empty($args['template'])) $args['template'] = 'default';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;filter_repositories_list();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;localize_strings();&nbsp;</div></li><li><div>          $this-&gt;set_filtered_prices($args);&nbsp;</div></li><li><div>          $this-&gt;set_hierarchy_and_order();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($args['template'] == 'compact') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(isset($args['repository']) && $args['repository'] == $repository_id) {&nbsp;</div></li><li><div>                      include $this-&gt;plugin_path() . '/templates/products-compact.php';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  include $this-&gt;plugin_path() . '/templates/repository-listing.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              unset($site_key, $subscription_type, $expired, $upgrade_options, $products_avaliable);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;center&gt;' . __('No repositories defined.', 'installer') . '&lt;/center&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($screen-&gt;base == 'settings_page_installer') { <span class="comment"><span class="comment">// settings page</span></span>&nbsp;</div></li><li><div>          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_product_price($repository_id, $package_id, $product_id, $incl_discount = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($this-&gt;settings['repositories'][$repository_id]['data']['packages'] as $package ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($package['id'] == $package_id) {&nbsp;</div></li><li><div>              if(isset($package['products'][$product_id])) {&nbsp;</div></li><li><div>                  if($incl_discount && isset($package['products'][$product_id]['price_disc'])) {&nbsp;</div></li><li><div>                      $price = $package['products'][$product_id]['price_disc'];&nbsp;</div></li><li><div>                  }elseif(isset($package['products'][$product_id]['price'])) {&nbsp;</div></li><li><div>                      $price = $package['products'][$product_id]['price'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $price;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function _render_product_packages($packages, $subscription_type, $expired, $upgrade_options, $repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($packages as $package_id =&gt; $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $row = array('products' =&gt; array(), 'downloads' =&gt; array());&nbsp;</div></li><li><div>          foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// filter out free subscriptions from being displayed as buying options</span>&nbsp;</div></li><li><div>              if( empty($product['price']) && (empty($subscription_type) || $expired) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//consider equivalent subscriptions</span>&nbsp;</div></li><li><div>              if( empty($product['subscription_type_equivalent'])) {&nbsp;</div></li><li><div>                  $product['subscription_type_equivalent'] = '';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// buy base</span>&nbsp;</div></li><li><div>              if(empty($subscription_type) || $expired) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $p['url'] = $this-&gt;append_parameters_to_buy_url($product['url'], $repository_id);&nbsp;</div></li><li><div>                  if (!empty($product['price_disc'])) {&nbsp;</div></li><li><div>                      $p['label'] = $product['call2action'] . ' - ' . sprintf('$%s %s$%d%s (USD)', $product['price_disc'], '&nbsp;&nbsp;&lt;del&gt;', $product['price'], '&lt;/del&gt;');&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $p['label'] = $product['call2action'] . ' - ' . sprintf('$%d (USD)', $product['price']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $row['products'][] = $p;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// renew</span>&nbsp;</div></li><li><div>              } elseif(isset($subscription_type) && ($product['subscription_type'] == $subscription_type || $product['subscription_type_equivalent'] == $subscription_type)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($product['renewals']) {&nbsp;</div></li><li><div>                      foreach ($product['renewals'] as $renewal) {&nbsp;</div></li><li><div>                          $p['url'] = $this-&gt;append_parameters_to_buy_url($renewal['url'], $repository_id);&nbsp;</div></li><li><div>                          $p['label'] = $renewal['call2action'] . ' - ' . sprintf('$%d (USD)', $renewal['price']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $row['products'][] = $p;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// upgrades</span>&nbsp;</div></li><li><div>              if(!empty($upgrade_options[$product['subscription_type']])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($upgrade_options[$product['subscription_type']] as $stype =&gt; $upgrade) {&nbsp;</div></li><li><div>                      if($stype != $subscription_type) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $p['url'] = $this-&gt;append_parameters_to_buy_url($upgrade['url'], $repository_id);&nbsp;</div></li><li><div>                      if (!empty($upgrade['price_disc'])) {&nbsp;</div></li><li><div>                          $p['label'] = $upgrade['call2action'] . ' - ' . sprintf('$%s %s$%d%s (USD)', $upgrade['price_disc'], '&nbsp;&nbsp;&lt;del&gt;', $upgrade['price'], '&lt;/del&gt;');&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $p['label'] = $upgrade['call2action'] . ' - ' . sprintf('$%d (USD)', $upgrade['price']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $row['products'][] = $p;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// downloads</span>&nbsp;</div></li><li><div>              if(isset($subscription_type) && !$expired && ($product['subscription_type'] == $subscription_type || $product['subscription_type_equivalent'] == $subscription_type)) {&nbsp;</div></li><li><div>                  foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>                      $row['downloads'][ $plugin_slug ] = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//subpackages</span>&nbsp;</div></li><li><div>              if(!empty($package['sub-packages'])) {&nbsp;</div></li><li><div>                  $row['sub-packages'] = $package['sub-packages'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $row['id'] = $package['id'];&nbsp;</div></li><li><div>          $row['image_url'] = $package['image_url'];&nbsp;</div></li><li><div>          $row['name'] = $package['name'];&nbsp;</div></li><li><div>          $row['description'] = $package['description'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($row['products']) || !empty($row['downloads']) || !empty($row['sub-packages'])) {&nbsp;</div></li><li><div>              $data[] = $row;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_extra_url_parameters() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parameters = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;package_source)) {&nbsp;</div></li><li><div>          foreach($this-&gt;package_source as $key =&gt; $val) {&nbsp;</div></li><li><div>              $parameters[$key] = $val;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parameters['installer_version'] = WP_INSTALLER_VERSION;&nbsp;</div></li><li><div>      $parameters['theme'] = wp_get_theme()-&gt;get( 'Name' );&nbsp;</div></li><li><div>      $parameters['site_name'] = get_bloginfo( 'name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $parameters;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function append_parameters_to_buy_url($url, $repository_id, $args = array()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = add_query_arg( array('icl_site_url' =&gt; $this-&gt;get_installer_site_url( $repository_id ) ), $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $affiliate_id = false;&nbsp;</div></li><li><div>      $affiliate_key = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Add extra parameters for custom Installer packages</span></span></span>&nbsp;</div></li><li><div>      if( !empty($this-&gt;package_source) ) {&nbsp;</div></li><li><div>          $extra = $this-&gt;get_extra_url_parameters();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( !empty($extra['repository']) && $extra['repository'] == $repository_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( !empty($extra['affiliate_key']) && !empty($extra['user_id']) ) {&nbsp;</div></li><li><div>                  $this-&gt;config['affiliate_id:' . $repository_id] = $extra['user_id'];&nbsp;</div></li><li><div>                  $this-&gt;config['affiliate_key:' . $repository_id] = $extra['affiliate_key'];&nbsp;</div></li><li><div>                  unset($extra['affiliate_key'], $extra['user_id'], $extra['repository']); <span class="comment">// no need to include these ones</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $url = add_query_arg($extra, $url);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($this-&gt;config['affiliate_id:' . $repository_id]) && isset($this-&gt;config['affiliate_key:' . $repository_id])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $affiliate_id = $this-&gt;config['affiliate_id:' . $repository_id];&nbsp;</div></li><li><div>          $affiliate_key = $this-&gt;config['affiliate_key:' . $repository_id];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }elseif(isset($args['affiliate_id:' . $repository_id]) && isset($args['affiliate_key:' . $repository_id])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $affiliate_id = $args['affiliate_id:' . $repository_id];&nbsp;</div></li><li><div>          $affiliate_key = $args['affiliate_key:' . $repository_id];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }elseif(defined('ICL_AFFILIATE_ID') && defined('ICL_AFFILIATE_KEY')) { <span class="comment">//support for 1 repo</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $affiliate_id = ICL_AFFILIATE_ID;&nbsp;</div></li><li><div>          $affiliate_key = ICL_AFFILIATE_KEY;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }elseif(isset($this-&gt;config['affiliate_id']) && isset($this-&gt;config['affiliate_key'])) {&nbsp;</div></li><li><div>          <span class="comment">// BACKWARDS COMPATIBILITY</span>&nbsp;</div></li><li><div>          $affiliate_id = $this-&gt;config['affiliate_id'];&nbsp;</div></li><li><div>          $affiliate_key = $this-&gt;config['affiliate_key'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($affiliate_id && $affiliate_key) {&nbsp;</div></li><li><div>          $url = add_query_arg(array('aid' =&gt; $affiliate_id, 'affiliate_key' =&gt; $affiliate_key), $url);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($repository_id == 'wpml') {&nbsp;</div></li><li><div>          $url = add_query_arg(array('using_icl' =&gt; $this-&gt;_using_icl, 'wpml_version' =&gt; $this-&gt;_wpml_version), $url);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = apply_filters('wp_installer_buy_url', $url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = esc_url($url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function save_site_key($args = array()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $args['repository_id'] ) ) {&nbsp;</div></li><li><div>          $repository_id = $args['repository_id'];&nbsp;</div></li><li><div>      }elseif( isset( $_POST['repository_id'] ) ) {&nbsp;</div></li><li><div>          $repository_id = sanitize_text_field( $_POST['repository_id'] );&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $repository_id = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $args['nonce'] ) ) {&nbsp;</div></li><li><div>          $nonce = $args['nonce'];&nbsp;</div></li><li><div>      }elseif( isset($_POST['nonce'] ) ) {&nbsp;</div></li><li><div>          $nonce = sanitize_text_field( $_POST['nonce'] );&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $nonce = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $args['site_key'] ) ) {&nbsp;</div></li><li><div>          $site_key = $args['site_key'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $site_key = sanitize_text_field( $_POST[ 'site_key_' . $repository_id] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $site_key = preg_replace(&quot;/[^A-Za-z0-9]/&quot;, '', $site_key);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($repository_id && $nonce && wp_create_nonce('save_site_key_' . $repository_id) == $nonce) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>              $subscription_data = $this-&gt;fetch_subscription_data( $repository_id, $site_key, self::SITE_KEY_VALIDATION_SOURCE_REGISTRATION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $subscription_data ) {&nbsp;</div></li><li><div>                  $this-&gt;settings['repositories'][$repository_id]['subscription'] = array(&nbsp;</div></li><li><div>                          'key' =&gt; $site_key, &nbsp;</div></li><li><div>                          'data' =&gt; $subscription_data, &nbsp;</div></li><li><div>                          'registered_by' =&gt; get_current_user_id()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                  $this-&gt;save_settings();&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $error = __( 'Invalid site key for the current site.', 'installer' )&nbsp;</div></li><li><div>                      . '&lt;br /&gt;&lt;div class=&quot;installer-footnote&quot;&gt;' .  __('Please note that the site key is case sensitive.', 'installer') . '&lt;/div&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } catch (Exception $e ) {&nbsp;</div></li><li><div>              $error = $e-&gt;getMessage();&nbsp;</div></li><li><div>              if( preg_match('#Could not resolve host: (.*)#', $error, $matches) || preg_match('#Couldn\'t resolve host \'(.*)\'#', $error, $matches) ) {&nbsp;</div></li><li><div>                  $error = sprintf(__(&quot;%s cannot access %s to register. Try again to see if it's a temporary problem. If the problem continues, make sure that this site has access to the Internet. You can still use the plugin without registration, but you will not receive automated updates.&quot;, 'installer'), &nbsp;</div></li><li><div>                      '&lt;strong&gt;&lt;i&gt;' . $this-&gt;get_generic_product_name($repository_id) . '&lt;/i&gt;&lt;/strong&gt;', &nbsp;</div></li><li><div>                      '&lt;strong&gt;&lt;i&gt;' . $matches[1]. '&lt;/i&gt;&lt;/strong&gt;'&nbsp;</div></li><li><div> ) ;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $return = array('error' =&gt; $error);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($this-&gt;api_debug) {&nbsp;</div></li><li><div>          $return['debug'] = $this-&gt;api_debug;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($args['return'])) {&nbsp;</div></li><li><div>          return $return;&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          echo json_encode($return);&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alias for WP_Installer::get_repository_site_key</span>&nbsp;</div></li><li><div><span class="comment">   * @see WP_Installer::get_repository_site_key()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $repository_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return string (site key) or bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_site_key($repository_id) {&nbsp;</div></li><li><div>      return WP_Installer::get_repository_site_key( $repository_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function remove_site_key( $repository_id ) {&nbsp;</div></li><li><div>      if( isset( $this-&gt;settings['repositories'][$repository_id] ) ) {&nbsp;</div></li><li><div>          unset($this-&gt;settings['repositories'][$repository_id]['subscription']);&nbsp;</div></li><li><div>          $this-&gt;save_settings();&nbsp;</div></li><li><div>          $this-&gt;refresh_repositories_data();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function remove_site_key_ajax() {&nbsp;</div></li><li><div>      if($_POST['nonce'] == wp_create_nonce('remove_site_key_' . $_POST['repository_id'])) {&nbsp;</div></li><li><div>          $this-&gt;remove_site_key( $_POST['repository_id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function validate_repository_subscription() {&nbsp;</div></li><li><div>      $repository_id = isset($_GET['validate_repository']) ? sanitize_text_field( $_GET['validate_repository'] ) : false;&nbsp;</div></li><li><div>      if($repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $site_key = $this-&gt;get_site_key($repository_id);&nbsp;</div></li><li><div>          if($site_key) {&nbsp;</div></li><li><div>              $subscription_data = $this-&gt;fetch_subscription_data( $repository_id, $site_key, self::SITE_KEY_VALIDATION_SOURCE_REVALIDATION);&nbsp;</div></li><li><div>              if(empty($subscription_data)) {&nbsp;</div></li><li><div>                  unset($this-&gt;settings['repositories'][$repository_id]['subscription']);&nbsp;</div></li><li><div>                  delete_site_transient('update_plugins');&nbsp;</div></li><li><div>                  $this-&gt;save_settings();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_redirect($this-&gt;menu_url() . '#repository-' . $repository_id);&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function update_site_key() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $repository_id = sanitize_text_field ( $_POST['repository_id'] );&nbsp;</div></li><li><div>      if($_POST['nonce'] == wp_create_nonce('update_site_key_' . $repository_id )) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $site_key = $this-&gt;get_site_key($_POST['repository_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($site_key) {&nbsp;</div></li><li><div>              try {&nbsp;</div></li><li><div>                  $subscription_data = $this-&gt;fetch_subscription_data( $repository_id, $site_key, self::SITE_KEY_VALIDATION_SOURCE_UPDATES_CHECK );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $subscription_data ) {&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['subscription'] = array(&nbsp;</div></li><li><div>                              'key' =&gt; $site_key, &nbsp;</div></li><li><div>                              'data' =&gt; $subscription_data, &nbsp;</div></li><li><div>                              'registered_by' =&gt; get_current_user_id()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">//also refresh products information</span>&nbsp;</div></li><li><div>                      $this-&gt;refresh_repositories_data();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this-&gt;save_settings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      unset($this-&gt;settings['repositories'][$repository_id]['subscription']);&nbsp;</div></li><li><div>                      $error = __( 'Invalid site key for the current site. If the error persists, try to unregister first and then register again with the same site key.', 'installer' );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } catch (Exception $e ) {&nbsp;</div></li><li><div>                  $error = $e-&gt;getMessage();&nbsp;</div></li><li><div>                  if( preg_match('#Could not resolve host: (.*)#', $error, $matches) || preg_match('#Couldn\'t resolve host \'(.*)\'#', $error, $matches) ) {&nbsp;</div></li><li><div>                      $error = sprintf(__(&quot;%s cannot access %s to register. Try again to see if it's a temporary problem. If the problem continues, make sure that this site has access to the Internet. You can still use the plugin without registration, but you will not receive automated updates.&quot;, 'installer'), &nbsp;</div></li><li><div>                          '&lt;strong&gt;&lt;i&gt;' . $this-&gt;get_generic_product_name($repository_id) . '&lt;/i&gt;&lt;/strong&gt;', &nbsp;</div></li><li><div>                          '&lt;strong&gt;&lt;i&gt;' . $matches[1]. '&lt;/i&gt;&lt;/strong&gt;'&nbsp;</div></li><li><div> ) ;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode(array('error' =&gt; $error));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function api_debug_log($text) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(defined('WPML_DEBUG_INSTALLER') && WPML_DEBUG_INSTALLER) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!is_scalar($text)) {&nbsp;</div></li><li><div>              $text = print_r($text, 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;api_debug .= $text . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function fetch_subscription_data( $repository_id, $site_key, $source = self::SITE_KEY_VALIDATION_SOURCE_OTHER ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscription_data = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['body'] = array(&nbsp;</div></li><li><div>          'action' =&gt; 'site_key_validation', &nbsp;</div></li><li><div>          'site_key' =&gt; $site_key, &nbsp;</div></li><li><div>          'site_url' =&gt; $this-&gt;get_installer_site_url( $repository_id ), &nbsp;</div></li><li><div>          'source' =&gt; $source&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($repository_id == 'wpml') {&nbsp;</div></li><li><div>          $args['body']['using_icl'] = $this-&gt;_using_icl;&nbsp;</div></li><li><div>          $args['body']['wpml_version'] = $this-&gt;_wpml_version;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['body']['installer_version'] = WP_INSTALLER_VERSION;&nbsp;</div></li><li><div>      $args['body']['theme'] = wp_get_theme()-&gt;get( 'Name' );&nbsp;</div></li><li><div>      $args['body']['site_name'] = get_bloginfo( 'name' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['body']['versions'] = $this-&gt;get_local_product_versions( $repository_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['timeout'] = 45;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Add extra parameters for custom Installer packages</span></span></span>&nbsp;</div></li><li><div>      if( !empty($this-&gt;package_source) ) {&nbsp;</div></li><li><div>          $extra = $this-&gt;get_extra_url_parameters();&nbsp;</div></li><li><div>          if( !empty($extra['repository']) && $extra['repository'] == $repository_id ) {&nbsp;</div></li><li><div>              unset($extra['repository']);&nbsp;</div></li><li><div>              foreach($extra as $key =&gt; $val) {&nbsp;</div></li><li><div>                  $args['body'][$key] = $val;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response = wp_remote_post($this-&gt;repositories[$repository_id]['api-url'], $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;api_debug_log(&quot;POST {$this-&gt;repositories[$repository_id]['api-url']}&quot;);&nbsp;</div></li><li><div>      $this-&gt;api_debug_log($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log(&quot;POST {$this-&gt;repositories[$repository_id]['api-url']} - fetch subscription data&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !is_wp_error($response) ) {&nbsp;</div></li><li><div>          $datas = wp_remote_retrieve_body($response);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(is_serialized($datas)) {&nbsp;</div></li><li><div>              $data =  unserialize($datas);&nbsp;</div></li><li><div>              $this-&gt;api_debug_log($data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( !empty( $data-&gt;subscription_data ) ) {&nbsp;</div></li><li><div>                  $subscription_data =  $data-&gt;subscription_data;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              do_action( 'installer_fetched_subscription_data', $data, $repository_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $this-&gt;api_debug_log($datas);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;api_debug_log($response);&nbsp;</div></li><li><div>          throw new Exception( $response-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $subscription_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_local_product_versions( $repository_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $versions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $this-&gt;settings['repositories'][$repository_id]['data']['packages'] as $package_id =&gt; $package ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach( $package['products'] as $product_id =&gt; $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach( $product['plugins'] as $plugin_slug ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if( empty( $versions[$download['slug']] ) ) {&nbsp;</div></li><li><div>                      $v = $this-&gt;get_plugin_installed_version($download['name'], $download['slug']);&nbsp;</div></li><li><div>                      if($v) {&nbsp;</div></li><li><div>                          $versions[$download['slug']] = $v;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $versions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_repository_site_key($repository_id) {&nbsp;</div></li><li><div>      $site_key = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'][$repository_id]['subscription']['key'])) {&nbsp;</div></li><li><div>          $site_key = $this-&gt;settings['repositories'][$repository_id]['subscription']['key'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $site_key;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function repository_has_valid_subscription($repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $valid = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'][$repository_id]['subscription'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $subscription = $this-&gt;settings['repositories'][$repository_id]['subscription']['data'];&nbsp;</div></li><li><div>          $valid = ( $subscription-&gt;status == 1 && (strtotime($subscription-&gt;expires) &gt; time() || empty($subscription-&gt;expires)) ) || $subscription-&gt;status == 4;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $valid;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function repository_has_subscription($repository_id) {&nbsp;</div></li><li><div>      $key = false;&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'][$repository_id]['subscription']['key'])) {&nbsp;</div></li><li><div>          $key = $this-&gt;settings['repositories'][$repository_id]['subscription']['key'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function repository_has_expired_subscription($repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;repository_has_subscription($repository_id) && !$this-&gt;repository_has_valid_subscription($repository_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_generic_product_name($repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;settings['repositories'][$repository_id]['data']['product-name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function show_subscription_renew_warning($repository_id, $subscription_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $show = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = $this-&gt;settings['repositories'][$repository_id]['data'];&nbsp;</div></li><li><div>      if(!empty($data['subscriptions_meta'])) {&nbsp;</div></li><li><div>          if(isset($data['subscriptions_meta']['expiration'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!empty($data['subscriptions_meta']['expiration'][$subscription_id])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $days = $data['subscriptions_meta']['expiration'][$subscription_id]['days_warning'];&nbsp;</div></li><li><div>                  $message = $data['subscriptions_meta']['expiration'][$subscription_id]['warning_message'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">//defaults</span></span>&nbsp;</div></li><li><div>                  $days = 30;&nbsp;</div></li><li><div>                  $message = __('You will have to renew your subscription in order to continue getting the updates and support.', 'installer');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!empty($this-&gt;settings['repositories'][$repository_id]['subscription'])) {&nbsp;</div></li><li><div>                  $subscription = $this-&gt;settings['repositories'][$repository_id]['subscription'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($subscription['data']-&gt;subscription_type == $subscription_id && !empty($subscription['data']-&gt;expires)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if(strtotime($subscription['data']-&gt;expires) &lt; strtotime(sprintf(&quot;+%d day&quot;, $days))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $days_to_expiration = ceil((strtotime($subscription['data']-&gt;expires) - time()) / 86400);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          echo '&lt;div&gt;&lt;p class=&quot;installer-warn-box&quot;&gt;' .&nbsp;</div></li><li><div>                              sprintf(_n('Your subscription expires in %d day.', 'Your subscription expires in %d days.', $days_to_expiration, 'installer'), $days_to_expiration) .&nbsp;</div></li><li><div>                              '&lt;br /&gt;' . $message .&nbsp;</div></li><li><div>                              '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $show = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $show;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setup_plugins_renew_warnings() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscriptions_with_warnings = array();&nbsp;</div></li><li><div>      foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($this-&gt;repository_has_valid_subscription($repository_id)) {&nbsp;</div></li><li><div>              $subscription_type = $this-&gt;settings['repositories'][$repository_id]['subscription']['data']-&gt;subscription_type;&nbsp;</div></li><li><div>              $expires = $this-&gt;settings['repositories'][$repository_id]['subscription']['data']-&gt;expires;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $never_expires = isset($this-&gt;settings['repositories'][$repository_id]['subscription'])&nbsp;</div></li><li><div>                  && empty($this-&gt;settings['repositories'][$repository_id]['subscription']['data']-&gt;expires)&nbsp;</div></li><li><div>                  && (&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['subscription']['data']-&gt;status == 4 ||&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['subscription']['data']-&gt;status == 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!$never_expires) {&nbsp;</div></li><li><div>                  if(isset($this-&gt;settings['repositories'][$repository_id]['data']['subscriptions_meta']['expiration'][$subscription_type])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $days_warning = $this-&gt;settings['repositories'][$repository_id]['data']['subscriptions_meta']['expiration'][$subscription_type]['days_warning'];&nbsp;</div></li><li><div>                      $custom_message = $this-&gt;settings['repositories'][$repository_id]['data']['subscriptions_meta']['expiration'][$subscription_type]['warning_message'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }else{&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">//defaults</span></span>&nbsp;</div></li><li><div>                      $days_warning = 30;&nbsp;</div></li><li><div>                      $custom_message = __('You will have to renew your subscription in order to continue getting the updates and support.', 'installer');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(strtotime($expires) &lt; strtotime(sprintf('+%d day', $days_warning)) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $days_to_expiration = ceil((strtotime($expires) - time()) / 86400);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $message = sprintf(_n('Your subscription expires in %d day.', 'Your subscription expires in %d days.', $days_to_expiration, 'installer'), $days_to_expiration);&nbsp;</div></li><li><div>                      $subscriptions_with_warnings[$subscription_type] = $message . ' ' . $custom_message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($plugins as $plugin_id =&gt; $plugin) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $slug = dirname($plugin_id);&nbsp;</div></li><li><div>          if(empty($slug)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($this-&gt;repository_has_valid_subscription($repository_id)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($repository['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if($download['slug'] == $slug || $download['name'] == $plugin['Name'] || $download['name'] == $plugin['Title']) { <span class="comment"><span class="comment">//match order: slug, name, title</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  if(isset($subscriptions_with_warnings[$product['subscription_type']])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                      $this-&gt;_plugins_renew_warnings[$plugin_id] = $subscriptions_with_warnings[$product['subscription_type']];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function queue_plugins_renew_warnings() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;_plugins_renew_warnings)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;_plugins_renew_warnings as $plugin_id =&gt; $message) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              add_action( &quot;after_plugin_row_&quot; . $plugin_id, array($this, 'plugins_renew_warning'), 10, 3 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugins_renew_warning($plugin_file, $plugin_data, $status) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($this-&gt;_plugins_renew_warnings[$plugin_file])) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wp_list_table = _get_list_table('WP_Plugins_List_Table');&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;tr class=&quot;plugin-update-tr&quot;&gt;&lt;td colspan=&quot;&lt;?php echo $wp_list_table-&gt;get_column_count(); ?&gt;&quot; class=&quot;plugin-update colspanchange&quot;&gt;&nbsp;</div></li><li><div>              &lt;div class=&quot;update-message&quot;&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  echo $this-&gt;_plugins_renew_warnings[$plugin_file]. ' ';&nbsp;</div></li><li><div>                  printf(__('%sRenew here%s.', 'installer'), &nbsp;</div></li><li><div>                      '&lt;a href=&quot;' . $this-&gt;menu_url() . '&quot;&gt;', '&lt;/a&gt;');&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>              &lt;/div&gt;&nbsp;</div></li><li><div>      &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_subscription_type_for_repository($repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscription_type = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'][$repository_id]['subscription'])) {&nbsp;</div></li><li><div>          $subscription_type = $this-&gt;settings['repositories'][$repository_id]['subscription']['data']-&gt;subscription_type;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $subscription_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function have_superior_subscription($subscription_type, $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $have = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_array($product['upgrades'])) {&nbsp;</div></li><li><div>          foreach($product['upgrades'] as $u) {&nbsp;</div></li><li><div>              if($u['subscription_type'] == $subscription_type) {&nbsp;</div></li><li><div>                  $have = true;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $have;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_product_available_for_download($product_name, $repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $available = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subscription_type = $this-&gt;get_subscription_type_for_repository($repository_id);&nbsp;</div></li><li><div>      $expired = $this-&gt;repository_has_expired_subscription($repository_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($this-&gt;repository_has_subscription($repository_id) && !$expired) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;set_hierarchy_and_order();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'][$repository_id]['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $has_top_package = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($subscription_type == $product['subscription_type']) {&nbsp;</div></li><li><div>                      $has_top_package = true;&nbsp;</div></li><li><div>                      if($product['name'] == $product_name) {&nbsp;</div></li><li><div>                          return $available = true;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!empty($package['sub-packages'])) {&nbsp;</div></li><li><div>                  foreach($package['sub-packages'] as $sub_package) {&nbsp;</div></li><li><div>                      foreach($sub_package['products'] as $product) {&nbsp;</div></li><li><div>                          if($product['name'] == $product_name && ($subscription_type == $product['subscription_type'] || $has_top_package)) {&nbsp;</div></li><li><div>                              return $available = true;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $available;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_upgrade_options($repository_id) {&nbsp;</div></li><li><div>      $all_upgrades = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//get all products: packages and subpackages</span>&nbsp;</div></li><li><div>      $all_products = array();&nbsp;</div></li><li><div>      foreach($this-&gt;settings['repositories'][$repository_id]['data']['packages'] as $package) {&nbsp;</div></li><li><div>          foreach($package['products'] as $product) {&nbsp;</div></li><li><div>              $all_products[] = $product;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if(!empty($package['sub-packages'])) {&nbsp;</div></li><li><div>              foreach($package['sub-packages'] as $subpackage) {&nbsp;</div></li><li><div>                  foreach($subpackage['products'] as $product) {&nbsp;</div></li><li><div>                      $all_products[] = $product;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $all_products as $product ) {&nbsp;</div></li><li><div>          if ($product['upgrades']) {&nbsp;</div></li><li><div>              foreach ($product['upgrades'] as $upgrade) {&nbsp;</div></li><li><div>                  if ($this-&gt;repository_has_valid_subscription($repository_id) || ($this-&gt;repository_has_subscription($repository_id) && $upgrade['including_expired'])) {&nbsp;</div></li><li><div>                      $all_upgrades[$upgrade['subscription_type']][$product['subscription_type']] = $upgrade;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $all_upgrades;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function append_site_key_to_download_url($url, $key, $repository_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url_params['site_key'] = $key;&nbsp;</div></li><li><div>      $url_params['site_url'] = $this-&gt;get_installer_site_url( $repository_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Add extra parameters for custom Installer packages</span></span></span>&nbsp;</div></li><li><div>      if( !empty($this-&gt;package_source) ) {&nbsp;</div></li><li><div>          $extra = $this-&gt;get_extra_url_parameters();&nbsp;</div></li><li><div>          if( !empty($extra['repository']) && $extra['repository'] == $repository_id ) {&nbsp;</div></li><li><div>              unset($extra['repository']);&nbsp;</div></li><li><div>              foreach($extra as $key =&gt; $val) {&nbsp;</div></li><li><div>                  $url_params[$key] = $val;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = add_query_arg($url_params, $url);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($repository_id == 'wpml') {&nbsp;</div></li><li><div>          $url = add_query_arg(array('using_icl' =&gt; $this-&gt;_using_icl, 'wpml_version' =&gt; $this-&gt;_wpml_version), $url);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugin_is_installed($name, $slug, $version = null) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($plugins as $plugin_id =&gt; $plugin) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wp_plugin_slug = dirname($plugin_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Exception: embedded plugins</span>&nbsp;</div></li><li><div>          if( $wp_plugin_slug == $slug || $plugin['Name'] == $name  || $plugin['Title'] == $name || ( $wp_plugin_slug == $slug . '-embedded' || $plugin['Name'] == $name . ' Embedded' ) ) {&nbsp;</div></li><li><div>              if($version) {&nbsp;</div></li><li><div>                  if(version_compare($plugin['Version'], $version, '&gt;=')) {&nbsp;</div></li><li><div>                      $is = $plugin['Version'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>                  $is = $plugin['Version'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//exception: Types name difference</span>&nbsp;</div></li><li><div>      if(!$is && $name == 'Types') {&nbsp;</div></li><li><div>          return $this-&gt;plugin_is_installed('Types - Complete Solution for Custom Fields and Types', $slug, $version);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $is;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugin_is_embedded_version($name, $slug) {&nbsp;</div></li><li><div>      $is = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//false if teh full version is also installed</span>&nbsp;</div></li><li><div>      $is_full_installed = false;&nbsp;</div></li><li><div>      foreach($plugins as $plugin_id =&gt; $plugin) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(($plugin['Name'] == $name && !preg_match(&quot;#-embedded$#&quot;, $slug)) ) {&nbsp;</div></li><li><div>              $is_full_installed = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($is_full_installed) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($plugins as $plugin_id =&gt; $plugin) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// TBD</span>&nbsp;</div></li><li><div>          $wp_plugin_slug = dirname($plugin_id);&nbsp;</div></li><li><div>          if( $wp_plugin_slug == $slug . '-embedded' &&  $plugin['Name'] == $name . ' Embedded') {&nbsp;</div></li><li><div>              $is = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $is;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Alias for plugin_is_installed</span>&nbsp;</div></li><li><div>  public function get_plugin_installed_version($name, $slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;plugin_is_installed($name, $slug);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_plugin_repository_version($repository_id, $slug) {&nbsp;</div></li><li><div>      $version = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'][$repository_id]['data']['packages'])) {&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'][$repository_id]['data']['packages'] as $package) {&nbsp;</div></li><li><div>              foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if($download['slug'] == $slug) {&nbsp;</div></li><li><div>                          $version = $download['version'];&nbsp;</div></li><li><div>                          break (3);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $version;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_uploading_allowed() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//_deprecated_function ( __FUNCTION__, '1.7.3', 'Installer_Dependencies::' . __FUNCTION__ );</span>&nbsp;</div></li><li><div>      return $this-&gt;dependencies-&gt;is_uploading_allowed();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function download_plugin_ajax_handler() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php';&nbsp;</div></li><li><div>      require_once $this-&gt;plugin_path() . '/includes/installer-upgrader-skins.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = json_decode( base64_decode( sanitize_text_field ( $_POST['data'] ) ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ret = false;&nbsp;</div></li><li><div>      $plugin_id = false;&nbsp;</div></li><li><div>      $message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//validate subscription</span></span></span>&nbsp;</div></li><li><div>      $site_key = $this-&gt;get_repository_site_key($data['repository_id']);&nbsp;</div></li><li><div>      $subscription_data = $this-&gt;fetch_subscription_data( $data['repository_id'], $site_key , self::SITE_KEY_VALIDATION_SOURCE_DOWNLOAD_REPORT);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($subscription_data && !is_wp_error($subscription_data) && $this-&gt;repository_has_valid_subscription($data['repository_id'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($data['nonce'] == wp_create_nonce('install_plugin_' . $data['url'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $upgrader_skins = new Installer_Upgrader_Skins(); <span class="comment"><span class="comment">//use our custom (mute) Skin</span></span>&nbsp;</div></li><li><div>              $upgrader = new Plugin_Upgrader($upgrader_skins);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              remove_action( 'upgrader_process_complete', array( 'Language_Pack_Upgrader', 'async_upgrade' ), 20 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">//upgrade</span></span> or install?</span>&nbsp;</div></li><li><div>              foreach($plugins as $id =&gt; $plugin) {&nbsp;</div></li><li><div>                  $wp_plugin_slug = dirname($id);&nbsp;</div></li><li><div>                  $is_embedded = $this-&gt;plugin_is_embedded_version(preg_replace('/ Embedded$/', '', $plugin['Name']), preg_replace('/-embedded$/', '', $wp_plugin_slug));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($wp_plugin_slug == $data['slug'] || $is_embedded && preg_replace('/-embedded$/', '', $wp_plugin_slug) == $data['slug']) {&nbsp;</div></li><li><div>                      $plugin_id = $id;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($plugin_id && empty($is_embedded)) { <span class="comment"><span class="comment">//upgrade</span></span>&nbsp;</div></li><li><div>                  $response['upgrade'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $plugin_is_active = is_plugin_active($plugin_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $ret = $upgrader-&gt;upgrade($plugin_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(!$ret && !empty($upgrader-&gt;skin-&gt;installer_error)) {&nbsp;</div></li><li><div>                      if(is_wp_error($upgrader-&gt;skin-&gt;installer_error)) {&nbsp;</div></li><li><div>                          $message = $upgrader-&gt;skin-&gt;installer_error-&gt;get_error_message() .&nbsp;</div></li><li><div>                              ' (' . $upgrader-&gt;skin-&gt;installer_error-&gt;get_error_data() . ')';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($plugin_is_active) {&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">//prevent redirects</span></span>&nbsp;</div></li><li><div>                      add_filter('wp_redirect', '__return_false');&nbsp;</div></li><li><div>                      activate_plugin($plugin_id);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }else{ <span class="comment"><span class="comment">//install</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($is_embedded) {&nbsp;</div></li><li><div>                      delete_plugins(array($plugin_id));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $response['install'] = 1;&nbsp;</div></li><li><div>                  $ret = $upgrader-&gt;install($data['url']);&nbsp;</div></li><li><div>                  if(!$ret && !empty($upgrader-&gt;skin-&gt;installer_error)) {&nbsp;</div></li><li><div>                      if(is_wp_error($upgrader-&gt;skin-&gt;installer_error)) {&nbsp;</div></li><li><div>                          $message = $upgrader-&gt;skin-&gt;installer_error-&gt;get_error_message() .&nbsp;</div></li><li><div>                              ' (' . $upgrader-&gt;skin-&gt;installer_error-&gt;get_error_data() . ')';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $plugins = get_plugins(); <span class="comment">//read again</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($ret && !empty($_POST['activate'])) {&nbsp;</div></li><li><div>                  foreach($plugins as $id =&gt; $plugin) {&nbsp;</div></li><li><div>                      $wp_plugin_slug = dirname($id);&nbsp;</div></li><li><div>                      if($wp_plugin_slug == $data['slug']) {&nbsp;</div></li><li><div>                          $plugin_version = $plugin['Version'];&nbsp;</div></li><li><div>                          $plugin_id = $id;&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else { <span class="comment">//subscription not valid</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ret = false;&nbsp;</div></li><li><div>          $message = __('Your subscription appears to no longer be valid. Please try to register again using a valid site key.', 'installer');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $response['version'] = isset($plugin_version) ? $plugin_version : 0;&nbsp;</div></li><li><div>      $response['plugin_id'] = $plugin_id;&nbsp;</div></li><li><div>      $response['nonce'] = wp_create_nonce('activate_' . $plugin_id);&nbsp;</div></li><li><div>      $response['success'] = $ret;&nbsp;</div></li><li><div>      $response['message'] = $message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode( $response );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function download_plugin($slug, $url) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php';&nbsp;</div></li><li><div>      require_once $this-&gt;plugin_path() . '/includes/installer-upgrader-skins.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $upgrader_skins = new Installer_Upgrader_Skins(); <span class="comment"><span class="comment">//use our custom (mute) Skin</span></span>&nbsp;</div></li><li><div>      $upgrader = new Plugin_Upgrader($upgrader_skins);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_action( 'upgrader_process_complete', array( 'Language_Pack_Upgrader', 'async_upgrade' ), 20 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugin_id = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">//upgrade</span></span> or install?</span>&nbsp;</div></li><li><div>      foreach($plugins as $id =&gt; $plugin) {&nbsp;</div></li><li><div>          $wp_plugin_slug = dirname($id);&nbsp;</div></li><li><div>          if($wp_plugin_slug == $slug) {&nbsp;</div></li><li><div>              $plugin_id = $id;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($plugin_id) { <span class="comment"><span class="comment">//upgrade</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $plugin_is_active = is_plugin_active($plugin_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ret = $upgrader-&gt;upgrade($plugin_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($plugin_is_active) {&nbsp;</div></li><li><div>              activate_plugin($plugin_id);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }else{ <span class="comment"><span class="comment">//install</span></span>&nbsp;</div></li><li><div>          $ret = $upgrader-&gt;install($url);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $ret;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function activate_plugin() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugin_id = sanitize_text_field ( $_POST['plugin_id'] );&nbsp;</div></li><li><div>      if(isset($_POST['nonce']) &&  $plugin_id && $_POST['nonce'] == wp_create_nonce('activate_' . $plugin_id )) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Deactivate any embedded version</span>&nbsp;</div></li><li><div>          $plugin_slug = dirname($plugin_id);&nbsp;</div></li><li><div>          $active_plugins = get_option('active_plugins');&nbsp;</div></li><li><div>          foreach($active_plugins as $plugin) {&nbsp;</div></li><li><div>              $wp_plugin_slug = dirname($plugin);&nbsp;</div></li><li><div>              if($wp_plugin_slug == $plugin_slug . '-embedded') {&nbsp;</div></li><li><div>                  deactivate_plugins(array($plugin));&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">//prevent redirects</span></span>&nbsp;</div></li><li><div>          add_filter('wp_redirect', '__return_false', 10000);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $return = activate_plugin($plugin_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(is_wp_error($return)) {&nbsp;</div></li><li><div>              $error = $return-&gt;get_error_message();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $error = 'error';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ret = array('error' =&gt; $error);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode($ret);&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function custom_plugins_api_call($false, $action, $args) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($action == 'plugin_information') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $plugins = get_plugins();&nbsp;</div></li><li><div>          $plugin_names = array();&nbsp;</div></li><li><div>          foreach( $plugins as $plugin_id =&gt; $plugin ) {&nbsp;</div></li><li><div>              <span class="comment">// plugins by WP slug which (plugin folder) which can be different</span>&nbsp;</div></li><li><div>              <span class="comment">// will use this to compare by title</span>&nbsp;</div></li><li><div>              $plugin_names[ dirname( $plugin_id ) ] = array(&nbsp;</div></li><li><div>                  'name' =&gt; $plugin['Name'], &nbsp;</div></li><li><div>                  'title' =&gt; $plugin['Title'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $slug = $args-&gt;slug;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!$this-&gt;repository_has_valid_subscription($repository_id)) {&nbsp;</div></li><li><div>                  $site_key = false;&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>                  $site_key = $repository['subscription']['key'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($repository['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if( $download['slug'] == $slug ||&nbsp;</div></li><li><div>                              isset( $plugin_names[$slug] ) && (&nbsp;</div></li><li><div>                                  $plugin_names[$slug]['name'] == $download['name']  ||&nbsp;</div></li><li><div>                                  $plugin_names[$slug]['title'] == $download['name']&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if( !empty( $download['free-on-wporg'] ) ) {&nbsp;</div></li><li><div>                                  return false; <span class="comment">// use data from wordpress.org</span>&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $res = new stdClass();&nbsp;</div></li><li><div>                              $res-&gt;external = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $res-&gt;name = $download['name'];&nbsp;</div></li><li><div>                              $res-&gt;slug = $slug;&nbsp;</div></li><li><div>                              $res-&gt;version = $download['version'];&nbsp;</div></li><li><div>                              $res-&gt;author = '';&nbsp;</div></li><li><div>                              $res-&gt;author_profile = '';&nbsp;</div></li><li><div>                              $res-&gt;last_updated = $download['date'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if($site_key) {&nbsp;</div></li><li><div>                                  $res-&gt;download_link = $this-&gt;append_site_key_to_download_url($download['url'], $site_key, $repository_id);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $res-&gt;homepage = $repository['data']['url'];&nbsp;</div></li><li><div>                              $res-&gt;sections = array('Description' =&gt; $download['description'], 'Changelog' =&gt; $download['changelog']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              return $res;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugins_upgrade_check($update_plugins) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($plugins as $plugin_id =&gt; $plugin) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $slug = dirname($plugin_id);&nbsp;</div></li><li><div>              if(empty($slug)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $version = $plugin['Version'];&nbsp;</div></li><li><div>              $name = $plugin['Name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(!$this-&gt;repository_has_valid_subscription($repository_id)) {&nbsp;</div></li><li><div>                      $site_key = false;&nbsp;</div></li><li><div>                  }else{&nbsp;</div></li><li><div>                      $site_key = $repository['subscription']['key'];&nbsp;</div></li><li><div>                      <span class="comment">//$subscription_type = $this-&gt;get_subscription_type_for_repository($repository_id);</span>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($repository['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if(!empty($download['free-on-wporg'])) {&nbsp;</div></li><li><div>                                  continue;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if(empty($update_plugins-&gt;response[$plugin_id]) && ($download['slug'] == $slug || $download['name'] == $name ) && version_compare($download['version'], $version, '&gt;')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  $response = new stdClass();&nbsp;</div></li><li><div>                                  $response-&gt;id = 0;&nbsp;</div></li><li><div>                                  $response-&gt;slug = $slug;&nbsp;</div></li><li><div>                                  $response-&gt;plugin = $plugin_id;&nbsp;</div></li><li><div>                                  $response-&gt;new_version = $download['version'];&nbsp;</div></li><li><div>                                  $response-&gt;upgrade_notice = '';&nbsp;</div></li><li><div>                                  $response-&gt;url = $download['url'];&nbsp;</div></li><li><div>                                  if($site_key) {&nbsp;</div></li><li><div>                                      $response-&gt;package = $this-&gt;append_site_key_to_download_url($download['url'], $site_key, $repository_id);&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  $update_plugins-&gt;checked[$plugin_id] = $version;&nbsp;</div></li><li><div>                                  $update_plugins-&gt;response[$plugin_id] = $response;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $update_plugins;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function setup_plugins_page_notices() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_plugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($plugins as $plugin_id =&gt; $plugin) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $slug = dirname($plugin_id);&nbsp;</div></li><li><div>          if(empty($slug)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $name = $plugin['Name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!$this-&gt;repository_has_valid_subscription($repository_id)) {&nbsp;</div></li><li><div>                  $site_key = false;&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>                  $site_key = $repository['subscription']['key'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($repository['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if(!empty($download['free-on-wporg'])) {&nbsp;</div></li><li><div>                              continue;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if( $download['slug'] == $slug || $download['name'] == $name ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              if( !$site_key || !$this-&gt;plugin_is_registered($repository_id, $download['slug']) ) {&nbsp;</div></li><li><div>                                  add_action( &quot;after_plugin_row_&quot; . $plugin_id, array($this, 'show_purchase_notice_under_plugin'), 10, 3 );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function show_purchase_notice_under_plugin($plugin_file, $plugin_data, $status) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wp_list_table = _get_list_table('WP_Plugins_List_Table');&nbsp;</div></li><li><div>      $wp_version = preg_replace( '/-(.+)$/', '', $GLOBALS['wp_version'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( version_compare( $wp_version, '4.6', '&gt;=' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;tr class=&quot;plugin-update-tr installer-plugin-update-tr&quot;&gt;&nbsp;</div></li><li><div>              &lt;td colspan=&quot;&lt;?php echo $wp_list_table-&gt;get_column_count(); ?&gt;&quot; class=&quot;plugin-update colspanchange&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;notice inline notice-warning notice-alt&quot;&gt;&nbsp;</div></li><li><div>                      &lt;p class=&quot;installer-q-icon&quot;&gt;&nbsp;</div></li><li><div>                          &lt;?php printf( __('You must have a valid subscription in order to get upgrades or support for this plugin. %sPurchase a subscription or enter an existing site key%s.', 'installer'), &nbsp;</div></li><li><div>                              '&lt;a href=&quot;' . $this-&gt;menu_url() . '&quot;&gt;', '&lt;/a&gt;'); ?&gt;&nbsp;</div></li><li><div>                      &lt;/p&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;tr class=&quot;plugin-update-tr&quot;&gt;&nbsp;</div></li><li><div>              &lt;td colspan=&quot;&lt;?php echo $wp_list_table-&gt;get_column_count(); ?&gt;&quot; class=&quot;plugin-update colspanchange&quot;&gt;&nbsp;</div></li><li><div>                  &lt;div class=&quot;update-message installer-q-icon&quot;&gt;&nbsp;</div></li><li><div>                      &lt;?php printf( __('You must have a valid subscription in order to get upgrades or support for this plugin. %sPurchase a subscription or enter an existing site key%s.', 'installer'), &nbsp;</div></li><li><div>                          '&lt;a href=&quot;' . $this-&gt;menu_url() . '&quot;&gt;', '&lt;/a&gt;'); ?&gt;&nbsp;</div></li><li><div>                  &lt;/div&gt;&nbsp;</div></li><li><div>              &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>          &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function localize_strings() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>              <span class="comment">//set name as call2action when don't have any</span>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//products</span></span>&nbsp;</div></li><li><div>              foreach($repository['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>                  foreach($package['products'] as $product_id =&gt; $product) {&nbsp;</div></li><li><div>                      if(empty($product['call2action'])) {&nbsp;</div></li><li><div>                          $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['call2action'] = $product['name'];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($product['upgrades'] as $idx =&gt; $upg) {&nbsp;</div></li><li><div>                          if(empty($upg['call2action'])) {&nbsp;</div></li><li><div>                              $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['upgrades'][$idx]['call2action'] = $upg['name'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($product['renewals'] as $idx =&gt; $rnw) {&nbsp;</div></li><li><div>                          if(empty($rnw['call2action'])) {&nbsp;</div></li><li><div>                              $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['renewals'][$idx]['call2action'] = $rnw['name'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $sitepress;&nbsp;</div></li><li><div>      if(is_null($sitepress)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// default strings are always in English</span>&nbsp;</div></li><li><div>      $user_admin_language = $sitepress-&gt;get_admin_language();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($user_admin_language != 'en') {&nbsp;</div></li><li><div>          foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $localization = $repository['data']['localization'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//packages</span>&nbsp;</div></li><li><div>              foreach($repository['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if( isset($localization['packages'][$package_id]['name'][$user_admin_language]) ) {&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['name'] = $localization['packages'][$package_id]['name'][$user_admin_language];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if( isset($localization['packages'][$package_id]['description'][$user_admin_language]) ) {&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['description'] = $localization['packages'][$package_id]['description'][$user_admin_language];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">//products</span></span>&nbsp;</div></li><li><div>              foreach($repository['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>                  foreach($package['products'] as $product_id =&gt; $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if( isset($localization['products'][$product_id]['name'][$user_admin_language]) ) {&nbsp;</div></li><li><div>                          $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['name']&nbsp;</div></li><li><div> = $localization['products'][$product_id]['name'][$user_admin_language];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if( isset($localization['products'][$product_id]['description'][$user_admin_language]) ) {&nbsp;</div></li><li><div>                          $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['description']&nbsp;</div></li><li><div> = $localization['products'][$product_id]['description'][$user_admin_language];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if( isset($localization['products'][$product_id]['call2action'][$user_admin_language]) ) {&nbsp;</div></li><li><div>                          $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['name']&nbsp;</div></li><li><div> = $localization['products'][$product_id]['call2action'][$user_admin_language];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//subscription info</span>&nbsp;</div></li><li><div>              if(isset($repository['data']['subscriptions_meta']['expiration'])) {&nbsp;</div></li><li><div>                  foreach($repository['data']['subscriptions_meta']['expiration'] as $subscription_id =&gt; $note) {&nbsp;</div></li><li><div>                      if(isset($localization['subscriptions-notes'][$subscription_id]['expiration-warning'][$user_admin_language])) {&nbsp;</div></li><li><div>                          $this-&gt;settings['repositories'][$repository_id]['data']['subscriptions_meta']['expiration'][$subscription_id]['warning_message']&nbsp;</div></li><li><div> = $localization['subscriptions-notes'][$subscription_id]['expiration-warning'][$user_admin_language];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_matching_cp($repository, $args = array()) {&nbsp;</div></li><li><div>      $match = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cp_name = $cp_author = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($this-&gt;config['src_name']) && isset($this-&gt;config['src_author'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $cp_name = $this-&gt;config['src_name'];&nbsp;</div></li><li><div>          $cp_author = $this-&gt;config['src_author'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }elseif(isset($args['src_name']) && isset($args['src_author'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $cp_name = $args['src_name'];&nbsp;</div></li><li><div>          $cp_author = $args['src_author'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($repository['data']['marketing_cp'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($repository['data']['marketing_cp'] as $cp) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!empty($cp['exp']) && time() &gt; $cp['exp']) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//Use theme_name for plugins too</span>&nbsp;</div></li><li><div>              if(!empty($cp['theme_name'])) {&nbsp;</div></li><li><div>                  if($cp['author_name'] == $cp_author && $cp['theme_name'] == $cp_name) {&nbsp;</div></li><li><div>                      $match = $cp;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>                  if($cp['author_name'] == $cp_author) {&nbsp;</div></li><li><div>                      $match = $cp;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $match;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function set_filtered_prices($args = array()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $match = $this-&gt;get_matching_cp($repository, $args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(empty($match)) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach($repository['data']['packages'] as $package_id =&gt; $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($package['products'] as $product_id =&gt; $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($match['dtp'] == '%') {&nbsp;</div></li><li><div>                      $fprice = round( $product['price'] * (1 - $match['amt']/100), 2 );&nbsp;</div></li><li><div>                      $fprice = $fprice != round($fprice) ? sprintf('%.2f', $fprice) : round($fprice, 0);&nbsp;</div></li><li><div>                  }elseif($match['dtp'] == '-') {&nbsp;</div></li><li><div>                      $fprice = $product['price'] - $match['amt'];&nbsp;</div></li><li><div>                  }else{&nbsp;</div></li><li><div>                      $fprice = $product['price'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($fprice) {&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['price_disc'] = $fprice;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $url_glue = false !== strpos($this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['url'], '?') ? '&' : '?';&nbsp;</div></li><li><div>                      $cpndata = base64_encode(json_encode(array('theme_author' =&gt; $match['author_name'], 'theme_name' =&gt; $match['theme_name'], 'vlc' =&gt; $match['vlc'])));&nbsp;</div></li><li><div>                      $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['url'] .= $url_glue . 'cpn=' . $cpndata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($product['upgrades'] as $upgrade_id =&gt; $upgrade) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $fprice = false;&nbsp;</div></li><li><div>                          if($match['dtp'] == '%') {&nbsp;</div></li><li><div>                              $fprice = round( $upgrade['price'] * (1 - $match['amt']/100), 2 );&nbsp;</div></li><li><div>                              $fprice = $fprice != round($fprice) ? sprintf('%.2f', $fprice) : round($fprice, 0);&nbsp;</div></li><li><div>                          }elseif($match['dtp'] == '-') {&nbsp;</div></li><li><div>                              $fprice = $upgrade['price'] - $match['amt'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          if($fprice) {&nbsp;</div></li><li><div>                              $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['upgrades'][$upgrade_id]['price_disc'] = $fprice;&nbsp;</div></li><li><div>                              $this-&gt;settings['repositories'][$repository_id]['data']['packages'][$package_id]['products'][$product_id]['upgrades'][$upgrade_id]['url'] .= $url_glue . 'cpn=' . $cpndata;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function set_hierarchy_and_order() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//2 levels</span>&nbsp;</div></li><li><div>      if(!empty($this-&gt;settings['repositories'])) {&nbsp;</div></li><li><div>          foreach ($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( empty( $repository['data']['packages'] ) ) continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $all_packages = $repository['data']['packages'];&nbsp;</div></li><li><div>              $ordered_packages = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//backward compatibility - 'order'</span>&nbsp;</div></li><li><div>              foreach($all_packages as $k =&gt; $v) {&nbsp;</div></li><li><div>                  if(!isset($v['order'])) {&nbsp;</div></li><li><div>                      $all_packages[$k]['order'] = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//select parents</span>&nbsp;</div></li><li><div>              foreach ($all_packages as $package_id =&gt; $package) {&nbsp;</div></li><li><div>                  if(empty($package['parent'])) {&nbsp;</div></li><li><div>                      $ordered_packages[$package_id] = $package;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">//add sub-packages</span>&nbsp;</div></li><li><div>              foreach($all_packages as $package_id =&gt; $package) {&nbsp;</div></li><li><div>                  if(!empty($package['parent'])) {&nbsp;</div></li><li><div>                      if(isset($ordered_packages[$package['parent']])) {&nbsp;</div></li><li><div>                          $ordered_packages[$package['parent']]['sub-packages'][$package_id] = $package;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// order parents</span>&nbsp;</div></li><li><div>              usort($ordered_packages, array($this, '_order_packages_callback'));&nbsp;</div></li><li><div>              <span class="comment">//order sub-packages</span>&nbsp;</div></li><li><div>              foreach($ordered_packages as $package_id =&gt; $package) {&nbsp;</div></li><li><div>                  if(!empty($package['sub-packages'])) {&nbsp;</div></li><li><div>                      usort($ordered_packages[$package_id]['sub-packages'], create_function('$a, $b', 'return $a[\'order\'] &gt; $b[\'order\'];'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;settings['repositories'][$repository_id]['data']['packages'] = $ordered_packages;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function _order_packages_callback($a, $b) {&nbsp;</div></li><li><div>      return $a['order'] &gt; $b['order'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_support_tag_by_name( $name, $repository ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( is_array($this-&gt;settings['repositories'][$repository]['data']['support_tags'] )) {&nbsp;</div></li><li><div>          foreach( $this-&gt;settings['repositories'][$repository]['data']['support_tags'] as $support_tag) {&nbsp;</div></li><li><div>              if( $support_tag['name'] == $name ) {&nbsp;</div></li><li><div>                  return $support_tag['url'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function plugin_upgrade_custom_errors() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset($_REQUEST['action']) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $action = isset($_REQUEST['action']) ? sanitize_text_field ( $_REQUEST['action'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//bulk mode</span>&nbsp;</div></li><li><div>          if('update-selected' == $action) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              global $plugins;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(isset($plugins) && is_array($plugins)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ($plugins as $k =&gt; $plugin) {&nbsp;</div></li><li><div>                      $plugin_repository = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $wp_plugin_slug = dirname($plugin);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach ($repository['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              foreach ($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  foreach ($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                      $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                      if ($download['slug'] == $wp_plugin_slug) {&nbsp;</div></li><li><div>                                          $plugin_repository = $repository_id;&nbsp;</div></li><li><div>                                          $product_name = $repository['data']['product-name'];&nbsp;</div></li><li><div>                                          $plugin_name = $download['name'];&nbsp;</div></li><li><div>                                          $free_on_wporg = !empty($download['free-on-wporg']);&nbsp;</div></li><li><div>                                          break;&nbsp;</div></li><li><div>                                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ($plugin_repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment">//validate subscription</span></span></span>&nbsp;</div></li><li><div>                          static $sub_cache = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if(empty($sub_cache[$plugin_repository])) {&nbsp;</div></li><li><div>                              $site_key = $this-&gt;get_repository_site_key($plugin_repository);&nbsp;</div></li><li><div>                              if ($site_key) {&nbsp;</div></li><li><div>                                  $subscription_data = $this-&gt;fetch_subscription_data( $plugin_repository, $site_key, self::SITE_KEY_VALIDATION_SOURCE_REVALIDATION );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $sub_cache[$plugin_repository]['site_key'] = $site_key;&nbsp;</div></li><li><div>                              $sub_cache[$plugin_repository]['subscription_data'] = isset($subscription_data) ? $subscription_data : false;&nbsp;</div></li><li><div>                          }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $site_key = $sub_cache[$plugin_repository]['site_key'];&nbsp;</div></li><li><div>                              $subscription_data = $sub_cache[$plugin_repository]['subscription_data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if(!$site_key && !empty($free_on_wporg)) { <span class="comment">// allow the download from wp.org</span>&nbsp;</div></li><li><div>                              continue;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if (empty($site_key) || empty($subscription_data)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              $error_message = sprintf(__(&quot;%s cannot update because your site's registration is not valid. Please %sregister %s%s again for this site first.&quot;, 'installer'), &nbsp;</div></li><li><div>                                  '&lt;strong&gt;' . $plugin_name . '&lt;/strong&gt;', '&lt;a target=&quot;_top&quot; href=&quot;' . $this-&gt;menu_url() . '&validate_repository=' . $plugin_repository .&nbsp;</div></li><li><div>                                  '#repository-' . $plugin_repository . '&quot;&gt;', $product_name, '&lt;/a&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              echo '&lt;div class=&quot;updated error&quot;&gt;&lt;p&gt;' . $error_message . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              unset($plugins[$k]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( 'upgrade-plugin' == $action || 'update-plugin' == $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $plugin = isset($_REQUEST['plugin']) ? trim( sanitize_text_field ( $_REQUEST['plugin'] ) ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $wp_plugin_slug = dirname($plugin);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $plugin_repository = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($this-&gt;settings['repositories'] as $repository_id =&gt; $repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach($repository['data']['packages'] as $package) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($package['products'] as $product) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          foreach($product['plugins'] as $plugin_slug) {&nbsp;</div></li><li><div>                              $download = $this-&gt;settings['repositories'][$repository_id]['data']['downloads']['plugins'][$plugin_slug];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                              <span class="comment">//match by folder, will change to match by name and folder</span>&nbsp;</div></li><li><div>                              if($download['slug'] == $wp_plugin_slug) {&nbsp;</div></li><li><div>                                  $plugin_repository = $repository_id;&nbsp;</div></li><li><div>                                  $product_name = $repository['data']['product-name'];&nbsp;</div></li><li><div>                                  $plugin_name = $download['name'];&nbsp;</div></li><li><div>                                  $free_on_wporg = !empty($download['free-on-wporg']);&nbsp;</div></li><li><div>                                  break;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($plugin_repository) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">//validate subscription</span></span></span>&nbsp;</div></li><li><div>                  $site_key = $this-&gt;get_repository_site_key($plugin_repository);&nbsp;</div></li><li><div>                  if ($site_key) {&nbsp;</div></li><li><div>                      $subscription_data = $this-&gt;fetch_subscription_data( $plugin_repository, $site_key, self::SITE_KEY_VALIDATION_SOURCE_REVALIDATION );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( (empty($site_key) || empty($subscription_data)) && empty($free_on_wporg)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $error_message = sprintf(__(&quot;%s cannot update because your site's registration is not valid. Please %sregister %s%s again for this site first.&quot;, 'installer'), &nbsp;</div></li><li><div>                          '&lt;strong&gt;'.$plugin_name . '&lt;/strong&gt;', '&lt;a href=&quot;' . $this-&gt;menu_url() . '&validate_repository=' . $plugin_repository .&nbsp;</div></li><li><div>                          '#repository-' . $plugin_repository . '&quot;&gt;', $product_name, '&lt;/a&gt;');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if(defined('DOING_AJAX')) { <span class="comment">//WP 4.2</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $status = array(&nbsp;</div></li><li><div>                              'update' =&gt; 'plugin', &nbsp;</div></li><li><div>                              'plugin' =&gt; $plugin, &nbsp;</div></li><li><div>                              'slug' =&gt; sanitize_key( $_POST['slug'] ), &nbsp;</div></li><li><div>                              'oldVersion' =&gt; '', &nbsp;</div></li><li><div>                              'newVersion' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $status['errorCode'] = 'wp_installer_invalid_subscription';&nbsp;</div></li><li><div>                          $status['error'] = $error_message;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          wp_send_json_error( $status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      } else { <span class="comment">// WP 4.1.1</span>&nbsp;</div></li><li><div>                          echo '&lt;div class=&quot;updated error&quot;&gt;&lt;p&gt;' . $error_message . '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          echo '&lt;div class=&quot;wrap&quot;&gt;';&nbsp;</div></li><li><div>                          echo '&lt;h2&gt;' . __( 'Update Plugin', 'installer' ) . '&lt;/h2&gt;';&nbsp;</div></li><li><div>                          echo '&lt;a href=&quot;' . admin_url('plugins.php') . '&quot;&gt;' . __( 'Return to the plugins page', 'installer' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>                          echo '&lt;/div&gt;';&nbsp;</div></li><li><div>                          require_once(ABSPATH . 'wp-admin/admin-footer.php');&nbsp;</div></li><li><div>                          exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Multilingual</li><li><span></span>4.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>