<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.1.3" data-slug="woocommerce-multilingual" data-type="file" data-id="18781"><head xmlns="http://www.w3.org/1999/xhtml"><title> inc-currencies-class-wcml-multi-currency-prices | file | Woocommerce Multilingual | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce-multilingual, 4.1.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3b34b6303eeef8d665031a7b4c0a0dd6' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/inc-currencies-class-wcml-multi-currency-prices/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Finc-currencies-class-wcml-multi-currency-prices%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Finc-currencies-class-wcml-multi-currency-prices%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-multilingual-4.1.3-file-inc-currencies-class-wcml-multi-currency-prices","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="inc-currencies-class-wcml-multi-currency-prices" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce-multilingual." href="http://hookr.io/plugins/woocommerce-multilingual/" class="plugin"><span property="name">woocommerce-multilingual</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.1.3." href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/" class="H_VERSION"><span property="name">4.1.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">inc-currencies-class-wcml-mul&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="810"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/all/" title="All">All <span class="count badge">810</span></a></li><li class="" data-id="new" data-count="15"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/new/" title="New">New <span class="count badge">15</span></a></li><li class="" data-id="hooks" data-count="350"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/hooks/" title="Hooks">Hooks <span class="count badge">350</span></a></li><li class="" data-id="action" data-count="47"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/actions/" title="Actions">Actions <span class="count badge">47</span></a></li><li class="" data-id="filter" data-count="303"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/filters/" title="Filters">Filters <span class="count badge">303</span></a></li><li class="" data-id="class" data-count="429"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/classes/" title="Classes">Classes <span class="count badge">429</span></a></li><li class="" data-id="constant" data-count="16"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/constants/" title="Constants">Constants <span class="count badge">16</span></a></li><li class="" data-id="function" data-count="14"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/functions/" title="Functions">Functions <span class="count badge">14</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/woocommerce-multilingual/4.1.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/inc/currencies/class-wcml-multi-currency-prices.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WCML_Multi_Currency_Prices{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var woocommerce_wpml</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $woocommerce_wpml;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var WCML_Multi_Currency</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $multi_currency;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @var orders_list_currency</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $orders_list_currency;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function __construct( &$multi_currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;multi_currency =& $multi_currency;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $this-&gt;multi_currency-&gt;load_filters ) {&nbsp;</div></li><li><div>          add_filter('init', array($this, 'prices_init'), 5);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Currency and Amount filters</span>&nbsp;</div></li><li><div>          add_filter('woocommerce_currency', array($this, 'currency_filter'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'wcml_price_currency', array($this, 'price_currency_filter') );      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// WCML filters</span></span></span></span>&nbsp;</div></li><li><div>          add_filter( 'wcml_raw_price_amount', array($this, 'raw_price_filter'), 10, 2 );  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// WCML filters</span></span></span></span>&nbsp;</div></li><li><div>          add_filter( 'wcml_product_price_by_currency', array($this, 'get_product_price_in_currency'), 10, 2 );  <span class="comment"><span class="comment"><span class="comment"><span class="comment">// WCML filters</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter('get_post_metadata', array($this, 'product_price_filter'), 10, 4);&nbsp;</div></li><li><div>          add_filter('get_post_metadata', array($this, 'variation_prices_filter'), 12, 4); <span class="comment">// second</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter('woocommerce_price_filter_widget_max_amount', array($this, 'raw_price_filter'), 99);&nbsp;</div></li><li><div>          add_filter('woocommerce_price_filter_widget_min_amount', array($this, 'raw_price_filter'), 99);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter('woocommerce_adjust_price', array($this, 'raw_price_filter'), 10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter('wcml_formatted_price', array($this, 'formatted_price'), 10, 2); <span class="comment"><span class="comment"><span class="comment"><span class="comment">// WCML filters</span></span></span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Shipping prices</span>&nbsp;</div></li><li><div>          add_filter('woocommerce_paypal_args', array($this, 'filter_price_woocommerce_paypal_args'));&nbsp;</div></li><li><div>          add_filter('woocommerce_get_variation_prices_hash', array($this, 'add_currency_to_variation_prices_hash'));&nbsp;</div></li><li><div>          add_filter('woocommerce_cart_contents_total', array($this, 'filter_woocommerce_cart_contents_total'), 100);&nbsp;</div></li><li><div>          add_filter('woocommerce_cart_subtotal', array($this, 'filter_woocommerce_cart_subtotal'), 100, 3);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//filters for wc-widget-price-filter</span>&nbsp;</div></li><li><div>          add_filter('woocommerce_price_filter_results', array($this, 'filter_price_filter_results'), 10, 3);&nbsp;</div></li><li><div>          add_filter('woocommerce_price_filter_widget_amount', array($this, 'filter_price_filter_widget_amount'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action( 'woocommerce_cart_loaded_from_session', array( $this, 'filter_currency_num_decimals_in_cart' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( version_compare( WOOCOMMERCE_VERSION, '2.3', '&lt;' ) ) {&nbsp;</div></li><li><div>              add_filter( 'wc_price', array( $this, 'price_in_specific_currency' ), 10, 3 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'wc_price_args', array( $this, 'filter_wc_price_args') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          WCML_Multi_Currency_Table_Rate_Shipping::set_up();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// formatting options</span>&nbsp;</div></li><li><div>      add_filter('option_woocommerce_price_thousand_sep', array($this, 'filter_currency_thousand_sep_option'));&nbsp;</div></li><li><div>      add_filter('option_woocommerce_price_decimal_sep', array($this, 'filter_currency_decimal_sep_option'));&nbsp;</div></li><li><div>      add_filter('option_woocommerce_price_num_decimals', array($this, 'filter_currency_num_decimals_option'));&nbsp;</div></li><li><div>      add_filter('option_woocommerce_currency_pos', array($this, 'filter_currency_position_option'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//need for display correct price format for order on orders list page</span>&nbsp;</div></li><li><div>      add_filter( 'get_post_metadata', array( $this, 'save_order_currency_for_filter' ), 10, 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function prices_init() {&nbsp;</div></li><li><div>      global $woocommerce_wpml;&nbsp;</div></li><li><div>      $this-&gt;woocommerce_wpml =& $woocommerce_wpml;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function currency_filter($currency) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $currency = apply_filters('wcml_price_currency', $currency);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $currency;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function price_currency_filter( $currency ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($this-&gt;order_currency)) {&nbsp;</div></li><li><div>          $currency = $this-&gt;order_currency;&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $currency;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function raw_price_filter($price, $currency = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency === false ) {&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency != get_option('woocommerce_currency')) {&nbsp;</div></li><li><div>          $price = $this-&gt;convert_price_amount( $price, $currency );&nbsp;</div></li><li><div>          $price = $this-&gt;apply_rounding_rules( $price, $currency );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_product_price_in_currency( $product_id, $currency = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !$currency ) {&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_filter( 'get_post_metadata', array( $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices, 'product_price_filter' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $manual_prices = $this-&gt;multi_currency-&gt;custom_prices-&gt;get_product_custom_prices( $product_id, $currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $manual_prices && !empty( $manual_prices[ '_price' ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $price = $manual_prices[ '_price' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $product = wc_get_product( $product_id );&nbsp;</div></li><li><div>          $price = $this-&gt;raw_price_filter( $product-&gt;get_price(), $currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'get_post_metadata', array( $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices, 'product_price_filter' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function product_price_filter($null, $object_id, $meta_key, $single) {&nbsp;</div></li><li><div>      global $sitepress;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      static $no_filter = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($no_filter) && in_array(get_post_type($object_id), array('product', 'product_variation'))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $price_keys = apply_filters( 'wcml_price_custom_fields_filtered', array(&nbsp;</div></li><li><div>              '_price', &nbsp;</div></li><li><div>              '_regular_price', &nbsp;</div></li><li><div>              '_sale_price', &nbsp;</div></li><li><div>              '_min_variation_price', &nbsp;</div></li><li><div>              '_max_variation_price', &nbsp;</div></li><li><div>              '_min_variation_regular_price', &nbsp;</div></li><li><div>              '_max_variation_regular_price', &nbsp;</div></li><li><div>              '_min_variation_sale_price', &nbsp;</div></li><li><div>              '_max_variation_sale_price'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(in_array($meta_key, $price_keys)) {&nbsp;</div></li><li><div>              $no_filter = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// exception for products migrated from before WCML 3.1 with independent prices</span>&nbsp;</div></li><li><div>              <span class="comment">// legacy prior 3.1</span>&nbsp;</div></li><li><div>              $original_object_id = apply_filters( 'translate_object_id', $object_id, get_post_type($object_id), false, $sitepress-&gt;get_default_language());&nbsp;</div></li><li><div>              $ccr = get_post_meta($original_object_id, '_custom_conversion_rate', true);&nbsp;</div></li><li><div>              if(in_array($meta_key, array('_price', '_regular_price', '_sale_price')) && !empty($ccr) && isset($ccr[$meta_key][$this-&gt;multi_currency-&gt;get_client_currency()])) {&nbsp;</div></li><li><div>                  $price_original = get_post_meta($original_object_id, $meta_key, $single);&nbsp;</div></li><li><div>                  $price = $price_original * $ccr[$meta_key][$this-&gt;multi_currency-&gt;get_client_currency()];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// normal filtering</span>&nbsp;</div></li><li><div>                  <span class="comment">// 1. manual prices</span>&nbsp;</div></li><li><div>                  $manual_prices = $this-&gt;multi_currency-&gt;custom_prices-&gt;get_product_custom_prices($object_id, $this-&gt;multi_currency-&gt;get_client_currency());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if($manual_prices && !empty($manual_prices[$meta_key])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $price = $manual_prices[$meta_key];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }else{&nbsp;</div></li><li><div>                      <span class="comment">// 2. automatic conversion</span>&nbsp;</div></li><li><div>                      $price = get_post_meta($object_id, $meta_key, $single);&nbsp;</div></li><li><div>                      $price = apply_filters('wcml_raw_price_amount', $price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $no_filter = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return !empty($price) ? $price : $null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function variation_prices_filter($null, $object_id, $meta_key, $single) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($meta_key) && get_post_type($object_id) == 'product_variation') {&nbsp;</div></li><li><div>          static $no_filter = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(empty($no_filter)) {&nbsp;</div></li><li><div>              $no_filter = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $variation_fields = get_post_meta($object_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $manual_prices = $this-&gt;multi_currency-&gt;custom_prices-&gt;get_product_custom_prices($object_id, $this-&gt;multi_currency-&gt;get_client_currency());&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach($variation_fields as $k =&gt; $v) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if(in_array($k, array('_price', '_regular_price', '_sale_price'))) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach($v as $j =&gt; $amount) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          if(isset($manual_prices[$k])) {&nbsp;</div></li><li><div>                              $variation_fields[$k][$j] = $manual_prices[$k];     <span class="comment">// manual price</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          }else{&nbsp;</div></li><li><div>                              $variation_fields[$k][$j] = apply_filters('wcml_raw_price_amount', $amount );   <span class="comment">// automatic conversion</span>&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $no_filter = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return !empty($variation_fields) ? $variation_fields : $null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function convert_price_amount($amount, $currency = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $currency ) ) {&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency != get_option('woocommerce_currency')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $exchange_rates = $this-&gt;multi_currency-&gt;get_exchange_rates();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($exchange_rates[$currency]) && is_numeric($amount)) {&nbsp;</div></li><li><div>              $amount = $amount * $exchange_rates[$currency];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// exception - currencies_without_cents</span></span>&nbsp;</div></li><li><div>              if(in_array($currency, $this-&gt;multi_currency-&gt;get_currencies_without_cents())) {&nbsp;</div></li><li><div>                  $amount = $this-&gt;round_up( $amount );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $amount = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $amount;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// convert back to default currency</span>&nbsp;</div></li><li><div>  public function unconvert_price_amount($amount, $currency = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($currency)) {&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($currency != get_option('woocommerce_currency')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $exchange_rates = $this-&gt;multi_currency-&gt;get_exchange_rates();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($exchange_rates[$currency]) && is_numeric($amount)) {&nbsp;</div></li><li><div>              $amount = $amount / $exchange_rates[$currency];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// exception - currencies_without_cents</span></span>&nbsp;</div></li><li><div>              if(in_array($currency, $this-&gt;multi_currency-&gt;get_currencies_without_cents())) {&nbsp;</div></li><li><div>                  $amount = $this-&gt;round_up( $amount );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $amount = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $amount;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function apply_rounding_rules($price, $currency = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( is_null($this-&gt;woocommerce_wpml) ) {&nbsp;</div></li><li><div>          global $woocommerce_wpml;&nbsp;</div></li><li><div>          $this-&gt;woocommerce_wpml = $woocommerce_wpml;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( !$currency ) {&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $currency_options = $this-&gt;woocommerce_wpml-&gt;settings['currency_options'][$currency];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency_options['rounding'] != 'disabled' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($currency_options['rounding_increment'] &gt; 1) {&nbsp;</div></li><li><div>              $price = $price / $currency_options['rounding_increment'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch($currency_options['rounding']) {&nbsp;</div></li><li><div>              case 'up':&nbsp;</div></li><li><div>                  $rounded_price = ceil($price);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'down':&nbsp;</div></li><li><div>                  $rounded_price = floor($price);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'nearest':&nbsp;</div></li><li><div>                  $rounded_price = $this-&gt;round_up( $price );&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($rounded_price &gt; 0) {&nbsp;</div></li><li><div>              $price = $rounded_price;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($currency_options['rounding_increment'] &gt; 1) {&nbsp;</div></li><li><div>              $price = $price * $currency_options['rounding_increment'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($currency_options['auto_subtract'] && $currency_options['auto_subtract'] &lt; $price) {&nbsp;</div></li><li><div>              $price = $price - $currency_options['auto_subtract'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Use configured number of decimals</span>&nbsp;</div></li><li><div>          $price = floor( $price * pow( 10, $currency_options['num_decimals']) + 0.0001 ) / pow( 10, $currency_options['num_decimals'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wcml_rounded_price', $price, $currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The PHP 5.2 compatible equivalent to &quot;round($amount, 0, PHP_ROUND_HALF_UP)&quot;</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $amount</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function round_up( $amount ) {&nbsp;</div></li><li><div>      if( $amount - floor( $amount ) &lt; 0.5 ) {&nbsp;</div></li><li><div>          $amount = floor( $amount );&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $amount = ceil( $amount );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $amount;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  * Converts the price from the default currency to the given currency and applies the format</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  public function formatted_price($amount, $currency = false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency === false ) {&nbsp;</div></li><li><div>          $currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $amount = $this-&gt;raw_price_filter($amount, $currency);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $currency_details = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currency_details_by_code( $currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $currency_details[ 'position' ] ) {&nbsp;</div></li><li><div>          case 'left' :&nbsp;</div></li><li><div>              $format = '%1$s%2$s';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'right' :&nbsp;</div></li><li><div>              $format = '%2$s%1$s';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'left_space' :&nbsp;</div></li><li><div>              $format = '%1$s&nbsp;%2$s';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'right_space' :&nbsp;</div></li><li><div>              $format = '%2$s&nbsp;%1$s';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wc_price_args = array(&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          'currency' =&gt; $currency, &nbsp;</div></li><li><div>          'decimal_separator' =&gt; $currency_details['decimal_sep'], &nbsp;</div></li><li><div>          'thousand_separator' =&gt; $currency_details['thousand_sep'], &nbsp;</div></li><li><div>          'decimals' =&gt; $currency_details['num_decimals'], &nbsp;</div></li><li><div>          'price_format' =&gt; $format, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = wc_price($amount, $wc_price_args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $price;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Exposed function</span>&nbsp;</div></li><li><div>  public function apply_currency_position( $price, $currency_code ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $currencies = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $currencies[$currency_code]['position'] ) ) {&nbsp;</div></li><li><div>          $position = $currencies[$currency_code]['position'];&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          remove_filter( 'option_woocommerce_currency_pos', array( $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices, 'filter_currency_position_option' ) );&nbsp;</div></li><li><div>          $position = get_option('woocommerce_currency_pos');&nbsp;</div></li><li><div>          add_filter( 'option_woocommerce_currency_pos', array( $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;prices, 'filter_currency_position_option' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch( $position ) {&nbsp;</div></li><li><div>          case 'left': $price = sprintf( '%s%s', get_woocommerce_currency_symbol( $currency_code ), $price ); break;&nbsp;</div></li><li><div>          case 'right': $price = sprintf( '%s%s', $price, get_woocommerce_currency_symbol( $currency_code ) ); break;&nbsp;</div></li><li><div>          case 'left_space': $price = sprintf( '%s %s', get_woocommerce_currency_symbol( $currency_code ), $price ); break;&nbsp;</div></li><li><div>          case 'right_space': $price = sprintf( '%s %s', $price, get_woocommerce_currency_symbol( $currency_code ) ); break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $price;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_price_woocommerce_paypal_args( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $args as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if( substr( $key, 0, 7 ) == 'amount_' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $currency_details = $this-&gt;woocommerce_wpml-&gt;multi_currency-&gt;get_currency_details_by_code( $args['currency_code'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $args[ $key ] =  number_format( $value, $currency_details['num_decimals'], '.', '' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function add_currency_to_variation_prices_hash($data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data['currency'] = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      $data['exchange_rates_hash'] = md5( json_encode( $this-&gt;multi_currency-&gt;get_exchange_rates() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_woocommerce_cart_contents_total( $cart_contents_total ) {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      remove_filter( 'woocommerce_cart_contents_total', array( $this, 'filter_woocommerce_cart_contents_total'), 100 );&nbsp;</div></li><li><div>      $woocommerce-&gt;cart-&gt;calculate_totals();&nbsp;</div></li><li><div>      $cart_contents_total = $woocommerce-&gt;cart-&gt;get_cart_total();&nbsp;</div></li><li><div>      add_filter( 'woocommerce_cart_contents_total', array( $this, 'filter_woocommerce_cart_contents_total'), 100 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cart_contents_total;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_woocommerce_cart_subtotal( $cart_subtotal, $compound, $obj ) {&nbsp;</div></li><li><div>      global $woocommerce;&nbsp;</div></li><li><div>      remove_filter( 'woocommerce_cart_subtotal', array( $this, 'filter_woocommerce_cart_subtotal'), 100, 3 );&nbsp;</div></li><li><div>      if( apply_filters( 'wcml_calculate_totals_exception', true ) ) {&nbsp;</div></li><li><div>          $woocommerce-&gt;cart-&gt;calculate_totals();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $cart_subtotal = $woocommerce-&gt;cart-&gt;get_cart_subtotal( $compound );&nbsp;</div></li><li><div>      add_filter( 'woocommerce_cart_subtotal', array( $this, 'filter_woocommerce_cart_subtotal'), 100, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cart_subtotal;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_price_filter_results( $matched_products, $min, $max ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      if( $current_currency != get_option('woocommerce_currency') ) {&nbsp;</div></li><li><div>          $filtered_min = $this-&gt;unconvert_price_amount( $min, $current_currency );&nbsp;</div></li><li><div>          $filtered_max = $this-&gt;unconvert_price_amount( $max, $current_currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $matched_products = $wpdb-&gt;get_results( $wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>              SELECT DISTINCT ID, post_parent, post_type FROM $wpdb-&gt;posts&nbsp;</div></li><li><div>              INNER JOIN $wpdb-&gt;postmeta ON ID = post_id&nbsp;</div></li><li><div>              WHERE post_type IN ( 'product', 'product_variation' ) AND post_status = 'publish' AND meta_key = %s AND meta_value BETWEEN %d AND %d&nbsp;</div></li><li><div>          &quot;, '_price', $filtered_min, $filtered_max ), OBJECT_K );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach( $matched_products as $key =&gt; $matched_product ) {&nbsp;</div></li><li><div>              $custom_price = get_post_meta( $matched_product-&gt;ID, '_price_'.$current_currency, true );&nbsp;</div></li><li><div>              if( $custom_price && ( $custom_price &lt; $min || $custom_price &gt; $max ) ) {&nbsp;</div></li><li><div>                  unset( $matched_products[$key] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $matched_products;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_price_filter_widget_amount( $amount ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      if( $current_currency != get_option('woocommerce_currency') ) {&nbsp;</div></li><li><div>          $amount = apply_filters('wcml_raw_price_amount', $amount );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $amount;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function check_admin_order_currency_code()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $actions = array('woocommerce_add_order_item', 'woocommerce_save_order_items', 'woocommerce_calc_line_taxes');&nbsp;</div></li><li><div>      $is_ajax_order_action =&nbsp;</div></li><li><div>          is_ajax() &&&nbsp;</div></li><li><div>          (&nbsp;</div></li><li><div>          (&nbsp;</div></li><li><div>              isset($_POST['action']) &&&nbsp;</div></li><li><div>              in_array($_POST['action'], $actions) ||&nbsp;</div></li><li><div>              (&nbsp;</div></li><li><div>                  isset($_GET['action']) &&&nbsp;</div></li><li><div>                  $_GET['action'] == 'woocommerce_json_search_products_and_variations'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_shop_order_new = $pagenow == 'post-new.php' && isset($_GET['post_type']) && $_GET['post_type'] == 'shop_order';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (($is_ajax_order_action || $is_shop_order_new) && isset($_COOKIE['_wcml_order_currency'])) {&nbsp;</div></li><li><div>          $currency_code = $_COOKIE['_wcml_order_currency'];&nbsp;</div></li><li><div>      } elseif (isset($_GET['post']) && get_post_type($_GET['post']) == 'shop_order') {&nbsp;</div></li><li><div>          $currency_code = get_post_meta($_GET['post'], '_order_currency', true);&nbsp;</div></li><li><div>      }elseif( isset( $_GET[ 'post_type' ] ) && $_GET[ 'post_type' ] == 'shop_order' && !is_null( $this-&gt;orders_list_currency ) ) {&nbsp;</div></li><li><div>          $currency_code = $this-&gt;orders_list_currency;&nbsp;</div></li><li><div>      }elseif( isset( $_GET[ 'page' ] ) && $_GET[ 'page' ] == 'wc-reports' && isset( $_COOKIE[ '_wcml_reports_currency' ] ) ) {&nbsp;</div></li><li><div>          $currency_code = $_COOKIE[ '_wcml_reports_currency' ];&nbsp;</div></li><li><div>      }elseif( isset( $_COOKIE[ '_wcml_dashboard_currency' ] ) && is_admin() && !defined( 'DOING_AJAX' ) && $pagenow == 'index.php' ) {&nbsp;</div></li><li><div>          $currency_code = $_COOKIE[ '_wcml_dashboard_currency' ];&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $currency_code = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wcml_filter_currency_position', $currency_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_admin_order_currency_code() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;check_admin_order_currency_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function save_order_currency_for_filter( $null, $object_id, $meta_key, $single ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(&nbsp;</div></li><li><div>          $meta_key == '_order_currency' &&&nbsp;</div></li><li><div>          isset( $_GET[ 'post_type' ] ) &&&nbsp;</div></li><li><div>          $_GET[ 'post_type' ] == 'shop_order' &&&nbsp;</div></li><li><div>          !isset( $_GET[ 'post' ] ) &&&nbsp;</div></li><li><div>          get_post_type( $object_id ) == 'shop_order'&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          remove_filter( 'get_post_metadata', array( $this, 'save_order_currency_for_filter' ), 10, 4);&nbsp;</div></li><li><div>          $this-&gt;orders_list_currency = get_post_meta( $object_id, $meta_key, true );&nbsp;</div></li><li><div>          add_filter( 'get_post_metadata', array( $this, 'save_order_currency_for_filter' ), 10, 4);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_currency_thousand_sep_option($value) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_currency = $this-&gt;multi_currency-&gt;get_default_currency();&nbsp;</div></li><li><div>      $currency_code = $this-&gt;check_admin_order_currency_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency_code !== $default_currency && isset( $this-&gt;multi_currency-&gt;currencies[$currency_code]['thousand_sep'] ) ) {&nbsp;</div></li><li><div>          $value = $this-&gt;multi_currency-&gt;currencies[$currency_code]['thousand_sep'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_currency_decimal_sep_option($value) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_currency = $this-&gt;multi_currency-&gt;get_default_currency();&nbsp;</div></li><li><div>      $currency_code = $this-&gt;check_admin_order_currency_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency_code !== $default_currency &&  isset( $this-&gt;multi_currency-&gt;currencies[$currency_code]['decimal_sep'] ) ) {&nbsp;</div></li><li><div>          $value = $this-&gt;multi_currency-&gt;currencies[$currency_code]['decimal_sep'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_currency_num_decimals_option($value) {&nbsp;</div></li><li><div>      <span class="comment">// no other way available (at the moment) to filter currency_num_decimals_option</span>&nbsp;</div></li><li><div>      $default_currency = $this-&gt;multi_currency-&gt;get_default_currency();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $db = debug_backtrace();&nbsp;</div></li><li><div>      if(&nbsp;</div></li><li><div>          isset( $db['8']['function'] ) &&  isset( $db['5']['function'] ) &&&nbsp;</div></li><li><div>          $db['8']['function'] == 'calculate_shipping_for_package' && $db['5']['function'] == 'add_rate'&nbsp;</div></li><li><div>              ||&nbsp;</div></li><li><div>          isset( $db['7']['function'] ) &&  isset( $db['4']['function'] ) &&&nbsp;</div></li><li><div>          $db['7']['function'] == 'calculate_shipping_for_package' && $db['4']['function'] == 'add_rate'&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>          $currency_code = $default_currency;&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $currency_code = $this-&gt;check_admin_order_currency_code();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency_code !== $default_currency && isset($this-&gt;multi_currency-&gt;currencies[$currency_code]['num_decimals']) ) {&nbsp;</div></li><li><div>          $value = $this-&gt;multi_currency-&gt;currencies[$currency_code]['num_decimals'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_currency_position_option($value) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_currency = $this-&gt;multi_currency-&gt;get_default_currency();&nbsp;</div></li><li><div>      $currency_code = $this-&gt;get_admin_order_currency_code();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $currency_code !== $default_currency &&&nbsp;</div></li><li><div>          isset($this-&gt;multi_currency-&gt;currencies[$currency_code]['position']) && get_option('woocommerce_currency') != $currency_code &&&nbsp;</div></li><li><div>          in_array($this-&gt;multi_currency-&gt;currencies[$currency_code]['position'], array('left', 'right', 'left_space', 'right_space'))) {&nbsp;</div></li><li><div>          $value = $this-&gt;multi_currency-&gt;currencies[$currency_code]['position'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_currency_num_decimals_in_cart( $cart ) {&nbsp;</div></li><li><div>      $cart-&gt;dp = wc_get_price_decimals();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Limitation: If the default currency is configured to display more decimals than the other currencies, </span>&nbsp;</div></li><li><div><span class="comment">   * the prices in the secondary currencies would be approximated to the number of decimals that they have more.</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  public function price_in_specific_currency( $return, $price, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($args['currency']) && $this-&gt;multi_currency-&gt;get_client_currency() != $args['currency']) {&nbsp;</div></li><li><div>          remove_filter( 'wc_price', array( $this, 'price_in_specific_currency' ), 10, 3 );&nbsp;</div></li><li><div>          $this-&gt;multi_currency-&gt;set_client_currency( $args['currency'] );&nbsp;</div></li><li><div>          $return = wc_price($price, $args);&nbsp;</div></li><li><div>          add_filter( 'wc_price', array( $this, 'price_in_specific_currency' ), 10, 3 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function filter_wc_price_args( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset($args['currency']) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($this-&gt;multi_currency-&gt;currencies[$args['currency']]['decimal_sep']) ) {&nbsp;</div></li><li><div>              $args['decimal_separator'] = $this-&gt;multi_currency-&gt;currencies[$args['currency']]['decimal_sep'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($this-&gt;multi_currency-&gt;currencies[$args['currency']]['thousand_sep']) ) {&nbsp;</div></li><li><div>              $args['thousand_separator'] = $this-&gt;multi_currency-&gt;currencies[$args['currency']]['thousand_sep'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($this-&gt;multi_currency-&gt;currencies[$args['currency']]['num_decimals']) ) {&nbsp;</div></li><li><div>              $args['decimals'] = $this-&gt;multi_currency-&gt;currencies[$args['currency']]['num_decimals'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( isset($this-&gt;multi_currency-&gt;currencies[$args['currency']]['position']) ) {&nbsp;</div></li><li><div>              $current_currency = $this-&gt;multi_currency-&gt;get_client_currency();&nbsp;</div></li><li><div>              $this-&gt;multi_currency-&gt;set_client_currency( $args['currency'] );&nbsp;</div></li><li><div>              $args['price_format'] = get_woocommerce_price_format();&nbsp;</div></li><li><div>              $this-&gt;multi_currency-&gt;set_client_currency( $current_currency ); <span class="comment">//restore</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce Multilingual</li><li><span></span>4.1.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>