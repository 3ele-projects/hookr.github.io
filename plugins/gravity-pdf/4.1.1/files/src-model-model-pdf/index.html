<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="4.1.1" data-slug="gravity-pdf" data-type="file" data-id="21026"><head xmlns="http://www.w3.org/1999/xhtml"><title> src-model-model-pdf | file | Gravity Pdf | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, gravity-pdf, 4.1.1" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=0f01bc266f296f7953b1e1b35e355fa0' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/src-model-model-pdf/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fsrc-model-model-pdf%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fsrc-model-model-pdf%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-gravity-pdf-4.1.1-file-src-model-model-pdf","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="src-model-model-pdf" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-pdf." href="http://hookr.io/plugins/gravity-pdf/" class="plugin"><span property="name">gravity-pdf</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 4.1.1." href="http://hookr.io/plugins/gravity-pdf/4.1.1/" class="H_VERSION"><span property="name">4.1.1</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/gravity-pdf/4.1.1/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">src-model-model-pdf</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="696"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/all/" title="All">All <span class="count badge">696</span></a></li><li class="" data-id="new" data-count="2"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/new/" title="New">New <span class="count badge">2</span></a></li><li class="" data-id="hooks" data-count="177"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/hooks/" title="Hooks">Hooks <span class="count badge">177</span></a></li><li class="" data-id="action" data-count="15"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/actions/" title="Actions">Actions <span class="count badge">15</span></a></li><li class="" data-id="filter" data-count="162"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/filters/" title="Filters">Filters <span class="count badge">162</span></a></li><li class="" data-id="class" data-count="411"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/classes/" title="Classes">Classes <span class="count badge">411</span></a></li><li class="" data-id="constant" data-count="64"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/constants/" title="Constants">Constants <span class="count badge">64</span></a></li><li class="" data-id="function" data-count="43"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/functions/" title="Functions">Functions <span class="count badge">43</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/gravity-pdf/4.1.1/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/src/model/Model_PDF.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>namespace GFPDF\Model;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Abstract_Model;&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_PDF;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Abstract_Fields;&nbsp;</div></li><li><div>use GFPDF\Helper\Fields\Field_Product;&nbsp;</div></li><li><div>use GFPDF\Helper\Fields\Field_Default;&nbsp;</div></li><li><div>use GFPDF\Helper\Fields\Field_Products;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Abstract_Form;&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Abstract_Options;&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Data;&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Misc;&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Notices;&nbsp;</div></li><li><div>use GFPDF\Helper\Helper_Templates;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use Psr\Log\LoggerInterface;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use GFFormsModel;&nbsp;</div></li><li><div>use GFCommon;&nbsp;</div></li><li><div>use GF_Field;&nbsp;</div></li><li><div>use GFQuiz;&nbsp;</div></li><li><div>use GFSurvey;&nbsp;</div></li><li><div>use GFPolls;&nbsp;</div></li><li><div>use GFResults;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use WP_Error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>use Exception;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * PDF Display Model, including the $form_data array</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package     Gravity PDF</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright   Copyright (c) 2016, Blue Liquid Designs</span>&nbsp;</div></li><li><div><span class="comment"> * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License</span>&nbsp;</div></li><li><div><span class="comment"> * @since       4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Exit if accessed directly */</span>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) {&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  This file is part of Gravity PDF.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  Gravity PDF * Copyright (C) 2016, Blue Liquid Designs</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  This program is free software; you can redistribute it and/or modify</span>&nbsp;</div></li><li><div><span class="comment">  it under the terms of the GNU General Public License as published by</span>&nbsp;</div></li><li><div><span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>&nbsp;</div></li><li><div><span class="comment">  (at your option) any later version.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  This program is distributed in the hope that it will be useful, </span>&nbsp;</div></li><li><div><span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>&nbsp;</div></li><li><div><span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>&nbsp;</div></li><li><div><span class="comment">  GNU General Public License for more details.</span>&nbsp;</div></li><li><div><span class="comment">&nbsp;</span>&nbsp;</div></li><li><div><span class="comment">  You should have received a copy of the GNU General Public License</span>&nbsp;</div></li><li><div><span class="comment">  along with this program; if not, write to the Free Software</span>&nbsp;</div></li><li><div><span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Model_PDF</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Handles all the PDF display logic</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Model_PDF extends Helper_Abstract_Model {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds the abstracted Gravity Forms API specific to Gravity PDF</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \GFPDF\Helper\Helper_Form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $gform;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds our log class</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \Monolog\Logger|LoggerInterface</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $log;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds our Helper_Abstract_Options / Helper_Options_Fields object</span>&nbsp;</div></li><li><div><span class="comment">   * Makes it easy to access global PDF settings and individual form PDF settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \GFPDF\Helper\Helper_Options_Fields</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds our Helper_Data object</span>&nbsp;</div></li><li><div><span class="comment">   * which we can autoload with any data needed</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \GFPDF\Helper\Helper_Data</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds our Helper_Misc object</span>&nbsp;</div></li><li><div><span class="comment">   * Makes it easy to access common methods throughout the plugin</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \GFPDF\Helper\Helper_Misc</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $misc;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds our Helper_Notices object</span>&nbsp;</div></li><li><div><span class="comment">   * which we can use to queue up admin messages for the user</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \GFPDF\Helper\Helper_Notices</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $notices;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Holds our Helper_Templates object</span>&nbsp;</div></li><li><div><span class="comment">   * used to ease access to our PDF templates</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var \GFPDF\Helper\Helper_Templates</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected $templates;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Setup our view with the needed data and classes</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_Abstract_Form    $gform   Our abstracted Gravity Forms helper functions</span>&nbsp;</div></li><li><div><span class="comment">   * @param \Monolog\Logger|LoggerInterface       $log     Our logger class</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_Abstract_Options $options Our options class which allows us to access any settings</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_Data             $data    Our plugin data store</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_Misc             $misc    Our miscellaneous class</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_Notices          $notices Our notice class used to queue admin messages and errors</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_Templates        $templates</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct( Helper_Abstract_Form $gform, LoggerInterface $log, Helper_Abstract_Options $options, Helper_Data $data, Helper_Misc $misc, Helper_Notices $notices, Helper_Templates $templates ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Assign our internal variables */</span>&nbsp;</div></li><li><div>      $this-&gt;gform = $gform;&nbsp;</div></li><li><div>      $this-&gt;log = $log;&nbsp;</div></li><li><div>      $this-&gt;options = $options;&nbsp;</div></li><li><div>      $this-&gt;data = $data;&nbsp;</div></li><li><div>      $this-&gt;misc = $misc;&nbsp;</div></li><li><div>      $this-&gt;notices = $notices;&nbsp;</div></li><li><div>      $this-&gt;templates = $templates;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Our Middleware used to handle the authentication process</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string  $pid    The Gravity Form PDF Settings ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  integer $lid    The Gravity Form Entry ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string  $action Whether the PDF should be viewed or downloaded</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return WP_Error</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_pdf( $pid, $lid, $action = 'view' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Check if we have a valid Gravity Form Entry and PDF Settings ID</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $entry = $this-&gt;gform-&gt;get_entry( $lid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** not a valid entry */</span>&nbsp;</div></li><li><div>      if ( is_wp_error( $entry ) ) {&nbsp;</div></li><li><div>          $this-&gt;log-&gt;addError( 'Invalid Entry.', [&nbsp;</div></li><li><div>              'entry' =&gt; $entry, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $entry; <span class="comment"><span class="comment">/** return error */</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings = $this-&gt;options-&gt;get_pdf( $entry['form_id'], $pid );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Not valid settings */</span>&nbsp;</div></li><li><div>      if ( is_wp_error( $settings ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log-&gt;addError( 'Invalid PDF Settings.', [&nbsp;</div></li><li><div>              'entry' =&gt; $entry, &nbsp;</div></li><li><div>              'WP_Error_Message' =&gt; $settings-&gt;get_error_message(), &nbsp;</div></li><li><div>              'WP_Error_Code' =&gt; $settings-&gt;get_error_code(), &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $settings; <span class="comment"><span class="comment">/** return error */</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Add our download setting */</span>&nbsp;</div></li><li><div>      $settings['pdf_action'] = $action;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Our middleware authenticator</span>&nbsp;</div></li><li><div><span class="comment">       * Allow users to tap into our middleware and add or remove additional authentication layers</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * Default middleware includes 'middle_public_access', 'middle_active', 'middle_conditional', 'middle_owner_restriction', 'middle_logged_out_timeout', 'middle_auth_logged_out_user', 'middle_user_capability'</span>&nbsp;</div></li><li><div><span class="comment">       * If WP_Error is returned the PDF won't be parsed</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * See https://gravitypdf.com/documentation/v4/gfpdf_pdf_middleware/ for more details about this filter</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $middleware = apply_filters( 'gfpdf_pdf_middleware', false, $entry, $settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Throw error */</span>&nbsp;</div></li><li><div>      if ( is_wp_error( $middleware ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log-&gt;addError( 'PDF Authentication Failure.', [&nbsp;</div></li><li><div>              'entry' =&gt; $entry, &nbsp;</div></li><li><div>              'settings' =&gt; $settings, &nbsp;</div></li><li><div>              'WP_Error_Message' =&gt; $middleware-&gt;get_error_message(), &nbsp;</div></li><li><div>              'WP_Error_Code' =&gt; $middleware-&gt;get_error_code(), &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $middleware;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Add backwards compatibility support for certain settings */</span>&nbsp;</div></li><li><div>      $settings = $this-&gt;apply_backwards_compatibility_filters( $settings, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** Ensure Gravity Forms depedancy loaded */</span></span>&nbsp;</div></li><li><div>      $this-&gt;misc-&gt;maybe_load_gf_entry_detail_class();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** If we are here we can generate our PDF */</span>&nbsp;</div></li><li><div>      $controller = $this-&gt;getController();&nbsp;</div></li><li><div>      $controller-&gt;view-&gt;generate_pdf( $entry, $settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Apply filters to particular settings to maintain backwards compatibility</span>&nbsp;</div></li><li><div><span class="comment">   * Note: If you want to modify the $settings array you should use the new &quot;gfpdf_pdf_config&quot; filter instead</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $settings The PDF settings array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array           The $settings array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function apply_backwards_compatibility_filters( $settings, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $settings['filename'] = $this-&gt;misc-&gt;remove_extension_from_string( apply_filters( 'gfpdfe_pdf_name', $settings['filename'], $form, $entry ) );&nbsp;</div></li><li><div>      $settings['template'] = $this-&gt;misc-&gt;remove_extension_from_string( apply_filters( 'gfpdfe_template', $settings['template'], $form, $entry ), '.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['orientation'] ) ) {&nbsp;</div></li><li><div>          $settings['orientation'] = apply_filters( 'gfpdf_orientation', $settings['orientation'], $form, $entry );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['security'] ) ) {&nbsp;</div></li><li><div>          $settings['security'] = $this-&gt;misc-&gt;update_deprecated_config( apply_filters( 'gfpdf_security', $settings['security'], $form, $entry ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['privileges'] ) ) {&nbsp;</div></li><li><div>          $settings['privileges'] = apply_filters( 'gfpdf_privilages', $settings['privileges'], $form, $entry );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['password'] ) ) {&nbsp;</div></li><li><div>          $settings['password'] = apply_filters( 'gfpdf_password', $settings['password'], $form, $entry );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['master_password'] ) ) {&nbsp;</div></li><li><div>          $settings['master_password'] = apply_filters( 'gfpdf_master_password', $settings['master_password'], $form, $entry );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['rtl'] ) ) {&nbsp;</div></li><li><div>          $settings['rtl'] = $this-&gt;misc-&gt;update_deprecated_config( apply_filters( 'gfpdf_rtl', $settings['rtl'], $form, $entry ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the current PDF trying to be viewed has public access enabled</span>&nbsp;</div></li><li><div><span class="comment">   * If it does, we'll remove some of our middleware filters to allow this feature</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_public_access( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['public_access'] ) && 'Yes' === $settings['public_access'] ) {&nbsp;</div></li><li><div>          remove_filter( 'gfpdf_pdf_middleware', [ $this, 'middle_owner_restriction' ], 40 );&nbsp;</div></li><li><div>          remove_filter( 'gfpdf_pdf_middleware', [ $this, 'middle_logged_out_timeout' ], 50 );&nbsp;</div></li><li><div>          remove_filter( 'gfpdf_pdf_middleware', [ $this, 'middle_auth_logged_out_user' ], 60 );&nbsp;</div></li><li><div>          remove_filter( 'gfpdf_pdf_middleware', [ $this, 'middle_user_capability' ], 70 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the current PDF trying to be viewed is active</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_active( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $action ) ) {&nbsp;</div></li><li><div>          if ( $settings['active'] !== true ) {&nbsp;</div></li><li><div>              return new WP_Error( 'inactive', esc_html__( 'The PDF configuration is not currently active.', 'gravity-forms-pdf-extended' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the current PDF trying to be viewed has conditional logic which passes</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_conditional( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $action ) ) {&nbsp;</div></li><li><div>          if ( isset( $settings['conditionalLogic'] ) && ! $this-&gt;misc-&gt;evaluate_conditional_logic( $settings['conditionalLogic'], $entry ) ) {&nbsp;</div></li><li><div>              return new WP_Error( 'conditional_logic', esc_html__( 'PDF conditional logic requirements have not been met.', 'gravity-forms-pdf-extended' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the current user attempting to access is the PDF owner</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array  $entry The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $type  The authentication type we should use</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_current_pdf_owner( $entry, $type = 'all' ) {&nbsp;</div></li><li><div>      $owner = false;&nbsp;</div></li><li><div>      <span class="comment">/** check if the user is logged in and the entry is assigned to them */</span>&nbsp;</div></li><li><div>      if ( $type === 'all' || $type === 'logged_in' ) {&nbsp;</div></li><li><div>          if ( is_user_logged_in() && (int) $entry['created_by'] === get_current_user_id() ) {&nbsp;</div></li><li><div>              $owner = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $type === 'all' || $type === 'logged_out' ) {&nbsp;</div></li><li><div>          $user_ip = trim( GFFormsModel::get_ip() );&nbsp;</div></li><li><div>          if ( $entry['ip'] == $user_ip && $entry['ip'] !== '127.0.0.1' && strlen( $user_ip ) !== 0 ) { <span class="comment">/** check if the user IP matches the entry IP */</span>&nbsp;</div></li><li><div>              $owner = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $owner;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check the &quot;Restrict Logged Out User&quot; global setting and validate it against the current user</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_owner_restriction( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** ensure another middleware filter hasn't already done validation */</span></span>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $action ) ) {&nbsp;</div></li><li><div>          <span class="comment">/** get the setting */</span>&nbsp;</div></li><li><div>          $owner_restriction = ( isset( $settings['restrict_owner'] ) ) ? $settings['restrict_owner'] : 'No';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $owner_restriction === 'Yes' && ! is_user_logged_in() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;log-&gt;addNotice( 'Redirecting to Login.', [&nbsp;</div></li><li><div>                  'entry' =&gt; $entry, &nbsp;</div></li><li><div>                  'settings' =&gt; $settings, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** prompt user to login */</span>&nbsp;</div></li><li><div>              auth_redirect();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check the &quot;Logged Out Timeout&quot; global setting and validate it against the current user</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_logged_out_timeout( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">/** ensure another middleware filter hasn't already done validation */</span></span>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $action ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** only check if PDF timed out if our logged out restriction is not 'Yes' and the user is not logged in */</span>&nbsp;</div></li><li><div>          if ( ! is_user_logged_in() && $this-&gt;is_current_pdf_owner( $entry, 'logged_out' ) === true ) {&nbsp;</div></li><li><div>              <span class="comment">/** get the global PDF settings */</span>&nbsp;</div></li><li><div>              $timeout = (int) $this-&gt;options-&gt;get_option( 'logged_out_timeout', '30' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** if '0' there is no timeout, or if the logged out restrictions are enabled we'll ignore this */</span>&nbsp;</div></li><li><div>              if ( $timeout !== 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $timeout_stamp = 60 * $timeout; <span class="comment">/** 60 seconds multiplied by number of minutes */</span>&nbsp;</div></li><li><div>                  $entry_created = strtotime( $entry['date_created'] ); <span class="comment">/** get entry timestamp */</span>&nbsp;</div></li><li><div>                  $timeout_expires = $entry_created + $timeout_stamp; <span class="comment">/** get the timeout expiry based on the entry created time */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/** compare our two timestamps and throw error if outside the timeout */</span>&nbsp;</div></li><li><div>                  if ( time() &gt; $timeout_expires ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">/** if there is no user account assigned to this entry throw error */</span>&nbsp;</div></li><li><div>                      if ( empty( $entry['created_by'] ) ) {&nbsp;</div></li><li><div>                          return new WP_Error( 'timeout_expired', esc_html__( 'Your PDF is no longer accessible.', 'gravity-forms-pdf-extended' ) );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $this-&gt;log-&gt;addNotice( 'Redirecting to Login.', [&nbsp;</div></li><li><div>                              'entry' =&gt; $entry, &nbsp;</div></li><li><div>                              'settings' =&gt; $settings, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">/** prompt to login */</span>&nbsp;</div></li><li><div>                          auth_redirect();&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the user is logged out and authenticate as needed</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_auth_logged_out_user( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $action ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** check if the user is not the current entry owner */</span>&nbsp;</div></li><li><div>          if ( ! is_user_logged_in() && $this-&gt;is_current_pdf_owner( $entry, 'logged_out' ) === false ) {&nbsp;</div></li><li><div>              <span class="comment">/** check if there is actually a user who owns entry */</span>&nbsp;</div></li><li><div>              if ( ! empty( $entry['created_by'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $this-&gt;log-&gt;addNotice( 'Redirecting to Login.', [&nbsp;</div></li><li><div>                      'entry' =&gt; $entry, &nbsp;</div></li><li><div>                      'settings' =&gt; $settings, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/** prompt user to login to get access */</span>&nbsp;</div></li><li><div>                  auth_redirect();&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">/** there's no returning, throw generic error */</span>&nbsp;</div></li><li><div>                  return new WP_Error( 'error' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check the &quot;User Restriction&quot; global setting and validate it against the current user</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean|object $action</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $entry    The Gravity Forms Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array          $settings The Gravity Form PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean|object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function middle_user_capability( $action, $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $action ) ) {&nbsp;</div></li><li><div>          <span class="comment">/** check if the user is logged in but is not the current owner */</span>&nbsp;</div></li><li><div>          if ( is_user_logged_in() &&&nbsp;</div></li><li><div>               ( ( $this-&gt;options-&gt;get_option( 'limit_to_admin', 'No' ) == 'Yes' ) || ( $this-&gt;is_current_pdf_owner( $entry, 'logged_in' ) === false ) )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Handle permissions checks */</span>&nbsp;</div></li><li><div>              $admin_permissions = $this-&gt;options-&gt;get_option( 'admin_capabilities', [ 'gravityforms_view_entries' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** loop through permissions and check if the current user has any of those capabilities */</span>&nbsp;</div></li><li><div>              $access = false;&nbsp;</div></li><li><div>              foreach ( $admin_permissions as $permission ) {&nbsp;</div></li><li><div>                  if ( $this-&gt;gform-&gt;has_capability( $permission ) ) {&nbsp;</div></li><li><div>                      $access = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** throw error if no access granted */</span>&nbsp;</div></li><li><div>              if ( ! $access ) {&nbsp;</div></li><li><div>                  return new WP_Error( 'access_denied', esc_html__( 'You do not have access to view this PDF.', 'gravity-forms-pdf-extended' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display PDF on Gravity Form entry list page</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  integer $form_id  Gravity Form ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  integer $field_id Current field ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  mixed   $value    Current value of field</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array   $entry    Entry Information</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function view_pdf_entry_list( $form_id, $field_id, $value, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $controller = $this-&gt;getController();&nbsp;</div></li><li><div>      $pdf_list = $this-&gt;get_pdf_display_list( $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log-&gt;addNotice( 'Display PDF Entry List.', [&nbsp;</div></li><li><div>          'pdfs' =&gt; $pdf_list, &nbsp;</div></li><li><div>          'entry' =&gt; $entry, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $pdf_list ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( sizeof( $pdf_list ) &gt; 1 ) {&nbsp;</div></li><li><div>              $args = [&nbsp;</div></li><li><div>                  'pdfs' =&gt; $pdf_list, &nbsp;</div></li><li><div>                  'view' =&gt; strtolower( $this-&gt;options-&gt;get_option( 'default_action' ) ), &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $controller-&gt;view-&gt;entry_list_pdf_multiple( $args );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">/** Only one PDF for this form so display a simple 'View PDF' link */</span>&nbsp;</div></li><li><div>              $args = [&nbsp;</div></li><li><div>                  'pdf' =&gt; array_shift( $pdf_list ), &nbsp;</div></li><li><div>                  'view' =&gt; strtolower( $this-&gt;options-&gt;get_option( 'default_action' ) ), &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $controller-&gt;view-&gt;entry_list_pdf_single( $args );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the PDF links on the entry detailed section of the admin area</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  integer $form_id Gravity Form ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array   $entry   The entry information</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function view_pdf_entry_detail( $form_id, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $controller = $this-&gt;getController();&nbsp;</div></li><li><div>      $pdf_list = $this-&gt;get_pdf_display_list( $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log-&gt;addNotice( 'Display PDF Entry Detail List.', [&nbsp;</div></li><li><div>          'pdfs' =&gt; $pdf_list, &nbsp;</div></li><li><div>          'entry' =&gt; $entry, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $pdf_list ) ) {&nbsp;</div></li><li><div>          $args = [&nbsp;</div></li><li><div>              'pdfs' =&gt; $pdf_list, &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>          $controller-&gt;view-&gt;entry_detailed_pdf( $args );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a preformatted list of active PDFs with name and URL</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_pdf_display_list( $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Stores our formatted PDFs */</span>&nbsp;</div></li><li><div>      $args = [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Check if we have any PDFs */</span>&nbsp;</div></li><li><div>      $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>      $pdfs = ( isset( $form['gfpdf_form_settings'] ) ) ? $this-&gt;get_active_pdfs( $form['gfpdf_form_settings'], $entry ) : [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $pdfs ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $pdfs as $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $args[] = [&nbsp;</div></li><li><div>                  'name' =&gt; $this-&gt;get_pdf_name( $settings, $entry ), &nbsp;</div></li><li><div>                  'view' =&gt; $this-&gt;get_pdf_url( $settings['id'], $entry['id'], false ), &nbsp;</div></li><li><div>                  'download' =&gt; $this-&gt;get_pdf_url( $settings['id'], $entry['id'], true ), &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate the PDF Name</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $settings The PDF Form Settings</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry    The Gravity Form entry details</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string      The PDF Name</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_pdf_name( $settings, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>      $name = $this-&gt;gform-&gt;process_tags( $settings['filename'], $form, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Decode HTML entities */</span>&nbsp;</div></li><li><div>      $name = wp_specialchars_decode( $name, ENT_QUOTES );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Add filter to modify PDF name</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * See https://gravitypdf.com/documentation/v4/gfpdf_pdf_filename/ for more details about this filter</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $name = apply_filters( 'gfpdf_pdf_filename', $name, $form, $entry, $settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Backwards compatible filter */</span>&nbsp;</div></li><li><div>      $name = apply_filters( 'gfpdfe_pdf_filename', $name, $form, $entry, $settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Remove any characters that cannot be present in a filename */</span>&nbsp;</div></li><li><div>      $name = $this-&gt;misc-&gt;strip_invalid_characters( $name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Create a PDF Link based on the current PDF settings and entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  integer $pid      The PDF Form Settings ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  integer $id       The Gravity Form entry ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean $download Whether the PDF should be downloaded or not</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean $print    Whether we should mark the PDF to be printed</span>&nbsp;</div></li><li><div><span class="comment">   * @param  boolean $esc      Whether to escape the URL or not</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string       Direct link to the PDF</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_pdf_url( $pid, $id, $download = false, $print = false, $esc = true ) {&nbsp;</div></li><li><div>      global $wp_rewrite;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Check if permalinks are enabled, otherwise fall back to our ugly link structure for 4.0 (not the same as our v3 links) */</span>&nbsp;</div></li><li><div>      if ( $wp_rewrite-&gt;using_permalinks() ) {&nbsp;</div></li><li><div>          $url = home_url() . '/' . $wp_rewrite-&gt;root; <span class="comment">/** Handle &quot;almost pretty&quot; permalinks - fix for IIS servers without modrewrite  */</span>&nbsp;</div></li><li><div>          $url .= 'pdf/' . $pid . '/' . $id . '/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $download ) {&nbsp;</div></li><li><div>              $url .= 'download/';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $print ) {&nbsp;</div></li><li><div>              $url .= '?print=1';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $url = home_url() . '/?gpdf=1&pid=' . $pid . '&lid=' . $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $download ) {&nbsp;</div></li><li><div>              $url .= '&action=download';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $print ) {&nbsp;</div></li><li><div>              $url .= '&print=1';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $esc ) {&nbsp;</div></li><li><div>          $url = esc_url( $url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $url;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter out inactive PDFs and those who don't meet the conditional logic</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $pdfs  The PDF settings array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The current entry information</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array       The filtered PDFs</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_active_pdfs( $pdfs, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $filtered = [];&nbsp;</div></li><li><div>      $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $pdfs as $pdf ) {&nbsp;</div></li><li><div>          if ( $pdf['active'] && ( empty( $pdf['conditionalLogic'] ) || $this-&gt;misc-&gt;evaluate_conditional_logic( $pdf['conditionalLogic'], $entry ) ) ) {&nbsp;</div></li><li><div>              $filtered[ $pdf['id'] ] = $pdf;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $filtered;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate and save PDF to disk</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_PDF $pdf The Helper_PDF object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_and_save_pdf( Helper_PDF $pdf ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Check that the PDF hasn't already been created this session */</span>&nbsp;</div></li><li><div>      if ( ! $this-&gt;does_pdf_exist( $pdf ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** Ensure Gravity Forms depedancy loaded */</span></span>&nbsp;</div></li><li><div>          $this-&gt;misc-&gt;maybe_load_gf_entry_detail_class();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Enable Multicurrency support */</span>&nbsp;</div></li><li><div>          $this-&gt;misc-&gt;maybe_add_multicurrency_support();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Get required parameters */</span>&nbsp;</div></li><li><div>          $entry = $pdf-&gt;get_entry();&nbsp;</div></li><li><div>          $settings = $pdf-&gt;get_settings();&nbsp;</div></li><li><div>          $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = $this-&gt;templates-&gt;get_template_arguments(&nbsp;</div></li><li><div>              $form, &nbsp;</div></li><li><div>              $this-&gt;misc-&gt;get_fields_sorted_by_id( $form['id'] ), &nbsp;</div></li><li><div>              $entry, &nbsp;</div></li><li><div>              $this-&gt;get_form_data( $entry ), &nbsp;</div></li><li><div>              $settings, &nbsp;</div></li><li><div>              $this-&gt;templates-&gt;get_config_class( $settings['template'] ), &nbsp;</div></li><li><div>              $this-&gt;misc-&gt;get_legacy_ids( $entry['id'], $settings )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Add backwards compatibility support */</span>&nbsp;</div></li><li><div>          $GLOBALS['wp']-&gt;query_vars['pid'] = $settings['id'];&nbsp;</div></li><li><div>          $GLOBALS['wp']-&gt;query_vars['lid'] = $entry['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          try {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Initialise our PDF helper class */</span>&nbsp;</div></li><li><div>              $pdf-&gt;init();&nbsp;</div></li><li><div>              $pdf-&gt;set_template();&nbsp;</div></li><li><div>              $pdf-&gt;set_output_type( 'save' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Increment our rudimentary PDF counter */</span>&nbsp;</div></li><li><div>              $this-&gt;options-&gt;increment_pdf_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Add Backwards compatibility support for our v3 Tier 2 Add-on */</span>&nbsp;</div></li><li><div>              if ( isset( $settings['advanced_template'] ) && strtolower( $settings['advanced_template'] ) == 'yes' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/** Check if we should process this document using our legacy system */</span>&nbsp;</div></li><li><div>                  if ( $this-&gt;handle_legacy_tier_2_processing( $pdf, $entry, $settings, $args ) ) {&nbsp;</div></li><li><div>                      return true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Render the PDF template HTML */</span>&nbsp;</div></li><li><div>              $pdf-&gt;render_html( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Generate and save the PDF */</span>&nbsp;</div></li><li><div>              $pdf-&gt;save_pdf( $pdf-&gt;generate() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          } catch ( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;log-&gt;addError( 'PDF Generation Error', [&nbsp;</div></li><li><div>                  'pdf' =&gt; $pdf, &nbsp;</div></li><li><div>                  'exception' =&gt; $e-&gt;getMessage(), &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Handles the loading and running of our legacy Tier 2 PDF templates</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param \GFPDF\Helper\Helper_PDF $pdf      The Helper_PDF object</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                    $entry    The Gravity Forms raw entry data</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                    $settings The Gravity PDF settings</span>&nbsp;</div></li><li><div><span class="comment">   * @param array                    $args     The data that should be passed directly to a PDF template</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function handle_legacy_tier_2_processing( Helper_PDF $pdf, $entry, $settings, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $prevent_main_pdf_loader = apply_filters( 'gfpdfe_pre_load_template', &nbsp;</div></li><li><div>          $form['id'], &nbsp;</div></li><li><div>          $entry['id'], &nbsp;</div></li><li><div>          basename( $pdf-&gt;get_template_path() ), &nbsp;</div></li><li><div>          $form['id'] . $entry['id'], &nbsp;</div></li><li><div>          $this-&gt;misc-&gt;backwards_compat_output( $pdf-&gt;get_output_type() ), &nbsp;</div></li><li><div>          $pdf-&gt;get_filename(), &nbsp;</div></li><li><div>          $this-&gt;misc-&gt;backwards_compat_conversion( $settings, $form, $entry ), &nbsp;</div></li><li><div>          $args&nbsp;</div></li><li><div> ); <span class="comment">/** Backwards Compatibility */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return ( $prevent_main_pdf_loader === true ) ? true : false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate and save the PDF to disk</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry    The Gravity Form entry array (usually passed in as a filter or pulled using GFAPI::get_entry( $id ) )</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $settings The PDF configuration settings for the particular entry / form being processed</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string|WP_Error           Return the full path to the PDF, or a WP_Error on failure</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function generate_and_save_pdf( $entry, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdf_generator = new Helper_PDF( $entry, $settings, $this-&gt;gform, $this-&gt;data, $this-&gt;misc, $this-&gt;templates );&nbsp;</div></li><li><div>      $pdf_generator-&gt;set_filename( $this-&gt;get_pdf_name( $settings, $entry ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;process_and_save_pdf( $pdf_generator ) ) {&nbsp;</div></li><li><div>          $pdf_path = $pdf_generator-&gt;get_full_pdf_path();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_file( $pdf_path ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Add appropriate filters so developers can access the PDF when it is generated */</span>&nbsp;</div></li><li><div>              $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>              $filename = basename( $pdf_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              do_action( 'gfpdf_post_pdf_save', $form['id'], $entry['id'], $settings, $pdf_path ); <span class="comment">/** Backwards compatibility */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** See https://gravitypdf.com/documentation/v4/gfpdf_post_save_pdf/ for more details about these actions */</span>&nbsp;</div></li><li><div>              do_action( 'gfpdf_post_save_pdf', $pdf_path, $filename, $settings, $entry, $form );&nbsp;</div></li><li><div>              do_action( 'gfpdf_post_save_pdf_' . $form['id'], $pdf_path, $filename, $settings, $entry, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              return $pdf_path;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return new WP_Error( 'pdf_generation_failure', esc_html__( 'The PDF could not be saved.', 'gravity-forms-pdf-extended' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the form has any PDFs, generate them and attach to the notification</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $notifications Gravity Forms Notification Array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function notifications( $notifications, $form, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Ensure our entry is stored in the database by checking it has an ID</span>&nbsp;</div></li><li><div><span class="comment">       * This resolves any issues with the &quot;Save and Continue&quot; feature</span>&nbsp;</div></li><li><div><span class="comment">       * See https://github.com/GravityPDF/gravity-pdf/issues/360</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( null === $entry['id'] ) {&nbsp;</div></li><li><div>          return $notifications;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdfs = ( isset( $form['gfpdf_form_settings'] ) ) ? $this-&gt;get_active_pdfs( $form['gfpdf_form_settings'], $entry ) : [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( sizeof( $pdfs ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Ensure our notification has an array setup for the attachments key */</span>&nbsp;</div></li><li><div>          $notifications['attachments'] = ( isset( $notifications['attachments'] ) ) ? $notifications['attachments'] : [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Loop through each PDF config and generate */</span>&nbsp;</div></li><li><div>          foreach ( $pdfs as $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Reset the variables each loop */</span>&nbsp;</div></li><li><div>              $filename = $tier_2_filename = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;maybe_attach_to_notification( $notifications, $settings ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/** Generate our PDF */</span>&nbsp;</div></li><li><div>                  $filename = $this-&gt;generate_and_save_pdf( $entry, $settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! is_wp_error( $filename ) ) {&nbsp;</div></li><li><div>                      $notifications['attachments'][] = $filename;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log-&gt;addNotice( 'Gravity Forms Attachments', [&nbsp;</div></li><li><div>              'attachments' =&gt; $notifications['attachments'], &nbsp;</div></li><li><div>              'notification' =&gt; $notifications, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $notifications;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determine if the PDF should be attached to the current notification</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $notification The Gravity Form Notification currently being processed</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $settings     The current Gravity PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_attach_to_notification( $notification, $settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $settings['notification'] ) && is_array( $settings['notification'] ) ) {&nbsp;</div></li><li><div>          if ( in_array( $notification['id'], $settings['notification'] ) ) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determine if the PDF should be saved to disk</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $settings The current Gravity PDF Settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_always_save_pdf( $settings ) {&nbsp;</div></li><li><div>      if ( isset( $settings['save'] ) && strtolower( $settings['save'] ) == 'yes' ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates a PDF on every submission, except when the PDF is already created during the notification hook</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The GF Entry Details</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form  The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_save_pdf( $entry, $form ) {&nbsp;</div></li><li><div>      $pdfs = ( isset( $form['gfpdf_form_settings'] ) ) ? $this-&gt;get_active_pdfs( $form['gfpdf_form_settings'], $entry ) : [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( sizeof( $pdfs ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Loop through each PDF config */</span>&nbsp;</div></li><li><div>          foreach ( $pdfs as $pdf ) {&nbsp;</div></li><li><div>              $settings = $this-&gt;options-&gt;get_pdf( $entry['form_id'], $pdf['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Only generate if the PDF wasn't created during the notification process */</span>&nbsp;</div></li><li><div>              if ( ! is_wp_error( $settings ) && $this-&gt;maybe_always_save_pdf( $settings ) ) {&nbsp;</div></li><li><div>                  $this-&gt;generate_and_save_pdf( $entry, $settings );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if the current PDF to be processed already exists on disk</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  \GFPDF\Helper\Helper_PDF $pdf The Helper_PDF Object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function does_pdf_exist( Helper_PDF $pdf ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_file( $pdf-&gt;get_full_pdf_path() ) ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * To prevent ourt tmp directory getting huge we will clean it up every 24 hours</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cleanup_tmp_dir() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $max_file_age = 24 * 3600; <span class="comment">/** Max age is 24 hours old */</span>&nbsp;</div></li><li><div>      $tmp_directory = $this-&gt;data-&gt;template_tmp_location;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_dir( $tmp_directory ) ) {&nbsp;</div></li><li><div>          <span class="comment">/** Scan the tmp directory and get a list of files / folders */</span>&nbsp;</div></li><li><div>          $directory_list = array_diff( scandir( $tmp_directory ), [ '..', '.', '.htaccess' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $directory_list as $item ) {&nbsp;</div></li><li><div>              $file = $tmp_directory . $item;&nbsp;</div></li><li><div>              $directory = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Fix to allow filemtime to work on directories too */</span>&nbsp;</div></li><li><div>              if ( is_dir( $file ) ) {&nbsp;</div></li><li><div>                  $file .= '.';&nbsp;</div></li><li><div>                  $directory = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Check if the file is too old and delete file / directory */</span>&nbsp;</div></li><li><div>              if ( file_exists( $file ) && filemtime( $file ) &lt; time() - $max_file_age ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $directory ) {&nbsp;</div></li><li><div>                      $this-&gt;misc-&gt;rmdir( substr( $file, 0, -1 ) );&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if ( ! unlink( $file ) ) {&nbsp;</div></li><li><div>                          $this-&gt;log-&gt;addError( 'Filesystem Delete Error', [&nbsp;</div></li><li><div>                              'file' =&gt; $file, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove the generated PDF from the server to save disk space</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @internal  In future we may give the option to cache PDFs to save on processing power</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The GF Entry Data</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form  The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since     4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo      Add PDF caching support to make software more performant. Need to review correct triggers for a cleanup (API-based, UI actions, 3rd-party add-on compatibility)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cleanup_pdf( $entry, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pdfs = ( isset( $form['gfpdf_form_settings'] ) ) ? $this-&gt;get_active_pdfs( $form['gfpdf_form_settings'], $entry ) : [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( sizeof( $pdfs ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** loop through each PDF config */</span>&nbsp;</div></li><li><div>          foreach ( $pdfs as $pdf ) {&nbsp;</div></li><li><div>              $settings = $this-&gt;options-&gt;get_pdf( $entry['form_id'], $pdf['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Only generate if the PDF wasn't during the notification process */</span>&nbsp;</div></li><li><div>              if ( ! is_wp_error( $settings ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $pdf_generator = new Helper_PDF( $entry, $settings, $this-&gt;gform, $this-&gt;data, $this-&gt;misc, $this-&gt;templates );&nbsp;</div></li><li><div>                  $pdf_generator-&gt;set_filename( $this-&gt;get_pdf_name( $settings, $entry ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;does_pdf_exist( $pdf_generator ) ) {&nbsp;</div></li><li><div>                      try {&nbsp;</div></li><li><div>                          $this-&gt;misc-&gt;rmdir( $pdf_generator-&gt;get_path() );&nbsp;</div></li><li><div>                      } catch ( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $this-&gt;log-&gt;addError( 'Cleanup PDF Error', [&nbsp;</div></li><li><div>                              'pdf' =&gt; $pdf, &nbsp;</div></li><li><div>                              'exception' =&gt; $e-&gt;getMessage(), &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Triggered after the Gravity Form entry is updated</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $form</span>&nbsp;</div></li><li><div><span class="comment">   * @param int   $entry_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cleanup_pdf_after_submission( $form, $entry_id ) {&nbsp;</div></li><li><div>      $entry = $this-&gt;gform-&gt;get_entry( $entry_id );&nbsp;</div></li><li><div>      $this-&gt;cleanup_pdf( $entry, $form );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Clean-up any PDFs stored on disk before we resend any notifications</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $form  The Gravity Forms object</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $leads An array of Gravity Form entry IDs</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array We tapped into a filter so we need to return the form object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function resend_notification_pdf_cleanup( $form, $leads ) {&nbsp;</div></li><li><div>      foreach ( $leads as $entry_id ) {&nbsp;</div></li><li><div>          $entry = $this-&gt;gform-&gt;get_entry( $entry_id );&nbsp;</div></li><li><div>          $this-&gt;cleanup_pdf( $entry, $form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $form;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Changes mPDF's tmp folder</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $path The current path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string       The new path</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function mpdf_tmp_path( $path ) {&nbsp;</div></li><li><div>      return $this-&gt;data-&gt;template_tmp_location;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Changes mPDF's fontdata folders</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $path The current path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string       The new path</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function mpdf_tmp_font_path( $path ) {&nbsp;</div></li><li><div>      return $this-&gt;data-&gt;template_fontdata_location;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * An mPDF filter that checks if mPDF has the font currently installed, otherwise</span>&nbsp;</div></li><li><div><span class="comment">   * will look in the Gravity PDF font folder for an alternative.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path The current path to the font mPDF is trying to load</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $font The current font name trying to be loaded</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_current_pdf_font( $path, $font ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** If the current font doesn't exist in mPDF core we'll look in our font folder */</span>&nbsp;</div></li><li><div>      if ( ! is_file( $path ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_file( $this-&gt;data-&gt;template_font_location . $font ) ) {&nbsp;</div></li><li><div>              $path = $this-&gt;data-&gt;template_font_location . $font;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * An mPDF filter which will register our custom font data with mPDF</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $fonts The registered fonts</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function register_custom_font_data_with_mPDF( $fonts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $custom_fonts = $this-&gt;options-&gt;get_custom_fonts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $custom_fonts as $font ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $fonts[ $font['shortname'] ] = array_filter( [&nbsp;</div></li><li><div>              'R' =&gt; basename( $font['regular'] ), &nbsp;</div></li><li><div>              'B' =&gt; basename( $font['bold'] ), &nbsp;</div></li><li><div>              'I' =&gt; basename( $font['italics'] ), &nbsp;</div></li><li><div>              'BI' =&gt; basename( $font['bolditalics'] ), &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $fonts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Read all fonts from our fonts directory and auto-load them into mPDF if they are not found</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $fonts The registered fonts</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_unregistered_fonts_to_mPDF( $fonts ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_fonts = glob( $this-&gt;data-&gt;template_font_location . '*.[tT][tT][fF]' );&nbsp;</div></li><li><div>      $user_fonts = ( is_array( $user_fonts ) ) ? $user_fonts : [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $user_fonts as $font ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Get font shortname */</span>&nbsp;</div></li><li><div>          $font_name = basename( $font );&nbsp;</div></li><li><div>          $short_name = $this-&gt;options-&gt;get_font_short_name( substr( $font_name, 0, -4 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Check if it exists already, otherwise add it */</span>&nbsp;</div></li><li><div>          if ( ! isset( $fonts[ $short_name ] ) && ! $this-&gt;misc-&gt;in_array( $font_name, $fonts ) ) {&nbsp;</div></li><li><div>              $fonts[ $short_name ] = [&nbsp;</div></li><li><div>                  'R' =&gt; $font_name, &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $fonts;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates our $data array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The Gravity Form Entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array        The $data array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_form_data( $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $entry['form_id']) ) {&nbsp;</div></li><li><div>          return [];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form = $this-&gt;gform-&gt;get_form( $entry['form_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! is_array( $form ) ) {&nbsp;</div></li><li><div>          return [];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Setup our basic structure */</span>&nbsp;</div></li><li><div>      $data = [&nbsp;</div></li><li><div>          'misc' =&gt; [], &nbsp;</div></li><li><div>          'field' =&gt; [], &nbsp;</div></li><li><div>          'field_descriptions' =&gt; [], &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Create a product class for use</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @var Field_Products</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $products = new Field_Products( new GF_Field(), $entry, $this-&gt;gform, $this-&gt;misc );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Get the form details */</span>&nbsp;</div></li><li><div>      $form_meta = $this-&gt;get_form_data_meta( $form, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Get the survey, quiz and poll data if applicable */</span>&nbsp;</div></li><li><div>      $quiz = $this-&gt;get_quiz_results( $form, $entry );&nbsp;</div></li><li><div>      $survey = $this-&gt;get_survey_results( $form, $entry );&nbsp;</div></li><li><div>      $poll = $this-&gt;get_poll_results( $form, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Merge in the meta data and survey, quiz and poll data */</span>&nbsp;</div></li><li><div>      $data = array_replace_recursive( $data, $form_meta, $quiz, $survey, $poll );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Loop through the form data, call the correct field object and</span>&nbsp;</div></li><li><div><span class="comment">       * save the data to our $data array</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      if ( isset( $form['fields'] ) ) {&nbsp;</div></li><li><div>          foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Skip over captcha, password and page fields */</span>&nbsp;</div></li><li><div>              $fields_to_skip = apply_filters( 'gfpdf_form_data_skip_fields', [&nbsp;</div></li><li><div>                  'captcha', &nbsp;</div></li><li><div>                  'password', &nbsp;</div></li><li><div>                  'page', &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( in_array( $field-&gt;type, $fields_to_skip ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Include any field descriptions */</span>&nbsp;</div></li><li><div>              $data['field_descriptions'][ $field-&gt;id ] = ( ! empty( $field-&gt;description ) ) ? $field-&gt;description : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Get our field object */</span>&nbsp;</div></li><li><div>              $class = $this-&gt;get_field_class( $field, $form, $entry, $products );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Merge in the field object form_data() results */</span>&nbsp;</div></li><li><div>              $data = array_replace_recursive( $data, $class-&gt;form_data() );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Load our product array if products exist */</span>&nbsp;</div></li><li><div>      if ( ! $products-&gt;is_empty() ) {&nbsp;</div></li><li><div>          $data = array_replace_recursive( $data, $products-&gt;form_data() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Re-order the array keys to make it more readable */</span>&nbsp;</div></li><li><div>      $order = [&nbsp;</div></li><li><div>          'misc', &nbsp;</div></li><li><div>          'field', &nbsp;</div></li><li><div>          'list', &nbsp;</div></li><li><div>          'signature_details_id', &nbsp;</div></li><li><div>          'products', &nbsp;</div></li><li><div>          'products_totals', &nbsp;</div></li><li><div>          'poll', &nbsp;</div></li><li><div>          'survey', &nbsp;</div></li><li><div>          'quiz', &nbsp;</div></li><li><div>          'pages', &nbsp;</div></li><li><div>          'html_id', &nbsp;</div></li><li><div>          'section_break', &nbsp;</div></li><li><div>          'field_descriptions', &nbsp;</div></li><li><div>          'signature', &nbsp;</div></li><li><div>          'signature_details', &nbsp;</div></li><li><div>          'html', &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $order as $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** If item exists pop it onto the end of the array */</span>&nbsp;</div></li><li><div>          if ( isset( $data[ $key ] ) ) {&nbsp;</div></li><li><div>              $item = $data[ $key ];&nbsp;</div></li><li><div>              unset( $data[ $key ] );&nbsp;</div></li><li><div>              $data[ $key ] = $item;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;log-&gt;addNotice( 'Form Data Array Created', [&nbsp;</div></li><li><div>          'data' =&gt; $data, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return our general $data information</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form  The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The Gravity Form Entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array        The $data array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_form_data_meta( $form, $entry ) {&nbsp;</div></li><li><div>      $data = [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Add form_id and entry_id for convinience */</span>&nbsp;</div></li><li><div>      $data['form_id'] = $entry['form_id'];&nbsp;</div></li><li><div>      $data['entry_id'] = $entry['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Set title and dates (both US and international) */</span>&nbsp;</div></li><li><div>      $data['form_title'] = ( isset( $form['title'] ) ) ? $form['title'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data['form_description'] = ( isset( $form['description'] ) ) ? $form['description'] : '';&nbsp;</div></li><li><div>      $data['date_created'] = GFCommon::format_date( $entry['date_created'], false, 'j/n/Y', false );&nbsp;</div></li><li><div>      $data['date_created_usa'] = GFCommon::format_date( $entry['date_created'], false, 'n/j/Y', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Include page names */</span>&nbsp;</div></li><li><div>      $data['pages'] = ( isset( $form['pagination']['pages'] ) ? $form['pagination']['pages'] : [] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Add misc fields */</span>&nbsp;</div></li><li><div>      $data['misc']['date_time'] = GFCommon::format_date( $entry['date_created'], false, 'Y-m-d H:i:s', false );&nbsp;</div></li><li><div>      $data['misc']['time_24hr'] = GFCommon::format_date( $entry['date_created'], false, 'H:i', false );&nbsp;</div></li><li><div>      $data['misc']['time_12hr'] = GFCommon::format_date( $entry['date_created'], false, 'g:ia', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $include = [&nbsp;</div></li><li><div>          'is_starred', &nbsp;</div></li><li><div>          'is_read', &nbsp;</div></li><li><div>          'ip', &nbsp;</div></li><li><div>          'source_url', &nbsp;</div></li><li><div>          'post_id', &nbsp;</div></li><li><div>          'currency', &nbsp;</div></li><li><div>          'payment_status', &nbsp;</div></li><li><div>          'payment_date', &nbsp;</div></li><li><div>          'transaction_id', &nbsp;</div></li><li><div>          'payment_amount', &nbsp;</div></li><li><div>          'is_fulfilled', &nbsp;</div></li><li><div>          'created_by', &nbsp;</div></li><li><div>          'transaction_type', &nbsp;</div></li><li><div>          'user_agent', &nbsp;</div></li><li><div>          'status', &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $include as $item ) {&nbsp;</div></li><li><div>          $data['misc'][ $item ] = ( isset( $entry[ $item ] ) ) ? $entry[ $item ] : '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Pull the Survey Results into the $form_data array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form  The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The Gravity Form Entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array        The results</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_survey_results( $form, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( class_exists( 'GFSurvey' ) && $this-&gt;check_field_exists( 'survey', $form ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Get survey fields */</span>&nbsp;</div></li><li><div>          $fields = GFCommon::get_fields_by_type( $form, [ 'survey' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Include the survey score, if any */</span>&nbsp;</div></li><li><div>          if ( isset( $lead['gsurvey_score'] ) ) {&nbsp;</div></li><li><div>              $data['survey']['score'] = $lead['gsurvey_score'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $results = $this-&gt;get_addon_global_data( $form, [], $fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Loop through the global survey data and convert information correctly */</span>&nbsp;</div></li><li><div>          foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Check if we have a multifield likert and replace the row key */</span>&nbsp;</div></li><li><div>              if ( isset( $field['gsurveyLikertEnableMultipleRows'] ) && $field['gsurveyLikertEnableMultipleRows'] == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  foreach ( $field['gsurveyLikertRows'] as $row ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $results['field_data'][ $field-&gt;id ] = $this-&gt;replace_key( $results['field_data'][ $field-&gt;id ], $row['value'], $row['text'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $field-&gt;choices ) && is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>                          foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                              $results['field_data'][ $field-&gt;id ][ $row['text'] ] = $this-&gt;replace_key( $results['field_data'][ $field-&gt;id ][ $row['text'] ], $choice['value'], $choice['text'] );&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Replace the standard row data */</span>&nbsp;</div></li><li><div>              if ( isset( $field-&gt;choices ) && is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>                  foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                      $results['field_data'][ $field-&gt;id ] = $this-&gt;replace_key( $results['field_data'][ $field-&gt;id ], $choice['value'], $choice['text'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data['survey']['global'] = $results;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Pull the Quiz Results into the $form_data array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form  The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The Gravity Form Entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array        The results</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_quiz_results( $form, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( class_exists( 'GFQuiz' ) && $this-&gt;check_field_exists( 'quiz', $form ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Get quiz fields */</span>&nbsp;</div></li><li><div>          $fields = GFCommon::get_fields_by_type( $form, [ 'quiz' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Store the quiz pass configuration */</span>&nbsp;</div></li><li><div>          $data['quiz']['config']['grading'] = ( isset( $form['gravityformsquiz']['grading'] ) ) ? $form['gravityformsquiz']['grading'] : '';&nbsp;</div></li><li><div>          $data['quiz']['config']['passPercent'] = ( isset( $form['gravityformsquiz']['passPercent'] ) ) ? $form['gravityformsquiz']['passPercent'] : '';&nbsp;</div></li><li><div>          $data['quiz']['config']['grades'] = ( isset( $form['gravityformsquiz']['grades'] ) ) ? $form['gravityformsquiz']['grades'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Store the user's quiz results */</span>&nbsp;</div></li><li><div>          $data['quiz']['results']['score'] = rgar( $entry, 'gquiz_score' );&nbsp;</div></li><li><div>          $data['quiz']['results']['percent'] = rgar( $entry, 'gquiz_percent' );&nbsp;</div></li><li><div>          $data['quiz']['results']['is_pass'] = rgar( $entry, 'gquiz_is_pass' );&nbsp;</div></li><li><div>          $data['quiz']['results']['grade'] = rgar( $entry, 'gquiz_grade' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Poll for the global quiz overall results */</span>&nbsp;</div></li><li><div>          $data['quiz']['global'] = $this-&gt;get_quiz_overall_data( $form, $fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Pull the Poll Results into the $form_data array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form  The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $entry The Gravity Form Entry</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array        The results</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_poll_results( $form, $entry ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $data = [];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( class_exists( 'GFPolls' ) && $this-&gt;check_field_exists( 'poll', $form ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Get poll fields and the overall results */</span>&nbsp;</div></li><li><div>          $fields = GFCommon::get_fields_by_type( $form, [ 'poll' ] );&nbsp;</div></li><li><div>          $results = $this-&gt;get_addon_global_data( $form, [], $fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Loop through our fields and update the results as needed */</span>&nbsp;</div></li><li><div>          foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/** Add the field name to a new 'misc' array key */</span>&nbsp;</div></li><li><div>              $results['field_data'][ $field-&gt;id ]['misc']['label'] = $field-&gt;label;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">/** Loop through the field choices */</span></span>&nbsp;</div></li><li><div>              foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                  $results['field_data'][ $field-&gt;id ] = $this-&gt;replace_key( $results['field_data'][ $field-&gt;id ], $choice['value'], $choice['text'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $data['poll']['global'] = $results;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parse the Quiz Overall Results</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form   The Gravity Form</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $fields The quiz fields</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array         The parsed results</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_quiz_overall_data( $form, $fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFQuiz' ) ) {&nbsp;</div></li><li><div>          return [];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** GFQuiz is a singleton. Get the instance */</span>&nbsp;</div></li><li><div>      $quiz = GFQuiz::get_instance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Create our callback to add additional data to the array specific to the quiz plugin */</span>&nbsp;</div></li><li><div>      $options['callbacks']['calculation'] = [&nbsp;</div></li><li><div>          $quiz, &nbsp;</div></li><li><div>          'results_calculation', &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $results = $this-&gt;get_addon_global_data( $form, $options, $fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Loop through our fields and update our global results */</span>&nbsp;</div></li><li><div>      foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Replace ['totals'] key with ['misc'] key */</span>&nbsp;</div></li><li><div>          $results['field_data'][ $field-&gt;id ] = $this-&gt;replace_key( $results['field_data'][ $field-&gt;id ], 'totals', 'misc' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Add the field name to the ['misc'] key */</span>&nbsp;</div></li><li><div>          $results['field_data'][ $field-&gt;id ]['misc']['label'] = $field-&gt;label;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">/** Loop through the field choices */</span></span>&nbsp;</div></li><li><div>          if ( is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>              foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                  $results['field_data'][ $field-&gt;id ] = $this-&gt;replace_key( $results['field_data'][ $field-&gt;id ], $choice['value'], $choice['text'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/** Check if this is the correct field */</span>&nbsp;</div></li><li><div>                  if ( isset( $choice['gquizIsCorrect'] ) && $choice['gquizIsCorrect'] == 1 ) {&nbsp;</div></li><li><div>                      $results['field_data'][ $field-&gt;id ]['misc']['correct_option_name'][] = esc_html( $choice['text'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $results;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Pull Gravity Forms global results Data</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $form    The Gravity Form array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $options The global query options</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $fields  The field array to use in our query</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array          The results</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_addon_global_data( $form, $options, $fields ) {&nbsp;</div></li><li><div>      <span class="comment">/** If the results class isn't loaded, load it */</span>&nbsp;</div></li><li><div>      if ( ! class_exists( 'GFResults' ) ) {&nbsp;</div></li><li><div>          require_once( GFCommon::get_base_path() . '/includes/addon/class-gf-results.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_id = $form['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Add form filter to keep in line with GF standard */</span>&nbsp;</div></li><li><div>      $form = apply_filters( 'gform_form_pre_results', $form );&nbsp;</div></li><li><div>      $form = apply_filters( 'gform_form_pre_results_' . $form_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Initiate the results class */</span>&nbsp;</div></li><li><div>      $gf_results = new GFResults( '', $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Ensure that only active leads are queried */</span>&nbsp;</div></li><li><div>      $search = [&nbsp;</div></li><li><div>          'field_filters' =&gt; [ 'mode' =&gt; '' ], &nbsp;</div></li><li><div>          'status' =&gt; 'active', &nbsp;</div></li><li><div> ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Get the results */</span>&nbsp;</div></li><li><div>      $data = $gf_results-&gt;get_results_data( $form, $fields, $search );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Unset some array keys we don't need */</span>&nbsp;</div></li><li><div>      unset( $data['status'] );&nbsp;</div></li><li><div>      unset( $data['timestamp'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sniff the form fields and determine if there are any of the $type available</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $type the field type we are looking for</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array  $form the form array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean       Whether there is a match or not</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_field_exists( $type, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $form['fields'] ) ) {&nbsp;</div></li><li><div>          foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>              if ( $field['type'] == $type ) {&nbsp;</div></li><li><div>                  return true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Swap out the array key</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array  $array           The array to be modified</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $key             The key to remove</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $replacement_key The new array key</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array        The modified array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function replace_key( $array, $key, $replacement_key ) {&nbsp;</div></li><li><div>      if ( $key !== $replacement_key && isset( $array[ $key ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Replace the array key with the actual field name */</span>&nbsp;</div></li><li><div>          $array[ $replacement_key ] = $array[ $key ];&nbsp;</div></li><li><div>          unset( $array[ $key ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Pass in a Gravity Form Field Object and get back a Gravity PDF Field Object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  object                              $field    Gravity Form Field Object</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array                               $form     The Gravity Form Array</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array                               $entry    The Gravity Form Entry</span>&nbsp;</div></li><li><div><span class="comment">   * @param  \GFPDF\Helper\Fields\Field_Products $products A Field_Products Object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return object        Gravity PDF Field Object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_field_class( $field, $form, $entry, Field_Products $products ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $class_name = $this-&gt;misc-&gt;get_field_class( $field-&gt;type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          <span class="comment">/** if we have a valid class name... */</span>&nbsp;</div></li><li><div>          if ( class_exists( $class_name ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Developer Note</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * We've purposefully not added any filters to the Field_* child classes directly.</span>&nbsp;</div></li><li><div><span class="comment">               * Instead, if you want to change how one of the fields are displayed or output (without effecting Gravity Forms itself) you should tap</span>&nbsp;</div></li><li><div><span class="comment">               * into one of the filters below and override or extend the entire class.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * Your class MUST extend the \GFPDF\Helper\Helper_Abstract_Fields abstract class - either directly or by extending an existing \GFPDF\Helper\Fields class.</span>&nbsp;</div></li><li><div><span class="comment">               * eg. class Fields_New_Text extends \GFPDF\Helper\Helper_Abstract_Fields or Fields_New_Text extends \GFPDF\Helper\Fields\Field_Text</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">               * To make your life more simple you should either use the same namespace as the field classes (\GFPDF\Helper\Fields) or import the class directly (use \GFPDF\Helper\Fields\Field_Text)</span>&nbsp;</div></li><li><div><span class="comment">               * We've tried to make the fields as modular as possible. If you have any feedback about this approach please submit a ticket on GitHub (https://github.com/GravityPDF/gravity-pdf/issues)</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              if ( GFCommon::is_product_field( $field-&gt;type ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">/** Product fields are handled through a single function */</span>&nbsp;</div></li><li><div>                  $product = new Field_Product( $field, $entry, $this-&gt;gform, $this-&gt;misc );&nbsp;</div></li><li><div>                  $product-&gt;set_products( $products );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $class = apply_filters( 'gfpdf_field_product_class', $product, $field, $entry, $form );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">                   * Load the selected class</span>&nbsp;</div></li><li><div><span class="comment">                   * See https://gravitypdf.com/documentation/v4/gfpdf_field_class/ for more details about these filters</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>                  $class = apply_filters( 'gfpdf_field_class', new $class_name( $field, $entry, $this-&gt;gform, $this-&gt;misc ), $field, $entry, $form );&nbsp;</div></li><li><div>                  $class = apply_filters( 'gfpdf_field_class_' . $field-&gt;type, $class, $field, $entry, $form );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( empty( $class ) || ! ( $class instanceof Helper_Abstract_Fields ) ) {&nbsp;</div></li><li><div>              throw new Exception( 'Class not found' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } catch ( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;log-&gt;addError( 'Invalid Field Class.', [&nbsp;</div></li><li><div>              'exception' =&gt; $e-&gt;getMessage(), &nbsp;</div></li><li><div>              'field' =&gt; $field, &nbsp;</div></li><li><div>              'form_id' =&gt; $form['id'], &nbsp;</div></li><li><div>              'entry' =&gt; $entry, &nbsp;</div></li><li><div> ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/** Exception thrown. Load generic field loader */</span>&nbsp;</div></li><li><div>          $class = apply_filters( 'gfpdf_field_default_class', new Field_Default( $field, $entry, $this-&gt;gform, $this-&gt;misc ), $field, $entry, $form );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $class;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Attempts to find a configuration which matches the legacy routing method</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $config</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_legacy_config( $config ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Get the form settings */</span>&nbsp;</div></li><li><div>      $pdfs = $this-&gt;options-&gt;get_form_pdfs( $config['fid'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $pdfs ) ) {&nbsp;</div></li><li><div>          return $pdfs;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Reindex the $pdfs keys */</span>&nbsp;</div></li><li><div>      $pdfs = array_values( $pdfs );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** Use the legacy aid to determine which PDF to load */</span>&nbsp;</div></li><li><div>      if ( $config['aid'] !== false ) {&nbsp;</div></li><li><div>          $selector = $config['aid'] - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $pdfs[ $selector ] ) && $pdfs[ $selector ]['template'] == $config['template'] ) {&nbsp;</div></li><li><div>              return $pdfs[ $selector ]['id'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** The aid method failed so lets load the first matching configuration */</span>&nbsp;</div></li><li><div>      foreach ( $pdfs as $pdf ) {&nbsp;</div></li><li><div>          if ( $pdf['active'] === true && $pdf['template'] == $config['template'] ) {&nbsp;</div></li><li><div>              return $pdf['id'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return new WP_Error( 'pdf_configuration_error', esc_html__( 'Could not find PDF configuration requested', 'gravity-forms-pdf-extended' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Do any preprocessing to our arguments before they are sent to the template</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $args</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  4.0</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function preprocess_template_arguments( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $args['settings']['header'] ) ) {&nbsp;</div></li><li><div>          $args['settings']['header'] = $this-&gt;gform-&gt;process_tags( $args['settings']['header'], $args['form'], $args['entry'] );&nbsp;</div></li><li><div>          $args['settings']['header'] = $this-&gt;misc-&gt;fix_header_footer( $args['settings']['header'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $args['settings']['first_header'] ) ) {&nbsp;</div></li><li><div>          $args['settings']['first_header'] = $this-&gt;gform-&gt;process_tags( $args['settings']['first_header'], $args['form'], $args['entry'] );&nbsp;</div></li><li><div>          $args['settings']['first_header'] = $this-&gt;misc-&gt;fix_header_footer( $args['settings']['first_header'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $args['settings']['footer'] ) ) {&nbsp;</div></li><li><div>          $args['settings']['footer'] = $this-&gt;gform-&gt;process_tags( $args['settings']['footer'], $args['form'], $args['entry'] );&nbsp;</div></li><li><div>          $args['settings']['footer'] = $this-&gt;misc-&gt;fix_header_footer( $args['settings']['footer'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $args['settings']['first_footer'] ) ) {&nbsp;</div></li><li><div>          $args['settings']['first_footer'] = $this-&gt;gform-&gt;process_tags( $args['settings']['first_footer'], $args['form'], $args['entry'] );&nbsp;</div></li><li><div>          $args['settings']['first_footer'] = $this-&gt;misc-&gt;fix_header_footer( $args['settings']['first_footer'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Gravity PDF</li><li><span></span>4.1.1</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>