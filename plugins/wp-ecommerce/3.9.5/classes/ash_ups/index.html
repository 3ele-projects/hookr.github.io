<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="class" data-id="21211"><head xmlns="http://www.w3.org/1999/xhtml"><title> ash_ups | class | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="ash_ups, class, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="Author : Greg Gullett and Instinct.co.uk SVN : UPS Trunk : Version : 1.1.0 : December 21, 2010" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.8"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=241c04c172d7e0e0d1c2a3b3456635f3' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.8' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/ash_ups/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fash_ups%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fash_ups%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-class-ash_ups","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="ash_ups" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">ash_ups</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="active" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>ash_ups</strong></h1><p>Author : Greg Gullett and Instinct.co.uk SVN : UPS Trunk : Version : 1.1.0 : December 21, 2010.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/wpsc-shipping-ups-20/" class="file">/wpsc-shipping/ups_20.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="6" class="block" start="6"><li><div>class ash_ups {&nbsp;</div></li><li><div>    public $internal_name;&nbsp;</div></li><li><div>    public $name;&nbsp;</div></li><li><div>    public $service_url = '';&nbsp;</div></li><li><div>    public $Services = array();&nbsp;</div></li><li><div>    public $singular_shipping = false;&nbsp;</div></li><li><div>    public $shipment;&nbsp;</div></li><li><div>    public $is_external = true;&nbsp;</div></li><li><div>    public $requires_curl = true;&nbsp;</div></li><li><div>    public $requires_weight = true;&nbsp;</div></li><li><div>    public $needs_zipcode = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $drop_types = array();&nbsp;</div></li><li><div>    public $cust_types = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function ash_ups () {&nbsp;</div></li><li><div>        $this-&gt;internal_name = 'ups';&nbsp;</div></li><li><div>        $this-&gt;name = _x( 'UPS', 'Shipping Module', 'wpsc' );&nbsp;</div></li><li><div>        $this-&gt;is_external = true;&nbsp;</div></li><li><div>        $this-&gt;requires_curl = true;&nbsp;</div></li><li><div>        $this-&gt;requires_weight = true;&nbsp;</div></li><li><div>        $this-&gt;needs_zipcode = true;&nbsp;</div></li><li><div>        $this-&gt;_setServiceURL();&nbsp;</div></li><li><div>        $this-&gt;_includeUPSData();&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __autoload ( $name ) {&nbsp;</div></li><li><div>        include_once( '../wpsc-includes/shipping.helper.php' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getId () {&nbsp;</div></li><li><div>        // return $this-&gt;usps_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function setId ( $id ) {&nbsp;</div></li><li><div>        // $usps_id = $id;&nbsp;</div></li><li><div>        // return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _setServiceURL () {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $wpsc_ups_settings = get_option( 'wpsc_ups_settings' );&nbsp;</div></li><li><div>        $wpsc_ups_environment = ( array_key_exists( 'upsenvironment', (array) $wpsc_ups_settings ) ) ? $wpsc_ups_settings['upsenvironment'] : '0'; //(1) testing, else (0) production.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '1' == $wpsc_ups_environment ) {&nbsp;</div></li><li><div>            $this-&gt;service_url = 'https://wwwcie.ups.com/ups.app/xml/Rate';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;service_url = 'https://www.ups.com/ups.app/xml/Rate';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getName () {&nbsp;</div></li><li><div>        return $this-&gt;name;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getInternalName () {&nbsp;</div></li><li><div>        return $this-&gt;internal_name;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _includeUPSData () {&nbsp;</div></li><li><div>        $this-&gt;drop_types = array(&nbsp;</div></li><li><div>            '01' =&gt; __( 'Daily Pickup', 'wpsc' ), &nbsp;</div></li><li><div>            '03' =&gt; __( 'Customer Counter', 'wpsc' ), &nbsp;</div></li><li><div>            '06' =&gt; __( 'One Time Pickup', 'wpsc' ), &nbsp;</div></li><li><div>            '07' =&gt; __( 'On Call Air', 'wpsc' ), &nbsp;</div></li><li><div>            '19' =&gt; __( 'Letter Center', 'wpsc' ), &nbsp;</div></li><li><div>            '20' =&gt; __( 'Air Service Center', 'wpsc' ), &nbsp;</div></li><li><div>            '11' =&gt; __( 'Suggested Retail Rates (Advanced Config)', 'wpsc' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;cust_types = array(&nbsp;</div></li><li><div>            '01' =&gt; __( 'Daily Pickup, with UPS Account', 'wpsc' ), &nbsp;</div></li><li><div>            '03' =&gt; __( 'No Daily Pickup, with No or Other Account', 'wpsc' ), &nbsp;</div></li><li><div>            '04' =&gt; __( 'Retail Outlet (Only US origin shipments)', 'wpsc' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;Services = array(&nbsp;</div></li><li><div>            '14' =&gt; __( 'Next Day Air Early AM', 'wpsc' ), &nbsp;</div></li><li><div>            '01' =&gt; __( 'Next Day Air', 'wpsc' ), &nbsp;</div></li><li><div>            '13' =&gt; __( 'Next Day Air Saver', 'wpsc' ), &nbsp;</div></li><li><div>            '59' =&gt; __( '2nd Day Air AM', 'wpsc' ), &nbsp;</div></li><li><div>            '02' =&gt; __( '2nd Day Air', 'wpsc' ), &nbsp;</div></li><li><div>            '12' =&gt; __( '3 Day Select', 'wpsc' ), &nbsp;</div></li><li><div>            '03' =&gt; __( 'Ground', 'wpsc' ), &nbsp;</div></li><li><div>            '11' =&gt; __( 'Standard', 'wpsc' ), &nbsp;</div></li><li><div>            '07' =&gt; __( 'Worldwide Express', 'wpsc' ), &nbsp;</div></li><li><div>            '54' =&gt; __( 'Worldwide Express Plus', 'wpsc' ), &nbsp;</div></li><li><div>            '08' =&gt; __( 'Worldwide Expedited', 'wpsc' ), &nbsp;</div></li><li><div>            '65' =&gt; __( 'Saver', 'wpsc' ), &nbsp;</div></li><li><div>            '82' =&gt; __( 'UPS Today Standard', 'wpsc' ), &nbsp;</div></li><li><div>            '83' =&gt; __( 'UPS Today Dedicated Courier', 'wpsc' ), &nbsp;</div></li><li><div>            '84' =&gt; __( 'UPS Today Intercity', 'wpsc' ), &nbsp;</div></li><li><div>            '85' =&gt; __( 'UPS Today Express', 'wpsc' ), &nbsp;</div></li><li><div>            '86' =&gt; __( 'UPS Today Express Saver', 'wpsc' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getForm () {&nbsp;</div></li><li><div>        if ( ! isset( $this-&gt;Services ) ) {&nbsp;</div></li><li><div>            $this-&gt;_includeUPSData();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        //__('Your Packaging', 'wpsc');  &lt;-- use to translate&nbsp;</div></li><li><div>        $wpsc_ups_settings = get_option( 'wpsc_ups_settings' );&nbsp;</div></li><li><div>        $wpsc_ups_services = get_option( 'wpsc_ups_services' );&nbsp;</div></li><li><div>        // Defined on page 41 in UPS API documentation RSS_Tool_06_10_09.pdf&nbsp;</div></li><li><div>        /**$packaging_options['00'] = __('**UNKNOWN**', 'wpsc');*/&nbsp;</div></li><li><div>        $packaging_options['01'] = __( 'UPS Letter', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['02'] = __( 'Your Packaging', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['03'] = __( 'UPS Tube', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['04'] = __( 'UPS Pak', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['21'] = __( 'UPS Express Box', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['2a'] = __( 'UPS Express Box - Small', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['2b'] = __( 'UPS Express Box - Medium', 'wpsc' );&nbsp;</div></li><li><div>        $packaging_options['2c'] = __( 'UPS Express Box - Large', 'wpsc' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;tr&gt;&lt;td&gt;&lt;table class='form-table'&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Destination Type', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;label&gt;&nbsp;</div></li><li><div>                        &lt;input type='radio' &lt;?php checked( '2' != $wpsc_ups_settings['49_residential'] ); ?&gt; value='1' name='wpsc_ups_settings[49_residential]' /&gt;&nbsp;</div></li><li><div>                        &lt;?php _e( 'Residential Address', 'wpsc' ); ?&gt;&nbsp;</div></li><li><div>                    &lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                    &lt;label&gt;&lt;input type='radio' &lt;?php checked( '2' == $wpsc_ups_settings['49_residential'] ); ?&gt;value='2' name='wpsc_ups_settings[49_residential]' /&gt;&nbsp;</div></li><li><div>                        &lt;?php _e( 'Commercial Address', 'wpsc' )?&gt;&nbsp;</div></li><li><div>                    &lt;/label&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            $sel2_drop = '';&nbsp;</div></li><li><div>            if ( empty( $wpsc_ups_settings['DropoffType'] ) ) {&nbsp;</div></li><li><div>                $sel2_drop = '01';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $sel2_drop = $wpsc_ups_settings['DropoffType'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Dropoff Type', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>                        function checkDropValue () {&nbsp;</div></li><li><div>                            var val = jQuery(&quot;#drop_type option:selected&quot;).val();&nbsp;</div></li><li><div>                            if (val == &quot;11&quot;) {&nbsp;</div></li><li><div>                                jQuery(&quot;#cust_type&quot;).removeAttr(&quot;disabled&quot;);&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                jQuery(&quot;#cust_type&quot;).attr(&quot;disabled&quot;, true);&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    &lt;/script&gt;&nbsp;</div></li><li><div>                    &lt;select id='drop_type' name='wpsc_ups_settings[DropoffType]' onChange='checkDropValue()' &gt;&nbsp;</div></li><li><div>                        &lt;?php foreach ( array_keys( (array) $this-&gt;drop_types ) as $dkey ): ?&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;&lt;?php esc_attr_e( $dkey ); ?&gt;&quot; &lt;?php selected( $dkey, $sel2_drop ); ?&gt; &gt;&nbsp;</div></li><li><div>                                &lt;?php echo( $this-&gt;drop_types[$dkey] ); ?&gt;&nbsp;</div></li><li><div>                            &lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>                    &lt;/select&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                $sel3_drop = '';&nbsp;</div></li><li><div>                if ( empty( $wpsc_ups_settings['CustomerType'] ) ) {&nbsp;</div></li><li><div>                    $sel3_drop = '01';&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $sel3_drop = $wpsc_ups_settings['CustomerType'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Customer Type', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;select id='cust_type' name='wpsc_ups_settings[CustomerType]' &lt;?php disabled( $wpsc_ups_settings['DropoffType'] != '11' ); ?&gt; &gt;&nbsp;</div></li><li><div>                        &lt;?php foreach( array_keys( $this-&gt;cust_types ) as $dkey ): ?&gt;&nbsp;</div></li><li><div>                            &lt;option value=&quot;&lt;?php esc_attr_e( $dkey ); ?&gt;&quot; &lt;?php selected( $sel3_drop == $dkey ); ?&gt; &gt;&nbsp;</div></li><li><div>                                &lt;?php echo( $this-&gt;cust_types[$dkey] ); ?&gt;&nbsp;</div></li><li><div>                            &lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>                    &lt;/select&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Packaging', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;select name='wpsc_ups_settings[48_container]'&gt;&nbsp;</div></li><li><div>                        &lt;?php foreach ( $packaging_options as $key =&gt; $name ): ?&gt;&nbsp;</div></li><li><div>                            &lt;option value='&lt;?php esc_attr_e( $key ); ?&gt;' &lt;?php selected( $key == $wpsc_ups_settings['48_container'] );?&gt;&gt;&nbsp;</div></li><li><div>                                &lt;?php esc_html_e( $name ); ?&gt;&nbsp;</div></li><li><div>                            &lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>                    &lt;/select&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Shipping Settings', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;checkbox&quot; id=&quot;ups_env_test&quot; name=&quot;wpsc_ups_settings[upsenvironment]&quot; value=&quot;1&quot; &lt;?php checked( 1, isset( $wpsc_ups_settings['upsenvironment'] ) && (bool) $wpsc_ups_settings['upsenvironment'] ); ?&gt; /&gt;&nbsp;</div></li><li><div>                    &lt;label for=&quot;ups_env_test&quot; &gt;&lt;?php _e( 'Use Testing Environment', 'wpsc' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;br /&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;checkbox&quot; id=&quot;ups_negotiated_rates&quot; name=&quot;wpsc_ups_settings[ups_negotiated_rates]&quot; value=&quot;1&quot; &lt;?php checked( 1, isset( $wpsc_ups_settings['ups_negotiated_rates'] ) && (bool) $wpsc_ups_settings['ups_negotiated_rates'] ); ?&gt; /&gt;&nbsp;</div></li><li><div>                    &lt;label for=&quot;ups_negotiated_rates&quot; &gt;&lt;?php _e( 'Show UPS negotiated rates', 'wpsc' ); ?&gt; *&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;br /&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;checkbox&quot; id=&quot;ups_insured_shipment&quot; name=&quot;wpsc_ups_settings[insured_shipment]&quot; value=&quot;1&quot; &lt;?php checked( 1, isset( $wpsc_ups_settings['insured_shipment'] ) && (bool) $wpsc_ups_settings['insured_shipment'] ); ?&gt; /&gt;&nbsp;</div></li><li><div>                    &lt;label for=&quot;ups_insured_shipment&quot; &gt;&lt;?php _e( 'Insure shipment against cart total', 'wpsc' ); ?&gt; *&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;br /&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;checkbox&quot; id=&quot;ups_singular_shipping&quot; name=&quot;wpsc_ups_settings[singular_shipping]&quot; value=&quot;1&quot; &lt;?php checked( 1, isset( $wpsc_ups_settings['singular_shipping'] ) && (bool) $wpsc_ups_settings['singular_shipping'] ); ?&gt; /&gt;&nbsp;</div></li><li><div>                    &lt;label for=&quot;ups_singular_shipping&quot; &gt;&lt;?php _e( 'Singular Shipping', 'wpsc' ); ?&gt; *&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php _e( 'Rate each quantity of items in a cart as its own package using dimensions on product', 'wpsc' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;checkbox&quot; id=&quot;ups_intl_rate&quot; name=&quot;wpsc_ups_settings[intl_rate]&quot; value=&quot;1&quot; &lt;?php checked( 1, isset( $wpsc_ups_settings['intl_rate'] ) && (bool) $wpsc_ups_settings['intl_rate'] ); ?&gt; /&gt;&nbsp;</div></li><li><div>                    &lt;label for=&quot;ups_intl_rate&quot; &gt;&lt;?php _e( 'Disable International Shipping', 'wpsc' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php _e( 'No shipping rates will be displayed if the shipment destination country is different than your base country/region.', 'wpsc' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>                ksort( $this-&gt;Services );&nbsp;</div></li><li><div>                $first = false;&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'UPS Preferred Services', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;div class=&quot;ui-widget-content multiple-select&quot;&gt;&nbsp;</div></li><li><div>                        &lt;?php foreach( array_keys( $this-&gt;Services ) as $service ): ?&gt;&nbsp;</div></li><li><div>                            &lt;input type=&quot;checkbox&quot; id=&quot;wps_ups_srv_&lt;?php esc_attr_e( $service ); ?&gt;&quot; name=&quot;wpsc_ups_services[]&quot; value=&quot;&lt;?php esc_attr_e( $service ); ?&gt;&quot; &lt;?php checked( is_array( $wpsc_ups_services ) && ( array_search( $service, $wpsc_ups_services ) !== false ) ); ?&gt; /&gt;&nbsp;</div></li><li><div>                            &lt;label for=&quot;wps_ups_srv_&lt;?php esc_attr_e( $service); ?&gt;&quot;&gt;&lt;?php esc_html_e( $this-&gt;Services[$service] ); ?&gt;&lt;/label&gt;&lt;br /&gt;&nbsp;</div></li><li><div>                        &lt;?php endforeach; ?&gt;&nbsp;</div></li><li><div>                    &lt;/div&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php _e( 'Note: All services used if no services selected', 'wpsc' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td colspan='2'&gt;&lt;strong&gt;&lt;?php _e( 'My UPS', 'wpsc' ); ?&gt;&lt;/strong&gt;&lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Account Number', 'wpsc' ); ?&gt; *&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;text&quot; name='wpsc_ups_settings[upsaccount]' value=&quot;&lt;?php esc_attr_e( $wpsc_ups_settings['upsaccount'] ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Username', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;text&quot; name='wpsc_ups_settings[upsusername]' value=&quot;&lt;?php esc_attr_e( base64_decode( $wpsc_ups_settings['upsusername'] ) ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'Password', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;password&quot; name='wpsc_ups_settings[upspassword]' value=&quot;&lt;?php esc_attr_e( base64_decode( $wpsc_ups_settings['upspassword'] ) ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&lt;?php _e( 'UPS XML API Key', 'wpsc' ); ?&gt;&lt;/td&gt;&nbsp;</div></li><li><div>                &lt;td&gt;&nbsp;</div></li><li><div>                    &lt;input type=&quot;text&quot; name='wpsc_ups_settings[upsid]' value=&quot;&lt;?php esc_attr_e( base64_decode( $wpsc_ups_settings['upsid'] ) ); ?&gt;&quot; /&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php printf( __( &quot;Don't have an API login/ID? &lt;a href='%s' target='_blank'&gt;Sign up for My UPS&lt;/a&gt;&quot;, 'wpsc' ), esc_url( &quot;https://www.ups.com/upsdeveloperkit?loc=en_US&quot; ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>            &lt;tr&gt;&nbsp;</div></li><li><div>                &lt;td colspan='2'&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php _e( '* For Negotiated rates, you must enter a UPS account number and select &quot;Show UPS negotiated rates&quot; ', 'wpsc' ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                    &lt;p class='description'&gt;&lt;?php printf( __( &quot;For more help configuring UPS, please &lt;a href='%s'&gt;read our documentation&lt;/a&gt;&quot;, 'wpsc' ), esc_url( 'http://docs.wpecommerce.org/wiki/documentation/shipping/ups' ) ); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;/td&gt;&nbsp;</div></li><li><div>            &lt;/tr&gt;&nbsp;</div></li><li><div>        &lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>        // End new Code&nbsp;</div></li><li><div>        return ob_get_clean();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function submit_form() {&nbsp;</div></li><li><div>        /** This function is called when the user hit &quot;submit&quot; in the&nbsp;</div></li><li><div>         * UPS settings area under Shipping to update the setttings.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        if (isset( $_POST['wpsc_ups_settings'] ) && !empty( $_POST['wpsc_ups_settings'] ) ) {&nbsp;</div></li><li><div>            if ( isset( $_POST['wpsc_ups_services'] ) ) {&nbsp;</div></li><li><div>                $wpsc_ups_services = $_POST['wpsc_ups_services'];&nbsp;</div></li><li><div>                update_option('wpsc_ups_services', $wpsc_ups_services);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $temp = stripslashes_deep( $_POST['wpsc_ups_settings'] );&nbsp;</div></li><li><div>            // base64_encode the information so it isnt stored as plaintext.&nbsp;</div></li><li><div>            // base64 is by no means secure but without knowing if the server&nbsp;</div></li><li><div>            // has mcrypt installed what can you do really?&nbsp;</div></li><li><div>            $temp['upsusername'] = base64_encode( $temp['upsusername'] );&nbsp;</div></li><li><div>            $temp['upspassword'] = base64_encode( $temp['upspassword'] );&nbsp;</div></li><li><div>            $temp['upsid'] = base64_encode( $temp['upsid'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            update_option('wpsc_ups_settings', $temp);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function array2xml( $data ) {&nbsp;</div></li><li><div>        $xml = &quot;&quot;;&nbsp;</div></li><li><div>        if ( is_array( $data ) ) {&nbsp;</div></li><li><div>            foreach( $data as $key =&gt; $value ) {&nbsp;</div></li><li><div>                $xml .= &quot;&lt;&quot; . trim( $key ) . &quot;&gt;&quot;;&nbsp;</div></li><li><div>                $xml .= $this-&gt;array2xml($value);&nbsp;</div></li><li><div>                $xml .= &quot;&lt;/&quot; . trim( $key ) . &quot;&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if ( is_bool( $data ) ) {&nbsp;</div></li><li><div>            if ( $data ) {&nbsp;</div></li><li><div>                $xml = &quot;true\n&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $xml = &quot;false\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $xml = trim( $data ) . &quot;\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $xml;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _is_large( &$pack, $package ) {&nbsp;</div></li><li><div>        $maximum = 165; // in inches&nbsp;</div></li><li><div>        $large_floor = 130; // in inches&nbsp;</div></li><li><div>        $calc_total=(round($package-&gt;length)+(2*round($package-&gt;width))+(2*round($package-&gt;height))); //see http://www.ups.com/content/us/en/resources/prepare/oversize.html.&nbsp;</div></li><li><div>        if ( $calc_total &gt; $maximum || round( $package-&gt;length ) &gt; 108 ) { //see http://www.ups.com/content/us/en/resources/prepare/oversize.html.&nbsp;</div></li><li><div>            throw new Exception( &quot;Package dimensions exceed non-freight limits&quot; );&nbsp;</div></li><li><div>        } elseif ( $calc_total &gt; $large_floor ) {&nbsp;</div></li><li><div>            $pack[&quot;LargePackageIndicator&quot;] = &quot;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _insured_value( &$pack, $package, $args ) {&nbsp;</div></li><li><div>        $monetary_value = $package-&gt;value;&nbsp;</div></li><li><div>        if ( $package-&gt;insurance === TRUE ) {&nbsp;</div></li><li><div>            if ( $package-&gt;insured_amount ) {&nbsp;</div></li><li><div>                $monetary_value = $package-&gt;insured_amount;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $pack[&quot;PackageServiceOptions&quot;][&quot;InsuredValue&quot;] = array(&nbsp;</div></li><li><div>                &quot;CurrencyCode&quot; =&gt; $args[&quot;currency&quot;], &nbsp;</div></li><li><div>                &quot;MonetaryValue&quot; =&gt; $package-&gt;insured_amount&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _declared_value( &$pack, $package, $args ) {&nbsp;</div></li><li><div>        $pack[&quot;PackageServiceOptions&quot;][&quot;DeclaredValue&quot;] = array(&nbsp;</div></li><li><div>            &quot;CurrencyCode&quot; =&gt; $args[&quot;currency&quot;], &nbsp;</div></li><li><div>            &quot;MonetaryValue&quot; =&gt; $package-&gt;value //Per package value, not total value&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _build_shipment( &$Shipment, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cart_shipment = apply_filters( 'wpsc_the_shipment', $this-&gt;shipment, $args ); //Filter to allow reprocessing shipment packages.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $cart_shipment-&gt;packages as $package ) {&nbsp;</div></li><li><div>            $pack = array(&nbsp;</div></li><li><div>                &quot;PackagingType&quot; =&gt; array(&nbsp;</div></li><li><div>                    &quot;Code&quot; =&gt; &quot;02&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                &quot;Dimensions&quot; =&gt; array(&nbsp;</div></li><li><div>                    &quot;UnitOfMeasurement&quot; =&gt; array(&nbsp;</div></li><li><div>                        &quot;Code&quot; =&gt; &quot;IN&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    &quot;Length&quot; =&gt; $package-&gt;length, &nbsp;</div></li><li><div>                    &quot;Width&quot; =&gt; $package-&gt;width, &nbsp;</div></li><li><div>                    &quot;Height&quot; =&gt; $package-&gt;height&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                &quot;PackageWeight&quot;=&gt;array(&nbsp;</div></li><li><div>                    &quot;UnitOfMeasurement&quot;=&gt;array(&nbsp;</div></li><li><div>                        &quot;Code&quot; =&gt; &quot;LBS&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    &quot;Weight&quot; =&gt; $package-&gt;weight&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ); // End Package&nbsp;</div></li><li><div>            // handle if the package is &quot;large&quot; or not (UPS standard)&nbsp;</div></li><li><div>            $this-&gt;_is_large($pack, $package);&nbsp;</div></li><li><div>            $this-&gt;_insured_value($pack, $package, $args);&nbsp;</div></li><li><div>            $this-&gt;_declared_value($pack, $package, $args);&nbsp;</div></li><li><div>            $Shipment .= $this-&gt;array2xml(array(&quot;Package&quot;=&gt;$pack));&nbsp;</div></li><li><div>        } // End for each package in shipment&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _buildRateRequest( $args ) {&nbsp;</div></li><li><div>        // Vars is an array&nbsp;</div></li><li><div>        // $RateRequest, $RatePackage, $RateCustomPackage, $RateRequestEnd&nbsp;</div></li><li><div>        // Are defined in ups_data.php that is included below if not&nbsp;</div></li><li><div>        // done so by instantiating class ... shouldnt ever need to&nbsp;</div></li><li><div>        // Always start of with this, it includes the auth block&nbsp;</div></li><li><div>        $REQUEST = &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&nbsp;</div></li><li><div>        &lt;AccessRequest xml:lang=\&quot;en-US\&quot;&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $access = array(&nbsp;</div></li><li><div>            &quot;AccessLicenseNumber&quot; =&gt; base64_decode( $args['api_id'] ), // UPS API ID#&nbsp;</div></li><li><div>            &quot;UserId&quot; =&gt; base64_decode( $args['username'] ), // UPS API Username&nbsp;</div></li><li><div>            &quot;Password&quot; =&gt; base64_decode( $args['password'] )  // UPS API Password&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $REQUEST .= $this-&gt;array2xml( $access );&nbsp;</div></li><li><div>        $REQUEST .= &quot;&lt;/AccessRequest&gt;\n&quot;;&nbsp;</div></li><li><div>        $REQUEST .= &quot;&lt;RatingServiceSelectionRequest xml:lang=\&quot;en-US\&quot;&gt;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // By Default we will shop. Shop when you do not have a service type&nbsp;</div></li><li><div>        // and you want to get a set of services and rates back!&nbsp;</div></li><li><div>        $RequestType = &quot;Shop&quot;;&nbsp;</div></li><li><div>        // If service type is set we cannot shop so instead we Rate!&nbsp;</div></li><li><div>        if ( isset( $args[&quot;service&quot;] ) ) {&nbsp;</div></li><li><div>            $RequestType = &quot;Rate&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $RatingServiceRequest = array(&nbsp;</div></li><li><div>            &quot;Request&quot; =&gt; array(&nbsp;</div></li><li><div>                &quot;TransactionReference&quot; =&gt; array(&nbsp;</div></li><li><div>                    &quot;CustomerContext&quot; =&gt; &quot;Rate Request&quot;, &nbsp;</div></li><li><div>                    &quot;XpciVersion&quot; =&gt; &quot;1.0001&quot;&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                &quot;RequestAction&quot; =&gt; &quot;Rate&quot;, &nbsp;</div></li><li><div>                &quot;RequestOption&quot; =&gt; $RequestType&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set the dropoff code&nbsp;</div></li><li><div>        $dropCode = ( array_key_exists( 'DropoffType', $args ) ) ? $args['DropoffType'] : '01';&nbsp;</div></li><li><div>        $PickupType = array(&nbsp;</div></li><li><div>            &quot;PickupType&quot; =&gt; array(&nbsp;</div></li><li><div>                &quot;Code&quot; =&gt; $dropCode&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $REQUEST .= $this-&gt;array2xml( $PickupType );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $dropCode == &quot;11&quot; && $args['shipr_ccode'] == &quot;US&quot; ) {&nbsp;</div></li><li><div>            // Set the request code&nbsp;</div></li><li><div>            $CustCode = ( array_key_exists( 'CustomerType', $args ) ) ? $args['CustomerType'] : '01';&nbsp;</div></li><li><div>            $CustomerType = array(&nbsp;</div></li><li><div>                &quot;CustomerClassification&quot; =&gt; array(&nbsp;</div></li><li><div>                    &quot;Code&quot;=&gt;$CustCode&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $REQUEST .= $this-&gt;array2xml( $CustomerType );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set up Shipment Node&nbsp;</div></li><li><div>        $Shipment = &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Shipper Address (billing)&nbsp;</div></li><li><div>        $Shipper = array(&nbsp;</div></li><li><div>            &quot;Address&quot; =&gt; array(&nbsp;</div></li><li><div>                &quot;StateProvinceCode&quot; =&gt; $args['shipr_state'], &nbsp;</div></li><li><div>                &quot;PostalCode&quot; =&gt; $args['shipr_pcode'], // The shipper Postal Code&nbsp;</div></li><li><div>                &quot;CountryCode&quot; =&gt; $args['shipr_ccode']&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Negotiated Rates&nbsp;</div></li><li><div>        if ( array_key_exists( 'negotiated_rates', $args ) ) {&nbsp;</div></li><li><div>            if ( $args['negotiated_rates'] == '1' && ! empty( $args['account_number'] ) ) {&nbsp;</div></li><li><div>                $Shipper[&quot;ShipperNumber&quot;] = $args['account_number'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the city is configured use it&nbsp;</div></li><li><div>        if ( array_key_exists( 'shipr_city', $args ) ) {&nbsp;</div></li><li><div>            if ( ! empty( $args['shipr_city'] ) ) {&nbsp;</div></li><li><div>                $Shipper[&quot;Address&quot;][&quot;City&quot;] = $args[&quot;shipr_city&quot;];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $Shipment .= $this-&gt;array2xml( array(&quot;Shipper&quot; =&gt; $Shipper ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The physical address the shipment is from (normally the same as billing)&nbsp;</div></li><li><div>        $ShipFrom = array(&nbsp;</div></li><li><div>            &quot;Address&quot; =&gt; array(&nbsp;</div></li><li><div>                &quot;StateProvinceCode&quot; =&gt; $args['shipf_state'], &nbsp;</div></li><li><div>                &quot;PostalCode&quot; =&gt; $args['shipf_pcode'], // The shipper Postal Code&nbsp;</div></li><li><div>                &quot;CountryCode&quot; =&gt; $args['shipf_ccode']&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If the city is configured use it&nbsp;</div></li><li><div>        if ( array_key_exists( 'shipf_city', $args ) ) {&nbsp;</div></li><li><div>            if ( ! empty( $args['shipf_city'] ) ) {&nbsp;</div></li><li><div>                $ShipFrom[&quot;Address&quot;][&quot;City&quot;] = $args[&quot;shipf_city&quot;];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $Shipment .= $this-&gt;array2xml( array( &quot;ShipFrom&quot; =&gt; $ShipFrom ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ShipTo = array(&nbsp;</div></li><li><div>            &quot;Address&quot; =&gt; array(&nbsp;</div></li><li><div>                &quot;StateProvinceCode&quot; =&gt; $args['dest_state'], // The Destination State&nbsp;</div></li><li><div>                &quot;PostalCode&quot; =&gt; $args['dest_pcode'], // The Destination Postal Code&nbsp;</div></li><li><div>                &quot;CountryCode&quot; =&gt; $args['dest_ccode'], // The Destination Country&nbsp;</div></li><li><div>                //&quot;ResidentialAddress&quot;=&gt;&quot;1&quot;&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $args['residential'] == '1' ) { //ResidentialAddressIndicator orig - Indicator&nbsp;</div></li><li><div>            $ShipTo[&quot;Address&quot;][&quot;ResidentialAddressIndicator&quot;] = &quot;1&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $Shipment .= $this-&gt;array2xml( array( &quot;ShipTo&quot; =&gt; $ShipTo ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If there is a specific service being requested then&nbsp;</div></li><li><div>        // we want to pass the service into the XML&nbsp;</div></li><li><div>        if ( isset( $args[&quot;service&quot;] ) ) {&nbsp;</div></li><li><div>           $Shipment .= $this-&gt;array2xml( array( &quot;Service&quot; =&gt; array( &quot;Code&quot; =&gt; $args['service'] ) ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Include this only if you want negotiated rates&nbsp;</div></li><li><div>        if ( array_key_exists( 'negotiated_rates', $args ) ) {&nbsp;</div></li><li><div>            if ( $args['negotiated_rates'] == &quot;1&quot; ) {&nbsp;</div></li><li><div>                $Shipment .= $this-&gt;array2xml( array( &quot;RateInformation&quot; =&gt; array( &quot;NegotiatedRatesIndicator&quot; =&gt; &quot;&quot; ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( (boolean) $args[&quot;singular_shipping&quot;] ) {&nbsp;</div></li><li><div>            $this-&gt;_build_shipment( $Shipment, $args );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $package = array(&nbsp;</div></li><li><div>                &quot;Package&quot; =&gt; array(&nbsp;</div></li><li><div>                    &quot;PackagingType&quot; =&gt; array(&nbsp;</div></li><li><div>                        &quot;Code&quot; =&gt; $args['packaging']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    &quot;PackageWeight&quot; =&gt; array(&nbsp;</div></li><li><div>                        &quot;UnitOfMeasurement&quot; =&gt; array(&nbsp;</div></li><li><div>                            &quot;Code&quot; =&gt; $args['units']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        &quot;Weight&quot; =&gt; $args[&quot;weight&quot;]&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            if ( (boolean) $args[&quot;insured_shipment&quot;] ) {&nbsp;</div></li><li><div>                $package[&quot;PackageServiceOptions&quot;] = array(&nbsp;</div></li><li><div>                    &quot;InsuredValue&quot;=&gt; array(&nbsp;</div></li><li><div>                        &quot;CurrencyCode&quot; =&gt; $args[&quot;currency&quot;], &nbsp;</div></li><li><div>                        &quot;MonetaryValue&quot; =&gt; $args[&quot;cart_total&quot;]&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $Shipment .= $this-&gt;array2xml( $package );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set the structure for the Shipment Node&nbsp;</div></li><li><div>        $RatingServiceRequest[&quot;Shipment&quot;] = $Shipment;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $REQUEST .= $this-&gt;array2xml( $RatingServiceRequest );&nbsp;</div></li><li><div>        $REQUEST .= &quot;&lt;/RatingServiceSelectionRequest&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return the final XML document as a string to be used by _makeRateRequest&nbsp;</div></li><li><div>        return $REQUEST;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _makeRateRequest( $message ) {&nbsp;</div></li><li><div>        // Make the XML request to the server and retrieve the response&nbsp;</div></li><li><div>        $ch = curl_init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        curl_setopt( $ch, CURLOPT_URL, $this-&gt;service_url );&nbsp;</div></li><li><div>        curl_setopt( $ch, CURLOPT_POST, 1 );&nbsp;</div></li><li><div>        curl_setopt( $ch, CURLOPT_POSTFIELDS, $message );&nbsp;</div></li><li><div>        curl_setopt( $ch, CURLOPT_RETURNTRANSFER, 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = curl_exec( $ch );&nbsp;</div></li><li><div>        curl_close( $ch );&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function futureDate( $interval ) {&nbsp;</div></li><li><div>        //Wed Apr 7&nbsp;</div></li><li><div>        date_default_timezone_set( 'America/Los_Angeles' );&nbsp;</div></li><li><div>        $timestamp = date( 'c' );&nbsp;</div></li><li><div>        $hour = date( &quot;G&quot; );&nbsp;</div></li><li><div>        if ( (int) $hour &gt;= 3 ) {&nbsp;</div></li><li><div>            $interval += 1;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $date = date( &quot;Y-m-d&quot; );&nbsp;</div></li><li><div>        $interval = &quot; +$interval day&quot;;&nbsp;</div></li><li><div>        $final = date( &quot;D M j&quot;, strtotime( date( &quot;Y-m-d&quot;, strtotime( $date ) ) . $interval ) );&nbsp;</div></li><li><div>        $test = explode(&quot; &quot;, $final);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $test[0] == &quot;Sat&quot; ) {&nbsp;</div></li><li><div>            return $this-&gt;futureDate( $interval + 2 );&nbsp;</div></li><li><div>        } else if ( $test[0] == &quot;Sun&quot; ) {&nbsp;</div></li><li><div>            return $this-&gt;futureDate( $interval + 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $final;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _parseQuote( $raw ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $config = get_option( 'wpsc_ups_settings', array() );&nbsp;</div></li><li><div>        $debug = ( array_key_exists( 'upsenvironment', $config) ) ? $config['upsenvironment'] : &quot;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $rate_table = array();&nbsp;</div></li><li><div>        $wpsc_ups_services = get_option( &quot;wpsc_ups_services&quot; );&nbsp;</div></li><li><div>        // Initialize a DOM using the XML passed in!&nbsp;</div></li><li><div>        $objDOM = new DOMDocument();&nbsp;</div></li><li><div>        if ( $raw != '' ) {&nbsp;</div></li><li><div>            $objDOM-&gt;loadXML( $raw );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get the &lt;ResponseStatusCode&gt; from the UPS XML&nbsp;</div></li><li><div>            $getStatusNode = $objDOM-&gt;getElementsByTagName( &quot;ResponseStatusCode&quot; );&nbsp;</div></li><li><div>            // Get the value of the error code, 1 == No Error, 0 == Error !!!&nbsp;</div></li><li><div>            $statusCode = $getStatusNode-&gt;item( 0 )-&gt;nodeValue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $statusCode == &quot;0&quot; ) {&nbsp;</div></li><li><div>                // Usually I dont leave debug stuff in but this is handy stuff!!&nbsp;</div></li><li><div>                // it will print out the error message returned by UPS!&nbsp;</div></li><li><div>                if ( $debug == &quot;1&quot; ) {&nbsp;</div></li><li><div>                    $getErrorDescNode = $objDOM-&gt;getElementsByTagName( &quot;ErrorDescription&quot; );&nbsp;</div></li><li><div>                    $ErrorDesc = $getErrorDescNode-&gt;item( 0 )-&gt;nodeValue;&nbsp;</div></li><li><div>                    echo &quot;&lt;br /&gt;Error : &quot; . $ErrorDesc . &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $RateBlocks = $objDOM-&gt;getElementsByTagName( 'RatedShipment' );&nbsp;</div></li><li><div>                foreach ( $RateBlocks as $rate_block ) {&nbsp;</div></li><li><div>                    // Get the &lt;Service&gt; Node from the XML chunk&nbsp;</div></li><li><div>                    $getServiceNode = $rate_block-&gt;getElementsByTagName( 'Service' );&nbsp;</div></li><li><div>                    $serviceNode = $getServiceNode-&gt;item( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Get the &lt;Code&gt; Node from the &lt;Service&gt; chunk&nbsp;</div></li><li><div>                    $getServiceCodeNode = $serviceNode-&gt;getElementsByTagName( 'Code' );&nbsp;</div></li><li><div>                    // Get the value from &lt;Code&gt;&nbsp;</div></li><li><div>                    $serviceCode = $getServiceCodeNode-&gt;item( 0 )-&gt;nodeValue;&nbsp;</div></li><li><div>                    $go = true;&nbsp;</div></li><li><div>                    $price = '';&nbsp;</div></li><li><div>                    $time = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //if (array_key_exists('ups_negotiated_rates', $config)) {&nbsp;</div></li><li><div>                    $getNegotiatedRateNode = $rate_block-&gt;getElementsByTagName( 'NegotiatedRates' );&nbsp;</div></li><li><div>                    if ( $getNegotiatedRateNode ) {&nbsp;</div></li><li><div>                        $negotiatedRateNode = $getNegotiatedRateNode-&gt;item( 0 );&nbsp;</div></li><li><div>                        if ( $negotiatedRateNode ) {&nbsp;</div></li><li><div>                            $getNetSummaryNode = $negotiatedRateNode-&gt;getElementsByTagName( 'NetSummaryCharges' );&nbsp;</div></li><li><div>                            $netSummaryNode = $getNetSummaryNode-&gt;item( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $getGrandTotalNode = $netSummaryNode-&gt;getElementsByTagName( 'GrandTotal' );&nbsp;</div></li><li><div>                            $grandTotalNode = $getGrandTotalNode-&gt;item( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $getMonetaryNode = $grandTotalNode-&gt;getElementsByTagName( 'MonetaryValue' );&nbsp;</div></li><li><div>                            $monetaryNode = $getMonetaryNode-&gt;item( 0 )-&gt;nodeValue;&nbsp;</div></li><li><div>                            if ( ! empty( $monetaryNode ) ) {&nbsp;</div></li><li><div>                                $go = false;&nbsp;</div></li><li><div>                                $price = $monetaryNode;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Get the &lt;TotalCharges&gt; Node from the XML chunk&nbsp;</div></li><li><div>                    $getChargeNodes = $rate_block-&gt;getElementsByTagName( 'TotalCharges' );&nbsp;</div></li><li><div>                    $chargeNode = $getChargeNodes-&gt;item( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Get the &lt;CurrencyCode&gt; from the &lt;TotalCharge&gt; chunk&nbsp;</div></li><li><div>                    $getCurrNode = $chargeNode-&gt;getElementsByTagName( 'CurrencyCode' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Get the value of &lt;CurrencyCode&gt;&nbsp;</div></li><li><div>                    $currCode = $getCurrNode-&gt;item( 0 )-&gt;nodeValue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $go == true ) {&nbsp;</div></li><li><div>                        // Get the &lt;MonetaryValue&gt; from the &lt;TotalCharge&gt; chunk&nbsp;</div></li><li><div>                        $getMonetaryNode = $chargeNode-&gt;getElementsByTagName( 'MonetaryValue' );&nbsp;</div></li><li><div>                        // Get the value of &lt;MonetaryValue&gt;&nbsp;</div></li><li><div>                        $price = $getMonetaryNode-&gt;item( 0 )-&gt;nodeValue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // If there are any services specified in the admin area&nbsp;</div></li><li><div>                    // this will check that list and pass on adding any services that&nbsp;</div></li><li><div>                    // are not explicitly defined.&nbsp;</div></li><li><div>                    if ( ! empty( $wpsc_ups_services ) ) {&nbsp;</div></li><li><div>                        if ( is_array( $wpsc_ups_services ) ) {&nbsp;</div></li><li><div>                            if ( array_search( $serviceCode, (array) $wpsc_ups_services ) === false ) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else if ( $wpsc_ups_services != $serviceCode ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    if ( array_key_exists( $serviceCode, (array) $this-&gt;Services ) ) {&nbsp;</div></li><li><div>                        $rate_table[ $this-&gt;Services[ $serviceCode ] ] = array( $currCode, $price );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } // End foreach rated shipment block&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Reverse sort the rate selection so it is cheapest first!&nbsp;</div></li><li><div>        if ( ! empty( $rate_table ) ) {&nbsp;</div></li><li><div>            asort( $rate_table );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $rate_table;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _formatTable( $services, $currency = false ) {&nbsp;</div></li><li><div>        /** The checkout template expects the array to be in a certain&nbsp;</div></li><li><div>         * format. This function will iterate through the provided&nbsp;</div></li><li><div>         * services array and format it for use. During the loop&nbsp;</div></li><li><div>         * we take advantage of the loop and translate the currency&nbsp;</div></li><li><div>         * if necessary based off of what UPS tells us they are giving us&nbsp;</div></li><li><div>         * for currency and what is set for the main currency in the settings&nbsp;</div></li><li><div>         * area&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $converter = null;&nbsp;</div></li><li><div>        if ( $currency ) {&nbsp;</div></li><li><div>            $converter = new CURRENCYCONVERTER();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $finalTable = array();&nbsp;</div></li><li><div>        foreach ( array_keys( $services ) as $service ) {&nbsp;</div></li><li><div>            if ( $currency != false && $currency != $services[ $service ][0] ) {&nbsp;</div></li><li><div>                $temp = $services[ $service ][1];&nbsp;</div></li><li><div>                $services[ $service ][1] = $converter-&gt;convert(&nbsp;</div></li><li><div>                    $services[ $service ][1], &nbsp;</div></li><li><div>                    $currency, &nbsp;</div></li><li><div>                    $services[ $service ][0]&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $finalTable[ $service ] = $services[ $service ][1];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $finalTable;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function getQuote() {&nbsp;</div></li><li><div>        global $wpdb, $wpec_ash, $wpsc_cart, $wpec_ash_tools;&nbsp;</div></li><li><div>        // Arguments array for various functions to use&nbsp;</div></li><li><div>        $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['dest_ccode'] = wpsc_get_customer_meta( 'shippingcountry' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the ups settings from the ups account info page (Shipping tab)&nbsp;</div></li><li><div>        $wpsc_ups_settings = get_option( 'wpsc_ups_settings', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Disable International Shipping. Default: Enabled, as it currently is.&nbsp;</div></li><li><div>        $args['intl_rate'] = isset( $wpsc_ups_settings['intl_rate'] ) && ! empty( $wpsc_ups_settings['intl_rate'] ) ? FALSE : TRUE;&nbsp;</div></li><li><div>        if ( ! $args['intl_rate'] && $args['dest_ccode'] != get_option( 'base_country' ) ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Destination zip code&nbsp;</div></li><li><div>        $args['dest_pcode'] = (string) wpsc_get_customer_meta( 'shippingpostcode' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_object( $wpec_ash_tools ) ) {&nbsp;</div></li><li><div>            $wpec_ash_tools = new ASHTools();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $args['dest_pcode'] ) && $wpec_ash_tools-&gt;needs_post_code( $args['dest_ccode'] ) ) {&nbsp;</div></li><li><div>            // We cannot get a quote without a zip code so might as well return!&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the total weight from the shopping cart&nbsp;</div></li><li><div>        $args['weight'] = wpsc_cart_weight_total();&nbsp;</div></li><li><div>        if ( empty( $args['weight'] ) ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['dest_state'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpsc_country = new WPSC_Country( wpsc_get_customer_meta( 'shippingcountry' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $wpsc_country-&gt;has_regions() ) {&nbsp;</div></li><li><div>            $wpsc_region = $wpsc_country-&gt;get_region( wpsc_get_customer_meta( 'shippingregion' ) );&nbsp;</div></li><li><div>            if ( is_a( $wpsc_region, 'WPSC_Region' ) ) {&nbsp;</div></li><li><div>                $args['dest_state'] = $wpsc_region-&gt;get_code();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty ( $args['dest_state'] ) ) {&nbsp;</div></li><li><div>            $args['dest_state'] = wpsc_get_customer_meta( 'shippingstate' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_object( $wpec_ash ) ) {&nbsp;</div></li><li><div>            $wpec_ash = new ASH();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $shipping_cache_check['state'] = $args['dest_state']; //The destination is needed for cached shipment check.&nbsp;</div></li><li><div>        $shipping_cache_check['country'] = $args['dest_ccode'];&nbsp;</div></li><li><div>        $shipping_cache_check['zipcode'] = $args['dest_pcode'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;shipment = $wpec_ash-&gt;get_shipment();&nbsp;</div></li><li><div>        $this-&gt;shipment-&gt;set_destination( $this-&gt;internal_name, $shipping_cache_check ); //Set this shipment's destination.&nbsp;</div></li><li><div>        $this-&gt;shipment-&gt;rates_expire = date( 'Y-m-d' );&nbsp;</div></li><li><div>        $args['shipper'] = $this-&gt;internal_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['singular_shipping'] = ( array_key_exists( 'singular_shipping', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['singular_shipping']    : '0';&nbsp;</div></li><li><div>        if ( $args['weight'] &gt; 150 && ! (boolean) $args['singular_shipping'] ) { // This is where shipping breaks out of UPS if weight is higher than 150 LBS&nbsp;</div></li><li><div>                $over_weight_txt = apply_filters(&nbsp;</div></li><li><div>                        'wpsc_shipment_over_weight', &nbsp;</div></li><li><div>                        __( 'Your order exceeds the standard shipping weight limit. Please contact us to quote other shipping alternatives.', 'wpsc' ), &nbsp;</div></li><li><div>                        $args&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $shipping_quotes[$over_weight_txt] = 0; // yes, a constant.&nbsp;</div></li><li><div>                $wpec_ash-&gt;cache_results( $this-&gt;internal_name, array( $shipping_quotes ), $this-&gt;shipment ); //Update shipment cache.&nbsp;</div></li><li><div>                return array( $shipping_quotes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache = $wpec_ash-&gt;check_cache( $this-&gt;internal_name, $this-&gt;shipment ); //And now, we're ready to check cache.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // We do not want to spam UPS (and slow down our process) if we already&nbsp;</div></li><li><div>        // have a shipping quote!&nbsp;</div></li><li><div>        if ( count( $cache['rate_table'] ) &gt;= 1 ) {&nbsp;</div></li><li><div>            return $cache['rate_table'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Final rate table&nbsp;</div></li><li><div>        $rate_table = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // API Auth settings //&nbsp;</div></li><li><div>        $args['username'] = ( array_key_exists( 'upsaccount', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['upsusername']          : '';&nbsp;</div></li><li><div>        $args['password'] = ( array_key_exists( 'upspassword', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['upspassword']          : '';&nbsp;</div></li><li><div>        $args['api_id'] = ( array_key_exists( 'upsid', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['upsid']                : '';&nbsp;</div></li><li><div>        $args['account_number'] = ( array_key_exists( 'upsaccount', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['upsaccount']           : '';&nbsp;</div></li><li><div>        $args['negotiated_rates'] = ( array_key_exists( 'ups_negotiated_rates', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['ups_negotiated_rates'] : '';&nbsp;</div></li><li><div>        $args['residential'] = $wpsc_ups_settings['49_residential'];&nbsp;</div></li><li><div>        $args['insured_shipment'] = ( array_key_exists( 'insured_shipment', $wpsc_ups_settings ) ) ? $wpsc_ups_settings['insured_shipment']     : '0';&nbsp;</div></li><li><div>        // What kind of pickup service do you use ?&nbsp;</div></li><li><div>        $args['DropoffType'] = $wpsc_ups_settings['DropoffType'];&nbsp;</div></li><li><div>        $args['packaging'] = $wpsc_ups_settings['48_container'];&nbsp;</div></li><li><div>        // Preferred Currency to display&nbsp;</div></li><li><div>        $currency_data = WPSC_Countries::get_currency_code( get_option( 'currency_type' ) );&nbsp;</div></li><li><div>        if ( ! empty( $currency_data ) ) {&nbsp;</div></li><li><div>            $args['currency'] = $currency_data;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $args['currency'] = 'USD';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Shipping billing / account address&nbsp;</div></li><li><div>        $region = new WPSC_Region( get_option( 'base_country' ), get_option( 'base_region' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['shipr_state'] = $region-&gt;get_code();&nbsp;</div></li><li><div>        $args['shipr_city'] = get_option( 'base_city' );&nbsp;</div></li><li><div>        $args['shipr_ccode'] = get_option( 'base_country' );&nbsp;</div></li><li><div>        $args['shipr_pcode'] = get_option( 'base_zipcode' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Physical Shipping address being shipped from&nbsp;</div></li><li><div>        $args['shipf_state'] = $args['shipr_state'];&nbsp;</div></li><li><div>        $args['shipf_city'] = $args['shipr_city'];&nbsp;</div></li><li><div>        $args['shipf_ccode'] = $args['shipr_ccode'];&nbsp;</div></li><li><div>        $args['shipf_pcode'] = $args['shipr_pcode'];&nbsp;</div></li><li><div>        $args['units'] = 'LBS';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args['cart_total'] = $wpsc_cart-&gt;calculate_subtotal( true );&nbsp;</div></li><li><div>        $args = apply_filters( 'wpsc_shipment_data', $args, $this-&gt;shipment );&nbsp;</div></li><li><div>        if ( isset( $args['stop'] ) ) { //Do not get rates.&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Build the XML request&nbsp;</div></li><li><div>        $request = $this-&gt;_buildRateRequest( $args );&nbsp;</div></li><li><div>        // Now that we have the message to send ... Send it!&nbsp;</div></li><li><div>        $raw_quote = $this-&gt;_makeRateRequest( $request );&nbsp;</div></li><li><div>        // Now we have the UPS response .. unfortunately its not ready&nbsp;</div></li><li><div>        // to be viewed by normal humans ...&nbsp;</div></li><li><div>        $quotes = $this-&gt;_parseQuote( $raw_quote );&nbsp;</div></li><li><div>        // If we actually have rates back from UPS we can use em!&nbsp;</div></li><li><div>        if ( $quotes != false ) {&nbsp;</div></li><li><div>            $rate_table = apply_filters( 'wpsc_rates_table', $this-&gt;_formatTable( $quotes, $args['currency'] ), $args, $this-&gt;shipment );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( isset( $wpsc_ups_settings['upsenvironment'] ) ) {&nbsp;</div></li><li><div>                echo '&lt;strong&gt;:: GetQuote ::DEBUG OUTPUT::&lt;/strong&gt;&lt;br /&gt;';&nbsp;</div></li><li><div>                echo 'Arguments sent to UPS';&nbsp;</div></li><li><div>                print_r( $args );&nbsp;</div></li><li><div>                echo '&lt;hr /&gt;';&nbsp;</div></li><li><div>                print $request;&nbsp;</div></li><li><div>                echo '&lt;hr /&gt;';&nbsp;</div></li><li><div>                echo 'Response from UPS';&nbsp;</div></li><li><div>                echo $raw_quote;&nbsp;</div></li><li><div>                echo '&lt;/strong&gt;:: GetQuote ::End DEBUG OUTPUT::';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpec_ash-&gt;cache_results(&nbsp;</div></li><li><div>            $this-&gt;internal_name, &nbsp;</div></li><li><div>            $rate_table, &nbsp;</div></li><li><div>            $this-&gt;shipment&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // return the final formatted array !&nbsp;</div></li><li><div>        return $rate_table;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Empty Function, this exists just b/c it is prototyped elsewhere&nbsp;</div></li><li><div>    function get_item_shipping() {&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.9.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/ash_ups/" class="active">3.9.5</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.4/classes/ash_ups/" class="">3.9.4</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.3/classes/ash_ups/" class="">3.9.3</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.2/classes/ash_ups/" class="">3.9.2</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.1/classes/ash_ups/" class="">3.9.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>ash_ups</li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>