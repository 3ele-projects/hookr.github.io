<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="class" data-id="27905"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc_cart | class | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="wpsc_cart, class, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WPSC Cart class" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=583babb13f3361f752c4a410ce6ab882' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wpsc_cart/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwpsc_cart%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwpsc_cart%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-class-wpsc_cart","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc_cart" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc_cart</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="active" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>wpsc_cart</strong></h1><p>The WPSC Cart class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/wpsc-includes-cart-class/" class="file">/wpsc-includes/cart.class.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="37" class="block" start="37"><li><div>class wpsc_cart {&nbsp;</div></li><li><div>    public $delivery_country;&nbsp;</div></li><li><div>    public $selected_country;&nbsp;</div></li><li><div>    public $delivery_region;&nbsp;</div></li><li><div>    public $selected_region;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $selected_shipping_method = null;&nbsp;</div></li><li><div>    public $selected_shipping_option = null;&nbsp;</div></li><li><div>    public $shipping_option = null;&nbsp;</div></li><li><div>    public $selected_shipping_amount = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $coupon;&nbsp;</div></li><li><div>    public $tax_percentage;&nbsp;</div></li><li><div>    public $unique_id;&nbsp;</div></li><li><div>    public $errors;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // caching of frequently used values, these are wiped when the cart is modified and then remade when needed&nbsp;</div></li><li><div>    public $total_tax = null;&nbsp;</div></li><li><div>    public $base_shipping = null;&nbsp;</div></li><li><div>    public $total_item_shipping = null;&nbsp;</div></li><li><div>    public $total_shipping = null;&nbsp;</div></li><li><div>    public $subtotal = null;&nbsp;</div></li><li><div>    public $total_price = null;&nbsp;</div></li><li><div>    public $uses_shipping = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public $is_incomplete = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // The cart loop variables&nbsp;</div></li><li><div>    public $cart_items = array();&nbsp;</div></li><li><div>    public $cart_item = null;&nbsp;</div></li><li><div>    public $cart_item_count = 0;&nbsp;</div></li><li><div>    public $current_cart_item = -1;&nbsp;</div></li><li><div>    public $in_the_loop = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // The shipping method loop variables&nbsp;</div></li><li><div>    public $shipping_methods = array();&nbsp;</div></li><li><div>    public $shipping_method = null;&nbsp;</div></li><li><div>    public $shipping_method_count = 0;&nbsp;</div></li><li><div>    public $current_shipping_method = -1;&nbsp;</div></li><li><div>    public $in_the_method_loop = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // The shipping quote loop variables&nbsp;</div></li><li><div>    public $shipping_quotes = array();&nbsp;</div></li><li><div>    public $shipping_quote = null;&nbsp;</div></li><li><div>    public $shipping_quote_count = 0;&nbsp;</div></li><li><div>    public $current_shipping_quote = -1;&nbsp;</div></li><li><div>    public $in_the_quote_loop = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //coupon variable&nbsp;</div></li><li><div>    public $coupons_name = '';&nbsp;</div></li><li><div>    public $coupons_amount = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Cart signature, a hash indicating uniqueness of cart&nbsp;</div></li><li><div>    public $_signature = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function wpsc_cart() {&nbsp;</div></li><li><div>        $coupon = 'percentage';&nbsp;</div></li><li><div>        $this-&gt;update_location();&nbsp;</div></li><li><div>        $this-&gt;wpsc_refresh_cart_items();&nbsp;</div></li><li><div>        $this-&gt;unique_id = sha1( uniqid( rand(), true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'wpsc_visitor_location_changing', array( &$this, 'shopper_location_changing' ), 10, 2);&nbsp;</div></li><li><div>        add_filter( 'wpsc_default_shipping_quote', array ($this, 'set_default_shipping_quote' ), 10, 3 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Action routine to start the processing that has to happen when the customer changes&nbsp;</div></li><li><div>     * location.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.8.14&nbsp;</div></li><li><div>     * @param array names of checnout items that hav changed since the last time the location for this customer was changed&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>      function shopper_location_changing( $what_changed, $visitor_id ) {&nbsp;</div></li><li><div>          $this-&gt;update_location();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * update_location method, updates the location&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function update_location() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;clear_cache();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $delivery_country = wpsc_get_customer_meta( 'shippingcountry' );&nbsp;</div></li><li><div>        $billing_country = wpsc_get_customer_meta( 'billingcountry' );&nbsp;</div></li><li><div>        $delivery_region = wpsc_get_customer_meta( 'shippingregion' );&nbsp;</div></li><li><div>        $billing_region = wpsc_get_customer_meta( 'billingregion' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;delivery_country = $delivery_country;&nbsp;</div></li><li><div>        $this-&gt;selected_country = $billing_country ;&nbsp;</div></li><li><div>        $this-&gt;delivery_region = $delivery_region ;&nbsp;</div></li><li><div>        $this-&gt;selected_region = $billing_region;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // adding refresh item&nbsp;</div></li><li><div>        $this-&gt;wpsc_refresh_cart_items();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * @description: refresh all items in the cart&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * @param: void&nbsp;</div></li><li><div>    * @return: null&nbsp;</div></li><li><div>    **/&nbsp;</div></li><li><div>    public function wpsc_refresh_cart_items() {&nbsp;</div></li><li><div>        global $wpsc_cart;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_object( $wpsc_cart ) && is_array( $wpsc_cart-&gt;cart_items ) ) {&nbsp;</div></li><li><div>            foreach ( $wpsc_cart-&gt;cart_items as $cart_item ) {&nbsp;</div></li><li><div>                $cart_item-&gt;refresh_item();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>   }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   /**&nbsp;</div></li><li><div>    * It os time to checkout, or at other points in the workflow and it's time to validate the shopping cart&nbsp;</div></li><li><div>    * call this function.&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * The function will in turn execute all of the hooks that are built into WPEC, then any hooks added by&nbsp;</div></li><li><div>    * themes and plugins.  This means that validation rules beyond what WPEC has internally can be added as needed.&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>   function validate_cart() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>           /**&nbsp;</div></li><li><div>            * action: wpsc_pre_validate_cart&nbsp;</div></li><li><div>            *&nbsp;</div></li><li><div>            * Prior to validating the cart we give anyone whoe is interested a chance to do a little setup with this&nbsp;</div></li><li><div>            * wpsc_pre_validate_cart.&nbsp;</div></li><li><div>            *&nbsp;</div></li><li><div>            * This action can be used as a convenient point to change the logic that is esecuted when the 'wpsc_validate_cart'&nbsp;</div></li><li><div>            * action is fired.  For example, if you want to do different address checks based on which country is being shipped&nbsp;</div></li><li><div>            * to you can call add_action with different function paramters.  Or if you wnated to some extra validation when shipping&nbsp;</div></li><li><div>            * address is differnet than billing, perhaps a quick SOAP call to a fraud check service, you can conditionally do an&nbsp;</div></li><li><div>            * add action to your function that does the fraud check.&nbsp;</div></li><li><div>            *&nbsp;</div></li><li><div>            * @param wpsc_cart the cart object&nbsp;</div></li><li><div>            * @param current visitor id (use this to get customer meta for the current user&nbsp;</div></li><li><div>            */&nbsp;</div></li><li><div>           do_action( 'wpsc_pre_validate_cart', $this, wpsc_get_current_customer_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>           /**&nbsp;</div></li><li><div>          * action: wpsc_validate_cart&nbsp;</div></li><li><div>            *&nbsp;</div></li><li><div>            * Validate that the cart contents is valid.  Typically done just prior to checkout.  Most often error conditions&nbsp;</div></li><li><div>            * will be recorded to special customer meta values, but other processing can be implemented based on specific needs&nbsp;</div></li><li><div>            *&nbsp;</div></li><li><div>            * These are the customer/visitor meta values that are typically added to when errors are found:&nbsp;</div></li><li><div>            *             checkout_error_messages&nbsp;</div></li><li><div>            *             gateway_error_messages&nbsp;</div></li><li><div>            *             registration_error_messages&nbsp;</div></li><li><div>            *&nbsp;</div></li><li><div>            * @param wpsc_cart the cart object&nbsp;</div></li><li><div>            * @param current visitor id (use this to get customer meta for the current user&nbsp;</div></li><li><div>            */&nbsp;</div></li><li><div>           do_action( 'wpsc_validate_cart', $this, wpsc_get_current_customer_id() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Clear all shipping method information for this cart&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.8.14&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function clear_shipping_info() {&nbsp;</div></li><li><div>        $this-&gt;selected_shipping_method = null;&nbsp;</div></li><li><div>        $this-&gt;selected_shipping_option = null;&nbsp;</div></li><li><div>        $this-&gt;shipping_option = null;&nbsp;</div></li><li><div>        $this-&gt;shipping_method = null;&nbsp;</div></li><li><div>        $this-&gt;shipping_methods = array();&nbsp;</div></li><li><div>        $this-&gt;shipping_quotes = array();&nbsp;</div></li><li><div>        $this-&gt;shipping_quote = null;&nbsp;</div></li><li><div>        $this-&gt;shipping_method_count = 0;&nbsp;</div></li><li><div>        $this-&gt;base_shipping = null;&nbsp;</div></li><li><div>        $this-&gt;total_item_shipping = null;&nbsp;</div></li><li><div>        $this-&gt;total_shipping = null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Does the cart have a valid shipping method selected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.8.14.1&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean true if a valid shipping method is selected, false otherwise&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function shipping_method_selected() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $selected = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // so the check could be written as one long expression, but thougth it better to make it more&nbsp;</div></li><li><div>        // readily understandable by someone who wants to see what is happening.&nbsp;</div></li><li><div>        // TODO:  All this logic would be unnecessary but for the lack of protected properties and&nbsp;</div></li><li><div>        // the legacy code that may choose to manipulate them directly avoiding class methods&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // is there a shipping method?&nbsp;</div></li><li><div>        if ( empty( $this-&gt;selected_shipping_method ) ) {&nbsp;</div></li><li><div>            $selected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // first we will check the shipping methods&nbsp;</div></li><li><div>        if ( $selected && ( ! is_array( $this-&gt;shipping_methods ) || empty( $this-&gt;shipping_methods ) ) ) {&nbsp;</div></li><li><div>            $selected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check to be sure the shipping method name is not empty, and is also in the array&nbsp;</div></li><li><div>        if ( $selected && ( empty( $this-&gt;selected_shipping_method ) || ! in_array( $this-&gt;selected_shipping_method, $this-&gt;shipping_methods ) ) ) {&nbsp;</div></li><li><div>            $selected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $selected;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Does the cart have a valid shipping quote selected&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.8.14.1&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean true if a valid shipping method is selected, false otherwise&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function shipping_quote_selected() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $selected = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // so the check could be written as one long expression, but thought it better to make it more&nbsp;</div></li><li><div>        // readily understandable by someone who wants to see what is happening.&nbsp;</div></li><li><div>        // TODO:  All this logic would be unnecessary but for the lack of protected properties and&nbsp;</div></li><li><div>        // the legacy code that may choose to manipulate them directly avoiding class methods&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // do we have a shipping quotes array&nbsp;</div></li><li><div>        if ( $selected && ( ! is_array( $this-&gt;shipping_quotes ) || empty( $this-&gt;shipping_quotes ) ) ) {&nbsp;</div></li><li><div>            $selected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $selected && ! isset( $this-&gt;shipping_quotes[$this-&gt;selected_shipping_option] ) ) {&nbsp;</div></li><li><div>            $selected = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $selected;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is all shipping method information for this cart empty&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.8.14&nbsp;</div></li><li><div>     * @return boolean true if all the shipping fields in the cart are empty&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function shipping_info_empty() {&nbsp;</div></li><li><div>        return empty( $this-&gt;selected_shipping_method )&nbsp;</div></li><li><div>                    && empty( $this-&gt;selected_shipping_option )&nbsp;</div></li><li><div>                            && empty( $this-&gt;shipping_method )&nbsp;</div></li><li><div>                                && empty( $this-&gt;shipping_methods )&nbsp;</div></li><li><div>                                    && empty( $this-&gt;shipping_quotes )&nbsp;</div></li><li><div>                                        && empty( $this-&gt;shipping_quote )&nbsp;</div></li><li><div>                                            && empty( $this-&gt;shipping_method_count )&nbsp;</div></li><li><div>                                                && empty( $this-&gt;base_shipping )&nbsp;</div></li><li><div>                                                    && empty( $this-&gt;total_item_shipping )&nbsp;</div></li><li><div>                                                        && empty( $this-&gt;total_shipping );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is shipping information calculated and ready to use&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.8.14&nbsp;</div></li><li><div>     * @return boolean true if a recalc is necessary&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function needs_shipping_recalc() {&nbsp;</div></li><li><div>        global $wpsc_shipping_modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wpsc_is_shipping_enabled() ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;shipping_info_empty() && $this-&gt;uses_shipping() ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $needs_shipping_recalc = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $what_changed = _wpsc_visitor_location_what_changed();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // TODO: this is where we will check the available shipping methods and see if&nbsp;</div></li><li><div>        // the parameters used to create the quotes have changes since the quotes where&nbsp;</div></li><li><div>        // created.  A function of the future shipping component&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( array_key_exists( 'shippingpostcode', $what_changed ) ) {&nbsp;</div></li><li><div>            $custom_shipping = get_option( 'custom_shipping_options' );&nbsp;</div></li><li><div>            foreach ( (array)$custom_shipping as $shipping ) {&nbsp;</div></li><li><div>                if ( isset( $wpsc_shipping_modules[$shipping]-&gt;needs_zipcode ) && $wpsc_shipping_modules[$shipping]-&gt;needs_zipcode == true ) {&nbsp;</div></li><li><div>                    $needs_shipping_recalc = true;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // recalculate shipping if country changes&nbsp;</div></li><li><div>        if ( array_key_exists( 'shippingcountry', $what_changed ) ) {&nbsp;</div></li><li><div>            $needs_shipping_recalc = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // recalculate shipping if region changes&nbsp;</div></li><li><div>        if ( array_key_exists( 'shippingregion', $what_changed ) ) {&nbsp;</div></li><li><div>            $needs_shipping_recalc = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // recalculate shipping if state&nbsp;</div></li><li><div>        if ( array_key_exists( 'shippingstate', $what_changed ) ) {&nbsp;</div></li><li><div>            $needs_shipping_recalc = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * filter: wpsc_needs_shipping_recalc&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * If more processing is needed to determine if shipping really needs to&nbsp;</div></li><li><div>         * be recalculated it should be hooked on here.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        return apply_filters( 'wpsc_needs_shipping_recalc', $needs_shipping_recalc, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get_shipping_rates method, gets the shipping rates&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_shipping_method() {&nbsp;</div></li><li><div>        global $wpsc_shipping_modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set us up with a shipping method.&nbsp;</div></li><li><div>        $custom_shipping = get_option( 'custom_shipping_options' );&nbsp;</div></li><li><div>        if ( empty( $custom_shipping ) ) {&nbsp;</div></li><li><div>            $custom_shipping = array();&nbsp;</div></li><li><div>        } elseif ( ! is_array( $custom_shipping ) ) {&nbsp;</div></li><li><div>            $custom_shipping = (array) $custom_shipping;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;shipping_methods = get_option( 'custom_shipping_options' );&nbsp;</div></li><li><div>        $this-&gt;shipping_method_count = count( $this-&gt;shipping_methods );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $use_shipping = ! get_option( 'do_not_use_shipping', false );&nbsp;</div></li><li><div>        $ready_to_calculate_shipping = apply_filters( 'wpsc_ready_to_calculate_shipping', true, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $use_shipping ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;shipping_method_count &gt; 0 && $ready_to_calculate_shipping ) {&nbsp;</div></li><li><div>                do_action( 'wpsc_before_get_shipping_method', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $shipping_quotes = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( (array) $custom_shipping as $shipping_module ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( empty( $wpsc_shipping_modules[ $shipping_module ] ) || ! is_callable( array( $wpsc_shipping_modules[ $shipping_module ], 'getQuote' ) ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $raw_quotes = $wpsc_shipping_modules[ $shipping_module ]-&gt;getQuote();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( empty( $raw_quotes ) || ! is_array( $raw_quotes ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_array( $raw_quotes ) ) {&nbsp;</div></li><li><div>                        foreach ( $raw_quotes as $key =&gt; $value ) {&nbsp;</div></li><li><div>                            $this-&gt;shipping_quotes[$wpsc_shipping_modules[ $shipping_module ]-&gt;name. ' ' . $key] = $value;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $this-&gt;shipping_quote_count = count( $this-&gt;shipping_quotes );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 1 == count( $this-&gt;shipping_methods ) ) {&nbsp;</div></li><li><div>                    $this-&gt;selected_shipping_method = $this-&gt;shipping_methods[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( 1 == count( $this-&gt;shipping_quotes ) ) {&nbsp;</div></li><li><div>                        reset( $this-&gt;shipping_quotes );&nbsp;</div></li><li><div>                        $this-&gt;selected_shipping_option = key( $this-&gt;shipping_quotes );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                do_action( 'wpsc_after_get_shipping_method', $this );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;rewind_shipping_methods();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get_shipping_option method, gets the shipping option from the selected method and associated quotes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return none&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_shipping_option() {&nbsp;</div></li><li><div>        global $wpdb, $wpsc_shipping_modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ( count( $this-&gt;shipping_quotes ) &lt; 1 ) &&&nbsp;</div></li><li><div>             isset( $wpsc_shipping_modules[$this-&gt;selected_shipping_method] ) &&&nbsp;</div></li><li><div>             is_callable( array( $wpsc_shipping_modules[$this-&gt;selected_shipping_method], 'getQuote' ) ) ) {&nbsp;</div></li><li><div>            $this-&gt;shipping_quotes = $wpsc_shipping_modules[$this-&gt;selected_shipping_method]-&gt;getQuote();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $wpsc_shipping_modules[$this-&gt;selected_shipping_method] ) ) {&nbsp;</div></li><li><div>            $this-&gt;selected_shipping_option = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( count( $this-&gt;shipping_quotes ) &lt; 1 ) {&nbsp;</div></li><li><div>            $this-&gt;selected_shipping_option = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if the current shipping option is not valid, go back to no shipping option&nbsp;</div></li><li><div>        if ( ! empty( $this-&gt;selected_shipping_option ) && ! isset( $this-&gt;shipping_quotes[$this-&gt;selected_shipping_option] ) ) {&nbsp;</div></li><li><div>            $this-&gt;selected_shipping_option = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // let the world pick a default shipping quote&nbsp;</div></li><li><div>        if (  empty( $this-&gt;selected_shipping_option ) && is_array( $this-&gt;shipping_quotes ) && ! empty( $this-&gt;shipping_quotes ) ) {&nbsp;</div></li><li><div>            $this-&gt;selected_shipping_option = apply_filters( 'wpsc_default_shipping_quote', $this-&gt;selected_shipping_option, $this-&gt;shipping_quotes, $this );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;rewind_shipping_methods();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * update_shipping method, updates the shipping&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function update_shipping( $method, $option ) {&nbsp;</div></li><li><div>        global $wpdb, $wpsc_shipping_modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $method ) ) {&nbsp;</div></li><li><div>            $this-&gt;selected_shipping_method = $method;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $option ) ) {&nbsp;</div></li><li><div>            $this-&gt;selected_shipping_option = $option;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;get_shipping_quotes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // reapply coupon in case it's free shipping&nbsp;</div></li><li><div>        if ( $this-&gt;coupons_name ) {&nbsp;</div></li><li><div>            $coupon = new wpsc_coupons( $this-&gt;coupons_name );&nbsp;</div></li><li><div>            if ( $coupon-&gt;is_free_shipping() )&nbsp;</div></li><li><div>                $this-&gt;apply_coupons( $coupon-&gt;calculate_discount(), $this-&gt;coupons_name );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get_tax_rate method, gets the tax rate as a percentage, based on the selected country and region&nbsp;</div></li><li><div>     * * EDIT: Replaced with WPEC Taxes - this function should probably be deprecated&nbsp;</div></li><li><div>     * Note: to refresh cart items use wpsc_refresh_cart_items&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_tax_rate() {&nbsp;</div></li><li><div>        $country = new WPSC_Country( get_option( 'base_country' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $country_data = WPSC_Countries::get_country( get_option( 'base_country' ), true );&nbsp;</div></li><li><div>        $add_tax = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;selected_country == get_option( 'base_country' ) ) {&nbsp;</div></li><li><div>            // Tax rules for various countries go here, if your countries tax rules&nbsp;</div></li><li><div>            // deviate from this, please supply code to add your region&nbsp;</div></li><li><div>            switch ( $this-&gt;selected_country ) {&nbsp;</div></li><li><div>                case 'US' : // USA!&nbsp;</div></li><li><div>                    $tax_region = get_option( 'base_region' );&nbsp;</div></li><li><div>                    if ( $this-&gt;selected_region == get_option( 'base_region' ) && ( get_option( 'lock_tax_to_shipping' ) != '1' ) ) {&nbsp;</div></li><li><div>                        // if they in the state, they pay tax&nbsp;</div></li><li><div>                        $add_tax = true;&nbsp;</div></li><li><div>                    } else if ( $this-&gt;delivery_region == get_option( 'base_region' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // if they live outside the state, but are delivering to within the state, they pay tax also&nbsp;</div></li><li><div>                        $add_tax = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'CA' : // Canada! apparently in canada, the region that you are in is used for tax purposes&nbsp;</div></li><li><div>                    if ( $this-&gt;selected_region != null ) {&nbsp;</div></li><li><div>                        $tax_region = $this-&gt;selected_region;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $tax_region = get_option( 'base_region' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $add_tax = true;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                default : // Everywhere else!&nbsp;</div></li><li><div>                    $tax_region = get_option( 'base_region' );&nbsp;</div></li><li><div>                    if ( $country-&gt;has_regions() ) {&nbsp;</div></li><li><div>                        if ( get_option( 'base_region' ) == $tax_region ) {&nbsp;</div></li><li><div>                            $add_tax = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $add_tax = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $add_tax == true ) {&nbsp;</div></li><li><div>            if ( $country-&gt;has_regions() ) {&nbsp;</div></li><li><div>                $region = $country-&gt;get_region( $tax_region );&nbsp;</div></li><li><div>                $tax_percentage = $region-&gt;get_tax();&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $tax_percentage = $country-&gt;get_tax();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // no tax charged = tax equal to 0%&nbsp;</div></li><li><div>            $tax_percentage = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;tax_percentage != $tax_percentage ) {&nbsp;</div></li><li><div>            $this-&gt;clear_cache();&nbsp;</div></li><li><div>            $this-&gt;tax_percentage = $tax_percentage;&nbsp;</div></li><li><div>            $this-&gt;wpsc_refresh_cart_items();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set Item method, requires a product ID and the parameters for the product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer the product ID&nbsp;</div></li><li><div>     * @param array parameters&nbsp;</div></li><li><div>     * @return boolean true on sucess, false on failure&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function set_item( $product_id, $parameters, $updater = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // default action is adding&nbsp;</div></li><li><div>        $add_item = false;&nbsp;</div></li><li><div>        $edit_item = false;&nbsp;</div></li><li><div>        $variation_check = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $parameters = wp_parse_args( $parameters, array(&nbsp;</div></li><li><div>            'quantity' =&gt; 0, &nbsp;</div></li><li><div>            'variation_values' =&gt; null&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( wpsc_product_has_variations( $product_id ) && is_null( $parameters['variation_values'] ) ) {&nbsp;</div></li><li><div>            $variation_check = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $variation_check && $parameters['quantity'] &gt; 0 && $this-&gt;check_remaining_quantity( $product_id, $parameters['variation_values'], $parameters['quantity'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $new_cart_item = new wpsc_cart_item( $product_id, $parameters, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'wpsc_set_cart_item', $product_id, $parameters, $this, $new_cart_item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $add_item = true;&nbsp;</div></li><li><div>            $edit_item = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( count( $this-&gt;cart_items ) &gt; 0 && $new_cart_item-&gt;is_donation != 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // loop through each cart item&nbsp;</div></li><li><div>                foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // compare product ids and variations.&nbsp;</div></li><li><div>                    if ( $cart_item-&gt;product_id == $new_cart_item-&gt;product_id && $cart_item-&gt;product_variations == $new_cart_item-&gt;product_variations && $cart_item-&gt;custom_message == $new_cart_item-&gt;custom_message && $cart_item-&gt;custom_file == $new_cart_item-&gt;custom_file && $cart_item-&gt;item_meta_equal( $new_cart_item ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // if they are the same, increment the count, and break out;&nbsp;</div></li><li><div>                        if ( ! $updater ) {&nbsp;</div></li><li><div>                            $this-&gt;cart_items[$key]-&gt;quantity += $new_cart_item-&gt;quantity;&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $this-&gt;cart_items[$key]-&gt;quantity = $new_cart_item-&gt;quantity;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $this-&gt;cart_items[$key]-&gt;refresh_item();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $add_item = false;&nbsp;</div></li><li><div>                        $edit_item = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        do_action( 'wpsc_edit_item', $product_id, $parameters, $this );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if we are still adding the item, add it&nbsp;</div></li><li><div>            if ( $add_item ) {&nbsp;</div></li><li><div>                $this-&gt;cart_items[] = $new_cart_item;&nbsp;</div></li><li><div>                do_action( 'wpsc_add_item', $product_id, $parameters, $this );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if some action was performed, return true, otherwise, return false;&nbsp;</div></li><li><div>        $status = false;&nbsp;</div></li><li><div>        if ( $add_item || $edit_item ) {&nbsp;</div></li><li><div>            $status = $new_cart_item;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;cart_item_count = count( $this-&gt;cart_items );&nbsp;</div></li><li><div>        $this-&gt;clear_cache();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $status;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit Item method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer a cart_items key&nbsp;</div></li><li><div>     * @param array an array of parameters to change&nbsp;</div></li><li><div>     * @return boolean true on sucess, false on failure&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function edit_item( $key, $parameters ) {&nbsp;</div></li><li><div>        if ( isset( $this-&gt;cart_items[$key] ) ) {&nbsp;</div></li><li><div>            $product_id = $this-&gt;cart_items[$key]-&gt;product_id;&nbsp;</div></li><li><div>            $quantity = $parameters ['quantity'] - $this-&gt;cart_items[$key]-&gt;quantity;&nbsp;</div></li><li><div>            if ( $this-&gt;check_remaining_quantity( $product_id, $this-&gt;cart_items[$key]-&gt;variation_values, $quantity ) == true ) {&nbsp;</div></li><li><div>                foreach ( $parameters as $name =&gt; $value ) {&nbsp;</div></li><li><div>                    $this-&gt;cart_items[$key]-&gt;$name = $value;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;cart_items[$key]-&gt;refresh_item();&nbsp;</div></li><li><div>                do_action( 'wpsc_edit_item', $product_id, $parameters, $this, $key );&nbsp;</div></li><li><div>                $this-&gt;clear_cache();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * check remaining quantity method&nbsp;</div></li><li><div>     * currently only checks remaining stock, in future will do claimed stock and quantity limits&nbsp;</div></li><li><div>     * will need to return errors, then, rather than true/false, maybe use the wp_error object?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer a product ID key&nbsp;</div></li><li><div>     * @param array variations on the product&nbsp;</div></li><li><div>     * @return boolean true on sucess, false on failure&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function check_remaining_quantity( $product_id, $variations = array(), $quantity = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stock = get_post_meta( $product_id, '_wpsc_stock', true );&nbsp;</div></li><li><div>        $stock = apply_filters( 'wpsc_product_stock', $stock, $product_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_numeric( $stock ) ) {&nbsp;</div></li><li><div>            $remaining_quantity = wpsc_get_remaining_quantity( $product_id, $variations, $quantity );&nbsp;</div></li><li><div>            if ( $remaining_quantity &lt; $quantity ) {&nbsp;</div></li><li><div>                $result = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    * get remaining quantity method&nbsp;</div></li><li><div>    * currently only checks remaining stock, in future will do claimed stock and quantity limits&nbsp;</div></li><li><div>    * will need to return errors, then, rather than true/false, maybe use the wp_error object?&nbsp;</div></li><li><div>    * @access public&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * @param integer a product ID key&nbsp;</div></li><li><div>    * @param array  variations on the product&nbsp;</div></li><li><div>    *&nbsp;</div></li><li><div>    * @return int Number of product remaining.&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_remaining_quantity( $product_id, $variations = array(), $quantity = 1 ) {&nbsp;</div></li><li><div>        return wpsc_get_remaining_quantity( $product_id, $variations, $quantity );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Remove Item method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer a cart_items key&nbsp;</div></li><li><div>     * @return boolean true on sucess, false on failure&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function remove_item( $key ) {&nbsp;</div></li><li><div>        if ( isset( $this-&gt;cart_items[$key] ) ) {&nbsp;</div></li><li><div>            $cart_item = & $this-&gt;cart_items[$key];&nbsp;</div></li><li><div>            $cart_item-&gt;update_item( 0 );&nbsp;</div></li><li><div>            unset( $this-&gt;cart_items[$key] );&nbsp;</div></li><li><div>            $this-&gt;cart_items = array_values( $this-&gt;cart_items );&nbsp;</div></li><li><div>            $this-&gt;cart_item_count = count( $this-&gt;cart_items );&nbsp;</div></li><li><div>            $this-&gt;current_cart_item = - 1;&nbsp;</div></li><li><div>            do_action( 'wpsc_remove_item', $key, $this, $cart_item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;clear_cache();&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;clear_cache();&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Empty Cart method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *         No parameters, nothing returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function empty_cart( $fromwidget = true ) {&nbsp;</div></li><li><div>        $claimed_query = new WPSC_Claimed_Stock( array(    'cart_id' =&gt; $this-&gt;unique_id ) );&nbsp;</div></li><li><div>        $claimed_query-&gt;clear_claimed_stock( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;cart_items = array();&nbsp;</div></li><li><div>        $this-&gt;cart_item = null;&nbsp;</div></li><li><div>        $this-&gt;cart_item_count = 0;&nbsp;</div></li><li><div>        $this-&gt;current_cart_item = - 1;&nbsp;</div></li><li><div>        $this-&gt;coupons_amount = 0;&nbsp;</div></li><li><div>        $this-&gt;coupons_name = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;clear_cache();&nbsp;</div></li><li><div>        $this-&gt;cleanup();&nbsp;</div></li><li><div>        do_action( 'wpsc_clear_cart', $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Clear Cache method, used to clear the cached totals&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *         No parameters, nothing returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function clear_cache() {&nbsp;</div></li><li><div>        $this-&gt;total_tax = null;&nbsp;</div></li><li><div>        $this-&gt;base_shipping = null;&nbsp;</div></li><li><div>        $this-&gt;total_item_shipping = null;&nbsp;</div></li><li><div>        $this-&gt;total_shipping = null;&nbsp;</div></li><li><div>        $this-&gt;subtotal = null;&nbsp;</div></li><li><div>        $this-&gt;total_price = null;&nbsp;</div></li><li><div>        $this-&gt;uses_shipping = null;&nbsp;</div></li><li><div>        $this-&gt;shipping_quotes = null;&nbsp;</div></li><li><div>        $this-&gt;get_shipping_option();&nbsp;</div></li><li><div>        do_action( 'wpsc_after_cart_clear_cache', $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * submit_stock_claims method, changes the association of the stock claims from the cart unique to the purchase log&nbsp;</div></li><li><div>     * ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *         No parameters, nothing returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function submit_stock_claims( $purchase_log_id ) {&nbsp;</div></li><li><div>        $claimed_query = new WPSC_Claimed_Stock( array( 'cart_id' =&gt; $this-&gt;unique_id ) );&nbsp;</div></li><li><div>        $claimed_query-&gt;submit_claimed_stock( $purchase_log_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * cleanup method, cleans up the cart just before final destruction&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *         No parameters, nothing returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function cleanup() {&nbsp;</div></li><li><div>        $claimed_query = new WPSC_Claimed_Stock( array( 'cart_id' =&gt; $this-&gt;unique_id ) );&nbsp;</div></li><li><div>        $claimed_query-&gt;clear_claimed_stock( 0 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Calculate total price method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_total_price() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Calculate individual component that comprise the cart total&nbsp;</div></li><li><div>        $subtotal = $this-&gt;calculate_subtotal();&nbsp;</div></li><li><div>        $shipping = $this-&gt;calculate_total_shipping();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get tax only if it is included&nbsp;</div></li><li><div>        $tax = ( ! wpsc_tax_isincluded() ) ? $this-&gt;calculate_total_tax() : 0.00;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get coupon amount, note that no matter what float precision this&nbsp;</div></li><li><div>        // coupon amount is, it's always saved to the database with rounded&nbsp;</div></li><li><div>        // value anyways&nbsp;</div></li><li><div>        $coupons_amount = round( $this-&gt;coupons_amount, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Calculate the total&nbsp;</div></li><li><div>        $total = ( $subtotal &gt; $coupons_amount ) ? ( ( $subtotal - $coupons_amount ) + $shipping + $tax ) : ( $tax + $shipping );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Filter total&nbsp;</div></li><li><div>        $total = apply_filters( 'wpsc_calculate_total_price', $total, $subtotal, $shipping, $tax, $coupons_amount, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set variable and return&nbsp;</div></li><li><div>        $this-&gt;total_price = $total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * calculate_subtotal method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param boolean for_shipping = exclude items with no shipping, &nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_subtotal( $for_shipping = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        if ( $for_shipping == true ) {&nbsp;</div></li><li><div>            $total = 0;&nbsp;</div></li><li><div>            foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                if ( $cart_item-&gt;uses_shipping == 1 ) {&nbsp;</div></li><li><div>                    $total += $cart_item-&gt;total_price;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $total = 0;&nbsp;</div></li><li><div>            if ( $this-&gt;subtotal == null ) {&nbsp;</div></li><li><div>                foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                    $total += $cart_item-&gt;total_price;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;subtotal = $total;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $total = $this-&gt;subtotal;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return the cart items.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Accept an array of arguments:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * - 'fields': Defaults to 'all', which returns all the fields. Otherwise, specify a field such&nbsp;</div></li><li><div>     *             as 'quantity' or 'pnp' to get an array of that field only.&nbsp;</div></li><li><div>     * - 'orderby': Specify a field to sort the cart items. Default to '', which means &quot;unsorted&quot;.&nbsp;</div></li><li><div>     * - 'order'  : Specify the direction of the sort, 'ASC' for ascending, 'DESC' for descending.&nbsp;</div></li><li><div>     *              Defaults to 'DESC'&nbsp;</div></li><li><div>     * @since  3.8.9&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @param  array  $args Array of arguments&nbsp;</div></li><li><div>     * @return array        Cart items&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_items( $args = array() ) {&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>                'fields' =&gt; 'all', &nbsp;</div></li><li><div>                'orderby' =&gt; '', &nbsp;</div></li><li><div>                'order' =&gt; 'ASC', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $r = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>        extract( $r, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $this-&gt;cart_items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $orderby ) ) {&nbsp;</div></li><li><div>            $comparison = new _WPSC_Comparison( $orderby, $order );&nbsp;</div></li><li><div>            usort( $results, array( $comparison, 'compare' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $fields != 'all' )&nbsp;</div></li><li><div>            $results = wp_list_pluck( $results, $fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $results;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * calculate total tax method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_total_tax() {&nbsp;</div></li><li><div>        $wpec_taxes_controller = new wpec_taxes_controller();&nbsp;</div></li><li><div>        $taxes_total = $wpec_taxes_controller-&gt;wpec_taxes_calculate_total();&nbsp;</div></li><li><div>        $this-&gt;total_tax = $taxes_total ['total'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $taxes_total['rate'] ) )&nbsp;</div></li><li><div>            $this-&gt;tax_percentage = $taxes_total['rate'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'wpsc_calculate_total_tax', $this-&gt;total_tax, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * calculate_total_weight method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param boolean for_shipping = exclude items with no shipping, &nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_total_weight( $for_shipping = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $total = '';&nbsp;</div></li><li><div>        if ( $for_shipping == true ) {&nbsp;</div></li><li><div>            foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                if ( $cart_item-&gt;uses_shipping == 1 ) {&nbsp;</div></li><li><div>                    $total += $cart_item-&gt;weight * $cart_item-&gt;quantity;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                $total += $cart_item-&gt;weight * $cart_item-&gt;quantity;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_total_shipping_quantity() {&nbsp;</div></li><li><div>        $total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>            if ( $cart_item-&gt;uses_shipping )&nbsp;</div></li><li><div>                $total += $cart_item-&gt;quantity;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get category url name method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_item_categories() {&nbsp;</div></li><li><div>        $category_list = array();&nbsp;</div></li><li><div>        foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>            $category_list = array_merge( (array) $cart_item-&gt;category_list, $category_list );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $category_list;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * get category IDs total price method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_item_category_ids() {&nbsp;</div></li><li><div>        $category_list = array();&nbsp;</div></li><li><div>        foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>            $category_list = array_merge( (array) $cart_item-&gt;category_id_list, $category_list );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $category_list;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * calculate_total_shipping method, gets the shipping option from the selected method and associated quotes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @return float returns the shipping as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_total_shipping() {&nbsp;</div></li><li><div>        $shipping_discount_value = get_option( 'shipping_discount_value' );&nbsp;</div></li><li><div>        $is_free_shipping_enabled = get_option( 'shipping_discount' );&nbsp;</div></li><li><div>        $subtotal = $this-&gt;calculate_subtotal();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_free_shipping = $is_free_shipping_enabled && $shipping_discount_value &gt; 0 && $shipping_discount_value &lt;= $subtotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wpsc_uses_shipping() || $has_free_shipping ) {&nbsp;</div></li><li><div>            $total = 0;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $total = $this-&gt;calculate_base_shipping();&nbsp;</div></li><li><div>            $total += $this-&gt;calculate_per_item_shipping();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'wpsc_convert_total_shipping', $total, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * has_total_shipping_discount method, checks whether the carts subtotal is larger or equal to the shipping discount&nbsp;</div></li><li><div>     * * value&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @return float returns true or false depending on whether the cart subtotal is larger or equal to the shipping *&nbsp;</div></li><li><div>     *         discount value.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function has_total_shipping_discount() {&nbsp;</div></li><li><div>        $shipping_discount_value = get_option( 'shipping_discount_value' );&nbsp;</div></li><li><div>        return get_option( 'shipping_discount' ) && $shipping_discount_value &gt; 0 && $shipping_discount_value &lt;= $this-&gt;calculate_subtotal();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * calculate_base_shipping method, gets the shipping option from the selected method and associated quotes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @return float returns the shipping as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_base_shipping() {&nbsp;</div></li><li><div>        global $wpdb, $wpsc_shipping_modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;uses_shipping() ) {&nbsp;</div></li><li><div>            if (    isset( $wpsc_shipping_modules[ $this-&gt;selected_shipping_method ] )&nbsp;</div></li><li><div>                 && is_callable( array( $wpsc_shipping_modules[ $this-&gt;selected_shipping_method ], 'getQuote' ) )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                    $this-&gt;shipping_quotes = $wpsc_shipping_modules[ $this-&gt;selected_shipping_method ]-&gt;getQuote();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $this-&gt;selected_shipping_option == null ) {&nbsp;</div></li><li><div>                $this-&gt;get_shipping_option();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $total = isset( $this-&gt;shipping_quotes[ $this-&gt;selected_shipping_option ] ) ? (float) $this-&gt;shipping_quotes[ $this-&gt;selected_shipping_option ] : 0;&nbsp;</div></li><li><div>            $this-&gt;base_shipping = $total;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $total = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * calculate_per_item_shipping method, gets the shipping option from the selected method and associated quotesing&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @return float returns the shipping as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function calculate_per_item_shipping( $method = null ) {&nbsp;</div></li><li><div>        global $wpdb, $wpsc_shipping_modules;&nbsp;</div></li><li><div>        $total = '';&nbsp;</div></li><li><div>        if ( $method == null ) {&nbsp;</div></li><li><div>            $method = $this-&gt;selected_shipping_method;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach ( (array) $this-&gt;cart_items as $cart_item ) {&nbsp;</div></li><li><div>            $total += $cart_item-&gt;calculate_shipping( $method );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $method == $this-&gt;selected_shipping_method ) {&nbsp;</div></li><li><div>            $this-&gt;total_item_shipping = $total;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $total;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * uses shipping method, to determine if shipping is used.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *         (!(get_option('shipping_discount')== 1) && (get_option('shipping_discount_value') &lt;=&nbsp;</div></li><li><div>     *         $wpsc_cart-&gt;calculate_subtotal()))&nbsp;</div></li><li><div>     * @return float returns the price as a floating point value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function uses_shipping() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        if ( get_option( 'do_not_use_shipping' ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $uses_shipping = 0;&nbsp;</div></li><li><div>        if ( ( $this-&gt;uses_shipping == null ) ) {&nbsp;</div></li><li><div>            foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                $uses_shipping += (int) $cart_item-&gt;uses_shipping;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $uses_shipping = $this-&gt;uses_shipping;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;uses_shipping = $uses_shipping;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $uses_shipping;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * process_as_currency method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param float a price&nbsp;</div></li><li><div>     * @return string a price with a currency sign&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function process_as_currency( $price ) {&nbsp;</div></li><li><div>        _wpsc_deprecated_function( __FUNCTION__, '3.8', 'wpsc_currency_display' );&nbsp;</div></li><li><div>        return wpsc_currency_display( $price );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * save_to_db method, saves the cart to the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function save_to_db( $purchase_log_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $this-&gt;cart_items as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>            $cart_item-&gt;save_to_db( $purchase_log_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function empty_db( $purchase_log_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( 'DELETE FROM ' . WPSC_TABLE_CART_CONTENTS . ' WHERE purchaseid = %d', $purchase_log_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * cart loop methods&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function next_cart_item() {&nbsp;</div></li><li><div>        $this-&gt;current_cart_item ++;&nbsp;</div></li><li><div>        $this-&gt;cart_item = $this-&gt;cart_items[$this-&gt;current_cart_item];&nbsp;</div></li><li><div>        return $this-&gt;cart_item;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function the_cart_item() {&nbsp;</div></li><li><div>        $this-&gt;in_the_loop = true;&nbsp;</div></li><li><div>        $this-&gt;cart_item = $this-&gt;next_cart_item();&nbsp;</div></li><li><div>        if ( $this-&gt;current_cart_item == 0 ) // loop has just started&nbsp;</div></li><li><div>            do_action( 'wpsc_cart_loop_start' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function have_cart_items() {&nbsp;</div></li><li><div>        if ( $this-&gt;current_cart_item + 1 &lt; $this-&gt;cart_item_count ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else if ( $this-&gt;current_cart_item + 1 == $this-&gt;cart_item_count && $this-&gt;cart_item_count &gt; 0 ) {&nbsp;</div></li><li><div>            do_action( 'wpsc_cart_loop_end' );&nbsp;</div></li><li><div>            // Do some cleaning up after the loop, &nbsp;</div></li><li><div>            $this-&gt;rewind_cart_items();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;in_the_loop = false;&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function rewind_cart_items() {&nbsp;</div></li><li><div>        $this-&gt;current_cart_item = - 1;&nbsp;</div></li><li><div>        if ( $this-&gt;cart_item_count &gt; 0 ) {&nbsp;</div></li><li><div>            $this-&gt;cart_item = $this-&gt;cart_items[0];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * shipping_methods methods&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function next_shipping_method() {&nbsp;</div></li><li><div>        $this-&gt;current_shipping_method ++;&nbsp;</div></li><li><div>        $this-&gt;shipping_method = $this-&gt;shipping_methods [$this-&gt;current_shipping_method];&nbsp;</div></li><li><div>        return $this-&gt;shipping_method;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function the_shipping_method() {&nbsp;</div></li><li><div>        $this-&gt;shipping_method = $this-&gt;next_shipping_method();&nbsp;</div></li><li><div>        $this-&gt;get_shipping_quotes();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function have_shipping_methods() {&nbsp;</div></li><li><div>        if ( $this-&gt;current_shipping_method + 1 &lt; $this-&gt;shipping_method_count ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else if ( $this-&gt;current_shipping_method + 1 == $this-&gt;shipping_method_count && $this-&gt;shipping_method_count &gt; 0 ) {&nbsp;</div></li><li><div>            // Do some cleaning up after the loop, &nbsp;</div></li><li><div>            $this-&gt;rewind_shipping_methods();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function rewind_shipping_methods() {&nbsp;</div></li><li><div>        $this-&gt;current_shipping_method = - 1;&nbsp;</div></li><li><div>        if ( $this-&gt;shipping_method_count &gt; 0 ) {&nbsp;</div></li><li><div>            $this-&gt;shipping_method = $this-&gt;shipping_methods[0];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * shipping_quotes methods&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_shipping_quotes() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb, $wpsc_shipping_modules;&nbsp;</div></li><li><div>        $this-&gt;shipping_quotes = array();&nbsp;</div></li><li><div>        if ( $this-&gt;shipping_method == null ) {&nbsp;</div></li><li><div>            $this-&gt;get_shipping_method();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $wpsc_shipping_modules[$this-&gt;shipping_method] ) && is_callable( array( $wpsc_shipping_modules [$this-&gt;shipping_method], 'getQuote' ) ) ) {&nbsp;</div></li><li><div>            $unprocessed_shipping_quotes = $wpsc_shipping_modules[$this-&gt;shipping_method]-&gt;getQuote();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $num = 0;&nbsp;</div></li><li><div>        if ( ! empty( $unprocessed_shipping_quotes ) ) {&nbsp;</div></li><li><div>            foreach ( (array) $unprocessed_shipping_quotes as $shipping_key =&gt; $shipping_value ) {&nbsp;</div></li><li><div>                $per_item_shipping = $this-&gt;calculate_per_item_shipping( $this-&gt;shipping_method );&nbsp;</div></li><li><div>                $this-&gt;shipping_quotes [$num] ['name'] = $shipping_key;&nbsp;</div></li><li><div>                $this-&gt;shipping_quotes [$num] ['value'] = (float) $shipping_value + (float) $per_item_shipping;&nbsp;</div></li><li><div>                $num ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;shipping_quote_count = count( $this-&gt;shipping_quotes );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If there is only one quote, set it as the default.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string     $selected_option  The currently selected rate.&nbsp;</div></li><li><div>     * @param array      $shipping_quotes  Array of all available shipping quotes.&nbsp;</div></li><li><div>     * @param WPSC_Cart  $wpsc_cart        The WPSC_Cart object.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function set_default_shipping_quote( $selected_option, $shipping_quotes, $wpsc_cart ) {&nbsp;</div></li><li><div>        if ( count( $shipping_quotes ) == 1 ) {&nbsp;</div></li><li><div>            reset( $shipping_quotes );&nbsp;</div></li><li><div>            $selected_option = key( $shipping_quotes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $selected_option;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function google_shipping_quotes() {&nbsp;</div></li><li><div>        if ( defined( 'WPEC_LOAD_DEPRECATED' ) && WPEC_LOAD_DEPRECATED ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Couldn't find an easy way to deprecate this function without creating a new class, so it is being&nbsp;</div></li><li><div>             * deprecated in place. Google checkout is gone, so this function should not have any purpose going forward&nbsp;</div></li><li><div>             * @since 3.8.14&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            global $wpsc_shipping_modules;&nbsp;</div></li><li><div>            $shipping_quote_count = 0;&nbsp;</div></li><li><div>            $custom_shipping = get_option( 'custom_shipping_options' );&nbsp;</div></li><li><div>            $shipping_quotes = null;&nbsp;</div></li><li><div>            if ( $this-&gt;selected_shipping_method != null ) {&nbsp;</div></li><li><div>                $this-&gt;shipping_quotes = $wpsc_shipping_modules [$this-&gt;selected_shipping_method]-&gt;getQuote();&nbsp;</div></li><li><div>                // use the selected shipping module&nbsp;</div></li><li><div>                if ( is_callable( array( $wpsc_shipping_modules [$this-&gt;selected_shipping_method], 'getQuote' ) ) ) {&nbsp;</div></li><li><div>                    $this-&gt;shipping_quotes = $wpsc_shipping_modules [$this-&gt;selected_shipping_method]-&gt;getQuote();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // otherwise select the first one with any quotes&nbsp;</div></li><li><div>                foreach ( (array) $custom_shipping as $shipping_module ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // if the shipping module does not require a weight, or requires one and the weight is larger than&nbsp;</div></li><li><div>                    // zero&nbsp;</div></li><li><div>                    $this-&gt;selected_shipping_method = $shipping_module;&nbsp;</div></li><li><div>                    if ( is_callable( array( $wpsc_shipping_modules [$this-&gt;selected_shipping_method], 'getQuote' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $this-&gt;shipping_quotes = $wpsc_shipping_modules [$this-&gt;selected_shipping_method]-&gt;getQuote();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // if we have any shipping quotes, break the loop.&nbsp;</div></li><li><div>                    if ( count( $this-&gt;shipping_quotes ) &gt; $shipping_quote_count ) {&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } // end load deprecated&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function next_shipping_quote() {&nbsp;</div></li><li><div>        $this-&gt;current_shipping_quote ++;&nbsp;</div></li><li><div>        $this-&gt;shipping_quote = $this-&gt;shipping_quotes [$this-&gt;current_shipping_quote];&nbsp;</div></li><li><div>        return $this-&gt;shipping_quote;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function the_shipping_quote() {&nbsp;</div></li><li><div>        $this-&gt;shipping_quote = $this-&gt;next_shipping_quote();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function have_shipping_quotes() {&nbsp;</div></li><li><div>        if ( $this-&gt;current_shipping_quote + 1 &lt; $this-&gt;shipping_quote_count ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else if ( $this-&gt;current_shipping_quote + 1 == $this-&gt;shipping_quote_count && $this-&gt;shipping_quote_count &gt; 0 ) {&nbsp;</div></li><li><div>            // Do some cleaning up after the loop, &nbsp;</div></li><li><div>            $this-&gt;rewind_shipping_quotes();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function rewind_shipping_quotes() {&nbsp;</div></li><li><div>        $this-&gt;current_shipping_quote = - 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;shipping_quote_count &gt; 0 ) {&nbsp;</div></li><li><div>            $this-&gt;shipping_quote = $this-&gt;shipping_quotes[0];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Applying Coupons&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function apply_coupons( $coupons_amount = '', $coupon_name = '' ) {&nbsp;</div></li><li><div>        $this-&gt;clear_cache();&nbsp;</div></li><li><div>        $this-&gt;coupons_name = $coupon_name;&nbsp;</div></li><li><div>        $this-&gt;coupons_amount = apply_filters( 'wpsc_coupons_amount', $coupons_amount, $coupon_name, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;calculate_total_price();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;total_price &lt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;coupons_amount += $this-&gt;total_price;&nbsp;</div></li><li><div>            $this-&gt;total_price = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;calculate_total_price();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.9.1</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/wpsc_cart/" class="active">3.9.5</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.4/classes/wpsc_cart/" class="">3.9.4</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.3/classes/wpsc_cart/" class="">3.9.3</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.2/classes/wpsc_cart/" class="">3.9.2</a></li><li><a href="http://hookr.io/plugins/wp-ecommerce/3.9.1/classes/wpsc_cart/" class="">3.9.1</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>wpsc_cart</li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>