<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27717"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-shipping-library-shipwire-functions | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=7095aa9c4795a5fe05bb89c9390e885c' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-shipping-library-shipwire-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-shipping-library-shipwire-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-shipping-library-shipwire-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-shipping-library-shipwire-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-shipping-library-shipwire-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-shipping-library-shipwir&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-shipping/library/shipwire_functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handles our current Shipwire integration.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Integrates with Order Fulfillment API, Inventory Sync API, Shipping Quotes API and Tracking API.  Order Fullfillment is hooked into the ordering process.</span>&nbsp;</div></li><li><div><span class="comment"> * Inventory and Tracking are handled through a manual 'Update Tracking and Inventory' click in Settings area.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Shipping is done via a custom shipping module.  Upon Shipwire activation, we disable all others and enable this.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Determine demand for further automation of Inventory/Tracking APIs.  Easy enough to hook in to cron.</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Determine if there is any performance, elegance or feature-set gain to be made in converting the get_*_xml methods to DOMDocument or SimpleXML</span>&nbsp;</div></li><li><div><span class="comment"> * @todo If and when purchase logs are moved to CPT, DO NOT FORGET TO REFACTOR!</span>&nbsp;</div></li><li><div><span class="comment"> * @todo If and when checkout forms are refactored to not utilize unique_names - DO NOT FORGET TO REFACTOR!</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Use WPSC_Purchase_Log class where appropriate.  I should imagine this will mitigate the point of CPT refactoring, as that will be handled at that level.</span>&nbsp;</div></li><li><div><span class="comment"> * @package wp-e-commerce</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage WPSC_Shipwire</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WPSC_Shipwire {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static $instance;&nbsp;</div></li><li><div>  private static $email;&nbsp;</div></li><li><div>  private static $passwd;&nbsp;</div></li><li><div>  private static $server;&nbsp;</div></li><li><div>  private static $warehouse;&nbsp;</div></li><li><div>  private static $endpoint;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Playing nicely.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_instance() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( self::$instance ) )&nbsp;</div></li><li><div>          self::$instance = new WPSC_Shipwire();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( self::is_active() )&nbsp;</div></li><li><div>          return self::$instance;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets up properties, sends Order via API on checkout success.  Initial hook for AJAX link in admin</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      self::$email = get_option( 'shipwireemail' );&nbsp;</div></li><li><div>      self::$passwd = get_option( 'shipwirepassword' );&nbsp;</div></li><li><div>      self::$server = apply_filters( 'wpsc_shipwire_server' , 'Production' );&nbsp;</div></li><li><div>      self::$warehouse = apply_filters( 'wpsc_shipwire_warehouse', '00' );&nbsp;</div></li><li><div>      self::$endpoint = (bool) get_option( 'shipwire_test_server' ) ? 'https:<span class="comment"><span class="comment">//api.beta.shipwire.com/exec/' : 'https://api.shipwire.com/exec/';</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! self::is_active() )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'DOING_AJAX' ) && DOING_AJAX )&nbsp;</div></li><li><div>          self::set_posted_properties();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wpsc_transaction_results_shutdown', array( $this, 'shipwire_on_checkout' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Hooks into ajax handler for Inventory Sync and Tracking API.  Handler is run upon clicking &quot;Update Tracking and Inventory&quot; in Shipping Settings</span>&nbsp;</div></li><li><div>      add_action( 'wp_ajax_sync_shipwire_products', array( $this, 'sync_products' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static function set_posted_properties() {&nbsp;</div></li><li><div>      if ( isset( $_POST['email'] ) )&nbsp;</div></li><li><div>          self::$email = $_POST['email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['password'] ) )&nbsp;</div></li><li><div>          self::$passwd = $_POST['password'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_POST['server'] ) ) {&nbsp;</div></li><li><div>          self::$endpoint = (bool) $_POST['server'] ? 'https:<span class="comment"><span class="comment">//api.beta.shipwire.com/exec/' : 'https://api.shipwire.com/exec/';</span></span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if Shipwire option is set and SimpleXML is present.  We'll use SimpleXML to parse responses from the server.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_active() {&nbsp;</div></li><li><div>      return ( (bool) get_option( 'shipwire' ) && function_exists( 'simplexml_load_string' ) ) || isset( $_POST['server'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Builds XML API request for Order API</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo Use WPSC_Purchase_Log class instead of direct queries.</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() Switch for 'wpsc_shipwire_show_declared_value' send declared value to Shipwire.  Defaults to true</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() Switch for 'wpsc_shipwire_show_affiliate' to send referring affiliate to Shipwire. Defaults to false</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() Switch for 'wpsc_shipwire_show_dimensions' to send dimensions to Shipwire. Defaults to false</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() 'get_order_xml' filters final XML</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $log_id</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $xml</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_order_xml( $log_id ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_info = $wpdb-&gt;get_results( 'SELECT * FROM ' . WPSC_TABLE_CHECKOUT_FORMS, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $form_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Sets up array of form IDs to compare against customer data</span>&nbsp;</div></li><li><div>      foreach ( $form_info as $info ) {&nbsp;</div></li><li><div>          if ( '1' == $info['active'] )&nbsp;</div></li><li><div>              $form_ids[$info['unique_name']] = $info['id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Extracts unique name variables for comparison.</span>&nbsp;</div></li><li><div>      extract( $form_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $customer_data = $wpdb-&gt;get_results( $wpdb-&gt;prepare( 'SELECT form_id, value FROM ' . WPSC_TABLE_SUBMITTED_FORM_DATA . ' WHERE log_id = %d', $log_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $customer_data as $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingfirstname )&nbsp;</div></li><li><div>              $first_name = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippinglastname )&nbsp;</div></li><li><div>              $last_name = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingaddress )&nbsp;</div></li><li><div>              $address = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingcity )&nbsp;</div></li><li><div>              $city = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingstate )&nbsp;</div></li><li><div>              $state = wpsc_get_state_by_id( $data-&gt;value, 'code' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingpostcode )&nbsp;</div></li><li><div>              $zip = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingcountry )&nbsp;</div></li><li><div>              $country = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $shippingcountry )&nbsp;</div></li><li><div>              $country = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $billingphone )&nbsp;</div></li><li><div>              $phone = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $data-&gt;form_id == $billingemail )&nbsp;</div></li><li><div>              $email = $data-&gt;value;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $full_name = $first_name . ' ' . $last_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $products = $wpdb-&gt;get_results( $wpdb-&gt;prepare( 'SELECT * FROM ' . WPSC_TABLE_CART_CONTENTS . ' WHERE purchaseid = %d', $log_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping = self::get_shipping( $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;OrderList&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;EmailAddress&gt;' . self::$email . '&lt;/EmailAddress&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Password&gt;' . self::$passwd . '&lt;/Password&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Server&gt;' . self::$server . '&lt;/Server&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $referrer = apply_filters( 'wpsc_shipwire_show_affiliate', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $referrer )&nbsp;</div></li><li><div>          $xml .= '&lt;Referer&gt;' . $referrer . '&lt;/Referer&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml .= '&lt;Warehouse&gt;' . self::$warehouse . '&lt;/Warehouse&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Order id=&quot;' . $log_id . '&quot;&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;AddressInfo type=&quot;ship&quot;&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Name&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Full&gt;' . $full_name . '&lt;/Full&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;/Name&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Address1&gt;' . $address . '&lt;/Address1&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;City&gt;' . $city . '&lt;/City&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;State&gt;' . $state . '&lt;/State&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Country&gt;' . $country . '&lt;/Country&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Zip&gt;' . $zip . '&lt;/Zip&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Phone&gt;' . $phone . '&lt;/Phone&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Email&gt;' . $email . '&lt;/Email&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;/AddressInfo&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Shipping&gt;' . $shipping . '&lt;/Shipping&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $num = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $show_declared_value = apply_filters( 'wpsc_shipwire_show_declared_value', true );&nbsp;</div></li><li><div>      $show_dimensions = apply_filters( 'wpsc_shipwire_show_dimensions', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $products as $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $product-&gt;no_shipping )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $xml .= '&lt;Item num=&quot;' . $num . '&quot;&gt;';&nbsp;</div></li><li><div>          $xml .='&lt;Code&gt;' . get_post_meta( $product-&gt;prodid, '_wpsc_sku', true ) . '&lt;/Code&gt;';&nbsp;</div></li><li><div>          $xml .= '&lt;Quantity&gt;' . $product-&gt;quantity . '&lt;/Quantity&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $show_dimensions ) {&nbsp;</div></li><li><div>              $dimensions = self::get_dimensions( $product-&gt;prodid );&nbsp;</div></li><li><div>              $xml .= '&lt;Length&gt;' . $dimensions['length'] . '&lt;/Length&gt;';&nbsp;</div></li><li><div>              $xml .= '&lt;Width&gt;' . $dimensions['width'] . '&lt;/Width&gt;';&nbsp;</div></li><li><div>              $xml .= '&lt;Height&gt;' . $dimensions['height'] . '&lt;/Height&gt;';&nbsp;</div></li><li><div>              $xml .= '&lt;Weight&gt;' . $dimensions['weight'] . '&lt;/Weight&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $show_declared_value )&nbsp;</div></li><li><div>              $xml .= '&lt;DeclaredValue&gt;' . $product-&gt;price . '&lt;/DeclaredValue&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $xml .= '&lt;/Item&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $num++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml .='&lt;/Order&gt;';&nbsp;</div></li><li><div>      $xml .='&lt;/OrderList&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'get_order_xml', $xml, $log_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns shipping string for order XML file.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $log_id</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Shipwire-ready shipping code</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_shipping( $log_id ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping_option = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT shipping_option FROM &quot; . WPSC_TABLE_PURCHASE_LOGS . &quot; WHERE id = %d&quot;, $log_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return convert_service_to_code( $shipping_option );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Shipwire requires dimensions to be in inches and pounds.  This handles the conversion process, if one is required.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $product_id</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $dimensions</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_dimensions( $product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_meta = get_post_meta( $product_id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>      $original_dimensions = $product_meta['dimensions'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $dimensions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $dimensions['weight'] = ( 'pound' == $original_dimensions['weight_unit'] ) ? $original_dimensions['weight'] : wpsc_convert_weight( $original_dimensions['weight'], $original_dimensions['weight_unit'] );&nbsp;</div></li><li><div>      $dimensions['length'] = ( 'in' == $original_dimensions['length_unit'] ) ? $original_dimensions['length'] : $this-&gt;convert_dimensions( $original_dimensions['length'], $original_dimensions['length_unit'] );&nbsp;</div></li><li><div>      $dimensions['width'] = ( 'in' == $original_dimensions['width_unit'] ) ? $original_dimensions['width'] : $this-&gt;convert_dimensions( $original_dimensions['width'], $original_dimensions['width_unit'] );&nbsp;</div></li><li><div>      $dimensions['height'] = ( 'in' == $original_dimensions['height_unit'] ) ? $original_dimensions['height'] : $this-&gt;convert_dimensions( $original_dimensions['height'], $original_dimensions['height_unit'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $dimensions;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The wpsc_convert_weight function essentially converts weights to grams (based on input parameters).  Then converts grams to output unit.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * We do the same in this method, but for dimensions rather than weight, using centimeters as the base.  This is used if dimensions are sent to Shipwire</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param float $measurement_in</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $unit_in</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $unit_out</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $raw</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return float $dimension</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function convert_dimensions( $measurement_in, $unit_in, $unit_out = 'inch', $raw = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $unit_in ) {&nbsp;</div></li><li><div>          case 'meter':&nbsp;</div></li><li><div>              $intermediate_dimension = $measurement_in / 100;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'cm':&nbsp;</div></li><li><div>              $intermediate_dimension = $measurement_in;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'in':&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $intermediate_dimension = $measurement_in * 2.54;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $unit_out ) {&nbsp;</div></li><li><div>          case 'meter':&nbsp;</div></li><li><div>              $dimension = $intermediate_dimension * 100;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'cm':&nbsp;</div></li><li><div>              $dimension = $intermediate_dimension;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'inch':&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $dimension = $intermediate_dimension / 2.54;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $raw )&nbsp;</div></li><li><div>          return $dimension;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return round( $dimension, 2 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sends API request for Order API</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $xml</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function send_order_request( $xml ) {&nbsp;</div></li><li><div>      return self::_api_request_handler( 'FulfillmentServices.php', 'OrderListXML', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hooks into to checkout process. Sends order to shipwire on successful checkout</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $object</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $sessionid</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $display</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function shipwire_on_checkout( $purchase_log_object, $sessionid, $display ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      self::process_order_request( $purchase_log_object-&gt;get( 'id' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Processes Order Request</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Grabs XML via self::get_order_xml( $log_id ).  Sends through to Shipwire via self::send_order_request( $xml ).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $log_id</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function process_order_request( $log_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order_info = self::get_order_xml( $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::send_order_request( $order_info );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Builds XML API request for Inventory API</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() Ability to query inventory from specific warehouse on 'wpsc_shipwire_inventory_warehouse'</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() 'get_inventory_xml' filters final XML</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $xml</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_inventory_xml( $product_code = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;InventoryUpdate&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;EmailAddress&gt;' . self::$email . '&lt;/EmailAddress&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Password&gt;' . self::$passwd . '&lt;/Password&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Server&gt;' . self::$server . '&lt;/Server&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== ( $warehouse = apply_filters( 'wpsc_shipwire_inventory_warehouse', false ) ) )&nbsp;</div></li><li><div>          $xml .= '&lt;Warehouse&gt;' . $warehouse . '&lt;/Warehouse&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml .= '&lt;ProductCode&gt;' . $product_code . '&lt;/ProductCode&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;/InventoryUpdate&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'get_inventory_xml', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sends API request for Inventory API</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $xml</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function send_inventory_request( $xml ) {&nbsp;</div></li><li><div>      return self::_api_request_handler( 'InventoryServices.php', 'InventoryUpdateXML', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Builds XML API request for Tracking API</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() 'wpsc_shipwire_tracking_bookmark' filters tracking bookmark</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() 'get_tracking_xml' filters final XML</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $xml</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_tracking_xml() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $xml = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;TrackingUpdate&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;EmailAddress&gt;' . self::$email . '&lt;/EmailAddress&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Password&gt;' . self::$passwd . '&lt;/Password&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Server&gt;' . self::$server . '&lt;/Server&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Bookmark&gt;' . apply_filters( 'wpsc_shipwire_tracking_bookmark', '1' ) .'&lt;/Bookmark&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;/TrackingUpdate&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'get_tracking_xml', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sends API request for Tracking API</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $xml</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function send_tracking_request( $xml ) {&nbsp;</div></li><li><div>      return self::_api_request_handler( 'TrackingServices.php', 'TrackingUpdateXML', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Builds XML API request for Shipping Rates API</span>&nbsp;</div></li><li><div><span class="comment">   *      *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters - filters XML on return</span>&nbsp;</div></li><li><div><span class="comment">   * @todo Get ZIP as transient when #437 is complete</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $xml</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_shipping_xml() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpsc_cart;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $zip = wpsc_get_customer_meta( 'shipping_zip' );&nbsp;</div></li><li><div>      $state = wpsc_get_state_by_id( $wpsc_cart-&gt;delivery_region, 'code' );&nbsp;</div></li><li><div>      $country = $wpsc_cart-&gt;delivery_country;&nbsp;</div></li><li><div>      $products = $wpsc_cart-&gt;cart_items;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $products_xml = '';&nbsp;</div></li><li><div>      $num = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count ( $products ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $products as $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $product-&gt;uses_shipping )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $products_xml .= '&lt;Item num=&quot;' . $num . '&quot;&gt;';&nbsp;</div></li><li><div>              $products_xml .= '&lt;Code&gt;' . wpsc_esc_xml( $product-&gt;sku ) . '&lt;/Code&gt;';&nbsp;</div></li><li><div>              $products_xml .= '&lt;Quantity&gt;' . wpsc_esc_xml( $product-&gt;quantity ) . '&lt;/Quantity&gt;';&nbsp;</div></li><li><div>              $products_xml .= '&lt;/Item&gt;';&nbsp;</div></li><li><div>              $num++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $products_xml ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>       $xml = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;RateRequest&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Username&gt;' . wpsc_esc_xml( self::$email ) . '&lt;/Username&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Password&gt;' . wpsc_esc_xml( self::$passwd ) . '&lt;/Password&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Order&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;AddressInfo type=&quot;ship&quot;&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;State&gt;' . wpsc_esc_xml( $state ) . '&lt;/State&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Country&gt;' . wpsc_esc_xml( $country ) . '&lt;/Country&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;Zip&gt;' . wpsc_esc_xml( $zip ) . '&lt;/Zip&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;/AddressInfo&gt;';&nbsp;</div></li><li><div>      $xml .= $products_xml;&nbsp;</div></li><li><div>      $xml .='&lt;/Order&gt;';&nbsp;</div></li><li><div>      $xml .= '&lt;/RateRequest&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'get_shipping_xml', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sends API request for Shipping Rates API</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $xml</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function send_shipping_request( $xml ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::_api_request_handler( 'RateServices.php', 'RateRequestXML', $xml );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates cache key for current cart and ZIP code for shipping rates.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cache_key() {&nbsp;</div></li><li><div>      global $wpsc_cart;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_object( $wpsc_cart ) || empty( $wpsc_cart-&gt;cart_items ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cached_object = array();&nbsp;</div></li><li><div>      $products = $wpsc_cart-&gt;cart_items;&nbsp;</div></li><li><div>      $zip = wpsc_get_customer_meta( 'shipping_zip' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $num = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $products as $product ) {&nbsp;</div></li><li><div>          if ( ! $product-&gt;uses_shipping )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $cached_object['products'][$num]['sku'] = $product-&gt;sku;&nbsp;</div></li><li><div>          $cached_object['products'][$num]['qty'] = $product-&gt;quantity;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $num++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cached_object['zip'] = $zip;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return 'rates_' . hash( 'md5', json_encode( $cached_object ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns XML Response from Shipwire API for Shipping Quotes</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, false on no shipping, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_shipping_quotes() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Returns false if no products in cart</span>&nbsp;</div></li><li><div>      if ( ! self::get_shipping_xml() )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cache_key = self::get_cache_key();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//Returns live shipping request if no cached response exists, cached response if one does</span>&nbsp;</div></li><li><div>      if ( false === ( $rates = get_transient( $cache_key ) ) )&nbsp;</div></li><li><div>          $rates = self::fetch_fresh_quotes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $rates;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * WordPress has some notable deficiencies when storing object data in the database.</span>&nbsp;</div></li><li><div><span class="comment">   * It's generally inadvisable anyways - so we convert the shipping quote object into a simple array.</span>&nbsp;</div></li><li><div><span class="comment">   * After that, we store the array as the quote in a transient.  Transient is stored for one hour - the expiration is filterable</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses simplexml_load_string()</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() 'wpsc_shipwire_methods' filters the methods returns - the $methods array and $quotes object are both passed to the filter</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() 'wpsc_shipwire_rates_cache_expiration' filters the expiration for the transient, defaults to one hour</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function fetch_fresh_quotes() {&nbsp;</div></li><li><div>      $quotes = self::send_shipping_request( self::get_shipping_xml() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $quotes = $quotes ? simplexml_load_string( $quotes ) : false;&nbsp;</div></li><li><div>      $methods = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $quotes = is_object( $quotes ) && isset( $quotes-&gt;Order )  ? $quotes-&gt;Order  : $methods;&nbsp;</div></li><li><div>      $quotes = is_object( $quotes ) && isset( $quotes-&gt;Quotes ) ? $quotes-&gt;Quotes : $methods;&nbsp;</div></li><li><div>      $quotes = is_object( $quotes ) && isset( $quotes-&gt;Quote )  ? $quotes-&gt;Quote  : $methods;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_object( $quotes ) )&nbsp;</div></li><li><div>          return $methods;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $quotes as $quote ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $service = (string) $quote['method'];&nbsp;</div></li><li><div>          $service = convert_code_to_service( $service );&nbsp;</div></li><li><div>          $cost = (string) $quote-&gt;Cost;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $methods[$service] = $cost;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $methods = apply_filters( 'wpsc_shipwire_methods', $methods, $quotes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_transient( self::get_cache_key(), $methods, apply_filters( 'wpsc_shipwire_rates_cache_expiration', 60 * 60 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $methods;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * AJAX Handler for sync products link in shipping admin</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Pings Shipwire server to get real-time inventory and tracking information for products</span>&nbsp;</div></li><li><div><span class="comment">   * Processes results by updating inventory on-site for each product</span>&nbsp;</div></li><li><div><span class="comment">   * Updates tracking numbers for each purchase log with one of the numbers presented (sometimes multiples are presented).</span>&nbsp;</div></li><li><div><span class="comment">   * We need to figure out a good UX for multiple tracking numbers. Could potentially update the notes, but that feels janky.</span>&nbsp;</div></li><li><div><span class="comment">   * Also emails customer with tracking ID.  Email attempts to work out multiple tracking numbers</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses do_action() Calls 'wpsc_shipwire_pre_sync' on the $tracking and $inventory variables before database interaction</span>&nbsp;</div></li><li><div><span class="comment">   * @uses do_action() Calls 'wpsc_shipwire_post_sync' on the $tracking and $inventory variables after database interaction</span>&nbsp;</div></li><li><div><span class="comment">   * @uses apply_filters() Calls 'wpsc_shipwire_send_tracking_email' on the $order_id and $tracking_numbers arrays - a bool switch for sending the tracking email</span>&nbsp;</div></li><li><div><span class="comment">   * @global $wpdb</span>&nbsp;</div></li><li><div><span class="comment">   * @todo Use WPSC_Purchase_Log class to update tracking information</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return json Number of rows updated by each method</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function sync_products( $product_code = '' ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined ( 'DOING_AJAX' ) && DOING_AJAX ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::set_posted_properties();&nbsp;</div></li><li><div>          if ( ! _wpsc_ajax_verify_nonce( 'shipping_module_settings_form' ) ) {&nbsp;</div></li><li><div>              die( __( 'Session expired. Try refreshing your Shipping Settings page.', 'wpsc' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// A bit tricky here - as we'd like this method available for all processes, not just AJAX, we have the product_code variable.</span>&nbsp;</div></li><li><div>          <span class="comment">// That variable will be set to the $_REQUEST['action'] from the AJAX handler.  Resetting the $product_code to empty fixes the issue.</span>&nbsp;</div></li><li><div>          <span class="comment">// There may certainly be better ways to do this.</span>&nbsp;</div></li><li><div>          $product_code = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_code = isset( $_POST['product_code'] ) ? $_POST['product_code'] : $product_code;&nbsp;</div></li><li><div>      $tracking = self::get_tracking_info();&nbsp;</div></li><li><div>      $inventory = self::get_inventory_info( $product_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wpsc_shipwire_pre_sync', $tracking, $inventory );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tracking_updates = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $tracking as $order_id =&gt; $tracking_number ) {&nbsp;</div></li><li><div>          $tracking_numbers = array_keys( $tracking_number );&nbsp;</div></li><li><div>          $update = (int) $wpdb-&gt;update(&nbsp;</div></li><li><div>                  WPSC_TABLE_PURCHASE_LOGS, &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'track_id' =&gt; $tracking_numbers[0]&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  array(&nbsp;</div></li><li><div>                      'id' =&gt; $order_id&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  '%s', &nbsp;</div></li><li><div>                  '%d'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tracking_updates += $update;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( apply_filters( 'wpsc_shipwire_send_tracking_email', true, $order_id, $tracking_number ) && $update )&nbsp;</div></li><li><div>              self::_send_tracking_email( $order_id, $tracking_number );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inventory_updates = 0;&nbsp;</div></li><li><div>      $product_ids = array();&nbsp;</div></li><li><div>      $queries = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $inventory as $sku =&gt; $qty ) {&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare( &quot;SELECT post_id FROM $wpdb-&gt;postmeta WHERE meta_key = '_wpsc_sku' AND meta_value = %s&quot;, $sku );&nbsp;</div></li><li><div>          $queries[] = $sql;&nbsp;</div></li><li><div>          $synced_product_ids = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>          foreach ( $synced_product_ids as $product_id ) {&nbsp;</div></li><li><div>              $product = get_post( $product_id );&nbsp;</div></li><li><div>              if ( ! $product-&gt;post_status == 'publish' )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              $product_ids[] = $product_id;&nbsp;</div></li><li><div>              $inventory_updates += (int) update_post_meta( $product_id, '_wpsc_stock', $qty );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wpsc_shipwire_post_sync', $tracking, $inventory );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sync_response = array(&nbsp;</div></li><li><div>                          'tracking' =&gt; sprintf( _n( 'Shipwire updated %d tracking number.', 'Shipwire updated %d tracking numbers.', $tracking_updates, 'wpsc' ), $tracking_updates ), &nbsp;</div></li><li><div>                          'inventory' =&gt; sprintf( _n( 'Shipwire updated inventory on %d product.', 'Shipwire updated inventory on %d products.', $inventory_updates, 'wpsc' ), $inventory_updates ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined ( 'DOING_AJAX' ) && DOING_AJAX )&nbsp;</div></li><li><div>          die( json_encode( $sync_response ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $sync_response;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Essentially copies functionality from wpsc_purchase_log_send_tracking_email().</span>&nbsp;</div></li><li><div><span class="comment">   * We should consider making &quot;AJAX&quot; functions like that process-agnostic.  Would be great to be able to utilize it from here.</span>&nbsp;</div></li><li><div><span class="comment">   * A simple DOING_AJAX check for the nonces and die() and adding a parameter to the function to check before the $_POST would suffice.</span>&nbsp;</div></li><li><div><span class="comment">   * Making private, primarily because I'd prefer this not to be used, even internally, pending AJAX refactor as suggested</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @global $wpdb</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $tracking_numbers Expects the $tracking_number object from self::get_tracking_info()</span>&nbsp;</div></li><li><div><span class="comment">   * @todo Use new Notification class from Issue 490 when that is implemented</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool Whether or not the email was sent successfully</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function _send_tracking_email( $order_id, $tracking_number = '' ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = absint( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tracking_numbers = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $tracking_number as $tn =&gt; $array ) {&nbsp;</div></li><li><div>          $tracking_numbers[] = '&lt;a href=&quot;' .  esc_url( $array['link'] ) . '&quot;&gt;' . esc_html( $tn ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tracking_numbers = implode( '&lt;br /&gt;', $tracking_numbers );&nbsp;</div></li><li><div>      $site_name = get_option( 'blogname' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $message = nl2br( get_option( 'wpsc_trackingid_message' ) );&nbsp;</div></li><li><div>      $message = str_replace( '%trackid%', $tracking_numbers, $message );&nbsp;</div></li><li><div>      $message = str_replace( '%shop_name%', $site_name, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $email_form_field = $wpdb-&gt;get_var( &quot;SELECT `id` FROM `&quot; . WPSC_TABLE_CHECKOUT_FORMS . &quot;` WHERE `type` IN ('email') AND `active` = '1' ORDER BY `checkout_order` ASC LIMIT 1&quot; );&nbsp;</div></li><li><div>      $email = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT `value` FROM `&quot; . WPSC_TABLE_SUBMITTED_FORM_DATA . &quot;` WHERE `log_id` = %d AND `form_id` = %d LIMIT 1&quot;, $id, $email_form_field ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subject = get_option( 'wpsc_trackingid_subject' );&nbsp;</div></li><li><div>      $subject = str_replace( '%shop_name%', $site_name, $subject );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'wp_mail_from', 'wpsc_replace_reply_address', 0 );&nbsp;</div></li><li><div>      add_filter( 'wp_mail_from_name', 'wpsc_replace_reply_name', 0 );&nbsp;</div></li><li><div>      add_filter( 'wp_mail_content_type', array( __CLASS__, 'tracking_email_html' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $send = wp_mail( $email, $subject, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_filter( 'wp_mail_from', 'wpsc_replace_reply_address', 0 );&nbsp;</div></li><li><div>      remove_filter( 'wp_mail_from_name', 'wpsc_replace_reply_name', 0 );&nbsp;</div></li><li><div>      remove_filter( 'wp_mail_content_type', array( __CLASS__, 'tracking_email_html' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $send;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Changes content type of email to HTML for sending tracking email</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function tracking_email_html() {&nbsp;</div></li><li><div>      return &quot;text/html&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gathers tracking info from Shipwire API.  Called primarily from sync product link.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Some interesting stuff happening here - Shipwire can send multiple tracking numbers per order, so we add them to an array, along with other potentially helpful information for plugins to use</span>&nbsp;</div></li><li><div><span class="comment">   * The multiple tracking numbers does introduce a reality we should address - we need to be able to support multiple numbers in our UX.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $orders</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_tracking_info() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tracking = simplexml_load_string( self::send_tracking_request( self::get_tracking_xml() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $orders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $tracking-&gt;children() as $key =&gt; $order ) {&nbsp;</div></li><li><div>          if ( 'Order' != $key )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty ( $order-&gt;TrackingNumber ) ) {&nbsp;</div></li><li><div>              $id = absint( $order['id'] );&nbsp;</div></li><li><div>              $tn = (string) $order-&gt;TrackingNumber;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $orders[$id][$tn]['link'] = (string) $order['href'];&nbsp;</div></li><li><div>              $orders[$id][$tn]['expected_delivery_date'] = (string) $order['expectedDeliveryDate'];&nbsp;</div></li><li><div>              $orders[$id][$tn]['ship_date'] = (string) $order['shipDate'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $orders;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets updated inventory information from Shipwire.  Returns array of name-value pairs where the name is the SKU, value is quantity</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $product_code</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return array $products</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_inventory_info( $product_code = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inventory = simplexml_load_string( self::send_inventory_request( self::get_inventory_xml( $product_code ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $inventory-&gt;children() as $key =&gt; $product ) {&nbsp;</div></li><li><div>          if ( 'Product' != $key )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $qty = absint( $product['good'] );&nbsp;</div></li><li><div>              $code = (string) $product['code'] ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $products[$code] = $qty;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $products;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * API Request Handler.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Sets content type to urlencoded form, sslverify to false (due to SSL cert issues on many setups) and timeout to 30 (more than sufficient for the most laborious API, Shipping Rates)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $url</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $method</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $body</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed - false on WP_Error, XML response on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function _api_request_handler( $url, $method, $body ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $url = esc_url_raw( self::$endpoint . $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>              'body' =&gt; array( $method =&gt; trim( $body ) ), &nbsp;</div></li><li><div>              'headers' =&gt; array(&nbsp;</div></li><li><div>                              'accept' =&gt; 'application/xml', &nbsp;</div></li><li><div>                              'content-type' =&gt; 'application/x-www-form-urlencoded'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              'sslverify' =&gt; false, &nbsp;</div></li><li><div>              'timeout' =&gt; 30&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $request = wp_remote_post( $url, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $request ) )&nbsp;</div></li><li><div>          return $request['body'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'init', array( 'WPSC_Shipwire', 'get_instance' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handy little XML escaping function.  Used primarily in shipping rate XML request.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $value</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_esc_xml( $value ) {&nbsp;</div></li><li><div>  return '&lt;![CDATA[' . esc_html( $value ) . ']]&gt;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Helper function for getting services to the front-end from codes.  Actual carriers are irrelevant, as that can change based on cost, availability, etc.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $service</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function convert_code_to_service( $service ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $service ) :&nbsp;</div></li><li><div>      case 'GD' :&nbsp;</div></li><li><div>          $service = _x( 'Ground', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '1D' :&nbsp;</div></li><li><div>          $service = _x( 'One-Day Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case '2D' :&nbsp;</div></li><li><div>          $service = _x( 'Two-Day Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'INTL' :&nbsp;</div></li><li><div>          $service = _x( 'Standard Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'FT' :&nbsp;</div></li><li><div>          $service = _x( 'Freight Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'E-INTL' :&nbsp;</div></li><li><div>          $service = _x( 'Economy Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'PL-INTL' :&nbsp;</div></li><li><div>          $service = _x( 'Plus Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case 'PM-INTL' :&nbsp;</div></li><li><div>          $service = _x( 'Premium Shipping', 'shipwire shipping method', 'wpsc' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      endswitch;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $service;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Helper function for getting codes to the API from services.  Actual carriers are irrelevant, as that can change based on cost, availability, etc.</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $service</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function convert_service_to_code( $service ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $service ) :&nbsp;</div></li><li><div>      case _x( 'Ground', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = 'GD';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'One-Day Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = '1D';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'Two-Day Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = '2D';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'Standard Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = 'INTL';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'Freight Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = 'FT';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'Economy Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = 'E-INTL';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'Plus Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = 'PL-INTL';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      case _x( 'Premium Shipping', 'shipwire shipping method', 'wpsc' ) :&nbsp;</div></li><li><div>          $service = 'PM-INTL';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      endswitch;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $service;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>