<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27517"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-components-theme-engine-v1-helpers-template-tags | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.15"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=983a084e3d5b1751698a3f934e220d37' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.15' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-components-theme-engine-v1-helpers-template-tags/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-helpers-template-tags%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-helpers-template-tags%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-components-theme-engine-v1-helpers-template-tags","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-components-theme-engine-v1-helpers-template-tags" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-components-theme-engine-&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-components/theme-engine-v1/helpers/template-tags.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc display products function</span>&nbsp;</div></li><li><div><span class="comment"> * Used to determine whether to display products on the page</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true for yes, false for no</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_display_products() {&nbsp;</div></li><li><div>  $post = get_queried_object();&nbsp;</div></li><li><div>  $product_page_id = wpsc_get_the_post_id_by_shortcode('[productspage]');&nbsp;</div></li><li><div>  <span class="comment">//we have to display something, if we are not displaying categories, then we must display products</span>&nbsp;</div></li><li><div>  $output = true;&nbsp;</div></li><li><div>  if ( wpsc_display_categories () && isset ( $post-&gt;ID ) ) {&nbsp;</div></li><li><div>      if ( get_option( 'wpsc_default_category' ) == 'list' && $post-&gt;ID == $product_page_id )&nbsp;</div></li><li><div>          $output = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['range'] ) || isset( $_GET['category'] ) )&nbsp;</div></li><li><div>          $output = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *     is single product function, determines if we are viewing a single product</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true, or false...</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_is_single_product() {&nbsp;</div></li><li><div>  return is_single() && get_post_type() == 'wpsc-product';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * category class function, categories can have a specific class, this gets that</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the class of the selected category</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_category_class() {&nbsp;</div></li><li><div>  global $wpdb, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $category_nice_name = '';&nbsp;</div></li><li><div>  if ( 'wpsc_product_category' == $wp_query-&gt;query_vars['taxonomy'] ) {&nbsp;</div></li><li><div>      $catid = wpsc_get_the_category_id($wp_query-&gt;query_vars['term'], 'slug');&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $catid = get_option( 'wpsc_default_category' );&nbsp;</div></li><li><div>      if ( $catid == 'all+list' ) {&nbsp;</div></li><li><div>          $catid = 'all';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( (int)$catid &gt; 0 ) {&nbsp;</div></li><li><div>      $term = get_term($catid, 'wpsc_product_category');&nbsp;</div></li><li><div>      $category_nice_name = $term-&gt;slug;&nbsp;</div></li><li><div>  }else if ( $catid == 'all' ) {&nbsp;</div></li><li><div>      $category_nice_name = 'all-categories';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>  return $category_nice_name;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * category transition function, finds the transition between categories</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the class of the selected category</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_current_category_name() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  $term_data = get_term( $wp_query-&gt;post-&gt;term_id, 'wpsc_product_category' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $term_data-&gt;name;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * category transition function, finds the transition between categories</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the class of the selected category</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_category_transition() {&nbsp;</div></li><li><div>  <span class="comment">//removed because it was not working in 3.8 RC2 see first changest after</span>&nbsp;</div></li><li><div>  <span class="comment">//http://plugins.trac.wordpress.org/changeset/357529/wp-e-commerce/</span>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc show fb like function, check whether to show facebook like</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean true if option is on, otherwise, false</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_show_fb_like() {&nbsp;</div></li><li><div>  if('on' == get_option('wpsc_facebook_like'))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc have products function, the product loop</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean true while we have products, otherwise, false</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_have_products() {&nbsp;</div></li><li><div>  return have_posts();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the product function, gets the next product, </span>&nbsp;</div></li><li><div><span class="comment"> * @return nothing</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product() {&nbsp;</div></li><li><div>  global $wpsc_custom_meta, $wpsc_variations;&nbsp;</div></li><li><div>  the_post();&nbsp;</div></li><li><div>  $wpsc_custom_meta = new wpsc_custom_meta( get_the_ID() );&nbsp;</div></li><li><div>  $wpsc_variations = new wpsc_variations( get_the_ID() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the product id function, </span>&nbsp;</div></li><li><div><span class="comment"> * @return integer - the product ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_id() {&nbsp;</div></li><li><div>  return get_the_ID();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc edit the product link function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - a link to edit this product</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_edit_the_product_link( $link = null, $before = '', $after = '', $id = 0 ) {&nbsp;</div></li><li><div>  global $wpsc_query, $current_user, $table_prefix, $wp_query;&nbsp;</div></li><li><div>  if ( $link == null )&nbsp;</div></li><li><div>      $link = __( 'Edit', 'wpsc' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_id = $wp_query-&gt;post-&gt;ID;&nbsp;</div></li><li><div>  if ( $id &gt; 0 )&nbsp;</div></li><li><div>      $product_id = $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  if(is_user_logged_in()) {&nbsp;</div></li><li><div>      get_currentuserinfo();&nbsp;</div></li><li><div>      if ( $current_user-&gt;{$table_prefix . 'capabilities'}['administrator'] == 1 )&nbsp;</div></li><li><div>          $output = $before . '&lt;a class=&quot;wpsc_edit_product&quot; href=&quot;' . esc_attr( get_edit_post_link( $product_id ) ) . '&quot;&gt;' . $link . '&lt;/a&gt;' . $after;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the product title function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product title</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_title( $post = 0 ) {&nbsp;</div></li><li><div>  return get_the_title( $post );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product description function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product description</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_description() {&nbsp;</div></li><li><div>  $content = get_the_content( __( 'Read the rest of this entry &raquo;', 'wpsc' ) );&nbsp;</div></li><li><div>  return do_shortcode( wpautop( $content, 1 ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc additional product description function</span>&nbsp;</div></li><li><div><span class="comment"> * TODO make this work with the tabbed multiple product descriptions, may require another loop</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the additional description</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_additional_description() {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !empty( $post-&gt;post_excerpt ) )&nbsp;</div></li><li><div>      return $post-&gt;post_excerpt;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product permalink function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the URL to the single product page for this product</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_permalink() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  return get_permalink();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc external link function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_external_link( $id = null ) {&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ( $id &gt; 0 ) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( isset( $product_meta['external_link'] ) ) {&nbsp;</div></li><li><div>      $external_link = $product_meta['external_link'];&nbsp;</div></li><li><div>      return esc_url( $external_link );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc external link text function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product external link text</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_external_link_text( $id = null, $default = null ) {&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ( $id &gt; 0 ) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $external_link_text = __( 'Buy Now', 'wpsc' );&nbsp;</div></li><li><div>  if ( $default != null ) {&nbsp;</div></li><li><div>      $external_link_text = $default;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( isset( $product_meta['external_link_text'] ) && !empty( $product_meta['external_link_text'] ) ) {&nbsp;</div></li><li><div>      $external_link_text = $product_meta['external_link_text'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return esc_html( $external_link_text );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc external link target function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product external link target</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_external_link_target( $id = null, $external_link_target = '' ) {&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ( $id &gt; 0 ) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( isset( $product_meta['external_link_target'] ) && !empty( $product_meta['external_link_target'] ) ) {&nbsp;</div></li><li><div>      $external_link_target = $product_meta['external_link_target'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return esc_attr( $external_link_target );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product sku function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_sku( $id = null ) {&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ( $id &gt; 0 ) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_sku = get_post_meta( $id, '_wpsc_sku', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return esc_attr( $product_sku );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_has_pages_top() {if(wpsc_has_pages() &&  ((get_option('wpsc_page_number_position') == 1) || (get_option('wpsc_page_number_position') == 3)))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_has_pages_bottom() {&nbsp;</div></li><li><div>  if(wpsc_has_pages() &&  ((get_option('wpsc_page_number_position') == 2) || (get_option('wpsc_page_number_position') == 3)))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Used in wpsc_pagination to generate the links in pagination</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $page int</span>&nbsp;</div></li><li><div><span class="comment"> * @return $output string, url</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_a_page_url($page=null) {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  $curpage = $wp_query-&gt;query_vars['paged'];&nbsp;</div></li><li><div>  if($page != '')&nbsp;</div></li><li><div>      $wp_query-&gt;query_vars['paged'] = $page;&nbsp;</div></li><li><div>  if($wp_query-&gt;is_single === true) {&nbsp;</div></li><li><div>      $wp_query-&gt;query_vars['paged'] = $curpage;&nbsp;</div></li><li><div>      return get_permalink($wp_query-&gt;post-&gt;ID);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if( 1 &lt; $wp_query-&gt;query_vars['paged']) {&nbsp;</div></li><li><div>          if(get_option('permalink_structure'))&nbsp;</div></li><li><div>              $output .= &quot;paged/{$wp_query-&gt;query_vars['paged']}/&quot;;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $output = add_query_arg('paged', '', $output);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  return esc_url( $output );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_pagination generates and returns the urls for pagination</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $totalpages (INT) Number of pages, </span>&nbsp;</div></li><li><div><span class="comment"> * @param $per_page (INT) Number of products per page</span>&nbsp;</div></li><li><div><span class="comment"> * @param $current_page (INT) Current Product page number</span>&nbsp;</div></li><li><div><span class="comment"> * @param $page_link (STRING) URL of Page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_pagination( $totalpages = '', $per_page = '', $current_page = '', $page_link = '' ) {&nbsp;</div></li><li><div>  global $wp_query, $wpsc_query, $wp_the_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $num_paged_links = 4; <span class="comment">//amount of links to show on either side of current page</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $additional_links = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//additional links, items per page and products order</span>&nbsp;</div></li><li><div>  if( get_option('permalink_structure') != '' ) {&nbsp;</div></li><li><div>      $additional_links_separator = '?';&nbsp;</div></li><li><div>  }else{&nbsp;</div></li><li><div>      $additional_links_separator = '&';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if( !empty( $_GET['items_per_page'] ) ) {&nbsp;</div></li><li><div>          $additional_links = $additional_links_separator . 'items_per_page=' . $_GET['items_per_page'];&nbsp;</div></li><li><div>          $additional_links_separator = '&';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if( !empty( $_GET['product_order'] ) )&nbsp;</div></li><li><div>      $additional_links .= $additional_links_separator . 'product_order=' . $_GET['product_order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $_GET['range'] ) )&nbsp;</div></li><li><div>      $additional_links .= $additional_links_separator . 'range=' . $_GET['range'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $additional_links = apply_filters('wpsc_pagination_additional_links', $additional_links);&nbsp;</div></li><li><div>  <span class="comment">//end of additional links</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($totalpages)) {&nbsp;</div></li><li><div>          $totalpages = $wp_query-&gt;max_num_pages;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if(empty($per_page))&nbsp;</div></li><li><div>      $per_page = (int)get_option('wpsc_products_per_page');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $current_page = absint( get_query_var('paged') );&nbsp;</div></li><li><div>  if($current_page == 0)&nbsp;</div></li><li><div>      $current_page = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(empty($page_link))&nbsp;</div></li><li><div>      $page_link = wpsc_a_page_url();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if there is no pagination</span>&nbsp;</div></li><li><div>  if(!get_option('permalink_structure')) {&nbsp;</div></li><li><div>      $category = '?';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! empty( $wp_query-&gt;query_vars['wpsc_product_category'] ) )&nbsp;</div></li><li><div>          $category = '?wpsc_product_category='.$wp_query-&gt;query_vars['wpsc_product_category'];&nbsp;</div></li><li><div>      if(isset($wp_query-&gt;query_vars['wpsc_product_category']) && is_string($wp_query-&gt;query_vars['wpsc_product_category'])) {&nbsp;</div></li><li><div>          $page_link = get_option('blogurl').$category.'&amp;paged';&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $page_link = get_option('product_list_url').$category.'&amp;paged';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $separator = '=';&nbsp;</div></li><li><div>  }else{&nbsp;</div></li><li><div>      global $wpsc_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $separator = 'page/';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $wp_query-&gt;query_vars['wpsc_product_category'] ) ) {&nbsp;</div></li><li><div>          $category_id = get_term_by( 'slug', $wp_query-&gt;query_vars['wpsc_product_category'], 'wpsc_product_category' );&nbsp;</div></li><li><div>          $page_link = trailingslashit( get_term_link( $category_id, 'wpsc_product_category' ) );&nbsp;</div></li><li><div>          <span class="comment">// in case we're displaying a category using shortcode, need to use the page's URL instead of the taxonomy URL</span>&nbsp;</div></li><li><div>          if ( $wp_the_query-&gt;is_page() ) {&nbsp;</div></li><li><div>              $page = $wp_the_query-&gt;get_queried_object();&nbsp;</div></li><li><div>              if ( preg_match( '/\[wpsc\_products[^\]]*category_id=/', $page-&gt;post_content ) ) {&nbsp;</div></li><li><div>                  $page_link = trailingslashit( get_permalink( $page-&gt;ID ) );&nbsp;</div></li><li><div>                  $separator = '';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( is_tax( 'product_tag' ) ) {&nbsp;</div></li><li><div>          $tag = get_queried_object();&nbsp;</div></li><li><div>          $page_link = trailingslashit( get_term_link( (int) $tag-&gt;term_id, 'product_tag' ) );&nbsp;</div></li><li><div>      } elseif ( $wpsc_query-&gt;is_front_page() ) {&nbsp;</div></li><li><div>          $page_link = trailingslashit( home_url() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $page_link = trailingslashit( get_option( 'product_list_url' ) );&nbsp;</div></li><li><div>          $separator = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If there's only one page, return now and don't bother</span>&nbsp;</div></li><li><div>  if($totalpages == 1)&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  <span class="comment">// Pagination Prefix</span>&nbsp;</div></li><li><div>  $output = __('Pages: ', 'wpsc');&nbsp;</div></li><li><div>  if(get_option('permalink_structure')) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Should we show the FIRST PAGE link?</span></span>&nbsp;</div></li><li><div>      if($current_page &gt; 1)&nbsp;</div></li><li><div>          $output .= &quot;&lt;a href=\&quot;&quot;. esc_url( $page_link . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . __('First Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('&laquo; First', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Should we show the PREVIOUS PAGE link?</span></span>&nbsp;</div></li><li><div>      if($current_page &gt; 1) {&nbsp;</div></li><li><div>          $previous_page = $current_page - 1;&nbsp;</div></li><li><div>          if( $previous_page == 1 )&nbsp;</div></li><li><div>              $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( $page_link . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . __('Previous Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('&lt; Previous', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( $page_link .$separator. $previous_page . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . __('Previous Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('&lt; Previous', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $i =$current_page - $num_paged_links;&nbsp;</div></li><li><div>      $count = 1;&nbsp;</div></li><li><div>      if($i &lt;= 0) $i =1;&nbsp;</div></li><li><div>      while($i &lt; $current_page) {&nbsp;</div></li><li><div>          if($count &lt;= $num_paged_links) {&nbsp;</div></li><li><div>              if($count == 1)&nbsp;</div></li><li><div>                  $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( $page_link . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . sprintf( __('Page %s', 'wpsc'), $i ) . &quot; \&quot;&gt;&quot;.$i.&quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( $page_link .$separator. $i . '/' . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . sprintf( __('Page %s', 'wpsc'), $i ) . &quot; \&quot;&gt;&quot;.$i.&quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $i++;&nbsp;</div></li><li><div>          $count++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Current Page Number</span></span>&nbsp;</div></li><li><div>      if($current_page &gt; 0)&nbsp;</div></li><li><div>          $output .= &quot;&lt;span class='current'&gt;$current_page&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//Links after Current Page</span></span>&nbsp;</div></li><li><div>      $i = $current_page + $num_paged_links;&nbsp;</div></li><li><div>      $count = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($current_page &lt; $totalpages) {&nbsp;</div></li><li><div>          while(($i) &gt; $current_page) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $count &lt; ( $num_paged_links + 1 ) && ( $count + $current_page ) &lt;= $totalpages ) {&nbsp;</div></li><li><div>                      $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( $page_link . $separator . ( $count + $current_page ) . '/' . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . sprintf( __('Page %s', 'wpsc'), ($count+$current_page) ) . &quot;\&quot;&gt;&quot;.($count+$current_page).&quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $count ++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($current_page &lt; $totalpages) {&nbsp;</div></li><li><div>          $next_page = $current_page + 1;&nbsp;</div></li><li><div>          $output .= &quot;&lt;a href=\&quot;&quot;. esc_url( $page_link  .$separator. $next_page . '/' . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . __('Next Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('Next &gt;', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Should we show the LAST PAGE link?</span></span>&nbsp;</div></li><li><div>      if($current_page &lt; $totalpages) {&nbsp;</div></li><li><div>          $output .= &quot;&lt;a href=\&quot;&quot;. esc_url( $page_link  .$separator. $totalpages . '/' . $additional_links ) . &quot;\&quot; title=\&quot;&quot; . __('Last Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('Last &raquo;', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Should we show the FIRST PAGE link?</span></span>&nbsp;</div></li><li><div>      if($current_page &gt; 1)&nbsp;</div></li><li><div>          $output .= &quot;&lt;a href=\&quot;&quot;. esc_url( remove_query_arg('paged' ) ) . &quot;\&quot; title=\&quot;&quot; . __('First Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('&laquo; First', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Should we show the PREVIOUS PAGE link?</span></span>&nbsp;</div></li><li><div>      if($current_page &gt; 1) {&nbsp;</div></li><li><div>          $previous_page = $current_page - 1;&nbsp;</div></li><li><div>          if( $previous_page == 1 )&nbsp;</div></li><li><div>              $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( remove_query_arg( 'paged' ) ) . $additional_links . &quot;\&quot; title=\&quot;&quot; . __('Previous Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('&lt; Previous', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( add_query_arg( 'paged', ($current_page - 1) ) ) . $additional_links . &quot;\&quot; title=\&quot;&quot; . __('Previous Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('&lt; Previous', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $i =$current_page - $num_paged_links;&nbsp;</div></li><li><div>      $count = 1;&nbsp;</div></li><li><div>      if($i &lt;= 0) $i =1;&nbsp;</div></li><li><div>      while($i &lt; $current_page) {&nbsp;</div></li><li><div>          if($count &lt;= $num_paged_links) {&nbsp;</div></li><li><div>              if($i == 1)&nbsp;</div></li><li><div>                  $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( remove_query_arg('paged' ) ) . &quot;\&quot; title=\&quot;&quot; . sprintf( __('Page %s', 'wpsc'), $i ) . &quot; \&quot;&gt;&quot;.$i.&quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( add_query_arg('paged', $i ) ) . &quot;\&quot; title=\&quot;&quot; . sprintf( __('Page %s', 'wpsc'), $i ) . &quot; \&quot;&gt;&quot;.$i.&quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $i++;&nbsp;</div></li><li><div>          $count++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Current Page Number</span></span>&nbsp;</div></li><li><div>      if($current_page &gt; 0)&nbsp;</div></li><li><div>          $output .= &quot;&lt;span class='current'&gt;$current_page&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//Links after Current Page</span></span>&nbsp;</div></li><li><div>      $i = $current_page + $num_paged_links;&nbsp;</div></li><li><div>      $count = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($current_page &lt; $totalpages) {&nbsp;</div></li><li><div>          while(($i) &gt; $current_page) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if($count &lt; $num_paged_links && ($count+$current_page) &lt;= $totalpages) {&nbsp;</div></li><li><div>                      $output .= &quot; &lt;a href=\&quot;&quot;. esc_url( add_query_arg( 'paged', ($count+$current_page) ) ) . &quot;\&quot; title=\&quot;&quot; . sprintf( __('Page %s', 'wpsc'), ($count+$current_page) ) . &quot;\&quot;&gt;&quot;.($count+$current_page).&quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>              }else{&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $count ++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($current_page &lt; $totalpages) {&nbsp;</div></li><li><div>          $next_page = $current_page + 1;&nbsp;</div></li><li><div>          $output .= &quot;&lt;a href=\&quot;&quot;. esc_url( add_query_arg( 'paged', $next_page ) ) . &quot;\&quot; title=\&quot;&quot; . __('Next Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('Next &gt;', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Should we show the LAST PAGE link?</span></span>&nbsp;</div></li><li><div>      if($current_page &lt; $totalpages) {&nbsp;</div></li><li><div>          $output .= &quot;&lt;a href=\&quot;&quot;. esc_url( add_query_arg( 'paged', $totalpages ) ) . &quot;\&quot; title=\&quot;&quot; . __('Last Page', 'wpsc') . &quot;\&quot;&gt;&quot; . __('Last &raquo;', 'wpsc') . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Return the output.</span>&nbsp;</div></li><li><div>  echo apply_filters( 'wpsc_pagination', $output, $totalpages, $per_page, $current_page, $page_link );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_show_stock_availability</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks to see whether stock symbols need to be shown</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true is the option has been checked false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_show_stock_availability() {&nbsp;</div></li><li><div>  if( get_option('list_view_quantity') == 1 )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product image function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * if no parameters are passed, the image is not resized, otherwise it is resized to the specified dimensions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer attachment_ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer width</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer height</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product image URL, or the URL of the resized version</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_image( $attachment_id = 0, $width = null, $height = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do some dancing around the image size</span>&nbsp;</div></li><li><div>  if ( ( ( $width &gt;= 10 ) && ( $height &gt;= 10 ) ) && ( ( $width &lt;= 1024 ) && ( $height &lt;= 1024 ) ) ) {&nbsp;</div></li><li><div>      $intermediate_size = &quot;wpsc-{$width}x{$height}&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get image url if we have enough info</span>&nbsp;</div></li><li><div>  if ( $attachment_id &gt; 0 && ! empty( $intermediate_size ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get all the required information about the attachment</span>&nbsp;</div></li><li><div>      $uploads = wp_upload_dir();&nbsp;</div></li><li><div>      $image_meta = get_post_meta( $attachment_id, '' );&nbsp;</div></li><li><div>      $file_path = get_attached_file( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Clean up the meta array</span>&nbsp;</div></li><li><div>      foreach ( $image_meta as $meta_name =&gt; $meta_value ) {&nbsp;</div></li><li><div>          $image_meta[ $meta_name ] = maybe_unserialize( array_pop( $meta_value ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $attachment_metadata = isset( $image_meta['_wp_attachment_metadata'] ) ? $image_meta['_wp_attachment_metadata'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Determine if we already have an image of this size</span>&nbsp;</div></li><li><div>      if ( isset( $attachment_metadata['sizes'] ) && count( $attachment_metadata['sizes'] ) && ( isset( $attachment_metadata['sizes'][ $intermediate_size ] ) ) ) {&nbsp;</div></li><li><div>          $intermediate_image_data = image_get_intermediate_size( $attachment_id, $intermediate_size );&nbsp;</div></li><li><div>          $image_url = $intermediate_image_data['url'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $image_url = home_url( &quot;index.php?wpsc_action=scale_image&attachment_id={$attachment_id}&width=$width&height=$height&quot; );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  <span class="comment">// Not enough info so attempt to fallback</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $attachment_id ) ) {&nbsp;</div></li><li><div>          $image_url = home_url( &quot;index.php?wpsc_action=scale_image&attachment_id={$attachment_id}&width=$width&height=$height&quot; );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $image_url = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $image_url ) && ! empty( $file_path ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $image_meta = get_post_meta( $attachment_id, '_wp_attached_file' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $image_meta ) ) {&nbsp;</div></li><li><div>          $image_url = $uploads['baseurl'] . '/' . $image_meta[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * The filter here and in wpsc_the_product_image() were unfortunately named, as were the functions.</span>&nbsp;</div></li><li><div><span class="comment">   * They do very different things but are named as if they do not.  The onus will be on the</span>&nbsp;</div></li><li><div><span class="comment">   * plugin developer to check if the second parameter is an attachment ID or a product ID.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  return apply_filters( 'wpsc_product_image', set_url_scheme( $image_url ), $attachment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_product_no_image_fallback( $image_url = '' ) {&nbsp;</div></li><li><div>  if ( ! empty( $image_url ) ) {&nbsp;</div></li><li><div>      return $image_url;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return apply_filters( 'wpsc_product_noimage', WPSC_CORE_THEME_URL . 'wpsc-images/noimage.png' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter( 'wpsc_product_image', 'wpsc_product_no_image_fallback' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc show pnp function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if display_pnp is 1 false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_show_pnp() {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>  if(1 == get_option('display_pnp'))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product price function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_price( $no_decimals = false, $only_normal_price = false, $product_id = 0 ) {&nbsp;</div></li><li><div>  global $wpsc_query, $wpsc_variations, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $product_id )&nbsp;</div></li><li><div>      $product_id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wpsc_product_has_variations( $product_id ) ) {&nbsp;</div></li><li><div>      $from_text = __( ' from %s', 'wpsc' );&nbsp;</div></li><li><div>      $from_text = apply_filters( 'wpsc_product_variation_text', $from_text );&nbsp;</div></li><li><div>      $output = wpsc_product_variation_price_from( $product_id, array(&nbsp;</div></li><li><div>          'from_text' =&gt; $from_text, &nbsp;</div></li><li><div>          'no_decimals' =&gt; $no_decimals, &nbsp;</div></li><li><div>          'only_normal_price' =&gt; $only_normal_price, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $price = $full_price = get_post_meta( $product_id, '_wpsc_price', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $only_normal_price ) {&nbsp;</div></li><li><div>          $special_price = get_post_meta( $product_id, '_wpsc_special_price', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ( $full_price &gt; $special_price ) && ( $special_price &gt; 0 ) )&nbsp;</div></li><li><div>              $price = $special_price;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $no_decimals ) {&nbsp;</div></li><li><div>          $price = explode( &quot;.&quot;, $price );&nbsp;</div></li><li><div>          $price = array_shift( $price );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = apply_filters( 'wpsc_do_convert_price', $price, $product_id );&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'display_as_html' =&gt; false, &nbsp;</div></li><li><div>          'display_decimal_point' =&gt; ! $no_decimals&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $output = wpsc_currency_display( $price, $args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc display categories function</span>&nbsp;</div></li><li><div><span class="comment"> * Used to determine whether to display products on the page</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true for yes, false for no</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_display_categories() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  $output = false;&nbsp;</div></li><li><div>  if ( !is_numeric( get_option( 'wpsc_default_category' ) ) && ! get_query_var( 'product_tag' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $wp_query-&gt;query_vars['products'] ) )&nbsp;</div></li><li><div>          $category_id = $wp_query-&gt;query_vars['products'];&nbsp;</div></li><li><div>      else if ( isset( $_GET['products'] ) )&nbsp;</div></li><li><div>          $category_id = $_GET['products'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we have no categories, and no search, show the group list</span>&nbsp;</div></li><li><div>      if ( is_numeric( get_option( 'wpsc_default_category' ) ) || (isset( $product_id ) && is_numeric( $product_id )) )&nbsp;</div></li><li><div>          $output = true;&nbsp;</div></li><li><div>      if ( (get_option( 'wpsc_default_category' ) == 'all+list'))&nbsp;</div></li><li><div>          $output = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (get_option( 'wpsc_default_category' ) == 'list' && (!isset($wp_query-&gt;query_vars['wpsc_product_category']) || !isset($wp_query-&gt;query_vars['product_tag']) && get_option('wpsc_display_categories')))&nbsp;</div></li><li><div>          $output = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $category_id ) && $category_id &gt; 0 )&nbsp;</div></li><li><div>      $output = false;&nbsp;</div></li><li><div>  if ( get_option( 'wpsc_display_categories' ))&nbsp;</div></li><li><div>      $output = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product creation time function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_creation_time( $format = null ) {&nbsp;</div></li><li><div>  global $wpsc_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $format == null )&nbsp;</div></li><li><div>      $format = &quot;Y-m-d H:i:s&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return mysql2date( $format, $wpsc_query-&gt;product['date_added'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc check variation stock availability function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the product price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_check_variation_stock_availability( $product_id, $variations ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $selected_post = get_posts( array(&nbsp;</div></li><li><div>              'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>              'post_type' =&gt; &quot;wpsc-product&quot;, &nbsp;</div></li><li><div>              'post_status' =&gt; 'any', &nbsp;</div></li><li><div>              'suppress_filters' =&gt; true, &nbsp;</div></li><li><div>              'numberposts' =&gt; -1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $selected_variation = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $selected_post as $variation ) {&nbsp;</div></li><li><div>      $matches = 0;&nbsp;</div></li><li><div>      $terms = wpsc_get_product_terms( $variation-&gt;ID, 'wpsc-variation' );&nbsp;</div></li><li><div>      foreach ( $terms as $term ) {&nbsp;</div></li><li><div>          if ( in_array( $term-&gt;term_id, $variations ) )&nbsp;</div></li><li><div>              $matches++;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $matches == count( $variations ) ) {&nbsp;</div></li><li><div>          $selected_variation = $variation-&gt;ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $selected_variation )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( wpsc_product_has_stock( $selected_variation ) ) {&nbsp;</div></li><li><div>      $stock = get_product_meta( $selected_variation, 'stock', true );&nbsp;</div></li><li><div>      if ( $stock === '' )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return (int) $stock;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product has stock function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if the product has stock or does not use stock, false if it does not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_has_stock( $id = null ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  <span class="comment">// maybe do wpsc_clear_stock_claims first?</span>&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ( $id &gt; 0 ) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stock = get_post_meta( $id, '_wpsc_stock', true );&nbsp;</div></li><li><div>  if ( $stock === '' )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $variations = get_children( array( &quot;post_type&quot; =&gt; &quot;wpsc-product&quot;, &quot;post_parent&quot; =&gt; $id ) );&nbsp;</div></li><li><div>  $filter_name = empty( $variations ) ? 'wpsc_product_stock' : 'wpsc_product_variation_stock';&nbsp;</div></li><li><div>  $stock = apply_filters( $filter_name, (int) $stock, $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $variations ) ) {&nbsp;</div></li><li><div>      foreach ( $variations as $variation ) {&nbsp;</div></li><li><div>          if ( wpsc_product_has_stock( $variation-&gt;ID ) )&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( $stock &gt; 0 ) {&nbsp;</div></li><li><div>      $claimed_query = new WPSC_Claimed_Stock( array( 'product_id' =&gt; $id ) );&nbsp;</div></li><li><div>      $claimed_stock = $claimed_query-&gt;get_claimed_stock_count();&nbsp;</div></li><li><div>      if( $stock - $claimed_stock &gt; 0 )&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_is_product_external( $product_id = 0 )</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks if current product is external.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $product_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_is_product_external( $product_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get product ID if incorrect value was passed</span>&nbsp;</div></li><li><div>  if ( empty( $product_id ) || !is_numeric( $product_id ) )&nbsp;</div></li><li><div>      $product_id = wpsc_the_product_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get external link</span>&nbsp;</div></li><li><div>  $external_link = wpsc_product_external_link( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Use external if set</span></span>&nbsp;</div></li><li><div>  if ( !empty( $external_link ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product remaining stock function</span>&nbsp;</div></li><li><div><span class="comment"> * @return integer - the amount of remaining stock, or null if product is stockless</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_remaining_stock( $id = null ) {&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ($id &gt; 0) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_limited_stock = get_post_meta( $id, '_wpsc_stock', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_numeric( $is_limited_stock ) ) {&nbsp;</div></li><li><div>      $product_stock = get_post_meta( $id, '_wpsc_stock', true );&nbsp;</div></li><li><div>      return absint( $product_stock );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc is donation function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if it is a donation, otherwise false</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_is_donation( $id = null ) {&nbsp;</div></li><li><div>  if ( is_numeric( $id ) && ($id &gt; 0) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_donation = get_post_meta( $id, '_wpsc_is_donation', true );&nbsp;</div></li><li><div>  if ( $is_donation == 1 )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product on special function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if the product is on special, otherwise false</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_on_special( $id = 0 ) {&nbsp;</div></li><li><div>  static $on_special = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpsc_query, $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $id )&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $on_special[ $id ] ) ) {&nbsp;</div></li><li><div>      <span class="comment">// don't rely on product sales price if it has variations</span>&nbsp;</div></li><li><div>      if ( wpsc_product_has_variations( $id ) ) {&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>              SELECT COUNT(*)&nbsp;</div></li><li><div>              FROM {$wpdb-&gt;posts} AS p&nbsp;</div></li><li><div>              INNER JOIN {$wpdb-&gt;postmeta} AS pm ON pm.post_id = p.id AND pm.meta_key = '_wpsc_special_price' AND pm.meta_value != '0' AND pm.meta_value != ''&nbsp;</div></li><li><div>              INNER JOIN {$wpdb-&gt;postmeta} AS pm2 ON pm2.post_id = p.id AND pm2.meta_key = '_wpsc_stock' AND pm2.meta_value != '0'&nbsp;</div></li><li><div>              INNER JOIN {$wpdb-&gt;postmeta} AS pm3 ON pm3.post_id = p.id AND pm3.meta_key = '_wpsc_price' AND CAST(pm3.meta_value AS DECIMAL(10, 2)) &gt; CAST(pm.meta_value AS DECIMAL(10, 2))&nbsp;</div></li><li><div>              WHERE&nbsp;</div></li><li><div>                  p.post_type = 'wpsc-product'&nbsp;</div></li><li><div>                  AND&nbsp;</div></li><li><div>                  p.post_parent = %d&nbsp;</div></li><li><div>          &quot;, $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $results = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $on_special[ $id ] = ( $results &gt; 0 );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $price = get_product_meta( $id, 'price', true );&nbsp;</div></li><li><div>          $special_price = get_product_meta( $id, 'special_price', true );&nbsp;</div></li><li><div>          $on_special[ $id ] = $special_price &gt; 0 && $price &gt; $special_price;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'wpsc_product_on_special', $on_special[ $id ], $id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product is modifiable function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if the product has a file</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_is_customisable() {&nbsp;</div></li><li><div>  global $wpsc_query, $wpdb;&nbsp;</div></li><li><div>  $id = get_the_ID();&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( (isset($product_meta['engraved']) && $product_meta['engraved'] == true) || (isset($product_meta['can_have_uploaded_image']) && $product_meta['can_have_uploaded_image'] == true) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product has personal text function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if the product has a file</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_has_personal_text() {&nbsp;</div></li><li><div>  global $wpsc_query, $wpdb;&nbsp;</div></li><li><div>  $id = get_the_ID();&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( isset($product_meta['engraved']) && $product_meta['engraved'] == true )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product has personal file function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if the product has a file</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_has_supplied_file() {&nbsp;</div></li><li><div>  global $wpsc_query, $wpdb;&nbsp;</div></li><li><div>  $id = get_the_ID();&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( isset($product_meta['can_have_uploaded_image']) && $product_meta['can_have_uploaded_image'] == true )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product postage and packaging function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - currently only valid for flat rate</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_postage_and_packaging( $id = null ) {&nbsp;</div></li><li><div>  if ( isset( $id ) && is_numeric( $id ) && ($id &gt; 0) )&nbsp;</div></li><li><div>      $id = absint( $id );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_meta = get_post_meta( $id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>  if ( isset(  $product_meta['shipping'] ) && is_array( $product_meta['shipping'] ) &&  1 != $product_meta['no_shipping'])&nbsp;</div></li><li><div>      return wpsc_currency_display( apply_filters( 'wpsc_product_postage_and_packaging', $product_meta['shipping']['local'] ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return wpsc_currency_display( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WPSC Product Image</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the product image URL. Uses the post thumbnail if set.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int     $width                   Image width</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int     $height                  Image height</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int     $product_id              Product ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string                           The URL to the thumbnail image</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses   wpsc_the_product_thumbnail_id()  Get the product thumbnail ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_image( $width = '', $height = '', $product_id = '' ) {&nbsp;</div></li><li><div>  if ( empty( $product_id ) )&nbsp;</div></li><li><div>      $product_id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If variation, get parent product</span>&nbsp;</div></li><li><div>  $product = get_post( $product_id );&nbsp;</div></li><li><div>  if ( $product-&gt;post_parent &gt; 0 )&nbsp;</div></li><li><div>      $product_id = $product-&gt;post_parent;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $src = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_thumbnail_id = wpsc_the_product_thumbnail_id( $product_id );&nbsp;</div></li><li><div>  $src = wp_get_attachment_image_src( $product_thumbnail_id, 'large' );&nbsp;</div></li><li><div>  $src = is_array( $src ) ? $src[0] : $src;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// WordPress's esc_url() function strips out spaces, so encode them here to ensure they don't get stripped out</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Ref: http://core.trac.wordpress.org/ticket/23605</span></span>&nbsp;</div></li><li><div>  $src = str_replace( ' ', '%20', $src );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'wpsc_product_image', set_url_scheme( $src ), $product_id, $product );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc check display type</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Check the display view for the selected category</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - display type</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_check_display_type() {&nbsp;</div></li><li><div>  global $wpsc_query, $post;&nbsp;</div></li><li><div>  if(isset($wpsc_query-&gt;query_vars['taxonomy']) && 'wpsc_product_category' == $wpsc_query-&gt;query_vars['taxonomy'] && is_string($wpsc_query-&gt;query_vars['term']) && 1 &lt; $wpsc_query-&gt;post_count)&nbsp;</div></li><li><div>      $display_type =    wpsc_get_the_category_display($wpsc_query-&gt;query_vars['term']);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $display_type = get_option('product_view');&nbsp;</div></li><li><div>  return $display_type;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product thumbnail function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Show the thumbnail image for the product</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the URL to the thumbnail image</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product thumbnail function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Show the thumbnail image for the product</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the URL to the thumbnail image</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_thumbnail( $width = null, $height = null, $product_id = 0, $page = false ) {&nbsp;</div></li><li><div>  $thumbnail = false;&nbsp;</div></li><li><div>  $display = wpsc_check_display_type();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the product ID if none was passed</span>&nbsp;</div></li><li><div>  if ( empty( $product_id ) )&nbsp;</div></li><li><div>      $product_id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load the product</span>&nbsp;</div></li><li><div>  $product = get_post( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $thumbnail_id = wpsc_the_product_thumbnail_id( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no thumbnail found for item, get its parent image</span>&nbsp;</div></li><li><div>  if ( ! $thumbnail_id && ( is_a( $product, 'WP_Post' ) && $product-&gt;post_parent ) ) {&nbsp;</div></li><li><div>      $thumbnail_id = wpsc_the_product_thumbnail_id( $product-&gt;post_parent );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if still no thumbnail ID is found, return our fallback function</span>&nbsp;</div></li><li><div>  if ( ! $thumbnail_id ) {&nbsp;</div></li><li><div>      return wpsc_product_image();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $page ) {&nbsp;</div></li><li><div>      $page = is_single() ? 'single' : 'products-page';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $width && ! $height ) {&nbsp;</div></li><li><div>      $width = get_option( 'product_image_width' );&nbsp;</div></li><li><div>      $height = get_option( 'product_image_height' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Overwrite height & width if custom dimensions exist for thumbnail_id</span>&nbsp;</div></li><li><div>      if ( 'grid' != $display && 'products-page' == $page && isset( $thumbnail_id ) ) {&nbsp;</div></li><li><div>          $custom_width = get_post_meta( $thumbnail_id, '_wpsc_custom_thumb_w', true );&nbsp;</div></li><li><div>          $custom_height = get_post_meta( $thumbnail_id, '_wpsc_custom_thumb_h', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $custom_width ) && ! empty( $custom_height ) ) {&nbsp;</div></li><li><div>              $width = $custom_width;&nbsp;</div></li><li><div>              $height = $custom_height;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( $page == 'single' && isset( $thumbnail_id ) ) {&nbsp;</div></li><li><div>          $custom_thumbnail = get_post_meta( $thumbnail_id, '_wpsc_selected_image_size', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $custom_thumbnail ) {&nbsp;</div></li><li><div>              $custom_thumbnail = 'medium-single-product';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $src = wp_get_attachment_image_src( $thumbnail_id, $custom_thumbnail );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $src ) {&nbsp;</div></li><li><div>              $custom_thumbnail = 'medium-single-product';&nbsp;</div></li><li><div>              $current_size = image_get_intermediate_size( $thumbnail_id, $custom_thumbnail );&nbsp;</div></li><li><div>              $settings_width = get_option( 'single_view_image_width' );&nbsp;</div></li><li><div>              $settings_height = get_option( 'single_view_image_height' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $current_size || ( $current_size['width'] != $settings_width && $current_size['height'] != $settings_height ) ) {&nbsp;</div></li><li><div>                  _wpsc_regenerate_thumbnail_size( $thumbnail_id, $custom_thumbnail );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $src = wp_get_attachment_image_src( $thumbnail_id, $custom_thumbnail );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $src ) && is_string( $src[0] ) )&nbsp;</div></li><li><div>              $thumbnail = $src[0];&nbsp;</div></li><li><div>      } elseif ( $page == 'manage-products' && isset( $thumbnail_id ) ) {&nbsp;</div></li><li><div>          $current_size = image_get_intermediate_size( $thumbnail_id, 'admin-product-thumbnails' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $current_size )&nbsp;</div></li><li><div>              _wpsc_regenerate_thumbnail_size( $thumbnail_id, 'admin-product-thumbnails' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $src = wp_get_attachment_image_src( $thumbnail_id, 'admin-product-thumbnails' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $src ) && is_string( $src[0] ) )&nbsp;</div></li><li><div>              $thumbnail = $src[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Calculate the height based on the ratio of the original dimensions.</span>&nbsp;</div></li><li><div>  if ( $height == 0 || $width == 0 ) {&nbsp;</div></li><li><div>      $attachment_meta = get_post_meta( $thumbnail_id, '_wp_attachment_metadata', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $original_width = isset( $attachment_meta['width'] )    ? absint( $attachment_meta['width'] )    : 0;&nbsp;</div></li><li><div>      $original_height = isset( $attachment_meta['height'] )    ? absint( $attachment_meta['height'] )    : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// bail if either original value is zero. can't divide by zero.</span>&nbsp;</div></li><li><div>      if ( $original_width == 0 || $original_height == 0 )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $width != 0 ) {&nbsp;</div></li><li><div>          $height = ( $original_height / $original_width ) * $width;&nbsp;</div></li><li><div>          $height = round( $height, 0 );&nbsp;</div></li><li><div>      } elseif ( $height != 0 ) {&nbsp;</div></li><li><div>          $width = ( $original_width / $original_height ) * $height;&nbsp;</div></li><li><div>          $width = round( $width, 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $thumbnail && isset( $thumbnail_id ) )&nbsp;</div></li><li><div>      $thumbnail = wpsc_product_image( $thumbnail_id, $width, $height );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// WordPress's esc_url() function strips out spaces, so encode them here to ensure they don't get stripped out</span></span>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Ref: http://core.trac.wordpress.org/ticket/23605</span></span>&nbsp;</div></li><li><div>  $thumbnail = str_replace( ' ', '%20', $thumbnail );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'wpsc_the_product_thumbnail', set_url_scheme( $thumbnail ), $product_id, $product );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the class(es) that should be applied to a product image's &lt;a&gt; tag.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the thickbox effect is enabled for product images (presentation setting), the thickbox class name is included</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function is called from theme files when outputting product img tags</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @return string space-separated list of class names (for use in a class=&quot;&quot;) attribute</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_product_image_link_classes() {&nbsp;</div></li><li><div>  $classes = array( );&nbsp;</div></li><li><div>  if ( get_option( 'show_thumbnails_thickbox' ) )&nbsp;</div></li><li><div>      $classes[] = 'thickbox';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $classes[] = 'preview_link';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $classes = apply_filters( 'wpsc_the_product_image_link_classes', $classes );&nbsp;</div></li><li><div>  return implode( ' ', $classes );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product comment link function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - javascript required to make the intense debate link work</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_comment_link() {&nbsp;</div></li><li><div>  <span class="comment">// add the product comment link</span>&nbsp;</div></li><li><div>  global $wpsc_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_option( 'wpsc_enable_comments' ) == 1 ) {&nbsp;</div></li><li><div>      $enable_for_product = get_product_meta( get_the_ID(), 'enable_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( (get_option( 'wpsc_comments_which_products' ) == 1 && $enable_for_product == '') || $enable_for_product == 'yes' ) {&nbsp;</div></li><li><div>          $original = array( &quot;&&quot;, &quot;'&quot;, &quot;:&quot;, &quot;/&quot;, &quot;@&quot;, &quot;?&quot;, &quot;=&quot; );&nbsp;</div></li><li><div>          $entities = array( &quot;%26&quot;, &quot;%27&quot;, &quot;%3A&quot;, &quot;%2F&quot;, &quot;%40&quot;, &quot;%3F&quot;, &quot;%3D&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $output = &quot;&lt;div class=\&quot;clear comments\&quot;&gt;&nbsp;</div></li><li><div>                      &lt;script src='https:<span class="comment">//www.intensedebate.com/js/getCommentLink.php?acct=&quot; . get_option( &quot;wpsc_intense_debate_account_id&quot; ) . &quot;&postid=product_&quot; . $wpsc_query-&gt;product['id'] . &quot;&posttitle=&quot; . urlencode( get_the_title() ) . &quot;&posturl=&quot; . str_replace( $original, $entities, get_permalink( get_the_ID() ) ) . &quot;&posttime=&quot; . urlencode( date( 'Y-m-d h:i:s', time() ) ) . &quot;&postauthor=author_&quot; . get_the_ID() . &quot;' type='text/javascript' defer='defer'&gt;&lt;/script&gt;</span>&nbsp;</div></li><li><div>                  &lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product comments function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - javascript for the intensedebate comments</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_comments() {&nbsp;</div></li><li><div>  global $wpsc_query;&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  <span class="comment">// add the product comments</span>&nbsp;</div></li><li><div>  if ( get_option( 'wpsc_enable_comments' ) == 1 ) {&nbsp;</div></li><li><div>      $enable_for_product = get_product_meta( $wpsc_query-&gt;product['id'], 'enable_comments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( (get_option( 'wpsc_comments_which_products' ) == 1 && $enable_for_product == '') || $enable_for_product == 'yes' ) {&nbsp;</div></li><li><div>          $output = &quot;&lt;script&gt;&nbsp;</div></li><li><div>              var idcomments_acct = '&quot; . esc_js( get_option( 'wpsc_intense_debate_account_id' ) ) . &quot;';&nbsp;</div></li><li><div>              var idcomments_post_id = 'product_&quot; . $wpsc_query-&gt;product['id'] . &quot;';&nbsp;</div></li><li><div>              var idcomments_post_url = encodeURIComponent('&quot; . get_permalink( $wpsc_query-&gt;product['id'] ) . &quot;');&nbsp;</div></li><li><div>              &lt;/script&gt;&nbsp;</div></li><li><div>              &lt;span id=\&quot;IDCommentsPostTitle\&quot; style=\&quot;display:none\&quot;&gt;&lt;/span&gt;&nbsp;</div></li><li><div>              &lt;script type='text/javascript' src='https:<span class="comment">//www.intensedebate.com/js/genericCommentWrapperV2.js'&gt;&lt;/script&gt;</span>&nbsp;</div></li><li><div>              &quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc have custom meta function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true while we have custom meta to display</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_have_custom_meta() {&nbsp;</div></li><li><div>  global $wpsc_custom_meta;&nbsp;</div></li><li><div>  return esc_html( $wpsc_custom_meta-&gt;have_custom_meta() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the custom meta function</span>&nbsp;</div></li><li><div><span class="comment"> * @return nothing - iterate through the custom meta vallues</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_custom_meta() {&nbsp;</div></li><li><div>  global $wpsc_custom_meta;&nbsp;</div></li><li><div>  return $wpsc_custom_meta-&gt;the_custom_meta();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc custom meta name function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the custom metal name</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_custom_meta_name() {&nbsp;</div></li><li><div>  global $wpsc_custom_meta;&nbsp;</div></li><li><div>  return esc_html( $wpsc_custom_meta-&gt;custom_meta_values['meta_key'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc custom meta value function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the custom meta value</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_custom_meta_value() {&nbsp;</div></li><li><div>  global $wpsc_custom_meta;&nbsp;</div></li><li><div>  return esc_html( $wpsc_custom_meta-&gt;custom_meta_values['meta_value'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc have variation groups function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true while we have variation groups</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_have_variation_groups() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  return $wpsc_variations-&gt;have_variation_groups();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation group function</span>&nbsp;</div></li><li><div><span class="comment"> * @return nothing - iterate through the variation groups</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation_group() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  $wpsc_variations-&gt;the_variation_group();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc have variations function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true while we have variations</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_have_variations() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  return $wpsc_variations-&gt;have_variations();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation function</span>&nbsp;</div></li><li><div><span class="comment"> * @return nothing - iterate through the variations</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  $wpsc_variations-&gt;the_variation();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_product_has_multicurrency() {&nbsp;</div></li><li><div>  global $wpdb, $wpsc_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $currency = get_product_meta(get_the_ID(), 'currency', true);&nbsp;</div></li><li><div>  if ( ! empty( $currency ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_display_product_multicurrency() {&nbsp;</div></li><li><div>  global $wpdb, $wpsc_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $results = get_product_meta(get_the_ID(), 'currency', true);&nbsp;</div></li><li><div>  if ( count( $results ) &gt; 0 ) {&nbsp;</div></li><li><div>      foreach ( (array)$results as $isocode =&gt; $curr ) {&nbsp;</div></li><li><div>          echo apply_filters( 'wpsc_display_product_multicurrency', '&lt;span class=&quot;wpscsmall pricefloatright pricedisplay&quot;&gt;' . $isocode . ': ' . wpsc_currency_display( $curr, array( 'isocode' =&gt; $isocode ) ) . '&lt;/span&gt;&lt;br /&gt;', $isocode, $curr );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc variation group name function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the variation group name</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_vargrp_name() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  return apply_filters( 'wpsc_vargrp_name', $wpsc_variations-&gt;variation_group-&gt;name, $wpsc_variations-&gt;variation_group );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc variation group form ID function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the variation group form id, for labels and the like</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_vargrp_form_id() {&nbsp;</div></li><li><div>  <span class="comment">// generate the variation group form ID;</span>&nbsp;</div></li><li><div>  global $wpsc_variations, $wpsc_variations;&nbsp;</div></li><li><div>  $product_id = get_the_ID();&nbsp;</div></li><li><div>  $form_id = &quot;variation_select_{$product_id}_{$wpsc_variations-&gt;variation_group-&gt;term_id}&quot;;&nbsp;</div></li><li><div>  return $form_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc variation group ID function</span>&nbsp;</div></li><li><div><span class="comment"> * @return integer - the variation group ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_vargrp_id() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  return $wpsc_variations-&gt;variation_group-&gt;term_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation name function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the variation name</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation_name() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  return esc_html( apply_filters( 'wpsc_variation_name', $wpsc_variations-&gt;variation-&gt;name ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation ID function</span>&nbsp;</div></li><li><div><span class="comment"> * @return integer - the variation ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation_id() {&nbsp;</div></li><li><div>  global $wpsc_variations;&nbsp;</div></li><li><div>  return $wpsc_variations-&gt;variation-&gt;term_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation out_of_stock function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - HTML attribute to disable select options and radio buttons</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation_out_of_stock() {&nbsp;</div></li><li><div>  global $wpsc_query, $wpdb, $wpsc_variations;&nbsp;</div></li><li><div>  $out_of_stock = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If there is more than one variation group we cannot determine a stock status for individual variations</span>&nbsp;</div></li><li><div>  <span class="comment">// Also, if the item is not stock limited, there is no need to check variation stock status</span>&nbsp;</div></li><li><div>  $product_id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stock = get_product_meta( $product_id, 'stock', true );&nbsp;</div></li><li><div>  if ( ($wpsc_variations-&gt;variation_group_count == 1) && is_numeric( $stock ) && isset( $wpsc_variations-&gt;variation-&gt;slug ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_id = get_the_ID();&nbsp;</div></li><li><div>      $variation_group_id = $wpsc_variations-&gt;variation_group-&gt;term_id;&nbsp;</div></li><li><div>      $variation_id = $wpsc_variations-&gt;variation-&gt;term_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpq = array( 'variations' =&gt; $wpsc_variations-&gt;variation-&gt;slug, &nbsp;</div></li><li><div>          'post_status' =&gt; 'inherit', &nbsp;</div></li><li><div>          'post_type' =&gt; 'wpsc-product', &nbsp;</div></li><li><div>          'post_parent' =&gt; $product_id );&nbsp;</div></li><li><div>      $query = new WP_Query( $wpq );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $query-&gt;post_count != 1 ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Should never happen</span></span></span>&nbsp;</div></li><li><div>          return FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $variation_product_id = $query-&gt;posts[0]-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stock = get_product_meta( $variation_product_id, &quot;stock&quot; );&nbsp;</div></li><li><div>      $stock = $stock[0];&nbsp;</div></li><li><div>      if ( $stock &lt; 1 ) {&nbsp;</div></li><li><div>          $out_of_stock = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $out_of_stock == true )&nbsp;</div></li><li><div>      return &quot;disabled='disabled'&quot;;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product rater function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - HTML to display the product rater</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_rater() {&nbsp;</div></li><li><div>  global $wpsc_query;&nbsp;</div></li><li><div>  $product_id = get_the_ID();&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  if ( get_option( 'product_ratings' ) == 1 ) {&nbsp;</div></li><li><div>      $output .= &quot;&lt;div class='product_footer'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output .= &quot;&lt;div class='product_average_vote'&gt;&quot;;&nbsp;</div></li><li><div>      $output .= &quot;&lt;strong&gt;&quot; . __( 'Avg. Customer Rating', 'wpsc' ) . &quot;:&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>      $output .= wpsc_product_existing_rating( $product_id );&nbsp;</div></li><li><div>      $output .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output .= &quot;&lt;div class='product_user_vote'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output .= &quot;&lt;strong&gt;&lt;span id='rating_&quot; . $product_id . &quot;_text'&gt;&quot; . __( 'Your Rating', 'wpsc' ) . &quot;:&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      $output .= &quot;&lt;span class='rating_saved' id='saved_&quot; . $product_id . &quot;_text'&gt; &quot; . __( 'Saved', 'wpsc' ) . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      $output .= &quot;&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output .= wpsc_product_new_rating( $product_id );&nbsp;</div></li><li><div>      $output .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      $output .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_product_existing_rating( $product_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $get_average = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT AVG(`rated`) AS `average`, COUNT(*) AS `count` FROM `&quot; . WPSC_TABLE_PRODUCT_RATING . &quot;` WHERE `productid`= %d &quot;, $product_id ), ARRAY_A );&nbsp;</div></li><li><div>  $average = floor( $get_average[0]['average'] );&nbsp;</div></li><li><div>  $count = $get_average[0]['count'];&nbsp;</div></li><li><div>  $output = &quot;  &lt;span class='votetext'&gt;&quot;;&nbsp;</div></li><li><div>  for ( $l = 1; $l &lt;= $average; ++$l ) {&nbsp;</div></li><li><div>      $output .= &quot;&lt;img class='goldstar' src='&quot; . WPSC_CORE_IMAGES_URL . &quot;/gold-star.png' alt='$l' title='$l' /&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $remainder = 5 - $average;&nbsp;</div></li><li><div>  for ( $l = 1; $l &lt;= $remainder; ++$l ) {&nbsp;</div></li><li><div>      $output .= &quot;&lt;img class='goldstar' src='&quot; . WPSC_CORE_IMAGES_URL . &quot;/grey-star.png' alt='$l' title='$l' /&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $output .= &quot;&lt;span class='vote_total'&gt;&nbsp;(&lt;span id='vote_total_{$product_id}'&gt;&quot; . $count . &quot;&lt;/span&gt;)&lt;/span&gt; \r\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;&lt;/span&gt; \r\n&quot;;&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_product_new_rating( $product_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cookie_data = '';&nbsp;</div></li><li><div>  if (isset($_COOKIE['voting_cookie'][$product_id])) {&nbsp;</div></li><li><div>      $cookie_data = explode( &quot;, &quot;, $_COOKIE['voting_cookie'][$product_id] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $vote_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($cookie_data[0]) &&  is_numeric( $cookie_data[0] ) )&nbsp;</div></li><li><div>      $vote_id = absint( $cookie_data[0] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $previous_vote = 1;&nbsp;</div></li><li><div>  if ( $vote_id &gt; 0 )&nbsp;</div></li><li><div>      $previous_vote = $wpdb-&gt;get_var( &quot;SELECT `rated` FROM `&quot; . WPSC_TABLE_PRODUCT_RATING . &quot;` WHERE `id`='&quot; . $vote_id . &quot;' LIMIT 1&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = &quot;&lt;form class='wpsc_product_rating' method='post'&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;            &lt;input type='hidden' name='wpsc_ajax_action' value='rate_product' /&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;            &lt;input type='hidden' class='wpsc_rating_product_id' name='product_id' value='{$product_id}' /&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;            &lt;select class='wpsc_select_product_rating' name='product_rating'&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;                    &lt;option &quot; . (($previous_vote == '1') ? &quot;selected='selected'&quot; : '') . &quot; value='1'&gt;1&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;                    &lt;option &quot; . (($previous_vote == '2') ? &quot;selected='selected'&quot; : '') . &quot; value='2'&gt;2&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;                    &lt;option &quot; . (($previous_vote == '3') ? &quot;selected='selected'&quot; : '') . &quot; value='3'&gt;3&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;                    &lt;option &quot; . (($previous_vote == '4') ? &quot;selected='selected'&quot; : '') . &quot; value='4'&gt;4&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;                    &lt;option &quot; . (($previous_vote == '5') ? &quot;selected='selected'&quot; : '') . &quot; value='5'&gt;5&lt;/option&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;            &lt;/select&gt;\n&quot;;&nbsp;</div></li><li><div>  $output .= &quot;            &lt;input type='submit' value='&quot; . __( 'Save', 'wpsc' ) . &quot;'&gt;&quot;;&nbsp;</div></li><li><div>  $output .= &quot;    &lt;/form&gt;&quot;;&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc has pages function</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean - true if we have pages</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_has_pages() {&nbsp;</div></li><li><div>  if(1 == get_option('use_pagination'))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * this is for the multi adding property, it checks to see whether multi adding is enabled;</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_has_multi_adding() {&nbsp;</div></li><li><div>  if ( get_option( 'multi_add' ) == 1 && (get_option( 'addtocart_or_buynow' ) != 1) ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc product count function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the page URL</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_count() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  return count($wp_query-&gt;posts);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//The following code was removed from WP 3.8, present in 3.7 - Not sure why it was removed and not refactored. (JS)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation price function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the variation price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation_price( $return_as_numeric = false ) {&nbsp;</div></li><li><div>  global $wpdb, $wpsc_variations;&nbsp;</div></li><li><div>  if ( $wpsc_variations-&gt;variation_count &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_id = get_the_ID();&nbsp;</div></li><li><div>      $wpq = array(&nbsp;</div></li><li><div>          'variations' =&gt; $wpsc_variations-&gt;variation-&gt;slug, &nbsp;</div></li><li><div>          'post_status' =&gt; array( 'inherit', 'publish' ), &nbsp;</div></li><li><div>          'post_type' =&gt; 'wpsc-product', &nbsp;</div></li><li><div>          'post_parent' =&gt; $product_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query = new WP_Query( $wpq );&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Should never happen</span></span></span>&nbsp;</div></li><li><div>      if ( $query-&gt;post_count != 1 )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $variation_product_id = $query-&gt;posts[0]-&gt;ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = get_product_meta( $variation_product_id, 'price', true );&nbsp;</div></li><li><div>      $special_price = get_product_meta( $variation_product_id, 'special_price', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $special_price &lt; $price && $special_price &gt; 0 )&nbsp;</div></li><li><div>          $price = $special_price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = apply_filters( 'wpsc_do_convert_price', $price, $product_id, $variation_product_id );&nbsp;</div></li><li><div>      $output = $return_as_numeric ? $price :  wpsc_currency_display( $price, array( 'display_as_html' =&gt; false ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $output = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc the variation stock function</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed - Stock level for the variation or FALSE if it can't be calculated</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_variation_stock() {&nbsp;</div></li><li><div>  global $wpdb, $wpsc_variations;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $wpsc_variations-&gt;variation_count &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_id = get_the_ID();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpq = array( 'variations' =&gt; $wpsc_variations-&gt;variation-&gt;slug, &nbsp;</div></li><li><div>          'post_status' =&gt; 'inherit', &nbsp;</div></li><li><div>          'post_type' =&gt; 'wpsc-product', &nbsp;</div></li><li><div>          'post_parent' =&gt; $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query = new WP_Query( $wpq );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Should never happen</span></span></span>&nbsp;</div></li><li><div>      if ( $query-&gt;post_count != 1 )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the stock count</span>&nbsp;</div></li><li><div>      $vp_id = $query-&gt;posts[0]-&gt;ID;&nbsp;</div></li><li><div>      $stock = get_product_meta( $vp_id, &quot;stock&quot; );&nbsp;</div></li><li><div>      $stock[0] = apply_filters( 'wpsc_product_variation_stock', $stock[0], $id );&nbsp;</div></li><li><div>      $output = $stock[0];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_category_grid_view function</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool - whether the category is in grid view or not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_category_grid_view() {&nbsp;</div></li><li><div>  if(get_option('wpsc_category_grid_view') == 1)&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_show_thumbnails function</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool - whether to show thumbnails or not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_show_thumbnails() {&nbsp;</div></li><li><div>  return get_option('show_thumbnails');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * gold_cart_display_gallery function</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool - whether to show gold cart gallery or not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function gold_cart_display_gallery() {&nbsp;</div></li><li><div>  return function_exists('gold_shpcrt_display_gallery');&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_remove_currency_code( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args['display_currency_symbol'] = false;&nbsp;</div></li><li><div>  $args['display_currency_code'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $args;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_you_save( $args = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'product_id' =&gt; false, &nbsp;</div></li><li><div>      'type' =&gt; 'percentage', &nbsp;</div></li><li><div>      'variations' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  extract( $args, EXTR_SKIP );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $product_id )&nbsp;</div></li><li><div>      if(function_exists('wpsc_the_product_id')) {&nbsp;</div></li><li><div>          <span class="comment">//select the variation ID with lowest price</span>&nbsp;</div></li><li><div>          $product_id = $wpdb-&gt;get_var('SELECT `posts`.`id` FROM ' . $wpdb-&gt;posts . ' `posts` JOIN ' . $wpdb-&gt;postmeta . ' `postmeta` ON `posts`.`id` = `postmeta`.`post_id` WHERE `posts`.`post_parent` = ' . wpsc_the_product_id() . ' AND `posts`.`post_type` = &quot;wpsc-product&quot; AND `posts`.`post_status` = &quot;inherit&quot; AND `postmeta`.`meta_key`=&quot;_wpsc_price&quot; ORDER BY (`postmeta`.`meta_value`)+0 ASC LIMIT 1');&nbsp;</div></li><li><div>          if(!$product_id)&nbsp;</div></li><li><div>              $product_id=wpsc_the_product_id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $product_id )&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $regular_price = wpsc_calculate_price( $product_id, $variations, false );&nbsp;</div></li><li><div>  $sale_price = wpsc_calculate_price( $product_id, $variations, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch( $type ) {&nbsp;</div></li><li><div>      case &quot;amount&quot;:&nbsp;</div></li><li><div>          return $regular_price - $sale_price;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          if ( $regular_price == 0 )&nbsp;</div></li><li><div>              return 0;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              return number_format( ( $regular_price - $sale_price ) / $regular_price * 100, 2 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_the_product_price_display( $args = array() ) {&nbsp;</div></li><li><div>  if ( empty( $args['id'] ) )&nbsp;</div></li><li><div>      $id = get_the_ID();&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $id = (int) $args['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'id' =&gt; $id, &nbsp;</div></li><li><div>      'old_price_text' =&gt; __( 'Old Price: %s', 'wpsc' ), &nbsp;</div></li><li><div>      'price_text' =&gt; __( 'Price: %s', 'wpsc' ), &nbsp;</div></li><li><div>      <span class="comment">/** translators     : %1$s is the saved amount text, %2$s is the saved percentage text, %% is the percentage sign */</span>&nbsp;</div></li><li><div>      'you_save_text' =&gt; __( 'You save: %s', 'wpsc' ), &nbsp;</div></li><li><div>      'old_price_class' =&gt; 'pricedisplay wpsc-product-old-price ' . $id, &nbsp;</div></li><li><div>      'old_price_before' =&gt; '&lt;p %s&gt;', &nbsp;</div></li><li><div>      'old_price_after' =&gt; '&lt;/p&gt;', &nbsp;</div></li><li><div>      'old_price_amount_id' =&gt; 'old_product_price_' . $id, &nbsp;</div></li><li><div>      'old_price_amount_class' =&gt; 'oldprice', &nbsp;</div></li><li><div>      'old_price_amount_before' =&gt; '&lt;span class=&quot;%1$s&quot; id=&quot;%2$s&quot;&gt;', &nbsp;</div></li><li><div>      'old_price_amount_after' =&gt; '&lt;/span&gt;', &nbsp;</div></li><li><div>      'price_amount_id' =&gt; 'product_price_' . $id, &nbsp;</div></li><li><div>      'price_class' =&gt; 'pricedisplay wpsc-product-price ' . $id, &nbsp;</div></li><li><div>      'price_before' =&gt; '&lt;p %s&gt;', &nbsp;</div></li><li><div>      'price_after' =&gt; '&lt;/p&gt;', &nbsp;</div></li><li><div>      'price_amount_class' =&gt; 'currentprice pricedisplay ' . $id, &nbsp;</div></li><li><div>      'price_amount_before' =&gt; '&lt;span class=&quot;%1$s&quot; id=&quot;%2$s&quot;&gt;', &nbsp;</div></li><li><div>      'price_amount_after' =&gt; '&lt;/span&gt;', &nbsp;</div></li><li><div>      'you_save_class' =&gt; 'pricedisplay wpsc-product-you-save product_' . $id, &nbsp;</div></li><li><div>      'you_save_before' =&gt; '&lt;p %s&gt;', &nbsp;</div></li><li><div>      'you_save_after' =&gt; '&lt;/p&gt;', &nbsp;</div></li><li><div>      'you_save_amount_id' =&gt; 'yousave_' . $id, &nbsp;</div></li><li><div>      'you_save_amount_class' =&gt; 'yousave', &nbsp;</div></li><li><div>      'you_save_amount_before' =&gt; '&lt;span class=&quot;%1$s&quot; id=&quot;%2$s&quot;&gt;', &nbsp;</div></li><li><div>      'you_save_amount_after' =&gt; '&lt;/span&gt;', &nbsp;</div></li><li><div>      'output_price' =&gt; true, &nbsp;</div></li><li><div>      'output_old_price' =&gt; true, &nbsp;</div></li><li><div>      'output_you_save' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $r = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>  extract( $r );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if the product has no variations, these amounts are straight forward...</span>&nbsp;</div></li><li><div>  $old_price = wpsc_product_normal_price( $id );&nbsp;</div></li><li><div>  $current_price = wpsc_the_product_price( false, false, $id );&nbsp;</div></li><li><div>  $you_save = wpsc_you_save( array( 'type' =&gt; 'amount', 'product_id' =&gt; $id, ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $show_old_price = $show_you_save = wpsc_product_on_special( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// but if the product has variations and at least one of the variations is on special, we have</span>&nbsp;</div></li><li><div>  <span class="comment">// a few edge cases...</span>&nbsp;</div></li><li><div>  if ( wpsc_product_has_variations( $id ) && wpsc_product_on_special( $id ) ) {&nbsp;</div></li><li><div>      <span class="comment">// generally it doesn't make sense to display &quot;you save&quot; amount unless the user has selected</span>&nbsp;</div></li><li><div>      <span class="comment">// a specific variation</span>&nbsp;</div></li><li><div>      $show_you_save = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $old_price_number = wpsc_product_variation_price_from( $id, array( 'only_normal_price' =&gt; true ) );&nbsp;</div></li><li><div>      $current_price_number = wpsc_product_variation_price_from( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if coincidentally, one of the variations are not on special, but its price is equal to</span>&nbsp;</div></li><li><div>      <span class="comment">// or lower than the lowest variation sale price, old price should be hidden, and current</span>&nbsp;</div></li><li><div>      <span class="comment">// price should reflect the &quot;normal&quot; price, not the sales price, to avoid confusion</span>&nbsp;</div></li><li><div>      if ( $old_price_number == $current_price_number ) {&nbsp;</div></li><li><div>          $show_old_price = false;&nbsp;</div></li><li><div>          $current_price = wpsc_product_normal_price( $id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// replace placeholders in arguments with correct values</span>&nbsp;</div></li><li><div>  $old_price_class = apply_filters( 'wpsc_the_product_price_display_old_price_class', $old_price_class, $id );&nbsp;</div></li><li><div>  $old_price_amount_class = apply_filters( 'wpsc_the_product_price_display_old_price_amount_class', $old_price_amount_class, $id );&nbsp;</div></li><li><div>  $attributes = 'class=&quot;' . esc_attr( $old_price_class ) . '&quot;';&nbsp;</div></li><li><div>  if ( ! $show_old_price )&nbsp;</div></li><li><div>      $attributes .= ' style=&quot;display:none;&quot;';&nbsp;</div></li><li><div>  $old_price_before = sprintf( $old_price_before, $attributes );&nbsp;</div></li><li><div>  $old_price_amount_before = sprintf( $old_price_amount_before, esc_attr( $old_price_amount_class ), esc_attr( $old_price_amount_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $price_class = 'class=&quot;' . esc_attr( apply_filters( 'wpsc_the_product_price_display_price_class', esc_attr( $price_class ), $id ) ) . '&quot;';&nbsp;</div></li><li><div>  $price_amount_class = apply_filters( 'wpsc_the_product_price_display_price_amount_class', esc_attr( $price_amount_class ), $id );&nbsp;</div></li><li><div>  $price_before = sprintf( $price_before, $price_class );&nbsp;</div></li><li><div>  $price_amount_before = sprintf( $price_amount_before, esc_attr( $price_amount_class ), esc_attr( $price_amount_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $you_save_class = apply_filters( 'wpsc_the_product_price_display_you_save_class', $you_save_class, $id );&nbsp;</div></li><li><div>  $you_save_amount_class = apply_filters( 'wpsc_the_product_price_display_you_save_amount_class', $you_save_amount_class, $id );&nbsp;</div></li><li><div>  $attributes = 'class=&quot;' . esc_attr( $you_save_class ) . '&quot;';&nbsp;</div></li><li><div>  if ( ! $show_you_save )&nbsp;</div></li><li><div>      $attributes .= ' style=&quot;display:none;&quot;';&nbsp;</div></li><li><div>  $you_save_before = sprintf( $you_save_before, $attributes );&nbsp;</div></li><li><div>  $you_save_amount_before = sprintf( $you_save_amount_before, esc_attr( $you_save_amount_class ), esc_attr( $you_save_amount_id ) );&nbsp;</div></li><li><div>  $you_save = wpsc_currency_display ( $you_save );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $old_price = $old_price_amount_before . $old_price . $old_price_amount_after;&nbsp;</div></li><li><div>  $current_price = $price_amount_before . $current_price . $price_amount_after;&nbsp;</div></li><li><div>  $you_save = $you_save_amount_before . $you_save . $you_save_amount_after;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $old_price_text = sprintf( $old_price_text, $old_price );&nbsp;</div></li><li><div>  $price_text = sprintf( $price_text, $current_price );&nbsp;</div></li><li><div>  $you_save_text = sprintf( $you_save_text, $you_save );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $output_old_price )&nbsp;</div></li><li><div>      echo $old_price_before . $old_price_text . $old_price_after . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $output_price )&nbsp;</div></li><li><div>      echo $price_before . $price_text . $price_after . &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $output_you_save )&nbsp;</div></li><li><div>      echo $you_save_before . $you_save_text . $you_save_after . &quot;\n&quot;;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_form_action</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Echo the form action for use in the template files</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global &lt;type&gt; $wpec_form_action</span>&nbsp;</div></li><li><div><span class="comment"> * @return &lt;type&gt;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_form_action() {&nbsp;</div></li><li><div>  echo wpsc_get_form_action();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * wpsc_get_form_action</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Return the form action for use in the template files</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @global &lt;type&gt; $wpec_form_action</span>&nbsp;</div></li><li><div><span class="comment">   * @return &lt;type&gt;</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function wpsc_get_form_action() {&nbsp;</div></li><li><div>      global $wpec_form_action;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_id = wpsc_the_product_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Function has already ran in this page load</span>&nbsp;</div></li><li><div>      if ( isset( $wpec_form_action ) ) {&nbsp;</div></li><li><div>          $action =  $wpec_form_action;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// No global so figure it out</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Use external if set</span></span>&nbsp;</div></li><li><div>          if ( wpsc_is_product_external() ) {&nbsp;</div></li><li><div>              $action = wpsc_product_external_link( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Otherwise use this page</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $action = wpsc_this_page_url();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Return form action</span>&nbsp;</div></li><li><div>      return $action;&nbsp;</div></li><li><div>  }&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>