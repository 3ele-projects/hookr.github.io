<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27679"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-includes-purchase-log-class | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=95c907d60f40aafd765af3f30b7d0ee0' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-includes-purchase-log-class/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-includes-purchase-log-class%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-includes-purchase-log-class%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-includes-purchase-log-class","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-includes-purchase-log-class" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-includes-purchase-log-cl&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-includes/purchase-log.class.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">// by default, expire stats cache after 48 hours</span>&nbsp;</div></li><li><div><span class="comment">// this doesn't have any effect if you're not using APC or memcached</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! defined( 'WPSC_PURCHASE_LOG_STATS_CACHE_EXPIRE' ) ) {&nbsp;</div></li><li><div>  define( 'WPSC_PURCHASE_LOG_STATS_CACHE_EXPIRE', DAY_IN_SECONDS * 2 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WPSC_Purchase_Log {&nbsp;</div></li><li><div>  const INCOMPLETE_SALE = 1;&nbsp;</div></li><li><div>  const ORDER_RECEIVED = 2;&nbsp;</div></li><li><div>  const ACCEPTED_PAYMENT = 3;&nbsp;</div></li><li><div>  const JOB_DISPATCHED = 4;&nbsp;</div></li><li><div>  const CLOSED_ORDER = 5;&nbsp;</div></li><li><div>  const PAYMENT_DECLINED = 6;&nbsp;</div></li><li><div>  const REFUNDED = 7;&nbsp;</div></li><li><div>  const REFUND_PENDING = 8;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Names of column that requires escaping values as strings before being inserted</span>&nbsp;</div></li><li><div><span class="comment">   * into the database</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static $string_cols = array(&nbsp;</div></li><li><div>      'sessionid', &nbsp;</div></li><li><div>      'transactid', &nbsp;</div></li><li><div>      'authcode', &nbsp;</div></li><li><div>      'date', &nbsp;</div></li><li><div>      'gateway', &nbsp;</div></li><li><div>      'billing_country', &nbsp;</div></li><li><div>      'shipping_country', &nbsp;</div></li><li><div>      'base_shipping', &nbsp;</div></li><li><div>      'email_sent', &nbsp;</div></li><li><div>      'stock_adjusted', &nbsp;</div></li><li><div>      'discount_data', &nbsp;</div></li><li><div>      'track_id', &nbsp;</div></li><li><div>      'billing_region', &nbsp;</div></li><li><div>      'shipping_region', &nbsp;</div></li><li><div>      'find_us', &nbsp;</div></li><li><div>      'engrave_text', &nbsp;</div></li><li><div>      'shipping_method', &nbsp;</div></li><li><div>      'shipping_option', &nbsp;</div></li><li><div>      'affiliate_id', &nbsp;</div></li><li><div>      'plugin_version', &nbsp;</div></li><li><div>      'notes', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Names of column that requires escaping values as integers before being inserted</span>&nbsp;</div></li><li><div><span class="comment">   * into the database</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static $int_cols = array(&nbsp;</div></li><li><div>      'id', &nbsp;</div></li><li><div>      'statusno', &nbsp;</div></li><li><div>      'processed', &nbsp;</div></li><li><div>      'user_ID', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the SQL query format for a column</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $col Name of the column</span>&nbsp;</div></li><li><div><span class="comment">   * @return string      Placeholder</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function get_column_format( $col ) {&nbsp;</div></li><li><div>      if ( in_array( $col, self::$string_cols ) )&nbsp;</div></li><li><div>          return '%s';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $col, self::$int_cols ) )&nbsp;</div></li><li><div>          return '%d';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return '%f';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Query the purchase log table to get sales and earning stats</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Accepts an array of arguments:</span>&nbsp;</div></li><li><div><span class="comment">   *     - 'ids': IDs of products for which you want to get stats</span>&nbsp;</div></li><li><div><span class="comment">   *     - 'products': array of WPSC_Product objects for which you want to get stats</span>&nbsp;</div></li><li><div><span class="comment">   *     - 'start' and 'end': the timestamp range (integers) during which you want</span>&nbsp;</div></li><li><div><span class="comment">   *                          to collect the stats.</span>&nbsp;</div></li><li><div><span class="comment">   *                          You can use none, either, or both of them.</span>&nbsp;</div></li><li><div><span class="comment">   *                          Note that the [start, end) interval is a left-closed, </span>&nbsp;</div></li><li><div><span class="comment">   *                          right-open.</span>&nbsp;</div></li><li><div><span class="comment">   *                          E.g.: to get stats from Jan 1st, 2013 to</span>&nbsp;</div></li><li><div><span class="comment">   *                          Dec 31st, 2013 (23:59:59), </span>&nbsp;</div></li><li><div><span class="comment">   *                          set &quot;start&quot; to the timestamp for Jan 1st, 2013, set</span>&nbsp;</div></li><li><div><span class="comment">   *                          &quot;end&quot; to the timestamp for Jan 1st, 2014</span>&nbsp;</div></li><li><div><span class="comment">   *  - 'order': what to sort the results by, defaults to 'id'.</span>&nbsp;</div></li><li><div><span class="comment">   *            Can be 'ids', 'sales', 'earnings' or empty string to disable sorting</span>&nbsp;</div></li><li><div><span class="comment">   *  - 'orderby': how to sort the results, defaults to 'ASC'.</span>&nbsp;</div></li><li><div><span class="comment">   *              Can be 'ASC', 'DESC' (lowercase is fine too)</span>&nbsp;</div></li><li><div><span class="comment">   *  - 'per_page': How many items to fetch, defaults to 0, which fetches all results</span>&nbsp;</div></li><li><div><span class="comment">   *  - 'page': Which page of the results to fetch, defaults to 1.</span>&nbsp;</div></li><li><div><span class="comment">   *            Has no effect if per_page is set to 0.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array|string $args Arguments</span>&nbsp;</div></li><li><div><span class="comment">   * @return array       Array containing 'sales' and 'earnings' stats</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function fetch_stats( $args ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'ids' =&gt; array(), <span class="comment">// IDs of the products to be queried</span>&nbsp;</div></li><li><div>          'products' =&gt; array(), <span class="comment">// Array of WPSC_Products objects</span>&nbsp;</div></li><li><div>          'start' =&gt; 0, <span class="comment"><span class="comment">// Int. timestamp, has to be UTC</span></span>&nbsp;</div></li><li><div>          'end' =&gt; 0, <span class="comment"><span class="comment">// Int. timestamp, has to be UTC</span></span>&nbsp;</div></li><li><div>          'order' =&gt; 'ASC', &nbsp;</div></li><li><div>          'orderby' =&gt; 'id', &nbsp;</div></li><li><div>          'per_page' =&gt; 0, &nbsp;</div></li><li><div>          'page' =&gt; 1, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// convert more advanced date / time args into &quot;start&quot; and &quot;end&quot;</span>&nbsp;</div></li><li><div>      $args = self::convert_date_args( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// build an array of WPSC_Product objects based on 'ids' and 'products' args</span>&nbsp;</div></li><li><div>      $products = array_merge(&nbsp;</div></li><li><div>          $args['products'], &nbsp;</div></li><li><div>          array_map( array( 'WPSC_Product', 'get_instance' ), $args['ids'] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// eliminate duplicates (Note: usage of this requires PHP 5.2.9)</span>&nbsp;</div></li><li><div>      $products = array_unique( $products, SORT_REGULAR );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $products ) ) {&nbsp;</div></li><li><div>          return null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $needs_fetching = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stats = array(&nbsp;</div></li><li><div>          'sales' =&gt; 0, &nbsp;</div></li><li><div>          'earnings' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we have date restriction, that means we won't be able to rely upon</span>&nbsp;</div></li><li><div>      <span class="comment">// individual stats cache inside WPSC_Product objects</span>&nbsp;</div></li><li><div>      $has_date_restriction = ! ( empty( $args['start'] ) && empty( $args['end'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we do NOT have date restriction, find out which WPSC_Product object</span>&nbsp;</div></li><li><div>      <span class="comment">// has stats cache, and which don't</span>&nbsp;</div></li><li><div>      if ( ! $has_date_restriction ) {&nbsp;</div></li><li><div>          foreach ( $products as $product ) {&nbsp;</div></li><li><div>              <span class="comment">// store the ID if this product doesn't have a stats cache yet</span>&nbsp;</div></li><li><div>              if ( $product-&gt;post-&gt;_wpsc_stats === '' ) {&nbsp;</div></li><li><div>                  $needs_fetching[] = $product-&gt;post-&gt;ID;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// tally up the sales and earnings if this one has cache already</span>&nbsp;</div></li><li><div>                  $prod_meta = get_post_meta( $product-&gt;post-&gt;ID, '_wpsc_stats', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( isset( $prod_meta['sales'] ) && isset( $prod_meta['earnings'] ) ) {&nbsp;</div></li><li><div>                      $stats['sales']    += $prod_meta['sales'];&nbsp;</div></li><li><div>                      $stats['earnings'] += $prod_meta['earnings'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $needs_fetching[] = $product-&gt;post-&gt;ID;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// never hurts to make sure</span>&nbsp;</div></li><li><div>      $needs_fetching = array_map( 'absint', $needs_fetching );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// pagination arguments</span>&nbsp;</div></li><li><div>      $limit = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $args['per_page'] ) ) {&nbsp;</div></li><li><div>          $offset = ( $args['page'] - 1 ) * $args['per_page'];&nbsp;</div></li><li><div>          $limit = &quot;LIMIT &quot; . absint( $args['per_page'] ) . &quot; OFFSET &quot; . absint( $offset );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// sorting</span>&nbsp;</div></li><li><div>      $order = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $args['orderby'] ) )&nbsp;</div></li><li><div>          $order = &quot;ORDER BY &quot; . esc_sql( $args['orderby'] ) . &quot; &quot; . esc_sql( $args['order'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// date</span>&nbsp;</div></li><li><div>      $where = &quot;WHERE p.processed IN (3, 4, 5)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $has_date_restriction ) {&nbsp;</div></li><li><div>          <span class="comment">// start date equal or larger than $args['start']</span>&nbsp;</div></li><li><div>          if ( ! empty( $args['start'] ) )&nbsp;</div></li><li><div>              $where .= &quot; AND CAST(p.date AS UNSIGNED) &gt;= &quot; . absint( $args['start'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// end date less than $args['end'].</span>&nbsp;</div></li><li><div>          <span class="comment">// the &quot;&lt;&quot; sign is not a typo, such upper limit makes it easier for</span>&nbsp;</div></li><li><div>          <span class="comment">// people to specify range.</span>&nbsp;</div></li><li><div>          <span class="comment">// E.g.: [1/1/2013 - 1/1/2014) rather than:</span>&nbsp;</div></li><li><div>          <span class="comment">//       [1/1/2013 - 31/12/2013 23:59:59]</span>&nbsp;</div></li><li><div>          if ( ! empty( $args['end'] ) )&nbsp;</div></li><li><div>              $where .= &quot; AND CAST(p.date AS UNSIGNED) &lt; &quot; . absint( $args['end'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// assemble the SQL query</span>&nbsp;</div></li><li><div>      $sql = &quot;&nbsp;</div></li><li><div>          SELECT cc.prodid AS id, SUM(cc.quantity) AS sales, SUM(cc.quantity * cc.price) AS earnings&nbsp;</div></li><li><div>          FROM $wpdb-&gt;wpsc_purchase_logs AS p&nbsp;</div></li><li><div>          INNER JOIN&nbsp;</div></li><li><div>              $wpdb-&gt;wpsc_cart_contents AS cc&nbsp;</div></li><li><div>              ON p.id = cc.purchaseid AND cc.prodid IN (&quot; . implode( ', ', $needs_fetching ) . &quot;)&nbsp;</div></li><li><div>          {$where}&nbsp;</div></li><li><div>          GROUP BY cc.prodid&nbsp;</div></li><li><div>          {$order}&nbsp;</div></li><li><div>          {$limit}&nbsp;</div></li><li><div>      &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if the result is cached, don't bother querying the database</span>&nbsp;</div></li><li><div>      $cache_key = md5( $sql );&nbsp;</div></li><li><div>      $results = wp_cache_get( $cache_key, 'wpsc_purchase_logs_stats' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === $results ) {&nbsp;</div></li><li><div>          $results = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>          wp_cache_set( $cache_key, $results, 'wpsc_purchase_logs_stats', WPSC_PURCHASE_LOG_STATS_CACHE_EXPIRE );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// tally up the sales and earnings from the query results</span>&nbsp;</div></li><li><div>      foreach ( $results as $row ) {&nbsp;</div></li><li><div>          if ( ! $has_date_restriction ) {&nbsp;</div></li><li><div>              $product = WPSC_Product::get_instance( $row-&gt;id );&nbsp;</div></li><li><div>              $product-&gt;sales = $row-&gt;sales;&nbsp;</div></li><li><div>              $product-&gt;earnings = $row-&gt;earnings;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $stats['sales']    += $row-&gt;sales;&nbsp;</div></li><li><div>          $stats['earnings'] += $row-&gt;earnings;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $stats;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Convert advanced date/time arguments like year, month, day, 'ago' etc.</span>&nbsp;</div></li><li><div><span class="comment">   * into basic arguments which are &quot;start&quot; and &quot;end&quot;.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.8.14</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $args Arguments</span>&nbsp;</div></li><li><div><span class="comment">   * @return array       Arguments after converting</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private static function convert_date_args( $args ) {&nbsp;</div></li><li><div>      <span class="comment">// TODO: Implement this</span>&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get overall sales and earning stats for just one product</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $id ID of the product</span>&nbsp;</div></li><li><div><span class="comment">   * @return array   Array containing 'sales' and 'earnings' stats</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_stats_for_product( $id, $args = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product = WPSC_Product::get_instance( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if this product has variations</span>&nbsp;</div></li><li><div>      if ( $product-&gt;has_variations ) {&nbsp;</div></li><li><div>          <span class="comment">// get total stats of variations</span>&nbsp;</div></li><li><div>          $args['products'] = $product-&gt;variations;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// otherwise, get stats of only this product</span>&nbsp;</div></li><li><div>          $args['products'] = array( $product );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::fetch_stats( $args );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check whether the status code indicates a completed status</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.13</span>&nbsp;</div></li><li><div><span class="comment">   * @param int  $status Status code</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_order_status_completed( $status ) {&nbsp;</div></li><li><div>      $completed_status = apply_filters( 'wpsc_order_status_completed', array(&nbsp;</div></li><li><div>          self::ACCEPTED_PAYMENT, &nbsp;</div></li><li><div>          self::JOB_DISPATCHED, &nbsp;</div></li><li><div>          self::CLOSED_ORDER, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return in_array( $status, $completed_status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Contains the values fetched from the DB</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Data that is not directly stored inside the DB but is inferred</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.9</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $meta_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $gateway_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * True if the DB row is fetched into $this-&gt;data.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $fetched = false;&nbsp;</div></li><li><div>  private $is_status_changed = false;&nbsp;</div></li><li><div>  private $previous_status = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private $cart_contents = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Contains the constructor arguments. This array is necessary because we will</span>&nbsp;</div></li><li><div><span class="comment">   * lazy load the DB row into $this-&gt;data whenever necessary. Lazy loading is, </span>&nbsp;</div></li><li><div><span class="comment">   * in turn, necessary because sometimes right after saving a new record, we need</span>&nbsp;</div></li><li><div><span class="comment">   * to fetch a property with the same object.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $args = array(&nbsp;</div></li><li><div>      'col' =&gt; '', &nbsp;</div></li><li><div>      'value' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * True if the row exists in DB</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private $exists = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update cache of the passed log object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WPSC_Purchase_Log $log The log object that you want to store into cache</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function update_cache( &$log ) {&nbsp;</div></li><li><div>      <span class="comment">// wpsc_purchase_logs stores the data array, while wpsc_purchase_logs_sessionid stores the</span>&nbsp;</div></li><li><div>      <span class="comment">// log id that's associated with the sessionid</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = $log-&gt;get( 'id' );&nbsp;</div></li><li><div>      wp_cache_set( $id, $log-&gt;data, 'wpsc_purchase_logs' );&nbsp;</div></li><li><div>      if ( $sessionid = $log-&gt;get( 'sessionid' ) )&nbsp;</div></li><li><div>          wp_cache_set( $sessionid, $id, 'wpsc_purchase_logs_sessionid' );&nbsp;</div></li><li><div>      wp_cache_set( $id, $log-&gt;cart_contents, 'wpsc_purchase_log_cart_contents' );&nbsp;</div></li><li><div>      do_action( 'wpsc_purchase_log_update_cache', $log );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Deletes cache of a log (either by using the log ID or sessionid)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @static</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value The value to query</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $col Optional. Defaults to 'id'. Whether to delete cache by using</span>&nbsp;</div></li><li><div><span class="comment">   *                    a purchase log ID or sessionid</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function delete_cache( $value, $col = 'id' ) {&nbsp;</div></li><li><div>      <span class="comment">// this will pull from the old cache, so no worries there</span>&nbsp;</div></li><li><div>      $log = new WPSC_Purchase_Log( $value, $col );&nbsp;</div></li><li><div>      wp_cache_delete( $log-&gt;get( 'id' ), 'wpsc_purchase_logs' );&nbsp;</div></li><li><div>      wp_cache_delete( $log-&gt;get( 'sessionid' ), 'wpsc_purchase_logs_sessionid' );&nbsp;</div></li><li><div>      wp_cache_delete( $log-&gt;get( 'id' ), 'wpsc_purchase_log_cart_contents' );&nbsp;</div></li><li><div>      do_action( 'wpsc_purchase_log_delete_cache', $log, $value, $col );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Deletes a log from the database.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access  public</span>&nbsp;</div></li><li><div><span class="comment">   * @since   3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @uses  $wpdb                              Global database instance.</span>&nbsp;</div></li><li><div><span class="comment">   * @uses  wpsc_is_store_admin()              Check user has admin capabilities.</span>&nbsp;</div></li><li><div><span class="comment">   * @uses  WPSC_Purchase_Log::delete_cache()  Delete purchaselog cache.</span>&nbsp;</div></li><li><div><span class="comment">   * @uses  WPSC_Claimed_Stock                 Claimed Stock class.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param   string   $log_id   ID of the log.</span>&nbsp;</div></li><li><div><span class="comment">   * @return  boolean            Deleted successfully.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function delete( $log_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! ( isset( $this ) && get_class( $this ) == __CLASS__ ) ) {&nbsp;</div></li><li><div>          _wpsc_doing_it_wrong( 'WPSC_Purchase_Log::delete', __( 'WPSC_Purchase_Log::delete() is no longer a static method and should not be called statically.', 'wpsc' ), '3.9.0' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== $log_id ) {&nbsp;</div></li><li><div>          _wpsc_deprecated_argument( __FUNCTION__, '3.9.0', 'The $log_id param is not used. You must first create an instance of WPSC_Purchase_Log before calling this method.' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! wpsc_is_store_admin() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $log_id = $this-&gt;get( 'id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $log_id &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wpsc_purchase_log_before_delete', $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          self::delete_cache( $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Delete claimed stock</span>&nbsp;</div></li><li><div>          $purchlog_status = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT `processed` FROM `&quot; . WPSC_TABLE_PURCHASE_LOGS . &quot;` WHERE `id`= %d&quot;, $log_id ) );&nbsp;</div></li><li><div>          if ( $purchlog_status == WPSC_Purchase_Log::CLOSED_ORDER || $purchlog_status == WPSC_Purchase_Log::INCOMPLETE_SALE ) {&nbsp;</div></li><li><div>              $claimed_query = new WPSC_Claimed_Stock( array(&nbsp;</div></li><li><div>                  'cart_id' =&gt; $log_id, &nbsp;</div></li><li><div>                  'cart_submitted' =&gt; 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>              $claimed_query-&gt;clear_claimed_stock( 0 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Delete cart content, submitted data, then purchase log</span>&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM `&quot; . WPSC_TABLE_CART_CONTENTS . &quot;` WHERE `purchaseid` = %d&quot;, $log_id ) );&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM `&quot; . WPSC_TABLE_SUBMITTED_FORM_DATA . &quot;` WHERE `log_id` IN (%d)&quot;, $log_id ) );&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM `&quot; . WPSC_TABLE_PURCHASE_LOGS . &quot;` WHERE `id` = %d LIMIT 1&quot;, $log_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wpsc_purchase_log_delete', $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor of the purchase log object. If no argument is passed, this simply</span>&nbsp;</div></li><li><div><span class="comment">   * create a new empty object. Otherwise, this will get the purchase log from the</span>&nbsp;</div></li><li><div><span class="comment">   * DB either by using purchase log id or sessionid (specified by the 2nd argument).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Eg:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * // get purchase log with ID number 23</span>&nbsp;</div></li><li><div><span class="comment">   * $log = new WPSC_Purchase_Log( 23 );</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * // get purchase log with sessionid &quot;asdf&quot;</span>&nbsp;</div></li><li><div><span class="comment">   * $log = new WPSC_Purchase_Log( 'asdf', 'sessionid' )</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $value Optional. Defaults to false.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $col Optional. Defaults to 'id'.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct( $value = false, $col = 'id' ) {&nbsp;</div></li><li><div>      if ( false === $value )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $value ) ) {&nbsp;</div></li><li><div>          $this-&gt;set( $value );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! in_array( $col, array( 'id', 'sessionid' ) ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// store the constructor args into an array so that later we can lazy load the data</span>&nbsp;</div></li><li><div>      $this-&gt;args = array(&nbsp;</div></li><li><div>          'col' =&gt; $col, &nbsp;</div></li><li><div>          'value' =&gt; $value, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if the sessionid is in cache, pull out the id</span>&nbsp;</div></li><li><div>      if ( $col == 'sessionid'  && $id = wp_cache_get( $value, 'wpsc_purchase_logs_sessionid' ) ) {&nbsp;</div></li><li><div>              $col = 'id';&nbsp;</div></li><li><div>              $value = $id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if the id is specified, try to get from cache</span>&nbsp;</div></li><li><div>      if ( $col == 'id' ) {&nbsp;</div></li><li><div>          $this-&gt;data = wp_cache_get( $value, 'wpsc_purchase_logs' );&nbsp;</div></li><li><div>          $this-&gt;cart_contents = wp_cache_get( $value, 'wpsc_purchase_log_cart_contents' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// cache exists</span>&nbsp;</div></li><li><div>      if ( $this-&gt;data ) {&nbsp;</div></li><li><div>          $this-&gt;fetched = true;&nbsp;</div></li><li><div>          $this-&gt;exists = true;&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function set_total_shipping() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $base_shipping = $this-&gt;get( 'base_shipping' );&nbsp;</div></li><li><div>      $item_shipping = wp_list_pluck( $this-&gt;get_cart_contents(), 'pnp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;meta_data['total_shipping'] = $base_shipping + array_sum( $item_shipping );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;meta_data['total_shipping'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function set_gateway_name() {&nbsp;</div></li><li><div>      global $wpsc_gateways;&nbsp;</div></li><li><div>      $gateway = $this-&gt;get( 'gateway' );&nbsp;</div></li><li><div>      $gateway_name = $gateway;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'wpsc_merchant_testmode' == $gateway )&nbsp;</div></li><li><div>          $gateway_name = __( 'Manual Payment', 'wpsc' );&nbsp;</div></li><li><div>      elseif ( isset( $wpsc_gateways[$gateway] ) )&nbsp;</div></li><li><div>          $gateway_name = $wpsc_gateways[$gateway]['name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;meta_data['gateway_name'] = $gateway_name;&nbsp;</div></li><li><div>      return $this-&gt;meta_data['gateway_name'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function set_shipping_method_names() {&nbsp;</div></li><li><div>      global $wpsc_shipping_modules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping_method = $this-&gt;get( 'shipping_method' );&nbsp;</div></li><li><div>      $shipping_option = $this-&gt;get( 'shipping_option' );&nbsp;</div></li><li><div>      $shipping_method_name = $shipping_method;&nbsp;</div></li><li><div>      $shipping_option_name = $shipping_option;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty ( $wpsc_shipping_modules[$shipping_method] ) ) {&nbsp;</div></li><li><div>          $shipping_class = $wpsc_shipping_modules[$shipping_method];&nbsp;</div></li><li><div>          $shipping_method_name = $shipping_class-&gt;name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;meta_data['shipping_method_name'] = $shipping_method_name;&nbsp;</div></li><li><div>      $this-&gt;meta_data['shipping_option_name'] = $shipping_option_name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function set_meta_props() {&nbsp;</div></li><li><div>      $this-&gt;set_total_shipping();&nbsp;</div></li><li><div>      $this-&gt;set_gateway_name();&nbsp;</div></li><li><div>      $this-&gt;set_shipping_method_names();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fetches the actual record from the database</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function fetch() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;fetched )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If $this-&gt;args is not set yet, it means the object contains a new unsaved</span>&nbsp;</div></li><li><div>      <span class="comment">// row so we don't need to fetch from DB</span>&nbsp;</div></li><li><div>      if ( ! $this-&gt;args['col'] || ! $this-&gt;args['value'] )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      extract( $this-&gt;args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $format = self::get_column_format( $col );&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT * FROM &quot; . WPSC_TABLE_PURCHASE_LOGS . &quot; WHERE {$col} = {$format}&quot;, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;exists = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $data = $wpdb-&gt;get_row( $sql, ARRAY_A ) ) {&nbsp;</div></li><li><div>          $this-&gt;exists = true;&nbsp;</div></li><li><div>          $this-&gt;data = apply_filters( 'wpsc_purchase_log_data', $data );&nbsp;</div></li><li><div>          $this-&gt;cart_contents = $this-&gt;get_cart_contents();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;set_meta_props();&nbsp;</div></li><li><div>          self::update_cache( $this );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wpsc_purchase_log_fetched', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;fetched = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Whether the DB row for this purchase log exists</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool True if it exists. Otherwise false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function exists() {&nbsp;</div></li><li><div>      $this-&gt;fetch();&nbsp;</div></li><li><div>      return $this-&gt;exists;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the value of the specified property of the purchase log</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key Name of the property (column)</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get( $key ) {&nbsp;</div></li><li><div>      <span class="comment">// lazy load the purchase log row if it's not fetched from the database yet</span>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;data ) || ! array_key_exists( $key, $this-&gt;data ) )&nbsp;</div></li><li><div>          $this-&gt;fetch();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $this-&gt;data[$key] ) )&nbsp;</div></li><li><div>          $value = $this-&gt;data[$key];&nbsp;</div></li><li><div>      elseif ( isset( $this-&gt;meta_data[$key] ) )&nbsp;</div></li><li><div>          $value = $this-&gt;meta_data[$key];&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $value = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wpsc_purchase_log_get_property', $value, $key, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_cart_contents() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;cart_contents ) && $this-&gt;fetched ) {&nbsp;</div></li><li><div>          return $this-&gt;cart_contents;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = $this-&gt;get( 'id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT * FROM &quot; . WPSC_TABLE_CART_CONTENTS . &quot; WHERE purchaseid = %d&quot;, $id );&nbsp;</div></li><li><div>      $this-&gt;cart_contents = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;cart_contents;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the whole database row in the form of an associative array</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_data() {&nbsp;</div></li><li><div>      if ( empty( $this-&gt;data ) )&nbsp;</div></li><li><div>          $this-&gt;fetch();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'wpsc_purchase_log_get_data', $this-&gt;data, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function get_gateway_data( $from_currency = false, $to_currency = false ) {&nbsp;</div></li><li><div>      if ( ! $this-&gt;exists() )&nbsp;</div></li><li><div>          return array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subtotal = 0;&nbsp;</div></li><li><div>      $shipping = wpsc_convert_currency( (float) $this-&gt;get( 'base_shipping' ), $from_currency, $to_currency );&nbsp;</div></li><li><div>      $items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;gateway_data = array(&nbsp;</div></li><li><div>          'amount' =&gt; wpsc_convert_currency( $this-&gt;get( 'totalprice' ), $from_currency, $to_currency ), &nbsp;</div></li><li><div>          'invoice' =&gt; $this-&gt;get( 'sessionid' ), &nbsp;</div></li><li><div>          'tax' =&gt; wpsc_convert_currency( $this-&gt;get( 'wpec_taxes_total' ), $from_currency, $to_currency ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;cart_contents as $item ) {&nbsp;</div></li><li><div>          $item_price = wpsc_convert_currency( $item-&gt;price, $from_currency, $to_currency );&nbsp;</div></li><li><div>          $items[] = array(&nbsp;</div></li><li><div>              'name' =&gt; $item-&gt;name, &nbsp;</div></li><li><div>              'amount' =&gt; $item_price, &nbsp;</div></li><li><div>              'tax' =&gt; wpsc_convert_currency( $item-&gt;tax_charged, $from_currency, $to_currency ), &nbsp;</div></li><li><div>              'quantity' =&gt; $item-&gt;quantity, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $subtotal += $item_price * $item-&gt;quantity;&nbsp;</div></li><li><div>          $shipping += wpsc_convert_currency( $item-&gt;pnp, $from_currency, $to_currency );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;gateway_data['discount'] = wpsc_convert_currency( (float) $this-&gt;get( 'discount_value' ), $from_currency, $to_currency );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;gateway_data['items'] = $items;&nbsp;</div></li><li><div>      $this-&gt;gateway_data['shipping'] = $shipping;&nbsp;</div></li><li><div>      $this-&gt;gateway_data['subtotal'] = $subtotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $from_currency ) {&nbsp;</div></li><li><div>          <span class="comment">// adjust total amount in case there's slight decimal error</span>&nbsp;</div></li><li><div>          $total = $subtotal + $shipping + $this-&gt;gateway_data['tax'] - $this-&gt;gateway_data['discount'];&nbsp;</div></li><li><div>          if ( $this-&gt;gateway_data['amount'] != $total )&nbsp;</div></li><li><div>              $this-&gt;gateway_data['amount'] = $total;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;gateway_data = apply_filters( 'wpsc_purchase_log_gateway_data', $this-&gt;gateway_data, $this-&gt;get_data() );&nbsp;</div></li><li><div>      return $this-&gt;gateway_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets a property to a certain value. This function accepts a key and a value</span>&nbsp;</div></li><li><div><span class="comment">   * as arguments, or an associative array containing key value pairs.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $key Name of the property (column), or an array containing key</span>&nbsp;</div></li><li><div><span class="comment">   *                   value pairs</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|int $value Optional. Defaults to false. In case $key is a string, </span>&nbsp;</div></li><li><div><span class="comment">   *                          this should be specified.</span>&nbsp;</div></li><li><div><span class="comment">   * @return WPSC_Purchase_Log The current object (for method chaining)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set( $key, $value = null ) {&nbsp;</div></li><li><div>      if ( is_array( $key ) ) {&nbsp;</div></li><li><div>          $properties = $key;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( is_null( $value ) )&nbsp;</div></li><li><div>              return $this;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $properties = array( $key =&gt; $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $properties = apply_filters( 'wpsc_purchase_log_set_properties', $properties, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( array_key_exists( 'processed', $properties ) ) {&nbsp;</div></li><li><div>          $this-&gt;previous_status = $this-&gt;get( 'processed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $properties['processed'] != $this-&gt;previous_status )&nbsp;</div></li><li><div>              $this-&gt;is_status_changed = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_array( $this-&gt;data ) )&nbsp;</div></li><li><div>          $this-&gt;data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;data = array_merge( $this-&gt;data, $properties );&nbsp;</div></li><li><div>      return $this;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an array containing the parameter format so that this can be used in</span>&nbsp;</div></li><li><div><span class="comment">   * $wpdb methods (update, insert etc.)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $data</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_data_format( $data ) {&nbsp;</div></li><li><div>      $format = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $data as $key =&gt; $value ) {&nbsp;</div></li><li><div>          $format[] = self::get_column_format( $key );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $format;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Saves the purchase log back to the database</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function save() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wpsc_purchase_log_pre_save', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// $this-&gt;args['col'] is empty when the record is new and needs to</span>&nbsp;</div></li><li><div>      <span class="comment">// be inserted. Otherwise, it means we're performing an update</span>&nbsp;</div></li><li><div>      $where_col = $this-&gt;args['col'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $where_col ) {&nbsp;</div></li><li><div>          $where_val = $this-&gt;args['value'];&nbsp;</div></li><li><div>          $where_format = self::get_column_format( $where_col );&nbsp;</div></li><li><div>          do_action( 'wpsc_purchase_log_pre_update', $this );&nbsp;</div></li><li><div>          self::delete_cache( $where_val, $where_col );&nbsp;</div></li><li><div>          $data = apply_filters( 'wpsc_purchase_log_update_data', $this-&gt;data );&nbsp;</div></li><li><div>          $format = $this-&gt;get_data_format( $data );&nbsp;</div></li><li><div>          $result = $wpdb-&gt;update( WPSC_TABLE_PURCHASE_LOGS, $data, array( $where_col =&gt; $where_val ), $format, array( $where_format ) );&nbsp;</div></li><li><div>          do_action( 'wpsc_purchase_log_update', $this );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          do_action( 'wpsc_purchase_log_pre_insert', $this );&nbsp;</div></li><li><div>          $data = apply_filters( 'wpsc_purchase_log_insert_data', $this-&gt;data );&nbsp;</div></li><li><div>          $format = $this-&gt;get_data_format( $data );&nbsp;</div></li><li><div>          $result = $wpdb-&gt;insert( WPSC_TABLE_PURCHASE_LOGS, $data, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $result ) {&nbsp;</div></li><li><div>              $this-&gt;set( 'id', $wpdb-&gt;insert_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// set $this-&gt;args so that properties can be lazy loaded right after</span>&nbsp;</div></li><li><div>              <span class="comment">// the row is inserted into the db</span>&nbsp;</div></li><li><div>              $this-&gt;args = array(&nbsp;</div></li><li><div>                  'col' =&gt; 'id', &nbsp;</div></li><li><div>                  'value' =&gt; $this-&gt;get( 'id' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'wpsc_purchase_log_insert', $this );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_status_changed ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;is_transaction_completed() ) {&nbsp;</div></li><li><div>              $this-&gt;update_downloadable_status();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $current_status = $this-&gt;get( 'processed' );&nbsp;</div></li><li><div>          $previous_status = $this-&gt;previous_status;&nbsp;</div></li><li><div>          $this-&gt;previous_status = $current_status;&nbsp;</div></li><li><div>          $this-&gt;is_status_changed = false;&nbsp;</div></li><li><div>          do_action( 'wpsc_update_purchase_log_status', $this-&gt;get( 'id' ), $current_status, $previous_status, $this );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wpsc_purchase_log_save', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private function update_downloadable_status() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_cart_contents() as $item ) {&nbsp;</div></li><li><div>          $wpdb-&gt;update(&nbsp;</div></li><li><div>              WPSC_TABLE_DOWNLOAD_STATUS, &nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'active' =&gt; '1'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'cartid' =&gt; $item-&gt;id, &nbsp;</div></li><li><div>                  'purchid' =&gt; $this-&gt;get( 'id' ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_transaction_completed() {&nbsp;</div></li><li><div>      return $this-&gt;is_accepted_payment() || $this-&gt;is_job_dispatched() || $this-&gt;is_closed_order();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_order_received() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::ORDER_RECEIVED;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_incomplete_sale() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::INCOMPLETE_SALE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_accepted_payment() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::ACCEPTED_PAYMENT;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_job_dispatched() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::JOB_DISPATCHED;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_closed_order() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::CLOSED_ORDER;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_payment_declined() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::PAYMENT_DECLINED;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_refunded() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::REFUNDED;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function is_refund_pending() {&nbsp;</div></li><li><div>      return $this-&gt;get( 'processed' ) == self::REFUND_PENDING;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>