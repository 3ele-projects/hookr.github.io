<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27511"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-components-theme-engine-v1-helpers-query | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=359078ed2d754faae48c4282c88a9cba' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-components-theme-engine-v1-helpers-query/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-helpers-query%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-helpers-query%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-components-theme-engine-v1-helpers-query","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-components-theme-engine-v1-helpers-query" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-components-theme-engine-&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-components/theme-engine-v1/helpers/query.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">// switch $wp_query and $wpsc_query at the beginning and the end of wp_nav_menu()</span>&nbsp;</div></li><li><div>add_action( 'pre_get_posts', '_wpsc_pre_get_posts_reset_taxonomy_globals', 1 );&nbsp;</div></li><li><div>add_action( 'template_redirect', 'wpsc_start_the_query', 8 );&nbsp;</div></li><li><div>add_action( 'wp', 'wpsc_force_ssl' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( is_ssl() ) {&nbsp;</div></li><li><div>  add_filter( 'option_product_list_url', 'set_url_scheme' );&nbsp;</div></li><li><div>  add_filter( 'option_shopping_cart_url', 'set_url_scheme' );&nbsp;</div></li><li><div>  add_filter( 'option_transact_url', 'set_url_scheme' );&nbsp;</div></li><li><div>  add_filter( 'option_user_account_url', 'set_url_scheme' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter( 'wp_nav_menu_args', 'wpsc_switch_the_query', 99 );&nbsp;</div></li><li><div>add_filter( 'request', 'wpsc_filter_query_request' );&nbsp;</div></li><li><div>add_filter( 'pre_get_posts', 'wpsc_split_the_query', 8 );&nbsp;</div></li><li><div>add_filter( 'parse_query', 'wpsc_mark_product_query', 12 );&nbsp;</div></li><li><div>add_filter( 'query_vars', 'wpsc_query_vars' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( get_option( 'product_category_hierarchical_url' ) ) {&nbsp;</div></li><li><div>  add_filter( 'request', 'wpsc_filter_request' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Fixes for some inconsistencies about $wp_query when viewing WPEC pages.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Causes the following URLs to work (with pagination enabled):</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * /products-page/ (product listing)</span>&nbsp;</div></li><li><div><span class="comment"> * /products-page/car-audio/ (existing product category)</span>&nbsp;</div></li><li><div><span class="comment"> * /products-page/car-audio/page/2/ (existing product category, page 2)</span>&nbsp;</div></li><li><div><span class="comment"> * /products-page/page/2/  (product listing, page 2)</span>&nbsp;</div></li><li><div><span class="comment"> * /products-page/checkout/  (existing built-in sub page)</span>&nbsp;</div></li><li><div><span class="comment"> * /products-page/anotherpage/  (another sub page that may exist)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $q Query String</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_filter_query_request( $args ) {&nbsp;</div></li><li><div>  global $wpsc_page_titles;&nbsp;</div></li><li><div>  if ( is_admin() )&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_sub_page =    ! empty( $args['wpsc_product_category'] )&nbsp;</div></li><li><div>                 &&   'page' != $args['wpsc_product_category']&nbsp;</div></li><li><div>                 && ! term_exists( $args['wpsc_product_category'], 'wpsc_product_category' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure no 404 error is thrown for any sub pages of products-page</span>&nbsp;</div></li><li><div>  if ( $is_sub_page ) {&nbsp;</div></li><li><div>      <span class="comment">// Probably requesting a page that is a sub page of products page</span>&nbsp;</div></li><li><div>      $pagename = &quot;{$wpsc_page_titles['products']}/{$args['wpsc_product_category']}&quot;;&nbsp;</div></li><li><div>      if ( isset($args['name']) ) {&nbsp;</div></li><li><div>          $pagename .= &quot;/{$args['name']}&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>      $args['pagename'] = $pagename;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// When product page is set to display all products or a category, and pagination is enabled, $wp_query is messed up</span>&nbsp;</div></li><li><div>  <span class="comment">// and is_home() is true. This fixes that.</span>&nbsp;</div></li><li><div>  $needs_pagination_fix =      isset( $args['post_type'] )&nbsp;</div></li><li><div>                          && ! empty( $args['wpsc_product_category'] )&nbsp;</div></li><li><div>                          &&   'wpsc-product' == $args['post_type']&nbsp;</div></li><li><div>                          && ! empty( $args['wpsc-product'] )&nbsp;</div></li><li><div>                          &&   'page' == $args['wpsc_product_category'];&nbsp;</div></li><li><div>  if ( $needs_pagination_fix ) {&nbsp;</div></li><li><div>      $default_category = get_option( 'wpsc_default_category' );&nbsp;</div></li><li><div>      if ( $default_category == 'all' || $default_category != 'list' ) {&nbsp;</div></li><li><div>          $page = $args['wpsc-product'];&nbsp;</div></li><li><div>          $args = array();&nbsp;</div></li><li><div>          $args['pagename'] = &quot;{$wpsc_page_titles['products']}&quot;;&nbsp;</div></li><li><div>          $args['page'] = $page;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $args;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _wpsc_menu_exists( $args ) {&nbsp;</div></li><li><div>  $args = (object) $args;&nbsp;</div></li><li><div>  <span class="comment">// Get the nav menu based on the requested menu</span>&nbsp;</div></li><li><div>  $menu = wp_get_nav_menu_object( $args-&gt;menu );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the nav menu based on the theme_location</span>&nbsp;</div></li><li><div>  if ( ! $menu && $args-&gt;theme_location && ( $locations = get_nav_menu_locations() ) && isset( $locations[ $args-&gt;theme_location ] ) )&nbsp;</div></li><li><div>      $menu = wp_get_nav_menu_object( $locations[ $args-&gt;theme_location ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// get the first menu that has items if we still can't find a menu</span>&nbsp;</div></li><li><div>  if ( ! $menu && ! $args-&gt;theme_location ) {&nbsp;</div></li><li><div>      $menus = wp_get_nav_menus();&nbsp;</div></li><li><div>      foreach ( $menus as $menu_maybe ) {&nbsp;</div></li><li><div>          if ( $menu_items = wp_get_nav_menu_items( $menu_maybe-&gt;term_id ) ) {&nbsp;</div></li><li><div>              $menu = $menu_maybe;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the menu exists, get its items.</span>&nbsp;</div></li><li><div>  if ( $menu && ! is_wp_error( $menu ) && ! isset( $menu_items ) )&nbsp;</div></li><li><div>      $menu_items = wp_get_nav_menu_items( $menu-&gt;term_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no menu was found or if the menu has no items and no location was requested, call the fallback_cb if it exists</span>&nbsp;</div></li><li><div>  if ( ( ! $menu || is_wp_error( $menu ) || ( isset( $menu_items ) && empty( $menu_items ) && ! $args-&gt;theme_location ) ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no fallback function was specified and the menu doesn't exists, bail.</span>&nbsp;</div></li><li><div>  if ( ! $menu || is_wp_error( $menu ) || empty( $menu_items ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) $menu;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _wpsc_switch_the_query( $stuff = '' ) {&nbsp;</div></li><li><div>  global $wp_query, $wpsc_query;&nbsp;</div></li><li><div>  list( $wp_query, $wpsc_query ) = array( $wpsc_query, $wp_query );&nbsp;</div></li><li><div>  return $stuff;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Switch $wp_query and $wpsc_query when outputting the navigation menu, but only if we're on a product</span>&nbsp;</div></li><li><div><span class="comment"> * category page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * We need to do this because the function _wp_menu_item_classes_by_context(), which generates classes</span>&nbsp;</div></li><li><div><span class="comment"> * for menu items, depends on $wp_query. As a result, without this fix, when viewing a product category</span>&nbsp;</div></li><li><div><span class="comment"> * page, the corresponding product category menu item will not be highlighted.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Because there are no action hooks in wp_nav_menu(), we have to use two filters that are applied at</span>&nbsp;</div></li><li><div><span class="comment"> * the beginning and the end of the function.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $stuff</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_switch_the_query( $args ) {&nbsp;</div></li><li><div>  global $wp_query, $wpsc_query;&nbsp;</div></li><li><div>  if ( ! empty ( $wpsc_query ) ) {&nbsp;</div></li><li><div>      $qv = $wpsc_query-&gt;query_vars;&nbsp;</div></li><li><div>      if ( ! empty( $qv ) ) {&nbsp;</div></li><li><div>          if ( ! empty( $qv['wpsc_product_category'] ) && ! empty( $qv['taxonomy'] ) && ! empty( $qv['term'] ) && ! is_single() && _wpsc_menu_exists( $args ) ) {&nbsp;</div></li><li><div>              _wpsc_switch_the_query();&nbsp;</div></li><li><div>              add_filter( 'wp_nav_menu', '_wpsc_switch_the_query', 99 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $args;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _wpsc_pre_get_posts_reset_taxonomy_globals( $query ) {&nbsp;</div></li><li><div>  global $wp_the_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_admin() || $query !== $wp_the_query )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $query-&gt;get( 'page' ) && ! $query-&gt;get( 'paged' ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! get_option( 'use_pagination' ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_page( wpsc_get_the_post_id_by_shortcode( '[productspage]' ) ) && ! $query-&gt;get( 'wpsc_product_category' ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query-&gt;set( 'posts_per_page', get_option( 'wpsc_products_per_page' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_type_object = get_post_type_object( 'wpsc-product' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( current_user_can( $post_type_object-&gt;cap-&gt;edit_posts ) )&nbsp;</div></li><li><div>      $query-&gt;set( 'post_status', apply_filters( 'wpsc_product_display_status', array( 'publish' ) ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $query-&gt;set( 'post_status', 'publish' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_start_the_query</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_start_the_query() {&nbsp;</div></li><li><div>  if ( is_404() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpsc_page_titles, $wp_query, $wpsc_query, $wpsc_query_vars;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_404 = $wp_query-&gt;is_404;&nbsp;</div></li><li><div>  if ( null == $wpsc_query ) {&nbsp;</div></li><li><div>      if( ( $wp_query-&gt;is_404 && !empty($wp_query-&gt;query_vars['paged']) ) || (isset( $wp_query-&gt;query['pagename']) && strpos( $wp_query-&gt;query['pagename'] , $wpsc_page_titles['products'] ) !== false ) && !isset($wp_query-&gt;post)) {&nbsp;</div></li><li><div>          global $post;&nbsp;</div></li><li><div>          $is_404 = true;&nbsp;</div></li><li><div>          if( !isset( $wp_query-&gt;query_vars['wpsc_product_category'] ) && ! isset( $wp_query-&gt;query_vars['product_tag'] ) )&nbsp;</div></li><li><div>              $wp_query = new WP_Query('post_type=wpsc-product&name='.$wp_query-&gt;query_vars['name']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(  isset( $wp_query-&gt;post ) && is_object( $wp_query-&gt;post ) && isset($wp_query-&gt;post-&gt;ID))&nbsp;</div></li><li><div>              $post = $wp_query-&gt;post;&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $wpsc_query_vars['wpsc_product_category'] = $wp_query-&gt;query_vars['name'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( count( $wpsc_query_vars ) &lt;= 1 ) {&nbsp;</div></li><li><div>          $wpsc_query_vars = array(&nbsp;</div></li><li><div>              'post_status' =&gt; apply_filters( 'wpsc_product_display_status', array( 'publish' ) ), &nbsp;</div></li><li><div>              'post_parent' =&gt; 0, &nbsp;</div></li><li><div>              'order' =&gt; apply_filters( 'wpsc_product_order', get_option( 'wpsc_product_order', 'ASC' ) ), &nbsp;</div></li><li><div>              'post_type' =&gt; apply_filters( 'wpsc_product_post_type', array( 'wpsc-product' ) ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          if($wp_query-&gt;query_vars['preview'])&nbsp;</div></li><li><div>              $wpsc_query_vars['post_status'] = 'any';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( isset( $_GET['product_order'] ) )&nbsp;</div></li><li><div>              $wpsc_query_vars['order'] = $_GET['product_order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($wp_query-&gt;query_vars['product_tag'])) {&nbsp;</div></li><li><div>              $wpsc_query_vars['product_tag'] = $wp_query-&gt;query_vars['product_tag'];&nbsp;</div></li><li><div>              $wpsc_query_vars['taxonomy'] = get_query_var( 'taxonomy' );&nbsp;</div></li><li><div>              $wpsc_query_vars['term'] = get_query_var( 'term' );&nbsp;</div></li><li><div>          }elseif( isset($wp_query-&gt;query_vars['wpsc_product_category']) ) {&nbsp;</div></li><li><div>              $wpsc_query_vars['wpsc_product_category'] = $wp_query-&gt;query_vars['wpsc_product_category'];&nbsp;</div></li><li><div>              $wpsc_query_vars['taxonomy'] = get_query_var( 'taxonomy' );&nbsp;</div></li><li><div>              $wpsc_query_vars['term'] = get_query_var( 'term' );&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $wpsc_query_vars['post_type'] = 'wpsc-product';&nbsp;</div></li><li><div>              $wpsc_query_vars['pagename'] = wpsc_get_page_slug( '[productspage]' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if(1 == get_option('use_pagination')) {&nbsp;</div></li><li><div>              $wpsc_query_vars['nopaging'] = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $wpsc_query_vars['posts_per_page'] = get_option('wpsc_products_per_page');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $wpsc_query_vars['paged'] = get_query_var('paged');&nbsp;</div></li><li><div>              if(isset($wpsc_query_vars['paged']) && empty($wpsc_query_vars['paged'])) {&nbsp;</div></li><li><div>                  $wpsc_query_vars['paged'] = get_query_var('page');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $orderby = ( isset( $_GET['product_order'] ) ) ? 'title' : null;&nbsp;</div></li><li><div>          $wpsc_query_vars = array_merge( $wpsc_query_vars, wpsc_product_sort_order_query_vars($orderby) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_filter( 'pre_get_posts', 'wpsc_generate_product_query', 11 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpsc_query = new WP_Query( $wpsc_query_vars );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//for 3.1 :|</span>&nbsp;</div></li><li><div>          if(empty($wpsc_query-&gt;posts) && isset($wpsc_query-&gt;tax_query) && isset($wp_query-&gt;query_vars['wpsc_product_category'])) {&nbsp;</div></li><li><div>              $wpsc_query_vars = array();&nbsp;</div></li><li><div>              $wpsc_query_vars['wpsc_product_category'] = $wp_query-&gt;query_vars['wpsc_product_category'];&nbsp;</div></li><li><div>              if(1 == get_option('use_pagination')) {&nbsp;</div></li><li><div>                  $wpsc_query_vars['posts_per_page'] = get_option('wpsc_products_per_page');&nbsp;</div></li><li><div>                  $wpsc_query_vars['paged'] = get_query_var('paged');&nbsp;</div></li><li><div>                  if(empty($wpsc_query_vars['paged']))&nbsp;</div></li><li><div>                      $wpsc_query_vars['paged'] = get_query_var('page');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $wpsc_query = new WP_Query( $wpsc_query_vars );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(  $is_404 || ( ( isset($wpsc_query-&gt;post_count) && $wpsc_query-&gt;post_count == 0 ) && isset($wpsc_query_vars['wpsc_product_category'] ) )) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array_merge($wp_query-&gt;query, array('posts_per_page' =&gt; get_option('wpsc_products_per_page')));&nbsp;</div></li><li><div>      $wp_query = new WP_Query($args);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $wp_query-&gt;posts ) ) {&nbsp;</div></li><li><div>          $product_page_id = wpsc_get_the_post_id_by_shortcode('[productspage]');&nbsp;</div></li><li><div>          $wp_query = new WP_Query( 'page_id='.$product_page_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( isset( $wp_query-&gt;post ) && is_object( $wp_query-&gt;post ) && isset( $wp_query-&gt;post-&gt;ID ) )&nbsp;</div></li><li><div>      $post_id = $wp_query-&gt;post-&gt;ID;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $post_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_permalink( $post_id ) == get_option( 'shopping_cart_url' ) )&nbsp;</div></li><li><div>      $_SESSION['wpsc_has_been_to_checkout'] = true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* Returns page slug that corresponds to a given WPEC-specific shortcode.</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @since 3.8.10</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @uses wpsc_get_the_post_id_by_shortcode() Gets page ID of shortcode.</span>&nbsp;</div></li><li><div><span class="comment">* @uses get_post_field() Returns post name of page ID.</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @param string $shortcode Shortcode of WPEC-specific page, e.g. '[productspage]''</span>&nbsp;</div></li><li><div><span class="comment">* @return string Post slug</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function wpsc_get_page_slug( $shortcode ) {&nbsp;</div></li><li><div>  $id = wpsc_get_the_post_id_by_shortcode( $shortcode );&nbsp;</div></li><li><div>  return get_post_field( 'post_name', $id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Obtain the necessary product sort order query variables based on the specified product sort order.</span>&nbsp;</div></li><li><div><span class="comment"> * If no sort order is specified, the sort order configured in Dashboard -&gt; Settings -&gt; Store -&gt; Presentation -&gt; 'Sort Product By' is used.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $orderby optional product sort order</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array of query variables</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_sort_order_query_vars( $orderby = null ) {&nbsp;</div></li><li><div>  if ( is_null($orderby) )&nbsp;</div></li><li><div>      $orderby = get_option( 'wpsc_sort_by' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query_vars = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $orderby ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case &quot;dragndrop&quot;:&nbsp;</div></li><li><div>          $query_vars[&quot;orderby&quot;] = 'menu_order';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case &quot;name&quot;:&nbsp;</div></li><li><div>          $query_vars[&quot;orderby&quot;] = 'title';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//This only works in WP 3.0.</span>&nbsp;</div></li><li><div>      case &quot;price&quot;:&nbsp;</div></li><li><div>          add_filter( 'posts_join', 'wpsc_add_meta_table' );&nbsp;</div></li><li><div>          add_filter( 'posts_where', 'wpsc_add_meta_table_where' );&nbsp;</div></li><li><div>          $query_vars[&quot;meta_key&quot;] = '_wpsc_price';&nbsp;</div></li><li><div>          $query_vars[&quot;orderby&quot;] = 'meta_value_num';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case &quot;id&quot;:&nbsp;</div></li><li><div>          $query_vars[&quot;orderby&quot;] = 'ID';&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          <span class="comment">// Allow other WordPress 'ordery' values as defined in http://codex.wordpress.org/Class_Reference/WP_Query#Order_.26_Orderby_Parameters</span>&nbsp;</div></li><li><div>          $query_vars[&quot;orderby&quot;] = $orderby;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $query_vars;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_query_vars function.</span>&nbsp;</div></li><li><div><span class="comment"> * adds in the post_type and wpsc_item query vars</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $vars</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_query_vars( $vars ) {&nbsp;</div></li><li><div>  <span class="comment">// post_type is used to specify that we are looking for products</span>&nbsp;</div></li><li><div>  $vars[] = &quot;post_type&quot;;&nbsp;</div></li><li><div>  <span class="comment">// wpsc_item is used to find items that could be either a product or a product category, it defaults to category, then tries products</span>&nbsp;</div></li><li><div>  $vars[] = &quot;wpsc_item&quot;;&nbsp;</div></li><li><div>  return $vars;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_query_modifier function.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @param object - reference to $wp_query</span>&nbsp;</div></li><li><div><span class="comment"> * @return $query</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_split_the_query( $query ) {&nbsp;</div></li><li><div>  global $wpsc_page_titles, $wpsc_query, $wpsc_query_vars;&nbsp;</div></li><li><div>  <span class="comment">// These values are to be dynamically defined</span>&nbsp;</div></li><li><div>  $products_page = $wpsc_page_titles['products'];&nbsp;</div></li><li><div>  $checkout_page = $wpsc_page_titles['checkout'];&nbsp;</div></li><li><div>  $userlog_page = $wpsc_page_titles['userlog'];&nbsp;</div></li><li><div>  $transaction_results_page = $wpsc_page_titles['transaction_results'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// otherwise, check if we are looking at a product, if so, duplicate the query and swap the old one out for a products page request</span>&nbsp;</div></li><li><div>  <span class="comment">// JS - 6.4.1020 - Added is_admin condition, as the products condition broke categories in backend</span>&nbsp;</div></li><li><div>  if ( !empty($query-&gt;query_vars['pagename']) && ($query-&gt;query_vars['pagename'] == $products_page) || isset( $query-&gt;query_vars['products'] ) && !is_admin() ) {&nbsp;</div></li><li><div>      <span class="comment">// store a copy of the wordpress query</span>&nbsp;</div></li><li><div>      $wpsc_query_data = $query-&gt;query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// wipe and replace the query vars</span>&nbsp;</div></li><li><div>      $query-&gt;query = array();&nbsp;</div></li><li><div>      $query-&gt;query['pagename'] = &quot;$products_page&quot;;&nbsp;</div></li><li><div>      $query-&gt;query_vars['pagename'] = &quot;$products_page&quot;;&nbsp;</div></li><li><div>      $query-&gt;query_vars['name'] = '';&nbsp;</div></li><li><div>      $query-&gt;query_vars['post_type'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query-&gt;queried_object = get_page_by_path( $query-&gt;query['pagename'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty( $query-&gt;queried_object ) )&nbsp;</div></li><li><div>          $query-&gt;queried_object_id = (int)$query-&gt;queried_object-&gt;ID;&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          unset( $query-&gt;queried_object );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['products'] );&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['name'] );&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['taxonomy'] );&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['term'] );&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['wpsc_item'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query-&gt;is_singular = true;&nbsp;</div></li><li><div>      $query-&gt;is_page = true;&nbsp;</div></li><li><div>      $query-&gt;is_tax = false;&nbsp;</div></li><li><div>      $query-&gt;is_archive = false;&nbsp;</div></li><li><div>      $query-&gt;is_single = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ($wpsc_query_vars == null ) ) {&nbsp;</div></li><li><div>          unset( $wpsc_query_data['pagename'] );&nbsp;</div></li><li><div>          $wpsc_query_vars = $wpsc_query_data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'redirect_canonical', 'wpsc_break_canonical_redirects', 10, 2 );&nbsp;</div></li><li><div>  remove_filter( 'pre_get_posts', 'wpsc_split_the_query', 8 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_generate_product_query function.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $query</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_generate_product_query( $query ) {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  $prod_page = wpsc_get_the_post_id_by_shortcode('[productspage]');&nbsp;</div></li><li><div>  $prod_page = get_post($prod_page);&nbsp;</div></li><li><div>  remove_filter( 'pre_get_posts', 'wpsc_generate_product_query', 11 );&nbsp;</div></li><li><div>  $query-&gt;query_vars['taxonomy'] = null;&nbsp;</div></li><li><div>  $query-&gt;query_vars['term'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// default product selection</span>&nbsp;</div></li><li><div>  if ( $query-&gt;query_vars['pagename'] != '' ) {&nbsp;</div></li><li><div>      $query-&gt;query_vars['post_type'] = 'wpsc-product';&nbsp;</div></li><li><div>      $query-&gt;query_vars['pagename'] = '';&nbsp;</div></li><li><div>      $query-&gt;is_page = false;&nbsp;</div></li><li><div>      $query-&gt;is_tax = false;&nbsp;</div></li><li><div>      $query-&gt;is_archive = true;&nbsp;</div></li><li><div>      $query-&gt;is_singular = false;&nbsp;</div></li><li><div>      $query-&gt;is_single = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If wpsc_item is not null, we are looking for a product or a product category, check for category</span>&nbsp;</div></li><li><div>  if ( isset( $query-&gt;query_vars['wpsc_item'] ) && ($query-&gt;query_vars['wpsc_item'] != '') ) {&nbsp;</div></li><li><div>      $test_term = get_term_by( 'slug', $query-&gt;query_vars['wpsc_item'], 'wpsc_product_category' );&nbsp;</div></li><li><div>      if ( $test_term-&gt;slug == $query-&gt;query_vars['wpsc_item'] ) {&nbsp;</div></li><li><div>          <span class="comment">// if category exists (slug matches slug), set products to value of wpsc_item</span>&nbsp;</div></li><li><div>          $query-&gt;query_vars['products'] = $query-&gt;query_vars['wpsc_item'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// otherwise set name to value of wpsc_item</span>&nbsp;</div></li><li><div>          $query-&gt;query_vars['name'] = $query-&gt;query_vars['wpsc_item'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query-&gt;query_vars['products'] ) && ($query-&gt;query_vars['products'] != null) && ($query-&gt;query_vars['name'] != null) ) {&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['taxonomy'] );&nbsp;</div></li><li><div>      unset( $query-&gt;query_vars['term'] );&nbsp;</div></li><li><div>      $query-&gt;query_vars['post_type'] = 'wpsc-product';&nbsp;</div></li><li><div>      $query-&gt;is_tax = false;&nbsp;</div></li><li><div>      $query-&gt;is_archive = true;&nbsp;</div></li><li><div>      $query-&gt;is_singular = false;&nbsp;</div></li><li><div>      $query-&gt;is_single = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if( isset($wp_query-&gt;query_vars['wpsc_product_category']) && !isset($wp_query-&gt;query_vars['wpsc-product'])) {&nbsp;</div></li><li><div>      $query-&gt;query_vars['wpsc_product_category'] = $wp_query-&gt;query_vars['wpsc_product_category'];&nbsp;</div></li><li><div>      $query-&gt;query_vars['taxonomy'] = $wp_query-&gt;query_vars['taxonomy'];&nbsp;</div></li><li><div>      $query-&gt;query_vars['term'] = $wp_query-&gt;query_vars['term'];&nbsp;</div></li><li><div>  }elseif( '' != ($default_category = get_option('wpsc_default_category')) && !isset($wp_query-&gt;query_vars['wpsc-product'])) {&nbsp;</div></li><li><div>      $default_term = get_term($default_category, 'wpsc_product_category');&nbsp;</div></li><li><div>      if(!empty($default_term) && empty($wp_query-&gt;query_vars['category_name'])) {&nbsp;</div></li><li><div>          $query-&gt;query_vars['taxonomy'] = 'wpsc_product_category';&nbsp;</div></li><li><div>          $query-&gt;query_vars['term'] = $default_term-&gt;slug;&nbsp;</div></li><li><div>          $query-&gt;is_tax = true;&nbsp;</div></li><li><div>      }elseif(isset($wp_query-&gt;query_vars['name']) && $wp_query-&gt;is_404 && $wp_query-&gt;query_vars['category_name'] != $prod_page-&gt;post_name) {&nbsp;</div></li><li><div>          unset( $query-&gt;query_vars['taxonomy'] );&nbsp;</div></li><li><div>          unset( $query-&gt;query_vars['term'] );&nbsp;</div></li><li><div>          $query-&gt;query_vars['wpsc-product'] = $wp_query-&gt;query_vars['name'];&nbsp;</div></li><li><div>          $query-&gt;query_vars['name'] = $wp_query-&gt;query_vars['name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $query-&gt;is_tax = true;&nbsp;</div></li><li><div>          $term =    get_term_by('slug', $wp_query-&gt;query_vars['name'], 'wpsc_product_category' );&nbsp;</div></li><li><div>          if(!empty($term)) {&nbsp;</div></li><li><div>              $query-&gt;query_vars['taxonomy'] = 'wpsc_product_category';&nbsp;</div></li><li><div>              $query-&gt;query_vars['wpsc_product_category__in'] = array($term-&gt;term_taxonomy_id);&nbsp;</div></li><li><div>              $query-&gt;query_vars['wpsc_product_category'] = $wp_query-&gt;query_vars['name'];&nbsp;</div></li><li><div>              $query-&gt;query_vars['term'] = $wp_query-&gt;query_vars['name'];&nbsp;</div></li><li><div>          }elseif(is_numeric($default_category)) {&nbsp;</div></li><li><div>              $query-&gt;query_vars['taxonomy'] = 'wpsc_product_category';&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $query-&gt;is_tax = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">//If Product Tag Taxonomy</span>&nbsp;</div></li><li><div>  if (isset($wp_query-&gt;query_vars['product_tag']) && $wp_query-&gt;query_vars['product_tag']) {&nbsp;</div></li><li><div>      $query-&gt;query_vars['product_tag'] = $wp_query-&gt;query_vars['product_tag'];&nbsp;</div></li><li><div>      $query-&gt;query_vars['term'] = $wp_query-&gt;query_vars['term'];&nbsp;</div></li><li><div>      $query-&gt;query_vars['taxonomy'] = 'product_tag';&nbsp;</div></li><li><div>      $query-&gt;is_tax = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if(1 == get_option('use_pagination')) {&nbsp;</div></li><li><div>      $query-&gt;query_vars['posts_per_page'] = get_option('wpsc_products_per_page');&nbsp;</div></li><li><div>      if( isset( $_GET['items_per_page'] ) ) {&nbsp;</div></li><li><div>          if ( is_numeric( $_GET['items_per_page'] ) ) {&nbsp;</div></li><li><div>              $query-&gt;query_vars['posts_per_page'] = (int) $_GET['items_per_page'];&nbsp;</div></li><li><div>          } elseif ( $_GET['items_per_page'] == 'all' ) {&nbsp;</div></li><li><div>              $query-&gt;query_vars['posts_per_page'] = -1;&nbsp;</div></li><li><div>              $query-&gt;query_vars['nopaging'] = 1;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $query-&gt;query_vars['posts_per_page'] = -1;&nbsp;</div></li><li><div>      $query-&gt;query_vars['nopaging'] = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( $query-&gt;is_tax == true )&nbsp;</div></li><li><div>      new wpsc_products_by_category( $query );&nbsp;</div></li><li><div>  return $query;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_mark_product_query( $query ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query-&gt;query_vars['post_type'] ) && ($query-&gt;query_vars['post_type'] == 'wpsc-product') )&nbsp;</div></li><li><div>      $query-&gt;is_product = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $query;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * add meta table where section for ordering by price</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_add_meta_table_where($where) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_filter( 'posts_where', 'wpsc_add_meta_table_where' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $where . ' AND ' . $wpdb-&gt;postmeta . '.meta_key = &quot;_wpsc_price&quot;';&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * add meta table join section for ordering by price</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_add_meta_table($join) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  remove_filter( 'posts_join', 'wpsc_add_meta_table' );&nbsp;</div></li><li><div>  if(strpos($join, &quot;INNER JOIN ON (&quot;.$wpdb-&gt;posts.&quot;.ID = &quot;.$wpdb-&gt;postmeta.&quot;.post_id)&quot;) !== false) {&nbsp;</div></li><li><div>      return  ' JOIN ' . $wpdb-&gt;postmeta . ' ON ' . $wpdb-&gt;posts. '.ID = ' . $wpdb-&gt;postmeta . '.post_id';&nbsp;</div></li><li><div>  }else{&nbsp;</div></li><li><div>      return $join;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_break_canonical_redirects( $redirect_url, $requested_url ) {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( isset( $wp_query-&gt;query_vars['products'] ) && ($wp_query-&gt;query_vars['products'] != '') ) || ( isset( $wp_query-&gt;query_vars['products'] ) && $wp_query-&gt;query_vars['products'] != 'wpsc_item') )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( stristr( $requested_url, $redirect_url ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $redirect_url;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_filter_request( $q ) {&nbsp;</div></li><li><div>  if ( empty( $q['wpsc-product'] ) )&nbsp;</div></li><li><div>      return $q;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $components = explode( '/', $q['wpsc-product'] );&nbsp;</div></li><li><div>  $end_node = array_pop( $components );&nbsp;</div></li><li><div>  $parent_node = array_pop( $components );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posts = get_posts( array(&nbsp;</div></li><li><div>      'post_type' =&gt; 'wpsc-product', &nbsp;</div></li><li><div>      'name' =&gt; $end_node, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $posts ) ) {&nbsp;</div></li><li><div>      $q['wpsc-product'] = $q['name'] = $end_node;&nbsp;</div></li><li><div>      if ( !empty( $parent_node ) )&nbsp;</div></li><li><div>          $q['wpsc_product_category'] = $parent_node;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $q['wpsc_product_category'] = $end_node;&nbsp;</div></li><li><div>      unset( $q['name'] );&nbsp;</div></li><li><div>      unset( $q['wpsc-product'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $q;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * if the user is on a checkout page, force SSL if that option is so set</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_force_ssl() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (&nbsp;</div></li><li><div>      ! is_admin() &&&nbsp;</div></li><li><div>      '1' == get_option( 'wpsc_force_ssl' ) &&&nbsp;</div></li><li><div>      ! is_ssl() &&&nbsp;</div></li><li><div>      ! empty ( $wp_query-&gt;post-&gt;post_content ) &&&nbsp;</div></li><li><div>      false !== strpos( $wp_query-&gt;post-&gt;post_content, '[shoppingcart]' ) ) {&nbsp;</div></li><li><div>          $sslurl = 'https:<span class="comment">//' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];</span>&nbsp;</div></li><li><div>          wp_redirect( $sslurl );&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_add_https_to_page_url_options( $url )</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Forces SSL onto option URLs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $url</span>&nbsp;</div></li><li><div><span class="comment"> * @deprecated 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_add_https_to_page_url_options( $url ) {&nbsp;</div></li><li><div>  return str_replace( 'http:<span class="comment">//', 'https://', $url );</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks if current page is shopping cart, and it should be SSL, but is not.</span>&nbsp;</div></li><li><div><span class="comment"> * Used primarily for str_replacing links or content for https</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @deprecated 3.8.8.2</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean true if we're on the shopping cart page and should be ssl, false if not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_is_ssl() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return '1' == get_option( 'wpsc_force_ssl' ) && ! is_ssl() && false !== strpos( $wp_query-&gt;post-&gt;post_content, '[shoppingcart]' );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>