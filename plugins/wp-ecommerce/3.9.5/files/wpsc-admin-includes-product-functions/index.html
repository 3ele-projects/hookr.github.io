<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27285"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-admin-includes-product-functions | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d2a61c597624c9bf82e5f3d007e28127' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-admin-includes-product-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-admin-includes-product-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-admin-includes-product-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-admin-includes-product-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-admin-includes-product-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-admin-includes-product-f&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-admin/includes/product-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WPSC Product modifying functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package wp-e-commerce</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.7</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_get_max_upload_size() {&nbsp;</div></li><li><div>  return size_format( wp_max_upload_size() );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* wpsc_admin_submit_product function</span>&nbsp;</div></li><li><div><span class="comment">* @internal Was going to completely refactor sanitise forms and wpsc_insert_product, but they are also used by the import system</span>&nbsp;</div></li><li><div><span class="comment"> * which I'm not really familiar with...so I'm not touching them :)  Erring on the side of redundancy and caution I'll just</span>&nbsp;</div></li><li><div><span class="comment"> * refactor this to do the job.</span>&nbsp;</div></li><li><div><span class="comment">* @return nothing</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function wpsc_admin_submit_product( $post_ID, $post ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) || $post-&gt;post_type != 'wpsc-product' ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Type-casting ( not so much sanitization, which would be good to do )</span>&nbsp;</div></li><li><div>  $post_data = stripslashes_deep( $_POST );&nbsp;</div></li><li><div>  $product_id = $post_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['additional_description'] = isset( $post_data['additional_description'] ) ? $post_data['additional_description'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $post_data['meta'] ) && isset( $_POST['meta'] ) ) {&nbsp;</div></li><li><div>      $post_data['meta'] = (array) $_POST['meta'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['meta']['_wpsc_price'] ) )&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_price'] = wpsc_string_to_float( $post_data['meta']['_wpsc_price'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['meta']['_wpsc_special_price'] ) )&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_special_price'] = wpsc_string_to_float( $post_data['meta']['_wpsc_special_price'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['meta']['_wpsc_sku'] ) && $post_data['meta']['_wpsc_sku'] == __('N/A', 'wpsc') ) {&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_sku'] = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update donation setting</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['wpsc_product_pricing_nonce'] ) && wp_verify_nonce( $post_data['wpsc_product_pricing_nonce'], 'update' ) ) {&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_is_donation'] = isset( $post_data['meta']['_wpsc_is_donation'] ) ? 1 : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $post_data['meta']['_wpsc_limited_stock'] ) ) {&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_stock'] = false;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_stock'] = isset( $post_data['meta']['_wpsc_stock'] ) ? (int) $post_data['meta']['_wpsc_stock'] : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  unset($post_data['meta']['_wpsc_limited_stock']);&nbsp;</div></li><li><div>  if(!isset($post_data['quantity_limited'])) $post_data['quantity_limited'] = '';&nbsp;</div></li><li><div>  if(!isset($post_data['special'])) $post_data['special'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['quantity_limited'] = (int)(bool)$post_data['quantity_limited'];&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['special'] = (int)(bool)$post_data['special'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update Stock Options</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['wpsc_product_stock_nonce'] ) && wp_verify_nonce( $_POST['wpsc_product_stock_nonce'], 'update' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata'] = wp_parse_args( $post_data['meta']['_wpsc_product_metadata'], array(&nbsp;</div></li><li><div>          'notify_when_none_left' =&gt; 0, &nbsp;</div></li><li><div>          'unpublish_when_none_left' =&gt; 0&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['notify_when_none_left'] = absint( (bool) $post_data['meta']['_wpsc_product_metadata']['notify_when_none_left'] );&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['unpublish_when_none_left'] = absint( (bool) $post_data['meta']['_wpsc_product_metadata']['unpublish_when_none_left'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update shipping setting</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['wpsc_product_shipping_nonce'] ) && wp_verify_nonce( $_POST['wpsc_product_shipping_nonce'], 'update' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata'] = wp_parse_args( $post_data['meta']['_wpsc_product_metadata'], array(&nbsp;</div></li><li><div>          'no_shipping' =&gt; 0&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['no_shipping'] = absint( (bool) $post_data['meta']['_wpsc_product_metadata']['no_shipping'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Product Weight</span></span>&nbsp;</div></li><li><div>  if(!isset($post_data['meta']['_wpsc_product_metadata']['display_weight_as'])) $post_data['meta']['_wpsc_product_metadata']['display_weight_as'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['meta']['_wpsc_product_metadata']['weight'] ) ) {&nbsp;</div></li><li><div>      $weight = wpsc_string_to_float( $post_data['meta']['_wpsc_product_metadata']['weight'] );&nbsp;</div></li><li><div>      $weight = wpsc_convert_weight( $weight, $post_data['meta']['_wpsc_product_metadata']['weight_unit'], &quot;pound&quot;, true);&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['weight'] = $weight;&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['display_weight_as'] = $post_data['meta']['_wpsc_product_metadata']['weight_unit'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['meta']['_wpsc_product_metadata']['dimensions'] ) ) {&nbsp;</div></li><li><div>      $dimensions =& $post_data['meta']['_wpsc_product_metadata']['dimensions'];&nbsp;</div></li><li><div>      foreach ( $dimensions as $key =&gt; $value ) {&nbsp;</div></li><li><div>          if ( ! in_array( $key, array( 'height', 'width', 'length' ) ) )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $dimensions[$key] = wpsc_string_to_float( $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the table rate prices (quantity discounts)</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['wpsc-update-quantity-discounts'] ) && wp_verify_nonce( $post_data['wpsc-update-quantity-discounts'], 'update-options' ) ) {&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['table_rate_price'] = isset( $post_data['table_rate_price'] ) ? $post_data['table_rate_price'] : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If table_rate_price is empty, set empty table rate price arrays</span>&nbsp;</div></li><li><div>      if ( empty( $post_data['meta']['_wpsc_product_metadata']['table_rate_price'] ) ) {&nbsp;</div></li><li><div>          $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['table_price'] = array();&nbsp;</div></li><li><div>          $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['quantity'] = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove any rates with no quantity or price</span>&nbsp;</div></li><li><div>      if ( ! empty( $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['table_price'] ) ) {&nbsp;</div></li><li><div>          foreach ( (array) $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['quantity'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( empty( $value ) ) {&nbsp;</div></li><li><div>                  unset( $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['table_price'][ $key ] );&nbsp;</div></li><li><div>                  unset( $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['quantity'][ $key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          foreach ( (array) $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['table_price'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( empty( $value ) ) {&nbsp;</div></li><li><div>                  unset( $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['table_price'][ $key ] );&nbsp;</div></li><li><div>                  unset( $post_data['meta']['_wpsc_product_metadata']['table_rate_price']['quantity'][ $key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['meta']['_wpsc_product_metadata']['shipping'] ) ) {&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['shipping']['local'] = wpsc_string_to_float( $post_data['meta']['_wpsc_product_metadata']['shipping']['local'] );&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['shipping']['international'] = wpsc_string_to_float( $post_data['meta']['_wpsc_product_metadata']['shipping']['international'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update product taxes</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['wpsc_product_tax_nonce'] ) && wp_verify_nonce( $_POST['wpsc_product_tax_nonce'], 'update' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata'] = wp_parse_args( $post_data['meta']['_wpsc_product_metadata'], array(&nbsp;</div></li><li><div>          'wpec_taxes_taxable_amount' =&gt; '', &nbsp;</div></li><li><div>          'wpec_taxes_taxable' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>      if ( ! empty( $post_data['meta']['_wpsc_product_metadata']['wpec_taxes_taxable_amount'] ) ) {&nbsp;</div></li><li><div>          $post_data['meta']['_wpsc_product_metadata']['wpec_taxes_taxable_amount'] = wpsc_string_to_float($post_data['meta']['_wpsc_product_metadata']['wpec_taxes_taxable_amount'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['wpec_taxes_taxable'] = $post_data['meta']['_wpsc_product_metadata']['wpec_taxes_taxable'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// External Link Options</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['wpsc_product_external_link_nonce'] ) && wp_verify_nonce( $_POST['wpsc_product_external_link_nonce'], 'update' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Parse post meta to ensure default values</span>&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata'] = wp_parse_args( $post_data['meta']['_wpsc_product_metadata'], array(&nbsp;</div></li><li><div>          'external_link' =&gt; '', &nbsp;</div></li><li><div>          'external_link_text' =&gt; '', &nbsp;</div></li><li><div>          'external_link_target' =&gt; ''&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Advanced Options</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['wpsc_product_personalization_nonce'] ) && wp_verify_nonce( $_POST['wpsc_product_personalization_nonce'], 'update' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Parse post meta to ensure default values</span> (especially checkboxes)&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata'] = wp_parse_args( $post_data['meta']['_wpsc_product_metadata'], array(&nbsp;</div></li><li><div>          'engraved' =&gt; 0, &nbsp;</div></li><li><div>          'can_have_uploaded_image' =&gt; 0&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['engraved'] = absint( (bool) $post_data['meta']['_wpsc_product_metadata']['engraved'] );&nbsp;</div></li><li><div>      $post_data['meta']['_wpsc_product_metadata']['can_have_uploaded_image'] = absint( (bool) $post_data['meta']['_wpsc_product_metadata']['can_have_uploaded_image'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset($post_data['meta']['_wpsc_product_metadata']['google_prohibited'])) $post_data['meta']['_wpsc_product_metadata']['google_prohibited'] = '';&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['google_prohibited'] = (int)(bool)$post_data['meta']['_wpsc_product_metadata']['google_prohibited'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fill in any missing meta values with existing values.</span>&nbsp;</div></li><li><div>  $post_data['meta'] = wp_parse_args( $post_data['meta'], array(&nbsp;</div></li><li><div>      '_wpsc_is_donation' =&gt; get_product_meta( $product_id, 'is_donation', true )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fill in any missing product meta values with existing values.</span>&nbsp;</div></li><li><div>  $default_meta_values = wp_parse_args( get_product_meta( $product_id, 'product_metadata', true ), array(&nbsp;</div></li><li><div>      'notify_when_none_left' =&gt; 0, &nbsp;</div></li><li><div>      'unpublish_when_none_left' =&gt; 0, &nbsp;</div></li><li><div>      'no_shipping' =&gt; 0, &nbsp;</div></li><li><div>      'external_link' =&gt; '', &nbsp;</div></li><li><div>      'external_link_text' =&gt; '', &nbsp;</div></li><li><div>      'external_link_target' =&gt; '', &nbsp;</div></li><li><div>      'engraved' =&gt; 0, &nbsp;</div></li><li><div>      'can_have_uploaded_image' =&gt; 0&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata'] = wp_parse_args( $post_data['meta']['_wpsc_product_metadata'], $default_meta_values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['files'] = $_FILES;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(isset($post_data['post_title']) && $post_data['post_title'] != '') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_columns = array(&nbsp;</div></li><li><div>      'name' =&gt; '', &nbsp;</div></li><li><div>      'description' =&gt; '', &nbsp;</div></li><li><div>      'additional_description' =&gt; '', &nbsp;</div></li><li><div>      'price' =&gt; null, &nbsp;</div></li><li><div>      'weight' =&gt; null, &nbsp;</div></li><li><div>      'weight_unit' =&gt; '', &nbsp;</div></li><li><div>      'pnp' =&gt; null, &nbsp;</div></li><li><div>      'international_pnp' =&gt; null, &nbsp;</div></li><li><div>      'file' =&gt; null, &nbsp;</div></li><li><div>      'image' =&gt; '0', &nbsp;</div></li><li><div>      'quantity_limited' =&gt; '', &nbsp;</div></li><li><div>      'quantity' =&gt; null, &nbsp;</div></li><li><div>      'special' =&gt; null, &nbsp;</div></li><li><div>      'special_price' =&gt; null, &nbsp;</div></li><li><div>      'display_frontpage' =&gt; null, &nbsp;</div></li><li><div>      'notax' =&gt; null, &nbsp;</div></li><li><div>      'publish' =&gt; null, &nbsp;</div></li><li><div>      'active' =&gt; null, &nbsp;</div></li><li><div>      'donation' =&gt; null, &nbsp;</div></li><li><div>      'no_shipping' =&gt; null, &nbsp;</div></li><li><div>      'thumbnail_image' =&gt; null, &nbsp;</div></li><li><div>      'thumbnail_state' =&gt; null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $product_columns as $column =&gt; $default ) {&nbsp;</div></li><li><div>      if ( ! isset( $post_data[ $column ] ) ) {&nbsp;</div></li><li><div>          $post_data[ $column ] = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// if we succeed, we can do further editing</span> (todo - if_wp_error)</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if we have no categories selected, assign one.</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['tax_input']['wpsc_product_category'] ) && count( $post_data['tax_input']['wpsc_product_category'] ) == 1 && $post_data['tax_input']['wpsc_product_category'][0] == 0) {&nbsp;</div></li><li><div>      $post_data['tax_input']['wpsc_product_category'][1] = wpsc_add_product_category_default($product_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// and the meta</span></span>&nbsp;</div></li><li><div>  wpsc_update_product_meta($product_id, $post_data['meta']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// and the custom meta</span>&nbsp;</div></li><li><div>  wpsc_update_custom_meta($product_id, $post_data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the alternative currencies</span>&nbsp;</div></li><li><div>  if ( isset( $post_data['wpsc-update-currency-layers'] ) && wp_verify_nonce( $post_data['wpsc-update-currency-layers'], 'update-options' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Clear currencies before re-saving to make sure deleted currencies are removed</span>&nbsp;</div></li><li><div>      update_product_meta( $product_id, 'currency', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $post_data['newCurrency'] ) ) {&nbsp;</div></li><li><div>          foreach( (array) $post_data['newCurrency'] as $key =&gt;$value ) {&nbsp;</div></li><li><div>              wpsc_update_alt_product_currency( $product_id, $value, $post_data['newCurrPrice'][ $key ] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['files']['file'] ) && $post_data['files']['file']['tmp_name'] != '' ) {&nbsp;</div></li><li><div>      wpsc_item_process_file($product_id, $post_data['files']['file']);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if (!isset($post_data['select_product_file'])) $post_data['select_product_file'] = null;&nbsp;</div></li><li><div>        wpsc_item_reassign_file($product_id, $post_data['select_product_file']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(isset($post_data['files']['preview_file']['tmp_name']) && ($post_data['files']['preview_file']['tmp_name'] != '')) {&nbsp;</div></li><li><div>       wpsc_item_add_preview_file($product_id, $post_data['files']['preview_file']);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  do_action('wpsc_edit_product', $product_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $product_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_pre_update( $data , $postarr ) {&nbsp;</div></li><li><div>   if ( (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) || $postarr[&quot;post_type&quot;] != 'wpsc-product' )&nbsp;</div></li><li><div>      return $data;&nbsp;</div></li><li><div>  if( isset( $postarr[&quot;additional_description&quot;] ) )&nbsp;</div></li><li><div>      $data[&quot;post_excerpt&quot;] = $postarr[&quot;additional_description&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   if( isset( $postarr[&quot;parent_post&quot;] ) && !empty( $postarr[&quot;parent_post&quot;] ) )&nbsp;</div></li><li><div>      $data[&quot;post_parent&quot;] = $postarr[&quot;parent_post&quot;];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Sanitize status for variations (see #324)</span>&nbsp;</div></li><li><div>  if ( $data['post_parent'] && ( ! isset( $data['ID'] ) || $data['post_parent'] != $data['ID'] ) && $data['post_status'] == 'publish' ) {&nbsp;</div></li><li><div>      $data['post_status'] = 'inherit';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $postarr['meta'] ) && ( ! isset( $postarr['meta']['_wpsc_product_metadata']['enable_comments'] ) || $postarr['meta']['_wpsc_product_metadata']['enable_comments'] == 0 || empty( $postarr['meta']['_wpsc_product_metadata']['enable_comments'] ) ) ) {&nbsp;</div></li><li><div>      $data[&quot;comment_status&quot;] = &quot;closed&quot;;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $data[&quot;comment_status&quot;] = &quot;open&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Can anyone explain to me why this is here?</span>&nbsp;</div></li><li><div>  if ( isset( $sku ) && ( $sku != '' ) )&nbsp;</div></li><li><div>      $data['guid'] = $sku;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'wp_insert_post_data', 'wpsc_pre_update', 99, 2 );&nbsp;</div></li><li><div>add_action( 'save_post', 'wpsc_admin_submit_product', 5, 2 );&nbsp;</div></li><li><div>add_action( 'admin_notices', 'wpsc_admin_submit_notices' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove category meta box from variation editor. This would disassociate variations</span>&nbsp;</div></li><li><div><span class="comment"> * with the default category. See #431 (http://code.google.com/p/wp-e-commerce/issues/detail?id=431)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_variation_remove_metaboxes() {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>  if ( ! $post-&gt;post_parent )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_meta_box( 'wpsc_product_categorydiv', 'wpsc-product', 'side' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'add_meta_boxes_wpsc-product', 'wpsc_variation_remove_metaboxes', 99 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_admin_submit_notices() {&nbsp;</div></li><li><div>  global $current_screen, $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $current_screen-&gt;id != 'wpsc-product' || !isset( $_SESSION['product_error_messages'] ) )&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>  foreach ( $_SESSION['product_error_messages'] as $error )&nbsp;</div></li><li><div>      echo &quot;&lt;div id=\&quot;message\&quot; class=\&quot;updated below-h2\&quot;&gt;&lt;p&gt;&quot;.$error.&quot;&lt;/p&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>  unset( $_SESSION['product_error_messages'] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* wpsc_add_product_category_default, if there is no category assigned assign first product category as default</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @since 3.8</span>&nbsp;</div></li><li><div><span class="comment">* @param $product_id (int) the Post ID</span>&nbsp;</div></li><li><div><span class="comment">* @return null</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function wpsc_add_product_category_default( $product_id ) {&nbsp;</div></li><li><div>  $terms = get_terms( 'wpsc_product_category', array( 'orderby' =&gt; 'id', 'hide_empty' =&gt; 0 ) );&nbsp;</div></li><li><div>  if ( ! empty( $terms ) ) {&nbsp;</div></li><li><div>      $default = array_shift( $terms );&nbsp;</div></li><li><div>      wp_set_object_terms( $product_id , array( $default-&gt;slug ) , 'wpsc_product_category' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">* wpsc_sanitise_product_forms function</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @return array - Sanitised product details</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function wpsc_sanitise_product_forms($post_data = null) {&nbsp;</div></li><li><div>  if ( empty($post_data) ) {&nbsp;</div></li><li><div>      $post_data = &$_POST;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data = stripslashes_deep( $post_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['name'] = isset($post_data['post_title']) ? $post_data['post_title'] : '';&nbsp;</div></li><li><div>  $post_data['title'] = $post_data['name'];&nbsp;</div></li><li><div>  $post_data['description'] = isset($post_data['content']) ? $post_data['content'] : '';&nbsp;</div></li><li><div>  $post_data['additional_description'] = isset($post_data['additional_description']) ? $post_data['additional_description'] : '';&nbsp;</div></li><li><div>  $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(isset($post_data['publish'])) {&nbsp;</div></li><li><div>      $post_data['post_status'] = 'publish';&nbsp;</div></li><li><div>  } else if(isset($post_data['unpublish'])) {&nbsp;</div></li><li><div>      $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_price'] = wpsc_string_to_float( $post_data['meta']['_wpsc_price'] );&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_special_price'] = wpsc_string_to_float( $post_data['meta']['_wpsc_special_price'] );&nbsp;</div></li><li><div>  if (!isset($post_data['meta']['_wpsc_is_donation'])) $post_data['meta']['_wpsc_is_donation'] = '';&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_is_donation'] = (int)(bool)$post_data['meta']['_wpsc_is_donation'];&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_stock'] = (int)$post_data['meta']['_wpsc_stock'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!isset($post_data['meta']['_wpsc_limited_stock'])) $post_data['meta']['_wpsc_limited_stock'] = '';&nbsp;</div></li><li><div>  if((bool)$post_data['meta']['_wpsc_limited_stock'] != true) {&nbsp;</div></li><li><div>    $post_data['meta']['_wpsc_stock'] = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  unset($post_data['meta']['_wpsc_limited_stock']);&nbsp;</div></li><li><div>  if(!isset($post_data['meta']['_wpsc_product_metadata']['notify_when_none_left'])) $post_data['meta']['_wpsc_product_metadata']['notify_when_none_left'] = 0;&nbsp;</div></li><li><div>  if(!isset($post_data['meta']['_wpsc_product_metadata']['unpublish_when_none_left'])) $post_data['meta']['_wpsc_product_metadata']['unpublish_when_none_left'] = '';&nbsp;</div></li><li><div>  if(!isset($post_data['quantity_limited'])) $post_data['quantity_limited'] = '';&nbsp;</div></li><li><div>  if(!isset($post_data['special'])) $post_data['special'] = '';&nbsp;</div></li><li><div>  if(!isset($post_data['meta']['_wpsc_product_metadata']['no_shipping'])) $post_data['meta']['_wpsc_product_metadata']['no_shipping'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['notify_when_none_left'] = (int)(bool)$post_data['meta']['_wpsc_product_metadata']['notify_when_none_left'];&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['unpublish_when_none_left'] = (int)(bool)$post_data['meta']['_wpsc_product_metadata']['unpublish_when_none_left'];&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['quantity_limited'] = (int)(bool)$post_data['quantity_limited'];&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['special'] = (int)(bool)$post_data['special'];&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['no_shipping'] = (int)(bool)$post_data['meta']['_wpsc_product_metadata']['no_shipping'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Product Weight</span></span>&nbsp;</div></li><li><div>  if(!isset($post_data['meta']['_wpsc_product_metadata']['display_weight_as'])) $post_data['meta']['_wpsc_product_metadata']['display_weight_as'] = '';&nbsp;</div></li><li><div>  if(!isset($post_data['meta']['_wpsc_product_metadata']['display_weight_as'])) $post_data['meta']['_wpsc_product_metadata']['display_weight_as'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $weight = wpsc_string_to_float( $post_data['meta']['_wpsc_product_metadata']['weight'] );&nbsp;</div></li><li><div>  $weight = wpsc_convert_weight( $weight, $post_data['meta']['_wpsc_product_metadata']['weight_unit'], &quot;pound&quot;, true);&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['weight'] = $weight;&nbsp;</div></li><li><div>  $post_data['meta']['_wpsc_product_metadata']['display_weight_as'] = $post_data['meta']['_wpsc_product_metadata']['weight_unit'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_data['files'] = $_FILES;&nbsp;</div></li><li><div>  return $post_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  * wpsc_insert_product function</span>&nbsp;</div></li><li><div><span class="comment">  *</span>&nbsp;</div></li><li><div><span class="comment">  * @param unknown</span>&nbsp;</div></li><li><div><span class="comment">  * @return unknown</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function wpsc_insert_product($post_data, $wpsc_error = false) {&nbsp;</div></li><li><div>  global $wpdb, $user_ID;&nbsp;</div></li><li><div>  $adding = false;&nbsp;</div></li><li><div>  $update = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_columns = array(&nbsp;</div></li><li><div>      'name' =&gt; '', &nbsp;</div></li><li><div>      'description' =&gt; '', &nbsp;</div></li><li><div>      'additional_description' =&gt; '', &nbsp;</div></li><li><div>      'price' =&gt; null, &nbsp;</div></li><li><div>      'weight' =&gt; null, &nbsp;</div></li><li><div>      'weight_unit' =&gt; '', &nbsp;</div></li><li><div>      'pnp' =&gt; null, &nbsp;</div></li><li><div>      'international_pnp' =&gt; null, &nbsp;</div></li><li><div>      'file' =&gt; null, &nbsp;</div></li><li><div>      'image' =&gt; '0', &nbsp;</div></li><li><div>      'quantity_limited' =&gt; '', &nbsp;</div></li><li><div>      'quantity' =&gt; null, &nbsp;</div></li><li><div>      'special' =&gt; null, &nbsp;</div></li><li><div>      'special_price' =&gt; null, &nbsp;</div></li><li><div>      'display_frontpage' =&gt; null, &nbsp;</div></li><li><div>      'notax' =&gt; null, &nbsp;</div></li><li><div>      'publish' =&gt; null, &nbsp;</div></li><li><div>      'active' =&gt; null, &nbsp;</div></li><li><div>      'donation' =&gt; null, &nbsp;</div></li><li><div>      'no_shipping' =&gt; null, &nbsp;</div></li><li><div>      'thumbnail_image' =&gt; null, &nbsp;</div></li><li><div>      'thumbnail_state' =&gt; null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $product_columns as $column =&gt; $default ) {&nbsp;</div></li><li><div>      if ( ! isset( $post_data[ $column ] ) ) {&nbsp;</div></li><li><div>          $post_data[ $column ] = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_post_values = array(&nbsp;</div></li><li><div>      'post_author' =&gt; $user_ID, &nbsp;</div></li><li><div>      'post_content' =&gt; $post_data['description'], &nbsp;</div></li><li><div>      'post_excerpt' =&gt; $post_data['additional_description'], &nbsp;</div></li><li><div>      'post_title' =&gt; $post_data['name'], &nbsp;</div></li><li><div>      'post_status' =&gt; $post_data['post_status'], &nbsp;</div></li><li><div>      'post_type' =&gt; &quot;wpsc-product&quot;, &nbsp;</div></li><li><div>      'post_name' =&gt; sanitize_title($post_data['name'])&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  $product_post_values[&quot;comment_status&quot;] = &quot;open&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(isset($sku) && ($sku != '')) {&nbsp;</div></li><li><div>      $product_post_array['guid'] = $sku;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_id = wp_insert_post($product_post_values);&nbsp;</div></li><li><div>  if ( isset ( $post_data[&quot;sticky&quot;] ) ) {&nbsp;</div></li><li><div>      stick_post($product_id);&nbsp;</div></li><li><div>  }else {&nbsp;</div></li><li><div>      unstick_post($product_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $adding = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if we succeed, we can do further editing</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// and the meta</span></span>&nbsp;</div></li><li><div>  wpsc_update_product_meta($product_id, $post_data['meta']);&nbsp;</div></li><li><div>  do_action('wpsc_edit_product', $product_id);&nbsp;</div></li><li><div>  return $product_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * term_id_price function</span>&nbsp;</div></li><li><div><span class="comment"> * Retreives associated price, if any, with term_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer term ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer parent product price</span>&nbsp;</div></li><li><div><span class="comment"> * @return integer modified price for child product, based on term ID price and parent price</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function term_id_price($term_id, $parent_price) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $term_price_arr = get_option( 'term_prices' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($term_price_arr[$term_id]) ) {&nbsp;</div></li><li><div>      $price = $term_price_arr[$term_id][&quot;price&quot;];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $price = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//Check for flat, percentile or differential</span>&nbsp;</div></li><li><div>      $var_price_type = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (flat_price($price)) {&nbsp;</div></li><li><div>          $var_price_type = 'flat';&nbsp;</div></li><li><div>          $price = floatval($price);&nbsp;</div></li><li><div>      } elseif ( differential_price($price) ) {&nbsp;</div></li><li><div>          $var_price_type = 'differential';&nbsp;</div></li><li><div>      } elseif (percentile_price($price)) {&nbsp;</div></li><li><div>          $var_price_type = 'percentile';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (strchr($price, '-') ) {&nbsp;</div></li><li><div>          $positive = false;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $positive = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($positive) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $var_price_type == 'differential' ) {&nbsp;</div></li><li><div>              $differential = (floatval($price));&nbsp;</div></li><li><div>              $price = $parent_price + $differential;&nbsp;</div></li><li><div>          } elseif ( $var_price_type == 'percentile' ) {&nbsp;</div></li><li><div>              $percentage = (floatval($price) / 100);&nbsp;</div></li><li><div>              $price = $parent_price + ($parent_price * $percentage);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $var_price_type == 'differential' ) {&nbsp;</div></li><li><div>              $differential = (floatval($price));&nbsp;</div></li><li><div>              $price = $parent_price - $differential;&nbsp;</div></li><li><div>          } elseif ( $var_price_type == 'percentile' ) {&nbsp;</div></li><li><div>              $percentage = (floatval($price) / 100);&nbsp;</div></li><li><div>              $price = $parent_price - ($parent_price * $percentage);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  return $price;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determine the price of a variation product based on the variation it's assigned</span>&nbsp;</div></li><li><div><span class="comment"> * to. Because each variation term can have its own price (eg. 10, +10, -5%), this</span>&nbsp;</div></li><li><div><span class="comment"> * function also takes those into account.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $variation_id ID of the variation product</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $terms Optional. Defaults to false. Variation terms assigned to</span>&nbsp;</div></li><li><div><span class="comment"> * the variation product. Pass this argument to save one SQL query.</span>&nbsp;</div></li><li><div><span class="comment"> * @return float Calculated price of the variation</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_determine_variation_price( $variation_id, $term_ids = false ) {&nbsp;</div></li><li><div>  $flat = array();&nbsp;</div></li><li><div>  $diff = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $variation = get_post( $variation_id );&nbsp;</div></li><li><div>  $price = (float) get_product_meta( $variation-&gt;post_parent, 'price', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $term_ids )&nbsp;</div></li><li><div>      $term_ids = wpsc_get_product_terms( $variation_id, 'wpsc-variation', 'term_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $term_price_arr = get_option( 'term_prices' );&nbsp;</div></li><li><div>  foreach ( $term_ids as $term_id ) {&nbsp;</div></li><li><div>      if ( isset( $term_price_arr[$term_id] ) )&nbsp;</div></li><li><div>          $term_price = trim( $term_price_arr[$term_id]['price'] );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      if ( flat_price( $term_price ) ) {&nbsp;</div></li><li><div>          $flat[] = $term_price;&nbsp;</div></li><li><div>      } elseif ( differential_price( $term_price ) ) {&nbsp;</div></li><li><div>          $diff += (float) $term_price;&nbsp;</div></li><li><div>      } elseif ( percentile_price( $term_price ) ) {&nbsp;</div></li><li><div>          $diff += (float) $term_price / 100 * $price;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Variation price should at least be the maximum of all flat prices</span>&nbsp;</div></li><li><div>  if ( ! empty( $flat ) )&nbsp;</div></li><li><div>      $price = max( $flat );&nbsp;</div></li><li><div>  $price += $diff;&nbsp;</div></li><li><div>  return $price;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_edit_product_variations function.</span>&nbsp;</div></li><li><div><span class="comment"> * this is the function to make child products using variations</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $product_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $post_data</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_edit_product_variations($product_id, $post_data) {&nbsp;</div></li><li><div>  global $user_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parent = get_post_field( 'post_parent', $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! empty( $parent ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $variations = array();&nbsp;</div></li><li><div>  $product_children = array();&nbsp;</div></li><li><div>  if (!isset($post_data['edit_var_val']))&nbsp;</div></li><li><div>      $post_data['edit_var_val'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $variations = (array) $post_data['edit_var_val'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Generate the arrays for variation sets, values and combinations</span>&nbsp;</div></li><li><div>  $wpsc_combinator = new wpsc_variation_combinator($variations);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Retrieve the array containing the variation set IDs</span>&nbsp;</div></li><li><div>  $variation_sets = $wpsc_combinator-&gt;return_variation_sets();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Retrieve the array containing the combinations of each variation set to be associated with this product.</span></span>&nbsp;</div></li><li><div>  $variation_values = $wpsc_combinator-&gt;return_variation_values();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Retrieve the array containing the combinations of each variation set to be associated with this product.</span></span>&nbsp;</div></li><li><div>  $combinations = $wpsc_combinator-&gt;return_combinations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_terms = wpsc_get_product_terms( $product_id, 'wpsc-variation' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $variation_sets_and_values = array_merge($variation_sets, $variation_values);&nbsp;</div></li><li><div>  $variation_sets_and_values = apply_filters('wpsc_edit_product_variation_sets_and_values', $variation_sets_and_values, $product_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_set_object_terms($product_id, $variation_sets_and_values, 'wpsc-variation');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parent_id = absint( $_REQUEST['product_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $child_product_template = array(&nbsp;</div></li><li><div>      'post_author' =&gt; $user_ID, &nbsp;</div></li><li><div>      'post_content' =&gt; get_post_field( 'post_content', $parent_id, 'raw' ), &nbsp;</div></li><li><div>      'post_excerpt' =&gt; get_post_field( 'post_excerpt', $parent_id, 'raw' ), &nbsp;</div></li><li><div>      'post_title' =&gt; get_post_field( 'post_title', $parent_id, 'raw' ), &nbsp;</div></li><li><div>      'post_status' =&gt; 'inherit', &nbsp;</div></li><li><div>      'post_type' =&gt; &quot;wpsc-product&quot;, &nbsp;</div></li><li><div>      'post_parent' =&gt; $product_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $child_product_meta = get_post_custom($product_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// here we loop through the combinations, get the term data and generate custom product names</span>&nbsp;</div></li><li><div>  foreach($combinations as $combination) {&nbsp;</div></li><li><div>      $term_names = array();&nbsp;</div></li><li><div>      $term_ids = array();&nbsp;</div></li><li><div>      $term_slugs = array();&nbsp;</div></li><li><div>      $product_values = $child_product_template;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $combination_terms = get_terms('wpsc-variation', array(&nbsp;</div></li><li><div>          'hide_empty' =&gt; 0, &nbsp;</div></li><li><div>          'include' =&gt; implode(&quot;, &quot;, $combination), &nbsp;</div></li><li><div>          'orderby' =&gt; 'parent', &nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach($combination_terms as $term) {&nbsp;</div></li><li><div>          $term_ids[] = $term-&gt;term_id;&nbsp;</div></li><li><div>          $term_slugs[] = $term-&gt;slug;&nbsp;</div></li><li><div>          $term_names[] = $term-&gt;name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_values['post_title'] .= &quot; (&quot;.implode(&quot;, &quot;, $term_names).&quot;)&quot;;&nbsp;</div></li><li><div>      $product_values['post_name'] = sanitize_title($product_values['post_title']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $selected_post = get_posts(array(&nbsp;</div></li><li><div>          'name' =&gt; $product_values['post_name'], &nbsp;</div></li><li><div>          'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>          'post_type' =&gt; &quot;wpsc-product&quot;, &nbsp;</div></li><li><div>          'post_status' =&gt; 'all', &nbsp;</div></li><li><div>          'suppress_filters' =&gt; true&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      $selected_post = array_shift($selected_post);&nbsp;</div></li><li><div>      $child_product_id = wpsc_get_child_object_in_terms($product_id, $term_ids, 'wpsc-variation');&nbsp;</div></li><li><div>      $already_a_variation = true;&nbsp;</div></li><li><div>      if($child_product_id == false) {&nbsp;</div></li><li><div>          $already_a_variation = false;&nbsp;</div></li><li><div>          if($selected_post != null) {&nbsp;</div></li><li><div>              $child_product_id = $selected_post-&gt;ID;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $child_product_id = wp_insert_post($product_values);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// sometimes there have been problems saving the variations, this gets the correct product ID</span>&nbsp;</div></li><li><div>          if(($selected_post != null) && ($selected_post-&gt;ID != $child_product_id)) {&nbsp;</div></li><li><div>              $child_product_id = $selected_post-&gt;ID;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $product_children[] = $child_product_id;&nbsp;</div></li><li><div>      if($child_product_id &gt; 0) {&nbsp;</div></li><li><div>          wp_set_object_terms($child_product_id, $term_slugs, 'wpsc-variation');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//JS - 7.9 - Adding loop to include meta data in child product.</span>&nbsp;</div></li><li><div>      if(!$already_a_variation) {&nbsp;</div></li><li><div>          $this_child_product_meta = apply_filters( 'insert_child_product_meta', $child_product_meta, $product_id, $combination_terms );&nbsp;</div></li><li><div>          foreach ($this_child_product_meta as $meta_key =&gt; $meta_value ) :&nbsp;</div></li><li><div>              if ($meta_key == &quot;_wpsc_product_metadata&quot;) {&nbsp;</div></li><li><div>                  update_post_meta($child_product_id, $meta_key, unserialize($meta_value[0]));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  update_post_meta($child_product_id, $meta_key, $meta_value[0]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          endforeach;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_array( $term_ids ) && $price = wpsc_determine_variation_price( $child_product_id, $term_ids ) )&nbsp;</div></li><li><div>              update_product_meta( $child_product_id, 'price', $price );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//For reasons unknown, this code did not previously deal with variation deletions.</span>&nbsp;</div></li><li><div>  <span class="comment">//Basically, we'll just check if any existing term associations are missing from the posted variables, delete if they are.</span>&nbsp;</div></li><li><div>  <span class="comment">//Get posted terms (multi-dimensional array, first level = parent var, second level = child var)</span>&nbsp;</div></li><li><div>  $posted_term = $variations;&nbsp;</div></li><li><div>  <span class="comment">//Get currently associated terms</span>&nbsp;</div></li><li><div>  $currently_associated_var = $product_terms;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ($currently_associated_var as $current) {&nbsp;</div></li><li><div>      $currently_associated_vars[] = $current-&gt;term_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $posted_terms = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ($posted_term as $term=&gt;$val) {&nbsp;</div></li><li><div>      $posted_terms[] = $term;&nbsp;</div></li><li><div>      if(is_array($val)) {&nbsp;</div></li><li><div>          foreach($val as $term2=&gt;$val2) {&nbsp;</div></li><li><div>              $posted_terms[] = $term2;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($currently_associated_vars)) {&nbsp;</div></li><li><div>      $term_ids_to_delete = array();&nbsp;</div></li><li><div>      $term_ids_to_delete = array_diff($currently_associated_vars, $posted_terms);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(isset($_REQUEST[&quot;post_ID&quot;])) {&nbsp;</div></li><li><div>      $post_id = $_REQUEST[&quot;post_ID&quot;];&nbsp;</div></li><li><div>  } elseif(isset($_REQUEST[&quot;product_id&quot;])) {&nbsp;</div></li><li><div>      $post_id = $_REQUEST[&quot;product_id&quot;];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if(!empty($term_ids_to_delete) && (isset($_REQUEST[&quot;product_id&quot;]) || isset($post_id))) {&nbsp;</div></li><li><div>      $post_ids_to_delete = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Whatever remains, find child products of current product with that term, in the variation taxonomy, and delete</span>&nbsp;</div></li><li><div>      $post_ids_to_delete = wpsc_get_child_object_in_terms_var($_REQUEST[&quot;product_id&quot;], $term_ids_to_delete, 'wpsc-variation');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_array($post_ids_to_delete) && !empty($post_ids_to_delete)) {&nbsp;</div></li><li><div>          foreach($post_ids_to_delete as $object_ids) {&nbsp;</div></li><li><div>              foreach($object_ids as $object_id) {&nbsp;</div></li><li><div>                  wp_delete_post($object_id);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $current_children = get_posts(array(&nbsp;</div></li><li><div>      'post_parent' =&gt; $post_id, &nbsp;</div></li><li><div>      'post_type' =&gt; 'wpsc-product', &nbsp;</div></li><li><div>      'post_status' =&gt; 'all', &nbsp;</div></li><li><div>      'numberposts' =&gt; -1&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach((array)$current_children as $child_prod) {&nbsp;</div></li><li><div>      $childs[] = $child_prod-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if(!empty($childs)) {&nbsp;</div></li><li><div>      $old_ids_to_delete = array_diff($childs, $product_children);&nbsp;</div></li><li><div>      $old_ids_to_delete = apply_filters('wpsc_edit_product_variations_deletion', $old_ids_to_delete);&nbsp;</div></li><li><div>      if(is_array($old_ids_to_delete) && !empty($old_ids_to_delete)) {&nbsp;</div></li><li><div>          foreach($old_ids_to_delete as $object_ids) {&nbsp;</div></li><li><div>              wp_delete_post($object_ids);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  _wpsc_refresh_parent_product_terms( $parent_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_update_alt_product_currency($product_id, $newCurrency, $newPrice) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $old_curr = get_product_meta($product_id, 'currency', true);&nbsp;</div></li><li><div>  $sql = $wpdb-&gt;prepare( &quot;SELECT `isocode` FROM `&quot;.WPSC_TABLE_CURRENCY_LIST.&quot;` WHERE `id`= %d&quot;, $newCurrency );&nbsp;</div></li><li><div>  $isocode = $wpdb-&gt;get_var($sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $newCurrency = 'currency';&nbsp;</div></li><li><div>  $old_curr[$isocode] = $newPrice;&nbsp;</div></li><li><div>  if(($newPrice != '') &&  ($newPrice &gt; 0.00)) {&nbsp;</div></li><li><div>      update_product_meta($product_id, $newCurrency, $old_curr);&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if((empty($old_curr[$isocode]) || 0.00 == $old_curr[$isocode]) && is_array($old_curr))&nbsp;</div></li><li><div>          unset($old_curr[$isocode]);&nbsp;</div></li><li><div>      update_product_meta($product_id, $newCurrency, $old_curr);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_update_product_meta function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer product ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string comma separated tags</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_update_product_meta($product_id, $product_meta) {&nbsp;</div></li><li><div>  if($product_meta != null) {&nbsp;</div></li><li><div>      foreach((array)$product_meta as $key =&gt; $value) {&nbsp;</div></li><li><div>          update_post_meta($product_id, $key, $value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Called from javascript within product page to toggle publish status - AJAX</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool    publish status</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_ajax_toggle_publish() {&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @todo - Check Admin Referer</span>&nbsp;</div></li><li><div><span class="comment"> * @todo - Check Permissions</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>  $status = (wpsc_toggle_publish_status($_REQUEST['productid'])) ? ('true') : ('false');&nbsp;</div></li><li><div>  exit( $status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">/**  END - Publish /No Publish functions</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_update_custom_meta($product_id, $post_data) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $post_data['new_custom_meta'] ) && $post_data['new_custom_meta'] != null ) {&nbsp;</div></li><li><div>  foreach((array)$post_data['new_custom_meta']['name'] as $key =&gt; $name) {&nbsp;</div></li><li><div>      $value = $post_data['new_custom_meta']['value'][(int)$key];&nbsp;</div></li><li><div>      if(($name != '') && ($value != '')) {&nbsp;</div></li><li><div>      add_post_meta($product_id, $name, $value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if (!isset($post_data['custom_meta'])) $post_data['custom_meta'] = '';&nbsp;</div></li><li><div>  if($post_data['custom_meta'] != null) {&nbsp;</div></li><li><div>      foreach((array)$post_data['custom_meta'] as $key =&gt; $values) {&nbsp;</div></li><li><div>          if(($values['name'] != '') && ($values['value'] != '')) {&nbsp;</div></li><li><div>              update_post_meta($product_id, $values['name'], $values['value']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_item_process_file function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer product ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param array the file array from $_FILES</span>&nbsp;</div></li><li><div><span class="comment"> * @param array the preview file array from $_FILES</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_item_process_file( $product_id, $submitted_file, $preview_file = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'upload_dir', 'wpsc_modify_upload_directory' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $time = current_time( 'mysql' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post = get_post( $product_id ) ) {&nbsp;</div></li><li><div>      if ( substr( $post-&gt;post_date, 0, 4 ) &gt; 0 )&nbsp;</div></li><li><div>          $time = $post-&gt;post_date;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = wp_handle_upload( $submitted_file, array( 'test_form' =&gt; false ), $time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $file['error'] ) ) {&nbsp;</div></li><li><div>      return new WP_Error( 'upload_error', $file['error'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $name_parts = pathinfo( $file['file'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Construct the attachment array</span></span>&nbsp;</div></li><li><div>  $attachment = array(&nbsp;</div></li><li><div>      'post_mime_type' =&gt; $file['type'], &nbsp;</div></li><li><div>      'guid' =&gt; $file['url'], &nbsp;</div></li><li><div>      'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>      'post_title' =&gt; $name_parts['basename'], &nbsp;</div></li><li><div>      'post_content' =&gt; '', &nbsp;</div></li><li><div>      'post_type' =&gt; 'wpsc-product-file', &nbsp;</div></li><li><div>      'post_status' =&gt; 'inherit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Save the data</span></span>&nbsp;</div></li><li><div>  wp_insert_post( $attachment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_filter( 'upload_dir', 'wpsc_modify_upload_directory' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_modify_upload_directory($input) {&nbsp;</div></li><li><div>  $previous_subdir = $input['subdir'];&nbsp;</div></li><li><div>  $download_subdir = str_replace($input['basedir'], '', WPSC_FILE_DIR);&nbsp;</div></li><li><div>  $input['path'] = substr_replace(str_replace($previous_subdir, $download_subdir, $input['path']), '', -1);&nbsp;</div></li><li><div>  $input['url'] = substr_replace(str_replace($previous_subdir, $download_subdir, $input['url']), '', -1);&nbsp;</div></li><li><div>  $input['subdir'] = substr_replace(str_replace($previous_subdir, $download_subdir, $input['subdir']), '', -1);&nbsp;</div></li><li><div>  return $input;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_modify_preview_directory($input) {&nbsp;</div></li><li><div>  $previous_subdir = $input['subdir'];&nbsp;</div></li><li><div>  $download_subdir = str_replace($input['basedir'], '', WPSC_PREVIEW_DIR);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $input['path'] = substr_replace(str_replace($previous_subdir, $download_subdir, $input['path']), '', -1);&nbsp;</div></li><li><div>  $input['url'] = substr_replace(str_replace($previous_subdir, $download_subdir, $input['url']), '', -1);&nbsp;</div></li><li><div>  $input['subdir'] = substr_replace(str_replace($previous_subdir, $download_subdir, $input['subdir']), '', -1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $input;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_item_reassign_file function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer product ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string the selected file name;</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_item_reassign_file($product_id, $selected_files) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $product_file_list = array();&nbsp;</div></li><li><div>  <span class="comment">// initialise $idhash to null to prevent issues with undefined variables and error logs</span>&nbsp;</div></li><li><div>  $idhash = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'post_type' =&gt; 'wpsc-product-file', &nbsp;</div></li><li><div>      'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>      'numberposts' =&gt; -1, &nbsp;</div></li><li><div>      'post_status' =&gt; 'any'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $attached_files = (array) get_posts( $args );&nbsp;</div></li><li><div>  $attached_files_by_file = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach($attached_files as $key =&gt; $attached_file) {&nbsp;</div></li><li><div>      $attached_files_by_file[$attached_file-&gt;post_title] = $attached_files[$key];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** if we are editing, grab the current file and ID hash */</span>&nbsp;</div></li><li><div>  if(!$selected_files) {&nbsp;</div></li><li><div>      <span class="comment">// unlikely that anyone will ever upload a file called .none., so its the value used to signify clearing the product association</span>&nbsp;</div></li><li><div>      return null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach($selected_files as $selected_file) {&nbsp;</div></li><li><div>      <span class="comment">// if we already use this file, there is no point doing anything more.</span>&nbsp;</div></li><li><div>      $file_is_attached = false;&nbsp;</div></li><li><div>      $selected_file_path = WPSC_FILE_DIR.basename($selected_file);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($attached_files_by_file[$selected_file])) {&nbsp;</div></li><li><div>          $file_is_attached = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($file_is_attached == false ) {&nbsp;</div></li><li><div>          $type = wpsc_get_mimetype($selected_file_path);&nbsp;</div></li><li><div>          $attachment = array(&nbsp;</div></li><li><div>              'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>              'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>              'post_title' =&gt; $selected_file, &nbsp;</div></li><li><div>              'post_content' =&gt; '', &nbsp;</div></li><li><div>              'post_type' =&gt; &quot;wpsc-product-file&quot;, &nbsp;</div></li><li><div>              'post_status' =&gt; 'inherit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          wp_insert_post($attachment);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $product_post_values = array(&nbsp;</div></li><li><div>              'ID' =&gt; $attached_files_by_file[$selected_file]-&gt;ID, &nbsp;</div></li><li><div>              'post_status' =&gt; 'inherit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          wp_update_post($product_post_values);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach($attached_files as $attached_file) {&nbsp;</div></li><li><div>      if(!in_array($attached_file-&gt;post_title, $selected_files)) {&nbsp;</div></li><li><div>          $product_post_values = array(&nbsp;</div></li><li><div>              'ID' =&gt; $attached_file-&gt;ID, &nbsp;</div></li><li><div>              'post_status' =&gt; 'draft'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          wp_update_post($product_post_values);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_delete_preview_file</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer product ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_delete_preview_file($product_id) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>  'post_type' =&gt; 'wpsc-preview-file', &nbsp;</div></li><li><div>  'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>  'numberposts' =&gt; -1, &nbsp;</div></li><li><div>  'post_status' =&gt; 'all'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $preview_files = (array)get_posts( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach( $preview_files as $preview ) {&nbsp;</div></li><li><div>      $preview_id = $preview-&gt;ID;&nbsp;</div></li><li><div>      wp_delete_post($preview_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_item_add_preview_file function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param integer product ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param array the preview file array from $_FILES</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_item_add_preview_file($product_id, $preview_file) {&nbsp;</div></li><li><div>global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>wpsc_delete_preview_file($product_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter('upload_dir', 'wpsc_modify_preview_directory');&nbsp;</div></li><li><div>  $overrides = array('test_form'=&gt;false);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $time = current_time('mysql');&nbsp;</div></li><li><div>  if ( $post = get_post($product_id) ) {&nbsp;</div></li><li><div>      if ( substr( $post-&gt;post_date, 0, 4 ) &gt; 0 )&nbsp;</div></li><li><div>          $time = $post-&gt;post_date;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file = wp_handle_upload($preview_file, $overrides, $time);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($file['error']) )&nbsp;</div></li><li><div>      return new WP_Error( 'upload_error', $file['error'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $name_parts = pathinfo($file['file']);&nbsp;</div></li><li><div>  $name = $name_parts['basename'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = $file['url'];&nbsp;</div></li><li><div>  $type = $file['type'];&nbsp;</div></li><li><div>  $file = $file['file'];&nbsp;</div></li><li><div>  $title = $name;&nbsp;</div></li><li><div>  $content = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Construct the attachment array</span></span>&nbsp;</div></li><li><div>  $attachment = array(&nbsp;</div></li><li><div>      'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>      'guid' =&gt; $url, &nbsp;</div></li><li><div>      'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>      'post_title' =&gt; $title, &nbsp;</div></li><li><div>      'post_content' =&gt; $content, &nbsp;</div></li><li><div>      'post_type' =&gt; &quot;wpsc-preview-file&quot;, &nbsp;</div></li><li><div>      'post_status' =&gt; 'inherit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Save the data</span></span>&nbsp;</div></li><li><div>  $id = wp_insert_post($attachment, $file, $product_id);&nbsp;</div></li><li><div>  remove_filter('upload_dir', 'wpsc_modify_preview_directory');&nbsp;</div></li><li><div>    return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_variation_combinator class.</span>&nbsp;</div></li><li><div><span class="comment"> * Produces all combinations of variations selected for this product</span>&nbsp;</div></li><li><div><span class="comment"> * this class is based off the example code from here:</span>&nbsp;</div></li><li><div><span class="comment"> * http://www.php.net/manual/en/ref.array.php#94910</span>&nbsp;</div></li><li><div><span class="comment"> * Thanks, phektus, you are awesome, whoever you are.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class wpsc_variation_combinator {&nbsp;</div></li><li><div>  var $variation_sets = array();&nbsp;</div></li><li><div>  var $variation_values = array();&nbsp;</div></li><li><div>  var $reprocessed_array = array();&nbsp;</div></li><li><div>  var $combinations= array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_variation_combinator($variation_sets) {&nbsp;</div></li><li><div>  if( $variation_sets ) {&nbsp;</div></li><li><div>      foreach($variation_sets as $variation_set_id =&gt; $variation_set) {&nbsp;</div></li><li><div>          $this-&gt;variation_sets[] = absint($variation_set_id);&nbsp;</div></li><li><div>          $new_variation_set = array();&nbsp;</div></li><li><div>          if( $variation_set ) {&nbsp;</div></li><li><div>              foreach($variation_set as $variation =&gt; $active) {&nbsp;</div></li><li><div>                  if($active == 1) {&nbsp;</div></li><li><div>                      $new_variation_set[] = array(absint($variation));&nbsp;</div></li><li><div>                      $this-&gt;variation_values[] = $variation;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;reprocessed_array[] = $new_variation_set;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;get_combinations(array(), $this-&gt;reprocessed_array, 0);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function get_combinations($batch, $elements, $i)  {&nbsp;</div></li><li><div>      if ($i &gt;= count($elements)) {&nbsp;</div></li><li><div>          $this-&gt;combinations[] = $batch;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          foreach ($elements[$i] as $element) {&nbsp;</div></li><li><div>              $this-&gt;get_combinations(array_merge($batch, $element), $elements, $i + 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function return_variation_sets() {&nbsp;</div></li><li><div>      return $this-&gt;variation_sets;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function return_variation_values() {&nbsp;</div></li><li><div>      return $this-&gt;variation_values;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function return_combinations() {&nbsp;</div></li><li><div>      return $this-&gt;combinations;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_variations_stock_remaining($product_id) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  return $wpdb-&gt;get_var( $wpdb-&gt;prepare( '&nbsp;</div></li><li><div>      SELECT&nbsp;</div></li><li><div>          sum(`pm`.`meta_value`)&nbsp;</div></li><li><div>      FROM&nbsp;</div></li><li><div>          `' . $wpdb-&gt;postmeta . '` `pm`&nbsp;</div></li><li><div>      JOIN&nbsp;</div></li><li><div>          `' . $wpdb-&gt;posts . '` `p`&nbsp;</div></li><li><div>          ON&nbsp;</div></li><li><div>          `pm`.`post_id` = `p`.`id`&nbsp;</div></li><li><div>      WHERE&nbsp;</div></li><li><div>          `p`.`post_type`= &quot;wpsc-product&quot;&nbsp;</div></li><li><div>          AND&nbsp;</div></li><li><div>          `p`.`post_parent` = %d&nbsp;</div></li><li><div>          AND&nbsp;</div></li><li><div>          `pm`.`meta_key` = &quot;_wpsc_stock&quot;&nbsp;</div></li><li><div>  ', $product_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function flat_price( $price ) {&nbsp;</div></li><li><div>  if ( ! empty( $price ) && strchr( $price, '-' ) === false && strchr( $price, '+' ) === false && strchr( $price, '%' ) === false )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function percentile_price( $price ) {&nbsp;</div></li><li><div>  if ( ! empty( $price ) && ( strchr( $price, '-' ) || strchr( $price, '+' ) ) && strchr( $price, '%' ) )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function differential_price( $price ) {&nbsp;</div></li><li><div>  if ( ! empty( $price ) && ( strchr( $price, '-' ) || strchr( $price, '+' ) ) && strchr( $price, '%' ) === false )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Refresh variation terms assigned to parent product based on the variations it has.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $parent_id Parent product ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_refresh_parent_product_terms( $parent_id ) {&nbsp;</div></li><li><div>  $children = get_children( array(&nbsp;</div></li><li><div>      'post_parent' =&gt; $parent_id, &nbsp;</div></li><li><div>      'post_status' =&gt; array( 'publish', 'inherit' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $children_ids = wp_list_pluck( $children, 'ID' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $children_terms = wp_get_object_terms( $children_ids, 'wpsc-variation' );&nbsp;</div></li><li><div>  $new_terms = array();&nbsp;</div></li><li><div>  foreach ( $children_terms as $term ) {&nbsp;</div></li><li><div>      if ( $term-&gt;parent )&nbsp;</div></li><li><div>          $new_terms[] = $term-&gt;parent;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $children_term_ids = wp_list_pluck( $children_terms, 'term_id' );&nbsp;</div></li><li><div>  $new_terms = array_merge( $new_terms, $children_term_ids );&nbsp;</div></li><li><div>  $new_terms = array_unique( $new_terms );&nbsp;</div></li><li><div>  $new_terms = array_map( 'absint', $new_terms );&nbsp;</div></li><li><div>  wp_set_object_terms( $parent_id, $new_terms, 'wpsc-variation' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Make sure parent product's assigned terms are refreshed when its variations are deleted or trashed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $post_id Parent product ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_action_refresh_variation_parent_terms( $post_id ) {&nbsp;</div></li><li><div>  $post = get_post( $post_id );&nbsp;</div></li><li><div>  if ( $post-&gt;post_type != 'wpsc-product' || ! $post-&gt;post_parent || in_array( $post-&gt;post_status, array( 'publish', 'inherit' ) ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  _wpsc_refresh_parent_product_terms( $post-&gt;post_parent );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Make sure parent product's assigned terms are refresh when its variations' statuses are changed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $new_status New status</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $old_status Old status</span>&nbsp;</div></li><li><div><span class="comment"> * @param  object $post       Variation object</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_action_transition_post_status( $new_status, $old_status, $post ) {&nbsp;</div></li><li><div>  if ( $post-&gt;post_type != 'wpsc-product' || ! $post-&gt;post_parent )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  _wpsc_refresh_parent_product_terms( $post-&gt;post_parent );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Prevent parent terms from being refreshed when its variations are updated. This is useful when</span>&nbsp;</div></li><li><div><span class="comment"> * the variations are being mass updated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_remove_refresh_variation_parent_term_hooks() {&nbsp;</div></li><li><div>  remove_action( 'transition_post_status', '_wpsc_action_transition_post_status', 10, 3 );&nbsp;</div></li><li><div>  remove_action( 'deleted_post', '_wpsc_action_refresh_variation_parent_terms', 10, 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add hooks so that parent product's assigned terms are refreshed when its variations are updated.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_add_refresh_variation_parent_term_hooks() {&nbsp;</div></li><li><div>  add_action( 'transition_post_status', '_wpsc_action_transition_post_status', 10, 3 );&nbsp;</div></li><li><div>  add_action( 'deleted_post', '_wpsc_action_refresh_variation_parent_terms', 10, 1 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>_wpsc_add_refresh_variation_parent_term_hooks();&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>