<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27509"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-components-theme-engine-v1-helpers-page | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=bbe8bc69c48095c2e1ef67a5d941f798' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-components-theme-engine-v1-helpers-page/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-helpers-page%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-helpers-page%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-components-theme-engine-v1-helpers-page","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-components-theme-engine-v1-helpers-page" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-components-theme-engine-&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-components/theme-engine-v1/helpers/page.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'wpsc_loaded', 'wpsc_core_load_page_titles' );&nbsp;</div></li><li><div>add_action( 'init', 'wpsc_register_core_theme_files' );&nbsp;</div></li><li><div>add_action( 'wpsc_move_theme', 'wpsc_flush_theme_transients', 10, true );&nbsp;</div></li><li><div>add_action( 'wpsc_switch_theme', 'wpsc_flush_theme_transients', 10, true );&nbsp;</div></li><li><div>add_action( 'switch_theme', 'wpsc_flush_theme_transients', 10, true );&nbsp;</div></li><li><div>add_action( 'admin_init', 'wpsc_theme_admin_notices');&nbsp;</div></li><li><div>add_action( 'update_option_product_image_width' , 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>add_action( 'update_option_product_image_height' , 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>add_action( 'update_option_single_view_image_width' , 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>add_action( 'update_option_single_view_image_height', 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>add_action( 'update_option_category_image_width' , 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>add_action( 'update_option_category_image_height' , 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>add_action( 'template_redirect', 'wpsc_all_products_on_page');&nbsp;</div></li><li><div>add_filter( 'aioseop_description', 'wpsc_set_aioseop_description' );&nbsp;</div></li><li><div>add_filter( 'request', 'wpsc_remove_page_from_query_string');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//Potentially unnecessary, as I believe this option is deprecated</span>&nbsp;</div></li><li><div>add_action( 'update_option_show_categorybrands' , 'wpsc_cache_to_upload' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! is_admin() )&nbsp;</div></li><li><div>  add_action( 'init', 'wpsc_enqueue_user_script_and_css' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_REQUEST['wpsc_flush_theme_transients'] ) && ( $_REQUEST['wpsc_flush_theme_transients'] == 'true' ) )&nbsp;</div></li><li><div>  add_action( 'admin_init', 'wpsc_force_flush_theme_transients' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( isset( $_GET['wpsc_user_dynamic_css'] ) && 'true' == $_GET['wpsc_user_dynamic_css'] )&nbsp;</div></li><li><div>  add_action( 'plugins_loaded', 'wpsc_user_dynamic_css', 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! is_admin() )&nbsp;</div></li><li><div>  add_filter('request', 'wpec_remap_shop_subpages');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if(get_option( 'wpsc_hide_featured_products' ) == 1)&nbsp;</div></li><li><div>  add_action( 'wpsc_top_of_products_page', 'wpsc_display_featured_products_page', 12 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$show_subcatsprods_in_cat = get_option( 'show_subcatsprods_in_cat' );&nbsp;</div></li><li><div>if(!$show_subcatsprods_in_cat)&nbsp;</div></li><li><div>  add_action( 'init', 'wpsc_hidesubcatprods_init' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_register_theme_file( $file_name )</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Adds a file name to a global list of</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $file_name Name of file to add to global list of files</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_register_theme_file( $file_name ) {&nbsp;</div></li><li><div>  global $wpec_theme_files;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !in_array( $file_name, (array)$wpec_theme_files ) )&nbsp;</div></li><li><div>      $wpec_theme_files[] = $file_name;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_register_core_theme_files()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Registers the core WPEC files into the global array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_register_core_theme_files() {&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-single_product.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-grid_view.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-list_view.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-products_page.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-shopping_cart_page.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-transaction_results.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-user-log.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-cart_widget.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-featured_product.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-category-list.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-category_widget.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-account-downloads.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-account-edit-profile.php' );&nbsp;</div></li><li><div>  wpsc_register_theme_file( 'wpsc-account-purchase-history.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Let other plugins register their theme files */</span>&nbsp;</div></li><li><div>  do_action( 'wpsc_register_core_theme_files' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_get_theme_files()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the global wpec_theme_files</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @global array $wpec_theme_files</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_theme_files() {&nbsp;</div></li><li><div>  global $wpec_theme_files;&nbsp;</div></li><li><div>  if ( empty( $wpec_theme_files ) )&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return apply_filters( 'wpsc_get_theme_files', (array)array_values( $wpec_theme_files ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_flush_theme_transients()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function will delete the temporary values stored in WordPress transients</span>&nbsp;</div></li><li><div><span class="comment"> * for all of the additional WPEC theme files and their locations. This is</span>&nbsp;</div></li><li><div><span class="comment"> * mostly used when the active theme changes, or when files are moved around. It</span>&nbsp;</div></li><li><div><span class="comment"> * does a complete flush of all possible path/url combinations of files.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_get_theme_files</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_flush_theme_transients( $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( true === $force || isset( $_REQUEST['wpsc_flush_theme_transients'] ) && !empty( $_REQUEST['wpsc_flush_theme_transients'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop through current theme files and remove transients</span>&nbsp;</div></li><li><div>      if ( $theme_files = wpsc_get_theme_files() ) {&nbsp;</div></li><li><div>          foreach( $theme_files as $file ) {&nbsp;</div></li><li><div>              delete_transient( WPEC_TRANSIENT_THEME_PATH_PREFIX . $file );&nbsp;</div></li><li><div>              delete_transient( WPEC_TRANSIENT_THEME_URL_PREFIX . $file );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          delete_transient( 'wpsc_theme_path' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No files were registered so return false</span>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_force_flush_theme_transients() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! wpsc_is_store_admin() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Flush transients</span>&nbsp;</div></li><li><div>  wpsc_flush_theme_transients( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Bounce back</span>&nbsp;</div></li><li><div>  $sendback = wp_get_referer();&nbsp;</div></li><li><div>  wp_redirect( $sendback );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  exit();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_check_theme_location()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Check theme location, compares the active theme and the themes within WPSC_CORE_THEME_PATH</span>&nbsp;</div></li><li><div><span class="comment"> * finds files of the same name.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param null</span>&nbsp;</div></li><li><div><span class="comment"> * @return $results (Array) of Files OR false if no similar files are found</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_check_theme_location() {&nbsp;</div></li><li><div>  <span class="comment">// Get the current theme</span>&nbsp;</div></li><li><div>  $current_theme = get_stylesheet_directory();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load up the files in the current theme</span>&nbsp;</div></li><li><div>  $current_theme_files = wpsc_list_product_templates( $current_theme . '/' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Load up the files in the wpec themes folder</span>&nbsp;</div></li><li><div>  $wpsc_template_files = wpsc_list_product_templates( WPSC_CORE_THEME_PATH );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Compare the two</span>&nbsp;</div></li><li><div>  $results = array_intersect( $current_theme_files, $wpsc_template_files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return the differences</span>&nbsp;</div></li><li><div>  if ( count( $results ) &gt; 0 )&nbsp;</div></li><li><div>      return $results;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No differences so return false</span>&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_list_product_templates( $path = '' )</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Lists the files within the WPSC_CORE_THEME_PATH directory</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $path - you can provide a path to find the files within it</span>&nbsp;</div></li><li><div><span class="comment"> * @return $templates (Array) List of files</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_list_product_templates( $path = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $selected_theme = get_option( 'wpsc_selected_theme' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no path, then try to make some assuptions</span>&nbsp;</div></li><li><div>  if ( empty( $path ) ) {&nbsp;</div></li><li><div>      if ( file_exists( WPSC_OLD_THEMES_PATH . $selected_theme . '/' . $selected_theme . '.css' ) ) {&nbsp;</div></li><li><div>          $path = WPSC_OLD_THEMES_PATH . $selected_theme . '/';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $path = WPSC_CORE_THEME_PATH;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Open the path and get the file names</span>&nbsp;</div></li><li><div>  $dh = opendir( $path );&nbsp;</div></li><li><div>  while ( ( $file = readdir( $dh ) ) !== false ) {&nbsp;</div></li><li><div>      if ( $file != &quot;.&quot; && $file != &quot;..&quot; && !strstr( $file, &quot;.svn&quot; ) && !strstr( $file, &quot;images&quot; ) && is_file( $path . $file ) ) {&nbsp;</div></li><li><div>          $templates[] = $file;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return template names</span>&nbsp;</div></li><li><div>  return $templates;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the theme upgrade notice</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param null</span>&nbsp;</div></li><li><div><span class="comment"> * @return null</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_theme_upgrade_notice() { ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php printf( __( '&lt;strong&gt;WP eCommerce is ready&lt;/strong&gt;. If you plan on editing the look of your site, you should &lt;a href=&quot;%1s&quot;&gt;update your active theme&lt;/a&gt; to include the additional WP eCommerce files. &lt;a href=&quot;%2s&quot;&gt;Click here&lt;/a&gt; to ignore and remove this box.', 'wpsc' ), admin_url( 'admin.php?page=wpsc-settings&tab=presentation' ), admin_url( 'admin.php?page=wpsc-settings&tab=presentation&wpsc_notices=theme_ignore' ) ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the database update notice</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param null</span>&nbsp;</div></li><li><div><span class="comment"> * @return null</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_database_update_notice() { ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;div class=&quot;error fade&quot;&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php printf( __( '&lt;strong&gt;Your WP eCommerce data needs to be updated&lt;/strong&gt;. You\'ve upgraded from a previous version of the WP eCommerce plugin, and your store needs updating.&lt;br&gt;You should &lt;a href=&quot;%1s&quot;&gt;update your database&lt;/a&gt; for your store to continue working.', 'wpsc' ), admin_url( 'index.php?page=wpsc-update' ) ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_theme_admin_notices() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check to see if WP eCommerce is installed before showing upgrade notices.</span>&nbsp;</div></li><li><div>  if ( false !== get_option( 'wpsc_version' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Database update notice is most important</span>&nbsp;</div></li><li><div>      if ( get_option ( 'wpsc_version' ) &lt; 3.8 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_action ( 'admin_notices', 'wpsc_database_update_notice' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If that's not an issue check if theme updates required</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( '' === get_option( 'wpsc_ignore_theme', '' ) ) {&nbsp;</div></li><li><div>              add_option( 'wpsc_ignore_theme', false );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! get_option( 'wpsc_ignore_theme' ) ) {&nbsp;</div></li><li><div>              add_action( 'admin_notices', 'wpsc_theme_upgrade_notice' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Flag config inconsistencies</span>&nbsp;</div></li><li><div>  if ( 1 == get_option( 'require_register' ) && 1 != get_option( 'users_can_register' ) ) {&nbsp;</div></li><li><div>      add_action( 'admin_notices', 'wpsc_turn_on_wp_register' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_turn_on_wp_register() {?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&nbsp;</div></li><li><div>      &lt;p&gt;&lt;?php printf( __( '&lt;strong&gt;Store Settings&lt;/strong&gt;: You have set \'users must register before checkout\', for this to work you need to check \'Anyone can register\' in your WordPress &lt;a href=&quot;%1s&quot;&gt;General Settings&lt;/a&gt;.', 'wpsc' ), admin_url( 'options-general.php' ) ) ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>  &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_get_template_file_url( $file )</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks the active theme folder for the particular file, if it exists then</span>&nbsp;</div></li><li><div><span class="comment"> * return the active theme url, otherwise return the global wpsc_theme_url</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $file string filename</span>&nbsp;</div></li><li><div><span class="comment"> * @return PATH to the file</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_template_file_url( $file = '' ) {&nbsp;</div></li><li><div>  <span class="comment">// If we're not looking for a file, do not proceed</span>&nbsp;</div></li><li><div>  if ( empty( $file ) )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Look for file in stylesheet</span>&nbsp;</div></li><li><div>  if ( file_exists( get_stylesheet_directory() . '/' . $file ) ) {&nbsp;</div></li><li><div>      $file_url = get_stylesheet_directory_uri() . '/' . $file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Look for file in template</span>&nbsp;</div></li><li><div>  } elseif ( file_exists( get_template_directory() . '/' . $file ) ) {&nbsp;</div></li><li><div>      $file_url = get_template_directory_uri() . '/' . $file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Backwards compatibility</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Look in old theme url</span>&nbsp;</div></li><li><div>      $selected_theme_check = WPSC_OLD_THEMES_PATH . get_option( 'wpsc_selected_theme' ) . '/' . str_ireplace( 'wpsc-', '', $file );&nbsp;</div></li><li><div>      <span class="comment">// Check the selected theme</span>&nbsp;</div></li><li><div>      if ( file_exists( $selected_theme_check ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $file_url = WPSC_OLD_THEMES_URL . get_option( 'wpsc_selected_theme' ) . '/' . str_ireplace( 'wpsc-', '', $file );&nbsp;</div></li><li><div>      <span class="comment">// Use the bundled theme CSS</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $file_url = WPSC_CORE_THEME_URL . $file;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file_url = set_url_scheme( $file_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return filtered result</span>&nbsp;</div></li><li><div>  return apply_filters( WPEC_TRANSIENT_THEME_URL_PREFIX . $file, $file_url );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_user_enqueues products function, </span>&nbsp;</div></li><li><div><span class="comment"> * enqueue all javascript and CSS for wp ecommerce</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_enqueue_user_script_and_css() {&nbsp;</div></li><li><div>  global $wp_styles, $wpsc_theme_url, $wp_query;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * added by xiligroup.dev to be compatible with touchshop</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  if ( has_filter( 'wpsc_enqueue_user_script_and_css' ) && apply_filters( 'wpsc_mobile_scripts_css_filters', false ) ) {&nbsp;</div></li><li><div>      do_action( 'wpsc_enqueue_user_script_and_css' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * end of added by xiligroup.dev to be compatible with touchshop</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $version_identifier = WPSC_VERSION . '.' . WPSC_MINOR_VERSION;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $category_id = wpsc_get_current_category_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_option( 'wpsc_share_this' ) == 1 ) {&nbsp;</div></li><li><div>          $remote_protocol = is_ssl() ? 'https:<span class="comment">//ws' : 'http://w';</span>&nbsp;</div></li><li><div>          wp_enqueue_script( 'sharethis', $remote_protocol . '.sharethis.com/button/buttons.js', array(), false, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script( 'jQuery' );&nbsp;</div></li><li><div>      wp_enqueue_script( 'wp-e-commerce', WPSC_CORE_JS_URL . '/wp-e-commerce.js', array( 'jquery' ), $version_identifier );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( defined( 'WPEC_LOAD_DEPRECATED_JS' ) && WPEC_LOAD_DEPRECATED_JS ) {&nbsp;</div></li><li><div>          wp_enqueue_script( 'wpsc-deprecated', WPSC_CORE_JS_URL . '/wpsc-deprecated.js', 'wp-e-commerce', $version_identifier );&nbsp;</div></li><li><div>          wp_localize_script( 'wpsc-deprecated', 'wpsc_deprecated_js_vars', _wpsc_deprecated_javascript_localization_vars() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script( 'wp-e-commerce', WPSC_CORE_JS_URL . '/wp-e-commerce.js', array( 'jquery' ), $version_identifier );&nbsp;</div></li><li><div>      wp_localize_script( 'wp-e-commerce', 'wpsc_vars', wpsc_javascript_localizations() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script( 'livequery', WPSC_URL             . '/wpsc-admin/js/jquery.livequery.js', array( 'jquery' ), '1.0.3' );&nbsp;</div></li><li><div>      if ( get_option( 'product_ratings' ) == 1 )&nbsp;</div></li><li><div>          wp_enqueue_script( 'jquery-rating', WPSC_CORE_JS_URL     . '/jquery.rating.js', array( 'jquery' ), $version_identifier );&nbsp;</div></li><li><div>      wp_enqueue_script( 'wp-e-commerce-legacy', WPSC_CORE_JS_URL     . '/user.js', array( 'jquery' ), WPSC_VERSION . WPSC_MINOR_VERSION );&nbsp;</div></li><li><div>      if ( get_option( 'show_thumbnails_thickbox' ) == 1 ) {&nbsp;</div></li><li><div>          $lightbox = get_option('wpsc_lightbox', 'thickbox');&nbsp;</div></li><li><div>          if( $lightbox == 'thickbox' ) {&nbsp;</div></li><li><div>              wp_enqueue_script( 'wpsc-thickbox', WPSC_CORE_JS_URL . '/thickbox.js', array( 'jquery' ), 'Instinct_e-commerce' );&nbsp;</div></li><li><div>              wp_enqueue_style( 'wpsc-thickbox', WPSC_CORE_JS_URL . '/thickbox.css', false, $version_identifier, 'all' );&nbsp;</div></li><li><div>          } elseif( $lightbox == 'colorbox' ) {&nbsp;</div></li><li><div>              wp_enqueue_script( 'colorbox-min', WPSC_CORE_JS_URL . '/jquery.colorbox-min.js', array( 'jquery' ), 'Instinct_e-commerce' );&nbsp;</div></li><li><div>              wp_enqueue_script( 'wpsc_colorbox', WPSC_CORE_JS_URL . '/wpsc_colorbox.js', array( 'jquery', 'colorbox-min' ), 'Instinct_e-commerce' );&nbsp;</div></li><li><div>              wp_enqueue_style( 'wpsc-colorbox-css', WPSC_CORE_JS_URL . '/wpsc_colorbox.css', false, $version_identifier, 'all' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_enqueue_style( 'wpsc-theme-css', wpsc_get_template_file_url( 'wpsc-' . get_option( 'wpsc_selected_theme' ) . '.css' ), false, $version_identifier, 'all' );&nbsp;</div></li><li><div>      wp_enqueue_style( 'wpsc-theme-css-compatibility', wpsc_get_template_file_url( 'compatibility.css' ), array( 'wpsc-theme-css' ), $version_identifier, 'all' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( function_exists( 'wp_add_inline_style' ) )&nbsp;</div></li><li><div>          wp_add_inline_style( 'wpsc-theme-css', wpsc_get_user_dynamic_css() );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          wp_enqueue_style( 'wp-e-commerce-dynamic', wpsc_get_dynamic_user_css_url(), array( 'wpsc-theme-css' ), $version_identifier );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( get_option( 'product_ratings' ) == 1 )&nbsp;</div></li><li><div>          wp_enqueue_style( 'wpsc-product-rater', WPSC_CORE_JS_URL     . '/product_rater.css', false, $version_identifier, 'all' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !defined( 'WPSC_MP3_MODULE_USES_HOOKS' ) && function_exists( 'listen_button' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      function wpsc_legacy_add_mp3_preview( $product_id, &$product_data ) {&nbsp;</div></li><li><div>          global $wpdb;&nbsp;</div></li><li><div>          if ( function_exists( 'listen_button' ) ) {&nbsp;</div></li><li><div>              $file_data = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT * FROM `&quot; . WPSC_TABLE_PRODUCT_FILES . &quot;` WHERE `id` = %d LIMIT 1&quot;, $product_data['file'] ), ARRAY_A );&nbsp;</div></li><li><div>              if ( $file_data != null ) {&nbsp;</div></li><li><div>                  echo listen_button( $file_data['idhash'], $file_data['id'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wpsc_product_before_description', 'wpsc_legacy_add_mp3_preview', 10, 2 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks the category slug for a display type, if none set returns default</span>&nbsp;</div></li><li><div><span class="comment"> * &lt;&lt; May need reworking to be more specific to the taxonomy type &gt;&gt;</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $slug(string)</span>&nbsp;</div></li><li><div><span class="comment"> * @return $slug either from db or 'default' if none set</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_get_the_category_display($slug) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $default_display_type = get_option('product_view');&nbsp;</div></li><li><div>  if ( !empty($slug) && is_string($slug) ) {&nbsp;</div></li><li><div>      $category_id = wpsc_get_the_category_id($slug , 'slug');&nbsp;</div></li><li><div>      $display_type = wpsc_get_categorymeta( $category_id, 'display_type' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if(!empty($display_type))&nbsp;</div></li><li><div>      return $display_type;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return  $default_display_type;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc display products function</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - html displaying one or more products</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_display_products_page( $query ) {&nbsp;</div></li><li><div>  global $wpdb, $wpsc_query, $wp_query, $wp_the_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_filter('the_title', 'wpsc_the_category_title');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the data is coming from a shortcode parse the values into the args variable, </span>&nbsp;</div></li><li><div>  <span class="comment">// I did it this was to preserve backwards compatibility</span>&nbsp;</div></li><li><div>  if(!empty($query)) {&nbsp;</div></li><li><div>      $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['post_type'] = 'wpsc-product';&nbsp;</div></li><li><div>      if(!empty($query['product_id']) && is_array($query['product_id'])) {&nbsp;</div></li><li><div>          $args['post__in'] = $query['product_id'];&nbsp;</div></li><li><div>      }elseif(is_string($query['product_id'])) {&nbsp;</div></li><li><div>          $args['post__in'] = (array)$query['product_id'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['old_product_id'])) {&nbsp;</div></li><li><div>          $post_id = wpsc_get_the_new_id($query['old_product_id']);&nbsp;</div></li><li><div>          $args['post__in'] = (array)$post_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['price']) && 'sale' != $query['price']) {&nbsp;</div></li><li><div>          $args['meta_key'] = '_wpsc_price';&nbsp;</div></li><li><div>          $args['meta_value'] = $query['price'];&nbsp;</div></li><li><div>      }elseif(!empty($query['price']) && 'sale' == $query['price']) {&nbsp;</div></li><li><div>          $args['meta_key'] = '_wpsc_special_price';&nbsp;</div></li><li><div>          $args['meta_compare'] = '&gt;=';&nbsp;</div></li><li><div>          $args['meta_value'] = '1';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['product_name'])) {&nbsp;</div></li><li><div>          $args['pagename'] = $query['product_name'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['category_id'])) {&nbsp;</div></li><li><div>          $term = get_term($query['category_id'], 'wpsc_product_category');&nbsp;</div></li><li><div>          $id = wpsc_get_meta($query['category_id'], 'category_id', 'wpsc_old_category');&nbsp;</div></li><li><div>          if( !empty($id)) {&nbsp;</div></li><li><div>              $term = get_term($id, 'wpsc_product_category');&nbsp;</div></li><li><div>              $args['wpsc_product_category'] = $term-&gt;slug;&nbsp;</div></li><li><div>              $args['wpsc_product_category__in'] = $term-&gt;term_id;&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $args['wpsc_product_category'] = $term-&gt;slug;&nbsp;</div></li><li><div>              $args['wpsc_product_category__in'] = $term-&gt;term_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['category_url_name'])) {&nbsp;</div></li><li><div>          $args['wpsc_product_category'] = $query['category_url_name'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $orderby = ( !empty($query['sort_order']) ) ? $query['sort_order'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = array_merge( $args, wpsc_product_sort_order_query_vars($orderby) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!empty($query['order'])) {&nbsp;</div></li><li><div>          $args['order'] = $query['order'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['limit_of_items']) && '1' == get_option('use_pagination')) {&nbsp;</div></li><li><div>          $args['posts_per_page'] = $query['limit_of_items'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($query['number_per_page']) && '1' == get_option('use_pagination')) {&nbsp;</div></li><li><div>          $args['posts_per_page'] = $query['number_per_page'];&nbsp;</div></li><li><div>          $args['paged'] = $query['page'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if( '0' == get_option('use_pagination') ) {&nbsp;</div></li><li><div>          $args['nopaging'] = true;&nbsp;</div></li><li><div>          $args['posts_per_page'] = '-1';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $query['tag'] ) ) {&nbsp;</div></li><li><div>          $args['product_tag'] = $query['tag'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      query_posts( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// swap the wpsc_query object</span></span>s</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $GLOBALS['nzshpcrt_activateshpcrt'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Pretty sure this single_product code is legacy...but fixing it up just in case.</span>&nbsp;</div></li><li><div>  <span class="comment">// get the display type for the selected category</span>&nbsp;</div></li><li><div>  if(!empty($wpsc_query-&gt;query_vars['term']))&nbsp;</div></li><li><div>      $display_type = wpsc_get_the_category_display($wpsc_query-&gt;query_vars['term']);&nbsp;</div></li><li><div>  elseif( !empty( $args['wpsc_product_category'] ) )&nbsp;</div></li><li><div>      $display_type = wpsc_get_the_category_display($args['wpsc_product_category']);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $display_type = 'default';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $saved_display = wpsc_get_customer_meta( 'display_type' );&nbsp;</div></li><li><div>  $display_type = ! empty( $saved_display ) ? $saved_display : $display_type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'wpsc_display_products_page', $display_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( isset( $wp_query-&gt;post ) && 'wpsc-product' == $wp_query-&gt;post-&gt;post_type ) && ! is_archive() && $wp_query-&gt;post_count &lt;= 1 )&nbsp;</div></li><li><div>      include( wpsc_get_template_file_path( 'wpsc-single_product.php' ) );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      wpsc_include_products_page_template( $display_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = ob_get_contents();&nbsp;</div></li><li><div>  ob_end_clean();&nbsp;</div></li><li><div>  $output = str_replace( '\$', '$', $output );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $query ) ) {&nbsp;</div></li><li><div>      wp_reset_query();&nbsp;</div></li><li><div>      wp_reset_postdata();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks if wpsc-single_product.php has been moved to the active theme, if it has then include the</span>&nbsp;</div></li><li><div><span class="comment"> * template from the active theme.</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $content content of the page</span>&nbsp;</div></li><li><div><span class="comment"> * @return $content with wpsc-single_product content if its a single product</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_single_template( $content ) {&nbsp;</div></li><li><div>  global $wpdb, $post, $wp_query, $wpsc_query, $_wpsc_is_in_custom_loop;&nbsp;</div></li><li><div>  if ( ! in_the_loop() )&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">//if we dont belong here exit out straight away</span>&nbsp;</div></li><li><div>  if((!isset($wp_query-&gt;is_product)) && !isset($wp_query-&gt;query_vars['wpsc_product_category']))return $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we are a single products page</span>&nbsp;</div></li><li><div>  if ( !is_archive() && $wp_query-&gt;post_count &gt; 0 && 'wpsc-product' == $wp_query-&gt;post-&gt;post_type && $wp_query-&gt;post_count &lt;= 1 ) {&nbsp;</div></li><li><div>      remove_filter( &quot;the_content&quot;, &quot;wpsc_single_template&quot;, 12 );&nbsp;</div></li><li><div>      $single_theme_path = wpsc_get_template_file_path( 'wpsc-single_product.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_preview = isset( $wp_query-&gt;query_vars['preview'] ) && $wp_query-&gt;query_vars['preview'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $wpsc_temp_query = new WP_Query( array( 'p' =&gt; $wp_query-&gt;post-&gt;ID , 'post_type' =&gt; 'wpsc-product', 'posts_per_page' =&gt; 1, 'preview' =&gt; $is_preview ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list( $wp_query, $wpsc_temp_query ) = array( $wpsc_temp_query, $wp_query ); <span class="comment"><span class="comment">// swap the wpsc_query object</span></span>&nbsp;</div></li><li><div>      $_wpsc_is_in_custom_loop = true;&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      include( $single_theme_path );&nbsp;</div></li><li><div>      $content = ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>      list( $wp_query, $wpsc_temp_query ) = array( $wpsc_temp_query, $wp_query ); <span class="comment"><span class="comment"><span class="comment">// swap the wpsc_query object</span></span>s</span> back&nbsp;</div></li><li><div>      $_wpsc_is_in_custom_loop = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $content;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_is_viewable_taxonomy() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  if(isset($wp_query-&gt;query_vars['taxonomy']) && ('wpsc_product_category' == $wp_query-&gt;query_vars['taxonomy'] ||  'product_tag' == $wp_query-&gt;query_vars['taxonomy'] ) || isset($wp_query-&gt;query_vars['wpsc_product_category']))&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _wpsc_is_in_custom_loop() {&nbsp;</div></li><li><div>  global $_wpsc_is_in_custom_loop;&nbsp;</div></li><li><div>  return (bool) $_wpsc_is_in_custom_loop;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks and replaces the Page title with the category title if on a category page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string    $title      The Page Title</span>&nbsp;</div></li><li><div><span class="comment"> * @param int       $id         The Page ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string   $title      The new title</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses in_the_loop()                  Returns true if you are  in the loop</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _wpsc_is_in_custom_loop()      Returns true if in the WPSC custom loop</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_tax()                       Returns true if you are on the supplied registered taxonomy</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_term_by()                  Gets term object by defined item, and what you pass</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_query_var()                Gets query var from wp_query</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_category_title( $title='', $id='' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $id ) )&nbsp;</div></li><li><div>      _wpsc_deprecated_argument( __FUNCTION__, '3.8.10', 'The $id param is not used. If you are trying to get the title of the category use get_term' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! in_the_loop() || _wpsc_is_in_custom_loop() )&nbsp;</div></li><li><div>      return $title;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $term = null;&nbsp;</div></li><li><div>  if ( is_tax( 'wpsc_product_category' ) ) {&nbsp;</div></li><li><div>      $term = get_term_by( 'slug', get_query_var( 'wpsc_product_category' ), 'wpsc_product_category' );&nbsp;</div></li><li><div>  } elseif ( is_tax( 'product_tag' ) ) {&nbsp;</div></li><li><div>      $term = get_term_by( 'slug', get_query_var( 'term' ), 'product_tag' );&nbsp;</div></li><li><div>  } <span class="comment">// is_tax</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $term )&nbsp;</div></li><li><div>      return $term-&gt;name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $title;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">//handles replacing the tags in the pages</span>&nbsp;</div></li><li><div>function wpsc_products_page( $content = '' ) {&nbsp;</div></li><li><div>  global $wpdb, $wp_query, $wpsc_query, $wpsc_query_vars, $_wpsc_is_in_custom_loop;&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  if ( ! in_the_loop() )&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  if ( preg_match( &quot;/\[productspage\]/&quot;, $content ) ) {&nbsp;</div></li><li><div>      global $more;&nbsp;</div></li><li><div>      $more = 0;&nbsp;</div></li><li><div>      remove_filter( 'the_content', 'wpautop' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list($wp_query, $wpsc_query) = array( $wpsc_query, $wp_query ); <span class="comment"><span class="comment">// swap the wpsc_query object</span></span>&nbsp;</div></li><li><div>      $_wpsc_is_in_custom_loop = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $GLOBALS['nzshpcrt_activateshpcrt'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get the display type for the productspage</span>&nbsp;</div></li><li><div>      $saved_display = wpsc_get_customer_meta( 'display_type' );&nbsp;</div></li><li><div>      $display_type = ! empty( $saved_display ) ? $saved_display : wpsc_check_display_type();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'wpsc_display_products_page', $display_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wpsc_include_products_page_template($display_type);&nbsp;</div></li><li><div>      $is_single = false;&nbsp;</div></li><li><div>      $output .= ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>      $output = str_replace( '$', '\$', $output );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $wp_query-&gt;post_count &gt; 0 ) {&nbsp;</div></li><li><div>          $product_id = $wp_query-&gt;post-&gt;ID;&nbsp;</div></li><li><div>          $product_meta = get_post_meta( $product_id, '_wpsc_product_metadata', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          list($wp_query, $wpsc_query) = array( $wpsc_query, $wp_query ); <span class="comment"><span class="comment"><span class="comment">// swap the wpsc_query object</span></span>s</span> back&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $_wpsc_is_in_custom_loop = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ($is_single == false) || ($product_meta['enable_comments'] == '0') )&nbsp;</div></li><li><div>              wp_reset_postdata();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $wp_query-&gt;current_post = $wp_query-&gt;post_count;&nbsp;</div></li><li><div>      return preg_replace( &quot;/(&lt;p&gt;)*\[productspage\](&lt;\/p&gt;)*/&quot;, $output, $content );&nbsp;</div></li><li><div>  } elseif(is_archive() && wpsc_is_viewable_taxonomy()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_filter( 'the_content', 'wpautop' );&nbsp;</div></li><li><div>      return wpsc_products_page('[productspage]');&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_the_category_template swaps the template used for product categories with pageif archive template is being used use</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $template (string) template path</span>&nbsp;</div></li><li><div><span class="comment"> * @return $template (string)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_the_category_template($template) {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  <span class="comment">//this bit of code makes sure we use a nice standard page template for our products</span>&nbsp;</div></li><li><div>  if(wpsc_is_viewable_taxonomy() && false !== strpos($template, 'archive'))&nbsp;</div></li><li><div>      return str_ireplace('archive', 'page', $template);&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return $template;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns current product category ID or default category ID if one is set.  If one is not set and there is no current category, returns empty string</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_current_category_id() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $category_id = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $wp_query ) && isset( $wp_query-&gt;query_vars['taxonomy'] ) && ('wpsc_product_category' ==  $wp_query-&gt;query_vars['taxonomy'] ) || is_numeric( get_option( 'wpsc_default_category' ) ) )&nbsp;</div></li><li><div>      $category_id = isset( $wp_query-&gt;query_vars['term'] ) && is_string( $wp_query-&gt;query_vars['term'] ) ? wpsc_get_category_id( $wp_query-&gt;query_vars['term'], 'slug' ) : get_option( 'wpsc_default_category' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $category_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns Dynamic User CSS URL</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This produces the cached CSS file if it exists and the uploads folder is writeable.</span>&nbsp;</div></li><li><div><span class="comment"> * If the folder is not writeable, we return the dynamic URL</span>&nbsp;</div></li><li><div><span class="comment"> * If the folder is writeable, but for some reason a cached copy of the CSS doesn't exist, we attempt to create it and return that URL.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_get_dynamic_user_css_url() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $uploads_dir = wp_upload_dir();&nbsp;</div></li><li><div>  $upload_folder = $uploads_dir['path'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_writable( $upload_folder ) && file_exists( $upload_folder . '/wpsc_cached_styles.css' ) )&nbsp;</div></li><li><div>      return esc_url( add_query_arg( 'timestamp', get_option( 'wpsc_dynamic_css_hash', time() ), $uploads_dir['url'] . '/wpsc_cached_styles.css' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_writable( $upload_folder ) )&nbsp;</div></li><li><div>      return esc_url( add_query_arg( 'wpsc_user_dynamic_css', 'true', home_url( 'index.php' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_writable( $upload_folder ) && ! file_exists( $upload_folder . '/wpsc_cached_styles.css' ) )&nbsp;</div></li><li><div>      return wpsc_cache_to_upload();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Moves dynamically generated input into a file in the uploads folder.</span>&nbsp;</div></li><li><div><span class="comment"> * Also updates CSS hash timestamp.  Timestamp is appended to URL</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed File URL on successful move, false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_cache_to_upload() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $uploads_dir = wp_upload_dir();&nbsp;</div></li><li><div>  $upload_folder = $uploads_dir['path'];&nbsp;</div></li><li><div>  $path = $upload_folder . '/wpsc_cached_styles.css';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_writable( $upload_folder ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === file_put_contents( $path, wpsc_get_user_dynamic_css() ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $timestamp = time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  update_option( 'wpsc_dynamic_css_hash', $timestamp );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return esc_url( add_query_arg( 'timestamp', $timestamp, $uploads_dir['url'] . '/wpsc_cached_styles.css' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Prints dynamic CSS.  This function is run either when the dynamic URL is hit, or when we need to grab new CSS to cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return CSS</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_user_dynamic_css() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  header( 'Content-Type: text/css' );&nbsp;</div></li><li><div>  header( 'Expires: ' . gmdate( 'r', mktime( 0, 0, 0, date( 'm' ), ( date( 'd' ) + 12 ), date( 'Y' ) ) ) );&nbsp;</div></li><li><div>  header( 'Cache-Control: public, must-revalidate, max-age=86400' );&nbsp;</div></li><li><div>  header( 'Pragma: public' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo wpsc_get_user_dynamic_css();&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns dynamic CSS as string.  This function is run either when the dynamic URL is hit, or when we need to grab new CSS to cache.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_user_dynamic_css() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! defined( 'WPSC_DISABLE_IMAGE_SIZE_FIXES' ) || (constant( 'WPSC_DISABLE_IMAGE_SIZE_FIXES' ) != true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $thumbnail_width = get_option( 'product_image_width' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $thumbnail_width &lt;= 0 )&nbsp;</div></li><li><div>          $thumbnail_width = 96;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $thumbnail_height = get_option( 'product_image_height' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $thumbnail_height &lt;= 0 )&nbsp;</div></li><li><div>          $thumbnail_height = 96;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $single_thumbnail_width = get_option( 'single_view_image_width' );&nbsp;</div></li><li><div>      $single_thumbnail_height = get_option( 'single_view_image_height' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $single_thumbnail_width &lt;= 0 )&nbsp;</div></li><li><div>          $single_thumbnail_width = 128;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $category_height = get_option( 'category_image_height' );&nbsp;</div></li><li><div>      $category_width = get_option( 'category_image_width' );&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/*</span>&nbsp;</div></li><li><div><span class="comment">      * Default View Styling</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>      div.default_product_display div.textcol{&nbsp;</div></li><li><div>          margin-left: &lt;?php echo $thumbnail_width + 10; ?&gt;px !important;&nbsp;</div></li><li><div>          min-height: &lt;?php echo $thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>          _height: &lt;?php echo $thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.default_product_display  div.textcol div.imagecol{&nbsp;</div></li><li><div>          position:absolute;&nbsp;</div></li><li><div>          top:0px;&nbsp;</div></li><li><div>          left: 0px;&nbsp;</div></li><li><div>          margin-left: -&lt;?php echo $thumbnail_width + 10; ?&gt;px !important;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.default_product_display  div.textcol div.imagecol a img {&nbsp;</div></li><li><div>          width: &lt;?php echo $thumbnail_width; ?&gt;px;&nbsp;</div></li><li><div>          height: &lt;?php echo $thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      .wpsc_category_grid_item  {&nbsp;</div></li><li><div>          display:block;&nbsp;</div></li><li><div>          float:left;&nbsp;</div></li><li><div>          width: &lt;?php echo $category_width; ?&gt;px;&nbsp;</div></li><li><div>          height: &lt;?php echo $category_height; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      .wpsc_category_grid_item  span{&nbsp;</div></li><li><div>          position:relative;&nbsp;</div></li><li><div>          top:&lt;?php echo ($thumbnail_height - 2)/9; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      div.default_product_display div.item_no_image a  {&nbsp;</div></li><li><div>          width: &lt;?php echo $thumbnail_width - 2; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.default_product_display .imagecol img.no-image, #content div.default_product_display .imagecol img.no-image {&nbsp;</div></li><li><div>          width: &lt;?php echo $thumbnail_width; ?&gt;px;&nbsp;</div></li><li><div>          height: &lt;?php echo $thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php do_action( 'wpsc_dynamic_css' ); ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/*</span>&nbsp;</div></li><li><div><span class="comment">      * Single View Styling</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.single_product_display div.item_no_image  {&nbsp;</div></li><li><div>          width: &lt;?php echo $single_thumbnail_width - 2; ?&gt;px;&nbsp;</div></li><li><div>          height: &lt;?php echo $single_thumbnail_height - 2; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      div.single_product_display div.item_no_image a  {&nbsp;</div></li><li><div>          width: &lt;?php echo $single_thumbnail_width - 2; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.single_product_display div.textcol{&nbsp;</div></li><li><div>          margin-left: &lt;?php echo $single_thumbnail_width + 10; ?&gt;px !important;&nbsp;</div></li><li><div>          min-height: &lt;?php echo $single_thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>          _height: &lt;?php echo $single_thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.single_product_display  div.textcol div.imagecol{&nbsp;</div></li><li><div>          position:absolute;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          margin-left: -&lt;?php echo $single_thumbnail_width + 10; ?&gt;px !important;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      div.single_product_display  div.textcol div.imagecol a img {&nbsp;</div></li><li><div>          width: &lt;?php echo $single_thumbnail_width; ?&gt;px;&nbsp;</div></li><li><div>          height: &lt;?php echo $single_thumbnail_height; ?&gt;px;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>  if ( (isset($_GET['brand']) && is_numeric( $_GET['brand'] )) || (get_option( 'show_categorybrands' ) == 3) ) {&nbsp;</div></li><li><div>      $brandstate = 'block';&nbsp;</div></li><li><div>      $categorystate = 'none';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $brandstate = 'none';&nbsp;</div></li><li><div>      $categorystate = 'block';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li><li><div>  div#categorydisplay{&nbsp;</div></li><li><div>      display: &lt;?php echo $categorystate; ?&gt;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  div#branddisplay{&nbsp;</div></li><li><div>      display: &lt;?php echo $brandstate; ?&gt;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $css = ob_get_contents();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $css;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_get_the_new_id($prod_id) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = (int) $wpdb-&gt;get_var($wpdb-&gt;prepare( &quot;SELECT `post_id` FROM `{$wpdb-&gt;postmeta}` WHERE meta_key = %s AND `meta_value` = %d LIMIT 1&quot;, '_wpsc_original_id', $prod_id ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * This switched between the 3 view types on category and products pages and includes the necessary template part</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param $display_type</span>&nbsp;</div></li><li><div><span class="comment"> * @return NULL</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_include_products_page_template( $display_type = 'default' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_GET['view_type'] ) ) {&nbsp;</div></li><li><div>      switch ( $_GET['view_type'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'grid':&nbsp;</div></li><li><div>              $display_type = 'grid';&nbsp;</div></li><li><div>              wpsc_update_customer_meta( 'display_type', $display_type );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'list':&nbsp;</div></li><li><div>              $display_type = 'list';&nbsp;</div></li><li><div>              wpsc_update_customer_meta( 'display_type', $display_type );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'default':&nbsp;</div></li><li><div>              $display_type = 'default';&nbsp;</div></li><li><div>              wpsc_update_customer_meta( 'display_type', $display_type );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// switch the display type, based on the display type variable...</span>&nbsp;</div></li><li><div>  switch ( $display_type ) {&nbsp;</div></li><li><div>      case &quot;grid&quot;:&nbsp;</div></li><li><div>          include( wpsc_get_template_file_path( 'wpsc-grid_view.php' ) );&nbsp;</div></li><li><div>          break; <span class="comment">// only break if we have the function;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      case &quot;list&quot;:&nbsp;</div></li><li><div>          include( wpsc_get_template_file_path( 'wpsc-list_view.php' ) );&nbsp;</div></li><li><div>          break; <span class="comment">// only break if we have the file;</span>&nbsp;</div></li><li><div>      default:&nbsp;</div></li><li><div>          include( wpsc_get_template_file_path( 'wpsc-products_page.php' ) );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_thesis_compat( $loop ) {&nbsp;</div></li><li><div>  $loop[1] = 'page';&nbsp;</div></li><li><div>  return $loop;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Template tags</span>&nbsp;</div></li><li><div>function wpsc_all_products_on_page() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_404() ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wp_query, $wpsc_query;&nbsp;</div></li><li><div>  do_action('wpsc_swap_the_template');&nbsp;</div></li><li><div>  $products_page_id = wpsc_get_the_post_id_by_shortcode('[productspage]');&nbsp;</div></li><li><div>  $term = get_query_var( 'wpsc_product_category' );&nbsp;</div></li><li><div>  $tax_term = get_query_var ('product_tag' );&nbsp;</div></li><li><div>  $obj = $wp_query-&gt;get_queried_object();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id = isset( $obj-&gt;ID ) ? $obj-&gt;ID : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( get_query_var( 'post_type' ) == 'wpsc-product' || $term || $tax_term || ( $id == $products_page_id )) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $templates = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $term && ! is_single() ) {&nbsp;</div></li><li><div>          array_push( $templates, &quot;taxonomy-wpsc_product_category-{$term}.php&quot;, 'taxonomy-wpsc_product_category.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $tax_term && ! is_single() ) {&nbsp;</div></li><li><div>          array_push( $templates, &quot;taxonomy-product_tag-{$tax_term}.php&quot;, 'taxonomy-product_tag.php' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Attempt to use the [productspage]'s custom page template as a higher priority than the normal page.php template</span>&nbsp;</div></li><li><div>      if ( false !== $productspage_page_template = get_post_meta($products_page_id, '_wp_page_template', true) )&nbsp;</div></li><li><div>          array_push( $templates, $productspage_page_template );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      array_push( $templates, 'page.php', 'single.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_single() )&nbsp;</div></li><li><div>          array_unshift( $templates, 'single-wpsc-product.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// have to pass 'page' as the template type. This is lame, btw, and needs a rewrite in 4.0</span>&nbsp;</div></li><li><div>      if ( ! $template = get_query_template( 'page', $templates ) )&nbsp;</div></li><li><div>          $template = get_index_template();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'thesis_custom_loop', 'wpsc_thesis_compat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      include( $template );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_count_themes_in_uploads_directory, does exactly what the name says</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_count_themes_in_uploads_directory() {&nbsp;</div></li><li><div>  $uploads_dir = false;&nbsp;</div></li><li><div>  if ( is_dir( WPSC_OLD_THEMES_PATH.get_option('wpsc_selected_theme').'/' ) )&nbsp;</div></li><li><div>      $uploads_dir = @opendir( WPSC_OLD_THEMES_PATH.get_option('wpsc_selected_theme').'/' ); <span class="comment">// might cause problems if dir doesnt exist</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !$uploads_dir )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $file_names = array( );&nbsp;</div></li><li><div>  while ( ($file = @readdir( $uploads_dir )) !== false ) {&nbsp;</div></li><li><div>      if ( is_dir( WPSC_OLD_THEMES_PATH . get_option('wpsc_selected_theme') . '/' . $file ) && ($file != &quot;..&quot;) && ($file != &quot;.&quot;) && ($file != &quot;.svn&quot;) )&nbsp;</div></li><li><div>          $file_names[] = $file;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  @closedir( $uploads_dir );&nbsp;</div></li><li><div>  return count( $file_names );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_place_shopping_cart( $content = '' ) {&nbsp;</div></li><li><div>  if ( ! in_the_loop() )&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( &quot;/\[shoppingcart\]/&quot;, $content ) ) {&nbsp;</div></li><li><div>      <span class="comment">// BEGIN: compatibility fix for outdated theme files still relying on sessions</span>&nbsp;</div></li><li><div>      $_SESSION['coupon_numbers' ] = wpsc_get_customer_meta( 'coupon' );&nbsp;</div></li><li><div>      $_SESSION['wpsc_checkout_misc_error_messages' ] = wpsc_get_customer_meta( 'checkout_misc_error_messages' );&nbsp;</div></li><li><div>      $_SESSION['categoryAndShippingCountryConflict'] = wpsc_get_customer_meta( 'category_shipping_conflict' );&nbsp;</div></li><li><div>      $_SESSION['shippingSameBilling' ] = wpsc_get_customer_meta( 'shippingSameBilling' );&nbsp;</div></li><li><div>      $_SESSION['wpsc_checkout_user_error_messages' ] = wpsc_get_customer_meta( 'registration_error_messages' );&nbsp;</div></li><li><div>      <span class="comment">// END: compatibility fix</span>&nbsp;</div></li><li><div>      $GLOBALS['nzshpcrt_activateshpcrt'] = true;&nbsp;</div></li><li><div>      if ( ! defined( 'DONOTCACHEPAGE' ) )&nbsp;</div></li><li><div>          define( 'DONOTCACHEPAGE', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// call this function to detect conflicts when the cart page is first loaded, otherwise</span>&nbsp;</div></li><li><div>      <span class="comment">// any conflict messages will only be displayed on the next page load</span>&nbsp;</div></li><li><div>      wpsc_get_acceptable_countries();&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      do_action( 'wpsc_before_shopping_cart_page' );&nbsp;</div></li><li><div>      include( wpsc_get_template_file_path( 'wpsc-shopping_cart_page.php' ) );&nbsp;</div></li><li><div>      do_action( 'wpsc_after_shopping_cart_page' );&nbsp;</div></li><li><div>      $output = ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>      $output = str_replace( '$', '\$', $output );&nbsp;</div></li><li><div>      wpsc_delete_customer_meta( 'checkout_misc_error_messages' );&nbsp;</div></li><li><div>      wpsc_delete_customer_meta( 'category_shipping_conflict' );&nbsp;</div></li><li><div>      wpsc_delete_customer_meta( 'registration_error_messages' );&nbsp;</div></li><li><div>      wpsc_delete_customer_meta( 'checkout_error_messages' );&nbsp;</div></li><li><div>      wpsc_delete_customer_meta( 'gateway_error_messages' );&nbsp;</div></li><li><div>      return preg_replace( &quot;/(&lt;p&gt;)*\[shoppingcart\](&lt;\/p&gt;)*/&quot;, $output, $content );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_transaction_results( $content = '' ) {&nbsp;</div></li><li><div>  if ( ! in_the_loop() )&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( preg_match( &quot;/\[transactionresults\]/&quot;, $content ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! defined( 'DONOTCACHEPAGE' ) || ( defined( 'DONOTCACHEPAGE' ) && ! DONOTCACHEPAGE ) ) {&nbsp;</div></li><li><div>          define( 'DONOTCACHEPAGE', true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      include( wpsc_get_template_file_path( 'wpsc-transaction_results.php' ) );&nbsp;</div></li><li><div>      $output = ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>      $output = preg_replace( '#(?&lt;!\\\\)(\\$|\\\\)#', '\\\\$1', $output );&nbsp;</div></li><li><div>      return preg_replace( &quot;/(&lt;p&gt;)*\[transactionresults\](&lt;\/p&gt;)*/&quot;, $output, $content );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_user_log( $content = '' ) {&nbsp;</div></li><li><div>  if ( ! in_the_loop() )&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  if ( preg_match( &quot;/\[userlog\]/&quot;, $content ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! defined( 'DONOTCACHEPAGE' ) ) {&nbsp;</div></li><li><div>          define( 'DONOTCACHEPAGE', true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      include( wpsc_get_template_file_path('wpsc-user-log.php') );&nbsp;</div></li><li><div>      $output = ob_get_clean();&nbsp;</div></li><li><div>      $content = preg_replace( &quot;/(&lt;p&gt;)*\[userlog\](&lt;\/p&gt;)*/&quot;, '[userlog]', $content );&nbsp;</div></li><li><div>      return str_replace( '[userlog]', $output, $content );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_get_the_post_id_by_shortcode( $shortcode ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $shortcode_options = array(&nbsp;</div></li><li><div>          '[productspage]' =&gt; 'product_list_url', &nbsp;</div></li><li><div>          '[shoppingcart]' =&gt; 'shopping_cart_url', &nbsp;</div></li><li><div>          '[checkout]' =&gt; 'shopping_cart_url', &nbsp;</div></li><li><div>          '[transactionresults]' =&gt; 'transact_url', &nbsp;</div></li><li><div>          '[userlog]' =&gt; 'user_account_url'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $shortcode_options[$shortcode] ) )&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $page_ids = get_option( 'wpsc_shortcode_page_ids', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $page_ids === false ) {&nbsp;</div></li><li><div>      wpsc_update_permalink_slugs();&nbsp;</div></li><li><div>      $page_ids = get_option( 'wpsc_shortcode_page_ids', false );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = isset( $page_ids[$shortcode] ) ? $page_ids[$shortcode] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// For back compat</span>&nbsp;</div></li><li><div>  $post_id = apply_filters( 'wpec_get_the_post_id_by_shortcode', $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'wpsc_get_the_post_id_by_shortcode', $post_id, $shortcode );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpec_remap_shop_subpages( $vars ) {&nbsp;</div></li><li><div>  if( empty( $vars ) )&nbsp;</div></li><li><div>      return $vars;&nbsp;</div></li><li><div>  $reserved_names = array('[shoppingcart]', '[userlog]', '[transactionresults]');&nbsp;</div></li><li><div>  foreach($reserved_names as $reserved_name) {&nbsp;</div></li><li><div>      if ( isset( $vars['taxonomy'] ) && $vars['taxonomy'] == 'wpsc_product_category' && isset( $vars['term'] ) && $vars['term'] == $page-&gt;post_name ) {&nbsp;</div></li><li><div>          $page_id = wpsc_get_the_post_id_by_shortcode( $reserved_name );&nbsp;</div></li><li><div>          $page = get_post( $page_id );&nbsp;</div></li><li><div>          return array( 'page_id' =&gt; $page-&gt;ID );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $vars;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_remove_page_from_query_string( $query_string ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === strpos( implode( ' ', $query_string ), 'wpsc' ) ) {&nbsp;</div></li><li><div>      return $query_string;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query_string['name'] ) && $query_string['name'] == 'page' && isset( $query_string['page'] ) ) {&nbsp;</div></li><li><div>      unset( $query_string['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      list( $delim, $page_index ) = explode( '/', $query_string['page'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query_string['paged'] = $page_index;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query_string['wpsc-product'] ) && 'page' == $query_string['wpsc-product'] ) {&nbsp;</div></li><li><div>      $query_string['wpsc-product'] = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query_string['name'] ) && is_numeric( $query_string['name'] ) ) {&nbsp;</div></li><li><div>      $query_string['paged'] = $query_string['name'];&nbsp;</div></li><li><div>      $query_string['page'] = '/'.$query_string['name'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query_string['posts_per_page'] = get_option('wpsc_products_per_page');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query_string['wpsc-product'] ) && is_numeric( $query_string['wpsc-product'] ) ) {&nbsp;</div></li><li><div>      unset( $query_string['wpsc-product'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query_string['wpsc_product_category'] ) && 'page' == $query_string['wpsc_product_category'] ) {&nbsp;</div></li><li><div>      unset( $query_string['wpsc_product_category'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $query_string['name'] ) && is_numeric( $query_string['name'] ) ) {&nbsp;</div></li><li><div>      unset( $query_string['name'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset($query_string['term']) && 'page' == $query_string['term'] )    {&nbsp;</div></li><li><div>      unset( $query_string['term'] );&nbsp;</div></li><li><div>      unset( $query_string['taxonomy'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $query_string;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function is_products_page() {&nbsp;</div></li><li><div>  global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $post ) || ! is_object( $post ) || empty( $post-&gt;ID ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $product_page_id = wpsc_get_the_post_id_by_shortcode( '[productspage]' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $post-&gt;ID == $product_page_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_display_products_page function.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed $query</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_display_featured_products_page() {&nbsp;</div></li><li><div>  global $wp_query;&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  $sticky_array = get_option( 'sticky_products' );&nbsp;</div></li><li><div>  if ( (is_front_page() || is_home() || is_products_page() ) && !empty( $sticky_array ) && $wp_query-&gt;post_count &gt; 1) {&nbsp;</div></li><li><div>      $query = get_posts( array(&nbsp;</div></li><li><div>                  'post__in' =&gt; $sticky_array, &nbsp;</div></li><li><div>                  'post_type' =&gt; 'wpsc-product', &nbsp;</div></li><li><div>                  'orderby' =&gt; 'rand', &nbsp;</div></li><li><div>                  'numberposts' =&gt; 1, &nbsp;</div></li><li><div>                  'posts_per_page' =&gt; 1&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( count( $query ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $GLOBALS['nzshpcrt_activateshpcrt'] = true;&nbsp;</div></li><li><div>          $image_width = get_option( 'product_image_width' );&nbsp;</div></li><li><div>          $image_height = get_option( 'product_image_height' );&nbsp;</div></li><li><div>          $featured_product_theme_path = wpsc_get_template_file_path( 'wpsc-featured_product.php' );&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>      include_once($featured_product_theme_path);&nbsp;</div></li><li><div>      $is_single = false;&nbsp;</div></li><li><div>      $output .= ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//Begin outputting featured product.  We can worry about templating later, or folks can just CSS it up.</span>&nbsp;</div></li><li><div>          echo $output;&nbsp;</div></li><li><div>          <span class="comment">//End output</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_hidesubcatprods_init() {&nbsp;</div></li><li><div>  $hide_subcatsprods = new WPSC_Hide_subcatsprods_in_cat;&nbsp;</div></li><li><div>  add_action( 'pre_get_posts', array( &$hide_subcatsprods, 'get_posts' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// check for all in one SEO pack and the is_static_front_page function</span>&nbsp;</div></li><li><div>if ( is_callable( array( &quot;All_in_One_SEO_Pack&quot;, 'is_static_front_page' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function wpsc_change_aioseop_home_title( $title ) {&nbsp;</div></li><li><div>      global $aiosp, $aioseop_options;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( (get_class( $aiosp ) == 'All_in_One_SEO_Pack') && $aiosp-&gt;is_static_front_page() ) {&nbsp;</div></li><li><div>          $aiosp_home_title = $aiosp-&gt;internationalize( $aioseop_options['aiosp_home_title'] );&nbsp;</div></li><li><div>          $new_title = wpsc_obtain_the_title();&nbsp;</div></li><li><div>          if ( $new_title != '' ) {&nbsp;</div></li><li><div>              $title = str_replace( $aiosp_home_title, $new_title, $title );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $title;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'aioseop_home_page_title', 'wpsc_change_aioseop_home_title' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_obtain_the_title function, for replaacing the page title with the category or product</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the new page title</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_obtain_the_title() {&nbsp;</div></li><li><div>  global $wpdb, $wp_query, $wpsc_title_data;&nbsp;</div></li><li><div>  $output = null;&nbsp;</div></li><li><div>  $category_id = null;&nbsp;</div></li><li><div>  if( !isset( $wp_query-&gt;query_vars['wpsc_product_category']) &&  !isset( $wp_query-&gt;query_vars['wpsc-product']))&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !isset( $wp_query-&gt;query_vars['wpsc_product_category'] ) && isset($wp_query-&gt;query_vars['wpsc-product']) )&nbsp;</div></li><li><div>      $wp_query-&gt;query_vars['wpsc_product_category'] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $wp_query-&gt;query_vars['taxonomy'] ) && 'wpsc_product_category' ==  $wp_query-&gt;query_vars['taxonomy'] || isset($wp_query-&gt;query_vars['wpsc_product_category']))&nbsp;</div></li><li><div>      $category_id = wpsc_get_the_category_id($wp_query-&gt;query_vars['wpsc_product_category'], 'slug');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $category_id &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $wpsc_title_data['category'][$category_id] ) ) {&nbsp;</div></li><li><div>          $output = $wpsc_title_data['category'][$category_id];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $term = get_term($category_id, 'wpsc_product_category');&nbsp;</div></li><li><div>          $output = $term-&gt;name;&nbsp;</div></li><li><div>          $wpsc_title_data['category'][$category_id] = $output;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !isset( $_GET['wpsc-product'] ) )&nbsp;</div></li><li><div>      $_GET['wpsc-product'] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( !isset( $wp_query-&gt;query_vars['wpsc-product'] ) )&nbsp;</div></li><li><div>      $wp_query-&gt;query_vars['wpsc-product'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $wp_query-&gt;query_vars['wpsc-product'] ) || is_string( $_GET['wpsc-product'] ) ) {&nbsp;</div></li><li><div>      $product_name = $wp_query-&gt;query_vars['wpsc-product'];&nbsp;</div></li><li><div>      if ( isset( $wpsc_title_data['product'][$product_name] ) ) {&nbsp;</div></li><li><div>          $product_list = array( );&nbsp;</div></li><li><div>          $full_product_name = $wpsc_title_data['product'][$product_name];&nbsp;</div></li><li><div>      } else if ( $product_name != '' ) {&nbsp;</div></li><li><div>          $product_id = $wp_query-&gt;post-&gt;ID;&nbsp;</div></li><li><div>          $full_product_name = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT `post_title` FROM `$wpdb-&gt;posts` WHERE `ID`= %d LIMIT 1&quot;, $product_id ) );&nbsp;</div></li><li><div>          $wpsc_title_data['product'][$product_name] = $full_product_name;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if(isset($_REQUEST['product_id'])) {&nbsp;</div></li><li><div>              $product_id = absint( $_REQUEST['product_id'] );&nbsp;</div></li><li><div>              $product_name = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT `post_title` FROM `$wpdb-&gt;posts` WHERE `ID`= %d LIMIT 1&quot;, $product_id ) );&nbsp;</div></li><li><div>              $full_product_name = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT `post_title` FROM `$wpdb-&gt;posts` WHERE `ID`= %d LIMIT 1&quot;, $product_id ) );&nbsp;</div></li><li><div>              $wpsc_title_data['product'][$product_name] = $full_product_name;&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              <span class="comment">//This has to exist, otherwise we would have bailed earlier.</span>&nbsp;</div></li><li><div>              $category = $wp_query-&gt;query_vars['wpsc_product_category'];&nbsp;</div></li><li><div>              $cat_term = get_term_by('slug', $wp_query-&gt;query_vars['wpsc_product_category'], 'wpsc_product_category');&nbsp;</div></li><li><div>              $full_product_name = $cat_term-&gt;name;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $output = $full_product_name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $full_product_name ) && ($full_product_name != null) )&nbsp;</div></li><li><div>      $output = esc_html(  $full_product_name );&nbsp;</div></li><li><div>  $seperator = ' | ';&nbsp;</div></li><li><div>  $seperator = apply_filters('wpsc_the_wp_title_seperator' , $seperator);&nbsp;</div></li><li><div>  return $output.$seperator;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *    Return category or product description depending on queried item</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_obtain_the_description() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return Category Description</span>&nbsp;</div></li><li><div>  if ( is_numeric( get_query_var('category_id') ) ) {&nbsp;</div></li><li><div>      $output = wpsc_get_categorymeta( get_query_var('category_id'), 'description' );&nbsp;</div></li><li><div>  } else if ( ! empty($_GET['category']) ) {&nbsp;</div></li><li><div>      $output = wpsc_get_categorymeta( absint( $_GET['category'] ), 'description' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return product content as description if product page</span>&nbsp;</div></li><li><div>  if ( !empty($_GET['product_id'] ) && is_numeric( $_GET['product_id'] ) ) {&nbsp;</div></li><li><div>      $product = get_post(absint( $_GET['product_id'] ));&nbsp;</div></li><li><div>      $output = $product-&gt;post_content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $output;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_set_aioseop_description( $data ) {&nbsp;</div></li><li><div>  $replacement_data = wpsc_obtain_the_description();&nbsp;</div></li><li><div>  if ( $replacement_data != '' ) {&nbsp;</div></li><li><div>      $data = $replacement_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return $data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> *     this page url function, returns the URL of this page</span>&nbsp;</div></li><li><div><span class="comment"> * @return string - the URL of the current page</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_this_page_url() {&nbsp;</div></li><li><div>  global $wpsc_query, $wp_query;&nbsp;</div></li><li><div>  if ( $wpsc_query-&gt;is_single === true ) {&nbsp;</div></li><li><div>      $output = get_permalink( $wp_query-&gt;post-&gt;ID );&nbsp;</div></li><li><div>  } else if ( isset( $wpsc_query-&gt;category ) && $wpsc_query-&gt;category != null ) {&nbsp;</div></li><li><div>      $output = wpsc_category_url( $wpsc_query-&gt;category );&nbsp;</div></li><li><div>      if ( $wpsc_query-&gt;query_vars['page'] &gt; 1 ) {&nbsp;</div></li><li><div>          if ( get_option( 'permalink_structure' ) ) {&nbsp;</div></li><li><div>              $output .= &quot;page/{$wpsc_query-&gt;query_vars['page']}/&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $output = add_query_arg( 'page_number', $wpsc_query-&gt;query_vars['page'], $output );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } elseif ( isset( $id ) ) {&nbsp;</div></li><li><div>      $output = get_permalink( $id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $output = get_permalink( get_the_ID() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return esc_url( $output );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Strips shortcode placeholders from excerpts returned in search results (and excerpts returned anywhere).</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $text Trimmed excerpt</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $text Trimmed excerpt, sans placeholders</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_strip_shortcode_placeholders( $text ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_wpsc_placeholder = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpsc_shortcodes = array(&nbsp;</div></li><li><div>      '[productspage]' , &nbsp;</div></li><li><div>      '[shoppingcart]' , &nbsp;</div></li><li><div>      '[checkout]' , &nbsp;</div></li><li><div>      '[transactionresults]', &nbsp;</div></li><li><div>      '[userlog]' , &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $wpsc_shortcodes as $shortcode ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== strpos( $text, $shortcode ) ) {&nbsp;</div></li><li><div>          $is_wpsc_placeholder = $shortcode;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_wpsc_placeholder ) {&nbsp;</div></li><li><div>      $text = str_replace( $is_wpsc_placeholder, '', $text );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $text;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter( 'wp_trim_excerpt', 'wpsc_strip_shortcode_placeholders' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>