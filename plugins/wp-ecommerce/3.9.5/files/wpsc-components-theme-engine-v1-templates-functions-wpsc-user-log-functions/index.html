<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27521"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-components-theme-engine-v1-templates-functions-wpsc-user-log-functions | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=0eb1ffdb1b0b4c44a72e871029fdfaf0' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-components-theme-engine-v1-templates-functions-wpsc-user-log-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-templates-functions-wpsc-user-log-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-components-theme-engine-v1-templates-functions-wpsc-user-log-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-components-theme-engine-v1-templates-functions-wpsc-user-log-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-components-theme-engine-v1-templates-functions-wpsc-user-log-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-components-theme-engine-&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-components/theme-engine-v1/templates/functions/wpsc-user_log_functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WP eCommerce User Account class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This class is responsible for theming the User Account page.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package wp-e-commerce</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>global $wpdb, $user_ID, $wpsc_purchlog_statuses, $separator;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( get_option( 'permalink_structure' ) != '' )&nbsp;</div></li><li><div>  $separator = &quot;?&quot;;&nbsp;</div></li><li><div>else&nbsp;</div></li><li><div>  $separator = &quot;&amp;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * wpsc_display_form_fields()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function displays each of the form fields.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_display_form_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'wpsc_start_display_user_log_form_fields' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $wpsc_checkout = wpsc_core_get_checkout();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $i = 0;&nbsp;</div></li><li><div>  while ( wpsc_have_checkout_items() ) {&nbsp;</div></li><li><div>      wpsc_the_checkout_item();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wpsc_checkout_form_is_header() ) {&nbsp;</div></li><li><div>          $i ++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// display headers for form fields</span>&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;?php if ( $i &gt; 1 ) {?&gt;&nbsp;</div></li><li><div>              &lt;/table&gt;&nbsp;</div></li><li><div>              &lt;table&gt;&nbsp;</div></li><li><div>          &lt;?php } ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>             &lt;tr class=&quot;checkout-heading-row &lt;?php echo esc_attr( wpsc_the_checkout_item_error_class( false ) );?&gt;&quot;&gt;&nbsp;</div></li><li><div>                 &lt;td &lt;?php wpsc_the_checkout_details_class(); ?&gt; colspan='2'&gt;&nbsp;</div></li><li><div>                         &lt;h4&gt;&lt;?php echo esc_html( wpsc_checkout_form_name() );?&gt;&lt;/h4&gt;&nbsp;</div></li><li><div>                 &lt;/td&gt;&nbsp;</div></li><li><div>             &lt;/tr&gt;&nbsp;</div></li><li><div>             &lt;?php if ( wpsc_is_shipping_details() ) {?&gt;&nbsp;</div></li><li><div>             &lt;tr class='same_as_shipping_row'&gt;&nbsp;</div></li><li><div>                  &lt;td colspan='2'&gt;&nbsp;</div></li><li><div>                         &lt;?php&nbsp;</div></li><li><div>                         $checked = '';&nbsp;</div></li><li><div>                         $shipping_same_as_billing = wpsc_get_customer_meta( 'shippingSameBilling' );&nbsp;</div></li><li><div>                         if ( $shipping_same_as_billing ) {&nbsp;</div></li><li><div>                          $checked = 'checked=&quot;checked&quot;';&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      ?&gt;&nbsp;</div></li><li><div>                      &lt;label for='shippingSameBilling'&gt;&nbsp;</div></li><li><div>                          &lt;input type='checkbox'&nbsp;</div></li><li><div>                              value='true'&nbsp;</div></li><li><div>                              data-wpsc-meta-key=&quot;shippingSameBilling&quot;&nbsp;</div></li><li><div>                              class=&quot;wpsc-visitor-meta&quot;&nbsp;</div></li><li><div>                              name='shippingSameBilling'&nbsp;</div></li><li><div>                              id='shippingSameBilling' &lt;?php echo $checked; ?&gt; /&gt;&nbsp;</div></li><li><div>                          &lt;?php _e( 'Same as billing address:', 'wpsc' ); ?&gt;&nbsp;</div></li><li><div>                      &lt;/label&gt;&nbsp;</div></li><li><div>                      &lt;br&gt;&nbsp;</div></li><li><div>                      &lt;span id=&quot;shippingsameasbillingmessage&quot;&gt;&lt;?php _e('Your orders will be shipped to the billing address', 'wpsc'); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>          &lt;?php }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Not a header so start display form fields</span>&nbsp;</div></li><li><div>      } elseif ( $wpsc_checkout-&gt;checkout_item-&gt;unique_name == 'billingemail' ) {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>             &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                 $email_markup = &quot;&lt;div class='wpsc_email_address'&gt;&nbsp;</div></li><li><div>                &lt;p class='&quot; . wpsc_checkout_form_element_id() . &quot;'&gt;&nbsp;</div></li><li><div>                   &lt;label class='wpsc_email_address' for='&quot; . wpsc_checkout_form_element_id() . &quot;'&gt;&nbsp;</div></li><li><div>                   &quot; . __( 'Enter your email address', 'wpsc' ) . &quot;&nbsp;</div></li><li><div>                   &lt;/label&gt;&nbsp;</div></li><li><div>                &lt;p class='wpsc_email_address_p'&gt;&nbsp;</div></li><li><div>                &lt;img src='https:<span class="comment">//secure.gravatar.com/avatar/empty?s=60&amp;d=mm' id='wpsc_checkout_gravatar' /&gt;</span>&nbsp;</div></li><li><div>                &quot; . wpsc_checkout_form_field();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( wpsc_the_checkout_item_error() != '' )&nbsp;</div></li><li><div>              $email_markup .= &quot;&lt;p class='validation-error'&gt;&quot; . wpsc_the_checkout_item_error() . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>          $email_markup .= &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          ?&gt;&nbsp;</div></li><li><div>          &lt;tr&gt;&nbsp;</div></li><li><div>              &lt;td class='&lt;?php echo wpsc_checkout_form_element_id(); ?&gt;'&gt;&nbsp;</div></li><li><div>                  &lt;label&nbsp;</div></li><li><div>                      for='&lt;?php echo esc_attr( wpsc_checkout_form_element_id() ); ?&gt;'&gt;&nbsp;</div></li><li><div>                      &lt;?php echo wpsc_checkout_form_name();?&gt;&nbsp;</div></li><li><div>                  &lt;/label&gt;&nbsp;</div></li><li><div>              &lt;/td&gt;&nbsp;</div></li><li><div>              &lt;td&gt;&nbsp;</div></li><li><div>                &lt;?php echo wpsc_checkout_form_field();?&gt;&nbsp;</div></li><li><div>                 &lt;?php if ( wpsc_the_checkout_item_error() != '' ) { ?&gt;&nbsp;</div></li><li><div>                        &lt;p class='validation-error'&gt;&lt;?php echo wpsc_the_checkout_item_error(); ?&gt;&lt;/p&gt;&nbsp;</div></li><li><div>                &lt;?php } ?&gt;&nbsp;</div></li><li><div>             &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>       &lt;?php }<span class="comment">//endif; ?&gt;</span>&nbsp;</div></li><li><div>    &lt;?php } <span class="comment">// end while ?&gt;</span>&nbsp;</div></li><li><div>    &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_has_downloads() {&nbsp;</div></li><li><div>  global $wpdb, $user_ID, $files, $links, $products;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $purchases = $wpdb-&gt;get_results( &quot;SELECT `id`, `processed` FROM `&quot; . WPSC_TABLE_PURCHASE_LOGS . &quot;` WHERE user_ID = &quot; . (int) $user_ID . &quot;&quot; );&nbsp;</div></li><li><div>  $rowcount = count( $purchases );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $rowcount &gt;= 1 ) {&nbsp;</div></li><li><div>      $perchidstr = &quot;(&quot;;&nbsp;</div></li><li><div>      $perchids = array();&nbsp;</div></li><li><div>      foreach ( (array) $purchases as $purchase ) {&nbsp;</div></li><li><div>          $is_transaction = wpsc_check_purchase_processed( $purchase-&gt;processed );&nbsp;</div></li><li><div>          if( $is_transaction ) {&nbsp;</div></li><li><div>              $perchids[] = $purchase-&gt;id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(!empty($perchids)) {&nbsp;</div></li><li><div>          $perchidstr .= implode( ', ', $perchids );&nbsp;</div></li><li><div>          $perchidstr .= &quot;)&quot;;&nbsp;</div></li><li><div>          $sql = &quot;SELECT * FROM `&quot; . WPSC_TABLE_DOWNLOAD_STATUS . &quot;` WHERE `purchid` IN &quot; . $perchidstr . &quot; AND `active` IN ('1') ORDER BY `datetime` DESC&quot;;&nbsp;</div></li><li><div>          $products = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>          $products = apply_filters( 'wpsc_has_downloads_products', $products );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array)$products as $key =&gt; $product ) {&nbsp;</div></li><li><div>  if( empty( $product['uniqueid'] ) ) { <span class="comment">// if the uniqueid is not equal to null, its &quot;valid&quot;, regardless of what it is</span>&nbsp;</div></li><li><div>          $links[] = home_url( '/?downloadid=' . $product['id'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $links[] = home_url( '/?downloadid=' . $product['uniqueid'] );&nbsp;</div></li><li><div>       }&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;posts WHERE id = %d&quot;, $product['fileid'] );&nbsp;</div></li><li><div>      $file = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>      $files[] = $file[0];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  if ( count( $files ) &gt; 0 ) {&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_has_purchases() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb, $user_ID, $wpsc_purchlog_statuses, $gateway_checkout_form_fields, $purchase_log, $col_count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * this finds the earliest timedit-profile in the shopping cart and sorts out the timestamp system for the month by month display</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $earliest_record_sql = &quot;SELECT MIN(`date`) AS `date` FROM `&quot; . WPSC_TABLE_PURCHASE_LOGS . &quot;` WHERE `date`!=''&quot;;&nbsp;</div></li><li><div>  $earliest_record = $wpdb-&gt;get_results( $earliest_record_sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $earliest_record[0]['date'] != null ) {&nbsp;</div></li><li><div>      $form_sql = &quot;SELECT * FROM `&quot; . WPSC_TABLE_CHECKOUT_FORMS . &quot;` WHERE `active` = '1' AND `display_log` = '1';&quot;;&nbsp;</div></li><li><div>      $col_count = 4; <span class="comment">//+ count( $form_data );</span>&nbsp;</div></li><li><div>      $sql = &quot;SELECT * FROM `&quot; . WPSC_TABLE_PURCHASE_LOGS . &quot;` WHERE `user_ID` IN ('&quot; . $user_ID . &quot;') AND `processed` IN (3, 4, 5) ORDER BY `date` DESC&quot;;&nbsp;</div></li><li><div>      $purchase_log = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_has_purchases_this_month() {&nbsp;</div></li><li><div>  global $wpdb, $user_ID, $wpsc_purchlog_statuses, $gateway_checkout_form_fields, $purchase_log, $col_count;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $i = 0;&nbsp;</div></li><li><div>  $subtotal = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $purchase_log != null )&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the Account Page tabs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.10</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_user_profile_links( $args = array() ) {&nbsp;</div></li><li><div>  global $current_tab, $separator;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array (&nbsp;</div></li><li><div>       'before_link_list' =&gt; '', &nbsp;</div></li><li><div>       'after_link_list' =&gt; '', &nbsp;</div></li><li><div>       'before_link_item' =&gt; '', &nbsp;</div></li><li><div>       'after_link_item' =&gt; '', &nbsp;</div></li><li><div>       'link_separator' =&gt; '|'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $profile_tabs = apply_filters( 'wpsc_user_profile_tabs', array(&nbsp;</div></li><li><div>      'purchase_history' =&gt; __( 'Purchase History', 'wpsc' ), &nbsp;</div></li><li><div>      'edit_profile' =&gt; __( 'Your Details', 'wpsc' ), &nbsp;</div></li><li><div>      'downloads' =&gt; __( 'Your Downloads', 'wpsc' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo $args['before_link_list'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $i = 0;&nbsp;</div></li><li><div>  $user_account_url = get_option( 'user_account_url' );&nbsp;</div></li><li><div>  $links = array();&nbsp;</div></li><li><div>  foreach ( $profile_tabs as $tab_id =&gt; $tab_title ) :&nbsp;</div></li><li><div>      $tab_link = $args['before_link_item'];&nbsp;</div></li><li><div>      $tab_url = add_query_arg( 'tab', $tab_id, $user_account_url );&nbsp;</div></li><li><div>      $tab_link = sprintf(&nbsp;</div></li><li><div>          '&lt;a href=&quot;%1$s&quot; class=&quot;%2$s&quot;&gt;%3$s&lt;/a&gt;', &nbsp;</div></li><li><div>          esc_url( $tab_url ), &nbsp;</div></li><li><div>          esc_attr( $current_tab == $tab_id ? 'current' : '' ), &nbsp;</div></li><li><div>          $tab_title&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $tab_link .= $args['after_link_item'];&nbsp;</div></li><li><div>      $links[] = $tab_link;&nbsp;</div></li><li><div>  endforeach;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo implode( $args['link_separator'], $links );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo $args['after_link_list'];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function wpsc_user_purchases() {&nbsp;</div></li><li><div>  global $wpdb, $user_ID, $wpsc_purchlog_statuses, $gateway_checkout_form_fields, $purchase_log, $col_count, $nzshpcrt_gateways;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $i = 0;&nbsp;</div></li><li><div>  $subtotal = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'wpsc_pre_purchase_logs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) $purchase_log as $purchase ) {&nbsp;</div></li><li><div>      $status_state = &quot;expand&quot;;&nbsp;</div></li><li><div>      $status_style = &quot;display:none;&quot;;&nbsp;</div></li><li><div>      $alternate = &quot;&quot;;&nbsp;</div></li><li><div>      $i++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ($i % 2) != 0 )&nbsp;</div></li><li><div>          $alternate = &quot;alt&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;&lt;tr class='$alternate'&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot; &lt;td class='status processed'&gt;&quot;;&nbsp;</div></li><li><div>      echo &quot;&lt;a href=\&quot;#\&quot; onclick=\&quot;return show_details_box('status_box_&quot; . $purchase['id'] . &quot;', 'log_expander_icon_&quot; . $purchase['id'] . &quot;');\&quot;&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !empty($_GET['id']) && $_GET['id'] == $purchase['id'] ) {&nbsp;</div></li><li><div>          $status_state = &quot;collapse&quot;;&nbsp;</div></li><li><div>          $status_style = &quot;style='display: block;'&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;&lt;img class=\&quot;log_expander_icon\&quot; id=\&quot;log_expander_icon_&quot; . $purchase['id'] . &quot;\&quot; src=\&quot;&quot; . WPSC_CORE_IMAGES_URL . &quot;/icon_window_$status_state.gif\&quot; alt=\&quot;\&quot; title=\&quot;\&quot; /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;&lt;span id='form_group_&quot; . $purchase['id'] . &quot;_text'&gt;&quot; . __( 'Details', 'wpsc' ) . &quot;&lt;/span&gt;&quot;;&nbsp;</div></li><li><div>      echo &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      echo &quot; &lt;/td&gt;\n\r&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot; &lt;td class='date'&gt;&quot;;&nbsp;</div></li><li><div>      echo date( &quot;jS M Y&quot;, $purchase['date'] );&nbsp;</div></li><li><div>      echo &quot; &lt;/td&gt;\n\r&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot; &lt;td class='price'&gt;&quot;;&nbsp;</div></li><li><div>      $country = get_option( 'country_form_field' );&nbsp;</div></li><li><div>      if ( $purchase['shipping_country'] != '' ) {&nbsp;</div></li><li><div>          $billing_country = $purchase['billing_country'];&nbsp;</div></li><li><div>          $shipping_country = $purchase['shipping_country'];&nbsp;</div></li><li><div>      } elseif ( !empty($country)) {&nbsp;</div></li><li><div>          $country_sql = $wpdb-&gt;prepare( &quot;SELECT * FROM `&quot; . WPSC_TABLE_SUBMITTED_FORM_DATA . &quot;` WHERE `log_id` = %d AND `form_id` = %d LIMIT 1&quot;, $purchase['id'] , get_option( 'country_form_field' ) );&nbsp;</div></li><li><div>          $country_data = $wpdb-&gt;get_results( $country_sql, ARRAY_A );&nbsp;</div></li><li><div>          $billing_country = $country_data[0]['value'];&nbsp;</div></li><li><div>          $shipping_country = $country_data[0]['value'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo wpsc_currency_display( $purchase['totalprice'], array('display_as_html' =&gt; false) );&nbsp;</div></li><li><div>      $subtotal += $purchase['totalprice'];&nbsp;</div></li><li><div>      echo &quot; &lt;/td&gt;\n\r&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_option( 'payment_method' ) == 2 ) {&nbsp;</div></li><li><div>          echo &quot; &lt;td class='payment_method'&gt;&quot;;&nbsp;</div></li><li><div>          $gateway_name = '';&nbsp;</div></li><li><div>          foreach ( (array)$nzshpcrt_gateways as $gateway ) {&nbsp;</div></li><li><div>              if ( $purchase['gateway'] != 'testmode' ) {&nbsp;</div></li><li><div>                  if ( $gateway['internalname'] == $purchase['gateway'] ) {&nbsp;</div></li><li><div>                      $gateway_name = $gateway['name'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $gateway_name = __( &quot;Manual Payment&quot;, 'wpsc' );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo $gateway_name;&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;\n\r&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo &quot;&lt;/tr&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot;&lt;tr&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot; &lt;td colspan='$col_count' class='details'&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot;  &lt;div id='status_box_&quot; . $purchase['id'] . &quot;' class='order_status' style=\&quot;$status_style\&quot;&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot;  &lt;div&gt;\n\r&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//order status code lies here</span>&nbsp;</div></li><li><div>      <span class="comment">//check what $purchase['processed'] reflects in the $wpsc_purchlog_statuses array</span>&nbsp;</div></li><li><div>      $status_name = wpsc_find_purchlog_status_name( $purchase['processed'] );&nbsp;</div></li><li><div>      echo &quot;  &lt;strong class='form_group'&gt;&quot; . __( 'Order Status', 'wpsc' ) . &quot;:&lt;/strong&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo $status_name . &quot;&lt;br /&gt;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              do_action( 'wpsc_user_log_after_order_status', $purchase );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//written by allen</span>&nbsp;</div></li><li><div>      $usps_id = get_option( 'usps_user_id' );&nbsp;</div></li><li><div>      if ( $usps_id != null ) {&nbsp;</div></li><li><div>          $XML1 = &quot;&lt;TrackFieldRequest USERID=\&quot;$usps_id\&quot;&gt;&lt;TrackID ID=\&quot;&quot; . $purchase['track_id'] . &quot;\&quot;&gt;&lt;/TrackID&gt;&lt;/TrackFieldRequest&gt;&quot;;&nbsp;</div></li><li><div>          $ch = curl_init();&nbsp;</div></li><li><div>          curl_setopt( $ch, CURLOPT_URL, &quot;http:<span class="comment">//secure.shippingapis.com/ShippingAPITest.dll?&quot; );</span>&nbsp;</div></li><li><div>          curl_setopt( $ch, CURLOPT_RETURNTRANSFER, 1 );&nbsp;</div></li><li><div>          curl_setopt( $ch, CURLOPT_POST, 1 );&nbsp;</div></li><li><div>          curl_setopt( $ch, CURLOPT_HEADER, 0 );&nbsp;</div></li><li><div>          $postdata = &quot;API=TrackV2&XML=&quot; . $XML1;&nbsp;</div></li><li><div>          curl_setopt( $ch, CURLOPT_POSTFIELDS, $postdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $parser = new xml2array;&nbsp;</div></li><li><div>          $parsed = $parser-&gt;parse( $result );&nbsp;</div></li><li><div>          $parsed = $parsed[0]['children'][0]['children'];&nbsp;</div></li><li><div>          if ( $purchase['track_id'] != null ) {&nbsp;</div></li><li><div>              echo &quot;&lt;br /&gt;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>              echo &quot; &lt;strong class='form_group'&gt;&quot; . __( 'Shipping Address', 'wpsc' ) . &quot;&lt;/strong&gt;\n\r&quot;;&nbsp;</div></li><li><div>              echo &quot;&lt;table&gt;&quot;;&nbsp;</div></li><li><div>              foreach ( (array)$parsed as $parse ) {&nbsp;</div></li><li><div>                  if ( $parse['name'] == &quot;TRACKSUMMARY&quot; )&nbsp;</div></li><li><div>                      foreach ( (array)$parse['children'] as $attrs ) {&nbsp;</div></li><li><div>                          if ( $attrs['name'] != &quot;EVENT&quot; )&nbsp;</div></li><li><div>                              $attrs['name'] = str_replace( &quot;EVENT&quot;, &quot;&quot;, $attrs['name'] );&nbsp;</div></li><li><div>                          $bar = ucfirst( strtolower( $attrs['name'] ) );&nbsp;</div></li><li><div>                          echo &quot;&lt;tr&gt;&lt;td&gt;&quot; . $bar . &quot;&lt;/td&gt;&lt;td&gt;&quot; . $attrs['tagData'] . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo &quot;&lt;br /&gt;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//end of written by allen</span>&nbsp;</div></li><li><div>      <span class="comment">//cart contents display starts here;</span>&nbsp;</div></li><li><div>      echo &quot;  &lt;strong class='form_group'&gt;&quot; . __( 'Order Details', 'wpsc' ) . &quot;:&lt;/strong&gt;\n\r&quot;;&nbsp;</div></li><li><div>      $cartsql = $wpdb-&gt;prepare( &quot;SELECT * FROM `&quot; . WPSC_TABLE_CART_CONTENTS . &quot;` WHERE `purchaseid`= %d&quot;, $purchase['id'] );&nbsp;</div></li><li><div>      $cart_log = $wpdb-&gt;get_results( $cartsql, ARRAY_A );&nbsp;</div></li><li><div>      $j = 0;&nbsp;</div></li><li><div>      <span class="comment">// /*</span>&nbsp;</div></li><li><div>      if ( $cart_log != null ) {&nbsp;</div></li><li><div>          echo &quot;&lt;table class='logdisplay'&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;tr class='toprow2'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;th class='details_name'&gt;&quot;;&nbsp;</div></li><li><div>          _e( 'Name', 'wpsc' );&nbsp;</div></li><li><div>          echo &quot; &lt;/th&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;th class='details_quantity'&gt;&quot;;&nbsp;</div></li><li><div>          _e( 'Quantity', 'wpsc' );&nbsp;</div></li><li><div>          echo &quot; &lt;/th&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;th class='details_price'&gt;&quot;;&nbsp;</div></li><li><div>          _e( 'Price', 'wpsc' );&nbsp;</div></li><li><div>          echo &quot; &lt;/th&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;th class='details_tax'&gt;&quot;;&nbsp;</div></li><li><div>          _e( 'GST', 'wpsc' );&nbsp;</div></li><li><div>          echo &quot; &lt;/th&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;th class='details_shipping'&gt;&quot;;&nbsp;</div></li><li><div>          _e( 'Shipping', 'wpsc' );&nbsp;</div></li><li><div>          echo &quot; &lt;/th&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;th class='details_total'&gt;&quot;;&nbsp;</div></li><li><div>          _e( 'Total', 'wpsc' );&nbsp;</div></li><li><div>          echo &quot; &lt;/th&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $gsttotal = false;&nbsp;</div></li><li><div>          $endtotal = $total_shipping = 0;&nbsp;</div></li><li><div>          foreach ( (array)$cart_log as $cart_row ) {&nbsp;</div></li><li><div>              $alternate = &quot;&quot;;&nbsp;</div></li><li><div>              $j++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ($j % 2) != 0 )&nbsp;</div></li><li><div>                  $alternate = &quot;alt&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $variation_list = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $billing_country = !empty($country_data[0]['value']) ? $country_data[0]['value'] : '';&nbsp;</div></li><li><div>              $shipping_country = !empty($country_data[0]['value']) ? $country_data[0]['value'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $shipping = $cart_row['pnp'];&nbsp;</div></li><li><div>              $total_shipping += $shipping;&nbsp;</div></li><li><div>              echo &quot;&lt;tr class='$alternate'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo &quot; &lt;td class='details_name'&gt;&quot;;&nbsp;</div></li><li><div>              echo apply_filters( 'the_title', $cart_row['name'] );&nbsp;</div></li><li><div>              echo $variation_list;&nbsp;</div></li><li><div>              echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo &quot; &lt;td class='details_quantity'&gt;&quot;;&nbsp;</div></li><li><div>              echo $cart_row['quantity'];&nbsp;</div></li><li><div>              echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo &quot; &lt;td class='details_price'&gt;&quot;;&nbsp;</div></li><li><div>              $price = $cart_row['price'] * $cart_row['quantity'];&nbsp;</div></li><li><div>              echo wpsc_currency_display( $price );&nbsp;</div></li><li><div>              echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo &quot; &lt;td class='details_tax'&gt;&quot;;&nbsp;</div></li><li><div>              $gst = $cart_row['tax_charged'];&nbsp;</div></li><li><div>              if( $gst &gt; 0)&nbsp;</div></li><li><div>                  $gsttotal += $gst;&nbsp;</div></li><li><div>              echo wpsc_currency_display( $gst , array('display_as_html' =&gt; false) );&nbsp;</div></li><li><div>              echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo &quot; &lt;td class='details_shipping'&gt;&quot;;&nbsp;</div></li><li><div>              echo wpsc_currency_display( $shipping , array('display_as_html' =&gt; false) );&nbsp;</div></li><li><div>              echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo &quot; &lt;td class='details_total'&gt;&quot;;&nbsp;</div></li><li><div>              $endtotal += $price;&nbsp;</div></li><li><div>              echo wpsc_currency_display( ( $shipping + $price ), array('display_as_html' =&gt; false) );&nbsp;</div></li><li><div>              echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              echo '&lt;/tr&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo &quot;&lt;tr&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;td&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;td&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;td&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot; &lt;td&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;td class='details_totals_labels'&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;strong&gt;&quot; . __( 'Total Shipping', 'wpsc' ) . &quot;:&lt;/strong&gt;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;strong&gt;&quot; . __( 'Total Tax', 'wpsc' ) . &quot;:&lt;/strong&gt;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;strong&gt;&quot; . __( 'Final Total', 'wpsc' ) . &quot;:&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot; &lt;td class='details_totals_labels'&gt;&quot;;&nbsp;</div></li><li><div>          $total_shipping += $purchase['base_shipping'];&nbsp;</div></li><li><div>          $endtotal += $total_shipping;&nbsp;</div></li><li><div>          $endtotal += $purchase['wpec_taxes_total'];&nbsp;</div></li><li><div>          echo wpsc_currency_display( $total_shipping, array('display_as_html' =&gt; false) ) . &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>          if ( $gsttotal ) { <span class="comment">//if false then must be exclusive.. doesnt seem too reliable needs more testing</span>&nbsp;</div></li><li><div>              echo wpsc_currency_display( $gsttotal , array('display_as_html' =&gt; false) ). &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              echo wpsc_currency_display( $purchase['wpec_taxes_total'] , array('display_as_html' =&gt; false) ). &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo wpsc_currency_display( $endtotal , array('display_as_html' =&gt; false) );&nbsp;</div></li><li><div>          echo &quot; &lt;/td&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;/tr&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;br /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;&lt;strong&gt;&quot; . __( 'Customer Details', 'wpsc' ) . &quot;:&lt;/strong&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;table class='customer_details'&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $usersql = $wpdb-&gt;prepare( &quot;SELECT `&quot;.WPSC_TABLE_SUBMITTED_FORM_DATA.&quot;`.value, `&quot;.WPSC_TABLE_CHECKOUT_FORMS.&quot;`.* FROM `&quot;.WPSC_TABLE_CHECKOUT_FORMS.&quot;` LEFT JOIN `&quot;.WPSC_TABLE_SUBMITTED_FORM_DATA.&quot;` ON `&quot;.WPSC_TABLE_CHECKOUT_FORMS.&quot;`.id = `&quot;.WPSC_TABLE_SUBMITTED_FORM_DATA.&quot;`.`form_id` WHERE `&quot;.WPSC_TABLE_SUBMITTED_FORM_DATA.&quot;`.log_id = %d OR `&quot;.WPSC_TABLE_CHECKOUT_FORMS.&quot;`.type = 'heading' ORDER BY `&quot;.WPSC_TABLE_CHECKOUT_FORMS.&quot;`.`checkout_set`, `&quot;.WPSC_TABLE_CHECKOUT_FORMS.&quot;`.`checkout_order`&quot;, $purchase['id'] );&nbsp;</div></li><li><div>          $formfields = $wpdb-&gt;get_results($usersql, ARRAY_A);&nbsp;</div></li><li><div>          if ( !empty($formfields) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( (array)$formfields as $form_field ) {&nbsp;</div></li><li><div>                  <span class="comment">// If its a heading display the Name otherwise continue on</span>&nbsp;</div></li><li><div>                  if( 'heading' == $form_field['type'] ) {&nbsp;</div></li><li><div>                      echo &quot;  &lt;tr&gt;&lt;td colspan='2'&gt;&quot; . esc_html( $form_field['name'] ) . &quot;:&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  switch ($form_field['unique_name']) {&nbsp;</div></li><li><div>                      case 'shippingcountry':&nbsp;</div></li><li><div>                      case 'billingcountry':&nbsp;</div></li><li><div>                      $country = maybe_unserialize($form_field['value']);&nbsp;</div></li><li><div>                           if(is_array($country))&nbsp;</div></li><li><div>                               $country = $country[0];&nbsp;</div></li><li><div>                           else&nbsp;</div></li><li><div>                               $country = $form_field['value'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                           echo &quot;  &lt;tr&gt;&lt;td&gt;&quot; . esc_html( $form_field['name'] ) . &quot;:&lt;/td&gt;&lt;td&gt;&quot; . esc_html( $country ) . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      case 'billingstate':&nbsp;</div></li><li><div>                      case 'shippingstate':&nbsp;</div></li><li><div>                          if(is_numeric($form_field['value']))&nbsp;</div></li><li><div>                              $state = wpsc_get_state_by_id($form_field['value'], 'name');&nbsp;</div></li><li><div>                              else&nbsp;</div></li><li><div>                               $state = $form_field['value'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            echo &quot;  &lt;tr&gt;&lt;td&gt;&quot; . esc_html( $form_field['name'] ) . &quot;:&lt;/td&gt;&lt;td&gt;&quot; . esc_html( $state ) . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      default:&nbsp;</div></li><li><div>                          echo &quot;  &lt;tr&gt;&lt;td&gt;&quot; . esc_html( $form_field['name'] ) . &quot;:&lt;/td&gt;&lt;td&gt;&quot; . esc_html( $form_field['value'] ) . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $payment_gateway_names = '';&nbsp;</div></li><li><div>          $payment_gateway_names = get_option('payment_gateway_names');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( (array)$payment_gateway_names as $gatewayname ) {&nbsp;</div></li><li><div>              <span class="comment">//if the gateway has a custom name</span>&nbsp;</div></li><li><div>              if (!empty ($gatewayname) )&nbsp;</div></li><li><div>                  $display_name = $payment_gateway_names[$purchase_log[0]['gateway']];&nbsp;</div></li><li><div>              else{&nbsp;</div></li><li><div>              <span class="comment">//if not fall back on default name</span>&nbsp;</div></li><li><div>                  foreach ( (array)$nzshpcrt_gateways as $gateway ) {&nbsp;</div></li><li><div>                      if ( $gateway['internalname'] == $purchase['gateway'])&nbsp;</div></li><li><div>                          $display_name = $gateway['name'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;  &lt;tr&gt;&lt;td&gt;&quot; . __( 'Payment Method', 'wpsc' ) . &quot;:&lt;/td&gt;&lt;td&gt;&quot; . $display_name . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;  &lt;tr&gt;&lt;td&gt;&quot; . __( 'Purchase #', 'wpsc' ) . &quot;:&lt;/td&gt;&lt;td&gt;&quot; . $purchase['id'] . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>          if ( $purchase['transactid'] != '' ) {&nbsp;</div></li><li><div>              echo &quot;  &lt;tr&gt;&lt;td&gt;&quot; . __( 'Transaction Id', 'wpsc' ) . &quot;:&lt;/td&gt;&lt;td&gt;&quot; . $purchase['transactid'] . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          echo &quot;&lt;/table&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      echo &quot;  &lt;/div&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot;  &lt;/div&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot; &lt;/td&gt;\n\r&quot;;&nbsp;</div></li><li><div>      echo &quot;&lt;/tr&gt;\n\r&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the Purchase History template</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.10</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_action_purchase_history_section() {&nbsp;</div></li><li><div>  include( wpsc_get_template_file_path( 'wpsc-account-purchase-history.php' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpsc_user_profile_section_purchase_history', '_wpsc_action_purchase_history_section' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the Edit Profile template</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.10</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_action_edit_profile_section() {&nbsp;</div></li><li><div>  include( wpsc_get_template_file_path( 'wpsc-account-edit-profile.php' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpsc_user_profile_section_edit_profile', '_wpsc_action_edit_profile_section' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the Downloads template</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.10</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_action_downloads_section() {&nbsp;</div></li><li><div>  global $files, $products;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $items = array();&nbsp;</div></li><li><div>  if ( wpsc_has_downloads() && ! empty( $files ) ) {&nbsp;</div></li><li><div>      foreach ( $files as $key =&gt; $file ) {&nbsp;</div></li><li><div>          $item = array();&nbsp;</div></li><li><div>          if ( $products[$key]['downloads'] &gt; 0 ) {&nbsp;</div></li><li><div>              $url = add_query_arg(&nbsp;</div></li><li><div>                  'downloadid', &nbsp;</div></li><li><div>                  $products[$key]['uniqueid'], &nbsp;</div></li><li><div>                  home_url()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              $item['title'] = sprintf(&nbsp;</div></li><li><div>                  '&lt;a href=&quot;%1$s&quot;&gt;%2$s&lt;/a&gt;', &nbsp;</div></li><li><div>                  esc_url( $url ), &nbsp;</div></li><li><div>                  esc_html( $file['post_title'] )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $item['title'] = esc_html( $file['post_title'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $item['downloads'] = $products[$key]['downloads'];&nbsp;</div></li><li><div>          $item['datetime'] = date( get_option( 'date_format' ), strtotime( $products[$key]['datetime'] ) );&nbsp;</div></li><li><div>          $items[] = (object) $item;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  include( wpsc_get_template_file_path( 'wpsc-account-downloads.php' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpsc_user_profile_section_downloads', '_wpsc_action_downloads_section' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>