<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="23175"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-includes-wpsc-meta-util | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.8"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=11b58389f45a5b8edc065a175a11fe94' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.8' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-includes-wpsc-meta-util/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-includes-wpsc-meta-util%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-includes-wpsc-meta-util%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-includes-wpsc-meta-util","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-includes-wpsc-meta-util" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-includes-wpsc-meta-util</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-includes/wpsc-meta-util.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// this is the priority that all hooks that enforce business rules about visitor meta will run.</span>&nbsp;</div></li><li><div><span class="comment">// Intentially set to a high priority so that extensions that use the hooks see the visitor meta values</span>&nbsp;</div></li><li><div><span class="comment">// after the rules have been enforced</span>&nbsp;</div></li><li><div>if ( ! defined( '_WPSC_USER_META_HOOK_PRIORITY' ) ) {&nbsp;</div></li><li><div>  define( '_WPSC_USER_META_HOOK_PRIORITY' , 2 );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get all meta ids that have the meta value</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type the WordPress meta object type</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key ids with the specified meta key</span>&nbsp;</div></li><li><div><span class="comment"> * @return array of int     meta object type object ids that match have the meta key</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_meta_ids_by_meta_key( $meta_object_type, $meta_key = '' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_table = _wpsc_meta_table_name( 'visitor' );&nbsp;</div></li><li><div>  $meta_key = _wpsc_meta_key_name( $meta_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $sql = 'SELECT meta_id FROM `' . $meta_table . '` where meta_key = &quot;%s&quot;';&nbsp;</div></li><li><div>  $sql = $wpdb-&gt;prepare( $sql, $meta_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_item_ids = $wpdb-&gt;get_col( $sql, 0 );&nbsp;</div></li><li><div>  $meta_item_ids = array_map( 'intval', $meta_item_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_item_ids = apply_filters( 'wpsc_get_ids_by_meta_key', $meta_item_ids, $meta_object_type, $meta_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $meta_item_ids;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Calls function for each meta matching the timestamp criteria.  Callback function</span>&nbsp;</div></li><li><div><span class="comment"> * will get a single parameter that is an object representing the meta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.12</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type the WordPress meta object type</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|string $timestamp timestamp to compare meta items against, if int a unix timestamp is assumed, </span>&nbsp;</div></li><li><div><span class="comment"> *                                if string a MYSQL timestamp is assumed</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $comparison any one of the supported comparison operators, (=, &gt;=, &gt;, &lt;=, &lt;, &lt;&gt;, !=)</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key restrict testing of meta to the values with the specified meta key</span>&nbsp;</div></li><li><div><span class="comment"> * @return array metadata matching the query</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_meta_by_timestamp( $meta_object_type, $timestamp = 0, $comparison = '&gt;', $meta_key = '' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_table = _wpsc_meta_table_name( $meta_object_type );&nbsp;</div></li><li><div>  $id_field_name = _wpsc_meta_key_name( 'visitor' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ($timestamp == 0) || empty( $timestamp ) ) {&nbsp;</div></li><li><div>      $sql = 'SELECT ' . $id_field_name . ' AS id FROM ` ' . $meta_table . '` ';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// validate the comparison operator</span>&nbsp;</div></li><li><div>      if ( ! in_array( $comparison, array( '=', '&gt;=', '&gt;', '&lt;=', '&lt;', '&lt;&gt;', '!=' ) ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_int( $timestamp ) ) {&nbsp;</div></li><li><div>          $timestamp = date( 'Y-m-d H:i:s', $timestamp );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = 'SELECT ' . $id_field_name . ' as id FROM `' . $meta_table. '` where meta_timestamp ' . $comparison . ' &quot;%s&quot;';&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( $sql , $timestamp );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty ($meta_key ) ) {&nbsp;</div></li><li><div>      $sql .= ' AND meta_key = %s';&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( $sql , $meta_key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_item_ids = $wpdb-&gt;get_col( $sql, 0 );&nbsp;</div></li><li><div>  $meta_item_ids = array_map( 'intval', $meta_item_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_item_ids = apply_filters( 'wpsc_get_meta_by_timestamp', $meta_item_ids, $meta_object_type, $meta_key, $timestamp, $comparison );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $metas = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $meta_item_ids as $id ) {&nbsp;</div></li><li><div>      $metas[$id] = get_metadata( $meta_object_type , $id , $meta_key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $metas;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get meta timestamp of the by object type, meta id and key, if multiple records exist</span>&nbsp;</div></li><li><div><span class="comment"> * the timestamp of the most recently updated record is returned</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.12</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $object_id ID for a specific meta item</span>&nbsp;</div></li><li><div><span class="comment"> * @return object Meta object timestamp or false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_metadata_timestamp( $meta_object_type, $object_id, $meta_key = '' ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $object_id = intval( $object_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty($meta_object_type) && ! empty( $meta_id )  && ! empty( $meta_key ) ) {&nbsp;</div></li><li><div>      $meta_table_name = _wpsc_meta_table_name( $meta_object_type );&nbsp;</div></li><li><div>      $id_field_name = _wpsc_meta_key_name( 'visitor' );&nbsp;</div></li><li><div>      if ( ! empty( $meta_table_name ) ) {&nbsp;</div></li><li><div>          if ( ! empty ( $meta_key ) ) {&nbsp;</div></li><li><div>              $sql = 'SELECT meta_timestamp '&nbsp;</div></li><li><div>                      . ' FROM '. $meta_table_name&nbsp;</div></li><li><div>                      . ' WHERE meta_key = %s AND `' . $id_field_name . '` = %d '&nbsp;</div></li><li><div>                      . ' ORDER BY meta_timestamp DESC LIMIT 1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $wpdb-&gt;prepare( $sql , $meta_key, $object_id );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $sql = 'SELECT meta_timestamp '&nbsp;</div></li><li><div>                      . ' FROM '. $meta_table_name&nbsp;</div></li><li><div>                      . ' WHERE ' . $id_field_name . '` = %d '&nbsp;</div></li><li><div>                      . ' ORDER BY meta_timestamp DESC LIMIT 1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $wpdb-&gt;prepare( $sql , $meta_key, $object_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $timestamp = $wpdb-&gt;get_row( $sql );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $timestamp ) ) {&nbsp;</div></li><li><div>      $timestamp = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $timestamp;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get meta timestamp of the by meta object id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $meta_id ID for a specific meta row</span>&nbsp;</div></li><li><div><span class="comment"> * @return object Meta object timestamp or false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_get_meta_id_timestamp( $meta_object_type, $meta_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_id = intval( $meta_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty($meta_object_type) && ! empty( $meta_id ) ) {&nbsp;</div></li><li><div>      $meta_table_name = _wpsc_meta_table_name( $meta_object_type );&nbsp;</div></li><li><div>      if ( ! empty( $meta_table_name ) ) {&nbsp;</div></li><li><div>          $sql = 'SELECT meta_timestamp FROM '. $meta_table_name .' WHERE meta_id = %d';&nbsp;</div></li><li><div>          $timestamp = $wpdb-&gt;get_var( $wpdb-&gt;prepare( $sql , $meta_id ), 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $timestamp ) ) {&nbsp;</div></li><li><div>      $timestamp = false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $timestamp;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the meta associated with a specific meta type and meta id</span>&nbsp;</div></li><li><div><span class="comment"> * the timestamp of the newest record is returned</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $meta_id ID for a specific meta row</span>&nbsp;</div></li><li><div><span class="comment"> * @return object Meta object or false.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_get_meta_by_meta_id( $meta_object_type, $meta_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $meta_item = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_id = intval( $meta_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty($meta_object_type) && ! empty( $meta_id ) ) {&nbsp;</div></li><li><div>      $meta_table_name = _wpsc_meta_table_name( $meta_object_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $meta_table_name ) ) {&nbsp;</div></li><li><div>          $sql = 'SELECT * FROM ' . $meta_table_name . ' WHERE meta_id = %d';&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare( $sql , $meta_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta_item = $wpdb-&gt;get_row( $sql, OBJECT );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta_item-&gt;meta_value = maybe_unserialize( $meta_item-&gt;meta_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $meta_item === null ) {&nbsp;</div></li><li><div>              $meta_item = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $meta_item;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the meta ids associated with a specific meta type, object id and meta key</span>&nbsp;</div></li><li><div><span class="comment"> * the timestamp of the newest record is returned</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @acess private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $meta_id ID for a specific meta row</span>&nbsp;</div></li><li><div><span class="comment"> * @return array array of meta ids</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_get_meta_ids( $meta_object_type, $object_id, $meta_key ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $meta_item_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $object_id = intval( $object_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty($meta_object_type) && ! empty( $object_id )  && ! empty( $meta_key ) ) {&nbsp;</div></li><li><div>      $meta_table_name = _wpsc_meta_table_name( $meta_object_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $meta_table_name ) ) {&nbsp;</div></li><li><div>          $sql = 'SELECT meta_id '&nbsp;</div></li><li><div>                  . ' FROM '. $meta_table_name&nbsp;</div></li><li><div>                  . ' WHERE `' . _wpsc_meta_key_name( $meta_object_type )  . '` = %d '&nbsp;</div></li><li><div>                  . ' AND meta_key = %s';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare( $sql , $object_id, $meta_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta_item_ids = $wpdb-&gt;get_col( $sql, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $meta_item_ids ) ) {&nbsp;</div></li><li><div>              $meta_item_ids = array_map( 'intval', $meta_item_ids );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $meta_item_ids;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validate the custom meta object type</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @return validated string, or empty string if it isn't a valid object type</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_validate_meta_object_type( $meta_object_type ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// This is a name translation that should stay very small and only be added to</span>&nbsp;</div></li><li><div>  <span class="comment">// in the case where we change a meta object name, or are storing multiple meta</span>&nbsp;</div></li><li><div>  <span class="comment">// types in the same table.</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  // TODO: post 3.8.14 enhance by adding the general meta table to this array and validate the the</span>&nbsp;</div></li><li><div>  <span class="comment">// WPEC built in meta infrastructure, with its nifty caching capabilities can be used to access</span>&nbsp;</div></li><li><div>  <span class="comment">// the legacy catch-all meta table</span>&nbsp;</div></li><li><div>  <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">  $valid_meta_object_types = array(</span>&nbsp;</div></li><li><div>          'visitor' =&gt; 'visitor', <span class="comment"><span class="comment"><span class="comment">// valid customer meta table</span></span></span>&nbsp;</div></li><li><div>          'purchase' =&gt; 'purchase', <span class="comment"><span class="comment"><span class="comment">// valid customer meta table</span></span></span>&nbsp;</div></li><li><div>          'cart_item' =&gt; 'cart_item', <span class="comment"><span class="comment"><span class="comment">// valid customer meta table</span></span></span>&nbsp;</div></li><li><div>          'customer' =&gt; 'visitor', <span class="comment">// customer changed to visitor in release 3.8.14</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( in_array( $meta_object_type, $valid_meta_object_types ) ) {&nbsp;</div></li><li><div>      $object_type = $valid_meta_object_types[$meta_object_type];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $object_type = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $object_type;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The name of the meta table for a specific meta object type.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *  if it hasn't been defined in $wpdb the name as it would be defined is returned. The</span>&nbsp;</div></li><li><div><span class="comment"> *  likely cases where it would not be defined would be during an initialization or</span>&nbsp;</div></li><li><div><span class="comment"> *  upgrade process. Because it is possible that the meta table name has been overridden</span>&nbsp;</div></li><li><div><span class="comment"> *  we will check to see if it exists in the $wpdb object before trying to crate it anew.</span>&nbsp;</div></li><li><div><span class="comment"> *  Note: that function call does not check if the table exits, it only give back the name, </span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.12</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Name of the custom meta table defined in $wpdb, or the name as it would be defined</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_meta_table_name( $meta_object_type ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_table_name_property = _wpsc_wpdb_meta_table( $meta_object_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( property_exists( $wpdb, $meta_table_name_property ) ) {&nbsp;</div></li><li><div>      return $wpdb-&gt;$meta_table_name_property;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return $wpdb-&gt;prefix . $meta_object_type . '_meta';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The name of the meta table property for a specific meta object type, this name should be the name</span>&nbsp;</div></li><li><div><span class="comment"> * found in the $wpdb class for the specified meta type</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @return string Name of the applicable WPEC custom meta table, empty string if the meta type is not valid</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_wpdb_meta_table( $meta_object_type ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $meta_object_type = _wpsc_validate_meta_object_type( $meta_object_type ) ) {&nbsp;</div></li><li><div>      $table_name_property = 'wpsc_'. $meta_object_type . 'meta';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $table_name_property = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $table_name_property;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The name of the column in the meta table that contains the key of the target object</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_object_type Type of object metadata is for (e.g., variation. cart, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * @return string column name of the applicable WPEC custom meta table index field, empty string if the meta type is not valid</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_meta_key_name( $meta_object_type ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $meta_object_type = _wpsc_validate_meta_object_type( $meta_object_type ) ) {&nbsp;</div></li><li><div>      $id_field_name = 'wpsc_' . $meta_object_type . '_id';&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $id_field_name = '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $id_field_name;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check the visitor meta key to see if it has been aliased to another visitor meta key</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $visitor_meta_key</span>&nbsp;</div></li><li><div><span class="comment"> * @return string valid unchanged key if original is valid, or replacement visitor meta key</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_validate_visitor_meta_key( $visitor_meta_key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// WPEC internal visitor meta keys are not allowed to be aliased, internal visitor meta keys</span>&nbsp;</div></li><li><div>  if ( ! ( strpos( $visitor_meta_key, _wpsc_get_visitor_meta_key( '' ) ) === 0 ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $build_in_checkout_names = wpsc_checkout_unique_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// the built in checkout names cannot be aliased to something else</span>&nbsp;</div></li><li><div>      if ( ! in_array( $visitor_meta_key, $build_in_checkout_names ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Filter wpsc_visitor_meta_key_replacements</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Get an array of key/value pairs that are used to alias visitor meta keys. The</span>&nbsp;</div></li><li><div><span class="comment">           * key is the old name, the value is the new name</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * @param array of key value pairs</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          $aliased_meta_keys = apply_filters( 'wpsc_visitor_meta_key_replacements', array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $aliased_meta_keys[$visitor_meta_key] ) ) {&nbsp;</div></li><li><div>              $visitor_meta_key = $aliased_meta_keys[$visitor_meta_key];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $visitor_meta_key;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Replace all of the specified meta keys in the database during an upgrade</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array  array of string parirs old key is the index key, new key is the value</span>&nbsp;</div></li><li><div><span class="comment"> * @return int    count of values updated</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_replace_visitor_meta_keys( $replacements ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $build_in_checkout_names = wpsc_checkout_unique_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $total_count_updated = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $replacements as $old_meta_key =&gt; $new_meta_key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// the built in checkout names cannot be replaced to something else</span>&nbsp;</div></li><li><div>      if ( ! isset( $build_in_checkout_names[$visitor_meta_key] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $sql = 'UPDATE ' . $wpdb-&gt;wpsc_visitormeta . ' SET meta_key = &quot;' . $new_meta_key .&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $rows_updated = $wpdb-&gt;update(&nbsp;</div></li><li><div>                  $wpdb-&gt;wpsc_visitormeta, <span class="comment">// table</span>&nbsp;</div></li><li><div>                  array( 'meta_key' =&gt; $new_meta_key, ), <span class="comment">// data to set</span>&nbsp;</div></li><li><div>                  array( 'meta_key' =&gt; $old_meta_key, ), <span class="comment">// where</span>&nbsp;</div></li><li><div>                  array( '%s', ), <span class="comment">// format</span>&nbsp;</div></li><li><div>                  array( '%s', )                          <span class="comment">// where</span> format&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $total_count_updated += $rows_updated;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $total_count_updated &gt; 0 ) {&nbsp;</div></li><li><div>      wpsc_core_flush_temporary_data();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $total_count_updated;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** Create visitors that we expect to be in the table</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_create_well_known_visitors() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// user id 1 will be used for a well known bot user</span>&nbsp;</div></li><li><div>  $wpdb-&gt;insert( $wpdb-&gt;wpsc_visitors, array( 'id' =&gt; 1 ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( defined( 'DOING_AJAX' ) && DOING_AJAX ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_action( 'wp_ajax_wpsc_migrate_anonymous_user', '_wpsc_meta_migrate_anonymous_user_worker' );&nbsp;</div></li><li><div>  add_action( 'wp_ajax_nopriv_wpsc_migrate_anonymous_user', '_wpsc_meta_migrate_anonymous_user_worker' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function _wpsc_meta_migrate_anonymous_user_worker() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $blog_prefix = is_multisite() ? $wpdb-&gt;get_blog_prefix() : '';&nbsp;</div></li><li><div>      $key_pattern = &quot;{$blog_prefix}_wpsc_&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_suspend_cache_addition( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $sql = 'SELECT ID FROM '. $wpdb-&gt;users . ' WHERE user_login LIKE &quot;\_%&quot; AND user_email = &quot;&quot; AND user_login = user_nicename AND user_login = display_name LIMIT 100';&nbsp;</div></li><li><div>      $user_ids = $wpdb-&gt;get_col( $sql, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Create an array to store users to be removed.</span>&nbsp;</div></li><li><div>      $bin = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $user_ids as $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $wpdb-&gt;query( 'INSERT INTO ' . $wpdb-&gt;wpsc_visitors . '(`id`) VALUES ( ' . $user_id . ' )' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wpsc_set_visitor_expiration( $user_id, DAY_IN_SECONDS );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta = get_user_meta( $user_id );&nbsp;</div></li><li><div>          foreach ( $meta as $key =&gt; $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( strpos( $key, $key_pattern ) === FALSE )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $short_key = str_replace( $key_pattern, '', $key );&nbsp;</div></li><li><div>              if ( $short_key !== 'cart' ) {&nbsp;</div></li><li><div>                  wpsc_add_visitor_meta( $user_id , $short_key, $value[0] );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $wpsc_user_cart = maybe_unserialize( base64_decode( $value[0] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! ($wpsc_user_cart instanceof wpsc_cart) ) {&nbsp;</div></li><li><div>                      $wpsc_user_cart = new wpsc_cart();&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $comment_count = $wpdb-&gt;get_var( 'SELECT COUNT(comment_ID) FROM ' . $wpdb-&gt;comments. ' WHERE user_id = ' . $user_id );&nbsp;</div></li><li><div>          if ( ! count_user_posts( $user_id ) && ! $comment_count ) {&nbsp;</div></li><li><div>              <span class="comment">//wp_delete_user( $user_id );</span>&nbsp;</div></li><li><div>              <span class="comment">// Add user to bin.</span>&nbsp;</div></li><li><div>              $bin[] = $user_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove users.</span>&nbsp;</div></li><li><div>      if ( ! empty( $bin ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Convert $bin to string.</span>&nbsp;</div></li><li><div>          $bin = implode( ', ', $bin );&nbsp;</div></li><li><div>          $wpdb-&gt;query( 'DELETE FROM ' . $wpdb-&gt;users . ' WHERE ID IN (' . $bin . ')' );&nbsp;</div></li><li><div>          $wpdb-&gt;query( 'DELETE FROM ' . $wpdb-&gt;usermeta . ' WHERE user_id IN (' . $bin . ')' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_suspend_cache_addition( false );&nbsp;</div></li><li><div>      exit( 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'wpsc_migrate_anonymous_user_cron', '_wpsc_meta_migrate_anonymous_user_cron' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _wpsc_meta_migrate_anonymous_user_cron() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  set_time_limit( 10 * 60 ); <span class="comment">// 10 minutes maximum for the cron</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// WPEC created user records with a funky format, no email is a dead giveaway, as is login, user name and display name being idnentical with the '_'</span>&nbsp;</div></li><li><div>  $sql = 'SELECT count( ID ) FROM '. $wpdb-&gt;users . ' WHERE user_login LIKE &quot;\_%&quot; AND user_email = &quot;&quot; AND user_login = user_nicename AND user_login = display_name LIMIT 1';&nbsp;</div></li><li><div>  $ids_to_migrate = $user_ids = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $ids_to_migrate ) {&nbsp;</div></li><li><div>      $response = wp_remote_post( admin_url( 'admin-ajax.php' ) . '?action=wpsc_migrate_anonymous_user' , array(  'blocking' =&gt; true, ) );&nbsp;</div></li><li><div>      wp_schedule_single_event( time() + 30 , 'wpsc_migrate_anonymous_user_cron' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wpsc_core_flush_temporary_data();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * custmer/visitor/user meta has been known by different identifiers. we are trying to standardize on using</span>&nbsp;</div></li><li><div><span class="comment"> * the uniquename value in the form definition for well known shopper meta.  this function allows</span>&nbsp;</div></li><li><div><span class="comment"> * old meta keys to return the proper meta value from the database</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param unknown $meta_keys</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_visitor_meta_key_replacements( $meta_keys ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $meta_keys['billing_region'] = 'billingregion';&nbsp;</div></li><li><div>  $meta_keys['billing_country'] = 'billingcountry';&nbsp;</div></li><li><div>  $meta_keys['shipping_region'] = 'shippingregion';&nbsp;</div></li><li><div>  $meta_keys['shipping_country'] = 'shippingcountry';&nbsp;</div></li><li><div>  $meta_keys['shipping_zip'] = 'shippingpostcode';&nbsp;</div></li><li><div>  $meta_keys['shipping_zipcode'] = 'shippingpostcode';&nbsp;</div></li><li><div>  $meta_keys['billing_zip'] = 'billingpostcode';&nbsp;</div></li><li><div>  $meta_keys['billing_zipcode'] = 'billingpostcode';&nbsp;</div></li><li><div>  $meta_keys['shippingzip'] = 'shippingpostcode';&nbsp;</div></li><li><div>  $meta_keys['billingzip'] = 'billingpostcode';&nbsp;</div></li><li><div>  $meta_keys['shipping_same_as_billing'] = 'shippingSameBilling';&nbsp;</div></li><li><div>  $meta_keys['delivertoafriend'] = 'shippingSameBilling';&nbsp;</div></li><li><div>  $meta_keys['shipping_state'] = 'shippingstate';&nbsp;</div></li><li><div>  return $meta_keys;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_filter( 'wpsc_visitor_meta_key_replacements', '_wpsc_visitor_meta_key_replacements' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Keep track of which visitor location attributes are changing, when the attributes are done changing</span>&nbsp;</div></li><li><div><span class="comment"> * at an apprpriate place in the flow there will be a call to _wpsc_has_visitor_location changed.  When</span>&nbsp;</div></li><li><div><span class="comment"> * that function runs it will check if there has been a change and will fire an action to whomever has</span>&nbsp;</div></li><li><div><span class="comment"> * hooked it to tell them it's time to do what ever they need to do with the changed location.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * By keeping track of which attributes have changed on the location different modules can decide what</span>&nbsp;</div></li><li><div><span class="comment"> * they might need to recalculate.  An example.  USPS rates are dependant on origin and destination</span>&nbsp;</div></li><li><div><span class="comment"> * zip codes, UPS rates use origin and destination zip codes and destination street address to calculate</span>&nbsp;</div></li><li><div><span class="comment"> * shipment costs.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Record what is changing about the visitors location</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string location value being set</span>&nbsp;</div></li><li><div><span class="comment"> * @param string location attribute name ( see unique_name field checkout definitions)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    the visitor/customer unique id</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return true if this is a location change, false if we already new that the specified part of the location changed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_visitor_location_is_changing( $meta_value, $meta_key, $visitor_id ) {&nbsp;</div></li><li><div>  $location_change_updated = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $what_about_the_visitor_location_changed = wpsc_get_visitor_meta( $visitor_id, 'location_attributes_changed', true );&nbsp;</div></li><li><div>  if ( ! $what_about_the_visitor_location_changed ) {&nbsp;</div></li><li><div>      $what_about_the_visitor_location_changed = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! array_key_exists( $meta_key, $what_about_the_visitor_location_changed ) ) {&nbsp;</div></li><li><div>      $what_about_the_visitor_location_changed[$meta_key] = $meta_value;&nbsp;</div></li><li><div>      wpsc_update_visitor_meta( $visitor_id, 'location_attributes_changed', $what_about_the_visitor_location_changed );&nbsp;</div></li><li><div>      $location_change_updated = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $location_change_updated;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * find out what has changed with visitor location</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment">* @access private</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @param int   $visitor_id the visitor/customer unique id</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @return array          key value pairs, the key is the unique name of the location element</span>&nbsp;</div></li><li><div><span class="comment">*                        that changed, the value is the new value assigned to the location attribute</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function _wpsc_visitor_location_what_changed( $visitor_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $visitor_id ) {&nbsp;</div></li><li><div>      $visitor_id = wpsc_get_current_customer_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $what_about_the_visitor_location_changed = wpsc_get_visitor_meta( $visitor_id, 'location_attributes_changed', true );&nbsp;</div></li><li><div>  if ( ! $what_about_the_visitor_location_changed ) {&nbsp;</div></li><li><div>      $what_about_the_visitor_location_changed = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $what_about_the_visitor_location_changed;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * clear any tracked changes in shipping location, presumable when shipping quotes are recalculated</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment">* @access private</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @param int   $visitor_id the visitor/customer unique id</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">* @return array          key value pairs, the key is the unique name of the location element</span>&nbsp;</div></li><li><div><span class="comment">*                        that changed, the value is the new value assigned to the location attribute</span>&nbsp;</div></li><li><div><span class="comment">*</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function _wpsc_visitor_location_clear_tracked_changes( $visitor_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $visitor_id ) {&nbsp;</div></li><li><div>      $visitor_id = wpsc_get_current_customer_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wpsc_delete_visitor_meta( $visitor_id, 'location_attributes_changed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>add_action( 'wpsc_before_get_shipping_method', '_wpsc_visitor_location_clear_tracked_changes', 10, 0 );&nbsp;</div></li><li><div>add_action( 'wpsc_before_shopping_cart_page', '_wpsc_visitor_location_clear_tracked_changes', 10, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * It might seem a tad verbose to attach a seperate hook to each meta item but doing it this</span>&nbsp;</div></li><li><div><span class="comment"> * way as several advantages.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *     1) If a developer wants to change the fact that changing the shipping city changes the users location</span>&nbsp;</div></li><li><div><span class="comment"> * all they have to do is remove the action.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *  2) Conversely, if someone wants to define an arbitrary attribute to cause the user's location as changing.</span>&nbsp;</div></li><li><div><span class="comment"> *  For example if the shopper was an interplanetary space traveler and they were moving to Titan, the dev</span>&nbsp;</div></li><li><div><span class="comment"> *  could add a planet field to checkout shipping information and all the heavy lifting would be taken care</span>&nbsp;</div></li><li><div><span class="comment"> *  of for them.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta_shippingregion', '_wpsc_visitor_location_is_changing', _WPSC_USER_META_HOOK_PRIORITY , 3 );&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta_shippingaddress', '_wpsc_visitor_location_is_changing', _WPSC_USER_META_HOOK_PRIORITY , 3 );&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta_shippingcity', '_wpsc_visitor_location_is_changing', _WPSC_USER_META_HOOK_PRIORITY , 3 );&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta_shippingstate', '_wpsc_visitor_location_is_changing', _WPSC_USER_META_HOOK_PRIORITY , 3 );&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta_shippingcountry', '_wpsc_visitor_location_is_changing', _WPSC_USER_META_HOOK_PRIORITY , 3 );&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta_shippingpostcode', '_wpsc_visitor_location_is_changing', _WPSC_USER_META_HOOK_PRIORITY , 3 );&nbsp;</div></li><li><div>add_action( 'wpsc_updated_visitor_meta', '_wpsc_vistor_shipping_same_as_billing_meta_update', _WPSC_USER_META_HOOK_PRIORITY, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check if the visitor location has changed, if it has inform those who have requested notification</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note that there are two actions fired when location has been found to have changed.</span>&nbsp;</div></li><li><div><span class="comment"> * The first action tells those who are listening for its broadcast that the vistor</span>&nbsp;</div></li><li><div><span class="comment"> * location has changed, which elements are changed, and that it is time to do any</span>&nbsp;</div></li><li><div><span class="comment"> * calculations that may alter any customer meta, and most importantly the</span>&nbsp;</div></li><li><div><span class="comment"> * meta that is related to a persons address.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The second action contains the parameters that have changed, and it's a signal to the code</span>&nbsp;</div></li><li><div><span class="comment"> * that it's safe to consume the customer meta.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Developers have the choice of using both hooks, or either one based on what is appropriate</span>&nbsp;</div></li><li><div><span class="comment"> * to the circumstance.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * An example where a well behaved and cooperative shipping plugin would shoose to implement both hooks</span>&nbsp;</div></li><li><div><span class="comment"> * would be a full implementation of a USPS shipping validation and indicia generation.  The first hook</span>&nbsp;</div></li><li><div><span class="comment"> * would be used to request the postal service validate and cleanse the desitination shipping address. The</span>&nbsp;</div></li><li><div><span class="comment"> * cleansed address elements would be stored into customer meta for other plugins and other part of WPEC</span>&nbsp;</div></li><li><div><span class="comment"> * to take advantage of.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The second hook would be use to generate the shipping quotes after other code that may adjust the destination</span>&nbsp;</div></li><li><div><span class="comment"> * address recorded thier inputs.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int | boolean visitor id if knowm, false or empty for the current customer</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_has_visitor_location_changed( $visitor_id = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $what_about_the_visitor_location_changed = wpsc_get_visitor_meta( $visitor_id, 'location_attributes_changed', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $what_about_the_visitor_location_changed ) && ! empty( $what_about_the_visitor_location_changed ) ) {&nbsp;</div></li><li><div>      do_action( 'wpsc_visitor_location_changing', $what_about_the_visitor_location_changed, $visitor_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $what_about_the_visitor_location_changed = wpsc_get_visitor_meta( $visitor_id, 'location_attributes_changed', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $what_about_the_visitor_location_changed ) && ! empty( $what_about_the_visitor_location_changed ) ) {&nbsp;</div></li><li><div>      do_action( 'wpsc_visitor_location_changed', $what_about_the_visitor_location_changed, $visitor_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Tries to turn an arbitrary value into a valid bool looking at the contents, including for strings like false and no, ...</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param varies $value      value to boolify</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return boolean true or false</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_make_value_into_bool( $value ) {&nbsp;</div></li><li><div>  if ( ! is_bool( $value ) ) {&nbsp;</div></li><li><div>      if ( empty( $value ) ) {&nbsp;</div></li><li><div>          $value = false;&nbsp;</div></li><li><div>      } elseif ( is_numeric( $value ) ) {&nbsp;</div></li><li><div>          $value = (bool) $value;&nbsp;</div></li><li><div>      } elseif ( is_string( $value ) ) {&nbsp;</div></li><li><div>          $value = strtolower( $value );&nbsp;</div></li><li><div>          if ( $value == 'no' || $value == 'false' ) {&nbsp;</div></li><li><div>              $value = false;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $value = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( is_array( $value ) ) {&nbsp;</div></li><li><div>          $value = ! empty( $value );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $value = (bool) $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $value;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * when visitor meta is updated we need to check if the shipping same as billing</span>&nbsp;</div></li><li><div><span class="comment"> * option is selected.  If so we need to update the corresponding meta value.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.14</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @param $meta_value varies value being stored</span>&nbsp;</div></li><li><div><span class="comment"> * @param $meta_key string name of the attribute being stored</span>&nbsp;</div></li><li><div><span class="comment"> * @param $visitor_id int id of the visitor to which the attribute applies</span>&nbsp;</div></li><li><div><span class="comment"> * @return n/a</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_vistor_shipping_same_as_billing_meta_update( $meta_value, $meta_key, $visitor_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// remove the action so we don't cause an infinite loop</span>&nbsp;</div></li><li><div>  remove_action( 'wpsc_updated_visitor_meta', '_wpsc_vistor_shipping_same_as_billing_meta_update', _WPSC_USER_META_HOOK_PRIORITY );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// if the shipping same as billing option is being checked then copy meta from billing to shipping</span>&nbsp;</div></li><li><div>  if ( $meta_key == 'shippingSameBilling' ) {&nbsp;</div></li><li><div>      $meta_value = _wpsc_make_value_into_bool( $meta_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $meta_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $checkout_names = wpsc_checkout_unique_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $checkout_names as $meta_key ) {&nbsp;</div></li><li><div>              $meta_key_starts_with_billing = strpos( $meta_key, 'billing', 0 ) === 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $meta_key_starts_with_billing ) {&nbsp;</div></li><li><div>                  $other_meta_key_name = 'shipping' . substr( $meta_key, strlen( 'billing' ) );&nbsp;</div></li><li><div>                  if ( in_array( $other_meta_key_name, $checkout_names ) ) {&nbsp;</div></li><li><div>                      $billing_meta_value = wpsc_get_customer_meta( $meta_key );&nbsp;</div></li><li><div>                      wpsc_update_visitor_meta( $visitor_id, $other_meta_key_name, $billing_meta_value );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $shipping_same_as_billing = wpsc_get_visitor_meta( $visitor_id, 'shippingSameBilling', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $shipping_same_as_billing ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta_key_starts_with_billing = strpos( $meta_key, 'billing', 0 ) === 0;&nbsp;</div></li><li><div>          $meta_key_starts_with_shipping = strpos( $meta_key, 'shipping', 0 ) === 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $meta_key_starts_with_billing ) {&nbsp;</div></li><li><div>              $checkout_names = wpsc_checkout_unique_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $other_meta_key_name = 'shipping' . substr( $meta_key, strlen( 'billing' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( in_array( $other_meta_key_name, $checkout_names ) ) {&nbsp;</div></li><li><div>                  wpsc_update_visitor_meta( $visitor_id, $other_meta_key_name, $meta_value );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } elseif ( $meta_key_starts_with_shipping ) {&nbsp;</div></li><li><div>              $checkout_names = wpsc_checkout_unique_names();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $other_meta_key_name = 'billing' . substr( $meta_key, strlen( 'shipping' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( in_array( $other_meta_key_name, $checkout_names ) ) {&nbsp;</div></li><li><div>                  wpsc_update_visitor_meta( $visitor_id, $other_meta_key_name, $meta_value );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// restore the action we removed at the start</span>&nbsp;</div></li><li><div>  add_action( 'wpsc_updated_visitor_meta', '_wpsc_vistor_shipping_same_as_billing_meta_update', _WPSC_USER_META_HOOK_PRIORITY, 3 );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>