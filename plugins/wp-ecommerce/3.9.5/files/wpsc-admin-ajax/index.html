<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.9.5" data-slug="wp-ecommerce" data-type="file" data-id="27256"><head xmlns="http://www.w3.org/1999/xhtml"><title> wpsc-admin-ajax | file | Wp Ecommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, wp-ecommerce, 3.9.5" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=fbd199f6cd84f67926e9aecbffab3112' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/wpsc-admin-ajax/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-admin-ajax%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fwpsc-admin-ajax%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-wp-ecommerce-3.9.5-file-wpsc-admin-ajax","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wpsc-admin-ajax" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to wp-ecommerce." href="http://hookr.io/plugins/wp-ecommerce/" class="plugin"><span property="name">wp-ecommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.9.5." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/" class="H_VERSION"><span property="name">3.9.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/wp-ecommerce/3.9.5/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wpsc-admin-ajax</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="4119"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/all/" title="All">All <span class="count badge">4119</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="836"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/hooks/" title="Hooks">Hooks <span class="count badge">836</span></a></li><li class="" data-id="action" data-count="253"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/actions/" title="Actions">Actions <span class="count badge">253</span></a></li><li class="" data-id="filter" data-count="583"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/filters/" title="Filters">Filters <span class="count badge">583</span></a></li><li class="" data-id="class" data-count="581"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/classes/" title="Classes">Classes <span class="count badge">581</span></a></li><li class="" data-id="constant" data-count="1044"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/constants/" title="Constants">Constants <span class="count badge">1044</span></a></li><li class="" data-id="function" data-count="1652"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/functions/" title="Functions">Functions <span class="count badge">1652</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/wp-ecommerce/3.9.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/wpsc-admin/ajax.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Verify nonce of an AJAX request</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error           WordPress Error Class</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_verify_nonce()    Verify that correct nonce was used with time limit.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $ajax_action Name of AJAX action</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Error|boolean True if nonce is valid. WP_Error if otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_verify_nonce( $ajax_action ) {&nbsp;</div></li><li><div>  <span class="comment">// nonce can be passed with name wpsc_nonce or _wpnonce</span>&nbsp;</div></li><li><div>  $nonce = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_REQUEST['nonce'] ) )&nbsp;</div></li><li><div>      $nonce = $_REQUEST['nonce'];&nbsp;</div></li><li><div>  elseif ( isset( $_REQUEST['_wpnonce'] ) )&nbsp;</div></li><li><div>      $nonce = $_REQUEST['_wpnonce'];&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      return _wpsc_error_invalid_nonce();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// validate nonce</span>&nbsp;</div></li><li><div>  if ( ! wp_verify_nonce( $nonce, 'wpsc_ajax_' . $ajax_action ) )&nbsp;</div></li><li><div>      return _wpsc_error_invalid_nonce();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>function _wpsc_error_invalid_nonce() {&nbsp;</div></li><li><div>  return new WP_Error( 'wpsc_ajax_invalid_nonce', __( 'Your session has expired. Please refresh the page and try again.', 'wpsc' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Verify AJAX callback and call it if it exists.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error   WordPress Error object</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $ajax_action Name of AJAX action</span>&nbsp;</div></li><li><div><span class="comment"> * @return WP_Error|array Array of response args if callback is valid. WP_Error if otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_fire_callback( $ajax_action ) {&nbsp;</div></li><li><div>  <span class="comment">// if callback exists, call it and output JSON response</span>&nbsp;</div></li><li><div>  $callback = &quot;_wpsc_ajax_{$ajax_action}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_callable( $callback ) )&nbsp;</div></li><li><div>      $result = call_user_func( $callback );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $result = new WP_Error( 'wpsc_invalid_ajax_callback', __( 'Invalid AJAX callback.', 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $result;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * AJAX handler for all WPEC ajax requests.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function automates nonce checking and outputs JSON response.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _wpsc_ajax_fire_callback()     Verify ajax callback if it exists</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _wpsc_ajax_verify_nonce()      Verify nonce of an ajax request</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error()                  Check whether variable is a WordPress Error.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $output    json encoded response</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_handler() {&nbsp;</div></li><li><div>  $ajax_action = str_replace( '-', '_', $_REQUEST['wpsc_action'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_callable( '_wpsc_ajax_verify_' . $ajax_action ) )&nbsp;</div></li><li><div>      $result = call_user_func( '_wpsc_ajax_verify_' . $ajax_action );&nbsp;</div></li><li><div>  else&nbsp;</div></li><li><div>      $result = _wpsc_ajax_verify_nonce( $ajax_action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_wp_error( $result ) )&nbsp;</div></li><li><div>      $result = _wpsc_ajax_fire_callback( $ajax_action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $output = array(&nbsp;</div></li><li><div>      'is_successful' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>      $output['error'] = array(&nbsp;</div></li><li><div>          'code' =&gt; $result-&gt;get_error_code(), &nbsp;</div></li><li><div>          'messages' =&gt; $result-&gt;get_error_messages(), &nbsp;</div></li><li><div>          'data' =&gt; $result-&gt;get_error_data(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $output['is_successful'] = true;&nbsp;</div></li><li><div>      $output['obj'] = $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo json_encode( $output );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_wpsc_ajax', '_wpsc_ajax_handler' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks if WPSC is doing ajax</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param   string  $action     req     The action we're checking</span>&nbsp;</div></li><li><div><span class="comment"> * @return  bool    True if doing ajax</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_is_doing_ajax( $action = '' ) {&nbsp;</div></li><li><div>  $ajax = defined( 'DOING_AJAX' ) && DOING_AJAX && ! empty( $_REQUEST['action'] ) && $_REQUEST['action'] == 'wpsc_ajax';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $action )&nbsp;</div></li><li><div>      $ajax = $ajax && ! empty( $_REQUEST['wpsc_action'] ) && $action == str_replace( '-', '_', $_REQUEST['wpsc_action'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $ajax;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Helper function that generates nonce for an AJAX action. Basically just a wrapper of</span>&nbsp;</div></li><li><div><span class="comment"> * wp_create_nonce() but automatically add prefix.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_create_nonce()  Creates a random one time use token</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $action AJAX action without prefix</span>&nbsp;</div></li><li><div><span class="comment"> * @return string         The generated nonce.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_create_ajax_nonce( $ajax_action ) {&nbsp;</div></li><li><div>  return wp_create_nonce( &quot;wpsc_ajax_{$ajax_action}&quot; );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add new variation set via AJAX.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * If the variation set name is the same as an existing variation set, </span>&nbsp;</div></li><li><div><span class="comment"> * the children variant terms will be added inside that existing set.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.8</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses term_exists()                      Returns true if term exists</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_term()                         Gets all term data by term_id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_term()                   Inserts a term to the WordPress database</span>&nbsp;</div></li><li><div><span class="comment"> * @uses is_wp_error()                      Checks whether variable is a WordPress error</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error                           WordPress Error class</span>&nbsp;</div></li><li><div><span class="comment"> * @uses clean_term_cache()                 Will remove all of the term ids from the cache.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_option()                    Deletes option from the database</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_cache_set()                     Saves the data to the cache.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _get_term_hierarchy()              Retrieves children of taxonomy as Term IDs.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_terms_checklist()               Output an unordered list of checkbox &lt;input&gt; elements labelled</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Walker_Variation_Checklist    Walker variation checklist</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Response args</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_add_variation_set() {&nbsp;</div></li><li><div>  $new_variation_set = $_POST['variation_set'];&nbsp;</div></li><li><div>  $variants = preg_split( '/\s*, \s*/', $_POST['variants'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parent_term_exists = term_exists( $new_variation_set, 'wpsc-variation' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// only use an existing parent ID if the term is not a child term</span>&nbsp;</div></li><li><div>  if ( $parent_term_exists ) {&nbsp;</div></li><li><div>      $parent_term = get_term( $parent_term_exists['term_id'], 'wpsc-variation' );&nbsp;</div></li><li><div>      if ( $parent_term-&gt;parent == '0' )&nbsp;</div></li><li><div>          $variation_set_id = $parent_term_exists['term_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $variation_set_id ) ) {&nbsp;</div></li><li><div>      $results = wp_insert_term( apply_filters( 'wpsc_new_variation_set', $new_variation_set ), 'wpsc-variation' );&nbsp;</div></li><li><div>      if ( is_wp_error( $results ) )&nbsp;</div></li><li><div>          return $results;&nbsp;</div></li><li><div>      $variation_set_id = $results['term_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $variation_set_id ) )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_invalid_variation_id', __( 'Cannot retrieve the variation set in order to proceed.', 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $variants as $variant ) {&nbsp;</div></li><li><div>      $results = wp_insert_term( apply_filters( 'wpsc_new_variant', $variant, $variation_set_id ), 'wpsc-variation', array( 'parent' =&gt; $variation_set_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $results ) )&nbsp;</div></li><li><div>          return $results;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $inserted_variants[] = $results['term_id'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once( 'includes/walker-variation-checklist.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! version_compare( $GLOBALS['wp_version'], '3.8.3', '&gt;' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** --- DIRTY HACK START --- */</span>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      There's a bug with term cache in WordPress core. See http://core.trac.wordpress.org/ticket/14485. Fixed in 3.9.</span>&nbsp;</div></li><li><div><span class="comment">      The next 3 lines will delete children term cache for wpsc-variation.</span>&nbsp;</div></li><li><div><span class="comment">      Without this hack, the new child variations won't be displayed on &quot;Variations&quot; page and</span>&nbsp;</div></li><li><div><span class="comment">      also won't be displayed in wp_terms_checklist() call below.</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>      clean_term_cache( $variation_set_id, 'wpsc-variation' );&nbsp;</div></li><li><div>      delete_option('wpsc-variation_children');&nbsp;</div></li><li><div>      wp_cache_set( 'last_changed', 1, 'terms' );&nbsp;</div></li><li><div>      _get_term_hierarchy('wpsc-variation');&nbsp;</div></li><li><div>      <span class="comment">/** --- DIRTY HACK END --- */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_terms_checklist( (int) $_POST['post_id'], array(&nbsp;</div></li><li><div>      'taxonomy' =&gt; 'wpsc-variation', &nbsp;</div></li><li><div>      'descendants_and_self' =&gt; $variation_set_id, &nbsp;</div></li><li><div>      'walker' =&gt; new WPSC_Walker_Variation_Checklist( $inserted_variants ), &nbsp;</div></li><li><div>      'checked_ontop' =&gt; false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $content = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array(&nbsp;</div></li><li><div>      'variation_set_id' =&gt; $variation_set_id, &nbsp;</div></li><li><div>      'inserted_variants' =&gt; $inserted_variants, &nbsp;</div></li><li><div>      'content' =&gt; $content, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Display gateway settings form via AJAX</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Tab_Gateway</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Tab_Gateway::display_payment_gateway_settings_form()     Displays payment gateway form</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Response args</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_payment_gateway_settings_form() {&nbsp;</div></li><li><div>  require_once( 'settings-page.php' );&nbsp;</div></li><li><div>  require_once( 'includes/settings-tabs/gateway.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $tab = new WPSC_Settings_Tab_Gateway();&nbsp;</div></li><li><div>  $tab-&gt;display_payment_gateway_settings_form();&nbsp;</div></li><li><div>  $return['content'] = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Display shipping module settings form via AJAX</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Table_Shipping</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Table_Shipping::display_shipping_module_settings_form()  Displays shipping module form</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $return    Response args</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_shipping_module_settings_form() {&nbsp;</div></li><li><div>  require_once( 'settings-page.php' );&nbsp;</div></li><li><div>  require_once( 'includes/settings-tabs/shipping.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $tab = new WPSC_Settings_Tab_Shipping();&nbsp;</div></li><li><div>  $tab-&gt;display_shipping_module_settings_form();&nbsp;</div></li><li><div>  $return['content'] = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Display settings tab via AJAX</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Page</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Page::display_current_tab()  Shows current tab of settings page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $return    Response args</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_navigate_settings_tab() {&nbsp;</div></li><li><div>  require_once( 'settings-page.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $settings_page = new WPSC_Settings_Page( $_POST['tab'] );&nbsp;</div></li><li><div>  $settings_page-&gt;display_current_tab();&nbsp;</div></li><li><div>  $return['content'] = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Display base region list in Store Settings -&gt; General</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Tab_General</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Settings_Tab_General::display_region_drop_down()  Shows region dropdown</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array    $return     Response args</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_display_region_list() {&nbsp;</div></li><li><div>  require_once( 'settings-page.php' );&nbsp;</div></li><li><div>  require_once( 'includes/settings-tabs/general.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array();&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $tab = new WPSC_Settings_Tab_General();&nbsp;</div></li><li><div>  $tab-&gt;display_region_drop_down();&nbsp;</div></li><li><div>  $return['content'] = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save tracking ID of a sales log.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error   WordPress Error class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error   $return     Response args if successful, WP_Error if otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_purchase_log_save_tracking_id() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = $wpdb-&gt;update(&nbsp;</div></li><li><div>      WPSC_TABLE_PURCHASE_LOGS, &nbsp;</div></li><li><div>      array(&nbsp;</div></li><li><div>          'track_id' =&gt; $_POST['value']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      array(&nbsp;</div></li><li><div>          'id' =&gt; $_POST['log_id']&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      '%s', &nbsp;</div></li><li><div>      '%d'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $result )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_save_tracking_id', __( &quot;Couldn't save tracking ID of the transaction. Please try again.&quot;, 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array(&nbsp;</div></li><li><div>      'rows_affected' =&gt; $result, &nbsp;</div></li><li><div>      'id' =&gt; $_POST['log_id'], &nbsp;</div></li><li><div>      'track_id' =&gt; $_POST['value'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send sales log tracking email via AJAX</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses $wpdb              WordPress database object for queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses get_option()       Gets option from DB given key</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_filter()       Calls 'wp_mail_from' which can replace the from email address</span>&nbsp;</div></li><li><div><span class="comment"> * @uses add_filter()       Calls 'wp_mail_from_name' allows replacement of the from name on WordPress emails</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_mail()          All the emailses in WordPress are sent through this function</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error           WordPress Error class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error   $return     Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_purchase_log_send_tracking_email() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $id = absint( $_POST['log_id'] );&nbsp;</div></li><li><div>  $sql = $wpdb-&gt;prepare( &quot;SELECT `track_id` FROM &quot; . WPSC_TABLE_PURCHASE_LOGS . &quot; WHERE `id`=%d LIMIT 1&quot;, $id );&nbsp;</div></li><li><div>  $trackingid = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = get_option( 'wpsc_trackingid_message' );&nbsp;</div></li><li><div>  $message = str_replace( '%trackid%', $trackingid, $message );&nbsp;</div></li><li><div>  $message = str_replace( '%shop_name%', get_option( 'blogname' ), $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $email = wpsc_get_buyers_email( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $subject = get_option( 'wpsc_trackingid_subject' );&nbsp;</div></li><li><div>  $subject = str_replace( '%shop_name%', get_option( 'blogname' ), $subject );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_filter( 'wp_mail_from', 'wpsc_replace_reply_address', 0 );&nbsp;</div></li><li><div>  add_filter( 'wp_mail_from_name', 'wpsc_replace_reply_name', 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = wp_mail( $email, $subject, $message);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $result )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_send_tracking_email', __( &quot;Couldn't send tracking email. Please try again.&quot;, 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array(&nbsp;</div></li><li><div>      'id' =&gt; $id, &nbsp;</div></li><li><div>      'tracking_id' =&gt; $trackingid, &nbsp;</div></li><li><div>      'subject' =&gt; $subject, &nbsp;</div></li><li><div>      'message' =&gt; $message, &nbsp;</div></li><li><div>      'email' =&gt; $email&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Do purchase log action link via AJAX</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since   3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return  array|WP_Error  $return  Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_purchase_log_action_link() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $_POST['log_id'] ) && isset( $_POST['purchase_log_action_link'] ) && isset( $_POST['purchase_log_action_nonce'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $log_id = absint( $_POST['log_id'] );&nbsp;</div></li><li><div>      $purchase_log_action_link = sanitize_key( $_POST['purchase_log_action_link'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Verify action nonce</span>&nbsp;</div></li><li><div>      if ( wp_verify_nonce( $_POST['purchase_log_action_nonce'], 'wpsc_purchase_log_action_ajax_' . $purchase_log_action_link ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Expected to receive success = true by default, or false on error.</span>&nbsp;</div></li><li><div>          $return = apply_filters( 'wpsc_purchase_log_action_ajax-' . $purchase_log_action_link, array( 'success' =&gt; null ), $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $return = _wpsc_error_invalid_nonce();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_wp_error( $return ) ) {&nbsp;</div></li><li><div>          $return['log_id'] = $log_id;&nbsp;</div></li><li><div>          $return['purchase_log_action_link'] = $purchase_log_action_link;&nbsp;</div></li><li><div>          $return['success'] = isset( $return['success'] ) ? (bool) $return['success'] : null;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return new WP_Error( 'wpsc_ajax_invalid_purchase_log_action', __( 'Purchase log action failed.', 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle AJAX clear downloads lock purchase log action</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The _wpsc_ajax_purchase_log_action_link() function which triggers this function is nonce</span>&nbsp;</div></li><li><div><span class="comment"> * and capability checked in _wpsc_ajax_handler().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since   3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array  $response  AJAX response.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int    $log_id    Purchase log ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_purchase_log_action_ajax_downloads_lock( $response, $log_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $response['success'] = wpsc_purchlog_clear_download_items( $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $response;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpsc_purchase_log_action_ajax-downloads_lock', 'wpsc_purchase_log_action_ajax_downloads_lock', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Handle AJAX email receipt purchase log action</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The _wpsc_ajax_purchase_log_action_link() function which triggers this function is nonce</span>&nbsp;</div></li><li><div><span class="comment"> * and capability checked in _wpsc_ajax_handler().</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since   3.9.0</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array  $response  AJAX response.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int    $log_id    Purchase log ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_purchase_log_action_ajax_email_receipt( $response, $log_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $response['success'] = wpsc_purchlog_resend_email( $log_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $response;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpsc_purchase_log_action_ajax-email_receipt', 'wpsc_purchase_log_action_ajax_email_receipt', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete an attached downloadable file via AJAX.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _wpsc_delete_file()    Deletes files associated with a product</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error               WordPress error class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error   $return     Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_delete_file() {&nbsp;</div></li><li><div>  $product_id = absint( $_REQUEST['product_id'] );&nbsp;</div></li><li><div>  $file_name = basename( $_REQUEST['file_name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $result = _wpsc_delete_file( $product_id, $file_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $result )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_delete_file', __( &quot;Couldn't delete the file. Please try again.&quot;, 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array(&nbsp;</div></li><li><div>      'product_id' =&gt; $product_id, &nbsp;</div></li><li><div>      'file_name' =&gt; $file_name, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Delete a product meta via AJAX</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_meta()      Deletes metadata by meta id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error           WordPress error class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return  array|WP_Error  $return     Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_remove_product_meta() {&nbsp;</div></li><li><div>  $meta_id = (int) $_POST['meta_id'];&nbsp;</div></li><li><div>  if ( ! delete_meta( $meta_id ) )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_delete_product_meta', __( &quot;Couldn't delete product meta. Please try again.&quot;, 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 'meta_id' =&gt; $meta_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Modify a purchase log's status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_purchlog_edit_status()                    Edits purchase log status</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error                                       WordPress Error class</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Purchase_Log_List_Table</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Purchase_Log_List_Table::prepare_items()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Purchase_Log_List_Table::views()</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Purchase_Log_List_Table::display_tablenav()   @todo docs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error   $return     Response args if successful, WP_Error if otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_change_purchase_log_status() {&nbsp;</div></li><li><div>  $result = wpsc_purchlog_edit_status( $_POST['id'], $_POST['new_status'] );&nbsp;</div></li><li><div>  if ( ! $result )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_edit_purchase_log_status', __( &quot;Couldn't modify purchase log's status. Please try again.&quot;, 'wpsc' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args['screen'] = 'dashboard_page_wpsc-sales-logs';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  require_once( WPSC_FILE_PATH . '/wpsc-admin/includes/purchase-log-list-table-class.php' );&nbsp;</div></li><li><div>  $purchaselog_table = new WPSC_Purchase_Log_List_Table( $args );&nbsp;</div></li><li><div>  $purchaselog_table-&gt;prepare_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $purchaselog_table-&gt;views();&nbsp;</div></li><li><div>  $views = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $purchaselog_table-&gt;display_tablenav( 'top' );&nbsp;</div></li><li><div>  $tablenav_top = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  $purchaselog_table-&gt;display_tablenav( 'bottom' );&nbsp;</div></li><li><div>  $tablenav_bottom = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = array(&nbsp;</div></li><li><div>      'id' =&gt; $_POST['id'], &nbsp;</div></li><li><div>      'new_status' =&gt; $_POST['new_status'], &nbsp;</div></li><li><div>      'views' =&gt; $views, &nbsp;</div></li><li><div>      'tablenav_top' =&gt; $tablenav_top, &nbsp;</div></li><li><div>      'tablenav_bottom' =&gt; $tablenav_bottom, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save product ordering after drag-and-drop sorting</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses $wpdb              WordPress database object for use in queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_update_post()   Updates post based on passed $args. Needs a post_id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error           WordPress Error class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_save_product_order() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $products = array( );&nbsp;</div></li><li><div>  foreach ( $_POST['post'] as $product ) {&nbsp;</div></li><li><div>      $products[] = (int) str_replace( 'post-', '', $product );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $failed = array();&nbsp;</div></li><li><div>  foreach ( $products as $order =&gt; $product_id ) {&nbsp;</div></li><li><div>      $result = wp_update_post( array(&nbsp;</div></li><li><div>          'ID' =&gt; $product_id, &nbsp;</div></li><li><div>          'menu_order' =&gt; $order, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $result )&nbsp;</div></li><li><div>          $failed[] = $product_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate data before exposing to action</span>&nbsp;</div></li><li><div>  $category = isset( $_POST['category_id'] ) ? get_term_by( 'slug', $_POST['category_id'], 'wpsc_product_category' ) : false;&nbsp;</div></li><li><div>  do_action( 'wpsc_save_product_order', $products, $category );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $failed ) ) {&nbsp;</div></li><li><div>      $error_data = array(&nbsp;</div></li><li><div>          'failed_ids' =&gt; $failed, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_save_product_sort_order', __( &quot;Couldn't save the products' sort order. Please try again.&quot;, 'wpsc' ), $error_data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'ids' =&gt; $products, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save Category Product Order</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Note that this uses the 'term_order' field in the 'term_relationships' table to store</span>&nbsp;</div></li><li><div><span class="comment"> * the order. Although this column presently seems to be unused by WordPress, the intention</span>&nbsp;</div></li><li><div><span class="comment"> * is it should be used to store the order of terms associates to a post, not the order</span>&nbsp;</div></li><li><div><span class="comment"> * of posts as we are doing. This shouldn't be an issue for WPEC unless WordPress adds a UI</span>&nbsp;</div></li><li><div><span class="comment"> * for this. More info at http://core.trac.wordpress.org/ticket/9547</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses $wpdb   WordPress database object used for queries</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_save_category_product_order( $products, $category ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only save category product order if in category</span>&nbsp;</div></li><li><div>  if ( ! $category )&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Save product order in term_relationships table</span>&nbsp;</div></li><li><div>  foreach ( $products as $order =&gt; $product_id ) {&nbsp;</div></li><li><div>      $wpdb-&gt;update( $wpdb-&gt;term_relationships, &nbsp;</div></li><li><div>          array( 'term_order' =&gt; $order ), &nbsp;</div></li><li><div>          array( 'object_id' =&gt; $product_id, 'term_taxonomy_id' =&gt; $category-&gt;term_taxonomy_id ), &nbsp;</div></li><li><div>          array( '%d' ), &nbsp;</div></li><li><div>          array( '%d', '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wpsc_save_product_order', '_wpsc_save_category_product_order', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update Checkout fields order</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses $wpdb      WordPress database object used for queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WP_Error   WordPress error class</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error Response args or WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_update_checkout_fields_order() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $checkout_fields = $_REQUEST['sort_order'];&nbsp;</div></li><li><div>  $order = 1;&nbsp;</div></li><li><div>  $failed = array();&nbsp;</div></li><li><div>  $modified = array();&nbsp;</div></li><li><div>  foreach ( $checkout_fields as &$checkout_field ) {&nbsp;</div></li><li><div>      <span class="comment">// ignore new fields</span>&nbsp;</div></li><li><div>      if ( strpos( $checkout_field, 'new-field' ) === 0 )&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      $checkout_field = absint( preg_replace('/[^0-9]+/', '', $checkout_field ) );&nbsp;</div></li><li><div>      $result = $wpdb-&gt;update(&nbsp;</div></li><li><div>          WPSC_TABLE_CHECKOUT_FORMS, &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'checkout_order' =&gt; $order&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'id' =&gt; $checkout_field&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          '%d', &nbsp;</div></li><li><div>          '%d'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $order ++;&nbsp;</div></li><li><div>      if ( $result === false )&nbsp;</div></li><li><div>          $failed[] = $checkout_field;&nbsp;</div></li><li><div>      elseif ( $result &gt; 0 )&nbsp;</div></li><li><div>          $modified[] = $checkout_field;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $failed ) )&nbsp;</div></li><li><div>      return new WP_Error( 'wpsc_cannot_save_checkout_field_sort_order', __( &quot;Couldn't save checkout field sort order. Please try again.&quot;, 'wpsc' ), array( 'failed_ids' =&gt; $failed ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'modified' =&gt; $modified, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Save a downloadable file to a product</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses $wpdb                          WordPress database object for use in queries</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _wpsc_create_ajax_nonce()      Creates nonce for an ajax action</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_get_mimetype()            Returns mimetype of file</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_insert_post()               Inserts post to WordPress database</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wp_nonce_url()                 Retrieve URL with nonce added to URL query.</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_convert_bytes()           Formats bytes</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_get_extension()           Gets extension of file</span>&nbsp;</div></li><li><div><span class="comment"> * @uses esc_attr()                     Escapes HTML attributes</span>&nbsp;</div></li><li><div><span class="comment"> * @uses _x()                           Retrieve translated string with gettext context</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error Response args if successful, WP_Error if otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_upload_product_file() {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  $product_id = absint( $_POST[&quot;product_id&quot;] );&nbsp;</div></li><li><div>  $output = '';&nbsp;</div></li><li><div>  $delete_nonce = _wpsc_create_ajax_nonce( 'delete_file' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $_POST[&quot;select_product_file&quot;] as $selected_file ) {&nbsp;</div></li><li><div>      <span class="comment">// if we already use this file, there is no point doing anything more.</span>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare( &quot;SELECT * FROM $wpdb-&gt;posts WHERE post_type = 'wpsc-product-file' AND post_title = %s&quot;, $selected_file ); <span class="comment">// TODO it's safer to select by post ID, in that case we will use get_posts()</span>&nbsp;</div></li><li><div>      $file_post_data = $wpdb-&gt;get_row( $sql, ARRAY_A );&nbsp;</div></li><li><div>      $selected_file_path = WPSC_FILE_DIR . basename( $selected_file );&nbsp;</div></li><li><div>      $file_url = WPSC_FILE_URL . basename( $selected_file );&nbsp;</div></li><li><div>      $file_size = filesize( $selected_file_path );&nbsp;</div></li><li><div>      if ( empty( $file_post_data ) ) {&nbsp;</div></li><li><div>          $type = wpsc_get_mimetype( $selected_file_path );&nbsp;</div></li><li><div>          $attachment = array(&nbsp;</div></li><li><div>              'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>              'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>              'post_title' =&gt; $selected_file, &nbsp;</div></li><li><div>              'post_content' =&gt; '', &nbsp;</div></li><li><div>              'post_type' =&gt; &quot;wpsc-product-file&quot;, &nbsp;</div></li><li><div>              'post_status' =&gt; 'inherit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $id = wp_insert_post( $attachment );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// already attached</span>&nbsp;</div></li><li><div>          if ( $file_post_data['post_parent'] == $product_id )&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          $type = $file_post_data[&quot;post_mime_type&quot;];&nbsp;</div></li><li><div>          $url = $file_post_data[&quot;guid&quot;];&nbsp;</div></li><li><div>          $title = $file_post_data[&quot;post_title&quot;];&nbsp;</div></li><li><div>          $content = $file_post_data[&quot;post_content&quot;];&nbsp;</div></li><li><div>          <span class="comment">// Construct the attachment</span>&nbsp;</div></li><li><div>          $attachment = array(&nbsp;</div></li><li><div>              'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>              'guid' =&gt; $url, &nbsp;</div></li><li><div>              'post_parent' =&gt; absint( $product_id ), &nbsp;</div></li><li><div>              'post_title' =&gt; $title, &nbsp;</div></li><li><div>              'post_content' =&gt; $content, &nbsp;</div></li><li><div>              'post_type' =&gt; &quot;wpsc-product-file&quot;, &nbsp;</div></li><li><div>              'post_status' =&gt; 'inherit'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          <span class="comment">// Save the data</span>&nbsp;</div></li><li><div>          $id = wp_insert_post( $attachment );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $deletion_url = wp_nonce_url( &quot;admin.php?wpsc_admin_action=delete_file&amp;file_name={$attachment['post_title']}&amp;product_id={$product_id}&quot;, 'delete_file_' . $attachment['post_title'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $output .= '&lt;tr class=&quot;wpsc_product_download_row&quot;&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;td style=&quot;padding-right: 30px;&quot;&gt;' . $attachment['post_title'] . '&lt;/td&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;td&gt;' . wpsc_convert_byte( $file_size ) . '&lt;/td&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;td&gt;.' . wpsc_get_extension( $attachment['post_title'] ) . '&lt;/td&gt;';&nbsp;</div></li><li><div>      $output .= &quot;&lt;td&gt;&lt;a data-file-name='&quot; . esc_attr( $attachment['post_title'] ) . &quot;' data-product-id='&quot; . esc_attr( $product_id ) . &quot;' data-nonce='&quot; . esc_attr( $delete_nonce ) . &quot;' class='file_delete_button' href='{$deletion_url}' &gt;&quot; . _x( 'Delete', 'Digital Download UI row', 'wpsc' ) . &quot;&lt;/a&gt;&lt;/td&gt;&quot;;&nbsp;</div></li><li><div>      $output .= '&lt;td&gt;&lt;a href=' .$file_url .'&gt;' . _x( 'Download', 'Digital Download UI row', 'wpsc' ) . '&lt;/a&gt;&lt;/td&gt;';&nbsp;</div></li><li><div>      $output .= '&lt;/tr&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'content' =&gt; $output, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generate variations</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_update_variations()       Updates product variations given</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_admin_product_listing()   DEPRECATED</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_update_variations() {&nbsp;</div></li><li><div>  $product_id = absint( $_REQUEST[&quot;product_id&quot;] );&nbsp;</div></li><li><div>  wpsc_update_variations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ob_start();&nbsp;</div></li><li><div>  wpsc_admin_product_listing( $product_id );&nbsp;</div></li><li><div>  $content = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array( 'content' =&gt; $content );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Display the shortcode generator.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_action_tinymce_window() {&nbsp;</div></li><li><div>  require_once( WPSC_CORE_JS_PATH . '/tinymce3/window.php' );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_wpsc_tinymce_window', '_wpsc_action_tinymce_window' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add tax rate</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.8.9</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpec_taxes_controller                                                  Contains all the logic to communicate with the taxes system</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpec_taxes_controller::wpec_taxes::wpec_taxes_get_regions()            Gets tax regions based on input country code</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpec_taxes_controller::wpec_taxes_build_select_options()               Returns HTML formatted options from input array</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpec_taxes_controller::wpec_taxes_build_form()                         Builds the tax rate form</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpec_taxes_controller::wpec_taxes::wpec_taxes_get_band_from_index()    Retrieves tax band for given name</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|WP_Error Response args if successful, WP_Error if otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_add_tax_rate() {&nbsp;</div></li><li><div>  <span class="comment">//include taxes controller</span>&nbsp;</div></li><li><div>  $wpec_taxes_controller = new wpec_taxes_controller;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $_REQUEST['wpec_taxes_action'] ) {&nbsp;</div></li><li><div>      case 'wpec_taxes_get_regions':&nbsp;</div></li><li><div>          $regions = $wpec_taxes_controller-&gt;wpec_taxes-&gt;wpec_taxes_get_regions( $_REQUEST['country_code'] );&nbsp;</div></li><li><div>          $key = $_REQUEST['current_key'];&nbsp;</div></li><li><div>          $type = $_REQUEST['taxes_type'];&nbsp;</div></li><li><div>          $default_option = array( 'region_code' =&gt; 'all-markets', 'name' =&gt; 'All Markets' );&nbsp;</div></li><li><div>          $select_settings = array(&nbsp;</div></li><li><div>              'id' =&gt; &quot;{$type}-region-{$key}&quot;, &nbsp;</div></li><li><div>              'name' =&gt; &quot;wpsc_options[wpec_taxes_{$type}][{$key}][region_code]&quot;, &nbsp;</div></li><li><div>              'class' =&gt; 'wpsc-taxes-region-drop-down'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $returnable = $wpec_taxes_controller-&gt;wpec_taxes_build_select_options( $regions, 'region_code', 'name', $default_option, $select_settings );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>  }<span class="comment">// switch</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array(&nbsp;</div></li><li><div>      'content' =&gt; $returnable, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Displays the WPSC product variations table</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses check_admin_referrer()                     Makes sure user was referred from another admin page</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Product_Variations_Page               The WPSC Product variations class</span>&nbsp;</div></li><li><div><span class="comment"> * @uses WPSC_Product_Variations_Page::display()    Displays the product variations page</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wpsc_product_variations_table() {&nbsp;</div></li><li><div>  check_admin_referer( 'wpsc_product_variations_table' );&nbsp;</div></li><li><div>  set_current_screen( 'wpsc-product' );&nbsp;</div></li><li><div>  require_once( WPSC_FILE_PATH . '/wpsc-admin/includes/product-variations-page.class.php' );&nbsp;</div></li><li><div>  $page = new WPSC_Product_Variations_Page();&nbsp;</div></li><li><div>  $page-&gt;display();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_wpsc_product_variations_table', 'wpsc_product_variations_table' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses current_user_can()             Checks user capabilities given string</span>&nbsp;</div></li><li><div><span class="comment"> * @uses delete_post_thumbnail()        Deletes post thumbnail given thumbnail id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses set_post_thumbnail()           Sets post thumbnail given post_id and thumbnail_id</span>&nbsp;</div></li><li><div><span class="comment"> * @uses wpsc_the_product_thumbnail()   Returns URL to the product thumbnail</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array    $response           Includes the thumbnail URL and success bool value</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function _wpsc_ajax_set_variation_product_thumbnail() {&nbsp;</div></li><li><div>  $response = array(&nbsp;</div></li><li><div>      'success' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_ID = intval( $_POST['post_id'] );&nbsp;</div></li><li><div>  if ( current_user_can( 'edit_post', $post_ID ) ) {&nbsp;</div></li><li><div>      $thumbnail_id = intval( $_POST['thumbnail_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $thumbnail_id == '-1' )&nbsp;</div></li><li><div>          delete_post_thumbnail( $post_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      set_post_thumbnail( $post_ID, $thumbnail_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $thumbnail = wpsc_the_product_thumbnail( 50, 50, $post_ID, '' );&nbsp;</div></li><li><div>      if ( ! $thumbnail )&nbsp;</div></li><li><div>          $thumbnail = WPSC_CORE_IMAGES_URL . '/no-image-uploaded.gif';&nbsp;</div></li><li><div>      $response['src'] = $thumbnail;&nbsp;</div></li><li><div>      $response['success'] = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  echo json_encode( $response );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_wpsc_set_variation_product_thumbnail', '_wpsc_ajax_set_variation_product_thumbnail' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span><a href="http://wpecommerce.org/">WP eCommerce</a></li><li><span></span>3.9.5</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>