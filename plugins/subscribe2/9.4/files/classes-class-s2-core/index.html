<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="9.4" data-slug="subscribe2" data-type="file" data-id="7364"><head xmlns="http://www.w3.org/1999/xhtml"><title> classes-class-s2-core | file | Subscribe2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, subscribe2, 9.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=38aa0707e5ae71983efccaa1ce83c6d5' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/classes-class-s2-core/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-class-s2-core%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fclasses-class-s2-core%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-subscribe2-9.4-file-classes-class-s2-core","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="classes-class-s2-core" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to subscribe2." href="http://hookr.io/plugins/subscribe2/" class="plugin"><span property="name">subscribe2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 9.4." href="http://hookr.io/plugins/subscribe2/9.4/" class="H_VERSION"><span property="name">9.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/subscribe2/9.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">classes-class-s2-core</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="74"><a href="http://hookr.io/plugins/subscribe2/9.4/all/" title="All">All <span class="count badge">74</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/subscribe2/9.4/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="59"><a href="http://hookr.io/plugins/subscribe2/9.4/hooks/" title="Hooks">Hooks <span class="count badge">59</span></a></li><li class="" data-id="action" data-count="2"><a href="http://hookr.io/plugins/subscribe2/9.4/actions/" title="Actions">Actions <span class="count badge">2</span></a></li><li class="" data-id="filter" data-count="57"><a href="http://hookr.io/plugins/subscribe2/9.4/filters/" title="Filters">Filters <span class="count badge">57</span></a></li><li class="" data-id="class" data-count="8"><a href="http://hookr.io/plugins/subscribe2/9.4/classes/" title="Classes">Classes <span class="count badge">8</span></a></li><li class="" data-id="constant" data-count="6"><a href="http://hookr.io/plugins/subscribe2/9.4/constants/" title="Constants">Constants <span class="count badge">6</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/subscribe2/9.4/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/subscribe2/9.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/classes/class-s2-core.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>class s2class {&nbsp;</div></li><li><div><span class="comment">// variables and constructor are declared at the end</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Load translations</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function load_translations() {&nbsp;</div></li><li><div>      load_plugin_textdomain('subscribe2', false, S2DIR);&nbsp;</div></li><li><div>      load_plugin_textdomain('subscribe2', false, S2DIR . &quot;languages/&quot;);&nbsp;</div></li><li><div>      $mofile = WP_LANG_DIR . '/subscribe2-' . apply_filters('plugin_locale', get_locale(), 'subscribe2') . '.mo';&nbsp;</div></li><li><div>      load_textdomain('subscribe2', $mofile);&nbsp;</div></li><li><div>  } <span class="comment">// end load_translations()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== Install, upgrade, reset ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Install our table</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function install() {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// load our translations</span> and strings</span></span></span>&nbsp;</div></li><li><div>      $this-&gt;load_translations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// include upgrade-functions for maybe_create_table;</span>&nbsp;</div></li><li><div>      if ( !function_exists('maybe_create_table') ) {&nbsp;</div></li><li><div>          require_once(ABSPATH . 'wp-admin/install-helper.php');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $date = date('Y-m-d');&nbsp;</div></li><li><div>      $sql = &quot;CREATE TABLE $this-&gt;public (&nbsp;</div></li><li><div>          id int(11) NOT NULL auto_increment, &nbsp;</div></li><li><div>          email varchar(64) NOT NULL default '', &nbsp;</div></li><li><div>          active tinyint(1) default 0, &nbsp;</div></li><li><div>          date DATE default '$date' NOT NULL, &nbsp;</div></li><li><div>          time TIME DEFAULT '00:00:00' NOT NULL, &nbsp;</div></li><li><div>          ip char(64) NOT NULL default 'admin', &nbsp;</div></li><li><div>          conf_date DATE, &nbsp;</div></li><li><div>          conf_time TIME, &nbsp;</div></li><li><div>          conf_ip char(64), &nbsp;</div></li><li><div>          PRIMARY KEY (id) )&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// create the table, as needed</span>&nbsp;</div></li><li><div>      maybe_create_table($this-&gt;public, $sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// create table entries for registered users</span>&nbsp;</div></li><li><div>      $users = $this-&gt;get_all_registered('ID');&nbsp;</div></li><li><div>      if ( !empty($users) ) {&nbsp;</div></li><li><div>          foreach ( $users as $user_ID ) {&nbsp;</div></li><li><div>              $check_format = get_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), true);&nbsp;</div></li><li><div>              if ( empty($check_format) ) {&nbsp;</div></li><li><div>                  <span class="comment">// no prior settings so create them</span>&nbsp;</div></li><li><div>                  $this-&gt;register($user_ID);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// safety check if options exist and if not create them</span>&nbsp;</div></li><li><div>      if ( !is_array($this-&gt;subscribe2_options) ) {&nbsp;</div></li><li><div>          $this-&gt;reset();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end install()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Upgrade function for the database and settings</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function upgrade() {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// load our translations</span> and strings</span></span></span>&nbsp;</div></li><li><div>      $this-&gt;load_translations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      require(S2PATH . &quot;classes/class-s2-upgrade.php&quot;);&nbsp;</div></li><li><div>      global $s2_upgrade;&nbsp;</div></li><li><div>      $s2_upgrade = new s2class_upgrade;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// ensure that the options are in the database</span>&nbsp;</div></li><li><div>      require(S2PATH . &quot;include/options.php&quot;);&nbsp;</div></li><li><div>      <span class="comment">// catch older versions that didn't use serialised options</span>&nbsp;</div></li><li><div>      if ( !isset($this-&gt;subscribe2_options['version']) ) {&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '2.0';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// let's take the time to ensure that database entries exist for all registered users</span>&nbsp;</div></li><li><div>      $s2_upgrade-&gt;upgrade_core();&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '2.3', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade23();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '2.3';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '5.1', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade51();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '5.1';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '5.6', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade56();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '5.6';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '5.9', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade59();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '5.9';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '6.4', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade64();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '6.4';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '7.0', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade70();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '7.0';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '8.5', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade85();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '8.5';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '8.6', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade86();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '8.6';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '8.8', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade88();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '8.8';&nbsp;</div></li><li><div>          update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( version_compare($this-&gt;subscribe2_options['version'], '10.0', '&lt;') ) {&nbsp;</div></li><li><div>          $s2_upgrade-&gt;upgrade100();&nbsp;</div></li><li><div>          $this-&gt;subscribe2_options['version'] = '10.0';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;subscribe2_options['version'] = S2VERSION;&nbsp;</div></li><li><div>      update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  } <span class="comment">// end upgrade()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Reset our options</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function reset() {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// load our translations</span> and strings</span></span></span>&nbsp;</div></li><li><div>      $this-&gt;load_translations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      delete_option('subscribe2_options');&nbsp;</div></li><li><div>      wp_clear_scheduled_hook('s2_digest_cron');&nbsp;</div></li><li><div>      unset($this-&gt;subscribe2_options);&nbsp;</div></li><li><div>      require(S2PATH . &quot;include/options.php&quot;);&nbsp;</div></li><li><div>      $this-&gt;subscribe2_options['version'] = S2VERSION;&nbsp;</div></li><li><div>      update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>  } <span class="comment">// end reset()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== mail handling ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Performs string substitutions for subscribe2 mail tags</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function substitute($string = '') {&nbsp;</div></li><li><div>      if ( '' == $string ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $string = str_replace(&quot;{BLOGNAME}&quot;, html_entity_decode(get_option('blogname'), ENT_QUOTES), $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{BLOGLINK}&quot;, get_option('home'), $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{TITLE}&quot;, stripslashes($this-&gt;post_title), $string);&nbsp;</div></li><li><div>      $link = &quot;&lt;a href=\&quot;&quot; . $this-&gt;get_tracking_link($this-&gt;permalink) . &quot;\&quot;&gt;&quot; . $this-&gt;get_tracking_link($this-&gt;permalink) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      $string = str_replace(&quot;{PERMALINK}&quot;, $link, $string);&nbsp;</div></li><li><div>      if ( strstr($string, &quot;{TINYLINK}&quot;) ) {&nbsp;</div></li><li><div>          $tinylink = file_get_contents('http:<span class="comment">//tinyurl.com/api-create.php?url=' . urlencode($this-&gt;get_tracking_link($this-&gt;permalink)));</span>&nbsp;</div></li><li><div>          if ( $tinylink !== 'Error' && $tinylink != false ) {&nbsp;</div></li><li><div>              $tlink = &quot;&lt;a href=\&quot;&quot; . $tinylink . &quot;\&quot;&gt;&quot; . $tinylink . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>              $string = str_replace(&quot;{TINYLINK}&quot;, $tlink, $string);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $string = str_replace(&quot;{TINYLINK}&quot;, $link, $string);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $string = str_replace(&quot;{DATE}&quot;, $this-&gt;post_date, $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{TIME}&quot;, $this-&gt;post_time, $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{MYNAME}&quot;, stripslashes($this-&gt;myname), $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{EMAIL}&quot;, $this-&gt;myemail, $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{AUTHORNAME}&quot;, stripslashes($this-&gt;authorname), $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{CATS}&quot;, $this-&gt;post_cat_names, $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{TAGS}&quot;, $this-&gt;post_tag_names, $string);&nbsp;</div></li><li><div>      $string = str_replace(&quot;{COUNT}&quot;, $this-&gt;post_count, $string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters('s2_custom_keywords', $string);&nbsp;</div></li><li><div>  } <span class="comment">// end substitute()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Delivers email to recipients in HTML or plaintext</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function mail($recipients = array(), $subject = '', $message = '', $type = 'text', $attachments = array()) {&nbsp;</div></li><li><div>      if ( empty($recipients) || '' == $message ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Replace any escaped html symbols in subject then apply filter</span>&nbsp;</div></li><li><div>      $subject = strip_tags(html_entity_decode($subject, ENT_QUOTES));&nbsp;</div></li><li><div>      $subject = apply_filters('s2_email_subject', $subject);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'html' == $type ) {&nbsp;</div></li><li><div>          $headers = $this-&gt;headers('html', $attachments);&nbsp;</div></li><li><div>          if ( 'yes' == $this-&gt;subscribe2_options['stylesheet'] ) {&nbsp;</div></li><li><div>              $mailtext = apply_filters('s2_html_email', &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;&quot; . $subject . &quot;&lt;/title&gt;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;&quot; . get_stylesheet_uri() . &quot;\&quot; type=\&quot;text/css\&quot; media=\&quot;screen\&quot; /&gt;&lt;/head&gt;&lt;body&gt;&quot; . $message . &quot;&lt;/body&gt;&lt;/html&gt;&quot;, $subject, $message);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mailtext = apply_filters('s2_html_email', &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;&quot; . $subject . &quot;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot; . $message . &quot;&lt;/body&gt;&lt;/html&gt;&quot;, $subject, $message);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $headers = $this-&gt;headers('text', $attachments);&nbsp;</div></li><li><div>          $message = html_entity_decode($message, ENT_NOQUOTES, 'UTF-8');&nbsp;</div></li><li><div>          $message = wordwrap(strip_tags($message), $this-&gt;word_wrap, &quot;\n&quot;);&nbsp;</div></li><li><div>          $mailtext = apply_filters('s2_plain_email', $message);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Construct BCC headers for sending or send individual emails</span>&nbsp;</div></li><li><div>      $bcc = '';&nbsp;</div></li><li><div>      natcasesort($recipients);&nbsp;</div></li><li><div>      if ( function_exists('wpmq_mail') || $this-&gt;subscribe2_options['bcclimit'] == 1 || count($recipients) == 1 ) {&nbsp;</div></li><li><div>          <span class="comment">// BCCLimit is 1 so send individual emails or we only have 1 recipient</span>&nbsp;</div></li><li><div>          foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>              $recipient = trim($recipient);&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// sanity check -- make sure we have a valid email</span></span></span>&nbsp;</div></li><li><div>              if ( !is_email($recipient) || empty($recipient) ) { continue; }&nbsp;</div></li><li><div>              <span class="comment">// Use the mail queue provided we are not sending a preview</span>&nbsp;</div></li><li><div>              if ( function_exists('wpmq_mail') && !$this-&gt;preview_email ) {&nbsp;</div></li><li><div>                  @wp_mail($recipient, $subject, $mailtext, $headers, $attachments, 0);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  @wp_mail($recipient, $subject, $mailtext, $headers, $attachments);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } elseif ( $this-&gt;subscribe2_options['bcclimit'] == 0 ) {&nbsp;</div></li><li><div>          <span class="comment">// we're not using BCCLimit</span>&nbsp;</div></li><li><div>          foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>              $recipient = trim($recipient);&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// sanity check -- make sure we have a valid email</span></span></span>&nbsp;</div></li><li><div>              if ( !is_email($recipient) ) { continue; }&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// and NOT the sender's email, since they'll get a copy anyway</span></span>&nbsp;</div></li><li><div>              if ( !empty($recipient) && $this-&gt;myemail != $recipient ) {&nbsp;</div></li><li><div>                  ('' == $bcc) ? $bcc = &quot;Bcc: $recipient&quot; : $bcc .= &quot;, $recipient&quot;;&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Bcc Headers now constructed by phpmailer class</span></span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $headers .= &quot;$bcc\n&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// we're using BCCLimit</span>&nbsp;</div></li><li><div>          $count = 1;&nbsp;</div></li><li><div>          $batch = array();&nbsp;</div></li><li><div>          foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>              $recipient = trim($recipient);&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// sanity check -- make sure we have a valid email</span></span></span>&nbsp;</div></li><li><div>              if ( !is_email($recipient) ) { continue; }&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// and NOT the sender's email, since they'll get a copy anyway</span></span>&nbsp;</div></li><li><div>              if ( !empty($recipient) && $this-&gt;myemail != $recipient ) {&nbsp;</div></li><li><div>                  ('' == $bcc) ? $bcc = &quot;Bcc: $recipient&quot; : $bcc .= &quot;, $recipient&quot;;&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Bcc Headers now constructed by phpmailer class</span></span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( $this-&gt;subscribe2_options['bcclimit'] == $count ) {&nbsp;</div></li><li><div>                  $count = 0;&nbsp;</div></li><li><div>                  $batch[] = $bcc;&nbsp;</div></li><li><div>                  $bcc = '';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $count++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// add any partially completed batches to our batch array</span>&nbsp;</div></li><li><div>          if ( '' != $bcc ) {&nbsp;</div></li><li><div>              $batch[] = $bcc;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// rewind the array, just to be safe</span>&nbsp;</div></li><li><div>      reset($recipients);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// actually send mail</span>&nbsp;</div></li><li><div>      if ( isset($batch) && !empty($batch) ) {&nbsp;</div></li><li><div>          foreach ( $batch as $bcc ) {&nbsp;</div></li><li><div>                  $newheaders = $headers . &quot;$bcc\n&quot;;&nbsp;</div></li><li><div>                  $status = @wp_mail($this-&gt;myemail, $subject, $mailtext, $newheaders, $attachments);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $status = @wp_mail($this-&gt;myemail, $subject, $mailtext, $headers, $attachments);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $status;&nbsp;</div></li><li><div>  } <span class="comment">// end mail()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Construct standard set of email headers</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function headers($type = 'text', $attachments = array()) {&nbsp;</div></li><li><div>      if ( empty($this-&gt;myname) || empty($this-&gt;myemail) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['sender'] == 'blogname' ) {&nbsp;</div></li><li><div>              $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>              $this-&gt;myemail = get_option('admin_email');&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $admin = $this-&gt;get_userdata($this-&gt;subscribe2_options['sender']);&nbsp;</div></li><li><div>              $this-&gt;myname = html_entity_decode($admin-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>              $this-&gt;myemail = $admin-&gt;user_email;&nbsp;</div></li><li><div>              <span class="comment">// fail safe to ensure sender details are not empty</span>&nbsp;</div></li><li><div>              if ( empty($this-&gt;myname) ) {&nbsp;</div></li><li><div>                  $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( empty($this-&gt;myemail) ) {&nbsp;</div></li><li><div>                  <span class="comment">// Get the site domain and get rid of www.</span>&nbsp;</div></li><li><div>                  $sitename = strtolower( $_SERVER['SERVER_NAME'] );&nbsp;</div></li><li><div>                  if ( substr( $sitename, 0, 4 ) == 'www.' ) {&nbsp;</div></li><li><div>                      $sitename = substr( $sitename, 4 );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $this-&gt;myemail = 'wordpress@' . $sitename;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $char_set = get_option('blog_charset');&nbsp;</div></li><li><div>      if ( function_exists('mb_encode_mimeheader') ) {&nbsp;</div></li><li><div>          $header['From'] = mb_encode_mimeheader($this-&gt;myname, $char_set, 'Q') . &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>          $header['Reply-To'] = mb_encode_mimeheader($this-&gt;myname, $char_set, 'Q') . &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $header['From'] = $this-&gt;myname. &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>          $header['Reply-To'] = $this-&gt;myname . &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $header['Return-path'] = &quot;&lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>      $header['Precedence'] = &quot;list\nList-Id: &quot; . html_entity_decode(get_option('blogname'), ENT_QUOTES) . &quot;&quot;;&nbsp;</div></li><li><div>      if ( empty($attachments) && $type == 'html' ) {&nbsp;</div></li><li><div>          <span class="comment">// To send HTML mail, the Content-Type header must be set</span>&nbsp;</div></li><li><div>          $header['Content-Type'] = get_option('html_type') . &quot;; charset=\&quot;&quot;. $char_set . &quot;\&quot;&quot;;&nbsp;</div></li><li><div>      } elseif ( empty($attachments) && $type == 'text' ) {&nbsp;</div></li><li><div>          $header['Content-Type'] = &quot;text/plain; charset=\&quot;&quot;. $char_set . &quot;\&quot;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// apply header filter to allow on-the-fly amendments</span>&nbsp;</div></li><li><div>      $header = apply_filters('s2_email_headers', $header);&nbsp;</div></li><li><div>      <span class="comment">// collapse the headers using $key as the header name</span>&nbsp;</div></li><li><div>      foreach ( $header as $key =&gt; $value ) {&nbsp;</div></li><li><div>          $headers[$key] = $key . &quot;: &quot; . $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $headers = implode(&quot;\n&quot;, $headers);&nbsp;</div></li><li><div>      $headers .= &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $headers;&nbsp;</div></li><li><div>  } <span class="comment">// end headers()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Function to add UTM tracking details to links</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_tracking_link($link) {&nbsp;</div></li><li><div>      if ( empty($link) ) { return; }&nbsp;</div></li><li><div>      if ( !empty($this-&gt;subscribe2_options['tracking']) ) {&nbsp;</div></li><li><div>          (strpos($link, '?') &gt; 0) ? $delimiter .= '&' : $delimiter = '?';&nbsp;</div></li><li><div>          $tracking = $this-&gt;subscribe2_options['tracking'];&nbsp;</div></li><li><div>          if ( strpos($tracking, &quot;{ID}&quot;) ) {&nbsp;</div></li><li><div>              $id = url_to_postid($link);&nbsp;</div></li><li><div>              $tracking = str_replace(&quot;{ID}&quot;, $id, $tracking);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( strpos($tracking, &quot;{TITLE}&quot;) ) {&nbsp;</div></li><li><div>              $id = url_to_postid($link);&nbsp;</div></li><li><div>              $title = urlencode(htmlentities(get_the_title($id), 1));&nbsp;</div></li><li><div>              $tracking = str_replace(&quot;{TITLE}&quot;, $title, $tracking);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $link . $delimiter . $tracking;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return $link;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end get_tracking_link()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Sends an email notification of a new post</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function publish($post, $preview = '') {&nbsp;</div></li><li><div>      if ( !$post ) { return $post; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;s2_mu && !apply_filters('s2_allow_site_switching', $this-&gt;site_switching) ) {&nbsp;</div></li><li><div>          global $switched;&nbsp;</div></li><li><div>          if ( $switched ) { return; }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $preview == '' ) {&nbsp;</div></li><li><div>          <span class="comment">// we aren't sending a Preview to the current user so carry out checks</span>&nbsp;</div></li><li><div>          $s2mail = get_post_meta($post-&gt;ID, '_s2mail', true);&nbsp;</div></li><li><div>          if ( (isset($_POST['s2_meta_field']) && $_POST['s2_meta_field'] == 'no') || strtolower(trim($s2mail)) == 'no' ) { return $post; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// are we doing daily digests? If so, don't send anything now</span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['email_freq'] != 'never' ) { return $post; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// is the current post of a type that should generate a notification email?</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// uses s2_post_types filter to allow for custom post types in WP 3.0</span></span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['pages'] == 'yes' ) {&nbsp;</div></li><li><div>              $s2_post_types = array('page', 'post');&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $s2_post_types = array('post');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $s2_post_types = apply_filters('s2_post_types', $s2_post_types);&nbsp;</div></li><li><div>          if ( !in_array($post-&gt;post_type, $s2_post_types) ) {&nbsp;</div></li><li><div>              return $post;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Are we sending notifications for password protected posts?</span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['password'] == &quot;no&quot; && $post-&gt;post_password != '' ) {&nbsp;</div></li><li><div>                  return $post;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Is the post assigned to a format for which we should not be sending posts</span>&nbsp;</div></li><li><div>          $post_format = get_post_format($post-&gt;ID);&nbsp;</div></li><li><div>          $excluded_formats = explode(', ', $this-&gt;subscribe2_options['exclude_formats']);&nbsp;</div></li><li><div>          if ( $post_format !== false && in_array($post_format, $excluded_formats) ) {&nbsp;</div></li><li><div>              return $post;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>          $post_cats = wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'ids'));&nbsp;</div></li><li><div>          $check = false;&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// is the current post assigned to any categories</span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// which should not generate a notification email?</span></span>&nbsp;</div></li><li><div>          foreach ( explode(', ', $this-&gt;subscribe2_options['exclude']) as $cat ) {&nbsp;</div></li><li><div>              if ( in_array($cat, $post_cats) ) {&nbsp;</div></li><li><div>                  $check = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $check ) {&nbsp;</div></li><li><div>              <span class="comment">// hang on -- can registered users subscribe to</span>&nbsp;</div></li><li><div>              <span class="comment">// excluded categories?</span>&nbsp;</div></li><li><div>              if ( '0' == $this-&gt;subscribe2_options['reg_override'] ) {&nbsp;</div></li><li><div>                  <span class="comment">// nope? okay, let's leave</span>&nbsp;</div></li><li><div>                  return $post;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Are we sending notifications for Private posts?</span>&nbsp;</div></li><li><div>          <span class="comment">// Action is added if we are, but double check option and post status</span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['private'] == &quot;yes&quot; && $post-&gt;post_status == 'private' ) {&nbsp;</div></li><li><div>              <span class="comment">// don't send notification to public users</span>&nbsp;</div></li><li><div>              $check = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// lets collect our subscribers</span>&nbsp;</div></li><li><div>          $public = array();&nbsp;</div></li><li><div>          if ( !$check ) {&nbsp;</div></li><li><div>              <span class="comment">// if this post is assigned to an excluded</span>&nbsp;</div></li><li><div>              <span class="comment">// category, or is a private post then</span>&nbsp;</div></li><li><div>              <span class="comment">// don't send public subscribers a notification</span>&nbsp;</div></li><li><div>              $public = $this-&gt;get_public();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( $post-&gt;post_type == 'page' ) {&nbsp;</div></li><li><div>              $post_cats_string = implode(', ', get_all_category_ids());&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $post_cats_string = implode(', ', $post_cats);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $registered = $this-&gt;get_registered(&quot;cats=$post_cats_string&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// do we have subscribers?</span>&nbsp;</div></li><li><div>          if ( empty($public) && empty($registered) ) {&nbsp;</div></li><li><div>              <span class="comment">// if not, no sense doing anything else</span>&nbsp;</div></li><li><div>              return $post;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// make sure we prime the taxonomy variable for preview posts</span>&nbsp;</div></li><li><div>          $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// we set these class variables so that we can avoid</span>&nbsp;</div></li><li><div>      <span class="comment">// passing them in function calls a little later</span>&nbsp;</div></li><li><div>      $this-&gt;post_title = &quot;&lt;a href=\&quot;&quot; . get_permalink($post-&gt;ID) . &quot;\&quot;&gt;&quot; . html_entity_decode($post-&gt;post_title, ENT_QUOTES) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>      $this-&gt;permalink = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>      $this-&gt;post_date = get_the_time(get_option('date_format'), $post);&nbsp;</div></li><li><div>      $this-&gt;post_time = get_the_time('', $post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $author = get_userdata($post-&gt;post_author);&nbsp;</div></li><li><div>      $this-&gt;authorname = html_entity_decode(apply_filters('the_author', $author-&gt;display_name), ENT_QUOTES);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// do we send as admin, or post author?</span>&nbsp;</div></li><li><div>      if ( 'author' == $this-&gt;subscribe2_options['sender'] ) {&nbsp;</div></li><li><div>          <span class="comment">// get author details</span>&nbsp;</div></li><li><div>          $user = &$author;&nbsp;</div></li><li><div>          $this-&gt;myemail = $user-&gt;user_email;&nbsp;</div></li><li><div>          $this-&gt;myname = html_entity_decode($user-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>      } elseif ( 'blogname' == $this-&gt;subscribe2_options['sender'] ) {&nbsp;</div></li><li><div>          $this-&gt;myemail = get_option('admin_email');&nbsp;</div></li><li><div>          $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// get admin details</span>&nbsp;</div></li><li><div>          $user = $this-&gt;get_userdata($this-&gt;subscribe2_options['sender']);&nbsp;</div></li><li><div>          $this-&gt;myemail = $user-&gt;user_email;&nbsp;</div></li><li><div>          $this-&gt;myname = html_entity_decode($user-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;post_cat_names = implode(', ', wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>      $this-&gt;post_tag_names = implode(', ', wp_get_post_tags($post-&gt;ID, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get email subject</span>&nbsp;</div></li><li><div>      $subject = html_entity_decode(stripslashes(wp_kses($this-&gt;substitute($this-&gt;subscribe2_options['notification_subject']), '')));&nbsp;</div></li><li><div>      <span class="comment">// Get the message template</span>&nbsp;</div></li><li><div>      $mailtext = apply_filters('s2_email_template', $this-&gt;subscribe2_options['mailtext']);&nbsp;</div></li><li><div>      $mailtext = stripslashes($this-&gt;substitute($mailtext));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plaintext = $post-&gt;post_content;&nbsp;</div></li><li><div>      $plaintext = strip_shortcodes($plaintext);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plaintext = preg_replace('|&lt;s[^&gt;]*&gt;(.*)&lt;\/s&gt;|Ui', '', $plaintext);&nbsp;</div></li><li><div>      $plaintext = preg_replace('|&lt;strike[^&gt;]*&gt;(.*)&lt;\/strike&gt;|Ui', '', $plaintext);&nbsp;</div></li><li><div>      $plaintext = preg_replace('|&lt;del[^&gt;]*&gt;(.*)&lt;\/del&gt;|Ui', '', $plaintext);&nbsp;</div></li><li><div>      $excerpttext = $plaintext;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strstr($mailtext, &quot;{REFERENCELINKS}&quot;) ) {&nbsp;</div></li><li><div>          $mailtext = str_replace(&quot;{REFERENCELINKS}&quot;, '', $mailtext);&nbsp;</div></li><li><div>          $plaintext_links = '';&nbsp;</div></li><li><div>          $i = 0;&nbsp;</div></li><li><div>          while ( preg_match('|&lt;a([^&gt;]*)&gt;(.*)&lt;\/a&gt;|Ui', $plaintext, $matches) ) {&nbsp;</div></li><li><div>              if ( preg_match('|href=&quot;([^&quot;]*)&quot;|', $matches[1], $link_matches) ) {&nbsp;</div></li><li><div>                  $plaintext_links .= sprintf( &quot;[%d] %s\r\n&quot;, ++$i, $link_matches[1] );&nbsp;</div></li><li><div>                  $link_replacement = sprintf( &quot;%s [%d]&quot;, $matches[2], $i );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $link_replacement = $matches[2];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $plaintext = preg_replace('|&lt;a[^&gt;]*&gt;(.*)&lt;\/a&gt;|Ui', $link_replacement, $plaintext, 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>       $plaintext = trim(strip_tags($plaintext));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strstr($mailtext, &quot;{REFERENCELINKS}&quot;) && $plaintext_links != '' ) {&nbsp;</div></li><li><div>          $plaintext .= &quot;\r\n\r\n&quot; . trim($plaintext_links);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $gallid = ']&gt;&quot;, &quot;]]&gt&quot;, $content);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $excerpt = trim($post-&gt;post_excerpt);&nbsp;</div></li><li><div>      if ( '' == $excerpt ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// no excerpt, is there a &lt;!--more--&gt; ?</span></span></span>&nbsp;</div></li><li><div>          if ( false !== strpos($excerpttext, '&lt;!--more--&gt;') ) {&nbsp;</div></li><li><div>              list($excerpt, $more) = explode('&lt;!--more--&gt;', $excerpttext, 2);&nbsp;</div></li><li><div>              <span class="comment">// strip tags and trailing whitespace</span>&nbsp;</div></li><li><div>              $excerpt = trim(strip_tags($excerpt));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// no &lt;!--more--&gt;, so grab the first 55 words</span></span>&nbsp;</div></li><li><div>              $excerpt = trim(strip_tags($excerpttext));&nbsp;</div></li><li><div>              $words = explode(' ', $excerpt, $this-&gt;excerpt_length + 1);&nbsp;</div></li><li><div>              if (count($words) &gt; $this-&gt;excerpt_length) {&nbsp;</div></li><li><div>                  array_pop($words);&nbsp;</div></li><li><div>                  array_push($words, '[...]');&nbsp;</div></li><li><div>                  $excerpt = implode(' ', $words);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $html_excerpt = trim($post-&gt;post_excerpt);&nbsp;</div></li><li><div>      if ( '' == $html_excerpt ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// no excerpt, is there a &lt;!--more--&gt; ?</span></span></span>&nbsp;</div></li><li><div>          if ( false !== strpos($content, '&lt;!--more--&gt;') ) {&nbsp;</div></li><li><div>              list($html_excerpt, $more) = explode('&lt;!--more--&gt;', $content, 2);&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// balance HTML tags and then strip leading and trailing whitespace</span></span>&nbsp;</div></li><li><div>              $html_excerpt = trim(balanceTags($html_excerpt, true));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// no &lt;!--more--&gt;, so grab the first 55 words</span></span>&nbsp;</div></li><li><div>              $words = explode(' ', $content, $this-&gt;excerpt_length + 1);&nbsp;</div></li><li><div>              if (count($words) &gt; $this-&gt;excerpt_length) {&nbsp;</div></li><li><div>                  array_pop($words);&nbsp;</div></li><li><div>                  array_push($words, '[...]');&nbsp;</div></li><li><div>                  $html_excerpt = implode(' ', $words);&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// balance HTML tags and then strip leading and trailing whitespace</span></span>&nbsp;</div></li><li><div>                  $html_excerpt = trim(balanceTags($html_excerpt, true));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $html_excerpt = $content;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// maybe add social media sharing buttons</span>&nbsp;</div></li><li><div>      $social = apply_filters('s2_social_links', array('facebook', 'twitter'));&nbsp;</div></li><li><div>      if ( !empty($social) ) {&nbsp;</div></li><li><div>          $social_buttons = $this-&gt;social_buttons($social);&nbsp;</div></li><li><div>          $content .= $social_buttons;&nbsp;</div></li><li><div>          $html_excerpt .= $social_buttons;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// remove excess white space from with $excerpt and $plaintext</span>&nbsp;</div></li><li><div>      $excerpt = preg_replace('|[ ]+|', ' ', $excerpt);&nbsp;</div></li><li><div>      $plaintext = preg_replace('|[ ]+|', ' ', $plaintext);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// prepare mail body texts</span>&nbsp;</div></li><li><div>      $plain_excerpt_body = str_replace(&quot;{POST}&quot;, $excerpt, $mailtext);&nbsp;</div></li><li><div>      $plain_body = str_replace(&quot;{POST}&quot;, $plaintext, $mailtext);&nbsp;</div></li><li><div>      $html_body = str_replace(&quot;\r\n&quot;, &quot;&lt;br /&gt;\r\n&quot;, $mailtext);&nbsp;</div></li><li><div>      $html_body = str_replace(&quot;{POST}&quot;, $content, $html_body);&nbsp;</div></li><li><div>      $html_excerpt_body = str_replace(&quot;\r\n&quot;, &quot;&lt;br /&gt;\r\n&quot;, $mailtext);&nbsp;</div></li><li><div>      $html_excerpt_body = str_replace(&quot;{POST}&quot;, $html_excerpt, $html_excerpt_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $preview != '' ) {&nbsp;</div></li><li><div>          $this-&gt;myemail = $preview;&nbsp;</div></li><li><div>          $this-&gt;myname = __('Plain Text Excerpt Preview', 'subscribe2');&nbsp;</div></li><li><div>          $this-&gt;mail(array($preview), $subject, $plain_excerpt_body);&nbsp;</div></li><li><div>          $this-&gt;myname = __('Plain Text Full Preview', 'subscribe2');&nbsp;</div></li><li><div>          $this-&gt;mail(array($preview), $subject, $plain_body);&nbsp;</div></li><li><div>          $this-&gt;myname = __('HTML Excerpt Preview', 'subscribe2');&nbsp;</div></li><li><div>          $this-&gt;mail(array($preview), $subject, $html_excerpt_body, 'html');&nbsp;</div></li><li><div>          $this-&gt;myname = __('HTML Full Preview', 'subscribe2');&nbsp;</div></li><li><div>          $this-&gt;mail(array($preview), $subject, $html_body, 'html');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Registered Subscribers first</span>&nbsp;</div></li><li><div>          <span class="comment">// first we send plaintext summary emails</span>&nbsp;</div></li><li><div>          $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=excerpt&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>          $recipients = apply_filters('s2_send_plain_excerpt_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>          $this-&gt;mail($recipients, $subject, $plain_excerpt_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// next we send plaintext full content emails</span>&nbsp;</div></li><li><div>          $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=post&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>          $recipients = apply_filters('s2_send_plain_fullcontent_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>          $this-&gt;mail($recipients, $subject, $plain_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// next we send html excerpt content emails</span>&nbsp;</div></li><li><div>          $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=html_excerpt&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>          $recipients = apply_filters('s2_send_html_excerpt_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>          $this-&gt;mail($recipients, $subject, $html_excerpt_body, 'html');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// next we send html full content emails</span>&nbsp;</div></li><li><div>          $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=html&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>          $recipients = apply_filters('s2_send_html_fullcontent_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>          $this-&gt;mail($recipients, $subject, $html_body, 'html');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// and finally we send to Public Subscribers</span>&nbsp;</div></li><li><div>          $recipients = apply_filters('s2_send_public_subscribers', $public, $post-&gt;ID);&nbsp;</div></li><li><div>          $this-&gt;mail($recipients, $subject, $plain_excerpt_body, 'text');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end publish()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Function to create social network sharing buttons</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function social_buttons($social) {&nbsp;</div></li><li><div>      $social_buttons = '';&nbsp;</div></li><li><div>      if ( in_array('facebook', $social) ) {&nbsp;</div></li><li><div>          $social_buttons .= '&lt;a href=&quot;http:<span class="comment">//api.addthis.com/oexchange/0.8/forward/facebook/offer?url=' . urlencode($this-&gt;permalink) . '&quot; target=&quot;_blank&quot; &gt;&lt;img src=&quot;http://cache.addthiscdn.com/icons/v1/thumbs/facebook.gif&quot; border=&quot;0&quot; style=&quot;margin: 1px;&quot; alt=&quot;' . __('Like', 'subscribe2') . '&quot; /&gt;&lt;/a&gt;';</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( in_array('twitter', $social) ) {&nbsp;</div></li><li><div>          $social_buttons .= '&lt;a href=&quot;http:<span class="comment">//api.addthis.com/oexchange/0.8/forward/twitter/offer?url=' . urlencode($this-&gt;permalink) . '&amp;title=' . urlencode(strip_tags($this-&gt;post_title)) . '&quot; target=&quot;_blank&quot; &gt;&lt;img src=&quot;http://cache.addthiscdn.com/icons/v1/thumbs/twitter.gif&quot; border=&quot;0&quot; style=&quot;margin: 1px;&quot; alt=&quot;' . __('Tweet', 'subscribe2') . '&quot; /&gt;&lt;/a&gt;';</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( in_array('google', $social) ) {&nbsp;</div></li><li><div>          $social_buttons .= '&lt;a href=&quot;http:<span class="comment">//api.addthis.com/oexchange/0.8/forward/google_plusone_share/offer?url=' . urlencode($this-&gt;permalink) . '&amp;title=' . urlencode(strip_tags($this-&gt;post_title)) . '&quot; target=&quot;_blank&quot; &gt;&lt;img src=&quot;http://cache.addthiscdn.com/icons/v1/thumbs/google_plusone.gif&quot; border=&quot;0&quot; style=&quot;margin: 1px;&quot; alt=&quot;' . __('Google+', 'subscribe2') . '&quot; /&gt;&lt;/a&gt;';</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters('s2_social_buttons', $social_buttons);&nbsp;</div></li><li><div>  } <span class="comment">// end social_buttons()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Send confirmation email to a public subscriber</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function send_confirm($what = '', $is_remind = false) {&nbsp;</div></li><li><div>      if ( $this-&gt;filtered == 1 ) { return true; }&nbsp;</div></li><li><div>      if ( !$this-&gt;email || !$what ) { return false; }&nbsp;</div></li><li><div>      $id = $this-&gt;get_id($this-&gt;email);&nbsp;</div></li><li><div>      if ( !$id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// generate the URL &quot;?s2=ACTION+HASH+ID&quot;</span>&nbsp;</div></li><li><div>      <span class="comment">// ACTION = 1 to subscribe, 0 to unsubscribe</span>&nbsp;</div></li><li><div>      <span class="comment">// HASH = wp_hash of email address</span>&nbsp;</div></li><li><div>      <span class="comment">// ID = user's ID in the subscribe2 table</span>&nbsp;</div></li><li><div>      <span class="comment">// use home instead of siteurl incase index.php is not in core wordpress directory</span>&nbsp;</div></li><li><div>      $link = apply_filters('s2_confirm_link', get_option('home')) . &quot;/?s2=&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'add' == $what ) {&nbsp;</div></li><li><div>          $link .= '1';&nbsp;</div></li><li><div>      } elseif ( 'del' == $what ) {&nbsp;</div></li><li><div>          $link .= '0';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $link .= wp_hash($this-&gt;email);&nbsp;</div></li><li><div>      $link .= $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// sort the headers now so we have all substitute information</span>&nbsp;</div></li><li><div>      $mailheaders = $this-&gt;headers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $is_remind == true ) {&nbsp;</div></li><li><div>          $body = $this-&gt;substitute(stripslashes($this-&gt;subscribe2_options['remind_email']));&nbsp;</div></li><li><div>          $subject = $this-&gt;substitute(stripslashes($this-&gt;subscribe2_options['remind_subject']));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $body = apply_filters('s2_confirm_email', stripslashes($this-&gt;subscribe2_options['confirm_email']), $what);&nbsp;</div></li><li><div>          $body = $this-&gt;substitute($body);&nbsp;</div></li><li><div>          if ( 'add' == $what ) {&nbsp;</div></li><li><div>              $body = str_replace(&quot;{ACTION}&quot;, $this-&gt;subscribe, $body);&nbsp;</div></li><li><div>              $subject = str_replace(&quot;{ACTION}&quot;, $this-&gt;subscribe, $this-&gt;subscribe2_options['confirm_subject']);&nbsp;</div></li><li><div>          } elseif ( 'del' == $what ) {&nbsp;</div></li><li><div>              $body = str_replace(&quot;{ACTION}&quot;, $this-&gt;unsubscribe, $body);&nbsp;</div></li><li><div>              $subject = str_replace(&quot;{ACTION}&quot;, $this-&gt;unsubscribe, $this-&gt;subscribe2_options['confirm_subject']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $subject = html_entity_decode($this-&gt;substitute(stripslashes($subject)), ENT_QUOTES);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $body = str_replace(&quot;{LINK}&quot;, $link, $body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $is_remind == true && function_exists('wpmq_mail') ) {&nbsp;</div></li><li><div>          <span class="comment">// could be sending lots of reminders so queue them if wpmq is enabled</span>&nbsp;</div></li><li><div>          @wp_mail($this-&gt;email, $subject, $body, $mailheaders, '', 0);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return @wp_mail($this-&gt;email, $subject, $body, $mailheaders);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end send_confirm()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== Public Subscriber functions ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Return an array of all the public subscribers</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_public($confirmed = 1) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      if ( 1 == $confirmed ) {&nbsp;</div></li><li><div>          if ( '' == $this-&gt;all_confirmed ) {&nbsp;</div></li><li><div>              $this-&gt;all_confirmed = $wpdb-&gt;get_col(&quot;SELECT email FROM $this-&gt;public WHERE active='1'&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $this-&gt;all_confirmed;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( '' == $this-&gt;all_unconfirmed ) {&nbsp;</div></li><li><div>              $this-&gt;all_unconfirmed = $wpdb-&gt;get_col(&quot;SELECT email FROM $this-&gt;public WHERE active='0'&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return $this-&gt;all_unconfirmed;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end get_public()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Given a public subscriber ID, returns the email address</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_email($id = 0) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT email FROM $this-&gt;public WHERE id=%d&quot;, $id));&nbsp;</div></li><li><div>  } <span class="comment">// end get_email()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Given a public subscriber email, returns the subscriber ID</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_id($email = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$email ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT id FROM $this-&gt;public WHERE email=%s&quot;, $email));&nbsp;</div></li><li><div>  } <span class="comment">// end get_id()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Add an public subscriber to the subscriber table</span>&nbsp;</div></li><li><div><span class="comment">  If added by admin it is immediately confirmed, otherwise as unconfirmed</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function add($email = '', $confirm = false) {&nbsp;</div></li><li><div>      if ( $this-&gt;filtered == 1 ) { return; }&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !is_email($email) ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== $this-&gt;is_public($email) ) {&nbsp;</div></li><li><div>          <span class="comment">// is this an email for a registered user</span>&nbsp;</div></li><li><div>          $check = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT user_email FROM $wpdb-&gt;users WHERE user_email=%s&quot;, $this-&gt;email));&nbsp;</div></li><li><div>          if ( $check ) { return; }&nbsp;</div></li><li><div>          if ( $confirm ) {&nbsp;</div></li><li><div>              $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET active='1', ip=%s WHERE CAST(email as binary)=%s&quot;, $this-&gt;ip, $email));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET date=CURDATE(), time=CURTIME() WHERE CAST(email as binary)=%s&quot;, $email));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $confirm ) {&nbsp;</div></li><li><div>              global $current_user;&nbsp;</div></li><li><div>              $wpdb-&gt;query($wpdb-&gt;prepare(&quot;INSERT INTO $this-&gt;public (email, active, date, time, ip) VALUES (%s, %d, CURDATE(), CURTIME(), %s)&quot;, $email, 1, $current_user-&gt;user_login));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $wpdb-&gt;query($wpdb-&gt;prepare(&quot;INSERT INTO $this-&gt;public (email, active, date, time, ip) VALUES (%s, %d, CURDATE(), CURTIME(), %s)&quot;, $email, 0, $this-&gt;ip));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end add()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Remove a public subscriber user from the subscription table</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function delete($email = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !is_email($email) ) { return false; }&nbsp;</div></li><li><div>      $wpdb-&gt;query($wpdb-&gt;prepare(&quot;DELETE FROM $this-&gt;public WHERE CAST(email as binary)=%s&quot;, $email));&nbsp;</div></li><li><div>  } <span class="comment">// end delete()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Toggle a public subscriber's status</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function toggle($email = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $email || !is_email($email) ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// let's see if this is a public user</span>&nbsp;</div></li><li><div>      $status = $this-&gt;is_public($email);&nbsp;</div></li><li><div>      if ( false === $status ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '0' == $status ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET active='1', conf_date=CURDATE(), conf_time=CURTIME(), conf_ip=%s WHERE CAST(email as binary)=%s&quot;, $this-&gt;ip, $email));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET active='0', conf_date=CURDATE(), conf_time=CURTIME(), conf_ip=%s WHERE CAST(email as binary)=%s&quot;, $this-&gt;ip, $email));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end toggle()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Send reminder email to unconfirmed public subscribers</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function remind($emails = '') {&nbsp;</div></li><li><div>      if ( '' == $emails ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $recipients = explode(&quot;, &quot;, $emails);&nbsp;</div></li><li><div>      if ( !is_array($recipients) ) { $recipients = (array)$recipients; }&nbsp;</div></li><li><div>      foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>          $this-&gt;email = $recipient;&nbsp;</div></li><li><div>          $this-&gt;send_confirm('add', true);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">//end remind()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Is the supplied email address a public subscriber?</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function is_public($email = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $email ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// run the query and force case sensitivity</span>&nbsp;</div></li><li><div>      $check = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT active FROM $this-&gt;public WHERE CAST(email as binary)=%s&quot;, $email));&nbsp;</div></li><li><div>      if ( '0' == $check || '1' == $check ) {&nbsp;</div></li><li><div>          return $check;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end is_public()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== Registered User and Subscriber functions ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Is the supplied email address a registered user of the blog?</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function is_registered($email = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $email ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $check = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT user_email FROM $wpdb-&gt;users WHERE user_email=%s&quot;, $email));&nbsp;</div></li><li><div>      if ( $check ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end is_registered()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Return Registered User ID from email</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_user_id($email = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $email ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $id = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT id FROM $wpdb-&gt;users WHERE user_email=%s&quot;, $email));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $id;&nbsp;</div></li><li><div>  } <span class="comment">// end get_user_id()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Return an array of all subscribers emails or IDs</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_all_registered($return = 'email') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;s2_mu ) {&nbsp;</div></li><li><div>          if ( $return === 'ID' ) {&nbsp;</div></li><li><div>              if ( $this-&gt;all_registered_id === '' ) {&nbsp;</div></li><li><div>                  $this-&gt;all_registered_id = $wpdb-&gt;get_col(&quot;SELECT user_id FROM $wpdb-&gt;usermeta WHERE meta_key='&quot; . $wpdb-&gt;prefix . &quot;capabilities'&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $this-&gt;all_registered_id;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $this-&gt;all_registered_email === '' ) {&nbsp;</div></li><li><div>                  $this-&gt;all_registered_email = $wpdb-&gt;get_col(&quot;SELECT a.user_email FROM $wpdb-&gt;users AS a INNER JOIN $wpdb-&gt;usermeta AS b ON a.ID = b.user_id WHERE b.meta_key='&quot; . $wpdb-&gt;prefix . &quot;capabilities'&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $this-&gt;all_registered_email;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $return === 'ID' ) {&nbsp;</div></li><li><div>              if ( $this-&gt;all_registered_id === '' ) {&nbsp;</div></li><li><div>                  $this-&gt;all_registered_id = $wpdb-&gt;get_col(&quot;SELECT ID FROM $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $this-&gt;all_registered_id;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $this-&gt;all_registered_email === '' ) {&nbsp;</div></li><li><div>                  $this-&gt;all_registered_email = $wpdb-&gt;get_col(&quot;SELECT user_email FROM $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $this-&gt;all_registered_email;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end get_all_registered()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Return an array of registered subscribers</span>&nbsp;</div></li><li><div><span class="comment">  Collect all the registered users of the blog who are subscribed to the specified categories</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_registered($args = '') {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      parse_str($args, $r);&nbsp;</div></li><li><div>      if ( !isset($r['format']) )&nbsp;</div></li><li><div>          $r['format'] = 'all';&nbsp;</div></li><li><div>      if ( !isset($r['cats']) )&nbsp;</div></li><li><div>          $r['cats'] = '';&nbsp;</div></li><li><div>      if ( !isset($r['author']) )&nbsp;</div></li><li><div>          $r['author'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// collect all subscribers for compulsory categories</span>&nbsp;</div></li><li><div>      $compulsory = explode(', ', $this-&gt;subscribe2_options['compulsory']);&nbsp;</div></li><li><div>      foreach ( explode(', ', $r['cats']) as $cat ) {&nbsp;</div></li><li><div>          if ( in_array($cat, $compulsory) ) {&nbsp;</div></li><li><div>              $r['cats'] = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $JOIN = ''; $AND = '';&nbsp;</div></li><li><div>      <span class="comment">// text or HTML subscribers</span>&nbsp;</div></li><li><div>      if ( 'all' != $r['format'] ) {&nbsp;</div></li><li><div>          $JOIN .= &quot;INNER JOIN $wpdb-&gt;usermeta AS b ON a.user_id = b.user_id &quot;;&nbsp;</div></li><li><div>          $AND .= $wpdb-&gt;prepare(&quot; AND b.meta_key=%s AND b.meta_value=&quot;, $this-&gt;get_usermeta_keyname('s2_format'));&nbsp;</div></li><li><div>          if ( 'html' == $r['format'] ) {&nbsp;</div></li><li><div>              $AND .= &quot;'html'&quot;;&nbsp;</div></li><li><div>          } elseif ( 'html_excerpt' == $r['format'] ) {&nbsp;</div></li><li><div>              $AND .= &quot;'html_excerpt'&quot;;&nbsp;</div></li><li><div>          } elseif ( 'post' == $r['format'] ) {&nbsp;</div></li><li><div>              $AND .= &quot;'post'&quot;;&nbsp;</div></li><li><div>          } elseif ( 'excerpt' == $r['format'] ) {&nbsp;</div></li><li><div>              $AND .= &quot;'excerpt'&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// specific category subscribers</span>&nbsp;</div></li><li><div>      if ( '' != $r['cats'] ) {&nbsp;</div></li><li><div>          $JOIN .= &quot;INNER JOIN $wpdb-&gt;usermeta AS c ON a.user_id = c.user_id &quot;;&nbsp;</div></li><li><div>          $and = '';&nbsp;</div></li><li><div>          foreach ( explode(', ', $r['cats']) as $cat ) {&nbsp;</div></li><li><div>              ('' == $and) ? $and = $wpdb-&gt;prepare(&quot;c.meta_key=%s&quot;, $this-&gt;get_usermeta_keyname('s2_cat') . $cat) : $and .= $wpdb-&gt;prepare(&quot; OR c.meta_key=%s&quot;, $this-&gt;get_usermeta_keyname('s2_cat') . $cat);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $AND .= &quot; AND ($and)&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// specific authors</span>&nbsp;</div></li><li><div>      if ( '' != $r['author'] ) {&nbsp;</div></li><li><div>          $JOIN .= &quot;INNER JOIN $wpdb-&gt;usermeta AS d ON a.user_id = d.user_id &quot;;&nbsp;</div></li><li><div>          $AND .= $wpdb-&gt;prepare(&quot; AND (d.meta_key=%s AND NOT FIND_IN_SET(%s, d.meta_value))&quot;, $this-&gt;get_usermeta_keyname('s2_authors'), $r['author']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;s2_mu ) {&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&quot;SELECT a.user_id FROM $wpdb-&gt;usermeta AS a INNER JOIN $wpdb-&gt;usermeta AS e ON a.user_id = e.user_id &quot; . $JOIN . &quot;WHERE a.meta_key='&quot; . $wpdb-&gt;prefix . &quot;capabilities' AND e.meta_key=%s AND e.meta_value &lt;&gt; ''&quot; . $AND, $this-&gt;get_usermeta_keyname('s2_subscribed'));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $sql = $wpdb-&gt;prepare(&quot;SELECT a.user_id FROM $wpdb-&gt;usermeta AS a &quot; . $JOIN . &quot;WHERE a.meta_key=%s AND a.meta_value &lt;&gt; ''&quot; . $AND, $this-&gt;get_usermeta_keyname('s2_subscribed'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $result = $wpdb-&gt;get_col($sql);&nbsp;</div></li><li><div>      if ( $result ) {&nbsp;</div></li><li><div>          $ids = implode(', ', array_map(array($this, 'prepare_in_data'), $result));&nbsp;</div></li><li><div>          $registered = $wpdb-&gt;get_col(&quot;SELECT user_email FROM $wpdb-&gt;users WHERE ID IN ($ids)&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty($registered) ) { return array(); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// apply filter to registered users to add or remove additional addresses, pass args too for additional control</span>&nbsp;</div></li><li><div>      $registered = apply_filters('s2_registered_subscribers', $registered, $args);&nbsp;</div></li><li><div>      return $registered;&nbsp;</div></li><li><div>  } <span class="comment">// end get_registered()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Function to ensure email is compliant with internet messaging standards</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function sanitize_email($email) {&nbsp;</div></li><li><div>      $email = trim($email);&nbsp;</div></li><li><div>      if ( !is_email($email) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// ensure that domain is in lowercase as per internet email standards http://www.ietf.org/rfc/rfc5321.txt</span>&nbsp;</div></li><li><div>      list($name, $domain) = explode('@', $email, 2);&nbsp;</div></li><li><div>      return $name . &quot;@&quot; . strtolower($domain);&nbsp;</div></li><li><div>  } <span class="comment">// end sanitize_email()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Create the appropriate usermeta values when a user registers</span>&nbsp;</div></li><li><div><span class="comment">  If the registering user had previously subscribed to notifications, this function will delete them from the public subscriber list first</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function register($user_ID = 0, $consent = false) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 0 == $user_ID ) { return $user_ID; }&nbsp;</div></li><li><div>      $user = get_userdata($user_ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Subscribe</span> registered users to categories obeying excluded categories</span>&nbsp;</div></li><li><div>      if ( 0 == $this-&gt;subscribe2_options['reg_override'] || 'no' == $this-&gt;subscribe2_options['newreg_override'] ) {&nbsp;</div></li><li><div>          $all_cats = $this-&gt;all_cats(true, 'ID');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $all_cats = $this-&gt;all_cats(false, 'ID');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cats = '';&nbsp;</div></li><li><div>      foreach ( $all_cats as $cat ) {&nbsp;</div></li><li><div>          ('' == $cats) ? $cats = &quot;$cat-&gt;term_id&quot; : $cats .= &quot;, $cat-&gt;term_id&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $cats ) {&nbsp;</div></li><li><div>          <span class="comment">// sanity check, might occur if all cats excluded and reg_override = 0</span>&nbsp;</div></li><li><div>          return $user_ID;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// has this user previously signed up for email notification?</span>&nbsp;</div></li><li><div>      if ( false !== $this-&gt;is_public($this-&gt;sanitize_email($user-&gt;user_email)) ) {&nbsp;</div></li><li><div>          <span class="comment">// delete this user from the public table, and subscribe them to all the categories</span>&nbsp;</div></li><li><div>          $this-&gt;delete($user-&gt;user_email);&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), $cats);&nbsp;</div></li><li><div>          foreach ( explode(', ', $cats) as $cat ) {&nbsp;</div></li><li><div>              update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat, $cat);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), 'excerpt');&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), $this-&gt;subscribe2_options['autosub_def']);&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_authors'), '');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// create post format entries for all users</span>&nbsp;</div></li><li><div>          if ( in_array($this-&gt;subscribe2_options['autoformat'], array('html', 'html_excerpt', 'post', 'excerpt')) ) {&nbsp;</div></li><li><div>              update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), $this-&gt;subscribe2_options['autoformat']);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), 'excerpt');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), $this-&gt;subscribe2_options['autosub_def']);&nbsp;</div></li><li><div>          <span class="comment">// if the are no existing subscriptions, create them if we have consent</span>&nbsp;</div></li><li><div>          if (  true === $consent ) {&nbsp;</div></li><li><div>              update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), $cats);&nbsp;</div></li><li><div>              foreach ( explode(', ', $cats) as $cat ) {&nbsp;</div></li><li><div>                  update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat, $cat);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_authors'), '');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $user_ID;&nbsp;</div></li><li><div>  } <span class="comment">// end register()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Get admin data from record 1 or first user with admin rights</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_userdata($admin_id) {&nbsp;</div></li><li><div>      global $wpdb, $userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_numeric($admin_id) ) {&nbsp;</div></li><li><div>          $admin = get_userdata($admin_id);&nbsp;</div></li><li><div>      } elseif ( $admin_id == 'admin' ) {&nbsp;</div></li><li><div>          <span class="comment">//ensure compatibility with &lt; 4.16</span>&nbsp;</div></li><li><div>          $admin = get_userdata('1');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $admin = &$userdata;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty($admin) || $admin-&gt;ID == 0 ) {&nbsp;</div></li><li><div>          $role = array('role' =&gt; 'administrator');&nbsp;</div></li><li><div>          $wp_user_query = get_users( $role );&nbsp;</div></li><li><div>          $admin = $wp_user_query[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $admin;&nbsp;</div></li><li><div>  } <span class="comment">//end get_userdata()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Subscribe/unsubscribe user from one-click submission</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function one_click_handler($user_ID, $action) {&nbsp;</div></li><li><div>      if ( !isset($user_ID) || !isset($action) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $all_cats = $this-&gt;all_cats(true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'subscribe' == $action ) {&nbsp;</div></li><li><div>          <span class="comment">// Subscribe</span>&nbsp;</div></li><li><div>          $new_cats = array();&nbsp;</div></li><li><div>          foreach ( $all_cats as $cat ) {&nbsp;</div></li><li><div>              update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat-&gt;term_id, $cat-&gt;term_id);&nbsp;</div></li><li><div>              $new_cats[] = $cat-&gt;term_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), implode(', ', $new_cats));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'yes' == $this-&gt;subscribe2_options['show_autosub'] && 'no' != get_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), true) ) {&nbsp;</div></li><li><div>              update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), 'yes');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ( 'unsubscribe' == $action ) {&nbsp;</div></li><li><div>          <span class="comment">// Unsubscribe</span>&nbsp;</div></li><li><div>          foreach ( $all_cats as $cat ) {&nbsp;</div></li><li><div>              delete_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat-&gt;term_id);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          delete_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'));&nbsp;</div></li><li><div>          update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), 'no');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">//end one_click_handler()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== helper functions: forms and stuff ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Get an object of all categories, include default and custom type</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function all_cats($exclude = false, $orderby = 'slug') {&nbsp;</div></li><li><div>      $all_cats = array();&nbsp;</div></li><li><div>      $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $s2_taxonomies as $taxonomy ) {&nbsp;</div></li><li><div>          if ( taxonomy_exists($taxonomy) ) {&nbsp;</div></li><li><div>              $all_cats = array_merge($all_cats, get_categories(array('hide_empty' =&gt; false, 'orderby' =&gt; $orderby, 'taxonomy' =&gt; $taxonomy)));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $exclude === true ) {&nbsp;</div></li><li><div>          <span class="comment">// remove excluded categories from the returned object</span>&nbsp;</div></li><li><div>          $excluded = explode(', ', $this-&gt;subscribe2_options['exclude']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// need to use $id like this as this is a mixed array / object</span>&nbsp;</div></li><li><div>          $id = 0;&nbsp;</div></li><li><div>          foreach ( $all_cats as $cat) {&nbsp;</div></li><li><div>              if ( in_array($cat-&gt;term_id, $excluded) ) {&nbsp;</div></li><li><div>                  unset($all_cats[$id]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $id++;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $all_cats;&nbsp;</div></li><li><div>  } <span class="comment">// end all_cats()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Function to sanitise array of data for SQL</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function prepare_in_data($data) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      return $wpdb-&gt;prepare('%s', $data);&nbsp;</div></li><li><div>  } <span class="comment">// end prepare_in_data()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Filter for usermeta table key names to adjust them if needed for WPMU blogs</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function get_usermeta_keyname($metaname) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Is this WordPressMU or not?</span></span>&nbsp;</div></li><li><div>      if ( $this-&gt;s2_mu === true ) {&nbsp;</div></li><li><div>          switch( $metaname ) {&nbsp;</div></li><li><div>              case 's2_subscribed':&nbsp;</div></li><li><div>              case 's2_cat':&nbsp;</div></li><li><div>              case 's2_format':&nbsp;</div></li><li><div>              case 's2_autosub':&nbsp;</div></li><li><div>              case 's2_authors':&nbsp;</div></li><li><div>                  return $wpdb-&gt;prefix . $metaname;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Not MU or not a prefixed option name</span>&nbsp;</div></li><li><div>      return $metaname;&nbsp;</div></li><li><div>  } <span class="comment">// end get_usermeta_keyname()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Adds information to the WordPress registration screen for new users</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function register_form() {&nbsp;</div></li><li><div>      if ( 'no' == $this-&gt;subscribe2_options['autosub'] ) { return; }&nbsp;</div></li><li><div>      if ( 'wpreg' == $this-&gt;subscribe2_options['autosub'] ) {&nbsp;</div></li><li><div>          echo &quot;&lt;p&gt;\r\n&lt;label&gt;&quot;;&nbsp;</div></li><li><div>          echo __('Check here to Subscribe to email notifications for new posts', 'subscribe2') . &quot;:&lt;br /&gt;\r\n&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;input type=\&quot;checkbox\&quot; name=\&quot;reg_subscribe\&quot;&quot; . checked($this-&gt;subscribe2_options['wpregdef'], 'yes', false) . &quot; /&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;/label&gt;\r\n&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;/p&gt;\r\n&quot;;&nbsp;</div></li><li><div>      } elseif ( 'yes' == $this-&gt;subscribe2_options['autosub'] ) {&nbsp;</div></li><li><div>          echo &quot;&lt;p&gt;\r\n&lt;center&gt;\r\n&quot;;&nbsp;</div></li><li><div>          echo __('By registering with this blog you are also agreeing to receive email notifications for new posts but you can unsubscribe at anytime', 'subscribe2') . &quot;.&lt;br /&gt;\r\n&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;/center&gt;&lt;/p&gt;\r\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end register_form()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Process function to add action if user selects to subscribe to posts during registration</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function register_post($user_ID = 0) {&nbsp;</div></li><li><div>      global $_POST;&nbsp;</div></li><li><div>      if ( 0 == $user_ID ) { return; }&nbsp;</div></li><li><div>      if ( 'yes' == $this-&gt;subscribe2_options['autosub'] || ( isset($_POST['reg_subscribe']) && 'on' == $_POST['reg_subscribe'] && 'wpreg' == $this-&gt;subscribe2_options['autosub'] ) ) {&nbsp;</div></li><li><div>          $this-&gt;register($user_ID, true);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;register($user_ID, false);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end register_post()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== comment subscriber functions ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Display check box on comment page</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function s2_comment_meta_form() {&nbsp;</div></li><li><div>      if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>          echo $this-&gt;profile;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          echo &quot;&lt;p style=\&quot;width: auto;\&quot;&gt;&lt;label&gt;&lt;input type=\&quot;checkbox\&quot; name=\&quot;s2_comment_request\&quot; value=\&quot;1\&quot; &quot; . checked($this-&gt;subscribe2_options['comment_def'], 'yes', false) . &quot;/&gt; &quot; . __('Check here to Subscribe to notifications for new posts', 'subscribe2') . &quot;&lt;/label&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end s2_comment_meta_form()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Process comment meta data</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function s2_comment_meta($comment_ID, $approved = 0) {&nbsp;</div></li><li><div>      if ( $_POST['s2_comment_request'] == '1' ) {&nbsp;</div></li><li><div>          switch ($approved) {&nbsp;</div></li><li><div>              case '0':&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Unapproved</span> so hold in meta data pending moderation</span>&nbsp;</div></li><li><div>                  add_comment_meta($comment_ID, 's2_comment_request', $_POST['s2_comment_request']);&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case '1':&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Approved</span> so add</span>&nbsp;</div></li><li><div>                  $comment = get_comment($comment_ID);&nbsp;</div></li><li><div>                  $is_public = $this-&gt;is_public($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                  if ( $is_public == 0 ) {&nbsp;</div></li><li><div>                      $this-&gt;toggle($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $is_registered = $this-&gt;is_registered($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                  if ( !$is_public && !$is_registered ) {&nbsp;</div></li><li><div>                      $this-&gt;add($comment-&gt;comment_author_email, true);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              default :&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end s2_comment_meta()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Action subscribe requests made on comment forms when comments are approved</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function comment_status($comment_ID = 0) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get meta data</span>&nbsp;</div></li><li><div>      $subscribe = get_comment_meta($comment_ID, 's2_comment_request', true);&nbsp;</div></li><li><div>      if ( $subscribe != '1' ) { return $comment_ID; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Retrieve the information about the comment</span>&nbsp;</div></li><li><div>      $sql = $wpdb-&gt;prepare(&quot;SELECT comment_author_email, comment_approved FROM $wpdb-&gt;comments WHERE comment_ID=%s LIMIT 1&quot;, $comment_ID);&nbsp;</div></li><li><div>      $comment = $wpdb-&gt;get_row($sql, OBJECT);&nbsp;</div></li><li><div>      if ( empty($comment) ) { return $comment_ID; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ($comment-&gt;comment_approved) {&nbsp;</div></li><li><div>          case '0': <span class="comment">// Unapproved</span>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case '1': <span class="comment">// Approved</span>&nbsp;</div></li><li><div>              $is_public = $this-&gt;is_public($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>              if ( $is_public == 0 ) {&nbsp;</div></li><li><div>                  $this-&gt;toggle($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $is_registered = $this-&gt;is_registered($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>              if ( !$is_public && !$is_registered ) {&nbsp;</div></li><li><div>                  $this-&gt;add($comment-&gt;comment_author_email, true);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              delete_comment_meta($comment_ID, 's2_comment_request');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default: <span class="comment">// post is trash, spam or deleted</span>&nbsp;</div></li><li><div>              delete_comment_meta($comment_ID, 's2_comment_request');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $comment_ID;&nbsp;</div></li><li><div>  } <span class="comment">// end comment_status()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== widget functions ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Register the form widget</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function subscribe2_widget() {&nbsp;</div></li><li><div>      require_once( S2PATH . 'include/widget.php');&nbsp;</div></li><li><div>      register_widget('S2_Form_widget');&nbsp;</div></li><li><div>  } <span class="comment">// end subscribe2_widget()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Register the counter widget</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function counter_widget() {&nbsp;</div></li><li><div>      require_once( S2PATH . 'include/counterwidget.php');&nbsp;</div></li><li><div>      register_widget('S2_Counter_widget');&nbsp;</div></li><li><div>  } <span class="comment">// end counter_widget()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== wp-cron functions ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Add a weekly event to cron</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function add_weekly_sched($scheds) {&nbsp;</div></li><li><div>      $exists = false;&nbsp;</div></li><li><div>      foreach ( $scheds as $sched ) {&nbsp;</div></li><li><div>          if ( array_search(604800, $sched) ) {&nbsp;</div></li><li><div>              $exists = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( !$exists ) {&nbsp;</div></li><li><div>          $scheds['weekly'] = array('interval' =&gt; 604800, 'display' =&gt; __('Weekly', 'subscribe2'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $scheds;&nbsp;</div></li><li><div>  } <span class="comment">// end add_weekly_sched()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Handle post transitions for the digest email</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function digest_post_transitions($new_status, $old_status, $post) {&nbsp;</div></li><li><div>      if ( $new_status === $old_status ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;subscribe2_options['pages'] == 'yes' ) {&nbsp;</div></li><li><div>          $s2_post_types = array('page', 'post');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $s2_post_types = array('post');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $s2_post_types = apply_filters('s2_post_types', $s2_post_types);&nbsp;</div></li><li><div>      if ( !in_array($post-&gt;post_type, $s2_post_types) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $post-&gt;ID, '_s2_digest_post_status', ( 'publish' === $new_status ) ? 'pending' : 'draft' );&nbsp;</div></li><li><div>  } <span class="comment">// end digest_post_transitions()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Send a daily digest of today's new posts</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function subscribe2_cron($preview = '', $resend = '') {&nbsp;</div></li><li><div>      if ( defined('DOING_S2_CRON') && DOING_S2_CRON ) { return; }&nbsp;</div></li><li><div>      define( 'DOING_S2_CRON', true );&nbsp;</div></li><li><div>      global $wpdb, $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $preview ) {&nbsp;</div></li><li><div>          <span class="comment">// set up SQL query based on options</span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['private'] == 'yes' ) {&nbsp;</div></li><li><div>              $status = &quot;'publish', 'private'&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $status = &quot;'publish'&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// send notifications for allowed post type (defaults for posts and pages)</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// uses s2_post_types filter to allow for custom post types in WP 3.0</span></span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['pages'] == 'yes' ) {&nbsp;</div></li><li><div>              $s2_post_types = array('page', 'post');&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $s2_post_types = array('post');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $s2_post_types = apply_filters('s2_post_types', $s2_post_types);&nbsp;</div></li><li><div>          foreach ( $s2_post_types as $post_type ) {&nbsp;</div></li><li><div>              if ( !isset($type) ) {&nbsp;</div></li><li><div>                  $type = $wpdb-&gt;prepare(&quot;%s&quot;, $post_type);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $type .= $wpdb-&gt;prepare(&quot;, %s&quot;, $post_type);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// collect posts</span>&nbsp;</div></li><li><div>          if ( $resend == 'resend' ) {&nbsp;</div></li><li><div>              $query = new WP_Query( array(&nbsp;</div></li><li><div>                  'post__in' =&gt; explode(', ', $this-&gt;subscribe2_options['last_s2cron']), &nbsp;</div></li><li><div>                  'ignore_sticky_posts' =&gt; 1, &nbsp;</div></li><li><div>                  'order' =&gt; ($this-&gt;subscribe2_options['cron_order'] === 'desc') ? &quot;DESC&quot; : &quot;ASC&quot;&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>              $posts = $query-&gt;posts;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $sql = &quot;SELECT ID, post_title, post_excerpt, post_content, post_type, post_password, post_date, post_author FROM $wpdb-&gt;posts AS a INNER JOIN $wpdb-&gt;postmeta AS b ON b.post_id = a.ID&quot;;&nbsp;</div></li><li><div>              $sql .= &quot; AND b.meta_key = '_s2_digest_post_status' AND b.meta_value = 'pending' WHERE post_status IN ($status) AND post_type IN ($type) ORDER BY post_date &quot; . (($this-&gt;subscribe2_options['cron_order'] === 'desc') ? 'DESC' : 'ASC');&nbsp;</div></li><li><div>              $posts = $wpdb-&gt;get_results($sql);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// we are sending a preview</span>&nbsp;</div></li><li><div>          $posts = get_posts('numberposts=1');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Collect sticky posts if desired</span>&nbsp;</div></li><li><div>      if ( $this-&gt;subscribe2_options['stickies'] == 'yes' ) {&nbsp;</div></li><li><div>          $sticky_ids = get_option('sticky_posts');&nbsp;</div></li><li><div>          if ( !empty($sticky_ids) ) {&nbsp;</div></li><li><div>              $sticky_posts = get_posts( array('post__in' =&gt; $sticky_ids) );&nbsp;</div></li><li><div>              $posts = array_merge((array)$sticky_posts, (array)$posts);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// do we have any posts?</span>&nbsp;</div></li><li><div>      if ( empty($posts) && !has_filter('s2_digest_email') ) { return false; }&nbsp;</div></li><li><div>      $this-&gt;post_count = count($posts);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if we have posts, let's prepare the digest</span>&nbsp;</div></li><li><div>      $datetime = get_option('date_format') . ' @ ' . get_option('time_format');&nbsp;</div></li><li><div>      $all_post_cats = array();&nbsp;</div></li><li><div>      $ids = array();&nbsp;</div></li><li><div>      $mailtext = apply_filters('s2_email_template', $this-&gt;subscribe2_options['mailtext']);&nbsp;</div></li><li><div>      $table = '';&nbsp;</div></li><li><div>      $tablelinks = '';&nbsp;</div></li><li><div>      $message_post= '';&nbsp;</div></li><li><div>      $message_posttime = '';&nbsp;</div></li><li><div>      $digest_post_ids = array();&nbsp;</div></li><li><div>      $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>      foreach ( $posts as $post ) {&nbsp;</div></li><li><div>          <span class="comment">// keep an array of post ids and skip if we've already done it once</span>&nbsp;</div></li><li><div>          if ( in_array($post-&gt;ID, $ids) ) { continue; }&nbsp;</div></li><li><div>          $ids[] = $post-&gt;ID;&nbsp;</div></li><li><div>          $post_cats = wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'ids'));&nbsp;</div></li><li><div>          $post_cats_string = implode(', ', $post_cats);&nbsp;</div></li><li><div>          $all_post_cats = array_unique(array_merge($all_post_cats, $post_cats));&nbsp;</div></li><li><div>          $check = false;&nbsp;</div></li><li><div>          <span class="comment">// Pages are put into category 1 so make sure we don't exclude</span>&nbsp;</div></li><li><div>          <span class="comment">// pages if category 1 is excluded</span>&nbsp;</div></li><li><div>          if ( $post-&gt;post_type != 'page' ) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// is the current post assigned to any categories</span></span>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// which should not generate a notification email?</span></span>&nbsp;</div></li><li><div>              foreach ( explode(', ', $this-&gt;subscribe2_options['exclude']) as $cat ) {&nbsp;</div></li><li><div>                  if ( in_array($cat, $post_cats) ) {&nbsp;</div></li><li><div>                      $check = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// is the current post set by the user to</span>&nbsp;</div></li><li><div>          <span class="comment">// not generate a notification email?</span>&nbsp;</div></li><li><div>          $s2mail = get_post_meta($post-&gt;ID, '_s2mail', true);&nbsp;</div></li><li><div>          if ( strtolower(trim($s2mail)) == 'no' ) {&nbsp;</div></li><li><div>              $check = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// is the current post private</span>&nbsp;</div></li><li><div>          <span class="comment">// and should this not generate a notification email?</span>&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['password'] == 'no' && $post-&gt;post_password != '' ) {&nbsp;</div></li><li><div>              $check = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// is the post assigned a format that should</span>&nbsp;</div></li><li><div>          <span class="comment">// not be included in the notification email?</span>&nbsp;</div></li><li><div>          $post_format = get_post_format($post-&gt;ID);&nbsp;</div></li><li><div>          $excluded_formats = explode(', ', $this-&gt;subscribe2_options['exclude_formats']);&nbsp;</div></li><li><div>          if ( $post_format !== false && in_array($post_format, $excluded_formats) ) {&nbsp;</div></li><li><div>              $check = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// if this post is excluded</span>&nbsp;</div></li><li><div>          <span class="comment">// don't include it in the digest</span>&nbsp;</div></li><li><div>          if ( $check ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset($sticky_ids) && !in_array($post-&gt;ID, $sticky_ids) ) {&nbsp;</div></li><li><div>              $digest_post_ids[] = $post-&gt;ID;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $digest_post_ids[] = $post-&gt;ID;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $post_title = html_entity_decode($post-&gt;post_title, ENT_QUOTES);&nbsp;</div></li><li><div>          ('' == $table) ? $table .= &quot;* &quot; . $post_title : $table .= &quot;\r\n* &quot; . $post_title;&nbsp;</div></li><li><div>          ('' == $tablelinks) ? $tablelinks .= &quot;* &quot; . $post_title : $tablelinks .= &quot;\r\n* &quot; . $post_title;&nbsp;</div></li><li><div>          $message_post .= $post_title;&nbsp;</div></li><li><div>          $message_posttime .= $post_title;&nbsp;</div></li><li><div>          if ( strstr($mailtext, &quot;{AUTHORNAME}&quot;) ) {&nbsp;</div></li><li><div>              $author = get_userdata($post-&gt;post_author);&nbsp;</div></li><li><div>              if ( $author-&gt;display_name != '' ) {&nbsp;</div></li><li><div>                  $message_post .= &quot; (&quot; . __('Author', 'subscribe2') . &quot;: &quot; . html_entity_decode(apply_filters('the_author', $author-&gt;display_name), ENT_QUOTES) . &quot;)&quot;;&nbsp;</div></li><li><div>                  $message_posttime .= &quot; (&quot; . __('Author', 'subscribe2') . &quot;: &quot; . html_entity_decode(apply_filters('the_author', $author-&gt;display_name), ENT_QUOTES) . &quot;)&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $message_post .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>          $message_posttime .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $message_posttime .= __('Posted on', 'subscribe2') . &quot;: &quot; . mysql2date($datetime, $post-&gt;post_date) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>          if ( strstr($mailtext, &quot;{TINYLINK}&quot;) ) {&nbsp;</div></li><li><div>              $tinylink = file_get_contents('http:<span class="comment">//tinyurl.com/api-create.php?url=' . urlencode($this-&gt;get_tracking_link(get_permalink($post-&gt;ID))));</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $tinylink = false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( strstr($mailtext, &quot;{TINYLINK}&quot;) && $tinylink !== 'Error' && $tinylink !== false ) {&nbsp;</div></li><li><div>              $tablelinks .= &quot;\r\n&quot; . $tinylink . &quot;\r\n&quot;;&nbsp;</div></li><li><div>              $message_post .= $tinylink . &quot;\r\n&quot;;&nbsp;</div></li><li><div>              $message_posttime .= $tinylink . &quot;\r\n&quot;;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $tablelinks .= &quot;\r\n&quot; . $this-&gt;get_tracking_link(get_permalink($post-&gt;ID)) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>              $message_post .= $this-&gt;get_tracking_link(get_permalink($post-&gt;ID)) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>              $message_posttime .= $this-&gt;get_tracking_link(get_permalink($post-&gt;ID)) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( strstr($mailtext, &quot;{CATS}&quot;) ) {&nbsp;</div></li><li><div>              $post_cat_names = implode(', ', wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>              $message_post .= __('Posted in', 'subscribe2') . &quot;: &quot; . $post_cat_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>              $message_posttime .= __('Posted in', 'subscribe2') . &quot;: &quot; . $post_cat_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( strstr($mailtext, &quot;{TAGS}&quot;) ) {&nbsp;</div></li><li><div>              $post_tag_names = implode(', ', wp_get_post_tags($post-&gt;ID, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>              if ( $post_tag_names != '' ) {&nbsp;</div></li><li><div>                  $message_post .= __('Tagged as', 'subscribe2') . &quot;: &quot; . $post_tag_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                  $message_posttime .= __('Tagged as', 'subscribe2') . &quot;: &quot; . $post_tag_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $message_post .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>          $message_posttime .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ( !empty($post-&gt;post_excerpt) ) ? $excerpt = trim($post-&gt;post_excerpt) : $excerpt = '';&nbsp;</div></li><li><div>          if ( '' == $excerpt ) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// no excerpt, is there a &lt;!--more--&gt; ?</span></span></span>&nbsp;</div></li><li><div>              if ( false !== strpos($post-&gt;post_content, '&lt;!--more--&gt;') ) {&nbsp;</div></li><li><div>                  list($excerpt, $more) = explode('&lt;!--more--&gt;', $post-&gt;post_content, 2);&nbsp;</div></li><li><div>                  $excerpt = strip_tags($excerpt);&nbsp;</div></li><li><div>                  $excerpt = strip_shortcodes($excerpt);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $excerpt = strip_tags($post-&gt;post_content);&nbsp;</div></li><li><div>                  $excerpt = strip_shortcodes($excerpt);&nbsp;</div></li><li><div>                  $words = explode(' ', $excerpt, $this-&gt;excerpt_length + 1);&nbsp;</div></li><li><div>                  if ( count($words) &gt; $this-&gt;excerpt_length ) {&nbsp;</div></li><li><div>                      array_pop($words);&nbsp;</div></li><li><div>                      array_push($words, '[...]');&nbsp;</div></li><li><div>                      $excerpt = implode(' ', $words);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// strip leading and trailing whitespace</span>&nbsp;</div></li><li><div>              $excerpt = trim($excerpt);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $message_post .= $excerpt . &quot;\r\n\r\n&quot;;&nbsp;</div></li><li><div>          $message_posttime .= $excerpt . &quot;\r\n\r\n&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $digest_post_ids as $digest_post_id ) {&nbsp;</div></li><li><div>          update_post_meta($digest_post_id, '_s2_digest_post_status', 'done');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;subscribe2_options['last_s2cron'] = implode(', ', $digest_post_ids);&nbsp;</div></li><li><div>      update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// we add a blank line after each post excerpt now trim white space that occurs for the last post</span>&nbsp;</div></li><li><div>      $message_post = trim($message_post);&nbsp;</div></li><li><div>      $message_posttime = trim($message_posttime);&nbsp;</div></li><li><div>      <span class="comment">// remove excess white space from within $message_post and $message_posttime</span>&nbsp;</div></li><li><div>      $message_post = preg_replace('|[ ]+|', ' ', $message_post);&nbsp;</div></li><li><div>      $message_posttime = preg_replace('|[ ]+|', ' ', $message_posttime);&nbsp;</div></li><li><div>      $message_post = preg_replace(&quot;|[\r\n]{3, }|&quot;, &quot;\r\n\r\n&quot;, $message_post);&nbsp;</div></li><li><div>      $message_posttime = preg_replace(&quot;|[\r\n]{3, }|&quot;, &quot;\r\n\r\n&quot;, $message_posttime);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// apply filter to allow custom keywords</span>&nbsp;</div></li><li><div>      $message_post = apply_filters('s2_custom_keywords', $message_post, $digest_post_ids);&nbsp;</div></li><li><div>      $message_posttime = apply_filters('s2_custom_keywords', $message_posttime, $digest_post_ids);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// apply filter to allow external content to be inserted or content manipulated</span>&nbsp;</div></li><li><div>      $message_post = apply_filters('s2_digest_email', $message_post);&nbsp;</div></li><li><div>      $message_posttime = apply_filters('s2_digest_email', $message_posttime);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//sanity check - don't send a mail if the content is empty</span>&nbsp;</div></li><li><div>      if ( !$message_post && !$message_posttime && !$table && !$tablelinks ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get sender details</span>&nbsp;</div></li><li><div>      if ( $this-&gt;subscribe2_options['sender'] == 'blogname' ) {&nbsp;</div></li><li><div>          $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>          $this-&gt;myemail = get_bloginfo('admin_email');&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $user = $this-&gt;get_userdata($this-&gt;subscribe2_options['sender']);&nbsp;</div></li><li><div>          $this-&gt;myemail = $user-&gt;user_email;&nbsp;</div></li><li><div>          $this-&gt;myname = html_entity_decode($user-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $scheds = (array)wp_get_schedules();&nbsp;</div></li><li><div>      $email_freq = $this-&gt;subscribe2_options['email_freq'];&nbsp;</div></li><li><div>      $display = $scheds[$email_freq]['display'];&nbsp;</div></li><li><div>      ( '' == get_option('blogname') ) ? $subject = &quot;&quot; : $subject = &quot;[&quot; . stripslashes(html_entity_decode(get_option('blogname'), ENT_QUOTES)) . &quot;] &quot;;&nbsp;</div></li><li><div>      $subject .= $display . &quot; &quot; . __('Digest Email', 'subscribe2');&nbsp;</div></li><li><div>      $mailtext = str_replace(&quot;{TABLELINKS}&quot;, $tablelinks, $mailtext);&nbsp;</div></li><li><div>      $mailtext = str_replace(&quot;{TABLE}&quot;, $table, $mailtext);&nbsp;</div></li><li><div>      $mailtext = str_replace(&quot;{POSTTIME}&quot;, $message_posttime, $mailtext);&nbsp;</div></li><li><div>      $mailtext = str_replace(&quot;{POST}&quot;, $message_post, $mailtext);&nbsp;</div></li><li><div>      $mailtext = stripslashes($this-&gt;substitute($mailtext));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// prepare recipients</span>&nbsp;</div></li><li><div>      if ( $preview != '' ) {&nbsp;</div></li><li><div>          $this-&gt;myemail = $preview;&nbsp;</div></li><li><div>          $this-&gt;myname = __('Digest Preview', 'subscribe2');&nbsp;</div></li><li><div>          $this-&gt;mail(array($preview), $subject, $mailtext);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $public = $this-&gt;get_public();&nbsp;</div></li><li><div>          $all_post_cats_string = implode(', ', $all_post_cats);&nbsp;</div></li><li><div>          $registered = $this-&gt;get_registered(&quot;cats=$all_post_cats_string&quot;);&nbsp;</div></li><li><div>          $recipients = array_merge((array)$public, (array)$registered);&nbsp;</div></li><li><div>          $this-&gt;mail($recipients, $subject, $mailtext);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end subscribe2_cron()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function s2cleaner_task() {&nbsp;</div></li><li><div>      $unconfirmed = $this-&gt;get_public('0');&nbsp;</div></li><li><div>      if ( empty($unconfirmed) ) { return; }&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $sql = &quot;SELECT email FROM $this-&gt;public WHERE active='0' AND date &lt; DATE_SUB(CURDATE(), INTERVAL &quot; . $this-&gt;clean_interval . &quot; DAY)&quot;;&nbsp;</div></li><li><div>      $old_unconfirmed = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>      if ( empty($old_unconfirmed) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          foreach ( $old_unconfirmed as $email ) {&nbsp;</div></li><li><div>              $this-&gt;delete($email);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  } <span class="comment">// end s2cleaner_task()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Jetpack comments doesn't play nice, this function kills that module</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function s2_hide_jetpack_comments($modules) {&nbsp;</div></li><li><div>      unset($modules['comments']);&nbsp;</div></li><li><div>      return $modules;&nbsp;</div></li><li><div>  } <span class="comment">// end s2_kill_jetpack_comments()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== Our constructor ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  Subscribe2 constructor</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function s2init() {&nbsp;</div></li><li><div>      global $wpdb, $wp_version, $wpmu_version;&nbsp;</div></li><li><div>      <span class="comment">// load the options</span>&nbsp;</div></li><li><div>      $this-&gt;subscribe2_options = get_option('subscribe2_options');&nbsp;</div></li><li><div>      <span class="comment">// if SCRIPT_DEBUG is true, use dev scripts</span>&nbsp;</div></li><li><div>      $this-&gt;script_debug = ( defined('SCRIPT_DEBUG') && SCRIPT_DEBUG ) ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// get the WordPress release number for in code version comparisons</span>&nbsp;</div></li><li><div>      $tmp = explode('-', $wp_version, 2);&nbsp;</div></li><li><div>      $this-&gt;wp_release = $tmp[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Is this WordPressMU or not?</span></span>&nbsp;</div></li><li><div>      if ( isset($wpmu_version) || strpos($wp_version, 'wordpress-mu') ) {&nbsp;</div></li><li><div>          $this-&gt;s2_mu = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( function_exists('is_multisite') && is_multisite() ) {&nbsp;</div></li><li><div>          $this-&gt;s2_mu = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add action to handle WPMU subscriptions and unsubscriptions</span>&nbsp;</div></li><li><div>      if ( $this-&gt;s2_mu === true ) {&nbsp;</div></li><li><div>          require_once(S2PATH . &quot;classes/class-s2-multisite.php&quot;);&nbsp;</div></li><li><div>          global $s2class_multisite;&nbsp;</div></li><li><div>          $s2class_multisite = new s2_multisite;&nbsp;</div></li><li><div>          if ( isset($_GET['s2mu_subscribe']) || isset($_GET['s2mu_unsubscribe']) ) {&nbsp;</div></li><li><div>              add_action('init', array(&$s2class_multisite, 'wpmu_subscribe'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// load our translations</span>&nbsp;</div></li><li><div>      add_action('plugins_loaded', array(&$this, 'load_translations'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// do we need to install anything?</span>&nbsp;</div></li><li><div>      $this-&gt;public = $wpdb-&gt;prefix . &quot;subscribe2&quot;;&nbsp;</div></li><li><div>      if ( $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SHOW TABLES LIKE %s&quot;, $this-&gt;public)) != $this-&gt;public ) { $this-&gt;install(); }&nbsp;</div></li><li><div>      <span class="comment">//do we need to upgrade anything?</span>&nbsp;</div></li><li><div>      if ( $this-&gt;subscribe2_options === false || is_array($this-&gt;subscribe2_options) && $this-&gt;subscribe2_options['version'] !== S2VERSION ) {&nbsp;</div></li><li><div>          add_action('shutdown', array(&$this, 'upgrade'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add core actions</span>&nbsp;</div></li><li><div>      add_filter('cron_schedules', array(&$this, 'add_weekly_sched'), 20);&nbsp;</div></li><li><div>      <span class="comment">// add actions for automatic subscription based on option settings</span>&nbsp;</div></li><li><div>      if ( $this-&gt;s2_mu ) {&nbsp;</div></li><li><div>          add_action('wpmu_activate_user', array(&$s2class_multisite, 'wpmu_add_user'));&nbsp;</div></li><li><div>          add_action('add_user_to_blog', array(&$s2class_multisite, 'wpmu_add_user'), 10);&nbsp;</div></li><li><div>          add_action('remove_user_from_blog', array(&$s2class_multisite, 'wpmu_remove_user'), 10);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          add_action('register_form', array(&$this, 'register_form'));&nbsp;</div></li><li><div>          add_action('user_register', array(&$this, 'register_post'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// add actions for processing posts based on per-post or cron email settings</span>&nbsp;</div></li><li><div>      if ( $this-&gt;subscribe2_options['email_freq'] != 'never' ) {&nbsp;</div></li><li><div>          add_action('s2_digest_cron', array(&$this, 'subscribe2_cron'));&nbsp;</div></li><li><div>          add_action('transition_post_status', array(&$this, 'digest_post_transitions'), 10, 3);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $statuses = apply_filters('s2_post_statuses', array('new', 'draft', 'auto-draft', 'pending'));&nbsp;</div></li><li><div>          if ( $this-&gt;subscribe2_options['private'] == 'yes' ) {&nbsp;</div></li><li><div>              foreach ( $statuses as $status ) {&nbsp;</div></li><li><div>                  add_action(&quot;{$status}_to_private&quot;, array(&$this, 'publish'));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          array_push($statuses, 'private', 'future');&nbsp;</div></li><li><div>          foreach ( $statuses as $status ) {&nbsp;</div></li><li><div>              add_action(&quot;{$status}_to_publish&quot;, array(&$this, 'publish'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// add actions for comment subscribers</span>&nbsp;</div></li><li><div>      if ( 'no' !== $this-&gt;subscribe2_options['comment_subs'] ) {&nbsp;</div></li><li><div>          add_filter('jetpack_get_available_modules', array(&$this, 's2_hide_jetpack_comments'));&nbsp;</div></li><li><div>          if ( 'before' == $this-&gt;subscribe2_options['comment_subs'] ) {&nbsp;</div></li><li><div>              add_action('comment_form_after_fields', array(&$this, 's2_comment_meta_form'));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              add_action('comment_form', array(&$this, 's2_comment_meta_form'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          add_action('comment_post', array(&$this, 's2_comment_meta'), 1, 2);&nbsp;</div></li><li><div>          add_action('wp_set_comment_status', array(&$this, 'comment_status'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// add action to display widget if option is enabled</span>&nbsp;</div></li><li><div>      if ( '1' == $this-&gt;subscribe2_options['widget'] ) {&nbsp;</div></li><li><div>          add_action('widgets_init', array(&$this, 'subscribe2_widget'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// add action to display counter widget if option is enabled</span>&nbsp;</div></li><li><div>      if ( '1' == $this-&gt;subscribe2_options['counterwidget'] ) {&nbsp;</div></li><li><div>          add_action('widgets_init', array(&$this, 'counter_widget'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// add action to 'clean' unconfirmed Public Subscribers</span>&nbsp;</div></li><li><div>      if ( $this-&gt;clean_interval &gt; 0 ) {&nbsp;</div></li><li><div>          add_action('wp_scheduled_delete', array(&$this, 's2cleaner_task'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add actions specific to admin or frontend</span>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          <span class="comment">//add menu, authoring and category admin actions</span>&nbsp;</div></li><li><div>          add_action('admin_menu', array(&$this, 'admin_menu'));&nbsp;</div></li><li><div>          add_action('admin_menu', array(&$this, 's2_meta_init'));&nbsp;</div></li><li><div>          add_action('save_post', array(&$this, 's2_meta_handler'));&nbsp;</div></li><li><div>          add_action('create_category', array(&$this, 'new_category'));&nbsp;</div></li><li><div>          add_action('delete_category', array(&$this, 'delete_category'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add filters for Ozh Admin Menu</span>&nbsp;</div></li><li><div>          if ( function_exists('wp_ozh_adminmenu') ) {&nbsp;</div></li><li><div>              add_filter('ozh_adminmenu_icon_s2_posts', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>              add_filter('ozh_adminmenu_icon_s2_users', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>              add_filter('ozh_adminmenu_icon_s2_tools', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>              add_filter('ozh_adminmenu_icon_s2_settings', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add write button</span>&nbsp;</div></li><li><div>          if ( '1' == $this-&gt;subscribe2_options['show_button'] ) {&nbsp;</div></li><li><div>              add_action('admin_init', array(&$this, 'button_init'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add counterwidget css and js</span>&nbsp;</div></li><li><div>          if ( '1' == $this-&gt;subscribe2_options['counterwidget'] ) {&nbsp;</div></li><li><div>              add_action('admin_init', array(&$this, 'widget_s2counter_css_and_js'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add one-click handlers</span>&nbsp;</div></li><li><div>          if ( 'yes' == $this-&gt;subscribe2_options['one_click_profile'] ) {&nbsp;</div></li><li><div>              add_action( 'show_user_profile', array(&$this, 'one_click_profile_form') );&nbsp;</div></li><li><div>              add_action( 'edit_user_profile', array(&$this, 'one_click_profile_form') );&nbsp;</div></li><li><div>              add_action( 'personal_options_update', array(&$this, 'one_click_profile_form_save') );&nbsp;</div></li><li><div>              add_action( 'edit_user_profile_update', array(&$this, 'one_click_profile_form_save') );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// capture CSV export</span>&nbsp;</div></li><li><div>          if ( isset($_POST['s2_admin']) && isset($_POST['csv']) ) {&nbsp;</div></li><li><div>              $date = date('Y-m-d');&nbsp;</div></li><li><div>              header(&quot;Content-Description: File Transfer&quot;);&nbsp;</div></li><li><div>              header(&quot;Content-type: application/octet-stream&quot;);&nbsp;</div></li><li><div>              header(&quot;Content-Disposition: attachment; filename=subscribe2_users_$date.csv&quot;);&nbsp;</div></li><li><div>              header(&quot;Pragma: no-cache&quot;);&nbsp;</div></li><li><div>              header(&quot;Expires: 0&quot;);&nbsp;</div></li><li><div>              echo $this-&gt;prepare_export($_POST['exportcsv']);&nbsp;</div></li><li><div>              exit(0);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// load strings later on frontend for polylang plugin compatibility</span>&nbsp;</div></li><li><div>          add_action('wp', array(&$this, 'load_strings'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset($_GET['s2']) ) {&nbsp;</div></li><li><div>              <span class="comment">// someone is confirming a request</span>&nbsp;</div></li><li><div>              if ( defined('DOING_S2_CONFIRM') && DOING_S2_CONFIRM ) { return; }&nbsp;</div></li><li><div>              define( 'DOING_S2_CONFIRM', true );&nbsp;</div></li><li><div>              add_filter('request', array(&$this, 'query_filter'));&nbsp;</div></li><li><div>              add_filter('the_title', array(&$this, 'title_filter'));&nbsp;</div></li><li><div>              add_filter('the_content', array(&$this, 'confirm'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add the frontend filters</span>&nbsp;</div></li><li><div>          add_shortcode('subscribe2', array(&$this, 'shortcode'));&nbsp;</div></li><li><div>          add_filter('the_content', array(&$this, 'filter'), 10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add actions for other plugins</span>&nbsp;</div></li><li><div>          if ( '1' == $this-&gt;subscribe2_options['show_meta'] ) {&nbsp;</div></li><li><div>              add_action('wp_meta', array(&$this, 'add_minimeta'), 0);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// add actions for ajax form if enabled</span>&nbsp;</div></li><li><div>          if ( '1' == $this-&gt;subscribe2_options['ajax'] ) {&nbsp;</div></li><li><div>              add_action('wp_enqueue_scripts', array(&$this, 'add_ajax'));&nbsp;</div></li><li><div>              add_action('wp_footer', array(&$this, 'add_s2_ajax'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } <span class="comment">// end s2init()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  PHP5 Constructor</span>&nbsp;</div></li><li><div><span class="comment">  Allows dynamic variable setting</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      $this-&gt;word_wrap = apply_filters('s2_word_wrap', 80);&nbsp;</div></li><li><div>      $this-&gt;excerpt_length = apply_filters('s2_excerpt_length', 55);&nbsp;</div></li><li><div>      $this-&gt;site_switching = apply_filters('s2_allow_site_switching', false);&nbsp;</div></li><li><div>      $this-&gt;clean_interval = apply_filters('s2_clean_interval', 28);&nbsp;</div></li><li><div>      $this-&gt;lockout = apply_filters('s2_lockout', 0);&nbsp;</div></li><li><div>  } <span class="comment">// end __construct()</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/** ===== our variables ===== */</span>&nbsp;</div></li><li><div>  <span class="comment">// cache variables</span>&nbsp;</div></li><li><div>  var $subscribe2_options = array();&nbsp;</div></li><li><div>  var $all_confirmed = '';&nbsp;</div></li><li><div>  var $all_unconfirmed = '';&nbsp;</div></li><li><div>  var $all_registered_id = '';&nbsp;</div></li><li><div>  var $all_registered_email = '';&nbsp;</div></li><li><div>  var $all_authors = '';&nbsp;</div></li><li><div>  var $excluded_cats = '';&nbsp;</div></li><li><div>  var $post_title = '';&nbsp;</div></li><li><div>  var $permalink = '';&nbsp;</div></li><li><div>  var $post_date = '';&nbsp;</div></li><li><div>  var $post_time = '';&nbsp;</div></li><li><div>  var $myname = '';&nbsp;</div></li><li><div>  var $myemail = '';&nbsp;</div></li><li><div>  var $authorname = '';&nbsp;</div></li><li><div>  var $post_cat_names = '';&nbsp;</div></li><li><div>  var $post_tag_names = '';&nbsp;</div></li><li><div>  var $post_count = '';&nbsp;</div></li><li><div>  var $signup_dates = array();&nbsp;</div></li><li><div>  var $filtered = 0;&nbsp;</div></li><li><div>  var $preview_email = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// state variables used to affect processing</span>&nbsp;</div></li><li><div>  var $s2_mu = false;&nbsp;</div></li><li><div>  var $action = '';&nbsp;</div></li><li><div>  var $email = '';&nbsp;</div></li><li><div>  var $message = '';&nbsp;</div></li><li><div>  var $word_wrap;&nbsp;</div></li><li><div>  var $excerpt_length;&nbsp;</div></li><li><div>  var $site_switching;&nbsp;</div></li><li><div>  var $clean_interval;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// some messages</span>&nbsp;</div></li><li><div>  var $please_log_in = '';&nbsp;</div></li><li><div>  var $profile = '';&nbsp;</div></li><li><div>  var $confirmation_sent = '';&nbsp;</div></li><li><div>  var $already_subscribed = '';&nbsp;</div></li><li><div>  var $not_subscribed ='';&nbsp;</div></li><li><div>  var $not_an_email = '';&nbsp;</div></li><li><div>  var $barred_domain = '';&nbsp;</div></li><li><div>  var $error = '';&nbsp;</div></li><li><div>  var $mail_sent = '';&nbsp;</div></li><li><div>  var $mail_failed = '';&nbsp;</div></li><li><div>  var $form = '';&nbsp;</div></li><li><div>  var $no_such_email = '';&nbsp;</div></li><li><div>  var $added = '';&nbsp;</div></li><li><div>  var $deleted = '';&nbsp;</div></li><li><div>  var $subscribe = '';&nbsp;</div></li><li><div>  var $unsubscribe = '';&nbsp;</div></li><li><div>  var $confirm_subject = '';&nbsp;</div></li><li><div>} <span class="comment">// end class subscribe2</span>&nbsp;</div></li><li><div>?&gt;&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Subscribe2</li><li><span></span>9.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>