<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="9.2" data-slug="subscribe2" data-type="class" data-id="7385"><head xmlns="http://www.w3.org/1999/xhtml"><title> s2class | class | Subscribe2 | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="s2class, class, plugin, subscribe2, 9.2" /><meta name="description" content="The Subscribe2 s2class class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.24"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=914475c82e688a9bbd3d8dc4e11278ff' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.24' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/s2class/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fs2class%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fs2class%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-subscribe2-9.2-class-s2class","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="s2class" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to subscribe2." href="http://hookr.io/plugins/subscribe2/" class="plugin"><span property="name">subscribe2</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 9.2." href="http://hookr.io/plugins/subscribe2/9.2/" class="H_VERSION"><span property="name">9.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/subscribe2/9.2/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">s2class</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="65"><a href="http://hookr.io/plugins/subscribe2/9.2/all/" title="All">All <span class="count badge">65</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/subscribe2/9.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="50"><a href="http://hookr.io/plugins/subscribe2/9.2/hooks/" title="Hooks">Hooks <span class="count badge">50</span></a></li><li class="" data-id="action" data-count="2"><a href="http://hookr.io/plugins/subscribe2/9.2/actions/" title="Actions">Actions <span class="count badge">2</span></a></li><li class="" data-id="filter" data-count="48"><a href="http://hookr.io/plugins/subscribe2/9.2/filters/" title="Filters">Filters <span class="count badge">48</span></a></li><li class="active" data-id="class" data-count="8"><a href="http://hookr.io/plugins/subscribe2/9.2/classes/" title="Classes">Classes <span class="count badge">8</span></a></li><li class="" data-id="constant" data-count="6"><a href="http://hookr.io/plugins/subscribe2/9.2/constants/" title="Constants">Constants <span class="count badge">6</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/subscribe2/9.2/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/subscribe2/9.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>s2class</strong></h1><p>The Subscribe2 <strong>s2class</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/subscribe2/9.2/files/classes-class-s2-core/" class="file">/classes/class-s2-core.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="2" class="block" start="2"><li><div>class s2class {&nbsp;</div></li><li><div>// variables and constructor are declared at the end&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Load translations&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function load_translations() {&nbsp;</div></li><li><div>        load_plugin_textdomain('subscribe2', false, S2DIR);&nbsp;</div></li><li><div>        load_plugin_textdomain('subscribe2', false, S2DIR . &quot;languages/&quot;);&nbsp;</div></li><li><div>        $mofile = WP_LANG_DIR . '/subscribe2-' . apply_filters('plugin_locale', get_locale(), 'subscribe2') . '.mo';&nbsp;</div></li><li><div>        load_textdomain('subscribe2', $mofile);&nbsp;</div></li><li><div>    } // end load_translations()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Load all our strings&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function load_strings() {&nbsp;</div></li><li><div>        // adjust the output of Subscribe2 here&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;please_log_in = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . sprintf(__('To manage your subscription options please &lt;a href=&quot;%1$s&quot;&gt;login.&lt;/a&gt;', 'subscribe2'), get_option('siteurl') . '/wp-login.php') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;profile = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . sprintf(__('You may manage your subscription options from your &lt;a href=&quot;%1$s&quot;&gt;profile&lt;/a&gt;', 'subscribe2'), get_option('siteurl') . &quot;/wp-admin/admin.php?page=s2&quot;) . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu === true ) {&nbsp;</div></li><li><div>            global $blog_id;&nbsp;</div></li><li><div>            $user_ID = get_current_user_id();&nbsp;</div></li><li><div>            if ( !is_user_member_of_blog($user_ID, $blog_id) ) {&nbsp;</div></li><li><div>                // if we are on multisite and the user is not a member of this blog change the link&nbsp;</div></li><li><div>                $this-&gt;profile = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . sprintf(__('&lt;a href=&quot;%1$s&quot;&gt;Subscribe&lt;/a&gt; to email notifications when this blog posts new content.', 'subscribe2'), get_option('siteurl') . &quot;/wp-admin/?s2mu_subscribe=&quot; . $blog_id) . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;confirmation_sent = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . __('A confirmation message is on its way!', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;already_subscribed = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('That email address is already subscribed.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;not_subscribed = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('That email address is not subscribed.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;not_an_email = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('Sorry, but that does not look like an email address to me.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;barred_domain = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('Sorry, email addresses at that domain are currently barred due to spam, please use an alternative email address.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;error = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('Sorry, there seems to be an error on the server. Please try again later.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;no_page = __('You must create a WordPress page for this plugin to work correctly.', 'subscribe2');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;mail_sent = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . __('Message sent!', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;mail_failed = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('Message failed!', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // confirmation messages&nbsp;</div></li><li><div>        $this-&gt;no_such_email = &quot;&lt;p class=\&quot;s2_error\&quot;&gt;&quot; . __('No such email address is registered.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;added = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . __('You have successfully subscribed!', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;deleted = &quot;&lt;p class=\&quot;s2_message\&quot;&gt;&quot; . __('You have successfully unsubscribed.', 'subscribe2') . &quot;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;subscribe = __('subscribe', 'subscribe2'); //ACTION replacement in subscribing confirmation email&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;unsubscribe = __('unsubscribe', 'subscribe2'); //ACTION replacement in unsubscribing in confirmation email&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // menu strings&nbsp;</div></li><li><div>        $this-&gt;options_saved = __('Options saved!', 'subscribe2');&nbsp;</div></li><li><div>        $this-&gt;options_reset = __('Options reset!', 'subscribe2');&nbsp;</div></li><li><div>    } // end load_strings()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== Install, upgrade, reset ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Install our table&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function install() {&nbsp;</div></li><li><div>        // load our translations and strings&nbsp;</div></li><li><div>        $this-&gt;load_translations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // include upgrade-functions for maybe_create_table;&nbsp;</div></li><li><div>        if ( !function_exists('maybe_create_table') ) {&nbsp;</div></li><li><div>            require_once(ABSPATH . 'wp-admin/install-helper.php');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $date = date('Y-m-d');&nbsp;</div></li><li><div>        $sql = &quot;CREATE TABLE $this-&gt;public (&nbsp;</div></li><li><div>            id int(11) NOT NULL auto_increment, &nbsp;</div></li><li><div>            email varchar(64) NOT NULL default '', &nbsp;</div></li><li><div>            active tinyint(1) default 0, &nbsp;</div></li><li><div>            date DATE default '$date' NOT NULL, &nbsp;</div></li><li><div>            time TIME DEFAULT '00:00:00' NOT NULL, &nbsp;</div></li><li><div>            ip char(64) NOT NULL default 'admin', &nbsp;</div></li><li><div>            conf_date DATE, &nbsp;</div></li><li><div>            conf_time TIME, &nbsp;</div></li><li><div>            conf_ip char(64), &nbsp;</div></li><li><div>            PRIMARY KEY (id) )&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create the table, as needed&nbsp;</div></li><li><div>        maybe_create_table($this-&gt;public, $sql);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create table entries for registered users&nbsp;</div></li><li><div>        $users = $this-&gt;get_all_registered('ID');&nbsp;</div></li><li><div>        if ( !empty($users) ) {&nbsp;</div></li><li><div>            foreach ( $users as $user_ID ) {&nbsp;</div></li><li><div>                $check_format = get_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), true);&nbsp;</div></li><li><div>                if ( empty($check_format) ) {&nbsp;</div></li><li><div>                    // no prior settings so create them&nbsp;</div></li><li><div>                    $this-&gt;register($user_ID);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // safety check if options exist and if not create them&nbsp;</div></li><li><div>        if ( !is_array($this-&gt;subscribe2_options) ) {&nbsp;</div></li><li><div>            $this-&gt;reset();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end install()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Upgrade function for the database and settings&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function upgrade() {&nbsp;</div></li><li><div>        // load our translations and strings&nbsp;</div></li><li><div>        $this-&gt;load_translations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require(S2PATH . &quot;classes/class-s2-upgrade.php&quot;);&nbsp;</div></li><li><div>        global $s2_upgrade;&nbsp;</div></li><li><div>        $s2_upgrade = new s2class_upgrade;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure that the options are in the database&nbsp;</div></li><li><div>        require(S2PATH . &quot;include/options.php&quot;);&nbsp;</div></li><li><div>        // catch older versions that didn't use serialised options&nbsp;</div></li><li><div>        if ( !isset($this-&gt;subscribe2_options['version']) ) {&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '2.0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // let's take the time to ensure that database entries exist for all registered users&nbsp;</div></li><li><div>        $s2_upgrade-&gt;upgrade_core();&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '2.3', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade23();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '2.3';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '5.1', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade51();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '5.1';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '5.6', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade56();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '5.6';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '5.9', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade59();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '5.9';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '6.4', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade64();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '6.4';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '7.0', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade70();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '7.0';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '8.5', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade85();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '8.5';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '8.6', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade86();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '8.6';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( version_compare($this-&gt;subscribe2_options['version'], '8.8', '&lt;') ) {&nbsp;</div></li><li><div>            $s2_upgrade-&gt;upgrade88();&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['version'] = '8.8';&nbsp;</div></li><li><div>            update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;subscribe2_options['version'] = S2VERSION;&nbsp;</div></li><li><div>        update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>    } // end upgrade()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Reset our options&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function reset() {&nbsp;</div></li><li><div>        // load our translations and strings&nbsp;</div></li><li><div>        $this-&gt;load_translations();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        delete_option('subscribe2_options');&nbsp;</div></li><li><div>        wp_clear_scheduled_hook('s2_digest_cron');&nbsp;</div></li><li><div>        unset($this-&gt;subscribe2_options);&nbsp;</div></li><li><div>        require(S2PATH . &quot;include/options.php&quot;);&nbsp;</div></li><li><div>        $this-&gt;subscribe2_options['version'] = S2VERSION;&nbsp;</div></li><li><div>        update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>    } // end reset()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== mail handling ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Performs string substitutions for subscribe2 mail tags&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function substitute($string = '') {&nbsp;</div></li><li><div>        if ( '' == $string ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $string = str_replace(&quot;{BLOGNAME}&quot;, html_entity_decode(get_option('blogname'), ENT_QUOTES), $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{BLOGLINK}&quot;, get_option('home'), $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{TITLE}&quot;, stripslashes($this-&gt;post_title), $string);&nbsp;</div></li><li><div>        $link = &quot;&lt;a href=\&quot;&quot; . $this-&gt;get_tracking_link($this-&gt;permalink) . &quot;\&quot;&gt;&quot; . $this-&gt;get_tracking_link($this-&gt;permalink) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>        $string = str_replace(&quot;{PERMALINK}&quot;, $link, $string);&nbsp;</div></li><li><div>        if ( strstr($string, &quot;{TINYLINK}&quot;) ) {&nbsp;</div></li><li><div>            $tinylink = file_get_contents('http://tinyurl.com/api-create.php?url=' . urlencode($this-&gt;get_tracking_link($this-&gt;permalink)));&nbsp;</div></li><li><div>            if ( $tinylink !== 'Error' && $tinylink != false ) {&nbsp;</div></li><li><div>                $tlink = &quot;&lt;a href=\&quot;&quot; . $tinylink . &quot;\&quot;&gt;&quot; . $tinylink . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>                $string = str_replace(&quot;{TINYLINK}&quot;, $tlink, $string);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $string = str_replace(&quot;{TINYLINK}&quot;, $link, $string);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $string = str_replace(&quot;{DATE}&quot;, $this-&gt;post_date, $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{TIME}&quot;, $this-&gt;post_time, $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{MYNAME}&quot;, stripslashes($this-&gt;myname), $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{EMAIL}&quot;, $this-&gt;myemail, $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{AUTHORNAME}&quot;, stripslashes($this-&gt;authorname), $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{CATS}&quot;, $this-&gt;post_cat_names, $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{TAGS}&quot;, $this-&gt;post_tag_names, $string);&nbsp;</div></li><li><div>        $string = str_replace(&quot;{COUNT}&quot;, $this-&gt;post_count, $string);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $string;&nbsp;</div></li><li><div>    } // end substitute()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Delivers email to recipients in HTML or plaintext&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function mail($recipients = array(), $subject = '', $message = '', $type = 'text', $attachments = array()) {&nbsp;</div></li><li><div>        if ( empty($recipients) || '' == $message ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Replace any escaped html symbols in subject then apply filter&nbsp;</div></li><li><div>        $subject = strip_tags(html_entity_decode($subject, ENT_QUOTES));&nbsp;</div></li><li><div>        $subject = apply_filters('s2_email_subject', $subject);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'html' == $type ) {&nbsp;</div></li><li><div>            $headers = $this-&gt;headers('html', $attachments);&nbsp;</div></li><li><div>            if ( 'yes' == $this-&gt;subscribe2_options['stylesheet'] ) {&nbsp;</div></li><li><div>                $mailtext = apply_filters('s2_html_email', &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;&quot; . $subject . &quot;&lt;/title&gt;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;&quot; . get_stylesheet_uri() . &quot;\&quot; type=\&quot;text/css\&quot; media=\&quot;screen\&quot; /&gt;&lt;/head&gt;&lt;body&gt;&quot; . $message . &quot;&lt;/body&gt;&lt;/html&gt;&quot;, $subject, $message);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $mailtext = apply_filters('s2_html_email', &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;&quot; . $subject . &quot;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot; . $message . &quot;&lt;/body&gt;&lt;/html&gt;&quot;, $subject, $message);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $headers = $this-&gt;headers('text', $attachments);&nbsp;</div></li><li><div>            $message = preg_replace('|&[^a][^m][^p].{0, 3};|', '', $message);&nbsp;</div></li><li><div>            $message = preg_replace('|&amp;|', '&', $message);&nbsp;</div></li><li><div>            $message = wordwrap(strip_tags($message), $this-&gt;word_wrap, &quot;\n&quot;);&nbsp;</div></li><li><div>            $mailtext = apply_filters('s2_plain_email', $message);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Construct BCC headers for sending or send individual emails&nbsp;</div></li><li><div>        $bcc = '';&nbsp;</div></li><li><div>        natcasesort($recipients);&nbsp;</div></li><li><div>        if ( function_exists('wpmq_mail') || $this-&gt;subscribe2_options['bcclimit'] == 1 || count($recipients) == 1 ) {&nbsp;</div></li><li><div>            // BCCLimit is 1 so send individual emails or we only have 1 recipient&nbsp;</div></li><li><div>            foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>                $recipient = trim($recipient);&nbsp;</div></li><li><div>                // sanity check -- make sure we have a valid email&nbsp;</div></li><li><div>                if ( !is_email($recipient) || empty($recipient) ) { continue; }&nbsp;</div></li><li><div>                // Use the mail queue provided we are not sending a preview&nbsp;</div></li><li><div>                if ( function_exists('wpmq_mail') && !$this-&gt;preview_email ) {&nbsp;</div></li><li><div>                    @wp_mail($recipient, $subject, $mailtext, $headers, $attachments, 0);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    @wp_mail($recipient, $subject, $mailtext, $headers, $attachments);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } elseif ( $this-&gt;subscribe2_options['bcclimit'] == 0 ) {&nbsp;</div></li><li><div>            // we're not using BCCLimit&nbsp;</div></li><li><div>            foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>                $recipient = trim($recipient);&nbsp;</div></li><li><div>                // sanity check -- make sure we have a valid email&nbsp;</div></li><li><div>                if ( !is_email($recipient) ) { continue; }&nbsp;</div></li><li><div>                // and NOT the sender's email, since they'll get a copy anyway&nbsp;</div></li><li><div>                if ( !empty($recipient) && $this-&gt;myemail != $recipient ) {&nbsp;</div></li><li><div>                    ('' == $bcc) ? $bcc = &quot;Bcc: $recipient&quot; : $bcc .= &quot;, $recipient&quot;;&nbsp;</div></li><li><div>                    // Bcc Headers now constructed by phpmailer class&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $headers .= &quot;$bcc\n&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // we're using BCCLimit&nbsp;</div></li><li><div>            $count = 1;&nbsp;</div></li><li><div>            $batch = array();&nbsp;</div></li><li><div>            foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>                $recipient = trim($recipient);&nbsp;</div></li><li><div>                // sanity check -- make sure we have a valid email&nbsp;</div></li><li><div>                if ( !is_email($recipient) ) { continue; }&nbsp;</div></li><li><div>                // and NOT the sender's email, since they'll get a copy anyway&nbsp;</div></li><li><div>                if ( !empty($recipient) && $this-&gt;myemail != $recipient ) {&nbsp;</div></li><li><div>                    ('' == $bcc) ? $bcc = &quot;Bcc: $recipient&quot; : $bcc .= &quot;, $recipient&quot;;&nbsp;</div></li><li><div>                    // Bcc Headers now constructed by phpmailer class&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $this-&gt;subscribe2_options['bcclimit'] == $count ) {&nbsp;</div></li><li><div>                    $count = 0;&nbsp;</div></li><li><div>                    $batch[] = $bcc;&nbsp;</div></li><li><div>                    $bcc = '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $count++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // add any partially completed batches to our batch array&nbsp;</div></li><li><div>            if ( '' != $bcc ) {&nbsp;</div></li><li><div>                $batch[] = $bcc;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // rewind the array, just to be safe&nbsp;</div></li><li><div>        reset($recipients);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // actually send mail&nbsp;</div></li><li><div>        if ( isset($batch) && !empty($batch) ) {&nbsp;</div></li><li><div>            foreach ( $batch as $bcc ) {&nbsp;</div></li><li><div>                    $newheaders = $headers . &quot;$bcc\n&quot;;&nbsp;</div></li><li><div>                    $status = @wp_mail($this-&gt;myemail, $subject, $mailtext, $newheaders, $attachments);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = @wp_mail($this-&gt;myemail, $subject, $mailtext, $headers, $attachments);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $status;&nbsp;</div></li><li><div>    } // end mail()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Construct standard set of email headers&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function headers($type = 'text', $attachments = array()) {&nbsp;</div></li><li><div>        if ( empty($this-&gt;myname) || empty($this-&gt;myemail) ) {&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['sender'] == 'blogname' ) {&nbsp;</div></li><li><div>                $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>                $this-&gt;myemail = get_option('admin_email');&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $admin = $this-&gt;get_userdata($this-&gt;subscribe2_options['sender']);&nbsp;</div></li><li><div>                $this-&gt;myname = html_entity_decode($admin-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>                $this-&gt;myemail = $admin-&gt;user_email;&nbsp;</div></li><li><div>                // fail safe to ensure sender details are not empty&nbsp;</div></li><li><div>                if ( empty($this-&gt;myname) ) {&nbsp;</div></li><li><div>                    $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( empty($this-&gt;myemail) ) {&nbsp;</div></li><li><div>                    // Get the site domain and get rid of www.&nbsp;</div></li><li><div>                    $sitename = strtolower( $_SERVER['SERVER_NAME'] );&nbsp;</div></li><li><div>                    if ( substr( $sitename, 0, 4 ) == 'www.' ) {&nbsp;</div></li><li><div>                        $sitename = substr( $sitename, 4 );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $this-&gt;myemail = 'wordpress@' . $sitename;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( function_exists('mb_encode_mimeheader') ) {&nbsp;</div></li><li><div>            $header['From'] = mb_encode_mimeheader($this-&gt;myname, 'UTF-8', 'Q') . &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>            $header['Reply-To'] = mb_encode_mimeheader($this-&gt;myname, 'UTF-8', 'Q') . &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $header['From'] = $this-&gt;myname. &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>            $header['Reply-To'] = $this-&gt;myname . &quot; &lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $header['Return-path'] = &quot;&lt;&quot; . $this-&gt;myemail . &quot;&gt;&quot;;&nbsp;</div></li><li><div>        $header['Precedence'] = &quot;list\nList-Id: &quot; . html_entity_decode(get_option('blogname'), ENT_QUOTES) . &quot;&quot;;&nbsp;</div></li><li><div>        if ( empty($attachments) && $type == 'html' ) {&nbsp;</div></li><li><div>            // To send HTML mail, the Content-Type header must be set&nbsp;</div></li><li><div>            $header['Content-Type'] = get_option('html_type') . &quot;; charset=\&quot;&quot;. get_option('blog_charset') . &quot;\&quot;&quot;;&nbsp;</div></li><li><div>        } elseif ( empty($attachments) && $type == 'text' ) {&nbsp;</div></li><li><div>            $header['Content-Type'] = &quot;text/plain; charset=\&quot;&quot;. get_option('blog_charset') . &quot;\&quot;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // apply header filter to allow on-the-fly amendments&nbsp;</div></li><li><div>        $header = apply_filters('s2_email_headers', $header);&nbsp;</div></li><li><div>        // collapse the headers using $key as the header name&nbsp;</div></li><li><div>        foreach ( $header as $key =&gt; $value ) {&nbsp;</div></li><li><div>            $headers[$key] = $key . &quot;: &quot; . $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $headers = implode(&quot;\n&quot;, $headers);&nbsp;</div></li><li><div>        $headers .= &quot;\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $headers;&nbsp;</div></li><li><div>    } // end headers()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Function to add UTM tracking details to links&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_tracking_link($link) {&nbsp;</div></li><li><div>        if ( empty($link) ) { return; }&nbsp;</div></li><li><div>        if ( !empty($this-&gt;subscribe2_options['tracking']) ) {&nbsp;</div></li><li><div>            (strpos($link, '?') &gt; 0) ? $delimiter .= '&' : $delimiter = '?';&nbsp;</div></li><li><div>            $tracking = $this-&gt;subscribe2_options['tracking'];&nbsp;</div></li><li><div>            if ( strpos($tracking, &quot;{ID}&quot;) ) {&nbsp;</div></li><li><div>                $id = url_to_postid($link);&nbsp;</div></li><li><div>                $tracking = str_replace(&quot;{ID}&quot;, $id, $tracking);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( strpos($tracking, &quot;{TITLE}&quot;) ) {&nbsp;</div></li><li><div>                $id = url_to_postid($link);&nbsp;</div></li><li><div>                $title = urlencode(htmlentities(get_the_title($id), 1));&nbsp;</div></li><li><div>                $tracking = str_replace(&quot;{TITLE}&quot;, $title, $tracking);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $link . $delimiter . $tracking;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $link;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end get_tracking_link()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Sends an email notification of a new post&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function publish($post, $preview = '') {&nbsp;</div></li><li><div>        if ( !$post ) { return $post; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu && !apply_filters('s2_allow_site_switching', $this-&gt;site_switching) ) {&nbsp;</div></li><li><div>            global $switched;&nbsp;</div></li><li><div>            if ( $switched ) { return; }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $preview == '' ) {&nbsp;</div></li><li><div>            // we aren't sending a Preview to the current user so carry out checks&nbsp;</div></li><li><div>            $s2mail = get_post_meta($post-&gt;ID, '_s2mail', true);&nbsp;</div></li><li><div>            if ( (isset($_POST['s2_meta_field']) && $_POST['s2_meta_field'] == 'no') || strtolower(trim($s2mail)) == 'no' ) { return $post; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // are we doing daily digests? If so, don't send anything now&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['email_freq'] != 'never' ) { return $post; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // is the current post of a type that should generate a notification email?&nbsp;</div></li><li><div>            // uses s2_post_types filter to allow for custom post types in WP 3.0&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['pages'] == 'yes' ) {&nbsp;</div></li><li><div>                $s2_post_types = array('page', 'post');&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $s2_post_types = array('post');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $s2_post_types = apply_filters('s2_post_types', $s2_post_types);&nbsp;</div></li><li><div>            if ( !in_array($post-&gt;post_type, $s2_post_types) ) {&nbsp;</div></li><li><div>                return $post;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Are we sending notifications for password protected posts?&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['password'] == &quot;no&quot; && $post-&gt;post_password != '' ) {&nbsp;</div></li><li><div>                    return $post;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Is the post assigned to a format for which we should not be sending posts&nbsp;</div></li><li><div>            $post_format = get_post_format($post-&gt;ID);&nbsp;</div></li><li><div>            $excluded_formats = explode(', ', $this-&gt;subscribe2_options['exclude_formats']);&nbsp;</div></li><li><div>            if ( $post_format !== false && in_array($post_format, $excluded_formats) ) {&nbsp;</div></li><li><div>                return $post;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>            $post_cats = wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'ids'));&nbsp;</div></li><li><div>            $check = false;&nbsp;</div></li><li><div>            // is the current post assigned to any categories&nbsp;</div></li><li><div>            // which should not generate a notification email?&nbsp;</div></li><li><div>            foreach ( explode(', ', $this-&gt;subscribe2_options['exclude']) as $cat ) {&nbsp;</div></li><li><div>                if ( in_array($cat, $post_cats) ) {&nbsp;</div></li><li><div>                    $check = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $check ) {&nbsp;</div></li><li><div>                // hang on -- can registered users subscribe to&nbsp;</div></li><li><div>                // excluded categories?&nbsp;</div></li><li><div>                if ( '0' == $this-&gt;subscribe2_options['reg_override'] ) {&nbsp;</div></li><li><div>                    // nope? okay, let's leave&nbsp;</div></li><li><div>                    return $post;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Are we sending notifications for Private posts?&nbsp;</div></li><li><div>            // Action is added if we are, but double check option and post status&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['private'] == &quot;yes&quot; && $post-&gt;post_status == 'private' ) {&nbsp;</div></li><li><div>                // don't send notification to public users&nbsp;</div></li><li><div>                $check = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // lets collect our subscribers&nbsp;</div></li><li><div>            $public = array();&nbsp;</div></li><li><div>            if ( !$check ) {&nbsp;</div></li><li><div>                // if this post is assigned to an excluded&nbsp;</div></li><li><div>                // category, or is a private post then&nbsp;</div></li><li><div>                // don't send public subscribers a notification&nbsp;</div></li><li><div>                $public = $this-&gt;get_public();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $post-&gt;post_type == 'page' ) {&nbsp;</div></li><li><div>                $post_cats_string = implode(', ', get_all_category_ids());&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $post_cats_string = implode(', ', $post_cats);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $registered = $this-&gt;get_registered(&quot;cats=$post_cats_string&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // do we have subscribers?&nbsp;</div></li><li><div>            if ( empty($public) && empty($registered) ) {&nbsp;</div></li><li><div>                // if not, no sense doing anything else&nbsp;</div></li><li><div>                return $post;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // make sure we prime the taxonomy variable for preview posts&nbsp;</div></li><li><div>            $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we set these class variables so that we can avoid&nbsp;</div></li><li><div>        // passing them in function calls a little later&nbsp;</div></li><li><div>        $this-&gt;post_title = &quot;&lt;a href=\&quot;&quot; . get_permalink($post-&gt;ID) . &quot;\&quot;&gt;&quot; . html_entity_decode($post-&gt;post_title, ENT_QUOTES) . &quot;&lt;/a&gt;&quot;;&nbsp;</div></li><li><div>        $this-&gt;permalink = get_permalink($post-&gt;ID);&nbsp;</div></li><li><div>        $this-&gt;post_date = get_the_time(get_option('date_format'), $post);&nbsp;</div></li><li><div>        $this-&gt;post_time = get_the_time('', $post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $author = get_userdata($post-&gt;post_author);&nbsp;</div></li><li><div>        $this-&gt;authorname = html_entity_decode(apply_filters('the_author', $author-&gt;display_name), ENT_QUOTES);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // do we send as admin, or post author?&nbsp;</div></li><li><div>        if ( 'author' == $this-&gt;subscribe2_options['sender'] ) {&nbsp;</div></li><li><div>            // get author details&nbsp;</div></li><li><div>            $user = &$author;&nbsp;</div></li><li><div>            $this-&gt;myemail = $user-&gt;user_email;&nbsp;</div></li><li><div>            $this-&gt;myname = html_entity_decode($user-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>        } elseif ( 'blogname' == $this-&gt;subscribe2_options['sender'] ) {&nbsp;</div></li><li><div>            $this-&gt;myemail = get_option('admin_email');&nbsp;</div></li><li><div>            $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // get admin details&nbsp;</div></li><li><div>            $user = $this-&gt;get_userdata($this-&gt;subscribe2_options['sender']);&nbsp;</div></li><li><div>            $this-&gt;myemail = $user-&gt;user_email;&nbsp;</div></li><li><div>            $this-&gt;myname = html_entity_decode($user-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;post_cat_names = implode(', ', wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>        $this-&gt;post_tag_names = implode(', ', wp_get_post_tags($post-&gt;ID, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get email subject&nbsp;</div></li><li><div>        $subject = html_entity_decode(stripslashes(wp_kses($this-&gt;substitute($this-&gt;subscribe2_options['notification_subject']), '')));&nbsp;</div></li><li><div>        // Get the message template&nbsp;</div></li><li><div>        $mailtext = apply_filters('s2_email_template', $this-&gt;subscribe2_options['mailtext']);&nbsp;</div></li><li><div>        $mailtext = stripslashes($this-&gt;substitute($mailtext));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plaintext = $post-&gt;post_content;&nbsp;</div></li><li><div>        $plaintext = strip_shortcodes($plaintext);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $plaintext = preg_replace('|&lt;s[^&gt;]*&gt;(.*)&lt;\/s&gt;|Ui', '', $plaintext);&nbsp;</div></li><li><div>        $plaintext = preg_replace('|&lt;strike[^&gt;]*&gt;(.*)&lt;\/strike&gt;|Ui', '', $plaintext);&nbsp;</div></li><li><div>        $plaintext = preg_replace('|&lt;del[^&gt;]*&gt;(.*)&lt;\/del&gt;|Ui', '', $plaintext);&nbsp;</div></li><li><div>        $excerpttext = $plaintext;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strstr($mailtext, &quot;{REFERENCELINKS}&quot;) ) {&nbsp;</div></li><li><div>            $mailtext = str_replace(&quot;{REFERENCELINKS}&quot;, '', $mailtext);&nbsp;</div></li><li><div>            $plaintext_links = '';&nbsp;</div></li><li><div>            $i = 0;&nbsp;</div></li><li><div>            while ( preg_match('|&lt;a([^&gt;]*)&gt;(.*)&lt;\/a&gt;|Ui', $plaintext, $matches) ) {&nbsp;</div></li><li><div>                if ( preg_match('|href=&quot;([^&quot;]*)&quot;|', $matches[1], $link_matches) ) {&nbsp;</div></li><li><div>                    $plaintext_links .= sprintf( &quot;[%d] %s\r\n&quot;, ++$i, $link_matches[1] );&nbsp;</div></li><li><div>                    $link_replacement = sprintf( &quot;%s [%d]&quot;, $matches[2], $i );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $link_replacement = $matches[2];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $plaintext = preg_replace('|&lt;a[^&gt;]*&gt;(.*)&lt;\/a&gt;|Ui', $link_replacement, $plaintext, 1);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>         $plaintext = trim(strip_tags($plaintext));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strstr($mailtext, &quot;{REFERENCELINKS}&quot;) && $plaintext_links != '' ) {&nbsp;</div></li><li><div>            $plaintext .= &quot;\r\n\r\n&quot; . trim($plaintext_links);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $gallid = '[gallery id=&quot;' . $post-&gt;ID . '&quot;';&nbsp;</div></li><li><div>        $content = str_replace('[gallery', $gallid, $post-&gt;post_content);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // remove the autoembed filter to remove iframes from notification emails&nbsp;</div></li><li><div>        if ( get_option('embed_autourls') ) {&nbsp;</div></li><li><div>            global $wp_embed;&nbsp;</div></li><li><div>            $priority = has_filter('the_content', array(&$wp_embed, 'autoembed'));&nbsp;</div></li><li><div>            if ( $priority !== false ) {&nbsp;</div></li><li><div>                remove_filter('the_content', array(&$wp_embed, 'autoembed'), $priority);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $content = apply_filters('the_content', $content);&nbsp;</div></li><li><div>        $content = str_replace(&quot;]]&gt;&quot;, &quot;]]&gt&quot;, $content);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $excerpt = trim($post-&gt;post_excerpt);&nbsp;</div></li><li><div>        if ( '' == $excerpt ) {&nbsp;</div></li><li><div>            // no excerpt, is there a &lt;!--more--&gt; ?&nbsp;</div></li><li><div>            if ( false !== strpos($excerpttext, '&lt;!--more--&gt;') ) {&nbsp;</div></li><li><div>                list($excerpt, $more) = explode('&lt;!--more--&gt;', $excerpttext, 2);&nbsp;</div></li><li><div>                // strip tags and trailing whitespace&nbsp;</div></li><li><div>                $excerpt = trim(strip_tags($excerpt));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // no &lt;!--more--&gt;, so grab the first 55 words&nbsp;</div></li><li><div>                $excerpt = trim(strip_tags($excerpttext));&nbsp;</div></li><li><div>                $words = explode(' ', $excerpt, $this-&gt;excerpt_length + 1);&nbsp;</div></li><li><div>                if (count($words) &gt; $this-&gt;excerpt_length) {&nbsp;</div></li><li><div>                    array_pop($words);&nbsp;</div></li><li><div>                    array_push($words, '[...]');&nbsp;</div></li><li><div>                    $excerpt = implode(' ', $words);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $html_excerpt = trim($post-&gt;post_excerpt);&nbsp;</div></li><li><div>        if ( '' == $html_excerpt ) {&nbsp;</div></li><li><div>            // no excerpt, is there a &lt;!--more--&gt; ?&nbsp;</div></li><li><div>            if ( false !== strpos($content, '&lt;!--more--&gt;') ) {&nbsp;</div></li><li><div>                list($html_excerpt, $more) = explode('&lt;!--more--&gt;', $content, 2);&nbsp;</div></li><li><div>                // balance HTML tags and then strip leading and trailing whitespace&nbsp;</div></li><li><div>                $html_excerpt = trim(balanceTags($html_excerpt, true));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // no &lt;!--more--&gt;, so grab the first 55 words&nbsp;</div></li><li><div>                $words = explode(' ', $content, $this-&gt;excerpt_length + 1);&nbsp;</div></li><li><div>                if (count($words) &gt; $this-&gt;excerpt_length) {&nbsp;</div></li><li><div>                    array_pop($words);&nbsp;</div></li><li><div>                    array_push($words, '[...]');&nbsp;</div></li><li><div>                    $html_excerpt = implode(' ', $words);&nbsp;</div></li><li><div>                    // balance HTML tags and then strip leading and trailing whitespace&nbsp;</div></li><li><div>                    $html_excerpt = trim(balanceTags($html_excerpt, true));&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $html_excerpt = $content;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // remove excess white space from with $excerpt and $plaintext&nbsp;</div></li><li><div>        $excerpt = preg_replace('|[ ]+|', ' ', $excerpt);&nbsp;</div></li><li><div>        $plaintext = preg_replace('|[ ]+|', ' ', $plaintext);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // prepare mail body texts&nbsp;</div></li><li><div>        $plain_excerpt_body = str_replace(&quot;{POST}&quot;, $excerpt, $mailtext);&nbsp;</div></li><li><div>        $plain_body = str_replace(&quot;{POST}&quot;, $plaintext, $mailtext);&nbsp;</div></li><li><div>        $html_body = str_replace(&quot;\r\n&quot;, &quot;&lt;br /&gt;\r\n&quot;, $mailtext);&nbsp;</div></li><li><div>        $html_body = str_replace(&quot;{POST}&quot;, $content, $html_body);&nbsp;</div></li><li><div>        $html_excerpt_body = str_replace(&quot;\r\n&quot;, &quot;&lt;br /&gt;\r\n&quot;, $mailtext);&nbsp;</div></li><li><div>        $html_excerpt_body = str_replace(&quot;{POST}&quot;, $html_excerpt, $html_excerpt_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $preview != '' ) {&nbsp;</div></li><li><div>            $this-&gt;myemail = $preview;&nbsp;</div></li><li><div>            $this-&gt;myname = __('Plain Text Excerpt Preview', 'subscribe2');&nbsp;</div></li><li><div>            $this-&gt;mail(array($preview), $subject, $plain_excerpt_body);&nbsp;</div></li><li><div>            $this-&gt;myname = __('Plain Text Full Preview', 'subscribe2');&nbsp;</div></li><li><div>            $this-&gt;mail(array($preview), $subject, $plain_body);&nbsp;</div></li><li><div>            $this-&gt;myname = __('HTML Excerpt Preview', 'subscribe2');&nbsp;</div></li><li><div>            $this-&gt;mail(array($preview), $subject, $html_excerpt_body, 'html');&nbsp;</div></li><li><div>            $this-&gt;myname = __('HTML Full Preview', 'subscribe2');&nbsp;</div></li><li><div>            $this-&gt;mail(array($preview), $subject, $html_body, 'html');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Registered Subscribers first&nbsp;</div></li><li><div>            // first we send plaintext summary emails&nbsp;</div></li><li><div>            $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=excerpt&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>            $recipients = apply_filters('s2_send_plain_excerpt_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>            $this-&gt;mail($recipients, $subject, $plain_excerpt_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // next we send plaintext full content emails&nbsp;</div></li><li><div>            $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=post&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>            $recipients = apply_filters('s2_send_plain_fullcontent_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>            $this-&gt;mail($recipients, $subject, $plain_body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // next we send html excerpt content emails&nbsp;</div></li><li><div>            $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=html_excerpt&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>            $recipients = apply_filters('s2_send_html_excerpt_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>            $this-&gt;mail($recipients, $subject, $html_excerpt_body, 'html');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // next we send html full content emails&nbsp;</div></li><li><div>            $recipients = $this-&gt;get_registered(&quot;cats=$post_cats_string&format=html&author=$post-&gt;post_author&quot;);&nbsp;</div></li><li><div>            $recipients = apply_filters('s2_send_html_fullcontent_subscribers', $recipients, $post-&gt;ID);&nbsp;</div></li><li><div>            $this-&gt;mail($recipients, $subject, $html_body, 'html');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // and finally we send to Public Subscribers&nbsp;</div></li><li><div>            $recipients = apply_filters('s2_send_public_subscribers', $public, $post-&gt;ID);&nbsp;</div></li><li><div>            $this-&gt;mail($recipients, $subject, $plain_excerpt_body, 'text');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end publish()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Send confirmation email to a public subscriber&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function send_confirm($what = '', $is_remind = false) {&nbsp;</div></li><li><div>        if ( $this-&gt;filtered == 1 ) { return true; }&nbsp;</div></li><li><div>        if ( !$this-&gt;email || !$what ) { return false; }&nbsp;</div></li><li><div>        $id = $this-&gt;get_id($this-&gt;email);&nbsp;</div></li><li><div>        if ( !$id ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // generate the URL &quot;?s2=ACTION+HASH+ID&quot;&nbsp;</div></li><li><div>        // ACTION = 1 to subscribe, 0 to unsubscribe&nbsp;</div></li><li><div>        // HASH = wp_hash of email address&nbsp;</div></li><li><div>        // ID = user's ID in the subscribe2 table&nbsp;</div></li><li><div>        // use home instead of siteurl incase index.php is not in core wordpress directory&nbsp;</div></li><li><div>        $link = get_option('home') . &quot;/?s2=&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'add' == $what ) {&nbsp;</div></li><li><div>            $link .= '1';&nbsp;</div></li><li><div>        } elseif ( 'del' == $what ) {&nbsp;</div></li><li><div>            $link .= '0';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $link .= wp_hash($this-&gt;email);&nbsp;</div></li><li><div>        $link .= $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // sort the headers now so we have all substitute information&nbsp;</div></li><li><div>        $mailheaders = $this-&gt;headers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_remind == true ) {&nbsp;</div></li><li><div>            $body = $this-&gt;substitute(stripslashes($this-&gt;subscribe2_options['remind_email']));&nbsp;</div></li><li><div>            $subject = $this-&gt;substitute(stripslashes($this-&gt;subscribe2_options['remind_subject']));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $body = apply_filters('s2_confirm_email', stripslashes($this-&gt;subscribe2_options['confirm_email']), $what);&nbsp;</div></li><li><div>            $body = $this-&gt;substitute($body);&nbsp;</div></li><li><div>            if ( 'add' == $what ) {&nbsp;</div></li><li><div>                $body = str_replace(&quot;{ACTION}&quot;, $this-&gt;subscribe, $body);&nbsp;</div></li><li><div>                $subject = str_replace(&quot;{ACTION}&quot;, $this-&gt;subscribe, $this-&gt;subscribe2_options['confirm_subject']);&nbsp;</div></li><li><div>            } elseif ( 'del' == $what ) {&nbsp;</div></li><li><div>                $body = str_replace(&quot;{ACTION}&quot;, $this-&gt;unsubscribe, $body);&nbsp;</div></li><li><div>                $subject = str_replace(&quot;{ACTION}&quot;, $this-&gt;unsubscribe, $this-&gt;subscribe2_options['confirm_subject']);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $subject = html_entity_decode($this-&gt;substitute(stripslashes($subject)), ENT_QUOTES);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $body = str_replace(&quot;{LINK}&quot;, $link, $body);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_remind == true && function_exists('wpmq_mail') ) {&nbsp;</div></li><li><div>            // could be sending lots of reminders so queue them if wpmq is enabled&nbsp;</div></li><li><div>            @wp_mail($this-&gt;email, $subject, $body, $mailheaders, '', 0);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return @wp_mail($this-&gt;email, $subject, $body, $mailheaders);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end send_confirm()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== Public Subscriber functions ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Return an array of all the public subscribers&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_public($confirmed = 1) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        if ( 1 == $confirmed ) {&nbsp;</div></li><li><div>            if ( '' == $this-&gt;all_confirmed ) {&nbsp;</div></li><li><div>                $this-&gt;all_confirmed = $wpdb-&gt;get_col(&quot;SELECT email FROM $this-&gt;public WHERE active='1'&quot;);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $this-&gt;all_confirmed;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( '' == $this-&gt;all_unconfirmed ) {&nbsp;</div></li><li><div>                $this-&gt;all_unconfirmed = $wpdb-&gt;get_col(&quot;SELECT email FROM $this-&gt;public WHERE active='0'&quot;);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            return $this-&gt;all_unconfirmed;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end get_public()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Given a public subscriber ID, returns the email address&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_email($id = 0) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$id ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT email FROM $this-&gt;public WHERE id=%d&quot;, $id));&nbsp;</div></li><li><div>    } // end get_email()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Given a public subscriber email, returns the subscriber ID&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_id($email = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !$email ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT id FROM $this-&gt;public WHERE email=%s&quot;, $email));&nbsp;</div></li><li><div>    } // end get_id()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Add an public subscriber to the subscriber table&nbsp;</div></li><li><div>    If added by admin it is immediately confirmed, otherwise as unconfirmed&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function add($email = '', $confirm = false) {&nbsp;</div></li><li><div>        if ( $this-&gt;filtered == 1 ) { return; }&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !is_email($email) ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false !== $this-&gt;is_public($email) ) {&nbsp;</div></li><li><div>            // is this an email for a registered user&nbsp;</div></li><li><div>            $check = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT user_email FROM $wpdb-&gt;users WHERE user_email=%s&quot;, $this-&gt;email));&nbsp;</div></li><li><div>            if ( $check ) { return; }&nbsp;</div></li><li><div>            if ( $confirm ) {&nbsp;</div></li><li><div>                $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET active='1', ip=%s WHERE CAST(email as binary)=%s&quot;, $this-&gt;ip, $email));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET date=CURDATE(), time=CURTIME() WHERE CAST(email as binary)=%s&quot;, $email));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( $confirm ) {&nbsp;</div></li><li><div>                global $current_user;&nbsp;</div></li><li><div>                $wpdb-&gt;query($wpdb-&gt;prepare(&quot;INSERT INTO $this-&gt;public (email, active, date, time, ip) VALUES (%s, %d, CURDATE(), CURTIME(), %s)&quot;, $email, 1, $current_user-&gt;user_login));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $wpdb-&gt;query($wpdb-&gt;prepare(&quot;INSERT INTO $this-&gt;public (email, active, date, time, ip) VALUES (%s, %d, CURDATE(), CURTIME(), %s)&quot;, $email, 0, $this-&gt;ip));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end add()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Remove a public subscriber user from the subscription table&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function delete($email = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( !is_email($email) ) { return false; }&nbsp;</div></li><li><div>        $wpdb-&gt;query($wpdb-&gt;prepare(&quot;DELETE FROM $this-&gt;public WHERE CAST(email as binary)=%s&quot;, $email));&nbsp;</div></li><li><div>    } // end delete()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Toggle a public subscriber's status&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function toggle($email = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' == $email || !is_email($email) ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // let's see if this is a public user&nbsp;</div></li><li><div>        $status = $this-&gt;is_public($email);&nbsp;</div></li><li><div>        if ( false === $status ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '0' == $status ) {&nbsp;</div></li><li><div>            $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET active='1', conf_date=CURDATE(), conf_time=CURTIME(), conf_ip=%s WHERE CAST(email as binary)=%s&quot;, $this-&gt;ip, $email));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $wpdb-&gt;query($wpdb-&gt;prepare(&quot;UPDATE $this-&gt;public SET active='0', conf_date=CURDATE(), conf_time=CURTIME(), conf_ip=%s WHERE CAST(email as binary)=%s&quot;, $this-&gt;ip, $email));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end toggle()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Send reminder email to unconfirmed public subscribers&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function remind($emails = '') {&nbsp;</div></li><li><div>        if ( '' == $emails ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $recipients = explode(&quot;, &quot;, $emails);&nbsp;</div></li><li><div>        if ( !is_array($recipients) ) { $recipients = (array)$recipients; }&nbsp;</div></li><li><div>        foreach ( $recipients as $recipient ) {&nbsp;</div></li><li><div>            $this-&gt;email = $recipient;&nbsp;</div></li><li><div>            $this-&gt;send_confirm('add', true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } //end remind()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Is the supplied email address a public subscriber?&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function is_public($email = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' == $email ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // run the query and force case sensitivity&nbsp;</div></li><li><div>        $check = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT active FROM $this-&gt;public WHERE CAST(email as binary)=%s&quot;, $email));&nbsp;</div></li><li><div>        if ( '0' == $check || '1' == $check ) {&nbsp;</div></li><li><div>            return $check;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end is_public()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== Registered User and Subscriber functions ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Is the supplied email address a registered user of the blog?&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function is_registered($email = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' == $email ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $check = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT user_email FROM $wpdb-&gt;users WHERE user_email=%s&quot;, $email));&nbsp;</div></li><li><div>        if ( $check ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end is_registered()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Return Registered User ID from email&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_user_id($email = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' == $email ) { return false; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SELECT id FROM $wpdb-&gt;users WHERE user_email=%s&quot;, $email));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $id;&nbsp;</div></li><li><div>    } // end get_user_id()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Return an array of all subscribers emails or IDs&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_all_registered($return = 'email') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu ) {&nbsp;</div></li><li><div>            if ( $return === 'ID' ) {&nbsp;</div></li><li><div>                if ( $this-&gt;all_registered_id === '' ) {&nbsp;</div></li><li><div>                    $this-&gt;all_registered_id = $wpdb-&gt;get_col(&quot;SELECT user_id FROM $wpdb-&gt;usermeta WHERE meta_key='&quot; . $wpdb-&gt;prefix . &quot;capabilities'&quot;);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return $this-&gt;all_registered_id;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( $this-&gt;all_registered_email === '' ) {&nbsp;</div></li><li><div>                    $this-&gt;all_registered_email = $wpdb-&gt;get_col(&quot;SELECT a.user_email FROM $wpdb-&gt;users AS a INNER JOIN $wpdb-&gt;usermeta AS b ON a.ID = b.user_id WHERE b.meta_key='&quot; . $wpdb-&gt;prefix . &quot;capabilities'&quot;);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return $this-&gt;all_registered_email;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( $return === 'ID' ) {&nbsp;</div></li><li><div>                if ( $this-&gt;all_registered_id === '' ) {&nbsp;</div></li><li><div>                    $this-&gt;all_registered_id = $wpdb-&gt;get_col(&quot;SELECT ID FROM $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return $this-&gt;all_registered_id;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( $this-&gt;all_registered_email === '' ) {&nbsp;</div></li><li><div>                    $this-&gt;all_registered_email = $wpdb-&gt;get_col(&quot;SELECT user_email FROM $wpdb-&gt;users&quot;);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                return $this-&gt;all_registered_email;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end get_all_registered()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Return an array of registered subscribers&nbsp;</div></li><li><div>    Collect all the registered users of the blog who are subscribed to the specified categories&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_registered($args = '') {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        parse_str($args, $r);&nbsp;</div></li><li><div>        if ( !isset($r['format']) )&nbsp;</div></li><li><div>            $r['format'] = 'all';&nbsp;</div></li><li><div>        if ( !isset($r['cats']) )&nbsp;</div></li><li><div>            $r['cats'] = '';&nbsp;</div></li><li><div>        if ( !isset($r['author']) )&nbsp;</div></li><li><div>            $r['author'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // collect all subscribers for compulsory categories&nbsp;</div></li><li><div>        $compulsory = explode(', ', $this-&gt;subscribe2_options['compulsory']);&nbsp;</div></li><li><div>        foreach ( explode(', ', $r['cats']) as $cat ) {&nbsp;</div></li><li><div>            if ( in_array($cat, $compulsory) ) {&nbsp;</div></li><li><div>                $r['cats'] = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $JOIN = ''; $AND = '';&nbsp;</div></li><li><div>        // text or HTML subscribers&nbsp;</div></li><li><div>        if ( 'all' != $r['format'] ) {&nbsp;</div></li><li><div>            $JOIN .= &quot;INNER JOIN $wpdb-&gt;usermeta AS b ON a.user_id = b.user_id &quot;;&nbsp;</div></li><li><div>            $AND .= $wpdb-&gt;prepare(&quot; AND b.meta_key=%s AND b.meta_value=&quot;, $this-&gt;get_usermeta_keyname('s2_format'));&nbsp;</div></li><li><div>            if ( 'html' == $r['format'] ) {&nbsp;</div></li><li><div>                $AND .= &quot;'html'&quot;;&nbsp;</div></li><li><div>            } elseif ( 'html_excerpt' == $r['format'] ) {&nbsp;</div></li><li><div>                $AND .= &quot;'html_excerpt'&quot;;&nbsp;</div></li><li><div>            } elseif ( 'post' == $r['format'] ) {&nbsp;</div></li><li><div>                $AND .= &quot;'post'&quot;;&nbsp;</div></li><li><div>            } elseif ( 'excerpt' == $r['format'] ) {&nbsp;</div></li><li><div>                $AND .= &quot;'excerpt'&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // specific category subscribers&nbsp;</div></li><li><div>        if ( '' != $r['cats'] ) {&nbsp;</div></li><li><div>            $JOIN .= &quot;INNER JOIN $wpdb-&gt;usermeta AS c ON a.user_id = c.user_id &quot;;&nbsp;</div></li><li><div>            $and = '';&nbsp;</div></li><li><div>            foreach ( explode(', ', $r['cats']) as $cat ) {&nbsp;</div></li><li><div>                ('' == $and) ? $and = $wpdb-&gt;prepare(&quot;c.meta_key=%s&quot;, $this-&gt;get_usermeta_keyname('s2_cat') . $cat) : $and .= $wpdb-&gt;prepare(&quot; OR c.meta_key=%s&quot;, $this-&gt;get_usermeta_keyname('s2_cat') . $cat);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $AND .= &quot; AND ($and)&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // specific authors&nbsp;</div></li><li><div>        if ( '' != $r['author'] ) {&nbsp;</div></li><li><div>            $JOIN .= &quot;INNER JOIN $wpdb-&gt;usermeta AS d ON a.user_id = d.user_id &quot;;&nbsp;</div></li><li><div>            $AND .= $wpdb-&gt;prepare(&quot; AND (d.meta_key=%s AND NOT FIND_IN_SET(%s, d.meta_value))&quot;, $this-&gt;get_usermeta_keyname('s2_authors'), $r['author']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu ) {&nbsp;</div></li><li><div>            $sql = $wpdb-&gt;prepare(&quot;SELECT a.user_id FROM $wpdb-&gt;usermeta AS a INNER JOIN $wpdb-&gt;usermeta AS e ON a.user_id = e.user_id &quot; . $JOIN . &quot;WHERE a.meta_key='&quot; . $wpdb-&gt;prefix . &quot;capabilities' AND e.meta_key=%s AND e.meta_value &lt;&gt; ''&quot; . $AND, $this-&gt;get_usermeta_keyname('s2_subscribed'));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $sql = $wpdb-&gt;prepare(&quot;SELECT a.user_id FROM $wpdb-&gt;usermeta AS a &quot; . $JOIN . &quot;WHERE a.meta_key=%s AND a.meta_value &lt;&gt; ''&quot; . $AND, $this-&gt;get_usermeta_keyname('s2_subscribed'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_col($sql);&nbsp;</div></li><li><div>        if ( $result ) {&nbsp;</div></li><li><div>            $ids = implode(', ', array_map(array($this, 'prepare_in_data'), $result));&nbsp;</div></li><li><div>            $registered = $wpdb-&gt;get_col(&quot;SELECT user_email FROM $wpdb-&gt;users WHERE ID IN ($ids)&quot;);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty($registered) ) { return array(); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // apply filter to registered users to add or remove additional addresses, pass args too for additional control&nbsp;</div></li><li><div>        $registered = apply_filters('s2_registered_subscribers', $registered, $args);&nbsp;</div></li><li><div>        return $registered;&nbsp;</div></li><li><div>    } // end get_registered()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Function to ensure email is compliant with internet messaging standards&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function sanitize_email($email) {&nbsp;</div></li><li><div>        $email = trim($email);&nbsp;</div></li><li><div>        if ( !is_email($email) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure that domain is in lowercase as per internet email standards http://www.ietf.org/rfc/rfc5321.txt&nbsp;</div></li><li><div>        list($name, $domain) = explode('@', $email, 2);&nbsp;</div></li><li><div>        return $name . &quot;@&quot; . strtolower($domain);&nbsp;</div></li><li><div>    } // end sanitize_email()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Create the appropriate usermeta values when a user registers&nbsp;</div></li><li><div>    If the registering user had previously subscribed to notifications, this function will delete them from the public subscriber list first&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function register($user_ID = 0, $consent = false) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 0 == $user_ID ) { return $user_ID; }&nbsp;</div></li><li><div>        $user = get_userdata($user_ID);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Subscribe registered users to categories obeying excluded categories&nbsp;</div></li><li><div>        if ( 0 == $this-&gt;subscribe2_options['reg_override'] || 'no' == $this-&gt;subscribe2_options['newreg_override'] ) {&nbsp;</div></li><li><div>            $all_cats = $this-&gt;all_cats(true, 'ID');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $all_cats = $this-&gt;all_cats(false, 'ID');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cats = '';&nbsp;</div></li><li><div>        foreach ( $all_cats as $cat ) {&nbsp;</div></li><li><div>            ('' == $cats) ? $cats = &quot;$cat-&gt;term_id&quot; : $cats .= &quot;, $cat-&gt;term_id&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' == $cats ) {&nbsp;</div></li><li><div>            // sanity check, might occur if all cats excluded and reg_override = 0&nbsp;</div></li><li><div>            return $user_ID;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // has this user previously signed up for email notification?&nbsp;</div></li><li><div>        if ( false !== $this-&gt;is_public($this-&gt;sanitize_email($user-&gt;user_email)) ) {&nbsp;</div></li><li><div>            // delete this user from the public table, and subscribe them to all the categories&nbsp;</div></li><li><div>            $this-&gt;delete($user-&gt;user_email);&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), $cats);&nbsp;</div></li><li><div>            foreach ( explode(', ', $cats) as $cat ) {&nbsp;</div></li><li><div>                update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat, $cat);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), 'excerpt');&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), $this-&gt;subscribe2_options['autosub_def']);&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_authors'), '');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // create post format entries for all users&nbsp;</div></li><li><div>            if ( in_array($this-&gt;subscribe2_options['autoformat'], array('html', 'html_excerpt', 'post', 'excerpt')) ) {&nbsp;</div></li><li><div>                update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), $this-&gt;subscribe2_options['autoformat']);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_format'), 'excerpt');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), $this-&gt;subscribe2_options['autosub_def']);&nbsp;</div></li><li><div>            // if the are no existing subscriptions, create them if we have consent&nbsp;</div></li><li><div>            if (  true === $consent ) {&nbsp;</div></li><li><div>                update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), $cats);&nbsp;</div></li><li><div>                foreach ( explode(', ', $cats) as $cat ) {&nbsp;</div></li><li><div>                    update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat, $cat);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_authors'), '');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $user_ID;&nbsp;</div></li><li><div>    } // end register()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Get admin data from record 1 or first user with admin rights&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_userdata($admin_id) {&nbsp;</div></li><li><div>        global $wpdb, $userdata;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_numeric($admin_id) ) {&nbsp;</div></li><li><div>            $admin = get_userdata($admin_id);&nbsp;</div></li><li><div>        } elseif ( $admin_id == 'admin' ) {&nbsp;</div></li><li><div>            //ensure compatibility with &lt; 4.16&nbsp;</div></li><li><div>            $admin = get_userdata('1');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $admin = &$userdata;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty($admin) || $admin-&gt;ID == 0 ) {&nbsp;</div></li><li><div>            $role = array('role' =&gt; 'administrator');&nbsp;</div></li><li><div>            $wp_user_query = get_users( $role );&nbsp;</div></li><li><div>            $admin = $wp_user_query[0];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $admin;&nbsp;</div></li><li><div>    } //end get_userdata()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Subscribe/unsubscribe user from one-click submission&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function one_click_handler($user_ID, $action) {&nbsp;</div></li><li><div>        if ( !isset($user_ID) || !isset($action) ) { return; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $all_cats = $this-&gt;all_cats(true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'subscribe' == $action ) {&nbsp;</div></li><li><div>            // Subscribe&nbsp;</div></li><li><div>            $new_cats = array();&nbsp;</div></li><li><div>            foreach ( $all_cats as $cat ) {&nbsp;</div></li><li><div>                update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat-&gt;term_id, $cat-&gt;term_id);&nbsp;</div></li><li><div>                $new_cats[] = $cat-&gt;term_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), implode(', ', $new_cats));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'yes' == $this-&gt;subscribe2_options['show_autosub'] && 'no' != get_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'), true) ) {&nbsp;</div></li><li><div>                update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), 'yes');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( 'unsubscribe' == $action ) {&nbsp;</div></li><li><div>            // Unsubscribe&nbsp;</div></li><li><div>            foreach ( $all_cats as $cat ) {&nbsp;</div></li><li><div>                delete_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_cat') . $cat-&gt;term_id);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            delete_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_subscribed'));&nbsp;</div></li><li><div>            update_user_meta($user_ID, $this-&gt;get_usermeta_keyname('s2_autosub'), 'no');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } //end one_click_handler()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== helper functions: forms and stuff ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Get an object of all categories, include default and custom type&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function all_cats($exclude = false, $orderby = 'slug') {&nbsp;</div></li><li><div>        $all_cats = array();&nbsp;</div></li><li><div>        $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach( $s2_taxonomies as $taxonomy ) {&nbsp;</div></li><li><div>            if ( taxonomy_exists($taxonomy) ) {&nbsp;</div></li><li><div>                $all_cats = array_merge($all_cats, get_categories(array('hide_empty' =&gt; false, 'orderby' =&gt; $orderby, 'taxonomy' =&gt; $taxonomy)));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $exclude === true ) {&nbsp;</div></li><li><div>            // remove excluded categories from the returned object&nbsp;</div></li><li><div>            $excluded = explode(', ', $this-&gt;subscribe2_options['exclude']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // need to use $id like this as this is a mixed array / object&nbsp;</div></li><li><div>            $id = 0;&nbsp;</div></li><li><div>            foreach ( $all_cats as $cat) {&nbsp;</div></li><li><div>                if ( in_array($cat-&gt;term_id, $excluded) ) {&nbsp;</div></li><li><div>                    unset($all_cats[$id]);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $id++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $all_cats;&nbsp;</div></li><li><div>    } // end all_cats()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Function to sanitise array of data for SQL&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function prepare_in_data($data) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return $wpdb-&gt;prepare('%s', $data);&nbsp;</div></li><li><div>    } // end prepare_in_data()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Filter for usermeta table key names to adjust them if needed for WPMU blogs&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function get_usermeta_keyname($metaname) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Is this WordPressMU or not?&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu === true ) {&nbsp;</div></li><li><div>            switch( $metaname ) {&nbsp;</div></li><li><div>                case 's2_subscribed':&nbsp;</div></li><li><div>                case 's2_cat':&nbsp;</div></li><li><div>                case 's2_format':&nbsp;</div></li><li><div>                case 's2_autosub':&nbsp;</div></li><li><div>                case 's2_authors':&nbsp;</div></li><li><div>                    return $wpdb-&gt;prefix . $metaname;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // Not MU or not a prefixed option name&nbsp;</div></li><li><div>        return $metaname;&nbsp;</div></li><li><div>    } // end get_usermeta_keyname()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Adds information to the WordPress registration screen for new users&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function register_form() {&nbsp;</div></li><li><div>        if ( 'no' == $this-&gt;subscribe2_options['autosub'] ) { return; }&nbsp;</div></li><li><div>        if ( 'wpreg' == $this-&gt;subscribe2_options['autosub'] ) {&nbsp;</div></li><li><div>            echo &quot;&lt;p&gt;\r\n&lt;label&gt;&quot;;&nbsp;</div></li><li><div>            echo __('Check here to Subscribe to email notifications for new posts', 'subscribe2') . &quot;:&lt;br /&gt;\r\n&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;input type=\&quot;checkbox\&quot; name=\&quot;reg_subscribe\&quot;&quot; . checked($this-&gt;subscribe2_options['wpregdef'], 'yes', false) . &quot; /&gt;&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/label&gt;\r\n&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/p&gt;\r\n&quot;;&nbsp;</div></li><li><div>        } elseif ( 'yes' == $this-&gt;subscribe2_options['autosub'] ) {&nbsp;</div></li><li><div>            echo &quot;&lt;p&gt;\r\n&lt;center&gt;\r\n&quot;;&nbsp;</div></li><li><div>            echo __('By registering with this blog you are also agreeing to receive email notifications for new posts but you can unsubscribe at anytime', 'subscribe2') . &quot;.&lt;br /&gt;\r\n&quot;;&nbsp;</div></li><li><div>            echo &quot;&lt;/center&gt;&lt;/p&gt;\r\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end register_form()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Process function to add action if user selects to subscribe to posts during registration&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function register_post($user_ID = 0) {&nbsp;</div></li><li><div>        global $_POST;&nbsp;</div></li><li><div>        if ( 0 == $user_ID ) { return; }&nbsp;</div></li><li><div>        if ( 'yes' == $this-&gt;subscribe2_options['autosub'] || ( isset($_POST['reg_subscribe']) && 'on' == $_POST['reg_subscribe'] && 'wpreg' == $this-&gt;subscribe2_options['autosub'] ) ) {&nbsp;</div></li><li><div>            $this-&gt;register($user_ID, true);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;register($user_ID, false);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end register_post()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== comment subscriber functions ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Display check box on comment page&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function s2_comment_meta_form() {&nbsp;</div></li><li><div>        if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>            echo $this-&gt;profile;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            echo &quot;&lt;p style=\&quot;width: auto;\&quot;&gt;&lt;label&gt;&lt;input type=\&quot;checkbox\&quot; name=\&quot;s2_comment_request\&quot; value=\&quot;1\&quot; &quot; . checked($this-&gt;subscribe2_options['comment_def'], 'yes', false) . &quot;/&gt; &quot; . __('Check here to Subscribe to notifications for new posts', 'subscribe2') . &quot;&lt;/label&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end s2_comment_meta_form()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Process comment meta data&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function s2_comment_meta($comment_ID, $approved = 0) {&nbsp;</div></li><li><div>        if ( $_POST['s2_comment_request'] == '1' ) {&nbsp;</div></li><li><div>            switch ($approved) {&nbsp;</div></li><li><div>                case '0':&nbsp;</div></li><li><div>                    // Unapproved so hold in meta data pending moderation&nbsp;</div></li><li><div>                    add_comment_meta($comment_ID, 's2_comment_request', $_POST['s2_comment_request']);&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case '1':&nbsp;</div></li><li><div>                    // Approved so add&nbsp;</div></li><li><div>                    $comment = get_comment($comment_ID);&nbsp;</div></li><li><div>                    $is_public = $this-&gt;is_public($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                    if ( $is_public == 0 ) {&nbsp;</div></li><li><div>                        $this-&gt;toggle($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $is_registered = $this-&gt;is_registered($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                    if ( !$is_public && !$is_registered ) {&nbsp;</div></li><li><div>                        $this-&gt;add($comment-&gt;comment_author_email, true);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                default :&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end s2_comment_meta()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Action subscribe requests made on comment forms when comments are approved&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function comment_status($comment_ID = 0) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get meta data&nbsp;</div></li><li><div>        $subscribe = get_comment_meta($comment_ID, 's2_comment_request', true);&nbsp;</div></li><li><div>        if ( $subscribe != '1' ) { return $comment_ID; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Retrieve the information about the comment&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&quot;SELECT comment_author_email, comment_approved FROM $wpdb-&gt;comments WHERE comment_ID=%s LIMIT 1&quot;, $comment_ID);&nbsp;</div></li><li><div>        $comment = $wpdb-&gt;get_row($sql, OBJECT);&nbsp;</div></li><li><div>        if ( empty($comment) ) { return $comment_ID; }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ($comment-&gt;comment_approved) {&nbsp;</div></li><li><div>            case '0': // Unapproved&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case '1': // Approved&nbsp;</div></li><li><div>                $is_public = $this-&gt;is_public($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                if ( $is_public == 0 ) {&nbsp;</div></li><li><div>                    $this-&gt;toggle($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $is_registered = $this-&gt;is_registered($comment-&gt;comment_author_email);&nbsp;</div></li><li><div>                if ( !$is_public && !$is_registered ) {&nbsp;</div></li><li><div>                    $this-&gt;add($comment-&gt;comment_author_email, true);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                delete_comment_meta($comment_ID, 's2_comment_request');&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default: // post is trash, spam or deleted&nbsp;</div></li><li><div>                delete_comment_meta($comment_ID, 's2_comment_request');&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $comment_ID;&nbsp;</div></li><li><div>    } // end comment_status()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== widget functions ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Register the form widget&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function subscribe2_widget() {&nbsp;</div></li><li><div>        require_once( S2PATH . 'include/widget.php');&nbsp;</div></li><li><div>        register_widget('S2_Form_widget');&nbsp;</div></li><li><div>    } // end subscribe2_widget()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Register the counter widget&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function counter_widget() {&nbsp;</div></li><li><div>        require_once( S2PATH . 'include/counterwidget.php');&nbsp;</div></li><li><div>        register_widget('S2_Counter_widget');&nbsp;</div></li><li><div>    } // end counter_widget()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== wp-cron functions ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Add a weekly event to cron&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function add_weekly_sched($scheds) {&nbsp;</div></li><li><div>        $scheds['weekly'] = array('interval' =&gt; 604800, 'display' =&gt; __('Weekly', 'subscribe2'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $scheds;&nbsp;</div></li><li><div>    } // end add_weekly_sched()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Send a digest of recent new posts&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function subscribe2_cron($preview = '', $resend = '') {&nbsp;</div></li><li><div>        if ( defined('DOING_S2_CRON') && DOING_S2_CRON ) { return; }&nbsp;</div></li><li><div>        define( 'DOING_S2_CRON', true );&nbsp;</div></li><li><div>        global $wpdb, $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' == $preview ) {&nbsp;</div></li><li><div>            // update last_s2cron execution time before completing or bailing&nbsp;</div></li><li><div>            $now = current_time('mysql');&nbsp;</div></li><li><div>            $prev = $this-&gt;subscribe2_options['last_s2cron'];&nbsp;</div></li><li><div>            $last = $this-&gt;subscribe2_options['previous_s2cron'];&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['last_s2cron'] = $now;&nbsp;</div></li><li><div>            $this-&gt;subscribe2_options['previous_s2cron'] = $prev;&nbsp;</div></li><li><div>            if ( '' == $resend ) {&nbsp;</div></li><li><div>                // update sending times provided this is not a resend&nbsp;</div></li><li><div>                update_option('subscribe2_options', $this-&gt;subscribe2_options);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set up SQL query based on options&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['private'] == 'yes' ) {&nbsp;</div></li><li><div>                $status = &quot;'publish', 'private'&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $status = &quot;'publish'&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // send notifications for allowed post type (defaults for posts and pages)&nbsp;</div></li><li><div>            // uses s2_post_types filter to allow for custom post types in WP 3.0&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['pages'] == 'yes' ) {&nbsp;</div></li><li><div>                $s2_post_types = array('page', 'post');&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $s2_post_types = array('post');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $s2_post_types = apply_filters('s2_post_types', $s2_post_types);&nbsp;</div></li><li><div>            foreach( $s2_post_types as $post_type ) {&nbsp;</div></li><li><div>                ('' == $type) ? $type = $wpdb-&gt;prepare(&quot;%s&quot;, $post_type) : $type .= $wpdb-&gt;prepare(&quot;, %s&quot;, $post_type);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // collect posts&nbsp;</div></li><li><div>            if ( $resend == 'resend' ) {&nbsp;</div></li><li><div>                if ( $this-&gt;subscribe2_options['cron_order'] == 'desc' ) {&nbsp;</div></li><li><div>                    $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT ID, post_title, post_excerpt, post_content, post_type, post_password, post_date, post_author FROM $wpdb-&gt;posts WHERE post_date &gt;= %s AND post_date &lt; %s AND post_status IN ($status) AND post_type IN ($type) ORDER BY post_date DESC&quot;, $last, $prev));&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT ID, post_title, post_excerpt, post_content, post_type, post_password, post_date, post_author FROM $wpdb-&gt;posts WHERE post_date &gt;= %s AND post_date &lt; %s AND post_status IN ($status) AND post_type IN ($type) ORDER BY post_date ASC&quot;, $last, $prev));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( $this-&gt;subscribe2_options['cron_order'] == 'desc' ) {&nbsp;</div></li><li><div>                    $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT ID, post_title, post_excerpt, post_content, post_type, post_password, post_date, post_author FROM $wpdb-&gt;posts WHERE post_date &gt;= %s AND post_date &lt; %s AND post_status IN ($status) AND post_type IN ($type) ORDER BY post_date DESC&quot;, $prev, $now));&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $posts = $wpdb-&gt;get_results($wpdb-&gt;prepare(&quot;SELECT ID, post_title, post_excerpt, post_content, post_type, post_password, post_date, post_author FROM $wpdb-&gt;posts WHERE post_date &gt;= %s AND post_date &lt; %s AND post_status IN ($status) AND post_type IN ($type) ORDER BY post_date ASC&quot;, $prev, $now));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // we are sending a preview&nbsp;</div></li><li><div>            $now = $prev = $last = current_time('mysql');&nbsp;</div></li><li><div>            $posts = get_posts('numberposts=1');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Collect sticky posts if desired&nbsp;</div></li><li><div>        if ( $this-&gt;subscribe2_options['stickies'] == 'yes' ) {&nbsp;</div></li><li><div>            $sticky_ids = get_option('sticky_posts');&nbsp;</div></li><li><div>            if ( !empty($sticky_ids) ) {&nbsp;</div></li><li><div>                $sticky_posts = get_posts( array('post__in' =&gt; $sticky_ids) );&nbsp;</div></li><li><div>                $posts = array_merge((array)$sticky_posts, (array)$posts);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // do we have any posts?&nbsp;</div></li><li><div>        if ( empty($posts) && !has_filter('s2_digest_email') ) { return false; }&nbsp;</div></li><li><div>        $this-&gt;post_count = count($posts);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if we have posts, let's prepare the digest&nbsp;</div></li><li><div>        $datetime = get_option('date_format') . ' @ ' . get_option('time_format');&nbsp;</div></li><li><div>        $all_post_cats = array();&nbsp;</div></li><li><div>        $ids = array();&nbsp;</div></li><li><div>        $mailtext = apply_filters('s2_email_template', $this-&gt;subscribe2_options['mailtext']);&nbsp;</div></li><li><div>        $table = '';&nbsp;</div></li><li><div>        $tablelinks = '';&nbsp;</div></li><li><div>        $message_post= '';&nbsp;</div></li><li><div>        $message_posttime = '';&nbsp;</div></li><li><div>        foreach ( $posts as $post ) {&nbsp;</div></li><li><div>            // keep an array of post ids and skip if we've already done it once&nbsp;</div></li><li><div>            if ( in_array($post-&gt;ID, $ids) ) { continue; }&nbsp;</div></li><li><div>            $ids[] = $post-&gt;ID;&nbsp;</div></li><li><div>            $s2_taxonomies = apply_filters('s2_taxonomies', array('category'));&nbsp;</div></li><li><div>            $post_cats = wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'ids'));&nbsp;</div></li><li><div>            $post_cats_string = implode(', ', $post_cats);&nbsp;</div></li><li><div>            $all_post_cats = array_unique(array_merge($all_post_cats, $post_cats));&nbsp;</div></li><li><div>            $check = false;&nbsp;</div></li><li><div>            // Pages are put into category 1 so make sure we don't exclude&nbsp;</div></li><li><div>            // pages if category 1 is excluded&nbsp;</div></li><li><div>            if ( $post-&gt;post_type != 'page' ) {&nbsp;</div></li><li><div>                // is the current post assigned to any categories&nbsp;</div></li><li><div>                // which should not generate a notification email?&nbsp;</div></li><li><div>                foreach ( explode(', ', $this-&gt;subscribe2_options['exclude']) as $cat ) {&nbsp;</div></li><li><div>                    if ( in_array($cat, $post_cats) ) {&nbsp;</div></li><li><div>                        $check = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // is the current post set by the user to&nbsp;</div></li><li><div>            // not generate a notification email?&nbsp;</div></li><li><div>            $s2mail = get_post_meta($post-&gt;ID, '_s2mail', true);&nbsp;</div></li><li><div>            if ( strtolower(trim($s2mail)) == 'no' ) {&nbsp;</div></li><li><div>                $check = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // is the current post private&nbsp;</div></li><li><div>            // and should this not generate a notification email?&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['password'] == 'no' && $post-&gt;post_password != '' ) {&nbsp;</div></li><li><div>                $check = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // is the post assigned a format that should&nbsp;</div></li><li><div>            // not be included in the notification email?&nbsp;</div></li><li><div>            $post_format = get_post_format($post-&gt;ID);&nbsp;</div></li><li><div>            $excluded_formats = explode(', ', $this-&gt;subscribe2_options['exclude_formats']);&nbsp;</div></li><li><div>            if ( $post_format !== false && in_array($post_format, $excluded_formats) ) {&nbsp;</div></li><li><div>                $check = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // if this post is excluded&nbsp;</div></li><li><div>            // don't include it in the digest&nbsp;</div></li><li><div>            if ( $check ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $post_title = html_entity_decode($post-&gt;post_title, ENT_QUOTES);&nbsp;</div></li><li><div>            ('' == $table) ? $table .= &quot;* &quot; . $post_title : $table .= &quot;\r\n* &quot; . $post_title;&nbsp;</div></li><li><div>            ('' == $tablelinks) ? $tablelinks .= &quot;* &quot; . $post_title : $tablelinks .= &quot;\r\n* &quot; . $post_title;&nbsp;</div></li><li><div>            $message_post .= $post_title;&nbsp;</div></li><li><div>            $message_posttime .= $post_title;&nbsp;</div></li><li><div>            if ( strstr($mailtext, &quot;{AUTHORNAME}&quot;) ) {&nbsp;</div></li><li><div>                $author = get_userdata($post-&gt;post_author);&nbsp;</div></li><li><div>                if ( $author-&gt;display_name != '' ) {&nbsp;</div></li><li><div>                    $message_post .= &quot; (&quot; . __('Author', 'subscribe2') . &quot;: &quot; . html_entity_decode(apply_filters('the_author', $author-&gt;display_name), ENT_QUOTES) . &quot;)&quot;;&nbsp;</div></li><li><div>                    $message_posttime .= &quot; (&quot; . __('Author', 'subscribe2') . &quot;: &quot; . html_entity_decode(apply_filters('the_author', $author-&gt;display_name), ENT_QUOTES) . &quot;)&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $message_post .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>            $message_posttime .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $message_posttime .= __('Posted on', 'subscribe2') . &quot;: &quot; . mysql2date($datetime, $post-&gt;post_date) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>            if ( strstr($mailtext, &quot;{TINYLINK}&quot;) ) {&nbsp;</div></li><li><div>                $tinylink = file_get_contents('http://tinyurl.com/api-create.php?url=' . urlencode($this-&gt;get_tracking_link(get_permalink($post-&gt;ID))));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $tinylink = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( strstr($mailtext, &quot;{TINYLINK}&quot;) && $tinylink !== 'Error' && $tinylink !== false ) {&nbsp;</div></li><li><div>                $tablelinks .= &quot;\r\n&quot; . $tinylink . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                $message_post .= $tinylink . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                $message_posttime .= $tinylink . &quot;\r\n&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $tablelinks .= &quot;\r\n&quot; . $this-&gt;get_tracking_link(get_permalink($post-&gt;ID)) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                $message_post .= $this-&gt;get_tracking_link(get_permalink($post-&gt;ID)) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                $message_posttime .= $this-&gt;get_tracking_link(get_permalink($post-&gt;ID)) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( strstr($mailtext, &quot;{CATS}&quot;) ) {&nbsp;</div></li><li><div>                $post_cat_names = implode(', ', wp_get_object_terms($post-&gt;ID, $s2_taxonomies, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>                $message_post .= __('Posted in', 'subscribe2') . &quot;: &quot; . $post_cat_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                $message_posttime .= __('Posted in', 'subscribe2') . &quot;: &quot; . $post_cat_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( strstr($mailtext, &quot;{TAGS}&quot;) ) {&nbsp;</div></li><li><div>                $post_tag_names = implode(', ', wp_get_post_tags($post-&gt;ID, array('fields' =&gt; 'names')));&nbsp;</div></li><li><div>                if ( $post_tag_names != '' ) {&nbsp;</div></li><li><div>                    $message_post .= __('Tagged as', 'subscribe2') . &quot;: &quot; . $post_tag_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                    $message_posttime .= __('Tagged as', 'subscribe2') . &quot;: &quot; . $post_tag_names . &quot;\r\n&quot;;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $message_post .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>            $message_posttime .= &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ( !empty($post-&gt;post_excerpt) ) ? $excerpt = trim($post-&gt;post_excerpt) : $excerpt = '';&nbsp;</div></li><li><div>            if ( '' == $excerpt ) {&nbsp;</div></li><li><div>                // no excerpt, is there a &lt;!--more--&gt; ?&nbsp;</div></li><li><div>                if ( false !== strpos($post-&gt;post_content, '&lt;!--more--&gt;') ) {&nbsp;</div></li><li><div>                    list($excerpt, $more) = explode('&lt;!--more--&gt;', $post-&gt;post_content, 2);&nbsp;</div></li><li><div>                    $excerpt = strip_tags($excerpt);&nbsp;</div></li><li><div>                    $excerpt = strip_shortcodes($excerpt);&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $excerpt = strip_tags($post-&gt;post_content);&nbsp;</div></li><li><div>                    $excerpt = strip_shortcodes($excerpt);&nbsp;</div></li><li><div>                    $words = explode(' ', $excerpt, $this-&gt;excerpt_length + 1);&nbsp;</div></li><li><div>                    if ( count($words) &gt; $this-&gt;excerpt_length ) {&nbsp;</div></li><li><div>                        array_pop($words);&nbsp;</div></li><li><div>                        array_push($words, '[...]');&nbsp;</div></li><li><div>                        $excerpt = implode(' ', $words);&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // strip leading and trailing whitespace&nbsp;</div></li><li><div>                $excerpt = trim($excerpt);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $message_post .= $excerpt . &quot;\r\n\r\n&quot;;&nbsp;</div></li><li><div>            $message_posttime .= $excerpt . &quot;\r\n\r\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // we add a blank line after each post excerpt now trim white space that occurs for the last post&nbsp;</div></li><li><div>        $message_post = trim($message_post);&nbsp;</div></li><li><div>        $message_posttime = trim($message_posttime);&nbsp;</div></li><li><div>        // remove excess white space from within $message_post and $message_posttime&nbsp;</div></li><li><div>        $message_post = preg_replace('|[ ]+|', ' ', $message_post);&nbsp;</div></li><li><div>        $message_posttime = preg_replace('|[ ]+|', ' ', $message_posttime);&nbsp;</div></li><li><div>        $message_post = preg_replace(&quot;|[\r\n]{3, }|&quot;, &quot;\r\n\r\n&quot;, $message_post);&nbsp;</div></li><li><div>        $message_posttime = preg_replace(&quot;|[\r\n]{3, }|&quot;, &quot;\r\n\r\n&quot;, $message_posttime);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // apply filter to allow external content to be inserted or content manipulated&nbsp;</div></li><li><div>        $message_post = apply_filters('s2_digest_email', $message_post, $now, $prev, $last, $this-&gt;subscribe2_options['cron_order']);&nbsp;</div></li><li><div>        $message_posttime = apply_filters('s2_digest_email', $message_posttime, $now, $prev, $last, $this-&gt;subscribe2_options['cron_order']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //sanity check - don't send a mail if the content is empty&nbsp;</div></li><li><div>        if ( !$message_post && !$message_posttime && !$table && !$tablelinks ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get sender details&nbsp;</div></li><li><div>        if ( $this-&gt;subscribe2_options['sender'] == 'blogname' ) {&nbsp;</div></li><li><div>            $this-&gt;myname = html_entity_decode(get_option('blogname'), ENT_QUOTES);&nbsp;</div></li><li><div>            $this-&gt;myemail = get_bloginfo('admin_email');&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $user = $this-&gt;get_userdata($this-&gt;subscribe2_options['sender']);&nbsp;</div></li><li><div>            $this-&gt;myemail = $user-&gt;user_email;&nbsp;</div></li><li><div>            $this-&gt;myname = html_entity_decode($user-&gt;display_name, ENT_QUOTES);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $scheds = (array)wp_get_schedules();&nbsp;</div></li><li><div>        $email_freq = $this-&gt;subscribe2_options['email_freq'];&nbsp;</div></li><li><div>        $display = $scheds[$email_freq]['display'];&nbsp;</div></li><li><div>        ( '' == get_option('blogname') ) ? $subject = &quot;&quot; : $subject = &quot;[&quot; . stripslashes(html_entity_decode(get_option('blogname'), ENT_QUOTES)) . &quot;] &quot;;&nbsp;</div></li><li><div>        $subject .= $display . &quot; &quot; . __('Digest Email', 'subscribe2');&nbsp;</div></li><li><div>        $mailtext = str_replace(&quot;{TABLELINKS}&quot;, $tablelinks, $mailtext);&nbsp;</div></li><li><div>        $mailtext = str_replace(&quot;{TABLE}&quot;, $table, $mailtext);&nbsp;</div></li><li><div>        $mailtext = str_replace(&quot;{POSTTIME}&quot;, $message_posttime, $mailtext);&nbsp;</div></li><li><div>        $mailtext = str_replace(&quot;{POST}&quot;, $message_post, $mailtext);&nbsp;</div></li><li><div>        $mailtext = stripslashes($this-&gt;substitute($mailtext));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // prepare recipients&nbsp;</div></li><li><div>        if ( $preview != '' ) {&nbsp;</div></li><li><div>            $this-&gt;myemail = $preview;&nbsp;</div></li><li><div>            $this-&gt;myname = __('Digest Preview', 'subscribe2');&nbsp;</div></li><li><div>            $this-&gt;mail(array($preview), $subject, $mailtext);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $public = $this-&gt;get_public();&nbsp;</div></li><li><div>            $all_post_cats_string = implode(', ', $all_post_cats);&nbsp;</div></li><li><div>            $registered = $this-&gt;get_registered(&quot;cats=$all_post_cats_string&quot;);&nbsp;</div></li><li><div>            $recipients = array_merge((array)$public, (array)$registered);&nbsp;</div></li><li><div>            $this-&gt;mail($recipients, $subject, $mailtext);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end subscribe2_cron()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function s2cleaner_task() {&nbsp;</div></li><li><div>        $unconfirmed = $this-&gt;get_public('0');&nbsp;</div></li><li><div>        if ( empty($unconfirmed) ) { return; }&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $sql = &quot;SELECT email FROM $this-&gt;public WHERE active='0' AND date &lt; DATE_SUB(CURDATE(), INTERVAL &quot; . $this-&gt;clean_interval . &quot; DAY)&quot;;&nbsp;</div></li><li><div>        $old_unconfirmed = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>        if ( empty($old_unconfirmed) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            foreach ($old_unconfirmed as $email) {&nbsp;</div></li><li><div>                $this-&gt;delete($email);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return;&nbsp;</div></li><li><div>    } // end s2cleaner_task()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== Our constructor ===== */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    Subscribe2 constructor&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function s2init() {&nbsp;</div></li><li><div>        global $wpdb, $wp_version, $wpmu_version;&nbsp;</div></li><li><div>        // load the options&nbsp;</div></li><li><div>        $this-&gt;subscribe2_options = get_option('subscribe2_options');&nbsp;</div></li><li><div>        // if SCRIPT_DEBUG is true, use dev scripts&nbsp;</div></li><li><div>        $this-&gt;script_debug = ( defined('SCRIPT_DEBUG') && SCRIPT_DEBUG ) ? '' : '.min';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get the WordPress release number for in code version comparisons&nbsp;</div></li><li><div>        $tmp = explode('-', $wp_version, 2);&nbsp;</div></li><li><div>        $this-&gt;wp_release = $tmp[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Is this WordPressMU or not?&nbsp;</div></li><li><div>        if ( isset($wpmu_version) || strpos($wp_version, 'wordpress-mu') ) {&nbsp;</div></li><li><div>            $this-&gt;s2_mu = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( function_exists('is_multisite') && is_multisite() ) {&nbsp;</div></li><li><div>            $this-&gt;s2_mu = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add action to handle WPMU subscriptions and unsubscriptions&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu === true ) {&nbsp;</div></li><li><div>            require_once(S2PATH . &quot;classes/class-s2-multisite.php&quot;);&nbsp;</div></li><li><div>            global $s2class_multisite;&nbsp;</div></li><li><div>            $s2class_multisite = new s2_multisite;&nbsp;</div></li><li><div>            if ( isset($_GET['s2mu_subscribe']) || isset($_GET['s2mu_unsubscribe']) ) {&nbsp;</div></li><li><div>                add_action('init', array(&$s2class_multisite, 'wpmu_subscribe'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // load our translations&nbsp;</div></li><li><div>        add_action('plugins_loaded', array(&$this, 'load_translations'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // do we need to install anything?&nbsp;</div></li><li><div>        $this-&gt;public = $wpdb-&gt;prefix . &quot;subscribe2&quot;;&nbsp;</div></li><li><div>        if ( $wpdb-&gt;get_var($wpdb-&gt;prepare(&quot;SHOW TABLES LIKE %s&quot;, $this-&gt;public)) != $this-&gt;public ) { $this-&gt;install(); }&nbsp;</div></li><li><div>        //do we need to upgrade anything?&nbsp;</div></li><li><div>        if ( $this-&gt;subscribe2_options === false || is_array($this-&gt;subscribe2_options) && $this-&gt;subscribe2_options['version'] !== S2VERSION ) {&nbsp;</div></li><li><div>            add_action('shutdown', array(&$this, 'upgrade'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add core actions&nbsp;</div></li><li><div>        add_filter('cron_schedules', array(&$this, 'add_weekly_sched'));&nbsp;</div></li><li><div>        // add actions for automatic subscription based on option settings&nbsp;</div></li><li><div>        add_action('register_form', array(&$this, 'register_form'));&nbsp;</div></li><li><div>        add_action('user_register', array(&$this, 'register_post'));&nbsp;</div></li><li><div>        if ( $this-&gt;s2_mu ) {&nbsp;</div></li><li><div>            add_action('add_user_to_blog', array(&$s2class_multisite, 'wpmu_add_user'), 10);&nbsp;</div></li><li><div>            add_action('remove_user_from_blog', array(&$s2class_multisite, 'wpmu_remove_user'), 10);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // add actions for processing posts based on per-post or cron email settings&nbsp;</div></li><li><div>        if ( $this-&gt;subscribe2_options['email_freq'] != 'never' ) {&nbsp;</div></li><li><div>            add_action('s2_digest_cron', array(&$this, 'subscribe2_cron'));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $statuses = apply_filters('s2_post_statuses', array('new', 'draft', 'auto-draft', 'pending'));&nbsp;</div></li><li><div>            if ( $this-&gt;subscribe2_options['private'] == 'yes' ) {&nbsp;</div></li><li><div>                foreach ( $statuses as $status ) {&nbsp;</div></li><li><div>                    add_action(&quot;{$status}_to_private&quot;, array(&$this, 'publish'));&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            array_push($statuses, 'private', 'future');&nbsp;</div></li><li><div>            foreach ( $statuses as $status ) {&nbsp;</div></li><li><div>                add_action(&quot;{$status}_to_publish&quot;, array(&$this, 'publish'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // add actions for comment subscribers&nbsp;</div></li><li><div>        if ( 'no' != $this-&gt;subscribe2_options['comment_subs'] ) {&nbsp;</div></li><li><div>            if ( 'before' == $this-&gt;subscribe2_options['comment_subs'] ) {&nbsp;</div></li><li><div>                add_action('comment_form_after_fields', array(&$this, 's2_comment_meta_form'));&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                add_action('comment_form', array(&$this, 's2_comment_meta_form'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            add_action('comment_post', array(&$this, 's2_comment_meta'), 1, 2);&nbsp;</div></li><li><div>            add_action('wp_set_comment_status', array(&$this, 'comment_status'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // add action to display widget if option is enabled&nbsp;</div></li><li><div>        if ( '1' == $this-&gt;subscribe2_options['widget'] ) {&nbsp;</div></li><li><div>            add_action('widgets_init', array(&$this, 'subscribe2_widget'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // add action to display counter widget if option is enabled&nbsp;</div></li><li><div>        if ( '1' == $this-&gt;subscribe2_options['counterwidget'] ) {&nbsp;</div></li><li><div>            add_action('widgets_init', array(&$this, 'counter_widget'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add action to 'clean' unconfirmed Public Subscribers&nbsp;</div></li><li><div>        if ( $this-&gt;clean_interval &gt; 0 ) {&nbsp;</div></li><li><div>            add_action('wp_scheduled_delete', array(&$this, 's2cleaner_task'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add actions specific to admin or frontend&nbsp;</div></li><li><div>        if ( is_admin() ) {&nbsp;</div></li><li><div>            // load strings&nbsp;</div></li><li><div>            add_action('init', array(&$this, 'load_strings'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //add menu, authoring and category admin actions&nbsp;</div></li><li><div>            add_action('admin_menu', array(&$this, 'admin_menu'));&nbsp;</div></li><li><div>            add_action('admin_menu', array(&$this, 's2_meta_init'));&nbsp;</div></li><li><div>            add_action('save_post', array(&$this, 's2_meta_handler'));&nbsp;</div></li><li><div>            add_action('create_category', array(&$this, 'new_category'));&nbsp;</div></li><li><div>            add_action('delete_category', array(&$this, 'delete_category'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add filters for Ozh Admin Menu&nbsp;</div></li><li><div>            if ( function_exists('wp_ozh_adminmenu') ) {&nbsp;</div></li><li><div>                add_filter('ozh_adminmenu_icon_s2_posts', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>                add_filter('ozh_adminmenu_icon_s2_users', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>                add_filter('ozh_adminmenu_icon_s2_tools', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>                add_filter('ozh_adminmenu_icon_s2_settings', array(&$this, 'ozh_s2_icon'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // add write button&nbsp;</div></li><li><div>            if ( '1' == $this-&gt;subscribe2_options['show_button'] ) {&nbsp;</div></li><li><div>                add_action('admin_init', array(&$this, 'button_init'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // add counterwidget css and js&nbsp;</div></li><li><div>            if ( '1' == $this-&gt;subscribe2_options['counterwidget'] ) {&nbsp;</div></li><li><div>                add_action('admin_init', array(&$this, 'widget_s2counter_css_and_js'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // add one-click handlers&nbsp;</div></li><li><div>            if ( 'yes' == $this-&gt;subscribe2_options['one_click_profile'] ) {&nbsp;</div></li><li><div>                add_action( 'show_user_profile', array(&$this, 'one_click_profile_form') );&nbsp;</div></li><li><div>                add_action( 'edit_user_profile', array(&$this, 'one_click_profile_form') );&nbsp;</div></li><li><div>                add_action( 'personal_options_update', array(&$this, 'one_click_profile_form_save') );&nbsp;</div></li><li><div>                add_action( 'edit_user_profile_update', array(&$this, 'one_click_profile_form_save') );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // capture CSV export&nbsp;</div></li><li><div>            if ( isset($_POST['s2_admin']) && isset($_POST['csv']) ) {&nbsp;</div></li><li><div>                $date = date('Y-m-d');&nbsp;</div></li><li><div>                header(&quot;Content-Description: File Transfer&quot;);&nbsp;</div></li><li><div>                header(&quot;Content-type: application/octet-stream&quot;);&nbsp;</div></li><li><div>                header(&quot;Content-Disposition: attachment; filename=subscribe2_users_$date.csv&quot;);&nbsp;</div></li><li><div>                header(&quot;Pragma: no-cache&quot;);&nbsp;</div></li><li><div>                header(&quot;Expires: 0&quot;);&nbsp;</div></li><li><div>                echo $this-&gt;prepare_export($_POST['exportcsv']);&nbsp;</div></li><li><div>                exit(0);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // load strings later on frontend for polylang plugin compatibility&nbsp;</div></li><li><div>            add_action('wp', array(&$this, 'load_strings'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset($_GET['s2']) ) {&nbsp;</div></li><li><div>                // someone is confirming a request&nbsp;</div></li><li><div>                if ( defined('DOING_S2_CONFIRM') && DOING_S2_CONFIRM ) { return; }&nbsp;</div></li><li><div>                define( 'DOING_S2_CONFIRM', true );&nbsp;</div></li><li><div>                add_filter('request', array(&$this, 'query_filter'));&nbsp;</div></li><li><div>                add_filter('the_title', array(&$this, 'title_filter'));&nbsp;</div></li><li><div>                add_filter('the_content', array(&$this, 'confirm'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // add the frontend filters&nbsp;</div></li><li><div>            add_shortcode('subscribe2', array(&$this, 'shortcode'));&nbsp;</div></li><li><div>            add_filter('the_content', array(&$this, 'filter'), 10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // add actions for other plugins&nbsp;</div></li><li><div>            if ( '1' == $this-&gt;subscribe2_options['show_meta'] ) {&nbsp;</div></li><li><div>                add_action('wp_meta', array(&$this, 'add_minimeta'), 0);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // add actions for ajax form if enabled&nbsp;</div></li><li><div>            if ( '1' == $this-&gt;subscribe2_options['ajax'] ) {&nbsp;</div></li><li><div>                add_action('wp_enqueue_scripts', array(&$this, 'add_ajax'));&nbsp;</div></li><li><div>                add_action('wp_footer', array(&$this, 'add_s2_ajax'));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    } // end s2init()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    PHP5 Constructor&nbsp;</div></li><li><div>    Allows dynamic variable setting&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        $this-&gt;word_wrap = apply_filters('s2_word_wrap', 80);&nbsp;</div></li><li><div>        $this-&gt;excerpt_length = apply_filters('s2_excerpt_length', 55);&nbsp;</div></li><li><div>        $this-&gt;site_switching = apply_filters('s2_allow_site_switching', false);&nbsp;</div></li><li><div>        $this-&gt;clean_interval = apply_filters('s2_clean_interval', 28);&nbsp;</div></li><li><div>    } // end __construct()&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>/** ===== our variables ===== */&nbsp;</div></li><li><div>    // cache variables&nbsp;</div></li><li><div>    var $subscribe2_options = array();&nbsp;</div></li><li><div>    var $all_confirmed = '';&nbsp;</div></li><li><div>    var $all_unconfirmed = '';&nbsp;</div></li><li><div>    var $all_registered_id = '';&nbsp;</div></li><li><div>    var $all_registered_email = '';&nbsp;</div></li><li><div>    var $all_authors = '';&nbsp;</div></li><li><div>    var $excluded_cats = '';&nbsp;</div></li><li><div>    var $post_title = '';&nbsp;</div></li><li><div>    var $permalink = '';&nbsp;</div></li><li><div>    var $post_date = '';&nbsp;</div></li><li><div>    var $post_time = '';&nbsp;</div></li><li><div>    var $myname = '';&nbsp;</div></li><li><div>    var $myemail = '';&nbsp;</div></li><li><div>    var $authorname = '';&nbsp;</div></li><li><div>    var $post_cat_names = '';&nbsp;</div></li><li><div>    var $post_tag_names = '';&nbsp;</div></li><li><div>    var $post_count = '';&nbsp;</div></li><li><div>    var $signup_dates = array();&nbsp;</div></li><li><div>    var $filtered = 0;&nbsp;</div></li><li><div>    var $preview_email = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // state variables used to affect processing&nbsp;</div></li><li><div>    var $s2_mu = false;&nbsp;</div></li><li><div>    var $action = '';&nbsp;</div></li><li><div>    var $email = '';&nbsp;</div></li><li><div>    var $message = '';&nbsp;</div></li><li><div>    var $word_wrap;&nbsp;</div></li><li><div>    var $excerpt_length;&nbsp;</div></li><li><div>    var $site_switching;&nbsp;</div></li><li><div>    var $clean_interval;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // some messages&nbsp;</div></li><li><div>    var $please_log_in = '';&nbsp;</div></li><li><div>    var $profile = '';&nbsp;</div></li><li><div>    var $confirmation_sent = '';&nbsp;</div></li><li><div>    var $already_subscribed = '';&nbsp;</div></li><li><div>    var $not_subscribed ='';&nbsp;</div></li><li><div>    var $not_an_email = '';&nbsp;</div></li><li><div>    var $barred_domain = '';&nbsp;</div></li><li><div>    var $error = '';&nbsp;</div></li><li><div>    var $mail_sent = '';&nbsp;</div></li><li><div>    var $mail_failed = '';&nbsp;</div></li><li><div>    var $form = '';&nbsp;</div></li><li><div>    var $no_such_email = '';&nbsp;</div></li><li><div>    var $added = '';&nbsp;</div></li><li><div>    var $deleted = '';&nbsp;</div></li><li><div>    var $subscribe = '';&nbsp;</div></li><li><div>    var $unsubscribe = '';&nbsp;</div></li><li><div>    var $confirm_subject = '';&nbsp;</div></li><li><div>    var $options_saved = '';&nbsp;</div></li><li><div>    var $options_reset = '';&nbsp;</div></li><li><div>} // end class subscribe2&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 9.0</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/subscribe2/9.4/classes/s2class/" class="">9.4</a></li><li><a href="http://hookr.io/plugins/subscribe2/9.3/classes/s2class/" class="">9.3</a></li><li><a href="http://hookr.io/plugins/subscribe2/9.2/classes/s2class/" class="active">9.2</a></li><li><a href="http://hookr.io/plugins/subscribe2/9.1/classes/s2class/" class="">9.1</a></li><li><a href="http://hookr.io/plugins/subscribe2/9.0/classes/s2class/" class="">9.0</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>s2class</li><li><span></span>Subscribe2</li><li><span></span>9.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>