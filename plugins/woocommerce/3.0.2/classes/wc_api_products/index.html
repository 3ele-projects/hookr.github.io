<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.0.2" data-slug="woocommerce" data-type="class" data-id="41114"><head xmlns="http://www.w3.org/1999/xhtml"><title> wc_api_products | class | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WC_API_Products, class, plugin, woocommerce, 3.0.2" /><meta name="description" content="The WooCommerce WC API Products class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=49cc507dc3982b1f389824461fc9b2cc' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wc_api_products/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_api_products%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_api_products%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.2-class-wc_api_products","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wc_api_products" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.2." href="http://hookr.io/plugins/woocommerce/3.0.2/" class="H_VERSION"><span property="name">3.0.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce/3.0.2/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wc_api_products</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="3103"><a href="http://hookr.io/plugins/woocommerce/3.0.2/all/" title="All">All <span class="count badge">3103</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce/3.0.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2096"><a href="http://hookr.io/plugins/woocommerce/3.0.2/hooks/" title="Hooks">Hooks <span class="count badge">2096</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.2/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1322"><a href="http://hookr.io/plugins/woocommerce/3.0.2/filters/" title="Filters">Filters <span class="count badge">1322</span></a></li><li class="active" data-id="class" data-count="364"><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/" title="Classes">Classes <span class="count badge">364</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.2/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="625"><a href="http://hookr.io/plugins/woocommerce/3.0.2/functions/" title="Functions">Functions <span class="count badge">625</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WC_API_Products</strong></h1><p>The WooCommerce <strong>WC API Products</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(3)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.2/files/includes-api-legacy-v1-class-wc-api-products/" class="file">/includes/api/legacy/v1/class-wc-api-products.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class WC_API_Products extends WC_API_Resource {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $base the route base */&nbsp;</div></li><li><div>    protected $base = '/products';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register the routes for this class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * GET /products&nbsp;</div></li><li><div>     * GET /products/count&nbsp;</div></li><li><div>     * GET /products/&lt;id&gt;&nbsp;</div></li><li><div>     * GET /products/&lt;id&gt;/reviews&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $routes&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_routes( $routes ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products&nbsp;</div></li><li><div>        $routes[ $this-&gt;base ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_products' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/count&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/count' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_products_count' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/&lt;id&gt;/reviews&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)/reviews' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_reviews' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $routes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all products&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @param int $page&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products( $fields = null, $type = null, $filter = array(), $page = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $type ) )&nbsp;</div></li><li><div>            $filter['type'] = $type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter['page'] = $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_products( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $query-&gt;posts as $product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;is_readable( $product_id ) )&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products[] = current( $this-&gt;get_product( $product_id, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;server-&gt;add_pagination_headers( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'products' =&gt; $products );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) )&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add data that applies to every product type&nbsp;</div></li><li><div>        $product_data = $this-&gt;get_product_data( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add variations to variable products&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) && $product-&gt;has_child() ) {&nbsp;</div></li><li><div>            $product_data['variations'] = $this-&gt;get_variation_data( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add the parent product data to an individual variation&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variation' ) ) {&nbsp;</div></li><li><div>            $product_data['parent'] = $this-&gt;get_product_data( $product-&gt;get_parent_id() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'product' =&gt; apply_filters( 'woocommerce_api_product_response', $product_data, $product, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total number of orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products_count( $type = null, $filter = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $type ) )&nbsp;</div></li><li><div>            $filter['type'] = $type;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'read_private_products' ) )&nbsp;</div></li><li><div>            return new WP_Error( 'woocommerce_api_user_cannot_read_products_count', __( 'You do not have permission to read the products count', 'woocommerce' ), array( 'status' =&gt; 401 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_products( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'count' =&gt; (int) $query-&gt;found_posts );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product( $id, $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) )&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;get_product( $id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param bool $force true to permanently delete order, false to move to trash&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product( $id, $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) )&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;delete( $id, 'product', ( 'true' === $force ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the reviews for a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the product ID to get reviews for&nbsp;</div></li><li><div>     * @param string $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_reviews( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) )&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'post_id' =&gt; $id, &nbsp;</div></li><li><div>            'approve' =&gt; 'approve', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comments = get_comments( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $reviews = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $reviews[] = array(&nbsp;</div></li><li><div>                'id' =&gt; $comment-&gt;comment_ID, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $comment-&gt;comment_date_gmt ), &nbsp;</div></li><li><div>                'review' =&gt; $comment-&gt;comment_content, &nbsp;</div></li><li><div>                'rating' =&gt; get_comment_meta( $comment-&gt;comment_ID, 'rating', true ), &nbsp;</div></li><li><div>                'reviewer_name' =&gt; $comment-&gt;comment_author, &nbsp;</div></li><li><div>                'reviewer_email' =&gt; $comment-&gt;comment_author_email, &nbsp;</div></li><li><div>                'verified' =&gt; wc_review_is_from_verified_owner( $comment-&gt;comment_ID ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'product_reviews' =&gt; apply_filters( 'woocommerce_api_product_reviews_response', $reviews, $id, $fields, $comments, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get product post objects&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $args request arguments for filtering query&nbsp;</div></li><li><div>     * @return WP_Query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function query_products( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set base query arguments&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_type' =&gt; 'product', &nbsp;</div></li><li><div>            'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>            'meta_query' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $types = explode( ', ', $args['type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['tax_query'] = array(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'taxonomy' =&gt; 'product_type', &nbsp;</div></li><li><div>                    'field' =&gt; 'slug', &nbsp;</div></li><li><div>                    'terms' =&gt; $types, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $args['type'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_args = $this-&gt;merge_query_args( $query_args, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_Query( $query_args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get standard product data that applies to every product type&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|int $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_product_data( $product ) {&nbsp;</div></li><li><div>        if ( is_numeric( $product ) ) {&nbsp;</div></li><li><div>            $product = wc_get_product( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'title' =&gt; $product-&gt;get_name(), &nbsp;</div></li><li><div>            'id' =&gt; $product-&gt;get_id(), &nbsp;</div></li><li><div>            'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $product-&gt;get_date_created(), false, true ), &nbsp;</div></li><li><div>            'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $product-&gt;get_date_modified(), false, true ), &nbsp;</div></li><li><div>            'type' =&gt; $product-&gt;get_type(), &nbsp;</div></li><li><div>            'status' =&gt; $product-&gt;get_status(), &nbsp;</div></li><li><div>            'downloadable' =&gt; $product-&gt;is_downloadable(), &nbsp;</div></li><li><div>            'virtual' =&gt; $product-&gt;is_virtual(), &nbsp;</div></li><li><div>            'permalink' =&gt; $product-&gt;get_permalink(), &nbsp;</div></li><li><div>            'sku' =&gt; $product-&gt;get_sku(), &nbsp;</div></li><li><div>            'price' =&gt; wc_format_decimal( $product-&gt;get_price(), 2 ), &nbsp;</div></li><li><div>            'regular_price' =&gt; wc_format_decimal( $product-&gt;get_regular_price(), 2 ), &nbsp;</div></li><li><div>            'sale_price' =&gt; $product-&gt;get_sale_price() ? wc_format_decimal( $product-&gt;get_sale_price(), 2 ) : null, &nbsp;</div></li><li><div>            'price_html' =&gt; $product-&gt;get_price_html(), &nbsp;</div></li><li><div>            'taxable' =&gt; $product-&gt;is_taxable(), &nbsp;</div></li><li><div>            'tax_status' =&gt; $product-&gt;get_tax_status(), &nbsp;</div></li><li><div>            'tax_class' =&gt; $product-&gt;get_tax_class(), &nbsp;</div></li><li><div>            'managing_stock' =&gt; $product-&gt;managing_stock(), &nbsp;</div></li><li><div>            'stock_quantity' =&gt; $product-&gt;get_stock_quantity(), &nbsp;</div></li><li><div>            'in_stock' =&gt; $product-&gt;is_in_stock(), &nbsp;</div></li><li><div>            'backorders_allowed' =&gt; $product-&gt;backorders_allowed(), &nbsp;</div></li><li><div>            'backordered' =&gt; $product-&gt;is_on_backorder(), &nbsp;</div></li><li><div>            'sold_individually' =&gt; $product-&gt;is_sold_individually(), &nbsp;</div></li><li><div>            'purchaseable' =&gt; $product-&gt;is_purchasable(), &nbsp;</div></li><li><div>            'featured' =&gt; $product-&gt;is_featured(), &nbsp;</div></li><li><div>            'visible' =&gt; $product-&gt;is_visible(), &nbsp;</div></li><li><div>            'catalog_visibility' =&gt; $product-&gt;get_catalog_visibility(), &nbsp;</div></li><li><div>            'on_sale' =&gt; $product-&gt;is_on_sale(), &nbsp;</div></li><li><div>            'weight' =&gt; $product-&gt;get_weight() ? wc_format_decimal( $product-&gt;get_weight(), 2 ) : null, &nbsp;</div></li><li><div>            'dimensions' =&gt; array(&nbsp;</div></li><li><div>                'length' =&gt; $product-&gt;get_length(), &nbsp;</div></li><li><div>                'width' =&gt; $product-&gt;get_width(), &nbsp;</div></li><li><div>                'height' =&gt; $product-&gt;get_height(), &nbsp;</div></li><li><div>                'unit' =&gt; get_option( 'woocommerce_dimension_unit' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'shipping_required' =&gt; $product-&gt;needs_shipping(), &nbsp;</div></li><li><div>            'shipping_taxable' =&gt; $product-&gt;is_shipping_taxable(), &nbsp;</div></li><li><div>            'shipping_class' =&gt; $product-&gt;get_shipping_class(), &nbsp;</div></li><li><div>            'shipping_class_id' =&gt; ( 0 !== $product-&gt;get_shipping_class_id() ) ? $product-&gt;get_shipping_class_id() : null, &nbsp;</div></li><li><div>            'description' =&gt; apply_filters( 'the_content', $product-&gt;get_description() ), &nbsp;</div></li><li><div>            'short_description' =&gt; apply_filters( 'woocommerce_short_description', $product-&gt;get_short_description() ), &nbsp;</div></li><li><div>            'reviews_allowed' =&gt; $product-&gt;get_reviews_allowed(), &nbsp;</div></li><li><div>            'average_rating' =&gt; wc_format_decimal( $product-&gt;get_average_rating(), 2 ), &nbsp;</div></li><li><div>            'rating_count' =&gt; $product-&gt;get_rating_count(), &nbsp;</div></li><li><div>            'related_ids' =&gt; array_map( 'absint', array_values( wc_get_related_products( $product-&gt;get_id() ) ) ), &nbsp;</div></li><li><div>            'upsell_ids' =&gt; array_map( 'absint', $product-&gt;get_upsell_ids() ), &nbsp;</div></li><li><div>            'cross_sell_ids' =&gt; array_map( 'absint', $product-&gt;get_cross_sell_ids() ), &nbsp;</div></li><li><div>            'categories' =&gt; wc_get_object_terms( $product-&gt;get_id(), 'product_cat', 'name' ), &nbsp;</div></li><li><div>            'tags' =&gt; wc_get_object_terms( $product-&gt;get_id(), 'product_tag', 'name' ), &nbsp;</div></li><li><div>            'images' =&gt; $this-&gt;get_images( $product ), &nbsp;</div></li><li><div>            'featured_src' =&gt; wp_get_attachment_url( get_post_thumbnail_id( $product-&gt;get_id() ) ), &nbsp;</div></li><li><div>            'attributes' =&gt; $this-&gt;get_attributes( $product ), &nbsp;</div></li><li><div>            'downloads' =&gt; $this-&gt;get_downloads( $product ), &nbsp;</div></li><li><div>            'download_limit' =&gt; $product-&gt;get_download_limit(), &nbsp;</div></li><li><div>            'download_expiry' =&gt; $product-&gt;get_download_expiry(), &nbsp;</div></li><li><div>            'download_type' =&gt; 'standard', &nbsp;</div></li><li><div>            'purchase_note' =&gt; apply_filters( 'the_content', $product-&gt;get_purchase_note() ), &nbsp;</div></li><li><div>            'total_sales' =&gt; $product-&gt;get_total_sales(), &nbsp;</div></li><li><div>            'variations' =&gt; array(), &nbsp;</div></li><li><div>            'parent' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an individual variation's data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_variation_data( $product ) {&nbsp;</div></li><li><div>        $variations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $child_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $variation || ! $variation-&gt;exists() ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variations[] = array(&nbsp;</div></li><li><div>                'id' =&gt; $variation-&gt;get_id(), &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $variation-&gt;get_date_created(), false, true ), &nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $variation-&gt;get_date_modified(), false, true ), &nbsp;</div></li><li><div>                'downloadable' =&gt; $variation-&gt;is_downloadable(), &nbsp;</div></li><li><div>                'virtual' =&gt; $variation-&gt;is_virtual(), &nbsp;</div></li><li><div>                'permalink' =&gt; $variation-&gt;get_permalink(), &nbsp;</div></li><li><div>                'sku' =&gt; $variation-&gt;get_sku(), &nbsp;</div></li><li><div>                'price' =&gt; wc_format_decimal( $variation-&gt;get_price(), 2 ), &nbsp;</div></li><li><div>                'regular_price' =&gt; wc_format_decimal( $variation-&gt;get_regular_price(), 2 ), &nbsp;</div></li><li><div>                'sale_price' =&gt; $variation-&gt;get_sale_price() ? wc_format_decimal( $variation-&gt;get_sale_price(), 2 ) : null, &nbsp;</div></li><li><div>                'taxable' =&gt; $variation-&gt;is_taxable(), &nbsp;</div></li><li><div>                'tax_status' =&gt; $variation-&gt;get_tax_status(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $variation-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'stock_quantity' =&gt; (int) $variation-&gt;get_stock_quantity(), &nbsp;</div></li><li><div>                'in_stock' =&gt; $variation-&gt;is_in_stock(), &nbsp;</div></li><li><div>                'backordered' =&gt; $variation-&gt;is_on_backorder(), &nbsp;</div></li><li><div>                'purchaseable' =&gt; $variation-&gt;is_purchasable(), &nbsp;</div></li><li><div>                'visible' =&gt; $variation-&gt;variation_is_visible(), &nbsp;</div></li><li><div>                'on_sale' =&gt; $variation-&gt;is_on_sale(), &nbsp;</div></li><li><div>                'weight' =&gt; $variation-&gt;get_weight() ? wc_format_decimal( $variation-&gt;get_weight(), 2 ) : null, &nbsp;</div></li><li><div>                'dimensions' =&gt; array(&nbsp;</div></li><li><div>                    'length' =&gt; $variation-&gt;get_length(), &nbsp;</div></li><li><div>                    'width' =&gt; $variation-&gt;get_width(), &nbsp;</div></li><li><div>                    'height' =&gt; $variation-&gt;get_height(), &nbsp;</div></li><li><div>                    'unit' =&gt; get_option( 'woocommerce_dimension_unit' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'shipping_class' =&gt; $variation-&gt;get_shipping_class(), &nbsp;</div></li><li><div>                'shipping_class_id' =&gt; ( 0 !== $variation-&gt;get_shipping_class_id() ) ? $variation-&gt;get_shipping_class_id() : null, &nbsp;</div></li><li><div>                'image' =&gt; $this-&gt;get_images( $variation ), &nbsp;</div></li><li><div>                'attributes' =&gt; $this-&gt;get_attributes( $variation ), &nbsp;</div></li><li><div>                'downloads' =&gt; $this-&gt;get_downloads( $variation ), &nbsp;</div></li><li><div>                'download_limit' =&gt; (int) $product-&gt;get_download_limit(), &nbsp;</div></li><li><div>                'download_expiry' =&gt; (int) $product-&gt;get_download_expiry(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $variations;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the images for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_images( $product ) {&nbsp;</div></li><li><div>        $images = $attachment_ids = array();&nbsp;</div></li><li><div>        $product_image = $product-&gt;get_image_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add featured image.&nbsp;</div></li><li><div>        if ( ! empty( $product_image ) ) {&nbsp;</div></li><li><div>            $attachment_ids[] = $product_image;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add gallery images.&nbsp;</div></li><li><div>        $attachment_ids = array_merge( $attachment_ids, $product-&gt;get_gallery_image_ids() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build image data.&nbsp;</div></li><li><div>        foreach ( $attachment_ids as $position =&gt; $attachment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment_post = get_post( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $attachment_post ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment = wp_get_attachment_image_src( $attachment_id, 'full' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_array( $attachment ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $images[] = array(&nbsp;</div></li><li><div>                'id' =&gt; (int) $attachment_id, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $attachment_post-&gt;post_date_gmt ), &nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $attachment_post-&gt;post_modified_gmt ), &nbsp;</div></li><li><div>                'src' =&gt; current( $attachment ), &nbsp;</div></li><li><div>                'title' =&gt; get_the_title( $attachment_id ), &nbsp;</div></li><li><div>                'alt' =&gt; get_post_meta( $attachment_id, '_wp_attachment_image_alt', true ), &nbsp;</div></li><li><div>                'position' =&gt; $position, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set a placeholder image if the product has no images set.&nbsp;</div></li><li><div>        if ( empty( $images ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $images[] = array(&nbsp;</div></li><li><div>                'id' =&gt; 0, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( time() ), // default to now&nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( time() ), &nbsp;</div></li><li><div>                'src' =&gt; wc_placeholder_img_src(), &nbsp;</div></li><li><div>                'title' =&gt; __( 'Placeholder', 'woocommerce' ), &nbsp;</div></li><li><div>                'alt' =&gt; __( 'Placeholder', 'woocommerce' ), &nbsp;</div></li><li><div>                'position' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $images;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get attribute options.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $product_id&nbsp;</div></li><li><div>     * @param array $attribute&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_attribute_options( $product_id, $attribute ) {&nbsp;</div></li><li><div>        if ( isset( $attribute['is_taxonomy'] ) && $attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>            return wc_get_product_terms( $product_id, $attribute['name'], array( 'fields' =&gt; 'names' ) );&nbsp;</div></li><li><div>        } elseif ( isset( $attribute['value'] ) ) {&nbsp;</div></li><li><div>            return array_map( 'trim', explode( '|', $attribute['value'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the attributes for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_attributes( $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variation' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // variation attributes&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_variation_attributes() as $attribute_name =&gt; $attribute ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // taxonomy-based attributes are prefixed with `pa_`, otherwise simply `attribute_`&nbsp;</div></li><li><div>                $attributes[] = array(&nbsp;</div></li><li><div>                    'name' =&gt; ucwords( str_replace( 'attribute_', '', str_replace( 'pa_', '', $attribute_name ) ) ), &nbsp;</div></li><li><div>                    'option' =&gt; $attribute, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_attributes() as $attribute ) {&nbsp;</div></li><li><div>                $attributes[] = array(&nbsp;</div></li><li><div>                    'name' =&gt; ucwords( str_replace( 'pa_', '', $attribute['name'] ) ), &nbsp;</div></li><li><div>                    'position' =&gt; $attribute['position'], &nbsp;</div></li><li><div>                    'visible' =&gt; (bool) $attribute['is_visible'], &nbsp;</div></li><li><div>                    'variation' =&gt; (bool) $attribute['is_variation'], &nbsp;</div></li><li><div>                    'options' =&gt; $this-&gt;get_attribute_options( $product-&gt;get_id(), $attribute ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $attributes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the downloads for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_downloads( $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $downloads = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_downloadable() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_downloads() as $file_id =&gt; $file ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $downloads[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $file_id, // do not cast as int as this is a hash&nbsp;</div></li><li><div>                    'name' =&gt; $file['name'], &nbsp;</div></li><li><div>                    'file' =&gt; $file['file'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $downloads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.2/files/includes-api-legacy-v2-class-wc-api-products/" class="file">/includes/api/legacy/v2/class-wc-api-products.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class WC_API_Products extends WC_API_Resource {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $base the route base */&nbsp;</div></li><li><div>    protected $base = '/products';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register the routes for this class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * GET/POST /products&nbsp;</div></li><li><div>     * GET /products/count&nbsp;</div></li><li><div>     * GET/PUT/DELETE /products/&lt;id&gt;&nbsp;</div></li><li><div>     * GET /products/&lt;id&gt;/reviews&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $routes&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_routes( $routes ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products&nbsp;</div></li><li><div>        $routes[ $this-&gt;base ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_products' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/count&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/count' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_products_count' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/&lt;id&gt;/reviews&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)/reviews' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_reviews' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/&lt;id&gt;/orders&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)/orders' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_orders' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/categories&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/categories' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_categories' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/categories/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/categories/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_category' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products/attributes&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/attributes' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_attributes' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product_attribute' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /attributes/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/attributes/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_attribute' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product_attribute' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product_attribute' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/sku/&lt;product sku&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/sku/(?P&lt;sku&gt;\w[\w\s\-]*)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_by_sku' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # POST|PUT /products/bulk&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/bulk' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'bulk' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $routes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all products&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @param int $page&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products( $fields = null, $type = null, $filter = array(), $page = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>            $filter['type'] = $type;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter['page'] = $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_products( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $query-&gt;posts as $product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;is_readable( $product_id ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products[] = current( $this-&gt;get_product( $product_id, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;server-&gt;add_pagination_headers( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'products' =&gt; $products );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add data that applies to every product type&nbsp;</div></li><li><div>        $product_data = $this-&gt;get_product_data( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add variations to variable products&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) && $product-&gt;has_child() ) {&nbsp;</div></li><li><div>            $product_data['variations'] = $this-&gt;get_variation_data( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add the parent product data to an individual variation&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variation' ) && $product-&gt;get_parent_id() ) {&nbsp;</div></li><li><div>            $_product = wc_get_product( $product-&gt;get_parent_id() );&nbsp;</div></li><li><div>            $product_data['parent'] = $this-&gt;get_product_data( $_product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'product' =&gt; apply_filters( 'woocommerce_api_product_response', $product_data, $product, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total number of products&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products_count( $type = null, $filter = array() ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! current_user_can( 'read_private_products' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_products_count', __( 'You do not have permission to read the products count', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>                $filter['type'] = $type;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query = $this-&gt;query_products( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'count' =&gt; (int) $query-&gt;found_posts );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $data posted data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product( $data ) {&nbsp;</div></li><li><div>        $id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_products' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product', __( 'You do not have permission to create products', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if product title is specified&nbsp;</div></li><li><div>            if ( ! isset( $data['title'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_title', sprintf( __( 'Missing parameter %s', 'woocommerce' ), 'title' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check product type&nbsp;</div></li><li><div>            if ( ! isset( $data['type'] ) ) {&nbsp;</div></li><li><div>                $data['type'] = 'simple';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set visible visibility when not sent&nbsp;</div></li><li><div>            if ( ! isset( $data['catalog_visibility'] ) ) {&nbsp;</div></li><li><div>                $data['catalog_visibility'] = 'visible';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the product type&nbsp;</div></li><li><div>            if ( ! in_array( wc_clean( $data['type'] ), array_keys( wc_get_product_types() ) ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_type', sprintf( __( 'Invalid product type - the product type must be any of these: %s', 'woocommerce' ), implode( ', ', array_keys( wc_get_product_types() ) ) ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Enable description html tags.&nbsp;</div></li><li><div>            $post_content = isset( $data['description'] ) ? wc_clean( $data['description'] ) : '';&nbsp;</div></li><li><div>            if ( $post_content && isset( $data['enable_html_description'] ) && true === $data['enable_html_description'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $post_content = $data['description'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Enable short description html tags.&nbsp;</div></li><li><div>            $post_excerpt = isset( $data['short_description'] ) ? wc_clean( $data['short_description'] ) : '';&nbsp;</div></li><li><div>            if ( $post_excerpt && isset( $data['enable_html_short_description'] ) && true === $data['enable_html_short_description'] ) {&nbsp;</div></li><li><div>                $post_excerpt = $data['short_description'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $classname = WC_Product_Factory::get_classname_from_product_type( $data['type'] );&nbsp;</div></li><li><div>            if ( ! class_exists( $classname ) ) {&nbsp;</div></li><li><div>                $classname = 'WC_Product_Simple';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product = new $classname();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_name( wc_clean( $data['title'] ) );&nbsp;</div></li><li><div>            $product-&gt;set_status( isset( $data['status'] ) ? wc_clean( $data['status'] ) : 'publish' );&nbsp;</div></li><li><div>            $product-&gt;set_short_description( isset( $data['short_description'] ) ? $post_excerpt : '' );&nbsp;</div></li><li><div>            $product-&gt;set_description( isset( $data['description'] ) ? $post_content : '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Attempts to create the new product.&nbsp;</div></li><li><div>            $product-&gt;save();&nbsp;</div></li><li><div>            $id = $product-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the product creation&nbsp;</div></li><li><div>            if ( 0 &gt;= $id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product', $id-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for featured/gallery images, upload it and set it&nbsp;</div></li><li><div>            if ( isset( $data['images'] ) ) {&nbsp;</div></li><li><div>                $product = $this-&gt;save_product_images( $product, $data['images'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save product meta fields&nbsp;</div></li><li><div>            $product = $this-&gt;save_product_meta( $product, $data );&nbsp;</div></li><li><div>            $product-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save variations&nbsp;</div></li><li><div>            if ( isset( $data['type'] ) && 'variable' == $data['type'] && isset( $data['variations'] ) && is_array( $data['variations'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;save_variations( $product, $data );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear cache/transients&nbsp;</div></li><li><div>            wc_delete_product_transients( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product( $id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            $this-&gt;clear_product( $id );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            $this-&gt;clear_product( $id );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product( $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $this-&gt;validate_request( $id, 'product', 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>                return $id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product title.&nbsp;</div></li><li><div>            if ( isset( $data['title'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_name( wc_clean( $data['title'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product name (slug).&nbsp;</div></li><li><div>            if ( isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_slug( wc_clean( $data['name'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product status.&nbsp;</div></li><li><div>            if ( isset( $data['status'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_status( wc_clean( $data['status'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product short description.&nbsp;</div></li><li><div>            if ( isset( $data['short_description'] ) ) {&nbsp;</div></li><li><div>                // Enable short description html tags.&nbsp;</div></li><li><div>                $post_excerpt = ( isset( $data['enable_html_short_description'] ) && true === $data['enable_html_short_description'] ) ? $data['short_description'] : wc_clean( $data['short_description'] );&nbsp;</div></li><li><div>                $product-&gt;set_short_description( $post_excerpt );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product description.&nbsp;</div></li><li><div>            if ( isset( $data['description'] ) ) {&nbsp;</div></li><li><div>                // Enable description html tags.&nbsp;</div></li><li><div>                $post_content = ( isset( $data['enable_html_description'] ) && true === $data['enable_html_description'] ) ? $data['description'] : wc_clean( $data['description'] );&nbsp;</div></li><li><div>                $product-&gt;set_description( $post_content );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the product type.&nbsp;</div></li><li><div>            if ( isset( $data['type'] ) && ! in_array( wc_clean( $data['type'] ), array_keys( wc_get_product_types() ) ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_type', sprintf( __( 'Invalid product type - the product type must be any of these: %s', 'woocommerce' ), implode( ', ', array_keys( wc_get_product_types() ) ) ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for featured/gallery images, upload it and set it.&nbsp;</div></li><li><div>            if ( isset( $data['images'] ) ) {&nbsp;</div></li><li><div>                $product = $this-&gt;save_product_images( $product, $data['images'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save product meta fields.&nbsp;</div></li><li><div>            $product = $this-&gt;save_product_meta( $product, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save variations.&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>                if ( isset( $data['variations'] ) && is_array( $data['variations'] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;save_variations( $product, $data );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // Just sync variations.&nbsp;</div></li><li><div>                    $product = WC_Product_Variable::sync( $product, false );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear cache/transients.&nbsp;</div></li><li><div>            wc_delete_product_transients( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product( $id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $id the product ID.&nbsp;</div></li><li><div>     * @param bool $force true to permanently delete order, false to move to trash.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product( $id, $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_delete_product', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If we're forcing, then delete permanently.&nbsp;</div></li><li><div>        if ( $force ) {&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>                foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>                    $child = wc_get_product( $child_id );&nbsp;</div></li><li><div>                    $child-&gt;delete( true );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( $product-&gt;is_type( 'grouped' ) ) {&nbsp;</div></li><li><div>                foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>                    $child = wc_get_product( $child_id );&nbsp;</div></li><li><div>                    $child-&gt;set_parent_id( 0 );&nbsp;</div></li><li><div>                    $child-&gt;save();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;delete( true );&nbsp;</div></li><li><div>            $result = $product-&gt;get_id() &gt; 0 ? false : true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;delete();&nbsp;</div></li><li><div>            $result = 'trash' === $product-&gt;get_status();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $result ) {&nbsp;</div></li><li><div>            return new WP_Error( 'woocommerce_api_cannot_delete_product', sprintf( __( 'This %s cannot be deleted', 'woocommerce' ), 'product' ), array( 'status' =&gt; 500 ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete parent product transients.&nbsp;</div></li><li><div>        if ( $parent_id = wp_get_post_parent_id( $id ) ) {&nbsp;</div></li><li><div>            wc_delete_product_transients( $parent_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force ) {&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Permanently deleted %s', 'woocommerce' ), 'product' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( '202' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the reviews for a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the product ID to get reviews for&nbsp;</div></li><li><div>     * @param string $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_reviews( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comments = get_approved_comments( $id );&nbsp;</div></li><li><div>        $reviews = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $reviews[] = array(&nbsp;</div></li><li><div>                'id' =&gt; intval( $comment-&gt;comment_ID ), &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $comment-&gt;comment_date_gmt ), &nbsp;</div></li><li><div>                'review' =&gt; $comment-&gt;comment_content, &nbsp;</div></li><li><div>                'rating' =&gt; get_comment_meta( $comment-&gt;comment_ID, 'rating', true ), &nbsp;</div></li><li><div>                'reviewer_name' =&gt; $comment-&gt;comment_author, &nbsp;</div></li><li><div>                'reviewer_email' =&gt; $comment-&gt;comment_author_email, &nbsp;</div></li><li><div>                'verified' =&gt; wc_review_is_from_verified_owner( $comment-&gt;comment_ID ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'product_reviews' =&gt; apply_filters( 'woocommerce_api_product_reviews_response', $reviews, $id, $fields, $comments, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the orders for a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param int $id the product ID to get orders for&nbsp;</div></li><li><div>     * @param string fields  fields to retrieve&nbsp;</div></li><li><div>     * @param string $filter filters to include in response&nbsp;</div></li><li><div>     * @param string $status the order status to retrieve&nbsp;</div></li><li><div>     * @param $page  $page   page to retrieve&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_orders( $id, $fields = null, $filter = array(), $status = null, $page = 1 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>            SELECT order_id&nbsp;</div></li><li><div>            FROM {$wpdb-&gt;prefix}woocommerce_order_items&nbsp;</div></li><li><div>            WHERE order_item_id IN ( SELECT order_item_id FROM {$wpdb-&gt;prefix}woocommerce_order_itemmeta WHERE meta_key = '_product_id' AND meta_value = %d )&nbsp;</div></li><li><div>            AND order_item_type = 'line_item'&nbsp;</div></li><li><div>         &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $order_ids ) ) {&nbsp;</div></li><li><div>            return array( 'orders' =&gt; array() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter = array_merge( $filter, array(&nbsp;</div></li><li><div>            'in' =&gt; implode( ', ', $order_ids ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orders = WC()-&gt;api-&gt;WC_API_Orders-&gt;get_orders( $fields, $filter, $status, $page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'orders' =&gt; apply_filters( 'woocommerce_api_product_orders_response', $orders['orders'], $id, $filter, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product categories&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_categories( $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_categories', __( 'You do not have permission to read product categories', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_categories = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $terms = get_terms( 'product_cat', array( 'hide_empty' =&gt; false, 'fields' =&gt; 'ids' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $terms as $term_id ) {&nbsp;</div></li><li><div>                $product_categories[] = current( $this-&gt;get_product_category( $term_id, $fields ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_categories' =&gt; apply_filters( 'woocommerce_api_product_categories_response', $product_categories, $terms, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product category for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $id product category term ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_category( $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate ID&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_category_id', __( 'Invalid product category ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_categories', __( 'You do not have permission to read product categories', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = get_term( $id, 'product_cat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) || is_null( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_category_id', __( 'A product category with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term_id = intval( $term-&gt;term_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get category display type&nbsp;</div></li><li><div>            $display_type = get_woocommerce_term_meta( $term_id, 'display_type' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get category image&nbsp;</div></li><li><div>            $image = '';&nbsp;</div></li><li><div>            if ( $image_id = get_woocommerce_term_meta( $term_id, 'thumbnail_id' ) ) {&nbsp;</div></li><li><div>                $image = wp_get_attachment_url( $image_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_category = array(&nbsp;</div></li><li><div>                'id' =&gt; $term_id, &nbsp;</div></li><li><div>                'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div>                'parent' =&gt; $term-&gt;parent, &nbsp;</div></li><li><div>                'description' =&gt; $term-&gt;description, &nbsp;</div></li><li><div>                'display' =&gt; $display_type ? $display_type : 'default', &nbsp;</div></li><li><div>                'image' =&gt; $image ? esc_url( $image ) : '', &nbsp;</div></li><li><div>                'count' =&gt; intval( $term-&gt;count ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_category' =&gt; apply_filters( 'woocommerce_api_product_category_response', $product_category, $id, $fields, $term, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get product post objects&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $args request arguments for filtering query&nbsp;</div></li><li><div>     * @return WP_Query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function query_products( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set base query arguments&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_type' =&gt; 'product', &nbsp;</div></li><li><div>            'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>            'meta_query' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['type'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $types = explode( ', ', $args['type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['tax_query'] = array(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'taxonomy' =&gt; 'product_type', &nbsp;</div></li><li><div>                    'field' =&gt; 'slug', &nbsp;</div></li><li><div>                    'terms' =&gt; $types, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $args['type'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Filter products by category&nbsp;</div></li><li><div>        if ( ! empty( $args['category'] ) ) {&nbsp;</div></li><li><div>            $query_args['product_cat'] = $args['category'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Filter by specific sku&nbsp;</div></li><li><div>        if ( ! empty( $args['sku'] ) ) {&nbsp;</div></li><li><div>            if ( ! is_array( $query_args['meta_query'] ) ) {&nbsp;</div></li><li><div>                $query_args['meta_query'] = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['meta_query'][] = array(&nbsp;</div></li><li><div>                'key' =&gt; '_sku', &nbsp;</div></li><li><div>                'value' =&gt; $args['sku'], &nbsp;</div></li><li><div>                'compare' =&gt; '=', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['post_type'] = array( 'product', 'product_variation' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_args = $this-&gt;merge_query_args( $query_args, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_Query( $query_args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get standard product data that applies to every product type&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|int $product&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_product_data( $product ) {&nbsp;</div></li><li><div>        if ( is_numeric( $product ) ) {&nbsp;</div></li><li><div>            $product = wc_get_product( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $prices_precision = wc_get_price_decimals();&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'title' =&gt; $product-&gt;get_name(), &nbsp;</div></li><li><div>            'id' =&gt; $product-&gt;get_id(), &nbsp;</div></li><li><div>            'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $product-&gt;get_date_created(), false, true ), &nbsp;</div></li><li><div>            'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $product-&gt;get_date_modified(), false, true ), &nbsp;</div></li><li><div>            'type' =&gt; $product-&gt;get_type(), &nbsp;</div></li><li><div>            'status' =&gt; $product-&gt;get_status(), &nbsp;</div></li><li><div>            'downloadable' =&gt; $product-&gt;is_downloadable(), &nbsp;</div></li><li><div>            'virtual' =&gt; $product-&gt;is_virtual(), &nbsp;</div></li><li><div>            'permalink' =&gt; $product-&gt;get_permalink(), &nbsp;</div></li><li><div>            'sku' =&gt; $product-&gt;get_sku(), &nbsp;</div></li><li><div>            'price' =&gt; wc_format_decimal( $product-&gt;get_price(), $prices_precision ), &nbsp;</div></li><li><div>            'regular_price' =&gt; wc_format_decimal( $product-&gt;get_regular_price(), $prices_precision ), &nbsp;</div></li><li><div>            'sale_price' =&gt; $product-&gt;get_sale_price() ? wc_format_decimal( $product-&gt;get_sale_price(), $prices_precision ) : null, &nbsp;</div></li><li><div>            'price_html' =&gt; $product-&gt;get_price_html(), &nbsp;</div></li><li><div>            'taxable' =&gt; $product-&gt;is_taxable(), &nbsp;</div></li><li><div>            'tax_status' =&gt; $product-&gt;get_tax_status(), &nbsp;</div></li><li><div>            'tax_class' =&gt; $product-&gt;get_tax_class(), &nbsp;</div></li><li><div>            'managing_stock' =&gt; $product-&gt;managing_stock(), &nbsp;</div></li><li><div>            'stock_quantity' =&gt; $product-&gt;get_stock_quantity(), &nbsp;</div></li><li><div>            'in_stock' =&gt; $product-&gt;is_in_stock(), &nbsp;</div></li><li><div>            'backorders_allowed' =&gt; $product-&gt;backorders_allowed(), &nbsp;</div></li><li><div>            'backordered' =&gt; $product-&gt;is_on_backorder(), &nbsp;</div></li><li><div>            'sold_individually' =&gt; $product-&gt;is_sold_individually(), &nbsp;</div></li><li><div>            'purchaseable' =&gt; $product-&gt;is_purchasable(), &nbsp;</div></li><li><div>            'featured' =&gt; $product-&gt;is_featured(), &nbsp;</div></li><li><div>            'visible' =&gt; $product-&gt;is_visible(), &nbsp;</div></li><li><div>            'catalog_visibility' =&gt; $product-&gt;get_catalog_visibility(), &nbsp;</div></li><li><div>            'on_sale' =&gt; $product-&gt;is_on_sale(), &nbsp;</div></li><li><div>            'product_url' =&gt; $product-&gt;is_type( 'external' ) ? $product-&gt;get_product_url() : '', &nbsp;</div></li><li><div>            'button_text' =&gt; $product-&gt;is_type( 'external' ) ? $product-&gt;get_button_text() : '', &nbsp;</div></li><li><div>            'weight' =&gt; $product-&gt;get_weight() ? wc_format_decimal( $product-&gt;get_weight(), 2 ) : null, &nbsp;</div></li><li><div>            'dimensions' =&gt; array(&nbsp;</div></li><li><div>                'length' =&gt; $product-&gt;get_length(), &nbsp;</div></li><li><div>                'width' =&gt; $product-&gt;get_width(), &nbsp;</div></li><li><div>                'height' =&gt; $product-&gt;get_height(), &nbsp;</div></li><li><div>                'unit' =&gt; get_option( 'woocommerce_dimension_unit' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'shipping_required' =&gt; $product-&gt;needs_shipping(), &nbsp;</div></li><li><div>            'shipping_taxable' =&gt; $product-&gt;is_shipping_taxable(), &nbsp;</div></li><li><div>            'shipping_class' =&gt; $product-&gt;get_shipping_class(), &nbsp;</div></li><li><div>            'shipping_class_id' =&gt; ( 0 !== $product-&gt;get_shipping_class_id() ) ? $product-&gt;get_shipping_class_id() : null, &nbsp;</div></li><li><div>            'description' =&gt; wpautop( do_shortcode( $product-&gt;get_description() ) ), &nbsp;</div></li><li><div>            'short_description' =&gt; apply_filters( 'woocommerce_short_description', $product-&gt;get_short_description() ), &nbsp;</div></li><li><div>            'reviews_allowed' =&gt; $product-&gt;get_reviews_allowed(), &nbsp;</div></li><li><div>            'average_rating' =&gt; wc_format_decimal( $product-&gt;get_average_rating(), 2 ), &nbsp;</div></li><li><div>            'rating_count' =&gt; $product-&gt;get_rating_count(), &nbsp;</div></li><li><div>            'related_ids' =&gt; array_map( 'absint', array_values( wc_get_related_products( $product-&gt;get_id() ) ) ), &nbsp;</div></li><li><div>            'upsell_ids' =&gt; array_map( 'absint', $product-&gt;get_upsell_ids() ), &nbsp;</div></li><li><div>            'cross_sell_ids' =&gt; array_map( 'absint', $product-&gt;get_cross_sell_ids() ), &nbsp;</div></li><li><div>            'parent_id' =&gt; $product-&gt;get_parent_id(), &nbsp;</div></li><li><div>            'categories' =&gt; wc_get_object_terms( $product-&gt;get_id(), 'product_cat', 'name' ), &nbsp;</div></li><li><div>            'tags' =&gt; wc_get_object_terms( $product-&gt;get_id(), 'product_tag', 'name' ), &nbsp;</div></li><li><div>            'images' =&gt; $this-&gt;get_images( $product ), &nbsp;</div></li><li><div>            'featured_src' =&gt; wp_get_attachment_url( get_post_thumbnail_id( $product-&gt;get_id() ) ), &nbsp;</div></li><li><div>            'attributes' =&gt; $this-&gt;get_attributes( $product ), &nbsp;</div></li><li><div>            'downloads' =&gt; $this-&gt;get_downloads( $product ), &nbsp;</div></li><li><div>            'download_limit' =&gt; $product-&gt;get_download_limit(), &nbsp;</div></li><li><div>            'download_expiry' =&gt; $product-&gt;get_download_expiry(), &nbsp;</div></li><li><div>            'download_type' =&gt; 'standard', &nbsp;</div></li><li><div>            'purchase_note' =&gt; wpautop( do_shortcode( wp_kses_post( $product-&gt;get_purchase_note() ) ) ), &nbsp;</div></li><li><div>            'total_sales' =&gt; $product-&gt;get_total_sales(), &nbsp;</div></li><li><div>            'variations' =&gt; array(), &nbsp;</div></li><li><div>            'parent' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an individual variation's data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_variation_data( $product ) {&nbsp;</div></li><li><div>        $prices_precision = wc_get_price_decimals();&nbsp;</div></li><li><div>        $variations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variation = wc_get_product( $child_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $variation || ! $variation-&gt;exists() ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variations[] = array(&nbsp;</div></li><li><div>                'id' =&gt; $variation-&gt;get_id(), &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $variation-&gt;get_date_created(), false, true ), &nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $variation-&gt;get_date_modified(), false, true ), &nbsp;</div></li><li><div>                'downloadable' =&gt; $variation-&gt;is_downloadable(), &nbsp;</div></li><li><div>                'virtual' =&gt; $variation-&gt;is_virtual(), &nbsp;</div></li><li><div>                'permalink' =&gt; $variation-&gt;get_permalink(), &nbsp;</div></li><li><div>                'sku' =&gt; $variation-&gt;get_sku(), &nbsp;</div></li><li><div>                'price' =&gt; wc_format_decimal( $variation-&gt;get_price(), $prices_precision ), &nbsp;</div></li><li><div>                'regular_price' =&gt; wc_format_decimal( $variation-&gt;get_regular_price(), $prices_precision ), &nbsp;</div></li><li><div>                'sale_price' =&gt; $variation-&gt;get_sale_price() ? wc_format_decimal( $variation-&gt;get_sale_price(), $prices_precision ) : null, &nbsp;</div></li><li><div>                'taxable' =&gt; $variation-&gt;is_taxable(), &nbsp;</div></li><li><div>                'tax_status' =&gt; $variation-&gt;get_tax_status(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $variation-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'managing_stock' =&gt; $variation-&gt;managing_stock(), &nbsp;</div></li><li><div>                'stock_quantity' =&gt; (int) $variation-&gt;get_stock_quantity(), &nbsp;</div></li><li><div>                'in_stock' =&gt; $variation-&gt;is_in_stock(), &nbsp;</div></li><li><div>                'backordered' =&gt; $variation-&gt;is_on_backorder(), &nbsp;</div></li><li><div>                'purchaseable' =&gt; $variation-&gt;is_purchasable(), &nbsp;</div></li><li><div>                'visible' =&gt; $variation-&gt;variation_is_visible(), &nbsp;</div></li><li><div>                'on_sale' =&gt; $variation-&gt;is_on_sale(), &nbsp;</div></li><li><div>                'weight' =&gt; $variation-&gt;get_weight() ? wc_format_decimal( $variation-&gt;get_weight(), 2 ) : null, &nbsp;</div></li><li><div>                'dimensions' =&gt; array(&nbsp;</div></li><li><div>                    'length' =&gt; $variation-&gt;get_length(), &nbsp;</div></li><li><div>                    'width' =&gt; $variation-&gt;get_width(), &nbsp;</div></li><li><div>                    'height' =&gt; $variation-&gt;get_height(), &nbsp;</div></li><li><div>                    'unit' =&gt; get_option( 'woocommerce_dimension_unit' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'shipping_class' =&gt; $variation-&gt;get_shipping_class(), &nbsp;</div></li><li><div>                'shipping_class_id' =&gt; ( 0 !== $variation-&gt;get_shipping_class_id() ) ? $variation-&gt;get_shipping_class_id() : null, &nbsp;</div></li><li><div>                'image' =&gt; $this-&gt;get_images( $variation ), &nbsp;</div></li><li><div>                'attributes' =&gt; $this-&gt;get_attributes( $variation ), &nbsp;</div></li><li><div>                'downloads' =&gt; $this-&gt;get_downloads( $variation ), &nbsp;</div></li><li><div>                'download_limit' =&gt; (int) $product-&gt;get_download_limit(), &nbsp;</div></li><li><div>                'download_expiry' =&gt; (int) $product-&gt;get_download_expiry(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $variations;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save default attributes.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param array $request&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_default_attributes( $product, $request ) {&nbsp;</div></li><li><div>        // Update default attributes options setting.&nbsp;</div></li><li><div>        if ( isset( $request['default_attribute'] ) ) {&nbsp;</div></li><li><div>            $request['default_attributes'] = $request['default_attribute'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $request['default_attributes'] ) && is_array( $request['default_attributes'] ) ) {&nbsp;</div></li><li><div>            $attributes = $product-&gt;get_attributes();&nbsp;</div></li><li><div>            $default_attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $request['default_attributes'] as $default_attr_key =&gt; $default_attr ) {&nbsp;</div></li><li><div>                if ( ! isset( $default_attr['name'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $taxonomy = sanitize_title( $default_attr['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $default_attr['slug'] ) ) {&nbsp;</div></li><li><div>                    $taxonomy = $this-&gt;get_attribute_taxonomy_by_slug( $default_attr['slug'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $attributes[ $taxonomy ] ) ) {&nbsp;</div></li><li><div>                    $_attribute = $attributes[ $taxonomy ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $_attribute['is_variation'] ) {&nbsp;</div></li><li><div>                        $value = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( isset( $default_attr['option'] ) ) {&nbsp;</div></li><li><div>                            if ( $_attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>                                // Don't use wc_clean as it destroys sanitized characters.&nbsp;</div></li><li><div>                                $value = sanitize_title( trim( stripslashes( $default_attr['option'] ) ) );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $value = wc_clean( trim( stripslashes( $default_attr['option'] ) ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $value ) {&nbsp;</div></li><li><div>                            $default_attributes[ $taxonomy ] = $value;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_default_attributes( $default_attributes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save product meta&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_product_meta( $product, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Virtual&nbsp;</div></li><li><div>        if ( isset( $data['virtual'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_virtual( $data['virtual'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Tax status&nbsp;</div></li><li><div>        if ( isset( $data['tax_status'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_tax_status( wc_clean( $data['tax_status'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Tax Class&nbsp;</div></li><li><div>        if ( isset( $data['tax_class'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_tax_class( wc_clean( $data['tax_class'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Catalog Visibility&nbsp;</div></li><li><div>        if ( isset( $data['catalog_visibility'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_catalog_visibility( wc_clean( $data['catalog_visibility'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Purchase Note&nbsp;</div></li><li><div>        if ( isset( $data['purchase_note'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_purchase_note( wc_clean( $data['purchase_note'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Featured Product&nbsp;</div></li><li><div>        if ( isset( $data['featured'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_featured( $data['featured'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Shipping data&nbsp;</div></li><li><div>        $product = $this-&gt;save_product_shipping_data( $product, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // SKU&nbsp;</div></li><li><div>        if ( isset( $data['sku'] ) ) {&nbsp;</div></li><li><div>            $sku = $product-&gt;get_sku();&nbsp;</div></li><li><div>            $new_sku = wc_clean( $data['sku'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( '' == $new_sku ) {&nbsp;</div></li><li><div>                $product-&gt;set_sku( '' );&nbsp;</div></li><li><div>            } elseif ( $new_sku !== $sku ) {&nbsp;</div></li><li><div>                if ( ! empty( $new_sku ) ) {&nbsp;</div></li><li><div>                    $unique_sku = wc_product_has_unique_sku( $product-&gt;get_id(), $new_sku );&nbsp;</div></li><li><div>                    if ( ! $unique_sku ) {&nbsp;</div></li><li><div>                        throw new WC_API_Exception( 'woocommerce_api_product_sku_already_exists', __( 'The SKU already exists on another product.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $product-&gt;set_sku( $new_sku );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $product-&gt;set_sku( '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Attributes&nbsp;</div></li><li><div>        if ( isset( $data['attributes'] ) ) {&nbsp;</div></li><li><div>            $attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $data['attributes'] as $attribute ) {&nbsp;</div></li><li><div>                $is_taxonomy = 0;&nbsp;</div></li><li><div>                $taxonomy = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! isset( $attribute['name'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $attribute_slug = sanitize_title( $attribute['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $attribute['slug'] ) ) {&nbsp;</div></li><li><div>                    $taxonomy = $this-&gt;get_attribute_taxonomy_by_slug( $attribute['slug'] );&nbsp;</div></li><li><div>                    $attribute_slug = sanitize_title( $attribute['slug'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $taxonomy ) {&nbsp;</div></li><li><div>                    $is_taxonomy = 1;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $is_taxonomy ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $attribute_id = wc_attribute_taxonomy_id_by_name( $attribute['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                        $options = $attribute['options'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! is_array( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                            // Text based attributes - Posted values are term names&nbsp;</div></li><li><div>                            $options = explode( WC_DELIMITER, $options );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $values = array_map( 'wc_sanitize_term_text_based', $options );&nbsp;</div></li><li><div>                        $values = array_filter( $values, 'strlen' );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $values = array();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Update post terms&nbsp;</div></li><li><div>                    if ( taxonomy_exists( $taxonomy ) ) {&nbsp;</div></li><li><div>                        wp_set_object_terms( $product-&gt;get_id(), $values, $taxonomy );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! empty( $values ) ) {&nbsp;</div></li><li><div>                        // Add attribute to array, but don't set values.&nbsp;</div></li><li><div>                        $attribute_object = new WC_Product_Attribute();&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_id( $attribute_id );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_name( $taxonomy );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_options( $values );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_position( isset( $attribute['position'] ) ? absint( $attribute['position'] ) : 0 );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_visible( ( isset( $attribute['visible'] ) && $attribute['visible'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_variation( ( isset( $attribute['variation'] ) && $attribute['variation'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                        $attributes[] = $attribute_object;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } elseif ( isset( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                    // Array based&nbsp;</div></li><li><div>                    if ( is_array( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                        $values = $attribute['options'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Text based, separate by pipe&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $values = array_map( 'wc_clean', explode( WC_DELIMITER, $attribute['options'] ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Custom attribute - Add attribute to array and set the values.&nbsp;</div></li><li><div>                    $attribute_object = new WC_Product_Attribute();&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_name( $attribute['name'] );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_options( $values );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_position( isset( $attribute['position'] ) ? absint( $attribute['position'] ) : 0 );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_visible( ( isset( $attribute['visible'] ) && $attribute['visible'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_variation( ( isset( $attribute['variation'] ) && $attribute['variation'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                    $attributes[] = $attribute_object;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            uasort( $attributes, 'wc_product_attribute_uasort_comparison' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_attributes( $attributes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sales and prices&nbsp;</div></li><li><div>        if ( in_array( $product-&gt;get_type(), array( 'variable', 'grouped' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Variable and grouped products have no prices.&nbsp;</div></li><li><div>            $product-&gt;set_regular_price( '' );&nbsp;</div></li><li><div>            $product-&gt;set_sale_price( '' );&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_to( '' );&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_from( '' );&nbsp;</div></li><li><div>            $product-&gt;set_price( '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Regular Price&nbsp;</div></li><li><div>            if ( isset( $data['regular_price'] ) ) {&nbsp;</div></li><li><div>                $regular_price = ( '' === $data['regular_price'] ) ? '' : $data['regular_price'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $regular_price = $product-&gt;get_regular_price();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sale Price&nbsp;</div></li><li><div>            if ( isset( $data['sale_price'] ) ) {&nbsp;</div></li><li><div>                $sale_price = ( '' === $data['sale_price'] ) ? '' : $data['sale_price'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $sale_price = $product-&gt;get_sale_price();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_regular_price( $regular_price );&nbsp;</div></li><li><div>            $product-&gt;set_sale_price( $sale_price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_from'] ) ) {&nbsp;</div></li><li><div>                $date_from = $data['sale_price_dates_from'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $date_from = $product-&gt;get_date_on_sale_from() ? date( 'Y-m-d', $product-&gt;get_date_on_sale_from()-&gt;getTimestamp() ) : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_to'] ) ) {&nbsp;</div></li><li><div>                $date_to = $data['sale_price_dates_to'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $date_to = $product-&gt;get_date_on_sale_to() ? date( 'Y-m-d', $product-&gt;get_date_on_sale_to()-&gt;getTimestamp() ) : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $date_to && ! $date_from ) {&nbsp;</div></li><li><div>                $date_from = strtotime( 'NOW', current_time( 'timestamp', true ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_to( $date_to );&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_from( $date_from );&nbsp;</div></li><li><div>            if ( $product-&gt;is_on_sale() ) {&nbsp;</div></li><li><div>                $product-&gt;set_price( $product-&gt;get_sale_price() );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $product-&gt;set_price( $product-&gt;get_regular_price() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product parent ID for groups&nbsp;</div></li><li><div>        if ( isset( $data['parent_id'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_parent_id( absint( $data['parent_id'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sold Individually&nbsp;</div></li><li><div>        if ( isset( $data['sold_individually'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_sold_individually( true === $data['sold_individually'] ? 'yes' : '' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Stock status&nbsp;</div></li><li><div>        if ( isset( $data['in_stock'] ) ) {&nbsp;</div></li><li><div>            $stock_status = ( true === $data['in_stock'] ) ? 'instock' : 'outofstock';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $stock_status = $product-&gt;get_stock_status();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( '' === $stock_status ) {&nbsp;</div></li><li><div>                $stock_status = 'instock';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Stock Data&nbsp;</div></li><li><div>        if ( 'yes' == get_option( 'woocommerce_manage_stock' ) ) {&nbsp;</div></li><li><div>            // Manage stock&nbsp;</div></li><li><div>            if ( isset( $data['managing_stock'] ) ) {&nbsp;</div></li><li><div>                $managing_stock = ( true === $data['managing_stock'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( $managing_stock );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $managing_stock = $product-&gt;get_manage_stock() ? 'yes' : 'no';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Backorders&nbsp;</div></li><li><div>            if ( isset( $data['backorders'] ) ) {&nbsp;</div></li><li><div>                if ( 'notify' == $data['backorders'] ) {&nbsp;</div></li><li><div>                    $backorders = 'notify';&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $backorders = ( true === $data['backorders'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $backorders = $product-&gt;get_backorders();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'grouped' ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_backorders( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>            } elseif ( $product-&gt;is_type( 'external' ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_backorders( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_status( 'instock' );&nbsp;</div></li><li><div>            } elseif ( 'yes' == $managing_stock ) {&nbsp;</div></li><li><div>                $product-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Stock status is always determined by children so sync later.&nbsp;</div></li><li><div>                if ( ! $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>                    $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Stock quantity&nbsp;</div></li><li><div>                if ( isset( $data['stock_quantity'] ) ) {&nbsp;</div></li><li><div>                    $product-&gt;set_stock_quantity( wc_stock_amount( $data['stock_quantity'] ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // Don't manage stock.&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>                $product-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Upsells&nbsp;</div></li><li><div>        if ( isset( $data['upsell_ids'] ) ) {&nbsp;</div></li><li><div>            $upsells = array();&nbsp;</div></li><li><div>            $ids = $data['upsell_ids'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $ids ) ) {&nbsp;</div></li><li><div>                foreach ( $ids as $id ) {&nbsp;</div></li><li><div>                    if ( $id && $id &gt; 0 ) {&nbsp;</div></li><li><div>                        $upsells[] = $id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product-&gt;set_upsell_ids( $upsells );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $product-&gt;set_upsell_ids( array() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cross sells&nbsp;</div></li><li><div>        if ( isset( $data['cross_sell_ids'] ) ) {&nbsp;</div></li><li><div>            $crosssells = array();&nbsp;</div></li><li><div>            $ids = $data['cross_sell_ids'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $ids ) ) {&nbsp;</div></li><li><div>                foreach ( $ids as $id ) {&nbsp;</div></li><li><div>                    if ( $id && $id &gt; 0 ) {&nbsp;</div></li><li><div>                        $crosssells[] = $id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product-&gt;set_cross_sell_ids( $crosssells );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $product-&gt;set_cross_sell_ids( array() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product categories&nbsp;</div></li><li><div>        if ( isset( $data['categories'] ) && is_array( $data['categories'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_category_ids( $data['categories'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product tags&nbsp;</div></li><li><div>        if ( isset( $data['tags'] ) && is_array( $data['tags'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_tag_ids( $data['tags'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Downloadable&nbsp;</div></li><li><div>        if ( isset( $data['downloadable'] ) ) {&nbsp;</div></li><li><div>            $is_downloadable = ( true === $data['downloadable'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>            $product-&gt;set_downloadable( $is_downloadable );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $is_downloadable = $product-&gt;get_downloadable() ? 'yes' : 'no';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Downloadable options&nbsp;</div></li><li><div>        if ( 'yes' == $is_downloadable ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Downloadable files&nbsp;</div></li><li><div>            if ( isset( $data['downloads'] ) && is_array( $data['downloads'] ) ) {&nbsp;</div></li><li><div>                $product = $this-&gt;save_downloadable_files( $product, $data['downloads'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Download limit&nbsp;</div></li><li><div>            if ( isset( $data['download_limit'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_download_limit( $data['download_limit'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Download expiry&nbsp;</div></li><li><div>            if ( isset( $data['download_expiry'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_download_expiry( $data['download_expiry'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product url&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'external' ) ) {&nbsp;</div></li><li><div>            if ( isset( $data['product_url'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_product_url( $data['product_url'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['button_text'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_button_text( $data['button_text'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Reviews allowed&nbsp;</div></li><li><div>        if ( isset( $data['reviews_allowed'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_reviews_allowed( $data['reviews_allowed'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save default attributes for variable products.&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>            $product = $this-&gt;save_default_attributes( $product, $data );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Do action for product type&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_process_product_meta_' . $product-&gt;get_type(), $product-&gt;get_id(), $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save variations&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     * @param  array $request&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_variations( $product, $request ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $product-&gt;get_id();&nbsp;</div></li><li><div>        $attributes = $product-&gt;get_attributes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $request['variations'] as $menu_order =&gt; $data ) {&nbsp;</div></li><li><div>            $variation_id = isset( $data['id'] ) ? absint( $data['id'] ) : 0;&nbsp;</div></li><li><div>            $variation = new WC_Product_Variation( $variation_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Create initial name and status.&nbsp;</div></li><li><div>            if ( ! $variation-&gt;get_slug() ) {&nbsp;</div></li><li><div>                /** translators: 1: variation id 2: product name */&nbsp;</div></li><li><div>                $variation-&gt;set_name( sprintf( __( 'Variation #%1$s of %2$s', 'woocommerce' ), $variation-&gt;get_id(), $product-&gt;get_name() ) );&nbsp;</div></li><li><div>                $variation-&gt;set_status( isset( $data['visible'] ) && false === $data['visible'] ? 'private' : 'publish' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Parent ID.&nbsp;</div></li><li><div>            $variation-&gt;set_parent_id( $product-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Menu order.&nbsp;</div></li><li><div>            $variation-&gt;set_menu_order( $menu_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Status.&nbsp;</div></li><li><div>            if ( isset( $data['visible'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_status( false === $data['visible'] ? 'private' : 'publish' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // SKU.&nbsp;</div></li><li><div>            if ( isset( $data['sku'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_sku( wc_clean( $data['sku'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Thumbnail.&nbsp;</div></li><li><div>            if ( isset( $data['image'] ) && is_array( $data['image'] ) ) {&nbsp;</div></li><li><div>                $image = current( $data['image'] );&nbsp;</div></li><li><div>                if ( is_array( $image ) ) {&nbsp;</div></li><li><div>                    $image['position'] = 0;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $variation = $this-&gt;save_product_images( $variation, array( $image ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Virtual variation.&nbsp;</div></li><li><div>            if ( isset( $data['virtual'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_virtual( $data['virtual'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Downloadable variation.&nbsp;</div></li><li><div>            if ( isset( $data['downloadable'] ) ) {&nbsp;</div></li><li><div>                $is_downloadable = $data['downloadable'];&nbsp;</div></li><li><div>                $variation-&gt;set_downloadable( $is_downloadable );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $is_downloadable = $variation-&gt;get_downloadable();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Downloads.&nbsp;</div></li><li><div>            if ( $is_downloadable ) {&nbsp;</div></li><li><div>                // Downloadable files.&nbsp;</div></li><li><div>                if ( isset( $data['downloads'] ) && is_array( $data['downloads'] ) ) {&nbsp;</div></li><li><div>                    $variation = $this-&gt;save_downloadable_files( $variation, $data['downloads'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Download limit.&nbsp;</div></li><li><div>                if ( isset( $data['download_limit'] ) ) {&nbsp;</div></li><li><div>                    $variation-&gt;set_download_limit( $data['download_limit'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Download expiry.&nbsp;</div></li><li><div>                if ( isset( $data['download_expiry'] ) ) {&nbsp;</div></li><li><div>                    $variation-&gt;set_download_expiry( $data['download_expiry'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Shipping data.&nbsp;</div></li><li><div>            $variation = $this-&gt;save_product_shipping_data( $variation, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Stock handling.&nbsp;</div></li><li><div>            $manage_stock = (bool) $variation-&gt;get_manage_stock();&nbsp;</div></li><li><div>            if ( isset( $data['managing_stock'] ) ) {&nbsp;</div></li><li><div>                $manage_stock = $data['managing_stock'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;set_manage_stock( $manage_stock );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stock_status = $variation-&gt;get_stock_status();&nbsp;</div></li><li><div>            if ( isset( $data['in_stock'] ) ) {&nbsp;</div></li><li><div>                $stock_status = true === $data['in_stock'] ? 'instock' : 'outofstock';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $backorders = $variation-&gt;get_backorders();&nbsp;</div></li><li><div>            if ( isset( $data['backorders'] ) ) {&nbsp;</div></li><li><div>                $backorders = $data['backorders'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $manage_stock ) {&nbsp;</div></li><li><div>                if ( isset( $data['stock_quantity'] ) ) {&nbsp;</div></li><li><div>                    $variation-&gt;set_stock_quantity( $data['stock_quantity'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $variation-&gt;set_backorders( 'no' );&nbsp;</div></li><li><div>                $variation-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Regular Price.&nbsp;</div></li><li><div>            if ( isset( $data['regular_price'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_regular_price( $data['regular_price'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sale Price.&nbsp;</div></li><li><div>            if ( isset( $data['sale_price'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_sale_price( $data['sale_price'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_from'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_date_on_sale_from( $data['sale_price_dates_from'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_to'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_date_on_sale_to( $data['sale_price_dates_to'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Tax class.&nbsp;</div></li><li><div>            if ( isset( $data['tax_class'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_tax_class( $data['tax_class'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update taxonomies.&nbsp;</div></li><li><div>            if ( isset( $data['attributes'] ) ) {&nbsp;</div></li><li><div>                $_attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $data['attributes'] as $attribute_key =&gt; $attribute ) {&nbsp;</div></li><li><div>                    if ( ! isset( $attribute['name'] ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $taxonomy = 0;&nbsp;</div></li><li><div>                    $_attribute = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $attribute['slug'] ) ) {&nbsp;</div></li><li><div>                        $taxonomy = $this-&gt;get_attribute_taxonomy_by_slug( $attribute['slug'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                        $taxonomy = sanitize_title( $attribute['name'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $attributes[ $taxonomy ] ) ) {&nbsp;</div></li><li><div>                        $_attribute = $attributes[ $taxonomy ];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $_attribute['is_variation'] ) && $_attribute['is_variation'] ) {&nbsp;</div></li><li><div>                        $_attribute_key = sanitize_title( $_attribute['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( isset( $_attribute['is_taxonomy'] ) && $_attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>                            // Don't use wc_clean as it destroys sanitized characters&nbsp;</div></li><li><div>                            $_attribute_value = isset( $attribute['option'] ) ? sanitize_title( stripslashes( $attribute['option'] ) ) : '';&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $_attribute_value = isset( $attribute['option'] ) ? wc_clean( stripslashes( $attribute['option'] ) ) : '';&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $_attributes[ $_attribute_key ] = $_attribute_value;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $variation-&gt;set_attributes( $_attributes );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_save_product_variation', $variation_id, $menu_order, $variation );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save product shipping data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function save_product_shipping_data( $product, $data ) {&nbsp;</div></li><li><div>        if ( isset( $data['weight'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_weight( '' === $data['weight'] ? '' : wc_format_decimal( $data['weight'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product dimensions&nbsp;</div></li><li><div>        if ( isset( $data['dimensions'] ) ) {&nbsp;</div></li><li><div>            // Height&nbsp;</div></li><li><div>            if ( isset( $data['dimensions']['height'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_height( '' === $data['dimensions']['height'] ? '' : wc_format_decimal( $data['dimensions']['height'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Width&nbsp;</div></li><li><div>            if ( isset( $data['dimensions']['width'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_width( '' === $data['dimensions']['width'] ? '' : wc_format_decimal( $data['dimensions']['width'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Length&nbsp;</div></li><li><div>            if ( isset( $data['dimensions']['length'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_length( '' === $data['dimensions']['length'] ? '' : wc_format_decimal( $data['dimensions']['length'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Virtual&nbsp;</div></li><li><div>        if ( isset( $data['virtual'] ) ) {&nbsp;</div></li><li><div>            $virtual = ( true === $data['virtual'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'yes' == $virtual ) {&nbsp;</div></li><li><div>                $product-&gt;set_weight( '' );&nbsp;</div></li><li><div>                $product-&gt;set_height( '' );&nbsp;</div></li><li><div>                $product-&gt;set_length( '' );&nbsp;</div></li><li><div>                $product-&gt;set_width( '' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Shipping class&nbsp;</div></li><li><div>        if ( isset( $data['shipping_class'] ) ) {&nbsp;</div></li><li><div>            $data_store = $product-&gt;get_data_store();&nbsp;</div></li><li><div>            $shipping_class_id = $data_store-&gt;get_shipping_class_id_by_slug( wc_clean( $data['shipping_class'] ) );&nbsp;</div></li><li><div>            if ( $shipping_class_id ) {&nbsp;</div></li><li><div>                $product-&gt;set_shipping_class_id( $shipping_class_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save downloadable files&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param array $downloads&nbsp;</div></li><li><div>     * @param int $deprecated Deprecated since 3.0.&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function save_downloadable_files( $product, $downloads, $deprecated = 0 ) {&nbsp;</div></li><li><div>        if ( $deprecated ) {&nbsp;</div></li><li><div>            wc_deprecated_argument( 'variation_id', '3.0', 'save_downloadable_files() does not require a variation_id anymore.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $files = array();&nbsp;</div></li><li><div>        foreach ( $downloads as $key =&gt; $file ) {&nbsp;</div></li><li><div>            if ( isset( $file['url'] ) ) {&nbsp;</div></li><li><div>                $file['file'] = $file['url'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $file['file'] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $download = new WC_Product_Download();&nbsp;</div></li><li><div>            $download-&gt;set_id( $key );&nbsp;</div></li><li><div>            $download-&gt;set_name( $file['name'] ? $file['name'] : wc_get_filename_from_url( $file['file'] ) );&nbsp;</div></li><li><div>            $download-&gt;set_file( apply_filters( 'woocommerce_file_download_path', $file['file'], $product, $key ) );&nbsp;</div></li><li><div>            $files[] = $download;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $product-&gt;set_downloads( $files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get attribute taxonomy by slug.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $slug&nbsp;</div></li><li><div>     * @return string|null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_attribute_taxonomy_by_slug( $slug ) {&nbsp;</div></li><li><div>        $taxonomy = null;&nbsp;</div></li><li><div>        $attribute_taxonomies = wc_get_attribute_taxonomies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $attribute_taxonomies as $key =&gt; $tax ) {&nbsp;</div></li><li><div>            if ( $slug == $tax-&gt;attribute_name ) {&nbsp;</div></li><li><div>                $taxonomy = 'pa_' . $tax-&gt;attribute_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $taxonomy;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the images for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_images( $product ) {&nbsp;</div></li><li><div>        $images = $attachment_ids = array();&nbsp;</div></li><li><div>        $product_image = $product-&gt;get_image_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add featured image.&nbsp;</div></li><li><div>        if ( ! empty( $product_image ) ) {&nbsp;</div></li><li><div>            $attachment_ids[] = $product_image;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add gallery images.&nbsp;</div></li><li><div>        $attachment_ids = array_merge( $attachment_ids, $product-&gt;get_gallery_image_ids() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build image data.&nbsp;</div></li><li><div>        foreach ( $attachment_ids as $position =&gt; $attachment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment_post = get_post( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $attachment_post ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment = wp_get_attachment_image_src( $attachment_id, 'full' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_array( $attachment ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $images[] = array(&nbsp;</div></li><li><div>                'id' =&gt; (int) $attachment_id, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $attachment_post-&gt;post_date_gmt ), &nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $attachment_post-&gt;post_modified_gmt ), &nbsp;</div></li><li><div>                'src' =&gt; current( $attachment ), &nbsp;</div></li><li><div>                'title' =&gt; get_the_title( $attachment_id ), &nbsp;</div></li><li><div>                'alt' =&gt; get_post_meta( $attachment_id, '_wp_attachment_image_alt', true ), &nbsp;</div></li><li><div>                'position' =&gt; (int) $position, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set a placeholder image if the product has no images set.&nbsp;</div></li><li><div>        if ( empty( $images ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $images[] = array(&nbsp;</div></li><li><div>                'id' =&gt; 0, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( time() ), // Default to now.&nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( time() ), &nbsp;</div></li><li><div>                'src' =&gt; wc_placeholder_img_src(), &nbsp;</div></li><li><div>                'title' =&gt; __( 'Placeholder', 'woocommerce' ), &nbsp;</div></li><li><div>                'alt' =&gt; __( 'Placeholder', 'woocommerce' ), &nbsp;</div></li><li><div>                'position' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $images;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save product images&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param  array $images&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_product_images( $product, $images ) {&nbsp;</div></li><li><div>        if ( is_array( $images ) ) {&nbsp;</div></li><li><div>            $gallery = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $images as $image ) {&nbsp;</div></li><li><div>                if ( isset( $image['position'] ) && 0 == $image['position'] ) {&nbsp;</div></li><li><div>                    $attachment_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( 0 === $attachment_id && isset( $image['src'] ) ) {&nbsp;</div></li><li><div>                        $upload = $this-&gt;upload_product_image( esc_url_raw( $image['src'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( is_wp_error( $upload ) ) {&nbsp;</div></li><li><div>                            throw new WC_API_Exception( 'woocommerce_api_cannot_upload_product_image', $upload-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $attachment_id = $this-&gt;set_product_image_as_attachment( $upload, $product-&gt;get_id() );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $product-&gt;set_image_id( $attachment_id );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $attachment_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( 0 === $attachment_id && isset( $image['src'] ) ) {&nbsp;</div></li><li><div>                        $upload = $this-&gt;upload_product_image( esc_url_raw( $image['src'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( is_wp_error( $upload ) ) {&nbsp;</div></li><li><div>                            throw new WC_API_Exception( 'woocommerce_api_cannot_upload_product_image', $upload-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $gallery[] = $this-&gt;set_product_image_as_attachment( $upload, $product-&gt;get_id() );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $gallery[] = $attachment_id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $gallery ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_gallery_image_ids( $gallery );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;set_image_id( '' );&nbsp;</div></li><li><div>            $product-&gt;set_gallery_image_ids( array() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Upload image from URL&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param  string $image_url&nbsp;</div></li><li><div>     * @return int|WP_Error attachment id&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function upload_product_image( $image_url ) {&nbsp;</div></li><li><div>        $file_name = basename( current( explode( '?', $image_url ) ) );&nbsp;</div></li><li><div>        $parsed_url = @parse_url( $image_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check parsed URL&nbsp;</div></li><li><div>        if ( ! $parsed_url || ! is_array( $parsed_url ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_image', sprintf( __( 'Invalid URL %s.', 'woocommerce' ), $image_url ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure url is valid&nbsp;</div></li><li><div>        $image_url = str_replace( ' ', '%20', $image_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the file&nbsp;</div></li><li><div>        $response = wp_safe_remote_get( $image_url, array(&nbsp;</div></li><li><div>            'timeout' =&gt; 10, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_remote_product_image', sprintf( __( 'Error getting remote image %s.', 'woocommerce' ), $image_url ) . ' ' . sprintf( __( 'Error: %s.', 'woocommerce' ), $response-&gt;get_error_message() ), 400 );&nbsp;</div></li><li><div>        } elseif ( 200 !== wp_remote_retrieve_response_code( $response ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_remote_product_image', sprintf( __( 'Error getting remote image %s.', 'woocommerce' ), $image_url ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure we have a file name and type&nbsp;</div></li><li><div>        $wp_filetype = wp_check_filetype( $file_name, wc_rest_allowed_image_mime_types() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $wp_filetype['type'] ) {&nbsp;</div></li><li><div>            $headers = wp_remote_retrieve_headers( $response );&nbsp;</div></li><li><div>            if ( isset( $headers['content-disposition'] ) && strstr( $headers['content-disposition'], 'filename=' ) ) {&nbsp;</div></li><li><div>                $disposition = end( explode( 'filename=', $headers['content-disposition'] ) );&nbsp;</div></li><li><div>                $disposition = sanitize_file_name( $disposition );&nbsp;</div></li><li><div>                $file_name = $disposition;&nbsp;</div></li><li><div>            } elseif ( isset( $headers['content-type'] ) && strstr( $headers['content-type'], 'image/' ) ) {&nbsp;</div></li><li><div>                $file_name = 'image.' . str_replace( 'image/', '', $headers['content-type'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            unset( $headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Recheck filetype&nbsp;</div></li><li><div>            $wp_filetype = wp_check_filetype( $file_name, wc_rest_allowed_image_mime_types() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $wp_filetype['type'] ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_image', __( 'Invalid image type.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Upload the file&nbsp;</div></li><li><div>        $upload = wp_upload_bits( $file_name, '', wp_remote_retrieve_body( $response ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $upload['error'] ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_product_image_upload_error', $upload['error'], 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get filesize&nbsp;</div></li><li><div>        $filesize = filesize( $upload['file'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 0 == $filesize ) {&nbsp;</div></li><li><div>            @unlink( $upload['file'] );&nbsp;</div></li><li><div>            unset( $upload );&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_product_image_upload_file_error', __( 'Zero size file downloaded.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $upload;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets product image as attachment and returns the attachment ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $upload&nbsp;</div></li><li><div>     * @param int $id&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_product_image_as_attachment( $upload, $id ) {&nbsp;</div></li><li><div>        $info = wp_check_filetype( $upload['file'] );&nbsp;</div></li><li><div>        $title = '';&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $image_meta = @wp_read_image_metadata( $upload['file'] ) ) {&nbsp;</div></li><li><div>            if ( trim( $image_meta['title'] ) && ! is_numeric( sanitize_title( $image_meta['title'] ) ) ) {&nbsp;</div></li><li><div>                $title = wc_clean( $image_meta['title'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( trim( $image_meta['caption'] ) ) {&nbsp;</div></li><li><div>                $content = wc_clean( $image_meta['caption'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachment = array(&nbsp;</div></li><li><div>            'post_mime_type' =&gt; $info['type'], &nbsp;</div></li><li><div>            'guid' =&gt; $upload['url'], &nbsp;</div></li><li><div>            'post_parent' =&gt; $id, &nbsp;</div></li><li><div>            'post_title' =&gt; $title, &nbsp;</div></li><li><div>            'post_content' =&gt; $content, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachment_id = wp_insert_attachment( $attachment, $upload['file'], $id );&nbsp;</div></li><li><div>        if ( ! is_wp_error( $attachment_id ) ) {&nbsp;</div></li><li><div>            wp_update_attachment_metadata( $attachment_id, wp_generate_attachment_metadata( $attachment_id, $upload['file'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $attachment_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get attribute options.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $product_id&nbsp;</div></li><li><div>     * @param array $attribute&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_attribute_options( $product_id, $attribute ) {&nbsp;</div></li><li><div>        if ( isset( $attribute['is_taxonomy'] ) && $attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>            return wc_get_product_terms( $product_id, $attribute['name'], array( 'fields' =&gt; 'names' ) );&nbsp;</div></li><li><div>        } elseif ( isset( $attribute['value'] ) ) {&nbsp;</div></li><li><div>            return array_map( 'trim', explode( '|', $attribute['value'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the attributes for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_attributes( $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variation' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // variation attributes&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_variation_attributes() as $attribute_name =&gt; $attribute ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // taxonomy-based attributes are prefixed with `pa_`, otherwise simply `attribute_`&nbsp;</div></li><li><div>                $attributes[] = array(&nbsp;</div></li><li><div>                    'name' =&gt; wc_attribute_label( str_replace( 'attribute_', '', $attribute_name ) ), &nbsp;</div></li><li><div>                    'slug' =&gt; str_replace( 'attribute_', '', str_replace( 'pa_', '', $attribute_name ) ), &nbsp;</div></li><li><div>                    'option' =&gt; $attribute, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_attributes() as $attribute ) {&nbsp;</div></li><li><div>                $attributes[] = array(&nbsp;</div></li><li><div>                    'name' =&gt; wc_attribute_label( $attribute['name'] ), &nbsp;</div></li><li><div>                    'slug' =&gt; str_replace( 'pa_', '', $attribute['name'] ), &nbsp;</div></li><li><div>                    'position' =&gt; (int) $attribute['position'], &nbsp;</div></li><li><div>                    'visible' =&gt; (bool) $attribute['is_visible'], &nbsp;</div></li><li><div>                    'variation' =&gt; (bool) $attribute['is_variation'], &nbsp;</div></li><li><div>                    'options' =&gt; $this-&gt;get_attribute_options( $product-&gt;get_id(), $attribute ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $attributes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the downloads for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_downloads( $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $downloads = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_downloadable() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_downloads() as $file_id =&gt; $file ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $downloads[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $file_id, // do not cast as int as this is a hash&nbsp;</div></li><li><div>                    'name' =&gt; $file['name'], &nbsp;</div></li><li><div>                    'file' =&gt; $file['file'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $downloads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product attributes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_attributes( $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_attributes', __( 'You do not have permission to read product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_attributes = array();&nbsp;</div></li><li><div>            $attribute_taxonomies = wc_get_attribute_taxonomies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $attribute_taxonomies as $attribute ) {&nbsp;</div></li><li><div>                $product_attributes[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; intval( $attribute-&gt;attribute_id ), &nbsp;</div></li><li><div>                    'name' =&gt; $attribute-&gt;attribute_label, &nbsp;</div></li><li><div>                    'slug' =&gt; wc_attribute_taxonomy_name( $attribute-&gt;attribute_name ), &nbsp;</div></li><li><div>                    'type' =&gt; $attribute-&gt;attribute_type, &nbsp;</div></li><li><div>                    'order_by' =&gt; $attribute-&gt;attribute_orderby, &nbsp;</div></li><li><div>                    'has_archives' =&gt; (bool) $attribute-&gt;attribute_public, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_attributes' =&gt; apply_filters( 'woocommerce_api_product_attributes_response', $product_attributes, $attribute_taxonomies, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product attribute for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param string $id product attribute term ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_attribute( $id, $fields = null ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate ID&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'Invalid product attribute ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_categories', __( 'You do not have permission to read product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT *&nbsp;</div></li><li><div>                FROM {$wpdb-&gt;prefix}woocommerce_attribute_taxonomies&nbsp;</div></li><li><div>                WHERE attribute_id = %d&nbsp;</div></li><li><div>             &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $attribute ) || is_null( $attribute ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_attribute = array(&nbsp;</div></li><li><div>                'id' =&gt; intval( $attribute-&gt;attribute_id ), &nbsp;</div></li><li><div>                'name' =&gt; $attribute-&gt;attribute_label, &nbsp;</div></li><li><div>                'slug' =&gt; wc_attribute_taxonomy_name( $attribute-&gt;attribute_name ), &nbsp;</div></li><li><div>                'type' =&gt; $attribute-&gt;attribute_type, &nbsp;</div></li><li><div>                'order_by' =&gt; $attribute-&gt;attribute_orderby, &nbsp;</div></li><li><div>                'has_archives' =&gt; (bool) $attribute-&gt;attribute_public, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_attribute' =&gt; apply_filters( 'woocommerce_api_product_attribute_response', $product_attribute, $id, $fields, $attribute, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate attribute data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.4.0&nbsp;</div></li><li><div>     * @param  string $name&nbsp;</div></li><li><div>     * @param  string $slug&nbsp;</div></li><li><div>     * @param  string $type&nbsp;</div></li><li><div>     * @param  string $order_by&nbsp;</div></li><li><div>     * @param  bool   $new_data&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function validate_attribute_data( $name, $slug, $type, $order_by, $new_data = true ) {&nbsp;</div></li><li><div>        if ( empty( $name ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_name', sprintf( __( 'Missing parameter %s', 'woocommerce' ), 'name' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strlen( $slug ) &gt;= 28 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_slug_too_long', sprintf( __( 'Slug &quot;%s&quot; is too long (28 characters max). Shorten it, please.', 'woocommerce' ), $slug ), 400 );&nbsp;</div></li><li><div>        } elseif ( wc_check_if_attribute_name_is_reserved( $slug ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_slug_reserved_name', sprintf( __( 'Slug &quot;%s&quot; is not allowed because it is a reserved term. Change it, please.', 'woocommerce' ), $slug ), 400 );&nbsp;</div></li><li><div>        } elseif ( $new_data && taxonomy_exists( wc_attribute_taxonomy_name( $slug ) ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_slug_already_exists', sprintf( __( 'Slug &quot;%s&quot; is already in use. Change it, please.', 'woocommerce' ), $slug ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Validate the attribute type&nbsp;</div></li><li><div>        if ( ! in_array( wc_clean( $type ), array_keys( wc_get_attribute_types() ) ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_type', sprintf( __( 'Invalid product attribute type - the product attribute type must be any of these: %s', 'woocommerce' ), implode( ', ', array_keys( wc_get_attribute_types() ) ) ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Validate the attribute order by&nbsp;</div></li><li><div>        if ( ! in_array( wc_clean( $order_by ), array( 'menu_order', 'name', 'name_num', 'id' ) ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_order_by', sprintf( __( 'Invalid product attribute order_by type - the product attribute order_by type must be any of these: %s', 'woocommerce' ), implode( ', ', array( 'menu_order', 'name', 'name_num', 'id' ) ) ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product attribute&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param array $data posted data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product_attribute( $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_attribute'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product_attribute' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product_attribute'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product_attribute', __( 'You do not have permission to create product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_attribute_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                $data['name'] = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set the attribute slug&nbsp;</div></li><li><div>            if ( ! isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $data['slug'] = wc_sanitize_taxonomy_name( stripslashes( $data['name'] ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $data['slug'] = preg_replace( '/^pa\_/', '', wc_sanitize_taxonomy_name( stripslashes( $data['slug'] ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set attribute type when not sent&nbsp;</div></li><li><div>            if ( ! isset( $data['type'] ) ) {&nbsp;</div></li><li><div>                $data['type'] = 'select';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set order by when not sent&nbsp;</div></li><li><div>            if ( ! isset( $data['order_by'] ) ) {&nbsp;</div></li><li><div>                $data['order_by'] = 'menu_order';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the attribute data&nbsp;</div></li><li><div>            $this-&gt;validate_attribute_data( $data['name'], $data['slug'], $data['type'], $data['order_by'], true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $insert = $wpdb-&gt;insert(&nbsp;</div></li><li><div>                $wpdb-&gt;prefix . 'woocommerce_attribute_taxonomies', &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'attribute_label' =&gt; $data['name'], &nbsp;</div></li><li><div>                    'attribute_name' =&gt; $data['slug'], &nbsp;</div></li><li><div>                    'attribute_type' =&gt; $data['type'], &nbsp;</div></li><li><div>                    'attribute_orderby' =&gt; $data['order_by'], &nbsp;</div></li><li><div>                    'attribute_public' =&gt; isset( $data['has_archives'] ) && true === $data['has_archives'] ? 1 : 0, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( '%s', '%s', '%s', '%s', '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the product creation&nbsp;</div></li><li><div>            if ( is_wp_error( $insert ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product_attribute', $insert-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product_attribute', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear transients&nbsp;</div></li><li><div>            delete_transient( 'wc_attribute_taxonomies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_attribute( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product attribute&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param int $id the attribute ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product_attribute( $id, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_attribute'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product_attribute' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $data = $data['product_attribute'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_edit_product_attribute', __( 'You do not have permission to edit product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_attribute_data', $data, $this );&nbsp;</div></li><li><div>            $attribute = $this-&gt;get_product_attribute( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $attribute ) ) {&nbsp;</div></li><li><div>                return $attribute;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute_name = isset( $data['name'] ) ? $data['name'] : $attribute['product_attribute']['name'];&nbsp;</div></li><li><div>            $attribute_type = isset( $data['type'] ) ? $data['type'] : $attribute['product_attribute']['type'];&nbsp;</div></li><li><div>            $attribute_order_by = isset( $data['order_by'] ) ? $data['order_by'] : $attribute['product_attribute']['order_by'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $attribute_slug = wc_sanitize_taxonomy_name( stripslashes( $data['slug'] ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $attribute_slug = $attribute['product_attribute']['slug'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $attribute_slug = preg_replace( '/^pa\_/', '', $attribute_slug );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['has_archives'] ) ) {&nbsp;</div></li><li><div>                $attribute_public = true === $data['has_archives'] ? 1 : 0;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $attribute_public = $attribute['product_attribute']['has_archives'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the attribute data&nbsp;</div></li><li><div>            $this-&gt;validate_attribute_data( $attribute_name, $attribute_slug, $attribute_type, $attribute_order_by, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update = $wpdb-&gt;update(&nbsp;</div></li><li><div>                $wpdb-&gt;prefix . 'woocommerce_attribute_taxonomies', &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'attribute_label' =&gt; $attribute_name, &nbsp;</div></li><li><div>                    'attribute_name' =&gt; $attribute_slug, &nbsp;</div></li><li><div>                    'attribute_type' =&gt; $attribute_type, &nbsp;</div></li><li><div>                    'attribute_orderby' =&gt; $attribute_order_by, &nbsp;</div></li><li><div>                    'attribute_public' =&gt; $attribute_public, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( 'attribute_id' =&gt; $id ), &nbsp;</div></li><li><div>                array( '%s', '%s', '%s', '%s', '%d' ), &nbsp;</div></li><li><div>                array( '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the product creation&nbsp;</div></li><li><div>            if ( false === $update ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_edit_product_attribute', __( 'Could not edit the attribute', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product_attribute', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear transients&nbsp;</div></li><li><div>            delete_transient( 'wc_attribute_taxonomies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_attribute( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product attribute&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.4.0&nbsp;</div></li><li><div>     * @param  int $id the product attribute ID&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product_attribute( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_delete_product_attribute', __( 'You do not have permission to delete product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute_name = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT attribute_name&nbsp;</div></li><li><div>                FROM {$wpdb-&gt;prefix}woocommerce_attribute_taxonomies&nbsp;</div></li><li><div>                WHERE attribute_id = %d&nbsp;</div></li><li><div>             &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $attribute_name ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $deleted = $wpdb-&gt;delete(&nbsp;</div></li><li><div>                $wpdb-&gt;prefix . 'woocommerce_attribute_taxonomies', &nbsp;</div></li><li><div>                array( 'attribute_id' =&gt; $id ), &nbsp;</div></li><li><div>                array( '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( false === $deleted ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_attribute', __( 'Could not delete the attribute', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name( $attribute_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( taxonomy_exists( $taxonomy ) ) {&nbsp;</div></li><li><div>                $terms = get_terms( $taxonomy, 'orderby=name&hide_empty=0' );&nbsp;</div></li><li><div>                foreach ( $terms as $term ) {&nbsp;</div></li><li><div>                    wp_delete_term( $term-&gt;term_id, $taxonomy );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_attribute_deleted', $id, $attribute_name, $taxonomy );&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_product_attribute', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear transients&nbsp;</div></li><li><div>            delete_transient( 'wc_attribute_taxonomies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product_attribute' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get product by SKU&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @deprecated 2.4.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.3.0&nbsp;</div></li><li><div>     * @param  int    $sku the product SKU&nbsp;</div></li><li><div>     * @param  string $fields&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_by_sku( $sku, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = wc_get_product_id_by_sku( $sku );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_sku', __( 'Invalid product SKU', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product( $id, $fields );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Clear product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function clear_product( $product_id ) {&nbsp;</div></li><li><div>        if ( ! is_numeric( $product_id ) || 0 &gt;= $product_id ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete product attachments&nbsp;</div></li><li><div>        $attachments = get_children( array(&nbsp;</div></li><li><div>            'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>            'post_status' =&gt; 'any', &nbsp;</div></li><li><div>            'post_type' =&gt; 'attachment', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( (array) $attachments as $attachment ) {&nbsp;</div></li><li><div>            wp_delete_attachment( $attachment-&gt;ID, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete product&nbsp;</div></li><li><div>        $product = wc_get_product( $product_id );&nbsp;</div></li><li><div>        $product-&gt;delete();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk update or insert products&nbsp;</div></li><li><div>     * Accepts an array with products in the formats supported by&nbsp;</div></li><li><div>     * WC_API_Products-&gt;create_product() and WC_API_Products-&gt;edit_product()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function bulk( $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['products'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_products_data', sprintf( __( 'No %1$s data specified to create/edit %1$s', 'woocommerce' ), 'products' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['products'];&nbsp;</div></li><li><div>            $limit = apply_filters( 'woocommerce_api_bulk_limit', 100, 'products' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Limit bulk operation&nbsp;</div></li><li><div>            if ( count( $data ) &gt; $limit ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_products_request_entity_too_large', sprintf( __( 'Unable to accept more than %s items for this request.', 'woocommerce' ), $limit ), 413 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $data as $_product ) {&nbsp;</div></li><li><div>                $product_id = 0;&nbsp;</div></li><li><div>                $product_sku = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Try to get the product ID&nbsp;</div></li><li><div>                if ( isset( $_product['id'] ) ) {&nbsp;</div></li><li><div>                    $product_id = intval( $_product['id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! $product_id && isset( $_product['sku'] ) ) {&nbsp;</div></li><li><div>                    $product_sku = wc_clean( $_product['sku'] );&nbsp;</div></li><li><div>                    $product_id = wc_get_product_id_by_sku( $product_sku );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Product exists / edit product&nbsp;</div></li><li><div>                    $edit = $this-&gt;edit_product( $product_id, array( 'product' =&gt; $_product ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $edit ) ) {&nbsp;</div></li><li><div>                        $products[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $product_id, &nbsp;</div></li><li><div>                            'sku' =&gt; $product_sku, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $edit-&gt;get_error_code(), 'message' =&gt; $edit-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $products[] = $edit['product'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Product don't exists / create product&nbsp;</div></li><li><div>                    $new = $this-&gt;create_product( array( 'product' =&gt; $_product ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $new ) ) {&nbsp;</div></li><li><div>                        $products[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $product_id, &nbsp;</div></li><li><div>                            'sku' =&gt; $product_sku, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $new-&gt;get_error_code(), 'message' =&gt; $new-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $products[] = $new['product'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'products' =&gt; apply_filters( 'woocommerce_api_products_bulk_response', $products, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.2/files/includes-api-legacy-v3-class-wc-api-products/" class="file">/includes/api/legacy/v3/class-wc-api-products.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class WC_API_Products extends WC_API_Resource {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $base the route base */&nbsp;</div></li><li><div>    protected $base = '/products';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register the routes for this class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * GET/POST /products&nbsp;</div></li><li><div>     * GET /products/count&nbsp;</div></li><li><div>     * GET/PUT/DELETE /products/&lt;id&gt;&nbsp;</div></li><li><div>     * GET /products/&lt;id&gt;/reviews&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $routes&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_routes( $routes ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products&nbsp;</div></li><li><div>        $routes[ $this-&gt;base ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_products' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/count&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/count' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_products_count' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/&lt;id&gt;/reviews&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)/reviews' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_reviews' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /products/&lt;id&gt;/orders&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)/orders' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_orders' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products/categories&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/categories' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_categories' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product_category' ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/categories/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/categories/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_category' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product_category' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product_category' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products/tags&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/tags' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_tags' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product_tag' ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/tags/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/tags/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_tag' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product_tag' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product_tag' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products/shipping_classes&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/shipping_classes' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_shipping_classes' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product_shipping_class' ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/shipping_classes/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/shipping_classes/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_shipping_class' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product_shipping_class' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product_shipping_class' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products/attributes&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/attributes' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_attributes' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product_attribute' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/attributes/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/attributes/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_attribute' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product_attribute' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product_attribute' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/POST /products/attributes/&lt;attribute_id&gt;/terms&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/attributes/(?P&lt;attribute_id&gt;\d+)/terms' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_attribute_terms' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_product_attribute_term' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET/PUT/DELETE /products/attributes/&lt;attribute_id&gt;/terms/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/attributes/(?P&lt;attribute_id&gt;\d+)/terms/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_product_attribute_term' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_product_attribute_term' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_product_attribute_term' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # POST|PUT /products/bulk&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/bulk' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'bulk' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $routes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all products&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @param int $page&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products( $fields = null, $type = null, $filter = array(), $page = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>            $filter['type'] = $type;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter['page'] = $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_products( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $query-&gt;posts as $product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;is_readable( $product_id ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products[] = current( $this-&gt;get_product( $product_id, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;server-&gt;add_pagination_headers( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'products' =&gt; $products );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add data that applies to every product type&nbsp;</div></li><li><div>        $product_data = $this-&gt;get_product_data( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add variations to variable products&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) && $product-&gt;has_child() ) {&nbsp;</div></li><li><div>            $product_data['variations'] = $this-&gt;get_variation_data( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add the parent product data to an individual variation&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variation' ) && $product-&gt;get_parent_id() ) {&nbsp;</div></li><li><div>            $product_data['parent'] = $this-&gt;get_product_data( $product-&gt;get_parent_id() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add grouped products data&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'grouped' ) && $product-&gt;has_child() ) {&nbsp;</div></li><li><div>            $product_data['grouped_products'] = $this-&gt;get_grouped_products_data( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'simple' ) ) {&nbsp;</div></li><li><div>            $parent_id = $product-&gt;get_parent_id();&nbsp;</div></li><li><div>            if ( ! empty( $parent_id ) ) {&nbsp;</div></li><li><div>                $_product = wc_get_product( $parent_id );&nbsp;</div></li><li><div>                $product_data['parent'] = $this-&gt;get_product_data( $_product );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'product' =&gt; apply_filters( 'woocommerce_api_product_response', $product_data, $product, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total number of products&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products_count( $type = null, $filter = array() ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! current_user_can( 'read_private_products' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_products_count', __( 'You do not have permission to read the products count', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>                $filter['type'] = $type;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query = $this-&gt;query_products( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'count' =&gt; (int) $query-&gt;found_posts );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $data posted data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product( $data ) {&nbsp;</div></li><li><div>        $id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_products' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product', __( 'You do not have permission to create products', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if product title is specified.&nbsp;</div></li><li><div>            if ( ! isset( $data['title'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_title', sprintf( __( 'Missing parameter %s', 'woocommerce' ), 'title' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check product type.&nbsp;</div></li><li><div>            if ( ! isset( $data['type'] ) ) {&nbsp;</div></li><li><div>                $data['type'] = 'simple';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set visible visibility when not sent.&nbsp;</div></li><li><div>            if ( ! isset( $data['catalog_visibility'] ) ) {&nbsp;</div></li><li><div>                $data['catalog_visibility'] = 'visible';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the product type.&nbsp;</div></li><li><div>            if ( ! in_array( wc_clean( $data['type'] ), array_keys( wc_get_product_types() ) ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_type', sprintf( __( 'Invalid product type - the product type must be any of these: %s', 'woocommerce' ), implode( ', ', array_keys( wc_get_product_types() ) ) ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Enable description html tags.&nbsp;</div></li><li><div>            $post_content = isset( $data['description'] ) ? wc_clean( $data['description'] ) : '';&nbsp;</div></li><li><div>            if ( $post_content && isset( $data['enable_html_description'] ) && true === $data['enable_html_description'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $post_content = $data['description'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Enable short description html tags.&nbsp;</div></li><li><div>            $post_excerpt = isset( $data['short_description'] ) ? wc_clean( $data['short_description'] ) : '';&nbsp;</div></li><li><div>            if ( $post_excerpt && isset( $data['enable_html_short_description'] ) && true === $data['enable_html_short_description'] ) {&nbsp;</div></li><li><div>                $post_excerpt = $data['short_description'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $classname = WC_Product_Factory::get_classname_from_product_type( $data['type'] );&nbsp;</div></li><li><div>            if ( ! class_exists( $classname ) ) {&nbsp;</div></li><li><div>                $classname = 'WC_Product_Simple';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product = new $classname();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_name( wc_clean( $data['title'] ) );&nbsp;</div></li><li><div>            $product-&gt;set_status( isset( $data['status'] ) ? wc_clean( $data['status'] ) : 'publish' );&nbsp;</div></li><li><div>            $product-&gt;set_short_description( isset( $data['short_description'] ) ? $post_excerpt : '' );&nbsp;</div></li><li><div>            $product-&gt;set_description( isset( $data['description'] ) ? $post_content : '' );&nbsp;</div></li><li><div>            $product-&gt;set_menu_order( isset( $data['menu_order'] ) ? intval( $data['menu_order'] ) : 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $data['name'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_slug( sanitize_title( $data['name'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Attempts to create the new product.&nbsp;</div></li><li><div>            $product-&gt;save();&nbsp;</div></li><li><div>            $id = $product-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the product creation.&nbsp;</div></li><li><div>            if ( 0 &gt;= $id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product', $id-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for featured/gallery images, upload it and set it.&nbsp;</div></li><li><div>            if ( isset( $data['images'] ) ) {&nbsp;</div></li><li><div>                $product = $this-&gt;save_product_images( $product, $data['images'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save product meta fields.&nbsp;</div></li><li><div>            $product = $this-&gt;save_product_meta( $product, $data );&nbsp;</div></li><li><div>            $product-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save variations.&nbsp;</div></li><li><div>            if ( isset( $data['type'] ) && 'variable' == $data['type'] && isset( $data['variations'] ) && is_array( $data['variations'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;save_variations( $product, $data );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear cache/transients.&nbsp;</div></li><li><div>            wc_delete_product_transients( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product( $id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            $this-&gt;clear_product( $id );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            $this-&gt;clear_product( $id );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $id the product ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product( $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $this-&gt;validate_request( $id, 'product', 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>                return $id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product title.&nbsp;</div></li><li><div>            if ( isset( $data['title'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_name( wc_clean( $data['title'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product name (slug).&nbsp;</div></li><li><div>            if ( isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_slug( wc_clean( $data['name'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product status.&nbsp;</div></li><li><div>            if ( isset( $data['status'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_status( wc_clean( $data['status'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product short description.&nbsp;</div></li><li><div>            if ( isset( $data['short_description'] ) ) {&nbsp;</div></li><li><div>                // Enable short description html tags.&nbsp;</div></li><li><div>                $post_excerpt = ( isset( $data['enable_html_short_description'] ) && true === $data['enable_html_short_description'] ) ? $data['short_description'] : wc_clean( $data['short_description'] );&nbsp;</div></li><li><div>                $product-&gt;set_short_description( $post_excerpt );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Product description.&nbsp;</div></li><li><div>            if ( isset( $data['description'] ) ) {&nbsp;</div></li><li><div>                // Enable description html tags.&nbsp;</div></li><li><div>                $post_content = ( isset( $data['enable_html_description'] ) && true === $data['enable_html_description'] ) ? $data['description'] : wc_clean( $data['description'] );&nbsp;</div></li><li><div>                $product-&gt;set_description( $post_content );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the product type.&nbsp;</div></li><li><div>            if ( isset( $data['type'] ) && ! in_array( wc_clean( $data['type'] ), array_keys( wc_get_product_types() ) ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_type', sprintf( __( 'Invalid product type - the product type must be any of these: %s', 'woocommerce' ), implode( ', ', array_keys( wc_get_product_types() ) ) ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Menu order.&nbsp;</div></li><li><div>            if ( isset( $data['menu_order'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_menu_order( intval( $data['menu_order'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check for featured/gallery images, upload it and set it.&nbsp;</div></li><li><div>            if ( isset( $data['images'] ) ) {&nbsp;</div></li><li><div>                $product = $this-&gt;save_product_images( $product, $data['images'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save product meta fields.&nbsp;</div></li><li><div>            $product = $this-&gt;save_product_meta( $product, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save variations.&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>                if ( isset( $data['variations'] ) && is_array( $data['variations'] ) ) {&nbsp;</div></li><li><div>                    $this-&gt;save_variations( $product, $data );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // Just sync variations.&nbsp;</div></li><li><div>                    $product = WC_Product_Variable::sync( $product, false );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear cache/transients.&nbsp;</div></li><li><div>            wc_delete_product_transients( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product( $id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $id the product ID.&nbsp;</div></li><li><div>     * @param bool $force true to permanently delete order, false to move to trash.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product( $id, $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_delete_product', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If we're forcing, then delete permanently.&nbsp;</div></li><li><div>        if ( $force ) {&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>                foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>                    $child = wc_get_product( $child_id );&nbsp;</div></li><li><div>                    $child-&gt;delete( true );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( $product-&gt;is_type( 'grouped' ) ) {&nbsp;</div></li><li><div>                foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>                    $child = wc_get_product( $child_id );&nbsp;</div></li><li><div>                    $child-&gt;set_parent_id( 0 );&nbsp;</div></li><li><div>                    $child-&gt;save();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;delete( true );&nbsp;</div></li><li><div>            $result = $product-&gt;get_id() &gt; 0 ? false : true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;delete();&nbsp;</div></li><li><div>            $result = 'trash' === $product-&gt;get_status();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $result ) {&nbsp;</div></li><li><div>            return new WP_Error( 'woocommerce_api_cannot_delete_product', sprintf( __( 'This %s cannot be deleted', 'woocommerce' ), 'product' ), array( 'status' =&gt; 500 ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete parent product transients.&nbsp;</div></li><li><div>        if ( $parent_id = wp_get_post_parent_id( $id ) ) {&nbsp;</div></li><li><div>            wc_delete_product_transients( $parent_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force ) {&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Permanently deleted %s', 'woocommerce' ), 'product' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( '202' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the reviews for a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the product ID to get reviews for&nbsp;</div></li><li><div>     * @param string $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_reviews( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $comments = get_approved_comments( $id );&nbsp;</div></li><li><div>        $reviews = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $reviews[] = array(&nbsp;</div></li><li><div>                'id' =&gt; intval( $comment-&gt;comment_ID ), &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $comment-&gt;comment_date_gmt ), &nbsp;</div></li><li><div>                'review' =&gt; $comment-&gt;comment_content, &nbsp;</div></li><li><div>                'rating' =&gt; get_comment_meta( $comment-&gt;comment_ID, 'rating', true ), &nbsp;</div></li><li><div>                'reviewer_name' =&gt; $comment-&gt;comment_author, &nbsp;</div></li><li><div>                'reviewer_email' =&gt; $comment-&gt;comment_author_email, &nbsp;</div></li><li><div>                'verified' =&gt; wc_review_is_from_verified_owner( $comment-&gt;comment_ID ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'product_reviews' =&gt; apply_filters( 'woocommerce_api_product_reviews_response', $reviews, $id, $fields, $comments, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the orders for a product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param int $id the product ID to get orders for&nbsp;</div></li><li><div>     * @param string fields  fields to retrieve&nbsp;</div></li><li><div>     * @param string $filter filters to include in response&nbsp;</div></li><li><div>     * @param string $status the order status to retrieve&nbsp;</div></li><li><div>     * @param $page  $page   page to retrieve&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_orders( $id, $fields = null, $filter = array(), $status = null, $page = 1 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'product', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>            SELECT order_id&nbsp;</div></li><li><div>            FROM {$wpdb-&gt;prefix}woocommerce_order_items&nbsp;</div></li><li><div>            WHERE order_item_id IN ( SELECT order_item_id FROM {$wpdb-&gt;prefix}woocommerce_order_itemmeta WHERE meta_key = '_product_id' AND meta_value = %d )&nbsp;</div></li><li><div>            AND order_item_type = 'line_item'&nbsp;</div></li><li><div>         &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $order_ids ) ) {&nbsp;</div></li><li><div>            return array( 'orders' =&gt; array() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter = array_merge( $filter, array(&nbsp;</div></li><li><div>            'in' =&gt; implode( ', ', $order_ids ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orders = WC()-&gt;api-&gt;WC_API_Orders-&gt;get_orders( $fields, $filter, $status, $page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'orders' =&gt; apply_filters( 'woocommerce_api_product_orders_response', $orders['orders'], $id, $filter, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product categories&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_categories( $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_categories', __( 'You do not have permission to read product categories', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_categories = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $terms = get_terms( 'product_cat', array( 'hide_empty' =&gt; false, 'fields' =&gt; 'ids' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $terms as $term_id ) {&nbsp;</div></li><li><div>                $product_categories[] = current( $this-&gt;get_product_category( $term_id, $fields ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_categories' =&gt; apply_filters( 'woocommerce_api_product_categories_response', $product_categories, $terms, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product category for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $id product category term ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_category( $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate ID&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_category_id', __( 'Invalid product category ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_categories', __( 'You do not have permission to read product categories', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = get_term( $id, 'product_cat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) || is_null( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_category_id', __( 'A product category with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term_id = intval( $term-&gt;term_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get category display type&nbsp;</div></li><li><div>            $display_type = get_woocommerce_term_meta( $term_id, 'display_type' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Get category image&nbsp;</div></li><li><div>            $image = '';&nbsp;</div></li><li><div>            if ( $image_id = get_woocommerce_term_meta( $term_id, 'thumbnail_id' ) ) {&nbsp;</div></li><li><div>                $image = wp_get_attachment_url( $image_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_category = array(&nbsp;</div></li><li><div>                'id' =&gt; $term_id, &nbsp;</div></li><li><div>                'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div>                'parent' =&gt; $term-&gt;parent, &nbsp;</div></li><li><div>                'description' =&gt; $term-&gt;description, &nbsp;</div></li><li><div>                'display' =&gt; $display_type ? $display_type : 'default', &nbsp;</div></li><li><div>                'image' =&gt; $image ? esc_url( $image ) : '', &nbsp;</div></li><li><div>                'count' =&gt; intval( $term-&gt;count ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_category' =&gt; apply_filters( 'woocommerce_api_product_category_response', $product_category, $id, $fields, $term, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product category.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  array          $data Posted data&nbsp;</div></li><li><div>     * @return array|WP_Error       Product category if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                              will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product_category( $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_category'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_category_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product_category' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product_category', __( 'You do not have permission to create product categories', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $defaults = array(&nbsp;</div></li><li><div>                'name' =&gt; '', &nbsp;</div></li><li><div>                'slug' =&gt; '', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div>                'parent' =&gt; 0, &nbsp;</div></li><li><div>                'display' =&gt; 'default', &nbsp;</div></li><li><div>                'image' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = wp_parse_args( $data['product_category'], $defaults );&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_category_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check parent.&nbsp;</div></li><li><div>            $data['parent'] = absint( $data['parent'] );&nbsp;</div></li><li><div>            if ( $data['parent'] ) {&nbsp;</div></li><li><div>                $parent = get_term_by( 'id', $data['parent'], 'product_cat' );&nbsp;</div></li><li><div>                if ( ! $parent ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_product_category_parent', __( 'Product category parent is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If value of image is numeric, assume value as image_id.&nbsp;</div></li><li><div>            $image = $data['image'];&nbsp;</div></li><li><div>            $image_id = 0;&nbsp;</div></li><li><div>            if ( is_numeric( $image ) ) {&nbsp;</div></li><li><div>                $image_id = absint( $image );&nbsp;</div></li><li><div>            } elseif ( ! empty( $image ) ) {&nbsp;</div></li><li><div>                $upload = $this-&gt;upload_product_category_image( esc_url_raw( $image ) );&nbsp;</div></li><li><div>                $image_id = $this-&gt;set_product_category_image_as_attachment( $upload );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $insert = wp_insert_term( $data['name'], 'product_cat', $data );&nbsp;</div></li><li><div>            if ( is_wp_error( $insert ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product_category', $insert-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $insert['term_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            update_woocommerce_term_meta( $id, 'display_type', 'default' === $data['display'] ? '' : sanitize_text_field( $data['display'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if image_id is a valid image attachment before updating the term meta.&nbsp;</div></li><li><div>            if ( $image_id && wp_attachment_is_image( $image_id ) ) {&nbsp;</div></li><li><div>                update_woocommerce_term_meta( $id, 'thumbnail_id', $image_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product_category', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_category( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product category.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int            $id   Product category term ID&nbsp;</div></li><li><div>     * @param  array          $data Posted data&nbsp;</div></li><li><div>     * @return array|WP_Error       Product category if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                              will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product_category( $id, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_category'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_category', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product_category' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $data = $data['product_category'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_edit_product_category', __( 'You do not have permission to edit product categories', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_category_data', $data, $this );&nbsp;</div></li><li><div>            $category = $this-&gt;get_product_category( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $category ) ) {&nbsp;</div></li><li><div>                return $category;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['image'] ) ) {&nbsp;</div></li><li><div>                $image_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // If value of image is numeric, assume value as image_id.&nbsp;</div></li><li><div>                $image = $data['image'];&nbsp;</div></li><li><div>                if ( is_numeric( $image ) ) {&nbsp;</div></li><li><div>                    $image_id = absint( $image );&nbsp;</div></li><li><div>                } elseif ( ! empty( $image ) ) {&nbsp;</div></li><li><div>                    $upload = $this-&gt;upload_product_category_image( esc_url_raw( $image ) );&nbsp;</div></li><li><div>                    $image_id = $this-&gt;set_product_category_image_as_attachment( $upload );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // In case client supplies invalid image or wants to unset category image.&nbsp;</div></li><li><div>                if ( ! wp_attachment_is_image( $image_id ) ) {&nbsp;</div></li><li><div>                    $image_id = '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update = wp_update_term( $id, 'product_cat', $data );&nbsp;</div></li><li><div>            if ( is_wp_error( $update ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_edit_product_catgory', __( 'Could not edit the category', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $data['display'] ) ) {&nbsp;</div></li><li><div>                update_woocommerce_term_meta( $id, 'display_type', 'default' === $data['display'] ? '' : sanitize_text_field( $data['display'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $image_id ) ) {&nbsp;</div></li><li><div>                update_woocommerce_term_meta( $id, 'thumbnail_id', $image_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product_category', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_category( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product category.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int            $id Product category term ID&nbsp;</div></li><li><div>     * @return array|WP_Error     Success message if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                            will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product_category( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_delete_product_category', __( 'You do not have permission to delete product category', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $deleted = wp_delete_term( $id, 'product_cat' );&nbsp;</div></li><li><div>            if ( ! $deleted || is_wp_error( $deleted ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_category', __( 'Could not delete the category', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // When a term is deleted, delete its meta.&nbsp;</div></li><li><div>            if ( get_option( 'db_version' ) &lt; 34370 ) {&nbsp;</div></li><li><div>                $wpdb-&gt;delete( $wpdb-&gt;woocommerce_termmeta, array( 'woocommerce_term_id' =&gt; $id ), array( '%d' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_product_category', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product_category' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product tags.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  string|null $fields Fields to limit response to&nbsp;</div></li><li><div>     * @return array               Product tags&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_tags( $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_tags', __( 'You do not have permission to read product tags', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_tags = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $terms = get_terms( 'product_tag', array( 'hide_empty' =&gt; false, 'fields' =&gt; 'ids' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $terms as $term_id ) {&nbsp;</div></li><li><div>                $product_tags[] = current( $this-&gt;get_product_tag( $term_id, $fields ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_tags' =&gt; apply_filters( 'woocommerce_api_product_tags_response', $product_tags, $terms, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product tag for the given ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  string $id          Product tag term ID&nbsp;</div></li><li><div>     * @param  string|null $fields Fields to limit response to&nbsp;</div></li><li><div>     * @return array               Product tag&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_tag( $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate ID&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_tag_id', __( 'Invalid product tag ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_tags', __( 'You do not have permission to read product tags', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = get_term( $id, 'product_tag' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) || is_null( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_tag_id', __( 'A product tag with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term_id = intval( $term-&gt;term_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $tag = array(&nbsp;</div></li><li><div>                'id' =&gt; $term_id, &nbsp;</div></li><li><div>                'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div>                'description' =&gt; $term-&gt;description, &nbsp;</div></li><li><div>                'count' =&gt; intval( $term-&gt;count ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_tag' =&gt; apply_filters( 'woocommerce_api_product_tag_response', $tag, $id, $fields, $term, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product tag.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  array          $data Posted data&nbsp;</div></li><li><div>     * @return array|WP_Error       Product tag if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                              will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product_tag( $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_tag'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_tag_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product_tag' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product_tag', __( 'You do not have permission to create product tags', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $defaults = array(&nbsp;</div></li><li><div>                'name' =&gt; '', &nbsp;</div></li><li><div>                'slug' =&gt; '', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = wp_parse_args( $data['product_tag'], $defaults );&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_tag_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $insert = wp_insert_term( $data['name'], 'product_tag', $data );&nbsp;</div></li><li><div>            if ( is_wp_error( $insert ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product_tag', $insert-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $id = $insert['term_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product_tag', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_tag( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product tag.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int            $id   Product tag term ID&nbsp;</div></li><li><div>     * @param  array          $data Posted data&nbsp;</div></li><li><div>     * @return array|WP_Error       Product tag if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                              will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product_tag( $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_tag'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_tag', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product_tag' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $data = $data['product_tag'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_edit_product_tag', __( 'You do not have permission to edit product tags', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_tag_data', $data, $this );&nbsp;</div></li><li><div>            $tag = $this-&gt;get_product_tag( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $tag ) ) {&nbsp;</div></li><li><div>                return $tag;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update = wp_update_term( $id, 'product_tag', $data );&nbsp;</div></li><li><div>            if ( is_wp_error( $update ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_edit_product_tag', __( 'Could not edit the tag', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product_tag', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_tag( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product tag.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int            $id Product tag term ID&nbsp;</div></li><li><div>     * @return array|WP_Error     Success message if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                            will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product_tag( $id ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_delete_product_tag', __( 'You do not have permission to delete product tag', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $deleted = wp_delete_term( $id, 'product_tag' );&nbsp;</div></li><li><div>            if ( ! $deleted || is_wp_error( $deleted ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_tag', __( 'Could not delete the tag', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_product_tag', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product_tag' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get product post objects&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $args request arguments for filtering query&nbsp;</div></li><li><div>     * @return WP_Query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function query_products( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set base query arguments&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_type' =&gt; 'product', &nbsp;</div></li><li><div>            'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>            'meta_query' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Taxonomy query to filter products by type, category, tag, shipping class, and&nbsp;</div></li><li><div>        // attribute.&nbsp;</div></li><li><div>        $tax_query = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Map between taxonomy name and arg's key.&nbsp;</div></li><li><div>        $taxonomies_arg_map = array(&nbsp;</div></li><li><div>            'product_type' =&gt; 'type', &nbsp;</div></li><li><div>            'product_cat' =&gt; 'category', &nbsp;</div></li><li><div>            'product_tag' =&gt; 'tag', &nbsp;</div></li><li><div>            'product_shipping_class' =&gt; 'shipping_class', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add attribute taxonomy names into the map.&nbsp;</div></li><li><div>        foreach ( wc_get_attribute_taxonomy_names() as $attribute_name ) {&nbsp;</div></li><li><div>            $taxonomies_arg_map[ $attribute_name ] = $attribute_name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set tax_query for each passed arg.&nbsp;</div></li><li><div>        foreach ( $taxonomies_arg_map as $tax_name =&gt; $arg ) {&nbsp;</div></li><li><div>            if ( ! empty( $args[ $arg ] ) ) {&nbsp;</div></li><li><div>                $terms = explode( ', ', $args[ $arg ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $tax_query[] = array(&nbsp;</div></li><li><div>                    'taxonomy' =&gt; $tax_name, &nbsp;</div></li><li><div>                    'field' =&gt; 'slug', &nbsp;</div></li><li><div>                    'terms' =&gt; $terms, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                unset( $args[ $arg ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $tax_query ) ) {&nbsp;</div></li><li><div>            $query_args['tax_query'] = $tax_query;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Filter by specific sku&nbsp;</div></li><li><div>        if ( ! empty( $args['sku'] ) ) {&nbsp;</div></li><li><div>            if ( ! is_array( $query_args['meta_query'] ) ) {&nbsp;</div></li><li><div>                $query_args['meta_query'] = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['meta_query'][] = array(&nbsp;</div></li><li><div>                'key' =&gt; '_sku', &nbsp;</div></li><li><div>                'value' =&gt; $args['sku'], &nbsp;</div></li><li><div>                'compare' =&gt; '=', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['post_type'] = array( 'product', 'product_variation' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_args = $this-&gt;merge_query_args( $query_args, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_Query( $query_args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get standard product data that applies to every product type&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|int $product&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_product_data( $product ) {&nbsp;</div></li><li><div>        if ( is_numeric( $product ) ) {&nbsp;</div></li><li><div>            $product = wc_get_product( $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'title' =&gt; $product-&gt;get_name(), &nbsp;</div></li><li><div>            'id' =&gt; $product-&gt;get_id(), &nbsp;</div></li><li><div>            'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $product-&gt;get_date_created(), false, true ), &nbsp;</div></li><li><div>            'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $product-&gt;get_date_modified(), false, true ), &nbsp;</div></li><li><div>            'type' =&gt; $product-&gt;get_type(), &nbsp;</div></li><li><div>            'status' =&gt; $product-&gt;get_status(), &nbsp;</div></li><li><div>            'downloadable' =&gt; $product-&gt;is_downloadable(), &nbsp;</div></li><li><div>            'virtual' =&gt; $product-&gt;is_virtual(), &nbsp;</div></li><li><div>            'permalink' =&gt; $product-&gt;get_permalink(), &nbsp;</div></li><li><div>            'sku' =&gt; $product-&gt;get_sku(), &nbsp;</div></li><li><div>            'price' =&gt; $product-&gt;get_price(), &nbsp;</div></li><li><div>            'regular_price' =&gt; $product-&gt;get_regular_price(), &nbsp;</div></li><li><div>            'sale_price' =&gt; $product-&gt;get_sale_price() ? $product-&gt;get_sale_price() : null, &nbsp;</div></li><li><div>            'price_html' =&gt; $product-&gt;get_price_html(), &nbsp;</div></li><li><div>            'taxable' =&gt; $product-&gt;is_taxable(), &nbsp;</div></li><li><div>            'tax_status' =&gt; $product-&gt;get_tax_status(), &nbsp;</div></li><li><div>            'tax_class' =&gt; $product-&gt;get_tax_class(), &nbsp;</div></li><li><div>            'managing_stock' =&gt; $product-&gt;managing_stock(), &nbsp;</div></li><li><div>            'stock_quantity' =&gt; $product-&gt;get_stock_quantity(), &nbsp;</div></li><li><div>            'in_stock' =&gt; $product-&gt;is_in_stock(), &nbsp;</div></li><li><div>            'backorders_allowed' =&gt; $product-&gt;backorders_allowed(), &nbsp;</div></li><li><div>            'backordered' =&gt; $product-&gt;is_on_backorder(), &nbsp;</div></li><li><div>            'sold_individually' =&gt; $product-&gt;is_sold_individually(), &nbsp;</div></li><li><div>            'purchaseable' =&gt; $product-&gt;is_purchasable(), &nbsp;</div></li><li><div>            'featured' =&gt; $product-&gt;is_featured(), &nbsp;</div></li><li><div>            'visible' =&gt; $product-&gt;is_visible(), &nbsp;</div></li><li><div>            'catalog_visibility' =&gt; $product-&gt;get_catalog_visibility(), &nbsp;</div></li><li><div>            'on_sale' =&gt; $product-&gt;is_on_sale(), &nbsp;</div></li><li><div>            'product_url' =&gt; $product-&gt;is_type( 'external' ) ? $product-&gt;get_product_url() : '', &nbsp;</div></li><li><div>            'button_text' =&gt; $product-&gt;is_type( 'external' ) ? $product-&gt;get_button_text() : '', &nbsp;</div></li><li><div>            'weight' =&gt; $product-&gt;get_weight() ? $product-&gt;get_weight() : null, &nbsp;</div></li><li><div>            'dimensions' =&gt; array(&nbsp;</div></li><li><div>                'length' =&gt; $product-&gt;get_length(), &nbsp;</div></li><li><div>                'width' =&gt; $product-&gt;get_width(), &nbsp;</div></li><li><div>                'height' =&gt; $product-&gt;get_height(), &nbsp;</div></li><li><div>                'unit' =&gt; get_option( 'woocommerce_dimension_unit' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'shipping_required' =&gt; $product-&gt;needs_shipping(), &nbsp;</div></li><li><div>            'shipping_taxable' =&gt; $product-&gt;is_shipping_taxable(), &nbsp;</div></li><li><div>            'shipping_class' =&gt; $product-&gt;get_shipping_class(), &nbsp;</div></li><li><div>            'shipping_class_id' =&gt; ( 0 !== $product-&gt;get_shipping_class_id() ) ? $product-&gt;get_shipping_class_id() : null, &nbsp;</div></li><li><div>            'description' =&gt; wpautop( do_shortcode( $product-&gt;get_description() ) ), &nbsp;</div></li><li><div>            'short_description' =&gt; apply_filters( 'woocommerce_short_description', $product-&gt;get_short_description() ), &nbsp;</div></li><li><div>            'reviews_allowed' =&gt; $product-&gt;get_reviews_allowed(), &nbsp;</div></li><li><div>            'average_rating' =&gt; wc_format_decimal( $product-&gt;get_average_rating(), 2 ), &nbsp;</div></li><li><div>            'rating_count' =&gt; $product-&gt;get_rating_count(), &nbsp;</div></li><li><div>            'related_ids' =&gt; array_map( 'absint', array_values( wc_get_related_products( $product-&gt;get_id() ) ) ), &nbsp;</div></li><li><div>            'upsell_ids' =&gt; array_map( 'absint', $product-&gt;get_upsell_ids() ), &nbsp;</div></li><li><div>            'cross_sell_ids' =&gt; array_map( 'absint', $product-&gt;get_cross_sell_ids() ), &nbsp;</div></li><li><div>            'parent_id' =&gt; $product-&gt;get_parent_id(), &nbsp;</div></li><li><div>            'categories' =&gt; wc_get_object_terms( $product-&gt;get_id(), 'product_cat', 'name' ), &nbsp;</div></li><li><div>            'tags' =&gt; wc_get_object_terms( $product-&gt;get_id(), 'product_tag', 'name' ), &nbsp;</div></li><li><div>            'images' =&gt; $this-&gt;get_images( $product ), &nbsp;</div></li><li><div>            'featured_src' =&gt; wp_get_attachment_url( get_post_thumbnail_id( $product-&gt;get_id() ) ), &nbsp;</div></li><li><div>            'attributes' =&gt; $this-&gt;get_attributes( $product ), &nbsp;</div></li><li><div>            'downloads' =&gt; $this-&gt;get_downloads( $product ), &nbsp;</div></li><li><div>            'download_limit' =&gt; $product-&gt;get_download_limit(), &nbsp;</div></li><li><div>            'download_expiry' =&gt; $product-&gt;get_download_expiry(), &nbsp;</div></li><li><div>            'download_type' =&gt; 'standard', &nbsp;</div></li><li><div>            'purchase_note' =&gt; wpautop( do_shortcode( wp_kses_post( $product-&gt;get_purchase_note() ) ) ), &nbsp;</div></li><li><div>            'total_sales' =&gt; $product-&gt;get_total_sales(), &nbsp;</div></li><li><div>            'variations' =&gt; array(), &nbsp;</div></li><li><div>            'parent' =&gt; array(), &nbsp;</div></li><li><div>            'grouped_products' =&gt; array(), &nbsp;</div></li><li><div>            'menu_order' =&gt; $this-&gt;get_product_menu_order( $product ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get product menu order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.3&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_product_menu_order( $product ) {&nbsp;</div></li><li><div>        $menu_order = $product-&gt;get_menu_order();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_api_product_menu_order', $menu_order, $product );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an individual variation's data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_variation_data( $product ) {&nbsp;</div></li><li><div>        $variations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $child_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $variation || ! $variation-&gt;exists() ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variations[] = array(&nbsp;</div></li><li><div>                'id' =&gt; $variation-&gt;get_id(), &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $variation-&gt;get_date_created(), false, true ), &nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $variation-&gt;get_date_modified(), false, true ), &nbsp;</div></li><li><div>                'downloadable' =&gt; $variation-&gt;is_downloadable(), &nbsp;</div></li><li><div>                'virtual' =&gt; $variation-&gt;is_virtual(), &nbsp;</div></li><li><div>                'permalink' =&gt; $variation-&gt;get_permalink(), &nbsp;</div></li><li><div>                'sku' =&gt; $variation-&gt;get_sku(), &nbsp;</div></li><li><div>                'price' =&gt; $variation-&gt;get_price(), &nbsp;</div></li><li><div>                'regular_price' =&gt; $variation-&gt;get_regular_price(), &nbsp;</div></li><li><div>                'sale_price' =&gt; $variation-&gt;get_sale_price() ? $variation-&gt;get_sale_price() : null, &nbsp;</div></li><li><div>                'taxable' =&gt; $variation-&gt;is_taxable(), &nbsp;</div></li><li><div>                'tax_status' =&gt; $variation-&gt;get_tax_status(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $variation-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'managing_stock' =&gt; $variation-&gt;managing_stock(), &nbsp;</div></li><li><div>                'stock_quantity' =&gt; $variation-&gt;get_stock_quantity(), &nbsp;</div></li><li><div>                'in_stock' =&gt; $variation-&gt;is_in_stock(), &nbsp;</div></li><li><div>                'backorders_allowed' =&gt; $variation-&gt;backorders_allowed(), &nbsp;</div></li><li><div>                'backordered' =&gt; $variation-&gt;is_on_backorder(), &nbsp;</div></li><li><div>                'purchaseable' =&gt; $variation-&gt;is_purchasable(), &nbsp;</div></li><li><div>                'visible' =&gt; $variation-&gt;variation_is_visible(), &nbsp;</div></li><li><div>                'on_sale' =&gt; $variation-&gt;is_on_sale(), &nbsp;</div></li><li><div>                'weight' =&gt; $variation-&gt;get_weight() ? $variation-&gt;get_weight() : null, &nbsp;</div></li><li><div>                'dimensions' =&gt; array(&nbsp;</div></li><li><div>                    'length' =&gt; $variation-&gt;get_length(), &nbsp;</div></li><li><div>                    'width' =&gt; $variation-&gt;get_width(), &nbsp;</div></li><li><div>                    'height' =&gt; $variation-&gt;get_height(), &nbsp;</div></li><li><div>                    'unit' =&gt; get_option( 'woocommerce_dimension_unit' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                'shipping_class' =&gt; $variation-&gt;get_shipping_class(), &nbsp;</div></li><li><div>                'shipping_class_id' =&gt; ( 0 !== $variation-&gt;get_shipping_class_id() ) ? $variation-&gt;get_shipping_class_id() : null, &nbsp;</div></li><li><div>                'image' =&gt; $this-&gt;get_images( $variation ), &nbsp;</div></li><li><div>                'attributes' =&gt; $this-&gt;get_attributes( $variation ), &nbsp;</div></li><li><div>                'downloads' =&gt; $this-&gt;get_downloads( $variation ), &nbsp;</div></li><li><div>                'download_limit' =&gt; (int) $product-&gt;get_download_limit(), &nbsp;</div></li><li><div>                'download_expiry' =&gt; (int) $product-&gt;get_download_expiry(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $variations;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get grouped products data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_grouped_products_data( $product ) {&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product-&gt;get_children() as $child_id ) {&nbsp;</div></li><li><div>            $_product = wc_get_product( $child_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $_product || ! $_product-&gt;exists() ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products[] = $this-&gt;get_product_data( $_product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $products;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save default attributes.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param WP_REST_Request $request&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_default_attributes( $product, $request ) {&nbsp;</div></li><li><div>        // Update default attributes options setting.&nbsp;</div></li><li><div>        if ( isset( $request['default_attribute'] ) ) {&nbsp;</div></li><li><div>            $request['default_attributes'] = $request['default_attribute'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $request['default_attributes'] ) && is_array( $request['default_attributes'] ) ) {&nbsp;</div></li><li><div>            $attributes = $product-&gt;get_attributes();&nbsp;</div></li><li><div>            $default_attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $request['default_attributes'] as $default_attr_key =&gt; $default_attr ) {&nbsp;</div></li><li><div>                if ( ! isset( $default_attr['name'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $taxonomy = sanitize_title( $default_attr['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $default_attr['slug'] ) ) {&nbsp;</div></li><li><div>                    $taxonomy = $this-&gt;get_attribute_taxonomy_by_slug( $default_attr['slug'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $attributes[ $taxonomy ] ) ) {&nbsp;</div></li><li><div>                    $_attribute = $attributes[ $taxonomy ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $_attribute['is_variation'] ) {&nbsp;</div></li><li><div>                        $value = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( isset( $default_attr['option'] ) ) {&nbsp;</div></li><li><div>                            if ( $_attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>                                // Don't use wc_clean as it destroys sanitized characters&nbsp;</div></li><li><div>                                $value = sanitize_title( trim( stripslashes( $default_attr['option'] ) ) );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $value = wc_clean( trim( stripslashes( $default_attr['option'] ) ) );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $value ) {&nbsp;</div></li><li><div>                            $default_attributes[ $taxonomy ] = $value;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_default_attributes( $default_attributes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save product meta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_product_meta( $product, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Virtual.&nbsp;</div></li><li><div>        if ( isset( $data['virtual'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_virtual( $data['virtual'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Tax status.&nbsp;</div></li><li><div>        if ( isset( $data['tax_status'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_tax_status( wc_clean( $data['tax_status'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Tax Class.&nbsp;</div></li><li><div>        if ( isset( $data['tax_class'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_tax_class( wc_clean( $data['tax_class'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Catalog Visibility.&nbsp;</div></li><li><div>        if ( isset( $data['catalog_visibility'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_catalog_visibility( wc_clean( $data['catalog_visibility'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Purchase Note.&nbsp;</div></li><li><div>        if ( isset( $data['purchase_note'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_purchase_note( wc_clean( $data['purchase_note'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Featured Product.&nbsp;</div></li><li><div>        if ( isset( $data['featured'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_featured( $data['featured'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Shipping data.&nbsp;</div></li><li><div>        $product = $this-&gt;save_product_shipping_data( $product, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // SKU.&nbsp;</div></li><li><div>        if ( isset( $data['sku'] ) ) {&nbsp;</div></li><li><div>            $sku = $product-&gt;get_sku();&nbsp;</div></li><li><div>            $new_sku = wc_clean( $data['sku'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( '' == $new_sku ) {&nbsp;</div></li><li><div>                $product-&gt;set_sku( '' );&nbsp;</div></li><li><div>            } elseif ( $new_sku !== $sku ) {&nbsp;</div></li><li><div>                if ( ! empty( $new_sku ) ) {&nbsp;</div></li><li><div>                    $unique_sku = wc_product_has_unique_sku( $product-&gt;get_id(), $new_sku );&nbsp;</div></li><li><div>                    if ( ! $unique_sku ) {&nbsp;</div></li><li><div>                        throw new WC_API_Exception( 'woocommerce_api_product_sku_already_exists', __( 'The SKU already exists on another product.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $product-&gt;set_sku( $new_sku );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $product-&gt;set_sku( '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Attributes.&nbsp;</div></li><li><div>        if ( isset( $data['attributes'] ) ) {&nbsp;</div></li><li><div>            $attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $data['attributes'] as $attribute ) {&nbsp;</div></li><li><div>                $is_taxonomy = 0;&nbsp;</div></li><li><div>                $taxonomy = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! isset( $attribute['name'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $attribute_slug = sanitize_title( $attribute['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $attribute['slug'] ) ) {&nbsp;</div></li><li><div>                    $taxonomy = $this-&gt;get_attribute_taxonomy_by_slug( $attribute['slug'] );&nbsp;</div></li><li><div>                    $attribute_slug = sanitize_title( $attribute['slug'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $taxonomy ) {&nbsp;</div></li><li><div>                    $is_taxonomy = 1;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $is_taxonomy ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $attribute_id = wc_attribute_taxonomy_id_by_name( $attribute['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                        $options = $attribute['options'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! is_array( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                            // Text based attributes - Posted values are term names.&nbsp;</div></li><li><div>                            $options = explode( WC_DELIMITER, $options );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $values = array_map( 'wc_sanitize_term_text_based', $options );&nbsp;</div></li><li><div>                        $values = array_filter( $values, 'strlen' );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $values = array();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Update post terms&nbsp;</div></li><li><div>                    if ( taxonomy_exists( $taxonomy ) ) {&nbsp;</div></li><li><div>                        wp_set_object_terms( $product-&gt;get_id(), $values, $taxonomy );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! empty( $values ) ) {&nbsp;</div></li><li><div>                        // Add attribute to array, but don't set values.&nbsp;</div></li><li><div>                        $attribute_object = new WC_Product_Attribute();&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_id( $attribute_id );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_name( $taxonomy );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_options( $values );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_position( isset( $attribute['position'] ) ? absint( $attribute['position'] ) : 0 );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_visible( ( isset( $attribute['visible'] ) && $attribute['visible'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                        $attribute_object-&gt;set_variation( ( isset( $attribute['variation'] ) && $attribute['variation'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                        $attributes[] = $attribute_object;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } elseif ( isset( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                    // Array based.&nbsp;</div></li><li><div>                    if ( is_array( $attribute['options'] ) ) {&nbsp;</div></li><li><div>                        $values = $attribute['options'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Text based, separate by pipe.&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $values = array_map( 'wc_clean', explode( WC_DELIMITER, $attribute['options'] ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Custom attribute - Add attribute to array and set the values.&nbsp;</div></li><li><div>                    $attribute_object = new WC_Product_Attribute();&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_name( $attribute['name'] );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_options( $values );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_position( isset( $attribute['position'] ) ? absint( $attribute['position'] ) : 0 );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_visible( ( isset( $attribute['visible'] ) && $attribute['visible'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                    $attribute_object-&gt;set_variation( ( isset( $attribute['variation'] ) && $attribute['variation'] ) ? 1 : 0 );&nbsp;</div></li><li><div>                    $attributes[] = $attribute_object;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            uasort( $attributes, 'wc_product_attribute_uasort_comparison' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_attributes( $attributes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sales and prices.&nbsp;</div></li><li><div>        if ( in_array( $product-&gt;get_type(), array( 'variable', 'grouped' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Variable and grouped products have no prices.&nbsp;</div></li><li><div>            $product-&gt;set_regular_price( '' );&nbsp;</div></li><li><div>            $product-&gt;set_sale_price( '' );&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_to( '' );&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_from( '' );&nbsp;</div></li><li><div>            $product-&gt;set_price( '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Regular Price&nbsp;</div></li><li><div>            if ( isset( $data['regular_price'] ) ) {&nbsp;</div></li><li><div>                $regular_price = ( '' === $data['regular_price'] ) ? '' : $data['regular_price'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $regular_price = $product-&gt;get_regular_price();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sale Price&nbsp;</div></li><li><div>            if ( isset( $data['sale_price'] ) ) {&nbsp;</div></li><li><div>                $sale_price = ( '' === $data['sale_price'] ) ? '' : $data['sale_price'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $sale_price = $product-&gt;get_sale_price();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_regular_price( $regular_price );&nbsp;</div></li><li><div>            $product-&gt;set_sale_price( $sale_price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_from'] ) ) {&nbsp;</div></li><li><div>                $date_from = $data['sale_price_dates_from'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $date_from = $product-&gt;get_date_on_sale_from() ? date( 'Y-m-d', $product-&gt;get_date_on_sale_from()-&gt;getTimestamp() ) : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_to'] ) ) {&nbsp;</div></li><li><div>                $date_to = $data['sale_price_dates_to'];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $date_to = $product-&gt;get_date_on_sale_to() ? date( 'Y-m-d', $product-&gt;get_date_on_sale_to()-&gt;getTimestamp() ) : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $date_to && ! $date_from ) {&nbsp;</div></li><li><div>                $date_from = strtotime( 'NOW', current_time( 'timestamp', true ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_to( $date_to );&nbsp;</div></li><li><div>            $product-&gt;set_date_on_sale_from( $date_from );&nbsp;</div></li><li><div>            if ( $product-&gt;is_on_sale() ) {&nbsp;</div></li><li><div>                $product-&gt;set_price( $product-&gt;get_sale_price() );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $product-&gt;set_price( $product-&gt;get_regular_price() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product parent ID for groups.&nbsp;</div></li><li><div>        if ( isset( $data['parent_id'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_parent_id( absint( $data['parent_id'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sold Individually.&nbsp;</div></li><li><div>        if ( isset( $data['sold_individually'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_sold_individually( true === $data['sold_individually'] ? 'yes' : '' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Stock status.&nbsp;</div></li><li><div>        if ( isset( $data['in_stock'] ) ) {&nbsp;</div></li><li><div>            $stock_status = ( true === $data['in_stock'] ) ? 'instock' : 'outofstock';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $stock_status = $product-&gt;get_stock_status();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( '' === $stock_status ) {&nbsp;</div></li><li><div>                $stock_status = 'instock';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Stock Data.&nbsp;</div></li><li><div>        if ( 'yes' == get_option( 'woocommerce_manage_stock' ) ) {&nbsp;</div></li><li><div>            // Manage stock.&nbsp;</div></li><li><div>            if ( isset( $data['managing_stock'] ) ) {&nbsp;</div></li><li><div>                $managing_stock = ( true === $data['managing_stock'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( $managing_stock );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $managing_stock = $product-&gt;get_manage_stock() ? 'yes' : 'no';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Backorders.&nbsp;</div></li><li><div>            if ( isset( $data['backorders'] ) ) {&nbsp;</div></li><li><div>                if ( 'notify' === $data['backorders'] ) {&nbsp;</div></li><li><div>                    $backorders = 'notify';&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $backorders = ( true === $data['backorders'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $backorders = $product-&gt;get_backorders();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'grouped' ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_backorders( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>            } elseif ( $product-&gt;is_type( 'external' ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_backorders( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_status( 'instock' );&nbsp;</div></li><li><div>            } elseif ( 'yes' == $managing_stock ) {&nbsp;</div></li><li><div>                $product-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Stock status is always determined by children so sync later.&nbsp;</div></li><li><div>                if ( ! $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>                    $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Stock quantity.&nbsp;</div></li><li><div>                if ( isset( $data['stock_quantity'] ) ) {&nbsp;</div></li><li><div>                    $product-&gt;set_stock_quantity( wc_stock_amount( $data['stock_quantity'] ) );&nbsp;</div></li><li><div>                } elseif ( isset( $data['inventory_delta'] ) ) {&nbsp;</div></li><li><div>                    $stock_quantity = wc_stock_amount( $product-&gt;get_stock_quantity() );&nbsp;</div></li><li><div>                    $stock_quantity += wc_stock_amount( $data['inventory_delta'] );&nbsp;</div></li><li><div>                    $product-&gt;set_stock_quantity( wc_stock_amount( $stock_quantity ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // Don't manage stock.&nbsp;</div></li><li><div>                $product-&gt;set_manage_stock( 'no' );&nbsp;</div></li><li><div>                $product-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>                $product-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>                $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Upsells.&nbsp;</div></li><li><div>        if ( isset( $data['upsell_ids'] ) ) {&nbsp;</div></li><li><div>            $upsells = array();&nbsp;</div></li><li><div>            $ids = $data['upsell_ids'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $ids ) ) {&nbsp;</div></li><li><div>                foreach ( $ids as $id ) {&nbsp;</div></li><li><div>                    if ( $id && $id &gt; 0 ) {&nbsp;</div></li><li><div>                        $upsells[] = $id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product-&gt;set_upsell_ids( $upsells );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $product-&gt;set_upsell_ids( array() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Cross sells.&nbsp;</div></li><li><div>        if ( isset( $data['cross_sell_ids'] ) ) {&nbsp;</div></li><li><div>            $crosssells = array();&nbsp;</div></li><li><div>            $ids = $data['cross_sell_ids'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $ids ) ) {&nbsp;</div></li><li><div>                foreach ( $ids as $id ) {&nbsp;</div></li><li><div>                    if ( $id && $id &gt; 0 ) {&nbsp;</div></li><li><div>                        $crosssells[] = $id;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product-&gt;set_cross_sell_ids( $crosssells );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $product-&gt;set_cross_sell_ids( array() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product categories.&nbsp;</div></li><li><div>        if ( isset( $data['categories'] ) && is_array( $data['categories'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_category_ids( $data['categories'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product tags.&nbsp;</div></li><li><div>        if ( isset( $data['tags'] ) && is_array( $data['tags'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_tag_ids( $data['tags'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Downloadable.&nbsp;</div></li><li><div>        if ( isset( $data['downloadable'] ) ) {&nbsp;</div></li><li><div>            $is_downloadable = ( true === $data['downloadable'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>            $product-&gt;set_downloadable( $is_downloadable );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $is_downloadable = $product-&gt;get_downloadable() ? 'yes' : 'no';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Downloadable options.&nbsp;</div></li><li><div>        if ( 'yes' == $is_downloadable ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Downloadable files.&nbsp;</div></li><li><div>            if ( isset( $data['downloads'] ) && is_array( $data['downloads'] ) ) {&nbsp;</div></li><li><div>                $product = $this-&gt;save_downloadable_files( $product, $data['downloads'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Download limit.&nbsp;</div></li><li><div>            if ( isset( $data['download_limit'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_download_limit( $data['download_limit'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Download expiry.&nbsp;</div></li><li><div>            if ( isset( $data['download_expiry'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_download_expiry( $data['download_expiry'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product url.&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'external' ) ) {&nbsp;</div></li><li><div>            if ( isset( $data['product_url'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_product_url( $data['product_url'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['button_text'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_button_text( $data['button_text'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Reviews allowed.&nbsp;</div></li><li><div>        if ( isset( $data['reviews_allowed'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_reviews_allowed( $data['reviews_allowed'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save default attributes for variable products.&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) ) {&nbsp;</div></li><li><div>            $product = $this-&gt;save_default_attributes( $product, $data );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Do action for product type&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_process_product_meta_' . $product-&gt;get_type(), $product-&gt;get_id(), $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save variations.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     * @param  array $request&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_variations( $product, $request ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $product-&gt;get_id();&nbsp;</div></li><li><div>        $variations = $request['variations'];&nbsp;</div></li><li><div>        $attributes = $product-&gt;get_attributes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $variations as $menu_order =&gt; $data ) {&nbsp;</div></li><li><div>            $variation_id = isset( $data['id'] ) ? absint( $data['id'] ) : 0;&nbsp;</div></li><li><div>            $variation = new WC_Product_Variation( $variation_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Create initial name and status.&nbsp;</div></li><li><div>            if ( ! $variation-&gt;get_slug() ) {&nbsp;</div></li><li><div>                /** translators: 1: variation id 2: product name */&nbsp;</div></li><li><div>                $variation-&gt;set_name( sprintf( __( 'Variation #%1$s of %2$s', 'woocommerce' ), $variation-&gt;get_id(), $product-&gt;get_name() ) );&nbsp;</div></li><li><div>                $variation-&gt;set_status( isset( $data['visible'] ) && false === $data['visible'] ? 'private' : 'publish' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Parent ID.&nbsp;</div></li><li><div>            $variation-&gt;set_parent_id( $product-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Menu order.&nbsp;</div></li><li><div>            $variation-&gt;set_menu_order( $menu_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Status.&nbsp;</div></li><li><div>            if ( isset( $data['visible'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_status( false === $data['visible'] ? 'private' : 'publish' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // SKU.&nbsp;</div></li><li><div>            if ( isset( $data['sku'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_sku( wc_clean( $data['sku'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Thumbnail.&nbsp;</div></li><li><div>            if ( isset( $data['image'] ) && is_array( $data['image'] ) ) {&nbsp;</div></li><li><div>                $image = current( $data['image'] );&nbsp;</div></li><li><div>                if ( is_array( $image ) ) {&nbsp;</div></li><li><div>                    $image['position'] = 0;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $variation = $this-&gt;save_product_images( $variation, array( $image ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Virtual variation.&nbsp;</div></li><li><div>            if ( isset( $data['virtual'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_virtual( $data['virtual'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Downloadable variation.&nbsp;</div></li><li><div>            if ( isset( $data['downloadable'] ) ) {&nbsp;</div></li><li><div>                $is_downloadable = $data['downloadable'];&nbsp;</div></li><li><div>                $variation-&gt;set_downloadable( $is_downloadable );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $is_downloadable = $variation-&gt;get_downloadable();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Downloads.&nbsp;</div></li><li><div>            if ( $is_downloadable ) {&nbsp;</div></li><li><div>                // Downloadable files.&nbsp;</div></li><li><div>                if ( isset( $data['downloads'] ) && is_array( $data['downloads'] ) ) {&nbsp;</div></li><li><div>                    $variation = $this-&gt;save_downloadable_files( $variation, $data['downloads'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Download limit.&nbsp;</div></li><li><div>                if ( isset( $data['download_limit'] ) ) {&nbsp;</div></li><li><div>                    $variation-&gt;set_download_limit( $data['download_limit'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Download expiry.&nbsp;</div></li><li><div>                if ( isset( $data['download_expiry'] ) ) {&nbsp;</div></li><li><div>                    $variation-&gt;set_download_expiry( $data['download_expiry'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Shipping data.&nbsp;</div></li><li><div>            $variation = $this-&gt;save_product_shipping_data( $variation, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Stock handling.&nbsp;</div></li><li><div>            $manage_stock = (bool) $variation-&gt;get_manage_stock();&nbsp;</div></li><li><div>            if ( isset( $data['managing_stock'] ) ) {&nbsp;</div></li><li><div>                $manage_stock = $data['managing_stock'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;set_manage_stock( $manage_stock );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stock_status = $variation-&gt;get_stock_status();&nbsp;</div></li><li><div>            if ( isset( $data['in_stock'] ) ) {&nbsp;</div></li><li><div>                $stock_status = true === $data['in_stock'] ? 'instock' : 'outofstock';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;set_stock_status( $stock_status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $backorders = $variation-&gt;get_backorders();&nbsp;</div></li><li><div>            if ( isset( $data['backorders'] ) ) {&nbsp;</div></li><li><div>                $backorders = $data['backorders'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;set_backorders( $backorders );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $manage_stock ) {&nbsp;</div></li><li><div>                if ( isset( $data['stock_quantity'] ) ) {&nbsp;</div></li><li><div>                    $variation-&gt;set_stock_quantity( $data['stock_quantity'] );&nbsp;</div></li><li><div>                } elseif ( isset( $data['inventory_delta'] ) ) {&nbsp;</div></li><li><div>                    $stock_quantity = wc_stock_amount( $variation-&gt;get_stock_quantity() );&nbsp;</div></li><li><div>                    $stock_quantity += wc_stock_amount( $data['inventory_delta'] );&nbsp;</div></li><li><div>                    $variation-&gt;set_stock_quantity( $stock_quantity );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $variation-&gt;set_backorders( 'no' );&nbsp;</div></li><li><div>                $variation-&gt;set_stock_quantity( '' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Regular Price.&nbsp;</div></li><li><div>            if ( isset( $data['regular_price'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_regular_price( $data['regular_price'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Sale Price.&nbsp;</div></li><li><div>            if ( isset( $data['sale_price'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_sale_price( $data['sale_price'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_from'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_date_on_sale_from( $data['sale_price_dates_from'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['sale_price_dates_to'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_date_on_sale_to( $data['sale_price_dates_to'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Tax class.&nbsp;</div></li><li><div>            if ( isset( $data['tax_class'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_tax_class( $data['tax_class'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Description.&nbsp;</div></li><li><div>            if ( isset( $data['description'] ) ) {&nbsp;</div></li><li><div>                $variation-&gt;set_description( wp_kses_post( $data['description'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update taxonomies.&nbsp;</div></li><li><div>            if ( isset( $data['attributes'] ) ) {&nbsp;</div></li><li><div>                $_attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $data['attributes'] as $attribute_key =&gt; $attribute ) {&nbsp;</div></li><li><div>                    if ( ! isset( $attribute['name'] ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $taxonomy = 0;&nbsp;</div></li><li><div>                    $_attribute = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $attribute['slug'] ) ) {&nbsp;</div></li><li><div>                        $taxonomy = $this-&gt;get_attribute_taxonomy_by_slug( $attribute['slug'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                        $taxonomy = sanitize_title( $attribute['name'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $attributes[ $taxonomy ] ) ) {&nbsp;</div></li><li><div>                        $_attribute = $attributes[ $taxonomy ];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( isset( $_attribute['is_variation'] ) && $_attribute['is_variation'] ) {&nbsp;</div></li><li><div>                        $_attribute_key = sanitize_title( $_attribute['name'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( isset( $_attribute['is_taxonomy'] ) && $_attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>                            // Don't use wc_clean as it destroys sanitized characters.&nbsp;</div></li><li><div>                            $_attribute_value = isset( $attribute['option'] ) ? sanitize_title( stripslashes( $attribute['option'] ) ) : '';&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $_attribute_value = isset( $attribute['option'] ) ? wc_clean( stripslashes( $attribute['option'] ) ) : '';&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $_attributes[ $_attribute_key ] = $_attribute_value;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $variation-&gt;set_attributes( $_attributes );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_save_product_variation', $variation_id, $menu_order, $variation );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save product shipping data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function save_product_shipping_data( $product, $data ) {&nbsp;</div></li><li><div>        if ( isset( $data['weight'] ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_weight( '' === $data['weight'] ? '' : wc_format_decimal( $data['weight'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Product dimensions&nbsp;</div></li><li><div>        if ( isset( $data['dimensions'] ) ) {&nbsp;</div></li><li><div>            // Height&nbsp;</div></li><li><div>            if ( isset( $data['dimensions']['height'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_height( '' === $data['dimensions']['height'] ? '' : wc_format_decimal( $data['dimensions']['height'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Width&nbsp;</div></li><li><div>            if ( isset( $data['dimensions']['width'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_width( '' === $data['dimensions']['width'] ? '' : wc_format_decimal( $data['dimensions']['width'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Length&nbsp;</div></li><li><div>            if ( isset( $data['dimensions']['length'] ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_length( '' === $data['dimensions']['length'] ? '' : wc_format_decimal( $data['dimensions']['length'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Virtual&nbsp;</div></li><li><div>        if ( isset( $data['virtual'] ) ) {&nbsp;</div></li><li><div>            $virtual = ( true === $data['virtual'] ) ? 'yes' : 'no';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'yes' == $virtual ) {&nbsp;</div></li><li><div>                $product-&gt;set_weight( '' );&nbsp;</div></li><li><div>                $product-&gt;set_height( '' );&nbsp;</div></li><li><div>                $product-&gt;set_length( '' );&nbsp;</div></li><li><div>                $product-&gt;set_width( '' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Shipping class&nbsp;</div></li><li><div>        if ( isset( $data['shipping_class'] ) ) {&nbsp;</div></li><li><div>            $data_store = $product-&gt;get_data_store();&nbsp;</div></li><li><div>            $shipping_class_id = $data_store-&gt;get_shipping_class_id_by_slug( wc_clean( $data['shipping_class'] ) );&nbsp;</div></li><li><div>            if ( $shipping_class_id ) {&nbsp;</div></li><li><div>                $product-&gt;set_shipping_class_id( $shipping_class_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save downloadable files&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param array $downloads&nbsp;</div></li><li><div>     * @param int $deprecated Deprecated since 3.0.&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function save_downloadable_files( $product, $downloads, $deprecated = 0 ) {&nbsp;</div></li><li><div>        if ( $deprecated ) {&nbsp;</div></li><li><div>            wc_deprecated_argument( 'variation_id', '3.0', 'save_downloadable_files() does not require a variation_id anymore.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $files = array();&nbsp;</div></li><li><div>        foreach ( $downloads as $key =&gt; $file ) {&nbsp;</div></li><li><div>            if ( isset( $file['url'] ) ) {&nbsp;</div></li><li><div>                $file['file'] = $file['url'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $file['file'] ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $download = new WC_Product_Download();&nbsp;</div></li><li><div>            $download-&gt;set_id( $key );&nbsp;</div></li><li><div>            $download-&gt;set_name( $file['name'] ? $file['name'] : wc_get_filename_from_url( $file['file'] ) );&nbsp;</div></li><li><div>            $download-&gt;set_file( apply_filters( 'woocommerce_file_download_path', $file['file'], $product, $key ) );&nbsp;</div></li><li><div>            $files[] = $download;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $product-&gt;set_downloads( $files );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get attribute taxonomy by slug.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $slug&nbsp;</div></li><li><div>     * @return string|null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_attribute_taxonomy_by_slug( $slug ) {&nbsp;</div></li><li><div>        $taxonomy = null;&nbsp;</div></li><li><div>        $attribute_taxonomies = wc_get_attribute_taxonomies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $attribute_taxonomies as $key =&gt; $tax ) {&nbsp;</div></li><li><div>            if ( $slug == $tax-&gt;attribute_name ) {&nbsp;</div></li><li><div>                $taxonomy = 'pa_' . $tax-&gt;attribute_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $taxonomy;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the images for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_images( $product ) {&nbsp;</div></li><li><div>        $images = $attachment_ids = array();&nbsp;</div></li><li><div>        $product_image = $product-&gt;get_image_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add featured image.&nbsp;</div></li><li><div>        if ( ! empty( $product_image ) ) {&nbsp;</div></li><li><div>            $attachment_ids[] = $product_image;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add gallery images.&nbsp;</div></li><li><div>        $attachment_ids = array_merge( $attachment_ids, $product-&gt;get_gallery_image_ids() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Build image data.&nbsp;</div></li><li><div>        foreach ( $attachment_ids as $position =&gt; $attachment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment_post = get_post( $attachment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $attachment_post ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attachment = wp_get_attachment_image_src( $attachment_id, 'full' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_array( $attachment ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $images[] = array(&nbsp;</div></li><li><div>                'id' =&gt; (int) $attachment_id, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $attachment_post-&gt;post_date_gmt ), &nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $attachment_post-&gt;post_modified_gmt ), &nbsp;</div></li><li><div>                'src' =&gt; current( $attachment ), &nbsp;</div></li><li><div>                'title' =&gt; get_the_title( $attachment_id ), &nbsp;</div></li><li><div>                'alt' =&gt; get_post_meta( $attachment_id, '_wp_attachment_image_alt', true ), &nbsp;</div></li><li><div>                'position' =&gt; (int) $position, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set a placeholder image if the product has no images set.&nbsp;</div></li><li><div>        if ( empty( $images ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $images[] = array(&nbsp;</div></li><li><div>                'id' =&gt; 0, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( time() ), // Default to now.&nbsp;</div></li><li><div>                'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( time() ), &nbsp;</div></li><li><div>                'src' =&gt; wc_placeholder_img_src(), &nbsp;</div></li><li><div>                'title' =&gt; __( 'Placeholder', 'woocommerce' ), &nbsp;</div></li><li><div>                'alt' =&gt; __( 'Placeholder', 'woocommerce' ), &nbsp;</div></li><li><div>                'position' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $images;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save product images.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.2&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     * @param  array $images&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     * @return WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function save_product_images( $product, $images ) {&nbsp;</div></li><li><div>        if ( is_array( $images ) ) {&nbsp;</div></li><li><div>            $gallery = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $images as $image ) {&nbsp;</div></li><li><div>                if ( isset( $image['position'] ) && 0 == $image['position'] ) {&nbsp;</div></li><li><div>                    $attachment_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( 0 === $attachment_id && isset( $image['src'] ) ) {&nbsp;</div></li><li><div>                        $upload = $this-&gt;upload_product_image( esc_url_raw( $image['src'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( is_wp_error( $upload ) ) {&nbsp;</div></li><li><div>                            throw new WC_API_Exception( 'woocommerce_api_cannot_upload_product_image', $upload-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $attachment_id = $this-&gt;set_product_image_as_attachment( $upload, $product-&gt;get_id() );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $product-&gt;set_image_id( $attachment_id );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $attachment_id = isset( $image['id'] ) ? absint( $image['id'] ) : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( 0 === $attachment_id && isset( $image['src'] ) ) {&nbsp;</div></li><li><div>                        $upload = $this-&gt;upload_product_image( esc_url_raw( $image['src'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( is_wp_error( $upload ) ) {&nbsp;</div></li><li><div>                            throw new WC_API_Exception( 'woocommerce_api_cannot_upload_product_image', $upload-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $attachment_id = $this-&gt;set_product_image_as_attachment( $upload, $product-&gt;get_id() );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $gallery[] = $attachment_id;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Set the image alt if present.&nbsp;</div></li><li><div>                if ( ! empty( $image['alt'] ) && $attachment_id ) {&nbsp;</div></li><li><div>                    update_post_meta( $attachment_id, '_wp_attachment_image_alt', wc_clean( $image['alt'] ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Set the image title if present.&nbsp;</div></li><li><div>                if ( ! empty( $image['title'] ) && $attachment_id ) {&nbsp;</div></li><li><div>                    wp_update_post( array( 'ID' =&gt; $attachment_id, 'post_title' =&gt; $image['title'] ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $gallery ) ) {&nbsp;</div></li><li><div>                $product-&gt;set_gallery_image_ids( $gallery );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;set_image_id( '' );&nbsp;</div></li><li><div>            $product-&gt;set_gallery_image_ids( array() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $product;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Upload image from URL&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $image_url&nbsp;</div></li><li><div>     * @return int|WP_Error attachment id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function upload_product_image( $image_url ) {&nbsp;</div></li><li><div>        return $this-&gt;upload_image_from_url( $image_url, 'product_image' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Upload product category image from URL.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param string $image_url&nbsp;</div></li><li><div>     * @return int|WP_Error attachment id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function upload_product_category_image( $image_url ) {&nbsp;</div></li><li><div>        return $this-&gt;upload_image_from_url( $image_url, 'product_category_image' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Upload image from URL.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param string $image_url&nbsp;</div></li><li><div>     * @param string $upload_for&nbsp;</div></li><li><div>     * @return int|WP_Error Attachment id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function upload_image_from_url( $image_url, $upload_for = 'product_image' ) {&nbsp;</div></li><li><div>        $file_name = basename( current( explode( '?', $image_url ) ) );&nbsp;</div></li><li><div>        $parsed_url = @parse_url( $image_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check parsed URL.&nbsp;</div></li><li><div>        if ( ! $parsed_url || ! is_array( $parsed_url ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_' . $upload_for, sprintf( __( 'Invalid URL %s.', 'woocommerce' ), $image_url ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure url is valid.&nbsp;</div></li><li><div>        $image_url = str_replace( ' ', '%20', $image_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the file.&nbsp;</div></li><li><div>        $response = wp_safe_remote_get( $image_url, array(&nbsp;</div></li><li><div>            'timeout' =&gt; 10, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $response ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_remote_' . $upload_for, sprintf( __( 'Error getting remote image %s.', 'woocommerce' ), $image_url ) . ' ' . sprintf( __( 'Error: %s.', 'woocommerce' ), $response-&gt;get_error_message() ), 400 );&nbsp;</div></li><li><div>        } elseif ( 200 !== wp_remote_retrieve_response_code( $response ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_remote_' . $upload_for, sprintf( __( 'Error getting remote image %s.', 'woocommerce' ), $image_url ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure we have a file name and type.&nbsp;</div></li><li><div>        $wp_filetype = wp_check_filetype( $file_name, wc_rest_allowed_image_mime_types() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $wp_filetype['type'] ) {&nbsp;</div></li><li><div>            $headers = wp_remote_retrieve_headers( $response );&nbsp;</div></li><li><div>            if ( isset( $headers['content-disposition'] ) && strstr( $headers['content-disposition'], 'filename=' ) ) {&nbsp;</div></li><li><div>                $disposition = end( explode( 'filename=', $headers['content-disposition'] ) );&nbsp;</div></li><li><div>                $disposition = sanitize_file_name( $disposition );&nbsp;</div></li><li><div>                $file_name = $disposition;&nbsp;</div></li><li><div>            } elseif ( isset( $headers['content-type'] ) && strstr( $headers['content-type'], 'image/' ) ) {&nbsp;</div></li><li><div>                $file_name = 'image.' . str_replace( 'image/', '', $headers['content-type'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            unset( $headers );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Recheck filetype&nbsp;</div></li><li><div>            $wp_filetype = wp_check_filetype( $file_name, wc_rest_allowed_image_mime_types() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $wp_filetype['type'] ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_' . $upload_for, __( 'Invalid image type.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Upload the file.&nbsp;</div></li><li><div>        $upload = wp_upload_bits( $file_name, '', wp_remote_retrieve_body( $response ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $upload['error'] ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_' . $upload_for . '_upload_error', $upload['error'], 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get filesize.&nbsp;</div></li><li><div>        $filesize = filesize( $upload['file'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 0 == $filesize ) {&nbsp;</div></li><li><div>            @unlink( $upload['file'] );&nbsp;</div></li><li><div>            unset( $upload );&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_' . $upload_for . '_upload_file_error', __( 'Zero size file downloaded.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_uploaded_image_from_url', $upload, $image_url, $upload_for );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $upload;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets product image as attachment and returns the attachment ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $upload&nbsp;</div></li><li><div>     * @param int $id&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_product_image_as_attachment( $upload, $id ) {&nbsp;</div></li><li><div>        return $this-&gt;set_uploaded_image_as_attachment( $upload, $id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets uploaded category image as attachment and returns the attachment ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  integer $upload Upload information from wp_upload_bits&nbsp;</div></li><li><div>     * @return int             Attachment ID&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_product_category_image_as_attachment( $upload ) {&nbsp;</div></li><li><div>        return $this-&gt;set_uploaded_image_as_attachment( $upload );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set uploaded image as attachment.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  array $upload Upload information from wp_upload_bits&nbsp;</div></li><li><div>     * @param  int   $id     Post ID. Default to 0.&nbsp;</div></li><li><div>     * @return int           Attachment ID&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_uploaded_image_as_attachment( $upload, $id = 0 ) {&nbsp;</div></li><li><div>        $info = wp_check_filetype( $upload['file'] );&nbsp;</div></li><li><div>        $title = '';&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $image_meta = @wp_read_image_metadata( $upload['file'] ) ) {&nbsp;</div></li><li><div>            if ( trim( $image_meta['title'] ) && ! is_numeric( sanitize_title( $image_meta['title'] ) ) ) {&nbsp;</div></li><li><div>                $title = wc_clean( $image_meta['title'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( trim( $image_meta['caption'] ) ) {&nbsp;</div></li><li><div>                $content = wc_clean( $image_meta['caption'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachment = array(&nbsp;</div></li><li><div>            'post_mime_type' =&gt; $info['type'], &nbsp;</div></li><li><div>            'guid' =&gt; $upload['url'], &nbsp;</div></li><li><div>            'post_parent' =&gt; $id, &nbsp;</div></li><li><div>            'post_title' =&gt; $title, &nbsp;</div></li><li><div>            'post_content' =&gt; $content, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attachment_id = wp_insert_attachment( $attachment, $upload['file'], $id );&nbsp;</div></li><li><div>        if ( ! is_wp_error( $attachment_id ) ) {&nbsp;</div></li><li><div>            wp_update_attachment_metadata( $attachment_id, wp_generate_attachment_metadata( $attachment_id, $upload['file'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $attachment_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get attribute options.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $product_id&nbsp;</div></li><li><div>     * @param array $attribute&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_attribute_options( $product_id, $attribute ) {&nbsp;</div></li><li><div>        if ( isset( $attribute['is_taxonomy'] ) && $attribute['is_taxonomy'] ) {&nbsp;</div></li><li><div>            return wc_get_product_terms( $product_id, $attribute['name'], array( 'fields' =&gt; 'names' ) );&nbsp;</div></li><li><div>        } elseif ( isset( $attribute['value'] ) ) {&nbsp;</div></li><li><div>            return array_map( 'trim', explode( '|', $attribute['value'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the attributes for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_attributes( $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variation' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // variation attributes&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_variation_attributes() as $attribute_name =&gt; $attribute ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // taxonomy-based attributes are prefixed with `pa_`, otherwise simply `attribute_`&nbsp;</div></li><li><div>                $attributes[] = array(&nbsp;</div></li><li><div>                    'name' =&gt; wc_attribute_label( str_replace( 'attribute_', '', $attribute_name ), $product ), &nbsp;</div></li><li><div>                    'slug' =&gt; str_replace( 'attribute_', '', str_replace( 'pa_', '', $attribute_name ) ), &nbsp;</div></li><li><div>                    'option' =&gt; $attribute, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_attributes() as $attribute ) {&nbsp;</div></li><li><div>                $attributes[] = array(&nbsp;</div></li><li><div>                    'name' =&gt; wc_attribute_label( $attribute['name'], $product ), &nbsp;</div></li><li><div>                    'slug' =&gt; str_replace( 'pa_', '', $attribute['name'] ), &nbsp;</div></li><li><div>                    'position' =&gt; (int) $attribute['position'], &nbsp;</div></li><li><div>                    'visible' =&gt; (bool) $attribute['is_visible'], &nbsp;</div></li><li><div>                    'variation' =&gt; (bool) $attribute['is_variation'], &nbsp;</div></li><li><div>                    'options' =&gt; $this-&gt;get_attribute_options( $product-&gt;get_id(), $attribute ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $attributes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the downloads for a product or product variation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Product|WC_Product_Variation $product&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_downloads( $product ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $downloads = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_downloadable() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $product-&gt;get_downloads() as $file_id =&gt; $file ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $downloads[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $file_id, // do not cast as int as this is a hash&nbsp;</div></li><li><div>                    'name' =&gt; $file['name'], &nbsp;</div></li><li><div>                    'file' =&gt; $file['file'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $downloads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product attributes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_attributes( $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_attributes', __( 'You do not have permission to read product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_attributes = array();&nbsp;</div></li><li><div>            $attribute_taxonomies = wc_get_attribute_taxonomies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $attribute_taxonomies as $attribute ) {&nbsp;</div></li><li><div>                $product_attributes[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; intval( $attribute-&gt;attribute_id ), &nbsp;</div></li><li><div>                    'name' =&gt; $attribute-&gt;attribute_label, &nbsp;</div></li><li><div>                    'slug' =&gt; wc_attribute_taxonomy_name( $attribute-&gt;attribute_name ), &nbsp;</div></li><li><div>                    'type' =&gt; $attribute-&gt;attribute_type, &nbsp;</div></li><li><div>                    'order_by' =&gt; $attribute-&gt;attribute_orderby, &nbsp;</div></li><li><div>                    'has_archives' =&gt; (bool) $attribute-&gt;attribute_public, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_attributes' =&gt; apply_filters( 'woocommerce_api_product_attributes_response', $product_attributes, $attribute_taxonomies, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product attribute for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param string $id product attribute term ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_attribute( $id, $fields = null ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate ID&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'Invalid product attribute ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_attributes', __( 'You do not have permission to read product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT *&nbsp;</div></li><li><div>                FROM {$wpdb-&gt;prefix}woocommerce_attribute_taxonomies&nbsp;</div></li><li><div>                WHERE attribute_id = %d&nbsp;</div></li><li><div>             &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $attribute ) || is_null( $attribute ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_attribute = array(&nbsp;</div></li><li><div>                'id' =&gt; intval( $attribute-&gt;attribute_id ), &nbsp;</div></li><li><div>                'name' =&gt; $attribute-&gt;attribute_label, &nbsp;</div></li><li><div>                'slug' =&gt; wc_attribute_taxonomy_name( $attribute-&gt;attribute_name ), &nbsp;</div></li><li><div>                'type' =&gt; $attribute-&gt;attribute_type, &nbsp;</div></li><li><div>                'order_by' =&gt; $attribute-&gt;attribute_orderby, &nbsp;</div></li><li><div>                'has_archives' =&gt; (bool) $attribute-&gt;attribute_public, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_attribute' =&gt; apply_filters( 'woocommerce_api_product_attribute_response', $product_attribute, $id, $fields, $attribute, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate attribute data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  string $name&nbsp;</div></li><li><div>     * @param  string $slug&nbsp;</div></li><li><div>     * @param  string $type&nbsp;</div></li><li><div>     * @param  string $order_by&nbsp;</div></li><li><div>     * @param  bool   $new_data&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     * @throws WC_API_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function validate_attribute_data( $name, $slug, $type, $order_by, $new_data = true ) {&nbsp;</div></li><li><div>        if ( empty( $name ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_name', sprintf( __( 'Missing parameter %s', 'woocommerce' ), 'name' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strlen( $slug ) &gt;= 28 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_slug_too_long', sprintf( __( 'Slug &quot;%s&quot; is too long (28 characters max). Shorten it, please.', 'woocommerce' ), $slug ), 400 );&nbsp;</div></li><li><div>        } elseif ( wc_check_if_attribute_name_is_reserved( $slug ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_slug_reserved_name', sprintf( __( 'Slug &quot;%s&quot; is not allowed because it is a reserved term. Change it, please.', 'woocommerce' ), $slug ), 400 );&nbsp;</div></li><li><div>        } elseif ( $new_data && taxonomy_exists( wc_attribute_taxonomy_name( $slug ) ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_slug_already_exists', sprintf( __( 'Slug &quot;%s&quot; is already in use. Change it, please.', 'woocommerce' ), $slug ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Validate the attribute type&nbsp;</div></li><li><div>        if ( ! in_array( wc_clean( $type ), array_keys( wc_get_attribute_types() ) ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_type', sprintf( __( 'Invalid product attribute type - the product attribute type must be any of these: %s', 'woocommerce' ), implode( ', ', array_keys( wc_get_attribute_types() ) ) ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Validate the attribute order by&nbsp;</div></li><li><div>        if ( ! in_array( wc_clean( $order_by ), array( 'menu_order', 'name', 'name_num', 'id' ) ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_order_by', sprintf( __( 'Invalid product attribute order_by type - the product attribute order_by type must be any of these: %s', 'woocommerce' ), implode( ', ', array( 'menu_order', 'name', 'name_num', 'id' ) ) ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product attribute.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param array $data Posted data.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product_attribute( $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_attribute'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product_attribute' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product_attribute'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product_attribute', __( 'You do not have permission to create product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_attribute_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                $data['name'] = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set the attribute slug.&nbsp;</div></li><li><div>            if ( ! isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $data['slug'] = wc_sanitize_taxonomy_name( stripslashes( $data['name'] ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $data['slug'] = preg_replace( '/^pa\_/', '', wc_sanitize_taxonomy_name( stripslashes( $data['slug'] ) ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set attribute type when not sent.&nbsp;</div></li><li><div>            if ( ! isset( $data['type'] ) ) {&nbsp;</div></li><li><div>                $data['type'] = 'select';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set order by when not sent.&nbsp;</div></li><li><div>            if ( ! isset( $data['order_by'] ) ) {&nbsp;</div></li><li><div>                $data['order_by'] = 'menu_order';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the attribute data.&nbsp;</div></li><li><div>            $this-&gt;validate_attribute_data( $data['name'], $data['slug'], $data['type'], $data['order_by'], true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $insert = $wpdb-&gt;insert(&nbsp;</div></li><li><div>                $wpdb-&gt;prefix . 'woocommerce_attribute_taxonomies', &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'attribute_label' =&gt; $data['name'], &nbsp;</div></li><li><div>                    'attribute_name' =&gt; $data['slug'], &nbsp;</div></li><li><div>                    'attribute_type' =&gt; $data['type'], &nbsp;</div></li><li><div>                    'attribute_orderby' =&gt; $data['order_by'], &nbsp;</div></li><li><div>                    'attribute_public' =&gt; isset( $data['has_archives'] ) && true === $data['has_archives'] ? 1 : 0, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( '%s', '%s', '%s', '%s', '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the product creation.&nbsp;</div></li><li><div>            if ( is_wp_error( $insert ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product_attribute', $insert-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product_attribute', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear transients.&nbsp;</div></li><li><div>            wp_schedule_single_event( time(), 'woocommerce_flush_rewrite_rules' );&nbsp;</div></li><li><div>            delete_transient( 'wc_attribute_taxonomies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_attribute( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product attribute.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param int $id the attribute ID.&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product_attribute( $id, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_attribute'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product_attribute' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $data = $data['product_attribute'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_edit_product_attribute', __( 'You do not have permission to edit product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_attribute_data', $data, $this );&nbsp;</div></li><li><div>            $attribute = $this-&gt;get_product_attribute( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $attribute ) ) {&nbsp;</div></li><li><div>                return $attribute;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute_name = isset( $data['name'] ) ? $data['name'] : $attribute['product_attribute']['name'];&nbsp;</div></li><li><div>            $attribute_type = isset( $data['type'] ) ? $data['type'] : $attribute['product_attribute']['type'];&nbsp;</div></li><li><div>            $attribute_order_by = isset( $data['order_by'] ) ? $data['order_by'] : $attribute['product_attribute']['order_by'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $attribute_slug = wc_sanitize_taxonomy_name( stripslashes( $data['slug'] ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $attribute_slug = $attribute['product_attribute']['slug'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $attribute_slug = preg_replace( '/^pa\_/', '', $attribute_slug );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['has_archives'] ) ) {&nbsp;</div></li><li><div>                $attribute_public = true === $data['has_archives'] ? 1 : 0;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $attribute_public = $attribute['product_attribute']['has_archives'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate the attribute data.&nbsp;</div></li><li><div>            $this-&gt;validate_attribute_data( $attribute_name, $attribute_slug, $attribute_type, $attribute_order_by, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update = $wpdb-&gt;update(&nbsp;</div></li><li><div>                $wpdb-&gt;prefix . 'woocommerce_attribute_taxonomies', &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'attribute_label' =&gt; $attribute_name, &nbsp;</div></li><li><div>                    'attribute_name' =&gt; $attribute_slug, &nbsp;</div></li><li><div>                    'attribute_type' =&gt; $attribute_type, &nbsp;</div></li><li><div>                    'attribute_orderby' =&gt; $attribute_order_by, &nbsp;</div></li><li><div>                    'attribute_public' =&gt; $attribute_public, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( 'attribute_id' =&gt; $id ), &nbsp;</div></li><li><div>                array( '%s', '%s', '%s', '%s', '%d' ), &nbsp;</div></li><li><div>                array( '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the product creation.&nbsp;</div></li><li><div>            if ( false === $update ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_edit_product_attribute', __( 'Could not edit the attribute', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product_attribute', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear transients.&nbsp;</div></li><li><div>            wp_schedule_single_event( time(), 'woocommerce_flush_rewrite_rules' );&nbsp;</div></li><li><div>            delete_transient( 'wc_attribute_taxonomies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_attribute( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product attribute.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int $id the product attribute ID.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product_attribute( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_delete_product_attribute', __( 'You do not have permission to delete product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute_name = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT attribute_name&nbsp;</div></li><li><div>                FROM {$wpdb-&gt;prefix}woocommerce_attribute_taxonomies&nbsp;</div></li><li><div>                WHERE attribute_id = %d&nbsp;</div></li><li><div>             &quot;, $id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $attribute_name ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $deleted = $wpdb-&gt;delete(&nbsp;</div></li><li><div>                $wpdb-&gt;prefix . 'woocommerce_attribute_taxonomies', &nbsp;</div></li><li><div>                array( 'attribute_id' =&gt; $id ), &nbsp;</div></li><li><div>                array( '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( false === $deleted ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_attribute', __( 'Could not delete the attribute', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name( $attribute_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( taxonomy_exists( $taxonomy ) ) {&nbsp;</div></li><li><div>                $terms = get_terms( $taxonomy, 'orderby=name&hide_empty=0' );&nbsp;</div></li><li><div>                foreach ( $terms as $term ) {&nbsp;</div></li><li><div>                    wp_delete_term( $term-&gt;term_id, $taxonomy );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_attribute_deleted', $id, $attribute_name, $taxonomy );&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_product_attribute', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Clear transients.&nbsp;</div></li><li><div>            wp_schedule_single_event( time(), 'woocommerce_flush_rewrite_rules' );&nbsp;</div></li><li><div>            delete_transient( 'wc_attribute_taxonomies' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product_attribute' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product attribute terms.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param int $attribute_id Attribute ID.&nbsp;</div></li><li><div>     * @param string|null $fields Fields to limit response to.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_attribute_terms( $attribute_id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_attribute_terms', __( 'You do not have permission to read product attribute terms', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name_by_id( $attribute_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args = array( 'hide_empty' =&gt; false );&nbsp;</div></li><li><div>            $orderby = wc_attribute_orderby( $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $orderby ) {&nbsp;</div></li><li><div>                case 'name' :&nbsp;</div></li><li><div>                    $args['orderby'] = 'name';&nbsp;</div></li><li><div>                    $args['menu_order'] = false;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>                case 'id' :&nbsp;</div></li><li><div>                    $args['orderby'] = 'id';&nbsp;</div></li><li><div>                    $args['order'] = 'ASC';&nbsp;</div></li><li><div>                    $args['menu_order'] = false;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>                case 'menu_order' :&nbsp;</div></li><li><div>                    $args['menu_order'] = 'ASC';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $terms = get_terms( $taxonomy, $args );&nbsp;</div></li><li><div>            $attribute_terms = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $terms as $term ) {&nbsp;</div></li><li><div>                $attribute_terms[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $term-&gt;term_id, &nbsp;</div></li><li><div>                    'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div>                    'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                    'count' =&gt; $term-&gt;count, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_attribute_terms' =&gt; apply_filters( 'woocommerce_api_product_attribute_terms_response', $attribute_terms, $terms, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product attribute term for the given ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param int $attribute_id Attribute ID.&nbsp;</div></li><li><div>     * @param string $id Product attribute term ID.&nbsp;</div></li><li><div>     * @param string|null $fields Fields to limit response to.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_attribute_term( $attribute_id, $id, $fields = null ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate ID&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_term_id', __( 'Invalid product attribute ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_attribute_terms', __( 'You do not have permission to read product attribute terms', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name_by_id( $attribute_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = get_term( $id, $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) || is_null( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_term_id', __( 'A product attribute term with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute_term = array(&nbsp;</div></li><li><div>                'id' =&gt; $term-&gt;term_id, &nbsp;</div></li><li><div>                'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div>                'count' =&gt; $term-&gt;count, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_attribute_term' =&gt; apply_filters( 'woocommerce_api_product_attribute_response', $attribute_term, $id, $fields, $term, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product attribute term.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param int $attribute_id Attribute ID.&nbsp;</div></li><li><div>     * @param array $data Posted data.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product_attribute_term( $attribute_id, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_attribute_term'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_term_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product_attribute_term' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['product_attribute_term'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product_attribute', __( 'You do not have permission to create product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name_by_id( $attribute_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_attribute_term_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check if attribute term name is specified.&nbsp;</div></li><li><div>            if ( ! isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_term_name', sprintf( __( 'Missing parameter %s', 'woocommerce' ), 'name' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set the attribute term slug.&nbsp;</div></li><li><div>            if ( isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $args['slug'] = sanitize_title( wp_unslash( $data['slug'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = wp_insert_term( $data['name'], $taxonomy, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Checks for an error in the term creation.&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product_attribute', $term-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $term['term_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product_attribute_term', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_attribute_term( $attribute_id, $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product attribute term.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     * @param int $attribute_id Attribute ID.&nbsp;</div></li><li><div>     * @param int $id the attribute ID.&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product_attribute_term( $attribute_id, $id, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_attribute_term'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_attribute_term_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product_attribute_term' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $data = $data['product_attribute_term'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_edit_product_attribute', __( 'You do not have permission to edit product attributes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name_by_id( $attribute_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_attribute_term_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update name.&nbsp;</div></li><li><div>            if ( isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                $args['name'] = wc_clean( wp_unslash( $data['name'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update slug.&nbsp;</div></li><li><div>            if ( isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $args['slug'] = sanitize_title( wp_unslash( $data['slug'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = wp_update_term( $id, $taxonomy, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_edit_product_attribute_term', $term-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product_attribute_term', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_attribute_term( $attribute_id, $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product attribute term.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param int $attribute_id Attribute ID.&nbsp;</div></li><li><div>     * @param int $id the product attribute ID.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product_attribute_term( $attribute_id, $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Check permissions.&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_delete_product_attribute_term', __( 'You do not have permission to delete product attribute terms', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $taxonomy = wc_attribute_taxonomy_name_by_id( $attribute_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $taxonomy ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_attribute_id', __( 'A product attribute with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $term = wp_delete_term( $id, $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $term ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_attribute_term', sprintf( __( 'This %s cannot be deleted', 'woocommerce' ), 'product_attribute_term' ), 500 );&nbsp;</div></li><li><div>            } elseif ( is_wp_error( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_attribute_term', $term-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_product_attribute_term', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product_attribute' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Clear product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function clear_product( $product_id ) {&nbsp;</div></li><li><div>        if ( ! is_numeric( $product_id ) || 0 &gt;= $product_id ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete product attachments&nbsp;</div></li><li><div>        $attachments = get_children( array(&nbsp;</div></li><li><div>            'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>            'post_status' =&gt; 'any', &nbsp;</div></li><li><div>            'post_type' =&gt; 'attachment', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( (array) $attachments as $attachment ) {&nbsp;</div></li><li><div>            wp_delete_attachment( $attachment-&gt;ID, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Delete product&nbsp;</div></li><li><div>        $product = wc_get_product( $product_id );&nbsp;</div></li><li><div>        $product-&gt;delete( true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk update or insert products&nbsp;</div></li><li><div>     * Accepts an array with products in the formats supported by&nbsp;</div></li><li><div>     * WC_API_Products-&gt;create_product() and WC_API_Products-&gt;edit_product()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function bulk( $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['products'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_products_data', sprintf( __( 'No %1$s data specified to create/edit %1$s', 'woocommerce' ), 'products' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['products'];&nbsp;</div></li><li><div>            $limit = apply_filters( 'woocommerce_api_bulk_limit', 100, 'products' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Limit bulk operation&nbsp;</div></li><li><div>            if ( count( $data ) &gt; $limit ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_products_request_entity_too_large', sprintf( __( 'Unable to accept more than %s items for this request.', 'woocommerce' ), $limit ), 413 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $data as $_product ) {&nbsp;</div></li><li><div>                $product_id = 0;&nbsp;</div></li><li><div>                $product_sku = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Try to get the product ID&nbsp;</div></li><li><div>                if ( isset( $_product['id'] ) ) {&nbsp;</div></li><li><div>                    $product_id = intval( $_product['id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! $product_id && isset( $_product['sku'] ) ) {&nbsp;</div></li><li><div>                    $product_sku = wc_clean( $_product['sku'] );&nbsp;</div></li><li><div>                    $product_id = wc_get_product_id_by_sku( $product_sku );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $product_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Product exists / edit product&nbsp;</div></li><li><div>                    $edit = $this-&gt;edit_product( $product_id, array( 'product' =&gt; $_product ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $edit ) ) {&nbsp;</div></li><li><div>                        $products[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $product_id, &nbsp;</div></li><li><div>                            'sku' =&gt; $product_sku, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $edit-&gt;get_error_code(), 'message' =&gt; $edit-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $products[] = $edit['product'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Product don't exists / create product&nbsp;</div></li><li><div>                    $new = $this-&gt;create_product( array( 'product' =&gt; $_product ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $new ) ) {&nbsp;</div></li><li><div>                        $products[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $product_id, &nbsp;</div></li><li><div>                            'sku' =&gt; $product_sku, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $new-&gt;get_error_code(), 'message' =&gt; $new-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $products[] = $new['product'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'products' =&gt; apply_filters( 'woocommerce_api_products_bulk_response', $products, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a listing of product shipping classes.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  string|null    $fields Fields to limit response to&nbsp;</div></li><li><div>     * @return array|WP_Error         List of product shipping classes if succeed, &nbsp;</div></li><li><div>     *                                otherwise WP_Error will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_shipping_classes( $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_shipping_classes', __( 'You do not have permission to read product shipping classes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_shipping_classes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $terms = get_terms( 'product_shipping_class', array( 'hide_empty' =&gt; false, 'fields' =&gt; 'ids' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $terms as $term_id ) {&nbsp;</div></li><li><div>                $product_shipping_classes[] = current( $this-&gt;get_product_shipping_class( $term_id, $fields ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_shipping_classes' =&gt; apply_filters( 'woocommerce_api_product_shipping_classes_response', $product_shipping_classes, $terms, $fields, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product shipping class for the given ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  string         $id     Product shipping class term ID&nbsp;</div></li><li><div>     * @param  string|null    $fields Fields to limit response to&nbsp;</div></li><li><div>     * @return array|WP_Error         Product shipping class if succeed, otherwise&nbsp;</div></li><li><div>     *                                WP_Error will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_shipping_class( $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            if ( ! $id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_shipping_class_id', __( 'Invalid product shipping class ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permissions check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_product_shipping_classes', __( 'You do not have permission to read product shipping classes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term = get_term( $id, 'product_shipping_class' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $term ) || is_null( $term ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_shipping_class_id', __( 'A product shipping class with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $term_id = intval( $term-&gt;term_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_shipping_class = array(&nbsp;</div></li><li><div>                'id' =&gt; $term_id, &nbsp;</div></li><li><div>                'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div>                'parent' =&gt; $term-&gt;parent, &nbsp;</div></li><li><div>                'description' =&gt; $term-&gt;description, &nbsp;</div></li><li><div>                'count' =&gt; intval( $term-&gt;count ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'product_shipping_class' =&gt; apply_filters( 'woocommerce_api_product_shipping_class_response', $product_shipping_class, $id, $fields, $term, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new product shipping class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  array          $data Posted data&nbsp;</div></li><li><div>     * @return array|WP_Error       Product shipping class if succeed, otherwise&nbsp;</div></li><li><div>     *                              WP_Error will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_product_shipping_class( $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_shipping_class'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_shipping_class_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'product_shipping_class' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_product_shipping_class', __( 'You do not have permission to create product shipping classes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $defaults = array(&nbsp;</div></li><li><div>                'name' =&gt; '', &nbsp;</div></li><li><div>                'slug' =&gt; '', &nbsp;</div></li><li><div>                'description' =&gt; '', &nbsp;</div></li><li><div>                'parent' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = wp_parse_args( $data['product_shipping_class'], $defaults );&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_product_shipping_class_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check parent.&nbsp;</div></li><li><div>            $data['parent'] = absint( $data['parent'] );&nbsp;</div></li><li><div>            if ( $data['parent'] ) {&nbsp;</div></li><li><div>                $parent = get_term_by( 'id', $data['parent'], 'product_shipping_class' );&nbsp;</div></li><li><div>                if ( ! $parent ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_product_shipping_class_parent', __( 'Product shipping class parent is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $insert = wp_insert_term( $data['name'], 'product_shipping_class', $data );&nbsp;</div></li><li><div>            if ( is_wp_error( $insert ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_product_shipping_class', $insert-&gt;get_error_message(), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $insert['term_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_product_shipping_class', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_shipping_class( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit a product shipping class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int            $id   Product shipping class term ID&nbsp;</div></li><li><div>     * @param  array          $data Posted data&nbsp;</div></li><li><div>     * @return array|WP_Error       Product shipping class if succeed, otherwise&nbsp;</div></li><li><div>     *                              WP_Error will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_product_shipping_class( $id, $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['product_shipping_class'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_product_shipping_class', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'product_shipping_class' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $data = $data['product_shipping_class'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_edit_product_shipping_class', __( 'You do not have permission to edit product shipping classes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_product_shipping_class_data', $data, $this );&nbsp;</div></li><li><div>            $shipping_class = $this-&gt;get_product_shipping_class( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $shipping_class ) ) {&nbsp;</div></li><li><div>                return $shipping_class;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update = wp_update_term( $id, 'product_shipping_class', $data );&nbsp;</div></li><li><div>            if ( is_wp_error( $update ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_edit_product_shipping_class', __( 'Could not edit the shipping class', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_product_shipping_class', $id, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_product_shipping_class( $id );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a product shipping class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.5.0&nbsp;</div></li><li><div>     * @param  int            $id Product shipping class term ID&nbsp;</div></li><li><div>     * @return array|WP_Error     Success message if succeed, otherwise WP_Error&nbsp;</div></li><li><div>     *                            will be returned&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_product_shipping_class( $id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Check permissions&nbsp;</div></li><li><div>            if ( ! current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_delete_product_shipping_class', __( 'You do not have permission to delete product shipping classes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>            $deleted = wp_delete_term( $id, 'product_shipping_class' );&nbsp;</div></li><li><div>            if ( ! $deleted || is_wp_error( $deleted ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_product_shipping_class', __( 'Could not delete the shipping class', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_product_shipping_class', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; sprintf( __( 'Deleted %s', 'woocommerce' ), 'product_shipping_class' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/wc_api_products/" class="">3.0.6</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/wc_api_products/" class="">3.0.5</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.4/classes/wc_api_products/" class="">3.0.4</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.3/classes/wc_api_products/" class="">3.0.3</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/wc_api_products/" class="active">3.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WC_API_Products</li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>