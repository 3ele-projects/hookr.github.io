<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.0.2" data-slug="woocommerce" data-type="class" data-id="41113"><head xmlns="http://www.w3.org/1999/xhtml"><title> wc_api_orders | class | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WC_API_Orders, class, plugin, woocommerce, 3.0.2" /><meta name="description" content="The WooCommerce WC API Orders class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=b442a5d11a36b7e2d5881c755fd9b7c0' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wc_api_orders/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_api_orders%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_api_orders%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.2-class-wc_api_orders","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wc_api_orders" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.2." href="http://hookr.io/plugins/woocommerce/3.0.2/" class="H_VERSION"><span property="name">3.0.2</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce/3.0.2/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wc_api_orders</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="3103"><a href="http://hookr.io/plugins/woocommerce/3.0.2/all/" title="All">All <span class="count badge">3103</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce/3.0.2/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2096"><a href="http://hookr.io/plugins/woocommerce/3.0.2/hooks/" title="Hooks">Hooks <span class="count badge">2096</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.2/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1322"><a href="http://hookr.io/plugins/woocommerce/3.0.2/filters/" title="Filters">Filters <span class="count badge">1322</span></a></li><li class="active" data-id="class" data-count="364"><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/" title="Classes">Classes <span class="count badge">364</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.2/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="625"><a href="http://hookr.io/plugins/woocommerce/3.0.2/functions/" title="Functions">Functions <span class="count badge">625</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.2/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WC_API_Orders</strong></h1><p>The WooCommerce <strong>WC API Orders</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(3)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.2/files/includes-api-legacy-v1-class-wc-api-orders/" class="file">/includes/api/legacy/v1/class-wc-api-orders.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="18" class="block" start="18"><li><div>class WC_API_Orders extends WC_API_Resource {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $base the route base */&nbsp;</div></li><li><div>    protected $base = '/orders';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register the routes for this class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * GET /orders&nbsp;</div></li><li><div>     * GET /orders/count&nbsp;</div></li><li><div>     * GET|PUT /orders/&lt;id&gt;&nbsp;</div></li><li><div>     * GET /orders/&lt;id&gt;/notes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $routes&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_routes( $routes ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders&nbsp;</div></li><li><div>        $routes[ $this-&gt;base ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_orders' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders/count&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/count' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_orders_count' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT /orders/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders/&lt;id&gt;/notes&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)/notes' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_notes' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $routes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @param string $status&nbsp;</div></li><li><div>     * @param int $page&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_orders( $fields = null, $filter = array(), $status = null, $page = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $status ) )&nbsp;</div></li><li><div>            $filter['status'] = $status;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter['page'] = $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $query-&gt;posts as $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;is_readable( $order_id ) )&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $orders[] = current( $this-&gt;get_order( $order_id, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;server-&gt;add_pagination_headers( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'orders' =&gt; $orders );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the order for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param array $fields&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure order ID is valid & user has permission to read&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'shop_order', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order = wc_get_order( $id );&nbsp;</div></li><li><div>        $order_data = array(&nbsp;</div></li><li><div>            'id' =&gt; $order-&gt;get_id(), &nbsp;</div></li><li><div>            'order_number' =&gt; $order-&gt;get_order_number(), &nbsp;</div></li><li><div>            'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_created() ? $order-&gt;get_date_created()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_modified() ? $order-&gt;get_date_modified()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'completed_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_completed() ? $order-&gt;get_date_completed()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'status' =&gt; $order-&gt;get_status(), &nbsp;</div></li><li><div>            'currency' =&gt; $order-&gt;get_currency(), &nbsp;</div></li><li><div>            'total' =&gt; wc_format_decimal( $order-&gt;get_total(), 2 ), &nbsp;</div></li><li><div>            'subtotal' =&gt; wc_format_decimal( $this-&gt;get_order_subtotal( $order ), 2 ), &nbsp;</div></li><li><div>            'total_line_items_quantity' =&gt; $order-&gt;get_item_count(), &nbsp;</div></li><li><div>            'total_tax' =&gt; wc_format_decimal( $order-&gt;get_total_tax(), 2 ), &nbsp;</div></li><li><div>            'total_shipping' =&gt; wc_format_decimal( $order-&gt;get_shipping_total(), 2 ), &nbsp;</div></li><li><div>            'cart_tax' =&gt; wc_format_decimal( $order-&gt;get_cart_tax(), 2 ), &nbsp;</div></li><li><div>            'shipping_tax' =&gt; wc_format_decimal( $order-&gt;get_shipping_tax(), 2 ), &nbsp;</div></li><li><div>            'total_discount' =&gt; wc_format_decimal( $order-&gt;get_total_discount(), 2 ), &nbsp;</div></li><li><div>            'cart_discount' =&gt; wc_format_decimal( 0, 2 ), &nbsp;</div></li><li><div>            'order_discount' =&gt; wc_format_decimal( 0, 2 ), &nbsp;</div></li><li><div>            'shipping_methods' =&gt; $order-&gt;get_shipping_method(), &nbsp;</div></li><li><div>            'payment_details' =&gt; array(&nbsp;</div></li><li><div>                'method_id' =&gt; $order-&gt;get_payment_method(), &nbsp;</div></li><li><div>                'method_title' =&gt; $order-&gt;get_payment_method_title(), &nbsp;</div></li><li><div>                'paid' =&gt; ! is_null( $order-&gt;get_date_paid() ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'billing_address' =&gt; array(&nbsp;</div></li><li><div>                'first_name' =&gt; $order-&gt;get_billing_first_name(), &nbsp;</div></li><li><div>                'last_name' =&gt; $order-&gt;get_billing_last_name(), &nbsp;</div></li><li><div>                'company' =&gt; $order-&gt;get_billing_company(), &nbsp;</div></li><li><div>                'address_1' =&gt; $order-&gt;get_billing_address_1(), &nbsp;</div></li><li><div>                'address_2' =&gt; $order-&gt;get_billing_address_2(), &nbsp;</div></li><li><div>                'city' =&gt; $order-&gt;get_billing_city(), &nbsp;</div></li><li><div>                'state' =&gt; $order-&gt;get_billing_state(), &nbsp;</div></li><li><div>                'postcode' =&gt; $order-&gt;get_billing_postcode(), &nbsp;</div></li><li><div>                'country' =&gt; $order-&gt;get_billing_country(), &nbsp;</div></li><li><div>                'email' =&gt; $order-&gt;get_billing_email(), &nbsp;</div></li><li><div>                'phone' =&gt; $order-&gt;get_billing_phone(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'shipping_address' =&gt; array(&nbsp;</div></li><li><div>                'first_name' =&gt; $order-&gt;get_shipping_first_name(), &nbsp;</div></li><li><div>                'last_name' =&gt; $order-&gt;get_shipping_last_name(), &nbsp;</div></li><li><div>                'company' =&gt; $order-&gt;get_shipping_company(), &nbsp;</div></li><li><div>                'address_1' =&gt; $order-&gt;get_shipping_address_1(), &nbsp;</div></li><li><div>                'address_2' =&gt; $order-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div>                'city' =&gt; $order-&gt;get_shipping_city(), &nbsp;</div></li><li><div>                'state' =&gt; $order-&gt;get_shipping_state(), &nbsp;</div></li><li><div>                'postcode' =&gt; $order-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>                'country' =&gt; $order-&gt;get_shipping_country(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'note' =&gt; $order-&gt;get_customer_note(), &nbsp;</div></li><li><div>            'customer_ip' =&gt; $order-&gt;get_customer_ip_address(), &nbsp;</div></li><li><div>            'customer_user_agent' =&gt; $order-&gt;get_customer_user_agent(), &nbsp;</div></li><li><div>            'customer_id' =&gt; $order-&gt;get_user_id(), &nbsp;</div></li><li><div>            'view_order_url' =&gt; $order-&gt;get_view_order_url(), &nbsp;</div></li><li><div>            'line_items' =&gt; array(), &nbsp;</div></li><li><div>            'shipping_lines' =&gt; array(), &nbsp;</div></li><li><div>            'tax_lines' =&gt; array(), &nbsp;</div></li><li><div>            'fee_lines' =&gt; array(), &nbsp;</div></li><li><div>            'coupon_lines' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add line items&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items() as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>            $product = $item-&gt;get_product();&nbsp;</div></li><li><div>            $order_data['line_items'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $item_id, &nbsp;</div></li><li><div>                'subtotal' =&gt; wc_format_decimal( $order-&gt;get_line_subtotal( $item ), 2 ), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $item ), 2 ), &nbsp;</div></li><li><div>                'total_tax' =&gt; wc_format_decimal( $order-&gt;get_line_tax( $item ), 2 ), &nbsp;</div></li><li><div>                'price' =&gt; wc_format_decimal( $order-&gt;get_item_total( $item ), 2 ), &nbsp;</div></li><li><div>                'quantity' =&gt; $item-&gt;get_quantity(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'name' =&gt; $item-&gt;get_name(), &nbsp;</div></li><li><div>                'product_id' =&gt; $item-&gt;get_variation_id() ? $item-&gt;get_variation_id() : $item-&gt;get_product_id(), &nbsp;</div></li><li><div>                'sku' =&gt; is_object( $product ) ? $product-&gt;get_sku() : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add shipping&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_shipping_methods() as $shipping_item_id =&gt; $shipping_item ) {&nbsp;</div></li><li><div>            $order_data['shipping_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $shipping_item_id, &nbsp;</div></li><li><div>                'method_id' =&gt; $shipping_item-&gt;get_method_id(), &nbsp;</div></li><li><div>                'method_title' =&gt; $shipping_item-&gt;get_name(), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $shipping_item-&gt;get_total(), 2 ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add taxes&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_tax_totals() as $tax_code =&gt; $tax ) {&nbsp;</div></li><li><div>            $order_data['tax_lines'][] = array(&nbsp;</div></li><li><div>                'code' =&gt; $tax_code, &nbsp;</div></li><li><div>                'title' =&gt; $tax-&gt;label, &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $tax-&gt;amount, 2 ), &nbsp;</div></li><li><div>                'compound' =&gt; (bool) $tax-&gt;is_compound, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add fees&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_fees() as $fee_item_id =&gt; $fee_item ) {&nbsp;</div></li><li><div>            $order_data['fee_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $fee_item_id, &nbsp;</div></li><li><div>                'title' =&gt; $fee_item-&gt;get_name(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $fee_item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $fee_item ), 2 ), &nbsp;</div></li><li><div>                'total_tax' =&gt; wc_format_decimal( $order-&gt;get_line_tax( $fee_item ), 2 ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add coupons&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items( 'coupon' ) as $coupon_item_id =&gt; $coupon_item ) {&nbsp;</div></li><li><div>            $order_data['coupon_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $coupon_item_id, &nbsp;</div></li><li><div>                'code' =&gt; $coupon_item-&gt;get_code(), &nbsp;</div></li><li><div>                'amount' =&gt; wc_format_decimal( $coupon_item-&gt;get_discount(), 2 ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order' =&gt; apply_filters( 'woocommerce_api_order_response', $order_data, $order, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total number of orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $status&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_orders_count( $status = null, $filter = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $status ) )&nbsp;</div></li><li><div>            $filter['status'] = $status;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'read_private_shop_orders' ) )&nbsp;</div></li><li><div>            return new WP_Error( 'woocommerce_api_user_cannot_read_orders_count', __( 'You do not have permission to read the orders count', 'woocommerce' ), array( 'status' =&gt; 401 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'count' =&gt; (int) $query-&gt;found_posts );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * API v1 only allows updating the status of an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order( $id, $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'shop_order', 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) )&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order = wc_get_order( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $data['status'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order-&gt;update_status( $data['status'], isset( $data['note'] ) ? $data['note'] : '' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;get_order( $id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param bool $force true to permanently delete order, false to move to trash&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order( $id, $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'shop_order', 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;delete( $id, 'order', ( 'true' === $force ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the admin order notes for an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param string $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_notes( $id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure ID is valid order ID&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, 'shop_order', 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) )&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'post_id' =&gt; $id, &nbsp;</div></li><li><div>            'approve' =&gt; 'approve', &nbsp;</div></li><li><div>            'type' =&gt; 'order_note', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        remove_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notes = get_comments( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_notes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $notes as $note ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_notes[] = array(&nbsp;</div></li><li><div>                'id' =&gt; $note-&gt;comment_ID, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $note-&gt;comment_date_gmt ), &nbsp;</div></li><li><div>                'note' =&gt; $note-&gt;comment_content, &nbsp;</div></li><li><div>                'customer_note' =&gt; get_comment_meta( $note-&gt;comment_ID, 'is_customer_note', true ) ? true : false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_notes' =&gt; apply_filters( 'woocommerce_api_order_notes_response', $order_notes, $id, $fields, $notes, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get order post objects&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $args request arguments for filtering query&nbsp;</div></li><li><div>     * @return WP_Query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function query_orders( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set base query arguments&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_type' =&gt; 'shop_order', &nbsp;</div></li><li><div>            'post_status' =&gt; array_keys( wc_get_order_statuses() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add status argument&nbsp;</div></li><li><div>        if ( ! empty( $args['status'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $statuses = 'wc-' . str_replace( ', ', ', wc-', $args['status'] );&nbsp;</div></li><li><div>            $statuses = explode( ', ', $statuses );&nbsp;</div></li><li><div>            $query_args['post_status'] = $statuses;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $args['status'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_args = $this-&gt;merge_query_args( $query_args, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_Query( $query_args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get the order subtotal&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param WC_Order $order&nbsp;</div></li><li><div>     * @return float&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_order_subtotal( $order ) {&nbsp;</div></li><li><div>        $subtotal = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // subtotal&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>            $subtotal += $item-&gt;get_subtotal();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $subtotal;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.2/files/includes-api-legacy-v2-class-wc-api-orders/" class="file">/includes/api/legacy/v2/class-wc-api-orders.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="17" class="block" start="17"><li><div>class WC_API_Orders extends WC_API_Resource {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $base the route base */&nbsp;</div></li><li><div>    protected $base = '/orders';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $post_type the custom post type */&nbsp;</div></li><li><div>    protected $post_type = 'shop_order';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register the routes for this class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * GET|POST /orders&nbsp;</div></li><li><div>     * GET /orders/count&nbsp;</div></li><li><div>     * GET|PUT|DELETE /orders/&lt;id&gt;&nbsp;</div></li><li><div>     * GET /orders/&lt;id&gt;/notes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $routes&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_routes( $routes ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|POST /orders&nbsp;</div></li><li><div>        $routes[ $this-&gt;base ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_orders' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_order' ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders/count&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/count' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_orders_count' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders/statuses&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/statuses' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_statuses' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT|DELETE /orders/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_order' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|POST /orders/&lt;id&gt;/notes&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/notes' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_notes' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_order_note' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT|DELETE /orders/&lt;order_id&gt;/notes/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/notes/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_note' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order_note' ), WC_API_SERVER::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_order_note' ), WC_API_SERVER::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|POST /orders/&lt;order_id&gt;/refunds&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/refunds' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_refunds' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_order_refund' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT|DELETE /orders/&lt;order_id&gt;/refunds/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/refunds/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_refund' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order_refund' ), WC_API_SERVER::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_order_refund' ), WC_API_SERVER::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # POST|PUT /orders/bulk&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/bulk' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'bulk' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $routes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @param string $status&nbsp;</div></li><li><div>     * @param int $page&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_orders( $fields = null, $filter = array(), $status = null, $page = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $status ) ) {&nbsp;</div></li><li><div>            $filter['status'] = $status;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter['page'] = $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $query-&gt;posts as $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;is_readable( $order_id ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $orders[] = current( $this-&gt;get_order( $order_id, $fields, $filter ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;server-&gt;add_pagination_headers( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'orders' =&gt; $orders );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the order for the given ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param array $fields&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order( $id, $fields = null, $filter = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure order ID is valid & user has permission to read&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the decimal precession&nbsp;</div></li><li><div>        $dp = ( isset( $filter['dp'] ) ? intval( $filter['dp'] ) : 2 );&nbsp;</div></li><li><div>        $order = wc_get_order( $id );&nbsp;</div></li><li><div>        $order_data = array(&nbsp;</div></li><li><div>            'id' =&gt; $order-&gt;get_id(), &nbsp;</div></li><li><div>            'order_number' =&gt; $order-&gt;get_order_number(), &nbsp;</div></li><li><div>            'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_created() ? $order-&gt;get_date_created()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_modified() ? $order-&gt;get_date_modified()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'completed_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_completed() ? $order-&gt;get_date_completed()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'status' =&gt; $order-&gt;get_status(), &nbsp;</div></li><li><div>            'currency' =&gt; $order-&gt;get_currency(), &nbsp;</div></li><li><div>            'total' =&gt; wc_format_decimal( $order-&gt;get_total(), $dp ), &nbsp;</div></li><li><div>            'subtotal' =&gt; wc_format_decimal( $order-&gt;get_subtotal(), $dp ), &nbsp;</div></li><li><div>            'total_line_items_quantity' =&gt; $order-&gt;get_item_count(), &nbsp;</div></li><li><div>            'total_tax' =&gt; wc_format_decimal( $order-&gt;get_total_tax(), $dp ), &nbsp;</div></li><li><div>            'total_shipping' =&gt; wc_format_decimal( $order-&gt;get_shipping_total(), $dp ), &nbsp;</div></li><li><div>            'cart_tax' =&gt; wc_format_decimal( $order-&gt;get_cart_tax(), $dp ), &nbsp;</div></li><li><div>            'shipping_tax' =&gt; wc_format_decimal( $order-&gt;get_shipping_tax(), $dp ), &nbsp;</div></li><li><div>            'total_discount' =&gt; wc_format_decimal( $order-&gt;get_total_discount(), $dp ), &nbsp;</div></li><li><div>            'shipping_methods' =&gt; $order-&gt;get_shipping_method(), &nbsp;</div></li><li><div>            'payment_details' =&gt; array(&nbsp;</div></li><li><div>                'method_id' =&gt; $order-&gt;get_payment_method(), &nbsp;</div></li><li><div>                'method_title' =&gt; $order-&gt;get_payment_method_title(), &nbsp;</div></li><li><div>                'paid' =&gt; ! is_null( $order-&gt;get_date_paid() ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'billing_address' =&gt; array(&nbsp;</div></li><li><div>                'first_name' =&gt; $order-&gt;get_billing_first_name(), &nbsp;</div></li><li><div>                'last_name' =&gt; $order-&gt;get_billing_last_name(), &nbsp;</div></li><li><div>                'company' =&gt; $order-&gt;get_billing_company(), &nbsp;</div></li><li><div>                'address_1' =&gt; $order-&gt;get_billing_address_1(), &nbsp;</div></li><li><div>                'address_2' =&gt; $order-&gt;get_billing_address_2(), &nbsp;</div></li><li><div>                'city' =&gt; $order-&gt;get_billing_city(), &nbsp;</div></li><li><div>                'state' =&gt; $order-&gt;get_billing_state(), &nbsp;</div></li><li><div>                'postcode' =&gt; $order-&gt;get_billing_postcode(), &nbsp;</div></li><li><div>                'country' =&gt; $order-&gt;get_billing_country(), &nbsp;</div></li><li><div>                'email' =&gt; $order-&gt;get_billing_email(), &nbsp;</div></li><li><div>                'phone' =&gt; $order-&gt;get_billing_phone(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'shipping_address' =&gt; array(&nbsp;</div></li><li><div>                'first_name' =&gt; $order-&gt;get_shipping_first_name(), &nbsp;</div></li><li><div>                'last_name' =&gt; $order-&gt;get_shipping_last_name(), &nbsp;</div></li><li><div>                'company' =&gt; $order-&gt;get_shipping_company(), &nbsp;</div></li><li><div>                'address_1' =&gt; $order-&gt;get_shipping_address_1(), &nbsp;</div></li><li><div>                'address_2' =&gt; $order-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div>                'city' =&gt; $order-&gt;get_shipping_city(), &nbsp;</div></li><li><div>                'state' =&gt; $order-&gt;get_shipping_state(), &nbsp;</div></li><li><div>                'postcode' =&gt; $order-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>                'country' =&gt; $order-&gt;get_shipping_country(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'note' =&gt; $order-&gt;get_customer_note(), &nbsp;</div></li><li><div>            'customer_ip' =&gt; $order-&gt;get_customer_ip_address(), &nbsp;</div></li><li><div>            'customer_user_agent' =&gt; $order-&gt;get_customer_user_agent(), &nbsp;</div></li><li><div>            'customer_id' =&gt; $order-&gt;get_user_id(), &nbsp;</div></li><li><div>            'view_order_url' =&gt; $order-&gt;get_view_order_url(), &nbsp;</div></li><li><div>            'line_items' =&gt; array(), &nbsp;</div></li><li><div>            'shipping_lines' =&gt; array(), &nbsp;</div></li><li><div>            'tax_lines' =&gt; array(), &nbsp;</div></li><li><div>            'fee_lines' =&gt; array(), &nbsp;</div></li><li><div>            'coupon_lines' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add line items&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items() as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>            $product = $item-&gt;get_product();&nbsp;</div></li><li><div>            $hideprefix = ( isset( $filter['all_item_meta'] ) && 'true' === $filter['all_item_meta'] ) ? null : '_';&nbsp;</div></li><li><div>            $item_meta = $item-&gt;get_formatted_meta_data( $hideprefix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $item_meta as $key =&gt; $values ) {&nbsp;</div></li><li><div>                $item_meta[ $key ]-&gt;label = $values-&gt;display_key;&nbsp;</div></li><li><div>                unset( $item_meta[ $key ]-&gt;display_key );&nbsp;</div></li><li><div>                unset( $item_meta[ $key ]-&gt;display_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_data['line_items'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $item_id, &nbsp;</div></li><li><div>                'subtotal' =&gt; wc_format_decimal( $order-&gt;get_line_subtotal( $item, false, false ), $dp ), &nbsp;</div></li><li><div>                'subtotal_tax' =&gt; wc_format_decimal( $item-&gt;get_subtotal_tax(), $dp ), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $item, false, false ), $dp ), &nbsp;</div></li><li><div>                'total_tax' =&gt; wc_format_decimal( $item-&gt;get_total_tax(), $dp ), &nbsp;</div></li><li><div>                'price' =&gt; wc_format_decimal( $order-&gt;get_item_total( $item, false, false ), $dp ), &nbsp;</div></li><li><div>                'quantity' =&gt; $item-&gt;get_quantity(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'name' =&gt; $item-&gt;get_name(), &nbsp;</div></li><li><div>                'product_id' =&gt; $item-&gt;get_variation_id() ? $item-&gt;get_variation_id() : $item-&gt;get_product_id(), &nbsp;</div></li><li><div>                'sku' =&gt; is_object( $product ) ? $product-&gt;get_sku() : null, &nbsp;</div></li><li><div>                'meta' =&gt; array_values( $item_meta ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add shipping&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_shipping_methods() as $shipping_item_id =&gt; $shipping_item ) {&nbsp;</div></li><li><div>            $order_data['shipping_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $shipping_item_id, &nbsp;</div></li><li><div>                'method_id' =&gt; $shipping_item-&gt;get_method_id(), &nbsp;</div></li><li><div>                'method_title' =&gt; $shipping_item-&gt;get_name(), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $shipping_item-&gt;get_total(), $dp ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add taxes&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_tax_totals() as $tax_code =&gt; $tax ) {&nbsp;</div></li><li><div>            $order_data['tax_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $tax-&gt;id, &nbsp;</div></li><li><div>                'rate_id' =&gt; $tax-&gt;rate_id, &nbsp;</div></li><li><div>                'code' =&gt; $tax_code, &nbsp;</div></li><li><div>                'title' =&gt; $tax-&gt;label, &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $tax-&gt;amount, $dp ), &nbsp;</div></li><li><div>                'compound' =&gt; (bool) $tax-&gt;is_compound, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add fees&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_fees() as $fee_item_id =&gt; $fee_item ) {&nbsp;</div></li><li><div>            $order_data['fee_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $fee_item_id, &nbsp;</div></li><li><div>                'title' =&gt; $fee_item-&gt;get_name(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $fee_item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $fee_item ), $dp ), &nbsp;</div></li><li><div>                'total_tax' =&gt; wc_format_decimal( $order-&gt;get_line_tax( $fee_item ), $dp ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add coupons&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items( 'coupon' ) as $coupon_item_id =&gt; $coupon_item ) {&nbsp;</div></li><li><div>            $order_data['coupon_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $coupon_item_id, &nbsp;</div></li><li><div>                'code' =&gt; $coupon_item-&gt;get_code(), &nbsp;</div></li><li><div>                'amount' =&gt; wc_format_decimal( $coupon_item-&gt;get_discount(), $dp ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order' =&gt; apply_filters( 'woocommerce_api_order_response', $order_data, $order, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total number of orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @param string $status&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_orders_count( $status = null, $filter = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! current_user_can( 'read_private_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_orders_count', __( 'You do not have permission to read the orders count', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $status ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 'any' === $status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $order_statuses = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( wc_get_order_statuses() as $slug =&gt; $name ) {&nbsp;</div></li><li><div>                        $filter['status'] = str_replace( 'wc-', '', $slug );&nbsp;</div></li><li><div>                        $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>                        $order_statuses[ str_replace( 'wc-', '', $slug ) ] = (int) $query-&gt;found_posts;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return array( 'count' =&gt; $order_statuses );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $filter['status'] = $status;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'count' =&gt; (int) $query-&gt;found_posts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a list of valid order statuses&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note this requires no specific permissions other than being an authenticated&nbsp;</div></li><li><div>     * API user. Order statuses (particularly custom statuses) could be considered&nbsp;</div></li><li><div>     * private information which is why it's not in the API index.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_statuses() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_statuses = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( wc_get_order_statuses() as $slug =&gt; $name ) {&nbsp;</div></li><li><div>            $order_statuses[ str_replace( 'wc-', '', $slug ) ] = $name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_statuses' =&gt; apply_filters( 'woocommerce_api_order_statuses_response', $order_statuses, $this ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $data raw order data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_order( $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_transaction_query( 'start' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'order' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // permission check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_order', __( 'You do not have permission to create orders', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_order_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // default order args, note that status is checked for validity in wc_create_order()&nbsp;</div></li><li><div>            $default_order_args = array(&nbsp;</div></li><li><div>                'status' =&gt; isset( $data['status'] ) ? $data['status'] : '', &nbsp;</div></li><li><div>                'customer_note' =&gt; isset( $data['note'] ) ? $data['note'] : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if creating order for existing customer&nbsp;</div></li><li><div>            if ( ! empty( $data['customer_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // make sure customer exists&nbsp;</div></li><li><div>                if ( false === get_user_by( 'id', $data['customer_id'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_customer_id', __( 'Customer ID is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $default_order_args['customer_id'] = $data['customer_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create the pending order&nbsp;</div></li><li><div>            $order = $this-&gt;create_base_order( $default_order_args, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_order', sprintf( __( 'Cannot create order: %s', 'woocommerce' ), implode( ', ', $order-&gt;get_error_messages() ) ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // billing/shipping addresses&nbsp;</div></li><li><div>            $this-&gt;set_order_addresses( $order, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $lines = array(&nbsp;</div></li><li><div>                'line_item' =&gt; 'line_items', &nbsp;</div></li><li><div>                'shipping' =&gt; 'shipping_lines', &nbsp;</div></li><li><div>                'fee' =&gt; 'fee_lines', &nbsp;</div></li><li><div>                'coupon' =&gt; 'coupon_lines', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $lines as $line_type =&gt; $line ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data[ $line ] ) && is_array( $data[ $line ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $set_item = &quot;set_{$line_type}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $data[ $line ] as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $this-&gt;$set_item( $order, $item, 'create' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // calculate totals and set them&nbsp;</div></li><li><div>            $order-&gt;calculate_totals();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // payment method (and payment_complete() if `paid` == true)&nbsp;</div></li><li><div>            if ( isset( $data['payment_details'] ) && is_array( $data['payment_details'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // method ID & title are required&nbsp;</div></li><li><div>                if ( empty( $data['payment_details']['method_id'] ) || empty( $data['payment_details']['method_title'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_payment_details', __( 'Payment method ID and title are required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_payment_method', $data['payment_details']['method_id'] );&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_payment_method_title', $data['payment_details']['method_title'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // mark as paid if set&nbsp;</div></li><li><div>                if ( isset( $data['payment_details']['paid'] ) && true === $data['payment_details']['paid'] ) {&nbsp;</div></li><li><div>                    $order-&gt;payment_complete( isset( $data['payment_details']['transaction_id'] ) ? $data['payment_details']['transaction_id'] : '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set order currency&nbsp;</div></li><li><div>            if ( isset( $data['currency'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! array_key_exists( $data['currency'], get_woocommerce_currencies() ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_order_currency', __( 'Provided order currency is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_order_currency', $data['currency'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set order meta&nbsp;</div></li><li><div>            if ( isset( $data['order_meta'] ) && is_array( $data['order_meta'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;set_order_meta( $order-&gt;get_id(), $data['order_meta'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // HTTP 201 Created&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_delete_shop_order_transients( $order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_order', $order-&gt;get_id(), $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_transaction_query( 'commit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order( $order-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            wc_transaction_query( 'rollback' );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            wc_transaction_query( 'rollback' );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates new WC_Order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Requires a separate function for classes that extend WC_API_Orders.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3&nbsp;</div></li><li><div>     * @param $args array&nbsp;</div></li><li><div>     * @return WC_Order&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function create_base_order( $args, $data ) {&nbsp;</div></li><li><div>        return wc_create_order( $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order( $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'order' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update_totals = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $this-&gt;validate_request( $id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>                return $id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_order_data', $data, $id, $this );&nbsp;</div></li><li><div>            $order = wc_get_order( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $order ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_id', __( 'Order ID is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_args = array( 'order_id' =&gt; $order-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer note.&nbsp;</div></li><li><div>            if ( isset( $data['note'] ) ) {&nbsp;</div></li><li><div>                $order_args['customer_note'] = $data['note'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer ID.&nbsp;</div></li><li><div>            if ( isset( $data['customer_id'] ) && $data['customer_id'] != $order-&gt;get_user_id() ) {&nbsp;</div></li><li><div>                // Make sure customer exists.&nbsp;</div></li><li><div>                if ( false === get_user_by( 'id', $data['customer_id'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_customer_id', __( 'Customer ID is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_customer_user', $data['customer_id'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Billing/shipping address.&nbsp;</div></li><li><div>            $this-&gt;set_order_addresses( $order, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $lines = array(&nbsp;</div></li><li><div>                'line_item' =&gt; 'line_items', &nbsp;</div></li><li><div>                'shipping' =&gt; 'shipping_lines', &nbsp;</div></li><li><div>                'fee' =&gt; 'fee_lines', &nbsp;</div></li><li><div>                'coupon' =&gt; 'coupon_lines', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $lines as $line_type =&gt; $line ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data[ $line ] ) && is_array( $data[ $line ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $update_totals = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $data[ $line ] as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Item ID is always required.&nbsp;</div></li><li><div>                        if ( ! array_key_exists( 'id', $item ) ) {&nbsp;</div></li><li><div>                            $item['id'] = null;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Create item.&nbsp;</div></li><li><div>                        if ( is_null( $item['id'] ) ) {&nbsp;</div></li><li><div>                            $this-&gt;set_item( $order, $line_type, $item, 'create' );&nbsp;</div></li><li><div>                        } elseif ( $this-&gt;item_is_null( $item ) ) {&nbsp;</div></li><li><div>                            // Delete item.&nbsp;</div></li><li><div>                            wc_delete_order_item( $item['id'] );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            // Update item.&nbsp;</div></li><li><div>                            $this-&gt;set_item( $order, $line_type, $item, 'update' );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Payment method (and payment_complete() if `paid` == true and order needs payment).&nbsp;</div></li><li><div>            if ( isset( $data['payment_details'] ) && is_array( $data['payment_details'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Method ID.&nbsp;</div></li><li><div>                if ( isset( $data['payment_details']['method_id'] ) ) {&nbsp;</div></li><li><div>                    update_post_meta( $order-&gt;get_id(), '_payment_method', $data['payment_details']['method_id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Method title.&nbsp;</div></li><li><div>                if ( isset( $data['payment_details']['method_title'] ) ) {&nbsp;</div></li><li><div>                    update_post_meta( $order-&gt;get_id(), '_payment_method_title', $data['payment_details']['method_title'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Mark as paid if set.&nbsp;</div></li><li><div>                if ( $order-&gt;needs_payment() && isset( $data['payment_details']['paid'] ) && true === $data['payment_details']['paid'] ) {&nbsp;</div></li><li><div>                    $order-&gt;payment_complete( isset( $data['payment_details']['transaction_id'] ) ? $data['payment_details']['transaction_id'] : '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set order currency.&nbsp;</div></li><li><div>            if ( isset( $data['currency'] ) ) {&nbsp;</div></li><li><div>                if ( ! array_key_exists( $data['currency'], get_woocommerce_currencies() ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_order_currency', __( 'Provided order currency is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_order_currency', $data['currency'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If items have changed, recalculate order totals.&nbsp;</div></li><li><div>            if ( $update_totals ) {&nbsp;</div></li><li><div>                $order-&gt;calculate_totals();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update order meta.&nbsp;</div></li><li><div>            if ( isset( $data['order_meta'] ) && is_array( $data['order_meta'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;set_order_meta( $order-&gt;get_id(), $data['order_meta'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update the order post to set customer note/modified date.&nbsp;</div></li><li><div>            wc_update_order( $order_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Order status.&nbsp;</div></li><li><div>            if ( ! empty( $data['status'] ) ) {&nbsp;</div></li><li><div>                $order-&gt;update_status( $data['status'], isset( $data['status_note'] ) ? $data['status_note'] : '', true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_delete_shop_order_transients( $order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_order', $order-&gt;get_id(), $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param bool $force true to permanently delete order, false to move to trash&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order( $id, $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, $this-&gt;post_type, 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_delete_shop_order_transients( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_delete_order', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;delete( $id, 'order', ( 'true' === $force ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get order post objects&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $args request arguments for filtering query&nbsp;</div></li><li><div>     * @return WP_Query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function query_orders( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set base query arguments&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_type' =&gt; $this-&gt;post_type, &nbsp;</div></li><li><div>            'post_status' =&gt; array_keys( wc_get_order_statuses() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add status argument&nbsp;</div></li><li><div>        if ( ! empty( $args['status'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $statuses = 'wc-' . str_replace( ', ', ', wc-', $args['status'] );&nbsp;</div></li><li><div>            $statuses = explode( ', ', $statuses );&nbsp;</div></li><li><div>            $query_args['post_status'] = $statuses;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $args['status'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_args = $this-&gt;merge_query_args( $query_args, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_Query( $query_args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to set/update the billing & shipping addresses for&nbsp;</div></li><li><div>     * an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_order_addresses( $order, $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $address_fields = array(&nbsp;</div></li><li><div>            'first_name', &nbsp;</div></li><li><div>            'last_name', &nbsp;</div></li><li><div>            'company', &nbsp;</div></li><li><div>            'email', &nbsp;</div></li><li><div>            'phone', &nbsp;</div></li><li><div>            'address_1', &nbsp;</div></li><li><div>            'address_2', &nbsp;</div></li><li><div>            'city', &nbsp;</div></li><li><div>            'state', &nbsp;</div></li><li><div>            'postcode', &nbsp;</div></li><li><div>            'country', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $billing_address = $shipping_address = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // billing address&nbsp;</div></li><li><div>        if ( isset( $data['billing_address'] ) && is_array( $data['billing_address'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $address_fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data['billing_address'][ $field ] ) ) {&nbsp;</div></li><li><div>                    $billing_address[ $field ] = wc_clean( $data['billing_address'][ $field ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $address_fields['email'] );&nbsp;</div></li><li><div>            unset( $address_fields['phone'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // shipping address&nbsp;</div></li><li><div>        if ( isset( $data['shipping_address'] ) && is_array( $data['shipping_address'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $address_fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data['shipping_address'][ $field ] ) ) {&nbsp;</div></li><li><div>                    $shipping_address[ $field ] = wc_clean( $data['shipping_address'][ $field ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;update_address( $order, $billing_address, 'billing' );&nbsp;</div></li><li><div>        $this-&gt;update_address( $order, $shipping_address, 'shipping' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update user meta&nbsp;</div></li><li><div>        if ( $order-&gt;get_user_id() ) {&nbsp;</div></li><li><div>            foreach ( $billing_address as $key =&gt; $value ) {&nbsp;</div></li><li><div>                update_user_meta( $order-&gt;get_user_id(), 'billing_' . $key, $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( $shipping_address as $key =&gt; $value ) {&nbsp;</div></li><li><div>                update_user_meta( $order-&gt;get_user_id(), 'shipping_' . $key, $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update address.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Order $order&nbsp;</div></li><li><div>     * @param array $posted&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_address( $order, $posted, $type = 'billing' ) {&nbsp;</div></li><li><div>        foreach ( $posted as $key =&gt; $value ) {&nbsp;</div></li><li><div>            if ( is_callable( array( $order, &quot;set_{$type}_{$key}&quot; ) ) ) {&nbsp;</div></li><li><div>                $order-&gt;{&quot;set_{$type}_{$key}&quot;}( $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to add/update order meta, with two restrictions:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * 1) Only non-protected meta (no leading underscore) can be set&nbsp;</div></li><li><div>     * 2) Meta values must be scalar (int, string, bool)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $order_id valid order ID&nbsp;</div></li><li><div>     * @param array $order_meta order meta in array( 'meta_key' =&gt; 'meta_value' ) format&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_order_meta( $order_id, $order_meta ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $order_meta as $meta_key =&gt; $meta_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_string( $meta_key ) && ! is_protected_meta( $meta_key ) && is_scalar( $meta_value ) ) {&nbsp;</div></li><li><div>                update_post_meta( $order_id, $meta_key, $meta_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to check if the resource ID associated with the provided item is null&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Items can be deleted by setting the resource ID to null&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $item item provided in the request body&nbsp;</div></li><li><div>     * @return bool true if the item resource ID is null, false otherwise&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function item_is_null( $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $keys = array( 'product_id', 'method_id', 'title', 'code' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $keys as $key ) {&nbsp;</div></li><li><div>            if ( array_key_exists( $key, $item ) && is_null( $item[ $key ] ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Wrapper method to create/update order items&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * When updating, the item ID provided is checked to ensure it is associated&nbsp;</div></li><li><div>     * with the order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order order&nbsp;</div></li><li><div>     * @param string $item_type&nbsp;</div></li><li><div>     * @param array $item item provided in the request body&nbsp;</div></li><li><div>     * @param string $action either 'create' or 'update'&nbsp;</div></li><li><div>     * @throws WC_API_Exception if item ID is not associated with order&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_item( $order, $item_type, $item, $action ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $set_method = &quot;set_{$item_type}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // verify provided line item ID is associated with order&nbsp;</div></li><li><div>        if ( 'update' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_row(&nbsp;</div></li><li><div>                $wpdb-&gt;prepare( &quot;SELECT * FROM {$wpdb-&gt;prefix}woocommerce_order_items WHERE order_item_id = %d AND order_id = %d&quot;, &nbsp;</div></li><li><div>                absint( $item['id'] ), &nbsp;</div></li><li><div>                absint( $order-&gt;get_id() )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $result ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_item_id', __( 'Order item ID provided is not associated with order.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;$set_method( $order, $item, $action );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update a line item&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $item line item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add line item or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_line_item( $order, $item, $action ) {&nbsp;</div></li><li><div>        $creating = ( 'create' === $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // product is always required&nbsp;</div></li><li><div>        if ( ! isset( $item['product_id'] ) && ! isset( $item['sku'] ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_id', __( 'Product ID or SKU is required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // when updating, ensure product ID provided matches&nbsp;</div></li><li><div>        if ( 'update' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item_product_id = wc_get_order_item_meta( $item['id'], '_product_id' );&nbsp;</div></li><li><div>            $item_variation_id = wc_get_order_item_meta( $item['id'], '_variation_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $item['product_id'] != $item_product_id && $item['product_id'] != $item_variation_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_id', __( 'Product ID provided does not match this line item', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $item['product_id'] ) ) {&nbsp;</div></li><li><div>            $product_id = $item['product_id'];&nbsp;</div></li><li><div>        } elseif ( isset( $item['sku'] ) ) {&nbsp;</div></li><li><div>            $product_id = wc_get_product_id_by_sku( $item['sku'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // variations must each have a key & value&nbsp;</div></li><li><div>        $variation_id = 0;&nbsp;</div></li><li><div>        if ( isset( $item['variations'] ) && is_array( $item['variations'] ) ) {&nbsp;</div></li><li><div>            foreach ( $item['variations'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>                if ( ! $key || ! $value ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_product_variation', __( 'The product variation is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation_id = $this-&gt;get_variation_id( wc_get_product( $product_id ), $item['variations'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $variation_id ? $variation_id : $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // must be a valid WC_Product&nbsp;</div></li><li><div>        if ( ! is_object( $product ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product', __( 'Product is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // quantity must be positive float&nbsp;</div></li><li><div>        if ( isset( $item['quantity'] ) && floatval( $item['quantity'] ) &lt;= 0 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_quantity', __( 'Product quantity must be a positive float.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // quantity is required when creating&nbsp;</div></li><li><div>        if ( $creating && ! isset( $item['quantity'] ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_quantity', __( 'Product quantity is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $creating ) {&nbsp;</div></li><li><div>            $line_item = new WC_Order_Item_Product();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $line_item = new WC_Order_Item_Product( $item['id'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $line_item-&gt;set_product( $product );&nbsp;</div></li><li><div>        $line_item-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $item['quantity'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_quantity( $item['quantity'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['total'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_total( floatval( $item['total'] ) );&nbsp;</div></li><li><div>        } elseif ( $creating ) {&nbsp;</div></li><li><div>            $total = wc_get_price_excluding_tax( $product, array( 'qty' =&gt; $line_item-&gt;get_quantity() ) );&nbsp;</div></li><li><div>            $line_item-&gt;set_total( $total );&nbsp;</div></li><li><div>            $line_item-&gt;set_subtotal( $total );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['total_tax'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_total_tax( floatval( $item['total_tax'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['subtotal'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_subtotal( floatval( $item['subtotal'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['subtotal_tax'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_subtotal_tax( floatval( $item['subtotal_tax'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $variation_id ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_variation_id( $variation_id );&nbsp;</div></li><li><div>            $line_item-&gt;set_variation( $item['variations'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $item_id = $line_item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $item_id ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_cannot_create_line_item', __( 'Cannot create line item, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Given a product ID & API provided variations, find the correct variation ID to use for calculation&nbsp;</div></li><li><div>     * We can't just trust input from the API to pass a variation_id manually, otherwise you could pass&nbsp;</div></li><li><div>     * the cheapest variation ID but provide other information so we have to look up the variation ID.&nbsp;</div></li><li><div>     * @param  int $product_id main product ID&nbsp;</div></li><li><div>     * @return int             returns an ID if a valid variation was found for this product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function get_variation_id( $product, $variations = array() ) {&nbsp;</div></li><li><div>        $variation_id = null;&nbsp;</div></li><li><div>        $variations_normalized = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) && $product-&gt;has_child() ) {&nbsp;</div></li><li><div>            if ( isset( $variations ) && is_array( $variations ) ) {&nbsp;</div></li><li><div>                // start by normalizing the passed variations&nbsp;</div></li><li><div>                foreach ( $variations as $key =&gt; $value ) {&nbsp;</div></li><li><div>                    $key = str_replace( 'attribute_', '', str_replace( 'pa_', '', $key ) ); // from get_attributes in class-wc-api-products.php&nbsp;</div></li><li><div>                    $variations_normalized[ $key ] = strtolower( $value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // now search through each product child and see if our passed variations match anything&nbsp;</div></li><li><div>                foreach ( $product-&gt;get_children() as $variation ) {&nbsp;</div></li><li><div>                    $meta = array();&nbsp;</div></li><li><div>                    foreach ( get_post_meta( $variation ) as $key =&gt; $value ) {&nbsp;</div></li><li><div>                        $value = $value[0];&nbsp;</div></li><li><div>                        $key = str_replace( 'attribute_', '', str_replace( 'pa_', '', $key ) );&nbsp;</div></li><li><div>                        $meta[ $key ] = strtolower( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // if the variation array is a part of the $meta array, we found our match&nbsp;</div></li><li><div>                    if ( $this-&gt;array_contains( $variations_normalized, $meta ) ) {&nbsp;</div></li><li><div>                        $variation_id = $variation;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $variation_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Utility function to see if the meta array contains data from variations&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function array_contains( $needles, $haystack ) {&nbsp;</div></li><li><div>        foreach ( $needles as $key =&gt; $value ) {&nbsp;</div></li><li><div>            if ( $haystack[ $key ] !== $value ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update an order shipping method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $shipping item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add shipping or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_shipping( $order, $shipping, $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // total must be a positive float&nbsp;</div></li><li><div>        if ( isset( $shipping['total'] ) && floatval( $shipping['total'] ) &lt; 0 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_invalid_shipping_total', __( 'Shipping total must be a positive amount.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'create' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // method ID is required&nbsp;</div></li><li><div>            if ( ! isset( $shipping['method_id'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_shipping_item', __( 'Shipping method ID is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $rate = new WC_Shipping_Rate( $shipping['method_id'], isset( $shipping['method_title'] ) ? $shipping['method_title'] : '', isset( $shipping['total'] ) ? floatval( $shipping['total'] ) : 0, array(), $shipping['method_id'] );&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Shipping();&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>            $item-&gt;set_shipping_rate( $rate );&nbsp;</div></li><li><div>            $shipping_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $shipping_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_create_shipping', __( 'Cannot create shipping method, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Shipping( $shipping['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $shipping['method_id'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_method_id( $shipping['method_id'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $shipping['method_title'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_method_title( $shipping['method_title'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $shipping['total'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_total( floatval( $shipping['total'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $shipping_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $shipping_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_update_shipping', __( 'Cannot update shipping method, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update an order fee&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $fee item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add fee or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_fee( $order, $fee, $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'create' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // fee title is required&nbsp;</div></li><li><div>            if ( ! isset( $fee['title'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_fee_item', __( 'Fee title is required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Fee();&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>            $item-&gt;set_name( wc_clean( $fee['title'] ) );&nbsp;</div></li><li><div>            $item-&gt;set_total( isset( $fee['total'] ) ? floatval( $fee['total'] ) : 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if taxable, tax class and total are required&nbsp;</div></li><li><div>            if ( ! empty( $fee['taxable'] ) ) {&nbsp;</div></li><li><div>                if ( ! isset( $fee['tax_class'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_fee_item', __( 'Fee tax class is required when fee is taxable.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $item-&gt;set_tax_status( 'taxable' );&nbsp;</div></li><li><div>                $item-&gt;set_tax_class( $fee['tax_class'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $fee['total_tax'] ) ) {&nbsp;</div></li><li><div>                    $item-&gt;set_total_tax( isset( $fee['total_tax'] ) ? wc_format_refund_total( $fee['total_tax'] ) : 0 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $fee['tax_data'] ) ) {&nbsp;</div></li><li><div>                    $item-&gt;set_total_tax( wc_format_refund_total( array_sum( $fee['tax_data'] ) ) );&nbsp;</div></li><li><div>                    $item-&gt;set_taxes( array_map( 'wc_format_refund_total', $fee['tax_data'] ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fee_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $fee_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_create_fee', __( 'Cannot create fee, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Fee( $fee['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['title'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_name( wc_clean( $fee['title'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['tax_class'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_tax_class( $fee['tax_class'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['total'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_total( floatval( $fee['total'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['total_tax'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_total_tax( floatval( $fee['total_tax'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fee_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $fee_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_update_fee', __( 'Cannot update fee, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update an order coupon&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $coupon item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add coupon or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_coupon( $order, $coupon, $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // coupon amount must be positive float&nbsp;</div></li><li><div>        if ( isset( $coupon['amount'] ) && floatval( $coupon['amount'] ) &lt; 0 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_invalid_coupon_total', __( 'Coupon discount total must be a positive amount.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'create' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // coupon code is required&nbsp;</div></li><li><div>            if ( empty( $coupon['code'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_coupon_coupon', __( 'Coupon code is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Coupon();&nbsp;</div></li><li><div>            $item-&gt;set_props( array(&nbsp;</div></li><li><div>                'code' =&gt; $coupon['code'], &nbsp;</div></li><li><div>                'discount' =&gt; isset( $coupon['amount'] ) ? floatval( $coupon['amount'] ) : 0, &nbsp;</div></li><li><div>                'discount_tax' =&gt; 0, &nbsp;</div></li><li><div>                'order_id' =&gt; $order-&gt;get_id(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            $coupon_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $coupon_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_create_order_coupon', __( 'Cannot create coupon, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Coupon( $coupon['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $coupon['code'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_code( $coupon['code'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $coupon['amount'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_discount( floatval( $coupon['amount'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $coupon_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $coupon_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_update_order_coupon', __( 'Cannot update coupon, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the admin order notes for an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_notes( $order_id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure ID is valid order ID&nbsp;</div></li><li><div>        $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>            return $order_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'post_id' =&gt; $order_id, &nbsp;</div></li><li><div>            'approve' =&gt; 'approve', &nbsp;</div></li><li><div>            'type' =&gt; 'order_note', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        remove_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notes = get_comments( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_notes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $notes as $note ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_notes[] = current( $this-&gt;get_order_note( $order_id, $note-&gt;comment_ID, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_notes' =&gt; apply_filters( 'woocommerce_api_order_notes_response', $order_notes, $order_id, $fields, $notes, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an order note for the given order ID and ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id order note ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_note( $order_id, $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'Invalid order note ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $note = get_comment( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $note ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'An order note with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_note = array(&nbsp;</div></li><li><div>                'id' =&gt; $note-&gt;comment_ID, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $note-&gt;comment_date_gmt ), &nbsp;</div></li><li><div>                'note' =&gt; $note-&gt;comment_content, &nbsp;</div></li><li><div>                'customer_note' =&gt; get_comment_meta( $note-&gt;comment_ID, 'is_customer_note', true ) ? true : false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'order_note' =&gt; apply_filters( 'woocommerce_api_order_note_response', $order_note, $id, $fields, $note, $order_id, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new order note for the given order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param array $data raw request data&nbsp;</div></li><li><div>     * @return WP_Error|array error or created note response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_order_note( $order_id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_note'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_note_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'order_note' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_note'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // permission check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_order_note', __( 'You do not have permission to create order notes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_order_note_data', $data, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // note content is required&nbsp;</div></li><li><div>            if ( ! isset( $data['note'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note', __( 'Order note is required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_customer_note = ( isset( $data['customer_note'] ) && true === $data['customer_note'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create the note&nbsp;</div></li><li><div>            $note_id = $order-&gt;add_order_note( $data['note'], $is_customer_note );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $note_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_order_note', __( 'Cannot create order note, please try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // HTTP 201 Created&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_order_note', $note_id, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_note( $order-&gt;get_id(), $note_id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit the order note&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id note ID&nbsp;</div></li><li><div>     * @param array $data parsed request data&nbsp;</div></li><li><div>     * @return WP_Error|array error or edited note response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order_note( $order_id, $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_note'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_note_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'order_note' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_note'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate note ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'Invalid order note ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is valid&nbsp;</div></li><li><div>            $note = get_comment( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $note ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'An order note with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is associated with given order&nbsp;</div></li><li><div>            if ( $note-&gt;comment_post_ID != $order-&gt;get_id() ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'The order note ID provided is not associated with the order', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_order_note_data', $data, $note-&gt;comment_ID, $order-&gt;get_id(), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Note content&nbsp;</div></li><li><div>            if ( isset( $data['note'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_update_comment(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'comment_ID' =&gt; $note-&gt;comment_ID, &nbsp;</div></li><li><div>                        'comment_content' =&gt; $data['note'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer note&nbsp;</div></li><li><div>            if ( isset( $data['customer_note'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_comment_meta( $note-&gt;comment_ID, 'is_customer_note', true === $data['customer_note'] ? 1 : 0 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_order_note', $note-&gt;comment_ID, $order-&gt;get_id(), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_note( $order-&gt;get_id(), $note-&gt;comment_ID );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete order note&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id note ID&nbsp;</div></li><li><div>     * @return WP_Error|array error or deleted message&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order_note( $order_id, $id ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate note ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'Invalid order note ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is valid&nbsp;</div></li><li><div>            $note = get_comment( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $note ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'An order note with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is associated with given order&nbsp;</div></li><li><div>            if ( $note-&gt;comment_post_ID != $order_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'The order note ID provided is not associated with the order', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Force delete since trashed order notes could not be managed through comments list table&nbsp;</div></li><li><div>            $result = wp_delete_comment( $note-&gt;comment_ID, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $result ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_order_note', __( 'This order note cannot be deleted', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_order_note', $note-&gt;comment_ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; __( 'Permanently deleted order note', 'woocommerce' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the order refunds for an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_refunds( $order_id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure ID is valid order ID&nbsp;</div></li><li><div>        $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>            return $order_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $refund_items = wc_get_orders( array(&nbsp;</div></li><li><div>            'type' =&gt; 'shop_order_refund', &nbsp;</div></li><li><div>            'parent' =&gt; $order_id, &nbsp;</div></li><li><div>            'limit' =&gt; -1, &nbsp;</div></li><li><div>            'return' =&gt; 'ids', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        $order_refunds = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $refund_items as $refund_id ) {&nbsp;</div></li><li><div>            $order_refunds[] = current( $this-&gt;get_order_refund( $order_id, $refund_id, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_refunds' =&gt; apply_filters( 'woocommerce_api_order_refunds_response', $order_refunds, $order_id, $fields, $refund_items, $this ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an order refund for the given order ID and ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_refund( $order_id, $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'Invalid order refund ID.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $refund = wc_get_order( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'An order refund with the provided ID could not be found.', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $line_items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add line items&nbsp;</div></li><li><div>            foreach ( $refund-&gt;get_items( 'line_item' ) as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>                $product = $item-&gt;get_product();&nbsp;</div></li><li><div>                $hideprefix = ( isset( $filter['all_item_meta'] ) && 'true' === $filter['all_item_meta'] ) ? null : '_';&nbsp;</div></li><li><div>                $item_meta = $item-&gt;get_formatted_meta_data( $hideprefix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $item_meta as $key =&gt; $values ) {&nbsp;</div></li><li><div>                    $item_meta[ $key ]-&gt;label = $values-&gt;display_key;&nbsp;</div></li><li><div>                    unset( $item_meta[ $key ]-&gt;display_key );&nbsp;</div></li><li><div>                    unset( $item_meta[ $key ]-&gt;display_value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $line_items[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $item_id, &nbsp;</div></li><li><div>                    'subtotal' =&gt; wc_format_decimal( $order-&gt;get_line_subtotal( $item ), 2 ), &nbsp;</div></li><li><div>                    'subtotal_tax' =&gt; wc_format_decimal( $item-&gt;get_subtotal_tax(), 2 ), &nbsp;</div></li><li><div>                    'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $item ), 2 ), &nbsp;</div></li><li><div>                    'total_tax' =&gt; wc_format_decimal( $order-&gt;get_line_tax( $item ), 2 ), &nbsp;</div></li><li><div>                    'price' =&gt; wc_format_decimal( $order-&gt;get_item_total( $item ), 2 ), &nbsp;</div></li><li><div>                    'quantity' =&gt; $item-&gt;get_quantity(), &nbsp;</div></li><li><div>                    'tax_class' =&gt; $item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                    'name' =&gt; $item-&gt;get_name(), &nbsp;</div></li><li><div>                    'product_id' =&gt; $item-&gt;get_variation_id() ? $item-&gt;get_variation_id() : $item-&gt;get_product_id(), &nbsp;</div></li><li><div>                    'sku' =&gt; is_object( $product ) ? $product-&gt;get_sku() : null, &nbsp;</div></li><li><div>                    'meta' =&gt; array_values( $item_meta ), &nbsp;</div></li><li><div>                    'refunded_item_id' =&gt; (int) $item-&gt;get_meta( 'refunded_item_id' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_refund = array(&nbsp;</div></li><li><div>                'id' =&gt; $refund-&gt;id, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $refund-&gt;get_date_created() ? $refund-&gt;get_date_created()-&gt;getTimestamp() : 0, false, false ), &nbsp;</div></li><li><div>                'amount' =&gt; wc_format_decimal( $refund-&gt;get_amount(), 2 ), &nbsp;</div></li><li><div>                'reason' =&gt; $refund-&gt;get_reason(), &nbsp;</div></li><li><div>                'line_items' =&gt; $line_items, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'order_refund' =&gt; apply_filters( 'woocommerce_api_order_refund_response', $order_refund, $id, $fields, $refund, $order_id, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new order refund for the given order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param array $data raw request data&nbsp;</div></li><li><div>     * @param bool $api_refund do refund using a payment gateway API&nbsp;</div></li><li><div>     * @return WP_Error|array error or created refund response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_order_refund( $order_id, $data, $api_refund = true ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_refund'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_refund_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'order_refund' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_refund'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permission check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_order_refund', __( 'You do not have permission to create order refunds', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_id = absint( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $order_id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_id', __( 'Order ID is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_order_refund_data', $data, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Refund amount is required&nbsp;</div></li><li><div>            if ( ! isset( $data['amount'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund', __( 'Refund amount is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            } elseif ( 0 &gt; $data['amount'] ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund', __( 'Refund amount must be positive.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data['order_id'] = $order_id;&nbsp;</div></li><li><div>            $data['refund_id'] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Create the refund&nbsp;</div></li><li><div>            $refund = wc_create_refund( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_order_refund', __( 'Cannot create order refund, please try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Refund via API&nbsp;</div></li><li><div>            if ( $api_refund ) {&nbsp;</div></li><li><div>                if ( WC()-&gt;payment_gateways() ) {&nbsp;</div></li><li><div>                    $payment_gateways = WC()-&gt;payment_gateways-&gt;payment_gateways();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $payment_gateways[ $order-&gt;get_payment_method() ] ) && $payment_gateways[ $order-&gt;get_payment_method() ]-&gt;supports( 'refunds' ) ) {&nbsp;</div></li><li><div>                    $result = $payment_gateways[ $order-&gt;get_payment_method() ]-&gt;process_refund( $order_id, $refund-&gt;get_amount(), $refund-&gt;get_reason() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                        return $result;&nbsp;</div></li><li><div>                    } elseif ( ! $result ) {&nbsp;</div></li><li><div>                        throw new WC_API_Exception( 'woocommerce_api_create_order_refund_api_failed', __( 'An error occurred while attempting to create the refund using the payment gateway API.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // HTTP 201 Created&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_order_refund', $refund-&gt;id, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_refund( $order_id, $refund-&gt;id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit an order refund&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id refund ID&nbsp;</div></li><li><div>     * @param array $data parsed request data&nbsp;</div></li><li><div>     * @return WP_Error|array error or edited refund response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order_refund( $order_id, $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_refund'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_refund_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'order_refund' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_refund'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate refund ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'Invalid order refund ID.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure order ID is valid&nbsp;</div></li><li><div>            $refund = get_post( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'An order refund with the provided ID could not be found.', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure refund ID is associated with given order&nbsp;</div></li><li><div>            if ( $refund-&gt;post_parent != $order_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'The order refund ID provided is not associated with the order.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_order_refund_data', $data, $refund-&gt;ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update reason&nbsp;</div></li><li><div>            if ( isset( $data['reason'] ) ) {&nbsp;</div></li><li><div>                $updated_refund = wp_update_post( array( 'ID' =&gt; $refund-&gt;ID, 'post_excerpt' =&gt; $data['reason'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_wp_error( $updated_refund ) ) {&nbsp;</div></li><li><div>                    return $updated_refund;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update refund amount&nbsp;</div></li><li><div>            if ( isset( $data['amount'] ) && 0 &lt; $data['amount'] ) {&nbsp;</div></li><li><div>                update_post_meta( $refund-&gt;ID, '_refund_amount', wc_format_decimal( $data['amount'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_order_refund', $refund-&gt;ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_refund( $order_id, $refund-&gt;ID );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete order refund&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id refund ID&nbsp;</div></li><li><div>     * @return WP_Error|array error or deleted message&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order_refund( $order_id, $id ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate refund ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'Invalid order refund ID.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure refund ID is valid&nbsp;</div></li><li><div>            $refund = get_post( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'An order refund with the provided ID could not be found.', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure refund ID is associated with given order&nbsp;</div></li><li><div>            if ( $refund-&gt;post_parent != $order_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'The order refund ID provided is not associated with the order.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_delete_shop_order_transients( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_order_refund', $refund-&gt;ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;delete( $refund-&gt;ID, 'refund', true );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk update or insert orders&nbsp;</div></li><li><div>     * Accepts an array with orders in the formats supported by&nbsp;</div></li><li><div>     * WC_API_Orders-&gt;create_order() and WC_API_Orders-&gt;edit_order()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function bulk( $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['orders'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_orders_data', sprintf( __( 'No %1$s data specified to create/edit %1$s', 'woocommerce' ), 'orders' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['orders'];&nbsp;</div></li><li><div>            $limit = apply_filters( 'woocommerce_api_bulk_limit', 100, 'orders' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Limit bulk operation&nbsp;</div></li><li><div>            if ( count( $data ) &gt; $limit ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_orders_request_entity_too_large', sprintf( __( 'Unable to accept more than %s items for this request.', 'woocommerce' ), $limit ), 413 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $orders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $data as $_order ) {&nbsp;</div></li><li><div>                $order_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Try to get the order ID&nbsp;</div></li><li><div>                if ( isset( $_order['id'] ) ) {&nbsp;</div></li><li><div>                    $order_id = intval( $_order['id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Order exists / edit order&nbsp;</div></li><li><div>                if ( $order_id ) {&nbsp;</div></li><li><div>                    $edit = $this-&gt;edit_order( $order_id, array( 'order' =&gt; $_order ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $edit ) ) {&nbsp;</div></li><li><div>                        $orders[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $order_id, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $edit-&gt;get_error_code(), 'message' =&gt; $edit-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $orders[] = $edit['order'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    // Order don't exists / create order&nbsp;</div></li><li><div>                    $new = $this-&gt;create_order( array( 'order' =&gt; $_order ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $new ) ) {&nbsp;</div></li><li><div>                        $orders[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $order_id, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $new-&gt;get_error_code(), 'message' =&gt; $new-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $orders[] = $new['order'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'orders' =&gt; apply_filters( 'woocommerce_api_orders_bulk_response', $orders, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.2/files/includes-api-legacy-v3-class-wc-api-orders/" class="file">/includes/api/legacy/v3/class-wc-api-orders.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="17" class="block" start="17"><li><div>class WC_API_Orders extends WC_API_Resource {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $base the route base */&nbsp;</div></li><li><div>    protected $base = '/orders';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /** @var string $post_type the custom post type */&nbsp;</div></li><li><div>    protected $post_type = 'shop_order';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Register the routes for this class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * GET|POST /orders&nbsp;</div></li><li><div>     * GET /orders/count&nbsp;</div></li><li><div>     * GET|PUT|DELETE /orders/&lt;id&gt;&nbsp;</div></li><li><div>     * GET /orders/&lt;id&gt;/notes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $routes&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function register_routes( $routes ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|POST /orders&nbsp;</div></li><li><div>        $routes[ $this-&gt;base ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_orders' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_order' ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders/count&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/count' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_orders_count' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET /orders/statuses&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/statuses' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_statuses' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT|DELETE /orders/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_order' ), WC_API_Server::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|POST /orders/&lt;id&gt;/notes&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/notes' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_notes' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_order_note' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT|DELETE /orders/&lt;order_id&gt;/notes/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/notes/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_note' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order_note' ), WC_API_SERVER::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_order_note' ), WC_API_SERVER::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|POST /orders/&lt;order_id&gt;/refunds&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/refunds' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_refunds' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'create_order_refund' ), WC_API_SERVER::CREATABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # GET|PUT|DELETE /orders/&lt;order_id&gt;/refunds/&lt;id&gt;&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/(?P&lt;order_id&gt;\d+)/refunds/(?P&lt;id&gt;\d+)' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'get_order_refund' ), WC_API_Server::READABLE ), &nbsp;</div></li><li><div>            array( array( $this, 'edit_order_refund' ), WC_API_SERVER::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div>            array( array( $this, 'delete_order_refund' ), WC_API_SERVER::DELETABLE ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        # POST|PUT /orders/bulk&nbsp;</div></li><li><div>        $routes[ $this-&gt;base . '/bulk' ] = array(&nbsp;</div></li><li><div>            array( array( $this, 'bulk' ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $routes;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get all orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $fields&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @param string $status&nbsp;</div></li><li><div>     * @param int $page&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_orders( $fields = null, $filter = array(), $status = null, $page = 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $status ) ) {&nbsp;</div></li><li><div>            $filter['status'] = $status;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $filter['page'] = $page;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $query-&gt;posts as $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $this-&gt;is_readable( $order_id ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $orders[] = current( $this-&gt;get_order( $order_id, $fields, $filter ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;server-&gt;add_pagination_headers( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'orders' =&gt; $orders );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the order for the given ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param int $id The order ID.&nbsp;</div></li><li><div>     * @param array $fields Request fields.&nbsp;</div></li><li><div>     * @param array $filter Request filters.&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order( $id, $fields = null, $filter = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure order ID is valid & user has permission to read.&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get the decimal precession.&nbsp;</div></li><li><div>        $dp = ( isset( $filter['dp'] ) ? intval( $filter['dp'] ) : 2 );&nbsp;</div></li><li><div>        $order = wc_get_order( $id );&nbsp;</div></li><li><div>        $expand = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $filter['expand'] ) ) {&nbsp;</div></li><li><div>            $expand = explode( ', ', $filter['expand'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_data = array(&nbsp;</div></li><li><div>            'id' =&gt; $order-&gt;get_id(), &nbsp;</div></li><li><div>            'order_number' =&gt; $order-&gt;get_order_number(), &nbsp;</div></li><li><div>            'order_key' =&gt; $order-&gt;get_order_key(), &nbsp;</div></li><li><div>            'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_created() ? $order-&gt;get_date_created()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'updated_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_modified() ? $order-&gt;get_date_modified()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'completed_at' =&gt; $this-&gt;server-&gt;format_datetime( $order-&gt;get_date_completed() ? $order-&gt;get_date_completed()-&gt;getTimestamp() : 0, false, false ), // API gives UTC times.&nbsp;</div></li><li><div>            'status' =&gt; $order-&gt;get_status(), &nbsp;</div></li><li><div>            'currency' =&gt; $order-&gt;get_currency(), &nbsp;</div></li><li><div>            'total' =&gt; wc_format_decimal( $order-&gt;get_total(), $dp ), &nbsp;</div></li><li><div>            'subtotal' =&gt; wc_format_decimal( $order-&gt;get_subtotal(), $dp ), &nbsp;</div></li><li><div>            'total_line_items_quantity' =&gt; $order-&gt;get_item_count(), &nbsp;</div></li><li><div>            'total_tax' =&gt; wc_format_decimal( $order-&gt;get_total_tax(), $dp ), &nbsp;</div></li><li><div>            'total_shipping' =&gt; wc_format_decimal( $order-&gt;get_shipping_total(), $dp ), &nbsp;</div></li><li><div>            'cart_tax' =&gt; wc_format_decimal( $order-&gt;get_cart_tax(), $dp ), &nbsp;</div></li><li><div>            'shipping_tax' =&gt; wc_format_decimal( $order-&gt;get_shipping_tax(), $dp ), &nbsp;</div></li><li><div>            'total_discount' =&gt; wc_format_decimal( $order-&gt;get_total_discount(), $dp ), &nbsp;</div></li><li><div>            'shipping_methods' =&gt; $order-&gt;get_shipping_method(), &nbsp;</div></li><li><div>            'payment_details' =&gt; array(&nbsp;</div></li><li><div>                'method_id' =&gt; $order-&gt;get_payment_method(), &nbsp;</div></li><li><div>                'method_title' =&gt; $order-&gt;get_payment_method_title(), &nbsp;</div></li><li><div>                'paid' =&gt; ! is_null( $order-&gt;get_date_paid() ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'billing_address' =&gt; array(&nbsp;</div></li><li><div>                'first_name' =&gt; $order-&gt;get_billing_first_name(), &nbsp;</div></li><li><div>                'last_name' =&gt; $order-&gt;get_billing_last_name(), &nbsp;</div></li><li><div>                'company' =&gt; $order-&gt;get_billing_company(), &nbsp;</div></li><li><div>                'address_1' =&gt; $order-&gt;get_billing_address_1(), &nbsp;</div></li><li><div>                'address_2' =&gt; $order-&gt;get_billing_address_2(), &nbsp;</div></li><li><div>                'city' =&gt; $order-&gt;get_billing_city(), &nbsp;</div></li><li><div>                'state' =&gt; $order-&gt;get_billing_state(), &nbsp;</div></li><li><div>                'postcode' =&gt; $order-&gt;get_billing_postcode(), &nbsp;</div></li><li><div>                'country' =&gt; $order-&gt;get_billing_country(), &nbsp;</div></li><li><div>                'email' =&gt; $order-&gt;get_billing_email(), &nbsp;</div></li><li><div>                'phone' =&gt; $order-&gt;get_billing_phone(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'shipping_address' =&gt; array(&nbsp;</div></li><li><div>                'first_name' =&gt; $order-&gt;get_shipping_first_name(), &nbsp;</div></li><li><div>                'last_name' =&gt; $order-&gt;get_shipping_last_name(), &nbsp;</div></li><li><div>                'company' =&gt; $order-&gt;get_shipping_company(), &nbsp;</div></li><li><div>                'address_1' =&gt; $order-&gt;get_shipping_address_1(), &nbsp;</div></li><li><div>                'address_2' =&gt; $order-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div>                'city' =&gt; $order-&gt;get_shipping_city(), &nbsp;</div></li><li><div>                'state' =&gt; $order-&gt;get_shipping_state(), &nbsp;</div></li><li><div>                'postcode' =&gt; $order-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>                'country' =&gt; $order-&gt;get_shipping_country(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'note' =&gt; $order-&gt;get_customer_note(), &nbsp;</div></li><li><div>            'customer_ip' =&gt; $order-&gt;get_customer_ip_address(), &nbsp;</div></li><li><div>            'customer_user_agent' =&gt; $order-&gt;get_customer_user_agent(), &nbsp;</div></li><li><div>            'customer_id' =&gt; $order-&gt;get_user_id(), &nbsp;</div></li><li><div>            'view_order_url' =&gt; $order-&gt;get_view_order_url(), &nbsp;</div></li><li><div>            'line_items' =&gt; array(), &nbsp;</div></li><li><div>            'shipping_lines' =&gt; array(), &nbsp;</div></li><li><div>            'tax_lines' =&gt; array(), &nbsp;</div></li><li><div>            'fee_lines' =&gt; array(), &nbsp;</div></li><li><div>            'coupon_lines' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add line items.&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items() as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>            $product = $item-&gt;get_product();&nbsp;</div></li><li><div>            $hideprefix = ( isset( $filter['all_item_meta'] ) && 'true' === $filter['all_item_meta'] ) ? null : '_';&nbsp;</div></li><li><div>            $item_meta = $item-&gt;get_formatted_meta_data( $hideprefix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $item_meta as $key =&gt; $values ) {&nbsp;</div></li><li><div>                $item_meta[ $key ]-&gt;label = $values-&gt;display_key;&nbsp;</div></li><li><div>                unset( $item_meta[ $key ]-&gt;display_key );&nbsp;</div></li><li><div>                unset( $item_meta[ $key ]-&gt;display_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $line_item = array(&nbsp;</div></li><li><div>                'id' =&gt; $item_id, &nbsp;</div></li><li><div>                'subtotal' =&gt; wc_format_decimal( $order-&gt;get_line_subtotal( $item, false, false ), $dp ), &nbsp;</div></li><li><div>                'subtotal_tax' =&gt; wc_format_decimal( $item-&gt;get_subtotal_tax(), $dp ), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $item, false, false ), $dp ), &nbsp;</div></li><li><div>                'total_tax' =&gt; wc_format_decimal( $item-&gt;get_total_tax(), $dp ), &nbsp;</div></li><li><div>                'price' =&gt; wc_format_decimal( $order-&gt;get_item_total( $item, false, false ), $dp ), &nbsp;</div></li><li><div>                'quantity' =&gt; $item-&gt;get_quantity(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'name' =&gt; $item-&gt;get_name(), &nbsp;</div></li><li><div>                'product_id' =&gt; $item-&gt;get_variation_id() ? $item-&gt;get_variation_id() : $item-&gt;get_product_id(), &nbsp;</div></li><li><div>                'sku' =&gt; is_object( $product ) ? $product-&gt;get_sku() : null, &nbsp;</div></li><li><div>                'meta' =&gt; array_values( $item_meta ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array( 'products', $expand ) ) {&nbsp;</div></li><li><div>                $_product_data = WC()-&gt;api-&gt;WC_API_Products-&gt;get_product( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $_product_data['product'] ) ) {&nbsp;</div></li><li><div>                    $line_item['product_data'] = $_product_data['product'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_data['line_items'][] = $line_item;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add shipping.&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_shipping_methods() as $shipping_item_id =&gt; $shipping_item ) {&nbsp;</div></li><li><div>            $order_data['shipping_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $shipping_item_id, &nbsp;</div></li><li><div>                'method_id' =&gt; $shipping_item-&gt;get_method_id(), &nbsp;</div></li><li><div>                'method_title' =&gt; $shipping_item-&gt;get_name(), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $shipping_item-&gt;get_total(), $dp ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add taxes.&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_tax_totals() as $tax_code =&gt; $tax ) {&nbsp;</div></li><li><div>            $tax_line = array(&nbsp;</div></li><li><div>                'id' =&gt; $tax-&gt;id, &nbsp;</div></li><li><div>                'rate_id' =&gt; $tax-&gt;rate_id, &nbsp;</div></li><li><div>                'code' =&gt; $tax_code, &nbsp;</div></li><li><div>                'title' =&gt; $tax-&gt;label, &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $tax-&gt;amount, $dp ), &nbsp;</div></li><li><div>                'compound' =&gt; (bool) $tax-&gt;is_compound, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array( 'taxes', $expand ) ) {&nbsp;</div></li><li><div>                $_rate_data = WC()-&gt;api-&gt;WC_API_Taxes-&gt;get_tax( $tax-&gt;rate_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $_rate_data['tax'] ) ) {&nbsp;</div></li><li><div>                    $tax_line['rate_data'] = $_rate_data['tax'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_data['tax_lines'][] = $tax_line;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add fees.&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_fees() as $fee_item_id =&gt; $fee_item ) {&nbsp;</div></li><li><div>            $order_data['fee_lines'][] = array(&nbsp;</div></li><li><div>                'id' =&gt; $fee_item_id, &nbsp;</div></li><li><div>                'title' =&gt; $fee_item-&gt;get_name(), &nbsp;</div></li><li><div>                'tax_class' =&gt; $fee_item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $fee_item ), $dp ), &nbsp;</div></li><li><div>                'total_tax' =&gt; wc_format_decimal( $order-&gt;get_line_tax( $fee_item ), $dp ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Add coupons.&nbsp;</div></li><li><div>        foreach ( $order-&gt;get_items( 'coupon' ) as $coupon_item_id =&gt; $coupon_item ) {&nbsp;</div></li><li><div>            $coupon_line = array(&nbsp;</div></li><li><div>                'id' =&gt; $coupon_item_id, &nbsp;</div></li><li><div>                'code' =&gt; $coupon_item-&gt;get_code(), &nbsp;</div></li><li><div>                'amount' =&gt; wc_format_decimal( $coupon_item-&gt;get_discount(), $dp ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array( 'coupons', $expand ) ) {&nbsp;</div></li><li><div>                $_coupon_data = WC()-&gt;api-&gt;WC_API_Coupons-&gt;get_coupon_by_code( $coupon_item-&gt;get_code() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! is_wp_error( $_coupon_data ) && isset( $_coupon_data['coupon'] ) ) {&nbsp;</div></li><li><div>                    $coupon_line['coupon_data'] = $_coupon_data['coupon'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_data['coupon_lines'][] = $coupon_line;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order' =&gt; apply_filters( 'woocommerce_api_order_response', $order_data, $order, $fields, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the total number of orders&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @param string $status&nbsp;</div></li><li><div>     * @param array $filter&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_orders_count( $status = null, $filter = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! current_user_can( 'read_private_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_read_orders_count', __( 'You do not have permission to read the orders count', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $status ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( 'any' === $status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $order_statuses = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( wc_get_order_statuses() as $slug =&gt; $name ) {&nbsp;</div></li><li><div>                        $filter['status'] = str_replace( 'wc-', '', $slug );&nbsp;</div></li><li><div>                        $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>                        $order_statuses[ str_replace( 'wc-', '', $slug ) ] = (int) $query-&gt;found_posts;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    return array( 'count' =&gt; $order_statuses );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $filter['status'] = $status;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query = $this-&gt;query_orders( $filter );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'count' =&gt; (int) $query-&gt;found_posts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a list of valid order statuses&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Note this requires no specific permissions other than being an authenticated&nbsp;</div></li><li><div>     * API user. Order statuses (particularly custom statuses) could be considered&nbsp;</div></li><li><div>     * private information which is why it's not in the API index.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_statuses() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_statuses = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( wc_get_order_statuses() as $slug =&gt; $name ) {&nbsp;</div></li><li><div>            $order_statuses[ str_replace( 'wc-', '', $slug ) ] = $name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_statuses' =&gt; apply_filters( 'woocommerce_api_order_statuses_response', $order_statuses, $this ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $data raw order data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_order( $data ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_transaction_query( 'start' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'order' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // permission check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_order', __( 'You do not have permission to create orders', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_order_data', $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // default order args, note that status is checked for validity in wc_create_order()&nbsp;</div></li><li><div>            $default_order_args = array(&nbsp;</div></li><li><div>                'status' =&gt; isset( $data['status'] ) ? $data['status'] : '', &nbsp;</div></li><li><div>                'customer_note' =&gt; isset( $data['note'] ) ? $data['note'] : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if creating order for existing customer&nbsp;</div></li><li><div>            if ( ! empty( $data['customer_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // make sure customer exists&nbsp;</div></li><li><div>                if ( false === get_user_by( 'id', $data['customer_id'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_customer_id', __( 'Customer ID is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $default_order_args['customer_id'] = $data['customer_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create the pending order&nbsp;</div></li><li><div>            $order = $this-&gt;create_base_order( $default_order_args, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_order', sprintf( __( 'Cannot create order: %s', 'woocommerce' ), implode( ', ', $order-&gt;get_error_messages() ) ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // billing/shipping addresses&nbsp;</div></li><li><div>            $this-&gt;set_order_addresses( $order, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $lines = array(&nbsp;</div></li><li><div>                'line_item' =&gt; 'line_items', &nbsp;</div></li><li><div>                'shipping' =&gt; 'shipping_lines', &nbsp;</div></li><li><div>                'fee' =&gt; 'fee_lines', &nbsp;</div></li><li><div>                'coupon' =&gt; 'coupon_lines', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $lines as $line_type =&gt; $line ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data[ $line ] ) && is_array( $data[ $line ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $set_item = &quot;set_{$line_type}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $data[ $line ] as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $this-&gt;$set_item( $order, $item, 'create' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set is vat exempt&nbsp;</div></li><li><div>            if ( isset( $data['is_vat_exempt'] ) ) {&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_is_vat_exempt', $data['is_vat_exempt'] ? 'yes' : 'no' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // calculate totals and set them&nbsp;</div></li><li><div>            $order-&gt;calculate_totals();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // payment method (and payment_complete() if `paid` == true)&nbsp;</div></li><li><div>            if ( isset( $data['payment_details'] ) && is_array( $data['payment_details'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // method ID & title are required&nbsp;</div></li><li><div>                if ( empty( $data['payment_details']['method_id'] ) || empty( $data['payment_details']['method_title'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_payment_details', __( 'Payment method ID and title are required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_payment_method', $data['payment_details']['method_id'] );&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_payment_method_title', $data['payment_details']['method_title'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // mark as paid if set&nbsp;</div></li><li><div>                if ( isset( $data['payment_details']['paid'] ) && true === $data['payment_details']['paid'] ) {&nbsp;</div></li><li><div>                    $order-&gt;payment_complete( isset( $data['payment_details']['transaction_id'] ) ? $data['payment_details']['transaction_id'] : '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set order currency&nbsp;</div></li><li><div>            if ( isset( $data['currency'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! array_key_exists( $data['currency'], get_woocommerce_currencies() ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_order_currency', __( 'Provided order currency is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_order_currency', $data['currency'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // set order meta&nbsp;</div></li><li><div>            if ( isset( $data['order_meta'] ) && is_array( $data['order_meta'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;set_order_meta( $order-&gt;get_id(), $data['order_meta'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // HTTP 201 Created&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_delete_shop_order_transients( $order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_order', $order-&gt;get_id(), $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_transaction_query( 'commit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order( $order-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            wc_transaction_query( 'rollback' );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            wc_transaction_query( 'rollback' );&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Creates new WC_Order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Requires a separate function for classes that extend WC_API_Orders.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.3&nbsp;</div></li><li><div>     * @param $args array&nbsp;</div></li><li><div>     * @return WC_Order&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function create_base_order( $args, $data ) {&nbsp;</div></li><li><div>        return wc_create_order( $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order( $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'order' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update_totals = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = $this-&gt;validate_request( $id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>                return $id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_order_data', $data, $id, $this );&nbsp;</div></li><li><div>            $order = wc_get_order( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $order ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_id', __( 'Order ID is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_args = array( 'order_id' =&gt; $order-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer note.&nbsp;</div></li><li><div>            if ( isset( $data['note'] ) ) {&nbsp;</div></li><li><div>                $order_args['customer_note'] = $data['note'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer ID.&nbsp;</div></li><li><div>            if ( isset( $data['customer_id'] ) && $data['customer_id'] != $order-&gt;get_user_id() ) {&nbsp;</div></li><li><div>                // Make sure customer exists.&nbsp;</div></li><li><div>                if ( false === get_user_by( 'id', $data['customer_id'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_customer_id', __( 'Customer ID is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_customer_user', $data['customer_id'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Billing/shipping address.&nbsp;</div></li><li><div>            $this-&gt;set_order_addresses( $order, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $lines = array(&nbsp;</div></li><li><div>                'line_item' =&gt; 'line_items', &nbsp;</div></li><li><div>                'shipping' =&gt; 'shipping_lines', &nbsp;</div></li><li><div>                'fee' =&gt; 'fee_lines', &nbsp;</div></li><li><div>                'coupon' =&gt; 'coupon_lines', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $lines as $line_type =&gt; $line ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data[ $line ] ) && is_array( $data[ $line ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $update_totals = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $data[ $line ] as $item ) {&nbsp;</div></li><li><div>                        // Item ID is always required.&nbsp;</div></li><li><div>                        if ( ! array_key_exists( 'id', $item ) ) {&nbsp;</div></li><li><div>                            $item['id'] = null;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Create item.&nbsp;</div></li><li><div>                        if ( is_null( $item['id'] ) ) {&nbsp;</div></li><li><div>                            $this-&gt;set_item( $order, $line_type, $item, 'create' );&nbsp;</div></li><li><div>                        } elseif ( $this-&gt;item_is_null( $item ) ) {&nbsp;</div></li><li><div>                            // Delete item.&nbsp;</div></li><li><div>                            wc_delete_order_item( $item['id'] );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            // Update item.&nbsp;</div></li><li><div>                            $this-&gt;set_item( $order, $line_type, $item, 'update' );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Payment method (and payment_complete() if `paid` == true and order needs payment).&nbsp;</div></li><li><div>            if ( isset( $data['payment_details'] ) && is_array( $data['payment_details'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Method ID.&nbsp;</div></li><li><div>                if ( isset( $data['payment_details']['method_id'] ) ) {&nbsp;</div></li><li><div>                    update_post_meta( $order-&gt;get_id(), '_payment_method', $data['payment_details']['method_id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Method title.&nbsp;</div></li><li><div>                if ( isset( $data['payment_details']['method_title'] ) ) {&nbsp;</div></li><li><div>                    update_post_meta( $order-&gt;get_id(), '_payment_method_title', $data['payment_details']['method_title'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Mark as paid if set.&nbsp;</div></li><li><div>                if ( $order-&gt;needs_payment() && isset( $data['payment_details']['paid'] ) && true === $data['payment_details']['paid'] ) {&nbsp;</div></li><li><div>                    $order-&gt;payment_complete( isset( $data['payment_details']['transaction_id'] ) ? $data['payment_details']['transaction_id'] : '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Set order currency.&nbsp;</div></li><li><div>            if ( isset( $data['currency'] ) ) {&nbsp;</div></li><li><div>                if ( ! array_key_exists( $data['currency'], get_woocommerce_currencies() ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_order_currency', __( 'Provided order currency is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_post_meta( $order-&gt;get_id(), '_order_currency', $data['currency'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If items have changed, recalculate order totals.&nbsp;</div></li><li><div>            if ( $update_totals ) {&nbsp;</div></li><li><div>                $order-&gt;calculate_totals();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update order meta.&nbsp;</div></li><li><div>            if ( isset( $data['order_meta'] ) && is_array( $data['order_meta'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;set_order_meta( $order-&gt;get_id(), $data['order_meta'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update the order post to set customer note/modified date.&nbsp;</div></li><li><div>            wc_update_order( $order_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Order status.&nbsp;</div></li><li><div>            if ( ! empty( $data['status'] ) ) {&nbsp;</div></li><li><div>                $order-&gt;update_status( $data['status'], isset( $data['status_note'] ) ? $data['status_note'] : '', true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_delete_shop_order_transients( $order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_order', $order-&gt;get_id(), $data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order( $id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $id the order ID&nbsp;</div></li><li><div>     * @param bool $force true to permanently delete order, false to move to trash&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order( $id, $force = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $this-&gt;validate_request( $id, $this-&gt;post_type, 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            return $id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_delete_shop_order_transients( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_api_delete_order', $id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;delete( $id, 'order', ( 'true' === $force ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to get order post objects&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param array $args request arguments for filtering query&nbsp;</div></li><li><div>     * @return WP_Query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function query_orders( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // set base query arguments&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_type' =&gt; $this-&gt;post_type, &nbsp;</div></li><li><div>            'post_status' =&gt; array_keys( wc_get_order_statuses() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add status argument&nbsp;</div></li><li><div>        if ( ! empty( $args['status'] ) ) {&nbsp;</div></li><li><div>            $statuses = 'wc-' . str_replace( ', ', ', wc-', $args['status'] );&nbsp;</div></li><li><div>            $statuses = explode( ', ', $statuses );&nbsp;</div></li><li><div>            $query_args['post_status'] = $statuses;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $args['status'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['customer_id'] ) ) {&nbsp;</div></li><li><div>            $query_args['meta_query'] = array(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'key' =&gt; '_customer_user', &nbsp;</div></li><li><div>                    'value' =&gt; absint( $args['customer_id'] ), &nbsp;</div></li><li><div>                    'compare' =&gt; '=', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_args = $this-&gt;merge_query_args( $query_args, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return new WP_Query( $query_args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to set/update the billing & shipping addresses for&nbsp;</div></li><li><div>     * an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_order_addresses( $order, $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $address_fields = array(&nbsp;</div></li><li><div>            'first_name', &nbsp;</div></li><li><div>            'last_name', &nbsp;</div></li><li><div>            'company', &nbsp;</div></li><li><div>            'email', &nbsp;</div></li><li><div>            'phone', &nbsp;</div></li><li><div>            'address_1', &nbsp;</div></li><li><div>            'address_2', &nbsp;</div></li><li><div>            'city', &nbsp;</div></li><li><div>            'state', &nbsp;</div></li><li><div>            'postcode', &nbsp;</div></li><li><div>            'country', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $billing_address = $shipping_address = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // billing address&nbsp;</div></li><li><div>        if ( isset( $data['billing_address'] ) && is_array( $data['billing_address'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $address_fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data['billing_address'][ $field ] ) ) {&nbsp;</div></li><li><div>                    $billing_address[ $field ] = wc_clean( $data['billing_address'][ $field ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            unset( $address_fields['email'] );&nbsp;</div></li><li><div>            unset( $address_fields['phone'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // shipping address&nbsp;</div></li><li><div>        if ( isset( $data['shipping_address'] ) && is_array( $data['shipping_address'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $address_fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data['shipping_address'][ $field ] ) ) {&nbsp;</div></li><li><div>                    $shipping_address[ $field ] = wc_clean( $data['shipping_address'][ $field ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;update_address( $order, $billing_address, 'billing' );&nbsp;</div></li><li><div>        $this-&gt;update_address( $order, $shipping_address, 'shipping' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update user meta&nbsp;</div></li><li><div>        if ( $order-&gt;get_user_id() ) {&nbsp;</div></li><li><div>            foreach ( $billing_address as $key =&gt; $value ) {&nbsp;</div></li><li><div>                update_user_meta( $order-&gt;get_user_id(), 'billing_' . $key, $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( $shipping_address as $key =&gt; $value ) {&nbsp;</div></li><li><div>                update_user_meta( $order-&gt;get_user_id(), 'shipping_' . $key, $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update address.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Order $order&nbsp;</div></li><li><div>     * @param array $posted&nbsp;</div></li><li><div>     * @param string $type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_address( $order, $posted, $type = 'billing' ) {&nbsp;</div></li><li><div>        foreach ( $posted as $key =&gt; $value ) {&nbsp;</div></li><li><div>            if ( is_callable( array( $order, &quot;set_{$type}_{$key}&quot; ) ) ) {&nbsp;</div></li><li><div>                $order-&gt;{&quot;set_{$type}_{$key}&quot;}( $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to add/update order meta, with two restrictions:&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * 1) Only non-protected meta (no leading underscore) can be set&nbsp;</div></li><li><div>     * 2) Meta values must be scalar (int, string, bool)&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param int $order_id valid order ID&nbsp;</div></li><li><div>     * @param array $order_meta order meta in array( 'meta_key' =&gt; 'meta_value' ) format&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_order_meta( $order_id, $order_meta ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $order_meta as $meta_key =&gt; $meta_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_string( $meta_key ) && ! is_protected_meta( $meta_key ) && is_scalar( $meta_value ) ) {&nbsp;</div></li><li><div>                update_post_meta( $order_id, $meta_key, $meta_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method to check if the resource ID associated with the provided item is null&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Items can be deleted by setting the resource ID to null&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param array $item item provided in the request body&nbsp;</div></li><li><div>     * @return bool true if the item resource ID is null, false otherwise&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function item_is_null( $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $keys = array( 'product_id', 'method_id', 'title', 'code' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $keys as $key ) {&nbsp;</div></li><li><div>            if ( array_key_exists( $key, $item ) && is_null( $item[ $key ] ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Wrapper method to create/update order items&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * When updating, the item ID provided is checked to ensure it is associated&nbsp;</div></li><li><div>     * with the order.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order order&nbsp;</div></li><li><div>     * @param string $item_type&nbsp;</div></li><li><div>     * @param array $item item provided in the request body&nbsp;</div></li><li><div>     * @param string $action either 'create' or 'update'&nbsp;</div></li><li><div>     * @throws WC_API_Exception if item ID is not associated with order&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_item( $order, $item_type, $item, $action ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $set_method = &quot;set_{$item_type}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // verify provided line item ID is associated with order&nbsp;</div></li><li><div>        if ( 'update' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $wpdb-&gt;get_row(&nbsp;</div></li><li><div>                $wpdb-&gt;prepare( &quot;SELECT * FROM {$wpdb-&gt;prefix}woocommerce_order_items WHERE order_item_id = %d AND order_id = %d&quot;, &nbsp;</div></li><li><div>                absint( $item['id'] ), &nbsp;</div></li><li><div>                absint( $order-&gt;get_id() )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $result ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_item_id', __( 'Order item ID provided is not associated with order.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;$set_method( $order, $item, $action );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update a line item&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $item line item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add line item or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_line_item( $order, $item, $action ) {&nbsp;</div></li><li><div>        $creating = ( 'create' === $action );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // product is always required&nbsp;</div></li><li><div>        if ( ! isset( $item['product_id'] ) && ! isset( $item['sku'] ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_id', __( 'Product ID or SKU is required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // when updating, ensure product ID provided matches&nbsp;</div></li><li><div>        if ( 'update' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item_product_id = wc_get_order_item_meta( $item['id'], '_product_id' );&nbsp;</div></li><li><div>            $item_variation_id = wc_get_order_item_meta( $item['id'], '_variation_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $item['product_id'] != $item_product_id && $item['product_id'] != $item_variation_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_product_id', __( 'Product ID provided does not match this line item', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $item['product_id'] ) ) {&nbsp;</div></li><li><div>            $product_id = $item['product_id'];&nbsp;</div></li><li><div>        } elseif ( isset( $item['sku'] ) ) {&nbsp;</div></li><li><div>            $product_id = wc_get_product_id_by_sku( $item['sku'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // variations must each have a key & value&nbsp;</div></li><li><div>        $variation_id = 0;&nbsp;</div></li><li><div>        if ( isset( $item['variations'] ) && is_array( $item['variations'] ) ) {&nbsp;</div></li><li><div>            foreach ( $item['variations'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>                if ( ! $key || ! $value ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_api_invalid_product_variation', __( 'The product variation is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation_id = $this-&gt;get_variation_id( wc_get_product( $product_id ), $item['variations'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = wc_get_product( $variation_id ? $variation_id : $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // must be a valid WC_Product&nbsp;</div></li><li><div>        if ( ! is_object( $product ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product', __( 'Product is invalid.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // quantity must be positive float&nbsp;</div></li><li><div>        if ( isset( $item['quantity'] ) && floatval( $item['quantity'] ) &lt;= 0 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_quantity', __( 'Product quantity must be a positive float.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // quantity is required when creating&nbsp;</div></li><li><div>        if ( $creating && ! isset( $item['quantity'] ) ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_api_invalid_product_quantity', __( 'Product quantity is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // quantity&nbsp;</div></li><li><div>        if ( $creating ) {&nbsp;</div></li><li><div>            $line_item = new WC_Order_Item_Product();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $line_item = new WC_Order_Item_Product( $item['id'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $line_item-&gt;set_product( $product );&nbsp;</div></li><li><div>        $line_item-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $item['quantity'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_quantity( $item['quantity'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['total'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_total( floatval( $item['total'] ) );&nbsp;</div></li><li><div>        } elseif ( $creating ) {&nbsp;</div></li><li><div>            $total = wc_get_price_excluding_tax( $product, array( 'qty' =&gt; $line_item-&gt;get_quantity() ) );&nbsp;</div></li><li><div>            $line_item-&gt;set_total( $total );&nbsp;</div></li><li><div>            $line_item-&gt;set_subtotal( $total );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['total_tax'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_total_tax( floatval( $item['total_tax'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['subtotal'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_subtotal( floatval( $item['subtotal'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $item['subtotal_tax'] ) ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_subtotal_tax( floatval( $item['subtotal_tax'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $variation_id ) {&nbsp;</div></li><li><div>            $line_item-&gt;set_variation_id( $variation_id );&nbsp;</div></li><li><div>            $line_item-&gt;set_variation( $item['variations'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $item_id = $line_item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $item_id ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_cannot_create_line_item', __( 'Cannot create line item, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Given a product ID & API provided variations, find the correct variation ID to use for calculation&nbsp;</div></li><li><div>     * We can't just trust input from the API to pass a variation_id manually, otherwise you could pass&nbsp;</div></li><li><div>     * the cheapest variation ID but provide other information so we have to look up the variation ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  WC_Product $product Product instance&nbsp;</div></li><li><div>     * @return int                 Returns an ID if a valid variation was found for this product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_variation_id( $product, $variations = array() ) {&nbsp;</div></li><li><div>        $variation_id = null;&nbsp;</div></li><li><div>        $variations_normalized = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product-&gt;is_type( 'variable' ) && $product-&gt;has_child() ) {&nbsp;</div></li><li><div>            if ( isset( $variations ) && is_array( $variations ) ) {&nbsp;</div></li><li><div>                // start by normalizing the passed variations&nbsp;</div></li><li><div>                foreach ( $variations as $key =&gt; $value ) {&nbsp;</div></li><li><div>                    $key = str_replace( 'attribute_', '', str_replace( 'pa_', '', $key ) ); // from get_attributes in class-wc-api-products.php&nbsp;</div></li><li><div>                    $variations_normalized[ $key ] = strtolower( $value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                // now search through each product child and see if our passed variations match anything&nbsp;</div></li><li><div>                foreach ( $product-&gt;get_children() as $variation ) {&nbsp;</div></li><li><div>                    $meta = array();&nbsp;</div></li><li><div>                    foreach ( get_post_meta( $variation ) as $key =&gt; $value ) {&nbsp;</div></li><li><div>                        $value = $value[0];&nbsp;</div></li><li><div>                        $key = str_replace( 'attribute_', '', str_replace( 'pa_', '', $key ) );&nbsp;</div></li><li><div>                        $meta[ $key ] = strtolower( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    // if the variation array is a part of the $meta array, we found our match&nbsp;</div></li><li><div>                    if ( $this-&gt;array_contains( $variations_normalized, $meta ) ) {&nbsp;</div></li><li><div>                        $variation_id = $variation;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $variation_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Utility function to see if the meta array contains data from variations&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function array_contains( $needles, $haystack ) {&nbsp;</div></li><li><div>        foreach ( $needles as $key =&gt; $value ) {&nbsp;</div></li><li><div>            if ( $haystack[ $key ] !== $value ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update an order shipping method&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $shipping item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add shipping or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_shipping( $order, $shipping, $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // total must be a positive float&nbsp;</div></li><li><div>        if ( isset( $shipping['total'] ) && floatval( $shipping['total'] ) &lt; 0 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_invalid_shipping_total', __( 'Shipping total must be a positive amount.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'create' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // method ID is required&nbsp;</div></li><li><div>            if ( ! isset( $shipping['method_id'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_shipping_item', __( 'Shipping method ID is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $rate = new WC_Shipping_Rate( $shipping['method_id'], isset( $shipping['method_title'] ) ? $shipping['method_title'] : '', isset( $shipping['total'] ) ? floatval( $shipping['total'] ) : 0, array(), $shipping['method_id'] );&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Shipping();&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>            $item-&gt;set_shipping_rate( $rate );&nbsp;</div></li><li><div>            $shipping_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $shipping_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_create_shipping', __( 'Cannot create shipping method, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Shipping( $shipping['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $shipping['method_id'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_method_id( $shipping['method_id'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $shipping['method_title'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_method_title( $shipping['method_title'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $shipping['total'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_total( floatval( $shipping['total'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $shipping_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $shipping_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_update_shipping', __( 'Cannot update shipping method, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update an order fee&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $fee item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add fee or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_fee( $order, $fee, $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'create' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // fee title is required&nbsp;</div></li><li><div>            if ( ! isset( $fee['title'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_fee_item', __( 'Fee title is required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Fee();&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>            $item-&gt;set_name( wc_clean( $fee['title'] ) );&nbsp;</div></li><li><div>            $item-&gt;set_total( isset( $fee['total'] ) ? floatval( $fee['total'] ) : 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if taxable, tax class and total are required&nbsp;</div></li><li><div>            if ( ! empty( $fee['taxable'] ) ) {&nbsp;</div></li><li><div>                if ( ! isset( $fee['tax_class'] ) ) {&nbsp;</div></li><li><div>                    throw new WC_API_Exception( 'woocommerce_invalid_fee_item', __( 'Fee tax class is required when fee is taxable.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $item-&gt;set_tax_status( 'taxable' );&nbsp;</div></li><li><div>                $item-&gt;set_tax_class( $fee['tax_class'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $fee['total_tax'] ) ) {&nbsp;</div></li><li><div>                    $item-&gt;set_total_tax( isset( $fee['total_tax'] ) ? wc_format_refund_total( $fee['total_tax'] ) : 0 );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $fee['tax_data'] ) ) {&nbsp;</div></li><li><div>                    $item-&gt;set_total_tax( wc_format_refund_total( array_sum( $fee['tax_data'] ) ) );&nbsp;</div></li><li><div>                    $item-&gt;set_taxes( array_map( 'wc_format_refund_total', $fee['tax_data'] ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fee_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $fee_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_create_fee', __( 'Cannot create fee, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Fee( $fee['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['title'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_name( wc_clean( $fee['title'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['tax_class'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_tax_class( $fee['tax_class'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['total'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_total( floatval( $fee['total'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $fee['total_tax'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_total_tax( floatval( $fee['total_tax'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $fee_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $fee_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_update_fee', __( 'Cannot update fee, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create or update an order coupon&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param \WC_Order $order&nbsp;</div></li><li><div>     * @param array $coupon item data&nbsp;</div></li><li><div>     * @param string $action 'create' to add coupon or 'update' to update it&nbsp;</div></li><li><div>     * @throws WC_API_Exception invalid data, server error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function set_coupon( $order, $coupon, $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // coupon amount must be positive float&nbsp;</div></li><li><div>        if ( isset( $coupon['amount'] ) && floatval( $coupon['amount'] ) &lt; 0 ) {&nbsp;</div></li><li><div>            throw new WC_API_Exception( 'woocommerce_invalid_coupon_total', __( 'Coupon discount total must be a positive amount.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'create' === $action ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // coupon code is required&nbsp;</div></li><li><div>            if ( empty( $coupon['code'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_invalid_coupon_coupon', __( 'Coupon code is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Coupon();&nbsp;</div></li><li><div>            $item-&gt;set_props( array(&nbsp;</div></li><li><div>                'code' =&gt; $coupon['code'], &nbsp;</div></li><li><div>                'discount' =&gt; isset( $coupon['amount'] ) ? floatval( $coupon['amount'] ) : 0, &nbsp;</div></li><li><div>                'discount_tax' =&gt; 0, &nbsp;</div></li><li><div>                'order_id' =&gt; $order-&gt;get_id(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            $coupon_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $coupon_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_create_order_coupon', __( 'Cannot create coupon, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Coupon( $coupon['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $coupon['code'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_code( $coupon['code'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $coupon['amount'] ) ) {&nbsp;</div></li><li><div>                $item-&gt;set_discount( floatval( $coupon['amount'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $coupon_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $coupon_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_cannot_update_order_coupon', __( 'Cannot update coupon, try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the admin order notes for an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.1&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_notes( $order_id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // ensure ID is valid order ID&nbsp;</div></li><li><div>        $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>            return $order_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array(&nbsp;</div></li><li><div>            'post_id' =&gt; $order_id, &nbsp;</div></li><li><div>            'approve' =&gt; 'approve', &nbsp;</div></li><li><div>            'type' =&gt; 'order_note', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        remove_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notes = get_comments( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ), 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_notes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $notes as $note ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_notes[] = current( $this-&gt;get_order_note( $order_id, $note-&gt;comment_ID, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_notes' =&gt; apply_filters( 'woocommerce_api_order_notes_response', $order_notes, $order_id, $fields, $notes, $this-&gt;server ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an order note for the given order ID and ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id order note ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_note( $order_id, $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'Invalid order note ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $note = get_comment( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $note ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'An order note with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_note = array(&nbsp;</div></li><li><div>                'id' =&gt; $note-&gt;comment_ID, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $note-&gt;comment_date_gmt ), &nbsp;</div></li><li><div>                'note' =&gt; $note-&gt;comment_content, &nbsp;</div></li><li><div>                'customer_note' =&gt; get_comment_meta( $note-&gt;comment_ID, 'is_customer_note', true ) ? true : false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'order_note' =&gt; apply_filters( 'woocommerce_api_order_note_response', $order_note, $id, $fields, $note, $order_id, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new order note for the given order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param array $data raw request data&nbsp;</div></li><li><div>     * @return WP_Error|array error or created note response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_order_note( $order_id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_note'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_note_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'order_note' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_note'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // permission check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_order_note', __( 'You do not have permission to create order notes', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_order_note_data', $data, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // note content is required&nbsp;</div></li><li><div>            if ( ! isset( $data['note'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note', __( 'Order note is required', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_customer_note = ( isset( $data['customer_note'] ) && true === $data['customer_note'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create the note&nbsp;</div></li><li><div>            $note_id = $order-&gt;add_order_note( $data['note'], $is_customer_note );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $note_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_order_note', __( 'Cannot create order note, please try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // HTTP 201 Created&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_order_note', $note_id, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_note( $order-&gt;get_id(), $note_id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit the order note&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id note ID&nbsp;</div></li><li><div>     * @param array $data parsed request data&nbsp;</div></li><li><div>     * @return WP_Error|array error or edited note response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order_note( $order_id, $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_note'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_note_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'order_note' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_note'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate note ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'Invalid order note ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is valid&nbsp;</div></li><li><div>            $note = get_comment( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $note ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'An order note with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is associated with given order&nbsp;</div></li><li><div>            if ( $note-&gt;comment_post_ID != $order-&gt;get_id() ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'The order note ID provided is not associated with the order', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_order_note_data', $data, $note-&gt;comment_ID, $order-&gt;get_id(), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Note content&nbsp;</div></li><li><div>            if ( isset( $data['note'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_update_comment(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'comment_ID' =&gt; $note-&gt;comment_ID, &nbsp;</div></li><li><div>                        'comment_content' =&gt; $data['note'], &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer note&nbsp;</div></li><li><div>            if ( isset( $data['customer_note'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                update_comment_meta( $note-&gt;comment_ID, 'is_customer_note', true === $data['customer_note'] ? 1 : 0 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_order_note', $note-&gt;comment_ID, $order-&gt;get_id(), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_note( $order-&gt;get_id(), $note-&gt;comment_ID );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete order note&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id note ID&nbsp;</div></li><li><div>     * @return WP_Error|array error or deleted message&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order_note( $order_id, $id ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate note ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'Invalid order note ID', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is valid&nbsp;</div></li><li><div>            $note = get_comment( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_null( $note ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'An order note with the provided ID could not be found', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure note ID is associated with given order&nbsp;</div></li><li><div>            if ( $note-&gt;comment_post_ID != $order_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_note_id', __( 'The order note ID provided is not associated with the order', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Force delete since trashed order notes could not be managed through comments list table&nbsp;</div></li><li><div>            $result = wp_delete_comment( $note-&gt;comment_ID, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $result ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_delete_order_note', __( 'This order note cannot be deleted', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_order_note', $note-&gt;comment_ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'message' =&gt; __( 'Permanently deleted order note', 'woocommerce' ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the order refunds for an order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to include in response&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_refunds( $order_id, $fields = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Ensure ID is valid order ID&nbsp;</div></li><li><div>        $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>            return $order_id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $refund_items = wc_get_orders( array(&nbsp;</div></li><li><div>            'type' =&gt; 'shop_order_refund', &nbsp;</div></li><li><div>            'parent' =&gt; $order_id, &nbsp;</div></li><li><div>            'limit' =&gt; -1, &nbsp;</div></li><li><div>            'return' =&gt; 'ids', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        $order_refunds = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $refund_items as $refund_id ) {&nbsp;</div></li><li><div>            $order_refunds[] = current( $this-&gt;get_order_refund( $order_id, $refund_id, $fields ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'order_refunds' =&gt; apply_filters( 'woocommerce_api_order_refunds_response', $order_refunds, $order_id, $fields, $refund_items, $this ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get an order refund for the given order ID and ID&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string|null $fields fields to limit response to&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_order_refund( $order_id, $id, $fields = null ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'read' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'Invalid order refund ID.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $refund = wc_get_order( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'An order refund with the provided ID could not be found.', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $line_items = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add line items&nbsp;</div></li><li><div>            foreach ( $refund-&gt;get_items( 'line_item' ) as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>                $product = $item-&gt;get_product();&nbsp;</div></li><li><div>                $hideprefix = ( isset( $filter['all_item_meta'] ) && 'true' === $filter['all_item_meta'] ) ? null : '_';&nbsp;</div></li><li><div>                $item_meta = $item-&gt;get_formatted_meta_data( $hideprefix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $item_meta as $key =&gt; $values ) {&nbsp;</div></li><li><div>                    $item_meta[ $key ]-&gt;label = $values-&gt;display_key;&nbsp;</div></li><li><div>                    unset( $item_meta[ $key ]-&gt;display_key );&nbsp;</div></li><li><div>                    unset( $item_meta[ $key ]-&gt;display_value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $line_items[] = array(&nbsp;</div></li><li><div>                    'id' =&gt; $item_id, &nbsp;</div></li><li><div>                    'subtotal' =&gt; wc_format_decimal( $order-&gt;get_line_subtotal( $item ), 2 ), &nbsp;</div></li><li><div>                    'subtotal_tax' =&gt; wc_format_decimal( $item-&gt;get_subtotal_tax(), 2 ), &nbsp;</div></li><li><div>                    'total' =&gt; wc_format_decimal( $order-&gt;get_line_total( $item ), 2 ), &nbsp;</div></li><li><div>                    'total_tax' =&gt; wc_format_decimal( $order-&gt;get_line_tax( $item ), 2 ), &nbsp;</div></li><li><div>                    'price' =&gt; wc_format_decimal( $order-&gt;get_item_total( $item ), 2 ), &nbsp;</div></li><li><div>                    'quantity' =&gt; $item-&gt;get_quantity(), &nbsp;</div></li><li><div>                    'tax_class' =&gt; $item-&gt;get_tax_class(), &nbsp;</div></li><li><div>                    'name' =&gt; $item-&gt;get_name(), &nbsp;</div></li><li><div>                    'product_id' =&gt; $item-&gt;get_variation_id() ? $item-&gt;get_variation_id() : $item-&gt;get_product_id(), &nbsp;</div></li><li><div>                    'sku' =&gt; is_object( $product ) ? $product-&gt;get_sku() : null, &nbsp;</div></li><li><div>                    'meta' =&gt; array_values( $item_meta ), &nbsp;</div></li><li><div>                    'refunded_item_id' =&gt; (int) $item-&gt;get_meta( 'refunded_item_id' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_refund = array(&nbsp;</div></li><li><div>                'id' =&gt; $refund-&gt;id, &nbsp;</div></li><li><div>                'created_at' =&gt; $this-&gt;server-&gt;format_datetime( $refund-&gt;get_date_created() ? $refund-&gt;get_date_created()-&gt;getTimestamp() : 0, false, false ), &nbsp;</div></li><li><div>                'amount' =&gt; wc_format_decimal( $refund-&gt;get_amount(), 2 ), &nbsp;</div></li><li><div>                'reason' =&gt; $refund-&gt;get_reason(), &nbsp;</div></li><li><div>                'line_items' =&gt; $line_items, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'order_refund' =&gt; apply_filters( 'woocommerce_api_order_refund_response', $order_refund, $id, $fields, $refund, $order_id, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create a new order refund for the given order&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param array $data raw request data&nbsp;</div></li><li><div>     * @param bool $api_refund do refund using a payment gateway API&nbsp;</div></li><li><div>     * @return WP_Error|array error or created refund response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create_order_refund( $order_id, $data, $api_refund = true ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_refund'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_refund_data', sprintf( __( 'No %1$s data specified to create %1$s', 'woocommerce' ), 'order_refund' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_refund'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Permission check&nbsp;</div></li><li><div>            if ( ! current_user_can( 'publish_shop_orders' ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_user_cannot_create_order_refund', __( 'You do not have permission to create order refunds', 'woocommerce' ), 401 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $order_id = absint( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $order_id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_id', __( 'Order ID is invalid', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_create_order_refund_data', $data, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Refund amount is required&nbsp;</div></li><li><div>            if ( ! isset( $data['amount'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund', __( 'Refund amount is required.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            } elseif ( 0 &gt; $data['amount'] ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund', __( 'Refund amount must be positive.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data['order_id'] = $order_id;&nbsp;</div></li><li><div>            $data['refund_id'] = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Create the refund&nbsp;</div></li><li><div>            $refund = wc_create_refund( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_cannot_create_order_refund', __( 'Cannot create order refund, please try again.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Refund via API&nbsp;</div></li><li><div>            if ( $api_refund ) {&nbsp;</div></li><li><div>                if ( WC()-&gt;payment_gateways() ) {&nbsp;</div></li><li><div>                    $payment_gateways = WC()-&gt;payment_gateways-&gt;payment_gateways();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $payment_gateways[ $order-&gt;get_payment_method() ] ) && $payment_gateways[ $order-&gt;get_payment_method() ]-&gt;supports( 'refunds' ) ) {&nbsp;</div></li><li><div>                    $result = $payment_gateways[ $order-&gt;get_payment_method() ]-&gt;process_refund( $order_id, $refund-&gt;get_amount(), $refund-&gt;get_reason() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                        return $result;&nbsp;</div></li><li><div>                    } elseif ( ! $result ) {&nbsp;</div></li><li><div>                        throw new WC_API_Exception( 'woocommerce_api_create_order_refund_api_failed', __( 'An error occurred while attempting to create the refund using the payment gateway API.', 'woocommerce' ), 500 );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // HTTP 201 Created&nbsp;</div></li><li><div>            $this-&gt;server-&gt;send_status( 201 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_create_order_refund', $refund-&gt;id, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_refund( $order_id, $refund-&gt;id );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Edit an order refund&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id refund ID&nbsp;</div></li><li><div>     * @param array $data parsed request data&nbsp;</div></li><li><div>     * @return WP_Error|array error or edited refund response data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function edit_order_refund( $order_id, $id, $data ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['order_refund'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_order_refund_data', sprintf( __( 'No %1$s data specified to edit %1$s', 'woocommerce' ), 'order_refund' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['order_refund'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate order ID&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate refund ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'Invalid order refund ID.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure order ID is valid&nbsp;</div></li><li><div>            $refund = get_post( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'An order refund with the provided ID could not be found.', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure refund ID is associated with given order&nbsp;</div></li><li><div>            if ( $refund-&gt;post_parent != $order_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'The order refund ID provided is not associated with the order.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = apply_filters( 'woocommerce_api_edit_order_refund_data', $data, $refund-&gt;ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update reason&nbsp;</div></li><li><div>            if ( isset( $data['reason'] ) ) {&nbsp;</div></li><li><div>                $updated_refund = wp_update_post( array( 'ID' =&gt; $refund-&gt;ID, 'post_excerpt' =&gt; $data['reason'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_wp_error( $updated_refund ) ) {&nbsp;</div></li><li><div>                    return $updated_refund;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Update refund amount&nbsp;</div></li><li><div>            if ( isset( $data['amount'] ) && 0 &lt; $data['amount'] ) {&nbsp;</div></li><li><div>                update_post_meta( $refund-&gt;ID, '_refund_amount', wc_format_decimal( $data['amount'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_edit_order_refund', $refund-&gt;ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;get_order_refund( $order_id, $refund-&gt;ID );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete order refund&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.2&nbsp;</div></li><li><div>     * @param string $order_id order ID&nbsp;</div></li><li><div>     * @param string $id refund ID&nbsp;</div></li><li><div>     * @return WP_Error|array error or deleted message&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete_order_refund( $order_id, $id ) {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = $this-&gt;validate_request( $order_id, $this-&gt;post_type, 'delete' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $order_id ) ) {&nbsp;</div></li><li><div>                return $order_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Validate refund ID&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $id ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'Invalid order refund ID.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure refund ID is valid&nbsp;</div></li><li><div>            $refund = get_post( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'An order refund with the provided ID could not be found.', 'woocommerce' ), 404 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Ensure refund ID is associated with given order&nbsp;</div></li><li><div>            if ( $refund-&gt;post_parent != $order_id ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_invalid_order_refund_id', __( 'The order refund ID provided is not associated with the order.', 'woocommerce' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wc_delete_shop_order_transients( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_api_delete_order_refund', $refund-&gt;ID, $order_id, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $this-&gt;delete( $refund-&gt;ID, 'refund', true );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk update or insert orders&nbsp;</div></li><li><div>     * Accepts an array with orders in the formats supported by&nbsp;</div></li><li><div>     * WC_API_Orders-&gt;create_order() and WC_API_Orders-&gt;edit_order()&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.4.0&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function bulk( $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( ! isset( $data['orders'] ) ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_missing_orders_data', sprintf( __( 'No %1$s data specified to create/edit %1$s', 'woocommerce' ), 'orders' ), 400 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data = $data['orders'];&nbsp;</div></li><li><div>            $limit = apply_filters( 'woocommerce_api_bulk_limit', 100, 'orders' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Limit bulk operation&nbsp;</div></li><li><div>            if ( count( $data ) &gt; $limit ) {&nbsp;</div></li><li><div>                throw new WC_API_Exception( 'woocommerce_api_orders_request_entity_too_large', sprintf( __( 'Unable to accept more than %s items for this request.', 'woocommerce' ), $limit ), 413 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $orders = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $data as $_order ) {&nbsp;</div></li><li><div>                $order_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Try to get the order ID&nbsp;</div></li><li><div>                if ( isset( $_order['id'] ) ) {&nbsp;</div></li><li><div>                    $order_id = intval( $_order['id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $order_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Order exists / edit order&nbsp;</div></li><li><div>                    $edit = $this-&gt;edit_order( $order_id, array( 'order' =&gt; $_order ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $edit ) ) {&nbsp;</div></li><li><div>                        $orders[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $order_id, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $edit-&gt;get_error_code(), 'message' =&gt; $edit-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $orders[] = $edit['order'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Order don't exists / create order&nbsp;</div></li><li><div>                    $new = $this-&gt;create_order( array( 'order' =&gt; $_order ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_wp_error( $new ) ) {&nbsp;</div></li><li><div>                        $orders[] = array(&nbsp;</div></li><li><div>                            'id' =&gt; $order_id, &nbsp;</div></li><li><div>                            'error' =&gt; array( 'code' =&gt; $new-&gt;get_error_code(), 'message' =&gt; $new-&gt;get_error_message() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $orders[] = $new['order'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'orders' =&gt; apply_filters( 'woocommerce_api_orders_bulk_response', $orders, $this ) );&nbsp;</div></li><li><div>        } catch ( WC_Data_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; 400 ) );&nbsp;</div></li><li><div>        } catch ( WC_API_Exception $e ) {&nbsp;</div></li><li><div>            return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( 'status' =&gt; $e-&gt;getCode() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/wc_api_orders/" class="">3.0.6</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/wc_api_orders/" class="">3.0.5</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.4/classes/wc_api_orders/" class="">3.0.4</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.3/classes/wc_api_orders/" class="">3.0.3</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/wc_api_orders/" class="active">3.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WC_API_Orders</li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>