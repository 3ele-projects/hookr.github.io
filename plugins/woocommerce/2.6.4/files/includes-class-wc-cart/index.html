<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.0.6" data-slug="woocommerce" data-type="file" data-id="40565"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-class-wc-cart | file | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce, 3.0.6" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=3aa99134dbf3f410427d21d6a2a08e19' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-class-wc-cart/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wc-cart%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-class-wc-cart%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.6-file-includes-class-wc-cart","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-class-wc-cart" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.6." href="http://hookr.io/plugins/woocommerce/3.0.6/" class="H_VERSION"><span property="name">3.0.6</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce/3.0.6/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-class-wc-cart</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="3119"><a href="http://hookr.io/plugins/woocommerce/3.0.6/all/" title="All">All <span class="count badge">3119</span></a></li><li class="" data-id="new" data-count="3"><a href="http://hookr.io/plugins/woocommerce/3.0.6/new/" title="New">New <span class="count badge">3</span></a></li><li class="" data-id="hooks" data-count="2110"><a href="http://hookr.io/plugins/woocommerce/3.0.6/hooks/" title="Hooks">Hooks <span class="count badge">2110</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.6/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1336"><a href="http://hookr.io/plugins/woocommerce/3.0.6/filters/" title="Filters">Filters <span class="count badge">1336</span></a></li><li class="" data-id="class" data-count="365"><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/" title="Classes">Classes <span class="count badge">365</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.6/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="626"><a href="http://hookr.io/plugins/woocommerce/3.0.6/functions/" title="Functions">Functions <span class="count badge">626</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.6/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/class-wc-cart.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) {&nbsp;</div></li><li><div>  exit; <span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WooCommerce cart</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The WooCommerce cart class stores cart data and active coupons as well as handling customer sessions and some cart related urls.</span>&nbsp;</div></li><li><div><span class="comment"> * The cart class also has a price calculation function which calls upon other classes to calculate totals.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @class         WC_Cart</span>&nbsp;</div></li><li><div><span class="comment"> * @version        2.1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @package        WooCommerce/Classes</span>&nbsp;</div></li><li><div><span class="comment"> * @category    Class</span>&nbsp;</div></li><li><div><span class="comment"> * @author         WooThemes</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class WC_Cart {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Contains an array of cart items. */</span>&nbsp;</div></li><li><div>  public $cart_contents = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Contains an array of removed cart items. */</span>&nbsp;</div></li><li><div>  public $removed_cart_contents = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Contains an array of coupon codes applied to the cart. */</span>&nbsp;</div></li><li><div>  public $applied_coupons = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Contains an array of coupon code discounts after they have been applied. */</span>&nbsp;</div></li><li><div>  public $coupon_discount_amounts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Contains an array of coupon code discount taxes. Used for tax incl pricing. */</span>&nbsp;</div></li><li><div>  public $coupon_discount_tax_amounts = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Contains an array of coupon usage counts after they have been applied. */</span>&nbsp;</div></li><li><div>  public $coupon_applied_count = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array Array of coupons */</span>&nbsp;</div></li><li><div>  public $coupons = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float The total cost of the cart items. */</span>&nbsp;</div></li><li><div>  public $cart_contents_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Cart grand total. */</span>&nbsp;</div></li><li><div>  public $total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Cart subtotal. */</span>&nbsp;</div></li><li><div>  public $subtotal;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Cart subtotal without tax. */</span>&nbsp;</div></li><li><div>  public $subtotal_ex_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Total cart tax. */</span>&nbsp;</div></li><li><div>  public $tax_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array An array of taxes/tax rates for the cart. */</span>&nbsp;</div></li><li><div>  public $taxes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array An array of taxes/tax rates for the shipping. */</span>&nbsp;</div></li><li><div>  public $shipping_taxes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Discount amount before tax */</span>&nbsp;</div></li><li><div>  public $discount_cart;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Discounted tax amount. Used predominantly for displaying tax inclusive prices correctly */</span>&nbsp;</div></li><li><div>  public $discount_cart_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Total for additional fees. */</span>&nbsp;</div></li><li><div>  public $fee_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Shipping cost. */</span>&nbsp;</div></li><li><div>  public $shipping_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var float Shipping tax. */</span>&nbsp;</div></li><li><div>  public $shipping_tax_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var array cart_session_data. Array of data the cart calculates and stores in the session with defaults */</span>&nbsp;</div></li><li><div>  public $cart_session_data = array(&nbsp;</div></li><li><div>      'cart_contents_total' =&gt; 0, &nbsp;</div></li><li><div>      'total' =&gt; 0, &nbsp;</div></li><li><div>      'subtotal' =&gt; 0, &nbsp;</div></li><li><div>      'subtotal_ex_tax' =&gt; 0, &nbsp;</div></li><li><div>      'tax_total' =&gt; 0, &nbsp;</div></li><li><div>      'taxes' =&gt; array(), &nbsp;</div></li><li><div>      'shipping_taxes' =&gt; array(), &nbsp;</div></li><li><div>      'discount_cart' =&gt; 0, &nbsp;</div></li><li><div>      'discount_cart_tax' =&gt; 0, &nbsp;</div></li><li><div>      'shipping_total' =&gt; 0, &nbsp;</div></li><li><div>      'shipping_tax_total' =&gt; 0, &nbsp;</div></li><li><div>      'coupon_discount_amounts' =&gt; array(), &nbsp;</div></li><li><div>      'coupon_discount_tax_amounts' =&gt; array(), &nbsp;</div></li><li><div>      'fee_total' =&gt; 0, &nbsp;</div></li><li><div>      'fees' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * An array of fees.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public $fees = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor for the cart class. Loads options and hooks in the init method.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct() {&nbsp;</div></li><li><div>      add_action( 'wp_loaded', array( $this, 'init' ) ); <span class="comment">// Get cart after WP and plugins are loaded.</span>&nbsp;</div></li><li><div>      add_action( 'wp', array( $this, 'maybe_set_cart_cookies' ), 99 ); <span class="comment">// Set cookies</span>&nbsp;</div></li><li><div>      add_action( 'shutdown', array( $this, 'maybe_set_cart_cookies' ), 0 ); <span class="comment">// Set cookies</span> before shutdown and ob flushing&nbsp;</div></li><li><div>      add_action( 'woocommerce_add_to_cart', array( $this, 'calculate_totals' ), 20, 0 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_applied_coupon', array( $this, 'calculate_totals' ), 20, 0 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Auto-load in-accessible properties on demand.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $key</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __get( $key ) {&nbsp;</div></li><li><div>      switch ( $key ) {&nbsp;</div></li><li><div>          case 'prices_include_tax' :&nbsp;</div></li><li><div>              return wc_prices_include_tax();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'round_at_subtotal' :&nbsp;</div></li><li><div>              return 'yes' === get_option( 'woocommerce_tax_round_at_subtotal' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'tax_display_cart' :&nbsp;</div></li><li><div>              return get_option( 'woocommerce_tax_display_cart' );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'dp' :&nbsp;</div></li><li><div>              return wc_get_price_decimals();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'display_totals_ex_tax' :&nbsp;</div></li><li><div>          case 'display_cart_ex_tax' :&nbsp;</div></li><li><div>              return 'excl' === $this-&gt;tax_display_cart;&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'cart_contents_weight' :&nbsp;</div></li><li><div>              return $this-&gt;get_cart_contents_weight();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'cart_contents_count' :&nbsp;</div></li><li><div>              return $this-&gt;get_cart_contents_count();&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'tax' :&nbsp;</div></li><li><div>              wc_deprecated_argument( 'WC_Cart-&gt;tax', '2.3', 'Use WC_Tax:: directly' );&nbsp;</div></li><li><div>              $this-&gt;tax = new WC_Tax();&nbsp;</div></li><li><div>          return $this-&gt;tax;&nbsp;</div></li><li><div>          case 'discount_total':&nbsp;</div></li><li><div>              wc_deprecated_argument( 'WC_Cart-&gt;discount_total', '2.3', 'After tax coupons are no longer supported. For more information see: https:<span class="comment">//woocommerce.wordpress.com/2014/12/upcoming-coupon-changes-in-woocommerce-2-3/' );</span>&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Loads the cart data from the PHP session during WordPress init and hooks in other methods.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function init() {&nbsp;</div></li><li><div>      $this-&gt;get_cart_from_session();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'woocommerce_check_cart_items', array( $this, 'check_cart_items' ), 1 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_check_cart_items', array( $this, 'check_cart_coupons' ), 1 );&nbsp;</div></li><li><div>      add_action( 'woocommerce_after_checkout_validation', array( $this, 'check_customer_coupons' ), 1 );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Will set cart cookies if needed, once, during WP hook.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_set_cart_cookies() {&nbsp;</div></li><li><div>      if ( ! headers_sent() && did_action( 'wp_loaded' ) ) {&nbsp;</div></li><li><div>          if ( ! $this-&gt;is_empty() ) {&nbsp;</div></li><li><div>              $this-&gt;set_cart_cookies( true );&nbsp;</div></li><li><div>          } elseif ( isset( $_COOKIE['woocommerce_items_in_cart'] ) ) {&nbsp;</div></li><li><div>              $this-&gt;set_cart_cookies( false );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set cart hash cookie and items in cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $set (default: true)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function set_cart_cookies( $set = true ) {&nbsp;</div></li><li><div>      if ( $set ) {&nbsp;</div></li><li><div>          wc_setcookie( 'woocommerce_items_in_cart', 1 );&nbsp;</div></li><li><div>          wc_setcookie( 'woocommerce_cart_hash', md5( json_encode( $this-&gt;get_cart_for_session() ) ) );&nbsp;</div></li><li><div>      } elseif ( isset( $_COOKIE['woocommerce_items_in_cart'] ) ) {&nbsp;</div></li><li><div>          wc_setcookie( 'woocommerce_items_in_cart', 0, time() - HOUR_IN_SECONDS );&nbsp;</div></li><li><div>          wc_setcookie( 'woocommerce_cart_hash', '', time() - HOUR_IN_SECONDS );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      do_action( 'woocommerce_set_cart_cookies', $set );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  /** Cart Session Handling</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the cart data from the PHP session and store it in class variables.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_from_session() {&nbsp;</div></li><li><div>      <span class="comment">// Load cart session data from session</span>&nbsp;</div></li><li><div>      foreach ( $this-&gt;cart_session_data as $key =&gt; $default ) {&nbsp;</div></li><li><div>          $this-&gt;$key = WC()-&gt;session-&gt;get( $key, $default );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $update_cart_session = false;&nbsp;</div></li><li><div>      $this-&gt;removed_cart_contents = array_filter( WC()-&gt;session-&gt;get( 'removed_cart_contents', array() ) );&nbsp;</div></li><li><div>      $this-&gt;applied_coupons = array_filter( WC()-&gt;session-&gt;get( 'applied_coupons', array() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Load the cart object. This defaults to the persistent cart if null.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      $cart = WC()-&gt;session-&gt;get( 'cart', null );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $cart ) && ( $saved_cart = get_user_meta( get_current_user_id(), '_woocommerce_persistent_cart', true ) ) ) {&nbsp;</div></li><li><div>          $cart = $saved_cart['cart'];&nbsp;</div></li><li><div>          $update_cart_session = true;&nbsp;</div></li><li><div>      } elseif ( is_null( $cart ) ) {&nbsp;</div></li><li><div>          $cart = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $cart ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Prime meta cache to reduce future queries</span>&nbsp;</div></li><li><div>          update_meta_cache( 'post', wp_list_pluck( $cart, 'product_id' ) );&nbsp;</div></li><li><div>          update_object_term_cache( wp_list_pluck( $cart, 'product_id' ), 'product' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $cart as $key =&gt; $values ) {&nbsp;</div></li><li><div>              $product = wc_get_product( $values['variation_id'] ? $values['variation_id'] : $values['product_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $product ) && $product-&gt;exists() && $values['quantity'] &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! $product-&gt;is_purchasable() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Flag to indicate the stored cart should be update</span>&nbsp;</div></li><li><div>                      $update_cart_session = true;&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">/** translators: %s: product name */</span></span></span>&nbsp;</div></li><li><div>                      wc_add_notice( sprintf( __( '%s has been removed from your cart because it can no longer be purchased. Please contact us if you need assistance.', 'woocommerce' ), $product-&gt;get_name() ), 'error' );&nbsp;</div></li><li><div>                      do_action( 'woocommerce_remove_cart_item_from_session', $key, $values );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Put session data into array. Run through filter so other plugins can load their own session data</span>&nbsp;</div></li><li><div>                      $session_data = array_merge( $values, array( 'data' =&gt; $product ) );&nbsp;</div></li><li><div>                      $this-&gt;cart_contents[ $key ] = apply_filters( 'woocommerce_get_cart_item_from_session', $session_data, $values, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Trigger action</span>&nbsp;</div></li><li><div>      do_action( 'woocommerce_cart_loaded_from_session', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $update_cart_session ) {&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;cart = $this-&gt;get_cart_for_session();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Queue re-calc if subtotal is not set</span>&nbsp;</div></li><li><div>      if ( ( ! $this-&gt;subtotal && ! $this-&gt;is_empty() ) || $update_cart_session ) {&nbsp;</div></li><li><div>          $this-&gt;calculate_totals();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets the php session data for the cart and coupons.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_session() {&nbsp;</div></li><li><div>      <span class="comment">// Set cart and coupon session data</span>&nbsp;</div></li><li><div>      $cart_session = $this-&gt;get_cart_for_session();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'cart', $cart_session );&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'applied_coupons', $this-&gt;applied_coupons );&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'coupon_discount_amounts', $this-&gt;coupon_discount_amounts );&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'coupon_discount_tax_amounts', $this-&gt;coupon_discount_tax_amounts );&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'removed_cart_contents', $this-&gt;removed_cart_contents );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;cart_session_data as $key =&gt; $default ) {&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set( $key, $this-&gt;$key );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_current_user_id() ) {&nbsp;</div></li><li><div>          $this-&gt;persistent_cart_update();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_cart_updated' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Empties the cart and optionally the persistent cart too.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $clear_persistent_cart (default: true)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function empty_cart( $clear_persistent_cart = true ) {&nbsp;</div></li><li><div>      $this-&gt;cart_contents = array();&nbsp;</div></li><li><div>      $this-&gt;reset( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( WC()-&gt;session-&gt;order_awaiting_payment, WC()-&gt;session-&gt;applied_coupons, WC()-&gt;session-&gt;coupon_discount_amounts, WC()-&gt;session-&gt;coupon_discount_tax_amounts, WC()-&gt;session-&gt;cart );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $clear_persistent_cart && get_current_user_id() ) {&nbsp;</div></li><li><div>          $this-&gt;persistent_cart_destroy();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_cart_emptied' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Persistent cart handling</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Save the persistent cart when the cart is updated.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function persistent_cart_update() {&nbsp;</div></li><li><div>      update_user_meta( get_current_user_id(), '_woocommerce_persistent_cart', array(&nbsp;</div></li><li><div>          'cart' =&gt; WC()-&gt;session-&gt;get( 'cart' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Delete the persistent cart permanently.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function persistent_cart_destroy() {&nbsp;</div></li><li><div>      delete_user_meta( get_current_user_id(), '_woocommerce_persistent_cart' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cart Data Functions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Coupons enabled function. Filterable.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 2.5.0 in favor to wc_coupons_enabled()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function coupons_enabled() {&nbsp;</div></li><li><div>      return wc_coupons_enabled();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get number of items in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_contents_count() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_contents_count', array_sum( wp_list_pluck( $this-&gt;get_cart(), 'quantity' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get weight of items in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_contents_weight() {&nbsp;</div></li><li><div>      $weight = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_cart() as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>          $weight += (float) $values['data']-&gt;get_weight() * $values['quantity'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_contents_weight', $weight );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if the cart is empty.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_empty() {&nbsp;</div></li><li><div>      return 0 === sizeof( $this-&gt;get_cart() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check all cart items for errors.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_cart_items() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Result</span>&nbsp;</div></li><li><div>      $return = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check cart item validity</span>&nbsp;</div></li><li><div>      $result = $this-&gt;check_cart_item_validity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>          wc_add_notice( $result-&gt;get_error_message(), 'error' );&nbsp;</div></li><li><div>          $return = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check item stock</span>&nbsp;</div></li><li><div>      $result = $this-&gt;check_cart_item_stock();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>          wc_add_notice( $result-&gt;get_error_message(), 'error' );&nbsp;</div></li><li><div>          $return = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check cart coupons for errors.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_cart_coupons() {&nbsp;</div></li><li><div>      foreach ( $this-&gt;applied_coupons as $code ) {&nbsp;</div></li><li><div>          $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $coupon-&gt;is_valid() ) {&nbsp;</div></li><li><div>              <span class="comment">// Error message</span>&nbsp;</div></li><li><div>              $coupon-&gt;add_coupon_message( WC_Coupon::E_WC_COUPON_INVALID_REMOVED );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Remove the coupon</span></span></span>&nbsp;</div></li><li><div>              $this-&gt;remove_coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Flag totals for refresh</span></span></span>&nbsp;</div></li><li><div>              WC()-&gt;session-&gt;set( 'refresh_totals', true );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get cart items quantities - merged so we can do accurate stock checks on items across multiple lines.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_item_quantities() {&nbsp;</div></li><li><div>      $quantities = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_cart() as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>          $product = $values['data'];&nbsp;</div></li><li><div>          $quantities[ $product-&gt;get_stock_managed_by_id() ] = isset( $quantities[ $product-&gt;get_stock_managed_by_id() ] ) ? $quantities[ $product-&gt;get_stock_managed_by_id() ] + $values['quantity'] : $values['quantity'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $quantities;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Looks through cart items and checks the posts are not trashed or deleted.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool|WP_Error</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_cart_item_validity() {&nbsp;</div></li><li><div>      $return = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_cart() as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>          $product = $values['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $product || ! $product-&gt;exists() || 'trash' === $product-&gt;get_status() ) {&nbsp;</div></li><li><div>              $this-&gt;set_quantity( $cart_item_key, 0 );&nbsp;</div></li><li><div>              $return = new WP_Error( 'invalid', __( 'An item which is no longer available was removed from your cart.', 'woocommerce' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Looks through the cart to check each item is in stock. If not, add an error.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool|WP_Error</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_cart_item_stock() {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $error = new WP_Error();&nbsp;</div></li><li><div>      $product_qty_in_cart = $this-&gt;get_cart_item_quantities();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// First stock check loop</span>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_cart() as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>          $product = $values['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Check stock based on stock-status.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! $product-&gt;is_in_stock() ) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">/** translators: %s: product name */</span></span></span>&nbsp;</div></li><li><div>              $error-&gt;add( 'out-of-stock', sprintf( __( 'Sorry, &quot;%s&quot; is not in stock. Please edit your cart and try again. We apologize for any inconvenience caused.', 'woocommerce' ), $product-&gt;get_name() ) );&nbsp;</div></li><li><div>              return $error;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $product-&gt;managing_stock() ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Check stock based on all items in the cart.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! $product-&gt;has_enough_stock( $product_qty_in_cart[ $product-&gt;get_stock_managed_by_id() ] ) ) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">/** translators: 1: product name 2: quantity in stock */</span></span>&nbsp;</div></li><li><div>              $error-&gt;add( 'out-of-stock', sprintf( __( 'Sorry, we do not have enough &quot;%1$s&quot; in stock to fulfill your order (%2$s in stock). Please edit your cart and try again. We apologize for any inconvenience caused.', 'woocommerce' ), $product-&gt;get_name(), wc_format_stock_quantity_for_display( $product-&gt;get_stock_quantity(), $product ) ) );&nbsp;</div></li><li><div>              return $error;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Finally consider any held stock, from pending orders.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( get_option( 'woocommerce_hold_stock_minutes' ) &gt; 0 && ! $product-&gt;backorders_allowed() ) {&nbsp;</div></li><li><div>              $order_id = isset( WC()-&gt;session-&gt;order_awaiting_payment ) ? absint( WC()-&gt;session-&gt;order_awaiting_payment ) : 0;&nbsp;</div></li><li><div>              $held_stock = $wpdb-&gt;get_var(&nbsp;</div></li><li><div>                  $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                      SELECT SUM( order_item_meta.meta_value ) AS held_qty&nbsp;</div></li><li><div>                      FROM {$wpdb-&gt;posts} AS posts&nbsp;</div></li><li><div>                      LEFT JOIN {$wpdb-&gt;prefix}woocommerce_order_items as order_items ON posts.ID = order_items.order_id&nbsp;</div></li><li><div>                      LEFT JOIN {$wpdb-&gt;prefix}woocommerce_order_itemmeta as order_item_meta ON order_items.order_item_id = order_item_meta.order_item_id&nbsp;</div></li><li><div>                      LEFT JOIN {$wpdb-&gt;prefix}woocommerce_order_itemmeta as order_item_meta2 ON order_items.order_item_id = order_item_meta2.order_item_id&nbsp;</div></li><li><div>                      WHERE     order_item_meta.meta_key = '_qty'&nbsp;</div></li><li><div>                      AND     order_item_meta2.meta_key = %s AND order_item_meta2.meta_value = %d&nbsp;</div></li><li><div>                      AND     posts.post_type            IN ( '&quot; . implode( &quot;', '&quot;, wc_get_order_types() ) . &quot;' )&nbsp;</div></li><li><div>                      AND     posts.post_status = 'wc-pending'&nbsp;</div></li><li><div>                      AND        posts.ID                   != %d;&quot;, &nbsp;</div></li><li><div>                      'variation' === get_post_type( $product-&gt;get_stock_managed_by_id() ) ? '_variation_id' : '_product_id', &nbsp;</div></li><li><div>                      $product-&gt;get_stock_managed_by_id(), &nbsp;</div></li><li><div>                      $order_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $product-&gt;get_stock_quantity() &lt; ( $held_stock + $product_qty_in_cart[ $product-&gt;get_stock_managed_by_id() ] ) ) {&nbsp;</div></li><li><div>                  <span class="comment">/** translators: 1: product name 2: minutes */</span>&nbsp;</div></li><li><div>                  $error-&gt;add( 'out-of-stock', sprintf( __( 'Sorry, we do not have enough &quot;%1$s&quot; in stock to fulfill your order right now. Please try again in %2$d minutes or edit your cart and try again. We apologize for any inconvenience caused.', 'woocommerce' ), $product-&gt;get_name(), get_option( 'woocommerce_hold_stock_minutes' ) ) );&nbsp;</div></li><li><div>                  return $error;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets and formats a list of cart item data + variations for display on the frontend.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $cart_item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $flat (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_data( $cart_item, $flat = false ) {&nbsp;</div></li><li><div>      $item_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Variation values are shown only if they are not found in the title as of 3.0.</span>&nbsp;</div></li><li><div>      <span class="comment">// This is because variation titles display the attributes.</span>&nbsp;</div></li><li><div>      if ( $cart_item['data']-&gt;is_type( 'variation' ) && is_array( $cart_item['variation'] ) ) {&nbsp;</div></li><li><div>          foreach ( $cart_item['variation'] as $name =&gt; $value ) {&nbsp;</div></li><li><div>              $taxonomy = wc_attribute_taxonomy_name( str_replace( 'attribute_pa_', '', urldecode( $name ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If this is a term slug, get the term's nice name</span>&nbsp;</div></li><li><div>              if ( taxonomy_exists( $taxonomy ) ) {&nbsp;</div></li><li><div>                  $term = get_term_by( 'slug', $value, $taxonomy );&nbsp;</div></li><li><div>                  if ( ! is_wp_error( $term ) && $term && $term-&gt;name ) {&nbsp;</div></li><li><div>                      $value = $term-&gt;name;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $label = wc_attribute_label( $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If this is a custom option slug, get the options name.</span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $value = apply_filters( 'woocommerce_variation_option_name', $value );&nbsp;</div></li><li><div>                  $label = wc_attribute_label( str_replace( 'attribute_', '', $name ), $cart_item['data'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Check the nicename against the title.</span>&nbsp;</div></li><li><div>              if ( '' === $value || wc_is_attribute_in_product_name( $value, $cart_item['data']-&gt;get_name() ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $item_data[] = array(&nbsp;</div></li><li><div>                  'key' =&gt; $label, &nbsp;</div></li><li><div>                  'value' =&gt; $value, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Filter item data to allow 3rd parties to add more to the array</span>&nbsp;</div></li><li><div>      $item_data = apply_filters( 'woocommerce_get_item_data', $item_data, $cart_item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Format item data ready to display</span>&nbsp;</div></li><li><div>      foreach ( $item_data as $key =&gt; $data ) {&nbsp;</div></li><li><div>          <span class="comment">// Set hidden to true to not display meta on cart.</span>&nbsp;</div></li><li><div>          if ( ! empty( $data['hidden'] ) ) {&nbsp;</div></li><li><div>              unset( $item_data[ $key ] );&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $item_data[ $key ]['key'] = ! empty( $data['key'] ) ? $data['key'] : $data['name'];&nbsp;</div></li><li><div>          $item_data[ $key ]['display'] = ! empty( $data['display'] ) ? $data['display'] : $data['value'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Output flat or in list format</span>&nbsp;</div></li><li><div>      if ( sizeof( $item_data ) &gt; 0 ) {&nbsp;</div></li><li><div>          ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $flat ) {&nbsp;</div></li><li><div>              foreach ( $item_data as $data ) {&nbsp;</div></li><li><div>                  echo esc_html( $data['key'] ) . ': ' . wp_kses_post( $data['display'] ) . &quot;\n&quot;;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              wc_get_template( 'cart/cart-item-data.php', array( 'item_data' =&gt; $item_data ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return ob_get_clean();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets cross sells based on the items in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array cross_sells (item ids)</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cross_sells() {&nbsp;</div></li><li><div>      $cross_sells = array();&nbsp;</div></li><li><div>      $in_cart = array();&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_empty() ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_cart() as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>              if ( $values['quantity'] &gt; 0 ) {&nbsp;</div></li><li><div>                  $cross_sells = array_merge( $values['data']-&gt;get_cross_sell_ids(), $cross_sells );&nbsp;</div></li><li><div>                  $in_cart[] = $values['product_id'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $cross_sells = array_diff( $cross_sells, $in_cart );&nbsp;</div></li><li><div>      return wp_parse_id_list( $cross_sells );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url to the cart page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 2.5.0 in favor to wc_get_cart_url()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string url to page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_url() {&nbsp;</div></li><li><div>      return wc_get_cart_url();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url to the checkout page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 2.5.0 in favor to wc_get_checkout_url()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string url to page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_checkout_url() {&nbsp;</div></li><li><div>      return wc_get_checkout_url();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url to remove an item from the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $cart_item_key contains the id of the cart item</span>&nbsp;</div></li><li><div><span class="comment">   * @return string url to page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_remove_url( $cart_item_key ) {&nbsp;</div></li><li><div>      $cart_page_url = wc_get_page_permalink( 'cart' );&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_remove_url', $cart_page_url ? wp_nonce_url( add_query_arg( 'remove_item', $cart_item_key, $cart_page_url ), 'woocommerce-cart' ) : '' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url to re-add an item into the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $cart_item_key</span>&nbsp;</div></li><li><div><span class="comment">   * @return string url to page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_undo_url( $cart_item_key ) {&nbsp;</div></li><li><div>      $cart_page_url = wc_get_page_permalink( 'cart' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query_args = array(&nbsp;</div></li><li><div>          'undo_item' =&gt; $cart_item_key, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_undo_url', $cart_page_url ? wp_nonce_url( add_query_arg( $query_args, $cart_page_url ), 'woocommerce-cart' ) : '', $cart_item_key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the contents of the cart in an array.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array contents of the cart</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart() {&nbsp;</div></li><li><div>      if ( ! did_action( 'wp_loaded' ) ) {&nbsp;</div></li><li><div>          wc_doing_it_wrong( __FUNCTION__, __( 'Get cart should not be called before the wp_loaded action.', 'woocommerce' ), '2.3' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! did_action( 'woocommerce_cart_loaded_from_session' ) ) {&nbsp;</div></li><li><div>          $this-&gt;get_cart_from_session();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array_filter( (array) $this-&gt;cart_contents );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the contents of the cart in an array without the 'data' element.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array contents of the cart</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_for_session() {&nbsp;</div></li><li><div>      $cart_session = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;get_cart() ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_cart() as $key =&gt; $values ) {&nbsp;</div></li><li><div>              $cart_session[ $key ] = $values;&nbsp;</div></li><li><div>              unset( $cart_session[ $key ]['data'] ); <span class="comment">// Unset product object</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cart_session;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a specific item in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $item_key Cart item key.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array Item data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_item( $item_key ) {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;cart_contents[ $item_key ] ) ) {&nbsp;</div></li><li><div>          return $this-&gt;cart_contents[ $item_key ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the cart and shipping taxes, merged.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array merged taxes</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_taxes() {&nbsp;</div></li><li><div>      $taxes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Merge</span>&nbsp;</div></li><li><div>      foreach ( array_keys( $this-&gt;taxes + $this-&gt;shipping_taxes ) as $key ) {&nbsp;</div></li><li><div>          $taxes[ $key ] = ( isset( $this-&gt;shipping_taxes[ $key ] ) ? $this-&gt;shipping_taxes[ $key ] : 0 ) + ( isset( $this-&gt;taxes[ $key ] ) ? $this-&gt;taxes[ $key ] : 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_get_taxes', $taxes, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get taxes, merged by code, formatted ready for output.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_tax_totals() {&nbsp;</div></li><li><div>      $taxes = $this-&gt;get_taxes();&nbsp;</div></li><li><div>      $tax_totals = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $taxes as $key =&gt; $tax ) {&nbsp;</div></li><li><div>          $code = WC_Tax::get_rate_code( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $code || apply_filters( 'woocommerce_cart_remove_taxes_zero_rate_id', 'zero-rated' ) === $key ) {&nbsp;</div></li><li><div>              if ( ! isset( $tax_totals[ $code ] ) ) {&nbsp;</div></li><li><div>                  $tax_totals[ $code ] = new stdClass();&nbsp;</div></li><li><div>                  $tax_totals[ $code ]-&gt;amount = 0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $tax_totals[ $code ]-&gt;tax_rate_id = $key;&nbsp;</div></li><li><div>              $tax_totals[ $code ]-&gt;is_compound = WC_Tax::is_compound( $key );&nbsp;</div></li><li><div>              $tax_totals[ $code ]-&gt;label = WC_Tax::get_rate_label( $key );&nbsp;</div></li><li><div>              $tax_totals[ $code ]-&gt;amount           += wc_round_tax_total( $tax );&nbsp;</div></li><li><div>              $tax_totals[ $code ]-&gt;formatted_amount = wc_price( wc_round_tax_total( $tax_totals[ $code ]-&gt;amount ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( apply_filters( 'woocommerce_cart_hide_zero_taxes', true ) ) {&nbsp;</div></li><li><div>          $amounts = array_filter( wp_list_pluck( $tax_totals, 'amount' ) );&nbsp;</div></li><li><div>          $tax_totals = array_intersect_key( $tax_totals, $amounts );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_tax_totals', $tax_totals, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get all tax classes for items in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_item_tax_classes() {&nbsp;</div></li><li><div>      $found_tax_classes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( WC()-&gt;cart-&gt;get_cart() as $item ) {&nbsp;</div></li><li><div>          $found_tax_classes[] = $item['data']-&gt;get_tax_class();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_unique( $found_tax_classes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determines the value that the customer spent and the subtotal</span>&nbsp;</div></li><li><div><span class="comment">   * displayed, used for things like coupon validation.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Since the coupon lines are displayed based on the TAX DISPLAY value</span>&nbsp;</div></li><li><div><span class="comment">   * of cart, this is used to determine the spend.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * If cart totals are shown including tax, use the subtotal.</span>&nbsp;</div></li><li><div><span class="comment">   * If cart totals are shown excluding tax, use the subtotal ex tax</span>&nbsp;</div></li><li><div><span class="comment">   * (tax is shown after coupons).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_displayed_subtotal() {&nbsp;</div></li><li><div>      if ( 'incl' === $this-&gt;tax_display_cart ) {&nbsp;</div></li><li><div>          return wc_format_decimal( $this-&gt;subtotal );&nbsp;</div></li><li><div>      } elseif ( 'excl' === $this-&gt;tax_display_cart ) {&nbsp;</div></li><li><div>          return wc_format_decimal( $this-&gt;subtotal_ex_tax );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add to cart handling.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if product is in the cart and return cart item key.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Cart item key will be unique based on the item and its properties, such as variations.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed id of product to find in the cart</span>&nbsp;</div></li><li><div><span class="comment">   * @return string cart item key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function find_product_in_cart( $cart_id = false ) {&nbsp;</div></li><li><div>      if ( false !== $cart_id ) {&nbsp;</div></li><li><div>          if ( is_array( $this-&gt;cart_contents ) && isset( $this-&gt;cart_contents[ $cart_id ] ) ) {&nbsp;</div></li><li><div>              return $cart_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generate a unique ID for the cart item being added.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $product_id - id of the product the key is being generated for</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $variation_id of the product the key is being generated for</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $variation data for the cart item</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $cart_item_data other cart item data passed which affects this items uniqueness in the cart</span>&nbsp;</div></li><li><div><span class="comment">   * @return string cart item key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function generate_cart_id( $product_id, $variation_id = 0, $variation = array(), $cart_item_data = array() ) {&nbsp;</div></li><li><div>      $id_parts = array( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $variation_id && 0 != $variation_id ) {&nbsp;</div></li><li><div>          $id_parts[] = $variation_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $variation ) && ! empty( $variation ) ) {&nbsp;</div></li><li><div>          $variation_key = '';&nbsp;</div></li><li><div>          foreach ( $variation as $key =&gt; $value ) {&nbsp;</div></li><li><div>              $variation_key .= trim( $key ) . trim( $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $id_parts[] = $variation_key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_array( $cart_item_data ) && ! empty( $cart_item_data ) ) {&nbsp;</div></li><li><div>          $cart_item_data_key = '';&nbsp;</div></li><li><div>          foreach ( $cart_item_data as $key =&gt; $value ) {&nbsp;</div></li><li><div>              if ( is_array( $value ) || is_object( $value ) ) {&nbsp;</div></li><li><div>                  $value = http_build_query( $value );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $cart_item_data_key .= trim( $key ) . trim( $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $id_parts[] = $cart_item_data_key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_id', md5( implode( '_', $id_parts ) ), $product_id, $variation_id, $variation, $cart_item_data );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a product to the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $product_id contains the id of the product to add to the cart</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $quantity contains the quantity of the item to add</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $variation_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $variation attribute values</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $cart_item_data extra cart item data we want to pass into the item</span>&nbsp;</div></li><li><div><span class="comment">   * @return string|bool $cart_item_key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_to_cart( $product_id = 0, $quantity = 1, $variation_id = 0, $variation = array(), $cart_item_data = array() ) {&nbsp;</div></li><li><div>      <span class="comment">// Wrap in try catch so plugins can throw an exception to prevent adding to cart</span>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>          $product_id = absint( $product_id );&nbsp;</div></li><li><div>          $variation_id = absint( $variation_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Ensure we don't add a variation to the cart directly by variation ID</span>&nbsp;</div></li><li><div>          if ( 'product_variation' === get_post_type( $product_id ) ) {&nbsp;</div></li><li><div>              $variation_id = $product_id;&nbsp;</div></li><li><div>              $product_id = wp_get_post_parent_id( $variation_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Get the product</span>&nbsp;</div></li><li><div>          $product_data = wc_get_product( $variation_id ? $variation_id : $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Sanity check</span>&nbsp;</div></li><li><div>          if ( $quantity &lt;= 0 || ! $product_data || 'trash' === $product_data-&gt;get_status() ) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Load cart item data - may be added by other plugins</span>&nbsp;</div></li><li><div>          $cart_item_data = (array) apply_filters( 'woocommerce_add_cart_item_data', $cart_item_data, $product_id, $variation_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Generate a ID based on product ID, variation ID, variation data, and other cart item data</span>&nbsp;</div></li><li><div>          $cart_id = $this-&gt;generate_cart_id( $product_id, $variation_id, $variation, $cart_item_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Find the cart item key in the existing cart</span>&nbsp;</div></li><li><div>          $cart_item_key = $this-&gt;find_product_in_cart( $cart_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Force quantity to 1 if sold individually and check for existing item in cart</span>&nbsp;</div></li><li><div>          if ( $product_data-&gt;is_sold_individually() ) {&nbsp;</div></li><li><div>              $quantity = apply_filters( 'woocommerce_add_to_cart_sold_individually_quantity', 1, $quantity, $product_id, $variation_id, $cart_item_data );&nbsp;</div></li><li><div>              $in_cart_quantity = $cart_item_key ? $this-&gt;cart_contents[ $cart_item_key ]['quantity'] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $in_cart_quantity &gt; 0 ) {&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">/** translators: %s: product name */</span></span></span>&nbsp;</div></li><li><div>                  throw new Exception( sprintf( '&lt;a href=&quot;%s&quot; class=&quot;button wc-forward&quot;&gt;%s&lt;/a&gt; %s', wc_get_cart_url(), __( 'View cart', 'woocommerce' ), sprintf( __( 'You cannot add another &quot;%s&quot; to your cart.', 'woocommerce' ), $product_data-&gt;get_name() ) ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Check product is_purchasable</span>&nbsp;</div></li><li><div>          if ( ! $product_data-&gt;is_purchasable() ) {&nbsp;</div></li><li><div>              throw new Exception( __( 'Sorry, this product cannot be purchased.', 'woocommerce' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Stock check - only check if we're managing stock and backorders are not allowed</span>&nbsp;</div></li><li><div>          if ( ! $product_data-&gt;is_in_stock() ) {&nbsp;</div></li><li><div>              throw new Exception( sprintf( __( 'You cannot add &quot;%s&quot; to the cart because the product is out of stock.', 'woocommerce' ), $product_data-&gt;get_name() ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $product_data-&gt;has_enough_stock( $quantity ) ) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">/** translators: 1: product name 2: quantity in stock */</span></span>&nbsp;</div></li><li><div>              throw new Exception( sprintf( __( 'You cannot add that amount of &quot;%1$s&quot; to the cart because there is not enough stock (%2$s remaining).', 'woocommerce' ), $product_data-&gt;get_name(), wc_format_stock_quantity_for_display( $product_data-&gt;get_stock_quantity(), $product_data ) ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Stock check - this time accounting for whats already in-cart</span>&nbsp;</div></li><li><div>          if ( $product_data-&gt;managing_stock() ) {&nbsp;</div></li><li><div>              $products_qty_in_cart = $this-&gt;get_cart_item_quantities();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( isset( $products_qty_in_cart[ $product_data-&gt;get_stock_managed_by_id() ] ) && ! $product_data-&gt;has_enough_stock( $products_qty_in_cart[ $product_data-&gt;get_stock_managed_by_id() ] + $quantity ) ) {&nbsp;</div></li><li><div>                  throw new Exception( sprintf(&nbsp;</div></li><li><div>                      '&lt;a href=&quot;%s&quot; class=&quot;button wc-forward&quot;&gt;%s&lt;/a&gt; %s', &nbsp;</div></li><li><div>                      wc_get_cart_url(), &nbsp;</div></li><li><div>                      __( 'View Cart', 'woocommerce' ), &nbsp;</div></li><li><div>                      sprintf( __( 'You cannot add that amount to the cart &mdash; we have %1$s in stock and you already have %2$s in your cart.', 'woocommerce' ), wc_format_stock_quantity_for_display( $product_data-&gt;get_stock_quantity(), $product_data ), wc_format_stock_quantity_for_display( $products_qty_in_cart[ $product_data-&gt;get_stock_managed_by_id() ], $product_data ) )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If cart_item_key is set, the item is already in the cart</span>&nbsp;</div></li><li><div>          if ( $cart_item_key ) {&nbsp;</div></li><li><div>              $new_quantity = $quantity + $this-&gt;cart_contents[ $cart_item_key ]['quantity'];&nbsp;</div></li><li><div>              $this-&gt;set_quantity( $cart_item_key, $new_quantity, false );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $cart_item_key = $cart_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Add item after merging with $cart_item_data - hook to allow plugins to modify cart item</span>&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ] = apply_filters( 'woocommerce_add_cart_item', array_merge( $cart_item_data, array(&nbsp;</div></li><li><div>                  'product_id' =&gt; $product_id, &nbsp;</div></li><li><div>                  'variation_id' =&gt; $variation_id, &nbsp;</div></li><li><div>                  'variation' =&gt; $variation, &nbsp;</div></li><li><div>                  'quantity' =&gt; $quantity, &nbsp;</div></li><li><div>                  'data' =&gt; $product_data, &nbsp;</div></li><li><div> ) ), $cart_item_key );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( did_action( 'wp' ) ) {&nbsp;</div></li><li><div>              $this-&gt;set_cart_cookies( ! $this-&gt;is_empty() );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_add_to_cart', $cart_item_key, $product_id, $quantity, $variation_id, $variation, $cart_item_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return $cart_item_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch ( Exception $e ) {&nbsp;</div></li><li><div>          if ( $e-&gt;getMessage() ) {&nbsp;</div></li><li><div>              wc_add_notice( $e-&gt;getMessage(), 'error' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove a cart item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $cart_item_key</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_cart_item( $cart_item_key ) {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;cart_contents[ $cart_item_key ] ) ) {&nbsp;</div></li><li><div>          $this-&gt;removed_cart_contents[ $cart_item_key ] = $this-&gt;cart_contents[ $cart_item_key ];&nbsp;</div></li><li><div>          unset( $this-&gt;removed_cart_contents[ $cart_item_key ]['data'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_remove_cart_item', $cart_item_key, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          unset( $this-&gt;cart_contents[ $cart_item_key ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_cart_item_removed', $cart_item_key, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;calculate_totals();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Restore a cart item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $cart_item_key</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function restore_cart_item( $cart_item_key ) {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;removed_cart_contents[ $cart_item_key ] ) ) {&nbsp;</div></li><li><div>          $this-&gt;cart_contents[ $cart_item_key ] = $this-&gt;removed_cart_contents[ $cart_item_key ];&nbsp;</div></li><li><div>          $this-&gt;cart_contents[ $cart_item_key ]['data'] = wc_get_product( $this-&gt;cart_contents[ $cart_item_key ]['variation_id'] ? $this-&gt;cart_contents[ $cart_item_key ]['variation_id'] : $this-&gt;cart_contents[ $cart_item_key ]['product_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_restore_cart_item', $cart_item_key, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          unset( $this-&gt;removed_cart_contents[ $cart_item_key ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_cart_item_restored', $cart_item_key, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;calculate_totals();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set the quantity for an item in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string    $cart_item_key    contains the id of the cart item</span>&nbsp;</div></li><li><div><span class="comment">   * @param int        $quantity        contains the quantity of the item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool      $refresh_totals    whether or not to calculate totals after setting the new qty</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_quantity( $cart_item_key, $quantity = 1, $refresh_totals = true ) {&nbsp;</div></li><li><div>      if ( 0 == $quantity || $quantity &lt; 0 ) {&nbsp;</div></li><li><div>          do_action( 'woocommerce_before_cart_item_quantity_zero', $cart_item_key );&nbsp;</div></li><li><div>          unset( $this-&gt;cart_contents[ $cart_item_key ] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $old_quantity = $this-&gt;cart_contents[ $cart_item_key ]['quantity'];&nbsp;</div></li><li><div>          $this-&gt;cart_contents[ $cart_item_key ]['quantity'] = $quantity;&nbsp;</div></li><li><div>          do_action( 'woocommerce_after_cart_item_quantity_update', $cart_item_key, $quantity, $old_quantity );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $refresh_totals ) {&nbsp;</div></li><li><div>          $this-&gt;calculate_totals();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cart Calculation Functions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Reset cart totals to the defaults. Useful before running calculations.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool      $unset_session If true, the session data will be forced unset.</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function reset( $unset_session = false ) {&nbsp;</div></li><li><div>      foreach ( $this-&gt;cart_session_data as $key =&gt; $default ) {&nbsp;</div></li><li><div>          $this-&gt;$key = $default;&nbsp;</div></li><li><div>          if ( $unset_session ) {&nbsp;</div></li><li><div>              unset( WC()-&gt;session-&gt;$key );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      do_action( 'woocommerce_cart_reset', $this, $unset_session );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sort by subtotal.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $a</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $b</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function sort_by_subtotal( $a, $b ) {&nbsp;</div></li><li><div>      $first_item_subtotal = isset( $a['line_subtotal'] ) ? $a['line_subtotal'] : 0;&nbsp;</div></li><li><div>      $second_item_subtotal = isset( $b['line_subtotal'] ) ? $b['line_subtotal'] : 0;&nbsp;</div></li><li><div>      if ( $first_item_subtotal === $second_item_subtotal ) {&nbsp;</div></li><li><div>          return 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return ( $first_item_subtotal &lt; $second_item_subtotal ) ? 1 : -1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate totals for the items in the cart.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function calculate_totals() {&nbsp;</div></li><li><div>      $this-&gt;reset();&nbsp;</div></li><li><div>      $this-&gt;coupons = $this-&gt;get_coupons();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_before_calculate_totals', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;is_empty() ) {&nbsp;</div></li><li><div>          $this-&gt;set_session();&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $tax_rates = array();&nbsp;</div></li><li><div>      $shop_tax_rates = array();&nbsp;</div></li><li><div>      $cart = $this-&gt;get_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Calculate subtotals for items. This is done first so that discount logic can use the values.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      foreach ( $cart as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>          $product = $values['data'];&nbsp;</div></li><li><div>          $line_price = $product-&gt;get_price() * $values['quantity'];&nbsp;</div></li><li><div>          $line_subtotal = 0;&nbsp;</div></li><li><div>          $line_subtotal_tax = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * No tax to calculate.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! $product-&gt;is_taxable() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Subtotal is the undiscounted price</span>&nbsp;</div></li><li><div>              $this-&gt;subtotal += $line_price;&nbsp;</div></li><li><div>              $this-&gt;subtotal_ex_tax += $line_price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Prices include tax.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * To prevent rounding issues we need to work with the inclusive price where possible.</span>&nbsp;</div></li><li><div><span class="comment">           * otherwise we'll see errors such as when working with a 9.99 inc price, 20% VAT which would.</span>&nbsp;</div></li><li><div><span class="comment">           * be 8.325 leading to totals being 1p off.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Pre tax coupons come off the price the customer thinks they are paying - tax is calculated.</span>&nbsp;</div></li><li><div><span class="comment">           * afterwards.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * e.g. $100 bike with $10 coupon = customer pays $90 and tax worked backwards from that.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          } elseif ( $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Get base tax rates</span>&nbsp;</div></li><li><div>              if ( empty( $shop_tax_rates[ $product-&gt;get_tax_class( 'unfiltered' ) ] ) ) {&nbsp;</div></li><li><div>                  $shop_tax_rates[ $product-&gt;get_tax_class( 'unfiltered' ) ] = WC_Tax::get_base_tax_rates( $product-&gt;get_tax_class( 'unfiltered' ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get item tax rates</span></span>&nbsp;</div></li><li><div>              if ( empty( $tax_rates[ $product-&gt;get_tax_class() ] ) ) {&nbsp;</div></li><li><div>                  $tax_rates[ $product-&gt;get_tax_class() ] = WC_Tax::get_rates( $product-&gt;get_tax_class() );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $base_tax_rates = $shop_tax_rates[ $product-&gt;get_tax_class( 'unfiltered' ) ];&nbsp;</div></li><li><div>              $item_tax_rates = $tax_rates[ $product-&gt;get_tax_class() ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * ADJUST TAX - Calculations when base tax is not equal to the item tax.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">                   * The woocommerce_adjust_non_base_location_prices filter can stop base taxes being taken off when dealing with out of base locations.</span>&nbsp;</div></li><li><div><span class="comment">                   * e.g. If a product costs 10 including tax, all users will pay 10 regardless of location and taxes.</span>&nbsp;</div></li><li><div><span class="comment">                   * This feature is experimental @since 2.4.7 and may change in the future. Use at your risk.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>              if ( $item_tax_rates !== $base_tax_rates && apply_filters( 'woocommerce_adjust_non_base_location_prices', true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Work out a new base price without the shop's base tax</span></span></span>&nbsp;</div></li><li><div>                  $taxes = WC_Tax::calc_tax( $line_price, $base_tax_rates, true, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Now we have a new item price (excluding TAX)</span></span></span>&nbsp;</div></li><li><div>                  $line_subtotal = $line_price - array_sum( $taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Now add modified taxes</span>&nbsp;</div></li><li><div>                  $tax_result = WC_Tax::calc_tax( $line_subtotal, $item_tax_rates );&nbsp;</div></li><li><div>                  $line_subtotal_tax = array_sum( $tax_result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Regular tax calculation (customer inside base and the tax class is unmodified.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Calc tax normally</span>&nbsp;</div></li><li><div>                  $taxes = WC_Tax::calc_tax( $line_price, $item_tax_rates, true );&nbsp;</div></li><li><div>                  $line_subtotal_tax = array_sum( $taxes );&nbsp;</div></li><li><div>                  $line_subtotal = $line_price - array_sum( $taxes );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Prices exclude tax.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * This calculation is simpler - work with the base, untaxed price.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get item tax rates</span></span>&nbsp;</div></li><li><div>              if ( empty( $tax_rates[ $product-&gt;get_tax_class() ] ) ) {&nbsp;</div></li><li><div>                  $tax_rates[ $product-&gt;get_tax_class() ] = WC_Tax::get_rates( $product-&gt;get_tax_class() );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $item_tax_rates = $tax_rates[ $product-&gt;get_tax_class() ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Base tax for line before discount - we will store this in the order data</span>&nbsp;</div></li><li><div>              $taxes = WC_Tax::calc_tax( $line_price, $item_tax_rates );&nbsp;</div></li><li><div>              $line_subtotal_tax = array_sum( $taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $line_subtotal = $line_price;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add to main subtotal</span>&nbsp;</div></li><li><div>          $this-&gt;subtotal        += $line_subtotal + $line_subtotal_tax;&nbsp;</div></li><li><div>          $this-&gt;subtotal_ex_tax += $line_subtotal;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Order cart items by price so coupon logic is 'fair' for customers and not based on order added to cart.</span>&nbsp;</div></li><li><div>      uasort( $cart, apply_filters( 'woocommerce_sort_by_subtotal_callback', array( $this, 'sort_by_subtotal' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Calculate totals for items.</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      foreach ( $cart as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $product = $values['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Prices</span>&nbsp;</div></li><li><div>          $base_price = $product-&gt;get_price();&nbsp;</div></li><li><div>          $line_price = $product-&gt;get_price() * $values['quantity'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Tax data</span>&nbsp;</div></li><li><div>          $taxes = array();&nbsp;</div></li><li><div>          $discounted_taxes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * No tax to calculate.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! $product-&gt;is_taxable() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Discounted Price (price with any pre-tax discounts applied)</span>&nbsp;</div></li><li><div>              $discounted_price = $this-&gt;get_discounted_price( $values, $base_price, true );&nbsp;</div></li><li><div>              $line_subtotal_tax = 0;&nbsp;</div></li><li><div>              $line_subtotal = $line_price;&nbsp;</div></li><li><div>              $line_tax = 0;&nbsp;</div></li><li><div>              $line_total = round( $discounted_price * $values['quantity'], wc_get_rounding_precision() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Prices include tax.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          } elseif ( $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $base_tax_rates = $shop_tax_rates[ $product-&gt;get_tax_class( 'unfiltered' ) ];&nbsp;</div></li><li><div>              $item_tax_rates = $tax_rates[ $product-&gt;get_tax_class() ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * ADJUST TAX - Calculations when base tax is not equal to the item tax.</span>&nbsp;</div></li><li><div><span class="comment">               *</span>&nbsp;</div></li><li><div><span class="comment">                   * The woocommerce_adjust_non_base_location_prices filter can stop base taxes being taken off when dealing with out of base locations.</span>&nbsp;</div></li><li><div><span class="comment">                   * e.g. If a product costs 10 including tax, all users will pay 10 regardless of location and taxes.</span>&nbsp;</div></li><li><div><span class="comment">                   * This feature is experimental @since 2.4.7 and may change in the future. Use at your risk.</span>&nbsp;</div></li><li><div><span class="comment">                   */</span>&nbsp;</div></li><li><div>              if ( $item_tax_rates !== $base_tax_rates && apply_filters( 'woocommerce_adjust_non_base_location_prices', true ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Work out a new base price without the shop's base tax</span></span></span>&nbsp;</div></li><li><div>                  $taxes = WC_Tax::calc_tax( $line_price, $base_tax_rates, true, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Now we have a new item price (excluding TAX)</span></span></span>&nbsp;</div></li><li><div>                  $line_subtotal = round( $line_price - array_sum( $taxes ), wc_get_rounding_precision() );&nbsp;</div></li><li><div>                  $taxes = WC_Tax::calc_tax( $line_subtotal, $item_tax_rates );&nbsp;</div></li><li><div>                  $line_subtotal_tax = array_sum( $taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Adjusted price (this is the price including the new tax rate)</span>&nbsp;</div></li><li><div>                  $adjusted_price = ( $line_subtotal + $line_subtotal_tax ) / $values['quantity'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Apply discounts and get the discounted price FOR A SINGLE ITEM</span>&nbsp;</div></li><li><div>                  $discounted_price = $this-&gt;get_discounted_price( $values, $adjusted_price, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Convert back to line price</span></span>&nbsp;</div></li><li><div>                  $discounted_line_price = $discounted_price * $values['quantity'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Now use rounded line price to get taxes.</span></span>&nbsp;</div></li><li><div>                  $discounted_taxes = WC_Tax::calc_tax( $discounted_line_price, $item_tax_rates, true );&nbsp;</div></li><li><div>                  $line_tax = array_sum( $discounted_taxes );&nbsp;</div></li><li><div>                  $line_total = $discounted_line_price - $line_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * Regular tax calculation (customer inside base and the tax class is unmodified.</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Work out a new base price without the item tax</span>&nbsp;</div></li><li><div>                  $taxes = WC_Tax::calc_tax( $line_price, $item_tax_rates, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment"><span class="comment">// Now we have a new item price (excluding TAX)</span></span></span>&nbsp;</div></li><li><div>                  $line_subtotal = $line_price - array_sum( $taxes );&nbsp;</div></li><li><div>                  $line_subtotal_tax = array_sum( $taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Calc prices and tax (discounted)</span>&nbsp;</div></li><li><div>                  $discounted_price = $this-&gt;get_discounted_price( $values, $base_price, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Convert back to line price</span></span>&nbsp;</div></li><li><div>                  $discounted_line_price = $discounted_price * $values['quantity'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Now use rounded line price to get taxes.</span></span>&nbsp;</div></li><li><div>                  $discounted_taxes = WC_Tax::calc_tax( $discounted_line_price, $item_tax_rates, true );&nbsp;</div></li><li><div>                  $line_tax = array_sum( $discounted_taxes );&nbsp;</div></li><li><div>                  $line_total = $discounted_line_price - $line_tax;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Tax rows - merge the totals we just got</span></span></span>&nbsp;</div></li><li><div>              foreach ( array_keys( $this-&gt;taxes + $discounted_taxes ) as $key ) {&nbsp;</div></li><li><div>                  $this-&gt;taxes[ $key ] = ( isset( $discounted_taxes[ $key ] ) ? $discounted_taxes[ $key ] : 0 ) + ( isset( $this-&gt;taxes[ $key ] ) ? $this-&gt;taxes[ $key ] : 0 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Prices exclude tax.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $item_tax_rates = $tax_rates[ $product-&gt;get_tax_class() ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Work out a new base price without the shop's base tax</span></span></span>&nbsp;</div></li><li><div>              $taxes = WC_Tax::calc_tax( $line_price, $item_tax_rates );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Now we have the item price (excluding TAX)</span>&nbsp;</div></li><li><div>              $line_subtotal = $line_price;&nbsp;</div></li><li><div>              $line_subtotal_tax = array_sum( $taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Now calc product rates</span>&nbsp;</div></li><li><div>              $discounted_price = $this-&gt;get_discounted_price( $values, $base_price, true );&nbsp;</div></li><li><div>              $discounted_taxes = WC_Tax::calc_tax( $discounted_price * $values['quantity'], $item_tax_rates );&nbsp;</div></li><li><div>              $discounted_tax_amount = array_sum( $discounted_taxes );&nbsp;</div></li><li><div>              $line_tax = $discounted_tax_amount;&nbsp;</div></li><li><div>              $line_total = $discounted_price * $values['quantity'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// Tax rows - merge the totals we just got</span></span></span>&nbsp;</div></li><li><div>              foreach ( array_keys( $this-&gt;taxes + $discounted_taxes ) as $key ) {&nbsp;</div></li><li><div>                  $this-&gt;taxes[ $key ] = ( isset( $discounted_taxes[ $key ] ) ? $discounted_taxes[ $key ] : 0 ) + ( isset( $this-&gt;taxes[ $key ] ) ? $this-&gt;taxes[ $key ] : 0 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Cart contents total is based on discounted prices and is used for the final total calculation</span>&nbsp;</div></li><li><div>          $this-&gt;cart_contents_total += $line_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * Store costs + taxes for lines. For tax inclusive prices, we do some extra rounding logic so the stored</span>&nbsp;</div></li><li><div><span class="comment">           * values &quot;add up&quot; when viewing the order in admin. This does have the disadvatage of not being able to</span>&nbsp;</div></li><li><div><span class="comment">           * recalculate the tax total/subtotal accurately in the future, but it does ensure the data looks correct.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * Tax exclusive prices are not affected.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          if ( ! $product-&gt;is_taxable() || $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_total'] = round( $line_total + $line_tax - wc_round_tax_total( $line_tax ), $this-&gt;dp );&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_subtotal'] = round( $line_subtotal + $line_subtotal_tax - wc_round_tax_total( $line_subtotal_tax ), $this-&gt;dp );&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_tax'] = wc_round_tax_total( $line_tax );&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_subtotal_tax'] = wc_round_tax_total( $line_subtotal_tax );&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_tax_data'] = array( 'total' =&gt; array_map( 'wc_round_tax_total', $discounted_taxes ), 'subtotal' =&gt; array_map( 'wc_round_tax_total', $taxes ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_total'] = $line_total;&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_subtotal'] = $line_subtotal;&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_tax'] = $line_tax;&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_subtotal_tax'] = $line_subtotal_tax;&nbsp;</div></li><li><div>              $this-&gt;cart_contents[ $cart_item_key ]['line_tax_data'] = array( 'total' =&gt; $discounted_taxes, 'subtotal' =&gt; $taxes );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only calculate the grand total + shipping if on the cart/checkout</span>&nbsp;</div></li><li><div>      if ( is_checkout() || is_cart() || defined( 'WOOCOMMERCE_CHECKOUT' ) || defined( 'WOOCOMMERCE_CART' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Calculate the Shipping</span>&nbsp;</div></li><li><div>          $this-&gt;calculate_shipping();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Trigger the fees API where developers can add fees to the cart</span>&nbsp;</div></li><li><div>          $this-&gt;calculate_fees();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Total up/round taxes and shipping taxes</span>&nbsp;</div></li><li><div>          if ( $this-&gt;round_at_subtotal ) {&nbsp;</div></li><li><div>              $this-&gt;tax_total = WC_Tax::get_tax_total( $this-&gt;taxes );&nbsp;</div></li><li><div>              $this-&gt;shipping_tax_total = WC_Tax::get_tax_total( $this-&gt;shipping_taxes );&nbsp;</div></li><li><div>              $this-&gt;taxes = array_map( array( 'WC_Tax', 'round' ), $this-&gt;taxes );&nbsp;</div></li><li><div>              $this-&gt;shipping_taxes = array_map( array( 'WC_Tax', 'round' ), $this-&gt;shipping_taxes );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;tax_total = array_sum( $this-&gt;taxes );&nbsp;</div></li><li><div>              $this-&gt;shipping_tax_total = array_sum( $this-&gt;shipping_taxes );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// VAT exemption done at this point - so all totals are correct before exemption</span></span>&nbsp;</div></li><li><div>          if ( WC()-&gt;customer-&gt;get_is_vat_exempt() ) {&nbsp;</div></li><li><div>              $this-&gt;remove_taxes();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Allow plugins to hook and alter totals before final total is calculated</span>&nbsp;</div></li><li><div>          do_action( 'woocommerce_calculate_totals', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Grand Total - Discounted product prices, discounted tax, shipping cost + tax</span>&nbsp;</div></li><li><div>          $this-&gt;total = max( 0, apply_filters( 'woocommerce_calculated_total', round( $this-&gt;cart_contents_total + $this-&gt;tax_total + $this-&gt;shipping_tax_total + $this-&gt;shipping_total + $this-&gt;fee_total, $this-&gt;dp ), $this ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set tax total to sum of all tax rows</span>&nbsp;</div></li><li><div>          $this-&gt;tax_total = WC_Tax::get_tax_total( $this-&gt;taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// VAT exemption done at this point - so all totals are correct before exemption</span></span>&nbsp;</div></li><li><div>          if ( WC()-&gt;customer-&gt;get_is_vat_exempt() ) {&nbsp;</div></li><li><div>              $this-&gt;remove_taxes();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_after_calculate_totals', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;set_session();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove taxes.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_taxes() {&nbsp;</div></li><li><div>      $this-&gt;shipping_tax_total = $this-&gt;tax_total = 0;&nbsp;</div></li><li><div>      $this-&gt;subtotal = $this-&gt;subtotal_ex_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;cart_contents as $cart_item_key =&gt; $item ) {&nbsp;</div></li><li><div>          $this-&gt;cart_contents[ $cart_item_key ]['line_subtotal_tax'] = $this-&gt;cart_contents[ $cart_item_key ]['line_tax'] = 0;&nbsp;</div></li><li><div>          $this-&gt;cart_contents[ $cart_item_key ]['line_tax_data'] = array( 'total' =&gt; array(), 'subtotal' =&gt; array() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If true, zero rate is applied so '0' tax is displayed on the frontend rather than nothing.</span>&nbsp;</div></li><li><div>      if ( apply_filters( 'woocommerce_cart_remove_taxes_apply_zero_rate', true ) ) {&nbsp;</div></li><li><div>          $this-&gt;taxes = $this-&gt;shipping_taxes = array( apply_filters( 'woocommerce_cart_remove_taxes_zero_rate_id', 'zero-rated' ) =&gt; 0 );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;taxes = $this-&gt;shipping_taxes = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Looks at the totals to see if payment is actually required.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function needs_payment() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_needs_payment', $this-&gt;total &gt; 0, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Shipping related functions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Uses the shipping class to calculate shipping then gets the totals when its finished.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function calculate_shipping() {&nbsp;</div></li><li><div>      if ( $this-&gt;needs_shipping() && $this-&gt;show_shipping() ) {&nbsp;</div></li><li><div>          WC()-&gt;shipping-&gt;calculate_shipping( $this-&gt;get_shipping_packages() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          WC()-&gt;shipping-&gt;reset_shipping();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get totals for the chosen shipping method</span>&nbsp;</div></li><li><div>      $this-&gt;shipping_total = WC()-&gt;shipping-&gt;shipping_total;    <span class="comment">// Shipping Total</span>&nbsp;</div></li><li><div>      $this-&gt;shipping_taxes = WC()-&gt;shipping-&gt;shipping_taxes;    <span class="comment">// Shipping Taxes</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter items needing shipping callback.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $item</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function filter_items_needing_shipping( $item ) {&nbsp;</div></li><li><div>      $product = $item['data'];&nbsp;</div></li><li><div>      return $product && $product-&gt;needs_shipping();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get only items that need shipping.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  3.0.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function get_items_needing_shipping() {&nbsp;</div></li><li><div>      return array_filter( $this-&gt;get_cart(), array( $this, 'filter_items_needing_shipping' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get packages to calculate shipping for.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * This lets us calculate costs for carts that are shipped to multiple locations.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Shipping methods are responsible for looping through these packages.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * By default we pass the cart itself as a package - plugins can change this.</span>&nbsp;</div></li><li><div><span class="comment">   * through the filter and break it up.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.5.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of cart items</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_packages() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_shipping_packages', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'contents' =&gt; $this-&gt;get_items_needing_shipping(), &nbsp;</div></li><li><div>                  'contents_cost' =&gt; array_sum( wp_list_pluck( $this-&gt;get_items_needing_shipping(), 'line_total' ) ), &nbsp;</div></li><li><div>                  'applied_coupons' =&gt; $this-&gt;applied_coupons, &nbsp;</div></li><li><div>                  'user' =&gt; array(&nbsp;</div></li><li><div>                      'ID' =&gt; get_current_user_id(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                  'destination' =&gt; array(&nbsp;</div></li><li><div>                      'country' =&gt; WC()-&gt;customer-&gt;get_shipping_country(), &nbsp;</div></li><li><div>                      'state' =&gt; WC()-&gt;customer-&gt;get_shipping_state(), &nbsp;</div></li><li><div>                      'postcode' =&gt; WC()-&gt;customer-&gt;get_shipping_postcode(), &nbsp;</div></li><li><div>                      'city' =&gt; WC()-&gt;customer-&gt;get_shipping_city(), &nbsp;</div></li><li><div>                      'address' =&gt; WC()-&gt;customer-&gt;get_shipping_address(), &nbsp;</div></li><li><div>                      'address_2' =&gt; WC()-&gt;customer-&gt;get_shipping_address_2(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Looks through the cart to see if shipping is actually required.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool whether or not the cart needs shipping</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function needs_shipping() {&nbsp;</div></li><li><div>      if ( ! wc_shipping_enabled() || 0 === wc_get_shipping_method_count( true ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $needs_shipping = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;cart_contents ) ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;cart_contents as $cart_item_key =&gt; $values ) {&nbsp;</div></li><li><div>              if ( $values['data']-&gt;needs_shipping() ) {&nbsp;</div></li><li><div>                  $needs_shipping = true;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_needs_shipping', $needs_shipping );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Should the shipping address form be shown.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function needs_shipping_address() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $needs_shipping_address = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;needs_shipping() === true && ! wc_ship_to_billing_address_only() ) {&nbsp;</div></li><li><div>          $needs_shipping_address = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_needs_shipping_address', $needs_shipping_address );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sees if the customer has entered enough data to calc the shipping yet.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function show_shipping() {&nbsp;</div></li><li><div>      if ( ! wc_shipping_enabled() || ! is_array( $this-&gt;cart_contents ) )&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' === get_option( 'woocommerce_shipping_cost_requires_address' ) ) {&nbsp;</div></li><li><div>          if ( ! WC()-&gt;customer-&gt;has_calculated_shipping() ) {&nbsp;</div></li><li><div>              if ( ! WC()-&gt;customer-&gt;get_shipping_country() || ( ! WC()-&gt;customer-&gt;get_shipping_state() && ! WC()-&gt;customer-&gt;get_shipping_postcode() ) ) {&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_ready_to_calc_shipping', true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sees if we need a shipping address.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 2.5.0 in favor to wc_ship_to_billing_address_only()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function ship_to_billing_address_only() {&nbsp;</div></li><li><div>      return wc_ship_to_billing_address_only();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the shipping total (after calculation).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string price or string for the shipping total</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_shipping_total() {&nbsp;</div></li><li><div>      if ( isset( $this-&gt;shipping_total ) ) {&nbsp;</div></li><li><div>          if ( $this-&gt;shipping_total &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Display varies depending on settings</span></span>&nbsp;</div></li><li><div>              if ( 'excl' === $this-&gt;tax_display_cart ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $return = wc_price( $this-&gt;shipping_total );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;shipping_tax_total &gt; 0 && $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                      $return .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;ex_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $return = wc_price( $this-&gt;shipping_total + $this-&gt;shipping_tax_total );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $this-&gt;shipping_tax_total &gt; 0 && ! $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                      $return .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;inc_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return __( 'Free!', 'woocommerce' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Coupons/Discount related functions.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check for user coupons (now that we have billing email). If a coupon is invalid, add an error.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Checks two types of coupons:</span>&nbsp;</div></li><li><div><span class="comment">   *  1. Where a list of customer emails are set (limits coupon usage to those defined).</span>&nbsp;</div></li><li><div><span class="comment">   *  2. Where a usage_limit_per_user is set (limits coupon usage to a number based on user ID and email).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $posted</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_customer_coupons( $posted ) {&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;applied_coupons ) ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;applied_coupons as $code ) {&nbsp;</div></li><li><div>              $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $coupon-&gt;is_valid() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Limit to defined email addresses</span>&nbsp;</div></li><li><div>                  if ( is_array( $coupon-&gt;get_email_restrictions() ) && sizeof( $coupon-&gt;get_email_restrictions() ) &gt; 0 ) {&nbsp;</div></li><li><div>                      $check_emails = array();&nbsp;</div></li><li><div>                      if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>                          $current_user = wp_get_current_user();&nbsp;</div></li><li><div>                          $check_emails[] = $current_user-&gt;user_email;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $check_emails[] = $posted['billing_email'];&nbsp;</div></li><li><div>                      $check_emails = array_map( 'sanitize_email', array_map( 'strtolower', $check_emails ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( 0 == sizeof( array_intersect( $check_emails, $coupon-&gt;get_email_restrictions() ) ) ) {&nbsp;</div></li><li><div>                          $coupon-&gt;add_coupon_message( WC_Coupon::E_WC_COUPON_NOT_YOURS_REMOVED );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment">// Remove the coupon</span></span></span>&nbsp;</div></li><li><div>                          $this-&gt;remove_coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment">// Flag totals for refresh</span></span></span>&nbsp;</div></li><li><div>                          WC()-&gt;session-&gt;set( 'refresh_totals', true );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Usage limits per user - check against billing and user email and user ID</span>&nbsp;</div></li><li><div>                  if ( $coupon-&gt;get_usage_limit_per_user() &gt; 0 ) {&nbsp;</div></li><li><div>                      $check_emails = array();&nbsp;</div></li><li><div>                      $used_by = $coupon-&gt;get_used_by();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>                          $current_user = wp_get_current_user();&nbsp;</div></li><li><div>                          $check_emails[] = sanitize_email( $current_user-&gt;user_email );&nbsp;</div></li><li><div>                          $usage_count = sizeof( array_keys( $used_by, get_current_user_id() ) );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $check_emails[] = sanitize_email( $posted['billing_email'] );&nbsp;</div></li><li><div>                          $user = get_user_by( 'email', $posted['billing_email'] );&nbsp;</div></li><li><div>                          if ( $user ) {&nbsp;</div></li><li><div>                              $usage_count = sizeof( array_keys( $used_by, $user-&gt;ID ) );&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              $usage_count = 0;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $check_emails as $check_email ) {&nbsp;</div></li><li><div>                          $usage_count = $usage_count + sizeof( array_keys( $used_by, $check_email ) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $usage_count &gt;= $coupon-&gt;get_usage_limit_per_user() ) {&nbsp;</div></li><li><div>                          $coupon-&gt;add_coupon_message( WC_Coupon::E_WC_COUPON_USAGE_LIMIT_REACHED );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment">// Remove the coupon</span></span></span>&nbsp;</div></li><li><div>                          $this-&gt;remove_coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment"><span class="comment">// Flag totals for refresh</span></span></span>&nbsp;</div></li><li><div>                          WC()-&gt;session-&gt;set( 'refresh_totals', true );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns whether or not a discount has been applied.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $coupon_code</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_discount( $coupon_code = '' ) {&nbsp;</div></li><li><div>      return $coupon_code ? in_array( wc_format_coupon_code( $coupon_code ), $this-&gt;applied_coupons ) : sizeof( $this-&gt;applied_coupons ) &gt; 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Applies a coupon code passed to the method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $coupon_code - The code to apply</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool    True if the coupon is applied, false if it does not exist or cannot be applied</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_discount( $coupon_code ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Coupons are globally disabled</span>.</span>&nbsp;</div></li><li><div>      if ( ! wc_coupons_enabled() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Sanitize coupon code.</span>&nbsp;</div></li><li><div>      $coupon_code = wc_format_coupon_code( $coupon_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get the coupon</span>.</span>&nbsp;</div></li><li><div>      $the_coupon = new WC_Coupon( $coupon_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check it can be used with cart.</span>&nbsp;</div></li><li><div>      if ( ! $the_coupon-&gt;is_valid() ) {&nbsp;</div></li><li><div>          wc_add_notice( $the_coupon-&gt;get_error_message(), 'error' );&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if applied.</span>&nbsp;</div></li><li><div>      if ( $this-&gt;has_discount( $coupon_code ) ) {&nbsp;</div></li><li><div>          $the_coupon-&gt;add_coupon_message( WC_Coupon::E_WC_COUPON_ALREADY_APPLIED );&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If its individual use then remove other coupons.</span>&nbsp;</div></li><li><div>      if ( $the_coupon-&gt;get_individual_use() ) {&nbsp;</div></li><li><div>          $coupons_to_keep = apply_filters( 'woocommerce_apply_individual_use_coupon', array(), $the_coupon, $this-&gt;applied_coupons );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;applied_coupons as $applied_coupon ) {&nbsp;</div></li><li><div>              $keep_key = array_search( $applied_coupon, $coupons_to_keep );&nbsp;</div></li><li><div>              if ( false === $keep_key ) {&nbsp;</div></li><li><div>                  $this-&gt;remove_coupon( $applied_coupon );&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  unset( $coupons_to_keep[ $keep_key ] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $coupons_to_keep ) ) {&nbsp;</div></li><li><div>              $this-&gt;applied_coupons += $coupons_to_keep;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check to see if an individual use coupon is set.</span>&nbsp;</div></li><li><div>      if ( $this-&gt;applied_coupons ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;applied_coupons as $code ) {&nbsp;</div></li><li><div>              $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $coupon-&gt;get_individual_use() && false === apply_filters( 'woocommerce_apply_with_individual_use_coupon', false, $the_coupon, $coupon, $this-&gt;applied_coupons ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Reject new coupon.</span>&nbsp;</div></li><li><div>                  $coupon-&gt;add_coupon_message( WC_Coupon::E_WC_COUPON_ALREADY_APPLIED_INDIV_USE_ONLY );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  return false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;applied_coupons[] = $coupon_code;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Choose free shipping.</span>&nbsp;</div></li><li><div>      if ( $the_coupon-&gt;get_free_shipping() ) {&nbsp;</div></li><li><div>          $packages = WC()-&gt;shipping-&gt;get_packages();&nbsp;</div></li><li><div>          $chosen_shipping_methods = WC()-&gt;session-&gt;get( 'chosen_shipping_methods' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $packages as $i =&gt; $package ) {&nbsp;</div></li><li><div>              $chosen_shipping_methods[ $i ] = 'free_shipping';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set( 'chosen_shipping_methods', $chosen_shipping_methods );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $the_coupon-&gt;add_coupon_message( WC_Coupon::WC_COUPON_SUCCESS );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_applied_coupon', $coupon_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get array of applied coupon objects and codes.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of applied coupons</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_coupons( $deprecated = null ) {&nbsp;</div></li><li><div>      $coupons = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'order' === $deprecated ) {&nbsp;</div></li><li><div>          return $coupons;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_applied_coupons() as $code ) {&nbsp;</div></li><li><div>          $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>          $coupons[ $code ] = $coupon;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $coupons;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the array of applied coupon codes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of applied coupons</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_applied_coupons() {&nbsp;</div></li><li><div>      return $this-&gt;applied_coupons;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the discount amount for a used coupon.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $code coupon code</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $ex_tax inc or ex tax</span>&nbsp;</div></li><li><div><span class="comment">   * @return float discount amount</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_coupon_discount_amount( $code, $ex_tax = true ) {&nbsp;</div></li><li><div>      $discount_amount = isset( $this-&gt;coupon_discount_amounts[ $code ] ) ? $this-&gt;coupon_discount_amounts[ $code ] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $ex_tax ) {&nbsp;</div></li><li><div>          $discount_amount += $this-&gt;get_coupon_discount_tax_amount( $code );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return wc_cart_round_discount( $discount_amount, $this-&gt;dp );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the discount tax amount for a used coupon (for tax inclusive prices).</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $code coupon code</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool inc or ex tax</span>&nbsp;</div></li><li><div><span class="comment">   * @return float discount amount</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_coupon_discount_tax_amount( $code ) {&nbsp;</div></li><li><div>      return wc_cart_round_discount( isset( $this-&gt;coupon_discount_tax_amounts[ $code ] ) ? $this-&gt;coupon_discount_tax_amounts[ $code ] : 0, $this-&gt;dp );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove coupons from the cart of a defined type. Type 1 is before tax, type 2 is after tax.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_coupons( $deprecated = null ) {&nbsp;</div></li><li><div>      $this-&gt;applied_coupons = $this-&gt;coupon_discount_amounts = $this-&gt;coupon_discount_tax_amounts = $this-&gt;coupon_applied_count = array();&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'applied_coupons', array() );&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'coupon_discount_amounts', array() );&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'coupon_discount_tax_amounts', array() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove a single coupon by code.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $coupon_code Code of the coupon to remove</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_coupon( $coupon_code ) {&nbsp;</div></li><li><div>      <span class="comment">// Coupons are globally disabled</span>&nbsp;</div></li><li><div>      if ( ! wc_coupons_enabled() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the coupon</span>&nbsp;</div></li><li><div>      $coupon_code = wc_format_coupon_code( $coupon_code );&nbsp;</div></li><li><div>      $position = array_search( $coupon_code, $this-&gt;applied_coupons );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== $position ) {&nbsp;</div></li><li><div>          unset( $this-&gt;applied_coupons[ $position ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'applied_coupons', $this-&gt;applied_coupons );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_removed_coupon', $coupon_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function to apply discounts to a product and get the discounted price (before tax is applied).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $values</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $price</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $add_totals (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @return float price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_discounted_price( $values, $price, $add_totals = false ) {&nbsp;</div></li><li><div>      if ( ! $price ) {&nbsp;</div></li><li><div>          return $price;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $undiscounted_price = $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;coupons ) ) {&nbsp;</div></li><li><div>          $product = $values['data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;coupons as $code =&gt; $coupon ) {&nbsp;</div></li><li><div>              if ( $coupon-&gt;is_valid() && ( $coupon-&gt;is_valid_for_product( $product, $values ) || $coupon-&gt;is_valid_for_cart() ) ) {&nbsp;</div></li><li><div>                  $discount_amount = $coupon-&gt;get_discount_amount( 'yes' === get_option( 'woocommerce_calc_discounts_sequentially', 'no' ) ? $price : $undiscounted_price, $values, true );&nbsp;</div></li><li><div>                  $discount_amount = min( $price, $discount_amount );&nbsp;</div></li><li><div>                  $price = max( $price - $discount_amount, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Store the totals for DISPLAY in the cart.</span>&nbsp;</div></li><li><div>                  if ( $add_totals ) {&nbsp;</div></li><li><div>                      $total_discount = $discount_amount * $values['quantity'];&nbsp;</div></li><li><div>                      $total_discount_tax = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( wc_tax_enabled() && $product-&gt;is_taxable() ) {&nbsp;</div></li><li><div>                          $tax_rates = WC_Tax::get_rates( $product-&gt;get_tax_class() );&nbsp;</div></li><li><div>                          $taxes = WC_Tax::calc_tax( $discount_amount, $tax_rates, $this-&gt;prices_include_tax );&nbsp;</div></li><li><div>                          $total_discount_tax = WC_Tax::get_tax_total( $taxes ) * $values['quantity'];&nbsp;</div></li><li><div>                          $total_discount = $this-&gt;prices_include_tax ? $total_discount - $total_discount_tax : $total_discount;&nbsp;</div></li><li><div>                          $this-&gt;discount_cart_tax += $total_discount_tax;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $this-&gt;discount_cart     += $total_discount;&nbsp;</div></li><li><div>                      $this-&gt;increase_coupon_discount_amount( $code, $total_discount, $total_discount_tax );&nbsp;</div></li><li><div>                      $this-&gt;increase_coupon_applied_count( $code, $values['quantity'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// If the price is 0, we can stop going through coupons because there is nothing more to discount for this product.</span>&nbsp;</div></li><li><div>              if ( 0 &gt;= $price ) {&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_discounted_price', $price, $values, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Store how much discount each coupon grants.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $code</span>&nbsp;</div></li><li><div><span class="comment">   * @param double $amount</span>&nbsp;</div></li><li><div><span class="comment">   * @param double $tax</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function increase_coupon_discount_amount( $code, $amount, $tax ) {&nbsp;</div></li><li><div>      $this-&gt;coupon_discount_amounts[ $code ]     = isset( $this-&gt;coupon_discount_amounts[ $code ] ) ? $this-&gt;coupon_discount_amounts[ $code ] + $amount : $amount;&nbsp;</div></li><li><div>      $this-&gt;coupon_discount_tax_amounts[ $code ] = isset( $this-&gt;coupon_discount_tax_amounts[ $code ] ) ? $this-&gt;coupon_discount_tax_amounts[ $code ] + $tax : $tax;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Store how many times each coupon is applied to cart/items.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $code</span>&nbsp;</div></li><li><div><span class="comment">   * @param int    $count</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function increase_coupon_applied_count( $code, $count = 1 ) {&nbsp;</div></li><li><div>      if ( empty( $this-&gt;coupon_applied_count[ $code ] ) ) {&nbsp;</div></li><li><div>          $this-&gt;coupon_applied_count[ $code ] = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;coupon_applied_count[ $code ] += $count;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Fees API to add additional costs to orders.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add additional fee to the cart.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Fee is an amount of money charged for a particular piece of work</span>&nbsp;</div></li><li><div><span class="comment">   * or for a particular right or service, and not supposed to be negative.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name      Unique name for the fee. Multiple fees of the same name cannot be added.</span>&nbsp;</div></li><li><div><span class="comment">   * @param float  $amount    Fee amount (do not enter negative amounts).</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool   $taxable   Is the fee taxable? (default: false).</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $tax_class The tax class for the fee if taxable. A blank string is standard tax class. (default: '').</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_fee( $name, $amount, $taxable = false, $tax_class = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new_fee_id = sanitize_title( $name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Only add each fee once.</span>&nbsp;</div></li><li><div>      foreach ( $this-&gt;fees as $fee ) {&nbsp;</div></li><li><div>          if ( $fee-&gt;id == $new_fee_id ) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $new_fee = new stdClass();&nbsp;</div></li><li><div>      $new_fee-&gt;id = $new_fee_id;&nbsp;</div></li><li><div>      $new_fee-&gt;name = esc_attr( $name );&nbsp;</div></li><li><div>      $new_fee-&gt;amount = (float) esc_attr( $amount );&nbsp;</div></li><li><div>      $new_fee-&gt;tax_class = $tax_class;&nbsp;</div></li><li><div>      $new_fee-&gt;taxable = $taxable ? true : false;&nbsp;</div></li><li><div>      $new_fee-&gt;tax = 0;&nbsp;</div></li><li><div>      $new_fee-&gt;tax_data = array();&nbsp;</div></li><li><div>      $this-&gt;fees[] = $new_fee;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get fees.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_fees() {&nbsp;</div></li><li><div>      return array_filter( (array) $this-&gt;fees );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate fees.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function calculate_fees() {&nbsp;</div></li><li><div>      <span class="comment">// Reset fees before calculation</span>&nbsp;</div></li><li><div>      $this-&gt;fee_total = 0;&nbsp;</div></li><li><div>      $this-&gt;fees = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fire an action where developers can add their fees</span>&nbsp;</div></li><li><div>      do_action( 'woocommerce_cart_calculate_fees', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If fees were added, total them and calculate tax</span>&nbsp;</div></li><li><div>      if ( ! empty( $this-&gt;fees ) ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;fees as $fee_key =&gt; $fee ) {&nbsp;</div></li><li><div>              $this-&gt;fee_total += $fee-&gt;amount;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $fee-&gt;taxable ) {&nbsp;</div></li><li><div>                  <span class="comment">// Get tax rates</span>&nbsp;</div></li><li><div>                  $tax_rates = WC_Tax::get_rates( $fee-&gt;tax_class );&nbsp;</div></li><li><div>                  $fee_taxes = WC_Tax::calc_tax( $fee-&gt;amount, $tax_rates, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! empty( $fee_taxes ) ) {&nbsp;</div></li><li><div>                      <span class="comment">// Set the tax total for this fee</span>&nbsp;</div></li><li><div>                      $this-&gt;fees[ $fee_key ]-&gt;tax = array_sum( $fee_taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// Set tax data - Since 2.2</span>&nbsp;</div></li><li><div>                      $this-&gt;fees[ $fee_key ]-&gt;tax_data = $fee_taxes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment"><span class="comment">// Tax rows - merge the totals we just got</span></span></span>&nbsp;</div></li><li><div>                      foreach ( array_keys( $this-&gt;taxes + $fee_taxes ) as $key ) {&nbsp;</div></li><li><div>                          $this-&gt;taxes[ $key ] = ( isset( $fee_taxes[ $key ] ) ? $fee_taxes[ $key ] : 0 ) + ( isset( $this-&gt;taxes[ $key ] ) ? $this-&gt;taxes[ $key ] : 0 );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get Formatted Totals.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the order total (after calculation).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_total', wc_price( $this-&gt;total ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the total excluding taxes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total_ex_tax() {&nbsp;</div></li><li><div>      $total = $this-&gt;total - $this-&gt;tax_total - $this-&gt;shipping_tax_total;&nbsp;</div></li><li><div>      if ( $total &lt; 0 ) {&nbsp;</div></li><li><div>          $total = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_total_ex_tax', wc_price( $total ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the cart contents total (after calculation).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @todo deprecate? It's unused.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_total() {&nbsp;</div></li><li><div>      if ( ! $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>          $cart_contents_total = wc_price( $this-&gt;cart_contents_total );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $cart_contents_total = wc_price( $this-&gt;cart_contents_total + $this-&gt;tax_total );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_contents_total', $cart_contents_total );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the sub total (after calculation).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $compound whether to include compound taxes</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_subtotal( $compound = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the cart has compound tax, we want to show the subtotal as</span>&nbsp;</div></li><li><div>      <span class="comment">// cart + shipping + non-compound taxes (after discount)</span>&nbsp;</div></li><li><div>      if ( $compound ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $cart_subtotal = wc_price( $this-&gt;cart_contents_total + $this-&gt;shipping_total + $this-&gt;get_taxes_total( false, false ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Otherwise we show cart items totals only (before discount)</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Display varies depending on settings</span></span>&nbsp;</div></li><li><div>          if ( 'excl' === $this-&gt;tax_display_cart ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $cart_subtotal = wc_price( $this-&gt;subtotal_ex_tax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;tax_total &gt; 0 && $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                  $cart_subtotal .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;ex_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $cart_subtotal = wc_price( $this-&gt;subtotal );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;tax_total &gt; 0 && ! $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                  $cart_subtotal .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;inc_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_subtotal', $cart_subtotal, $compound, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the product row price per item.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WC_Product $product</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_product_price( $product ) {&nbsp;</div></li><li><div>      if ( 'excl' === $this-&gt;tax_display_cart ) {&nbsp;</div></li><li><div>          $product_price = wc_get_price_excluding_tax( $product );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $product_price = wc_get_price_including_tax( $product );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_product_price', wc_price( $product_price ), $product );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the product row subtotal.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the tax etc to avoid rounding issues.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * When on the checkout (review order), this will get the subtotal based on the customer's tax rate rather than the base rate.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WC_Product $product</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $quantity</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_product_subtotal( $product, $quantity ) {&nbsp;</div></li><li><div>      $price = $product-&gt;get_price();&nbsp;</div></li><li><div>      $taxable = $product-&gt;is_taxable();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Taxable</span>&nbsp;</div></li><li><div>      if ( $taxable ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'excl' === $this-&gt;tax_display_cart ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $row_price = wc_get_price_excluding_tax( $product, array( 'qty' =&gt; $quantity ) );&nbsp;</div></li><li><div>              $product_subtotal = wc_price( $row_price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;prices_include_tax && $this-&gt;tax_total &gt; 0 ) {&nbsp;</div></li><li><div>                  $product_subtotal .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;ex_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $row_price = wc_get_price_including_tax( $product, array( 'qty' =&gt; $quantity ) );&nbsp;</div></li><li><div>              $product_subtotal = wc_price( $row_price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $this-&gt;prices_include_tax && $this-&gt;tax_total &gt; 0 ) {&nbsp;</div></li><li><div>                  $product_subtotal .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;inc_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Non-taxable</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $row_price = $price * $quantity;&nbsp;</div></li><li><div>          $product_subtotal = wc_price( $row_price );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_product_subtotal', $product_subtotal, $product, $quantity, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the cart tax (after calculation).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string formatted price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_tax() {&nbsp;</div></li><li><div>      $cart_total_tax = wc_round_tax_total( $this-&gt;tax_total + $this-&gt;shipping_tax_total );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_cart_tax', $cart_total_tax ? wc_price( $cart_total_tax ) : '' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a tax amount.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $tax_rate_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return float amount</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_tax_amount( $tax_rate_id ) {&nbsp;</div></li><li><div>      return isset( $this-&gt;taxes[ $tax_rate_id ] ) ? $this-&gt;taxes[ $tax_rate_id ] : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a tax amount.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $tax_rate_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return float amount</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_tax_amount( $tax_rate_id ) {&nbsp;</div></li><li><div>      return isset( $this-&gt;shipping_taxes[ $tax_rate_id ] ) ? $this-&gt;shipping_taxes[ $tax_rate_id ] : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get tax row amounts with or without compound taxes includes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $compound True if getting compound taxes</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $display  True if getting total to display</span>&nbsp;</div></li><li><div><span class="comment">   * @return float price</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_taxes_total( $compound = true, $display = true ) {&nbsp;</div></li><li><div>      $total = 0;&nbsp;</div></li><li><div>      foreach ( $this-&gt;taxes as $key =&gt; $tax ) {&nbsp;</div></li><li><div>          if ( ! $compound && WC_Tax::is_compound( $key ) ) continue;&nbsp;</div></li><li><div>          $total += $tax;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach ( $this-&gt;shipping_taxes as $key =&gt; $tax ) {&nbsp;</div></li><li><div>          if ( ! $compound && WC_Tax::is_compound( $key ) ) continue;&nbsp;</div></li><li><div>          $total += $tax;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $display ) {&nbsp;</div></li><li><div>          $total = wc_round_tax_total( $total );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_taxes_total', $total, $compound, $display, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the total of all cart discounts.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_discount_total() {&nbsp;</div></li><li><div>      return wc_cart_round_discount( $this-&gt;discount_cart, $this-&gt;dp );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the total of all cart tax discounts (used for discounts on tax inclusive prices).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_discount_tax_total() {&nbsp;</div></li><li><div>      return wc_cart_round_discount( $this-&gt;discount_cart_tax, $this-&gt;dp );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the total discount amount - both kinds.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed formatted price or false if there are none</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total_discount() {&nbsp;</div></li><li><div>      if ( $this-&gt;get_cart_discount_total() ) {&nbsp;</div></li><li><div>          $total_discount = wc_price( $this-&gt;get_cart_discount_total() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $total_discount = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_total_discount', $total_discount, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the total (product) discount amount - these are applied before tax.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated Order discounts (after tax) removed in 2.3 so multiple methods for discounts are no longer required.</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed formatted price or false if there are none</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_discounts_before_tax() {&nbsp;</div></li><li><div>      wc_deprecated_function( 'get_discounts_before_tax', '2.3', 'get_total_discount' );&nbsp;</div></li><li><div>      if ( $this-&gt;get_cart_discount_total() ) {&nbsp;</div></li><li><div>          $discounts_before_tax = wc_price( $this-&gt;get_cart_discount_total() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $discounts_before_tax = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_cart_discounts_before_tax', $discounts_before_tax, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the total of all order discounts (after tax discounts).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated Order discounts (after tax) removed in 2.3</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order_discount_total() {&nbsp;</div></li><li><div>      wc_deprecated_function( 'get_order_discount_total', '2.3' );&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function to apply cart discounts after tax.</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated Coupons can not be applied after tax</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function apply_cart_discounts_after_tax( $values, $price ) {&nbsp;</div></li><li><div>      wc_deprecated_function( 'apply_cart_discounts_after_tax', '2.3' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function to apply product discounts after tax.</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated Coupons can not be applied after tax</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function apply_product_discounts_after_tax( $values, $price ) {&nbsp;</div></li><li><div>      wc_deprecated_function( 'apply_product_discounts_after_tax', '2.3' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the order discount amount - these are applied after tax.</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated Coupons can not be applied after tax</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_discounts_after_tax() {&nbsp;</div></li><li><div>      wc_deprecated_function( 'get_discounts_after_tax', '2.3' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>