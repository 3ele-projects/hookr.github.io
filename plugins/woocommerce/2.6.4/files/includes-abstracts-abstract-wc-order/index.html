<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.6.4" data-slug="woocommerce" data-type="file" data-id="44533"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-abstracts-abstract-wc-order | file | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce, 2.6.4" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"http:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4"}};!function(a,b,c){function d(a){var c=b.createElement("canvas"),d=c.getContext&&c.getContext("2d");return d&&d.fillText?(d.textBaseline="top",d.font="600 32px Arial","flag"===a?(d.fillText(String.fromCharCode(55356,56806,55356,56826),0,0),c.toDataURL().length>3e3):("simple"===a?d.fillText(String.fromCharCode(55357,56835),0,0):d.fillText(String.fromCharCode(55356,57135),0,0),0!==d.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=b396d030d381a4bbc143a4c1dd17bd43' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-abstracts-abstract-wc-order/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-abstracts-abstract-wc-order%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-abstracts-abstract-wc-order%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-2.6.4-file-includes-abstracts-abstract-wc-order","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-abstracts-abstract-wc-order" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.6.4." href="http://hookr.io/plugins/woocommerce/2.6.4/" class="H_VERSION"><span property="name">2.6.4</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce/2.6.4/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-abstracts-abstract-w&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2840"><a href="http://hookr.io/plugins/woocommerce/2.6.4/all/" title="All">All <span class="count badge">2840</span></a></li><li class="" data-id="new" data-count="3"><a href="http://hookr.io/plugins/woocommerce/2.6.4/new/" title="New">New <span class="count badge">3</span></a></li><li class="" data-id="hooks" data-count="2002"><a href="http://hookr.io/plugins/woocommerce/2.6.4/hooks/" title="Hooks">Hooks <span class="count badge">2002</span></a></li><li class="" data-id="action" data-count="714"><a href="http://hookr.io/plugins/woocommerce/2.6.4/actions/" title="Actions">Actions <span class="count badge">714</span></a></li><li class="" data-id="filter" data-count="1288"><a href="http://hookr.io/plugins/woocommerce/2.6.4/filters/" title="Filters">Filters <span class="count badge">1288</span></a></li><li class="" data-id="class" data-count="281"><a href="http://hookr.io/plugins/woocommerce/2.6.4/classes/" title="Classes">Classes <span class="count badge">281</span></a></li><li class="" data-id="constant" data-count="21"><a href="http://hookr.io/plugins/woocommerce/2.6.4/constants/" title="Constants">Constants <span class="count badge">21</span></a></li><li class="" data-id="function" data-count="532"><a href="http://hookr.io/plugins/woocommerce/2.6.4/functions/" title="Functions">Functions <span class="count badge">532</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/2.6.4/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/abstracts/abstract-wc-order.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Abstract Order</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The WooCommerce order class handles order data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @class       WC_Order</span>&nbsp;</div></li><li><div><span class="comment"> * @version     2.2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @package     WooCommerce/Classes</span>&nbsp;</div></li><li><div><span class="comment"> * @category    Class</span>&nbsp;</div></li><li><div><span class="comment"> * @author      WooThemes</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_first_name The billing address first name.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_last_name The billing address last name.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_company The billing address company.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_address_1 The first line of the billing address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_address_2 The second line of the billing address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_city The city of the billing address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_state The state of the billing address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_postcode The postcode of the billing address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_country The country of the billing address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_phone The billing phone number.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $billing_email The billing email.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_first_name The shipping address first name.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_last_name The shipping address last name.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_company The shipping address company.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_address_1 The first line of the shipping address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_address_2 The second line of the shipping address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_city The city of the shipping address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_state The state of the shipping address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_postcode The postcode of the shipping address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_country The country of the shipping address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $cart_discount Total amount of discount.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $cart_discount_tax Total amount of discount applied to taxes.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $shipping_method_title &lt; 2.1 was used for shipping method title. Now @deprecated.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    int $customer_user User ID who the order belongs to. 0 for guests.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_key Random key/password unqique to each order.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_discount Stored after tax discounts pre-2.3. Now @deprecated.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_tax Stores order tax total.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_shipping_tax Stores shipping tax total.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_shipping Stores shipping total.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_total Stores order total.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $order_currency Stores currency code used for the order.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $payment_method method ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $payment_method_title Name of the payment method used.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $customer_ip_address Customer IP Address.</span>&nbsp;</div></li><li><div><span class="comment"> * @property    string $customer_user_agent Customer User agent.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>abstract class WC_Abstract_Order {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public int Order (post) ID. */</span>&nbsp;</div></li><li><div>  public $id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @var $post WP_Post. */</span>&nbsp;</div></li><li><div>  public $post = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Order type. */</span>&nbsp;</div></li><li><div>  public $order_type = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Order Date. */</span>&nbsp;</div></li><li><div>  public $order_date = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Order Modified Date. */</span>&nbsp;</div></li><li><div>  public $modified_date = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Customer Message (excerpt). */</span>&nbsp;</div></li><li><div>  public $customer_message = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Customer Note */</span>&nbsp;</div></li><li><div>  public $customer_note = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Order Status. */</span>&nbsp;</div></li><li><div>  public $post_status = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public bool Do prices include tax? */</span>&nbsp;</div></li><li><div>  public $prices_include_tax = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public string Display mode for taxes in cart. */</span>&nbsp;</div></li><li><div>  public $tax_display_cart = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public bool Do totals display ex tax? */</span>&nbsp;</div></li><li><div>  public $display_totals_ex_tax = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @public bool Do cart prices display ex tax? */</span>&nbsp;</div></li><li><div>  public $display_cart_ex_tax = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @protected string Formatted address. Accessed via get_formatted_billing_address(). */</span>&nbsp;</div></li><li><div>  protected $formatted_billing_address = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** @protected string Formatted address. Accessed via get_formatted_shipping_address(). */</span>&nbsp;</div></li><li><div>  protected $formatted_shipping_address = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the order if ID is passed, otherwise the order is new and empty.</span>&nbsp;</div></li><li><div><span class="comment">   * This class should NOT be instantiated, but the get_order function or new WC_Order_Factory.</span>&nbsp;</div></li><li><div><span class="comment">   * should be used. It is possible, but the aforementioned are preferred and are the only.</span>&nbsp;</div></li><li><div><span class="comment">   * methods that will be maintained going forward.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int|object|WC_Order $order Order to init.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct( $order = 0 ) {&nbsp;</div></li><li><div>      $this-&gt;prices_include_tax = get_option('woocommerce_prices_include_tax') == 'yes' ? true : false;&nbsp;</div></li><li><div>      $this-&gt;tax_display_cart = get_option( 'woocommerce_tax_display_cart' );&nbsp;</div></li><li><div>      $this-&gt;display_totals_ex_tax = $this-&gt;tax_display_cart == 'excl' ? true : false;&nbsp;</div></li><li><div>      $this-&gt;display_cart_ex_tax = $this-&gt;tax_display_cart == 'excl' ? true : false;&nbsp;</div></li><li><div>      $this-&gt;init( $order );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Init/load the order object. Called from the constructor.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int|object|WC_Order $order Order to init.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  protected function init( $order ) {&nbsp;</div></li><li><div>      if ( is_numeric( $order ) ) {&nbsp;</div></li><li><div>          $this-&gt;id = absint( $order );&nbsp;</div></li><li><div>          $this-&gt;post = get_post( $order );&nbsp;</div></li><li><div>          $this-&gt;get_order( $this-&gt;id );&nbsp;</div></li><li><div>      } elseif ( $order instanceof WC_Order ) {&nbsp;</div></li><li><div>          $this-&gt;id = absint( $order-&gt;id );&nbsp;</div></li><li><div>          $this-&gt;post = $order-&gt;post;&nbsp;</div></li><li><div>          $this-&gt;get_order( $this-&gt;id );&nbsp;</div></li><li><div>      } elseif ( isset( $order-&gt;ID ) ) {&nbsp;</div></li><li><div>          $this-&gt;id = absint( $order-&gt;ID );&nbsp;</div></li><li><div>          $this-&gt;post = $order;&nbsp;</div></li><li><div>          $this-&gt;get_order( $this-&gt;id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Remove all line items (products, coupons, shipping, taxes) from the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type Order item type. Default null.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function remove_order_items( $type = null ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $type ) ) {&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM itemmeta USING {$wpdb-&gt;prefix}woocommerce_order_itemmeta itemmeta INNER JOIN {$wpdb-&gt;prefix}woocommerce_order_items items WHERE itemmeta.order_item_id = items.order_item_id AND items.order_id = %d AND items.order_item_type = %s&quot;, $this-&gt;id, $type ) );&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM {$wpdb-&gt;prefix}woocommerce_order_items WHERE order_id = %d AND order_item_type = %s&quot;, $this-&gt;id, $type ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM itemmeta USING {$wpdb-&gt;prefix}woocommerce_order_itemmeta itemmeta INNER JOIN {$wpdb-&gt;prefix}woocommerce_order_items items WHERE itemmeta.order_item_id = items.order_item_id and items.order_id = %d&quot;, $this-&gt;id ) );&nbsp;</div></li><li><div>          $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM {$wpdb-&gt;prefix}woocommerce_order_items WHERE order_id = %d&quot;, $this-&gt;id ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a list of all payment tokens associated with the current order</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6</span>&nbsp;</div></li><li><div><span class="comment">   * @return array An array of payment token objects</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_payment_tokens() {&nbsp;</div></li><li><div>      return WC_Payment_Tokens::get_order_tokens( $this-&gt;id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a payment token to an order</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6</span>&nbsp;</div></li><li><div><span class="comment">   * @param  WC_Payment_Token   $token     Payment token object</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean True if the token was added, false if not</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_payment_token( $token ) {&nbsp;</div></li><li><div>      if ( empty( $token ) || ! ( $token instanceof WC_Payment_Token ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $token_ids = get_post_meta( $this-&gt;id, '_payment_tokens', true );&nbsp;</div></li><li><div>      if ( empty ( $token_ids ) ) {&nbsp;</div></li><li><div>          $token_ids = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $token_ids[] = $token-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $this-&gt;id, '_payment_tokens', $token_ids );&nbsp;</div></li><li><div>      do_action( 'woocommerce_payment_token_added_to_order', $this-&gt;id, $token-&gt;get_id(), $token, $token_ids );&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set the payment method for the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WC_Payment_Gateway|string $payment_method</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_payment_method( $payment_method = '' ) {&nbsp;</div></li><li><div>      if ( is_object( $payment_method ) ) {&nbsp;</div></li><li><div>          update_post_meta( $this-&gt;id, '_payment_method', $payment_method-&gt;id );&nbsp;</div></li><li><div>          update_post_meta( $this-&gt;id, '_payment_method_title', $payment_method-&gt;get_title() );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          update_post_meta( $this-&gt;id, '_payment_method', '' );&nbsp;</div></li><li><div>          update_post_meta( $this-&gt;id, '_payment_method_title', '' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set the customer address.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $address Address data.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type billing or shipping.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_address( $address, $type = 'billing' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $address as $key =&gt; $value ) {&nbsp;</div></li><li><div>          update_post_meta( $this-&gt;id, &quot;_{$type}_&quot; . $key, $value );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the requested address in raw, non-formatted way.</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $type Billing or shipping. Anything else besides 'billing' will return shipping address.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array The stored address after filter.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_address( $type = 'billing' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'billing' === $type ) {&nbsp;</div></li><li><div>          $address = array(&nbsp;</div></li><li><div>              'first_name' =&gt; $this-&gt;billing_first_name, &nbsp;</div></li><li><div>              'last_name' =&gt; $this-&gt;billing_last_name, &nbsp;</div></li><li><div>              'company' =&gt; $this-&gt;billing_company, &nbsp;</div></li><li><div>              'address_1' =&gt; $this-&gt;billing_address_1, &nbsp;</div></li><li><div>              'address_2' =&gt; $this-&gt;billing_address_2, &nbsp;</div></li><li><div>              'city' =&gt; $this-&gt;billing_city, &nbsp;</div></li><li><div>              'state' =&gt; $this-&gt;billing_state, &nbsp;</div></li><li><div>              'postcode' =&gt; $this-&gt;billing_postcode, &nbsp;</div></li><li><div>              'country' =&gt; $this-&gt;billing_country, &nbsp;</div></li><li><div>              'email' =&gt; $this-&gt;billing_email, &nbsp;</div></li><li><div>              'phone' =&gt; $this-&gt;billing_phone, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $address = array(&nbsp;</div></li><li><div>              'first_name' =&gt; $this-&gt;shipping_first_name, &nbsp;</div></li><li><div>              'last_name' =&gt; $this-&gt;shipping_last_name, &nbsp;</div></li><li><div>              'company' =&gt; $this-&gt;shipping_company, &nbsp;</div></li><li><div>              'address_1' =&gt; $this-&gt;shipping_address_1, &nbsp;</div></li><li><div>              'address_2' =&gt; $this-&gt;shipping_address_2, &nbsp;</div></li><li><div>              'city' =&gt; $this-&gt;shipping_city, &nbsp;</div></li><li><div>              'state' =&gt; $this-&gt;shipping_state, &nbsp;</div></li><li><div>              'postcode' =&gt; $this-&gt;shipping_postcode, &nbsp;</div></li><li><div>              'country' =&gt; $this-&gt;shipping_country, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_order_address', $address, $type, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a product line item to the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param \WC_Product $product</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $qty Line item quantity.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|bool Item ID or false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_product( $product, $qty = 1, $args = array() ) {&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, array(&nbsp;</div></li><li><div>          'variation' =&gt; array(), &nbsp;</div></li><li><div>          'totals' =&gt; array()&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $product ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_id = wc_add_order_item( $this-&gt;id, array(&nbsp;</div></li><li><div>          'order_item_name' =&gt; $product-&gt;get_title(), &nbsp;</div></li><li><div>          'order_item_type' =&gt; 'line_item'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_qty', wc_stock_amount( $qty ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_tax_class', $product-&gt;get_tax_class() );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_product_id', $product-&gt;id );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_variation_id', isset( $product-&gt;variation_id ) ? $product-&gt;variation_id : 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set line item totals, either passed in or from the product</span>&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_subtotal', wc_format_decimal( isset( $args['totals']['subtotal'] ) ? $args['totals']['subtotal'] : $product-&gt;get_price_excluding_tax( $qty ) ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_total', wc_format_decimal( isset( $args['totals']['total'] ) ? $args['totals']['total'] : $product-&gt;get_price_excluding_tax( $qty ) ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_subtotal_tax', wc_format_decimal( isset( $args['totals']['subtotal_tax'] ) ? $args['totals']['subtotal_tax'] : 0 ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_tax', wc_format_decimal( isset( $args['totals']['tax'] ) ? $args['totals']['tax'] : 0 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Save tax data - Since 2.2</span></span>&nbsp;</div></li><li><div>      if ( isset( $args['totals']['tax_data'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tax_data = array();&nbsp;</div></li><li><div>          $tax_data['total'] = array_map( 'wc_format_decimal', $args['totals']['tax_data']['total'] );&nbsp;</div></li><li><div>          $tax_data['subtotal'] = array_map( 'wc_format_decimal', $args['totals']['tax_data']['subtotal'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wc_add_order_item_meta( $item_id, '_line_tax_data', $tax_data );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wc_add_order_item_meta( $item_id, '_line_tax_data', array( 'total' =&gt; array(), 'subtotal' =&gt; array() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add variation meta</span>&nbsp;</div></li><li><div>      if ( ! empty( $args['variation'] ) ) {&nbsp;</div></li><li><div>          foreach ( $args['variation'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>              wc_add_order_item_meta( $item_id, str_replace( 'attribute_', '', $key ), $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Backorders</span></span>&nbsp;</div></li><li><div>      if ( $product-&gt;backorders_require_notification() && $product-&gt;is_on_backorder( $qty ) ) {&nbsp;</div></li><li><div>          wc_add_order_item_meta( $item_id, apply_filters( 'woocommerce_backordered_item_meta_name', __( 'Backordered', 'woocommerce' ) ), $qty - max( 0, $product-&gt;get_total_stock() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_add_product', $this-&gt;id, $item_id, $product, $qty, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $item_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update a line item for the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note this does not update order totals.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $item_id order item ID.</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args data to update.</span>&nbsp;</div></li><li><div><span class="comment">   * @param WC_Product $product</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function update_product( $item_id, $product, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id || ! is_object( $product ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// quantity</span>&nbsp;</div></li><li><div>      if ( isset( $args['qty'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_qty', wc_stock_amount( $args['qty'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// tax class</span></span>&nbsp;</div></li><li><div>      if ( isset( $args['tax_class'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_tax_class', $args['tax_class'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// set item totals, either provided or from product</span>&nbsp;</div></li><li><div>      if ( isset( $args['qty'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_line_subtotal', wc_format_decimal( isset( $args['totals']['subtotal'] ) ? $args['totals']['subtotal'] : $product-&gt;get_price_excluding_tax( $args['qty'] ) ) );&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_line_total', wc_format_decimal( isset( $args['totals']['total'] ) ? $args['totals']['total'] : $product-&gt;get_price_excluding_tax( $args['qty'] ) ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// set item tax totals</span>&nbsp;</div></li><li><div>      wc_update_order_item_meta( $item_id, '_line_subtotal_tax', wc_format_decimal( isset( $args['totals']['subtotal_tax'] ) ? $args['totals']['subtotal_tax'] : 0 ) );&nbsp;</div></li><li><div>      wc_update_order_item_meta( $item_id, '_line_tax', wc_format_decimal( isset( $args['totals']['tax'] ) ? $args['totals']['tax'] : 0 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// variation meta</span>&nbsp;</div></li><li><div>      if ( isset( $args['variation'] ) && is_array( $args['variation'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $args['variation'] as $key =&gt; $value ) {&nbsp;</div></li><li><div>              wc_update_order_item_meta( $item_id, str_replace( 'attribute_', '', $key ), $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// backorders</span>&nbsp;</div></li><li><div>      if ( isset( $args['qty'] ) && $product-&gt;backorders_require_notification() && $product-&gt;is_on_backorder( $args['qty'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, apply_filters( 'woocommerce_backordered_item_meta_name', __( 'Backordered', 'woocommerce' ) ), $args['qty'] - max( 0, $product-&gt;get_total_stock() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_edit_product', $this-&gt;id, $item_id, $args, $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add coupon code to the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $code</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $discount_amount</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $discount_amount_tax &quot;Discounted&quot; tax - used for tax inclusive prices.</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|bool Item ID or false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_coupon( $code, $discount_amount = 0, $discount_amount_tax = 0 ) {&nbsp;</div></li><li><div>      $item_id = wc_add_order_item( $this-&gt;id, array(&nbsp;</div></li><li><div>          'order_item_name' =&gt; $code, &nbsp;</div></li><li><div>          'order_item_type' =&gt; 'coupon'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'discount_amount', $discount_amount );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'discount_amount_tax', $discount_amount_tax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_add_coupon', $this-&gt;id, $item_id, $code, $discount_amount, $discount_amount_tax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $item_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update coupon for order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note this does not update order totals.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $item_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function update_coupon( $item_id, $args ) {&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// code</span>&nbsp;</div></li><li><div>      if ( isset( $args['code'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item( $item_id, array( 'order_item_name' =&gt; $args['code'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// amount</span>&nbsp;</div></li><li><div>      if ( isset( $args['discount_amount'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, 'discount_amount', wc_format_decimal( $args['discount_amount'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( isset( $args['discount_amount_tax'] ) ) {&nbsp;</div></li><li><div>          wc_add_order_item_meta( $item_id, 'discount_amount_tax', wc_format_decimal( $args['discount_amount_tax'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_update_coupon', $this-&gt;id, $item_id, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a tax row to the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param int tax_rate_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|bool Item ID or false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_tax( $tax_rate_id, $tax_amount = 0, $shipping_tax_amount = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $code = WC_Tax::get_rate_code( $tax_rate_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $code ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_id = wc_add_order_item( $this-&gt;id, array(&nbsp;</div></li><li><div>          'order_item_name' =&gt; $code, &nbsp;</div></li><li><div>          'order_item_type' =&gt; 'tax'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'rate_id', $tax_rate_id );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'label', WC_Tax::get_rate_label( $tax_rate_id ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'compound', WC_Tax::is_compound( $tax_rate_id ) ? 1 : 0 );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'tax_amount', wc_format_decimal( $tax_amount ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'shipping_tax_amount', wc_format_decimal( $shipping_tax_amount ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_add_tax', $this-&gt;id, $item_id, $tax_rate_id, $tax_amount, $shipping_tax_amount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $item_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a shipping row to the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WC_Shipping_Rate shipping_rate</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|bool Item ID or false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_shipping( $shipping_rate ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_id = wc_add_order_item( $this-&gt;id, array(&nbsp;</div></li><li><div>          'order_item_name' =&gt; $shipping_rate-&gt;label, &nbsp;</div></li><li><div>          'order_item_type' =&gt; 'shipping'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'method_id', $shipping_rate-&gt;id );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'cost', wc_format_decimal( $shipping_rate-&gt;cost ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Save shipping taxes - Since 2.2</span>&nbsp;</div></li><li><div>      $taxes = array_map( 'wc_format_decimal', $shipping_rate-&gt;taxes );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, 'taxes', $taxes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Store meta</span>&nbsp;</div></li><li><div>      $shipping_meta = $shipping_rate-&gt;get_meta_data();&nbsp;</div></li><li><div>      if ( ! empty( $shipping_meta ) ) {&nbsp;</div></li><li><div>          foreach ( $shipping_rate-&gt;get_meta_data() as $key =&gt; $value ) {&nbsp;</div></li><li><div>              wc_add_order_item_meta( $item_id, $key, $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_add_shipping', $this-&gt;id, $item_id, $shipping_rate );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Update</span> total</span>&nbsp;</div></li><li><div>      $this-&gt;set_total( $this-&gt;order_shipping + wc_format_decimal( $shipping_rate-&gt;cost ), 'shipping' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $item_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update shipping method for order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note this does not update the order total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $item_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function update_shipping( $item_id, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// method title</span>&nbsp;</div></li><li><div>      if ( isset( $args['method_title'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item( $item_id, array( 'order_item_name' =&gt; $args['method_title'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// method ID</span>&nbsp;</div></li><li><div>      if ( isset( $args['method_id'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, 'method_id', $args['method_id'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// method cost</span>&nbsp;</div></li><li><div>      if ( isset( $args['cost'] ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Get old cost before updating</span>&nbsp;</div></li><li><div>          $old_cost = wc_get_order_item_meta( $item_id, 'cost' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Update</span>&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, 'cost', wc_format_decimal( $args['cost'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Update</span> total</span>&nbsp;</div></li><li><div>          $this-&gt;set_total( $this-&gt;order_shipping - wc_format_decimal( $old_cost ) + wc_format_decimal( $args['cost'] ), 'shipping' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_update_shipping', $this-&gt;id, $item_id, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add a fee to the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $fee</span>&nbsp;</div></li><li><div><span class="comment">   * @return int|bool Item ID or false.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_fee( $fee ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $item_id = wc_add_order_item( $this-&gt;id, array(&nbsp;</div></li><li><div>          'order_item_name' =&gt; $fee-&gt;name, &nbsp;</div></li><li><div>          'order_item_type' =&gt; 'fee'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $fee-&gt;taxable ) {&nbsp;</div></li><li><div>          wc_add_order_item_meta( $item_id, '_tax_class', $fee-&gt;tax_class );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wc_add_order_item_meta( $item_id, '_tax_class', '0' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_total', wc_format_decimal( $fee-&gt;amount ) );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_tax', wc_format_decimal( $fee-&gt;tax ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Save tax data - Since 2.2</span></span>&nbsp;</div></li><li><div>      $tax_data = array_map( 'wc_format_decimal', $fee-&gt;tax_data );&nbsp;</div></li><li><div>      wc_add_order_item_meta( $item_id, '_line_tax_data', array( 'total' =&gt; $tax_data ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_add_fee', $this-&gt;id, $item_id, $fee );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $item_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update fee for order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note this does not update order totals.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $item_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function update_fee( $item_id, $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $item_id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// name</span>&nbsp;</div></li><li><div>      if ( isset( $args['name'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item( $item_id, array( 'order_item_name' =&gt; $args['name'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// tax class</span></span>&nbsp;</div></li><li><div>      if ( isset( $args['tax_class'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_tax_class', $args['tax_class'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// total</span>&nbsp;</div></li><li><div>      if ( isset( $args['line_total'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_line_total', wc_format_decimal( $args['line_total'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// total</span> tax&nbsp;</div></li><li><div>      if ( isset( $args['line_tax'] ) ) {&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_line_tax', wc_format_decimal( $args['line_tax'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_update_fee', $this-&gt;id, $item_id, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set an order total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param float $amount</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $total_type</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function set_total( $amount, $total_type = 'total' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! in_array( $total_type, array( 'shipping', 'tax', 'shipping_tax', 'total', 'cart_discount', 'cart_discount_tax' ) ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $total_type ) {&nbsp;</div></li><li><div>          case 'total' :&nbsp;</div></li><li><div>              $key = '_order_total';&nbsp;</div></li><li><div>              $amount = wc_format_decimal( $amount, wc_get_price_decimals() );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'cart_discount' :&nbsp;</div></li><li><div>          case 'cart_discount_tax' :&nbsp;</div></li><li><div>              $key = '_' . $total_type;&nbsp;</div></li><li><div>              $amount = wc_format_decimal( $amount );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>              $key = '_order_' . $total_type;&nbsp;</div></li><li><div>              $amount = wc_format_decimal( $amount );&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $this-&gt;id, $key, $amount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get all tax classes for items in the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.6.3</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_items_tax_classes() {&nbsp;</div></li><li><div>      $found_tax_classes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          if ( $_product = $this-&gt;get_product_from_item( $item ) ) {&nbsp;</div></li><li><div>              $found_tax_classes[] = $_product-&gt;get_tax_class();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_unique( $found_tax_classes );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate taxes for all line items and shipping, and store the totals and tax rows.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Will use the base country unless customer addresses are set.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool success or fail.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function calculate_taxes() {&nbsp;</div></li><li><div>      $tax_total = 0;&nbsp;</div></li><li><div>      $shipping_tax_total = 0;&nbsp;</div></li><li><div>      $taxes = array();&nbsp;</div></li><li><div>      $shipping_taxes = array();&nbsp;</div></li><li><div>      $tax_based_on = get_option( 'woocommerce_tax_based_on' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If is_vat_exempt is 'yes', or wc_tax_enabled is false, return and do nothing.</span>&nbsp;</div></li><li><div>      if ( 'yes' === $this-&gt;is_vat_exempt || ! wc_tax_enabled() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'billing' === $tax_based_on ) {&nbsp;</div></li><li><div>          $country = $this-&gt;billing_country;&nbsp;</div></li><li><div>          $state = $this-&gt;billing_state;&nbsp;</div></li><li><div>          $postcode = $this-&gt;billing_postcode;&nbsp;</div></li><li><div>          $city = $this-&gt;billing_city;&nbsp;</div></li><li><div>      } elseif ( 'shipping' === $tax_based_on ) {&nbsp;</div></li><li><div>          $country = $this-&gt;shipping_country;&nbsp;</div></li><li><div>          $state = $this-&gt;shipping_state;&nbsp;</div></li><li><div>          $postcode = $this-&gt;shipping_postcode;&nbsp;</div></li><li><div>          $city = $this-&gt;shipping_city;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Default to base</span>&nbsp;</div></li><li><div>      if ( 'base' === $tax_based_on || empty( $country ) ) {&nbsp;</div></li><li><div>          $default = wc_get_base_location();&nbsp;</div></li><li><div>          $country = $default['country'];&nbsp;</div></li><li><div>          $state = $default['state'];&nbsp;</div></li><li><div>          $postcode = '';&nbsp;</div></li><li><div>          $city = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get items</span>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items( array( 'line_item', 'fee' ) ) as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $product = $this-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>          $line_total = isset( $item['line_total'] ) ? $item['line_total'] : 0;&nbsp;</div></li><li><div>          $line_subtotal = isset( $item['line_subtotal'] ) ? $item['line_subtotal'] : 0;&nbsp;</div></li><li><div>          $tax_class = $item['tax_class'];&nbsp;</div></li><li><div>          $item_tax_status = $product ? $product-&gt;get_tax_status() : 'taxable';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( '0' !== $tax_class && 'taxable' === $item_tax_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $tax_rates = WC_Tax::find_rates( array(&nbsp;</div></li><li><div>                  'country' =&gt; $country, &nbsp;</div></li><li><div>                  'state' =&gt; $state, &nbsp;</div></li><li><div>                  'postcode' =&gt; $postcode, &nbsp;</div></li><li><div>                  'city' =&gt; $city, &nbsp;</div></li><li><div>                  'tax_class' =&gt; $tax_class&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $line_subtotal_taxes = WC_Tax::calc_tax( $line_subtotal, $tax_rates, false );&nbsp;</div></li><li><div>              $line_taxes = WC_Tax::calc_tax( $line_total, $tax_rates, false );&nbsp;</div></li><li><div>              $line_subtotal_tax = max( 0, array_sum( $line_subtotal_taxes ) );&nbsp;</div></li><li><div>              $line_tax = max( 0, array_sum( $line_taxes ) );&nbsp;</div></li><li><div>              $tax_total           += $line_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wc_update_order_item_meta( $item_id, '_line_subtotal_tax', wc_format_decimal( $line_subtotal_tax ) );&nbsp;</div></li><li><div>              wc_update_order_item_meta( $item_id, '_line_tax', wc_format_decimal( $line_tax ) );&nbsp;</div></li><li><div>              wc_update_order_item_meta( $item_id, '_line_tax_data', array( 'total' =&gt; $line_taxes, 'subtotal' =&gt; $line_subtotal_taxes ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Sum the item taxes</span></span>&nbsp;</div></li><li><div>              foreach ( array_keys( $taxes + $line_taxes ) as $key ) {&nbsp;</div></li><li><div>                  $taxes[ $key ] = ( isset( $line_taxes[ $key ] ) ? $line_taxes[ $key ] : 0 ) + ( isset( $taxes[ $key ] ) ? $taxes[ $key ] : 0 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Calc taxes for shipping</span>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_shipping_methods() as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>          $shipping_tax_class = get_option( 'woocommerce_shipping_tax_class' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Inherit tax class from items</span>&nbsp;</div></li><li><div>          if ( '' === $shipping_tax_class ) {&nbsp;</div></li><li><div>              $tax_classes = WC_Tax::get_tax_classes();&nbsp;</div></li><li><div>              $found_tax_classes = $this-&gt;get_items_tax_classes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $tax_classes as $tax_class ) {&nbsp;</div></li><li><div>                  $tax_class = sanitize_title( $tax_class );&nbsp;</div></li><li><div>                  if ( in_array( $tax_class, $found_tax_classes ) ) {&nbsp;</div></li><li><div>                      $tax_rates = WC_Tax::find_shipping_rates( array(&nbsp;</div></li><li><div>                          'country' =&gt; $country, &nbsp;</div></li><li><div>                          'state' =&gt; $state, &nbsp;</div></li><li><div>                          'postcode' =&gt; $postcode, &nbsp;</div></li><li><div>                          'city' =&gt; $city, &nbsp;</div></li><li><div>                          'tax_class' =&gt; $tax_class, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $tax_rates = WC_Tax::find_shipping_rates( array(&nbsp;</div></li><li><div>                  'country' =&gt; $country, &nbsp;</div></li><li><div>                  'state' =&gt; $state, &nbsp;</div></li><li><div>                  'postcode' =&gt; $postcode, &nbsp;</div></li><li><div>                  'city' =&gt; $city, &nbsp;</div></li><li><div>                  'tax_class' =&gt; 'standard' === $shipping_tax_class ? '' : $shipping_tax_class, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $line_taxes = WC_Tax::calc_tax( $item['cost'], $tax_rates, false );&nbsp;</div></li><li><div>          $line_tax = max( 0, array_sum( $line_taxes ) );&nbsp;</div></li><li><div>          $shipping_tax_total += $line_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_line_tax', wc_format_decimal( $line_tax ) );&nbsp;</div></li><li><div>          wc_update_order_item_meta( $item_id, '_line_tax_data', array( 'total' =&gt; $line_taxes ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Sum the item taxes</span></span>&nbsp;</div></li><li><div>          foreach ( array_keys( $shipping_taxes + $line_taxes ) as $key ) {&nbsp;</div></li><li><div>              $shipping_taxes[ $key ] = ( isset( $line_taxes[ $key ] ) ? $line_taxes[ $key ] : 0 ) + ( isset( $shipping_taxes[ $key ] ) ? $shipping_taxes[ $key ] : 0 );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Save tax totals</span></span>&nbsp;</div></li><li><div>      $this-&gt;set_total( $shipping_tax_total, 'shipping_tax' );&nbsp;</div></li><li><div>      $this-&gt;set_total( $tax_total, 'tax' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Tax rows</span>&nbsp;</div></li><li><div>      $this-&gt;remove_order_items( 'tax' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Now merge to keep tax rows</span>&nbsp;</div></li><li><div>      foreach ( array_keys( $taxes + $shipping_taxes ) as $tax_rate_id ) {&nbsp;</div></li><li><div>          $this-&gt;add_tax( $tax_rate_id, isset( $taxes[ $tax_rate_id ] ) ? $taxes[ $tax_rate_id ] : 0, isset( $shipping_taxes[ $tax_rate_id ] ) ? $shipping_taxes[ $tax_rate_id ] : 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate shipping total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function calculate_shipping() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping_total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_shipping_methods() as $shipping ) {&nbsp;</div></li><li><div>          $shipping_total += $shipping['cost'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;set_total( $shipping_total, 'shipping' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;get_total_shipping();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Update tax lines at order level by looking at the line item taxes themselves.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool success or fail.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function update_taxes() {&nbsp;</div></li><li><div>      $order_taxes = array();&nbsp;</div></li><li><div>      $order_shipping_taxes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items( array( 'line_item', 'fee' ) ) as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $line_tax_data = maybe_unserialize( $item['line_tax_data'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $line_tax_data['total'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $line_tax_data['total'] as $tax_rate_id =&gt; $tax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( ! isset( $order_taxes[ $tax_rate_id ] ) ) {&nbsp;</div></li><li><div>                      $order_taxes[ $tax_rate_id ] = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $order_taxes[ $tax_rate_id ] += $tax;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items( array( 'shipping' ) ) as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $line_tax_data = maybe_unserialize( $item['taxes'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( isset( $line_tax_data ) ) {&nbsp;</div></li><li><div>              foreach ( $line_tax_data as $tax_rate_id =&gt; $tax ) {&nbsp;</div></li><li><div>                  if ( ! isset( $order_shipping_taxes[ $tax_rate_id ] ) ) {&nbsp;</div></li><li><div>                      $order_shipping_taxes[ $tax_rate_id ] = 0;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $order_shipping_taxes[ $tax_rate_id ] += $tax;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove old existing tax rows.</span>&nbsp;</div></li><li><div>      $this-&gt;remove_order_items( 'tax' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Now merge to keep tax rows</span>.&nbsp;</div></li><li><div>      foreach ( array_keys( $order_taxes + $order_shipping_taxes ) as $tax_rate_id ) {&nbsp;</div></li><li><div>          $this-&gt;add_tax( $tax_rate_id, isset( $order_taxes[ $tax_rate_id ] ) ? $order_taxes[ $tax_rate_id ] : 0, isset( $order_shipping_taxes[ $tax_rate_id ] ) ? $order_shipping_taxes[ $tax_rate_id ] : 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Save tax totals</span></span>&nbsp;</div></li><li><div>      $this-&gt;set_total( WC_Tax::round( array_sum( $order_shipping_taxes ) ), 'shipping_tax' );&nbsp;</div></li><li><div>      $this-&gt;set_total( WC_Tax::round( array_sum( $order_taxes ) ), 'tax' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate totals by looking at the contents of the order. Stores the totals and returns the orders final total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $and_taxes Calc taxes if true.</span>&nbsp;</div></li><li><div><span class="comment">   * @return float calculated grand total.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function calculate_totals( $and_taxes = true ) {&nbsp;</div></li><li><div>      $cart_subtotal = 0;&nbsp;</div></li><li><div>      $cart_total = 0;&nbsp;</div></li><li><div>      $fee_total = 0;&nbsp;</div></li><li><div>      $cart_subtotal_tax = 0;&nbsp;</div></li><li><div>      $cart_total_tax = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $and_taxes && wc_tax_enabled() ) {&nbsp;</div></li><li><div>          $this-&gt;calculate_taxes();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// line items</span>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          $cart_subtotal     += wc_format_decimal( isset( $item['line_subtotal'] ) ? $item['line_subtotal'] : 0 );&nbsp;</div></li><li><div>          $cart_total        += wc_format_decimal( isset( $item['line_total'] ) ? $item['line_total'] : 0 );&nbsp;</div></li><li><div>          $cart_subtotal_tax += wc_format_decimal( isset( $item['line_subtotal_tax'] ) ? $item['line_subtotal_tax'] : 0 );&nbsp;</div></li><li><div>          $cart_total_tax    += wc_format_decimal( isset( $item['line_tax'] ) ? $item['line_tax'] : 0 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;calculate_shipping();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_fees() as $item ) {&nbsp;</div></li><li><div>          $fee_total += $item['line_total'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;set_total( $cart_subtotal - $cart_total, 'cart_discount' );&nbsp;</div></li><li><div>      $this-&gt;set_total( $cart_subtotal_tax - $cart_total_tax, 'cart_discount_tax' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $grand_total = round( $cart_total + $fee_total + $this-&gt;get_total_shipping() + $this-&gt;get_cart_tax() + $this-&gt;get_shipping_tax(), wc_get_price_decimals() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;set_total( $grand_total, 'total' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $grand_total;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets an order from the database.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $id (default: 0).</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order( $id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $result = get_post( $id ) ) {&nbsp;</div></li><li><div>          $this-&gt;populate( $result );&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Populates an order from the loaded post data.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $result</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function populate( $result ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Standard post data</span>&nbsp;</div></li><li><div>      $this-&gt;id = $result-&gt;ID;&nbsp;</div></li><li><div>      $this-&gt;order_date = $result-&gt;post_date;&nbsp;</div></li><li><div>      $this-&gt;modified_date = $result-&gt;post_modified;&nbsp;</div></li><li><div>      $this-&gt;customer_message = $result-&gt;post_excerpt;&nbsp;</div></li><li><div>      $this-&gt;customer_note = $result-&gt;post_excerpt;&nbsp;</div></li><li><div>      $this-&gt;post_status = $result-&gt;post_status;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Billing email can default to user if set.</span>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;billing_email ) && ! empty( $this-&gt;customer_user ) && ( $user = get_user_by( 'id', $this-&gt;customer_user ) ) ) {&nbsp;</div></li><li><div>          $this-&gt;billing_email = $user-&gt;user_email;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Orders store the state of prices including tax when created.</span>&nbsp;</div></li><li><div>      $this-&gt;prices_include_tax = metadata_exists( 'post', $this-&gt;id, '_prices_include_tax' ) ? get_post_meta( $this-&gt;id, '_prices_include_tax', true ) === 'yes' : $this-&gt;prices_include_tax;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * __isset function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $key</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __isset( $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return metadata_exists( 'post', $this-&gt;id, '_' . $key );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * __get function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $key</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __get( $key ) {&nbsp;</div></li><li><div>      <span class="comment">// Get values or default if not set.</span>&nbsp;</div></li><li><div>      if ( 'completed_date' === $key ) {&nbsp;</div></li><li><div>          $value = ( $value = get_post_meta( $this-&gt;id, '_completed_date', true ) ) ? $value : $this-&gt;modified_date;&nbsp;</div></li><li><div>      } elseif ( 'user_id' === $key ) {&nbsp;</div></li><li><div>          $value = ( $value = get_post_meta( $this-&gt;id, '_customer_user', true ) ) ? absint( $value ) : '';&nbsp;</div></li><li><div>      } elseif ( 'status' === $key ) {&nbsp;</div></li><li><div>          $value = $this-&gt;get_status();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $value = get_post_meta( $this-&gt;id, '_' . $key, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the order statuses without wc- internal prefix.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Queries get_post_status() directly to avoid having out of date statuses, if updated elsewhere.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_status() {&nbsp;</div></li><li><div>      $this-&gt;post_status = get_post_status( $this-&gt;id );&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_get_status', 'wc-' === substr( $this-&gt;post_status, 0, 3 ) ? substr( $this-&gt;post_status, 3 ) : $this-&gt;post_status, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks the order status against a passed in status.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_status( $status ) {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_has_status', ( is_array( $status ) && in_array( $this-&gt;get_status(), $status ) ) || $this-&gt;get_status() === $status ? true : false, $this, $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the user ID associated with the order. Guests are 0.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_user_id() {&nbsp;</div></li><li><div>      return $this-&gt;customer_user ? intval( $this-&gt;customer_user ) : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the user associated with the order. False for guests.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment">   * @return WP_User|false</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_user() {&nbsp;</div></li><li><div>      return $this-&gt;get_user_id() ? get_user_by( 'id', $this-&gt;get_user_id() ) : false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get transaction id for the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_transaction_id() {&nbsp;</div></li><li><div>      return get_post_meta( $this-&gt;id, '_transaction_id', true );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check if an order key is valid.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $key</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function key_is_valid( $key ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $key == $this-&gt;order_key ) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get_order_number function.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the order number for display (by default, order ID).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order_number() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_number', $this-&gt;id, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a formatted billing address for the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_formatted_billing_address() {&nbsp;</div></li><li><div>      if ( ! $this-&gt;formatted_billing_address ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Formatted Addresses</span>.</span>&nbsp;</div></li><li><div>          $address = apply_filters( 'woocommerce_order_formatted_billing_address', array(&nbsp;</div></li><li><div>              'first_name' =&gt; $this-&gt;billing_first_name, &nbsp;</div></li><li><div>              'last_name' =&gt; $this-&gt;billing_last_name, &nbsp;</div></li><li><div>              'company' =&gt; $this-&gt;billing_company, &nbsp;</div></li><li><div>              'address_1' =&gt; $this-&gt;billing_address_1, &nbsp;</div></li><li><div>              'address_2' =&gt; $this-&gt;billing_address_2, &nbsp;</div></li><li><div>              'city' =&gt; $this-&gt;billing_city, &nbsp;</div></li><li><div>              'state' =&gt; $this-&gt;billing_state, &nbsp;</div></li><li><div>              'postcode' =&gt; $this-&gt;billing_postcode, &nbsp;</div></li><li><div>              'country' =&gt; $this-&gt;billing_country&nbsp;</div></li><li><div> ), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;formatted_billing_address = WC()-&gt;countries-&gt;get_formatted_address( $address );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;formatted_billing_address;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a formatted shipping address for the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_formatted_shipping_address() {&nbsp;</div></li><li><div>      if ( ! $this-&gt;formatted_shipping_address ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $this-&gt;shipping_address_1 || $this-&gt;shipping_address_2 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Formatted Addresses</span>&nbsp;</div></li><li><div>              $address = apply_filters( 'woocommerce_order_formatted_shipping_address', array(&nbsp;</div></li><li><div>                  'first_name' =&gt; $this-&gt;shipping_first_name, &nbsp;</div></li><li><div>                  'last_name' =&gt; $this-&gt;shipping_last_name, &nbsp;</div></li><li><div>                  'company' =&gt; $this-&gt;shipping_company, &nbsp;</div></li><li><div>                  'address_1' =&gt; $this-&gt;shipping_address_1, &nbsp;</div></li><li><div>                  'address_2' =&gt; $this-&gt;shipping_address_2, &nbsp;</div></li><li><div>                  'city' =&gt; $this-&gt;shipping_city, &nbsp;</div></li><li><div>                  'state' =&gt; $this-&gt;shipping_state, &nbsp;</div></li><li><div>                  'postcode' =&gt; $this-&gt;shipping_postcode, &nbsp;</div></li><li><div>                  'country' =&gt; $this-&gt;shipping_country&nbsp;</div></li><li><div> ), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $this-&gt;formatted_shipping_address = WC()-&gt;countries-&gt;get_formatted_address( $address );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;formatted_shipping_address;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a formatted shipping address for the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_address_map_url() {&nbsp;</div></li><li><div>      $address = apply_filters( 'woocommerce_shipping_address_map_url_parts', array(&nbsp;</div></li><li><div>          'address_1' =&gt; $this-&gt;shipping_address_1, &nbsp;</div></li><li><div>          'address_2' =&gt; $this-&gt;shipping_address_2, &nbsp;</div></li><li><div>          'city' =&gt; $this-&gt;shipping_city, &nbsp;</div></li><li><div>          'state' =&gt; $this-&gt;shipping_state, &nbsp;</div></li><li><div>          'postcode' =&gt; $this-&gt;shipping_postcode, &nbsp;</div></li><li><div>          'country' =&gt; $this-&gt;shipping_country&nbsp;</div></li><li><div> ), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_shipping_address_map_url', 'https:<span class="comment">//maps.google.com/maps?&q=' . urlencode( implode( ', ', $address ) ) . '&z=16', $this );</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the billing address in an array.</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 2.3</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_billing_address() {&nbsp;</div></li><li><div>      _deprecated_function( 'get_billing_address', '2.3', 'get_formatted_billing_address' );&nbsp;</div></li><li><div>      return $this-&gt;get_formatted_billing_address();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the shipping address in an array.</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated 2.3</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_address() {&nbsp;</div></li><li><div>      _deprecated_function( 'get_shipping_address', '2.3', 'get_formatted_shipping_address' );&nbsp;</div></li><li><div>      return $this-&gt;get_formatted_shipping_address();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a formatted billing full name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_formatted_billing_full_name() {&nbsp;</div></li><li><div>      return sprintf( _x( '%1$s %2$s', 'full name', 'woocommerce' ), $this-&gt;billing_first_name, $this-&gt;billing_last_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a formatted shipping full name.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_formatted_shipping_full_name() {&nbsp;</div></li><li><div>      return sprintf( _x( '%1$s %2$s', 'full name', 'woocommerce' ), $this-&gt;shipping_first_name, $this-&gt;shipping_last_name );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return an array of items/products within this order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $type Types of line items to get (array or string).</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_items( $type = '' ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $type ) ) {&nbsp;</div></li><li><div>          $type = array( 'line_item' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_array( $type ) ) {&nbsp;</div></li><li><div>          $type = array( $type );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $items = array();&nbsp;</div></li><li><div>      $get_items_sql = $wpdb-&gt;prepare( &quot;SELECT order_item_id, order_item_name, order_item_type FROM {$wpdb-&gt;prefix}woocommerce_order_items WHERE order_id = %d &quot;, $this-&gt;id );&nbsp;</div></li><li><div>      $get_items_sql .= &quot;AND order_item_type IN ( '&quot; . implode( &quot;', '&quot;, array_map( 'esc_sql', $type ) ) . &quot;' ) ORDER BY order_item_id;&quot;;&nbsp;</div></li><li><div>      $line_items = $wpdb-&gt;get_results( $get_items_sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Loop items</span>&nbsp;</div></li><li><div>      foreach ( $line_items as $item ) {&nbsp;</div></li><li><div>          $items[ $item-&gt;order_item_id ]['name'] = $item-&gt;order_item_name;&nbsp;</div></li><li><div>          $items[ $item-&gt;order_item_id ]['type'] = $item-&gt;order_item_type;&nbsp;</div></li><li><div>          $items[ $item-&gt;order_item_id ]['item_meta'] = $this-&gt;get_item_meta( $item-&gt;order_item_id );&nbsp;</div></li><li><div>          $items[ $item-&gt;order_item_id ]['item_meta_array'] = $this-&gt;get_item_meta_array( $item-&gt;order_item_id );&nbsp;</div></li><li><div>          $items[ $item-&gt;order_item_id ]                    = $this-&gt;expand_item_meta( $items[ $item-&gt;order_item_id ] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_get_items', $items, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Expand item meta into the $item array.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.4.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $item before expansion.</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function expand_item_meta( $item ) {&nbsp;</div></li><li><div>      <span class="comment">// Reserved meta keys</span>&nbsp;</div></li><li><div>      $reserved_item_meta_keys = array(&nbsp;</div></li><li><div>          'name', &nbsp;</div></li><li><div>          'type', &nbsp;</div></li><li><div>          'item_meta', &nbsp;</div></li><li><div>          'item_meta_array', &nbsp;</div></li><li><div>          'qty', &nbsp;</div></li><li><div>          'tax_class', &nbsp;</div></li><li><div>          'product_id', &nbsp;</div></li><li><div>          'variation_id', &nbsp;</div></li><li><div>          'line_subtotal', &nbsp;</div></li><li><div>          'line_total', &nbsp;</div></li><li><div>          'line_tax', &nbsp;</div></li><li><div>          'line_subtotal_tax'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Expand item meta if set.</span>&nbsp;</div></li><li><div>      if ( ! empty( $item['item_meta'] ) ) {&nbsp;</div></li><li><div>          foreach ( $item['item_meta'] as $name =&gt; $value ) {&nbsp;</div></li><li><div>              if ( in_array( $name, $reserved_item_meta_keys ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ( '_' === substr( $name, 0, 1 ) ) {&nbsp;</div></li><li><div>                  $item[ substr( $name, 1 ) ] = $value[0];&nbsp;</div></li><li><div>              } elseif ( ! in_array( $name, $reserved_item_meta_keys ) ) {&nbsp;</div></li><li><div>                  $item[ $name ] = make_clickable( $value[0] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $item;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the count of order items of a certain type.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $item_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_count( $item_type = '' ) {&nbsp;</div></li><li><div>      if ( empty( $item_type ) ) {&nbsp;</div></li><li><div>          $item_type = array( 'line_item' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( ! is_array( $item_type ) ) {&nbsp;</div></li><li><div>          $item_type = array( $item_type );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $items = $this-&gt;get_items( $item_type );&nbsp;</div></li><li><div>      $count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $items as $item ) {&nbsp;</div></li><li><div>          $count += empty( $item['qty'] ) ? 1 : $item['qty'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_item_count', $count, $item_type, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get refunds</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_refunds() { return array(); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return an array of fees within this order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_fees() {&nbsp;</div></li><li><div>      return $this-&gt;get_items( 'fee' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return an array of taxes within this order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_taxes() {&nbsp;</div></li><li><div>      return $this-&gt;get_items( 'tax' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return an array of shipping costs within this order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_methods() {&nbsp;</div></li><li><div>      return $this-&gt;get_items( 'shipping' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check whether this order has a specific shipping method or not.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $method_id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_shipping_method( $method_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $shipping_methods = $this-&gt;get_shipping_methods();&nbsp;</div></li><li><div>      $has_method = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $shipping_methods ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $shipping_methods as $shipping_method ) {&nbsp;</div></li><li><div>          if ( $shipping_method['method_id'] == $method_id ) {&nbsp;</div></li><li><div>              $has_method = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $has_method;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get taxes, merged by code, formatted ready for output.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_tax_totals() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $taxes = $this-&gt;get_items( 'tax' );&nbsp;</div></li><li><div>      $tax_totals = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $taxes as $key =&gt; $tax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $code = $tax[ 'name' ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! isset( $tax_totals[ $code ] ) ) {&nbsp;</div></li><li><div>              $tax_totals[ $code ] = new stdClass();&nbsp;</div></li><li><div>              $tax_totals[ $code ]-&gt;amount = 0;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $tax_totals[ $code ]-&gt;id = $key;&nbsp;</div></li><li><div>          $tax_totals[ $code ]-&gt;rate_id = $tax['rate_id'];&nbsp;</div></li><li><div>          $tax_totals[ $code ]-&gt;is_compound = $tax[ 'compound' ];&nbsp;</div></li><li><div>          $tax_totals[ $code ]-&gt;label = isset( $tax[ 'label' ] ) ? $tax[ 'label' ] : $tax[ 'name' ];&nbsp;</div></li><li><div>          $tax_totals[ $code ]-&gt;amount           += $tax[ 'tax_amount' ] + $tax[ 'shipping_tax_amount' ];&nbsp;</div></li><li><div>          $tax_totals[ $code ]-&gt;formatted_amount = wc_price( wc_round_tax_total( $tax_totals[ $code ]-&gt;amount ), array('currency' =&gt; $this-&gt;get_order_currency()) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( apply_filters( 'woocommerce_order_hide_zero_taxes', true ) ) {&nbsp;</div></li><li><div>          $amounts = array_filter( wp_list_pluck( $tax_totals, 'amount' ) );&nbsp;</div></li><li><div>          $tax_totals = array_intersect_key( $tax_totals, $amounts );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_tax_totals', $tax_totals, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * has_meta function for order items.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $order_item_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of meta data.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_meta( $order_item_id ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT meta_key, meta_value, meta_id, order_item_id&nbsp;</div></li><li><div>          FROM {$wpdb-&gt;prefix}woocommerce_order_itemmeta WHERE order_item_id = %d&nbsp;</div></li><li><div>          ORDER BY meta_id&quot;, absint( $order_item_id ) ), ARRAY_A );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get all item meta data in array format in the order it was saved. Does not group meta by key like get_item_meta().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $order_item_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return array of objects</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_meta_array( $order_item_id ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get cache key - uses get_cache_prefix to invalidate when needed</span>&nbsp;</div></li><li><div>      $cache_key = WC_Cache_Helper::get_cache_prefix( 'orders' ) . 'item_meta_array_' . $order_item_id;&nbsp;</div></li><li><div>      $item_meta_array = wp_cache_get( $cache_key, 'orders' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === $item_meta_array ) {&nbsp;</div></li><li><div>          $item_meta_array = array();&nbsp;</div></li><li><div>          $metadata = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT meta_key, meta_value, meta_id FROM {$wpdb-&gt;prefix}woocommerce_order_itemmeta WHERE order_item_id = %d ORDER BY meta_id&quot;, absint( $order_item_id ) ) );&nbsp;</div></li><li><div>          foreach ( $metadata as $metadata_row ) {&nbsp;</div></li><li><div>              $item_meta_array[ $metadata_row-&gt;meta_id ] = (object) array( 'key' =&gt; $metadata_row-&gt;meta_key, 'value' =&gt; $metadata_row-&gt;meta_value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_cache_set( $cache_key, $item_meta_array, 'orders' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $item_meta_array ;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display meta data belonging to an item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function display_item_meta( $item ) {&nbsp;</div></li><li><div>      $product = $this-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>      $item_meta = new WC_Order_Item_Meta( $item, $product );&nbsp;</div></li><li><div>      $item_meta-&gt;display();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get order item meta.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $order_item_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key (default: '')</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $single (default: false)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array|string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_meta( $order_item_id, $key = '', $single = false ) {&nbsp;</div></li><li><div>      return get_metadata( 'order_item', $order_item_id, $key, $single );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** Total Getters *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the total discount amount.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $ex_tax Show discount excl any tax.</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total_discount( $ex_tax = true ) {&nbsp;</div></li><li><div>      if ( ! $this-&gt;order_version || version_compare( $this-&gt;order_version, '2.3.7', '&lt;' ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Backwards compatible total calculation - totals were not stored consistently in old versions.</span>&nbsp;</div></li><li><div>          if ( $ex_tax ) {&nbsp;</div></li><li><div>              if ( $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                  $total_discount = (double) $this-&gt;cart_discount - (double) $this-&gt;cart_discount_tax;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $total_discount = (double) $this-&gt;cart_discount;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ( $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                  $total_discount = (double) $this-&gt;cart_discount;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $total_discount = (double) $this-&gt;cart_discount + (double) $this-&gt;cart_discount_tax;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      <span class="comment">// New logic - totals are always stored exclusive of tax, tax total is stored in cart_discount_tax</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( $ex_tax ) {&nbsp;</div></li><li><div>              $total_discount = (double) $this-&gt;cart_discount;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $total_discount = (double) $this-&gt;cart_discount + (double) $this-&gt;cart_discount_tax;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_total_discount', round( $total_discount, wc_get_rounding_precision() ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the discount amount.</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated in favour of get_total_discount() since we now only have one discount type.</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_discount() {&nbsp;</div></li><li><div>      _deprecated_function( 'get_cart_discount', '2.3', 'get_total_discount' );&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_cart_discount', $this-&gt;get_total_discount(), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get cart discount (formatted).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated order (after tax) discounts removed in 2.3.0.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order_discount_to_display() {&nbsp;</div></li><li><div>      _deprecated_function( 'get_order_discount_to_display', '2.3' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the total (order) discount amount - these are applied after tax.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated order (after tax) discounts removed in 2.3.0.</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order_discount() {&nbsp;</div></li><li><div>      _deprecated_function( 'get_order_discount', '2.3' );&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_order_discount', (double) $this-&gt;order_discount, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets cart tax amount.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_tax() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_cart_tax', (double) $this-&gt;order_tax, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets shipping tax amount.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_tax() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_shipping_tax', (double) $this-&gt;order_shipping_tax, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets shipping and product tax.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total_tax() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_total_tax', wc_round_tax_total( $this-&gt;get_cart_tax() + $this-&gt;get_shipping_tax() ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets shipping total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total_shipping() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_total_shipping', (double) $this-&gt;order_shipping, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets order total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_total() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_total', (double) $this-&gt;order_total, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets order subtotal.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed|void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_subtotal() {&nbsp;</div></li><li><div>      $subtotal = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          $subtotal += ( isset( $item['line_subtotal'] ) ) ? $item['line_subtotal'] : 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_subtotal', (double) $subtotal, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get item subtotal - this is the cost before discount.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $inc_tax (default: false).</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $round (default: true).</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_subtotal( $item, $inc_tax = false, $round = true ) {&nbsp;</div></li><li><div>      if ( $inc_tax ) {&nbsp;</div></li><li><div>          $price = ( $item['line_subtotal'] + $item['line_subtotal_tax'] ) / max( 1, $item['qty'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $price = ( $item['line_subtotal'] / max( 1, $item['qty'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = $round ? number_format( (float) $price, wc_get_price_decimals(), '.', '' ) : $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_item_subtotal', $price, $this, $item, $inc_tax, $round );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get line subtotal - this is the cost before discount.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $inc_tax (default: false).</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $round (default: true).</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_line_subtotal( $item, $inc_tax = false, $round = true ) {&nbsp;</div></li><li><div>      if ( $inc_tax ) {&nbsp;</div></li><li><div>          $price = $item['line_subtotal'] + $item['line_subtotal_tax'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $price = $item['line_subtotal'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = $round ? round( $price, wc_get_price_decimals() ) : $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_line_subtotal', $price, $this, $item, $inc_tax, $round );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate item cost - useful for gateways.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $inc_tax (default: false).</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $round (default: true).</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_total( $item, $inc_tax = false, $round = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $qty = ( ! empty( $item['qty'] ) ) ? $item['qty'] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $inc_tax ) {&nbsp;</div></li><li><div>          $price = ( $item['line_total'] + $item['line_tax'] ) / max( 1, $qty );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $price = $item['line_total'] / max( 1, $qty );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = $round ? round( $price, wc_get_price_decimals() ) : $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_item_total', $price, $this, $item, $inc_tax, $round );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate line total - useful for gateways.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $inc_tax (default: false).</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $round (default: true).</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_line_total( $item, $inc_tax = false, $round = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if we need to add line tax to the line total.</span>&nbsp;</div></li><li><div>      $line_total = $inc_tax ? $item['line_total'] + $item['line_tax'] : $item['line_total'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if we need to round.</span>&nbsp;</div></li><li><div>      $line_total = $round ? round( $line_total, wc_get_price_decimals() ) : $line_total;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_line_total', $line_total, $this, $item, $inc_tax, $round );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate item tax - useful for gateways.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $round (default: true).</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_tax( $item, $round = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $price = $item['line_tax'] / max( 1, $item['qty'] );&nbsp;</div></li><li><div>      $price = $round ? wc_round_tax_total( $price ) : $price;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_item_tax', $price, $item, $round, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate line tax - useful for gateways.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @return float</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_line_tax( $item ) {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_amount_line_tax', wc_round_tax_total( $item['line_tax'] ), $item, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/** End Total Getters *******************************************************/</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets formatted shipping method title.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_method() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $labels = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Backwards compat &lt; 2.1 - get shipping title stored in meta.</span>&nbsp;</div></li><li><div>      if ( $this-&gt;shipping_method_title ) {&nbsp;</div></li><li><div>          $labels[] = $this-&gt;shipping_method_title;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// 2.1+ get line items for shipping.</span>&nbsp;</div></li><li><div>          $shipping_methods = $this-&gt;get_shipping_methods();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $shipping_methods as $shipping ) {&nbsp;</div></li><li><div>              $labels[] = $shipping['name'] ? $shipping['name'] : __( 'Shipping', 'woocommerce' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_shipping_method', implode( ', ', $labels ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets line subtotal - formatted for display.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array  $item</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $tax_display</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_formatted_line_subtotal( $item, $tax_display = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $tax_display ) {&nbsp;</div></li><li><div>          $tax_display = $this-&gt;tax_display_cart;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $item['line_subtotal'] ) || ! isset( $item['line_subtotal_tax'] ) ) {&nbsp;</div></li><li><div>          return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'excl' == $tax_display ) {&nbsp;</div></li><li><div>          $ex_tax_label = $this-&gt;prices_include_tax ? 1 : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $subtotal = wc_price( $this-&gt;get_line_subtotal( $item ), array( 'ex_tax_label' =&gt; $ex_tax_label, 'currency' =&gt; $this-&gt;get_order_currency() ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $subtotal = wc_price( $this-&gt;get_line_subtotal( $item, true ), array('currency' =&gt; $this-&gt;get_order_currency()) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_formatted_line_subtotal', $subtotal, $item, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets order currency.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order_currency() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_order_currency', $this-&gt;order_currency, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets order total - formatted for display.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_formatted_order_total() {&nbsp;</div></li><li><div>      $formatted_total = wc_price( $this-&gt;get_total(), array( 'currency' =&gt; $this-&gt;get_order_currency() ) );&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_formatted_order_total', $formatted_total, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets subtotal - subtotal is shown before discounts, but with localised taxes.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $compound (default: false).</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $tax_display (default: the tax_display_cart value).</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_subtotal_to_display( $compound = false, $tax_display = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $tax_display ) {&nbsp;</div></li><li><div>          $tax_display = $this-&gt;tax_display_cart;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $subtotal = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $compound ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! isset( $item['line_subtotal'] ) || ! isset( $item['line_subtotal_tax'] ) ) {&nbsp;</div></li><li><div>                  return '';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $subtotal += $item['line_subtotal'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 'incl' == $tax_display ) {&nbsp;</div></li><li><div>                  $subtotal += $item['line_subtotal_tax'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $subtotal = wc_price( $subtotal, array('currency' =&gt; $this-&gt;get_order_currency()) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $tax_display == 'excl' && $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>              $subtotal .= ' &lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;ex_tax_or_vat() . '&lt;/small&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( 'incl' == $tax_display ) {&nbsp;</div></li><li><div>              return '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $subtotal += $item['line_subtotal'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Add Shipping Costs.</span>&nbsp;</div></li><li><div>          $subtotal += $this-&gt;get_total_shipping();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Remove non-compound taxes.</span>&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_taxes() as $tax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! empty( $tax['compound'] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $subtotal = $subtotal + $tax['tax_amount'] + $tax['shipping_tax_amount'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Remove discounts.</span>&nbsp;</div></li><li><div>          $subtotal = $subtotal - $this-&gt;get_total_discount();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $subtotal = wc_price( $subtotal, array('currency' =&gt; $this-&gt;get_order_currency()) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_subtotal_to_display', $subtotal, $compound, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets shipping (formatted).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_shipping_to_display( $tax_display = '' ) {&nbsp;</div></li><li><div>      if ( ! $tax_display ) {&nbsp;</div></li><li><div>          $tax_display = $this-&gt;tax_display_cart;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;order_shipping != 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $tax_display == 'excl' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Show shipping excluding tax.</span>&nbsp;</div></li><li><div>              $shipping = wc_price( $this-&gt;order_shipping, array('currency' =&gt; $this-&gt;get_order_currency()) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;order_shipping_tax != 0 && $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                  $shipping .= apply_filters( 'woocommerce_order_shipping_to_display_tax_label', '&nbsp;&lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;ex_tax_or_vat() . '&lt;/small&gt;', $this, $tax_display );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Show shipping including tax.</span>&nbsp;</div></li><li><div>              $shipping = wc_price( $this-&gt;order_shipping + $this-&gt;order_shipping_tax, array('currency' =&gt; $this-&gt;get_order_currency()) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $this-&gt;order_shipping_tax != 0 && ! $this-&gt;prices_include_tax ) {&nbsp;</div></li><li><div>                  $shipping .= apply_filters( 'woocommerce_order_shipping_to_display_tax_label', '&nbsp;&lt;small class=&quot;tax_label&quot;&gt;' . WC()-&gt;countries-&gt;inc_tax_or_vat() . '&lt;/small&gt;', $this, $tax_display );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $shipping .= apply_filters( 'woocommerce_order_shipping_to_display_shipped_via', '&nbsp;&lt;small class=&quot;shipped_via&quot;&gt;' . sprintf( __( 'via %s', 'woocommerce' ), $this-&gt;get_shipping_method() ) . '&lt;/small&gt;', $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( $this-&gt;get_shipping_method() ) {&nbsp;</div></li><li><div>          $shipping = $this-&gt;get_shipping_method();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $shipping = __( 'Free!', 'woocommerce' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_shipping_to_display', $shipping, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the discount amount (formatted).</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.3.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_discount_to_display( $tax_display = '' ) {&nbsp;</div></li><li><div>      if ( ! $tax_display ) {&nbsp;</div></li><li><div>          $tax_display = $this-&gt;tax_display_cart;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_discount_to_display', wc_price( $this-&gt;get_total_discount( $tax_display === 'excl' && $this-&gt;display_totals_ex_tax ), array( 'currency' =&gt; $this-&gt;get_order_currency() ) ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get cart discount (formatted).</span>&nbsp;</div></li><li><div><span class="comment">   * @deprecated</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cart_discount_to_display( $tax_display = '' ) {&nbsp;</div></li><li><div>      _deprecated_function( 'get_cart_discount_to_display', '2.3', 'get_discount_to_display' );&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_cart_discount_to_display', $this-&gt;get_discount_to_display( $tax_display ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get a product (either product or variation).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $item</span>&nbsp;</div></li><li><div><span class="comment">   * @return WC_Product</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_product_from_item( $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $item['variation_id'] ) && 'product_variation' === get_post_type( $item['variation_id'] ) ) {&nbsp;</div></li><li><div>          $_product = wc_get_product( $item['variation_id'] );&nbsp;</div></li><li><div>      } elseif ( ! empty( $item['product_id'] ) ) {&nbsp;</div></li><li><div>          $_product = wc_get_product( $item['product_id'] );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $_product = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_product_from_item', $_product, $item, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get totals for display on pages and in emails.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $tax_display</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_order_item_totals( $tax_display = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $tax_display ) {&nbsp;</div></li><li><div>          $tax_display = $this-&gt;tax_display_cart;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $total_rows = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $subtotal = $this-&gt;get_subtotal_to_display( false, $tax_display ) ) {&nbsp;</div></li><li><div>          $total_rows['cart_subtotal'] = array(&nbsp;</div></li><li><div>              'label' =&gt; __( 'Subtotal:', 'woocommerce' ), &nbsp;</div></li><li><div>              'value' =&gt; $subtotal&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;get_total_discount() &gt; 0 ) {&nbsp;</div></li><li><div>          $total_rows['discount'] = array(&nbsp;</div></li><li><div>              'label' =&gt; __( 'Discount:', 'woocommerce' ), &nbsp;</div></li><li><div>              'value' =&gt; '-' . $this-&gt;get_discount_to_display( $tax_display )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;get_shipping_method() ) {&nbsp;</div></li><li><div>          $total_rows['shipping'] = array(&nbsp;</div></li><li><div>              'label' =&gt; __( 'Shipping:', 'woocommerce' ), &nbsp;</div></li><li><div>              'value' =&gt; $this-&gt;get_shipping_to_display( $tax_display )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $fees = $this-&gt;get_fees() ) {&nbsp;</div></li><li><div>          foreach ( $fees as $id =&gt; $fee ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( apply_filters( 'woocommerce_get_order_item_totals_excl_free_fees', $fee['line_total'] + $fee['line_tax'] == 0, $id ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( 'excl' == $tax_display ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $total_rows[ 'fee_' . $id ] = array(&nbsp;</div></li><li><div>                      'label' =&gt; ( $fee['name'] ? $fee['name'] : __( 'Fee', 'woocommerce' ) ) . ':', &nbsp;</div></li><li><div>                      'value' =&gt; wc_price( $fee['line_total'], array('currency' =&gt; $this-&gt;get_order_currency()) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $total_rows[ 'fee_' . $id ] = array(&nbsp;</div></li><li><div>                      'label' =&gt; $fee['name'] . ':', &nbsp;</div></li><li><div>                      'value' =&gt; wc_price( $fee['line_total'] + $fee['line_tax'], array('currency' =&gt; $this-&gt;get_order_currency()) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Tax for tax exclusive prices.</span>&nbsp;</div></li><li><div>      if ( 'excl' === $tax_display ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( get_option( 'woocommerce_tax_total_display' ) == 'itemized' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $this-&gt;get_tax_totals() as $code =&gt; $tax ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $total_rows[ sanitize_title( $code ) ] = array(&nbsp;</div></li><li><div>                      'label' =&gt; $tax-&gt;label . ':', &nbsp;</div></li><li><div>                      'value' =&gt; $tax-&gt;formatted_amount&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $total_rows['tax'] = array(&nbsp;</div></li><li><div>                  'label' =&gt; WC()-&gt;countries-&gt;tax_or_vat() . ':', &nbsp;</div></li><li><div>                  'value' =&gt; wc_price( $this-&gt;get_total_tax(), array( 'currency' =&gt; $this-&gt;get_order_currency() ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;get_total() &gt; 0 && $this-&gt;payment_method_title ) {&nbsp;</div></li><li><div>          $total_rows['payment_method'] = array(&nbsp;</div></li><li><div>              'label' =&gt; __( 'Payment Method:', 'woocommerce' ), &nbsp;</div></li><li><div>              'value' =&gt; $this-&gt;payment_method_title&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $refunds = $this-&gt;get_refunds() ) {&nbsp;</div></li><li><div>          foreach ( $refunds as $id =&gt; $refund ) {&nbsp;</div></li><li><div>              $total_rows[ 'refund_' . $id ] = array(&nbsp;</div></li><li><div>                  'label' =&gt; $refund-&gt;get_refund_reason() ? $refund-&gt;get_refund_reason() : __( 'Refund', 'woocommerce' ) . ':', &nbsp;</div></li><li><div>                  'value' =&gt; wc_price( '-' . $refund-&gt;get_refund_amount(), array( 'currency' =&gt; $this-&gt;get_order_currency() ) )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $total_rows['order_total'] = array(&nbsp;</div></li><li><div>          'label' =&gt; __( 'Total:', 'woocommerce' ), &nbsp;</div></li><li><div>          'value' =&gt; $this-&gt;get_formatted_order_total( $tax_display )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_order_item_totals', $total_rows, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Output items for display in html emails.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args Items args.</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $deprecated1 Deprecated arg.</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $deprecated2 Deprecated arg.</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $deprecated3 Deprecated arg.</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $deprecated4 Deprecated arg.</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $deprecated5 Deprecated arg.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function email_order_items_table( $args = array(), $deprecated1 = null, $deprecated2 = null, $deprecated3 = null, $deprecated4 = null, $deprecated5 = null ) {&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_null( $deprecated1 ) || ! is_null( $deprecated2 ) || ! is_null( $deprecated3 ) || ! is_null( $deprecated4 ) || ! is_null( $deprecated5 ) ) {&nbsp;</div></li><li><div>          _deprecated_argument( __FUNCTION__, '2.5.0' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $defaults = array(&nbsp;</div></li><li><div>          'show_sku' =&gt; false, &nbsp;</div></li><li><div>          'show_image' =&gt; false, &nbsp;</div></li><li><div>          'image_size' =&gt; array( 32, 32 ), &nbsp;</div></li><li><div>          'plain_text' =&gt; false, &nbsp;</div></li><li><div>          'sent_to_admin' =&gt; false&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>      $template = $args['plain_text'] ? 'emails/plain/email-order-items.php' : 'emails/email-order-items.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wc_get_template( $template, apply_filters( 'woocommerce_email_order_items_args', array(&nbsp;</div></li><li><div>          'order' =&gt; $this, &nbsp;</div></li><li><div>          'items' =&gt; $this-&gt;get_items(), &nbsp;</div></li><li><div>          'show_download_links' =&gt; $this-&gt;is_download_permitted() && ! $args['sent_to_admin'], &nbsp;</div></li><li><div>          'show_sku' =&gt; $args['show_sku'], &nbsp;</div></li><li><div>          'show_purchase_note' =&gt; $this-&gt;is_paid() && ! $args['sent_to_admin'], &nbsp;</div></li><li><div>          'show_image' =&gt; $args['show_image'], &nbsp;</div></li><li><div>          'image_size' =&gt; $args['image_size'], &nbsp;</div></li><li><div>          'plain_text' =&gt; $args['plain_text'], &nbsp;</div></li><li><div>          'sent_to_admin' =&gt; $args['sent_to_admin']&nbsp;</div></li><li><div> ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_email_order_items_table', ob_get_clean(), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns if an order has been paid for based on the order status.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_paid() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_is_paid', $this-&gt;has_status( apply_filters( 'woocommerce_order_is_paid_statuses', array( 'processing', 'completed' ) ) ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if product download is permitted.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_download_permitted() {&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_is_download_permitted', $this-&gt;has_status( 'completed' ) || ( get_option( 'woocommerce_downloads_grant_access_after_payment' ) == 'yes' && $this-&gt;has_status( 'processing' ) ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if the order contains a downloadable product.</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_downloadable_item() {&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          $_product = $this-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $_product && $_product-&gt;exists() && $_product-&gt;is_downloadable() && $_product-&gt;has_file() ) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns true if the order contains a free product.</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.5.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function has_free_item() {&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          if ( ! $item['line_total'] ) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a URL so that a customer can pay for their (unpaid - pending) order. Pass 'true' for the checkout version which doesn't offer gateway choices.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $on_checkout</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_checkout_payment_url( $on_checkout = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $pay_url = wc_get_endpoint_url( 'order-pay', $this-&gt;id, wc_get_page_permalink( 'checkout' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' == get_option( 'woocommerce_force_ssl_checkout' ) || is_ssl() ) {&nbsp;</div></li><li><div>          $pay_url = str_replace( 'http:', 'https:', $pay_url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $on_checkout ) {&nbsp;</div></li><li><div>          $pay_url = add_query_arg( 'key', $this-&gt;order_key, $pay_url );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $pay_url = add_query_arg( array( 'pay_for_order' =&gt; 'true', 'key' =&gt; $this-&gt;order_key ), $pay_url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_checkout_payment_url', $pay_url, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a URL for the thanks page (order received).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_checkout_order_received_url() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order_received_url = wc_get_endpoint_url( 'order-received', $this-&gt;id, wc_get_page_permalink( 'checkout' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' == get_option( 'woocommerce_force_ssl_checkout' ) || is_ssl() ) {&nbsp;</div></li><li><div>          $order_received_url = str_replace( 'http:', 'https:', $order_received_url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $order_received_url = add_query_arg( 'key', $this-&gt;order_key, $order_received_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_checkout_order_received_url', $order_received_url, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a URL so that a customer can cancel their (unpaid - pending) order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $redirect</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cancel_order_url( $redirect = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get cancel endpoint</span></span>&nbsp;</div></li><li><div>      $cancel_endpoint = $this-&gt;get_cancel_endpoint();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_cancel_order_url', esc_url( add_query_arg( array(&nbsp;</div></li><li><div>          'cancel_order' =&gt; 'true', &nbsp;</div></li><li><div>          'order' =&gt; $this-&gt;order_key, &nbsp;</div></li><li><div>          'order_id' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>          'redirect' =&gt; $redirect, &nbsp;</div></li><li><div> ), $cancel_endpoint ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a raw (unescaped) cancel-order URL for use by payment gateways.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $redirect</span>&nbsp;</div></li><li><div><span class="comment">   * @return string The unescaped cancel-order URL.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cancel_order_url_raw( $redirect = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Get cancel endpoint</span></span>&nbsp;</div></li><li><div>      $cancel_endpoint = $this-&gt;get_cancel_endpoint();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_cancel_order_url_raw', add_query_arg( array(&nbsp;</div></li><li><div>          'cancel_order' =&gt; 'true', &nbsp;</div></li><li><div>          'order' =&gt; $this-&gt;order_key, &nbsp;</div></li><li><div>          'order_id' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>          'redirect' =&gt; $redirect, &nbsp;</div></li><li><div> ), $cancel_endpoint ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Helper method to return the cancel endpoint.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string the cancel endpoint; either the cart page or the home page.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_cancel_endpoint() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cancel_endpoint = wc_get_page_permalink( 'cart' );&nbsp;</div></li><li><div>      if ( ! $cancel_endpoint ) {&nbsp;</div></li><li><div>          $cancel_endpoint = home_url();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === strpos( $cancel_endpoint, '?' ) ) {&nbsp;</div></li><li><div>          $cancel_endpoint = trailingslashit( $cancel_endpoint );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $cancel_endpoint;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a URL to view an order from the my account page.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_view_order_url() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $view_order_url = wc_get_endpoint_url( 'view-order', $this-&gt;id, wc_get_page_permalink( 'myaccount' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_view_order_url', $view_order_url, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the downloadable files for an item in this order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $item</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_item_downloads( $item ) {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $product_id = $item['variation_id'] &gt; 0 ? $item['variation_id'] : $item['product_id'];&nbsp;</div></li><li><div>      $product = wc_get_product( $product_id );&nbsp;</div></li><li><div>      if ( ! $product ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * $product can be `false`. Example: checking an old order, when a product or variation has been deleted.</span>&nbsp;</div></li><li><div><span class="comment">           * @see \WC_Product_Factory::get_product</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>          return array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $download_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare(&quot;&nbsp;</div></li><li><div>          SELECT download_id&nbsp;</div></li><li><div>          FROM {$wpdb-&gt;prefix}woocommerce_downloadable_product_permissions&nbsp;</div></li><li><div>          WHERE user_email = %s&nbsp;</div></li><li><div>          AND order_key = %s&nbsp;</div></li><li><div>          AND product_id = %s&nbsp;</div></li><li><div>          ORDER BY permission_id&nbsp;</div></li><li><div>      &quot;, $this-&gt;billing_email, $this-&gt;order_key, $product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $files = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $download_ids as $download_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $product-&gt;has_file( $download_id ) ) {&nbsp;</div></li><li><div>              $files[ $download_id ]                 = $product-&gt;get_file( $download_id );&nbsp;</div></li><li><div>              $files[ $download_id ]['download_url'] = $this-&gt;get_download_url( $product_id, $download_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_get_item_downloads', $files, $item, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display download links for an order item.</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $item</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function display_item_downloads( $item ) {&nbsp;</div></li><li><div>      $product = $this-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $product && $product-&gt;exists() && $product-&gt;is_downloadable() && $this-&gt;is_download_permitted() ) {&nbsp;</div></li><li><div>          $download_files = $this-&gt;get_item_downloads( $item );&nbsp;</div></li><li><div>          $i = 0;&nbsp;</div></li><li><div>          $links = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $download_files as $download_id =&gt; $file ) {&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>              $prefix = count( $download_files ) &gt; 1 ? sprintf( __( 'Download %d', 'woocommerce' ), $i ) : __( 'Download', 'woocommerce' );&nbsp;</div></li><li><div>              $links[] = '&lt;small class=&quot;download-url&quot;&gt;' . $prefix . ': &lt;a href=&quot;' . esc_url( $file['download_url'] ) . '&quot; target=&quot;_blank&quot;&gt;' . esc_html( $file['name'] ) . '&lt;/a&gt;&lt;/small&gt;' . &quot;\n&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo '&lt;br/&gt;' . implode( '&lt;br/&gt;', $links );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the Download URL.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $product_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int $download_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_download_url( $product_id, $download_id ) {&nbsp;</div></li><li><div>      return add_query_arg( array(&nbsp;</div></li><li><div>          'download_file' =&gt; $product_id, &nbsp;</div></li><li><div>          'order' =&gt; $this-&gt;order_key, &nbsp;</div></li><li><div>          'email' =&gt; urlencode( $this-&gt;billing_email ), &nbsp;</div></li><li><div>          'key' =&gt; $download_id&nbsp;</div></li><li><div> ), trailingslashit( home_url() ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds a note (comment) to the order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $note Note to add.</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $is_customer_note (default: 0) Is this a note for the customer?</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool added_by_user Was the note added by a user?</span>&nbsp;</div></li><li><div><span class="comment">   * @return int Comment ID.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function add_order_note( $note, $is_customer_note = 0, $added_by_user = false ) {&nbsp;</div></li><li><div>      if ( is_user_logged_in() && current_user_can( 'edit_shop_order', $this-&gt;id ) && $added_by_user ) {&nbsp;</div></li><li><div>          $user = get_user_by( 'id', get_current_user_id() );&nbsp;</div></li><li><div>          $comment_author = $user-&gt;display_name;&nbsp;</div></li><li><div>          $comment_author_email = $user-&gt;user_email;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $comment_author = __( 'WooCommerce', 'woocommerce' );&nbsp;</div></li><li><div>          $comment_author_email = strtolower( __( 'WooCommerce', 'woocommerce' ) ) . '@';&nbsp;</div></li><li><div>          $comment_author_email .= isset( $_SERVER['HTTP_HOST'] ) ? str_replace( 'www.', '', $_SERVER['HTTP_HOST'] ) : 'noreply.com';&nbsp;</div></li><li><div>          $comment_author_email = sanitize_email( $comment_author_email );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $comment_post_ID = $this-&gt;id;&nbsp;</div></li><li><div>      $comment_author_url = '';&nbsp;</div></li><li><div>      $comment_content = $note;&nbsp;</div></li><li><div>      $comment_agent = 'WooCommerce';&nbsp;</div></li><li><div>      $comment_type = 'order_note';&nbsp;</div></li><li><div>      $comment_parent = 0;&nbsp;</div></li><li><div>      $comment_approved = 1;&nbsp;</div></li><li><div>      $commentdata = apply_filters( 'woocommerce_new_order_note_data', compact( 'comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_agent', 'comment_type', 'comment_parent', 'comment_approved' ), array( 'order_id' =&gt; $this-&gt;id, 'is_customer_note' =&gt; $is_customer_note ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $comment_id = wp_insert_comment( $commentdata );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $is_customer_note ) {&nbsp;</div></li><li><div>          add_comment_meta( $comment_id, 'is_customer_note', 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_new_customer_note', array( 'order_id' =&gt; $this-&gt;id, 'customer_note' =&gt; $commentdata['comment_content'] ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $comment_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Updates status of order.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $new_status Status to change the order to. No internal wc- prefix is required.</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $note (default: '') Optional note to add.</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $manual is this a manual order status change?</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool Successful change or not</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function update_status( $new_status, $note = '', $manual = false ) {&nbsp;</div></li><li><div>      if ( ! $this-&gt;id ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Standardise status names.</span>&nbsp;</div></li><li><div>      $new_status = 'wc-' === substr( $new_status, 0, 3 ) ? substr( $new_status, 3 ) : $new_status;&nbsp;</div></li><li><div>      $old_status = $this-&gt;get_status();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the old status is unknown (e.g. draft) assume its pending for action usage.</span>&nbsp;</div></li><li><div>      if ( ! in_array( 'wc-' . $old_status, array_keys( wc_get_order_statuses() ) ) ) {&nbsp;</div></li><li><div>          $old_status = 'pending';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the statuses are the same there is no need to update, unless the post status is not a valid 'wc' status.</span>&nbsp;</div></li><li><div>      if ( $new_status === $old_status && in_array( $this-&gt;post_status, array_keys( wc_get_order_statuses() ) ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;post_status = 'wc-' . $new_status;&nbsp;</div></li><li><div>      $update_post_data = array(&nbsp;</div></li><li><div>          'ID' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>          'post_status' =&gt; $this-&gt;post_status, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'pending' === $old_status && ! $manual ) {&nbsp;</div></li><li><div>          $update_post_data[ 'post_date' ]     = current_time( 'mysql', 0 );&nbsp;</div></li><li><div>          $update_post_data[ 'post_date_gmt' ] = current_time( 'mysql', 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! wp_update_post( $update_post_data ) ) {&nbsp;</div></li><li><div>          $this-&gt;add_order_note( sprintf( __( 'Unable to update order from %1$s to %2$s.', 'woocommerce' ), wc_get_order_status_name( $old_status ), wc_get_order_status_name( $new_status ) ), 0, $manual );&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Status was set.</span>&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_status_' . $new_status, $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Status was changed.</span>&nbsp;</div></li><li><div>      if ( $new_status !== $old_status ) {&nbsp;</div></li><li><div>          $this-&gt;add_order_note( trim( $note . ' ' . sprintf( __( 'Order status changed from %1$s to %2$s.', 'woocommerce' ), wc_get_order_status_name( $old_status ), wc_get_order_status_name( $new_status ) ) ), 0, $manual );&nbsp;</div></li><li><div>          do_action( 'woocommerce_order_status_' . $old_status . '_to_' . $new_status, $this-&gt;id );&nbsp;</div></li><li><div>          do_action( 'woocommerce_order_status_changed', $this-&gt;id, $old_status, $new_status );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;add_order_note( trim( $note . ' ' . sprintf( __( 'Order status changed to %s.', 'woocommerce' ), wc_get_order_status_name( $new_status ) ) ), 0, $manual );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( $new_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'completed' :&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Record the sales.</span></span>&nbsp;</div></li><li><div>              $this-&gt;record_product_sales();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Increase coupon usage counts.</span></span>&nbsp;</div></li><li><div>              $this-&gt;increase_coupon_usage_counts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Record the completed date of the order.</span>&nbsp;</div></li><li><div>              update_post_meta( $this-&gt;id, '_completed_date', current_time('mysql') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update</span> reports.&nbsp;</div></li><li><div>              wc_delete_shop_order_transients( $this-&gt;id );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'processing' :&nbsp;</div></li><li><div>          case 'on-hold' :&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Record the sales.</span></span>&nbsp;</div></li><li><div>              $this-&gt;record_product_sales();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Increase coupon usage counts.</span></span>&nbsp;</div></li><li><div>              $this-&gt;increase_coupon_usage_counts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update</span> reports.&nbsp;</div></li><li><div>              wc_delete_shop_order_transients( $this-&gt;id );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'cancelled' :&nbsp;</div></li><li><div>              <span class="comment">// If the order is cancelled, restore used coupons.</span>&nbsp;</div></li><li><div>              $this-&gt;decrease_coupon_usage_counts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// Update</span> reports.&nbsp;</div></li><li><div>              wc_delete_shop_order_transients( $this-&gt;id );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Cancel the order and restore the cart (before payment).</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $note (default: '') Optional note to add.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function cancel_order( $note = '' ) {&nbsp;</div></li><li><div>      WC()-&gt;session-&gt;set( 'order_awaiting_payment', false );&nbsp;</div></li><li><div>      $this-&gt;update_status( 'cancelled', $note );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * When a payment is complete this function is called.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Most of the time this should mark an order as 'processing' so that admin can process/post the items.</span>&nbsp;</div></li><li><div><span class="comment">   * If the cart contains only downloadable items then the order is 'completed' since the admin needs to take no action.</span>&nbsp;</div></li><li><div><span class="comment">   * Stock levels are reduced at this point.</span>&nbsp;</div></li><li><div><span class="comment">   * Sales are also recorded for products.</span>&nbsp;</div></li><li><div><span class="comment">   * Finally, record the date of payment.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $transaction_id Optional transaction id to store in post meta.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function payment_complete( $transaction_id = '' ) {&nbsp;</div></li><li><div>      do_action( 'woocommerce_pre_payment_complete', $this-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( null !== WC()-&gt;session ) {&nbsp;</div></li><li><div>          WC()-&gt;session-&gt;set( 'order_awaiting_payment', false );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $valid_order_statuses = apply_filters( 'woocommerce_valid_order_statuses_for_payment_complete', array( 'on-hold', 'pending', 'failed', 'cancelled' ), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;id && $this-&gt;has_status( $valid_order_statuses ) ) {&nbsp;</div></li><li><div>          $order_needs_processing = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( sizeof( $this-&gt;get_items() ) &gt; 0 ) {&nbsp;</div></li><li><div>              foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>                  if ( $_product = $this-&gt;get_product_from_item( $item ) ) {&nbsp;</div></li><li><div>                      $virtual_downloadable_item = $_product-&gt;is_downloadable() && $_product-&gt;is_virtual();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( apply_filters( 'woocommerce_order_item_needs_processing', ! $virtual_downloadable_item, $_product, $this-&gt;id ) ) {&nbsp;</div></li><li><div>                          $order_needs_processing = true;&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $order_needs_processing = true;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;update_status( apply_filters( 'woocommerce_payment_complete_order_status', $order_needs_processing ? 'processing' : 'completed', $this-&gt;id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_post_meta( $this-&gt;id, '_paid_date', current_time( 'mysql' ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $transaction_id ) ) {&nbsp;</div></li><li><div>              update_post_meta( $this-&gt;id, '_transaction_id', $transaction_id );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Payment is complete so reduce stock levels</span>&nbsp;</div></li><li><div>          if ( apply_filters( 'woocommerce_payment_complete_reduce_order_stock', ! get_post_meta( $this-&gt;id, '_order_stock_reduced', true ), $this-&gt;id ) ) {&nbsp;</div></li><li><div>              $this-&gt;reduce_order_stock();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_payment_complete', $this-&gt;id );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          do_action( 'woocommerce_payment_complete_order_status_' . $this-&gt;get_status(), $this-&gt;id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Record sales.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function record_product_sales() {&nbsp;</div></li><li><div>      if ( 'yes' === get_post_meta( $this-&gt;id, '_recorded_sales', true ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( sizeof( $this-&gt;get_items() ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $item['product_id'] &gt; 0 ) {&nbsp;</div></li><li><div>                  $sales = (int) get_post_meta( $item['product_id'], 'total_sales', true );&nbsp;</div></li><li><div>                  $sales += (int) $item['qty'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $sales ) {&nbsp;</div></li><li><div>                      update_post_meta( $item['product_id'], 'total_sales', $sales );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      update_post_meta( $this-&gt;id, '_recorded_sales', 'yes' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Called when sales for an order are recorded</span>&nbsp;</div></li><li><div><span class="comment">       *</span>&nbsp;</div></li><li><div><span class="comment">       * @param int $order_id order id</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'woocommerce_recorded_sales', $this-&gt;id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get coupon codes only.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_used_coupons() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $codes = array();&nbsp;</div></li><li><div>      $coupons = $this-&gt;get_items( 'coupon' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $coupons as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>          $codes[] = trim( $item['name'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $codes;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Increase applied coupon counts.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function increase_coupon_usage_counts() {&nbsp;</div></li><li><div>      if ( 'yes' == get_post_meta( $this-&gt;id, '_recorded_coupon_usage_counts', true ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( sizeof( $this-&gt;get_used_coupons() ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_used_coupons() as $code ) {&nbsp;</div></li><li><div>              if ( ! $code ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $used_by = $this-&gt;get_user_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $used_by ) {&nbsp;</div></li><li><div>                  $used_by = $this-&gt;billing_email;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $coupon-&gt;inc_usage_count( $used_by );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_post_meta( $this-&gt;id, '_recorded_coupon_usage_counts', 'yes' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Decrease applied coupon counts.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function decrease_coupon_usage_counts() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' != get_post_meta( $this-&gt;id, '_recorded_coupon_usage_counts', true ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( sizeof( $this-&gt;get_used_coupons() ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_used_coupons() as $code ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $code ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $used_by = $this-&gt;get_user_id();&nbsp;</div></li><li><div>              if ( ! $used_by ) {&nbsp;</div></li><li><div>                  $used_by = $this-&gt;billing_email;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $coupon-&gt;dcr_usage_count( $used_by );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          delete_post_meta( $this-&gt;id, '_recorded_coupon_usage_counts' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Reduce stock levels for all line items in the order.</span>&nbsp;</div></li><li><div><span class="comment">   * Runs if stock management is enabled, but can be disabled on per-order basis by extensions @since 2.4.0 via woocommerce_can_reduce_order_stock hook.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function reduce_order_stock() {&nbsp;</div></li><li><div>      if ( 'yes' === get_option( 'woocommerce_manage_stock' ) && apply_filters( 'woocommerce_can_reduce_order_stock', true, $this ) && sizeof( $this-&gt;get_items() ) &gt; 0 ) {&nbsp;</div></li><li><div>          foreach ( $this-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>              if ( $item['product_id'] &gt; 0 ) {&nbsp;</div></li><li><div>                  $_product = $this-&gt;get_product_from_item( $item );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if ( $_product && $_product-&gt;exists() && $_product-&gt;managing_stock() ) {&nbsp;</div></li><li><div>                      $qty = apply_filters( 'woocommerce_order_item_quantity', $item['qty'], $this, $item );&nbsp;</div></li><li><div>                      $new_stock = $_product-&gt;reduce_stock( $qty );&nbsp;</div></li><li><div>                      $item_name = $_product-&gt;get_sku() ? $_product-&gt;get_sku(): $item['product_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( isset( $item['variation_id'] ) && $item['variation_id'] ) {&nbsp;</div></li><li><div>                          $this-&gt;add_order_note( sprintf( __( 'Item %1$s variation #%2$s stock reduced from %3$s to %4$s.', 'woocommerce' ), $item_name, $item['variation_id'], $new_stock + $qty, $new_stock) );&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $this-&gt;add_order_note( sprintf( __( 'Item %1$s stock reduced from %2$s to %3$s.', 'woocommerce' ), $item_name, $new_stock + $qty, $new_stock) );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $this-&gt;send_stock_notifications( $_product, $new_stock, $item['qty'] );&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          add_post_meta( $this-&gt;id, '_order_stock_reduced', '1', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_reduce_order_stock', $this );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Send the stock notifications.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param WC_Product $product</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $new_stock</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $qty_ordered</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function send_stock_notifications( $product, $new_stock, $qty_ordered ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Backorders</span></span>&nbsp;</div></li><li><div>      if ( $new_stock &lt; 0 ) {&nbsp;</div></li><li><div>          do_action( 'woocommerce_product_on_backorder', array( 'product' =&gt; $product, 'order_id' =&gt; $this-&gt;id, 'quantity' =&gt; $qty_ordered ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// stock status notifications</span>&nbsp;</div></li><li><div>      $notification_sent = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'yes' == get_option( 'woocommerce_notify_no_stock' ) && get_option( 'woocommerce_notify_no_stock_amount' ) &gt;= $new_stock ) {&nbsp;</div></li><li><div>          do_action( 'woocommerce_no_stock', $product );&nbsp;</div></li><li><div>          $notification_sent = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $notification_sent && 'yes' == get_option( 'woocommerce_notify_low_stock' ) && get_option( 'woocommerce_notify_low_stock_amount' ) &gt;= $new_stock ) {&nbsp;</div></li><li><div>          do_action( 'woocommerce_low_stock', $product );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_after_send_stock_notifications', $product, $new_stock, $qty_ordered );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * List order notes (public) for the customer.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_customer_order_notes() {&nbsp;</div></li><li><div>      $notes = array();&nbsp;</div></li><li><div>      $args = array(&nbsp;</div></li><li><div>          'post_id' =&gt; $this-&gt;id, &nbsp;</div></li><li><div>          'approve' =&gt; 'approve', &nbsp;</div></li><li><div>          'type' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      remove_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $comments = get_comments( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $comments as $comment ) {&nbsp;</div></li><li><div>          if ( ! get_comment_meta( $comment-&gt;comment_ID, 'is_customer_note', true ) ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $comment-&gt;comment_content = make_clickable( $comment-&gt;comment_content );&nbsp;</div></li><li><div>          $notes[] = $comment;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'comments_clauses', array( 'WC_Comments', 'exclude_order_comments' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $notes;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if an order needs payment, based on status and order total.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function needs_payment() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $valid_order_statuses = apply_filters( 'woocommerce_valid_order_statuses_for_payment', array( 'pending', 'failed' ), $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $this-&gt;has_status( $valid_order_statuses ) && $this-&gt;get_total() &gt; 0 ) {&nbsp;</div></li><li><div>          $needs_payment = true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $needs_payment = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_needs_payment', $needs_payment, $this, $valid_order_statuses );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if an order needs display the shipping address, based on shipping method.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function needs_shipping_address() {&nbsp;</div></li><li><div>      if ( ! wc_shipping_enabled() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $hide = apply_filters( 'woocommerce_order_hide_shipping_address', array( 'local_pickup' ), $this );&nbsp;</div></li><li><div>      $needs_address = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $this-&gt;get_shipping_methods() as $shipping_method ) {&nbsp;</div></li><li><div>          if ( ! in_array( $shipping_method['method_id'], $hide ) ) {&nbsp;</div></li><li><div>              $needs_address = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'woocommerce_order_needs_shipping_address', $needs_address, $hide, $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Checks if an order can be edited, specifically for use on the Edit Order screen.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_editable() {&nbsp;</div></li><li><div>      return apply_filters( 'wc_order_is_editable', in_array( $this-&gt;get_status(), array( 'pending', 'on-hold', 'auto-draft', 'failed' ) ), $this );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce</li><li><span></span>2.6.4</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>