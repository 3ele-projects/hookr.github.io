<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.0.6" data-slug="woocommerce" data-type="class" data-id="41167"><head xmlns="http://www.w3.org/1999/xhtml"><title> wc_coupon | class | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WC_Coupon, class, plugin, woocommerce, 3.0.6" /><meta name="description" content="WooCommerce coupons." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=854ded2fae477ae005aba528ac83782d' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wc_coupon/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_coupon%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_coupon%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.6-class-wc_coupon","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wc_coupon" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.6." href="http://hookr.io/plugins/woocommerce/3.0.6/" class="H_VERSION"><span property="name">3.0.6</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce/3.0.6/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wc_coupon</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="3119"><a href="http://hookr.io/plugins/woocommerce/3.0.6/all/" title="All">All <span class="count badge">3119</span></a></li><li class="" data-id="new" data-count="3"><a href="http://hookr.io/plugins/woocommerce/3.0.6/new/" title="New">New <span class="count badge">3</span></a></li><li class="" data-id="hooks" data-count="2110"><a href="http://hookr.io/plugins/woocommerce/3.0.6/hooks/" title="Hooks">Hooks <span class="count badge">2110</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.6/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1336"><a href="http://hookr.io/plugins/woocommerce/3.0.6/filters/" title="Filters">Filters <span class="count badge">1336</span></a></li><li class="active" data-id="class" data-count="365"><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/" title="Classes">Classes <span class="count badge">365</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.6/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="626"><a href="http://hookr.io/plugins/woocommerce/3.0.6/functions/" title="Functions">Functions <span class="count badge">626</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.6/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WC_Coupon</strong></h1><p>WooCommerce coupons.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.6/files/includes-class-wc-coupon/" class="file">/includes/class-wc-coupon.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="19" class="block" start="19"><li><div>class WC_Coupon extends WC_Legacy_Coupon {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Data array, with defaults.&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $data = array(&nbsp;</div></li><li><div>        'code' =&gt; '', &nbsp;</div></li><li><div>        'amount' =&gt; 0, &nbsp;</div></li><li><div>        'date_created' =&gt; null, &nbsp;</div></li><li><div>        'date_modified' =&gt; null, &nbsp;</div></li><li><div>        'date_expires' =&gt; null, &nbsp;</div></li><li><div>        'discount_type' =&gt; 'fixed_cart', &nbsp;</div></li><li><div>        'description' =&gt; '', &nbsp;</div></li><li><div>        'usage_count' =&gt; 0, &nbsp;</div></li><li><div>        'individual_use' =&gt; false, &nbsp;</div></li><li><div>        'product_ids' =&gt; array(), &nbsp;</div></li><li><div>        'excluded_product_ids' =&gt; array(), &nbsp;</div></li><li><div>        'usage_limit' =&gt; 0, &nbsp;</div></li><li><div>        'usage_limit_per_user' =&gt; 0, &nbsp;</div></li><li><div>        'limit_usage_to_x_items' =&gt; null, &nbsp;</div></li><li><div>        'free_shipping' =&gt; false, &nbsp;</div></li><li><div>        'product_categories' =&gt; array(), &nbsp;</div></li><li><div>        'excluded_product_categories' =&gt; array(), &nbsp;</div></li><li><div>        'exclude_sale_items' =&gt; false, &nbsp;</div></li><li><div>        'minimum_amount' =&gt; '', &nbsp;</div></li><li><div>        'maximum_amount' =&gt; '', &nbsp;</div></li><li><div>        'email_restrictions' =&gt; array(), &nbsp;</div></li><li><div>        'used_by' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Coupon message codes&nbsp;</div></li><li><div>    const E_WC_COUPON_INVALID_FILTERED = 100;&nbsp;</div></li><li><div>    const E_WC_COUPON_INVALID_REMOVED = 101;&nbsp;</div></li><li><div>    const E_WC_COUPON_NOT_YOURS_REMOVED = 102;&nbsp;</div></li><li><div>    const E_WC_COUPON_ALREADY_APPLIED = 103;&nbsp;</div></li><li><div>    const E_WC_COUPON_ALREADY_APPLIED_INDIV_USE_ONLY = 104;&nbsp;</div></li><li><div>    const E_WC_COUPON_NOT_EXIST = 105;&nbsp;</div></li><li><div>    const E_WC_COUPON_USAGE_LIMIT_REACHED = 106;&nbsp;</div></li><li><div>    const E_WC_COUPON_EXPIRED = 107;&nbsp;</div></li><li><div>    const E_WC_COUPON_MIN_SPEND_LIMIT_NOT_MET = 108;&nbsp;</div></li><li><div>    const E_WC_COUPON_NOT_APPLICABLE = 109;&nbsp;</div></li><li><div>    const E_WC_COUPON_NOT_VALID_SALE_ITEMS = 110;&nbsp;</div></li><li><div>    const E_WC_COUPON_PLEASE_ENTER = 111;&nbsp;</div></li><li><div>    const E_WC_COUPON_MAX_SPEND_LIMIT_MET = 112;&nbsp;</div></li><li><div>    const E_WC_COUPON_EXCLUDED_PRODUCTS = 113;&nbsp;</div></li><li><div>    const E_WC_COUPON_EXCLUDED_CATEGORIES = 114;&nbsp;</div></li><li><div>    const WC_COUPON_SUCCESS = 200;&nbsp;</div></li><li><div>    const WC_COUPON_REMOVED = 201;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cache group.&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $cache_group = 'coupons';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Coupon constructor. Loads coupon data.&nbsp;</div></li><li><div>     * @param mixed $data Coupon data, object, ID or code.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct( $data = '' ) {&nbsp;</div></li><li><div>        parent::__construct( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $data instanceof WC_Coupon ) {&nbsp;</div></li><li><div>            $this-&gt;set_id( absint( $data-&gt;get_id() ) );&nbsp;</div></li><li><div>        } elseif ( $coupon = apply_filters( 'woocommerce_get_shop_coupon_data', false, $data ) ) {&nbsp;</div></li><li><div>            $this-&gt;read_manual_coupon( $data, $coupon );&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        } elseif ( is_numeric( $data ) && 'shop_coupon' === get_post_type( $data ) ) {&nbsp;</div></li><li><div>            $this-&gt;set_id( $data );&nbsp;</div></li><li><div>        } elseif ( ! empty( $data ) ) {&nbsp;</div></li><li><div>            $this-&gt;set_id( wc_get_coupon_id_by_code( $data ) );&nbsp;</div></li><li><div>            $this-&gt;set_code( $data );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;set_object_read( true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data_store = WC_Data_Store::load( 'coupon' );&nbsp;</div></li><li><div>        if ( $this-&gt;get_id() &gt; 0 ) {&nbsp;</div></li><li><div>            $this-&gt;data_store-&gt;read( $this );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Checks the coupon type.&nbsp;</div></li><li><div>     * @param  string $type Array or string of types&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_type( $type ) {&nbsp;</div></li><li><div>        return ( $this-&gt;get_discount_type() === $type || ( is_array( $type ) && in_array( $this-&gt;get_discount_type(), $type ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prefix for action and filter hooks on data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function get_hook_prefix() {&nbsp;</div></li><li><div>        return 'woocommerce_coupon_get_';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     |--------------------------------------------------------------------------&nbsp;</div></li><li><div>     | Getters&nbsp;</div></li><li><div>     |--------------------------------------------------------------------------&nbsp;</div></li><li><div>     |&nbsp;</div></li><li><div>     | Methods for getting data from the coupon object.&nbsp;</div></li><li><div>     |&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon code.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_code( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'code', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon description.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_description( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'description', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get discount type.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_discount_type( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'discount_type', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon amount.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return float&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_amount( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'amount', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon expiration date.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return WC_DateTime|NULL object if the date is set or null if there is no date.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_date_expires( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'date_expires', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get date_created&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return WC_DateTime|NULL object if the date is set or null if there is no date.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_date_created( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'date_created', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get date_modified&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return WC_DateTime|NULL object if the date is set or null if there is no date.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_date_modified( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'date_modified', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon usage count.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return integer&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_usage_count( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'usage_count', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the &quot;indvidual use&quot; checkbox status.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_individual_use( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'individual_use', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get product IDs this coupon can apply to.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_ids( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'product_ids', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get product IDs that this coupon should not apply to.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_excluded_product_ids( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'excluded_product_ids', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon usage limit.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return integer&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_usage_limit( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'usage_limit', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get coupon usage limit per customer (for a single customer)&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return integer&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_usage_limit_per_user( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'usage_limit_per_user', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Usage limited to certain amount of items&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return integer|null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_limit_usage_to_x_items( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'limit_usage_to_x_items', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If this coupon grants free shipping or not.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_free_shipping( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'free_shipping', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get product categories this coupon can apply to.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_categories( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'product_categories', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get product categories this coupon cannot not apply to.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_excluded_product_categories( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'excluded_product_categories', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If this coupon should exclude items on sale.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_exclude_sale_items( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'exclude_sale_items', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get minium spend amount.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return float&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_minimum_amount( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'minimum_amount', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get maximum spend amount.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return float&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_maximum_amount( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'maximum_amount', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get emails to check customer usage restrictions.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_email_restrictions( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'email_restrictions', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get records of all users who have used the current coupon.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $context&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_used_by( $context = 'view' ) {&nbsp;</div></li><li><div>        return $this-&gt;get_prop( 'used_by', $context );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get discount amount for a cart item.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  float $discounting_amount Amount the coupon is being applied to&nbsp;</div></li><li><div>     * @param  array|null $cart_item Cart item being discounted if applicable&nbsp;</div></li><li><div>     * @param  boolean $single True if discounting a single qty item, false if its the line&nbsp;</div></li><li><div>     * @return float Amount this coupon has discounted&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_discount_amount( $discounting_amount, $cart_item = null, $single = false ) {&nbsp;</div></li><li><div>        $discount = 0;&nbsp;</div></li><li><div>        $cart_item_qty = is_null( $cart_item ) ? 1 : $cart_item['quantity'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;is_type( array( 'percent' ) ) ) {&nbsp;</div></li><li><div>            $discount = (float) $this-&gt;get_amount() * ( $discounting_amount / 100 );&nbsp;</div></li><li><div>        } elseif ( $this-&gt;is_type( 'fixed_cart' ) && ! is_null( $cart_item ) && WC()-&gt;cart-&gt;subtotal_ex_tax ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * This is the most complex discount - we need to divide the discount between rows based on their price in.&nbsp;</div></li><li><div>             * proportion to the subtotal. This is so rows with different tax rates get a fair discount, and so rows.&nbsp;</div></li><li><div>             * with no price (free) don't get discounted.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * Get item discount by dividing item cost by subtotal to get a %.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * Uses price inc tax if prices include tax to work around https://github.com/woocommerce/woocommerce/issues/7669 and https://github.com/woocommerce/woocommerce/issues/8074.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            if ( wc_prices_include_tax() ) {&nbsp;</div></li><li><div>                $discount_percent = ( wc_get_price_including_tax( $cart_item['data'] ) * $cart_item_qty ) / WC()-&gt;cart-&gt;subtotal;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $discount_percent = ( wc_get_price_excluding_tax( $cart_item['data'] ) * $cart_item_qty ) / WC()-&gt;cart-&gt;subtotal_ex_tax;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $discount = ( (float) $this-&gt;get_amount() * $discount_percent ) / $cart_item_qty;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif ( $this-&gt;is_type( 'fixed_product' ) ) {&nbsp;</div></li><li><div>            $discount = min( $this-&gt;get_amount(), $discounting_amount );&nbsp;</div></li><li><div>            $discount = $single ? $discount : $discount * $cart_item_qty;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $discount = (float) min( $discount, $discounting_amount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Handle the limit_usage_to_x_items option&nbsp;</div></li><li><div>        if ( ! $this-&gt;is_type( array( 'fixed_cart' ) ) ) {&nbsp;</div></li><li><div>            if ( $discounting_amount ) {&nbsp;</div></li><li><div>                if ( null === $this-&gt;get_limit_usage_to_x_items() ) {&nbsp;</div></li><li><div>                    $limit_usage_qty = $cart_item_qty;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $limit_usage_qty = min( $this-&gt;get_limit_usage_to_x_items(), $cart_item_qty );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;set_limit_usage_to_x_items( max( 0, ( $this-&gt;get_limit_usage_to_x_items() - $limit_usage_qty ) ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( $single ) {&nbsp;</div></li><li><div>                    $discount = ( $discount * $limit_usage_qty ) / $cart_item_qty;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $discount = ( $discount / $cart_item_qty ) * $limit_usage_qty;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $discount = round( $discount, wc_get_rounding_precision() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_coupon_get_discount_amount', $discount, $discounting_amount, $cart_item, $single, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     |--------------------------------------------------------------------------&nbsp;</div></li><li><div>     | Setters&nbsp;</div></li><li><div>     |--------------------------------------------------------------------------&nbsp;</div></li><li><div>     |&nbsp;</div></li><li><div>     | Functions for setting coupon data. These should not update anything in the&nbsp;</div></li><li><div>     | database itself and should only change what is stored in the class&nbsp;</div></li><li><div>     | object.&nbsp;</div></li><li><div>     |&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set coupon code.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $code&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_code( $code ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'code', wc_format_coupon_code( $code ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set coupon description.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $description&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_description( $description ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'description', $description );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set discount type.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $discount_type&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_discount_type( $discount_type ) {&nbsp;</div></li><li><div>        if ( 'percent_product' === $discount_type ) {&nbsp;</div></li><li><div>            $discount_type = 'percent'; // Backwards compatibility.&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! in_array( $discount_type, array_keys( wc_get_coupon_types() ) ) ) {&nbsp;</div></li><li><div>            $this-&gt;error( 'coupon_invalid_discount_type', __( 'Invalid discount type', 'woocommerce' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'discount_type', $discount_type );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set amount.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  float $amount&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_amount( $amount ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'amount', wc_format_decimal( $amount ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set expiration date.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param string|integer|null $date UTC timestamp, or ISO 8601 DateTime. If the DateTime string has no timezone or offset, WordPress site timezone will be assumed. Null if there is no date.&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_date_expires( $date ) {&nbsp;</div></li><li><div>        $this-&gt;set_date_prop( 'date_expires', $date );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set date_created&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param string|integer|null $date UTC timestamp, or ISO 8601 DateTime. If the DateTime string has no timezone or offset, WordPress site timezone will be assumed. Null if there is no date.&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_date_created( $date ) {&nbsp;</div></li><li><div>        $this-&gt;set_date_prop( 'date_created', $date );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set date_modified&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param string|integer|null $date UTC timestamp, or ISO 8601 DateTime. If the DateTime string has no timezone or offset, WordPress site timezone will be assumed. Null if there is no date.&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_date_modified( $date ) {&nbsp;</div></li><li><div>        $this-&gt;set_date_prop( 'date_modified', $date );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set how many times this coupon has been used.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  int $usage_count&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_usage_count( $usage_count ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'usage_count', absint( $usage_count ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set if this coupon can only be used once.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  bool $is_individual_use&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_individual_use( $is_individual_use ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'individual_use', (bool) $is_individual_use );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the product IDs this coupon can be used with.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  array $product_ids&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_product_ids( $product_ids ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'product_ids', array_filter( wp_parse_id_list( (array) $product_ids ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the product IDs this coupon cannot be used with.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  array $excluded_product_ids&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_excluded_product_ids( $excluded_product_ids ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'excluded_product_ids', array_filter( wp_parse_id_list( (array) $excluded_product_ids ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the amount of times this coupon can be used.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  int $usage_limit&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_usage_limit( $usage_limit ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'usage_limit', absint( $usage_limit ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the amount of times this coupon can be used per user.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  int $usage_limit&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_usage_limit_per_user( $usage_limit ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'usage_limit_per_user', absint( $usage_limit ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set usage limit to x number of items.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  int|null $limit_usage_to_x_items&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_limit_usage_to_x_items( $limit_usage_to_x_items ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'limit_usage_to_x_items', is_null( $limit_usage_to_x_items ) ? null : absint( $limit_usage_to_x_items ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set if this coupon enables free shipping or not.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  bool $free_shipping&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_free_shipping( $free_shipping ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'free_shipping', (bool) $free_shipping );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the product category IDs this coupon can be used with.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  array $product_categories&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_product_categories( $product_categories ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'product_categories', array_filter( wp_parse_id_list( (array) $product_categories ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the product category IDs this coupon cannot be used with.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  array $excluded_product_categories&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_excluded_product_categories( $excluded_product_categories ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'excluded_product_categories', array_filter( wp_parse_id_list( (array) $excluded_product_categories ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set if this coupon should excluded sale items or not.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  bool $exclude_sale_items&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_exclude_sale_items( $exclude_sale_items ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'exclude_sale_items', (bool) $exclude_sale_items );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the minimum spend amount.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  float $amount&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_minimum_amount( $amount ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'minimum_amount', wc_format_decimal( $amount ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set the maximum spend amount.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  float $amount&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_maximum_amount( $amount ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'maximum_amount', wc_format_decimal( $amount ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set email restrictions.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  array $emails&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_email_restrictions( $emails = array() ) {&nbsp;</div></li><li><div>        $emails = array_filter( array_map( 'sanitize_email', (array) $emails ) );&nbsp;</div></li><li><div>        foreach ( $emails as $email ) {&nbsp;</div></li><li><div>            if ( ! is_email( $email ) ) {&nbsp;</div></li><li><div>                $this-&gt;error( 'coupon_invalid_email_address', __( 'Invalid email address restriction', 'woocommerce' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'email_restrictions', $emails );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set which users have used this coupon.&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param array $used_by&nbsp;</div></li><li><div>     * @throws WC_Data_Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_used_by( $used_by ) {&nbsp;</div></li><li><div>        $this-&gt;set_prop( 'used_by', array_filter( $used_by ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    | Other Actions&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Developers can programically return coupons. This function will read those values into our WC_Coupon class.&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  string $code  Coupon code&nbsp;</div></li><li><div>     * @param  array $coupon Array of coupon properties&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function read_manual_coupon( $code, $coupon ) {&nbsp;</div></li><li><div>        foreach ( $coupon as $key =&gt; $value ) {&nbsp;</div></li><li><div>            switch ( $key ) {&nbsp;</div></li><li><div>                case 'excluded_product_ids' :&nbsp;</div></li><li><div>                case 'exclude_product_ids' :&nbsp;</div></li><li><div>                    if ( ! is_array( $coupon[ $key ] ) ) {&nbsp;</div></li><li><div>                        wc_doing_it_wrong( $key, $key . ' should be an array instead of a string.', '3.0' );&nbsp;</div></li><li><div>                        $coupon['excluded_product_ids'] = wc_string_to_array( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'exclude_product_categories' :&nbsp;</div></li><li><div>                case 'excluded_product_categories' :&nbsp;</div></li><li><div>                    if ( ! is_array( $coupon[ $key ] ) ) {&nbsp;</div></li><li><div>                        wc_doing_it_wrong( $key, $key . ' should be an array instead of a string.', '3.0' );&nbsp;</div></li><li><div>                        $coupon['excluded_product_categories'] = wc_string_to_array( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'product_ids' :&nbsp;</div></li><li><div>                    if ( ! is_array( $coupon[ $key ] ) ) {&nbsp;</div></li><li><div>                        wc_doing_it_wrong( $key, $key . ' should be an array instead of a string.', '3.0' );&nbsp;</div></li><li><div>                        $coupon[ $key ] = wc_string_to_array( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'individual_use' :&nbsp;</div></li><li><div>                case 'free_shipping' :&nbsp;</div></li><li><div>                case 'exclude_sale_items' :&nbsp;</div></li><li><div>                    if ( ! is_bool( $coupon[ $key ] ) ) {&nbsp;</div></li><li><div>                        wc_doing_it_wrong( $key, $key . ' should be true or false instead of yes or no.', '3.0' );&nbsp;</div></li><li><div>                        $coupon[ $key ] = wc_string_to_bool( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'expiry_date' :&nbsp;</div></li><li><div>                    $coupon['date_expires'] = $value;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;set_code( $code );&nbsp;</div></li><li><div>        $this-&gt;set_props( $coupon );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Increase usage count for current coupon.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $used_by Either user ID or billing email&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function increase_usage_count( $used_by = '' ) {&nbsp;</div></li><li><div>        if ( $this-&gt;get_id() && $this-&gt;data_store ) {&nbsp;</div></li><li><div>            $new_count = $this-&gt;data_store-&gt;increase_usage_count( $this, $used_by );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Bypass set_prop and remove pending changes since the data store saves the count already.&nbsp;</div></li><li><div>            $this-&gt;data['usage_count'] = $new_count;&nbsp;</div></li><li><div>            if ( isset( $this-&gt;changes['usage_count'] ) ) {&nbsp;</div></li><li><div>                unset( $this-&gt;changes['usage_count'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Decrease usage count for current coupon.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $used_by Either user ID or billing email&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function decrease_usage_count( $used_by = '' ) {&nbsp;</div></li><li><div>        if ( $this-&gt;get_id() && $this-&gt;get_usage_count() &gt; 0 && $this-&gt;data_store ) {&nbsp;</div></li><li><div>            $new_count = $this-&gt;data_store-&gt;decrease_usage_count( $this, $used_by );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Bypass set_prop and remove pending changes since the data store saves the count already.&nbsp;</div></li><li><div>            $this-&gt;data['usage_count'] = $new_count;&nbsp;</div></li><li><div>            if ( isset( $this-&gt;changes['usage_count'] ) ) {&nbsp;</div></li><li><div>                unset( $this-&gt;changes['usage_count'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     |--------------------------------------------------------------------------&nbsp;</div></li><li><div>     | Validation & Error Handling&nbsp;</div></li><li><div>     |--------------------------------------------------------------------------&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the error_message string.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_error_message() {&nbsp;</div></li><li><div>        return $this-&gt;error_message;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon exists or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_exists() {&nbsp;</div></li><li><div>        if ( ! $this-&gt;get_id() ) {&nbsp;</div></li><li><div>            throw new Exception( self::E_WC_COUPON_NOT_EXIST );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon usage limit is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_usage_limit() {&nbsp;</div></li><li><div>        if ( $this-&gt;get_usage_limit() &gt; 0 && $this-&gt;get_usage_count() &gt;= $this-&gt;get_usage_limit() ) {&nbsp;</div></li><li><div>            throw new Exception( self::E_WC_COUPON_USAGE_LIMIT_REACHED );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon user usage limit is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Per user usage limit - check here if user is logged in (against user IDs).&nbsp;</div></li><li><div>     * Checked again for emails later on in WC_Cart::check_customer_coupons().&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  int  $user_id&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_user_usage_limit( $user_id = 0 ) {&nbsp;</div></li><li><div>        if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>            $user_id = get_current_user_id();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $this-&gt;get_usage_limit_per_user() &gt; 0 && is_user_logged_in() && $this-&gt;get_id() && $this-&gt;data_store ) {&nbsp;</div></li><li><div>            global $wpdb;&nbsp;</div></li><li><div>            $usage_count = $this-&gt;data_store-&gt;get_usage_by_user_id( $this, $user_id );&nbsp;</div></li><li><div>            if ( $usage_count &gt;= $this-&gt;get_usage_limit_per_user() ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_USAGE_LIMIT_REACHED );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon date is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_expiry_date() {&nbsp;</div></li><li><div>        if ( $this-&gt;get_date_expires() && current_time( 'timestamp', true ) &gt; $this-&gt;get_date_expires()-&gt;getTimestamp() ) {&nbsp;</div></li><li><div>            throw new Exception( $error_code = self::E_WC_COUPON_EXPIRED );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon amount is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_minimum_amount() {&nbsp;</div></li><li><div>        if ( $this-&gt;get_minimum_amount() &gt; 0 && apply_filters( 'woocommerce_coupon_validate_minimum_amount', $this-&gt;get_minimum_amount() &gt; WC()-&gt;cart-&gt;get_displayed_subtotal(), $this ) ) {&nbsp;</div></li><li><div>            throw new Exception( self::E_WC_COUPON_MIN_SPEND_LIMIT_NOT_MET );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon amount is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_maximum_amount() {&nbsp;</div></li><li><div>        if ( $this-&gt;get_maximum_amount() &gt; 0 && apply_filters( 'woocommerce_coupon_validate_maximum_amount', $this-&gt;get_maximum_amount() &lt; WC()-&gt;cart-&gt;get_displayed_subtotal(), $this ) ) {&nbsp;</div></li><li><div>            throw new Exception( self::E_WC_COUPON_MAX_SPEND_LIMIT_MET );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon is valid for products in the cart is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_product_ids() {&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_product_ids() ) &gt; 0 ) {&nbsp;</div></li><li><div>            $valid_for_cart = false;&nbsp;</div></li><li><div>            if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                    if ( in_array( $cart_item['product_id'], $this-&gt;get_product_ids() ) || in_array( $cart_item['variation_id'], $this-&gt;get_product_ids() ) || in_array( $cart_item['data']-&gt;get_parent_id(), $this-&gt;get_product_ids() ) ) {&nbsp;</div></li><li><div>                        $valid_for_cart = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! $valid_for_cart ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_NOT_APPLICABLE );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon is valid for product categories in the cart is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_product_categories() {&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_product_categories() ) &gt; 0 ) {&nbsp;</div></li><li><div>            $valid_for_cart = false;&nbsp;</div></li><li><div>            if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                    $product_cats = wc_get_product_cat_ids( $cart_item['product_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // If we find an item with a cat in our allowed cat list, the coupon is valid&nbsp;</div></li><li><div>                    if ( sizeof( array_intersect( $product_cats, $this-&gt;get_product_categories() ) ) &gt; 0 ) {&nbsp;</div></li><li><div>                        $valid_for_cart = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! $valid_for_cart ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_NOT_APPLICABLE );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ensure coupon is valid for sale items in the cart is valid or throw exception.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_sale_items() {&nbsp;</div></li><li><div>        if ( $this-&gt;get_exclude_sale_items() ) {&nbsp;</div></li><li><div>            $valid_for_cart = false;&nbsp;</div></li><li><div>            $product_ids_on_sale = wc_get_product_ids_on_sale();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                    if ( ! empty( $cart_item['variation_id'] ) ) {&nbsp;</div></li><li><div>                        if ( ! in_array( $cart_item['variation_id'], $product_ids_on_sale, true ) ) {&nbsp;</div></li><li><div>                            $valid_for_cart = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } elseif ( ! in_array( $cart_item['product_id'], $product_ids_on_sale, true ) ) {&nbsp;</div></li><li><div>                        $valid_for_cart = true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! $valid_for_cart ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_NOT_VALID_SALE_ITEMS );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * All exclusion rules must pass at the same time for a product coupon to be valid.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_excluded_items() {&nbsp;</div></li><li><div>        if ( ! WC()-&gt;cart-&gt;is_empty() && $this-&gt;is_type( wc_get_product_coupon_types() ) ) {&nbsp;</div></li><li><div>            $valid = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                if ( $this-&gt;is_valid_for_product( $cart_item['data'], $cart_item ) ) {&nbsp;</div></li><li><div>                    $valid = true;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $valid ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_NOT_APPLICABLE );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Cart discounts cannot be added if non-eligble product is found in cart.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_cart_excluded_items() {&nbsp;</div></li><li><div>        if ( ! $this-&gt;is_type( wc_get_product_coupon_types() ) ) {&nbsp;</div></li><li><div>            $this-&gt;validate_cart_excluded_product_ids();&nbsp;</div></li><li><div>            $this-&gt;validate_cart_excluded_product_categories();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Exclude products from cart.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_cart_excluded_product_ids() {&nbsp;</div></li><li><div>        // Exclude Products&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_excluded_product_ids() ) &gt; 0 ) {&nbsp;</div></li><li><div>            $valid_for_cart = true;&nbsp;</div></li><li><div>            if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                    if ( in_array( $cart_item['product_id'], $this-&gt;get_excluded_product_ids() ) || in_array( $cart_item['variation_id'], $this-&gt;get_excluded_product_ids() ) || in_array( $cart_item['data']-&gt;get_parent_id(), $this-&gt;get_excluded_product_ids() ) ) {&nbsp;</div></li><li><div>                        $valid_for_cart = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! $valid_for_cart ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_EXCLUDED_PRODUCTS );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Exclude categories from cart.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_cart_excluded_product_categories() {&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_excluded_product_categories() ) &gt; 0 ) {&nbsp;</div></li><li><div>            $valid_for_cart = true;&nbsp;</div></li><li><div>            if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                    $product_cats = wc_get_product_cat_ids( $cart_item['product_id'] );&nbsp;</div></li><li><div>                    if ( sizeof( array_intersect( $product_cats, $this-&gt;get_excluded_product_categories() ) ) &gt; 0 ) {&nbsp;</div></li><li><div>                        $valid_for_cart = false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( ! $valid_for_cart ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_EXCLUDED_CATEGORIES );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if a coupon is valid.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return boolean validity&nbsp;</div></li><li><div>     * @throws Exception&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_valid() {&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $this-&gt;validate_exists();&nbsp;</div></li><li><div>            $this-&gt;validate_usage_limit();&nbsp;</div></li><li><div>            $this-&gt;validate_user_usage_limit();&nbsp;</div></li><li><div>            $this-&gt;validate_expiry_date();&nbsp;</div></li><li><div>            $this-&gt;validate_minimum_amount();&nbsp;</div></li><li><div>            $this-&gt;validate_maximum_amount();&nbsp;</div></li><li><div>            $this-&gt;validate_product_ids();&nbsp;</div></li><li><div>            $this-&gt;validate_product_categories();&nbsp;</div></li><li><div>            $this-&gt;validate_sale_items();&nbsp;</div></li><li><div>            $this-&gt;validate_excluded_items();&nbsp;</div></li><li><div>            $this-&gt;validate_cart_excluded_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! apply_filters( 'woocommerce_coupon_is_valid', true, $this ) ) {&nbsp;</div></li><li><div>                throw new Exception( self::E_WC_COUPON_INVALID_FILTERED );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            $this-&gt;error_message = $this-&gt;get_coupon_error( $e-&gt;getMessage() );&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if a coupon is valid.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_valid_for_cart() {&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_coupon_is_valid_for_cart', $this-&gt;is_type( wc_get_cart_coupon_types() ), $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if a coupon is valid for a product.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  WC_Product  $product&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_valid_for_product( $product, $values = array() ) {&nbsp;</div></li><li><div>        if ( ! $this-&gt;is_type( wc_get_product_coupon_types() ) ) {&nbsp;</div></li><li><div>            return apply_filters( 'woocommerce_coupon_is_valid_for_product', false, $product, $this, $values );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $valid = false;&nbsp;</div></li><li><div>        $product_cats = wc_get_product_cat_ids( $product-&gt;is_type( 'variation' ) ? $product-&gt;get_parent_id() : $product-&gt;get_id() );&nbsp;</div></li><li><div>        $product_ids = array( $product-&gt;get_id(), $product-&gt;get_parent_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Specific products get the discount&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_product_ids() ) && sizeof( array_intersect( $product_ids, $this-&gt;get_product_ids() ) ) ) {&nbsp;</div></li><li><div>            $valid = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Category discounts&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_product_categories() ) && sizeof( array_intersect( $product_cats, $this-&gt;get_product_categories() ) ) ) {&nbsp;</div></li><li><div>            $valid = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // No product ids - all items discounted&nbsp;</div></li><li><div>        if ( ! sizeof( $this-&gt;get_product_ids() ) && ! sizeof( $this-&gt;get_product_categories() ) ) {&nbsp;</div></li><li><div>            $valid = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Specific product IDs excluded from the discount&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_excluded_product_ids() ) && sizeof( array_intersect( $product_ids, $this-&gt;get_excluded_product_ids() ) ) ) {&nbsp;</div></li><li><div>            $valid = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Specific categories excluded from the discount&nbsp;</div></li><li><div>        if ( sizeof( $this-&gt;get_excluded_product_categories() ) && sizeof( array_intersect( $product_cats, $this-&gt;get_excluded_product_categories() ) ) ) {&nbsp;</div></li><li><div>            $valid = false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Sale Items excluded from discount&nbsp;</div></li><li><div>        if ( $this-&gt;get_exclude_sale_items() ) {&nbsp;</div></li><li><div>            $product_ids_on_sale = wc_get_product_ids_on_sale();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array( $product-&gt;get_id(), $product_ids_on_sale, true ) ) {&nbsp;</div></li><li><div>                $valid = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_coupon_is_valid_for_product', $valid, $product, $this, $values );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Converts one of the WC_Coupon message/error codes to a message string and.&nbsp;</div></li><li><div>     * displays the message/error.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $msg_code Message/error code.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_coupon_message( $msg_code ) {&nbsp;</div></li><li><div>        $msg = $msg_code &lt; 200 ? $this-&gt;get_coupon_error( $msg_code ) : $this-&gt;get_coupon_message( $msg_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $msg ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $msg_code &lt; 200 ) {&nbsp;</div></li><li><div>            wc_add_notice( $msg, 'error' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wc_add_notice( $msg );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Map one of the WC_Coupon message codes to a message string.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param integer $msg_code&nbsp;</div></li><li><div>     * @return string| Message/error string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_coupon_message( $msg_code ) {&nbsp;</div></li><li><div>        switch ( $msg_code ) {&nbsp;</div></li><li><div>            case self::WC_COUPON_SUCCESS :&nbsp;</div></li><li><div>                $msg = __( 'Coupon code applied successfully.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::WC_COUPON_REMOVED :&nbsp;</div></li><li><div>                $msg = __( 'Coupon code removed successfully.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                $msg = '';&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_coupon_message', $msg, $msg_code, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Map one of the WC_Coupon error codes to a message string.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $err_code Message/error code.&nbsp;</div></li><li><div>     * @return string| Message/error string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_coupon_error( $err_code ) {&nbsp;</div></li><li><div>        switch ( $err_code ) {&nbsp;</div></li><li><div>            case self::E_WC_COUPON_INVALID_FILTERED:&nbsp;</div></li><li><div>                $err = __( 'Coupon is not valid.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_NOT_EXIST:&nbsp;</div></li><li><div>                /** translators: %s: coupon code */&nbsp;</div></li><li><div>                $err = sprintf( __( 'Coupon &quot;%s&quot; does not exist!', 'woocommerce' ), $this-&gt;get_code() );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_INVALID_REMOVED:&nbsp;</div></li><li><div>                /** translators: %s: coupon code */&nbsp;</div></li><li><div>                $err = sprintf( __( 'Sorry, it seems the coupon &quot;%s&quot; is invalid - it has now been removed from your order.', 'woocommerce' ), $this-&gt;get_code() );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_NOT_YOURS_REMOVED:&nbsp;</div></li><li><div>                /** translators: %s: coupon code */&nbsp;</div></li><li><div>                $err = sprintf( __( 'Sorry, it seems the coupon &quot;%s&quot; is not yours - it has now been removed from your order.', 'woocommerce' ), $this-&gt;get_code() );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_ALREADY_APPLIED:&nbsp;</div></li><li><div>                $err = __( 'Coupon code already applied!', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_ALREADY_APPLIED_INDIV_USE_ONLY:&nbsp;</div></li><li><div>                /** translators: %s: coupon code */&nbsp;</div></li><li><div>                $err = sprintf( __( 'Sorry, coupon &quot;%s&quot; has already been applied and cannot be used in conjunction with other coupons.', 'woocommerce' ), $this-&gt;get_code() );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_USAGE_LIMIT_REACHED:&nbsp;</div></li><li><div>                $err = __( 'Coupon usage limit has been reached.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_EXPIRED:&nbsp;</div></li><li><div>                $err = __( 'This coupon has expired.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_MIN_SPEND_LIMIT_NOT_MET:&nbsp;</div></li><li><div>                /** translators: %s: coupon minimum amount */&nbsp;</div></li><li><div>                $err = sprintf( __( 'The minimum spend for this coupon is %s.', 'woocommerce' ), wc_price( $this-&gt;get_minimum_amount() ) );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_MAX_SPEND_LIMIT_MET:&nbsp;</div></li><li><div>                /** translators: %s: coupon maximum amount */&nbsp;</div></li><li><div>                $err = sprintf( __( 'The maximum spend for this coupon is %s.', 'woocommerce' ), wc_price( $this-&gt;get_maximum_amount() ) );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_NOT_APPLICABLE:&nbsp;</div></li><li><div>                $err = __( 'Sorry, this coupon is not applicable to your cart contents.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_EXCLUDED_PRODUCTS:&nbsp;</div></li><li><div>                // Store excluded products that are in cart in $products&nbsp;</div></li><li><div>                $products = array();&nbsp;</div></li><li><div>                if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                    foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                        if ( in_array( $cart_item['product_id'], $this-&gt;get_excluded_product_ids() ) || in_array( $cart_item['variation_id'], $this-&gt;get_excluded_product_ids() ) || in_array( $cart_item['data']-&gt;get_parent_id(), $this-&gt;get_excluded_product_ids() ) ) {&nbsp;</div></li><li><div>                            $products[] = $cart_item['data']-&gt;get_name();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /** translators: %s: products list */&nbsp;</div></li><li><div>                $err = sprintf( __( 'Sorry, this coupon is not applicable to the products: %s.', 'woocommerce' ), implode( ', ', $products ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_EXCLUDED_CATEGORIES:&nbsp;</div></li><li><div>                // Store excluded categories that are in cart in $categories&nbsp;</div></li><li><div>                $categories = array();&nbsp;</div></li><li><div>                if ( ! WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>                    foreach ( WC()-&gt;cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {&nbsp;</div></li><li><div>                        $product_cats = wc_get_product_cat_ids( $cart_item['product_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( sizeof( $intersect = array_intersect( $product_cats, $this-&gt;get_excluded_product_categories() ) ) &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            foreach ( $intersect as $cat_id ) {&nbsp;</div></li><li><div>                                $cat = get_term( $cat_id, 'product_cat' );&nbsp;</div></li><li><div>                                $categories[] = $cat-&gt;name;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                /** translators: %s: categories list */&nbsp;</div></li><li><div>                $err = sprintf( __( 'Sorry, this coupon is not applicable to the categories: %s.', 'woocommerce' ), implode( ', ', array_unique( $categories ) ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_NOT_VALID_SALE_ITEMS:&nbsp;</div></li><li><div>                $err = __( 'Sorry, this coupon is not valid for sale items.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                $err = '';&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_coupon_error', $err, $err_code, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Map one of the WC_Coupon error codes to an error string.&nbsp;</div></li><li><div>     * No coupon instance will be available where a coupon does not exist, &nbsp;</div></li><li><div>     * so this static method exists.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $err_code Error code&nbsp;</div></li><li><div>     * @return string| Error string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_generic_coupon_error( $err_code ) {&nbsp;</div></li><li><div>        switch ( $err_code ) {&nbsp;</div></li><li><div>            case self::E_WC_COUPON_NOT_EXIST:&nbsp;</div></li><li><div>                $err = __( 'Coupon does not exist!', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            case self::E_WC_COUPON_PLEASE_ENTER:&nbsp;</div></li><li><div>                $err = __( 'Please enter a coupon code.', 'woocommerce' );&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                $err = '';&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        // When using this static method, there is no $this to pass to filter&nbsp;</div></li><li><div>        return apply_filters( 'woocommerce_coupon_error', $err, $err_code, null );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/wc_coupon/" class="active">3.0.6</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/wc_coupon/" class="">3.0.5</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.4/classes/wc_coupon/" class="">3.0.4</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.3/classes/wc_coupon/" class="">3.0.3</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/wc_coupon/" class="">3.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WC_Coupon</li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>