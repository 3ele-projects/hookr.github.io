<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="3.0.6" data-slug="woocommerce" data-type="file" data-id="40770"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-wc-order-functions | file | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, woocommerce, 3.0.6" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=63c5f76e8526fdd0e2300bdad39a8c44' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-wc-order-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-wc-order-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-wc-order-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.6-file-includes-wc-order-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-wc-order-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.6." href="http://hookr.io/plugins/woocommerce/3.0.6/" class="H_VERSION"><span property="name">3.0.6</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/woocommerce/3.0.6/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-wc-order-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="3119"><a href="http://hookr.io/plugins/woocommerce/3.0.6/all/" title="All">All <span class="count badge">3119</span></a></li><li class="" data-id="new" data-count="3"><a href="http://hookr.io/plugins/woocommerce/3.0.6/new/" title="New">New <span class="count badge">3</span></a></li><li class="" data-id="hooks" data-count="2110"><a href="http://hookr.io/plugins/woocommerce/3.0.6/hooks/" title="Hooks">Hooks <span class="count badge">2110</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.6/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1336"><a href="http://hookr.io/plugins/woocommerce/3.0.6/filters/" title="Filters">Filters <span class="count badge">1336</span></a></li><li class="" data-id="class" data-count="365"><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/" title="Classes">Classes <span class="count badge">365</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.6/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="626"><a href="http://hookr.io/plugins/woocommerce/3.0.6/functions/" title="Functions">Functions <span class="count badge">626</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.6/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/wc-order-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * WooCommerce Order Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Functions for order specific things.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author      WooThemes</span>&nbsp;</div></li><li><div><span class="comment"> * @category    Core</span>&nbsp;</div></li><li><div><span class="comment"> * @package     WooCommerce/Functions</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) {&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Wrapper for get_posts specific to orders.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This function should be used for order retrieval so that when we move to</span>&nbsp;</div></li><li><div><span class="comment"> * custom tables, functions still work.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Args:</span>&nbsp;</div></li><li><div><span class="comment"> *      status array|string List of order statuses to find</span>&nbsp;</div></li><li><div><span class="comment"> *      type array|string Order type, e.g. shop_order or shop_order_refund</span>&nbsp;</div></li><li><div><span class="comment"> *      parent int post/order parent</span>&nbsp;</div></li><li><div><span class="comment"> *      customer int|string|array User ID or billing email to limit orders to a</span>&nbsp;</div></li><li><div><span class="comment"> *          particular user. Accepts array of values. Array of values is OR'ed. If array of array is passed, each array will be AND'ed.</span>&nbsp;</div></li><li><div><span class="comment"> *          e.g. test@test.com, 1, array( 1, 2, 3 ), array( array( 1, 'test@test.com' ), 2, 3 )</span>&nbsp;</div></li><li><div><span class="comment"> *      limit int Maximum of orders to retrieve.</span>&nbsp;</div></li><li><div><span class="comment"> *      offset int Offset of orders to retrieve.</span>&nbsp;</div></li><li><div><span class="comment"> *      page int Page of orders to retrieve. Ignored when using the 'offset' arg.</span>&nbsp;</div></li><li><div><span class="comment"> *      date_before string Get orders before a certain date ( strtotime() compatibile string )</span>&nbsp;</div></li><li><div><span class="comment"> *      date_after string Get orders after a certain date ( strtotime() compatibile string )</span>&nbsp;</div></li><li><div><span class="comment"> *      exclude array Order IDs to exclude from the query.</span>&nbsp;</div></li><li><div><span class="comment"> *      orderby string Order by date, title, id, modified, rand etc</span>&nbsp;</div></li><li><div><span class="comment"> *      order string ASC or DESC</span>&nbsp;</div></li><li><div><span class="comment"> *      return string Type of data to return. Allowed values:</span>&nbsp;</div></li><li><div><span class="comment"> *          ids array of order ids</span>&nbsp;</div></li><li><div><span class="comment"> *          objects array of order objects (default)</span>&nbsp;</div></li><li><div><span class="comment"> *      paginate bool If true, the return value will be an array with values:</span>&nbsp;</div></li><li><div><span class="comment"> *          'orders' =&gt; array of data (return value above), </span>&nbsp;</div></li><li><div><span class="comment"> *          'total' =&gt; total number of orders matching the query</span>&nbsp;</div></li><li><div><span class="comment"> *          'max_num_pages' =&gt; max number of pages found</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $args Array of args (above)</span>&nbsp;</div></li><li><div><span class="comment"> * @return array|stdClass Number of pages and an array of order objects if</span>&nbsp;</div></li><li><div><span class="comment"> *                             paginate is true, or just an array of values.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_orders( $args ) {&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, array(&nbsp;</div></li><li><div>      'status' =&gt; array_keys( wc_get_order_statuses() ), &nbsp;</div></li><li><div>      'type' =&gt; wc_get_order_types( 'view-orders' ), &nbsp;</div></li><li><div>      'parent' =&gt; null, &nbsp;</div></li><li><div>      'customer' =&gt; null, &nbsp;</div></li><li><div>      'email' =&gt; '', &nbsp;</div></li><li><div>      'limit' =&gt; get_option( 'posts_per_page' ), &nbsp;</div></li><li><div>      'offset' =&gt; null, &nbsp;</div></li><li><div>      'page' =&gt; 1, &nbsp;</div></li><li><div>      'exclude' =&gt; array(), &nbsp;</div></li><li><div>      'orderby' =&gt; 'date', &nbsp;</div></li><li><div>      'order' =&gt; 'DESC', &nbsp;</div></li><li><div>      'return' =&gt; 'objects', &nbsp;</div></li><li><div>      'paginate' =&gt; false, &nbsp;</div></li><li><div>      'date_before' =&gt; '', &nbsp;</div></li><li><div>      'date_after' =&gt; '', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Handle some BW compatibility arg names where wp_query args differ in naming.</span>&nbsp;</div></li><li><div>  $map_legacy = array(&nbsp;</div></li><li><div>      'numberposts' =&gt; 'limit', &nbsp;</div></li><li><div>      'post_type' =&gt; 'type', &nbsp;</div></li><li><div>      'post_status' =&gt; 'status', &nbsp;</div></li><li><div>      'post_parent' =&gt; 'parent', &nbsp;</div></li><li><div>      'author' =&gt; 'customer', &nbsp;</div></li><li><div>      'posts_per_page' =&gt; 'limit', &nbsp;</div></li><li><div>      'paged' =&gt; 'page', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $map_legacy as $from =&gt; $to ) {&nbsp;</div></li><li><div>      if ( isset( $args[ $from ] ) ) {&nbsp;</div></li><li><div>          $args[ $to ] = $args[ $from ];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return WC_Data_Store::load( 'order' )-&gt;get_orders( $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Main function for returning orders, uses the WC_Order_Factory class.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param  mixed $the_order Post object or post ID of the order.</span>&nbsp;</div></li><li><div><span class="comment"> * @return WC_Order|WC_Refund</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_order( $the_order = false ) {&nbsp;</div></li><li><div>  if ( ! did_action( 'woocommerce_after_register_post_type' ) ) {&nbsp;</div></li><li><div>      wc_doing_it_wrong( __FUNCTION__, __( 'wc_get_order should not be called before post types are registered (woocommerce_after_register_post_type action).', 'woocommerce' ), '2.5' );&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return WC()-&gt;order_factory-&gt;get_order( $the_order );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get all order statuses.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @used-by WC_Order::set_status</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_order_statuses() {&nbsp;</div></li><li><div>  $order_statuses = array(&nbsp;</div></li><li><div>      'wc-pending' =&gt; _x( 'Pending payment', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div>      'wc-processing' =&gt; _x( 'Processing', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div>      'wc-on-hold' =&gt; _x( 'On hold', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div>      'wc-completed' =&gt; _x( 'Completed', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div>      'wc-cancelled' =&gt; _x( 'Cancelled', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div>      'wc-refunded' =&gt; _x( 'Refunded', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div>      'wc-failed' =&gt; _x( 'Failed', 'Order status', 'woocommerce' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  return apply_filters( 'wc_order_statuses', $order_statuses );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * See if a string is an order status.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $maybe_status Status, including any wc- prefix</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_is_order_status( $maybe_status ) {&nbsp;</div></li><li><div>  $order_statuses = wc_get_order_statuses();&nbsp;</div></li><li><div>  return isset( $order_statuses[ $maybe_status ] );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get list of statuses which are consider 'paid'.</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_is_paid_statuses() {&nbsp;</div></li><li><div>  return apply_filters( 'woocommerce_order_is_paid_statuses', array( 'processing', 'completed' ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the nice name for an order status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $status</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_order_status_name( $status ) {&nbsp;</div></li><li><div>  $statuses = wc_get_order_statuses();&nbsp;</div></li><li><div>  $status = 'wc-' === substr( $status, 0, 3 ) ? substr( $status, 3 ) : $status;&nbsp;</div></li><li><div>  $status = isset( $statuses[ 'wc-' . $status ] ) ? $statuses[ 'wc-' . $status ] : $status;&nbsp;</div></li><li><div>  return $status;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Finds an Order ID based on an order key.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $order_key An order key has generated by</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The ID of an order, or 0 if the order could not be found</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_order_id_by_order_key( $order_key ) {&nbsp;</div></li><li><div>  $data_store = WC_Data_Store::load( 'order' );&nbsp;</div></li><li><div>  return $data_store-&gt;get_order_id_by_order_key( $order_key );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get all registered order types.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * $for optionally define what you are getting order types for so only relevant types are returned.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * e.g. for 'order-meta-boxes', 'order-count'</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $for</span>&nbsp;</div></li><li><div><span class="comment"> * @return array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_order_types( $for = '' ) {&nbsp;</div></li><li><div>  global $wc_order_types;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $wc_order_types ) ) {&nbsp;</div></li><li><div>      $wc_order_types = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $order_types = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  switch ( $for ) {&nbsp;</div></li><li><div>      case 'order-count' :&nbsp;</div></li><li><div>          foreach ( $wc_order_types as $type =&gt; $args ) {&nbsp;</div></li><li><div>              if ( ! $args['exclude_from_order_count'] ) {&nbsp;</div></li><li><div>                  $order_types[] = $type;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>      case 'order-meta-boxes' :&nbsp;</div></li><li><div>          foreach ( $wc_order_types as $type =&gt; $args ) {&nbsp;</div></li><li><div>              if ( $args['add_order_meta_boxes'] ) {&nbsp;</div></li><li><div>                  $order_types[] = $type;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>      case 'view-orders' :&nbsp;</div></li><li><div>          foreach ( $wc_order_types as $type =&gt; $args ) {&nbsp;</div></li><li><div>              if ( ! $args['exclude_from_order_views'] ) {&nbsp;</div></li><li><div>                  $order_types[] = $type;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>      case 'reports' :&nbsp;</div></li><li><div>          foreach ( $wc_order_types as $type =&gt; $args ) {&nbsp;</div></li><li><div>              if ( ! $args['exclude_from_order_reports'] ) {&nbsp;</div></li><li><div>                  $order_types[] = $type;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>      case 'sales-reports' :&nbsp;</div></li><li><div>          foreach ( $wc_order_types as $type =&gt; $args ) {&nbsp;</div></li><li><div>              if ( ! $args['exclude_from_order_sales_reports'] ) {&nbsp;</div></li><li><div>                  $order_types[] = $type;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>      case 'order-webhooks' :&nbsp;</div></li><li><div>          foreach ( $wc_order_types as $type =&gt; $args ) {&nbsp;</div></li><li><div>              if ( ! $args['exclude_from_order_webhooks'] ) {&nbsp;</div></li><li><div>                  $order_types[] = $type;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>      default :&nbsp;</div></li><li><div>          $order_types = array_keys( $wc_order_types );&nbsp;</div></li><li><div>      break;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'wc_order_types', $order_types, $for );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get an order type by post type name.</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string post type name</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|array of datails about the order type</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_order_type( $type ) {&nbsp;</div></li><li><div>  global $wc_order_types;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $wc_order_types[ $type ] ) ) {&nbsp;</div></li><li><div>      return $wc_order_types[ $type ];&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register order type. Do not use before init.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Wrapper for register post type, as well as a method of telling WC which.</span>&nbsp;</div></li><li><div><span class="comment"> * post types are types of orders, and having them treated as such.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * $args are passed to register_post_type, but there are a few specific to this function:</span>&nbsp;</div></li><li><div><span class="comment"> *      - exclude_from_orders_screen (bool) Whether or not this order type also get shown in the main.</span>&nbsp;</div></li><li><div><span class="comment"> *      orders screen.</span>&nbsp;</div></li><li><div><span class="comment"> *      - add_order_meta_boxes (bool) Whether or not the order type gets shop_order meta boxes.</span>&nbsp;</div></li><li><div><span class="comment"> *      - exclude_from_order_count (bool) Whether or not this order type is excluded from counts.</span>&nbsp;</div></li><li><div><span class="comment"> *      - exclude_from_order_views (bool) Whether or not this order type is visible by customers when.</span>&nbsp;</div></li><li><div><span class="comment"> *      viewing orders e.g. on the my account page.</span>&nbsp;</div></li><li><div><span class="comment"> *      - exclude_from_order_reports (bool) Whether or not to exclude this type from core reports.</span>&nbsp;</div></li><li><div><span class="comment"> *      - exclude_from_order_sales_reports (bool) Whether or not to exclude this type from core sales reports.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @see    register_post_type for $args used in that function</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $type Post type. (max. 20 characters, can not contain capital letters or spaces)</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $args An array of arguments.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool Success or failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_register_order_type( $type, $args = array() ) {&nbsp;</div></li><li><div>  if ( post_type_exists( $type ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wc_order_types;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $wc_order_types ) ) {&nbsp;</div></li><li><div>      $wc_order_types = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Register as a post type</span>&nbsp;</div></li><li><div>  if ( is_wp_error( register_post_type( $type, $args ) ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Register for WC usage</span>&nbsp;</div></li><li><div>  $order_type_args = array(&nbsp;</div></li><li><div>      'exclude_from_orders_screen' =&gt; false, &nbsp;</div></li><li><div>      'add_order_meta_boxes' =&gt; true, &nbsp;</div></li><li><div>      'exclude_from_order_count' =&gt; false, &nbsp;</div></li><li><div>      'exclude_from_order_views' =&gt; false, &nbsp;</div></li><li><div>      'exclude_from_order_webhooks' =&gt; false, &nbsp;</div></li><li><div>      'exclude_from_order_reports' =&gt; false, &nbsp;</div></li><li><div>      'exclude_from_order_sales_reports' =&gt; false, &nbsp;</div></li><li><div>      'class_name' =&gt; 'WC_Order', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array_intersect_key( $args, $order_type_args );&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $order_type_args );&nbsp;</div></li><li><div>  $wc_order_types[ $type ] = $args;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return true;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the count of processing orders.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_processing_order_count() {&nbsp;</div></li><li><div>  return wc_orders_count( 'processing' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Return the orders count of a specific order status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $status</span>&nbsp;</div></li><li><div><span class="comment"> * @return int</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_orders_count( $status ) {&nbsp;</div></li><li><div>  $count = 0;&nbsp;</div></li><li><div>  $status = 'wc-' . $status;&nbsp;</div></li><li><div>  $order_statuses = array_keys( wc_get_order_statuses() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! in_array( $status, $order_statuses ) ) {&nbsp;</div></li><li><div>      return 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cache_key = WC_Cache_Helper::get_cache_prefix( 'orders' ) . $status;&nbsp;</div></li><li><div>  $cached_count = wp_cache_get( $cache_key, 'counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== $cached_count ) {&nbsp;</div></li><li><div>      return $cached_count;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( wc_get_order_types( 'order-count' ) as $type ) {&nbsp;</div></li><li><div>      $data_store = WC_Data_Store::load( 'shop_order' === $type ? 'order' : $type );&nbsp;</div></li><li><div>      if ( $data_store ) {&nbsp;</div></li><li><div>          $count += $data_store-&gt;get_order_count( $status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_cache_set( $cache_key, $count, 'counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $count;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Grant downloadable product access to the file identified by $download_id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $download_id file identifier</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int|WC_Product $product</span>&nbsp;</div></li><li><div><span class="comment"> * @param  WC_Order $order the order</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $qty purchased</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool insert id or false on failure</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_downloadable_file_permission( $download_id, $product, $order, $qty = 1 ) {&nbsp;</div></li><li><div>  if ( is_numeric( $product ) ) {&nbsp;</div></li><li><div>      $product = wc_get_product( $product );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $download = new WC_Customer_Download();&nbsp;</div></li><li><div>  $download-&gt;set_download_id( $download_id );&nbsp;</div></li><li><div>  $download-&gt;set_product_id( $product-&gt;get_id() );&nbsp;</div></li><li><div>  $download-&gt;set_user_id( $order-&gt;get_customer_id() );&nbsp;</div></li><li><div>  $download-&gt;set_order_id( $order-&gt;get_id() );&nbsp;</div></li><li><div>  $download-&gt;set_user_email( $order-&gt;get_billing_email() );&nbsp;</div></li><li><div>  $download-&gt;set_order_key( $order-&gt;get_order_key() );&nbsp;</div></li><li><div>  $download-&gt;set_downloads_remaining( 0 &gt; $product-&gt;get_download_limit() ? '' : $product-&gt;get_download_limit() * $qty );&nbsp;</div></li><li><div>  $download-&gt;set_access_granted( current_time( 'timestamp', true ) );&nbsp;</div></li><li><div>  $download-&gt;set_download_count( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $expiry = $product-&gt;get_download_expiry();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $expiry &gt; 0 ) {&nbsp;</div></li><li><div>      $from_date = $order-&gt;get_date_completed() ? $order-&gt;get_date_completed()-&gt;format( 'Y-m-d' ) : current_time( 'mysql', true );&nbsp;</div></li><li><div>      $download-&gt;set_access_expires( strtotime( $from_date . ' + ' . $expiry . ' DAY' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $download-&gt;save();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Order Status completed - GIVE DOWNLOADABLE PRODUCT ACCESS TO CUSTOMER.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_downloadable_product_permissions( $order_id, $force = false ) {&nbsp;</div></li><li><div>  $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $order || ( $order-&gt;get_data_store()-&gt;get_download_permissions_granted( $order ) && ! $force ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $order-&gt;has_status( 'processing' ) && 'no' === get_option( 'woocommerce_downloads_grant_access_after_payment' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( sizeof( $order-&gt;get_items() ) &gt; 0 ) {&nbsp;</div></li><li><div>      foreach ( $order-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          $product = $item-&gt;get_product();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $product && $product-&gt;exists() && $product-&gt;is_downloadable() ) {&nbsp;</div></li><li><div>              $downloads = $product-&gt;get_downloads();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( array_keys( $downloads ) as $download_id ) {&nbsp;</div></li><li><div>                  wc_downloadable_file_permission( $download_id, $product, $order, $item-&gt;get_quantity() );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $order-&gt;get_data_store()-&gt;set_download_permissions_granted( $order, true );&nbsp;</div></li><li><div>  do_action( 'woocommerce_grant_product_download_permissions', $order_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_completed', 'wc_downloadable_product_permissions' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_processing', 'wc_downloadable_product_permissions' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Clear all transients cache for order data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|WC_Order $order</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_delete_shop_order_transients( $order = 0 ) {&nbsp;</div></li><li><div>  if ( is_numeric( $order ) ) {&nbsp;</div></li><li><div>      $order = wc_get_order( $order );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $reports = WC_Admin_Reports::get_reports();&nbsp;</div></li><li><div>  $transients_to_clear = array(&nbsp;</div></li><li><div>      'wc_admin_report'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $reports as $report_group ) {&nbsp;</div></li><li><div>      foreach ( $report_group['reports'] as $report_key =&gt; $report ) {&nbsp;</div></li><li><div>          $transients_to_clear[] = 'wc_report_' . $report_key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $transients_to_clear as $transient ) {&nbsp;</div></li><li><div>      delete_transient( $transient );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Clear money spent for user associated with order</span>&nbsp;</div></li><li><div>  if ( is_a( $order, 'WC_Order' ) ) {&nbsp;</div></li><li><div>      $order_id = $order-&gt;get_id();&nbsp;</div></li><li><div>      delete_user_meta( $order-&gt;get_customer_id(), '_money_spent' );&nbsp;</div></li><li><div>      delete_user_meta( $order-&gt;get_customer_id(), '_order_count' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $order_id = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Increments the transient version to invalidate cache</span>&nbsp;</div></li><li><div>  WC_Cache_Helper::get_transient_version( 'orders', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Do the same for regular cache</span>&nbsp;</div></li><li><div>  WC_Cache_Helper::incr_cache_prefix( 'orders' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'woocommerce_delete_shop_order_transients', $order_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * See if we only ship to billing addresses.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_ship_to_billing_address_only() {&nbsp;</div></li><li><div>  return 'billing_only' === get_option( 'woocommerce_ship_to_destination' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create a new order refund programmatically.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns a new refund object on success which can then be used to add additional data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args</span>&nbsp;</div></li><li><div><span class="comment"> * @return WC_Order_Refund|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_create_refund( $args = array() ) {&nbsp;</div></li><li><div>  $default_args = array(&nbsp;</div></li><li><div>      'amount' =&gt; 0, &nbsp;</div></li><li><div>      'reason' =&gt; null, &nbsp;</div></li><li><div>      'order_id' =&gt; 0, &nbsp;</div></li><li><div>      'refund_id' =&gt; 0, &nbsp;</div></li><li><div>      'line_items' =&gt; array(), &nbsp;</div></li><li><div>      'refund_payment' =&gt; false, &nbsp;</div></li><li><div>      'restock_items' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  try {&nbsp;</div></li><li><div>      $args = wp_parse_args( $args, $default_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $order = wc_get_order( $args['order_id'] ) ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'Invalid order ID.', 'woocommerce' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $remaining_refund_amount = $order-&gt;get_remaining_refund_amount();&nbsp;</div></li><li><div>      $remaining_refund_items = $order-&gt;get_remaining_refund_items();&nbsp;</div></li><li><div>      $refund_item_count = 0;&nbsp;</div></li><li><div>      $refund = new WC_Order_Refund( $args['refund_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 0 &gt; $args['amount'] || $args['amount'] &gt; $remaining_refund_amount ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'Invalid refund amount.', 'woocommerce' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $refund-&gt;set_currency( $order-&gt;get_currency() );&nbsp;</div></li><li><div>      $refund-&gt;set_amount( $args['amount'] );&nbsp;</div></li><li><div>      $refund-&gt;set_parent_id( absint( $args['order_id'] ) );&nbsp;</div></li><li><div>      $refund-&gt;set_refunded_by( get_current_user_id() ? get_current_user_id() : 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_null( $args['reason'] ) ) {&nbsp;</div></li><li><div>          $refund-&gt;set_reason( $args['reason'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Negative line items</span>&nbsp;</div></li><li><div>      if ( sizeof( $args['line_items'] ) &gt; 0 ) {&nbsp;</div></li><li><div>          $items = $order-&gt;get_items( array( 'line_item', 'fee', 'shipping' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ( $items as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>              if ( ! isset( $args['line_items'][ $item_id ] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $qty = isset( $args['line_items'][ $item_id ]['qty'] ) ? $args['line_items'][ $item_id ]['qty'] : 0;&nbsp;</div></li><li><div>              $refund_total = $args['line_items'][ $item_id ]['refund_total'];&nbsp;</div></li><li><div>              $refund_tax = isset( $args['line_items'][ $item_id ]['refund_tax'] ) ? array_filter( (array) $args['line_items'][ $item_id ]['refund_tax'] ) : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( empty( $qty ) && empty( $refund_total ) && empty( $args['line_items'][ $item_id ]['refund_tax'] ) ) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $class = get_class( $item );&nbsp;</div></li><li><div>              $refunded_item = new $class( $item );&nbsp;</div></li><li><div>              $refunded_item-&gt;set_id( 0 );&nbsp;</div></li><li><div>              $refunded_item-&gt;add_meta_data( '_refunded_item_id', $item_id, true );&nbsp;</div></li><li><div>              $refunded_item-&gt;set_total( wc_format_refund_total( $refund_total ) );&nbsp;</div></li><li><div>              $refunded_item-&gt;set_taxes( array( 'total' =&gt; array_map( 'wc_format_refund_total', $refund_tax ), 'subtotal' =&gt; array_map( 'wc_format_refund_total', $refund_tax ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_callable( array( $refunded_item, 'set_subtotal' ) ) ) {&nbsp;</div></li><li><div>                  $refunded_item-&gt;set_subtotal( wc_format_refund_total( $refund_total ) );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_callable( array( $refunded_item, 'set_quantity' ) ) ) {&nbsp;</div></li><li><div>                  $refunded_item-&gt;set_quantity( $qty * -1 );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $refund-&gt;add_item( $refunded_item );&nbsp;</div></li><li><div>              $refund_item_count += $qty;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $refund-&gt;update_taxes();&nbsp;</div></li><li><div>      $refund-&gt;calculate_totals( false );&nbsp;</div></li><li><div>      $refund-&gt;set_total( $args['amount'] * -1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">       * Action hook to adjust refund before save.</span>&nbsp;</div></li><li><div><span class="comment">       * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>      do_action( 'woocommerce_create_refund', $refund, $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $refund-&gt;save() ) {&nbsp;</div></li><li><div>          if ( $args['refund_payment'] ) {&nbsp;</div></li><li><div>              $result = wc_refund_payment( $order, $refund-&gt;get_amount(), $refund-&gt;get_reason() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                  $refund-&gt;delete();&nbsp;</div></li><li><div>                  return $result;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $args['restock_items'] ) {&nbsp;</div></li><li><div>              wc_restock_refunded_items( $order, $args['line_items'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Trigger notification emails</span>&nbsp;</div></li><li><div>          if ( ( $remaining_refund_amount - $args['amount'] ) &gt; 0 || ( $order-&gt;has_free_item() && ( $remaining_refund_items - $refund_item_count ) &gt; 0 ) ) {&nbsp;</div></li><li><div>              do_action( 'woocommerce_order_partially_refunded', $order-&gt;get_id(), $refund-&gt;get_id() );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              do_action( 'woocommerce_order_fully_refunded', $order-&gt;get_id(), $refund-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $parent_status = apply_filters( 'woocommerce_order_fully_refunded_status', 'refunded', $order-&gt;get_id(), $refund-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $parent_status ) {&nbsp;</div></li><li><div>                  $order-&gt;update_status( $parent_status );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'woocommerce_refund_created', $refund-&gt;get_id(), $args );&nbsp;</div></li><li><div>      do_action( 'woocommerce_order_refunded', $order-&gt;get_id(), $refund-&gt;get_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } catch ( Exception $e ) {&nbsp;</div></li><li><div>      return new WP_Error( 'error', $e-&gt;getMessage() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $refund;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Try to refund the payment for an order via the gateway.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param WC_Order $order</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $amount</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $reason</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|WP_Error</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_refund_payment( $order, $amount, $reason = '' ) {&nbsp;</div></li><li><div>  try {&nbsp;</div></li><li><div>      if ( ! is_a( $order, 'WC_Order' ) ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'Invalid order.', 'woocommerce' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $gateway_controller = WC_Payment_Gateways::instance();&nbsp;</div></li><li><div>      $all_gateways = $gateway_controller-&gt;payment_gateways();&nbsp;</div></li><li><div>      $payment_method = $order-&gt;get_payment_method();&nbsp;</div></li><li><div>      $gateway = isset( $all_gateways[ $payment_method ] ) ? $all_gateways[ $payment_method ] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $gateway ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'The payment gateway for this order does not exist.', 'woocommerce' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $gateway-&gt;supports( 'refunds' ) ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'The payment gateway for this order does not support automatic refunds.', 'woocommerce' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result = $gateway-&gt;process_refund( $order-&gt;get_id(), $amount, $reason );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $result ) {&nbsp;</div></li><li><div>          throw new Exception( __( 'An error occurred while attempting to create the refund using the payment gateway API.', 'woocommerce' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>          throw new Exception( $result-&gt;get_error_message() );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } catch ( Exception $e ) {&nbsp;</div></li><li><div>      return new WP_Error( 'error', $e-&gt;getMessage() );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Restock items during refund.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param  WC_Order $order</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $refunded_line_items</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_restock_refunded_items( $order, $refunded_line_items ) {&nbsp;</div></li><li><div>  $line_items = $order-&gt;get_items();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $line_items as $item_id =&gt; $item ) {&nbsp;</div></li><li><div>      if ( ! isset( $refunded_line_items[ $item_id ], $refunded_line_items[ $item_id ]['qty'] ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $product = $item-&gt;get_product();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $product && $product-&gt;managing_stock() ) {&nbsp;</div></li><li><div>          $old_stock = $product-&gt;get_stock_quantity();&nbsp;</div></li><li><div>          $new_stock = wc_update_product_stock( $product, $refunded_line_items[ $item_id ]['qty'], 'increase' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $order-&gt;add_order_note( sprintf( __( 'Item #%1$s stock increased from %2$s to %3$s.', 'woocommerce' ), $product-&gt;get_id(), $old_stock, $new_stock ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'woocommerce_restock_refunded_item', $product-&gt;get_id(), $old_stock, $new_stock, $order, $product );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get tax class by tax id.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $tax_id</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_tax_class_by_tax_id( $tax_id ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>  return $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT tax_rate_class FROM {$wpdb-&gt;prefix}woocommerce_tax_rates WHERE tax_rate_id = %d&quot;, $tax_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get payment gateway class by order data.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int|WC_Order $order</span>&nbsp;</div></li><li><div><span class="comment"> * @return WC_Payment_Gateway|bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_get_payment_gateway_by_order( $order ) {&nbsp;</div></li><li><div>  if ( WC()-&gt;payment_gateways() ) {&nbsp;</div></li><li><div>      $payment_gateways = WC()-&gt;payment_gateways-&gt;payment_gateways();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $payment_gateways = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_object( $order ) ) {&nbsp;</div></li><li><div>      $order_id = absint( $order );&nbsp;</div></li><li><div>      $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return isset( $payment_gateways[ $order-&gt;get_payment_method() ] ) ? $payment_gateways[ $order-&gt;get_payment_method() ] : false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * When refunding an order, create a refund line item if the partial refunds do not match order total.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is manual; no gateway refund will be performed.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_order_fully_refunded( $order_id ) {&nbsp;</div></li><li><div>  $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>  $max_refund = wc_format_decimal( $order-&gt;get_total() - $order-&gt;get_total_refunded() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $max_refund ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Create the refund object</span>&nbsp;</div></li><li><div>  wc_create_refund( array(&nbsp;</div></li><li><div>      'amount' =&gt; $max_refund, &nbsp;</div></li><li><div>      'reason' =&gt; __( 'Order fully refunded', 'woocommerce' ), &nbsp;</div></li><li><div>      'order_id' =&gt; $order_id, &nbsp;</div></li><li><div>      'line_items' =&gt; array(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_refunded', 'wc_order_fully_refunded' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Search orders.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $term Term to search.</span>&nbsp;</div></li><li><div><span class="comment"> * @return array List of orders ID.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_order_search( $term ) {&nbsp;</div></li><li><div>  $data_store = WC_Data_Store::load( 'order' );&nbsp;</div></li><li><div>  return $data_store-&gt;search_orders( str_replace( 'Order #', '', wc_clean( $term ) ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update total sales amount for each product within a paid order.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_update_total_sales_counts( $order_id ) {&nbsp;</div></li><li><div>  $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $order || $order-&gt;get_data_store()-&gt;get_recorded_sales( $order ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( sizeof( $order-&gt;get_items() ) &gt; 0 ) {&nbsp;</div></li><li><div>      foreach ( $order-&gt;get_items() as $item ) {&nbsp;</div></li><li><div>          if ( $product_id = $item-&gt;get_product_id() ) {&nbsp;</div></li><li><div>              $data_store = WC_Data_Store::load( 'product' );&nbsp;</div></li><li><div>              $data_store-&gt;update_product_sales( $product_id, absint( $item['qty'] ), 'increase' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $order-&gt;get_data_store()-&gt;set_recorded_sales( $order, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Called when sales for an order are recorded</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $order_id order id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'woocommerce_recorded_sales', $order_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_completed', 'wc_update_total_sales_counts' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_processing', 'wc_update_total_sales_counts' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_on-hold', 'wc_update_total_sales_counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update used coupon amount for each coupon within an order.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 3.0.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $order_id</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_update_coupon_usage_counts( $order_id ) {&nbsp;</div></li><li><div>  if ( ! $order = wc_get_order( $order_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $has_recorded = $order-&gt;get_data_store()-&gt;get_recorded_coupon_usage_counts( $order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $order-&gt;has_status( 'cancelled' ) && $has_recorded ) {&nbsp;</div></li><li><div>      $action = 'reduce';&nbsp;</div></li><li><div>      $order-&gt;get_data_store()-&gt;set_recorded_coupon_usage_counts( $order, false );&nbsp;</div></li><li><div>  } elseif ( ! $order-&gt;has_status( 'cancelled' ) && ! $has_recorded ) {&nbsp;</div></li><li><div>      $action = 'increase';&nbsp;</div></li><li><div>      $order-&gt;get_data_store()-&gt;set_recorded_coupon_usage_counts( $order, true );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( sizeof( $order-&gt;get_used_coupons() ) &gt; 0 ) {&nbsp;</div></li><li><div>      foreach ( $order-&gt;get_used_coupons() as $code ) {&nbsp;</div></li><li><div>          if ( ! $code ) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $coupon = new WC_Coupon( $code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! $used_by = $order-&gt;get_user_id() ) {&nbsp;</div></li><li><div>              $used_by = $order-&gt;get_billing_email();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch ( $action ) {&nbsp;</div></li><li><div>              case 'reduce' :&nbsp;</div></li><li><div>                  $coupon-&gt;decrease_usage_count( $used_by );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>              case 'increase' :&nbsp;</div></li><li><div>                  $coupon-&gt;increase_usage_count( $used_by );&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_pending', 'wc_update_coupon_usage_counts' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_completed', 'wc_update_coupon_usage_counts' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_processing', 'wc_update_coupon_usage_counts' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_on-hold', 'wc_update_coupon_usage_counts' );&nbsp;</div></li><li><div>add_action( 'woocommerce_order_status_cancelled', 'wc_update_coupon_usage_counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Cancel all unpaid orders after held duration to prevent stock lock for those products.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function wc_cancel_unpaid_orders() {&nbsp;</div></li><li><div>  $held_duration = get_option( 'woocommerce_hold_stock_minutes' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $held_duration &lt; 1 || 'yes' !== get_option( 'woocommerce_manage_stock' ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $data_store = WC_Data_Store::load( 'order' );&nbsp;</div></li><li><div>  $unpaid_orders = $data_store-&gt;get_unpaid_orders( strtotime( '-' . absint( $held_duration ) . ' MINUTES', current_time( 'timestamp' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $unpaid_orders ) {&nbsp;</div></li><li><div>      foreach ( $unpaid_orders as $unpaid_order ) {&nbsp;</div></li><li><div>          $order = wc_get_order( $unpaid_order );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( apply_filters( 'woocommerce_cancel_unpaid_order', 'checkout' === $order-&gt;get_created_via(), $order ) ) {&nbsp;</div></li><li><div>              $order-&gt;update_status( 'cancelled', __( 'Unpaid order cancelled - time limit reached.', 'woocommerce' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  wp_clear_scheduled_hook( 'woocommerce_cancel_unpaid_orders' );&nbsp;</div></li><li><div>  wp_schedule_single_event( time() + ( absint( $held_duration ) * 60 ), 'woocommerce_cancel_unpaid_orders' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'woocommerce_cancel_unpaid_orders', 'wc_cancel_unpaid_orders' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>