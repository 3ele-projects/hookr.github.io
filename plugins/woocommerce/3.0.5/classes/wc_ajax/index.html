<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.0.5" data-slug="woocommerce" data-type="class" data-id="41103"><head xmlns="http://www.w3.org/1999/xhtml"><title> wc_ajax | class | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WC_AJAX, class, plugin, woocommerce, 3.0.5" /><meta name="description" content="WooCommerce WC_AJAX." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=834629e2d44c8bd713cc47b3bcb28318' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wc_ajax/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_ajax%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_ajax%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.5-class-wc_ajax","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wc_ajax" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.5." href="http://hookr.io/plugins/woocommerce/3.0.5/" class="H_VERSION"><span property="name">3.0.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce/3.0.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wc_ajax</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="3116"><a href="http://hookr.io/plugins/woocommerce/3.0.5/all/" title="All">All <span class="count badge">3116</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce/3.0.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2109"><a href="http://hookr.io/plugins/woocommerce/3.0.5/hooks/" title="Hooks">Hooks <span class="count badge">2109</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.5/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1335"><a href="http://hookr.io/plugins/woocommerce/3.0.5/filters/" title="Filters">Filters <span class="count badge">1335</span></a></li><li class="active" data-id="class" data-count="364"><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/" title="Classes">Classes <span class="count badge">364</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.5/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="625"><a href="http://hookr.io/plugins/woocommerce/3.0.5/functions/" title="Functions">Functions <span class="count badge">625</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WC_AJAX</strong></h1><p>WooCommerce WC_AJAX.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.5/files/includes-class-wc-ajax/" class="file">/includes/class-wc-ajax.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="17" class="block" start="17"><li><div>class WC_AJAX {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Hook in ajax handlers.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function init() {&nbsp;</div></li><li><div>        add_action( 'init', array( __CLASS__, 'define_ajax' ), 0 );&nbsp;</div></li><li><div>        add_action( 'template_redirect', array( __CLASS__, 'do_wc_ajax' ), 0 );&nbsp;</div></li><li><div>        self::add_ajax_events();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get WC Ajax Endpoint.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $request Optional&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_endpoint( $request = '' ) {&nbsp;</div></li><li><div>        return esc_url_raw( apply_filters( 'woocommerce_ajax_get_endpoint', add_query_arg( 'wc-ajax', $request, remove_query_arg( array( 'remove_item', 'add-to-cart', 'added-to-cart' ) ) ), $request ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set WC AJAX constant and headers.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function define_ajax() {&nbsp;</div></li><li><div>        if ( ! empty( $_GET['wc-ajax'] ) ) {&nbsp;</div></li><li><div>            wc_maybe_define_constant( 'DOING_AJAX', true );&nbsp;</div></li><li><div>            wc_maybe_define_constant( 'WC_DOING_AJAX', true );&nbsp;</div></li><li><div>            if ( ! WP_DEBUG || ( WP_DEBUG && ! WP_DEBUG_DISPLAY ) ) {&nbsp;</div></li><li><div>                @ini_set( 'display_errors', 0 ); // Turn off display_errors during AJAX events to prevent malformed JSON&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $GLOBALS['wpdb']-&gt;hide_errors();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Send headers for WC Ajax Requests.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 2.5.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function wc_ajax_headers() {&nbsp;</div></li><li><div>        send_origin_headers();&nbsp;</div></li><li><div>        @header( 'Content-Type: text/html; charset=' . get_option( 'blog_charset' ) );&nbsp;</div></li><li><div>        @header( 'X-Robots-Tag: noindex' );&nbsp;</div></li><li><div>        send_nosniff_header();&nbsp;</div></li><li><div>        nocache_headers();&nbsp;</div></li><li><div>        status_header( 200 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check for WC Ajax request and fire action.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function do_wc_ajax() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['wc-ajax'] ) ) {&nbsp;</div></li><li><div>            $wp_query-&gt;set( 'wc-ajax', sanitize_text_field( $_GET['wc-ajax'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $action = $wp_query-&gt;get( 'wc-ajax' ) ) {&nbsp;</div></li><li><div>            self::wc_ajax_headers();&nbsp;</div></li><li><div>            do_action( 'wc_ajax_' . sanitize_text_field( $action ) );&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Hook in methods - uses WordPress ajax handlers (admin-ajax).&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_ajax_events() {&nbsp;</div></li><li><div>        // woocommerce_EVENT =&gt; nopriv&nbsp;</div></li><li><div>        $ajax_events = array(&nbsp;</div></li><li><div>            'get_refreshed_fragments' =&gt; true, &nbsp;</div></li><li><div>            'apply_coupon' =&gt; true, &nbsp;</div></li><li><div>            'remove_coupon' =&gt; true, &nbsp;</div></li><li><div>            'update_shipping_method' =&gt; true, &nbsp;</div></li><li><div>            'get_cart_totals' =&gt; true, &nbsp;</div></li><li><div>            'update_order_review' =&gt; true, &nbsp;</div></li><li><div>            'add_to_cart' =&gt; true, &nbsp;</div></li><li><div>            'checkout' =&gt; true, &nbsp;</div></li><li><div>            'get_variation' =&gt; true, &nbsp;</div></li><li><div>            'get_customer_location' =&gt; true, &nbsp;</div></li><li><div>            'feature_product' =&gt; false, &nbsp;</div></li><li><div>            'mark_order_status' =&gt; false, &nbsp;</div></li><li><div>            'add_attribute' =&gt; false, &nbsp;</div></li><li><div>            'add_new_attribute' =&gt; false, &nbsp;</div></li><li><div>            'remove_variation' =&gt; false, &nbsp;</div></li><li><div>            'remove_variations' =&gt; false, &nbsp;</div></li><li><div>            'save_attributes' =&gt; false, &nbsp;</div></li><li><div>            'add_variation' =&gt; false, &nbsp;</div></li><li><div>            'link_all_variations' =&gt; false, &nbsp;</div></li><li><div>            'revoke_access_to_download' =&gt; false, &nbsp;</div></li><li><div>            'grant_access_to_download' =&gt; false, &nbsp;</div></li><li><div>            'get_customer_details' =&gt; false, &nbsp;</div></li><li><div>            'add_order_item' =&gt; false, &nbsp;</div></li><li><div>            'add_order_fee' =&gt; false, &nbsp;</div></li><li><div>            'add_order_shipping' =&gt; false, &nbsp;</div></li><li><div>            'add_order_tax' =&gt; false, &nbsp;</div></li><li><div>            'remove_order_item' =&gt; false, &nbsp;</div></li><li><div>            'remove_order_tax' =&gt; false, &nbsp;</div></li><li><div>            'reduce_order_item_stock' =&gt; false, &nbsp;</div></li><li><div>            'increase_order_item_stock' =&gt; false, &nbsp;</div></li><li><div>            'add_order_item_meta' =&gt; false, &nbsp;</div></li><li><div>            'remove_order_item_meta' =&gt; false, &nbsp;</div></li><li><div>            'calc_line_taxes' =&gt; false, &nbsp;</div></li><li><div>            'save_order_items' =&gt; false, &nbsp;</div></li><li><div>            'load_order_items' =&gt; false, &nbsp;</div></li><li><div>            'add_order_note' =&gt; false, &nbsp;</div></li><li><div>            'delete_order_note' =&gt; false, &nbsp;</div></li><li><div>            'json_search_products' =&gt; false, &nbsp;</div></li><li><div>            'json_search_products_and_variations' =&gt; false, &nbsp;</div></li><li><div>            'json_search_downloadable_products_and_variations' =&gt; false, &nbsp;</div></li><li><div>            'json_search_customers' =&gt; false, &nbsp;</div></li><li><div>            'term_ordering' =&gt; false, &nbsp;</div></li><li><div>            'product_ordering' =&gt; false, &nbsp;</div></li><li><div>            'refund_line_items' =&gt; false, &nbsp;</div></li><li><div>            'delete_refund' =&gt; false, &nbsp;</div></li><li><div>            'rated' =&gt; false, &nbsp;</div></li><li><div>            'update_api_key' =&gt; false, &nbsp;</div></li><li><div>            'load_variations' =&gt; false, &nbsp;</div></li><li><div>            'save_variations' =&gt; false, &nbsp;</div></li><li><div>            'bulk_edit_variations' =&gt; false, &nbsp;</div></li><li><div>            'tax_rates_save_changes' =&gt; false, &nbsp;</div></li><li><div>            'shipping_zones_save_changes' =&gt; false, &nbsp;</div></li><li><div>            'shipping_zone_add_method' =&gt; false, &nbsp;</div></li><li><div>            'shipping_zone_methods_save_changes' =&gt; false, &nbsp;</div></li><li><div>            'shipping_zone_methods_save_settings' =&gt; false, &nbsp;</div></li><li><div>            'shipping_classes_save_changes' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $ajax_events as $ajax_event =&gt; $nopriv ) {&nbsp;</div></li><li><div>            add_action( 'wp_ajax_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $nopriv ) {&nbsp;</div></li><li><div>                add_action( 'wp_ajax_nopriv_woocommerce_' . $ajax_event, array( __CLASS__, $ajax_event ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // WC AJAX can be used for frontend ajax requests.&nbsp;</div></li><li><div>                add_action( 'wc_ajax_' . $ajax_event, array( __CLASS__, $ajax_event ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a refreshed cart fragment, including the mini cart HTML.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_refreshed_fragments() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        woocommerce_mini_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $mini_cart = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'fragments' =&gt; apply_filters( 'woocommerce_add_to_cart_fragments', array(&nbsp;</div></li><li><div>                    'div.widget_shopping_cart_content' =&gt; '&lt;div class=&quot;widget_shopping_cart_content&quot;&gt;' . $mini_cart . '&lt;/div&gt;', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'cart_hash' =&gt; apply_filters( 'woocommerce_add_to_cart_hash', WC()-&gt;cart-&gt;get_cart_for_session() ? md5( json_encode( WC()-&gt;cart-&gt;get_cart_for_session() ) ) : '', WC()-&gt;cart-&gt;get_cart_for_session() ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json( $data );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX apply coupon on checkout page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function apply_coupon() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'apply-coupon', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_POST['coupon_code'] ) ) {&nbsp;</div></li><li><div>            WC()-&gt;cart-&gt;add_discount( sanitize_text_field( $_POST['coupon_code'] ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wc_add_notice( WC_Coupon::get_generic_coupon_error( WC_Coupon::E_WC_COUPON_PLEASE_ENTER ), 'error' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_print_notices();&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX remove coupon on cart and checkout page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function remove_coupon() {&nbsp;</div></li><li><div>        check_ajax_referer( 'remove-coupon', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $coupon = isset( $_POST['coupon'] ) ? wc_clean( $_POST['coupon'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $coupon ) ) {&nbsp;</div></li><li><div>            wc_add_notice( __( 'Sorry there was a problem removing this coupon.', 'woocommerce' ), 'error' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            WC()-&gt;cart-&gt;remove_coupon( $coupon );&nbsp;</div></li><li><div>            wc_add_notice( __( 'Coupon has been removed.', 'woocommerce' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_print_notices();&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX update shipping method on cart page.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_shipping_method() {&nbsp;</div></li><li><div>        check_ajax_referer( 'update-shipping-method', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_maybe_define_constant( 'WOOCOMMERCE_CART', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $chosen_shipping_methods = WC()-&gt;session-&gt;get( 'chosen_shipping_methods' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_POST['shipping_method'] ) && is_array( $_POST['shipping_method'] ) ) {&nbsp;</div></li><li><div>            foreach ( $_POST['shipping_method'] as $i =&gt; $value ) {&nbsp;</div></li><li><div>                $chosen_shipping_methods[ $i ] = wc_clean( $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( 'chosen_shipping_methods', $chosen_shipping_methods );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::get_cart_totals();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX receive updated cart_totals div.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_cart_totals() {&nbsp;</div></li><li><div>        wc_maybe_define_constant( 'WOOCOMMERCE_CART', true );&nbsp;</div></li><li><div>        WC()-&gt;cart-&gt;calculate_totals();&nbsp;</div></li><li><div>        woocommerce_cart_totals();&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Session has expired.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function update_order_review_expired() {&nbsp;</div></li><li><div>        wp_send_json( array(&nbsp;</div></li><li><div>            'fragments' =&gt; apply_filters( 'woocommerce_update_order_review_fragments', array(&nbsp;</div></li><li><div>                'form.woocommerce-checkout' =&gt; '&lt;div class=&quot;woocommerce-error&quot;&gt;' . __( 'Sorry, your session has expired.', 'woocommerce' ) . ' &lt;a href=&quot;' . esc_url( wc_get_page_permalink( 'shop' ) ) . '&quot; class=&quot;wc-backward&quot;&gt;' . __( 'Return to shop', 'woocommerce' ) . '&lt;/a&gt;&lt;/div&gt;', &nbsp;</div></li><li><div> ) ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX update order review on checkout.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_order_review() {&nbsp;</div></li><li><div>        check_ajax_referer( 'update-order-review', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_maybe_define_constant( 'WOOCOMMERCE_CHECKOUT', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( WC()-&gt;cart-&gt;is_empty() ) {&nbsp;</div></li><li><div>            self::update_order_review_expired();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_checkout_update_order_review', $_POST['post_data'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $chosen_shipping_methods = WC()-&gt;session-&gt;get( 'chosen_shipping_methods' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_POST['shipping_method'] ) && is_array( $_POST['shipping_method'] ) ) {&nbsp;</div></li><li><div>            foreach ( $_POST['shipping_method'] as $i =&gt; $value ) {&nbsp;</div></li><li><div>                $chosen_shipping_methods[ $i ] = wc_clean( $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( 'chosen_shipping_methods', $chosen_shipping_methods );&nbsp;</div></li><li><div>        WC()-&gt;session-&gt;set( 'chosen_payment_method', empty( $_POST['payment_method'] ) ? '' : $_POST['payment_method'] );&nbsp;</div></li><li><div>        WC()-&gt;customer-&gt;set_props( array(&nbsp;</div></li><li><div>            'billing_country' =&gt; isset( $_POST['country'] ) ? $_POST['country']     : null, &nbsp;</div></li><li><div>            'billing_state' =&gt; isset( $_POST['state'] ) ? $_POST['state']         : null, &nbsp;</div></li><li><div>            'billing_postcode' =&gt; isset( $_POST['postcode'] ) ? $_POST['postcode']   : null, &nbsp;</div></li><li><div>            'billing_city' =&gt; isset( $_POST['city'] ) ? $_POST['city']           : null, &nbsp;</div></li><li><div>            'billing_address_1' =&gt; isset( $_POST['address'] ) ? $_POST['address']     : null, &nbsp;</div></li><li><div>            'billing_address_2' =&gt; isset( $_POST['address_2'] ) ? $_POST['address_2'] : null, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( wc_ship_to_billing_address_only() ) {&nbsp;</div></li><li><div>            WC()-&gt;customer-&gt;set_props( array(&nbsp;</div></li><li><div>                'shipping_country' =&gt; isset( $_POST['country'] ) ? $_POST['country']     : null, &nbsp;</div></li><li><div>                'shipping_state' =&gt; isset( $_POST['state'] ) ? $_POST['state']         : null, &nbsp;</div></li><li><div>                'shipping_postcode' =&gt; isset( $_POST['postcode'] ) ? $_POST['postcode']   : null, &nbsp;</div></li><li><div>                'shipping_city' =&gt; isset( $_POST['city'] ) ? $_POST['city']           : null, &nbsp;</div></li><li><div>                'shipping_address_1' =&gt; isset( $_POST['address'] ) ? $_POST['address']     : null, &nbsp;</div></li><li><div>                'shipping_address_2' =&gt; isset( $_POST['address_2'] ) ? $_POST['address_2'] : null, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            if ( ! empty( $_POST['country'] ) ) {&nbsp;</div></li><li><div>                WC()-&gt;customer-&gt;set_calculated_shipping( true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            WC()-&gt;customer-&gt;set_props( array(&nbsp;</div></li><li><div>                'shipping_country' =&gt; isset( $_POST['s_country'] ) ? $_POST['s_country']     : null, &nbsp;</div></li><li><div>                'shipping_state' =&gt; isset( $_POST['s_state'] ) ? $_POST['s_state']         : null, &nbsp;</div></li><li><div>                'shipping_postcode' =&gt; isset( $_POST['s_postcode'] ) ? $_POST['s_postcode']   : null, &nbsp;</div></li><li><div>                'shipping_city' =&gt; isset( $_POST['s_city'] ) ? $_POST['s_city']           : null, &nbsp;</div></li><li><div>                'shipping_address_1' =&gt; isset( $_POST['s_address'] ) ? $_POST['s_address']     : null, &nbsp;</div></li><li><div>                'shipping_address_2' =&gt; isset( $_POST['s_address_2'] ) ? $_POST['s_address_2'] : null, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>            if ( ! empty( $_POST['s_country'] ) ) {&nbsp;</div></li><li><div>                WC()-&gt;customer-&gt;set_calculated_shipping( true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        WC()-&gt;customer-&gt;save();&nbsp;</div></li><li><div>        WC()-&gt;cart-&gt;calculate_totals();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get order review fragment&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        woocommerce_order_review();&nbsp;</div></li><li><div>        $woocommerce_order_review = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get checkout payment fragment&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>        woocommerce_checkout_payment();&nbsp;</div></li><li><div>        $woocommerce_checkout_payment = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get messages if reload checkout is not true&nbsp;</div></li><li><div>        $messages = '';&nbsp;</div></li><li><div>        if ( ! isset( WC()-&gt;session-&gt;reload_checkout ) ) {&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>            wc_print_notices();&nbsp;</div></li><li><div>            $messages = ob_get_clean();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( WC()-&gt;session-&gt;refresh_totals, WC()-&gt;session-&gt;reload_checkout );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json( array(&nbsp;</div></li><li><div>            'result' =&gt; empty( $messages ) ? 'success' : 'failure', &nbsp;</div></li><li><div>            'messages' =&gt; $messages, &nbsp;</div></li><li><div>            'reload' =&gt; isset( WC()-&gt;session-&gt;reload_checkout ) ? 'true' : 'false', &nbsp;</div></li><li><div>            'fragments' =&gt; apply_filters( 'woocommerce_update_order_review_fragments', array(&nbsp;</div></li><li><div>                '.woocommerce-checkout-review-order-table' =&gt; $woocommerce_order_review, &nbsp;</div></li><li><div>                '.woocommerce-checkout-payment' =&gt; $woocommerce_checkout_payment, &nbsp;</div></li><li><div> ) ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * AJAX add to cart.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_to_cart() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_id = apply_filters( 'woocommerce_add_to_cart_product_id', absint( $_POST['product_id'] ) );&nbsp;</div></li><li><div>        $quantity = empty( $_POST['quantity'] ) ? 1 : wc_stock_amount( $_POST['quantity'] );&nbsp;</div></li><li><div>        $passed_validation = apply_filters( 'woocommerce_add_to_cart_validation', true, $product_id, $quantity );&nbsp;</div></li><li><div>        $product_status = get_post_status( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $passed_validation && false !== WC()-&gt;cart-&gt;add_to_cart( $product_id, $quantity ) && 'publish' === $product_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_ajax_added_to_cart', $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( get_option( 'woocommerce_cart_redirect_after_add' ) == 'yes' ) {&nbsp;</div></li><li><div>                wc_add_to_cart_message( array( $product_id =&gt; $quantity ), true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Return fragments&nbsp;</div></li><li><div>            self::get_refreshed_fragments();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // If there was an error adding to the cart, redirect to the product page to show any errors&nbsp;</div></li><li><div>            $data = array(&nbsp;</div></li><li><div>                'error' =&gt; true, &nbsp;</div></li><li><div>                'product_url' =&gt; apply_filters( 'woocommerce_cart_redirect_after_error', get_permalink( $product_id ), $product_id ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json( $data );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process ajax checkout form.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function checkout() {&nbsp;</div></li><li><div>        wc_maybe_define_constant( 'WOOCOMMERCE_CHECKOUT', true );&nbsp;</div></li><li><div>        WC()-&gt;checkout()-&gt;process_checkout();&nbsp;</div></li><li><div>        wp_die( 0 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get a matching variation based on posted attributes.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_variation() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $_POST['product_id'] ) || ! ( $variable_product = wc_get_product( absint( $_POST['product_id'] ) ) ) ) {&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data_store = WC_Data_Store::load( 'product' );&nbsp;</div></li><li><div>        $variation_id = $data_store-&gt;find_matching_product_variation( $variable_product, wp_unslash( $_POST ) );&nbsp;</div></li><li><div>        $variation = $variation_id ? $variable_product-&gt;get_available_variation( $variation_id ) : false;&nbsp;</div></li><li><div>        wp_send_json( $variation );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Locate user via AJAX.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_customer_location() {&nbsp;</div></li><li><div>        $location_hash = WC_Cache_Helper::geolocation_ajax_get_location_hash();&nbsp;</div></li><li><div>        wp_send_json_success( array( 'hash' =&gt; $location_hash ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Toggle Featured status of a product from admin.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function feature_product() {&nbsp;</div></li><li><div>        if ( current_user_can( 'edit_products' ) && check_admin_referer( 'woocommerce-feature-product' ) ) {&nbsp;</div></li><li><div>            $product = wc_get_product( absint( $_GET['product_id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product ) {&nbsp;</div></li><li><div>                $product-&gt;set_featured( ! $product-&gt;get_featured() );&nbsp;</div></li><li><div>                $product-&gt;save();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_safe_redirect( wp_get_referer() ? remove_query_arg( array( 'trashed', 'untrashed', 'deleted', 'ids' ), wp_get_referer() ) : admin_url( 'edit.php?post_type=product' ) );&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Mark an order with a status.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function mark_order_status() {&nbsp;</div></li><li><div>        if ( current_user_can( 'edit_shop_orders' ) && check_admin_referer( 'woocommerce-mark-order-status' ) ) {&nbsp;</div></li><li><div>            $status = sanitize_text_field( $_GET['status'] );&nbsp;</div></li><li><div>            $order = wc_get_order( absint( $_GET['order_id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( wc_is_order_status( 'wc-' . $status ) && $order ) {&nbsp;</div></li><li><div>                $order-&gt;update_status( $status, '', true );&nbsp;</div></li><li><div>                do_action( 'woocommerce_order_edit_status', $order-&gt;get_id(), $status );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_safe_redirect( wp_get_referer() ? wp_get_referer() : admin_url( 'edit.php?post_type=shop_order' ) );&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add an attribute row.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_attribute() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'add-attribute', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $i = absint( $_POST['i'] );&nbsp;</div></li><li><div>        $metabox_class = array();&nbsp;</div></li><li><div>        $attribute = new WC_Product_Attribute();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attribute-&gt;set_id( wc_attribute_taxonomy_id_by_name( sanitize_text_field( $_POST['taxonomy'] ) ) );&nbsp;</div></li><li><div>        $attribute-&gt;set_name( sanitize_text_field( $_POST['taxonomy'] ) );&nbsp;</div></li><li><div>        $attribute-&gt;set_visible( apply_filters( 'woocommerce_attribute_default_visibility', 1 ) );&nbsp;</div></li><li><div>        $attribute-&gt;set_variation( apply_filters( 'woocommerce_attribute_default_is_variation', 0 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $attribute-&gt;is_taxonomy() ) {&nbsp;</div></li><li><div>            $metabox_class[] = 'taxonomy';&nbsp;</div></li><li><div>            $metabox_class[] = $attribute-&gt;get_name();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        include( 'admin/meta-boxes/views/html-product-attribute.php' );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add a new attribute via ajax function.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_new_attribute() {&nbsp;</div></li><li><div>        check_ajax_referer( 'add-attribute', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( current_user_can( 'manage_product_terms' ) ) {&nbsp;</div></li><li><div>            $taxonomy = esc_attr( $_POST['taxonomy'] );&nbsp;</div></li><li><div>            $term = wc_clean( $_POST['term'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( taxonomy_exists( $taxonomy ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $result = wp_insert_term( $term, $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    wp_send_json( array(&nbsp;</div></li><li><div>                        'error' =&gt; $result-&gt;get_error_message(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $term = get_term_by( 'id', $result['term_id'], $taxonomy );&nbsp;</div></li><li><div>                    wp_send_json( array(&nbsp;</div></li><li><div>                        'term_id' =&gt; $term-&gt;term_id, &nbsp;</div></li><li><div>                        'name' =&gt; $term-&gt;name, &nbsp;</div></li><li><div>                        'slug' =&gt; $term-&gt;slug, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die( -1 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete variations via ajax function.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function remove_variations() {&nbsp;</div></li><li><div>        check_ajax_referer( 'delete-variations', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( current_user_can( 'edit_products' ) ) {&nbsp;</div></li><li><div>            $variation_ids = (array) $_POST['variation_ids'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $variation_ids as $variation_id ) {&nbsp;</div></li><li><div>                if ( 'product_variation' === get_post_type( $variation_id ) ) {&nbsp;</div></li><li><div>                    $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>                    $variation-&gt;delete( true );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die( -1 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save attributes via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function save_attributes() {&nbsp;</div></li><li><div>        check_ajax_referer( 'save-attributes', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        parse_str( $_POST['data'], $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $attributes = WC_Meta_Box_Product_Data::prepare_attributes( $data );&nbsp;</div></li><li><div>        $product_id = absint( $_POST['post_id'] );&nbsp;</div></li><li><div>        $product_type = ! empty( $_POST['product_type'] ) ? wc_clean( $_POST['product_type'] ) : 'simple';&nbsp;</div></li><li><div>        $classname = WC_Product_Factory::get_product_classname( $product_id, $product_type );&nbsp;</div></li><li><div>        $product = new $classname( $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product-&gt;set_attributes( $attributes );&nbsp;</div></li><li><div>        $product-&gt;save();&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add variation via ajax function.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_variation() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'add-variation', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $post; // Set $post global so its available, like within the admin screens&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_id = intval( $_POST['post_id'] );&nbsp;</div></li><li><div>        $post = get_post( $product_id );&nbsp;</div></li><li><div>        $loop = intval( $_POST['loop'] );&nbsp;</div></li><li><div>        $product_object = wc_get_product( $product_id );&nbsp;</div></li><li><div>        $variation_object = new WC_Product_Variation();&nbsp;</div></li><li><div>        $variation_object-&gt;set_parent_id( $product_id );&nbsp;</div></li><li><div>        $variation_id = $variation_object-&gt;save();&nbsp;</div></li><li><div>        $variation = get_post( $variation_id );&nbsp;</div></li><li><div>        $variation_data = array_merge( array_map( 'maybe_unserialize', get_post_custom( $variation_id ) ), wc_get_product_variation_attributes( $variation_id ) ); // kept for BW compat.&nbsp;</div></li><li><div>        include( 'admin/meta-boxes/views/html-variation-admin.php' );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Link all variations via ajax function.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function link_all_variations() {&nbsp;</div></li><li><div>        check_ajax_referer( 'link-variations', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_maybe_define_constant( 'WC_MAX_LINKED_VARIATIONS', 49 );&nbsp;</div></li><li><div>        wc_set_time_limit( 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_id = intval( $_POST['post_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $post_id ) {&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $variations = array();&nbsp;</div></li><li><div>        $product = wc_get_product( $post_id );&nbsp;</div></li><li><div>        $attributes = wc_list_pluck( array_filter( $product-&gt;get_attributes(), 'wc_attributes_array_filter_variation' ), 'get_slugs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $attributes ) ) {&nbsp;</div></li><li><div>            // Get existing variations so we don't create duplicates.&nbsp;</div></li><li><div>            $existing_variations = array_map( 'wc_get_product', $product-&gt;get_children() );&nbsp;</div></li><li><div>            $existing_attributes = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $existing_variations as $existing_variation ) {&nbsp;</div></li><li><div>                $existing_attributes[] = $existing_variation-&gt;get_attributes();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $added = 0;&nbsp;</div></li><li><div>            $possible_attributes = wc_array_cartesian( $attributes );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $possible_attributes as $possible_attribute ) {&nbsp;</div></li><li><div>                if ( in_array( $possible_attribute, $existing_attributes ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $variation = new WC_Product_Variation();&nbsp;</div></li><li><div>                $variation-&gt;set_parent_id( $post_id );&nbsp;</div></li><li><div>                $variation-&gt;set_attributes( $possible_attribute );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                do_action( 'product_variation_linked', $variation-&gt;save() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ( $added ++ ) &gt; WC_MAX_LINKED_VARIATIONS ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo $added;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data_store = $product-&gt;get_data_store();&nbsp;</div></li><li><div>        $data_store-&gt;sort_all_product_variations( $product-&gt;get_id() );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete download permissions via ajax function.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function revoke_access_to_download() {&nbsp;</div></li><li><div>        check_ajax_referer( 'revoke-access', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $download_id = $_POST['download_id'];&nbsp;</div></li><li><div>        $product_id = intval( $_POST['product_id'] );&nbsp;</div></li><li><div>        $order_id = intval( $_POST['order_id'] );&nbsp;</div></li><li><div>        $permission_id = absint( $_POST['permission_id'] );&nbsp;</div></li><li><div>        $data_store = WC_Data_Store::load( 'customer-download' );&nbsp;</div></li><li><div>        $data_store-&gt;delete_by_id( $permission_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_ajax_revoke_access_to_product_download', $download_id, $product_id, $order_id, $permission_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Grant download permissions via ajax function.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function grant_access_to_download() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'grant-access', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;hide_errors();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_id = intval( $_POST['order_id'] );&nbsp;</div></li><li><div>        $product_ids = $_POST['product_ids'];&nbsp;</div></li><li><div>        $loop = intval( $_POST['loop'] );&nbsp;</div></li><li><div>        $file_counter = 0;&nbsp;</div></li><li><div>        $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $product_ids ) ) {&nbsp;</div></li><li><div>            $product_ids = array( $product_ids );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product_ids as $product_id ) {&nbsp;</div></li><li><div>            $product = wc_get_product( $product_id );&nbsp;</div></li><li><div>            $files = $product-&gt;get_downloads();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $order-&gt;get_billing_email() ) {&nbsp;</div></li><li><div>                wp_die();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $files ) ) {&nbsp;</div></li><li><div>                foreach ( $files as $download_id =&gt; $file ) {&nbsp;</div></li><li><div>                    if ( $inserted_id = wc_downloadable_file_permission( $download_id, $product_id, $order ) ) {&nbsp;</div></li><li><div>                        $download = new WC_Customer_Download( $inserted_id );&nbsp;</div></li><li><div>                        $loop ++;&nbsp;</div></li><li><div>                        $file_counter ++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $file-&gt;get_name() ) {&nbsp;</div></li><li><div>                            $file_count = $file-&gt;get_name();&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $file_count = sprintf( __( 'File %d', 'woocommerce' ), $file_counter );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        include( 'admin/meta-boxes/views/html-order-download-permission.php' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get customer details via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_customer_details() {&nbsp;</div></li><li><div>        check_ajax_referer( 'get-customer-details', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_id = absint( $_POST['user_id'] );&nbsp;</div></li><li><div>        $customer = new WC_Customer( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( has_filter( 'woocommerce_found_customer_details' ) ) {&nbsp;</div></li><li><div>            wc_deprecated_function( 'The woocommerce_found_customer_details filter', '3.0', 'woocommerce_ajax_get_customer_details' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = $customer-&gt;get_data();&nbsp;</div></li><li><div>        $data['date_created'] = $data['date_created'] ? $data['date_created']-&gt;getTimestamp() : null;&nbsp;</div></li><li><div>        $data['date_modified'] = $data['date_modified'] ? $data['date_modified']-&gt;getTimestamp() : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $customer_data = apply_filters( 'woocommerce_ajax_get_customer_details', $data, $customer, $user_id );&nbsp;</div></li><li><div>        wp_send_json( $customer_data );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add order item via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_order_item() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $items_to_add = wp_parse_id_list( is_array( $_POST['item_to_add'] ) ? $_POST['item_to_add'] : array( $_POST['item_to_add'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $order ) {&nbsp;</div></li><li><div>                throw new Exception( __( 'Invalid order', 'woocommerce' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $items_to_add as $item_to_add ) {&nbsp;</div></li><li><div>                if ( ! in_array( get_post_type( $item_to_add ), array( 'product', 'product_variation' ) ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $item_id = $order-&gt;add_product( wc_get_product( $item_to_add ) );&nbsp;</div></li><li><div>                $item = apply_filters( 'woocommerce_ajax_order_item', $order-&gt;get_item( $item_id ), $item_id );&nbsp;</div></li><li><div>                $order_taxes = $order-&gt;get_taxes();&nbsp;</div></li><li><div>                $class = 'new_row';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                do_action( 'woocommerce_ajax_add_order_item_meta', $item_id, $item );&nbsp;</div></li><li><div>                include( 'admin/meta-boxes/views/html-order-item.php' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success( array(&nbsp;</div></li><li><div>                'html' =&gt; ob_get_clean(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            wp_send_json_error( array( 'error' =&gt; $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add order fee via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_order_fee() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $order_taxes = $order-&gt;get_taxes();&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Fee();&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order_id );&nbsp;</div></li><li><div>            $item_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>            include( 'admin/meta-boxes/views/html-order-fee.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success( array(&nbsp;</div></li><li><div>                'html' =&gt; ob_get_clean(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            wp_send_json_error( array( 'error' =&gt; $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add order shipping cost via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_order_shipping() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $order_taxes = $order-&gt;get_taxes();&nbsp;</div></li><li><div>            $shipping_methods = WC()-&gt;shipping() ? WC()-&gt;shipping-&gt;load_shipping_methods() : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add new shipping&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Shipping();&nbsp;</div></li><li><div>            $item-&gt;set_shipping_rate( new WC_Shipping_Rate() );&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order_id );&nbsp;</div></li><li><div>            $item_id = $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>            include( 'admin/meta-boxes/views/html-order-shipping.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success( array(&nbsp;</div></li><li><div>                'html' =&gt; ob_get_clean(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            wp_send_json_error( array( 'error' =&gt; $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add order tax column via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_order_tax() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>            $rate_id = absint( $_POST['rate_id'] );&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $data = get_post_meta( $order_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Add new tax&nbsp;</div></li><li><div>            $item = new WC_Order_Item_Tax();&nbsp;</div></li><li><div>            $item-&gt;set_rate( $rate_id );&nbsp;</div></li><li><div>            $item-&gt;set_order_id( $order_id );&nbsp;</div></li><li><div>            $item-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ob_start();&nbsp;</div></li><li><div>            include( 'admin/meta-boxes/views/html-order-items.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success( array(&nbsp;</div></li><li><div>                'html' =&gt; ob_get_clean(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            wp_send_json_error( array( 'error' =&gt; $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Remove an order item.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function remove_order_item() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_item_ids = $_POST['order_item_ids'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $order_item_ids ) && is_numeric( $order_item_ids ) ) {&nbsp;</div></li><li><div>            $order_item_ids = array( $order_item_ids );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( sizeof( $order_item_ids ) &gt; 0 ) {&nbsp;</div></li><li><div>            foreach ( $order_item_ids as $id ) {&nbsp;</div></li><li><div>                wc_delete_order_item( absint( $id ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Remove an order tax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function remove_order_tax() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>        $rate_id = absint( $_POST['rate_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_delete_order_item( $rate_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return HTML items&nbsp;</div></li><li><div>        $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>        include( 'admin/meta-boxes/views/html-order-items.php' );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Reduce order item stock.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function reduce_order_item_stock() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>        $order_item_ids = isset( $_POST['order_item_ids'] ) ? $_POST['order_item_ids'] : array();&nbsp;</div></li><li><div>        $order_item_qty = isset( $_POST['order_item_qty'] ) ? $_POST['order_item_qty'] : array();&nbsp;</div></li><li><div>        $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>        $order_items = $order-&gt;get_items();&nbsp;</div></li><li><div>        $return = array();&nbsp;</div></li><li><div>        if ( $order && ! empty( $order_items ) && sizeof( $order_item_ids ) &gt; 0 ) {&nbsp;</div></li><li><div>            foreach ( $order_items as $item_id =&gt; $order_item ) {&nbsp;</div></li><li><div>                // Only reduce checked items&nbsp;</div></li><li><div>                if ( ! in_array( $item_id, $order_item_ids ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $_product = $order_item-&gt;get_product();&nbsp;</div></li><li><div>                if ( $_product && $_product-&gt;exists() && $_product-&gt;managing_stock() && isset( $order_item_qty[ $item_id ] ) && $order_item_qty[ $item_id ] &gt; 0 ) {&nbsp;</div></li><li><div>                    $stock_change = apply_filters( 'woocommerce_reduce_order_stock_quantity', $order_item_qty[ $item_id ], $item_id );&nbsp;</div></li><li><div>                    $new_stock = wc_update_product_stock( $_product, $stock_change, 'decrease' );&nbsp;</div></li><li><div>                    $item_name = $_product-&gt;get_sku() ? $_product-&gt;get_sku() : $_product-&gt;get_id();&nbsp;</div></li><li><div>                    $note = sprintf( __( 'Item %1$s stock reduced from %2$s to %3$s.', 'woocommerce' ), $item_name, $new_stock + $stock_change, $new_stock );&nbsp;</div></li><li><div>                    $return[] = $note;&nbsp;</div></li><li><div>                    $order-&gt;add_order_note( $note );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            do_action( 'woocommerce_reduce_order_stock', $order );&nbsp;</div></li><li><div>            if ( empty( $return ) ) {&nbsp;</div></li><li><div>                $return[] = __( 'No products had their stock reduced - they may not have stock management enabled.', 'woocommerce' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            echo wp_kses_post( implode( ', ', $return ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Increase order item stock.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function increase_order_item_stock() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>        $order_item_ids = isset( $_POST['order_item_ids'] ) ? $_POST['order_item_ids'] : array();&nbsp;</div></li><li><div>        $order_item_qty = isset( $_POST['order_item_qty'] ) ? $_POST['order_item_qty'] : array();&nbsp;</div></li><li><div>        $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>        $order_items = $order-&gt;get_items();&nbsp;</div></li><li><div>        $return = array();&nbsp;</div></li><li><div>        if ( $order && ! empty( $order_items ) && sizeof( $order_item_ids ) &gt; 0 ) {&nbsp;</div></li><li><div>            foreach ( $order_items as $item_id =&gt; $order_item ) {&nbsp;</div></li><li><div>                // Only reduce checked items&nbsp;</div></li><li><div>                if ( ! in_array( $item_id, $order_item_ids ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $_product = $order_item-&gt;get_product();&nbsp;</div></li><li><div>                if ( $_product && $_product-&gt;exists() && $_product-&gt;managing_stock() && isset( $order_item_qty[ $item_id ] ) && $order_item_qty[ $item_id ] &gt; 0 ) {&nbsp;</div></li><li><div>                    $old_stock = $_product-&gt;get_stock_quantity();&nbsp;</div></li><li><div>                    $stock_change = apply_filters( 'woocommerce_restore_order_stock_quantity', $order_item_qty[ $item_id ], $item_id );&nbsp;</div></li><li><div>                    $new_quantity = wc_update_product_stock( $_product, $stock_change, 'increase' );&nbsp;</div></li><li><div>                    $item_name = $_product-&gt;get_sku() ? $_product-&gt;get_sku() : $_product-&gt;get_id();&nbsp;</div></li><li><div>                    $note = sprintf( __( 'Item %1$s stock increased from %2$s to %3$s.', 'woocommerce' ), $item_name, $old_stock, $new_quantity );&nbsp;</div></li><li><div>                    $return[] = $note;&nbsp;</div></li><li><div>                    $order-&gt;add_order_note( $note );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            do_action( 'woocommerce_restore_order_stock', $order );&nbsp;</div></li><li><div>            if ( empty( $return ) ) {&nbsp;</div></li><li><div>                $return[] = __( 'No products had their stock increased - they may not have stock management enabled.', 'woocommerce' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            echo wp_kses_post( implode( ', ', $return ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Calc line tax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function calc_line_taxes() {&nbsp;</div></li><li><div>        check_ajax_referer( 'calc-totals', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>        $calculate_tax_args = array(&nbsp;</div></li><li><div>            'country' =&gt; strtoupper( wc_clean( $_POST['country'] ) ), &nbsp;</div></li><li><div>            'state' =&gt; strtoupper( wc_clean( $_POST['state'] ) ), &nbsp;</div></li><li><div>            'postcode' =&gt; strtoupper( wc_clean( $_POST['postcode'] ) ), &nbsp;</div></li><li><div>            'city' =&gt; strtoupper( wc_clean( $_POST['city'] ) ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Parse the jQuery serialized items&nbsp;</div></li><li><div>        $items = array();&nbsp;</div></li><li><div>        parse_str( $_POST['items'], $items );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save order items first&nbsp;</div></li><li><div>        wc_save_order_items( $order_id, $items );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Grab the order and recalc taxes&nbsp;</div></li><li><div>        $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>        $order-&gt;calculate_taxes( $calculate_tax_args );&nbsp;</div></li><li><div>        $order-&gt;calculate_totals( false );&nbsp;</div></li><li><div>        include( 'admin/meta-boxes/views/html-order-items.php' );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save order items via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function save_order_items() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_POST['order_id'], $_POST['items'] ) ) {&nbsp;</div></li><li><div>            $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Parse the jQuery serialized items&nbsp;</div></li><li><div>            $items = array();&nbsp;</div></li><li><div>            parse_str( $_POST['items'], $items );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Save order items&nbsp;</div></li><li><div>            wc_save_order_items( $order_id, $items );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Return HTML items&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            include( 'admin/meta-boxes/views/html-order-items.php' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load order items via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_order_items() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Return HTML items&nbsp;</div></li><li><div>        $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>        $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>        include( 'admin/meta-boxes/views/html-order-items.php' );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add order note via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function add_order_note() {&nbsp;</div></li><li><div>        check_ajax_referer( 'add-order-note', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_id = absint( $_POST['post_id'] );&nbsp;</div></li><li><div>        $note = wp_kses_post( trim( stripslashes( $_POST['note'] ) ) );&nbsp;</div></li><li><div>        $note_type = $_POST['note_type'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_customer_note = ( 'customer' === $note_type ) ? 1 : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $post_id &gt; 0 ) {&nbsp;</div></li><li><div>            $order = wc_get_order( $post_id );&nbsp;</div></li><li><div>            $comment_id = $order-&gt;add_order_note( $note, $is_customer_note, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;li rel=&quot;' . esc_attr( $comment_id ) . '&quot; class=&quot;note ';&nbsp;</div></li><li><div>            if ( $is_customer_note ) {&nbsp;</div></li><li><div>                echo 'customer-note';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            echo '&quot;&gt;&lt;div class=&quot;note_content&quot;&gt;';&nbsp;</div></li><li><div>            echo wpautop( wptexturize( $note ) );&nbsp;</div></li><li><div>            echo '&lt;/div&gt;&lt;p class=&quot;meta&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;delete_note&quot;&gt;' . __( 'Delete note', 'woocommerce' ) . '&lt;/a&gt;&lt;/p&gt;';&nbsp;</div></li><li><div>            echo '&lt;/li&gt;';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete order note via ajax.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function delete_order_note() {&nbsp;</div></li><li><div>        check_ajax_referer( 'delete-order-note', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $note_id = (int) $_POST['note_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $note_id &gt; 0 ) {&nbsp;</div></li><li><div>            wp_delete_comment( $note_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Search for products and echo json.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $term (default: '')&nbsp;</div></li><li><div>     * @param bool $include_variations in search or not&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function json_search_products( $term = '', $include_variations = false ) {&nbsp;</div></li><li><div>        check_ajax_referer( 'search-products', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $term = wc_clean( empty( $term ) ? stripslashes( $_GET['term'] ) : $term );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $term ) ) {&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data_store = WC_Data_Store::load( 'product' );&nbsp;</div></li><li><div>        $ids = $data_store-&gt;search_products( $term, '', (bool) $include_variations );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['exclude'] ) ) {&nbsp;</div></li><li><div>            $ids = array_diff( $ids, (array) $_GET['exclude'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['include'] ) ) {&nbsp;</div></li><li><div>            $ids = array_intersect( $ids, (array) $_GET['include'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['limit'] ) ) {&nbsp;</div></li><li><div>            $ids = array_slice( $ids, 0, absint( $_GET['limit'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_objects = array_filter( array_map( 'wc_get_product', $ids ), 'wc_products_array_filter_editable' );&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product_objects as $product_object ) {&nbsp;</div></li><li><div>            $products[ $product_object-&gt;get_id() ] = rawurldecode( $product_object-&gt;get_formatted_name() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json( apply_filters( 'woocommerce_json_search_found_products', $products ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Search for product variations and return json.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see WC_AJAX::json_search_products()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function json_search_products_and_variations() {&nbsp;</div></li><li><div>        self::json_search_products( '', true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Search for downloadable product variations and return json.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @see WC_AJAX::json_search_products()&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function json_search_downloadable_products_and_variations() {&nbsp;</div></li><li><div>        check_ajax_referer( 'search-products', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $term = (string) wc_clean( stripslashes( $_GET['term'] ) );&nbsp;</div></li><li><div>        $data_store = WC_Data_Store::load( 'product' );&nbsp;</div></li><li><div>        $ids = $data_store-&gt;search_products( $term, 'downloadable', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['exclude'] ) ) {&nbsp;</div></li><li><div>            $ids = array_diff( $ids, (array) $_GET['exclude'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['include'] ) ) {&nbsp;</div></li><li><div>            $ids = array_intersect( $ids, (array) $_GET['include'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['limit'] ) ) {&nbsp;</div></li><li><div>            $ids = array_slice( $ids, 0, absint( $_GET['limit'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_objects = array_filter( array_map( 'wc_get_product', $ids ), 'wc_products_array_filter_editable' );&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product_objects as $product_object ) {&nbsp;</div></li><li><div>            $products[ $product_object-&gt;get_id() ] = rawurldecode( $product_object-&gt;get_formatted_name() );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json( $products );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Search for customers and return json.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function json_search_customers() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'search-customers', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $term = wc_clean( stripslashes( $_GET['term'] ) );&nbsp;</div></li><li><div>        $exclude = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $term ) ) {&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Stop if it is not numeric and smaller than 3 characters.&nbsp;</div></li><li><div>        if ( ! is_numeric( $term ) && 2 &gt;= strlen( $term ) ) {&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Search by ID.&nbsp;</div></li><li><div>        if ( is_numeric( $term ) ) {&nbsp;</div></li><li><div>            $customer = new WC_Customer( intval( $term ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Customer does not exists.&nbsp;</div></li><li><div>            if ( 0 === $customer-&gt;get_id() ) {&nbsp;</div></li><li><div>                wp_die();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $ids = array( $customer-&gt;get_id() );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $data_store = WC_Data_Store::load( 'customer' );&nbsp;</div></li><li><div>            $ids = $data_store-&gt;search_customers( $term );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $found_customers = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $_GET['exclude'] ) ) {&nbsp;</div></li><li><div>            $ids = array_diff( $ids, (array) $_GET['exclude'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $ids as $id ) {&nbsp;</div></li><li><div>            $customer = new WC_Customer( $id );&nbsp;</div></li><li><div>            /** translators: 1: user display name 2: user ID 3: user email */&nbsp;</div></li><li><div>            $found_customers[ $id ] = sprintf(&nbsp;</div></li><li><div>                esc_html__( '%1$s (#%2$s &ndash; %3$s)', 'woocommerce' ), &nbsp;</div></li><li><div>                $customer-&gt;get_first_name() . ' ' . $customer-&gt;get_last_name(), &nbsp;</div></li><li><div>                $customer-&gt;get_id(), &nbsp;</div></li><li><div>                $customer-&gt;get_email()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json( apply_filters( 'woocommerce_json_search_found_customers', $found_customers ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ajax request handling for categories ordering.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function term_ordering() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check permissions again and make sure we have what we need&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) || empty( $_POST['id'] ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = (int) $_POST['id'];&nbsp;</div></li><li><div>        $next_id = isset( $_POST['nextid'] ) && (int) $_POST['nextid'] ? (int) $_POST['nextid'] : null;&nbsp;</div></li><li><div>        $taxonomy = isset( $_POST['thetaxonomy'] ) ? esc_attr( $_POST['thetaxonomy'] ) : null;&nbsp;</div></li><li><div>        $term = get_term_by( 'id', $id, $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $id || ! $term || ! $taxonomy ) {&nbsp;</div></li><li><div>            wp_die( 0 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wc_reorder_terms( $term, $next_id, $taxonomy );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $children = get_terms( $taxonomy, &quot;child_of=$id&menu_order=ASC&hide_empty=0&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $term && sizeof( $children ) ) {&nbsp;</div></li><li><div>            echo 'children';&nbsp;</div></li><li><div>            wp_die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Ajax request handling for product ordering.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Based on Simple Page Ordering by 10up (https://wordpress.org/plugins/simple-page-ordering/).&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function product_ordering() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) || empty( $_POST['id'] ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sorting_id = absint( $_POST['id'] );&nbsp;</div></li><li><div>        $previd = absint( isset( $_POST['previd'] ) ? $_POST['previd'] : 0 );&nbsp;</div></li><li><div>        $nextid = absint( isset( $_POST['nextid'] ) ? $_POST['nextid'] : 0 );&nbsp;</div></li><li><div>        $menu_orders = wp_list_pluck( $wpdb-&gt;get_results( &quot;SELECT ID, menu_order FROM {$wpdb-&gt;posts} WHERE post_type = 'product' ORDER BY menu_order ASC, post_title ASC&quot; ), 'menu_order', 'ID' );&nbsp;</div></li><li><div>        $index = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $menu_orders as $id =&gt; $menu_order ) {&nbsp;</div></li><li><div>            $id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $sorting_id === $id ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $nextid === $id ) {&nbsp;</div></li><li><div>                $index ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $index ++;&nbsp;</div></li><li><div>            $menu_orders[ $id ] = $index;&nbsp;</div></li><li><div>            $wpdb-&gt;update( $wpdb-&gt;posts, array( 'menu_order' =&gt; $index ), array( 'ID' =&gt; $id ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $menu_orders[ $previd ] ) ) {&nbsp;</div></li><li><div>            $menu_orders[ $sorting_id ] = $menu_orders[ $previd ] + 1;&nbsp;</div></li><li><div>        } elseif ( isset( $menu_orders[ $nextid ] ) ) {&nbsp;</div></li><li><div>            $menu_orders[ $sorting_id ] = $menu_orders[ $nextid ] - 1;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $menu_orders[ $sorting_id ] = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;update( $wpdb-&gt;posts, array( 'menu_order' =&gt; $menu_orders[ $sorting_id ] ), array( 'ID' =&gt; $sorting_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_after_product_ordering' );&nbsp;</div></li><li><div>        wp_send_json( $menu_orders );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle a refund via the edit order screen.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function refund_line_items() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_id = absint( $_POST['order_id'] );&nbsp;</div></li><li><div>        $refund_amount = wc_format_decimal( sanitize_text_field( $_POST['refund_amount'] ), wc_get_price_decimals() );&nbsp;</div></li><li><div>        $refund_reason = sanitize_text_field( $_POST['refund_reason'] );&nbsp;</div></li><li><div>        $line_item_qtys = json_decode( sanitize_text_field( stripslashes( $_POST['line_item_qtys'] ) ), true );&nbsp;</div></li><li><div>        $line_item_totals = json_decode( sanitize_text_field( stripslashes( $_POST['line_item_totals'] ) ), true );&nbsp;</div></li><li><div>        $line_item_tax_totals = json_decode( sanitize_text_field( stripslashes( $_POST['line_item_tax_totals'] ) ), true );&nbsp;</div></li><li><div>        $api_refund = 'true' === $_POST['api_refund'];&nbsp;</div></li><li><div>        $restock_refunded_items = 'true' === $_POST['restock_refunded_items'];&nbsp;</div></li><li><div>        $refund = false;&nbsp;</div></li><li><div>        $response_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            $order = wc_get_order( $order_id );&nbsp;</div></li><li><div>            $order_items = $order-&gt;get_items();&nbsp;</div></li><li><div>            $max_refund = wc_format_decimal( $order-&gt;get_total() - $order-&gt;get_total_refunded(), wc_get_price_decimals() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! $refund_amount || $max_refund &lt; $refund_amount || 0 &gt; $refund_amount ) {&nbsp;</div></li><li><div>                throw new exception( __( 'Invalid refund amount', 'woocommerce' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Prepare line items which we are refunding&nbsp;</div></li><li><div>            $line_items = array();&nbsp;</div></li><li><div>            $item_ids = array_unique( array_merge( array_keys( $line_item_qtys, $line_item_totals ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $item_ids as $item_id ) {&nbsp;</div></li><li><div>                $line_items[ $item_id ] = array( 'qty' =&gt; 0, 'refund_total' =&gt; 0, 'refund_tax' =&gt; array() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( $line_item_qtys as $item_id =&gt; $qty ) {&nbsp;</div></li><li><div>                $line_items[ $item_id ]['qty'] = max( $qty, 0 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( $line_item_totals as $item_id =&gt; $total ) {&nbsp;</div></li><li><div>                $line_items[ $item_id ]['refund_total'] = wc_format_decimal( $total );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            foreach ( $line_item_tax_totals as $item_id =&gt; $tax_totals ) {&nbsp;</div></li><li><div>                $line_items[ $item_id ]['refund_tax'] = array_filter( array_map( 'wc_format_decimal', $tax_totals ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Create the refund object.&nbsp;</div></li><li><div>            $refund = wc_create_refund( array(&nbsp;</div></li><li><div>                'amount' =&gt; $refund_amount, &nbsp;</div></li><li><div>                'reason' =&gt; $refund_reason, &nbsp;</div></li><li><div>                'order_id' =&gt; $order_id, &nbsp;</div></li><li><div>                'line_items' =&gt; $line_items, &nbsp;</div></li><li><div>                'refund_payment' =&gt; $api_refund, &nbsp;</div></li><li><div>                'restock_items' =&gt; $restock_refunded_items, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $refund ) ) {&nbsp;</div></li><li><div>                throw new Exception( $refund-&gt;get_error_message() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( did_action( 'woocommerce_order_fully_refunded' ) ) {&nbsp;</div></li><li><div>                $response_data['status'] = 'fully_refunded';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success( $response_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            if ( $refund && is_a( $refund, 'WC_Order_Refund' ) ) {&nbsp;</div></li><li><div>                wp_delete_post( $refund-&gt;get_id(), true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            wp_send_json_error( array( 'error' =&gt; $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Delete a refund.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function delete_refund() {&nbsp;</div></li><li><div>        check_ajax_referer( 'order-item', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_shop_orders' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $refund_ids = array_map( 'absint', is_array( $_POST['refund_id'] ) ? $_POST['refund_id'] : array( $_POST['refund_id'] ) );&nbsp;</div></li><li><div>        foreach ( $refund_ids as $refund_id ) {&nbsp;</div></li><li><div>            if ( $refund_id && 'shop_order_refund' === get_post_type( $refund_id ) ) {&nbsp;</div></li><li><div>                $refund = wc_get_order( $refund_id );&nbsp;</div></li><li><div>                $order_id = $refund-&gt;get_parent_id();&nbsp;</div></li><li><div>                $refund-&gt;delete( true );&nbsp;</div></li><li><div>                do_action( 'woocommerce_refund_deleted', $refund_id, $order_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Triggered when clicking the rating footer.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function rated() {&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        update_option( 'woocommerce_admin_footer_text_rated', 1 );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Create/Update API key.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_api_key() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'update-api-key', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        try {&nbsp;</div></li><li><div>            if ( empty( $_POST['description'] ) ) {&nbsp;</div></li><li><div>                throw new Exception( __( 'Description is missing.', 'woocommerce' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( empty( $_POST['user'] ) ) {&nbsp;</div></li><li><div>                throw new Exception( __( 'User is missing.', 'woocommerce' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( empty( $_POST['permissions'] ) ) {&nbsp;</div></li><li><div>                throw new Exception( __( 'Permissions is missing.', 'woocommerce' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $key_id = absint( $_POST['key_id'] );&nbsp;</div></li><li><div>            $description = sanitize_text_field( wp_unslash( $_POST['description'] ) );&nbsp;</div></li><li><div>            $permissions = ( in_array( $_POST['permissions'], array( 'read', 'write', 'read_write' ) ) ) ? sanitize_text_field( $_POST['permissions'] ) : 'read';&nbsp;</div></li><li><div>            $user_id = absint( $_POST['user'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 0 &lt; $key_id ) {&nbsp;</div></li><li><div>                $data = array(&nbsp;</div></li><li><div>                    'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>                    'description' =&gt; $description, &nbsp;</div></li><li><div>                    'permissions' =&gt; $permissions, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $wpdb-&gt;update(&nbsp;</div></li><li><div>                    $wpdb-&gt;prefix . 'woocommerce_api_keys', &nbsp;</div></li><li><div>                    $data, &nbsp;</div></li><li><div>                    array( 'key_id' =&gt; $key_id ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        '%d', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array( '%d' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data['consumer_key'] = '';&nbsp;</div></li><li><div>                $data['consumer_secret'] = '';&nbsp;</div></li><li><div>                $data['message'] = __( 'API Key updated successfully.', 'woocommerce' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $consumer_key = 'ck_' . wc_rand_hash();&nbsp;</div></li><li><div>                $consumer_secret = 'cs_' . wc_rand_hash();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = array(&nbsp;</div></li><li><div>                    'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>                    'description' =&gt; $description, &nbsp;</div></li><li><div>                    'permissions' =&gt; $permissions, &nbsp;</div></li><li><div>                    'consumer_key' =&gt; wc_api_hash( $consumer_key ), &nbsp;</div></li><li><div>                    'consumer_secret' =&gt; $consumer_secret, &nbsp;</div></li><li><div>                    'truncated_key' =&gt; substr( $consumer_key, -7 ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $wpdb-&gt;insert(&nbsp;</div></li><li><div>                    $wpdb-&gt;prefix . 'woocommerce_api_keys', &nbsp;</div></li><li><div>                    $data, &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        '%d', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div>                        '%s', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $key_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>                $data['consumer_key'] = $consumer_key;&nbsp;</div></li><li><div>                $data['consumer_secret'] = $consumer_secret;&nbsp;</div></li><li><div>                $data['message'] = __( 'API Key generated successfully. Make sure to copy your new API keys now. You won\'t be able to see it again!', 'woocommerce' );&nbsp;</div></li><li><div>                $data['revoke_url'] = '&lt;a style=&quot;color: #a00; text-decoration: none;&quot; href=&quot;' . esc_url( wp_nonce_url( add_query_arg( array( 'revoke-key' =&gt; $key_id ), admin_url( 'admin.php?page=wc-settings&tab=api&section=keys' ) ), 'revoke' ) ) . '&quot;&gt;' . __( 'Revoke key', 'woocommerce' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_send_json_success( $data );&nbsp;</div></li><li><div>        } catch ( Exception $e ) {&nbsp;</div></li><li><div>            wp_send_json_error( array( 'message' =&gt; $e-&gt;getMessage() ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Load variations via AJAX.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_variations() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'load-variations', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) || empty( $_POST['product_id'] ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set $post global so its available, like within the admin screens&nbsp;</div></li><li><div>        global $post;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $loop = 0;&nbsp;</div></li><li><div>        $product_id = absint( $_POST['product_id'] );&nbsp;</div></li><li><div>        $post = get_post( $product_id );&nbsp;</div></li><li><div>        $product_object = wc_get_product( $product_id );&nbsp;</div></li><li><div>        $per_page = ! empty( $_POST['per_page'] ) ? absint( $_POST['per_page'] ) : 10;&nbsp;</div></li><li><div>        $page = ! empty( $_POST['page'] ) ? absint( $_POST['page'] ) : 1;&nbsp;</div></li><li><div>        $variations = wc_get_products( array(&nbsp;</div></li><li><div>            'status' =&gt; array( 'private', 'publish' ), &nbsp;</div></li><li><div>            'type' =&gt; 'variation', &nbsp;</div></li><li><div>            'parent' =&gt; $product_id, &nbsp;</div></li><li><div>            'limit' =&gt; $per_page, &nbsp;</div></li><li><div>            'page' =&gt; $page, &nbsp;</div></li><li><div>            'orderby' =&gt; array(&nbsp;</div></li><li><div>                'menu_order' =&gt; 'ASC', &nbsp;</div></li><li><div>                'ID' =&gt; 'DESC', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'return' =&gt; 'objects', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $variations ) {&nbsp;</div></li><li><div>            foreach ( $variations as $variation_object ) {&nbsp;</div></li><li><div>                $variation_id = $variation_object-&gt;get_id();&nbsp;</div></li><li><div>                $variation = get_post( $variation_id );&nbsp;</div></li><li><div>                $variation_data = array_merge( array_map( 'maybe_unserialize', get_post_custom( $variation_id ) ), wc_get_product_variation_attributes( $variation_id ) ); // kept for BW compat.&nbsp;</div></li><li><div>                include( 'admin/meta-boxes/views/html-variation-admin.php' );&nbsp;</div></li><li><div>                $loop++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save variations via AJAX.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function save_variations() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'save-variations', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check permissions again and make sure we have what we need&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) || empty( $_POST ) || empty( $_POST['product_id'] ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_id = absint( $_POST['product_id'] );&nbsp;</div></li><li><div>        WC_Admin_Meta_Boxes::$meta_box_errors = array();&nbsp;</div></li><li><div>        WC_Meta_Box_Product_Data::save_variations( $product_id, get_post( $product_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_ajax_save_product_variations', $product_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $errors = WC_Admin_Meta_Boxes::$meta_box_errors ) {&nbsp;</div></li><li><div>            echo '&lt;div class=&quot;error notice is-dismissible&quot;&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $errors as $error ) {&nbsp;</div></li><li><div>                echo '&lt;p&gt;' . wp_kses_post( $error ) . '&lt;/p&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            echo '&lt;button type=&quot;button&quot; class=&quot;notice-dismiss&quot;&gt;&lt;span class=&quot;screen-reader-text&quot;&gt;' . __( 'Dismiss this notice.', 'woocommerce' ) . '&lt;/span&gt;&lt;/button&gt;';&nbsp;</div></li><li><div>            echo '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            delete_option( 'woocommerce_meta_box_errors' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Toggle Enabled.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_toggle_enabled( $variations, $data ) {&nbsp;</div></li><li><div>        foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>            $variation-&gt;set_status( 'private' === $variation-&gt;get_status( 'edit' ) ? 'publish' : 'private' );&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Toggle Downloadable Checkbox.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_toggle_downloadable( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_toggle( $variations, 'downloadable' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Toggle Virtual Checkbox.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_toggle_virtual( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_toggle( $variations, 'virtual' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Toggle Manage Stock Checkbox.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_toggle_manage_stock( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_toggle( $variations, 'manage_stock' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Regular Prices.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_regular_price( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'regular_price', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Sale Prices.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_sale_price( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'sale_price', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Stock.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_stock( $variations, $data ) {&nbsp;</div></li><li><div>        if ( ! isset( $data['value'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $quantity = wc_stock_amount( wc_clean( $data['value'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>            if ( $variation-&gt;managing_stock() ) {&nbsp;</div></li><li><div>                $variation-&gt;set_stock_quantity( $quantity );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $variation-&gt;set_stock_quantity( null );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Weight.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_weight( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'weight', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Length.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_length( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'length', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Width.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_width( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'width', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Height.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_height( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'height', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Download Limit.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_download_limit( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'download_limit', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Download Expiry.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_download_expiry( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_set( $variations, 'download_expiry', $data['value'] );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Delete all.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_delete_all( $variations, $data ) {&nbsp;</div></li><li><div>        if ( isset( $data['allowed'] ) && 'true' === $data['allowed'] ) {&nbsp;</div></li><li><div>            foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>                $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>                $variation-&gt;delete( true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Sale Schedule.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_sale_schedule( $variations, $data ) {&nbsp;</div></li><li><div>        if ( ! isset( $data['date_from'] ) && ! isset( $data['date_to'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'false' !== $data['date_from'] ) {&nbsp;</div></li><li><div>                $variation-&gt;set_date_on_sale_from( wc_clean( $data['date_from'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'false' !== $data['date_to'] ) {&nbsp;</div></li><li><div>                $variation-&gt;set_date_on_sale_to( wc_clean( $data['date_to'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Increase Regular Prices.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_regular_price_increase( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_adjust_price( $variations, 'regular_price', '+', wc_clean( $data['value'] ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Decrease Regular Prices.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_regular_price_decrease( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_adjust_price( $variations, 'regular_price', '-', wc_clean( $data['value'] ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Increase Sale Prices.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_sale_price_increase( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_adjust_price( $variations, 'sale_price', '+', wc_clean( $data['value'] ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Decrease Sale Prices.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param  array $variations&nbsp;</div></li><li><div>     * @param  array $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_action_variable_sale_price_decrease( $variations, $data ) {&nbsp;</div></li><li><div>        self::variation_bulk_adjust_price( $variations, 'sale_price', '-', wc_clean( $data['value'] ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action - Set Price.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @used-by bulk_edit_variations&nbsp;</div></li><li><div>     * @param array $variations&nbsp;</div></li><li><div>     * @param string $operator + or -&nbsp;</div></li><li><div>     * @param string $field price being adjusted _regular_price or _sale_price&nbsp;</div></li><li><div>     * @param string $value Price or Percent&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_adjust_price( $variations, $field, $operator, $value ) {&nbsp;</div></li><li><div>        foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>            $field_value = $variation-&gt;{&quot;get_$field&quot;}( 'edit' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( '%' === substr( $value, -1 ) ) {&nbsp;</div></li><li><div>                $percent = wc_format_decimal( substr( $value, 0, -1 ) );&nbsp;</div></li><li><div>                $field_value += ( ( $field_value / 100 ) * $percent ) * &quot;{$operator}1&quot;;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $field_value += $value * &quot;{$operator}1&quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $variation-&gt;{&quot;set_$field&quot;}( $field_value );&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk set convenience function.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @param array $variations&nbsp;</div></li><li><div>     * @param string $field&nbsp;</div></li><li><div>     * @param string $value&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_set( $variations, $field, $value ) {&nbsp;</div></li><li><div>        foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>            $variation-&gt;{ &quot;set_$field&quot; }( wc_clean( $value ) );&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk toggle convenience function.&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @param array $variations&nbsp;</div></li><li><div>     * @param string $field&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function variation_bulk_toggle( $variations, $field ) {&nbsp;</div></li><li><div>        foreach ( $variations as $variation_id ) {&nbsp;</div></li><li><div>            $variation = wc_get_product( $variation_id );&nbsp;</div></li><li><div>            $prev_value = $variation-&gt;{ &quot;get_$field&quot; }( 'edit' );&nbsp;</div></li><li><div>            $variation-&gt;{ &quot;set_$field&quot; }( ! $prev_value );&nbsp;</div></li><li><div>            $variation-&gt;save();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk edit variations via AJAX.&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_set()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_adjust_price()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_sale_price_decrease()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_sale_price_increase()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_regular_price_decrease()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_regular_price_increase()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_sale_schedule()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_delete_all()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_download_expiry()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_download_limit()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_height()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_width()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_length()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_weight()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_stock()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_sale_price()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_variable_regular_price()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_toggle_manage_stock()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_toggle_virtual()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_toggle_downloadable()&nbsp;</div></li><li><div>     * @uses WC_AJAX::variation_bulk_action_toggle_enabled&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function bulk_edit_variations() {&nbsp;</div></li><li><div>        ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        check_ajax_referer( 'bulk-edit-variations', 'security' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check permissions again and make sure we have what we need&nbsp;</div></li><li><div>        if ( ! current_user_can( 'edit_products' ) || empty( $_POST['product_id'] ) || empty( $_POST['bulk_action'] ) ) {&nbsp;</div></li><li><div>            wp_die( -1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_id = absint( $_POST['product_id'] );&nbsp;</div></li><li><div>        $bulk_action = wc_clean( $_POST['bulk_action'] );&nbsp;</div></li><li><div>        $data = ! empty( $_POST['data'] ) ? array_map( 'wc_clean', $_POST['data'] ) : array();&nbsp;</div></li><li><div>        $variations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( apply_filters( 'woocommerce_bulk_edit_variations_need_children', true ) ) {&nbsp;</div></li><li><div>            $variations = get_posts( array(&nbsp;</div></li><li><div>                'post_parent' =&gt; $product_id, &nbsp;</div></li><li><div>                'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>                'post_type' =&gt; 'product_variation', &nbsp;</div></li><li><div>                'fields' =&gt; 'ids', &nbsp;</div></li><li><div>                'post_status' =&gt; array( 'publish', 'private' ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( method_exists( __CLASS__, &quot;variation_bulk_action_$bulk_action&quot; ) ) {&nbsp;</div></li><li><div>            call_user_func( array( __CLASS__, &quot;variation_bulk_action_$bulk_action&quot; ), $variations, $data );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            do_action( 'woocommerce_bulk_edit_variations_default', $bulk_action, $data, $product_id, $variations );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_bulk_edit_variations', $bulk_action, $data, $product_id, $variations );&nbsp;</div></li><li><div>        WC_Product_Variable::sync( $product_id );&nbsp;</div></li><li><div>        wc_delete_product_transients( $product_id );&nbsp;</div></li><li><div>        wp_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle submissions from assets/js/settings-views-html-settings-tax.js Backbone model.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function tax_rates_save_changes() {&nbsp;</div></li><li><div>        if ( ! isset( $_POST['wc_tax_nonce'], $_POST['changes'] ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_fields' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_class = ! empty( $_POST['current_class'] ) ? $_POST['current_class'] : ''; // This is sanitized seven lines later.&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['wc_tax_nonce'], 'wc_tax_nonce-class:' . $current_class ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'bad_nonce' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_class = WC_Tax::format_tax_rate_class( $current_class );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check User Caps&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_capabilities' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $changes = $_POST['changes'];&nbsp;</div></li><li><div>        foreach ( $changes as $tax_rate_id =&gt; $data ) {&nbsp;</div></li><li><div>            if ( isset( $data['deleted'] ) ) {&nbsp;</div></li><li><div>                if ( isset( $data['newRow'] ) ) {&nbsp;</div></li><li><div>                    // So the user added and deleted a new row.&nbsp;</div></li><li><div>                    // That's fine, it's not in the database anyways. NEXT!&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                WC_Tax::_delete_tax_rate( $tax_rate_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $tax_rate = array_intersect_key( $data, array(&nbsp;</div></li><li><div>                'tax_rate_country' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate_state' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate_name' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate_priority' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate_compound' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate_shipping' =&gt; 1, &nbsp;</div></li><li><div>                'tax_rate_order' =&gt; 1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['newRow'] ) ) {&nbsp;</div></li><li><div>                // Hurrah, shiny and new!&nbsp;</div></li><li><div>                $tax_rate['tax_rate_class'] = $current_class;&nbsp;</div></li><li><div>                $tax_rate_id = WC_Tax::_insert_tax_rate( $tax_rate );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                // Updating an existing rate ...&nbsp;</div></li><li><div>                if ( ! empty( $tax_rate ) ) {&nbsp;</div></li><li><div>                    WC_Tax::_update_tax_rate( $tax_rate_id, $tax_rate );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['postcode'] ) ) {&nbsp;</div></li><li><div>                $postcode = array_map( 'wc_clean', $data['postcode'] );&nbsp;</div></li><li><div>                $postcode = array_map( 'wc_normalize_postcode', $postcode );&nbsp;</div></li><li><div>                WC_Tax::_update_tax_rate_postcodes( $tax_rate_id, $postcode );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( isset( $data['city'] ) ) {&nbsp;</div></li><li><div>                WC_Tax::_update_tax_rate_cities( $tax_rate_id, array_map( 'wc_clean', $data['city'] ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json_success( array(&nbsp;</div></li><li><div>            'rates' =&gt; WC_Tax::get_rates_for_tax_class( $current_class ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle submissions from assets/js/wc-shipping-zones.js Backbone model.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function shipping_zones_save_changes() {&nbsp;</div></li><li><div>        if ( ! isset( $_POST['wc_shipping_zones_nonce'], $_POST['changes'] ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_fields' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['wc_shipping_zones_nonce'], 'wc_shipping_zones_nonce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'bad_nonce' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check User Caps&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_capabilities' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $changes = $_POST['changes'];&nbsp;</div></li><li><div>        foreach ( $changes as $zone_id =&gt; $data ) {&nbsp;</div></li><li><div>            if ( isset( $data['deleted'] ) ) {&nbsp;</div></li><li><div>                if ( isset( $data['newRow'] ) ) {&nbsp;</div></li><li><div>                    // So the user added and deleted a new row.&nbsp;</div></li><li><div>                    // That's fine, it's not in the database anyways. NEXT!&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                WC_Shipping_Zones::delete_zone( $zone_id );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $zone_data = array_intersect_key( $data, array(&nbsp;</div></li><li><div>                'zone_id' =&gt; 1, &nbsp;</div></li><li><div>                'zone_order' =&gt; 1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $zone_data['zone_id'] ) ) {&nbsp;</div></li><li><div>                $zone = new WC_Shipping_Zone( $zone_data['zone_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $zone_data['zone_order'] ) ) {&nbsp;</div></li><li><div>                    $zone-&gt;set_zone_order( $zone_data['zone_order'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $zone-&gt;save();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json_success( array(&nbsp;</div></li><li><div>            'zones' =&gt; WC_Shipping_Zones::get_zones(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle submissions from assets/js/wc-shipping-zone-methods.js Backbone model.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function shipping_zone_add_method() {&nbsp;</div></li><li><div>        if ( ! isset( $_POST['wc_shipping_zones_nonce'], $_POST['zone_id'], $_POST['method_id'] ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_fields' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['wc_shipping_zones_nonce'], 'wc_shipping_zones_nonce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'bad_nonce' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check User Caps&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_capabilities' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $zone_id = wc_clean( $_POST['zone_id'] );&nbsp;</div></li><li><div>        $zone = new WC_Shipping_Zone( $zone_id );&nbsp;</div></li><li><div>        $instance_id = $zone-&gt;add_shipping_method( wc_clean( $_POST['method_id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json_success( array(&nbsp;</div></li><li><div>            'instance_id' =&gt; $instance_id, &nbsp;</div></li><li><div>            'zone_id' =&gt; $zone-&gt;get_id(), &nbsp;</div></li><li><div>            'zone_name' =&gt; $zone-&gt;get_zone_name(), &nbsp;</div></li><li><div>            'methods' =&gt; $zone-&gt;get_shipping_methods(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle submissions from assets/js/wc-shipping-zone-methods.js Backbone model.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function shipping_zone_methods_save_changes() {&nbsp;</div></li><li><div>        if ( ! isset( $_POST['wc_shipping_zones_nonce'], $_POST['zone_id'], $_POST['changes'] ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_fields' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['wc_shipping_zones_nonce'], 'wc_shipping_zones_nonce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'bad_nonce' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_capabilities' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $zone_id = wc_clean( $_POST['zone_id'] );&nbsp;</div></li><li><div>        $zone = new WC_Shipping_Zone( $zone_id );&nbsp;</div></li><li><div>        $changes = $_POST['changes'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $changes['zone_name'] ) ) {&nbsp;</div></li><li><div>            $zone-&gt;set_zone_name( wc_clean( $changes['zone_name'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $changes['zone_locations'] ) ) {&nbsp;</div></li><li><div>            $zone-&gt;clear_locations( array( 'state', 'country', 'continent' ) );&nbsp;</div></li><li><div>            $locations = array_filter( array_map( 'wc_clean', (array) $changes['zone_locations'] ) );&nbsp;</div></li><li><div>            foreach ( $locations as $location ) {&nbsp;</div></li><li><div>                // Each posted location will be in the format type:code&nbsp;</div></li><li><div>                $location_parts = explode( ':', $location );&nbsp;</div></li><li><div>                switch ( $location_parts[0] ) {&nbsp;</div></li><li><div>                    case 'state' :&nbsp;</div></li><li><div>                        $zone-&gt;add_location( $location_parts[1] . ':' . $location_parts[2], 'state' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    case 'country' :&nbsp;</div></li><li><div>                        $zone-&gt;add_location( $location_parts[1], 'country' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    case 'continent' :&nbsp;</div></li><li><div>                        $zone-&gt;add_location( $location_parts[1], 'continent' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $changes['zone_postcodes'] ) ) {&nbsp;</div></li><li><div>            $zone-&gt;clear_locations( 'postcode' );&nbsp;</div></li><li><div>            $postcodes = array_filter( array_map( 'strtoupper', array_map( 'wc_clean', explode( &quot;\n&quot;, $changes['zone_postcodes'] ) ) ) );&nbsp;</div></li><li><div>            foreach ( $postcodes as $postcode ) {&nbsp;</div></li><li><div>                $zone-&gt;add_location( $postcode, 'postcode' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $changes['methods'] ) ) {&nbsp;</div></li><li><div>            foreach ( $changes['methods'] as $instance_id =&gt; $data ) {&nbsp;</div></li><li><div>                $method_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT method_id FROM {$wpdb-&gt;prefix}woocommerce_shipping_zone_methods WHERE instance_id = %d&quot;, $instance_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $data['deleted'] ) ) {&nbsp;</div></li><li><div>                    $shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );&nbsp;</div></li><li><div>                    $option_key = $shipping_method-&gt;get_instance_option_key();&nbsp;</div></li><li><div>                    if ( $wpdb-&gt;delete( &quot;{$wpdb-&gt;prefix}woocommerce_shipping_zone_methods&quot;, array( 'instance_id' =&gt; $instance_id ) ) ) {&nbsp;</div></li><li><div>                        delete_option( $option_key );&nbsp;</div></li><li><div>                        do_action( 'woocommerce_shipping_zone_method_deleted', $instance_id, $method_id, $zone_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $method_data = array_intersect_key( $data, array(&nbsp;</div></li><li><div>                    'method_order' =&gt; 1, &nbsp;</div></li><li><div>                    'enabled' =&gt; 1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $method_data['method_order'] ) ) {&nbsp;</div></li><li><div>                    $wpdb-&gt;update( &quot;{$wpdb-&gt;prefix}woocommerce_shipping_zone_methods&quot;, array( 'method_order' =&gt; absint( $method_data['method_order'] ) ), array( 'instance_id' =&gt; absint( $instance_id ) ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $method_data['enabled'] ) ) {&nbsp;</div></li><li><div>                    $is_enabled = absint( 'yes' === $method_data['enabled'] );&nbsp;</div></li><li><div>                    if ( $wpdb-&gt;update( &quot;{$wpdb-&gt;prefix}woocommerce_shipping_zone_methods&quot;, array( 'is_enabled' =&gt; $is_enabled ), array( 'instance_id' =&gt; absint( $instance_id ) ) ) ) {&nbsp;</div></li><li><div>                        do_action( 'woocommerce_shipping_zone_method_status_toggled', $instance_id, $method_id, $zone_id, $is_enabled );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $zone-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json_success( array(&nbsp;</div></li><li><div>            'zone_id' =&gt; $zone-&gt;get_id(), &nbsp;</div></li><li><div>            'zone_name' =&gt; $zone-&gt;get_zone_name(), &nbsp;</div></li><li><div>            'methods' =&gt; $zone-&gt;get_shipping_methods(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Save method settings&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function shipping_zone_methods_save_settings() {&nbsp;</div></li><li><div>        if ( ! isset( $_POST['wc_shipping_zones_nonce'], $_POST['instance_id'], $_POST['data'] ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_fields' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['wc_shipping_zones_nonce'], 'wc_shipping_zones_nonce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'bad_nonce' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_capabilities' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $instance_id = absint( $_POST['instance_id'] );&nbsp;</div></li><li><div>        $zone = WC_Shipping_Zones::get_zone_by( 'instance_id', $instance_id );&nbsp;</div></li><li><div>        $shipping_method = WC_Shipping_Zones::get_shipping_method( $instance_id );&nbsp;</div></li><li><div>        $shipping_method-&gt;set_post_data( $_POST['data'] );&nbsp;</div></li><li><div>        $shipping_method-&gt;process_admin_options();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json_success( array(&nbsp;</div></li><li><div>            'zone_id' =&gt; $zone-&gt;get_id(), &nbsp;</div></li><li><div>            'zone_name' =&gt; $zone-&gt;get_zone_name(), &nbsp;</div></li><li><div>            'methods' =&gt; $zone-&gt;get_shipping_methods(), &nbsp;</div></li><li><div>            'errors' =&gt; $shipping_method-&gt;get_errors(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle submissions from assets/js/wc-shipping-classes.js Backbone model.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function shipping_classes_save_changes() {&nbsp;</div></li><li><div>        if ( ! isset( $_POST['wc_shipping_classes_nonce'], $_POST['changes'] ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_fields' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! wp_verify_nonce( $_POST['wc_shipping_classes_nonce'], 'wc_shipping_classes_nonce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'bad_nonce' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! current_user_can( 'manage_woocommerce' ) ) {&nbsp;</div></li><li><div>            wp_send_json_error( 'missing_capabilities' );&nbsp;</div></li><li><div>            exit;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $changes = $_POST['changes'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $changes as $term_id =&gt; $data ) {&nbsp;</div></li><li><div>            $term_id = absint( $term_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['deleted'] ) ) {&nbsp;</div></li><li><div>                if ( isset( $data['newRow'] ) ) {&nbsp;</div></li><li><div>                    // So the user added and deleted a new row.&nbsp;</div></li><li><div>                    // That's fine, it's not in the database anyways. NEXT!&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                wp_delete_term( $term_id, 'product_shipping_class' );&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $update_args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['name'] ) ) {&nbsp;</div></li><li><div>                $update_args['name'] = wc_clean( $data['name'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['slug'] ) ) {&nbsp;</div></li><li><div>                $update_args['slug'] = wc_clean( $data['slug'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['description'] ) ) {&nbsp;</div></li><li><div>                $update_args['description'] = wc_clean( $data['description'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $data['newRow'] ) ) {&nbsp;</div></li><li><div>                $update_args = array_filter( $update_args );&nbsp;</div></li><li><div>                if ( empty( $update_args['name'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $term_id = wp_insert_term( $update_args['name'], 'product_shipping_class', $update_args );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                wp_update_term( $term_id, 'product_shipping_class', $update_args );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_shipping_classes_save_class', $term_id, $data );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wc_shipping = WC_Shipping::instance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_send_json_success( array(&nbsp;</div></li><li><div>            'shipping_classes' =&gt; $wc_shipping-&gt;get_shipping_classes(), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/wc_ajax/" class="">3.0.6</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/wc_ajax/" class="active">3.0.5</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.4/classes/wc_ajax/" class="">3.0.4</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.3/classes/wc_ajax/" class="">3.0.3</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/wc_ajax/" class="">3.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WC_AJAX</li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>