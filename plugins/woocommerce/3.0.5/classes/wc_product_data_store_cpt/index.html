<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="3.0.5" data-slug="woocommerce" data-type="class" data-id="41513"><head xmlns="http://www.w3.org/1999/xhtml"><title> wc_product_data_store_cpt | class | Woocommerce | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WC_Product_Data_Store_CPT, class, plugin, woocommerce, 3.0.5" /><meta name="description" content="WC Product Data Store: Stored in CPT." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=35a9f79ddbbf2f77d9b0f1f4f28d1db9' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wc_product_data_store_cpt/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_product_data_store_cpt%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwc_product_data_store_cpt%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-woocommerce-3.0.5-class-wc_product_data_store_cpt","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wc_product_data_store_cpt" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to woocommerce." href="http://hookr.io/plugins/woocommerce/" class="plugin"><span property="name">woocommerce</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 3.0.5." href="http://hookr.io/plugins/woocommerce/3.0.5/" class="H_VERSION"><span property="name">3.0.5</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/woocommerce/3.0.5/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wc_product_data_store_cpt</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="3116"><a href="http://hookr.io/plugins/woocommerce/3.0.5/all/" title="All">All <span class="count badge">3116</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/woocommerce/3.0.5/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="2109"><a href="http://hookr.io/plugins/woocommerce/3.0.5/hooks/" title="Hooks">Hooks <span class="count badge">2109</span></a></li><li class="" data-id="action" data-count="774"><a href="http://hookr.io/plugins/woocommerce/3.0.5/actions/" title="Actions">Actions <span class="count badge">774</span></a></li><li class="" data-id="filter" data-count="1335"><a href="http://hookr.io/plugins/woocommerce/3.0.5/filters/" title="Filters">Filters <span class="count badge">1335</span></a></li><li class="active" data-id="class" data-count="364"><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/" title="Classes">Classes <span class="count badge">364</span></a></li><li class="" data-id="constant" data-count="14"><a href="http://hookr.io/plugins/woocommerce/3.0.5/constants/" title="Constants">Constants <span class="count badge">14</span></a></li><li class="" data-id="function" data-count="625"><a href="http://hookr.io/plugins/woocommerce/3.0.5/functions/" title="Functions">Functions <span class="count badge">625</span></a></li><li class="" data-id="shortcode" data-count="4"><a href="http://hookr.io/plugins/woocommerce/3.0.5/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">4</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WC_Product_Data_Store_CPT</strong></h1><p>WC Product Data Store: Stored in CPT.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/woocommerce/3.0.5/files/includes-data-stores-class-wc-product-data-store-cpt/" class="file">/includes/data-stores/class-wc-product-data-store-cpt.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="13" class="block" start="13"><li><div>class WC_Product_Data_Store_CPT extends WC_Data_Store_WP implements WC_Object_Data_Store_Interface, WC_Product_Data_Store_Interface {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Data stored in meta keys, but not considered &quot;meta&quot;.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $internal_meta_keys = array(&nbsp;</div></li><li><div>        '_visibility', &nbsp;</div></li><li><div>        '_sku', &nbsp;</div></li><li><div>        '_price', &nbsp;</div></li><li><div>        '_regular_price', &nbsp;</div></li><li><div>        '_sale_price', &nbsp;</div></li><li><div>        '_sale_price_dates_from', &nbsp;</div></li><li><div>        '_sale_price_dates_to', &nbsp;</div></li><li><div>        'total_sales', &nbsp;</div></li><li><div>        '_tax_status', &nbsp;</div></li><li><div>        '_tax_class', &nbsp;</div></li><li><div>        '_manage_stock', &nbsp;</div></li><li><div>        '_stock', &nbsp;</div></li><li><div>        '_stock_status', &nbsp;</div></li><li><div>        '_backorders', &nbsp;</div></li><li><div>        '_sold_individually', &nbsp;</div></li><li><div>        '_weight', &nbsp;</div></li><li><div>        '_length', &nbsp;</div></li><li><div>        '_width', &nbsp;</div></li><li><div>        '_height', &nbsp;</div></li><li><div>        '_upsell_ids', &nbsp;</div></li><li><div>        '_crosssell_ids', &nbsp;</div></li><li><div>        '_purchase_note', &nbsp;</div></li><li><div>        '_default_attributes', &nbsp;</div></li><li><div>        '_product_attributes', &nbsp;</div></li><li><div>        '_virtual', &nbsp;</div></li><li><div>        '_downloadable', &nbsp;</div></li><li><div>        '_featured', &nbsp;</div></li><li><div>        '_downloadable_files', &nbsp;</div></li><li><div>        '_wc_rating_count', &nbsp;</div></li><li><div>        '_wc_average_rating', &nbsp;</div></li><li><div>        '_wc_review_count', &nbsp;</div></li><li><div>        '_variation_description', &nbsp;</div></li><li><div>        '_thumbnail_id', &nbsp;</div></li><li><div>        '_file_paths', &nbsp;</div></li><li><div>        '_product_image_gallery', &nbsp;</div></li><li><div>        '_product_version', &nbsp;</div></li><li><div>        '_wp_old_slug', &nbsp;</div></li><li><div>        '_edit_last', &nbsp;</div></li><li><div>        '_edit_lock', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * If we have already saved our extra data, don't do automatic / default handling.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $extra_data_saved = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Stores updated props.&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $updated_props = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    | CRUD Methods&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Method to create a new product in the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function create( &$product ) {&nbsp;</div></li><li><div>        if ( ! $product-&gt;get_date_created() ) {&nbsp;</div></li><li><div>            $product-&gt;set_date_created( current_time( 'timestamp', true ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = wp_insert_post( apply_filters( 'woocommerce_new_product_data', array(&nbsp;</div></li><li><div>            'post_type' =&gt; 'product', &nbsp;</div></li><li><div>            'post_status' =&gt; $product-&gt;get_status() ? $product-&gt;get_status() : 'publish', &nbsp;</div></li><li><div>            'post_author' =&gt; get_current_user_id(), &nbsp;</div></li><li><div>            'post_title' =&gt; $product-&gt;get_name() ? $product-&gt;get_name() : __( 'Product', 'woocommerce' ), &nbsp;</div></li><li><div>            'post_content' =&gt; $product-&gt;get_description(), &nbsp;</div></li><li><div>            'post_excerpt' =&gt; $product-&gt;get_short_description(), &nbsp;</div></li><li><div>            'post_parent' =&gt; $product-&gt;get_parent_id(), &nbsp;</div></li><li><div>            'comment_status' =&gt; $product-&gt;get_reviews_allowed() ? 'open' : 'closed', &nbsp;</div></li><li><div>            'ping_status' =&gt; 'closed', &nbsp;</div></li><li><div>            'menu_order' =&gt; $product-&gt;get_menu_order(), &nbsp;</div></li><li><div>            'post_date' =&gt; gmdate( 'Y-m-d H:i:s', $product-&gt;get_date_created( 'edit' )-&gt;getOffsetTimestamp() ), &nbsp;</div></li><li><div>            'post_date_gmt' =&gt; gmdate( 'Y-m-d H:i:s', $product-&gt;get_date_created( 'edit' )-&gt;getTimestamp() ), &nbsp;</div></li><li><div>            'post_name' =&gt; $product-&gt;get_slug( 'edit' ), &nbsp;</div></li><li><div> ) ), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $id && ! is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            $product-&gt;set_id( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;update_post_meta( $product, true );&nbsp;</div></li><li><div>            $this-&gt;update_terms( $product, true );&nbsp;</div></li><li><div>            $this-&gt;update_visibility( $product, true );&nbsp;</div></li><li><div>            $this-&gt;update_attributes( $product, true );&nbsp;</div></li><li><div>            $this-&gt;update_version_and_type( $product );&nbsp;</div></li><li><div>            $this-&gt;handle_updated_props( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product-&gt;save_meta_data();&nbsp;</div></li><li><div>            $product-&gt;apply_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;clear_caches( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            do_action( 'woocommerce_new_product', $id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Method to read a product from the database.&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function read( &$product ) {&nbsp;</div></li><li><div>        $product-&gt;set_defaults();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $product-&gt;get_id() || ! ( $post_object = get_post( $product-&gt;get_id() ) ) || 'product' !== $post_object-&gt;post_type ) {&nbsp;</div></li><li><div>            throw new Exception( __( 'Invalid product.', 'woocommerce' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $product-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product-&gt;set_props( array(&nbsp;</div></li><li><div>            'name' =&gt; $post_object-&gt;post_title, &nbsp;</div></li><li><div>            'slug' =&gt; $post_object-&gt;post_name, &nbsp;</div></li><li><div>            'date_created' =&gt; 0 &lt; $post_object-&gt;post_date_gmt ? wc_string_to_timestamp( $post_object-&gt;post_date_gmt ) : null, &nbsp;</div></li><li><div>            'date_modified' =&gt; 0 &lt; $post_object-&gt;post_modified_gmt ? wc_string_to_timestamp( $post_object-&gt;post_modified_gmt ) : null, &nbsp;</div></li><li><div>            'status' =&gt; $post_object-&gt;post_status, &nbsp;</div></li><li><div>            'description' =&gt; $post_object-&gt;post_content, &nbsp;</div></li><li><div>            'short_description' =&gt; $post_object-&gt;post_excerpt, &nbsp;</div></li><li><div>            'parent_id' =&gt; $post_object-&gt;post_parent, &nbsp;</div></li><li><div>            'menu_order' =&gt; $post_object-&gt;menu_order, &nbsp;</div></li><li><div>            'reviews_allowed' =&gt; 'open' === $post_object-&gt;comment_status, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;read_attributes( $product );&nbsp;</div></li><li><div>        $this-&gt;read_downloads( $product );&nbsp;</div></li><li><div>        $this-&gt;read_visibility( $product );&nbsp;</div></li><li><div>        $this-&gt;read_product_data( $product );&nbsp;</div></li><li><div>        $this-&gt;read_extra_data( $product );&nbsp;</div></li><li><div>        $product-&gt;set_object_read( true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Method to update a product in the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update( &$product ) {&nbsp;</div></li><li><div>        $product-&gt;save_meta_data();&nbsp;</div></li><li><div>        $changes = $product-&gt;get_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only update the post when the post data changes.&nbsp;</div></li><li><div>        if ( array_intersect( array( 'description', 'short_description', 'name', 'parent_id', 'reviews_allowed', 'status', 'menu_order', 'date_created', 'date_modified', 'slug' ), array_keys( $changes ) ) ) {&nbsp;</div></li><li><div>            $post_data = array(&nbsp;</div></li><li><div>                'post_content' =&gt; $product-&gt;get_description( 'edit' ), &nbsp;</div></li><li><div>                'post_excerpt' =&gt; $product-&gt;get_short_description( 'edit' ), &nbsp;</div></li><li><div>                'post_title' =&gt; $product-&gt;get_name( 'edit' ), &nbsp;</div></li><li><div>                'post_parent' =&gt; $product-&gt;get_parent_id( 'edit' ), &nbsp;</div></li><li><div>                'comment_status' =&gt; $product-&gt;get_reviews_allowed( 'edit' ) ? 'open' : 'closed', &nbsp;</div></li><li><div>                'post_status' =&gt; $product-&gt;get_status( 'edit' ) ? $product-&gt;get_status( 'edit' ) : 'publish', &nbsp;</div></li><li><div>                'menu_order' =&gt; $product-&gt;get_menu_order( 'edit' ), &nbsp;</div></li><li><div>                'post_name' =&gt; $product-&gt;get_slug( 'edit' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            if ( $product-&gt;get_date_created( 'edit' ) ) {&nbsp;</div></li><li><div>                $post_data['post_date'] = gmdate( 'Y-m-d H:i:s', $product-&gt;get_date_created( 'edit' )-&gt;getOffsetTimestamp() );&nbsp;</div></li><li><div>                $post_data['post_date_gmt'] = gmdate( 'Y-m-d H:i:s', $product-&gt;get_date_created( 'edit' )-&gt;getTimestamp() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( isset( $changes['date_modified'] ) && $product-&gt;get_date_modified( 'edit' ) ) {&nbsp;</div></li><li><div>                $post_data['post_modified'] = gmdate( 'Y-m-d H:i:s', $product-&gt;get_date_modified( 'edit' )-&gt;getOffsetTimestamp() );&nbsp;</div></li><li><div>                $post_data['post_modified_gmt'] = gmdate( 'Y-m-d H:i:s', $product-&gt;get_date_modified( 'edit' )-&gt;getTimestamp() );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $post_data['post_modified'] = current_time( 'mysql' );&nbsp;</div></li><li><div>                $post_data['post_modified_gmt'] = current_time( 'mysql', 1 );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * When updating this object, to prevent infinite loops, use $wpdb&nbsp;</div></li><li><div>             * to update data, since wp_update_post spawns more calls to the&nbsp;</div></li><li><div>             * save_post action.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * This ensures hooks are fired by either WP itself (admin screen save), &nbsp;</div></li><li><div>             * or an update purely from CRUD.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            if ( doing_action( 'save_post' ) ) {&nbsp;</div></li><li><div>                $GLOBALS['wpdb']-&gt;update( $GLOBALS['wpdb']-&gt;posts, $post_data, array( 'ID' =&gt; $product-&gt;get_id() ) );&nbsp;</div></li><li><div>                clean_post_cache( $product-&gt;get_id() );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                wp_update_post( array_merge( array( 'ID' =&gt; $product-&gt;get_id() ), $post_data ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product-&gt;read_meta_data( true ); // Refresh internal meta data, in case things were hooked into `save_post` or another WP hook.&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;update_post_meta( $product );&nbsp;</div></li><li><div>        $this-&gt;update_terms( $product );&nbsp;</div></li><li><div>        $this-&gt;update_visibility( $product );&nbsp;</div></li><li><div>        $this-&gt;update_attributes( $product );&nbsp;</div></li><li><div>        $this-&gt;update_version_and_type( $product );&nbsp;</div></li><li><div>        $this-&gt;handle_updated_props( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product-&gt;apply_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;clear_caches( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'woocommerce_update_product', $product-&gt;get_id() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Method to delete a product from the database.&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @param array $args Array of args to pass to the delete method.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function delete( &$product, $args = array() ) {&nbsp;</div></li><li><div>        $id = $product-&gt;get_id();&nbsp;</div></li><li><div>        $post_type = $product-&gt;is_type( 'variation' ) ? 'product_variation' : 'product';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, array(&nbsp;</div></li><li><div>            'force_delete' =&gt; false, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $args['force_delete'] ) {&nbsp;</div></li><li><div>            wp_delete_post( $product-&gt;get_id() );&nbsp;</div></li><li><div>            $product-&gt;set_id( 0 );&nbsp;</div></li><li><div>            do_action( 'woocommerce_delete_' . $post_type, $id );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            wp_trash_post( $product-&gt;get_id() );&nbsp;</div></li><li><div>            $product-&gt;set_status( 'trash' );&nbsp;</div></li><li><div>            do_action( 'woocommerce_trash_' . $post_type, $id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    | Additional Methods&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Read product data. Can be overridden by child classes to load other props.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function read_product_data( &$product ) {&nbsp;</div></li><li><div>        $id = $product-&gt;get_id();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' === ( $review_count = get_post_meta( $id, '_wc_review_count', true ) ) ) {&nbsp;</div></li><li><div>            WC_Comments::get_review_count_for_product( $product );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;set_review_count( $review_count );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' === ( $rating_counts = get_post_meta( $id, '_wc_rating_count', true ) ) ) {&nbsp;</div></li><li><div>            WC_Comments::get_rating_counts_for_product( $product );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;set_rating_counts( $rating_counts );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( '' === ( $average_rating = get_post_meta( $id, '_wc_average_rating', true ) ) ) {&nbsp;</div></li><li><div>            WC_Comments::get_average_rating_for_product( $product );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product-&gt;set_average_rating( $average_rating );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product-&gt;set_props( array(&nbsp;</div></li><li><div>            'sku' =&gt; get_post_meta( $id, '_sku', true ), &nbsp;</div></li><li><div>            'regular_price' =&gt; get_post_meta( $id, '_regular_price', true ), &nbsp;</div></li><li><div>            'sale_price' =&gt; get_post_meta( $id, '_sale_price', true ), &nbsp;</div></li><li><div>            'price' =&gt; get_post_meta( $id, '_price', true ), &nbsp;</div></li><li><div>            'date_on_sale_from' =&gt; get_post_meta( $id, '_sale_price_dates_from', true ), &nbsp;</div></li><li><div>            'date_on_sale_to' =&gt; get_post_meta( $id, '_sale_price_dates_to', true ), &nbsp;</div></li><li><div>            'total_sales' =&gt; get_post_meta( $id, 'total_sales', true ), &nbsp;</div></li><li><div>            'tax_status' =&gt; get_post_meta( $id, '_tax_status', true ), &nbsp;</div></li><li><div>            'tax_class' =&gt; get_post_meta( $id, '_tax_class', true ), &nbsp;</div></li><li><div>            'manage_stock' =&gt; get_post_meta( $id, '_manage_stock', true ), &nbsp;</div></li><li><div>            'stock_quantity' =&gt; get_post_meta( $id, '_stock', true ), &nbsp;</div></li><li><div>            'stock_status' =&gt; get_post_meta( $id, '_stock_status', true ), &nbsp;</div></li><li><div>            'backorders' =&gt; get_post_meta( $id, '_backorders', true ), &nbsp;</div></li><li><div>            'sold_individually' =&gt; get_post_meta( $id, '_sold_individually', true ), &nbsp;</div></li><li><div>            'weight' =&gt; get_post_meta( $id, '_weight', true ), &nbsp;</div></li><li><div>            'length' =&gt; get_post_meta( $id, '_length', true ), &nbsp;</div></li><li><div>            'width' =&gt; get_post_meta( $id, '_width', true ), &nbsp;</div></li><li><div>            'height' =&gt; get_post_meta( $id, '_height', true ), &nbsp;</div></li><li><div>            'upsell_ids' =&gt; get_post_meta( $id, '_upsell_ids', true ), &nbsp;</div></li><li><div>            'cross_sell_ids' =&gt; get_post_meta( $id, '_crosssell_ids', true ), &nbsp;</div></li><li><div>            'purchase_note' =&gt; get_post_meta( $id, '_purchase_note', true ), &nbsp;</div></li><li><div>            'default_attributes' =&gt; get_post_meta( $id, '_default_attributes', true ), &nbsp;</div></li><li><div>            'category_ids' =&gt; $this-&gt;get_term_ids( $product, 'product_cat' ), &nbsp;</div></li><li><div>            'tag_ids' =&gt; $this-&gt;get_term_ids( $product, 'product_tag' ), &nbsp;</div></li><li><div>            'shipping_class_id' =&gt; current( $this-&gt;get_term_ids( $product, 'product_shipping_class' ) ), &nbsp;</div></li><li><div>            'virtual' =&gt; get_post_meta( $id, '_virtual', true ), &nbsp;</div></li><li><div>            'downloadable' =&gt; get_post_meta( $id, '_downloadable', true ), &nbsp;</div></li><li><div>            'gallery_image_ids' =&gt; array_filter( explode( ', ', get_post_meta( $id, '_product_image_gallery', true ) ) ), &nbsp;</div></li><li><div>            'download_limit' =&gt; get_post_meta( $id, '_download_limit', true ), &nbsp;</div></li><li><div>            'download_expiry' =&gt; get_post_meta( $id, '_download_expiry', true ), &nbsp;</div></li><li><div>            'image_id' =&gt; get_post_thumbnail_id( $id ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Read extra data associated with the product, like button text or product URL for external products.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function read_extra_data( &$product ) {&nbsp;</div></li><li><div>        foreach ( $product-&gt;get_extra_data_keys() as $key ) {&nbsp;</div></li><li><div>            $function = 'set_' . $key;&nbsp;</div></li><li><div>            if ( is_callable( array( $product, $function ) ) ) {&nbsp;</div></li><li><div>                $product-&gt;{$function}( get_post_meta( $product-&gt;get_id(), '_' . $key, true ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Convert visibility terms to props.&nbsp;</div></li><li><div>     * Catalog visibility valid values are 'visible', 'catalog', 'search', and 'hidden'.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function read_visibility( &$product ) {&nbsp;</div></li><li><div>        $terms = get_the_terms( $product-&gt;get_id(), 'product_visibility' );&nbsp;</div></li><li><div>        $term_names = is_array( $terms ) ? wp_list_pluck( $terms, 'name' ) : array();&nbsp;</div></li><li><div>        $featured = in_array( 'featured', $term_names );&nbsp;</div></li><li><div>        $exclude_search = in_array( 'exclude-from-search', $term_names );&nbsp;</div></li><li><div>        $exclude_catalog = in_array( 'exclude-from-catalog', $term_names );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $exclude_search && $exclude_catalog ) {&nbsp;</div></li><li><div>            $catalog_visibility = 'hidden';&nbsp;</div></li><li><div>        } elseif ( $exclude_search ) {&nbsp;</div></li><li><div>            $catalog_visibility = 'catalog';&nbsp;</div></li><li><div>        } elseif ( $exclude_catalog ) {&nbsp;</div></li><li><div>            $catalog_visibility = 'search';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $catalog_visibility = 'visible';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product-&gt;set_props( array(&nbsp;</div></li><li><div>            'featured' =&gt; $featured, &nbsp;</div></li><li><div>            'catalog_visibility' =&gt; $catalog_visibility, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Read attributes from post meta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function read_attributes( &$product ) {&nbsp;</div></li><li><div>        $meta_values = get_post_meta( $product-&gt;get_id(), '_product_attributes', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $meta_values ) && is_array( $meta_values ) ) {&nbsp;</div></li><li><div>            $attributes = array();&nbsp;</div></li><li><div>            foreach ( $meta_values as $meta_value ) {&nbsp;</div></li><li><div>                $meta_value = array_merge( array(&nbsp;</div></li><li><div>                    'name' =&gt; '', &nbsp;</div></li><li><div>                    'value' =&gt; '', &nbsp;</div></li><li><div>                    'position' =&gt; 0, &nbsp;</div></li><li><div>                    'is_visible' =&gt; 0, &nbsp;</div></li><li><div>                    'is_variation' =&gt; 0, &nbsp;</div></li><li><div>                    'is_taxonomy' =&gt; 0, &nbsp;</div></li><li><div> ), (array) $meta_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $meta_value['is_taxonomy'] ) ) {&nbsp;</div></li><li><div>                    if ( ! taxonomy_exists( $meta_value['name'] ) ) {&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $options = wc_get_object_terms( $product-&gt;get_id(), $meta_value['name'], 'term_id' );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $options = wc_get_text_attributes( $meta_value['value'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $attribute = new WC_Product_Attribute();&nbsp;</div></li><li><div>                $attribute-&gt;set_id( wc_attribute_taxonomy_id_by_name( $meta_value['name'] ) );&nbsp;</div></li><li><div>                $attribute-&gt;set_name( $meta_value['name'] );&nbsp;</div></li><li><div>                $attribute-&gt;set_options( $options );&nbsp;</div></li><li><div>                $attribute-&gt;set_position( $meta_value['position'] );&nbsp;</div></li><li><div>                $attribute-&gt;set_visible( $meta_value['is_visible'] );&nbsp;</div></li><li><div>                $attribute-&gt;set_variation( $meta_value['is_variation'] );&nbsp;</div></li><li><div>                $attributes[] = $attribute;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product-&gt;set_attributes( $attributes );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Read downloads from post meta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function read_downloads( &$product ) {&nbsp;</div></li><li><div>        $meta_values = array_filter( (array) get_post_meta( $product-&gt;get_id(), '_downloadable_files', true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $meta_values ) {&nbsp;</div></li><li><div>            $downloads = array();&nbsp;</div></li><li><div>            foreach ( $meta_values as $key =&gt; $value ) {&nbsp;</div></li><li><div>                if ( ! isset( $value['name'], $value['file'] ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $download = new WC_Product_Download();&nbsp;</div></li><li><div>                $download-&gt;set_id( $key );&nbsp;</div></li><li><div>                $download-&gt;set_name( $value['name'] ? $value['name'] : wc_get_filename_from_url( $value['file'] ) );&nbsp;</div></li><li><div>                $download-&gt;set_file( apply_filters( 'woocommerce_file_download_path', $value['file'], $product, $key ) );&nbsp;</div></li><li><div>                $downloads[] = $download;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product-&gt;set_downloads( $downloads );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Helper method that updates all the post meta for a product based on it's settings in the WC_Product class.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @param bool Force update. Used during create.&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_post_meta( &$product, $force = false ) {&nbsp;</div></li><li><div>        $meta_key_to_props = array(&nbsp;</div></li><li><div>            '_sku' =&gt; 'sku', &nbsp;</div></li><li><div>            '_regular_price' =&gt; 'regular_price', &nbsp;</div></li><li><div>            '_sale_price' =&gt; 'sale_price', &nbsp;</div></li><li><div>            '_sale_price_dates_from' =&gt; 'date_on_sale_from', &nbsp;</div></li><li><div>            '_sale_price_dates_to' =&gt; 'date_on_sale_to', &nbsp;</div></li><li><div>            'total_sales' =&gt; 'total_sales', &nbsp;</div></li><li><div>            '_tax_status' =&gt; 'tax_status', &nbsp;</div></li><li><div>            '_tax_class' =&gt; 'tax_class', &nbsp;</div></li><li><div>            '_manage_stock' =&gt; 'manage_stock', &nbsp;</div></li><li><div>            '_backorders' =&gt; 'backorders', &nbsp;</div></li><li><div>            '_sold_individually' =&gt; 'sold_individually', &nbsp;</div></li><li><div>            '_weight' =&gt; 'weight', &nbsp;</div></li><li><div>            '_length' =&gt; 'length', &nbsp;</div></li><li><div>            '_width' =&gt; 'width', &nbsp;</div></li><li><div>            '_height' =&gt; 'height', &nbsp;</div></li><li><div>            '_upsell_ids' =&gt; 'upsell_ids', &nbsp;</div></li><li><div>            '_crosssell_ids' =&gt; 'cross_sell_ids', &nbsp;</div></li><li><div>            '_purchase_note' =&gt; 'purchase_note', &nbsp;</div></li><li><div>            '_default_attributes' =&gt; 'default_attributes', &nbsp;</div></li><li><div>            '_virtual' =&gt; 'virtual', &nbsp;</div></li><li><div>            '_downloadable' =&gt; 'downloadable', &nbsp;</div></li><li><div>            '_product_image_gallery' =&gt; 'gallery_image_ids', &nbsp;</div></li><li><div>            '_download_limit' =&gt; 'download_limit', &nbsp;</div></li><li><div>            '_download_expiry' =&gt; 'download_expiry', &nbsp;</div></li><li><div>            '_thumbnail_id' =&gt; 'image_id', &nbsp;</div></li><li><div>            '_stock' =&gt; 'stock_quantity', &nbsp;</div></li><li><div>            '_stock_status' =&gt; 'stock_status', &nbsp;</div></li><li><div>            '_wc_average_rating' =&gt; 'average_rating', &nbsp;</div></li><li><div>            '_wc_rating_count' =&gt; 'rating_counts', &nbsp;</div></li><li><div>            '_wc_review_count' =&gt; 'review_count', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure to take extra data (like product url or text for external products) into account.&nbsp;</div></li><li><div>        $extra_data_keys = $product-&gt;get_extra_data_keys();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $extra_data_keys as $key ) {&nbsp;</div></li><li><div>            $meta_key_to_props[ '_' . $key ] = $key;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $props_to_update = $force ? $meta_key_to_props : $this-&gt;get_props_to_update( $product, $meta_key_to_props );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $props_to_update as $meta_key =&gt; $prop ) {&nbsp;</div></li><li><div>            $value = $product-&gt;{&quot;get_$prop&quot;}( 'edit' );&nbsp;</div></li><li><div>            switch ( $prop ) {&nbsp;</div></li><li><div>                case 'virtual' :&nbsp;</div></li><li><div>                case 'downloadable' :&nbsp;</div></li><li><div>                case 'manage_stock' :&nbsp;</div></li><li><div>                case 'sold_individually' :&nbsp;</div></li><li><div>                    $updated = update_post_meta( $product-&gt;get_id(), $meta_key, wc_bool_to_string( $value ) );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'gallery_image_ids' :&nbsp;</div></li><li><div>                    $updated = update_post_meta( $product-&gt;get_id(), $meta_key, implode( ', ', $value ) );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'image_id' :&nbsp;</div></li><li><div>                    if ( ! empty( $value ) ) {&nbsp;</div></li><li><div>                        set_post_thumbnail( $product-&gt;get_id(), $value );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        delete_post_meta( $product-&gt;get_id(), '_thumbnail_id' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $updated = true;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'date_on_sale_from' :&nbsp;</div></li><li><div>                case 'date_on_sale_to' :&nbsp;</div></li><li><div>                    $updated = update_post_meta( $product-&gt;get_id(), $meta_key, $value ? $value-&gt;getTimestamp() : '' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                default :&nbsp;</div></li><li><div>                    $updated = update_post_meta( $product-&gt;get_id(), $meta_key, $value );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $updated ) {&nbsp;</div></li><li><div>                $this-&gt;updated_props[] = $prop;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update extra data associated with the product like button text or product URL for external products.&nbsp;</div></li><li><div>        if ( ! $this-&gt;extra_data_saved ) {&nbsp;</div></li><li><div>            foreach ( $extra_data_keys as $key ) {&nbsp;</div></li><li><div>                if ( ! array_key_exists( $key, $props_to_update ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $function = 'get_' . $key;&nbsp;</div></li><li><div>                if ( is_callable( array( $product, $function ) ) ) {&nbsp;</div></li><li><div>                    if ( update_post_meta( $product-&gt;get_id(), '_' . $key, $product-&gt;{$function}( 'edit' ) ) ) {&nbsp;</div></li><li><div>                        $this-&gt;updated_props[] = $key;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $this-&gt;update_downloads( $product, $force ) ) {&nbsp;</div></li><li><div>            $this-&gt;updated_props[] = 'downloads';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Handle updated meta props after updating meta data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  WC_Product $product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function handle_updated_props( &$product ) {&nbsp;</div></li><li><div>        if ( in_array( 'date_on_sale_from', $this-&gt;updated_props ) || in_array( 'date_on_sale_to', $this-&gt;updated_props ) || in_array( 'regular_price', $this-&gt;updated_props ) || in_array( 'sale_price', $this-&gt;updated_props ) ) {&nbsp;</div></li><li><div>            if ( $product-&gt;is_on_sale( 'edit' ) ) {&nbsp;</div></li><li><div>                update_post_meta( $product-&gt;get_id(), '_price', $product-&gt;get_sale_price( 'edit' ) );&nbsp;</div></li><li><div>                $product-&gt;set_price( $product-&gt;get_sale_price( 'edit' ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                update_post_meta( $product-&gt;get_id(), '_price', $product-&gt;get_regular_price( 'edit' ) );&nbsp;</div></li><li><div>                $product-&gt;set_price( $product-&gt;get_regular_price( 'edit' ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( in_array( 'stock_quantity', $this-&gt;updated_props ) ) {&nbsp;</div></li><li><div>            do_action( $product-&gt;is_type( 'variation' ) ? 'woocommerce_variation_set_stock' : 'woocommerce_product_set_stock' , $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( in_array( 'stock_status', $this-&gt;updated_props ) ) {&nbsp;</div></li><li><div>            do_action( $product-&gt;is_type( 'variation' ) ? 'woocommerce_variation_set_stock_status' : 'woocommerce_product_set_stock_status' , $product-&gt;get_id(), $product-&gt;get_stock_status(), $product );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Trigger action so 3rd parties can deal with updated props.&nbsp;</div></li><li><div>        do_action( 'woocommerce_product_object_updated_props', $product, $this-&gt;updated_props );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // After handling, we can reset the props array.&nbsp;</div></li><li><div>        $this-&gt;updated_props = array();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * For all stored terms in all taxonomies, save them to the DB.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @param bool Force update. Used during create.&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_terms( &$product, $force = false ) {&nbsp;</div></li><li><div>        $changes = $product-&gt;get_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force || array_key_exists( 'category_ids', $changes ) ) {&nbsp;</div></li><li><div>            wp_set_post_terms( $product-&gt;get_id(), $product-&gt;get_category_ids( 'edit' ), 'product_cat', false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $force || array_key_exists( 'tag_ids', $changes ) ) {&nbsp;</div></li><li><div>            wp_set_post_terms( $product-&gt;get_id(), $product-&gt;get_tag_ids( 'edit' ), 'product_tag', false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $force || array_key_exists( 'shipping_class_id', $changes ) ) {&nbsp;</div></li><li><div>            wp_set_post_terms( $product-&gt;get_id(), array( $product-&gt;get_shipping_class_id( 'edit' ) ), 'product_shipping_class', false );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update visibility terms based on props.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param bool Force update. Used during create.&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_visibility( &$product, $force = false ) {&nbsp;</div></li><li><div>        $changes = $product-&gt;get_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force || array_intersect( array( 'featured', 'stock_status', 'average_rating', 'catalog_visibility' ), array_keys( $changes ) ) ) {&nbsp;</div></li><li><div>            $terms = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product-&gt;get_featured() ) {&nbsp;</div></li><li><div>                $terms[] = 'featured';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'outofstock' === $product-&gt;get_stock_status() ) {&nbsp;</div></li><li><div>                $terms[] = 'outofstock';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $rating = max( array( 5, min( array( 1, round( $product-&gt;get_average_rating(), 0 ) ) ) ) );&nbsp;</div></li><li><div>            $terms[] = 'rated-' . $rating;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $product-&gt;get_catalog_visibility() ) {&nbsp;</div></li><li><div>                case 'hidden' :&nbsp;</div></li><li><div>                    $terms[] = 'exclude-from-search';&nbsp;</div></li><li><div>                    $terms[] = 'exclude-from-catalog';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'catalog' :&nbsp;</div></li><li><div>                    $terms[] = 'exclude-from-search';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'search' :&nbsp;</div></li><li><div>                    $terms[] = 'exclude-from-catalog';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_wp_error( wp_set_post_terms( $product-&gt;get_id(), $terms, 'product_visibility', false ) ) ) {&nbsp;</div></li><li><div>                delete_transient( 'wc_featured_products' );&nbsp;</div></li><li><div>                do_action( 'woocommerce_product_set_visibility', $product-&gt;get_id(), $product-&gt;get_catalog_visibility() );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update attributes which are a mix of terms and meta data.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @param bool Force update. Used during create.&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_attributes( &$product, $force = false ) {&nbsp;</div></li><li><div>        $changes = $product-&gt;get_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force || array_key_exists( 'attributes', $changes ) ) {&nbsp;</div></li><li><div>            $attributes = $product-&gt;get_attributes();&nbsp;</div></li><li><div>            $meta_values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $attributes ) {&nbsp;</div></li><li><div>                foreach ( $attributes as $attribute_key =&gt; $attribute ) {&nbsp;</div></li><li><div>                    $value = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_null( $attribute ) ) {&nbsp;</div></li><li><div>                        if ( taxonomy_exists( $attribute_key ) ) {&nbsp;</div></li><li><div>                            // Handle attributes that have been unset.&nbsp;</div></li><li><div>                            wp_set_object_terms( $product-&gt;get_id(), array(), $attribute_key );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } elseif ( $attribute-&gt;is_taxonomy() ) {&nbsp;</div></li><li><div>                        wp_set_object_terms( $product-&gt;get_id(), wp_list_pluck( $attribute-&gt;get_terms(), 'term_id' ), $attribute-&gt;get_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $value = wc_implode_text_attributes( $attribute-&gt;get_options() );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Store in format WC uses in meta.&nbsp;</div></li><li><div>                    $meta_values[ $attribute_key ] = array(&nbsp;</div></li><li><div>                        'name' =&gt; $attribute-&gt;get_name(), &nbsp;</div></li><li><div>                        'value' =&gt; $value, &nbsp;</div></li><li><div>                        'position' =&gt; $attribute-&gt;get_position(), &nbsp;</div></li><li><div>                        'is_visible' =&gt; $attribute-&gt;get_visible() ? 1 : 0, &nbsp;</div></li><li><div>                        'is_variation' =&gt; $attribute-&gt;get_variation() ? 1 : 0, &nbsp;</div></li><li><div>                        'is_taxonomy' =&gt; $attribute-&gt;is_taxonomy() ? 1 : 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            update_post_meta( $product-&gt;get_id(), '_product_attributes', $meta_values );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update downloads.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     * @param bool Force update. Used during create.&nbsp;</div></li><li><div>     * @return bool If updated or not.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_downloads( &$product, $force = false ) {&nbsp;</div></li><li><div>        $changes = $product-&gt;get_changes();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $force || array_key_exists( 'downloads', $changes ) ) {&nbsp;</div></li><li><div>            $downloads = $product-&gt;get_downloads();&nbsp;</div></li><li><div>            $meta_values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $downloads ) {&nbsp;</div></li><li><div>                foreach ( $downloads as $key =&gt; $download ) {&nbsp;</div></li><li><div>                    // Store in format WC uses in meta.&nbsp;</div></li><li><div>                    $meta_values[ $key ] = $download-&gt;get_data();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product-&gt;is_type( 'variation' ) ) {&nbsp;</div></li><li><div>                do_action( 'woocommerce_process_product_file_download_paths', $product-&gt;get_parent_id(), $product-&gt;get_id(), $downloads );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                do_action( 'woocommerce_process_product_file_download_paths', $product-&gt;get_id(), 0, $downloads );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return update_post_meta( $product-&gt;get_id(), '_downloadable_files', $meta_values );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Make sure we store the product type and version (to track data changes).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function update_version_and_type( &$product ) {&nbsp;</div></li><li><div>        $old_type = WC_Product_Factory::get_product_type( $product-&gt;get_id() );&nbsp;</div></li><li><div>        $new_type = $product-&gt;get_type();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_set_object_terms( $product-&gt;get_id(), $new_type, 'product_type' );&nbsp;</div></li><li><div>        update_post_meta( $product-&gt;get_id(), '_product_version', WC_VERSION );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Action for the transition.&nbsp;</div></li><li><div>        if ( $old_type !== $new_type ) {&nbsp;</div></li><li><div>            do_action( 'woocommerce_product_type_changed', $product, $old_type, $new_type );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Clear any caches.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param WC_Product&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function clear_caches( &$product ) {&nbsp;</div></li><li><div>        wc_delete_product_transients( $product-&gt;get_id() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    | wc-product-functions.php methods&nbsp;</div></li><li><div>    |--------------------------------------------------------------------------&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of on sale products, as an array of objects with an&nbsp;</div></li><li><div>     * ID and parent_id present. Example: $return[0]-&gt;id, $return[0]-&gt;parent_id.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_on_sale_products() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $decimals = absint( wc_get_price_decimals() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_results( &quot;&nbsp;</div></li><li><div>            SELECT post.ID as id, post.post_parent as parent_id FROM `$wpdb-&gt;posts` AS post&nbsp;</div></li><li><div>            LEFT JOIN `$wpdb-&gt;postmeta` AS meta ON post.ID = meta.post_id&nbsp;</div></li><li><div>            LEFT JOIN `$wpdb-&gt;postmeta` AS meta2 ON post.ID = meta2.post_id&nbsp;</div></li><li><div>            WHERE post.post_type IN ( 'product', 'product_variation' )&nbsp;</div></li><li><div>                AND post.post_status = 'publish'&nbsp;</div></li><li><div>                AND meta.meta_key = '_sale_price'&nbsp;</div></li><li><div>                AND meta2.meta_key = '_price'&nbsp;</div></li><li><div>                AND CAST( meta.meta_value AS DECIMAL ) &gt;= 0&nbsp;</div></li><li><div>                AND CAST( meta.meta_value AS CHAR ) != ''&nbsp;</div></li><li><div>                AND CAST( meta.meta_value AS DECIMAL( 10, {$decimals} ) ) = CAST( meta2.meta_value AS DECIMAL( 10, {$decimals} ) )&nbsp;</div></li><li><div>            GROUP BY post.ID;&nbsp;</div></li><li><div>        &quot; );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a list of product IDs ( id as key =&gt; parent as value) that are&nbsp;</div></li><li><div>     * featured. Uses get_posts instead of wc_get_products since we want&nbsp;</div></li><li><div>     * some extra meta queries and ALL products (posts_per_page = -1).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_featured_product_ids() {&nbsp;</div></li><li><div>        $product_visibility_term_ids = wc_get_product_visibility_term_ids();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return get_posts( array(&nbsp;</div></li><li><div>            'post_type' =&gt; array( 'product', 'product_variation' ), &nbsp;</div></li><li><div>            'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div>            'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>            'tax_query' =&gt; array(&nbsp;</div></li><li><div>                'relation' =&gt; 'AND', &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'taxonomy' =&gt; 'product_visibility', &nbsp;</div></li><li><div>                    'field' =&gt; 'term_taxonomy_id', &nbsp;</div></li><li><div>                    'terms' =&gt; array( $product_visibility_term_ids['featured'] ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'taxonomy' =&gt; 'product_visibility', &nbsp;</div></li><li><div>                    'field' =&gt; 'term_taxonomy_id', &nbsp;</div></li><li><div>                    'terms' =&gt; array( $product_visibility_term_ids['exclude-from-catalog'] ), &nbsp;</div></li><li><div>                    'operator' =&gt; 'NOT IN', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'fields' =&gt; 'id=&gt;parent', &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check if product sku is found for any other product IDs.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param int $product_id&nbsp;</div></li><li><div>     * @param string $sku Will be slashed to work around https://core.trac.wordpress.org/ticket/27421&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function is_existing_sku( $product_id, $sku ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>            SELECT $wpdb-&gt;posts.ID&nbsp;</div></li><li><div>            FROM $wpdb-&gt;posts&nbsp;</div></li><li><div>            LEFT JOIN $wpdb-&gt;postmeta ON ( $wpdb-&gt;posts.ID = $wpdb-&gt;postmeta.post_id )&nbsp;</div></li><li><div>            WHERE $wpdb-&gt;posts.post_type IN ( 'product', 'product_variation' )&nbsp;</div></li><li><div>            AND $wpdb-&gt;posts.post_status != 'trash'&nbsp;</div></li><li><div>            AND $wpdb-&gt;postmeta.meta_key = '_sku' AND $wpdb-&gt;postmeta.meta_value = '%s'&nbsp;</div></li><li><div>            AND $wpdb-&gt;postmeta.post_id &lt;&gt; %d LIMIT 1&nbsp;</div></li><li><div>         &quot;, wp_slash( $sku ), $product_id ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return product ID based on SKU.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param string $sku&nbsp;</div></li><li><div>     * @return int&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_id_by_sku( $sku ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>            SELECT posts.ID&nbsp;</div></li><li><div>            FROM $wpdb-&gt;posts AS posts&nbsp;</div></li><li><div>            LEFT JOIN $wpdb-&gt;postmeta AS postmeta ON ( posts.ID = postmeta.post_id )&nbsp;</div></li><li><div>            WHERE posts.post_type IN ( 'product', 'product_variation' )&nbsp;</div></li><li><div>            AND posts.post_status != 'trash'&nbsp;</div></li><li><div>            AND postmeta.meta_key = '_sku'&nbsp;</div></li><li><div>            AND postmeta.meta_value = '%s'&nbsp;</div></li><li><div>            LIMIT 1&nbsp;</div></li><li><div>         &quot;, $sku ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of IDs of products that have sales starting soon.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_starting_sales() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>            SELECT postmeta.post_id FROM {$wpdb-&gt;postmeta} as postmeta&nbsp;</div></li><li><div>            LEFT JOIN {$wpdb-&gt;postmeta} as postmeta_2 ON postmeta.post_id = postmeta_2.post_id&nbsp;</div></li><li><div>            LEFT JOIN {$wpdb-&gt;postmeta} as postmeta_3 ON postmeta.post_id = postmeta_3.post_id&nbsp;</div></li><li><div>            WHERE postmeta.meta_key = '_sale_price_dates_from'&nbsp;</div></li><li><div>            AND postmeta_2.meta_key = '_price'&nbsp;</div></li><li><div>            AND postmeta_3.meta_key = '_sale_price'&nbsp;</div></li><li><div>            AND postmeta.meta_value &gt; 0&nbsp;</div></li><li><div>            AND postmeta.meta_value &lt; %s&nbsp;</div></li><li><div>            AND postmeta_2.meta_value != postmeta_3.meta_value&nbsp;</div></li><li><div>        &quot;, current_time( 'timestamp', true ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of IDs of products that have sales which are due to end.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_ending_sales() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>            SELECT postmeta.post_id FROM {$wpdb-&gt;postmeta} as postmeta&nbsp;</div></li><li><div>            LEFT JOIN {$wpdb-&gt;postmeta} as postmeta_2 ON postmeta.post_id = postmeta_2.post_id&nbsp;</div></li><li><div>            LEFT JOIN {$wpdb-&gt;postmeta} as postmeta_3 ON postmeta.post_id = postmeta_3.post_id&nbsp;</div></li><li><div>            WHERE postmeta.meta_key = '_sale_price_dates_to'&nbsp;</div></li><li><div>            AND postmeta_2.meta_key = '_price'&nbsp;</div></li><li><div>            AND postmeta_3.meta_key = '_regular_price'&nbsp;</div></li><li><div>            AND postmeta.meta_value &gt; 0&nbsp;</div></li><li><div>            AND postmeta.meta_value &lt; %s&nbsp;</div></li><li><div>            AND postmeta_2.meta_value != postmeta_3.meta_value&nbsp;</div></li><li><div>        &quot;, current_time( 'timestamp', true ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Find a matching (enabled) variation within a variable product.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  3.0.0&nbsp;</div></li><li><div>     * @param  WC_Product $product Variable product.&nbsp;</div></li><li><div>     * @param  array $match_attributes Array of attributes we want to try to match.&nbsp;</div></li><li><div>     * @return int Matching variation ID or 0.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function find_matching_product_variation( $product, $match_attributes = array() ) {&nbsp;</div></li><li><div>        $query_args = array(&nbsp;</div></li><li><div>            'post_parent' =&gt; $product-&gt;get_id(), &nbsp;</div></li><li><div>            'post_type' =&gt; 'product_variation', &nbsp;</div></li><li><div>            'orderby' =&gt; 'menu_order', &nbsp;</div></li><li><div>            'order' =&gt; 'ASC', &nbsp;</div></li><li><div>            'fields' =&gt; 'ids', &nbsp;</div></li><li><div>            'post_status' =&gt; 'publish', &nbsp;</div></li><li><div>            'numberposts' =&gt; 1, &nbsp;</div></li><li><div>            'meta_query' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow large queries in case user has many variations or attributes.&nbsp;</div></li><li><div>        $GLOBALS['wpdb']-&gt;query( 'SET SESSION SQL_BIG_SELECTS=1' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $product-&gt;get_attributes() as $attribute ) {&nbsp;</div></li><li><div>            if ( ! $attribute-&gt;get_variation() ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $attribute_field_name = 'attribute_' . sanitize_title( $attribute-&gt;get_name() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! isset( $match_attributes[ $attribute_field_name ] ) ) {&nbsp;</div></li><li><div>                return 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Note not wc_clean here to prevent removal of entities.&nbsp;</div></li><li><div>            $value = $match_attributes[ $attribute_field_name ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query_args['meta_query'][] = array(&nbsp;</div></li><li><div>                'relation' =&gt; 'OR', &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'key' =&gt; $attribute_field_name, &nbsp;</div></li><li><div>                    'value' =&gt; array( '', $value ), &nbsp;</div></li><li><div>                    'compare' =&gt; 'IN', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'key' =&gt; $attribute_field_name, &nbsp;</div></li><li><div>                    'compare' =&gt; 'NOT EXISTS', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $variations = get_posts( $query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $variations && ! is_wp_error( $variations ) ) {&nbsp;</div></li><li><div>            return current( $variations );&nbsp;</div></li><li><div>         } elseif ( version_compare( get_post_meta( $product-&gt;get_id(), '_product_version', true ), '2.4.0', '&lt;' ) ) {&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Pre 2.4 handling where 'slugs' were saved instead of the full text attribute.&nbsp;</div></li><li><div>             * Fallback is here because there are cases where data will be 'synced' but the product version will remain the same.&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            return ( array_map( 'sanitize_title', $match_attributes ) === $match_attributes ) ? 0 : $this-&gt;find_matching_product_variation( $product, array_map( 'sanitize_title', $match_attributes ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Make sure all variations have a sort order set so they can be reordered correctly.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     *     @param int $parent_id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function sort_all_product_variations( $parent_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_type='product_variation' AND post_parent=%d AND post_status='publish' ORDER BY menu_order ASC, ID ASC&quot;, $parent_id ) );&nbsp;</div></li><li><div>        $index = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $ids as $id ) {&nbsp;</div></li><li><div>            $wpdb-&gt;update( $wpdb-&gt;posts, array( 'menu_order' =&gt; ( $index ++ ) ), array( 'ID' =&gt; absint( $id ) ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return a list of related products (using data like categories and IDs).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param array $cats_array  List of categories IDs.&nbsp;</div></li><li><div>     * @param array $tags_array  List of tags IDs.&nbsp;</div></li><li><div>     * @param array $exclude_ids Excluded IDs.&nbsp;</div></li><li><div>     * @param int   $limit       Limit of results.&nbsp;</div></li><li><div>     * @param int   $product_id&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_related_products( $cats_array, $tags_array, $exclude_ids, $limit, $product_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        return $wpdb-&gt;get_col( implode( ' ', apply_filters( 'woocommerce_product_related_posts_query', $this-&gt;get_related_products_query( $cats_array, $tags_array, $exclude_ids, $limit + 10 ), $product_id ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Builds the related posts query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param array $cats_array  List of categories IDs.&nbsp;</div></li><li><div>     * @param array $tags_array  List of tags IDs.&nbsp;</div></li><li><div>     * @param array $exclude_ids Excluded IDs.&nbsp;</div></li><li><div>     * @param int   $limit       Limit of results.&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_related_products_query( $cats_array, $tags_array, $exclude_ids, $limit ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Arrays to string.&nbsp;</div></li><li><div>        $exclude_ids = implode( ', ', array_map( 'absint', $exclude_ids ) );&nbsp;</div></li><li><div>        $cats_array = implode( ', ', array_map( 'absint', $cats_array ) );&nbsp;</div></li><li><div>        $tags_array = implode( ', ', array_map( 'absint', $tags_array ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $limit = absint( $limit );&nbsp;</div></li><li><div>        $query = array();&nbsp;</div></li><li><div>        $query['fields'] = &quot;SELECT DISTINCT ID FROM {$wpdb-&gt;posts} p&quot;;&nbsp;</div></li><li><div>        $query['join'] = &quot; INNER JOIN {$wpdb-&gt;term_relationships} tr ON (p.ID = tr.object_id)&quot;;&nbsp;</div></li><li><div>        $query['join']  .= &quot; INNER JOIN {$wpdb-&gt;term_taxonomy} tt ON (tr.term_taxonomy_id = tt.term_taxonomy_id)&quot;;&nbsp;</div></li><li><div>        $query['join']  .= &quot; INNER JOIN {$wpdb-&gt;terms} t ON (t.term_id = tt.term_id)&quot;;&nbsp;</div></li><li><div>        $query['where'] = ' WHERE 1=1';&nbsp;</div></li><li><div>        $query['where'] .= &quot; AND p.post_status = 'publish'&quot;;&nbsp;</div></li><li><div>        $query['where'] .= &quot; AND p.post_type = 'product'&quot;;&nbsp;</div></li><li><div>        $query['where'] .= &quot; AND p.ID NOT IN ( {$exclude_ids} )&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_visibility_term_ids = wc_get_product_visibility_term_ids();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product_visibility_term_ids['exclude-from-catalog'] ) {&nbsp;</div></li><li><div>            $query['where'] .= &quot; AND t.term_id !=&quot; . $product_visibility_term_ids['exclude-from-catalog'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'yes' === get_option( 'woocommerce_hide_out_of_stock_items' ) && $product_visibility_term_ids['outofstock'] ) {&nbsp;</div></li><li><div>            $query['where'] .= &quot; AND t.term_id !=&quot; . $product_visibility_term_ids['outofstock'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $cats_array || $tags_array ) {&nbsp;</div></li><li><div>            $query['where'] .= ' AND (';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $cats_array ) {&nbsp;</div></li><li><div>                $query['where'] .= &quot; ( tt.taxonomy = 'product_cat' AND t.term_id IN ( {$cats_array} ) ) &quot;;&nbsp;</div></li><li><div>                if ( $tags_array ) {&nbsp;</div></li><li><div>                    $query['where'] .= ' OR ';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $tags_array ) {&nbsp;</div></li><li><div>                $query['where'] .= &quot; ( tt.taxonomy = 'product_tag' AND t.term_id IN ( {$tags_array} ) ) &quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $query['where'] .= ')';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query['limits'] = &quot; LIMIT {$limit} &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $query;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update a product's stock amount directly.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Uses queries rather than update_post_meta so we can do this in one query (to avoid stock issues).&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  3.0.0 this supports set, increase and decrease.&nbsp;</div></li><li><div>     * @param  int&nbsp;</div></li><li><div>     * @param  int|null $stock_quantity&nbsp;</div></li><li><div>     * @param  string $operation set, increase and decrease.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_product_stock( $product_id_with_stock, $stock_quantity = null, $operation = 'set' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        add_post_meta( $product_id_with_stock, '_stock', 0, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update stock in DB directly&nbsp;</div></li><li><div>        switch ( $operation ) {&nbsp;</div></li><li><div>            case 'increase' :&nbsp;</div></li><li><div>                $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_value = meta_value + %f WHERE post_id = %d AND meta_key='_stock'&quot;, $stock_quantity, $product_id_with_stock ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'decrease' :&nbsp;</div></li><li><div>                $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_value = meta_value - %f WHERE post_id = %d AND meta_key='_stock'&quot;, $stock_quantity, $product_id_with_stock ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_value = %f WHERE post_id = %d AND meta_key='_stock'&quot;, $stock_quantity, $product_id_with_stock ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete( $product_id_with_stock, 'post_meta' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update a product's sale count directly.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Uses queries rather than update_post_meta so we can do this in one query for performance.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  3.0.0 this supports set, increase and decrease.&nbsp;</div></li><li><div>     * @param  int&nbsp;</div></li><li><div>     * @param  int|null $quantity&nbsp;</div></li><li><div>     * @param  string $operation set, increase and decrease.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_product_sales( $product_id, $quantity = null, $operation = 'set' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        add_post_meta( $product_id, 'total_sales', 0, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Update stock in DB directly&nbsp;</div></li><li><div>        switch ( $operation ) {&nbsp;</div></li><li><div>            case 'increase' :&nbsp;</div></li><li><div>                $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_value = meta_value + %f WHERE post_id = %d AND meta_key='total_sales'&quot;, $quantity, $product_id ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'decrease' :&nbsp;</div></li><li><div>                $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_value = meta_value - %f WHERE post_id = %d AND meta_key='total_sales'&quot;, $quantity, $product_id ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_value = %f WHERE post_id = %d AND meta_key='total_sales'&quot;, $quantity, $product_id ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_cache_delete( $product_id, 'post_meta' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update a products average rating meta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_average_rating( $product ) {&nbsp;</div></li><li><div>        update_post_meta( $product-&gt;get_id(), '_wc_average_rating', $product-&gt;get_average_rating( 'edit' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update a products review count meta.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_review_count( $product ) {&nbsp;</div></li><li><div>        update_post_meta( $product-&gt;get_id(), '_wc_review_count', $product-&gt;get_review_count( 'edit' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Update a products rating counts.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param WC_Product $product&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_rating_counts( $product ) {&nbsp;</div></li><li><div>        update_post_meta( $product-&gt;get_id(), '_wc_rating_count', $product-&gt;get_rating_counts( 'edit' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get shipping class ID by slug.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param $slug string&nbsp;</div></li><li><div>     * @return int|false&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_shipping_class_id_by_slug( $slug ) {&nbsp;</div></li><li><div>        $shipping_class_term = get_term_by( 'slug', $slug, 'product_shipping_class' );&nbsp;</div></li><li><div>        if ( $shipping_class_term ) {&nbsp;</div></li><li><div>            return $shipping_class_term-&gt;term_id;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array of products.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  array $args @see wc_get_products&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products( $args = array() ) {&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Generate WP_Query args.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $wp_query_args = array(&nbsp;</div></li><li><div>            'post_type' =&gt; 'variation' === $args['type'] ? 'product_variation' : 'product', &nbsp;</div></li><li><div>            'post_status' =&gt; $args['status'], &nbsp;</div></li><li><div>            'posts_per_page' =&gt; $args['limit'], &nbsp;</div></li><li><div>            'meta_query' =&gt; array(), &nbsp;</div></li><li><div>            'orderby' =&gt; $args['orderby'], &nbsp;</div></li><li><div>            'order' =&gt; $args['order'], &nbsp;</div></li><li><div>            'tax_query' =&gt; array(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        // Do not load unnecessary post data if the user only wants IDs.&nbsp;</div></li><li><div>        if ( 'ids' === $args['return'] ) {&nbsp;</div></li><li><div>            $wp_query_args['fields'] = 'ids';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'variation' !== $args['type'] ) {&nbsp;</div></li><li><div>            $wp_query_args['tax_query'][] = array(&nbsp;</div></li><li><div>                'taxonomy' =&gt; 'product_type', &nbsp;</div></li><li><div>                'field' =&gt; 'slug', &nbsp;</div></li><li><div>                'terms' =&gt; $args['type'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['sku'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['meta_query'][] = array(&nbsp;</div></li><li><div>                'key' =&gt; '_sku', &nbsp;</div></li><li><div>                'value' =&gt; $args['sku'], &nbsp;</div></li><li><div>                'compare' =&gt; 'LIKE', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['category'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['tax_query'][] = array(&nbsp;</div></li><li><div>                'taxonomy' =&gt; 'product_cat', &nbsp;</div></li><li><div>                'field' =&gt; 'slug', &nbsp;</div></li><li><div>                'terms' =&gt; $args['category'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['tag'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['tax_query'][] = array(&nbsp;</div></li><li><div>                'taxonomy' =&gt; 'product_tag', &nbsp;</div></li><li><div>                'field' =&gt; 'slug', &nbsp;</div></li><li><div>                'terms' =&gt; $args['tag'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['shipping_class'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['tax_query'][] = array(&nbsp;</div></li><li><div>                'taxonomy' =&gt; 'product_shipping_class', &nbsp;</div></li><li><div>                'field' =&gt; 'slug', &nbsp;</div></li><li><div>                'terms' =&gt; $args['shipping_class'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_null( $args['parent'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['post_parent'] = absint( $args['parent'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_null( $args['offset'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['offset'] = absint( $args['offset'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $wp_query_args['paged'] = absint( $args['page'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['include'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['post__in'] = array_map( 'absint', $args['include'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $args['exclude'] ) ) {&nbsp;</div></li><li><div>            $wp_query_args['post__not_in'] = array_map( 'absint', $args['exclude'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $args['paginate'] ) {&nbsp;</div></li><li><div>            $wp_query_args['no_found_rows'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Get results.&nbsp;</div></li><li><div>        $products = new WP_Query( $wp_query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'objects' === $args['return'] ) {&nbsp;</div></li><li><div>            $return = array_filter( array_map( 'wc_get_product', $products-&gt;posts ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $return = $products-&gt;posts;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $args['paginate'] ) {&nbsp;</div></li><li><div>            return (object) array(&nbsp;</div></li><li><div>                'products' =&gt; $return, &nbsp;</div></li><li><div>                'total' =&gt; $products-&gt;found_posts, &nbsp;</div></li><li><div>                'max_num_pages' =&gt; $products-&gt;max_num_pages, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Search product data for a term and return ids.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  string $term&nbsp;</div></li><li><div>     * @param  string $type of product&nbsp;</div></li><li><div>     * @param  bool $include_variations in search or not&nbsp;</div></li><li><div>     * @return array of ids&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function search_products( $term, $type = '', $include_variations = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $search_fields = array_map( 'wc_clean', apply_filters( 'woocommerce_product_search_fields', array(&nbsp;</div></li><li><div>            '_sku', &nbsp;</div></li><li><div> ) ) );&nbsp;</div></li><li><div>        $like_term = '%' . $wpdb-&gt;esc_like( $term ) . '%';&nbsp;</div></li><li><div>        $post_types = $include_variations ? array( 'product', 'product_variation' ) : array( 'product' );&nbsp;</div></li><li><div>        $post_statuses = current_user_can( 'edit_private_products' ) ? array( 'private', 'publish' ) : array( 'publish' );&nbsp;</div></li><li><div>        $type_join = '';&nbsp;</div></li><li><div>        $type_where = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $type ) {&nbsp;</div></li><li><div>            if ( in_array( $type, array( 'virtual', 'downloadable' ) ) ) {&nbsp;</div></li><li><div>                $type_join = &quot; LEFT JOIN {$wpdb-&gt;postmeta} postmeta_type ON posts.ID = postmeta_type.post_id &quot;;&nbsp;</div></li><li><div>                $type_where = &quot; AND ( postmeta_type.meta_key = '_{$type}' AND postmeta_type.meta_value = 'yes' ) &quot;;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product_ids = $wpdb-&gt;get_col(&nbsp;</div></li><li><div>            $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>                SELECT DISTINCT posts.ID FROM {$wpdb-&gt;posts} posts&nbsp;</div></li><li><div>                LEFT JOIN {$wpdb-&gt;postmeta} postmeta ON posts.ID = postmeta.post_id&nbsp;</div></li><li><div>                $type_join&nbsp;</div></li><li><div>                WHERE (&nbsp;</div></li><li><div>                    posts.post_title LIKE %s&nbsp;</div></li><li><div>                    OR posts.post_content LIKE %s&nbsp;</div></li><li><div>                    OR (&nbsp;</div></li><li><div>                        postmeta.meta_key = '_sku' AND postmeta.meta_value LIKE %s&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div>                AND posts.post_type IN ('&quot; . implode( &quot;', '&quot;, $post_types ) . &quot;')&nbsp;</div></li><li><div>                AND posts.post_status IN ('&quot; . implode( &quot;', '&quot;, $post_statuses ) . &quot;')&nbsp;</div></li><li><div>                $type_where&nbsp;</div></li><li><div>                ORDER BY posts.post_parent ASC, posts.post_title ASC&nbsp;</div></li><li><div>                &quot;, &nbsp;</div></li><li><div>                $like_term, &nbsp;</div></li><li><div>                $like_term, &nbsp;</div></li><li><div>                $like_term&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_numeric( $term ) ) {&nbsp;</div></li><li><div>            $post_id = absint( $term );&nbsp;</div></li><li><div>            $post_type = get_post_type( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'product_variation' === $post_type && $include_variations ) {&nbsp;</div></li><li><div>                $product_ids[] = $post_id;&nbsp;</div></li><li><div>            } elseif ( 'product' === $post_type ) {&nbsp;</div></li><li><div>                $product_ids[] = $post_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_ids[] = wp_get_post_parent_id( $post_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return wp_parse_id_list( $product_ids );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get the product type based on product ID.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 3.0.0&nbsp;</div></li><li><div>     * @param int $product_id&nbsp;</div></li><li><div>     * @return bool|string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_type( $product_id ) {&nbsp;</div></li><li><div>        $post_type = get_post_type( $product_id );&nbsp;</div></li><li><div>        if ( 'product_variation' === $post_type ) {&nbsp;</div></li><li><div>            return 'variation';&nbsp;</div></li><li><div>        } elseif ( 'product' === $post_type ) {&nbsp;</div></li><li><div>            $terms = get_the_terms( $product_id, 'product_type' );&nbsp;</div></li><li><div>            return ! empty( $terms ) ? sanitize_title( current( $terms )-&gt;name ) : 'simple';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 3.0.2</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/woocommerce/3.0.6/classes/wc_product_data_store_cpt/" class="">3.0.6</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.5/classes/wc_product_data_store_cpt/" class="active">3.0.5</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.4/classes/wc_product_data_store_cpt/" class="">3.0.4</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.3/classes/wc_product_data_store_cpt/" class="">3.0.3</a></li><li><a href="http://hookr.io/plugins/woocommerce/3.0.2/classes/wc_product_data_store_cpt/" class="">3.0.2</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WC_Product_Data_Store_CPT</li><li><span></span>WooCommerce</li><li><span></span>3.0.6</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>