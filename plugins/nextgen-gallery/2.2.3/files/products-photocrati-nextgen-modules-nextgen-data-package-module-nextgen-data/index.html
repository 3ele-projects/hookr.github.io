<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.2.3" data-slug="nextgen-gallery" data-type="file" data-id="65578"><head xmlns="http://www.w3.org/1999/xhtml"><title> products-photocrati-nextgen-modules-nextgen-data-package-module-nextgen-data | file | Nextgen Gallery | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, nextgen-gallery, 2.2.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=a6b7e1795cd6cbd073539517d58ad09f' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/products-photocrati-nextgen-modules-nextgen-data-package-module-nextgen-data/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fproducts-photocrati-nextgen-modules-nextgen-data-package-module-nextgen-data%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fproducts-photocrati-nextgen-modules-nextgen-data-package-module-nextgen-data%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-nextgen-gallery-2.2.3-file-products-photocrati-nextgen-modules-nextgen-data-package-module-nextgen-data","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="products-photocrati-nextgen-modules-nextgen-data-package-module-nextgen-data" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to nextgen-gallery." href="http://hookr.io/plugins/nextgen-gallery/" class="plugin"><span property="name">nextgen-gallery</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.2.3." href="http://hookr.io/plugins/nextgen-gallery/2.2.3/" class="H_VERSION"><span property="name">2.2.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/nextgen-gallery/2.2.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">products-photocrati-nextgen-m&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="783"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/all/" title="All">All <span class="count badge">783</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="157"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/hooks/" title="Hooks">Hooks <span class="count badge">157</span></a></li><li class="" data-id="action" data-count="48"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/actions/" title="Actions">Actions <span class="count badge">48</span></a></li><li class="" data-id="filter" data-count="109"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/filters/" title="Filters">Filters <span class="count badge">109</span></a></li><li class="" data-id="class" data-count="374"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/classes/" title="Classes">Classes <span class="count badge">374</span></a></li><li class="" data-id="constant" data-count="172"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/constants/" title="Constants">Constants <span class="count badge">172</span></a></li><li class="" data-id="function" data-count="79"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/functions/" title="Functions">Functions <span class="count badge">79</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/products/photocrati_nextgen/modules/nextgen_data/package.module.nextgen_data.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Modifies a custom post datamapper to use the WordPress built-in 'attachment'</span>&nbsp;</div></li><li><div><span class="comment"> * custom post type, as used by the Media Library</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @todo Not used yet</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Attachment_DataMapper extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function initialize()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_object_name = 'attachment';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Saves the entity using the wp_insert_attachment function</span>&nbsp;</div></li><li><div><span class="comment">   * instead of the wp_insert_post</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdObject $entity</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _save_entity($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $post = $this-&gt;object-&gt;_convert_entity_to_post($entity);&nbsp;</div></li><li><div>      $filename = property_exists($entity, 'filename') ? $entity-&gt;filename : FALSE;&nbsp;</div></li><li><div>      $primary_key = $this-&gt;object-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      if ($post_id = $attachment_id = wp_insert_attachment($post, $filename)) {&nbsp;</div></li><li><div>          $new_entity = $this-&gt;object-&gt;find($post_id);&nbsp;</div></li><li><div>          foreach ($new_entity as $key =&gt; $value) {&nbsp;</div></li><li><div>              $entity-&gt;{$key} = $value;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Merge meta data with WordPress Attachment Meta Data</span>&nbsp;</div></li><li><div>          if (property_exists($entity, 'meta_data')) {&nbsp;</div></li><li><div>              $meta_data = wp_get_attachment_metadata($attachment_id);&nbsp;</div></li><li><div>              if (isset($meta_data['image_meta'])) {&nbsp;</div></li><li><div>                  $entity-&gt;meta_data = array_merge_recursive($meta_data['image_meta'], $entity-&gt;meta_data);&nbsp;</div></li><li><div>                  wp_update_attachment_metadata($attachment_id, $entity-&gt;meta_data);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Save properties are post meta as well</span>&nbsp;</div></li><li><div>          $this-&gt;object-&gt;_flush_and_update_postmeta($attachment_id, $entity instanceof stdClass ? $entity : $entity-&gt;get_entity(), array('_wp_attached_file', '_wp_attachment_metadata', '_mapper'));&nbsp;</div></li><li><div>          $entity-&gt;id_field = $primary_key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $attachment_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function select($fields = '*')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $ret = $this-&gt;call_parent('select', $fields);&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_query_args['datamapper_attachment'] = true;&nbsp;</div></li><li><div>      return $ret;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_NextGen_Data_Factory</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_Component_Factory</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_Component_Factory</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_NextGen_Data_Factory extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function gallery($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Gallery($properties, $mapper, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function gallery_image($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Image($properties, $mapper, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function image($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Image($properties, $mapper, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function album($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Album($properties, $mapper, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function ngglegacy_gallery_storage($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_NggLegacy_GalleryStorage_Driver($context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function wordpress_gallery_storage($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_WordPress_GalleryStorage_Driver($context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function gallery_storage($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Gallery_Storage($context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function extra_fields($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Datamapper_Model($mapper, $properties, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function gallerystorage($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;gallery_storage($context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Album</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NextGen_Album_Instance_Methods</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Album</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Album extends C_DataMapper_Model&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_mapper_interface = 'I_Album_Mapper';&nbsp;</div></li><li><div>  function define($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($mapper, $properties, $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NextGen_Album_Instance_Methods');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Album');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Instantiates an Album object</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool|\C_DataMapper|\FALSE $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $properties</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function initialize($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Get the mapper is not specified</span></span></span>&nbsp;</div></li><li><div>      if (!$mapper) {&nbsp;</div></li><li><div>          $mapper = $this-&gt;get_registry()-&gt;get_utility($this-&gt;_mapper_interface);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Initialize</span></span></span>&nbsp;</div></li><li><div>      parent::initialize($mapper, $properties);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides instance methods for the album</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_NextGen_Album_Instance_Methods extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function validation()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;validates_presence_of('name');&nbsp;</div></li><li><div>      $this-&gt;validates_numericality_of('previewpic');&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;is_valid();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets all galleries associated with the album</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_galleries($models = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      $mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      $gallery_key = $mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $retval = $mapper-&gt;find_all(array(&quot;{$gallery_key} IN %s&quot;, $this-&gt;object-&gt;sortorder), $models);&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Album_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NextGen_Table_Extras</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Album_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Album_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Album_Mapper extends C_CustomTable_DataMapper_Driver&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  static $_instance = NULL;&nbsp;</div></li><li><div>  function initialize($object_name = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::initialize('ngg_album');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function define($context = FALSE, $not_used = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Define the context</span>&nbsp;</div></li><li><div>      if (!is_array($context)) {&nbsp;</div></li><li><div>          $context = array($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      array_push($context, 'album');&nbsp;</div></li><li><div>      $this-&gt;_primary_key_column = 'id';&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Define the mapper</span></span>&nbsp;</div></li><li><div>      parent::define('ngg_album', $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NextGen_Table_Extras');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Album_Mapper');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Album_Mapper');&nbsp;</div></li><li><div>      $this-&gt;set_model_factory_method('album');&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Define the columns</span></span></span>&nbsp;</div></li><li><div>      $this-&gt;define_column('id', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('name', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('slug', 'VARCHAR(255');&nbsp;</div></li><li><div>      $this-&gt;define_column('previewpic', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('albumdesc', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('sortorder', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('pageid', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('extras_post_id', 'BIGINT', 0);&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Mark the columns which should be unserialized</span></span>&nbsp;</div></li><li><div>      $this-&gt;add_serialized_column('sortorder');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an instance of the album datamapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool|mixed $context</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Album_Mapper</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_instance($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_null(self::$_instance)) {&nbsp;</div></li><li><div>          $klass = get_class();&nbsp;</div></li><li><div>          self::$_instance = new $klass($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides album-specific methods for the datamapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Album_Mapper extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the post title when the Custom Post driver is used</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_DataMapper_Model|C_Album|stdClass $entity</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_post_title($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $entity-&gt;name;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _save_entity($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = $this-&gt;call_parent('_save_entity', $entity);&nbsp;</div></li><li><div>      if ($retval) {&nbsp;</div></li><li><div>          do_action('ngg_album_updated', $entity);&nbsp;</div></li><li><div>          C_Photocrati_Transient_Manager::flush('displayed_gallery_rendering');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets the defaults for an album</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_DataMapper_Model|C_Album|stdClass $entity</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function set_defaults($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'name', '');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'albumdesc', '');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'sortorder', array());&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'previewpic', 0);&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'exclude', 0);&nbsp;</div></li><li><div>      if (isset($entity-&gt;name) && !isset($entity-&gt;slug)) {&nbsp;</div></li><li><div>          $entity-&gt;slug = nggdb::get_unique_slug(sanitize_title($entity-&gt;name), 'album');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_NextGen_Gallery_Validation&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Validates whether the gallery can be saved</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function validation()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// If a title is present, we can auto-populate some other properties</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;title) {&nbsp;</div></li><li><div>          <span class="comment">// Strip html</span>&nbsp;</div></li><li><div>          $this-&gt;object-&gt;title = M_NextGen_Data::strip_html($this-&gt;object-&gt;title, TRUE);&nbsp;</div></li><li><div>          $sanitized_title = str_replace(' ', '-', $this-&gt;object-&gt;title);&nbsp;</div></li><li><div>          if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {&nbsp;</div></li><li><div>              $sanitized_title = remove_accents($sanitized_title);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// If no name is present, use the title to generate one</span>&nbsp;</div></li><li><div>          if (!$this-&gt;object-&gt;name) {&nbsp;</div></li><li><div>              $this-&gt;object-&gt;name = apply_filters('ngg_gallery_name', sanitize_file_name($sanitized_title));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// If no slug is set, use the title to generate one</span>&nbsp;</div></li><li><div>          if (!$this-&gt;object-&gt;slug) {&nbsp;</div></li><li><div>              $this-&gt;object-&gt;slug = preg_replace('|[^a-z0-9 \\-~+_.#=!&;, /:%@$\\|*\'()\\x80-\\xff]|i', '', $sanitized_title);&nbsp;</div></li><li><div>              $this-&gt;object-&gt;slug = nggdb::get_unique_slug($this-&gt;object-&gt;slug, 'gallery');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Set what will be the path to the gallery</span>&nbsp;</div></li><li><div>      if (!$this-&gt;object-&gt;path) {&nbsp;</div></li><li><div>          $storage = C_Gallery_Storage::get_instance();&nbsp;</div></li><li><div>          $this-&gt;object-&gt;path = $storage-&gt;get_upload_relpath($this-&gt;object);&nbsp;</div></li><li><div>          unset($storage);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;path = M_NextGen_Data::strip_html($this-&gt;object-&gt;path);&nbsp;</div></li><li><div>          $this-&gt;object-&gt;path = str_replace(array('&quot;', &quot;''&quot;, &quot;&gt;&quot;, &quot;&lt;&quot;), array('', '', '', ''), $this-&gt;object-&gt;path);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('title');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('name');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_uniqueness_of('slug');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_numericality_of('author');&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;is_valid();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Creates a model representing a NextGEN Gallery object</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NextGen_Gallery_Validation</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Gallery</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Gallery extends C_DataMapper_Model&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_mapper_interface = 'I_Gallery_Mapper';&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines the interfaces and methods (through extensions and hooks)</span>&nbsp;</div></li><li><div><span class="comment">   * that this class provides</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function define($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($mapper, $properties, $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NextGen_Gallery_Validation');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Gallery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Instantiates a new model</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|stdClass $properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_DataMapper $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function initialize($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Get the mapper is not specified</span></span></span>&nbsp;</div></li><li><div>      if (!$mapper) {&nbsp;</div></li><li><div>          $mapper = $this-&gt;get_registry()-&gt;get_utility($this-&gt;_mapper_interface);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Initialize</span></span></span>&nbsp;</div></li><li><div>      parent::initialize($mapper, $properties);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_images()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>      return $mapper-&gt;select()-&gt;where(array('galleryid = %d', $this-&gt;gid))-&gt;order_by('sortorder')-&gt;run_query();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides a datamapper for galleries</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NextGen_Table_Extras</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Gallery_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Gallery_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Gallery_Mapper extends C_CustomTable_DataMapper_Driver&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public static $_instance = NULL;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Define the object</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function define($context = FALSE, $not_used = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Add 'gallery' context</span>&nbsp;</div></li><li><div>      if (!is_array($context)) {&nbsp;</div></li><li><div>          $context = array($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      array_push($context, 'gallery');&nbsp;</div></li><li><div>      $this-&gt;_primary_key_column = 'gid';&nbsp;</div></li><li><div>      <span class="comment">// Continue defining the object</span>&nbsp;</div></li><li><div>      parent::define('ngg_gallery', $context);&nbsp;</div></li><li><div>      $this-&gt;set_model_factory_method('gallery');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NextGen_Table_Extras');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Gallery_Mapper');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Gallery_Mapper');&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Define the columns</span></span></span>&nbsp;</div></li><li><div>      $this-&gt;define_column('gid', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('name', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('slug', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('path', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('title', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('pageid', 'INT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('previewpic', 'INT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('author', 'INT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('extras_post_id', 'BIGINT', 0);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function initialize($object_name = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::initialize('ngg_gallery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a singleton of the gallery mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Gallery_Mapper</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_instance($context = False)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_null(self::$_instance)) {&nbsp;</div></li><li><div>          $klass = get_class();&nbsp;</div></li><li><div>          self::$_instance = new $klass($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_Gallery_Mapper extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Uses the title property as the post title when the Custom Post driver</span>&nbsp;</div></li><li><div><span class="comment">   * is used</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_post_title($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $entity-&gt;title;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _save_entity($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// A bug in NGG 2.1.24 allowed galleries to be created with spaces in the directory name, unreplaced by dashes</span>&nbsp;</div></li><li><div>      <span class="comment">// This causes a few problems everywhere, so we here allow users a way to fix those galleries by just re-saving</span>&nbsp;</div></li><li><div>      if (FALSE !== strpos($entity-&gt;path, ' ')) {&nbsp;</div></li><li><div>          $storage = C_Gallery_Storage::get_instance();&nbsp;</div></li><li><div>          $abspath = $storage-&gt;get_gallery_abspath($entity-&gt;{$entity-&gt;id_field});&nbsp;</div></li><li><div>          $pre_path = $entity-&gt;path;&nbsp;</div></li><li><div>          $entity-&gt;path = str_replace(' ', '-', $entity-&gt;path);&nbsp;</div></li><li><div>          $new_abspath = str_replace($pre_path, $entity-&gt;path, $abspath);&nbsp;</div></li><li><div>          <span class="comment">// Begin adding -1, -2, etc until we have a safe target: rename() will overwrite existing directories</span>&nbsp;</div></li><li><div>          if (@file_exists($new_abspath)) {&nbsp;</div></li><li><div>              $max_count = 100;&nbsp;</div></li><li><div>              $count = 0;&nbsp;</div></li><li><div>              $corrected_abspath = $new_abspath;&nbsp;</div></li><li><div>              while (@file_exists($corrected_abspath) && $count &lt;= $max_count) {&nbsp;</div></li><li><div>                  $count++;&nbsp;</div></li><li><div>                  $corrected_abspath = $new_abspath . '-' . $count;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $new_abspath = $corrected_abspath;&nbsp;</div></li><li><div>              $entity-&gt;path = $entity-&gt;path . '-' . $count;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          @rename($abspath, $new_abspath);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $slug = $entity-&gt;slug;&nbsp;</div></li><li><div>      $entity-&gt;slug = str_replace(' ', '-', $entity-&gt;slug);&nbsp;</div></li><li><div>      <span class="comment">// Note: we do the following to mimic the behaviour of esc_url so that slugs are always valid in URLs after escaping</span>&nbsp;</div></li><li><div>      $entity-&gt;slug = preg_replace('|[^a-z0-9 \\-~+_.#=!&;, /:%@$\\|*\'()\\x80-\\xff]|i', '', $entity-&gt;slug);&nbsp;</div></li><li><div>      if ($slug != $entity-&gt;slug) {&nbsp;</div></li><li><div>          <span class="comment">// creating new slug for the gallery</span>&nbsp;</div></li><li><div>          $entity-&gt;slug = nggdb::get_unique_slug($entity-&gt;slug, 'gallery');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = $this-&gt;call_parent('_save_entity', $entity);&nbsp;</div></li><li><div>      if ($retval) {&nbsp;</div></li><li><div>          do_action('ngg_created_new_gallery', $entity-&gt;{$entity-&gt;id_field});&nbsp;</div></li><li><div>          C_Photocrati_Transient_Manager::flush('displayed_gallery_rendering');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function destroy($gallery, $with_dependencies = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if ($gallery) {&nbsp;</div></li><li><div>          $gallery_id = is_numeric($gallery) ? $gallery : $gallery-&gt;{$gallery-&gt;id_field};&nbsp;</div></li><li><div>          <span class="comment">// TODO: Look into making this operation more efficient</span>&nbsp;</div></li><li><div>          if ($with_dependencies) {&nbsp;</div></li><li><div>              $image_mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>              <span class="comment">// Delete the image files from the filesystem</span>&nbsp;</div></li><li><div>              $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>              if ($settings-&gt;deleteImg) {&nbsp;</div></li><li><div>                  $storage = C_Gallery_Storage::get_instance();&nbsp;</div></li><li><div>                  $storage-&gt;delete_gallery($gallery);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Delete the image records from the DB</span>&nbsp;</div></li><li><div>              $image_mapper-&gt;delete()-&gt;where(array(&quot;galleryid = %d&quot;, $gallery_id))-&gt;run_query();&nbsp;</div></li><li><div>              $image_key = $image_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>              $image_table = $image_mapper-&gt;get_table_name();&nbsp;</div></li><li><div>              <span class="comment">// Delete tag associations no longer needed. The following SQL statement</span>&nbsp;</div></li><li><div>              <span class="comment">// deletes all tag associates for images that no longer exist</span>&nbsp;</div></li><li><div>              global $wpdb;&nbsp;</div></li><li><div>              $wpdb-&gt;query(&quot;\n\t\t\t\t\tDELETE wptr.* FROM {$wpdb-&gt;term_relationships} wptr\n\t\t\t\t\tINNER JOIN {$wpdb-&gt;term_taxonomy} wptt\n\t\t\t\t\tON wptt.term_taxonomy_id = wptr.term_taxonomy_id\n\t\t\t\t\tWHERE wptt.term_taxonomy_id = wptr.term_taxonomy_id\n\t\t\t\t\tAND wptt.taxonomy = 'ngg_tag'\n\t\t\t\t\tAND wptr.object_id NOT IN (SELECT {$image_key} FROM {$image_table})&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = $this-&gt;call_parent('destroy', $gallery);&nbsp;</div></li><li><div>          if ($retval) {&nbsp;</div></li><li><div>              do_action('ngg_delete_gallery', $gallery);&nbsp;</div></li><li><div>              C_Photocrati_Transient_Manager::flush('displayed_gallery_rendering');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function set_preview_image($gallery, $image, $only_if_empty = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// We need the gallery object</span>&nbsp;</div></li><li><div>      if (is_numeric($gallery)) {&nbsp;</div></li><li><div>          $gallery = $this-&gt;object-&gt;find($gallery);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// We need the image id</span>&nbsp;</div></li><li><div>      if (!is_numeric($image)) {&nbsp;</div></li><li><div>          if (method_exists($image, 'id')) {&nbsp;</div></li><li><div>              $image = $image-&gt;id();&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $image = $image-&gt;{$image-&gt;id_field};&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($gallery && $image) {&nbsp;</div></li><li><div>          if ($only_if_empty && !$gallery-&gt;previewpic or !$only_if_empty) {&nbsp;</div></li><li><div>              $gallery-&gt;previewpic = $image;&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;save($gallery);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets default values for the gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function set_defaults($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// If author is missing, then set to the current user id</span>&nbsp;</div></li><li><div>      <span class="comment">// TODO: Using wordpress function. Should use abstraction</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'author', get_current_user_id());&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class GalleryStorageDriverNotSelectedException extends RuntimeException&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function __construct($message = '', $code = NULL, $previous = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$message) {&nbsp;</div></li><li><div>          $message = &quot;No gallery storage driver selected.&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      parent::__construct($message, $code, $previous);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_GalleryStorage extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the name of the class which provides the gallerystorage</span>&nbsp;</div></li><li><div><span class="comment">   * implementation</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_driver_factory_method($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $factory_method = '';&nbsp;</div></li><li><div>      <span class="comment">// No constant has been defined to establish a global gallerystorage driver</span>&nbsp;</div></li><li><div>      if (!defined('GALLERYSTORAGE_DRIVER')) {&nbsp;</div></li><li><div>          <span class="comment">// Get the datamapper configured in the database</span>&nbsp;</div></li><li><div>          $factory_method = C_NextGen_Settings::get_instance()-&gt;gallerystorage_driver;&nbsp;</div></li><li><div>          <span class="comment">// Define a constant and use this as the global gallerystorage driver, </span>&nbsp;</div></li><li><div>          <span class="comment">// unless running in a SimpleTest Environment</span>&nbsp;</div></li><li><div>          if (!isset($GLOBALS['SIMPLE_TEST_RUNNING'])) {&nbsp;</div></li><li><div>              define('GALLERYSTORAGE_DRIVER', $factory_method);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $factory_method = GALLERYSTORAGE_DRIVER;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $factory_method;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_GalleryStorage_Base extends C_Component&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url or path of an image of a particular size</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $method</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __call($method, $args)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (preg_match(&quot;/^get_(\\w+)_(abspath|url|dimensions|html|size_params)\$/&quot;, $method, $match)) {&nbsp;</div></li><li><div>          if (isset($match[1]) && isset($match[2]) && !$this-&gt;has_method($method)) {&nbsp;</div></li><li><div>              $method = 'get_image_' . $match[2];&nbsp;</div></li><li><div>              $args[] = $match[1];&nbsp;</div></li><li><div>              <span class="comment">// array($image, $size)</span>&nbsp;</div></li><li><div>              return parent::__call($method, $args);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return parent::__call($method, $args);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Gallery_Storage</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_GalleryStorage</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Gallery_Storage</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Gallery_Storage extends C_GalleryStorage_Base&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public static $_instances = array();&nbsp;</div></li><li><div>  function define($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_GalleryStorage');&nbsp;</div></li><li><div>      $this-&gt;wrap('I_GalleryStorage_Driver', array(&$this, '_get_driver'), $context);&nbsp;</div></li><li><div>      $this-&gt;implement('I_Gallery_Storage');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  static function get_instance($context = False)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instances[$context])) {&nbsp;</div></li><li><div>          self::$_instances[$context] = new C_Gallery_Storage($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instances[$context];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the implementation for the gallerystorage</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $args</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_driver($context)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $factory_method = $this-&gt;_get_driver_factory_method($context);&nbsp;</div></li><li><div>      $factory = C_Component_Factory::get_instance();&nbsp;</div></li><li><div>      return $factory-&gt;create($factory_method, FALSE, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class E_UploadException extends E_NggErrorException&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function __construct($message = '', $code = NULL, $previous = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$message) {&nbsp;</div></li><li><div>          $message = &quot;There was a problem uploading the file.&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (PHP_VERSION_ID &gt;= 50300) {&nbsp;</div></li><li><div>          parent::__construct($message, $code, $previous);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          parent::__construct($message, $code);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class E_InsufficientWriteAccessException extends E_NggErrorException&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function __construct($message = FALSE, $filename = NULL, $code = NULL, $previous = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$message) {&nbsp;</div></li><li><div>          $message = &quot;Could not write to file. Please check filesystem permissions.&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($filename) {&nbsp;</div></li><li><div>          $message .= &quot; Filename: {$filename}&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (PHP_VERSION_ID &gt;= 50300) {&nbsp;</div></li><li><div>          parent::__construct($message, $code, $previous);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          parent::__construct($message, $code);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class E_NoSpaceAvailableException extends E_NggErrorException&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function __construct($message = '', $code = NULL, $previous = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$message) {&nbsp;</div></li><li><div>          $message = &quot;You have exceeded your storage capacity. Please remove some files and try again.&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (PHP_VERSION_ID &gt;= 50300) {&nbsp;</div></li><li><div>          parent::__construct($message, $code, $previous);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          parent::__construct($message, $code);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class E_No_Image_Library_Exception extends E_NggErrorException&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function __construct($message = '', $code = NULL, $previous = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$message) {&nbsp;</div></li><li><div>          $message = &quot;The site does not support the GD Image library. Please ask your hosting provider to enable it.&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (PHP_VERSION_ID &gt;= 50300) {&nbsp;</div></li><li><div>          parent::__construct($message, $code, $previous);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          parent::__construct($message, $code);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_GalleryStorage_Driver_Base extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set correct file permissions (taken from wp core). Should be called</span>&nbsp;</div></li><li><div><span class="comment">   * after writing any file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @class nggAdmin</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $filename</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool $result</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _chmod($filename = '')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $stat = @stat(dirname($filename));&nbsp;</div></li><li><div>      $perms = $stat['mode'] & 0666;&nbsp;</div></li><li><div>      <span class="comment">// Remove execute bits for files</span>&nbsp;</div></li><li><div>      if (@chmod($filename, $perms)) {&nbsp;</div></li><li><div>          return TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return FALSE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the id of a gallery, regardless of whether an integer</span>&nbsp;</div></li><li><div><span class="comment">   * or object was passed as an argument</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $gallery_obj_or_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_gallery_id($gallery_obj_or_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $gallery_key = $this-&gt;object-&gt;_gallery_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      if (is_object($gallery_obj_or_id)) {&nbsp;</div></li><li><div>          if (isset($gallery_obj_or_id-&gt;{$gallery_key})) {&nbsp;</div></li><li><div>              $retval = $gallery_obj_or_id-&gt;{$gallery_key};&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif (is_numeric($gallery_obj_or_id)) {&nbsp;</div></li><li><div>          $retval = $gallery_obj_or_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the id of an image, regardless of whether an integer</span>&nbsp;</div></li><li><div><span class="comment">   * or object was passed as an argument</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $image_obj_or_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_image_id($image_obj_or_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $image_key = $this-&gt;object-&gt;_image_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      if (is_object($image_obj_or_id)) {&nbsp;</div></li><li><div>          if (isset($image_obj_or_id-&gt;{$image_key})) {&nbsp;</div></li><li><div>              $retval = $image_obj_or_id-&gt;{$image_key};&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif (is_numeric($image_obj_or_id)) {&nbsp;</div></li><li><div>          $retval = $image_obj_or_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function convert_slashes($path)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $search = array('/', &quot;\\&quot;);&nbsp;</div></li><li><div>      $replace = array(DIRECTORY_SEPARATOR, DIRECTORY_SEPARATOR);&nbsp;</div></li><li><div>      return str_replace($search, $replace, $path);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function delete_directory($abspath)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if (@file_exists($abspath)) {&nbsp;</div></li><li><div>          $files = scandir($abspath);&nbsp;</div></li><li><div>          array_shift($files);&nbsp;</div></li><li><div>          array_shift($files);&nbsp;</div></li><li><div>          foreach ($files as $file) {&nbsp;</div></li><li><div>              $file_abspath = implode(DIRECTORY_SEPARATOR, array(rtrim($abspath, &quot;/\\&quot;), $file));&nbsp;</div></li><li><div>              if (is_dir($file_abspath)) {&nbsp;</div></li><li><div>                  $this-&gt;object-&gt;delete_directory($file_abspath);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  unlink($file_abspath);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          rmdir($abspath);&nbsp;</div></li><li><div>          $retval = @file_exists($abspath);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Backs up an image file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function backup_image($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $image_path = $this-&gt;object-&gt;get_image_abspath($image);&nbsp;</div></li><li><div>      if ($image_path && @file_exists($image_path)) {&nbsp;</div></li><li><div>          $retval = copy($image_path, $this-&gt;object-&gt;get_backup_abspath($image));&nbsp;</div></li><li><div>          <span class="comment">// Store the dimensions of the image</span>&nbsp;</div></li><li><div>          if (function_exists('getimagesize')) {&nbsp;</div></li><li><div>              $mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>              if (!is_object($image)) {&nbsp;</div></li><li><div>                  $image = $mapper-&gt;find($image);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($image) {&nbsp;</div></li><li><div>                  if (!property_exists($image, 'meta_data')) {&nbsp;</div></li><li><div>                      $image-&gt;meta_data = array();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $dimensions = getimagesize($image_path);&nbsp;</div></li><li><div>                  $image-&gt;meta_data['backup'] = array('filename' =&gt; basename($image_path), 'width' =&gt; $dimensions[0], 'height' =&gt; $dimensions[1], 'generated' =&gt; microtime());&nbsp;</div></li><li><div>                  $mapper-&gt;save($image);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Copies images into another gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $images</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $db optionally only copy the image files</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $move move the image instead of copying</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function copy_images($images, $gallery, $db = TRUE, $move = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Ensure we have a valid gallery</span></span>&nbsp;</div></li><li><div>      if ($gallery = $this-&gt;object-&gt;_get_gallery_id($gallery)) {&nbsp;</div></li><li><div>          $gallery_path = $this-&gt;object-&gt;get_gallery_abspath($gallery);&nbsp;</div></li><li><div>          $image_key = $this-&gt;object-&gt;_image_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>          $retval = TRUE;&nbsp;</div></li><li><div>          <span class="comment">// Iterate through each image to copy...</span>&nbsp;</div></li><li><div>          foreach ($images as $image) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Copy each image size</span></span>&nbsp;</div></li><li><div>              foreach ($this-&gt;object-&gt;get_image_sizes() as $size) {&nbsp;</div></li><li><div>                  $image_path = $this-&gt;object-&gt;get_image_abspath($image, $size);&nbsp;</div></li><li><div>                  $dst = implode(DIRECTORY_SEPARATOR, array($gallery_path, M_I18n::mb_basename($image_path)));&nbsp;</div></li><li><div>                  $success = $move ? move($image_path, $dst) : copy($image_path, $dst);&nbsp;</div></li><li><div>                  if (!$success) {&nbsp;</div></li><li><div>                      $retval = FALSE;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Copy the db entry</span>&nbsp;</div></li><li><div>              if ($db) {&nbsp;</div></li><li><div>                  if (is_numeric($image)) {&nbsp;</div></li><li><div>                      $this-&gt;object-&gt;_image_mapper($image);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  unset($image-&gt;{$image_key});&nbsp;</div></li><li><div>                  $image-&gt;galleryid = $gallery;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Empties the gallery cache directory of content</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function flush_cache($gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $cache = C_Cache::get_instance();&nbsp;</div></li><li><div>      $cache-&gt;flush_directory($this-&gt;object-&gt;get_cache_abspath($gallery));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the absolute path of the backup of an original image</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_backup_abspath($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = null;&nbsp;</div></li><li><div>      if ($image_path = $this-&gt;object-&gt;get_image_abspath($image)) {&nbsp;</div></li><li><div>          $retval = $image_path . '_backup';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_backup_dimensions($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_dimensions($image, 'backup');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_backup_url($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_url($image, 'backup');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the absolute path to the cache directory of a gallery.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Without the gallery parameter the legacy (pre 2.0) shared directory is returned.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Gallery $gallery (optional)</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Absolute path to cache directory</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_cache_abspath($gallery = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      if (FALSE == $gallery) {&nbsp;</div></li><li><div>          $gallerypath = C_NextGen_Settings::get_instance()-&gt;gallerypath;&nbsp;</div></li><li><div>          $retval = implode(DIRECTORY_SEPARATOR, array(rtrim(C_Fs::get_instance()-&gt;get_document_root('gallery'), &quot;/\\&quot;), rtrim($gallerypath, &quot;/\\&quot;), 'cache'));&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if (is_numeric($gallery)) {&nbsp;</div></li><li><div>              $gallery = $this-&gt;object-&gt;_gallery_mapper-&gt;find($gallery);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = rtrim(implode(DIRECTORY_SEPARATOR, array($this-&gt;object-&gt;get_gallery_abspath($gallery), 'dynamic')), &quot;/\\&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the absolute path where the full-sized image is stored</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_full_abspath($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_abspath($image, 'full');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alias to get_image_dimensions()</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_full_dimensions($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_dimensions($image, 'full');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alias to get_image_html()</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_full_html($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_html($image, 'full');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alias for get_original_url()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Image $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_full_url($image, $check_existance = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_url($image, 'full', $check_existance);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_image_checksum($image, $size = 'full')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      if ($image_abspath = $this-&gt;get_image_abspath($image, $size, TRUE)) {&nbsp;</div></li><li><div>          $retval = md5_file($image_abspath);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the dimensions for a particular-sized image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $size</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_dimensions($image, $size = 'full')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      <span class="comment">// If an image id was provided, get the entity</span>&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Ensure we have a valid image</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          <span class="comment">// Adjust size parameter</span>&nbsp;</div></li><li><div>          switch ($size) {&nbsp;</div></li><li><div>              case 'original':&nbsp;</div></li><li><div>                  $size = 'full';&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'thumbnails':&nbsp;</div></li><li><div>              case 'thumbnail':&nbsp;</div></li><li><div>              case 'thumb':&nbsp;</div></li><li><div>              case 'thumbs':&nbsp;</div></li><li><div>                  $size = 'thumbnail';&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Image dimensions are stored in the $image-&gt;meta_data</span>&nbsp;</div></li><li><div>          <span class="comment">// property for all implementations</span>&nbsp;</div></li><li><div>          if (isset($image-&gt;meta_data) && isset($image-&gt;meta_data[$size])) {&nbsp;</div></li><li><div>              $retval = $image-&gt;meta_data[$size];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $abspath = $this-&gt;object-&gt;get_image_abspath($image, $size);&nbsp;</div></li><li><div>              if (@file_exists($abspath)) {&nbsp;</div></li><li><div>                  $dims = getimagesize($abspath);&nbsp;</div></li><li><div>                  if ($dims) {&nbsp;</div></li><li><div>                      $retval['width'] = $dims[0];&nbsp;</div></li><li><div>                      $retval['height'] = $dims[1];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ($size == 'backup') {&nbsp;</div></li><li><div>                  $retval = $this-&gt;object-&gt;get_image_dimensions($image, 'full');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the HTML for an image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $size</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_html($image, $size = 'full', $attributes = array())&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = &quot;&quot;;&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          <span class="comment">// Set alt text if not already specified</span>&nbsp;</div></li><li><div>          if (!isset($attributes['alttext'])) {&nbsp;</div></li><li><div>              $attributes['alt'] = esc_attr($image-&gt;alttext);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Set the title if not already set</span>&nbsp;</div></li><li><div>          if (!isset($attributes['title'])) {&nbsp;</div></li><li><div>              $attributes['title'] = esc_attr($image-&gt;alttext);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Set the dimensions if not set already</span>&nbsp;</div></li><li><div>          if (!isset($attributes['width']) or !isset($attributes['height'])) {&nbsp;</div></li><li><div>              $dimensions = $this-&gt;object-&gt;get_image_dimensions($image, $size);&nbsp;</div></li><li><div>              if (!isset($attributes['width'])) {&nbsp;</div></li><li><div>                  $attributes['width'] = $dimensions['width'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!isset($attributes['height'])) {&nbsp;</div></li><li><div>                  $attributes['height'] = $dimensions['height'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Set the url if not already specified</span>&nbsp;</div></li><li><div>          if (!isset($attributes['src'])) {&nbsp;</div></li><li><div>              $attributes['src'] = $this-&gt;object-&gt;get_image_url($image, $size);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Format attributes</span>&nbsp;</div></li><li><div>          $attribs = array();&nbsp;</div></li><li><div>          foreach ($attributes as $attrib =&gt; $value) {&nbsp;</div></li><li><div>              $attribs[] = &quot;{$attrib}=\&quot;{$value}\&quot;&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $attribs = implode(&quot; &quot;, $attribs);&nbsp;</div></li><li><div>          <span class="comment">// Return HTML string</span>&nbsp;</div></li><li><div>          $retval = &quot;&lt;img {$attribs} /&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * An alias for get_full_abspath()</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_original_abspath($image, $check_existance = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_abspath($image, 'full', $check_existance);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alias to get_image_dimensions()</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_original_dimensions($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_dimensions($image, 'full');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Alias to get_image_html()</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_original_html($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_html($image, 'full');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url to the original-sized image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Image $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_original_url($image, $check_existance = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_image_url($image, 'full', $check_existance);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the upload path, optionally for a particular gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|C_Gallery|stdClass $gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_upload_relpath($gallery = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>      $retval = str_replace($fs-&gt;get_document_root('gallery'), '', $this-&gt;object-&gt;get_upload_abspath($gallery));&nbsp;</div></li><li><div>      return DIRECTORY_SEPARATOR . ltrim($retval, &quot;/\\&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Moves images from to another gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $images</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $db optionally only move the image files, not the db entries</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function move_images($images, $gallery, $db = TRUE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;copy_images($images, $gallery, $db, TRUE);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_image_file($filename = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if (!$filename && isset($_FILES['file']) && $_FILES['file']['error'] == 0) {&nbsp;</div></li><li><div>          $filename = $_FILES['file']['tmp_name'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $valid_types = array('image/gif', 'image/jpg', 'image/jpeg', 'image/pjpeg', 'image/png');&nbsp;</div></li><li><div>      <span class="comment">// If we can, we'll verify the mime type</span>&nbsp;</div></li><li><div>      if (function_exists('exif_imagetype')) {&nbsp;</div></li><li><div>          if (($image_type = @exif_imagetype($filename)) !== FALSE) {&nbsp;</div></li><li><div>              $retval = in_array(image_type_to_mime_type($image_type), $valid_types);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $file_info = @getimagesize($filename);&nbsp;</div></li><li><div>          if (isset($file_info[2])) {&nbsp;</div></li><li><div>              $retval = in_array(image_type_to_mime_type($file_info[2]), $valid_types);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_zip()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if (isset($_FILES['file']) && $_FILES['file']['error'] == 0) {&nbsp;</div></li><li><div>          $file_info = $_FILES['file'];&nbsp;</div></li><li><div>          if (isset($file_info['type'])) {&nbsp;</div></li><li><div>              $type = $file_info['type'];&nbsp;</div></li><li><div>              $type_parts = explode('/', $type);&nbsp;</div></li><li><div>              if (strtolower($type_parts[0]) == 'application') {&nbsp;</div></li><li><div>                  $spec = $type_parts[1];&nbsp;</div></li><li><div>                  $spec_parts = explode('-', $spec);&nbsp;</div></li><li><div>                  $spec_parts = array_map('strtolower', $spec_parts);&nbsp;</div></li><li><div>                  if (in_array($spec, array('zip', 'octet-stream')) || in_array('zip', $spec_parts)) {&nbsp;</div></li><li><div>                      $retval = true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function upload_zip($gallery_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $memory_limit = intval(ini_get('memory_limit'));&nbsp;</div></li><li><div>      if (!extension_loaded('suhosin') && $memory_limit &lt; 256) {&nbsp;</div></li><li><div>          @ini_set('memory_limit', '256M');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;is_zip()) {&nbsp;</div></li><li><div>          $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>          <span class="comment">// Uses the WordPress ZIP abstraction API</span>&nbsp;</div></li><li><div>          include_once $fs-&gt;join_paths(ABSPATH, 'wp-admin', 'includes', 'file.php');&nbsp;</div></li><li><div>          WP_Filesystem();&nbsp;</div></li><li><div>          <span class="comment">// Ensure that we truly have the gallery id</span>&nbsp;</div></li><li><div>          $gallery_id = $this-&gt;_get_gallery_id($gallery_id);&nbsp;</div></li><li><div>          $zipfile = $_FILES['file']['tmp_name'];&nbsp;</div></li><li><div>          $dest_path = implode(DIRECTORY_SEPARATOR, array(rtrim(get_temp_dir(), &quot;/\\&quot;), 'unpacked-' . M_I18n::mb_basename($zipfile)));&nbsp;</div></li><li><div>          wp_mkdir_p($dest_path);&nbsp;</div></li><li><div>          if (unzip_file($zipfile, $dest_path) === TRUE) {&nbsp;</div></li><li><div>              $dest_dir = $dest_path . DIRECTORY_SEPARATOR;&nbsp;</div></li><li><div>              $files = glob($dest_dir . '*');&nbsp;</div></li><li><div>              $size = 0;&nbsp;</div></li><li><div>              foreach ($files as $file) {&nbsp;</div></li><li><div>                  if (is_file($dest_dir . $file)) {&nbsp;</div></li><li><div>                      $size += filesize($dest_dir . $file);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($size == 0) {&nbsp;</div></li><li><div>                  $this-&gt;object-&gt;delete_directory($dest_path);&nbsp;</div></li><li><div>                  $destination = wp_upload_dir();&nbsp;</div></li><li><div>                  $destination_path = $destination['basedir'];&nbsp;</div></li><li><div>                  $dest_path = implode(DIRECTORY_SEPARATOR, array(rtrim($destination_path, &quot;/\\&quot;), 'unpacked-' . M_I18n::mb_basename($zipfile)));&nbsp;</div></li><li><div>                  wp_mkdir_p($dest_path);&nbsp;</div></li><li><div>                  if (unzip_file($zipfile, $dest_path) === TRUE) {&nbsp;</div></li><li><div>                      $retval = $this-&gt;object-&gt;import_gallery_from_fs($dest_path, $gallery_id);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $retval = $this-&gt;object-&gt;import_gallery_from_fs($dest_path, $gallery_id);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;object-&gt;delete_directory($dest_path);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!extension_loaded('suhosin')) {&nbsp;</div></li><li><div>          @ini_set('memory_limit', $memory_limit . 'M');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_current_user_over_quota()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>      if (is_multisite() && $settings-&gt;get('wpmuQuotaCheck')) {&nbsp;</div></li><li><div>          require_once ABSPATH . 'wp-admin/includes/ms.php';&nbsp;</div></li><li><div>          $retval = upload_is_user_over_quota(FALSE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Uploads base64 file to a gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Gallery $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data base64-encoded string of data representing the image</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $filename specifies the name of the file</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function upload_base64_image($gallery, $data, $filename = FALSE, $image_id = FALSE, $override = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>      $memory_limit = intval(ini_get('memory_limit'));&nbsp;</div></li><li><div>      if (!extension_loaded('suhosin') && $memory_limit &lt; 256) {&nbsp;</div></li><li><div>          @ini_set('memory_limit', '256M');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      if ($gallery_id = $this-&gt;object-&gt;_get_gallery_id($gallery)) {&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;is_current_user_over_quota()) {&nbsp;</div></li><li><div>              $message = sprintf(__('Sorry, you have used your space allocation. Please delete some files to upload more files.', 'nggallery'));&nbsp;</div></li><li><div>              throw new E_NoSpaceAvailableException($message);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Get path information. The use of get_upload_abspath() might</span>&nbsp;</div></li><li><div>          <span class="comment">// not be the best for some drivers. For example, if using the</span>&nbsp;</div></li><li><div>          <span class="comment">// WordPress Media Library for uploading, then the wp_upload_bits()</span>&nbsp;</div></li><li><div>          <span class="comment">// function should perhaps be used</span>&nbsp;</div></li><li><div>          $upload_dir = $this-&gt;object-&gt;get_upload_abspath($gallery);&nbsp;</div></li><li><div>          <span class="comment">// Perhaps a filename was given instead of base64 data?</span>&nbsp;</div></li><li><div>          if (preg_match(&quot;#/\\\\#&quot;, $data[0]) && @file_exists($data)) {&nbsp;</div></li><li><div>              if (!$filename) {&nbsp;</div></li><li><div>                  $filename = M_I18n::mb_basename($data);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $data = file_get_contents($data);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Determine filenames</span>&nbsp;</div></li><li><div>          $original_filename = $filename;&nbsp;</div></li><li><div>          $filename = $filename ? sanitize_file_name($original_filename) : uniqid('nextgen-gallery');&nbsp;</div></li><li><div>          if (preg_match(&quot;/\\-(png|jpg|gif|jpeg)\$/i&quot;, $filename, $match)) {&nbsp;</div></li><li><div>              $filename = str_replace($match[0], '.' . $match[1], $filename);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $abs_filename = implode(DIRECTORY_SEPARATOR, array($upload_dir, $filename));&nbsp;</div></li><li><div>          <span class="comment">// Ensure that the filename is valid</span>&nbsp;</div></li><li><div>          if (!preg_match(&quot;/(png|jpeg|jpg|gif)\$/i&quot;, $abs_filename)) {&nbsp;</div></li><li><div>              throw new E_UploadException(__('Invalid image file. Acceptable formats: JPG, GIF, and PNG.', 'nggallery'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Prevent duplicate filenames: check if the filename exists and</span>&nbsp;</div></li><li><div>          <span class="comment">// begin appending '-i' until we find an open slot</span>&nbsp;</div></li><li><div>          if (!ini_get('safe_mode') && @file_exists($abs_filename) && !$override) {&nbsp;</div></li><li><div>              $file_exists = TRUE;&nbsp;</div></li><li><div>              $i = 0;&nbsp;</div></li><li><div>              do {&nbsp;</div></li><li><div>                  $i++;&nbsp;</div></li><li><div>                  $parts = explode('.', $filename);&nbsp;</div></li><li><div>                  $extension = array_pop($parts);&nbsp;</div></li><li><div>                  $new_filename = implode('.', $parts) . '-' . $i . '.' . $extension;&nbsp;</div></li><li><div>                  $new_abs_filename = implode(DIRECTORY_SEPARATOR, array($upload_dir, $new_filename));&nbsp;</div></li><li><div>                  if (!@file_exists($new_abs_filename)) {&nbsp;</div></li><li><div>                      $file_exists = FALSE;&nbsp;</div></li><li><div>                      $filename = $new_filename;&nbsp;</div></li><li><div>                      $abs_filename = $new_abs_filename;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } while ($file_exists == TRUE);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Create or retrieve the image object</span>&nbsp;</div></li><li><div>          $image = NULL;&nbsp;</div></li><li><div>          if ($image_id) {&nbsp;</div></li><li><div>              $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image_id, TRUE);&nbsp;</div></li><li><div>              if ($image) {&nbsp;</div></li><li><div>                  unset($image-&gt;meta_data['saved']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!$image) {&nbsp;</div></li><li><div>              $image = $this-&gt;object-&gt;_image_mapper-&gt;create();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = $image;&nbsp;</div></li><li><div>          <span class="comment">// Create or update the database record</span>&nbsp;</div></li><li><div>          $image-&gt;alttext = str_replace('.' . M_I18n::mb_pathinfo($original_filename, PATHINFO_EXTENSION), '', M_I18n::mb_basename($original_filename));&nbsp;</div></li><li><div>          $image-&gt;galleryid = $this-&gt;object-&gt;_get_gallery_id($gallery);&nbsp;</div></li><li><div>          $image-&gt;filename = $filename;&nbsp;</div></li><li><div>          $image-&gt;image_slug = nggdb::get_unique_slug(sanitize_title_with_dashes($image-&gt;alttext), 'image');&nbsp;</div></li><li><div>          $image_key = $this-&gt;object-&gt;_image_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>          <span class="comment">// If we can't write to the directory, then there's no point in continuing</span>&nbsp;</div></li><li><div>          if (!@file_exists($upload_dir)) {&nbsp;</div></li><li><div>              @wp_mkdir_p($upload_dir);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!is_writable($upload_dir)) {&nbsp;</div></li><li><div>              throw new E_InsufficientWriteAccessException(FALSE, $upload_dir, FALSE);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Save the image</span>&nbsp;</div></li><li><div>          if ($image_id = $this-&gt;object-&gt;_image_mapper-&gt;save($image)) {&nbsp;</div></li><li><div>              try {&nbsp;</div></li><li><div>                  <span class="comment">// Try writing the image</span>&nbsp;</div></li><li><div>                  $fp = fopen($abs_filename, 'w');&nbsp;</div></li><li><div>                  fwrite($fp, $data);&nbsp;</div></li><li><div>                  fclose($fp);&nbsp;</div></li><li><div>                  if ($settings-&gt;imgBackup) {&nbsp;</div></li><li><div>                      $this-&gt;object-&gt;backup_image($image);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ($settings-&gt;imgAutoResize) {&nbsp;</div></li><li><div>                      $this-&gt;object-&gt;generate_image_clone($abs_filename, $abs_filename, $this-&gt;object-&gt;get_image_size_params($image_id, 'full'));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Ensure that fullsize dimensions are added to metadata array</span></span>&nbsp;</div></li><li><div>                  $dimensions = getimagesize($abs_filename);&nbsp;</div></li><li><div>                  $full_meta = array('width' =&gt; $dimensions[0], 'height' =&gt; $dimensions[1], 'md5' =&gt; $this-&gt;object-&gt;get_image_checksum($image, 'full'));&nbsp;</div></li><li><div>                  if (!isset($image-&gt;meta_data) or is_string($image-&gt;meta_data) && strlen($image-&gt;meta_data) == 0) {&nbsp;</div></li><li><div>                      $image-&gt;meta_data = array();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $image-&gt;meta_data = array_merge($image-&gt;meta_data, $full_meta);&nbsp;</div></li><li><div>                  $image-&gt;meta_data['full'] = $full_meta;&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Generate a thumbnail for the image</span></span>&nbsp;</div></li><li><div>                  $this-&gt;object-&gt;generate_thumbnail($image);&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Set gallery preview image if missing</span></span>&nbsp;</div></li><li><div>                  C_Gallery_Mapper::get_instance()-&gt;set_preview_image($gallery, $image_id, TRUE);&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Notify other plugins that an image has been added</span></span>&nbsp;</div></li><li><div>                  do_action('ngg_added_new_image', $image);&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// delete dirsize after adding new images</span></span>&nbsp;</div></li><li><div>                  delete_transient('dirsize_cache');&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// Seems redundant to above hook. Maintaining for legacy purposes</span></span>&nbsp;</div></li><li><div>                  do_action('ngg_after_new_images_added', $gallery_id, array($image-&gt;{$image_key}));&nbsp;</div></li><li><div>              } catch (E_No_Image_Library_Exception $ex) {&nbsp;</div></li><li><div>                  throw $ex;&nbsp;</div></li><li><div>              } catch (E_Clean_Exit $ex) {&nbsp;</div></li><li><div>                  <span class="comment">// pass</span>&nbsp;</div></li><li><div>              } catch (Exception $ex) {&nbsp;</div></li><li><div>                  throw new E_InsufficientWriteAccessException(FALSE, $abs_filename, FALSE, $ex);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              throw new E_InvalidEntityException();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          throw new E_EntityNotFoundException();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!extension_loaded('suhosin')) {&nbsp;</div></li><li><div>          @ini_set('memory_limit', $memory_limit . 'M');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function import_gallery_from_fs($abspath, $gallery_id = FALSE, $create_new_gallerypath = TRUE, $gallery_title = NULL, $filenames = array())&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if (@file_exists($abspath)) {&nbsp;</div></li><li><div>          $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Ensure that this folder has images</span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Ensure that this folder has images</span></span>&nbsp;</div></li><li><div>          $i = 0;&nbsp;</div></li><li><div>          $files = array();&nbsp;</div></li><li><div>          foreach (scandir($abspath) as $file) {&nbsp;</div></li><li><div>              if ($file == '.' || $file == '..') {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $file_abspath = $fs-&gt;join_paths($abspath, $file);&nbsp;</div></li><li><div>              <span class="comment">// The first directory is considered valid</span>&nbsp;</div></li><li><div>              if (is_dir($file_abspath) && $i === 0) {&nbsp;</div></li><li><div>                  $files[] = $file_abspath;&nbsp;</div></li><li><div>              } elseif ($this-&gt;is_image_file($file_abspath)) {&nbsp;</div></li><li><div>                  if ($filenames && array_search($file_abspath, $filenames) !== FALSE) {&nbsp;</div></li><li><div>                      $files[] = $file_abspath;&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if (!$filenames) {&nbsp;</div></li><li><div>                          $files[] = $file_abspath;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!empty($files)) {&nbsp;</div></li><li><div>              <span class="comment">// Get needed utilities</span>&nbsp;</div></li><li><div>              $gallery_mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>              <span class="comment">// Sometimes users try importing a directory, which actually has all images under another directory</span>&nbsp;</div></li><li><div>              if (is_dir($files[0])) {&nbsp;</div></li><li><div>                  return $this-&gt;import_gallery_from_fs($files[0], $gallery_id, $create_new_gallerypath, $gallery_title, $filenames);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// If no gallery has been specified, then use the directory name as the gallery name</span>&nbsp;</div></li><li><div>              if (!$gallery_id) {&nbsp;</div></li><li><div>                  <span class="comment">// Create the gallery</span>&nbsp;</div></li><li><div>                  $gallery = $gallery_mapper-&gt;create(array('title' =&gt; $gallery_title ? $gallery_title : M_I18n::mb_basename($abspath)));&nbsp;</div></li><li><div>                  if (!$create_new_gallerypath) {&nbsp;</div></li><li><div>                      $gallery-&gt;path = str_ireplace(ABSPATH, '', $abspath);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  <span class="comment">// Save the gallery</span>&nbsp;</div></li><li><div>                  if ($gallery-&gt;save()) {&nbsp;</div></li><li><div>                      $gallery_id = $gallery-&gt;id();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Ensure that we have a gallery id</span>&nbsp;</div></li><li><div>              if ($gallery_id) {&nbsp;</div></li><li><div>                  $retval = array('gallery_id' =&gt; $gallery_id, 'image_ids' =&gt; array());&nbsp;</div></li><li><div>                  foreach ($files as $file_abspath) {&nbsp;</div></li><li><div>                      if (!preg_match(&quot;/\\.(jpg|jpeg|gif|png)\$/i&quot;, $file_abspath)) {&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $image = null;&nbsp;</div></li><li><div>                      if ($create_new_gallerypath) {&nbsp;</div></li><li><div>                          $image = $this-&gt;object-&gt;upload_base64_image($gallery_id, file_get_contents($file_abspath), str_replace(' ', '_', M_I18n::mb_basename($file_abspath)));&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          <span class="comment">// Create the database record ... TODO cleanup, some duplication here from upload_base64_image</span>&nbsp;</div></li><li><div>                          $factory = C_Component_Factory::get_instance();&nbsp;</div></li><li><div>                          $image = $factory-&gt;create('image');&nbsp;</div></li><li><div>                          $image-&gt;alttext = sanitize_title_with_dashes(str_replace('.' . M_I18n::mb_pathinfo($file_abspath, PATHINFO_EXTENSION), '', M_I18n::mb_basename($file_abspath)));&nbsp;</div></li><li><div>                          $image-&gt;galleryid = $this-&gt;object-&gt;_get_gallery_id($gallery_id);&nbsp;</div></li><li><div>                          $image-&gt;filename = M_I18n::mb_basename($file_abspath);&nbsp;</div></li><li><div>                          $image-&gt;image_slug = nggdb::get_unique_slug(sanitize_title_with_dashes($image-&gt;alttext), 'image');&nbsp;</div></li><li><div>                          $image_key = $this-&gt;object-&gt;_image_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>                          $abs_filename = $file_abspath;&nbsp;</div></li><li><div>                          if ($image_id = $this-&gt;object-&gt;_image_mapper-&gt;save($image)) {&nbsp;</div></li><li><div>                              try {&nbsp;</div></li><li><div>                                  if (C_NextGen_settings::get_instance()-&gt;imgBackup) {&nbsp;</div></li><li><div>                                      $this-&gt;object-&gt;backup_image($image);&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  #                                                            if ($settings-&gt;imgAutoResize)&nbsp;</div></li><li><div>                                  #                                                                $this-&gt;object-&gt;generate_image_clone(&nbsp;</div></li><li><div>                                  #                                                                    $abs_filename, &nbsp;</div></li><li><div>                                  #                                                                    $abs_filename, &nbsp;</div></li><li><div>                                  #                                                                    $this-&gt;object-&gt;get_image_size_params($image_id, 'full')&nbsp;</div></li><li><div>                                  # );&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment">// Ensure that fullsize dimensions are added to metadata array</span></span>&nbsp;</div></li><li><div>                                  $dimensions = getimagesize($abs_filename);&nbsp;</div></li><li><div>                                  $full_meta = array('width' =&gt; $dimensions[0], 'height' =&gt; $dimensions[1]);&nbsp;</div></li><li><div>                                  if (!isset($image-&gt;meta_data) or is_string($image-&gt;meta_data) && strlen($image-&gt;meta_data) == 0) {&nbsp;</div></li><li><div>                                      $image-&gt;meta_data = array();&nbsp;</div></li><li><div>                                  }&nbsp;</div></li><li><div>                                  $image-&gt;meta_data = array_merge($image-&gt;meta_data, $full_meta);&nbsp;</div></li><li><div>                                  $image-&gt;meta_data['full'] = $full_meta;&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment">// Generate a thumbnail for the image</span></span>&nbsp;</div></li><li><div>                                  $this-&gt;object-&gt;generate_thumbnail($image);&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment">// Set gallery preview image if missing</span></span>&nbsp;</div></li><li><div>                                  C_Gallery_Mapper::get_instance()-&gt;set_preview_image($gallery, $image_id, TRUE);&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment">// Notify other plugins that an image has been added</span></span>&nbsp;</div></li><li><div>                                  do_action('ngg_added_new_image', $image);&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment">// delete dirsize after adding new images</span></span>&nbsp;</div></li><li><div>                                  delete_transient('dirsize_cache');&nbsp;</div></li><li><div>                                  <span class="comment"><span class="comment">// Seems redundant to above hook. Maintaining for legacy purposes</span></span>&nbsp;</div></li><li><div>                                  do_action('ngg_after_new_images_added', $gallery_id, array($image-&gt;{$image_key}));&nbsp;</div></li><li><div>                              } catch (Exception $ex) {&nbsp;</div></li><li><div>                                  throw new E_InsufficientWriteAccessException(FALSE, $abs_filename, FALSE, $ex);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              throw new E_InvalidEntityException();&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $retval['image_ids'][] = $image-&gt;{$image-&gt;id_field};&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  <span class="comment">// Add the gallery name to the result</span>&nbsp;</div></li><li><div>                  $gallery = $gallery_mapper-&gt;find($gallery_id);&nbsp;</div></li><li><div>                  $retval['gallery_name'] = $gallery-&gt;title;&nbsp;</div></li><li><div>                  unset($gallery);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_image_format_list()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $format_list = array(IMAGETYPE_GIF =&gt; 'gif', IMAGETYPE_JPEG =&gt; 'jpg', IMAGETYPE_PNG =&gt; 'png');&nbsp;</div></li><li><div>      return $format_list;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an array of properties of a resulting clone image if and when generated</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $image_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $clone_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calculate_image_clone_result($image_path, $clone_path, $params)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $width = isset($params['width']) ? $params['width'] : NULL;&nbsp;</div></li><li><div>      $height = isset($params['height']) ? $params['height'] : NULL;&nbsp;</div></li><li><div>      $quality = isset($params['quality']) ? $params['quality'] : NULL;&nbsp;</div></li><li><div>      $type = isset($params['type']) ? $params['type'] : NULL;&nbsp;</div></li><li><div>      $crop = isset($params['crop']) ? $params['crop'] : NULL;&nbsp;</div></li><li><div>      $watermark = isset($params['watermark']) ? $params['watermark'] : NULL;&nbsp;</div></li><li><div>      $rotation = isset($params['rotation']) ? $params['rotation'] : NULL;&nbsp;</div></li><li><div>      $reflection = isset($params['reflection']) ? $params['reflection'] : NULL;&nbsp;</div></li><li><div>      $crop_frame = isset($params['crop_frame']) ? $params['crop_frame'] : NULL;&nbsp;</div></li><li><div>      $result = NULL;&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Ensure we have a valid image</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ($image_path && @file_exists($image_path)) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Ensure target directory exists, but only create 1 subdirectory</span></span>&nbsp;</div></li><li><div>          $image_dir = dirname($image_path);&nbsp;</div></li><li><div>          $clone_dir = dirname($clone_path);&nbsp;</div></li><li><div>          $image_extension = M_I18n::mb_pathinfo($image_path, PATHINFO_EXTENSION);&nbsp;</div></li><li><div>          $image_extension_str = null;&nbsp;</div></li><li><div>          $clone_extension = M_I18n::mb_pathinfo($clone_path, PATHINFO_EXTENSION);&nbsp;</div></li><li><div>          $clone_extension_str = null;&nbsp;</div></li><li><div>          if ($image_extension != null) {&nbsp;</div></li><li><div>              $image_extension_str = '.' . $image_extension;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($clone_extension != null) {&nbsp;</div></li><li><div>              $clone_extension_str = '.' . $clone_extension;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $image_basename = M_I18n::mb_basename($image_path, $image_extension_str);&nbsp;</div></li><li><div>          $clone_basename = M_I18n::mb_basename($clone_path, $clone_extension_str);&nbsp;</div></li><li><div>          <span class="comment">// We use a default suffix as passing in null as the suffix will make WordPress use a default</span>&nbsp;</div></li><li><div>          $clone_suffix = null;&nbsp;</div></li><li><div>          $format_list = $this-&gt;object-&gt;get_image_format_list();&nbsp;</div></li><li><div>          $clone_format = null;&nbsp;</div></li><li><div>          <span class="comment">// format is determined below and based on $type otherwise left to null</span>&nbsp;</div></li><li><div>          <span class="comment">// suffix is only used to reconstruct paths for image_resize function</span>&nbsp;</div></li><li><div>          if (strpos($clone_basename, $image_basename) === 0) {&nbsp;</div></li><li><div>              $clone_suffix = substr($clone_basename, strlen($image_basename));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($clone_suffix != null && $clone_suffix[0] == '-') {&nbsp;</div></li><li><div>              <span class="comment">// WordPress adds '-' on its own</span>&nbsp;</div></li><li><div>              $clone_suffix = substr($clone_suffix, 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Get original image dimensions</span>&nbsp;</div></li><li><div>          $dimensions = getimagesize($image_path);&nbsp;</div></li><li><div>          if ($width == null && $height == null) {&nbsp;</div></li><li><div>              if ($dimensions != null) {&nbsp;</div></li><li><div>                  if ($width == null) {&nbsp;</div></li><li><div>                      $width = $dimensions[0];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ($height == null) {&nbsp;</div></li><li><div>                      $height = $dimensions[1];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// XXX Don't think there's any other option here but to fail miserably...use some hard-coded defaults maybe?</span>&nbsp;</div></li><li><div>                  return null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($dimensions != null) {&nbsp;</div></li><li><div>              $dimensions_ratio = $dimensions[0] / $dimensions[1];&nbsp;</div></li><li><div>              if ($width == null) {&nbsp;</div></li><li><div>                  $width = (int) round($height * $dimensions_ratio);&nbsp;</div></li><li><div>                  if ($width == $dimensions[0] - 1) {&nbsp;</div></li><li><div>                      $width = $dimensions[0];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ($height == null) {&nbsp;</div></li><li><div>                      $height = (int) round($width / $dimensions_ratio);&nbsp;</div></li><li><div>                      if ($height == $dimensions[1] - 1) {&nbsp;</div></li><li><div>                          $height = $dimensions[1];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($width &gt; $dimensions[0]) {&nbsp;</div></li><li><div>                  $width = $dimensions[0];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($height &gt; $dimensions[1]) {&nbsp;</div></li><li><div>                  $height = $dimensions[1];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $image_format = $dimensions[2];&nbsp;</div></li><li><div>              if ($type != null) {&nbsp;</div></li><li><div>                  if (is_string($type)) {&nbsp;</div></li><li><div>                      $type = strtolower($type);&nbsp;</div></li><li><div>                      <span class="comment">// Indexes in the $format_list array correspond to IMAGETYPE_XXX values appropriately</span>&nbsp;</div></li><li><div>                      if (($index = array_search($type, $format_list)) !== false) {&nbsp;</div></li><li><div>                          $type = $index;&nbsp;</div></li><li><div>                          if ($type != $image_format) {&nbsp;</div></li><li><div>                              <span class="comment">// Note: this only changes the FORMAT of the image but not the extension</span>&nbsp;</div></li><li><div>                              $clone_format = $type;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($width == null || $height == null) {&nbsp;</div></li><li><div>              <span class="comment">// Something went wrong...</span>&nbsp;</div></li><li><div>              return null;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $result['clone_path'] = $clone_path;&nbsp;</div></li><li><div>          $result['clone_directory'] = $clone_dir;&nbsp;</div></li><li><div>          $result['clone_suffix'] = $clone_suffix;&nbsp;</div></li><li><div>          $result['clone_format'] = $clone_format;&nbsp;</div></li><li><div>          $result['base_width'] = $dimensions[0];&nbsp;</div></li><li><div>          $result['base_height'] = $dimensions[1];&nbsp;</div></li><li><div>          <span class="comment">// image_resize() has limitations:</span>&nbsp;</div></li><li><div>          <span class="comment">// - no easy crop frame support</span>&nbsp;</div></li><li><div>          <span class="comment">// - fails if the dimensions are unchanged</span>&nbsp;</div></li><li><div>          <span class="comment">// - doesn't support filename prefix, only suffix so names like thumbs_original_name.jpg for $clone_path are not supported</span>&nbsp;</div></li><li><div>          <span class="comment">//   also suffix cannot be null as that will make WordPress use a default suffix...we could use an object that returns empty string from __toString() but for now just fallback to ngg generator</span>&nbsp;</div></li><li><div>          if (FALSE) {&nbsp;</div></li><li><div>              <span class="comment">// disabling the WordPress method for Iteration #6</span>&nbsp;</div></li><li><div>              <span class="comment">//            if (($crop_frame == null || !$crop) && ($dimensions[0] != $width && $dimensions[1] != $height) && $clone_suffix != null)</span>&nbsp;</div></li><li><div>              $result['method'] = 'wordpress';&nbsp;</div></li><li><div>              $new_dims = image_resize_dimensions($dimensions[0], $dimensions[1], $width, $height, $crop);&nbsp;</div></li><li><div>              if ($new_dims) {&nbsp;</div></li><li><div>                  list($dst_x, $dst_y, $src_x, $src_y, $dst_w, $dst_h, $src_w, $src_h) = $new_dims;&nbsp;</div></li><li><div>                  $width = $dst_w;&nbsp;</div></li><li><div>                  $height = $dst_h;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $result['error'] = new WP_Error('error_getting_dimensions', __('Could not calculate resized image dimensions'));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $result['method'] = 'nextgen';&nbsp;</div></li><li><div>              $original_width = $dimensions[0];&nbsp;</div></li><li><div>              $original_height = $dimensions[1];&nbsp;</div></li><li><div>              $aspect_ratio = $width / $height;&nbsp;</div></li><li><div>              $orig_ratio_x = $original_width / $width;&nbsp;</div></li><li><div>              $orig_ratio_y = $original_height / $height;&nbsp;</div></li><li><div>              if ($crop) {&nbsp;</div></li><li><div>                  $algo = 'shrink';&nbsp;</div></li><li><div>                  <span class="comment">// either 'adapt' or 'shrink'</span>&nbsp;</div></li><li><div>                  if ($crop_frame != null) {&nbsp;</div></li><li><div>                      $crop_x = (int) round($crop_frame['x']);&nbsp;</div></li><li><div>                      $crop_y = (int) round($crop_frame['y']);&nbsp;</div></li><li><div>                      $crop_width = (int) round($crop_frame['width']);&nbsp;</div></li><li><div>                      $crop_height = (int) round($crop_frame['height']);&nbsp;</div></li><li><div>                      $crop_final_width = (int) round($crop_frame['final_width']);&nbsp;</div></li><li><div>                      $crop_final_height = (int) round($crop_frame['final_height']);&nbsp;</div></li><li><div>                      $crop_width_orig = $crop_width;&nbsp;</div></li><li><div>                      $crop_height_orig = $crop_height;&nbsp;</div></li><li><div>                      $crop_factor_x = $crop_width / $crop_final_width;&nbsp;</div></li><li><div>                      $crop_factor_y = $crop_height / $crop_final_height;&nbsp;</div></li><li><div>                      $crop_ratio_x = $crop_width / $width;&nbsp;</div></li><li><div>                      $crop_ratio_y = $crop_height / $height;&nbsp;</div></li><li><div>                      if ($algo == 'adapt') {&nbsp;</div></li><li><div>                          <span class="comment">// XXX not sure about this...don't use for now</span>&nbsp;</div></li><li><div>                          #                            $crop_width = (int) round($width * $crop_factor_x);&nbsp;</div></li><li><div>                          #                            $crop_height = (int) round($height * $crop_factor_y);&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          if ($algo == 'shrink') {&nbsp;</div></li><li><div>                              if ($crop_ratio_x &lt; $crop_ratio_y) {&nbsp;</div></li><li><div>                                  $crop_width = max($crop_width, $width);&nbsp;</div></li><li><div>                                  $crop_height = (int) round($crop_width / $aspect_ratio);&nbsp;</div></li><li><div>                              } else {&nbsp;</div></li><li><div>                                  $crop_height = max($crop_height, $height);&nbsp;</div></li><li><div>                                  $crop_width = (int) round($crop_height * $aspect_ratio);&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ($crop_width == $crop_width_orig - 1) {&nbsp;</div></li><li><div>                                  $crop_width = $crop_width_orig;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                              if ($crop_height == $crop_height_orig - 1) {&nbsp;</div></li><li><div>                                  $crop_height = $crop_height_orig;&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $crop_diff_x = (int) round(($crop_width_orig - $crop_width) / 2);&nbsp;</div></li><li><div>                      $crop_diff_y = (int) round(($crop_height_orig - $crop_height) / 2);&nbsp;</div></li><li><div>                      $crop_x += $crop_diff_x;&nbsp;</div></li><li><div>                      $crop_y += $crop_diff_y;&nbsp;</div></li><li><div>                      $crop_max_x = $crop_x + $crop_width;&nbsp;</div></li><li><div>                      $crop_max_y = $crop_y + $crop_height;&nbsp;</div></li><li><div>                      <span class="comment">// Check if we're overflowing borders</span>&nbsp;</div></li><li><div>                      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">                      if ($crop_x &lt; 0) {</span>&nbsp;</div></li><li><div>                          $crop_x = 0;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          if ($crop_max_x &gt; $original_width) {&nbsp;</div></li><li><div>                              $crop_x -= $crop_max_x - $original_width;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($crop_y &lt; 0) {&nbsp;</div></li><li><div>                          $crop_y = 0;&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          if ($crop_max_y &gt; $original_height) {&nbsp;</div></li><li><div>                              $crop_y -= $crop_max_y - $original_height;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if ($orig_ratio_x &lt; $orig_ratio_y) {&nbsp;</div></li><li><div>                          $crop_width = $original_width;&nbsp;</div></li><li><div>                          $crop_height = (int) round($height * $orig_ratio_x);&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $crop_height = $original_height;&nbsp;</div></li><li><div>                          $crop_width = (int) round($width * $orig_ratio_y);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($crop_width == $width - 1) {&nbsp;</div></li><li><div>                          $crop_width = $width;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($crop_height == $height - 1) {&nbsp;</div></li><li><div>                          $crop_height = $height;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $crop_x = (int) round(($original_width - $crop_width) / 2);&nbsp;</div></li><li><div>                      $crop_y = (int) round(($original_height - $crop_height) / 2);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $result['crop_area'] = array('x' =&gt; $crop_x, 'y' =&gt; $crop_y, 'width' =&gt; $crop_width, 'height' =&gt; $crop_height);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// Just constraint dimensions to ensure there's no stretching or deformations</span>&nbsp;</div></li><li><div>                  list($width, $height) = wp_constrain_dimensions($original_width, $original_height, $width, $height);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $result['width'] = $width;&nbsp;</div></li><li><div>          $result['height'] = $height;&nbsp;</div></li><li><div>          $result['quality'] = $quality;&nbsp;</div></li><li><div>          $real_width = $width;&nbsp;</div></li><li><div>          $real_height = $height;&nbsp;</div></li><li><div>          if ($rotation && in_array(abs($rotation), array(90, 270))) {&nbsp;</div></li><li><div>              $real_width = $height;&nbsp;</div></li><li><div>              $real_height = $width;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($reflection) {&nbsp;</div></li><li><div>              <span class="comment">// default for nextgen was 40%, this is used in generate_image_clone as well</span>&nbsp;</div></li><li><div>              $reflection_amount = 40;&nbsp;</div></li><li><div>              <span class="comment">// Note, round() would probably be best here but using the same code that C_NggLegacy_Thumbnail uses for compatibility</span>&nbsp;</div></li><li><div>              $reflection_height = intval($real_height * ($reflection_amount / 100));&nbsp;</div></li><li><div>              $real_height = $real_height + $reflection_height;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $result['real_width'] = $real_width;&nbsp;</div></li><li><div>          $result['real_height'] = $real_height;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $result;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an array of dimensional properties (width, height, real_width, real_height) of a resulting clone image if and when generated</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $image_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $clone_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calculate_image_clone_dimensions($image_path, $clone_path, $params)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = null;&nbsp;</div></li><li><div>      $result = $this-&gt;object-&gt;calculate_image_clone_result($image_path, $clone_path, $params);&nbsp;</div></li><li><div>      if ($result != null) {&nbsp;</div></li><li><div>          $retval = array('width' =&gt; $result['width'], 'height' =&gt; $result['height'], 'real_width' =&gt; $result['real_width'], 'real_height' =&gt; $result['real_height']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a &quot;clone&quot; for an existing image, the clone can be altered using the $params array</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $image_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $clone_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function generate_image_clone($image_path, $clone_path, $params)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $crop = isset($params['crop']) ? $params['crop'] : NULL;&nbsp;</div></li><li><div>      $watermark = isset($params['watermark']) ? $params['watermark'] : NULL;&nbsp;</div></li><li><div>      $reflection = isset($params['reflection']) ? $params['reflection'] : NULL;&nbsp;</div></li><li><div>      $rotation = isset($params['rotation']) ? $params['rotation'] : NULL;&nbsp;</div></li><li><div>      $flip = isset($params['flip']) ? $params['flip'] : NULL;&nbsp;</div></li><li><div>      $destpath = NULL;&nbsp;</div></li><li><div>      $thumbnail = NULL;&nbsp;</div></li><li><div>      $result = $this-&gt;object-&gt;calculate_image_clone_result($image_path, $clone_path, $params);&nbsp;</div></li><li><div>      <span class="comment">// XXX this should maybe be removed and extra settings go into $params?</span>&nbsp;</div></li><li><div>      $settings = apply_filters('ngg_settings_during_image_generation', C_NextGen_Settings::get_instance()-&gt;to_array());&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Ensure we have a valid image</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ($image_path && @file_exists($image_path) && $result != null && !isset($result['error'])) {&nbsp;</div></li><li><div>          $image_dir = dirname($image_path);&nbsp;</div></li><li><div>          $clone_path = $result['clone_path'];&nbsp;</div></li><li><div>          $clone_dir = $result['clone_directory'];&nbsp;</div></li><li><div>          $clone_format = $result['clone_format'];&nbsp;</div></li><li><div>          $format_list = $this-&gt;object-&gt;get_image_format_list();&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Ensure target directory exists, but only create 1 subdirectory</span></span>&nbsp;</div></li><li><div>          if (!@file_exists($clone_dir)) {&nbsp;</div></li><li><div>              if (strtolower(realpath($image_dir)) != strtolower(realpath($clone_dir))) {&nbsp;</div></li><li><div>                  if (strtolower(realpath($image_dir)) == strtolower(realpath(dirname($clone_dir)))) {&nbsp;</div></li><li><div>                      wp_mkdir_p($clone_dir);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $method = $result['method'];&nbsp;</div></li><li><div>          $width = $result['width'];&nbsp;</div></li><li><div>          $height = $result['height'];&nbsp;</div></li><li><div>          $quality = $result['quality'];&nbsp;</div></li><li><div>          if ($quality == null) {&nbsp;</div></li><li><div>              $quality = 100;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($method == 'wordpress') {&nbsp;</div></li><li><div>              $original = wp_get_image_editor($image_path);&nbsp;</div></li><li><div>              $destpath = $clone_path;&nbsp;</div></li><li><div>              if (!is_wp_error($original)) {&nbsp;</div></li><li><div>                  $original-&gt;resize($width, $height, $crop);&nbsp;</div></li><li><div>                  $original-&gt;set_quality($quality);&nbsp;</div></li><li><div>                  $original-&gt;save($clone_path);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ($method == 'nextgen') {&nbsp;</div></li><li><div>                  $destpath = $clone_path;&nbsp;</div></li><li><div>                  $thumbnail = new C_NggLegacy_Thumbnail($image_path, true);&nbsp;</div></li><li><div>                  if (!$thumbnail-&gt;error) {&nbsp;</div></li><li><div>                      if ($crop) {&nbsp;</div></li><li><div>                          $crop_area = $result['crop_area'];&nbsp;</div></li><li><div>                          $crop_x = $crop_area['x'];&nbsp;</div></li><li><div>                          $crop_y = $crop_area['y'];&nbsp;</div></li><li><div>                          $crop_width = $crop_area['width'];&nbsp;</div></li><li><div>                          $crop_height = $crop_area['height'];&nbsp;</div></li><li><div>                          $thumbnail-&gt;crop($crop_x, $crop_y, $crop_width, $crop_height);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $thumbnail-&gt;resize($width, $height);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $thumbnail = NULL;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// We successfully generated the thumbnail</span></span>&nbsp;</div></li><li><div>          if (is_string($destpath) && (@file_exists($destpath) || $thumbnail != null)) {&nbsp;</div></li><li><div>              if ($clone_format != null) {&nbsp;</div></li><li><div>                  if (isset($format_list[$clone_format])) {&nbsp;</div></li><li><div>                      $clone_format_extension = $format_list[$clone_format];&nbsp;</div></li><li><div>                      $clone_format_extension_str = null;&nbsp;</div></li><li><div>                      if ($clone_format_extension != null) {&nbsp;</div></li><li><div>                          $clone_format_extension_str = '.' . $clone_format_extension;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $destpath_info = M_I18n::mb_pathinfo($destpath);&nbsp;</div></li><li><div>                      $destpath_extension = $destpath_info['extension'];&nbsp;</div></li><li><div>                      if (strtolower($destpath_extension) != strtolower($clone_format_extension)) {&nbsp;</div></li><li><div>                          $destpath_dir = $destpath_info['dirname'];&nbsp;</div></li><li><div>                          $destpath_basename = $destpath_info['filename'];&nbsp;</div></li><li><div>                          $destpath_new = $destpath_dir . DIRECTORY_SEPARATOR . $destpath_basename . $clone_format_extension_str;&nbsp;</div></li><li><div>                          if (@file_exists($destpath) && rename($destpath, $destpath_new) || $thumbnail != null) {&nbsp;</div></li><li><div>                              $destpath = $destpath_new;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (is_null($thumbnail)) {&nbsp;</div></li><li><div>                  $thumbnail = new C_NggLegacy_Thumbnail($destpath, true);&nbsp;</div></li><li><div>                  if ($thumbnail-&gt;error) {&nbsp;</div></li><li><div>                      $thumbnail = null;&nbsp;</div></li><li><div>                      return null;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $thumbnail-&gt;fileName = $destpath;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// This is quite odd, when watermark equals int(0) it seems all statements below ($watermark == 'image') and ($watermark == 'text') both evaluate as true</span>&nbsp;</div></li><li><div>              <span class="comment">// so we set it at null if it evaluates to any null-like value</span>&nbsp;</div></li><li><div>              if ($watermark == null) {&nbsp;</div></li><li><div>                  $watermark = null;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($watermark == 1 || $watermark === true) {&nbsp;</div></li><li><div>                  if (in_array(strval($settings['wmType']), array('image', 'text'))) {&nbsp;</div></li><li><div>                      $watermark = $settings['wmType'];&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $watermark = 'text';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $watermark = strval($watermark);&nbsp;</div></li><li><div>              if ($watermark == 'image') {&nbsp;</div></li><li><div>                  $thumbnail-&gt;watermarkImgPath = $settings['wmPath'];&nbsp;</div></li><li><div>                  $thumbnail-&gt;watermarkImage($settings['wmPos'], $settings['wmXpos'], $settings['wmYpos']);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ($watermark == 'text') {&nbsp;</div></li><li><div>                      $thumbnail-&gt;watermarkText = $settings['wmText'];&nbsp;</div></li><li><div>                      $thumbnail-&gt;watermarkCreateText($settings['wmColor'], $settings['wmFont'], $settings['wmSize'], $settings['wmOpaque']);&nbsp;</div></li><li><div>                      $thumbnail-&gt;watermarkImage($settings['wmPos'], $settings['wmXpos'], $settings['wmYpos']);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($rotation && in_array(abs($rotation), array(90, 180, 270))) {&nbsp;</div></li><li><div>                  $thumbnail-&gt;rotateImageAngle($rotation);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $flip = strtolower($flip);&nbsp;</div></li><li><div>              if ($flip && in_array($flip, array('h', 'v', 'hv'))) {&nbsp;</div></li><li><div>                  $flip_h = in_array($flip, array('h', 'hv'));&nbsp;</div></li><li><div>                  $flip_v = in_array($flip, array('v', 'hv'));&nbsp;</div></li><li><div>                  $thumbnail-&gt;flipImage($flip_h, $flip_v);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($reflection) {&nbsp;</div></li><li><div>                  $thumbnail-&gt;createReflection(40, 40, 50, FALSE, '#a4a4a4');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($clone_format != null && isset($format_list[$clone_format])) {&nbsp;</div></li><li><div>                  <span class="comment">// Force format</span>&nbsp;</div></li><li><div>                  $thumbnail-&gt;format = strtoupper($format_list[$clone_format]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $thumbnail = apply_filters('ngg_before_save_thumbnail', $thumbnail);&nbsp;</div></li><li><div>              $thumbnail-&gt;save($destpath, $quality);&nbsp;</div></li><li><div>              <span class="comment">// IF the original contained IPTC metadata we should attempt to copy it</span>&nbsp;</div></li><li><div>              if (isset($detailed_size['APP13']) && function_exists('iptcembed')) {&nbsp;</div></li><li><div>                  $metadata = @iptcembed($detailed_size['APP13'], $destpath);&nbsp;</div></li><li><div>                  $fp = @fopen($destpath, 'wb');&nbsp;</div></li><li><div>                  @fwrite($fp, $metadata);&nbsp;</div></li><li><div>                  @fclose($fp);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $thumbnail;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_GalleryStorage_Driver_Base</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_GalleryStorage_Driver_Base</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_GalleryStorage_Driver</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_GalleryStorage_Driver_Base extends C_GalleryStorage_Base&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public static $_instances = array();&nbsp;</div></li><li><div>  function define($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_GalleryStorage_Driver_Base');&nbsp;</div></li><li><div>      $this-&gt;implement('I_GalleryStorage_Driver');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function initialize()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::initialize();&nbsp;</div></li><li><div>      $this-&gt;_gallery_mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      $this-&gt;_image_mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public static function get_instance($context = False)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instances[$context])) {&nbsp;</div></li><li><div>          self::$_instances[$context] = new C_GalleryStorage_Driver_Base($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instances[$context];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the class name of the driver used</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_driver_class_name()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return get_called_class();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_NextGen_Gallery_Image_Validation extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function validation()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Additional checks...</span>&nbsp;</div></li><li><div>      if (isset($this-&gt;object-&gt;description)) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;description = M_NextGen_Data::strip_html($this-&gt;object-&gt;description, TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (isset($this-&gt;object-&gt;alttext)) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;alttext = M_NextGen_Data::strip_html($this-&gt;object-&gt;alttext, TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;validates_presence_of('galleryid', 'filename', 'alttext', 'exclude', 'sortorder', 'imagedate');&nbsp;</div></li><li><div>      $this-&gt;validates_numericality_of('galleryid');&nbsp;</div></li><li><div>      $this-&gt;validates_numericality_of($this-&gt;id());&nbsp;</div></li><li><div>      $this-&gt;validates_numericality_of('sortorder');&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;is_valid();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Model for NextGen Gallery Images</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NextGen_Gallery_Image_Validation</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Image</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Image extends C_DataMapper_Model&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_mapper_interface = 'I_Image_Mapper';&nbsp;</div></li><li><div>  function define($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($mapper, $properties, $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NextGen_Gallery_Image_Validation');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Image');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Instantiates a new model</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|stdClass $properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_DataMapper $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function initialize($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Get the mapper is not specified</span></span></span>&nbsp;</div></li><li><div>      if (!$mapper) {&nbsp;</div></li><li><div>          $mapper = $this-&gt;get_registry()-&gt;get_utility($this-&gt;_mapper_interface);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Initialize</span></span></span>&nbsp;</div></li><li><div>      parent::initialize($mapper, $properties);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the model representing the gallery associated with this image</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Gallery|stdClass</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_gallery($model = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $gallery_mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      return $gallery_mapper-&gt;find($this-&gt;galleryid, $model);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Image_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NextGen_Table_Extras</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Gallery_Image_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Image_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Image_Mapper extends C_CustomTable_DataMapper_Driver&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public static $_instance = NULL;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines the gallery image mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function define($context = FALSE, $not_used = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Add 'attachment' context</span>&nbsp;</div></li><li><div>      if (!is_array($context)) {&nbsp;</div></li><li><div>          $context = array($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      array_push($context, 'attachment');&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Define the mapper</span></span>&nbsp;</div></li><li><div>      $this-&gt;_primary_key_column = 'pid';&nbsp;</div></li><li><div>      parent::define('ngg_pictures', $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NextGen_Table_Extras');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Gallery_Image_Mapper');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Image_Mapper');&nbsp;</div></li><li><div>      $this-&gt;set_model_factory_method('image');&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Define the columns</span></span></span>&nbsp;</div></li><li><div>      $this-&gt;define_column('pid', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('image_slug', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('post_id', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('galleryid', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('filename', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('description', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('alttext', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('imagedate', 'DATETIME');&nbsp;</div></li><li><div>      $this-&gt;define_column('exclude', 'INT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('sortorder', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('meta_data', 'TEXT');&nbsp;</div></li><li><div>      $this-&gt;define_column('extras_post_id', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('updated_at', 'BIGINT');&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Mark the columns which should be unserialized</span></span>&nbsp;</div></li><li><div>      $this-&gt;add_serialized_column('meta_data');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function initialize($object_name = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::initialize('ngg_pictures');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  static function get_instance($context = False)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_null(self::$_instance)) {&nbsp;</div></li><li><div>          $klass = get_class();&nbsp;</div></li><li><div>          self::$_instance = new $klass($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sets the alttext property as the post title</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Gallery_Image_Mapper extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function destroy($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = $this-&gt;call_parent('destroy', $image);&nbsp;</div></li><li><div>      <span class="comment">// Delete tag associations with the image</span>&nbsp;</div></li><li><div>      if (!is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $image-&gt;{$image-&gt;id_field};&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_delete_object_term_relationships($image, 'ngg_tag');&nbsp;</div></li><li><div>      C_Photocrati_Transient_Manager::flush('displayed_gallery_rendering');&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _save_entity($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $entity-&gt;updated_at = time();&nbsp;</div></li><li><div>      <span class="comment">// If successfully saved, then import metadata and</span>&nbsp;</div></li><li><div>      $retval = $this-&gt;call_parent('_save_entity', $entity);&nbsp;</div></li><li><div>      if ($retval) {&nbsp;</div></li><li><div>          include_once NGGALLERY_ABSPATH . '/admin/functions.php';&nbsp;</div></li><li><div>          $image_id = $this-&gt;get_id($entity);&nbsp;</div></li><li><div>          if (!isset($entity-&gt;meta_data['saved'])) {&nbsp;</div></li><li><div>              nggAdmin::import_MetaData($image_id);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          C_Photocrati_Transient_Manager::flush('displayed_gallery_rendering');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function reimport_metadata($image_or_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Get the image</span>&nbsp;</div></li><li><div>      $image = NULL;&nbsp;</div></li><li><div>      if (is_int($image_or_id)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;find($image_or_id);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $image = $image_or_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Reset all image details that would have normally been imported</span>&nbsp;</div></li><li><div>      $image-&gt;alttext = '';&nbsp;</div></li><li><div>      $image-&gt;description = '';&nbsp;</div></li><li><div>      if (is_array($image-&gt;meta_data)) {&nbsp;</div></li><li><div>          unset($image-&gt;meta_data['saved']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_delete_object_term_relationships($image-&gt;{$image-&gt;id_field}, 'ngg_tag');&nbsp;</div></li><li><div>      nggAdmin::import_MetaData($image);&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;save($image);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieves the id from an image</span>&nbsp;</div></li><li><div><span class="comment">   * @param $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_id($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// Have we been passed an entity and is the id_field set?</span>&nbsp;</div></li><li><div>      if ($image instanceof stdClass) {&nbsp;</div></li><li><div>          if (isset($image-&gt;id_field)) {&nbsp;</div></li><li><div>              $retval = $image-&gt;{$image-&gt;id_field};&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $retval = $image-&gt;id();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If we still don't have an id, then we'll lookup the primary key</span>&nbsp;</div></li><li><div>      <span class="comment">// and try fetching it manually</span>&nbsp;</div></li><li><div>      if (!$retval) {&nbsp;</div></li><li><div>          $key = $this-&gt;object-&gt;get_primary_key_column();&nbsp;</div></li><li><div>          $retval = $image-&gt;{$key};&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_post_title($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $entity-&gt;alttext;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function set_defaults($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// If not set already, we'll add an exclude property. This is used</span>&nbsp;</div></li><li><div>      <span class="comment">// by NextGEN Gallery itself, as well as the Attach to Post module</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'exclude', 0);&nbsp;</div></li><li><div>      <span class="comment">// Ensure that the object has a description attribute</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'description', '');&nbsp;</div></li><li><div>      <span class="comment">// If not set already, set a default sortorder</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'sortorder', 0);&nbsp;</div></li><li><div>      <span class="comment">// The imagedate must be set</span>&nbsp;</div></li><li><div>      if (!isset($entity-&gt;imagedate) or is_null($entity-&gt;imagedate) or $entity-&gt;imagedate == '0000-00-00 00:00:00') {&nbsp;</div></li><li><div>          $entity-&gt;imagedate = date(&quot;Y-m-d H:i:s&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If a filename is set, and no alttext is set, then set the alttext</span>&nbsp;</div></li><li><div>      <span class="comment">// to the basename of the filename (legacy behavior)</span>&nbsp;</div></li><li><div>      if (isset($entity-&gt;filename)) {&nbsp;</div></li><li><div>          $path_parts = M_I18n::mb_pathinfo($entity-&gt;filename);&nbsp;</div></li><li><div>          $alttext = !isset($path_parts['filename']) ? substr($path_parts['basename'], 0, strpos($path_parts['basename'], '.')) : $path_parts['filename'];&nbsp;</div></li><li><div>          $this-&gt;object-&gt;_set_default_value($entity, 'alttext', $alttext);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Set unique slug</span>&nbsp;</div></li><li><div>      if (isset($entity-&gt;alttext) && empty($entity-&gt;image_slug)) {&nbsp;</div></li><li><div>          $entity-&gt;image_slug = nggdb::get_unique_slug(sanitize_title_with_dashes($entity-&gt;alttext), 'image');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Ensure that the exclude parameter is an integer or boolean-evaluated</span>&nbsp;</div></li><li><div>      <span class="comment">// value</span>&nbsp;</div></li><li><div>      if (is_string($entity-&gt;exclude)) {&nbsp;</div></li><li><div>          $entity-&gt;exclude = intval($entity-&gt;exclude);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Trim alttext and description</span>&nbsp;</div></li><li><div>      $entity-&gt;description = trim($entity-&gt;description);&nbsp;</div></li><li><div>      $entity-&gt;alttext = trim($entity-&gt;alttext);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Finds all images for a gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $model</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function find_all_for_gallery($gallery, $model = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      $gallery_id = 0;&nbsp;</div></li><li><div>      if (is_object($gallery)) {&nbsp;</div></li><li><div>          if (isset($gallery-&gt;id_field)) {&nbsp;</div></li><li><div>              $gallery_id = $gallery-&gt;{$gallery-&gt;id_field};&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $key = $this-&gt;object-&gt;get_primary_key_column();&nbsp;</div></li><li><div>              if (isset($gallery-&gt;{$key})) {&nbsp;</div></li><li><div>                  $gallery_id = $gallery-&gt;{$key};&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif (is_numeric($gallery)) {&nbsp;</div></li><li><div>          $gallery_id = $gallery;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($gallery_id) {&nbsp;</div></li><li><div>          $retval = $this-&gt;object-&gt;select()-&gt;where(array(&quot;galleryid = %s&quot;, $gallery_id))-&gt;run_query(FALSE, $model);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * This class provides a lazy-loading wrapper to the NextGen-Legacy &quot;nggImage&quot; class for use in legacy style templates</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Image_Wrapper&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public $_cache;&nbsp;</div></li><li><div>  <span class="comment">// cache of retrieved values</span>&nbsp;</div></li><li><div>  public $_settings;&nbsp;</div></li><li><div>  <span class="comment">// I_Settings_Manager cache</span>&nbsp;</div></li><li><div>  public $_storage;&nbsp;</div></li><li><div>  <span class="comment">// I_Gallery_Storage cache</span>&nbsp;</div></li><li><div>  public $_galleries;&nbsp;</div></li><li><div>  <span class="comment">// cache of I_Gallery_Mapper (plural)</span>&nbsp;</div></li><li><div>  public $_orig_image;&nbsp;</div></li><li><div>  <span class="comment">// original provided image</span>&nbsp;</div></li><li><div>  public $_orig_image_id;&nbsp;</div></li><li><div>  <span class="comment">// original image ID</span>&nbsp;</div></li><li><div>  public $_cache_overrides;&nbsp;</div></li><li><div>  <span class="comment">// allow for forcing variable values</span>&nbsp;</div></li><li><div>  public $_legacy = FALSE;&nbsp;</div></li><li><div>  public $_displayed_gallery;&nbsp;</div></li><li><div>  <span class="comment">// cached object</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Constructor. Converts the image class into an array and fills from defaults any missing values</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $gallery Individual result from displayed_gallery-&gt;get_entities()</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $displayed_gallery Displayed gallery -- MAY BE NULL</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $legacy Whether the image source is from NextGen Legacy or NextGen</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($image, $displayed_gallery = NULL, $legacy = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// for clarity</span>&nbsp;</div></li><li><div>      if ($displayed_gallery && isset($displayed_gallery-&gt;display_settings['number_of_columns'])) {&nbsp;</div></li><li><div>          $columns = $displayed_gallery-&gt;display_settings['number_of_columns'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $columns = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Public variables</span>&nbsp;</div></li><li><div>      $defaults = array('errmsg' =&gt; '', 'error' =&gt; FALSE, 'imageURL' =&gt; '', 'thumbURL' =&gt; '', 'imagePath' =&gt; '', 'thumbPath' =&gt; '', 'href' =&gt; '', 'thumbPrefix' =&gt; 'thumbs_', 'thumbFolder' =&gt; '/thumbs/', 'galleryid' =&gt; 0, 'pid' =&gt; 0, 'filename' =&gt; '', 'description' =&gt; '', 'alttext' =&gt; '', 'imagedate' =&gt; '', 'exclude' =&gt; '', 'thumbcode' =&gt; '', 'name' =&gt; '', 'path' =&gt; '', 'title' =&gt; '', 'pageid' =&gt; 0, 'previewpic' =&gt; 0, 'style' =&gt; $columns &gt; 0 ? 'style=&quot;width:' . floor(100 / $columns) . '%;&quot;' : '', 'hidden' =&gt; FALSE, 'permalink' =&gt; '', 'tags' =&gt; '');&nbsp;</div></li><li><div>      <span class="comment">// convert the image to an array and apply the defaults</span>&nbsp;</div></li><li><div>      $this-&gt;_orig_image = $image;&nbsp;</div></li><li><div>      $image = (array) $image;&nbsp;</div></li><li><div>      foreach ($defaults as $key =&gt; $val) {&nbsp;</div></li><li><div>          if (!isset($image[$key])) {&nbsp;</div></li><li><div>              $image[$key] = $val;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// cache the results</span>&nbsp;</div></li><li><div>      ksort($image);&nbsp;</div></li><li><div>      $id_field = !empty($image['id_field']) ? $image['id_field'] : 'pid';&nbsp;</div></li><li><div>      $this-&gt;_cache = (array) apply_filters('ngg_image_object', (object) $image, $image[$id_field]);&nbsp;</div></li><li><div>      $this-&gt;_orig_image_id = $image[$id_field];&nbsp;</div></li><li><div>      $this-&gt;_legacy = $legacy;&nbsp;</div></li><li><div>      $this-&gt;_displayed_gallery = $displayed_gallery;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function __set($name, $value)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;_cache[$name] = $value;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function __isset($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return isset($this-&gt;_cache[$name]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function __unset($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      unset($this-&gt;_cache[$name]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Lazy-loader for image variables.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name Parameter name</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __get($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (isset($this-&gt;_cache_overrides[$name])) {&nbsp;</div></li><li><div>          return $this-&gt;_cache_overrides[$name];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// at the bottom we default to returning $this-&gt;_cache[$name].</span>&nbsp;</div></li><li><div>      switch ($name) {&nbsp;</div></li><li><div>          case 'alttext':&nbsp;</div></li><li><div>              $this-&gt;_cache['alttext'] = empty($this-&gt;_cache['alttext']) ? ' ' : html_entity_decode(stripslashes($this-&gt;_cache['alttext']));&nbsp;</div></li><li><div>              return $this-&gt;_cache['alttext'];&nbsp;</div></li><li><div>          case 'author':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['author'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['author'];&nbsp;</div></li><li><div>          case 'caption':&nbsp;</div></li><li><div>              $caption = html_entity_decode(stripslashes($this-&gt;__get('description')));&nbsp;</div></li><li><div>              if (empty($caption)) {&nbsp;</div></li><li><div>                  $caption = '&nbsp;';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;_cache['caption'] = $caption;&nbsp;</div></li><li><div>              return $this-&gt;_cache['caption'];&nbsp;</div></li><li><div>          case 'description':&nbsp;</div></li><li><div>              $this-&gt;_cache['description'] = empty($this-&gt;_cache['description']) ? ' ' : html_entity_decode(stripslashes($this-&gt;_cache['description']));&nbsp;</div></li><li><div>              return $this-&gt;_cache['description'];&nbsp;</div></li><li><div>          case 'galdesc':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['galdesc'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['galdesc'];&nbsp;</div></li><li><div>          case 'gid':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['gid'] = $gallery-&gt;{$gallery-&gt;id_field};&nbsp;</div></li><li><div>              return $this-&gt;_cache['gid'];&nbsp;</div></li><li><div>          case 'href':&nbsp;</div></li><li><div>              return $this-&gt;__get('imageHTML');&nbsp;</div></li><li><div>          case 'id':&nbsp;</div></li><li><div>              return $this-&gt;_orig_image_id;&nbsp;</div></li><li><div>          case 'imageHTML':&nbsp;</div></li><li><div>              $tmp = '&lt;a href=&quot;' . $this-&gt;__get('imageURL') . '&quot; title=&quot;' . htmlspecialchars(stripslashes($this-&gt;__get('description'))) . '&quot; ' . $this-&gt;get_thumbcode($this-&gt;__get('name')) . '&gt;' . '&lt;img alt=&quot;' . $this-&gt;__get('alttext') . '&quot; src=&quot;' . $this-&gt;__get('imageURL') . '&quot;/&gt;' . '&lt;/a&gt;';&nbsp;</div></li><li><div>              $this-&gt;_cache['href'] = $tmp;&nbsp;</div></li><li><div>              $this-&gt;_cache['imageHTML'] = $tmp;&nbsp;</div></li><li><div>              return $this-&gt;_cache['imageHTML'];&nbsp;</div></li><li><div>          case 'imagePath':&nbsp;</div></li><li><div>              $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>              $this-&gt;_cache['imagePath'] = $storage-&gt;get_image_abspath($this-&gt;_orig_image, 'full');&nbsp;</div></li><li><div>              return $this-&gt;_cache['imagePath'];&nbsp;</div></li><li><div>          case 'imageURL':&nbsp;</div></li><li><div>              $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>              $this-&gt;_cache['imageURL'] = $storage-&gt;get_image_url($this-&gt;_orig_image, 'full');&nbsp;</div></li><li><div>              return $this-&gt;_cache['imageURL'];&nbsp;</div></li><li><div>          case 'linktitle':&nbsp;</div></li><li><div>              $this-&gt;_cache['linktitle'] = htmlspecialchars(stripslashes($this-&gt;__get('description')));&nbsp;</div></li><li><div>              return $this-&gt;_cache['linktitle'];&nbsp;</div></li><li><div>          case 'name':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['name'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['name'];&nbsp;</div></li><li><div>          case 'pageid':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['pageid'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['pageid'];&nbsp;</div></li><li><div>          case 'path':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['path'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['path'];&nbsp;</div></li><li><div>          case 'permalink':&nbsp;</div></li><li><div>              $this-&gt;_cache['permalink'] = $this-&gt;__get('imageURL');&nbsp;</div></li><li><div>              return $this-&gt;_cache['permalink'];&nbsp;</div></li><li><div>          case 'pid':&nbsp;</div></li><li><div>              return $this-&gt;_orig_image_id;&nbsp;</div></li><li><div>          case 'id_field':&nbsp;</div></li><li><div>              $this-&gt;_cache['id_field'] = !empty($this-&gt;_orig_image-&gt;id_field) ? $this-&gt;_orig_image-&gt;id_field : 'pid';&nbsp;</div></li><li><div>              return $this-&gt;_cache['id_field'];&nbsp;</div></li><li><div>          case 'pidlink':&nbsp;</div></li><li><div>              $application = C_Router::get_instance()-&gt;get_routed_app();&nbsp;</div></li><li><div>              $controller = C_Display_Type_Controller::get_instance();&nbsp;</div></li><li><div>              $this-&gt;_cache['pidlink'] = $controller-&gt;set_param_for($application-&gt;get_routed_url(TRUE), 'pid', $this-&gt;__get('image_slug'));&nbsp;</div></li><li><div>              return $this-&gt;_cache['pidlink'];&nbsp;</div></li><li><div>          case 'previewpic':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['previewpic'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['previewpic'];&nbsp;</div></li><li><div>          case 'size':&nbsp;</div></li><li><div>              $w = 0;&nbsp;</div></li><li><div>              $h = 0;&nbsp;</div></li><li><div>              if ($this-&gt;_displayed_gallery && isset($this-&gt;_displayed_gallery-&gt;display_settings)) {&nbsp;</div></li><li><div>                  $ds = $this-&gt;_displayed_gallery-&gt;display_settings;&nbsp;</div></li><li><div>                  if (isset($ds['override_thumbnail_settings']) && $ds['override_thumbnail_settings']) {&nbsp;</div></li><li><div>                      $w = $ds['thumbnail_width'];&nbsp;</div></li><li><div>                      $h = $ds['thumbnail_height'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!$w || !$h) {&nbsp;</div></li><li><div>                  if (is_string($this-&gt;_orig_image-&gt;meta_data)) {&nbsp;</div></li><li><div>                      $this-&gt;_orig_image = C_Image_Mapper::get_instance()-&gt;unserialize($this-&gt;_orig_image-&gt;meta_data);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (!isset($this-&gt;_orig_image-&gt;meta_data['thumbnail'])) {&nbsp;</div></li><li><div>                      $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>                      $storage-&gt;generate_thumbnail($this-&gt;_orig_image);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $w = $this-&gt;_orig_image-&gt;meta_data['thumbnail']['width'];&nbsp;</div></li><li><div>                  $h = $this-&gt;_orig_image-&gt;meta_data['thumbnail']['height'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return &quot;width='{$w}' height='{$h}'&quot;;&nbsp;</div></li><li><div>          case 'slug':&nbsp;</div></li><li><div>              $gallery = $this-&gt;get_legacy_gallery($this-&gt;__get('galleryid'));&nbsp;</div></li><li><div>              $this-&gt;_cache['slug'] = $gallery-&gt;name;&nbsp;</div></li><li><div>              return $this-&gt;_cache['slug'];&nbsp;</div></li><li><div>          case 'tags':&nbsp;</div></li><li><div>              $this-&gt;_cache['tags'] = wp_get_object_terms($this-&gt;__get('id'), 'ngg_tag', 'fields=all');&nbsp;</div></li><li><div>              return $this-&gt;_cache['tags'];&nbsp;</div></li><li><div>          case 'thumbHTML':&nbsp;</div></li><li><div>              $tmp = '&lt;a href=&quot;' . $this-&gt;__get('imageURL') . '&quot; title=&quot;' . htmlspecialchars(stripslashes($this-&gt;__get('description'))) . '&quot; ' . $this-&gt;get_thumbcode($this-&gt;__get('name')) . '&gt;' . '&lt;img alt=&quot;' . $this-&gt;__get('alttext') . '&quot; src=&quot;' . $this-&gt;thumbURL . '&quot;/&gt;' . '&lt;/a&gt;';&nbsp;</div></li><li><div>              $this-&gt;_cache['href'] = $tmp;&nbsp;</div></li><li><div>              $this-&gt;_cache['thumbHTML'] = $tmp;&nbsp;</div></li><li><div>              return $this-&gt;_cache['thumbHTML'];&nbsp;</div></li><li><div>          case 'thumbPath':&nbsp;</div></li><li><div>              $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>              $this-&gt;_cache['thumbPath'] = $storage-&gt;get_image_abspath($this-&gt;_orig_image, 'thumbnail');&nbsp;</div></li><li><div>              return $this-&gt;_cache['thumbPath'];&nbsp;</div></li><li><div>          case 'thumbnailURL':&nbsp;</div></li><li><div>              $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>              $thumbnail_size_name = 'thumbnail';&nbsp;</div></li><li><div>              if ($this-&gt;_displayed_gallery && isset($this-&gt;_displayed_gallery-&gt;display_settings)) {&nbsp;</div></li><li><div>                  $ds = $this-&gt;_displayed_gallery-&gt;display_settings;&nbsp;</div></li><li><div>                  if (isset($ds['override_thumbnail_settings']) && $ds['override_thumbnail_settings']) {&nbsp;</div></li><li><div>                      $dynthumbs = C_Component_Registry::get_instance()-&gt;get_utility('I_Dynamic_Thumbnails_Manager');&nbsp;</div></li><li><div>                      $dyn_params = array('width' =&gt; $ds['thumbnail_width'], 'height' =&gt; $ds['thumbnail_height']);&nbsp;</div></li><li><div>                      if ($ds['thumbnail_quality']) {&nbsp;</div></li><li><div>                          $dyn_params['quality'] = $ds['thumbnail_quality'];&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($ds['thumbnail_crop']) {&nbsp;</div></li><li><div>                          $dyn_params['crop'] = TRUE;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if ($ds['thumbnail_watermark']) {&nbsp;</div></li><li><div>                          $dyn_params['watermark'] = TRUE;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $thumbnail_size_name = $dynthumbs-&gt;get_size_name($dyn_params);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;_cache['thumbnailURL'] = $storage-&gt;get_image_url($this-&gt;_orig_image, $thumbnail_size_name);&nbsp;</div></li><li><div>              return $this-&gt;_cache['thumbnailURL'];&nbsp;</div></li><li><div>          case 'thumbcode':&nbsp;</div></li><li><div>              if ($this-&gt;_displayed_gallery && isset($this-&gt;_displayed_gallery-&gt;display_settings) && isset($this-&gt;_displayed_gallery-&gt;display_settings['use_imagebrowser_effect']) && $this-&gt;_displayed_gallery-&gt;display_settings['use_imagebrowser_effect'] && !empty($this-&gt;_orig_image-&gt;thumbcode)) {&nbsp;</div></li><li><div>                  $this-&gt;_cache['thumbcode'] = $this-&gt;_orig_image-&gt;thumbcode;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;_cache['thumbcode'] = $this-&gt;get_thumbcode($this-&gt;__get('name'));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              return $this-&gt;_cache['thumbcode'];&nbsp;</div></li><li><div>          case 'thumbURL':&nbsp;</div></li><li><div>              return $this-&gt;__get('thumbnailURL');&nbsp;</div></li><li><div>          case 'title':&nbsp;</div></li><li><div>              $this-&gt;_cache['title'] = stripslashes($this-&gt;__get('name'));&nbsp;</div></li><li><div>              return $this-&gt;_cache['title'];&nbsp;</div></li><li><div>          case 'url':&nbsp;</div></li><li><div>              $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>              $this-&gt;_cache['url'] = $storage-&gt;get_image_url($this-&gt;_orig_image, 'full');&nbsp;</div></li><li><div>              return $this-&gt;_cache['url'];&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              return $this-&gt;_cache[$name];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// called on initial nggLegacy image at construction. not sure what to do with it now.</span>&nbsp;</div></li><li><div>  function construct_ngg_Image($gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      do_action_ref_array('ngg_get_image', array(&$this));&nbsp;</div></li><li><div>      unset($this-&gt;tags);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieves and caches an I_Settings_Manager instance</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_settings()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_null($this-&gt;_settings)) {&nbsp;</div></li><li><div>          $this-&gt;_settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;_settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieves and caches an I_Gallery_Storage instance</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_storage()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_null($this-&gt;_storage)) {&nbsp;</div></li><li><div>          $this-&gt;_storage = C_Gallery_Storage::get_instance();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;_storage;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieves I_Gallery_Mapper instance.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $gallery_id Gallery ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_gallery($gallery_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (isset($this-&gt;container) && method_exists($this-&gt;container, 'get_gallery')) {&nbsp;</div></li><li><div>          return $this-&gt;container-&gt;get_gallery($gallery_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return C_Gallery_Mapper::get_instance()-&gt;find($gallery_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieves I_Gallery_Mapper instance.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $gallery_id Gallery ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_legacy_gallery($gallery_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return C_Gallery_Mapper::get_instance()-&gt;find($gallery_id);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the thumbnail code (to add effects on thumbnail click)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Applies the filter 'ngg_get_thumbcode'</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_thumbcode($gallery_name = '')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (empty($this-&gt;_displayed_gallery)) {&nbsp;</div></li><li><div>          $effect_code = C_NextGen_Settings::get_instance()-&gt;thumbCode;&nbsp;</div></li><li><div>          $effect_code = str_replace('%GALLERY_ID%', $gallery_name, $effect_code);&nbsp;</div></li><li><div>          $effect_code = str_replace('%GALLERY_NAME%', $gallery_name, $effect_code);&nbsp;</div></li><li><div>          $retval = $effect_code;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $controller = C_Display_Type_Controller::get_instance();&nbsp;</div></li><li><div>          $retval = $controller-&gt;get_effect_code($this-&gt;_displayed_gallery);&nbsp;</div></li><li><div>          <span class="comment">// This setting requires that we disable the effect code</span>&nbsp;</div></li><li><div>          $ds = $this-&gt;_displayed_gallery-&gt;display_settings;&nbsp;</div></li><li><div>          if (isset($ds['use_imagebrowser_effect']) && $ds['use_imagebrowser_effect']) {&nbsp;</div></li><li><div>              $retval = '';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = apply_filters('ngg_get_thumbcode', $retval, $this);&nbsp;</div></li><li><div>      <span class="comment">// ensure some additional data- fields are added; provides Pro-Lightbox compatibility</span>&nbsp;</div></li><li><div>      $retval .= ' data-image-id=&quot;' . $this-&gt;__get('id') . '&quot;';&nbsp;</div></li><li><div>      $retval .= ' data-src=&quot;' . $this-&gt;__get('imageURL') . '&quot;';&nbsp;</div></li><li><div>      $retval .= ' data-thumbnail=&quot;' . $this-&gt;__get('thumbnailURL') . '&quot;';&nbsp;</div></li><li><div>      $retval .= ' data-title=&quot;' . esc_attr($this-&gt;__get('alttext')) . '&quot;';&nbsp;</div></li><li><div>      $retval .= ' data-description=&quot;' . esc_attr($this-&gt;__get('description')) . '&quot;';&nbsp;</div></li><li><div>      $this-&gt;_cache['thumbcode'] = $retval;&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * For compatibility support</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_href_link()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;__get('imageHTML');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * For compatibility support</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_href_thumb_link()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;__get('thumbHTML');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function exists for legacy support but has been gutted to not do anything</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $mode could be watermark | web20 | crop</span>&nbsp;</div></li><li><div><span class="comment">   * @return the url for the image or false if failed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cached_singlepic_file($width = '', $height = '', $mode = '')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $dynthumbs = C_Dynamic_Thumbnails_Manager::get_instance();&nbsp;</div></li><li><div>      $storage = $this-&gt;get_storage();&nbsp;</div></li><li><div>      <span class="comment">// determine what to do with 'mode'</span>&nbsp;</div></li><li><div>      $display_reflection = FALSE;&nbsp;</div></li><li><div>      $display_watermark = FALSE;&nbsp;</div></li><li><div>      if (!is_array($mode)) {&nbsp;</div></li><li><div>          $mode = explode(', ', $mode);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (in_array('web20', $mode)) {&nbsp;</div></li><li><div>          $display_reflection = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (in_array('watermark', $mode)) {&nbsp;</div></li><li><div>          $display_watermark = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// and go for it</span>&nbsp;</div></li><li><div>      $params = array('width' =&gt; $width, 'height' =&gt; $height, 'watermark' =&gt; $display_watermark, 'reflection' =&gt; $display_reflection);&nbsp;</div></li><li><div>      return $storage-&gt;get_image_url((object) $this-&gt;_cache, $dynthumbs-&gt;get_size_name($params));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the tags associated to this image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_tags()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;__get('tags');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the permalink to the image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * TODO: Get a permalink to a page presenting the image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_permalink()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;__get('permalink');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the _cache array; used by nggImage</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_image()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;_cache;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_Image_Wrapper_Collection implements ArrayAccess&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public $container = array();&nbsp;</div></li><li><div>  public $galleries = array();&nbsp;</div></li><li><div>  public function offsetExists($offset)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return isset($this-&gt;container[$offset]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function offsetGet($offset)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return isset($this-&gt;container[$offset]) ? $this-&gt;container[$offset] : null;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function offsetSet($offset, $value)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_object($value)) {&nbsp;</div></li><li><div>          $value-&gt;container = $this;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (is_null($offset)) {&nbsp;</div></li><li><div>          $this-&gt;container[] = $value;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;container[$offset] = $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function offsetUnset($offset)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      unset($this-&gt;container[$offset]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieves and caches an I_Gallery_Mapper instance for this gallery id</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $gallery_id Gallery ID</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function get_gallery($gallery_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset($this-&gt;galleries[$gallery_id]) || is_null($this-&gt;galleries[$gallery_id])) {&nbsp;</div></li><li><div>          $this-&gt;galleries[$gallery_id] = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;galleries[$gallery_id];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_NextGen_Data_Installer extends C_NggLegacy_Installer&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function get_registry()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return C_Component_Registry::get_instance();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function install()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;remove_table_extra_options();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function remove_table_extra_options()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $likes = array(&quot;option_name LIKE '%ngg_gallery%'&quot;, &quot;option_name LIKE '%ngg_pictures%'&quot;, &quot;option_name LIKE '%ngg_album%'&quot;);&nbsp;</div></li><li><div>      $sql = &quot;DELETE FROM {$wpdb-&gt;options} WHERE &quot; . implode(&quot; OR &quot;, $likes);&nbsp;</div></li><li><div>      $wpdb-&gt;query($sql);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function uninstall($hard = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($hard) {&nbsp;</div></li><li><div>          <span class="comment">/** Yes: this is commented twice.</span>&nbsp;</div></li><li><div><span class="comment">                  // TODO for now never delete galleries/albums/content</span>&nbsp;</div></li><li><div><span class="comment">          #            $mappers = array(</span>&nbsp;</div></li><li><div><span class="comment">          #                $this-&gt;get_registry()-&gt;get_utility('I_Album_Mapper'), </span>&nbsp;</div></li><li><div><span class="comment">          #                $this-&gt;get_registry()-&gt;get_utility('I_Gallery_Mapper'), </span>&nbsp;</div></li><li><div><span class="comment">          #                $this-&gt;get_registry()-&gt;get_utility('I_Image_Mapper'), </span>&nbsp;</div></li><li><div><span class="comment">          # );</span>&nbsp;</div></li><li><div><span class="comment">          </span>&nbsp;</div></li><li><div><span class="comment">          #            foreach ($mappers as $mapper) {</span>&nbsp;</div></li><li><div><span class="comment">          #                $mapper-&gt;delete()-&gt;run_query();</span>&nbsp;</div></li><li><div><span class="comment">          #            }</span>&nbsp;</div></li><li><div><span class="comment">          </span>&nbsp;</div></li><li><div><span class="comment">          #            // Remove ngg tags</span>&nbsp;</div></li><li><div><span class="comment">          #            global $wpdb;</span>&nbsp;</div></li><li><div><span class="comment">          #            $wpdb-&gt;query(&quot;DELETE FROM {$wpdb-&gt;terms} WHERE term_id IN (SELECT term_id FROM {$wpdb-&gt;term_taxonomy} WHERE taxonomy='ngg_tag')&quot;);</span>&nbsp;</div></li><li><div><span class="comment">          #            $wpdb-&gt;query(&quot;DELETE FROM {$wpdb-&gt;term_taxonomy} WHERE taxonomy='ngg_tag'&quot;);</span>&nbsp;</div></li><li><div><span class="comment">                      */</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_NextGen_Metadata extends C_Component&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">// Image data</span>&nbsp;</div></li><li><div>  public $image = '';&nbsp;</div></li><li><div>  <span class="comment">// The image object</span>&nbsp;</div></li><li><div>  public $file_path = '';&nbsp;</div></li><li><div>  <span class="comment">// Path to the image file</span>&nbsp;</div></li><li><div>  public $size = FALSE;&nbsp;</div></li><li><div>  <span class="comment">// The image size</span>&nbsp;</div></li><li><div>  public $exif_data = FALSE;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// EXIF data array</span></span>&nbsp;</div></li><li><div>  public $iptc_data = FALSE;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// IPTC data array</span></span>&nbsp;</div></li><li><div>  public $xmp_data = FALSE;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// XMP data array</span></span>&nbsp;</div></li><li><div>  <span class="comment">// Filtered Data</span>&nbsp;</div></li><li><div>  public $exif_array = FALSE;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// EXIF data array</span></span>&nbsp;</div></li><li><div>  public $iptc_array = FALSE;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// IPTC data array</span></span>&nbsp;</div></li><li><div>  public $xmp_array = FALSE;&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// XMP data array</span></span>&nbsp;</div></li><li><div>  public $sanitize = FALSE;&nbsp;</div></li><li><div>  <span class="comment">// sanitize meta data on request</span>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Class constructor</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   * @param int $image Image ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $onlyEXIF TRUE = will parse only EXIF data</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool FALSE if the file does not exist or metadat could not be read</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function __construct($image, $onlyEXIF = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = C_Image_Mapper::get_instance()-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;image = apply_filters('ngg_find_image_meta', $image);&nbsp;</div></li><li><div>      $this-&gt;file_path = C_Gallery_Storage::get_instance()-&gt;get_image_abspath($this-&gt;image);&nbsp;</div></li><li><div>      if (!@file_exists($this-&gt;file_path)) {&nbsp;</div></li><li><div>          return FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;size = @getimagesize($this-&gt;file_path, $metadata);&nbsp;</div></li><li><div>      if ($this-&gt;size && is_array($metadata)) {&nbsp;</div></li><li><div>          <span class="comment">// get exif - data</span>&nbsp;</div></li><li><div>          if (is_callable('exif_read_data')) {&nbsp;</div></li><li><div>              $this-&gt;exif_data = @exif_read_data($this-&gt;file_path, NULL, TRUE);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// stop here if we didn't need other meta data</span>&nbsp;</div></li><li><div>          if ($onlyEXIF) {&nbsp;</div></li><li><div>              return TRUE;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// get the iptc data - should be in APP13</span>&nbsp;</div></li><li><div>          if (is_callable('iptcparse') && isset($metadata['APP13'])) {&nbsp;</div></li><li><div>              $this-&gt;iptc_data = @iptcparse($metadata['APP13']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// get the xmp data in a XML format</span>&nbsp;</div></li><li><div>          if (is_callable('xml_parser_create')) {&nbsp;</div></li><li><div>              $this-&gt;xmp_data = $this-&gt;extract_XMP($this-&gt;file_path);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return FALSE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * return the saved meta data from the database</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.4.0</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $object (optional)</span>&nbsp;</div></li><li><div><span class="comment">   * @return array|mixed return either the complete array or the single object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_saved_meta($object = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $meta = $this-&gt;image-&gt;meta_data;&nbsp;</div></li><li><div>      if (!isset($meta['saved'])) {&nbsp;</div></li><li><div>          $meta['saved'] = FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//check if we already import the meta data to the database</span>&nbsp;</div></li><li><div>      if (!is_array($meta) || $meta['saved'] != true) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// return one element if requested</span></span></span></span>&nbsp;</div></li><li><div>      if ($object) {&nbsp;</div></li><li><div>          return $meta[$object];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//removed saved parameter we don't need that to show</span>&nbsp;</div></li><li><div>      unset($meta['saved']);&nbsp;</div></li><li><div>      <span class="comment">// and remove empty tags or arrays</span>&nbsp;</div></li><li><div>      foreach ($meta as $key =&gt; $value) {&nbsp;</div></li><li><div>          if (empty($value) or is_array($value)) {&nbsp;</div></li><li><div>              unset($meta[$key]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// on request sanitize the output</span></span></span></span>&nbsp;</div></li><li><div>      if ($this-&gt;sanitize == true) {&nbsp;</div></li><li><div>          array_walk($meta, create_function('&$value', '$value = esc_html($value);'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $meta;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * nggMeta::get_EXIF()</span>&nbsp;</div></li><li><div><span class="comment">   * See also http://trac.wordpress.org/changeset/6313</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return structured EXIF data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_EXIF($object = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;exif_data) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!is_array($this-&gt;exif_array)) {&nbsp;</div></li><li><div>          $meta = array();&nbsp;</div></li><li><div>          if (isset($this-&gt;exif_data['EXIF'])) {&nbsp;</div></li><li><div>              $exif = $this-&gt;exif_data['EXIF'];&nbsp;</div></li><li><div>              if (!empty($exif['FNumber'])) {&nbsp;</div></li><li><div>                  $meta['aperture'] = 'F ' . round($this-&gt;exif_frac2dec($exif['FNumber']), 2);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Model'])) {&nbsp;</div></li><li><div>                  $meta['camera'] = trim($exif['Model']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['DateTimeDigitized'])) {&nbsp;</div></li><li><div>                  $meta['created_timestamp'] = $this-&gt;exif_date2ts($exif['DateTimeDigitized']);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if (!empty($exif['DateTimeOriginal'])) {&nbsp;</div></li><li><div>                      $meta['created_timestamp'] = $this-&gt;exif_date2ts($exif['DateTimeOriginal']);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if (!empty($exif['FileDateTime'])) {&nbsp;</div></li><li><div>                          $meta['created_timestamp'] = $this-&gt;exif_date2ts($exif['FileDateTime']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['FocalLength'])) {&nbsp;</div></li><li><div>                  $meta['focal_length'] = $this-&gt;exif_frac2dec($exif['FocalLength']) . __(' mm', 'nggallery');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['ISOSpeedRatings'])) {&nbsp;</div></li><li><div>                  $meta['iso'] = $exif['ISOSpeedRatings'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['ExposureTime'])) {&nbsp;</div></li><li><div>                  $meta['shutter_speed'] = $this-&gt;exif_frac2dec($exif['ExposureTime']);&nbsp;</div></li><li><div>                  $meta['shutter_speed'] = ($meta['shutter_speed'] &gt; 0.0 and $meta['shutter_speed'] &lt; 1.0) ? '1/' . round(1 / $meta['shutter_speed'], -1) : $meta['shutter_speed'];&nbsp;</div></li><li><div>                  $meta['shutter_speed'] .= __(' sec', 'nggallery');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">//Bit 0 indicates the flash firing status</span>&nbsp;</div></li><li><div>              if (!empty($exif['Flash'])) {&nbsp;</div></li><li><div>                  $meta['flash'] = $exif['Flash'] & 1 ? __('Fired', 'nggallery') : __('Not fired', ' nggallery');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// additional information</span>&nbsp;</div></li><li><div>          if (isset($this-&gt;exif_data['IFD0'])) {&nbsp;</div></li><li><div>              $exif = $this-&gt;exif_data['IFD0'];&nbsp;</div></li><li><div>              if (!empty($exif['Model'])) {&nbsp;</div></li><li><div>                  $meta['camera'] = $exif['Model'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Make'])) {&nbsp;</div></li><li><div>                  $meta['make'] = $exif['Make'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['ImageDescription'])) {&nbsp;</div></li><li><div>                  $meta['title'] = $this-&gt;utf8_encode($exif['ImageDescription']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Orientation'])) {&nbsp;</div></li><li><div>                  $meta['Orientation'] = $exif['Orientation'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// this is done by Windows</span>&nbsp;</div></li><li><div>          if (isset($this-&gt;exif_data['WINXP'])) {&nbsp;</div></li><li><div>              $exif = $this-&gt;exif_data['WINXP'];&nbsp;</div></li><li><div>              if (!empty($exif['Title']) && empty($meta['title'])) {&nbsp;</div></li><li><div>                  $meta['title'] = $this-&gt;utf8_encode($exif['Title']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Author'])) {&nbsp;</div></li><li><div>                  $meta['author'] = $this-&gt;utf8_encode($exif['Author']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Keywords'])) {&nbsp;</div></li><li><div>                  $meta['tags'] = $this-&gt;utf8_encode($exif['Keywords']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Subject'])) {&nbsp;</div></li><li><div>                  $meta['subject'] = $this-&gt;utf8_encode($exif['Subject']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!empty($exif['Comments'])) {&nbsp;</div></li><li><div>                  $meta['caption'] = $this-&gt;utf8_encode($exif['Comments']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;exif_array = $meta;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// return one element if requested</span></span></span></span>&nbsp;</div></li><li><div>      if ($object == true) {&nbsp;</div></li><li><div>          $value = isset($this-&gt;exif_array[$object]) ? $this-&gt;exif_array[$object] : false;&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// on request sanitize the output</span></span></span></span>&nbsp;</div></li><li><div>      if ($this-&gt;sanitize == true) {&nbsp;</div></li><li><div>          array_walk($this-&gt;exif_array, create_function('&$value', '$value = esc_html($value);'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;exif_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// convert a fraction string to a decimal</span>&nbsp;</div></li><li><div>  function exif_frac2dec($str)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      @(list($n, $d) = explode('/', $str));&nbsp;</div></li><li><div>      if (!empty($d)) {&nbsp;</div></li><li><div>          return $n / $d;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// convert the exif date format to a unix timestamp</span>&nbsp;</div></li><li><div>  function exif_date2ts($str)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = is_numeric($str) ? $str : @strtotime($str);&nbsp;</div></li><li><div>      if (!$retval && $str) {&nbsp;</div></li><li><div>          @(list($date, $time) = explode(' ', trim($str)));&nbsp;</div></li><li><div>          @(list($y, $m, $d) = explode(':', $date));&nbsp;</div></li><li><div>          $retval = strtotime(&quot;{$y}-{$m}-{$d} {$time}&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * nggMeta::readIPTC() - IPTC Data Information for EXIF Display</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $output_tag</span>&nbsp;</div></li><li><div><span class="comment">   * @return IPTC-tags</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_IPTC($object = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;iptc_data) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!is_array($this-&gt;iptc_array)) {&nbsp;</div></li><li><div>          <span class="comment">// --------- Set up Array Functions --------- //</span>&nbsp;</div></li><li><div>          $iptcTags = array(&quot;2#005&quot; =&gt; 'title', &quot;2#007&quot; =&gt; 'status', &quot;2#012&quot; =&gt; 'subject', &quot;2#015&quot; =&gt; 'category', &quot;2#025&quot; =&gt; 'keywords', &quot;2#055&quot; =&gt; 'created_date', &quot;2#060&quot; =&gt; 'created_time', &quot;2#080&quot; =&gt; 'author', &quot;2#085&quot; =&gt; 'position', &quot;2#090&quot; =&gt; 'city', &quot;2#092&quot; =&gt; 'location', &quot;2#095&quot; =&gt; 'state', &quot;2#100&quot; =&gt; 'country_code', &quot;2#101&quot; =&gt; 'country', &quot;2#105&quot; =&gt; 'headline', &quot;2#110&quot; =&gt; 'credit', &quot;2#115&quot; =&gt; 'source', &quot;2#116&quot; =&gt; 'copyright', &quot;2#118&quot; =&gt; 'contact', &quot;2#120&quot; =&gt; 'caption');&nbsp;</div></li><li><div>          $meta = array();&nbsp;</div></li><li><div>          foreach ($iptcTags as $key =&gt; $value) {&nbsp;</div></li><li><div>              if (isset($this-&gt;iptc_data[$key])) {&nbsp;</div></li><li><div>                  $meta[$value] = trim($this-&gt;utf8_encode(implode(&quot;, &quot;, $this-&gt;iptc_data[$key])));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;iptc_array = $meta;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// return one element if requested</span></span></span></span>&nbsp;</div></li><li><div>      if ($object) {&nbsp;</div></li><li><div>          return isset($this-&gt;iptc_array[$object]) ? $this-&gt;iptc_array[$object] : NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// on request sanitize the output</span></span></span></span>&nbsp;</div></li><li><div>      if ($this-&gt;sanitize == true) {&nbsp;</div></li><li><div>          array_walk($this-&gt;iptc_array, create_function('&$value', '$value = esc_html($value);'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;iptc_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * nggMeta::extract_XMP()</span>&nbsp;</div></li><li><div><span class="comment">   * get XMP DATA</span>&nbsp;</div></li><li><div><span class="comment">   * code by Pekka Saarinen http://photography-on-the.net</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $filename</span>&nbsp;</div></li><li><div><span class="comment">   * @return XML data</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function extract_XMP($filename)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//TODO:Require a lot of memory, could be better</span>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>      @readfile($filename);&nbsp;</div></li><li><div>      $source = ob_get_contents();&nbsp;</div></li><li><div>      ob_end_clean();&nbsp;</div></li><li><div>      $start = strpos($source, &quot;&lt;x:xmpmeta&quot;);&nbsp;</div></li><li><div>      $end = strpos($source, &quot;&lt;/x:xmpmeta&gt;&quot;);&nbsp;</div></li><li><div>      if (!$start === false && !$end === false) {&nbsp;</div></li><li><div>          $lenght = $end - $start;&nbsp;</div></li><li><div>          $xmp_data = substr($source, $start, $lenght + 12);&nbsp;</div></li><li><div>          unset($source);&nbsp;</div></li><li><div>          return $xmp_data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      unset($source);&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * nggMeta::get_XMP()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @package Taken from http://php.net/manual/en/function.xml-parse-into-struct.php</span>&nbsp;</div></li><li><div><span class="comment">   * @author Alf Marius Foss Olsen & Alex Rabe</span>&nbsp;</div></li><li><div><span class="comment">   * @return XML Array or object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_XMP($object = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;xmp_data) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!is_array($this-&gt;xmp_array)) {&nbsp;</div></li><li><div>          $parser = xml_parser_create();&nbsp;</div></li><li><div>          xml_parser_set_option($parser, XML_OPTION_CASE_FOLDING, 0);&nbsp;</div></li><li><div>          <span class="comment">// Dont mess with my cAsE sEtTings</span>&nbsp;</div></li><li><div>          xml_parser_set_option($parser, XML_OPTION_SKIP_WHITE, 1);&nbsp;</div></li><li><div>          <span class="comment">// Dont bother with empty info</span>&nbsp;</div></li><li><div>          xml_parse_into_struct($parser, $this-&gt;xmp_data, $values);&nbsp;</div></li><li><div>          xml_parser_free($parser);&nbsp;</div></li><li><div>          $xmlarray = array();&nbsp;</div></li><li><div>          <span class="comment">// The XML array</span>&nbsp;</div></li><li><div>          $this-&gt;xmp_array = array();&nbsp;</div></li><li><div>          <span class="comment">// The returned array</span>&nbsp;</div></li><li><div>          $stack = array();&nbsp;</div></li><li><div>          <span class="comment">// tmp array used for stacking</span>&nbsp;</div></li><li><div>          $list_array = array();&nbsp;</div></li><li><div>          <span class="comment">// tmp array for list elements</span>&nbsp;</div></li><li><div>          $list_element = false;&nbsp;</div></li><li><div>          <span class="comment">// rdf:li indicator</span>&nbsp;</div></li><li><div>          foreach ($values as $val) {&nbsp;</div></li><li><div>              if ($val['type'] == &quot;open&quot;) {&nbsp;</div></li><li><div>                  array_push($stack, $val['tag']);&nbsp;</div></li><li><div>              } elseif ($val['type'] == &quot;close&quot;) {&nbsp;</div></li><li><div>                  <span class="comment">// reset the compared stack</span>&nbsp;</div></li><li><div>                  if ($list_element == false) {&nbsp;</div></li><li><div>                      array_pop($stack);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  <span class="comment">// reset the rdf:li indicator & array</span>&nbsp;</div></li><li><div>                  $list_element = false;&nbsp;</div></li><li><div>                  $list_array = array();&nbsp;</div></li><li><div>              } elseif ($val['type'] == &quot;complete&quot;) {&nbsp;</div></li><li><div>                  if ($val['tag'] == &quot;rdf:li&quot;) {&nbsp;</div></li><li><div>                      <span class="comment">// first go one element back</span>&nbsp;</div></li><li><div>                      if ($list_element == false) {&nbsp;</div></li><li><div>                          array_pop($stack);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $list_element = true;&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// do not parse empty tags</span></span>&nbsp;</div></li><li><div>                      if (empty($val['value'])) {&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      <span class="comment">// save it in our temp array</span>&nbsp;</div></li><li><div>                      $list_array[] = $val['value'];&nbsp;</div></li><li><div>                      <span class="comment">// in the case it's a list element we seralize it</span>&nbsp;</div></li><li><div>                      $value = implode(&quot;, &quot;, $list_array);&nbsp;</div></li><li><div>                      $this-&gt;setArrayValue($xmlarray, $stack, $value);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      array_push($stack, $val['tag']);&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// do not parse empty tags</span></span>&nbsp;</div></li><li><div>                      if (!empty($val['value'])) {&nbsp;</div></li><li><div>                          $this-&gt;setArrayValue($xmlarray, $stack, $val['value']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      array_pop($stack);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// foreach</span>&nbsp;</div></li><li><div>          <span class="comment">// don't parse a empty array</span>&nbsp;</div></li><li><div>          if (empty($xmlarray) || empty($xmlarray['x:xmpmeta'])) {&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// cut off the useless tags</span>&nbsp;</div></li><li><div>          $xmlarray = $xmlarray['x:xmpmeta']['rdf:RDF']['rdf:Description'];&nbsp;</div></li><li><div>          <span class="comment">// --------- Some values from the XMP format--------- //</span>&nbsp;</div></li><li><div>          $xmpTags = array('xap:CreateDate' =&gt; 'created_timestamp', 'xap:ModifyDate' =&gt; 'last_modfied', 'xap:CreatorTool' =&gt; 'tool', 'dc:format' =&gt; 'format', 'dc:title' =&gt; 'title', 'dc:creator' =&gt; 'author', 'dc:subject' =&gt; 'keywords', 'dc:description' =&gt; 'caption', 'photoshop:AuthorsPosition' =&gt; 'position', 'photoshop:City' =&gt; 'city', 'photoshop:Country' =&gt; 'country');&nbsp;</div></li><li><div>          foreach ($xmpTags as $key =&gt; $value) {&nbsp;</div></li><li><div>              <span class="comment">// if the kex exist</span>&nbsp;</div></li><li><div>              if (isset($xmlarray[$key])) {&nbsp;</div></li><li><div>                  switch ($key) {&nbsp;</div></li><li><div>                      case 'xap:CreateDate':&nbsp;</div></li><li><div>                      case 'xap:ModifyDate':&nbsp;</div></li><li><div>                          $this-&gt;xmp_array[$value] = strtotime($xmlarray[$key]);&nbsp;</div></li><li><div>                          break;&nbsp;</div></li><li><div>                      default:&nbsp;</div></li><li><div>                          $this-&gt;xmp_array[$value] = $xmlarray[$key];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// return one element if requested</span></span></span></span>&nbsp;</div></li><li><div>      if ($object != false) {&nbsp;</div></li><li><div>          return isset($this-&gt;xmp_array[$object]) ? $this-&gt;xmp_array[$object] : false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// on request sanitize the output</span></span></span></span>&nbsp;</div></li><li><div>      if ($this-&gt;sanitize == true) {&nbsp;</div></li><li><div>          array_walk($this-&gt;xmp_array, create_function('&$value', '$value = esc_html($value);'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;xmp_array;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function setArrayValue(&$array, $stack, $value)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($stack) {&nbsp;</div></li><li><div>          $key = array_shift($stack);&nbsp;</div></li><li><div>          $this-&gt;setArrayValue($array[$key], $stack, $value);&nbsp;</div></li><li><div>          return $array;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $array = $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * nggMeta::get_META() - return a meta value form the available list</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $object</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed $value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_META($object = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// defined order first look into database, then XMP, IPTC and EXIF.</span>&nbsp;</div></li><li><div>      if ($value = $this-&gt;get_saved_meta($object)) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($value = $this-&gt;get_XMP($object)) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($object == 'created_timestamp' && ($d = $this-&gt;get_IPTC('created_date')) && ($t = $this-&gt;get_IPTC('created_time'))) {&nbsp;</div></li><li><div>          return $this-&gt;exif_date2ts($d . ' ' . $t);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($value = $this-&gt;get_IPTC($object)) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($value = $this-&gt;get_EXIF($object)) {&nbsp;</div></li><li><div>          return $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// nothing found ?</span>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * nggMeta::i8n_name() -  localize the tag name</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $key</span>&nbsp;</div></li><li><div><span class="comment">   * @return translated $key</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function i18n_name($key)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $tagnames = array('aperture' =&gt; __('Aperture', 'nggallery'), 'credit' =&gt; __('Credit', 'nggallery'), 'camera' =&gt; __('Camera', 'nggallery'), 'caption' =&gt; __('Caption', 'nggallery'), 'created_timestamp' =&gt; __('Date/Time', 'nggallery'), 'copyright' =&gt; __('Copyright', 'nggallery'), 'focal_length' =&gt; __('Focal length', 'nggallery'), 'iso' =&gt; __('ISO', 'nggallery'), 'shutter_speed' =&gt; __('Shutter speed', 'nggallery'), 'title' =&gt; __('Title', 'nggallery'), 'author' =&gt; __('Author', 'nggallery'), 'tags' =&gt; __('Tags', 'nggallery'), 'subject' =&gt; __('Subject', 'nggallery'), 'make' =&gt; __('Make', 'nggallery'), 'status' =&gt; __('Edit Status', 'nggallery'), 'category' =&gt; __('Category', 'nggallery'), 'keywords' =&gt; __('Keywords', 'nggallery'), 'created_date' =&gt; __('Date Created', 'nggallery'), 'created_time' =&gt; __('Time Created', 'nggallery'), 'position' =&gt; __('Author Position', 'nggallery'), 'city' =&gt; __('City', 'nggallery'), 'location' =&gt; __('Location', 'nggallery'), 'state' =&gt; __('Province/State', 'nggallery'), 'country_code' =&gt; __('Country code', 'nggallery'), 'country' =&gt; __('Country', 'nggallery'), 'headline' =&gt; __('Headline', 'nggallery'), 'credit' =&gt; __('Credit', 'nggallery'), 'source' =&gt; __('Source', 'nggallery'), 'copyright' =&gt; __('Copyright Notice', 'nggallery'), 'contact' =&gt; __('Contact', 'nggallery'), 'last_modfied' =&gt; __('Last modified', 'nggallery'), 'tool' =&gt; __('Program tool', 'nggallery'), 'format' =&gt; __('Format', 'nggallery'), 'width' =&gt; __('Image Width', 'nggallery'), 'height' =&gt; __('Image Height', 'nggallery'), 'flash' =&gt; __('Flash', 'nggallery'));&nbsp;</div></li><li><div>      if (isset($tagnames[$key])) {&nbsp;</div></li><li><div>          $key = $tagnames[$key];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $key;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Return the Timestamp from the image , if possible it's read from exif data</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_date_time()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $date = time();&nbsp;</div></li><li><div>      <span class="comment">// Try getting the created_timestamp field</span>&nbsp;</div></li><li><div>      $date = $this-&gt;exif_date2ts($this-&gt;get_META('created_timestamp'));&nbsp;</div></li><li><div>      if (!$date) {&nbsp;</div></li><li><div>          $image_path = C_Gallery_Storage::get_instance()-&gt;get_backup_abspath($this-&gt;image);&nbsp;</div></li><li><div>          $date = @filectime($image_path);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Failback</span>&nbsp;</div></li><li><div>      if (!$date) {&nbsp;</div></li><li><div>          $date = time();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Return the MySQL format</span>&nbsp;</div></li><li><div>      $date_time = date('Y-m-d H:i:s', $date);&nbsp;</div></li><li><div>      return $date_time;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * This function return the most common metadata, via a filter we can add more</span>&nbsp;</div></li><li><div><span class="comment">   * Reason : GD manipulation removes that options</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since V1.4.0</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_common_meta()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $meta = array('aperture' =&gt; 0, 'credit' =&gt; '', 'camera' =&gt; '', 'caption' =&gt; '', 'created_timestamp' =&gt; 0, 'copyright' =&gt; '', 'focal_length' =&gt; 0, 'iso' =&gt; 0, 'shutter_speed' =&gt; 0, 'flash' =&gt; 0, 'title' =&gt; '', 'keywords' =&gt; '');&nbsp;</div></li><li><div>      $meta = apply_filters('ngg_read_image_metadata', $meta);&nbsp;</div></li><li><div>      <span class="comment">// meta should be still an array</span>&nbsp;</div></li><li><div>      if (!is_array($meta)) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      foreach ($meta as $key =&gt; $value) {&nbsp;</div></li><li><div>          $meta[$key] = $this-&gt;get_META($key);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//let's add now the size of the image</span>&nbsp;</div></li><li><div>      $meta['width'] = $this-&gt;size[0];&nbsp;</div></li><li><div>      $meta['height'] = $this-&gt;size[1];&nbsp;</div></li><li><div>      return $meta;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If needed sanitize each value before output</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function sanitize()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;sanitize = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Wrapper to utf8_encode() that avoids double encoding</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Regex adapted from http://www.w3.org/International/questions/qa-forms-utf-8.en.php</span>&nbsp;</div></li><li><div><span class="comment">   * to determine if the given string is already UTF-8. mb_detect_encoding() is not</span>&nbsp;</div></li><li><div><span class="comment">   * always available and is limited in accuracy</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $str</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function utf8_encode($str)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $is_utf8 = preg_match('%^(?:&nbsp;</div></li><li><div>            [\\x09\\x0A\\x0D\\x20-\\x7E]            # ASCII&nbsp;</div></li><li><div>          | [\\xC2-\\xDF][\\x80-\\xBF]             # non-overlong 2-byte&nbsp;</div></li><li><div>          |  \\xE0[\\xA0-\\xBF][\\x80-\\xBF]        # excluding overlongs&nbsp;</div></li><li><div>          | [\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}  # straight 3-byte&nbsp;</div></li><li><div>          |  \\xED[\\x80-\\x9F][\\x80-\\xBF]        # excluding surrogates&nbsp;</div></li><li><div>          |  \\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}     # planes 1-3&nbsp;</div></li><li><div>          | [\\xF1-\\xF3][\\x80-\\xBF]{3}          # planes 4-15&nbsp;</div></li><li><div>          |  \\xF4[\\x80-\\x8F][\\x80-\\xBF]{2}     # plane 16&nbsp;</div></li><li><div> )*$%xs', $str);&nbsp;</div></li><li><div>      if (!$is_utf8) {&nbsp;</div></li><li><div>          utf8_encode($str);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $str;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_NggLegacy_GalleryStorage_Driver extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the named sizes available for images</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_sizes()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return array('full', 'thumbnail');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_upload_abspath($gallery = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Base upload path</span>&nbsp;</div></li><li><div>      $retval = C_NextGen_Settings::get_instance()-&gt;gallerypath;&nbsp;</div></li><li><div>      $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>      <span class="comment">// If a gallery has been specified, then we'll</span>&nbsp;</div></li><li><div>      <span class="comment">// append the slug</span>&nbsp;</div></li><li><div>      if ($gallery) {&nbsp;</div></li><li><div>          $retval = $this-&gt;get_gallery_abspath($gallery);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// We need to make this an absolute path</span>&nbsp;</div></li><li><div>      if (strpos($retval, $fs-&gt;get_document_root('gallery')) !== 0) {&nbsp;</div></li><li><div>          $retval = rtrim($fs-&gt;join_paths($fs-&gt;get_document_root('gallery'), $retval), &quot;/\\&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Convert slashes</span>&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;convert_slashes($retval);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get the gallery path persisted in the database for the gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_NextGen_Gallery $gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_gallery_abspath($gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>      <span class="comment">// Get the gallery entity from the database</span>&nbsp;</div></li><li><div>      if ($gallery) {&nbsp;</div></li><li><div>          if (is_numeric($gallery)) {&nbsp;</div></li><li><div>              $gallery = $this-&gt;object-&gt;_gallery_mapper-&gt;find($gallery);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// It just doesn't exist</span>&nbsp;</div></li><li><div>      if (!$gallery || is_numeric($gallery)) {&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// We we have a gallery, determine it's path</span>&nbsp;</div></li><li><div>      if ($gallery) {&nbsp;</div></li><li><div>          if (isset($gallery-&gt;path)) {&nbsp;</div></li><li><div>              $retval = $gallery-&gt;path;&nbsp;</div></li><li><div>          } elseif (isset($gallery-&gt;slug)) {&nbsp;</div></li><li><div>              $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>              $basepath = C_NextGen_Settings::get_instance()-&gt;gallerypath;&nbsp;</div></li><li><div>              $retval = $fs-&gt;join_paths($basepath, sanitize_file_name(sanitize_title($gallery-&gt;slug)));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $root_type = defined('NGG_GALLERY_ROOT_TYPE') ? NGG_GALLERY_ROOT_TYPE : 'site';&nbsp;</div></li><li><div>      if ($root_type == 'content') {&nbsp;</div></li><li><div>          <span class="comment">// This requires explanation: in case our content root ends with the same directory name</span>&nbsp;</div></li><li><div>          <span class="comment">// that the gallery path begins with we remove the duplicate name from $retval. This is</span>&nbsp;</div></li><li><div>          <span class="comment">// necessary because the default WP_CONTENT_DIR setting ends in /wp-content/ and</span>&nbsp;</div></li><li><div>          <span class="comment">// NextGEN's default gallery path begins with /wp-content/. This also allows gallery</span>&nbsp;</div></li><li><div>          <span class="comment">// paths to also be expressed as simply &quot;/gallery-name/&quot;</span>&nbsp;</div></li><li><div>          $exploded_root = explode(DIRECTORY_SEPARATOR, trim($fs-&gt;get_document_root('content'), '/\\'));&nbsp;</div></li><li><div>          $exploded_gallery = explode(DIRECTORY_SEPARATOR, trim($retval, '/\\'));&nbsp;</div></li><li><div>          $exploded_gallery = array_values($exploded_gallery);&nbsp;</div></li><li><div>          $last_gallery_dirname = $exploded_gallery[0];&nbsp;</div></li><li><div>          $last_root_dirname = end($exploded_root);&nbsp;</div></li><li><div>          if ($last_root_dirname === $last_gallery_dirname) {&nbsp;</div></li><li><div>              unset($exploded_gallery[0]);&nbsp;</div></li><li><div>              $retval = implode(DIRECTORY_SEPARATOR, $exploded_gallery);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Ensure that the path is absolute</span>&nbsp;</div></li><li><div>      if (strpos($retval, $fs-&gt;get_document_root('gallery')) !== 0) {&nbsp;</div></li><li><div>          $retval = rtrim($fs-&gt;join_paths($fs-&gt;get_document_root('gallery'), $retval), &quot;/\\&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;convert_slashes(rtrim($retval, &quot;/\\&quot;));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the absolute path where the image is stored</span>&nbsp;</div></li><li><div><span class="comment">   * Can optionally return the path for a particular sized image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_abspath($image, $size = 'full', $check_existance = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>      <span class="comment">// Ensure that we have a size</span>&nbsp;</div></li><li><div>      if (!$size) {&nbsp;</div></li><li><div>          $size = 'full';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If we have the id, get the actual image entity</span>&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Ensure we have the image entity - user could have passed in an</span>&nbsp;</div></li><li><div>      <span class="comment">// incorrect id</span>&nbsp;</div></li><li><div>      if (is_object($image)) {&nbsp;</div></li><li><div>          if ($gallery_path = $this-&gt;object-&gt;get_gallery_abspath($image-&gt;galleryid)) {&nbsp;</div></li><li><div>              $folder = $prefix = $size;&nbsp;</div></li><li><div>              switch ($size) {&nbsp;</div></li><li><div>                  # Images are stored in the associated gallery folder&nbsp;</div></li><li><div>                  case 'full':&nbsp;</div></li><li><div>                  case 'original':&nbsp;</div></li><li><div>                  case 'image':&nbsp;</div></li><li><div>                      $retval = $fs-&gt;join_paths($gallery_path, $image-&gt;filename);&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'backup':&nbsp;</div></li><li><div>                      $retval = $fs-&gt;join_paths($gallery_path, $image-&gt;filename . '_backup');&nbsp;</div></li><li><div>                      if ($check_existance && !@file_exists($retval)) {&nbsp;</div></li><li><div>                          $retval = $fs-&gt;join_paths($gallery_path, $image-&gt;filename);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>                  case 'thumbnails':&nbsp;</div></li><li><div>                  case 'thumbnail':&nbsp;</div></li><li><div>                  case 'thumb':&nbsp;</div></li><li><div>                  case 'thumbs':&nbsp;</div></li><li><div>                      $size = 'thumbnail';&nbsp;</div></li><li><div>                      $folder = 'thumbs';&nbsp;</div></li><li><div>                      $prefix = 'thumbs';&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// deliberately no break here</span></span>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// We assume any other size of image is stored in the a</span></span>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">//subdirectory of the same name within the gallery folder</span></span>&nbsp;</div></li><li><div>                      <span class="comment"><span class="comment">// gallery folder, but with the size appended to the filename</span></span>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// deliberately no break here</span></span>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// We assume any other size of image is stored in the a</span></span>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">//subdirectory of the same name within the gallery folder</span></span>&nbsp;</div></li><li><div>                  <span class="comment"><span class="comment">// gallery folder, but with the size appended to the filename</span></span>&nbsp;</div></li><li><div>                  default:&nbsp;</div></li><li><div>                      $image_path = $fs-&gt;join_paths($gallery_path, $folder);&nbsp;</div></li><li><div>                      <span class="comment">// NGG 2.0 stores relative filenames in the meta data of</span>&nbsp;</div></li><li><div>                      <span class="comment">// an image. It does this because it uses filenames</span>&nbsp;</div></li><li><div>                      <span class="comment">// that follow conventional WordPress naming scheme.</span>&nbsp;</div></li><li><div>                      if (isset($image-&gt;meta_data) && isset($image-&gt;meta_data[$size]) && isset($image-&gt;meta_data[$size]['filename'])) {&nbsp;</div></li><li><div>                          $image_path = $fs-&gt;join_paths($image_path, $image-&gt;meta_data[$size]['filename']);&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $image_path = $fs-&gt;join_paths($image_path, &quot;{$prefix}_{$image-&gt;filename}&quot;);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $retval = $image_path;&nbsp;</div></li><li><div>                      break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Check the existance of the file</span>&nbsp;</div></li><li><div>      if ($retval && $check_existance) {&nbsp;</div></li><li><div>          if (!@file_exists($retval)) {&nbsp;</div></li><li><div>              $retval = NULL;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval ? rtrim($retval, &quot;/\\&quot;) : $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url of a particular-sized image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $size</span>&nbsp;</div></li><li><div><span class="comment">   * @returns array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_url($image, $size = 'full', $check_existance = FALSE, $image_abspath = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>      $router = C_Router::get_instance();&nbsp;</div></li><li><div>      if (!$image_abspath) {&nbsp;</div></li><li><div>          $image_abspath = $this-&gt;object-&gt;get_image_abspath($image, $size, $check_existance);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($image_abspath) {&nbsp;</div></li><li><div>          <span class="comment">// Use multibyte pathinfo() in case of UTF8 gallery or file names</span>&nbsp;</div></li><li><div>          $parts = M_I18n::mb_pathinfo($image_abspath);&nbsp;</div></li><li><div>          $image_abspath = $parts['dirname'] . DIRECTORY_SEPARATOR . $parts['basename'];&nbsp;</div></li><li><div>          $doc_root = $fs-&gt;get_document_root('gallery');&nbsp;</div></li><li><div>          if ($doc_root != null) {&nbsp;</div></li><li><div>              $doc_root = rtrim($doc_root, &quot;/\\&quot;) . DIRECTORY_SEPARATOR;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// if docroot is &quot;/&quot; we would generate urls like /wp-contentpluginsnextgen-galleryetcetc</span>&nbsp;</div></li><li><div>          if ($doc_root !== '/') {&nbsp;</div></li><li><div>              $request_uri = str_replace($doc_root, '', $image_abspath);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $request_uri = $image_abspath;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $request_uri = '/' . ltrim(str_replace(&quot;\\&quot;, '/', $request_uri), &quot;/&quot;);&nbsp;</div></li><li><div>          <span class="comment">// Because like%@this.jpg is a valid directory and filename</span>&nbsp;</div></li><li><div>          $request_uri = explode('/', $request_uri);&nbsp;</div></li><li><div>          foreach ($request_uri as $ndx =&gt; $segment) {&nbsp;</div></li><li><div>              $request_uri[$ndx] = rawurlencode($segment);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $request_uri = implode('/', $request_uri);&nbsp;</div></li><li><div>          $retval = $router-&gt;remove_url_segment('/index.php', $router-&gt;get_url($request_uri, FALSE, 'gallery'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters('ngg_get_image_url', $retval, $image, $size);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Uploads an image for a particular gallerys</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_NextGEN_Gallery $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $filename, specifies the name of the file</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $data if specified, expects base64 encoded string of data</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Image</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function upload_image($gallery, $filename = FALSE, $data = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      <span class="comment">// Ensure that we have the data present that we require</span>&nbsp;</div></li><li><div>      if (isset($_FILES['file']) && $_FILES['file']['error'] == 0) {&nbsp;</div></li><li><div>          <span class="comment">//        $_FILES = Array(</span>&nbsp;</div></li><li><div>          <span class="comment">//         [file] =&gt;    Array (</span>&nbsp;</div></li><li><div>          <span class="comment">//            [name] =&gt; Canada_landscape4.jpg</span>&nbsp;</div></li><li><div>          <span class="comment">//            [type] =&gt; image/jpeg</span>&nbsp;</div></li><li><div>          <span class="comment">//            [tmp_name] =&gt; /private/var/tmp/php6KO7Dc</span>&nbsp;</div></li><li><div>          <span class="comment">//            [error] =&gt; 0</span>&nbsp;</div></li><li><div>          <span class="comment">//            [size] =&gt; 64975</span>&nbsp;</div></li><li><div>          <span class="comment">// )</span>&nbsp;</div></li><li><div>          <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">          $file = $_FILES['file'];</span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;is_zip()) {&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;upload_zip($gallery);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ($this-&gt;is_image_file()) {&nbsp;</div></li><li><div>                  $retval = $this-&gt;object-&gt;upload_base64_image($gallery, file_get_contents($file['tmp_name']), $filename ? $filename : (isset($file['name']) ? $file['name'] : FALSE));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  <span class="comment">// Remove the non-valid (and potentially insecure) file from the PHP upload directory</span>&nbsp;</div></li><li><div>                  if (isset($_FILES['file']['tmp_name'])) {&nbsp;</div></li><li><div>                      $filename = $_FILES['file']['tmp_name'];&nbsp;</div></li><li><div>                      @unlink($filename);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  throw new E_UploadException(__('Invalid image file. Acceptable formats: JPG, GIF, and PNG.', 'nggallery'));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ($data) {&nbsp;</div></li><li><div>          $retval = $this-&gt;object-&gt;upload_base64_image($filename, $data);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          throw new E_UploadException();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_image_size_params($image, $size, $params = null, $skip_defaults = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Get the image</span> entity&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $params = apply_filters('ngg_get_image_size_params', $params, $size, $image);&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Ensure we have a valid image</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>          if (!$skip_defaults) {&nbsp;</div></li><li><div>              <span class="comment">// Get default settings</span>&nbsp;</div></li><li><div>              if ($size == 'full') {&nbsp;</div></li><li><div>                  if (!isset($params['quality'])) {&nbsp;</div></li><li><div>                      $params['quality'] = $settings-&gt;imgQuality;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if (!isset($params['crop'])) {&nbsp;</div></li><li><div>                      $params['crop'] = $settings-&gt;thumbfix;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (!isset($params['quality'])) {&nbsp;</div></li><li><div>                      $params['quality'] = $settings-&gt;thumbquality;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Not sure why this was here... commenting out for now, always require watermark parameters to be explicit</span>&nbsp;</div></li><li><div>              #                if (!isset($params['watermark'])) {&nbsp;</div></li><li><div>              #                    $params['watermark'] = $settings-&gt;wmType;&nbsp;</div></li><li><div>              #                }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// width and height when omitted make generate_image_clone create a clone with original size, so try find defaults regardless of $skip_defaults</span>&nbsp;</div></li><li><div>          if (!isset($params['width']) || !isset($params['height'])) {&nbsp;</div></li><li><div>              <span class="comment">// First test if this is a &quot;known&quot; image size, i.e. if we store these sizes somewhere when users re-generate these sizes from the UI...this is required to be compatible with legacy</span>&nbsp;</div></li><li><div>              <span class="comment">// try the 2 default built-in sizes, first thumbnail...</span>&nbsp;</div></li><li><div>              if ($size == 'thumbnail') {&nbsp;</div></li><li><div>                  if (!isset($params['width'])) {&nbsp;</div></li><li><div>                      $params['width'] = $settings-&gt;thumbwidth;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (!isset($params['height'])) {&nbsp;</div></li><li><div>                      $params['height'] = $settings-&gt;thumbheight;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ($size == 'full') {&nbsp;</div></li><li><div>                      if (!isset($params['width'])) {&nbsp;</div></li><li><div>                          if ($settings-&gt;imgAutoResize) {&nbsp;</div></li><li><div>                              $params['width'] = $settings-&gt;imgWidth;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      if (!isset($params['height'])) {&nbsp;</div></li><li><div>                          if ($settings-&gt;imgAutoResize) {&nbsp;</div></li><li><div>                              $params['height'] = $settings-&gt;imgHeight;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      if (isset($image-&gt;meta_data) && isset($image-&gt;meta_data[$size])) {&nbsp;</div></li><li><div>                          $dimensions = $image-&gt;meta_data[$size];&nbsp;</div></li><li><div>                          if (!isset($params['width'])) {&nbsp;</div></li><li><div>                              $params['width'] = $dimensions['width'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          if (!isset($params['height'])) {&nbsp;</div></li><li><div>                              $params['height'] = $dimensions['height'];&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!isset($params['crop_frame'])) {&nbsp;</div></li><li><div>              $crop_frame_size_name = 'thumbnail';&nbsp;</div></li><li><div>              if (isset($image-&gt;meta_data[$size]['crop_frame'])) {&nbsp;</div></li><li><div>                  $crop_frame_size_name = $size;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (isset($image-&gt;meta_data[$crop_frame_size_name]['crop_frame'])) {&nbsp;</div></li><li><div>                  $params['crop_frame'] = $image-&gt;meta_data[$crop_frame_size_name]['crop_frame'];&nbsp;</div></li><li><div>                  if (!isset($params['crop_frame']['final_width'])) {&nbsp;</div></li><li><div>                      $params['crop_frame']['final_width'] = $image-&gt;meta_data[$crop_frame_size_name]['width'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if (!isset($params['crop_frame']['final_height'])) {&nbsp;</div></li><li><div>                      $params['crop_frame']['final_height'] = $image-&gt;meta_data[$crop_frame_size_name]['height'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if (!isset($params['crop_frame']['final_width'])) {&nbsp;</div></li><li><div>                  $params['crop_frame']['final_width'] = $params['width'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!isset($params['crop_frame']['final_height'])) {&nbsp;</div></li><li><div>                  $params['crop_frame']['final_height'] = $params['height'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $params;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an array of dimensional properties (width, height, real_width, real_height) of a resulting clone image if and when generated</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $image_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $clone_path</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calculate_image_size_dimensions($image, $size, $params = null, $skip_defaults = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// Get the image</span> entity&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Ensure we have a valid image</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          $params = $this-&gt;object-&gt;get_image_size_params($image, $size, $params, $skip_defaults);&nbsp;</div></li><li><div>          <span class="comment">// Get the image</span> filename&nbsp;</div></li><li><div>          $image_path = $this-&gt;object-&gt;get_original_abspath($image, 'original');&nbsp;</div></li><li><div>          $clone_path = $this-&gt;object-&gt;get_image_abspath($image, $size);&nbsp;</div></li><li><div>          $retval = $this-&gt;object-&gt;calculate_image_clone_dimensions($image_path, $clone_path, $params);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a specific size for an image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Image $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool|object</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function generate_image_size($image, $size, $params = null, $skip_defaults = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// Get the image</span> entity&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment"><span class="comment">// Ensure we have a valid image</span></span></span></span></span></span>&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          $params = $this-&gt;object-&gt;get_image_size_params($image, $size, $params, $skip_defaults);&nbsp;</div></li><li><div>          $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>          <span class="comment">// Get the image</span> filename&nbsp;</div></li><li><div>          $filename = $this-&gt;object-&gt;get_original_abspath($image, 'original');&nbsp;</div></li><li><div>          $thumbnail = null;&nbsp;</div></li><li><div>          if ($size == 'full' && $settings-&gt;imgBackup == 1) {&nbsp;</div></li><li><div>              <span class="comment">// XXX change this? 'full' should be the resized path and 'original' the _backup path</span>&nbsp;</div></li><li><div>              $backup_path = $this-&gt;object-&gt;get_backup_abspath($image);&nbsp;</div></li><li><div>              if (!@file_exists($backup_path)) {&nbsp;</div></li><li><div>                  @copy($filename, $backup_path);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Generate the thumbnail using WordPress</span>&nbsp;</div></li><li><div>          $existing_image_abpath = $this-&gt;object-&gt;get_image_abspath($image, $size);&nbsp;</div></li><li><div>          $existing_image_dir = dirname($existing_image_abpath);&nbsp;</div></li><li><div>          <span class="comment">// removing the old thumbnail is actually not needed as generate_image_clone() will replace it, leaving commented in as reminder in case there are issues in the future</span>&nbsp;</div></li><li><div>          if (@file_exists($existing_image_abpath)) {&nbsp;</div></li><li><div>              <span class="comment">//unlink($existing_image_abpath);</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_mkdir_p($existing_image_dir);&nbsp;</div></li><li><div>          $clone_path = $existing_image_abpath;&nbsp;</div></li><li><div>          $thumbnail = $this-&gt;object-&gt;generate_image_clone($filename, $clone_path, $params);&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// We successfully generated the thumbnail</span></span>&nbsp;</div></li><li><div>          if ($thumbnail != null) {&nbsp;</div></li><li><div>              $clone_path = $thumbnail-&gt;fileName;&nbsp;</div></li><li><div>              if (function_exists('getimagesize')) {&nbsp;</div></li><li><div>                  $dimensions = getimagesize($clone_path);&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $dimensions = array($params['width'], $params['height']);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (!isset($image-&gt;meta_data)) {&nbsp;</div></li><li><div>                  $image-&gt;meta_data = array();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $size_meta = array('width' =&gt; $dimensions[0], 'height' =&gt; $dimensions[1], 'filename' =&gt; M_I18n::mb_basename($clone_path), 'generated' =&gt; microtime());&nbsp;</div></li><li><div>              if (isset($params['crop_frame'])) {&nbsp;</div></li><li><div>                  $size_meta['crop_frame'] = $params['crop_frame'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $image-&gt;meta_data[$size] = $size_meta;&nbsp;</div></li><li><div>              if ($size == 'full') {&nbsp;</div></li><li><div>                  $image-&gt;meta_data['width'] = $size_meta['width'];&nbsp;</div></li><li><div>                  $image-&gt;meta_data['height'] = $size_meta['height'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;_image_mapper-&gt;save($image);&nbsp;</div></li><li><div>              do_action('ngg_generated_image', $image, $size, $params);&nbsp;</div></li><li><div>              if ($retval == 0) {&nbsp;</div></li><li><div>                  $retval = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($retval) {&nbsp;</div></li><li><div>                  $retval = $thumbnail;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Something went wrong. Thumbnail generation failed!</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Generates a thumbnail for an image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Image $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function generate_thumbnail($image, $params = null, $skip_defaults = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $sized_image = $this-&gt;object-&gt;generate_image_size($image, 'thumbnail', $params, $skip_defaults);&nbsp;</div></li><li><div>      $retval = false;&nbsp;</div></li><li><div>      if ($sized_image != null) {&nbsp;</div></li><li><div>          $retval = true;&nbsp;</div></li><li><div>          $sized_image-&gt;destruct();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Outputs/renders an image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_NextGen_Gallery_Image $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function render_image($image, $size = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $format_list = $this-&gt;object-&gt;get_image_format_list();&nbsp;</div></li><li><div>      $abspath = $this-&gt;get_image_abspath($image, $size, true);&nbsp;</div></li><li><div>      if ($abspath == null) {&nbsp;</div></li><li><div>          $thumbnail = $this-&gt;object-&gt;generate_image_size($image, $size);&nbsp;</div></li><li><div>          if ($thumbnail != null) {&nbsp;</div></li><li><div>              $abspath = $thumbnail-&gt;fileName;&nbsp;</div></li><li><div>              $thumbnail-&gt;destruct();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($abspath != null) {&nbsp;</div></li><li><div>          $data = @getimagesize($abspath);&nbsp;</div></li><li><div>          $format = 'jpg';&nbsp;</div></li><li><div>          if ($data != null && is_array($data) && isset($format_list[$data[2]])) {&nbsp;</div></li><li><div>              $format = $format_list[$data[2]];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Clear output</span>&nbsp;</div></li><li><div>          while (ob_get_level() &gt; 0) {&nbsp;</div></li><li><div>              ob_end_clean();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $format = strtolower($format);&nbsp;</div></li><li><div>          <span class="comment">// output image and headers</span>&nbsp;</div></li><li><div>          header('Content-type: image/' . $format);&nbsp;</div></li><li><div>          readfile($abspath);&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function delete_gallery($gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>      $safe_dirs = array(DIRECTORY_SEPARATOR, $fs-&gt;get_document_root('plugins'), $fs-&gt;get_document_root('plugins_mu'), $fs-&gt;get_document_root('templates'), $fs-&gt;get_document_root('stylesheets'), $fs-&gt;get_document_root('content'), $fs-&gt;get_document_root('galleries'), $fs-&gt;get_document_root());&nbsp;</div></li><li><div>      $abspath = $this-&gt;object-&gt;get_gallery_abspath($gallery);&nbsp;</div></li><li><div>      if ($abspath && file_exists($abspath) && !in_array(stripslashes($abspath), $safe_dirs)) {&nbsp;</div></li><li><div>          <span class="comment">// delete the directory and everything in it</span>&nbsp;</div></li><li><div>          $iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($abspath), RecursiveIteratorIterator::CHILD_FIRST);&nbsp;</div></li><li><div>          foreach ($iterator as $file) {&nbsp;</div></li><li><div>              if (in_array($file-&gt;getBasename(), array('.', '..'))) {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              } elseif ($file-&gt;isDir()) {&nbsp;</div></li><li><div>                  rmdir($file-&gt;getPathname());&nbsp;</div></li><li><div>              } elseif ($file-&gt;isFile() || $file-&gt;isLink()) {&nbsp;</div></li><li><div>                  unlink($file-&gt;getPathname());&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = @rmdir($abspath);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function delete_image($image, $size = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// Ensure that we have the image entity</span>&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          $image_id = $image-&gt;{$image-&gt;id_field};&nbsp;</div></li><li><div>          do_action('ngg_delete_image', $image_id, $size);&nbsp;</div></li><li><div>          <span class="comment">// Delete only a particular image size</span>&nbsp;</div></li><li><div>          if ($size) {&nbsp;</div></li><li><div>              $abspath = $this-&gt;object-&gt;get_image_abspath($image, $size);&nbsp;</div></li><li><div>              if ($abspath && @file_exists($abspath)) {&nbsp;</div></li><li><div>                  unlink($abspath);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (isset($image-&gt;meta_data) && isset($image-&gt;meta_data[$size])) {&nbsp;</div></li><li><div>                  unset($image-&gt;meta_data[$size]);&nbsp;</div></li><li><div>                  $this-&gt;object-&gt;_image_mapper-&gt;save($image);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Get the paths to fullsize and thumbnail files</span>&nbsp;</div></li><li><div>              $abspaths = array($this-&gt;object-&gt;get_full_abspath($image), $this-&gt;object-&gt;get_thumb_abspath($image), $this-&gt;object-&gt;get_backup_abspath($image));&nbsp;</div></li><li><div>              if (isset($image-&gt;meta_data)) {&nbsp;</div></li><li><div>                  foreach (array_keys($image-&gt;meta_data) as $size) {&nbsp;</div></li><li><div>                      $abspaths[] = $this-&gt;object-&gt;get_image_abspath($image, $size);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Delete each image</span>&nbsp;</div></li><li><div>              foreach ($abspaths as $abspath) {&nbsp;</div></li><li><div>                  if ($abspath && @file_exists($abspath)) {&nbsp;</div></li><li><div>                      unlink($abspath);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Delete the entity</span>&nbsp;</div></li><li><div>              $this-&gt;object-&gt;_image_mapper-&gt;destroy($image);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function set_post_thumbnail($post, $image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $attachment_id = null;&nbsp;</div></li><li><div>      <span class="comment">// Get the post id</span>&nbsp;</div></li><li><div>      $post_id = $post;&nbsp;</div></li><li><div>      if (is_object($post)) {&nbsp;</div></li><li><div>          if (property_exists($post, 'ID')) {&nbsp;</div></li><li><div>              $post_id = $post-&gt;ID;&nbsp;</div></li><li><div>          } elseif (property_exists($post, 'post_id')) {&nbsp;</div></li><li><div>              $post_id = $post-&gt;post_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif (is_array($post)) {&nbsp;</div></li><li><div>          if (isset($post['ID'])) {&nbsp;</div></li><li><div>              $post_id = $post['ID'];&nbsp;</div></li><li><div>          } elseif (isset($post['post_id'])) {&nbsp;</div></li><li><div>              $post_id = $post['post_id'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Get the image</span> object&nbsp;</div></li><li><div>      if (is_int($image)) {&nbsp;</div></li><li><div>          $image = C_Image_Mapper::get_instance()-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Do we have what we need?</span>&nbsp;</div></li><li><div>      if ($image && is_int($post_id)) {&nbsp;</div></li><li><div>          $args = array('post_type' =&gt; 'attachment', 'meta_key' =&gt; '_ngg_image_id', 'meta_compare' =&gt; '==', 'meta_value' =&gt; $image-&gt;{$image-&gt;id_field});&nbsp;</div></li><li><div>          $upload_dir = wp_upload_dir();&nbsp;</div></li><li><div>          $basedir = $upload_dir['basedir'];&nbsp;</div></li><li><div>          $thumbs_dir = implode(DIRECTORY_SEPARATOR, array($basedir, 'ngg_featured'));&nbsp;</div></li><li><div>          $gallery_abspath = $this-&gt;object-&gt;get_gallery_abspath($image-&gt;galleryid);&nbsp;</div></li><li><div>          $image_abspath = $this-&gt;object-&gt;get_full_abspath($image);&nbsp;</div></li><li><div>          $target_path = null;&nbsp;</div></li><li><div>          $copy_image = TRUE;&nbsp;</div></li><li><div>          <span class="comment">// Have we previously set the post thumbnail?</span>&nbsp;</div></li><li><div>          if ($posts = get_posts($args)) {&nbsp;</div></li><li><div>              $attachment_id = $posts[0]-&gt;ID;&nbsp;</div></li><li><div>              $attachment_file = get_attached_file($attachment_id);&nbsp;</div></li><li><div>              $target_path = $attachment_file;&nbsp;</div></li><li><div>              if (filemtime($image_abspath) &gt; filemtime($target_path)) {&nbsp;</div></li><li><div>                  $copy_image = TRUE;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $url = $this-&gt;object-&gt;get_full_url($image);&nbsp;</div></li><li><div>              $target_relpath = null;&nbsp;</div></li><li><div>              $target_basename = M_I18n::mb_basename($image_abspath);&nbsp;</div></li><li><div>              if (strpos($image_abspath, $gallery_abspath) === 0) {&nbsp;</div></li><li><div>                  $target_relpath = substr($image_abspath, strlen($gallery_abspath));&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ($image-&gt;galleryid) {&nbsp;</div></li><li><div>                      $target_relpath = path_join(strval($image-&gt;galleryid), $target_basename);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $target_relpath = $target_basename;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $target_relpath = trim($target_relpath, '\\/');&nbsp;</div></li><li><div>              $target_path = path_join($thumbs_dir, $target_relpath);&nbsp;</div></li><li><div>              $max_count = 100;&nbsp;</div></li><li><div>              $count = 0;&nbsp;</div></li><li><div>              while (@file_exists($target_path) && $count &lt;= $max_count) {&nbsp;</div></li><li><div>                  $count++;&nbsp;</div></li><li><div>                  $pathinfo = M_I18n::mb_pathinfo($target_path);&nbsp;</div></li><li><div>                  $dirname = $pathinfo['dirname'];&nbsp;</div></li><li><div>                  $filename = $pathinfo['filename'];&nbsp;</div></li><li><div>                  $extension = $pathinfo['extension'];&nbsp;</div></li><li><div>                  $rand = mt_rand(1, 9999);&nbsp;</div></li><li><div>                  $basename = $filename . '_' . sprintf('%04d', $rand) . '.' . $extension;&nbsp;</div></li><li><div>                  $target_path = path_join($dirname, $basename);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (@file_exists($target_path)) {&nbsp;</div></li><li><div>                  <span class="comment">// XXX handle very rare case in which $max_count wasn't enough?</span>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $target_dir = dirname($target_path);&nbsp;</div></li><li><div>              wp_mkdir_p($target_dir);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($copy_image) {&nbsp;</div></li><li><div>              @copy($image_abspath, $target_path);&nbsp;</div></li><li><div>              if (!$attachment_id) {&nbsp;</div></li><li><div>                  $size = @getimagesize($target_path);&nbsp;</div></li><li><div>                  $image_type = $size ? $size['mime'] : 'image/jpeg';&nbsp;</div></li><li><div>                  $title = sanitize_file_name($image-&gt;alttext);&nbsp;</div></li><li><div>                  $caption = sanitize_file_name($image-&gt;description);&nbsp;</div></li><li><div>                  $attachment = array('post_title' =&gt; $title, 'post_content' =&gt; $caption, 'post_status' =&gt; 'attachment', 'post_parent' =&gt; 0, 'post_mime_type' =&gt; $image_type, 'guid' =&gt; $url);&nbsp;</div></li><li><div>                  $attachment_id = wp_insert_attachment($attachment, $target_path);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              update_post_meta($attachment_id, '_ngg_image_id', $image-&gt;{$image-&gt;id_field});&nbsp;</div></li><li><div>              wp_update_attachment_metadata($attachment_id, wp_generate_attachment_metadata($attachment_id, $target_path));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $attachment_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Copies (or moves) images into another gallery</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $images</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $db optionally only copy the image files</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $move move the image instead of copying</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed NULL on failure, array|image-ids on success</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function copy_images($images, $gallery, $db = TRUE, $move = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $new_image_pids = array();&nbsp;</div></li><li><div>      <span class="comment">// the return value</span>&nbsp;</div></li><li><div>      <span class="comment">// legacy requires passing just a numeric ID</span>&nbsp;</div></li><li><div>      if (is_numeric($gallery)) {&nbsp;</div></li><li><div>          $gallery = $this-&gt;object-&gt;_gallery_mapper-&gt;find($gallery);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// move_images() is a wrapper to this function so we implement both features here</span>&nbsp;</div></li><li><div>      $func = $move ? 'rename' : 'copy';&nbsp;</div></li><li><div>      <span class="comment">// legacy allows for arrays of just the ID</span>&nbsp;</div></li><li><div>      if (!is_array($images)) {&nbsp;</div></li><li><div>          $images = array($images);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Ensure we have a valid gallery</span></span>&nbsp;</div></li><li><div>      $gallery_id = $this-&gt;object-&gt;_get_gallery_id($gallery);&nbsp;</div></li><li><div>      if (!$gallery_id) {&nbsp;</div></li><li><div>          return array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $image_key = $this-&gt;object-&gt;_image_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $gallery_abspath = $this-&gt;object-&gt;get_gallery_abspath($gallery);&nbsp;</div></li><li><div>      <span class="comment">// Check for folder permission</span>&nbsp;</div></li><li><div>      if (!is_dir($gallery_abspath) && !wp_mkdir_p($gallery_abspath)) {&nbsp;</div></li><li><div>          echo sprintf(__('Unable to create directory %s.', 'nggallery'), esc_html($gallery_abspath));&nbsp;</div></li><li><div>          return $new_image_pids;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!is_writable($gallery_abspath)) {&nbsp;</div></li><li><div>          echo sprintf(__('Unable to write to directory %s. Is this directory writable by the server?', 'nggallery'), esc_html($gallery_abspath));&nbsp;</div></li><li><div>          return $new_image_pids;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_gallery_ids = array();&nbsp;</div></li><li><div>      $image_pid_map = array();&nbsp;</div></li><li><div>      foreach ($images as $image) {&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;is_current_user_over_quota()) {&nbsp;</div></li><li><div>              throw new E_NoSpaceAvailableException(__('Sorry, you have used your space allocation. Please delete some files to upload more files.', 'nggallery'));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// again legacy requires that it be able to pass just a numeric ID</span>&nbsp;</div></li><li><div>          if (is_numeric($image)) {&nbsp;</div></li><li><div>              $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $old_gallery_ids[] = $image-&gt;galleryid;&nbsp;</div></li><li><div>          $old_pid = $image-&gt;{$image_key};&nbsp;</div></li><li><div>          <span class="comment">// update the DB if requested</span>&nbsp;</div></li><li><div>          $new_image = clone $image;&nbsp;</div></li><li><div>          $new_pid = $old_pid;&nbsp;</div></li><li><div>          if ($db) {&nbsp;</div></li><li><div>              unset($new_image-&gt;extras_post_id);&nbsp;</div></li><li><div>              $new_image-&gt;galleryid = $gallery_id;&nbsp;</div></li><li><div>              if (!$move) {&nbsp;</div></li><li><div>                  $new_image-&gt;image_slug = nggdb::get_unique_slug(sanitize_title_with_dashes($image-&gt;alttext), 'image');&nbsp;</div></li><li><div>                  unset($new_image-&gt;{$image_key});&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $new_pid = $this-&gt;object-&gt;_image_mapper-&gt;save($new_image);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!$new_pid) {&nbsp;</div></li><li><div>              echo sprintf(__('Failed to copy database row for picture %s', 'nggallery'), $old_pid) . '&lt;br /&gt;';&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// 'backup' is not included in get_image_sizes()</span>&nbsp;</div></li><li><div>          $sizes = $this-&gt;object-&gt;get_image_sizes();&nbsp;</div></li><li><div>          $sizes[] = 'backup';&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Copy each image size</span></span>&nbsp;</div></li><li><div>          foreach ($sizes as $size) {&nbsp;</div></li><li><div>              <span class="comment">// if backups are off there's no backup file to copy</span>&nbsp;</div></li><li><div>              if (!C_NextGen_Settings::get_instance()-&gt;imgBackup && $size == 'backup') {&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $orig_path = $this-&gt;object-&gt;get_image_abspath($image, $size, TRUE);&nbsp;</div></li><li><div>              if (!$orig_path || !@file_exists($orig_path)) {&nbsp;</div></li><li><div>                  echo sprintf(__('Failed to get image path for %s', 'nggallery'), esc_html(M_I18n::mb_basename($orig_path))) . '&lt;br/&gt;';&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $new_path = $this-&gt;object-&gt;get_image_abspath($new_image, $size, FALSE);&nbsp;</div></li><li><div>              <span class="comment">// Prevent duplicate filenames: check if the filename exists and</span> begin appending '-#'&nbsp;</div></li><li><div>              if (!ini_get('safe_mode') && @file_exists($new_path)) {&nbsp;</div></li><li><div>                  <span class="comment">// prevent get_image_abspath() from using the thumbnail filename in metadata</span>&nbsp;</div></li><li><div>                  unset($new_image-&gt;meta_data['thumbnail']['filename']);&nbsp;</div></li><li><div>                  $file_exists = TRUE;&nbsp;</div></li><li><div>                  $i = 0;&nbsp;</div></li><li><div>                  do {&nbsp;</div></li><li><div>                      $i++;&nbsp;</div></li><li><div>                      $parts = explode('.', $image-&gt;filename);&nbsp;</div></li><li><div>                      $extension = array_pop($parts);&nbsp;</div></li><li><div>                      $tmp_filename = implode('.', $parts) . '-' . $i . '.' . $extension;&nbsp;</div></li><li><div>                      $new_image-&gt;filename = $tmp_filename;&nbsp;</div></li><li><div>                      $tmp_path = $this-&gt;object-&gt;get_image_abspath($new_image, $size, FALSE);&nbsp;</div></li><li><div>                      if (!@file_exists($tmp_path)) {&nbsp;</div></li><li><div>                          $file_exists = FALSE;&nbsp;</div></li><li><div>                          $new_path = $tmp_path;&nbsp;</div></li><li><div>                          if ($db) {&nbsp;</div></li><li><div>                              $this-&gt;object-&gt;_image_mapper-&gt;save($new_image);&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  } while ($file_exists == TRUE);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Copy files</span>&nbsp;</div></li><li><div>              if (!@$func($orig_path, $new_path)) {&nbsp;</div></li><li><div>                  echo sprintf(__('Failed to copy image %1$s to %2$s', 'nggallery'), esc_html($orig_path), esc_html($new_path)) . '&lt;br/&gt;';&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// disabling: this is a bit too verbose</span>&nbsp;</div></li><li><div>              <span class="comment">// if (!empty($tmp_path))</span>&nbsp;</div></li><li><div>              <span class="comment">//     echo sprintf(__('Image %1$s (%2$s) copied as image %3$s (%4$s) &raquo; The file already existed in the destination gallery.', 'nggallery'), $old_pid, esc_html($orig_path), $new_pid, esc_html($new_path)) . '&lt;br /&gt;';</span>&nbsp;</div></li><li><div>              <span class="comment">// else</span>&nbsp;</div></li><li><div>              <span class="comment">//     echo sprintf(__('Image %1$s (%2$s) copied as image %3$s (%4$s)', 'nggallery'), $old_pid, esc_html($orig_path), $new_pid, esc_html($new_path)) . '&lt;br /&gt;';</span>&nbsp;</div></li><li><div>              <span class="comment">// Copy tags</span>&nbsp;</div></li><li><div>              if ($db) {&nbsp;</div></li><li><div>                  $tags = wp_get_object_terms($old_pid, 'ngg_tag', 'fields=ids');&nbsp;</div></li><li><div>                  $tags = array_map('intval', $tags);&nbsp;</div></li><li><div>                  wp_set_object_terms($new_pid, $tags, 'ngg_tag', true);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $new_image_pids[] = $new_pid;&nbsp;</div></li><li><div>          $image_pid_map[$old_pid] = $new_pid;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $old_gallery_ids = array_unique($old_gallery_ids);&nbsp;</div></li><li><div>      if ($move) {&nbsp;</div></li><li><div>          do_action('ngg_moved_images', $images, $old_gallery_ids, $gallery_id);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          do_action('ngg_copied_images', $image_pid_map, $old_gallery_ids, $gallery_id);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $title = '&lt;a href=&quot;' . admin_url() . 'admin.php?page=nggallery-manage-gallery&mode=edit&gid=' . $gallery_id . '&quot; &gt;';&nbsp;</div></li><li><div>      $title .= $gallery-&gt;title;&nbsp;</div></li><li><div>      $title .= '&lt;/a&gt;';&nbsp;</div></li><li><div>      echo '&lt;hr/&gt;' . sprintf(__('Copied %1$s picture(s) to gallery %2$s .', 'nggallery'), count($new_image_pids), $title);&nbsp;</div></li><li><div>      return $new_image_pids;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Recover image from backup copy and reprocess it</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|stdClass|C_Image $image</span>&nbsp;</div></li><li><div><span class="comment">   * @return string result code</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function recover_image($image)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if (is_numeric($image)) {&nbsp;</div></li><li><div>          $image = $this-&gt;object-&gt;_image_mapper-&gt;find($image);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($image) {&nbsp;</div></li><li><div>          $full_abspath = $this-&gt;object-&gt;get_image_abspath($image);&nbsp;</div></li><li><div>          $backup_abspath = $this-&gt;object-&gt;get_image_abspath($image, 'backup');&nbsp;</div></li><li><div>          if ($backup_abspath != $full_abspath && @file_exists($backup_abspath)) {&nbsp;</div></li><li><div>              if (is_writable($full_abspath) && is_writable(dirname($full_abspath))) {&nbsp;</div></li><li><div>                  <span class="comment">// Copy the backup</span>&nbsp;</div></li><li><div>                  if (@copy($backup_abspath, $full_abspath)) {&nbsp;</div></li><li><div>                      <span class="comment">// Re-create non-fullsize image sizes</span>&nbsp;</div></li><li><div>                      foreach ($this-&gt;object-&gt;get_image_sizes($image) as $named_size) {&nbsp;</div></li><li><div>                          if ($named_size == 'full') {&nbsp;</div></li><li><div>                              continue;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                          $this-&gt;object-&gt;generate_image_clone($backup_abspath, $this-&gt;object-&gt;get_image_abspath($image, $named_size), $this-&gt;object-&gt;get_image_size_params($image, $named_size));&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      do_action('ngg_recovered_image', $image);&nbsp;</div></li><li><div>                      <span class="comment">// Reimport all metadata</span>&nbsp;</div></li><li><div>                      $retval = $this-&gt;object-&gt;_image_mapper-&gt;reimport_metadata($image);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_NggLegacy_GalleryStorage_Driver</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_NggLegacy_GalleryStorage_Driver</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_NggLegacy_GalleryStorage_Driver extends C_GalleryStorage_Driver_Base&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function define($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_NggLegacy_GalleryStorage_Driver');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * gd.thumbnail.inc.php</span>&nbsp;</div></li><li><div><span class="comment"> * </span>&nbsp;</div></li><li><div><span class="comment"> * @author         Ian Selby (ian@gen-x-design.com)</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright     Copyright 2006-2011</span>&nbsp;</div></li><li><div><span class="comment"> * @version     1.3.0 (based on 1.1.3)</span>&nbsp;</div></li><li><div><span class="comment"> * @modded      by Alex Rabe</span>&nbsp;</div></li><li><div><span class="comment"> * </span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * PHP class for dynamically resizing, cropping, and rotating images for thumbnail purposes and either displaying them on-the-fly or saving them.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_NggLegacy_Thumbnail&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Error message to display, if any</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $errmsg;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Whether or not there is an error</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $error;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Format of the image file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $format;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * File name and path of the image file</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $fileName;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Current dimensions of working image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $currentDimensions;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * New dimensions of working image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $newDimensions;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Image resource for newly manipulated image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var resource</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $newImage;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Image resource for image before previous manipulation</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var resource</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $oldImage;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Image resource for image being currently manipulated</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var resource</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $workingImage;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Percentage to resize image by</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var int</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $percent;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Maximum width of image during resize</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var int</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $maxWidth;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Maximum height of image during resize</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var int</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $maxHeight;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Image for Watermark</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $watermarkImgPath;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Text for Watermark</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  var $watermarkText;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Image Resource ID for Watermark</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @var string</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function __construct($fileName, $no_ErrorImage = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//make sure the GD library is installed</span>&nbsp;</div></li><li><div>      if (!function_exists(&quot;gd_info&quot;)) {&nbsp;</div></li><li><div>          echo 'You do not have the GD Library installed.  This class requires the GD library to function properly.' . &quot;\n&quot;;&nbsp;</div></li><li><div>          echo 'visit http:<span class="comment">//us2.php.net/manual/en/ref.image.php for more information';</span>&nbsp;</div></li><li><div>          throw new E_No_Image_Library_Exception();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//initialize variables</span>&nbsp;</div></li><li><div>      $this-&gt;errmsg = '';&nbsp;</div></li><li><div>      $this-&gt;error = false;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions = array();&nbsp;</div></li><li><div>      $this-&gt;newDimensions = array();&nbsp;</div></li><li><div>      $this-&gt;fileName = $fileName;&nbsp;</div></li><li><div>      $this-&gt;percent = 100;&nbsp;</div></li><li><div>      $this-&gt;maxWidth = 0;&nbsp;</div></li><li><div>      $this-&gt;maxHeight = 0;&nbsp;</div></li><li><div>      $this-&gt;watermarkImgPath = '';&nbsp;</div></li><li><div>      $this-&gt;watermarkText = '';&nbsp;</div></li><li><div>      <span class="comment">//check to see if file exists</span>&nbsp;</div></li><li><div>      if (!@file_exists($this-&gt;fileName)) {&nbsp;</div></li><li><div>          $this-&gt;errmsg = 'File not found';&nbsp;</div></li><li><div>          $this-&gt;error = true;&nbsp;</div></li><li><div>      } elseif (!is_readable($this-&gt;fileName)) {&nbsp;</div></li><li><div>          $this-&gt;errmsg = 'File is not readable';&nbsp;</div></li><li><div>          $this-&gt;error = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//if there are no errors, determine the file format</span>&nbsp;</div></li><li><div>      if ($this-&gt;error == false) {&nbsp;</div></li><li><div>          @ini_set('memory_limit', -1);&nbsp;</div></li><li><div>          $data = @getimagesize($this-&gt;fileName);&nbsp;</div></li><li><div>          if (isset($data) && is_array($data)) {&nbsp;</div></li><li><div>              $extensions = array('1' =&gt; 'GIF', '2' =&gt; 'JPG', '3' =&gt; 'PNG');&nbsp;</div></li><li><div>              $extension = array_key_exists($data[2], $extensions) ? $extensions[$data[2]] : '';&nbsp;</div></li><li><div>              if ($extension) {&nbsp;</div></li><li><div>                  $this-&gt;format = $extension;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $this-&gt;errmsg = 'Unknown file format';&nbsp;</div></li><li><div>                  $this-&gt;error = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $this-&gt;errmsg = 'File is not an image';&nbsp;</div></li><li><div>              $this-&gt;error = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// increase memory-limit if possible, GD needs this for large images</span>&nbsp;</div></li><li><div>      if (!extension_loaded('suhosin')) {&nbsp;</div></li><li><div>          @ini_set('memory_limit', '512M');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;error == false) {&nbsp;</div></li><li><div>          <span class="comment">// Check memory consumption if file exists</span>&nbsp;</div></li><li><div>          $this-&gt;checkMemoryForImage($this-&gt;fileName);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//initialize resources if no errors</span>&nbsp;</div></li><li><div>      if ($this-&gt;error == false) {&nbsp;</div></li><li><div>          $img_err = null;&nbsp;</div></li><li><div>          switch ($this-&gt;format) {&nbsp;</div></li><li><div>              case 'GIF':&nbsp;</div></li><li><div>                  if (function_exists('ImageCreateFromGif')) {&nbsp;</div></li><li><div>                      $this-&gt;oldImage = @ImageCreateFromGif($this-&gt;fileName);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $img_err = __('Support for GIF format is missing.', 'nggallery');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'JPG':&nbsp;</div></li><li><div>                  if (function_exists('ImageCreateFromJpeg')) {&nbsp;</div></li><li><div>                      $this-&gt;oldImage = @ImageCreateFromJpeg($this-&gt;fileName);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $img_err = __('Support for JPEG format is missing.', 'nggallery');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'PNG':&nbsp;</div></li><li><div>                  if (function_exists('ImageCreateFromPng')) {&nbsp;</div></li><li><div>                      $this-&gt;oldImage = @ImageCreateFromPng($this-&gt;fileName);&nbsp;</div></li><li><div>                  } else {&nbsp;</div></li><li><div>                      $img_err = __('Support for PNG format is missing.', 'nggallery');&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!$this-&gt;oldImage) {&nbsp;</div></li><li><div>              if ($img_err == null) {&nbsp;</div></li><li><div>                  $img_err = __('Check memory limit', 'nggallery');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $this-&gt;errmsg = sprintf(__('Create Image failed. %1$s', 'nggallery'), $img_err);&nbsp;</div></li><li><div>              $this-&gt;error = true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $size = GetImageSize($this-&gt;fileName);&nbsp;</div></li><li><div>              $this-&gt;currentDimensions = array('width' =&gt; $size[0], 'height' =&gt; $size[1]);&nbsp;</div></li><li><div>              $this-&gt;newImage = $this-&gt;oldImage;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;error == true) {&nbsp;</div></li><li><div>          if (!$no_ErrorImage) {&nbsp;</div></li><li><div>              $this-&gt;showErrorImage();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculate the memory limit</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function checkMemoryForImage($filename)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (function_exists('memory_get_usage') && ini_get('memory_limit')) {&nbsp;</div></li><li><div>          $imageInfo = getimagesize($filename);&nbsp;</div></li><li><div>          switch ($this-&gt;format) {&nbsp;</div></li><li><div>              case 'GIF':&nbsp;</div></li><li><div>                  <span class="comment">// measured factor 1 is better</span>&nbsp;</div></li><li><div>                  $CHANNEL = 1;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'JPG':&nbsp;</div></li><li><div>                  $CHANNEL = $imageInfo['channels'];&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'PNG':&nbsp;</div></li><li><div>                  <span class="comment">// didn't get the channel for png</span>&nbsp;</div></li><li><div>                  $CHANNEL = 3;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $MB = 1048576;&nbsp;</div></li><li><div>          <span class="comment">// number of bytes in 1M</span>&nbsp;</div></li><li><div>          $K64 = 65536;&nbsp;</div></li><li><div>          <span class="comment">// number of bytes in 64K</span>&nbsp;</div></li><li><div>          $TWEAKFACTOR = 1.68;&nbsp;</div></li><li><div>          <span class="comment">// Or whatever works for you</span>&nbsp;</div></li><li><div>          $bits = !empty($imageInfo['bits']) ? $imageInfo['bits'] : 32;&nbsp;</div></li><li><div>          <span class="comment">// imgInfo[bits] is not always available</span>&nbsp;</div></li><li><div>          $memoryNeeded = round(($imageInfo[0] * $imageInfo[1] * $bits * $CHANNEL / 8 + $K64) * $TWEAKFACTOR);&nbsp;</div></li><li><div>          $memoryNeeded = memory_get_usage() + $memoryNeeded;&nbsp;</div></li><li><div>          <span class="comment">// get memory limit</span>&nbsp;</div></li><li><div>          $memory_limit = ini_get('memory_limit');&nbsp;</div></li><li><div>          <span class="comment">// PHP docs : Note that to have no memory limit, set this directive to -1.</span>&nbsp;</div></li><li><div>          if ($memory_limit == -1) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Just check megabyte limits, not higher</span>&nbsp;</div></li><li><div>          if (strtolower(substr($memory_limit, -1)) == 'm') {&nbsp;</div></li><li><div>              if ($memory_limit != '') {&nbsp;</div></li><li><div>                  $memory_limit = substr($memory_limit, 0, -1) * 1024 * 1024;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($memoryNeeded &gt; $memory_limit) {&nbsp;</div></li><li><div>                  $memoryNeeded = round($memoryNeeded / 1024 / 1024, 2);&nbsp;</div></li><li><div>                  $this-&gt;errmsg = 'Exceed Memory limit. Require : ' . $memoryNeeded . &quot; MByte&quot;;&nbsp;</div></li><li><div>                  $this-&gt;error = true;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function __destruct()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;destruct();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Must be called to free up allocated memory after all manipulations are done</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function destruct()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_resource($this-&gt;newImage)) {&nbsp;</div></li><li><div>          @ImageDestroy($this-&gt;newImage);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (is_resource($this-&gt;oldImage)) {&nbsp;</div></li><li><div>          @ImageDestroy($this-&gt;oldImage);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (is_resource($this-&gt;workingImage)) {&nbsp;</div></li><li><div>          @ImageDestroy($this-&gt;workingImage);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the current width of the image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function getCurrentWidth()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;currentDimensions['width'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the current height of the image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @return int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function getCurrentHeight()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;currentDimensions['height'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculates new image width</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calcWidth($width, $height)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $newWp = 100 * $this-&gt;maxWidth / $width;&nbsp;</div></li><li><div>      $newHeight = $height * $newWp / 100;&nbsp;</div></li><li><div>      if (intval($newHeight) == $this-&gt;maxHeight - 1) {&nbsp;</div></li><li><div>          $newHeight = $this-&gt;maxHeight;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array('newWidth' =&gt; intval($this-&gt;maxWidth), 'newHeight' =&gt; intval($newHeight));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculates new image height</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calcHeight($width, $height)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $newHp = 100 * $this-&gt;maxHeight / $height;&nbsp;</div></li><li><div>      $newWidth = $width * $newHp / 100;&nbsp;</div></li><li><div>      if (intval($newWidth) == $this-&gt;maxWidth - 1) {&nbsp;</div></li><li><div>          $newWidth = $this-&gt;maxWidth;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array('newWidth' =&gt; intval($newWidth), 'newHeight' =&gt; intval($this-&gt;maxHeight));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculates new image size based on percentage</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calcPercent($width, $height)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $newWidth = $width * $this-&gt;percent / 100;&nbsp;</div></li><li><div>      $newHeight = $height * $this-&gt;percent / 100;&nbsp;</div></li><li><div>      return array('newWidth' =&gt; intval($newWidth), 'newHeight' =&gt; intval($newHeight));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculates new image size based on width and height, while constraining to maxWidth and maxHeight</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calcImageSize($width, $height)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// $width and $height are the CURRENT image resolutions</span>&nbsp;</div></li><li><div>      $ratio_w = $this-&gt;maxWidth / $width;&nbsp;</div></li><li><div>      $ratio_h = $this-&gt;maxHeight / $height;&nbsp;</div></li><li><div>      if ($ratio_w &gt;= $ratio_h) {&nbsp;</div></li><li><div>          $width = $this-&gt;maxWidth;&nbsp;</div></li><li><div>          $height = (int) round($height * $ratio_h, 0);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $height = $this-&gt;maxHeight;&nbsp;</div></li><li><div>          $width = (int) round($width * $ratio_w, 0);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;newDimensions = array('newWidth' =&gt; $width, 'newHeight' =&gt; $height);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculates new image size based percentage</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function calcImageSizePercent($width, $height)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($this-&gt;percent &gt; 0) {&nbsp;</div></li><li><div>          $this-&gt;newDimensions = $this-&gt;calcPercent($width, $height);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Displays error image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function showErrorImage()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      header('Content-type: image/png');&nbsp;</div></li><li><div>      $errImg = ImageCreate(220, 25);&nbsp;</div></li><li><div>      $bgColor = imagecolorallocate($errImg, 0, 0, 0);&nbsp;</div></li><li><div>      $fgColor1 = imagecolorallocate($errImg, 255, 255, 255);&nbsp;</div></li><li><div>      $fgColor2 = imagecolorallocate($errImg, 255, 0, 0);&nbsp;</div></li><li><div>      imagestring($errImg, 3, 6, 6, 'Error:', $fgColor2);&nbsp;</div></li><li><div>      imagestring($errImg, 3, 55, 6, $this-&gt;errmsg, $fgColor1);&nbsp;</div></li><li><div>      imagepng($errImg);&nbsp;</div></li><li><div>      imagedestroy($errImg);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Resizes image to fixed Width x Height</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   * @param int $Width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $Height</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function resizeFix($Width = 0, $Height = 0, $deprecated = 3)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;newWidth = $Width;&nbsp;</div></li><li><div>      $this-&gt;newHeight = $Height;&nbsp;</div></li><li><div>      if (function_exists(&quot;ImageCreateTrueColor&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreateTrueColor($this-&gt;newWidth, $this-&gt;newHeight);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreate($this-&gt;newWidth, $this-&gt;newHeight);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        ImageCopyResampled(</span></span>&nbsp;</div></li><li><div>      $this-&gt;imagecopyresampled($this-&gt;workingImage, $this-&gt;oldImage, 0, 0, 0, 0, $this-&gt;newWidth, $this-&gt;newHeight, $this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height']);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = $this-&gt;newWidth;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = $this-&gt;newHeight;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Resizes image to maxWidth x maxHeight</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $maxWidth</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $maxHeight</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function resize($maxWidth = 0, $maxHeight = 0, $deprecated = 3)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;maxWidth = $maxWidth;&nbsp;</div></li><li><div>      $this-&gt;maxHeight = $maxHeight;&nbsp;</div></li><li><div>      $this-&gt;calcImageSize($this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height']);&nbsp;</div></li><li><div>      if (function_exists(&quot;ImageCreateTrueColor&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreateTrueColor($this-&gt;newDimensions['newWidth'], $this-&gt;newDimensions['newHeight']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreate($this-&gt;newDimensions['newWidth'], $this-&gt;newDimensions['newHeight']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//        ImageCopyResampled(</span></span>&nbsp;</div></li><li><div>      $this-&gt;imagecopyresampled($this-&gt;workingImage, $this-&gt;oldImage, 0, 0, 0, 0, $this-&gt;newDimensions['newWidth'], $this-&gt;newDimensions['newHeight'], $this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height']);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = $this-&gt;newDimensions['newWidth'];&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = $this-&gt;newDimensions['newHeight'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Resizes the image by $percent percent</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $percent</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function resizePercent($percent = 0)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;percent = $percent;&nbsp;</div></li><li><div>      $this-&gt;calcImageSizePercent($this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height']);&nbsp;</div></li><li><div>      if (function_exists(&quot;ImageCreateTrueColor&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreateTrueColor($this-&gt;newDimensions['newWidth'], $this-&gt;newDimensions['newHeight']);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreate($this-&gt;newDimensions['newWidth'], $this-&gt;newDimensions['newHeight']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;ImageCopyResampled($this-&gt;workingImage, $this-&gt;oldImage, 0, 0, 0, 0, $this-&gt;newDimensions['newWidth'], $this-&gt;newDimensions['newHeight'], $this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height']);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = $this-&gt;newDimensions['newWidth'];&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = $this-&gt;newDimensions['newHeight'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Crops the image from calculated center in a square of $cropSize pixels</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $cropSize</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function cropFromCenter($cropSize)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($cropSize &gt; $this-&gt;currentDimensions['width']) {&nbsp;</div></li><li><div>          $cropSize = $this-&gt;currentDimensions['width'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($cropSize &gt; $this-&gt;currentDimensions['height']) {&nbsp;</div></li><li><div>          $cropSize = $this-&gt;currentDimensions['height'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $cropX = intval(($this-&gt;currentDimensions['width'] - $cropSize) / 2);&nbsp;</div></li><li><div>      $cropY = intval(($this-&gt;currentDimensions['height'] - $cropSize) / 2);&nbsp;</div></li><li><div>      if (function_exists(&quot;ImageCreateTrueColor&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreateTrueColor($cropSize, $cropSize);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreate($cropSize, $cropSize);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;imagecopyresampled($this-&gt;workingImage, $this-&gt;oldImage, 0, 0, $cropX, $cropY, $cropSize, $cropSize, $cropSize, $cropSize);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = $cropSize;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = $cropSize;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Advanced cropping function that crops an image using $startX and $startY as the upper-left hand corner.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $startX</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $startY</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $width</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $height</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function crop($startX, $startY, $width, $height)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">//make sure the cropped area is not greater than the size of the image</span>&nbsp;</div></li><li><div>      if ($width &gt; $this-&gt;currentDimensions['width']) {&nbsp;</div></li><li><div>          $width = $this-&gt;currentDimensions['width'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($height &gt; $this-&gt;currentDimensions['height']) {&nbsp;</div></li><li><div>          $height = $this-&gt;currentDimensions['height'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//make sure not starting outside the image</span>&nbsp;</div></li><li><div>      if ($startX + $width &gt; $this-&gt;currentDimensions['width']) {&nbsp;</div></li><li><div>          $startX = $this-&gt;currentDimensions['width'] - $width;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($startY + $height &gt; $this-&gt;currentDimensions['height']) {&nbsp;</div></li><li><div>          $startY = $this-&gt;currentDimensions['height'] - $height;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($startX &lt; 0) {&nbsp;</div></li><li><div>          $startX = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($startY &lt; 0) {&nbsp;</div></li><li><div>          $startY = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (function_exists(&quot;ImageCreateTrueColor&quot;)) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreateTrueColor($width, $height);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;workingImage = ImageCreate($width, $height);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;imagecopyresampled($this-&gt;workingImage, $this-&gt;oldImage, 0, 0, $startX, $startY, $width, $height, $width, $height);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = $width;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = $height;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Outputs the image to the screen, or saves to $name if supplied.  Quality of JPEG images can be controlled with the $quality variable</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $quality</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function show($quality = 100, $name = '')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      switch ($this-&gt;format) {&nbsp;</div></li><li><div>          case 'GIF':&nbsp;</div></li><li><div>              if ($name != '') {&nbsp;</div></li><li><div>                  @ImageGif($this-&gt;newImage, $name) or $this-&gt;error = true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  header('Content-type: image/gif');&nbsp;</div></li><li><div>                  ImageGif($this-&gt;newImage);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'JPG':&nbsp;</div></li><li><div>              if ($name != '') {&nbsp;</div></li><li><div>                  @ImageJpeg($this-&gt;newImage, $name, $quality) or $this-&gt;error = true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  header('Content-type: image/jpeg');&nbsp;</div></li><li><div>                  ImageJpeg($this-&gt;newImage, NULL, $quality);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'PNG':&nbsp;</div></li><li><div>              if ($name != '') {&nbsp;</div></li><li><div>                  @ImagePng($this-&gt;newImage, $name) or $this-&gt;error = true;&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  header('Content-type: image/png');&nbsp;</div></li><li><div>                  ImagePng($this-&gt;newImage);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Saves image as $name (can include file path), with quality of # percent if file is a jpeg</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $quality</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool errorstate</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function save($name, $quality = 100)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;show($quality, $name);&nbsp;</div></li><li><div>      if ($this-&gt;error == true) {&nbsp;</div></li><li><div>          $this-&gt;errmsg = 'Create Image failed. Check safe mode settings';&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (function_exists('do_action')) {&nbsp;</div></li><li><div>          do_action('ngg_ajax_image_save', $name);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates Apple-style reflection under image, optionally adding a border to main image</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $percent</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $reflection</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $white</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $border</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $borderColor</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function createReflection($percent, $reflection, $white, $border = true, $borderColor = '#a4a4a4')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $width = $this-&gt;currentDimensions['width'];&nbsp;</div></li><li><div>      $height = $this-&gt;currentDimensions['height'];&nbsp;</div></li><li><div>      $reflectionHeight = intval($height * ($reflection / 100));&nbsp;</div></li><li><div>      $newHeight = $height + $reflectionHeight;&nbsp;</div></li><li><div>      $reflectedPart = $height * ($percent / 100);&nbsp;</div></li><li><div>      $this-&gt;workingImage = ImageCreateTrueColor($width, $newHeight);&nbsp;</div></li><li><div>      ImageAlphaBlending($this-&gt;workingImage, true);&nbsp;</div></li><li><div>      $colorToPaint = ImageColorAllocateAlpha($this-&gt;workingImage, 255, 255, 255, 0);&nbsp;</div></li><li><div>      ImageFilledRectangle($this-&gt;workingImage, 0, 0, $width, $newHeight, $colorToPaint);&nbsp;</div></li><li><div>      imagecopyresampled($this-&gt;workingImage, $this-&gt;newImage, 0, 0, 0, $reflectedPart, $width, $reflectionHeight, $width, $height - $reflectedPart);&nbsp;</div></li><li><div>      $this-&gt;imageFlipVertical();&nbsp;</div></li><li><div>      imagecopy($this-&gt;workingImage, $this-&gt;newImage, 0, 0, 0, 0, $width, $height);&nbsp;</div></li><li><div>      imagealphablending($this-&gt;workingImage, true);&nbsp;</div></li><li><div>      for ($i = 0; $i &lt; $reflectionHeight; $i++) {&nbsp;</div></li><li><div>          $colorToPaint = imagecolorallocatealpha($this-&gt;workingImage, 255, 255, 255, ($i / $reflectionHeight * -1 + 1) * $white);&nbsp;</div></li><li><div>          imagefilledrectangle($this-&gt;workingImage, 0, $height + $i, $width, $height + $i, $colorToPaint);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($border == true) {&nbsp;</div></li><li><div>          $rgb = $this-&gt;hex2rgb($borderColor, false);&nbsp;</div></li><li><div>          $colorToPaint = imagecolorallocate($this-&gt;workingImage, $rgb[0], $rgb[1], $rgb[2]);&nbsp;</div></li><li><div>          imageline($this-&gt;workingImage, 0, 0, $width, 0, $colorToPaint);&nbsp;</div></li><li><div>          <span class="comment">//top line</span>&nbsp;</div></li><li><div>          imageline($this-&gt;workingImage, 0, $height, $width, $height, $colorToPaint);&nbsp;</div></li><li><div>          <span class="comment">//bottom line</span>&nbsp;</div></li><li><div>          imageline($this-&gt;workingImage, 0, 0, 0, $height, $colorToPaint);&nbsp;</div></li><li><div>          <span class="comment">//left line</span>&nbsp;</div></li><li><div>          imageline($this-&gt;workingImage, $width - 1, 0, $width - 1, $height, $colorToPaint);&nbsp;</div></li><li><div>          <span class="comment">//right line</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = $width;&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = $newHeight;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Flip an image.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $horz flip the image in horizontal mode</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $vert flip the image in vertical mode</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function flipImage($horz = false, $vert = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $sx = $vert ? $this-&gt;currentDimensions['width'] - 1 : 0;&nbsp;</div></li><li><div>      $sy = $horz ? $this-&gt;currentDimensions['height'] - 1 : 0;&nbsp;</div></li><li><div>      $sw = $vert ? -$this-&gt;currentDimensions['width'] : $this-&gt;currentDimensions['width'];&nbsp;</div></li><li><div>      $sh = $horz ? -$this-&gt;currentDimensions['height'] : $this-&gt;currentDimensions['height'];&nbsp;</div></li><li><div>      $this-&gt;workingImage = imagecreatetruecolor($this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height']);&nbsp;</div></li><li><div>      $this-&gt;imagecopyresampled($this-&gt;workingImage, $this-&gt;oldImage, 0, 0, $sx, $sy, $this-&gt;currentDimensions['width'], $this-&gt;currentDimensions['height'], $sw, $sh);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Rotate an image clockwise or counter clockwise</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $direction could be CW or CCW</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function rotateImage($dir = 'CW')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $angle = $dir == 'CW' ? 90 : -90;&nbsp;</div></li><li><div>      return $this-&gt;rotateImageAngle($angle);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Rotate an image clockwise or counter clockwise</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $direction could be CW or CCW</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function rotateImageAngle($angle = 90)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (function_exists('imagerotate')) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = imagerotate($this-&gt;oldImage, 360 - $angle, 0);&nbsp;</div></li><li><div>          <span class="comment">// imagerotate() rotates CCW</span>&nbsp;</div></li><li><div>          $this-&gt;currentDimensions['width'] = imagesx($this-&gt;workingImage);&nbsp;</div></li><li><div>          $this-&gt;currentDimensions['height'] = imagesy($this-&gt;workingImage);&nbsp;</div></li><li><div>          $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>          $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;workingImage = imagecreatetruecolor($this-&gt;currentDimensions['height'], $this-&gt;currentDimensions['width']);&nbsp;</div></li><li><div>      imagealphablending($this-&gt;workingImage, false);&nbsp;</div></li><li><div>      imagesavealpha($this-&gt;workingImage, true);&nbsp;</div></li><li><div>      switch ($angle) {&nbsp;</div></li><li><div>          case 90:&nbsp;</div></li><li><div>              for ($x = 0; $x &lt; $this-&gt;currentDimensions['width']; $x++) {&nbsp;</div></li><li><div>                  for ($y = 0; $y &lt; $this-&gt;currentDimensions['height']; $y++) {&nbsp;</div></li><li><div>                      if (!imagecopy($this-&gt;workingImage, $this-&gt;oldImage, $this-&gt;currentDimensions['height'] - $y - 1, $x, $x, $y, 1, 1)) {&nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case -90:&nbsp;</div></li><li><div>              for ($x = 0; $x &lt; $this-&gt;currentDimensions['width']; $x++) {&nbsp;</div></li><li><div>                  for ($y = 0; $y &lt; $this-&gt;currentDimensions['height']; $y++) {&nbsp;</div></li><li><div>                      if (!imagecopy($this-&gt;workingImage, $this-&gt;oldImage, $y, $this-&gt;currentDimensions['width'] - $x - 1, $x, $y, 1, 1)) {&nbsp;</div></li><li><div>                          return false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['width'] = imagesx($this-&gt;workingImage);&nbsp;</div></li><li><div>      $this-&gt;currentDimensions['height'] = imagesy($this-&gt;workingImage);&nbsp;</div></li><li><div>      $this-&gt;oldImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      $this-&gt;newImage = $this-&gt;workingImage;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Inverts working image, used by reflection function</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   * @access    private</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function imageFlipVertical()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $x_i = imagesx($this-&gt;workingImage);&nbsp;</div></li><li><div>      $y_i = imagesy($this-&gt;workingImage);&nbsp;</div></li><li><div>      for ($x = 0; $x &lt; $x_i; $x++) {&nbsp;</div></li><li><div>          for ($y = 0; $y &lt; $y_i; $y++) {&nbsp;</div></li><li><div>              imagecopy($this-&gt;workingImage, $this-&gt;workingImage, $x, $y_i - $y - 1, $x, $y, 1, 1);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Converts hexidecimal color value to rgb values and returns as array/string</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $hex</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $asString</span>&nbsp;</div></li><li><div><span class="comment">   * @return array|string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function hex2rgb($hex, $asString = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// strip off any leading #</span>&nbsp;</div></li><li><div>      if (0 === strpos($hex, '#')) {&nbsp;</div></li><li><div>          $hex = substr($hex, 1);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if (0 === strpos($hex, '&H')) {&nbsp;</div></li><li><div>              $hex = substr($hex, 2);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// break into hex 3-tuple</span>&nbsp;</div></li><li><div>      $cutpoint = ceil(strlen($hex) / 2) - 1;&nbsp;</div></li><li><div>      $rgb = explode(':', wordwrap($hex, $cutpoint, ':', $cutpoint), 3);&nbsp;</div></li><li><div>      <span class="comment">// convert each tuple to decimal</span>&nbsp;</div></li><li><div>      $rgb[0] = isset($rgb[0]) ? hexdec($rgb[0]) : 0;&nbsp;</div></li><li><div>      $rgb[1] = isset($rgb[1]) ? hexdec($rgb[1]) : 0;&nbsp;</div></li><li><div>      $rgb[2] = isset($rgb[2]) ? hexdec($rgb[2]) : 0;&nbsp;</div></li><li><div>      return $asString ? &quot;{$rgb[0]} {$rgb[1]} {$rgb[2]}&quot; : $rgb;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Based on the Watermark function by Marek Malcherek  </span>&nbsp;</div></li><li><div><span class="comment">   * http://www.malcherek.de</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $color</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $wmFont</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $wmSize</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $wmOpaque</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function watermarkCreateText($color = '000000', $wmFont, $wmSize = 10, $wmOpaque = 90)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// set font path</span>&nbsp;</div></li><li><div>      $wmFontPath = NGGALLERY_ABSPATH . &quot;fonts/&quot; . $wmFont;&nbsp;</div></li><li><div>      if (!is_readable($wmFontPath)) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// This function requires both the GD library and the FreeType library.</span>&nbsp;</div></li><li><div>      if (!function_exists('ImageTTFBBox')) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $words = preg_split('/ /', $this-&gt;watermarkText);&nbsp;</div></li><li><div>      $lines = array();&nbsp;</div></li><li><div>      $line = '';&nbsp;</div></li><li><div>      $watermark_image_width = 0;&nbsp;</div></li><li><div>      <span class="comment">// attempt adding a new word until the width is too large; then start a new line and start again</span>&nbsp;</div></li><li><div>      foreach ($words as $word) {&nbsp;</div></li><li><div>          <span class="comment">// sanitize the text being input; imagettftext() can be sensitive</span>&nbsp;</div></li><li><div>          $TextSize = $this-&gt;ImageTTFBBoxDimensions($wmSize, 0, $this-&gt;correct_gd_unc_path($wmFontPath), $line . preg_replace('~^(&([a-zA-Z0-9]);)~', htmlentities('${1}'), mb_convert_encoding($word, &quot;HTML-ENTITIES&quot;, &quot;UTF-8&quot;)));&nbsp;</div></li><li><div>          if ($watermark_image_width == 0) {&nbsp;</div></li><li><div>              $watermark_image_width = $TextSize['width'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($TextSize['width'] &gt; $this-&gt;newDimensions['newWidth']) {&nbsp;</div></li><li><div>              $lines[] = trim($line);&nbsp;</div></li><li><div>              $line = '';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ($TextSize['width'] &gt; $watermark_image_width) {&nbsp;</div></li><li><div>                  $watermark_image_width = $TextSize['width'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $line .= $word . ' ';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $lines[] = trim($line);&nbsp;</div></li><li><div>      <span class="comment">// use this string to determine our largest possible line height</span>&nbsp;</div></li><li><div>      $line_dimensions = $this-&gt;ImageTTFBBoxDimensions($wmSize, 0, $this-&gt;correct_gd_unc_path($wmFontPath), 'MXQJALYmxqjabdfghjklpqry019`@$^&*(, !132');&nbsp;</div></li><li><div>      $line_height = $line_dimensions['height'] * 1.05;&nbsp;</div></li><li><div>      <span class="comment">// Create an image to apply our text to</span>&nbsp;</div></li><li><div>      $this-&gt;workingImage = ImageCreateTrueColor($watermark_image_width, count($lines) * $line_height);&nbsp;</div></li><li><div>      ImageSaveAlpha($this-&gt;workingImage, true);&nbsp;</div></li><li><div>      ImageAlphaBlending($this-&gt;workingImage, false);&nbsp;</div></li><li><div>      $bgText = imagecolorallocatealpha($this-&gt;workingImage, 255, 255, 255, 127);&nbsp;</div></li><li><div>      imagefill($this-&gt;workingImage, 0, 0, $bgText);&nbsp;</div></li><li><div>      $wmTransp = 127 - $wmOpaque * 1.27;&nbsp;</div></li><li><div>      $rgb = $this-&gt;hex2rgb($color, false);&nbsp;</div></li><li><div>      $TextColor = imagecolorallocatealpha($this-&gt;workingImage, $rgb[0], $rgb[1], $rgb[2], $wmTransp);&nbsp;</div></li><li><div>      <span class="comment">// Put text on the image, line-by-line</span>&nbsp;</div></li><li><div>      $y_pos = $wmSize;&nbsp;</div></li><li><div>      foreach ($lines as $line) {&nbsp;</div></li><li><div>          imagettftext($this-&gt;workingImage, $wmSize, 0, 0, $y_pos, $TextColor, $this-&gt;correct_gd_unc_path($wmFontPath), $line);&nbsp;</div></li><li><div>          $y_pos += $line_height;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;watermarkImgPath = $this-&gt;workingImage;&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a path that can be used with imagettftext() and ImageTTFBBox()</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * imagettftext() and ImageTTFBBox() cannot load resources from Windows UNC paths</span>&nbsp;</div></li><li><div><span class="comment">   * and require they be mangled to be like //server\filename instead of \\server\filename</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path Absolute file path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $path Mangled absolute file path</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function correct_gd_unc_path($path)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (strtoupper(substr(PHP_OS, 0, 3)) == 'WIN' && substr($path, 0, 2) === '\\\\') {&nbsp;</div></li><li><div>          $path = ltrim($path, '\\\\');&nbsp;</div></li><li><div>          $path = '<span class="comment">//' . $path;</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $path;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Calculates the width & height dimensions of ImageTTFBBox().</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Note: ImageTTFBBox() is unreliable with large font sizes</span>&nbsp;</div></li><li><div><span class="comment">   * @param $wmSize</span>&nbsp;</div></li><li><div><span class="comment">   * @param $fontAngle</span>&nbsp;</div></li><li><div><span class="comment">   * @param $wmFontPath</span>&nbsp;</div></li><li><div><span class="comment">   * @param $text</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function ImageTTFBBoxDimensions($wmSize, $fontAngle, $wmFontPath, $text)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $box = @ImageTTFBBox($wmSize, $fontAngle, $this-&gt;correct_gd_unc_path($wmFontPath), $text);&nbsp;</div></li><li><div>      $max_x = max(array($box[0], $box[2], $box[4], $box[6]));&nbsp;</div></li><li><div>      $max_y = max(array($box[1], $box[3], $box[5], $box[7]));&nbsp;</div></li><li><div>      $min_x = min(array($box[0], $box[2], $box[4], $box[6]));&nbsp;</div></li><li><div>      $min_y = min(array($box[1], $box[3], $box[5], $box[7]));&nbsp;</div></li><li><div>      return array(&quot;width&quot; =&gt; $max_x - $min_x, &quot;height&quot; =&gt; $max_y - $min_y);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function applyFilter($filterType)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $args = func_get_args();&nbsp;</div></li><li><div>      array_unshift($args, $this-&gt;newImage);&nbsp;</div></li><li><div>      return call_user_func_array('imagefilter', $args);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Modfied Watermark function by Steve Peart </span>&nbsp;</div></li><li><div><span class="comment">   * http://parasitehosting.com/</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $relPOS</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $xPOS</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $yPOS</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function watermarkImage($relPOS = 'botRight', $xPOS = 0, $yPOS = 0)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// if it's a resource ID take it as watermark text image</span>&nbsp;</div></li><li><div>      if (is_resource($this-&gt;watermarkImgPath)) {&nbsp;</div></li><li><div>          $this-&gt;workingImage = $this-&gt;watermarkImgPath;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// (possibly) search for the file from the document root</span>&nbsp;</div></li><li><div>          if (!is_file($this-&gt;watermarkImgPath)) {&nbsp;</div></li><li><div>              $fs = C_Fs::get_instance();&nbsp;</div></li><li><div>              if (is_file($fs-&gt;join_paths($fs-&gt;get_document_root('content'), $this-&gt;watermarkImgPath))) {&nbsp;</div></li><li><div>                  $this-&gt;watermarkImgPath = $fs-&gt;get_document_root('content') . $this-&gt;watermarkImgPath;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Would you really want to use anything other than a png?</span>&nbsp;</div></li><li><div>          $this-&gt;workingImage = @imagecreatefrompng($this-&gt;watermarkImgPath);&nbsp;</div></li><li><div>          <span class="comment">// if it's not a valid file die...</span>&nbsp;</div></li><li><div>          if (empty($this-&gt;workingImage) or !$this-&gt;workingImage) {&nbsp;</div></li><li><div>              return;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      imagealphablending($this-&gt;workingImage, false);&nbsp;</div></li><li><div>      imagesavealpha($this-&gt;workingImage, true);&nbsp;</div></li><li><div>      $sourcefile_width = imageSX($this-&gt;oldImage);&nbsp;</div></li><li><div>      $sourcefile_height = imageSY($this-&gt;oldImage);&nbsp;</div></li><li><div>      $watermarkfile_width = imageSX($this-&gt;workingImage);&nbsp;</div></li><li><div>      $watermarkfile_height = imageSY($this-&gt;workingImage);&nbsp;</div></li><li><div>      switch (substr($relPOS, 0, 3)) {&nbsp;</div></li><li><div>          case 'top':&nbsp;</div></li><li><div>              $dest_y = 0 + $yPOS;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'mid':&nbsp;</div></li><li><div>              $dest_y = $sourcefile_height / 2 - $watermarkfile_height / 2;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'bot':&nbsp;</div></li><li><div>              $dest_y = $sourcefile_height - $watermarkfile_height - $yPOS;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $dest_y = 0;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      switch (substr($relPOS, 3)) {&nbsp;</div></li><li><div>          case 'Left':&nbsp;</div></li><li><div>              $dest_x = 0 + $xPOS;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'Center':&nbsp;</div></li><li><div>              $dest_x = $sourcefile_width / 2 - $watermarkfile_width / 2;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'Right':&nbsp;</div></li><li><div>              $dest_x = $sourcefile_width - $watermarkfile_width - $xPOS;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $dest_x = 0;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// debug</span>&nbsp;</div></li><li><div>      <span class="comment">// $this-&gt;errmsg = 'X '.$dest_x.' Y '.$dest_y;</span>&nbsp;</div></li><li><div>      <span class="comment">// $this-&gt;showErrorImage();</span>&nbsp;</div></li><li><div>      <span class="comment">// if a gif, we have to upsample it to a truecolor image</span>&nbsp;</div></li><li><div>      if ($this-&gt;format == 'GIF') {&nbsp;</div></li><li><div>          $tempimage = imagecreatetruecolor($sourcefile_width, $sourcefile_height);&nbsp;</div></li><li><div>          imagecopy($tempimage, $this-&gt;oldImage, 0, 0, 0, 0, $sourcefile_width, $sourcefile_height);&nbsp;</div></li><li><div>          $this-&gt;newImage = $tempimage;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;imagecopymerge_alpha($this-&gt;newImage, $this-&gt;workingImage, $dest_x, $dest_y, 0, 0, $watermarkfile_width, $watermarkfile_height, 100);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Wrapper to imagecopymerge() that allows PNG transparency</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function imagecopymerge_alpha($destination_image, $source_image, $destination_x, $destination_y, $source_x, $source_y, $source_w, $source_h, $pct)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $cut = imagecreatetruecolor($source_w, $source_h);&nbsp;</div></li><li><div>      imagecopy($cut, $destination_image, 0, 0, $destination_x, $destination_y, $source_w, $source_h);&nbsp;</div></li><li><div>      imagecopy($cut, $source_image, 0, 0, $source_x, $source_y, $source_w, $source_h);&nbsp;</div></li><li><div>      imagecopymerge($destination_image, $cut, $destination_x, $destination_y, 0, 0, $source_w, $source_h, $pct);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Modfied imagecopyresampled function to save transparent images</span>&nbsp;</div></li><li><div><span class="comment">   * See : http://www.akemapa.com/2008/07/10/php-gd-resize-transparent-image-png-gif/</span>&nbsp;</div></li><li><div><span class="comment">   * @since 1.9.0</span>&nbsp;</div></li><li><div><span class="comment">   * </span>&nbsp;</div></li><li><div><span class="comment">   * @param resource $dst_image</span>&nbsp;</div></li><li><div><span class="comment">   * @param resource $src_image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $dst_x</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $dst_y</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $src_x</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $src_y</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $dst_w</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $dst_h</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $src_w</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $src_h</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function imagecopyresampled(&$dst_image, $src_image, $dst_x, $dst_y, $src_x, $src_y, $dst_w, $dst_h, $src_w, $src_h)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Check if this image is PNG or GIF, then set if Transparent</span>&nbsp;</div></li><li><div>      if ($this-&gt;format == 'GIF' || $this-&gt;format == 'PNG') {&nbsp;</div></li><li><div>          imagealphablending($dst_image, false);&nbsp;</div></li><li><div>          imagesavealpha($dst_image, true);&nbsp;</div></li><li><div>          $transparent = imagecolorallocatealpha($dst_image, 255, 255, 255, 127);&nbsp;</div></li><li><div>          imagefilledrectangle($dst_image, 0, 0, $dst_w, $dst_h, $transparent);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      imagecopyresampled($dst_image, $src_image, $dst_x, $dst_y, $src_x, $src_y, $dst_w, $dst_h, $src_w, $src_h);&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_WordPress_GalleryStorage_Driver extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the named sizes available for images</span>&nbsp;</div></li><li><div><span class="comment">   * @global array $_wp_additional_image_sizese</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_sizes()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $_wp_additional_image_sizes;&nbsp;</div></li><li><div>      $_wp_additional_image_sizes[] = 'full';&nbsp;</div></li><li><div>      return $_wp_additional_image_sizes;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the upload path for new images in this gallery</span>&nbsp;</div></li><li><div><span class="comment">   * This will always be the date-based directory</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_upload_abspath($gallery = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Gallery is used for this driver, as the upload path is</span>&nbsp;</div></li><li><div>      <span class="comment">// the same, regardless of what gallery is used</span>&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $dir = wp_upload_dir(time());&nbsp;</div></li><li><div>      if ($dir) {&nbsp;</div></li><li><div>          $retval = $dir['path'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Will always return the same as get_upload_abspath(), as</span>&nbsp;</div></li><li><div><span class="comment">   * WordPress storage is not organized by gallery but by date</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_gallery_abspath($gallery = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_upload_abspath();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the url of a particular sized image</span>&nbsp;</div></li><li><div><span class="comment">   * @param int|object $image</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $size</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_image_url($image = FALSE, $size = 'full')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $image_key = C_Displayed_Gallery_Mapper::get_instance()-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      if ($image && ($image_id = $this-&gt;object-&gt;_get_image_id($image))) {&nbsp;</div></li><li><div>          $parts = wp_get_attachment_image_src($image-&gt;{$image_key});&nbsp;</div></li><li><div>          if ($parts) {&nbsp;</div></li><li><div>              $retval = $parts['url'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return apply_filters('ngg_get_image_url', $retval, $image, $size);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_WordPress_GalleryStorage_Driver</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_WordPress_GalleryStorage_Driver</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_WordPress_GalleryStorage_Driver extends C_GalleryStorage_Driver_Base&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function define($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_WordPress_GalleryStorage_Driver');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class Mixin_NextGen_Table_Extras</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_CustomPost_DataMapper_Driver</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_NextGen_Table_Extras extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  const CUSTOM_POST_NAME = __CLASS__;&nbsp;</div></li><li><div>  function initialize()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Each record in a NextGEN Gallery table has an associated custom post in the wp_posts table</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_custom_post_mapper = new C_CustomPost_DataMapper_Driver($this-&gt;object-&gt;get_object_name());&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_custom_post_mapper-&gt;set_model_factory_method('extra_fields');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines a column for the mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param $name</span>&nbsp;</div></li><li><div><span class="comment">   * @param $data_type</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $default_value</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $extra</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function define_column($name, $data_type, $default_value = NULL, $extra = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;call_parent('define_column', $name, $data_type, $default_value);&nbsp;</div></li><li><div>      if ($extra) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;_columns[$name]['extra'] = TRUE;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;_columns[$name]['extra'] = FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets a list of all the extra columns defined for this table</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_extra_columns()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      foreach ($this-&gt;object-&gt;_columns as $key =&gt; $properties) {&nbsp;</div></li><li><div>          if ($properties['extra']) {&nbsp;</div></li><li><div>              $retval[] = $key;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds a column to the database</span>&nbsp;</div></li><li><div><span class="comment">   * @param $column_name</span>&nbsp;</div></li><li><div><span class="comment">   * @param $datatype</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $default_value</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _add_column($column_name, $datatype, $default_value = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $skip = FALSE;&nbsp;</div></li><li><div>      if (isset($this-&gt;object-&gt;_columns[$column_name]) and $this-&gt;object-&gt;_columns[$column_name]['extra']) {&nbsp;</div></li><li><div>          $skip = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!$skip) {&nbsp;</div></li><li><div>          $this-&gt;call_parent('_add_column', $column_name, $datatype, $default_value);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return !$skip;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function create_custom_post_entity($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $custom_post_entity = new stdClass();&nbsp;</div></li><li><div>      <span class="comment">// If the custom post entity already exists then it needs</span>&nbsp;</div></li><li><div>      <span class="comment">// an ID</span>&nbsp;</div></li><li><div>      if (isset($entity-&gt;extras_post_id)) {&nbsp;</div></li><li><div>          $custom_post_entity-&gt;ID = $entity-&gt;extras_post_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If a property isn't a column for the table, then</span>&nbsp;</div></li><li><div>      <span class="comment">// it belongs to the custom post record</span>&nbsp;</div></li><li><div>      foreach (get_object_vars($entity) as $key =&gt; $value) {&nbsp;</div></li><li><div>          if (!$this-&gt;object-&gt;has_column($key)) {&nbsp;</div></li><li><div>              unset($entity-&gt;{$key});&nbsp;</div></li><li><div>              if ($this-&gt;object-&gt;has_defined_column($key) && $key != $this-&gt;object-&gt;get_primary_key_column()) {&nbsp;</div></li><li><div>                  $custom_post_entity-&gt;{$key} = $value;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Used to help find these type of records</span>&nbsp;</div></li><li><div>      $custom_post_entity-&gt;post_name = self::CUSTOM_POST_NAME;&nbsp;</div></li><li><div>      return $custom_post_entity;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Creates a new record in the custom table, as well as a custom post record</span>&nbsp;</div></li><li><div><span class="comment">   * @param $entity</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _create($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $custom_post_entity = $this-&gt;create_custom_post_entity($entity);&nbsp;</div></li><li><div>      <span class="comment">// Try persisting the custom post type record first</span>&nbsp;</div></li><li><div>      if ($custom_post_id = $this-&gt;object-&gt;_custom_post_mapper-&gt;save($custom_post_entity)) {&nbsp;</div></li><li><div>          <span class="comment">// Try saving the custom table record. If that fails, then destroy the previously</span>&nbsp;</div></li><li><div>          <span class="comment">// created custom post type record</span>&nbsp;</div></li><li><div>          if (!($retval = $this-&gt;call_parent('_create', $entity))) {&nbsp;</div></li><li><div>              $this-&gt;object-&gt;_custom_post_mapper-&gt;destroy($custom_post_id);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $entity-&gt;extras_post_id = $custom_post_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Updates a custom table record and it's associated custom post type record in the database</span>&nbsp;</div></li><li><div>  function _update($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $custom_post_entity = $this-&gt;create_custom_post_entity($entity);&nbsp;</div></li><li><div>      $custom_post_id = $this-&gt;object-&gt;_custom_post_mapper-&gt;save($custom_post_entity);&nbsp;</div></li><li><div>      $entity-&gt;extras_post_id = $custom_post_id;&nbsp;</div></li><li><div>      $retval = $this-&gt;call_parent('_update', $entity);&nbsp;</div></li><li><div>      foreach ($this-&gt;get_extra_columns() as $key) {&nbsp;</div></li><li><div>          if (isset($custom_post_entity-&gt;{$key})) {&nbsp;</div></li><li><div>              $entity-&gt;{$key} = $custom_post_entity-&gt;{$key};&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function destroy($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (isset($entity-&gt;extras_post_id)) {&nbsp;</div></li><li><div>          wp_delete_post($entity-&gt;extras_post_id, TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;call_parent('destroy', $entity);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _regex_replace($in)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      $from = 'FROM `' . $this-&gt;object-&gt;get_table_name() . '`';&nbsp;</div></li><li><div>      $out = str_replace('FROM', &quot;, GROUP_CONCAT(CONCAT_WS('@@', meta_key, meta_value)) AS 'extras' FROM&quot;, $in);&nbsp;</div></li><li><div>      $out = str_replace($from, &quot;{$from} LEFT OUTER JOIN `{$wpdb-&gt;postmeta}` ON `{$wpdb-&gt;postmeta}`.`post_id` = `extras_post_id` &quot;, $out);&nbsp;</div></li><li><div>      return $out;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the generated query</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_generated_query()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Add extras column</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;is_select_statement() && stripos($this-&gt;object-&gt;_select_clause, 'count(') === FALSE) {&nbsp;</div></li><li><div>          $table_name = $this-&gt;object-&gt;get_table_name();&nbsp;</div></li><li><div>          $primary_key = &quot;{$table_name}.{$this-&gt;object-&gt;get_primary_key_column()}&quot;;&nbsp;</div></li><li><div>          if (stripos($this-&gt;object-&gt;_select_clause, 'DISTINCT') === FALSE) {&nbsp;</div></li><li><div>              $this-&gt;object-&gt;_select_clause = str_replace('SELECT', 'SELECT DISTINCT', $this-&gt;object-&gt;_select_clause);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;object-&gt;group_by($primary_key);&nbsp;</div></li><li><div>          $sql = $this-&gt;call_parent('get_generated_query');&nbsp;</div></li><li><div>          <span class="comment">// Sections may be omitted by wrapping them in mysql/C style comments</span>&nbsp;</div></li><li><div>          if (stripos($sql, '<span class="comment"><span class="comment">/*NGG_NO_EXTRAS_TABLE*/</span></span>') !== FALSE) {&nbsp;</div></li><li><div>              $parts = explode('<span class="comment"><span class="comment">/*NGG_NO_EXTRAS_TABLE*/</span></span>', $sql);&nbsp;</div></li><li><div>              foreach ($parts as $ndx =&gt; $row) {&nbsp;</div></li><li><div>                  if ($ndx % 2 != 0) {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $parts[$ndx] = $this-&gt;_regex_replace($row);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $sql = implode('', $parts);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $sql = $this-&gt;_regex_replace($sql);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $sql = $this-&gt;call_parent('get_generated_query');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $sql;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _convert_to_entity($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Add extra columns to entity</span>&nbsp;</div></li><li><div>      if (isset($entity-&gt;extras)) {&nbsp;</div></li><li><div>          $extras = $entity-&gt;extras;&nbsp;</div></li><li><div>          unset($entity-&gt;extras);&nbsp;</div></li><li><div>          foreach (explode(', ', $extras) as $extra) {&nbsp;</div></li><li><div>              if ($extra) {&nbsp;</div></li><li><div>                  list($key, $value) = explode('@@', $extra);&nbsp;</div></li><li><div>                  if ($this-&gt;object-&gt;has_defined_column($key) && !isset($entity-&gt;key)) {&nbsp;</div></li><li><div>                      $entity-&gt;{$key} = $value;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Cast custom_post_id as integer</span>&nbsp;</div></li><li><div>      if (isset($entity-&gt;extras_post_id)) {&nbsp;</div></li><li><div>          $entity-&gt;extras_post_id = intval($entity-&gt;extras_post_id);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $entity-&gt;extras_post_id = 0;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = $this-&gt;call_parent('_convert_to_entity', $entity);&nbsp;</div></li><li><div>      return $entity;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>NextGEN Gallery</li><li><span></span>2.2.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>