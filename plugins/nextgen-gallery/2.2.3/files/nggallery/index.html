<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.2.3" data-slug="nextgen-gallery" data-type="file" data-id="65217"><head xmlns="http://www.w3.org/1999/xhtml"><title> nggallery | file | Nextgen Gallery | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, nextgen-gallery, 2.2.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=9db56e959336aec5e9168f6b201fe4a5' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/nggallery/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fnggallery%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fnggallery%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-nextgen-gallery-2.2.3-file-nggallery","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="nggallery" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to nextgen-gallery." href="http://hookr.io/plugins/nextgen-gallery/" class="plugin"><span property="name">nextgen-gallery</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.2.3." href="http://hookr.io/plugins/nextgen-gallery/2.2.3/" class="H_VERSION"><span property="name">2.2.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/nextgen-gallery/2.2.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">nggallery</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="783"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/all/" title="All">All <span class="count badge">783</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="157"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/hooks/" title="Hooks">Hooks <span class="count badge">157</span></a></li><li class="" data-id="action" data-count="48"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/actions/" title="Actions">Actions <span class="count badge">48</span></a></li><li class="" data-id="filter" data-count="109"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/filters/" title="Filters">Filters <span class="count badge">109</span></a></li><li class="" data-id="class" data-count="374"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/classes/" title="Classes">Classes <span class="count badge">374</span></a></li><li class="" data-id="constant" data-count="172"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/constants/" title="Constants">Constants <span class="count badge">172</span></a></li><li class="" data-id="function" data-count="79"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/functions/" title="Functions">Functions <span class="count badge">79</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/nggallery.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>if(preg_match('#' . basename(__FILE__) . '#', $_SERVER['PHP_SELF'])) { die('You are not allowed to call this page directly.'); }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Plugin Name: NextGEN Gallery</span>&nbsp;</div></li><li><div><span class="comment"> * Description: The most popular gallery plugin for WordPress and one of the most popular plugins of all time with over 17 million downloads.</span>&nbsp;</div></li><li><div><span class="comment"> * Version: 2.2.3</span>&nbsp;</div></li><li><div><span class="comment"> * Author: Imagely</span>&nbsp;</div></li><li><div><span class="comment"> * Plugin URI: https://www.imagely.com/wordpress-gallery-plugin/nextgen-gallery/</span>&nbsp;</div></li><li><div><span class="comment"> * Author URI: https://www.imagely.com</span>&nbsp;</div></li><li><div><span class="comment"> * License: GPLv2</span>&nbsp;</div></li><li><div><span class="comment"> * Text Domain: nggallery</span>&nbsp;</div></li><li><div><span class="comment"> * Domain Path: /products/photocrati_nextgen/modules/i18n/lang</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>if (!class_exists('E_Clean_Exit')) { class E_Clean_Exit extends RuntimeException {} }&nbsp;</div></li><li><div>if (!class_exists('E_NggErrorException')) { class E_NggErrorException extends RuntimeException {} }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// This is a temporary function to replace the use of WP's esc_url which strips spaces away from URLs</span>&nbsp;</div></li><li><div><span class="comment">// TODO: Move this to a better place</span>&nbsp;</div></li><li><div>if (!function_exists('nextgen_esc_url')) {&nbsp;</div></li><li><div>  function nextgen_esc_url( $url, $protocols = null, $_context = 'display' ) {&nbsp;</div></li><li><div>      $original_url = $url;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '' == $url )&nbsp;</div></li><li><div>          return $url;&nbsp;</div></li><li><div>      $url = preg_replace('|[^a-z0-9 \\-~+_.?#=!&;, /:%@$\|*\'()\\x80-\\xff]|i', '', $url);&nbsp;</div></li><li><div>      $strip = array('%0d', '%0a', '%0D', '%0A');&nbsp;</div></li><li><div>      $url = _deep_replace($strip, $url);&nbsp;</div></li><li><div>      $url = str_replace(';<span class="comment">//', '://', $url);</span>&nbsp;</div></li><li><div>      <span class="comment">/** If the URL doesn't appear to contain a scheme, we</span>&nbsp;</div></li><li><div><span class="comment">       * presume it needs http:// appended (unless a relative</span>&nbsp;</div></li><li><div><span class="comment">       * link starting with /, # or ? or a php file).</span>&nbsp;</div></li><li><div><span class="comment">       */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( strpos($url, ':') === false && ! in_array( $url[0], array( '/', '#', '?' ) ) &&&nbsp;</div></li><li><div>           ! preg_match('/^[a-z0-9-]+?\.php/i', $url) )&nbsp;</div></li><li><div>          $url = 'http:<span class="comment">//' . $url;</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Replace ampersands and single quotes only when displaying.</span>&nbsp;</div></li><li><div>      if ( 'display' == $_context ) {&nbsp;</div></li><li><div>          $url = wp_kses_normalize_entities( $url );&nbsp;</div></li><li><div>          $url = str_replace( '&amp;', '&#038;', $url );&nbsp;</div></li><li><div>          $url = str_replace( &quot;'&quot;, '&#039;', $url );&nbsp;</div></li><li><div>          $url = str_replace( ' ', '%20', $url );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '/' === $url[0] ) {&nbsp;</div></li><li><div>          $good_protocol_url = $url;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if ( ! is_array( $protocols ) )&nbsp;</div></li><li><div>              $protocols = wp_allowed_protocols();&nbsp;</div></li><li><div>          $good_protocol_url = wp_kses_bad_protocol( $url, $protocols );&nbsp;</div></li><li><div>          if ( strtolower( $good_protocol_url ) != strtolower( $url ) )&nbsp;</div></li><li><div>              return '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters('clean_url', $good_protocol_url, $original_url, $_context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * NextGEN Gallery is built on top of the Pope Framework:</span>&nbsp;</div></li><li><div><span class="comment"> * https://bitbucket.org/photocrati/pope-framework</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Pope constructs applications by assembling modules.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * The Bootstrapper. This class performs the following:</span>&nbsp;</div></li><li><div><span class="comment"> * 1) Loads the Pope Framework</span>&nbsp;</div></li><li><div><span class="comment"> * 2) Adds a path to the C_Component_Registry instance to search for products</span>&nbsp;</div></li><li><div><span class="comment"> * 3) Loads all found Products. A Product is a collection of modules with some</span>&nbsp;</div></li><li><div><span class="comment"> * additional meta data. A Product is responsible for loading any modules it</span>&nbsp;</div></li><li><div><span class="comment"> * requires.</span>&nbsp;</div></li><li><div><span class="comment"> * 4) Once all Products (and their associated modules) have been loaded (or in</span>&nbsp;</div></li><li><div><span class="comment"> * otherwords, &quot;included&quot;), the modules are initialized.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_NextGEN_Bootstrap&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_registry = NULL;&nbsp;</div></li><li><div>  var $_settings_option_name = 'ngg_options';&nbsp;</div></li><li><div>  var $_pope_loaded = FALSE;&nbsp;</div></li><li><div>  static $debug = FALSE;&nbsp;</div></li><li><div>  var $minimum_ngg_pro_version = '2.0.5';&nbsp;</div></li><li><div>  var $minimum_ngg_plus_version = '1.0.1';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function shutdown($exception=NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_null($exception)) {&nbsp;</div></li><li><div>          throw new E_Clean_Exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      elseif (!($exception instanceof E_Clean_Exit)) {&nbsp;</div></li><li><div>          ob_end_clean();&nbsp;</div></li><li><div>          self::print_exception($exception);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function print_exception($exception)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $klass = get_class($exception);&nbsp;</div></li><li><div>      echo &quot;&lt;h1&gt;{$klass} thrown&lt;/h1&gt;&quot;;&nbsp;</div></li><li><div>      echo &quot;&lt;p&gt;{$exception-&gt;getMessage()}&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>      if (self::$debug OR (defined('NGG_DEBUG') AND NGG_DEBUG == TRUE)) {&nbsp;</div></li><li><div>          echo &quot;&lt;h3&gt;Where:&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;p&gt;On line &lt;strong&gt;{$exception-&gt;getLine()}&lt;/strong&gt; of &lt;strong&gt;{$exception-&gt;getFile()}&lt;/strong&gt;&lt;/p&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;h3&gt;Trace:&lt;/h3&gt;&quot;;&nbsp;</div></li><li><div>          echo &quot;&lt;pre&gt;{$exception-&gt;getTraceAsString()}&lt;/pre&gt;&quot;;&nbsp;</div></li><li><div>          if (method_exists($exception, 'getPrevious')) {&nbsp;</div></li><li><div>              if (($previous = $exception-&gt;getPrevious())) {&nbsp;</div></li><li><div>                  self::print_exception($previous);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static function get_backtrace($objects=FALSE, $remove_dynamic_calls=TRUE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $trace = debug_backtrace($objects);&nbsp;</div></li><li><div>      if ($remove_dynamic_calls) {&nbsp;</div></li><li><div>          $skip_methods = array(&nbsp;</div></li><li><div>              '_exec_cached_method', &nbsp;</div></li><li><div>              '__call', &nbsp;</div></li><li><div>              'get_method_property', &nbsp;</div></li><li><div>              'set_method_property', &nbsp;</div></li><li><div>              'call_method'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          foreach ($trace as $key =&gt; &$value) {&nbsp;</div></li><li><div>              if (isset($value['class']) && isset($value['function'])) {&nbsp;</div></li><li><div>                  if ($value['class'] == 'ReflectionMethod' && $value['function'] == 'invokeArgs')&nbsp;</div></li><li><div>                      unset($trace[$key]);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  else if ($value['class'] == 'ExtensibleObject' && in_array($value['function'], $skip_methods))&nbsp;</div></li><li><div>                      unset($trace[$key]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $trace;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      set_exception_handler(__CLASS__.'::shutdown');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We only load the plugin if we're outside of the activation request, loaded in an iframe</span>&nbsp;</div></li><li><div>      <span class="comment">// by WordPress. Reason being, if WP_DEBUG is enabled, and another Pope-based plugin (such as</span>&nbsp;</div></li><li><div>      <span class="comment">// the photocrati theme or NextGEN Pro/Plus), then PHP will output strict warnings</span>&nbsp;</div></li><li><div>      if ($this-&gt;is_not_activating()) {&nbsp;</div></li><li><div>          $this-&gt;_define_constants();&nbsp;</div></li><li><div>          $this-&gt;_load_non_pope();&nbsp;</div></li><li><div>          $this-&gt;_register_hooks();&nbsp;</div></li><li><div>          $this-&gt;_load_pope();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_not_activating()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return !$this-&gt;is_activating();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_activating()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval =  strpos($_SERVER['REQUEST_URI'], 'plugins.php') !== FALSE && isset($_REQUEST['action']) && in_array($_REQUEST['action'], array('activate-selected'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$retval && strpos($_SERVER['REQUEST_URI'], 'update.php') !== FALSE && isset($_REQUEST['action']) && $_REQUEST['action'] == 'install-plugin' && isset($_REQUEST['plugin']) && strpos($_REQUEST['plugin'], 'nextgen-gallery') === 0) {&nbsp;</div></li><li><div>          $retval = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!$retval && strpos($_SERVER['REQUEST_URI'], 'update.php') !== FALSE && isset($_REQUEST['action']) && $_REQUEST['action'] == 'activate-plugin' && isset($_REQUEST['plugin']) && strpos($_REQUEST['plugin'], 'nextgen-gallery') === 0) {&nbsp;</div></li><li><div>          $retval = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function _load_non_pope()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Load caching component</span>&nbsp;</div></li><li><div>      include_once('non_pope/class.photocrati_transient_manager.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (isset($_REQUEST['ngg_flush']) OR isset($_REQUEST['ngg_flush_expired'])) {&nbsp;</div></li><li><div>          C_Photocrati_Transient_Manager::flush();&nbsp;</div></li><li><div>          die(&quot;Flushed all caches&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load Settings Manager</span>&nbsp;</div></li><li><div>      include_once('non_pope/class.photocrati_settings_manager.php');&nbsp;</div></li><li><div>      include_once('non_pope/class.nextgen_settings.php');&nbsp;</div></li><li><div>      C_Photocrati_Global_Settings_Manager::$option_name = $this-&gt;_settings_option_name;&nbsp;</div></li><li><div>      C_Photocrati_Settings_Manager::$option_name = $this-&gt;_settings_option_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the installer</span>&nbsp;</div></li><li><div>      include_once('non_pope/class.photocrati_installer.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the resource manager</span>&nbsp;</div></li><li><div>      include_once('non_pope/class.photocrati_resource_manager.php');&nbsp;</div></li><li><div>      C_Photocrati_Resource_Manager::init();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the style manager</span>&nbsp;</div></li><li><div>      include_once('non_pope/class.nextgen_style_manager.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load the shortcode manager</span>&nbsp;</div></li><li><div>      include_once('non_pope/class.nextgen_shortcode_manager.php');&nbsp;</div></li><li><div>      C_NextGen_Shortcode_Manager::get_instance();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function fix_loading_order()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// If a plugin wasn't activated/deactivated siliently, we can listen for these things</span>&nbsp;</div></li><li><div>      if (did_action('activate_plugin') || did_action('deactivate_plugin')) return;&nbsp;</div></li><li><div>      else if (strpos($_SERVER['REQUEST_URI'], 'plugins') !== FALSE) return;&nbsp;</div></li><li><div>      else if (!$this-&gt;is_page_request()) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugins = get_option('active_plugins');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove NGG from the list</span>&nbsp;</div></li><li><div>      $ngg = basename(dirname(__FILE__)).'/'.basename(__FILE__);&nbsp;</div></li><li><div>      $order = array();&nbsp;</div></li><li><div>      foreach ($plugins as $plugin) {&nbsp;</div></li><li><div>          if ($plugin != $ngg) $order[] = $plugin;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the position of either NGG Pro or NGG Plus</span>&nbsp;</div></li><li><div>      $insert_at = FALSE;&nbsp;</div></li><li><div>      for($i=0; $i&lt;count($order); $i++) {&nbsp;</div></li><li><div>          $plugin = $order[$i];&nbsp;</div></li><li><div>          if (strpos($plugin, 'nggallery-pro') !== FALSE) $insert_at = $i+1;&nbsp;</div></li><li><div>          else if (strpos($plugin, 'ngg-plus') !== FALSE) $insert_at = $i+1;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Re-insert NGG after Pro or Plus</span>&nbsp;</div></li><li><div>      if ($insert_at === FALSE || $insert_at === count($order)) $order[] = $ngg;&nbsp;</div></li><li><div>      elseif ($insert_at === 0) array_unshift($order, $ngg);&nbsp;</div></li><li><div>      else array_splice($order, $insert_at, 0, array($ngg));&nbsp;</div></li><li><div>      &nbsp;</div></li><li><div>      if ($order != $plugins) {&nbsp;</div></li><li><div>          $order = array_filter($order);&nbsp;</div></li><li><div>          update_option('active_plugins', $order);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Loads the Pope Framework</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _load_pope()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// No need to initialize pope again</span>&nbsp;</div></li><li><div>      if ($this-&gt;_pope_loaded) return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Pope requires a a higher limit</span>&nbsp;</div></li><li><div>      $tmp = ini_get('xdebug.max_nesting_level');&nbsp;</div></li><li><div>      if ($tmp && (int)$tmp &lt;= 300) @ini_set('xdebug.max_nesting_level', 300);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Include pope framework</span>&nbsp;</div></li><li><div>      require_once(implode(&nbsp;</div></li><li><div>          DIRECTORY_SEPARATOR, array(NGG_PLUGIN_DIR, 'pope', 'lib', 'autoload.php')&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Enable/disable pope caching. For now, the pope cache will not be used in multisite environments</span>&nbsp;</div></li><li><div>      if (class_exists('C_Pope_Cache')) {&nbsp;</div></li><li><div>          if ((C_Pope_Cache::$enabled = NGG_POPE_CACHE)) {&nbsp;</div></li><li><div>              $blogid = (is_multisite() ? get_current_blog_id() : NULL);&nbsp;</div></li><li><div>              if (isset($_SERVER['SERVER_ADDR']))&nbsp;</div></li><li><div>                  $cache_key_prefix = abs(crc32((implode('|', array($blogid, site_url(), AUTH_KEY, $_SERVER['SERVER_ADDR'])))));&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  $cache_key_prefix = abs(crc32(implode('|', array($blogid, site_url(), AUTH_KEY))));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              C_Pope_Cache::set_driver('C_Pope_Cache_SingleFile');&nbsp;</div></li><li><div>              C_Pope_Cache::add_key_prefix($cache_key_prefix);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Enforce interfaces</span>&nbsp;</div></li><li><div>      if (property_exists('ExtensibleObject', 'enforce_interfaces')) ExtensibleObject::$enforce_interfaces = EXTENSIBLE_OBJECT_ENFORCE_INTERFACES;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the component registry</span>&nbsp;</div></li><li><div>      $this-&gt;_registry = C_Component_Registry::get_instance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the default Pope factory utility, C_Component_Factory</span>&nbsp;</div></li><li><div>      $this-&gt;_registry-&gt;add_utility('I_Component_Factory', 'C_Component_Factory');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Blacklist any modules which are known NOT to work with this version of NextGEN Gallery</span>&nbsp;</div></li><li><div>      <span class="comment">// We need to check if we have this ability as it's only available with Pope 0.9</span>&nbsp;</div></li><li><div>      if (method_exists($this-&gt;_registry, 'blacklist_module_file')) {&nbsp;</div></li><li><div>          $this-&gt;_registry-&gt;blacklist_module_file('module.nextgen_pro_lightbox_legacy.php');&nbsp;</div></li><li><div>          $this-&gt;_registry-&gt;blacklist_module_file('module.protect_image.php');&nbsp;</div></li><li><div>          <span class="comment">// TODO: Add module id for protect image</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If Pro is incompatible, then we need to blacklist all of Pro's modules</span>&nbsp;</div></li><li><div>      <span class="comment">// TODO: Pope needs a better way of introspecting into a product's list of provided modules</span>&nbsp;</div></li><li><div>      if ($this-&gt;is_pro_incompatible()) {&nbsp;</div></li><li><div>          $pro_modules = array(&nbsp;</div></li><li><div>              'photocrati-comments', &nbsp;</div></li><li><div>              'photocrati-galleria', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_slideshow', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_horizontal_filmstrip', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_thumbnail_grid', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_blog_gallery', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_film', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_masonry', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_albums', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_lightbox', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_lightbox_legacy', &nbsp;</div></li><li><div>              'photocrati-nextgen_pro_ecommerce', &nbsp;</div></li><li><div>              'photocrati-paypal_express_checkout', &nbsp;</div></li><li><div>              'photocrati-paypal_standard', &nbsp;</div></li><li><div>              'photocrati-stripe'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          foreach ($pro_modules as $mod) $this-&gt;_registry-&gt;blacklist_module_file($mod);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Load embedded products. Each product is expected to load any</span>&nbsp;</div></li><li><div>      <span class="comment">// modules required</span>&nbsp;</div></li><li><div>      $this-&gt;_registry-&gt;add_module_path(NGG_PRODUCT_DIR, 2, false);&nbsp;</div></li><li><div>      $this-&gt;_registry-&gt;load_all_products();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Give third-party plugins that opportunity to include their own products</span>&nbsp;</div></li><li><div>      <span class="comment">// and modules</span>&nbsp;</div></li><li><div>      do_action('load_nextgen_gallery_modules', $this-&gt;_registry);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Initializes all loaded modules</span>&nbsp;</div></li><li><div>      $this-&gt;_registry-&gt;initialize_all_modules();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;_pope_loaded = TRUE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_pro_compatible()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = TRUE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (defined('NEXTGEN_GALLERY_PRO_VERSION')) $retval = FALSE;&nbsp;</div></li><li><div>      if (defined('NEXTGEN_GALLERY_PRO_PLUGIN_BASENAME') && !defined('NGG_PRO_PLUGIN_VERSION')) $retval = FALSE; <span class="comment">// 1.0 - 1.0.6</span>&nbsp;</div></li><li><div>      if (defined('NGG_PRO_PLUGIN_VERSION')  && version_compare(NGG_PRO_PLUGIN_VERSION, $this-&gt;minimum_ngg_pro_version)  &lt; 0) $retval = FALSE;&nbsp;</div></li><li><div>      if (defined('NGG_PLUS_PLUGIN_VERSION') && version_compare(NGG_PLUS_PLUGIN_VERSION, $this-&gt;minimum_ngg_plus_version) &lt; 0) $retval = FALSE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_pro_incompatible()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return !$this-&gt;is_pro_compatible();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function render_incompatibility_warning()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      echo '&lt;div class=&quot;updated error&quot;&gt;&lt;p&gt;';&nbsp;</div></li><li><div>      echo esc_html(&nbsp;</div></li><li><div>          sprintf(&nbsp;</div></li><li><div>              __(&quot;NextGEN Gallery %s is incompatible with this version of NextGEN Pro. Please update NextGEN Pro to version %s or higher to restore NextGEN Pro functionality.&quot;, &nbsp;</div></li><li><div>                  'nggallery'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>              NGG_PLUGIN_VERSION, $this-&gt;minimum_ngg_pro_version&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>      echo '&lt;/p&gt;&lt;/div&gt;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Registers hooks for the WordPress framework necessary for instantiating</span>&nbsp;</div></li><li><div><span class="comment">   * the plugin</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _register_hooks()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Register the deactivation routines</span>&nbsp;</div></li><li><div>      add_action('deactivate_'.NGG_PLUGIN_BASENAME, array(get_class(), 'deactivate'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Register our test suite</span>&nbsp;</div></li><li><div>      add_filter('simpletest_suites', array(&$this, 'add_testsuite'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Ensure that settings manager is saved as an array</span>&nbsp;</div></li><li><div>      add_filter('pre_update_option_'.$this-&gt;_settings_option_name, array(&$this, 'persist_settings'));&nbsp;</div></li><li><div>      add_filter('pre_update_site_option_'.$this-&gt;_settings_option_name, array(&$this, 'persist_settings'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This plugin uses jQuery extensively</span>&nbsp;</div></li><li><div>      if (NGG_FIX_JQUERY) {&nbsp;</div></li><li><div>          add_action('wp_enqueue_scripts', array(&$this, 'fix_jquery'));&nbsp;</div></li><li><div>          add_action('wp_print_scripts', array(&$this, 'fix_jquery'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If the selected stylesheet is using an unsafe path, then notify the user</span>&nbsp;</div></li><li><div>      add_action('all_admin_notices', array(&$this, 'display_stylesheet_notice'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Delete displayed gallery transients periodically</span>&nbsp;</div></li><li><div>      if (NGG_CRON_ENABLED) {&nbsp;</div></li><li><div>          add_filter('cron_schedules', array(&$this, 'add_ngg_schedule'));&nbsp;</div></li><li><div>          add_action('ngg_delete_expired_transients', array(&$this, 'delete_expired_transients'));&nbsp;</div></li><li><div>          add_action('wp', array(&$this, 'schedule_cron_jobs'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Update modules</span>&nbsp;</div></li><li><div>      add_action('init', array(&$this, 'update'), PHP_INT_MAX-2);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Start the plugin!</span>&nbsp;</div></li><li><div>      add_action('init', array(&$this, 'route'), 11);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Flush pope cache</span>&nbsp;</div></li><li><div>      add_action('init', array(&$this, 'flush_pope_cache'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// NGG extension plugins should be loaded in a specific order</span>&nbsp;</div></li><li><div>      add_action('shutdown', array(&$this, 'fix_loading_order'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Display a warning if an compatible version of NextGEN Pro is installed alongside this</span>&nbsp;</div></li><li><div>      <span class="comment">// version of NextGEN Gallery</span>&nbsp;</div></li><li><div>      if ($this-&gt;is_pro_incompatible()) {&nbsp;</div></li><li><div>          add_filter('http_request_args', array(&$this, 'fix_autoupdate_api_requests'), 10, 2);&nbsp;</div></li><li><div>          add_action('all_admin_notices', array(&$this, 'render_incompatibility_warning'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter('ngg_load_frontend_logic', array($this, 'disable_frontend_logic'), -10, 2);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function disable_frontend_logic($enabled, $module_id)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_admin())&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>          if (!$settings-&gt;get('always_enable_frontend_logic'))&nbsp;</div></li><li><div>              $enabled = FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $enabled;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function fix_autoupdate_api_requests($args, $url)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Is this an HTTP request to the licensing server?</span>&nbsp;</div></li><li><div>      if (preg_match(&quot;/api_act=/&quot;, $url)) {&nbsp;</div></li><li><div>          $args['autoupdate'] = TRUE;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If we're supposed to pass all Pro modules, then include them here</span>&nbsp;</div></li><li><div>          if (preg_match(&quot;/api_act=(ckups|cklic)/&quot;, $url) && isset($args['body']) && is_array($args['body']) && isset($args['body']['module-list'])) {&nbsp;</div></li><li><div>              $pro_modules = array(&nbsp;</div></li><li><div>                  'photocrati-comments', &nbsp;</div></li><li><div>                  'photocrati-galleria', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_slideshow', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_horizontal_filmstrip', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_thumbnail_grid', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_blog_gallery', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_film', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_masonry', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_albums', &nbsp;</div></li><li><div>                  'photocrati-auto_update', &nbsp;</div></li><li><div>                  'photocrati-auto_update-admin', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_lightbox', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_lightbox_legacy', &nbsp;</div></li><li><div>                  'photocrati-nextgen_pro_ecommerce', &nbsp;</div></li><li><div>                  'photocrati-paypal_express_checkout', &nbsp;</div></li><li><div>                  'photocrati-paypal_standard', &nbsp;</div></li><li><div>                  'photocrati-stripe'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              foreach ($pro_modules as $mod) {&nbsp;</div></li><li><div>                  if (!isset($args['body']['module-list'][$mod])) $args['body']['module-list'][$mod] = '0.1';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $args;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function flush_pope_cache()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_user_logged_in() && current_user_can('manage_options') && isset($_REQUEST['ngg_flush_pope_cache'])) {&nbsp;</div></li><li><div>          C_Pope_Cache::get_instance()-&gt;flush();&nbsp;</div></li><li><div>          print &quot;Flushed pope cache&quot;;&nbsp;</div></li><li><div>          exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function schedule_cron_jobs()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!wp_next_scheduled('ngg_delete_expired_transients')) {&nbsp;</div></li><li><div>          wp_schedule_event(time(), 'ngg_custom', 'ngg_delete_expired_transients');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines a new cron schedule</span>&nbsp;</div></li><li><div><span class="comment">   * @param $schedules</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function add_ngg_schedule($schedules)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $schedules['ngg_custom'] = array(&nbsp;</div></li><li><div>          'interval' =&gt;    NGG_CRON_SCHEDULE, &nbsp;</div></li><li><div>          'display' =&gt;    sprintf(__('Every %d seconds', 'nggallery'), NGG_CRON_SCHEDULE)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $schedules;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Flush all expires transients created by the plugin</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function delete_expired_transients()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      C_Photocrati_Transient_Manager::flush();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Ensure that C_Photocrati_Settings_Manager gets persisted as an array</span>&nbsp;</div></li><li><div><span class="comment">   * @param $settings</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function persist_settings($settings)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (is_object($settings) && $settings instanceof C_Photocrati_Settings_Manager_Base) {&nbsp;</div></li><li><div>          $settings = $settings-&gt;to_array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $settings;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Ensures that the version of JQuery used is expected for NextGEN Gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function fix_jquery()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wp_scripts;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Determine which version of jQuery to include</span>&nbsp;</div></li><li><div>      $src = '/wp-includes/js/jquery/jquery.js';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Ensure that jQuery is always set to the default</span>&nbsp;</div></li><li><div>      if (isset($wp_scripts-&gt;registered['jquery'])) {&nbsp;</div></li><li><div>          $jquery = $wp_scripts-&gt;registered['jquery'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// There's an exception to the rule. We'll allow the same</span>&nbsp;</div></li><li><div>          <span class="comment">// version of jQuery as included with WP to be fetched from</span>&nbsp;</div></li><li><div>          <span class="comment">// Google AJAX libraries, as we have a systematic means of verifying</span>&nbsp;</div></li><li><div>          <span class="comment">// that won't cause any troubles</span>&nbsp;</div></li><li><div>          $version = preg_quote($jquery-&gt;ver, '#');&nbsp;</div></li><li><div>          if (!preg_match(&quot;#ajax\\.googleapis\\.com/ajax/libs/jquery/{$version}/jquery\\.min\\.js#&quot;, $jquery-&gt;src)) {&nbsp;</div></li><li><div>              $jquery-&gt;src = FALSE;&nbsp;</div></li><li><div>              if (array_search('jquery-core', $jquery-&gt;deps) === FALSE) {&nbsp;</div></li><li><div>                  $jquery-&gt;deps[] = 'jquery-core';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if (array_search('jquery-migrate', $jquery-&gt;deps) === FALSE) {&nbsp;</div></li><li><div>                  $jquery-&gt;deps[] = 'jquery-migrate';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Ensure that jquery-core is used, as WP intended</span>&nbsp;</div></li><li><div>      if (isset($wp_scripts-&gt;registered['jquery-core'])) {&nbsp;</div></li><li><div>          $wp_scripts-&gt;registered['jquery-core']-&gt;src = $src;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_enqueue_script('jquery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Displays a notice to the user that the current stylesheet location is unsafe</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function display_stylesheet_notice()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (C_NextGen_Style_Manager::get_instance()-&gt;is_directory_unsafe()) {&nbsp;</div></li><li><div>          $styles = C_NextGen_Style_Manager::get_instance();&nbsp;</div></li><li><div>          $filename = $styles-&gt;get_selected_stylesheet();&nbsp;</div></li><li><div>          $abspath = $styles-&gt;find_selected_stylesheet_abspath();&nbsp;</div></li><li><div>          $newpath = $styles-&gt;new_dir;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          echo &quot;&lt;div class='updated error'&gt;&nbsp;</div></li><li><div>              &lt;h3&gt;WARNING: NextGEN Gallery Stylesheet NOT Upgrade-safe&lt;/h3&gt;&nbsp;</div></li><li><div>              &lt;p&gt;&nbsp;</div></li><li><div>              &lt;strong&gt;{$filename}&lt;/strong&gt; is currently stored in &lt;strong&gt;{$abspath}&lt;/strong&gt;, which isn't upgrade-safe. Please move the stylesheet to&nbsp;</div></li><li><div>              &lt;strong&gt;{$newpath}&lt;/strong&gt; to ensure that your customizations persist after updates.&nbsp;</div></li><li><div>          &lt;/p&gt;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Updates all modules</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function update()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ((!(defined('DOING_AJAX') && DOING_AJAX)) && !isset($_REQUEST['doing_wp_cron'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $this-&gt;_load_pope();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Try updating all modules</span>&nbsp;</div></li><li><div>          C_Photocrati_Installer::update();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Routes access points using the Pope Router</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function route()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;_load_pope();&nbsp;</div></li><li><div>      $router = C_Router::get_instance();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set context to path if subdirectory install</span>&nbsp;</div></li><li><div>      $parts = parse_url($router-&gt;get_base_url(FALSE));&nbsp;</div></li><li><div>      if (isset($parts['path'])) {&nbsp;</div></li><li><div>          $parts = explode('/index.php', $parts['path']);&nbsp;</div></li><li><div>          $router-&gt;context = array_shift($parts);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Provide a means for modules/third-parties to configure routes</span>&nbsp;</div></li><li><div>      do_action_ref_array('ngg_routes', array(&$router));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Serve the routes</span>&nbsp;</div></li><li><div>      if (!$router-&gt;serve_request() && $router-&gt;has_parameter_segments()) {&nbsp;</div></li><li><div>          return $router-&gt;passthru();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function is_page_request()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return !(defined('DOING_AJAX') && DOING_AJAX) && !(defined('DOING_CRON') && DOING_CRON) && !(defined('NGG_AJAX_SLUG') && strpos($_SERVER['REQUEST_URI'], NGG_AJAX_SLUG) !== FALSE);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Run the uninstaller</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function deactivate()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      include_once('products/photocrati_nextgen/class.nextgen_product_installer.php');&nbsp;</div></li><li><div>      C_Photocrati_Installer::add_handler(NGG_PLUGIN_BASENAME, 'C_NextGen_Product_Installer');&nbsp;</div></li><li><div>      C_Photocrati_Installer::uninstall(NGG_PLUGIN_BASENAME);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines necessary plugins for the plugin to load correctly</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _define_constants()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      define('NGG_PLUGIN', basename($this-&gt;directory_path()));&nbsp;</div></li><li><div>      define('NGG_PLUGIN_BASENAME', plugin_basename(__FILE__));&nbsp;</div></li><li><div>      define('NGG_PLUGIN_DIR', $this-&gt;directory_path());&nbsp;</div></li><li><div>      define('NGG_PLUGIN_URL', $this-&gt;path_uri());&nbsp;</div></li><li><div>      define('NGG_TESTS_DIR', implode(DIRECTORY_SEPARATOR, array(rtrim(NGG_PLUGIN_DIR, &quot;/\\&quot;), 'tests')));&nbsp;</div></li><li><div>      define('NGG_PRODUCT_DIR', implode(DIRECTORY_SEPARATOR, array(rtrim(NGG_PLUGIN_DIR, &quot;/\\&quot;), 'products')));&nbsp;</div></li><li><div>      define('NGG_MODULE_DIR', implode(DIRECTORY_SEPARATOR, array(rtrim(NGG_PRODUCT_DIR, &quot;/\\&quot;), 'photocrati_nextgen', 'modules')));&nbsp;</div></li><li><div>      define('NGG_PRODUCT_URL', path_join(str_replace(&quot;\\&quot;, '/', NGG_PLUGIN_URL), 'products'));&nbsp;</div></li><li><div>      define('NGG_MODULE_URL', path_join(str_replace(&quot;\\&quot;, '/', NGG_PRODUCT_URL), 'photocrati_nextgen/modules'));&nbsp;</div></li><li><div>      define('NGG_PLUGIN_STARTED_AT', microtime());&nbsp;</div></li><li><div>      define('NGG_PLUGIN_VERSION', '2.2.3');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (defined('SCRIPT_DEBUG') && SCRIPT_DEBUG)&nbsp;</div></li><li><div>          define('NGG_SCRIPT_VERSION', (string)mt_rand(0, mt_getrandmax()));&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          define('NGG_SCRIPT_VERSION', NGG_PLUGIN_VERSION);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!defined('NGG_HIDE_STRICT_ERRORS')) {&nbsp;</div></li><li><div>          define('NGG_HIDE_STRICT_ERRORS', TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Should we display E_STRICT errors?</span>&nbsp;</div></li><li><div>      if (NGG_HIDE_STRICT_ERRORS) {&nbsp;</div></li><li><div>          $level = error_reporting();&nbsp;</div></li><li><div>          if ($level != 0) error_reporting($level & ~E_STRICT);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Should we display NGG debugging information?</span>&nbsp;</div></li><li><div>      if (!defined('NGG_DEBUG')) {&nbsp;</div></li><li><div>          define('NGG_DEBUG', FALSE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      self::$debug = NGG_DEBUG;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// User definable constants</span>&nbsp;</div></li><li><div>      if (!defined('NGG_IMPORT_ROOT')) {&nbsp;</div></li><li><div>          $path = WP_CONTENT_DIR;&nbsp;</div></li><li><div>          if (defined('NEXTGEN_GALLERY_IMPORT_ROOT')) {&nbsp;</div></li><li><div>              $path = NEXTGEN_GALLERY_IMPORT_ROOT;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          define('NGG_IMPORT_ROOT', $path);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Should the Photocrati cache be enabled</span>&nbsp;</div></li><li><div>      if (!defined('PHOTOCRATI_CACHE')) {&nbsp;</div></li><li><div>          define('PHOTOCRATI_CACHE', TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!defined('PHOTOCRATI_CACHE_TTL')) {&nbsp;</div></li><li><div>          define('PHOTOCRATI_CACHE_TTL', 1800);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Cron job</span>&nbsp;</div></li><li><div>      if (!defined('NGG_CRON_SCHEDULE')) {&nbsp;</div></li><li><div>          define('NGG_CRON_SCHEDULE', 900);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (!defined('NGG_CRON_ENABLED')) {&nbsp;</div></li><li><div>          define('NGG_CRON_ENABLED', TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Don't enforce interfaces</span>&nbsp;</div></li><li><div>      if (!defined('EXTENSIBLE_OBJECT_ENFORCE_INTERFACES')) {&nbsp;</div></li><li><div>          define('EXTENSIBLE_OBJECT_ENFORCE_INTERFACES', FALSE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fix jquery</span>&nbsp;</div></li><li><div>      if (!defined('NGG_FIX_JQUERY')) {&nbsp;</div></li><li><div>          define('NGG_FIX_JQUERY', TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Use Pope's new caching mechanism?</span>&nbsp;</div></li><li><div>      if (!defined('NGG_POPE_CACHE')) {&nbsp;</div></li><li><div>          define('NGG_POPE_CACHE', FALSE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines the NextGEN Test Suite</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $suites</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function add_testsuite($suites=array())&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $tests_dir = NGG_TESTS_DIR;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (file_exists($tests_dir)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Include mock objects</span>&nbsp;</div></li><li><div>          <span class="comment">// TODO: These mock objects should be moved to the appropriate</span>&nbsp;</div></li><li><div>          <span class="comment">// test folder</span>&nbsp;</div></li><li><div>          require_once(path_join($tests_dir, 'mocks.php'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Define the NextGEN Test Suite</span>&nbsp;</div></li><li><div>          $suites['nextgen'] = array(&nbsp;</div></li><li><div><span class="comment">//                path_join($tests_dir, 'mvc'), </span>&nbsp;</div></li><li><div>              path_join($tests_dir, 'datamapper'), &nbsp;</div></li><li><div>              path_join($tests_dir, 'nextgen_data'), &nbsp;</div></li><li><div>              path_join($tests_dir, 'gallery_display')&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $suites;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the path to a file within the plugin root folder</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $file_name</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function file_path($file_name=NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $path = dirname(__FILE__);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($file_name != null)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $path .= '/' . $file_name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return str_replace(array('/', '\\'), DIRECTORY_SEPARATOR, $path);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the directory path used by the plugin</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function directory_path($dir=NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;file_path($dir);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determines the location of the plugin - within a theme or plugin</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_plugin_location()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $path = dirname(__FILE__);&nbsp;</div></li><li><div>      $gallery_dir = strtolower($path);&nbsp;</div></li><li><div>      $gallery_dir = str_replace(array('/', '\\'), DIRECTORY_SEPARATOR, $gallery_dir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $theme_dir = strtolower(get_stylesheet_directory());&nbsp;</div></li><li><div>      $theme_dir = str_replace(array('/', '\\'), DIRECTORY_SEPARATOR, $theme_dir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $plugin_dir = strtolower(WP_PLUGIN_DIR);&nbsp;</div></li><li><div>      $plugin_dir = str_replace(array('/', '\\'), DIRECTORY_SEPARATOR, $plugin_dir);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $common_dir_theme = substr($gallery_dir, 0, strlen($theme_dir));&nbsp;</div></li><li><div>      $common_dir_plugin = substr($gallery_dir, 0, strlen($plugin_dir));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($common_dir_theme == $theme_dir)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return 'theme';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($common_dir_plugin == $plugin_dir)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return 'plugin';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parent_dir = dirname($path);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if (file_exists($parent_dir . DIRECTORY_SEPARATOR . 'style.css'))&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          return 'theme';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return 'plugin';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the URI for a particular path</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $url_encode</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function path_uri($path = null, $url_encode = false)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $location = $this-&gt;get_plugin_location();&nbsp;</div></li><li><div>      $uri = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $path = str_replace(array('/', '\\'), '/', $path);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($url_encode)&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $path_list = explode('/', $path);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          foreach ($path_list as $index =&gt; $path_item)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $path_list[$index] = urlencode($path_item);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $path = implode('/', $path_list);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ($location == 'theme')&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          $theme_uri = get_stylesheet_directory_uri();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $uri = $theme_uri . 'nextgen-gallery';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($path != null)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $uri .= '/' . $path;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>      {&nbsp;</div></li><li><div>          <span class="comment">// XXX Note, paths could not match but STILL being contained in the theme (i.e. WordPress returns the wrong path for the theme directory, either with wrong formatting or wrong encoding)</span>&nbsp;</div></li><li><div>          $base = basename(dirname(__FILE__));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($base != 'nextgen-gallery')&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              <span class="comment">// XXX this is needed when using symlinks, if the user renames the plugin folder everything will break though</span>&nbsp;</div></li><li><div>              $base = 'nextgen-gallery';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ($path != null)&nbsp;</div></li><li><div>          {&nbsp;</div></li><li><div>              $base .= '/' . $path;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $uri = plugins_url($base);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $uri;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the URI for a particular file</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $file_name</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function file_uri($file_name = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;path($file_name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>#region Freemius&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Customize the opt-in message.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Vova Feldman (@svovaf)</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1.32</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $message</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_first_name</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $plugin_title</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $user_login</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $site_link</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $freemius_link</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ngg_fs_custom_connect_message(&nbsp;</div></li><li><div>  $message, &nbsp;</div></li><li><div>  $user_first_name, &nbsp;</div></li><li><div>  $plugin_title, &nbsp;</div></li><li><div>  $user_login, &nbsp;</div></li><li><div>  $site_link, &nbsp;</div></li><li><div>  $freemius_link&nbsp;</div></li><li><div>) {&nbsp;</div></li><li><div>  return sprintf(&nbsp;</div></li><li><div>      __fs( 'hey-x' ) . '&lt;br&gt;' .&nbsp;</div></li><li><div>      __( 'Allow %6$s to collect some usage data with %5$s to make the plugin even more awesome. If you skip this, that\'s okay! %2$s will still work just fine.', 'nggallery' ), &nbsp;</div></li><li><div>      $user_first_name, &nbsp;</div></li><li><div>      '&lt;b&gt;' . __('NextGEN Gallery', 'nggallery') . '&lt;/b&gt;', &nbsp;</div></li><li><div>      '&lt;b&gt;' . $user_login . '&lt;/b&gt;', &nbsp;</div></li><li><div>      $site_link, &nbsp;</div></li><li><div>      $freemius_link, &nbsp;</div></li><li><div>      '&lt;b&gt;' . __('Imagely', 'nggallery') . '&lt;/b&gt;'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Uninstall cleanup script.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ngg_fs_uninstall() {&nbsp;</div></li><li><div>  <span class="comment">// Your cleanup script.</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Send custom event about 1st gallery creation.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Vova Feldman (@svovaf)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function fs_track_new_gallery() {&nbsp;</div></li><li><div>  global $ngg_fs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $galleries = C_Gallery_Mapper::get_instance()-&gt;count();&nbsp;</div></li><li><div>  if (1 == $galleries) {&nbsp;</div></li><li><div>      <span class="comment">// Only track event on 1st gallery creation.</span>&nbsp;</div></li><li><div>      $ngg_fs-&gt;track_event_once( 'new_gallery' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Create a helper function for easy SDK access.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @author Vova Feldman (@svovaf)</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.1.32</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $activate_for_all If true, activate Freemius for all users. Was added for testing.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return \Freemius</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function ngg_fs( $activate_for_all = false ) {&nbsp;</div></li><li><div>  global $ngg_fs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $activate_for_all ) {&nbsp;</div></li><li><div>      $ngg_options = get_option( 'ngg_options' );&nbsp;</div></li><li><div>      $ngg_run_freemius = get_option( 'ngg_run_freemius', null );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false === $ngg_options ) {&nbsp;</div></li><li><div>          <span class="comment">// New plugin installation.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( defined( 'WP_FS__DEV_MODE' ) && WP_FS__DEV_MODE ) {&nbsp;</div></li><li><div>              <span class="comment">// Always run Freemius in development mode for new plugin installs.</span>&nbsp;</div></li><li><div>              $run_freemius = true;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Run Freemius code on 20% of the new installations.</span>&nbsp;</div></li><li><div>          <span class="comment">// $random = rand( 1, 10 );</span>&nbsp;</div></li><li><div>          <span class="comment">// $run_freemius = ( 1 &lt;= $random && $random &lt;= 2 );</span>&nbsp;</div></li><li><div>          <span class="comment">// Update 2016-08: run on all new instances</span>&nbsp;</div></li><li><div>          $run_freemius = TRUE;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_option( 'ngg_run_freemius', $run_freemius );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Compare both bool or string 0/1 because get_option() may give us either</span>&nbsp;</div></li><li><div>      } else if ( ( is_bool( $ngg_run_freemius ) && $ngg_run_freemius ) || '1' === $ngg_run_freemius ) {&nbsp;</div></li><li><div>          <span class="comment">// If runFreemius was set, use the value.</span>&nbsp;</div></li><li><div>          $run_freemius = $ngg_run_freemius;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Don't run Freemius for plugin updates.</span>&nbsp;</div></li><li><div>          $run_freemius = false;&nbsp;</div></li><li><div>      if (is_null($ngg_run_freemius))&nbsp;</div></li><li><div>          update_option('ngg_run_freemius', FALSE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $run_freemius ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $ngg_fs ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Include Freemius SDK.</span>&nbsp;</div></li><li><div>      require_once dirname( __FILE__ ) . '/freemius/start.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $ngg_fs = fs_dynamic_init( array(&nbsp;</div></li><li><div>          'id' =&gt; '266', &nbsp;</div></li><li><div>          'slug' =&gt; 'nextgen-gallery', &nbsp;</div></li><li><div>          'public_key' =&gt; 'pk_009356711cd548837f074e1ef60a4', &nbsp;</div></li><li><div>          'is_premium' =&gt; false, &nbsp;</div></li><li><div>          'has_addons' =&gt; false, &nbsp;</div></li><li><div>          'has_paid_plans' =&gt; false, &nbsp;</div></li><li><div>          'menu' =&gt; array(&nbsp;</div></li><li><div>              'slug' =&gt; 'nextgen-gallery', &nbsp;</div></li><li><div>              'account' =&gt; false, &nbsp;</div></li><li><div>              'contact' =&gt; false, &nbsp;</div></li><li><div>              'support' =&gt; false, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'permissions' =&gt; array(&nbsp;</div></li><li><div>              'newsletter' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">  // Optional button override.</span>&nbsp;</div></li><li><div><span class="comment">  if ( function_exists( 'fs_override_i18n' ) ) {</span>&nbsp;</div></li><li><div><span class="comment">      fs_override_i18n( array(</span>&nbsp;</div></li><li><div><span class="comment">          'opt-in-connect' =&gt; __('OK - I\'m in!', 'nggallery'), </span>&nbsp;</div></li><li><div><span class="comment"> ), 'nextgen-gallery' );</span>&nbsp;</div></li><li><div><span class="comment">  }</span>&nbsp;</div></li><li><div><span class="comment">  */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Hook to the custom message filter.</span>&nbsp;</div></li><li><div>  $ngg_fs-&gt;add_filter( 'connect_message', 'ngg_fs_custom_connect_message', 10, 6 );&nbsp;</div></li><li><div>  $ngg_fs-&gt;add_action( 'after_uninstall', 'ngg_fs_uninstall' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Hook to new gallery creation event.</span>&nbsp;</div></li><li><div>  add_action( 'ngg_created_new_gallery', 'fs_track_new_gallery' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $ngg_fs;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Init Freemius.</span>&nbsp;</div></li><li><div>ngg_fs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>#endregion Freemius&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>new C_NextGEN_Bootstrap();&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>NextGEN Gallery</li><li><span></span>2.2.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>