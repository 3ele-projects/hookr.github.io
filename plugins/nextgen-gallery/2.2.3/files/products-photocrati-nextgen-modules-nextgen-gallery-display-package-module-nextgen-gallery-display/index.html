<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.2.3" data-slug="nextgen-gallery" data-type="file" data-id="65580"><head xmlns="http://www.w3.org/1999/xhtml"><title> products-photocrati-nextgen-modules-nextgen-gallery-display-package-module-nextgen-gallery-display | file | Nextgen Gallery | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, nextgen-gallery, 2.2.3" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.25"}};!function(e,n,t){var a;function i(e){var t=n.createElement("canvas"),a=t.getContext&&t.getContext("2d"),i=String.fromCharCode;return!(!a||!a.fillText)&&(a.textBaseline="top",a.font="600 32px Arial","flag"===e?(a.fillText(i(55356,56806,55356,56826),0,0),3e3<t.toDataURL().length):"diversity"===e?(a.fillText(i(55356,57221),0,0),t=a.getImageData(16,16,1,1).data,a.fillText(i(55356,57221,55356,57343),0,0),(t=a.getImageData(16,16,1,1).data)[0],t[1],t[2],t[3],!0):("simple"===e?a.fillText(i(55357,56835),0,0):a.fillText(i(55356,57135),0,0),0!==a.getImageData(16,16,1,1).data[0]))}function o(e){var t=n.createElement("script");t.src=e,t.type="text/javascript",n.getElementsByTagName("head")[0].appendChild(t)}t.supports={simple:i("simple"),flag:i("flag"),unicode8:i("unicode8"),diversity:i("diversity")},t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.simple&&t.supports.flag&&t.supports.unicode8&&t.supports.diversity||(a=function(){t.readyCallback()},n.addEventListener?(n.addEventListener("DOMContentLoaded",a,!1),e.addEventListener("load",a,!1)):(e.attachEvent("onload",a),n.attachEvent("onreadystatechange",function(){"complete"===n.readyState&&t.readyCallback()})),(a=t.source||{}).concatemoji?o(a.concatemoji):a.wpemoji&&a.twemoji&&(o(a.twemoji),o(a.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d0a0e3f86361439e8928f83b196feaa2' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.25' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/products-photocrati-nextgen-modules-nextgen-gallery-display-package-module-nextgen-gallery-display/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fproducts-photocrati-nextgen-modules-nextgen-gallery-display-package-module-nextgen-gallery-display%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fproducts-photocrati-nextgen-modules-nextgen-gallery-display-package-module-nextgen-gallery-display%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-nextgen-gallery-2.2.3-file-products-photocrati-nextgen-modules-nextgen-gallery-display-package-module-nextgen-gallery-display","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="products-photocrati-nextgen-modules-nextgen-gallery-display-package-module-nextgen-gallery-display" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to nextgen-gallery." href="http://hookr.io/plugins/nextgen-gallery/" class="plugin"><span property="name">nextgen-gallery</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.2.3." href="http://hookr.io/plugins/nextgen-gallery/2.2.3/" class="H_VERSION"><span property="name">2.2.3</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/nextgen-gallery/2.2.3/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">products-photocrati-nextgen-m&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="783"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/all/" title="All">All <span class="count badge">783</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="157"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/hooks/" title="Hooks">Hooks <span class="count badge">157</span></a></li><li class="" data-id="action" data-count="48"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/actions/" title="Actions">Actions <span class="count badge">48</span></a></li><li class="" data-id="filter" data-count="109"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/filters/" title="Filters">Filters <span class="count badge">109</span></a></li><li class="" data-id="class" data-count="374"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/classes/" title="Classes">Classes <span class="count badge">374</span></a></li><li class="" data-id="constant" data-count="172"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/constants/" title="Constants">Constants <span class="count badge">172</span></a></li><li class="" data-id="function" data-count="79"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/functions/" title="Functions">Functions <span class="count badge">79</span></a></li><li class="" data-id="shortcode" data-count="1"><a href="http://hookr.io/plugins/nextgen-gallery/2.2.3/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">1</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/products/photocrati_nextgen/modules/nextgen_gallery_display/package.module.nextgen_gallery_display.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_Display_Settings_Controller</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_NextGen_Admin_Page_Controller</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_NextGen_Admin_Page using &quot;ngg_display_settings&quot; context</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Display_Settings_Controller extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Static resources required for the Display Settings page</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function enqueue_backend_resources()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;call_parent('enqueue_backend_resources');&nbsp;</div></li><li><div>      wp_enqueue_style('nextgen_gallery_display_settings');&nbsp;</div></li><li><div>      wp_enqueue_script('nextgen_gallery_display_settings');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_page_title()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return __('Gallery Settings', 'nggallery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_required_permission()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return 'NextGEN Change options';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_Display_Settings_Page</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_Page_Manager</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_Page_Manager</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Display_Settings_Page extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function setup()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;object-&gt;add(NGG_DISPLAY_SETTINGS_SLUG, array('adapter' =&gt; 'A_Display_Settings_Controller', 'parent' =&gt; NGGFOLDER, 'before' =&gt; 'ngg_other_options'));&nbsp;</div></li><li><div>      return $this-&gt;call_parent('setup');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_Displayed_Gallery_Trigger_Element</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_MVC_View</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_MVC_View</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Displayed_Gallery_Trigger_Element extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function render_object()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $root_element = $this-&gt;call_parent('render_object');&nbsp;</div></li><li><div>      if (($displayed_gallery = $this-&gt;object-&gt;get_param('displayed_gallery')) && $this-&gt;object-&gt;get_param('display_type_rendering')) {&nbsp;</div></li><li><div>          $triggers = C_Displayed_Gallery_Trigger_Manager::get_instance();&nbsp;</div></li><li><div>          $triggers-&gt;render($root_element, $displayed_gallery);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $root_element;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_Displayed_Gallery_Trigger_Resources</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_Display_Type_Controller</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_Display_Type_Controller</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Displayed_Gallery_Trigger_Resources extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  protected $run_once = FALSE;&nbsp;</div></li><li><div>  function enqueue_frontend_resources($displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;call_parent('enqueue_frontend_resources', $displayed_gallery);&nbsp;</div></li><li><div>      return $this-&gt;enqueue_displayed_gallery_trigger_buttons_resources($displayed_gallery);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function enqueue_displayed_gallery_trigger_buttons_resources($displayed_gallery = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      M_Gallery_Display::enqueue_fontawesome();&nbsp;</div></li><li><div>      if (!$this-&gt;run_once && !empty($displayed_gallery) && !empty($displayed_gallery-&gt;display_settings['ngg_triggers_display']) && $displayed_gallery-&gt;display_settings['ngg_triggers_display'] !== 'never') {&nbsp;</div></li><li><div>          $pro_active = FALSE;&nbsp;</div></li><li><div>          if (defined('NGG_PRO_PLUGIN_VERSION')) {&nbsp;</div></li><li><div>              $pro_active = 'NGG_PRO_PLUGIN_VERSION';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (defined('NEXTGEN_GALLERY_PRO_VERSION')) {&nbsp;</div></li><li><div>              $pro_active = 'NEXTGEN_GALLERY_PRO_VERSION';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!empty($pro_active)) {&nbsp;</div></li><li><div>              $pro_active = constant($pro_active);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!is_admin() && (empty($pro_active) || version_compare($pro_active, '1.0.11') &gt;= 0)) {&nbsp;</div></li><li><div>              wp_enqueue_style('fontawesome');&nbsp;</div></li><li><div>              $retval = TRUE;&nbsp;</div></li><li><div>              $this-&gt;run_once = TRUE;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_Gallery_Display_Factory</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_Component_Factory</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_Component_Factory</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Gallery_Display_Factory extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Instantiates a Display Type</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_DataMapper $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|stdClass|C_DataMapper_Model $properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array|FALSE $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function display_type($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Display_Type($properties, $mapper, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Instantiates a Displayed Gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_DataMapper $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|stdClass|C_DataMapper_Model $properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array|FALSE $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function displayed_gallery($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return new C_Displayed_Gallery($properties, $mapper, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class A_Gallery_Display_View</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_MVC_View</span>&nbsp;</div></li><li><div><span class="comment"> * @adapts I_MVC_View</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class A_Gallery_Display_View extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check whether to render certain kinds of extra additions to the view for a displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param object $displayed_gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $template_id</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_MVC_View_Element $root_element</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $addition_type what kind of addition is being made 'layout', 'decoration', 'style', 'logic' etc.</span>&nbsp;</div></li><li><div><span class="comment">   * @return string|NULL</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _check_addition_rendering($displayed_gallery, $template_id, $root_element, $addition_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $view = $root_element-&gt;get_object();&nbsp;</div></li><li><div>      $mode = $view-&gt;get_param('render_mode');&nbsp;</div></li><li><div>      $ret = true;&nbsp;</div></li><li><div>      switch ($addition_type) {&nbsp;</div></li><li><div>          case 'layout':&nbsp;</div></li><li><div>              $ret = !in_array($mode, array('bare', 'basic'));&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'decoration':&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'style':&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'logic':&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $ret;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A Display Type is a component which renders a collection of images</span>&nbsp;</div></li><li><div><span class="comment"> * in a &quot;gallery&quot;.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Properties:</span>&nbsp;</div></li><li><div><span class="comment"> * - entity_types (gallery, album)</span>&nbsp;</div></li><li><div><span class="comment"> * - name         (nextgen_basic-thumbnails)</span>&nbsp;</div></li><li><div><span class="comment"> * - title         (NextGEN Basic Thumbnails)</span>&nbsp;</div></li><li><div><span class="comment"> * - aliases    [basic_thumbnail, basic_thumbnails]</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Display_Type_Validation</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Display_Type_Instance_Methods</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Display_Type</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Display_Type extends C_DataMapper_Model&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_mapper_interface = 'I_Display_Type_Mapper';&nbsp;</div></li><li><div>  function define($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($mapper, $properties, $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Display_Type_Validation');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Display_Type_Instance_Methods');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Display_Type');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initializes a display type with properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param FALSE|C_Display_Type_Mapper $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|stdClass|C_Display_Type $properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param FALSE|string|array $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function initialize($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// If no mapper was specified, then get the mapper</span>&nbsp;</div></li><li><div>      if (!$mapper) {&nbsp;</div></li><li><div>          $mapper = $this-&gt;get_registry()-&gt;get_utility($this-&gt;_mapper_interface);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Construct the model</span>&nbsp;</div></li><li><div>      parent::initialize($mapper, $properties);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Allows a setting to be retrieved directly, rather than through the</span>&nbsp;</div></li><li><div><span class="comment">   * settings property</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $property</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function &__get($property)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (isset($this-&gt;settings) && isset($this-&gt;settings[$property])) {&nbsp;</div></li><li><div>          $retval =& $this-&gt;settings[$property];&nbsp;</div></li><li><div>          return $retval;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return parent::__get($property);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_Display_Type_Validation extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function validation()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('entity_types');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('name');&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('title');&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;is_valid();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides methods available for class instances</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Display_Type_Instance_Methods extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Determines if this display type is compatible with a displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * source</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function is_compatible_with_source($source)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return C_Displayed_Gallery_Source_Manager::get_instance()-&gt;is_compatible($source, $this);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_order()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return NGG_DISPLAY_PRIORITY_BASE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * A Controller which displays the settings form for the display type, as</span>&nbsp;</div></li><li><div><span class="comment"> * well as the front-end display</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Display_Type_Controller</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Display_Type_Controller</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Display_Type_Controller</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Display_Type_Controller extends C_MVC_Controller&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  static $_instances = array();&nbsp;</div></li><li><div>  function define($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Display_Type_Controller');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Display_Type_Controller');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets a singleton of the mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $context</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Display_Type_Controller</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_instance($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instances[$context])) {&nbsp;</div></li><li><div>          self::$_instances[$context] = new C_Display_Type_Controller($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instances[$context];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides instance methods for the C_Display_Type_Controller class</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Display_Type_Controller extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_render_mode;&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Enqueues static resources required for lightbox effects</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $displayed_gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function enqueue_lightbox_resources($displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      C_Lightbox_Library_Manager::get_instance()-&gt;enqueue();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_cachable()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return TRUE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * This method should be overwritten by other adapters/mixins, and call</span>&nbsp;</div></li><li><div><span class="comment">   * wp_enqueue_script() / wp_enqueue_style()</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function enqueue_frontend_resources($displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// This script provides common JavaScript among all display types</span>&nbsp;</div></li><li><div>      wp_enqueue_script('ngg_common');&nbsp;</div></li><li><div>      <span class="comment">// Enqueue the display type library</span>&nbsp;</div></li><li><div>      wp_enqueue_script($displayed_gallery-&gt;display_type, $this-&gt;object-&gt;_get_js_lib_url($displayed_gallery), FALSE, NGG_SCRIPT_VERSION);&nbsp;</div></li><li><div>      <span class="comment">// Add &quot;galleries = {};&quot;</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_add_script_data('ngg_common', 'galleries', new stdClass(), TRUE, FALSE);&nbsp;</div></li><li><div>      <span class="comment">// Add &quot;galleries.gallery_1 = {};&quot;</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_add_script_data('ngg_common', 'galleries.gallery_' . $displayed_gallery-&gt;id(), (array) $displayed_gallery-&gt;get_entity(), FALSE);&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_add_script_data('ngg_common', 'galleries.gallery_' . $displayed_gallery-&gt;id() . '.wordpress_page_root', get_permalink(), FALSE);&nbsp;</div></li><li><div>      <span class="comment">// Enqueue trigger button resources</span>&nbsp;</div></li><li><div>      C_Displayed_Gallery_Trigger_Manager::get_instance()-&gt;enqueue_resources($displayed_gallery);&nbsp;</div></li><li><div>      <span class="comment">// Enqueue lightbox library</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;enqueue_lightbox_resources($displayed_gallery);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function enqueue_ngg_styles()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>      if ((!is_multisite() || is_multisite() && $settings-&gt;wpmuStyle) && $settings-&gt;activateCSS) {&nbsp;</div></li><li><div>          wp_enqueue_style('nggallery', C_NextGen_Style_Manager::get_instance()-&gt;get_selected_stylesheet_url(), FALSE, NGG_SCRIPT_VERSION);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_render_mode()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;_render_mode;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function set_render_mode($mode)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_render_mode = $mode;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Ensures that the minimum configuration of parameters are sent to a view</span>&nbsp;</div></li><li><div><span class="comment">   * @param $displayed_gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param null $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return array|null</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function prepare_display_parameters($displayed_gallery, $params = null)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($params == null) {&nbsp;</div></li><li><div>          $params = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $params['display_type_rendering'] = true;&nbsp;</div></li><li><div>      $params['displayed_gallery'] = $displayed_gallery;&nbsp;</div></li><li><div>      $params['render_mode'] = $this-&gt;object-&gt;get_render_mode();&nbsp;</div></li><li><div>      return $params;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Renders the frontend display of the display type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function index_action($displayed_gallery, $return = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;render_partial('photocrati-nextgen_gallery_display#index', array(), $return);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the url for the JavaScript library required</span>&nbsp;</div></li><li><div><span class="comment">   * @return null|string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_js_lib_url()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return NULL;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function does_lightbox_support_displayed_gallery($displayed_gallery, $lightbox = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$lightbox) {&nbsp;</div></li><li><div>          $lightbox = C_Lightbox_Library_Manager::get_instance()-&gt;get_selected();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if ($lightbox) {&nbsp;</div></li><li><div>          <span class="comment">// HANDLE COMPATIBILITY BREAK</span>&nbsp;</div></li><li><div>          <span class="comment">// In NGG 2.1.48 and earlier, lightboxes were stdClass objects, and it was assumed</span>&nbsp;</div></li><li><div>          <span class="comment">// that they only supported galleries that contained images, not albums that contained galleries.</span>&nbsp;</div></li><li><div>          <span class="comment">// After NGG 2.1.48, lightboxes are now C_NGG_Lightbox instances which have a 'is_supported()' method</span>&nbsp;</div></li><li><div>          <span class="comment">// to test if the lightbox can work with the displayed gallery settings</span>&nbsp;</div></li><li><div>          if (get_class($lightbox) == 'stdClass') {&nbsp;</div></li><li><div>              $retval = !in_array($displayed_gallery-&gt;source, array('album', 'albums'));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $retval = $lightbox-&gt;is_supported($displayed_gallery);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the effect HTML code for the displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $displayed_gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_effect_code($displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = '';&nbsp;</div></li><li><div>      if ($lightbox = C_Lightbox_Library_Manager::get_instance()-&gt;get_selected()) {&nbsp;</div></li><li><div>          if ($this-&gt;does_lightbox_support_displayed_gallery($displayed_gallery, $lightbox)) {&nbsp;</div></li><li><div>              $retval = $lightbox-&gt;code;&nbsp;</div></li><li><div>              $retval = str_replace('%GALLERY_ID%', $displayed_gallery-&gt;id(), $retval);&nbsp;</div></li><li><div>              $retval = str_replace('%GALLERY_NAME%', $displayed_gallery-&gt;id(), $retval);&nbsp;</div></li><li><div>              global $post;&nbsp;</div></li><li><div>              if ($post && isset($post-&gt;ID) && $post-&gt;ID) {&nbsp;</div></li><li><div>                  $retval = str_replace('%PAGE_ID%', $post-&gt;ID, $retval);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// allow for customization</span>&nbsp;</div></li><li><div>      $retval = apply_filters('ngg_effect_code', $retval, $displayed_gallery);&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds data to the DOM which is then accessible by a script</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $handle</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $object_name</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $object_value</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $define</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _add_script_data($handle, $object_name, $object_value, $define = TRUE, $override = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// wp_localize_script allows you to add data to the DOM, associated</span>&nbsp;</div></li><li><div>      <span class="comment">// with a particular script. You can even call wp_localize_script</span>&nbsp;</div></li><li><div>      <span class="comment">// multiple times to add multiple objects to the DOM. However, there</span>&nbsp;</div></li><li><div>      <span class="comment">// are a few problems with wp_localize_script:</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      // - If you call it with the same object_name more than once, you're</span>&nbsp;</div></li><li><div>      <span class="comment">//   overwritting the first call.</span>&nbsp;</div></li><li><div>      <span class="comment">// - You cannot namespace your objects due to the &quot;var&quot; keyword always</span>&nbsp;</div></li><li><div>      <span class="comment">// - being used.</span>&nbsp;</div></li><li><div>      <span class="comment">//</span>&nbsp;</div></li><li><div><span class="comment">      // To circumvent the above issues, we're going to use the WP_Scripts</span>&nbsp;</div></li><li><div>      <span class="comment">// object to workaround the above issues</span>&nbsp;</div></li><li><div>      global $wp_scripts;&nbsp;</div></li><li><div>      <span class="comment">// Has the script been registered or enqueued yet?</span>&nbsp;</div></li><li><div>      if (isset($wp_scripts-&gt;registered[$handle])) {&nbsp;</div></li><li><div>          <span class="comment">// Get the associated data with this script</span>&nbsp;</div></li><li><div>          $script =& $wp_scripts-&gt;registered[$handle];&nbsp;</div></li><li><div>          $data = isset($script-&gt;extra['data']) ? $script-&gt;extra['data'] : '';&nbsp;</div></li><li><div>          <span class="comment">// Construct the addition</span>&nbsp;</div></li><li><div>          $addition = $define ? &quot;\nvar {$object_name} = &quot; . json_encode($object_value) . ';' : &quot;\n{$object_name} = &quot; . json_encode($object_value) . ';';&nbsp;</div></li><li><div>          <span class="comment">// Add the addition</span>&nbsp;</div></li><li><div>          if ($override) {&nbsp;</div></li><li><div>              $data .= $addition;&nbsp;</div></li><li><div>              $retval = TRUE;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if (strpos($data, $object_name) === FALSE) {&nbsp;</div></li><li><div>                  $data .= $addition;&nbsp;</div></li><li><div>                  $retval = TRUE;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $script-&gt;extra['data'] = $data;&nbsp;</div></li><li><div>          unset($script);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Returns the longest and widest dimensions from a list of entities</span>&nbsp;</div></li><li><div>  function get_entity_statistics($entities, $named_size, $style_images = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $longest = $widest = 0;&nbsp;</div></li><li><div>      $storage = C_Gallery_Storage::get_instance();&nbsp;</div></li><li><div>      $image_mapper = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// we'll fetch this if needed</span>&nbsp;</div></li><li><div>      <span class="comment">// Calculate longest and</span>&nbsp;</div></li><li><div>      foreach ($entities as $entity) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Get the image</span></span>&nbsp;</div></li><li><div>          $image = FALSE;&nbsp;</div></li><li><div>          if (isset($entity-&gt;pid)) {&nbsp;</div></li><li><div>              $image = $entity;&nbsp;</div></li><li><div>          } elseif (isset($entity-&gt;previewpic)) {&nbsp;</div></li><li><div>              if (!$image_mapper) {&nbsp;</div></li><li><div>                  $image_mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $image = $image_mapper-&gt;find($entity-&gt;previewpic);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Once we have the image, get it's dimensions</span>&nbsp;</div></li><li><div>          if ($image) {&nbsp;</div></li><li><div>              $dimensions = $storage-&gt;get_image_dimensions($image, $named_size);&nbsp;</div></li><li><div>              if ($dimensions['width'] &gt; $widest) {&nbsp;</div></li><li><div>                  $widest = $dimensions['width'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              if ($dimensions['height'] &gt; $longest) {&nbsp;</div></li><li><div>                  $longest = $dimensions['height'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Second loop to style images</span>&nbsp;</div></li><li><div>      if ($style_images) {&nbsp;</div></li><li><div>          foreach ($entities as &$entity) {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// Get the image</span></span>&nbsp;</div></li><li><div>              $image = FALSE;&nbsp;</div></li><li><div>              if (isset($entity-&gt;pid)) {&nbsp;</div></li><li><div>                  $image = $entity;&nbsp;</div></li><li><div>              } elseif (isset($entity-&gt;previewpic)) {&nbsp;</div></li><li><div>                  if (!$image_mapper) {&nbsp;</div></li><li><div>                      $image_mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $image = $image_mapper-&gt;find($entity-&gt;previewpic);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              <span class="comment">// Once we have the image, get it's dimension and calculate margins</span>&nbsp;</div></li><li><div>              if ($image) {&nbsp;</div></li><li><div>                  $dimensions = $storage-&gt;get_image_dimensions($image, $named_size);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array('entities' =&gt; $entities, 'longest' =&gt; $longest, 'widest' =&gt; $widest);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Renders a view after checking for templates</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function create_view($template, $params = array(), $context = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (isset($params['displayed_gallery'])) {&nbsp;</div></li><li><div>          if (isset($params['displayed_gallery']-&gt;display_settings)) {&nbsp;</div></li><li><div>              if (isset($params['displayed_gallery']-&gt;display_settings['display_type_view'])) {&nbsp;</div></li><li><div>                  if ('default' !== $params['displayed_gallery']-&gt;display_settings['display_type_view']) {&nbsp;</div></li><li><div>                      $template = $this-&gt;get_display_type_view_abspath($template, $params);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;call_parent('create_view', $template, $params, $context);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Finds the abs path of template given file name and list of posssible directories</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $template</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params</span>&nbsp;</div></li><li><div><span class="comment">   * @return string $template </span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_display_type_view_abspath($template, $params)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">/** Identify display type and display_type_view */</span>&nbsp;</div></li><li><div>      $display_type_name = $params['displayed_gallery']-&gt;display_type;&nbsp;</div></li><li><div>      $display_type_view = $params['displayed_gallery']-&gt;display_settings['display_type_view'];&nbsp;</div></li><li><div>      <span class="comment">/** Fetch array of template directories */</span>&nbsp;</div></li><li><div>      $dirs = M_Gallery_Display::get_display_type_view_dirs($display_type_name);&nbsp;</div></li><li><div>      <span class="comment">/** Set abspath for template based on directory placeholder in display_type_view */</span>&nbsp;</div></li><li><div>      $path = pathinfo($display_type_view);&nbsp;</div></li><li><div>      if ($path['dirname'] == &quot;.&quot;) {&nbsp;</div></li><li><div>          $template = $dirs['default'] . DIRECTORY_SEPARATOR . $path['basename'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          foreach ($dirs as $dir_name =&gt; $dir) {&nbsp;</div></li><li><div>              if ($path['dirname'] == $dir_name) {&nbsp;</div></li><li><div>                  $template = $dir . DIRECTORY_SEPARATOR . $path['basename'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">/** Return template. If no match is found, returns the original template */</span>&nbsp;</div></li><li><div>      return $template;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides a datamapper to perform CRUD operations for Display Types</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Display_Type_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Display_Type_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Display_Type_Mapper extends C_CustomPost_DataMapper_Driver&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  public static $_instances = array();&nbsp;</div></li><li><div>  function define($context = FALSE, $not_used = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $object_name = 'display_type';&nbsp;</div></li><li><div>      <span class="comment">// Add the object name to the context of the object as well</span>&nbsp;</div></li><li><div>      <span class="comment">// This allows us to adapt the driver itself, if required</span>&nbsp;</div></li><li><div>      if (!is_array($context)) {&nbsp;</div></li><li><div>          $context = array($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      array_push($context, $object_name);&nbsp;</div></li><li><div>      parent::define($object_name, $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Display_Type_Mapper');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Display_Type_Mapper');&nbsp;</div></li><li><div>      $this-&gt;set_model_factory_method($object_name);&nbsp;</div></li><li><div>      <span class="comment">// Define columns</span>&nbsp;</div></li><li><div>      $this-&gt;define_column('ID', 'BIGINT', 0);&nbsp;</div></li><li><div>      $this-&gt;define_column('name', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('title', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('preview_image_relpath', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('default_source', 'VARCHAR(255)');&nbsp;</div></li><li><div>      $this-&gt;define_column('view_order', 'BIGINT', NGG_DISPLAY_PRIORITY_BASE);&nbsp;</div></li><li><div>      $this-&gt;add_serialized_column('settings');&nbsp;</div></li><li><div>      $this-&gt;add_serialized_column('entity_types');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function initialize($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::initialize('display_type');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets a singleton of the mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $context</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Display_Type_Mapper</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_instance($context = False)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instances[$context])) {&nbsp;</div></li><li><div>          self::$_instances[$context] = new C_Display_Type_Mapper($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instances[$context];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides instance methods for the display type mapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Display_Type_Mapper extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Locates a Display Type by names</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function find_by_name($name, $model = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      $this-&gt;object-&gt;select();&nbsp;</div></li><li><div>      $this-&gt;object-&gt;where(array('name = %s', $name));&nbsp;</div></li><li><div>      $results = $this-&gt;object-&gt;run_query(FALSE, $model);&nbsp;</div></li><li><div>      if (!$results) {&nbsp;</div></li><li><div>          foreach ($this-&gt;object-&gt;find_all(FALSE, $model) as $entity) {&nbsp;</div></li><li><div>              if ($entity-&gt;name == $name || isset($entity-&gt;aliases) && is_array($entity-&gt;aliases) && in_array($name, $entity-&gt;aliases)) {&nbsp;</div></li><li><div>                  $retval = $entity;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $retval = $results[0];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Finds display types used to display specific types of entities</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $entity_type e.g. image, gallery, album</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function find_by_entity_type($entity_type, $model = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $find_entity_types = is_array($entity_type) ? $entity_type : array($entity_type);&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      foreach ($this-&gt;object-&gt;find_all(FALSE, $model) as $display_type) {&nbsp;</div></li><li><div>          foreach ($find_entity_types as $entity_type) {&nbsp;</div></li><li><div>              if (isset($display_type-&gt;entity_types) && in_array($entity_type, $display_type-&gt;entity_types)) {&nbsp;</div></li><li><div>                  $retval[] = $display_type;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Uses the title attribute as the post title</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass $entity</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_post_title($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $entity-&gt;title;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets default values needed for display types</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function set_defaults($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset($entity-&gt;settings)) {&nbsp;</div></li><li><div>          $entity-&gt;settings = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'preview_image_relpath', '');&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'default_source', '');&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'view_order', NGG_DISPLAY_PRIORITY_BASE);&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'settings', 'use_lightbox_effect', TRUE);&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'hidden_from_ui', FALSE);&nbsp;</div></li><li><div>      <span class="comment">// todo remove later</span>&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'hidden_from_igw', FALSE);&nbsp;</div></li><li><div>      $this-&gt;_set_default_value($entity, 'aliases', array());&nbsp;</div></li><li><div>      return $this-&gt;call_parent('set_defaults', $entity);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Associates a Display Type with a collection of images</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * * Properties:</span>&nbsp;</div></li><li><div><span class="comment"> * - source                (gallery, album, recent_images, random_images, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * - container_ids        (gallery ids, album ids, tag ids, etc)</span>&nbsp;</div></li><li><div><span class="comment"> * - display_type        (name of the display type being used)</span>&nbsp;</div></li><li><div><span class="comment"> * - display_settings    (settings for the display type)</span>&nbsp;</div></li><li><div><span class="comment"> * - exclusions            (excluded entity ids)</span>&nbsp;</div></li><li><div><span class="comment"> * - entity_ids            (specific images/galleries to include, sorted)</span>&nbsp;</div></li><li><div><span class="comment"> * - order_by</span>&nbsp;</div></li><li><div><span class="comment"> * - order_direction</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Displayed_Gallery_Validation</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Displayed_Gallery_Instance_Methods</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Displayed_Gallery_Queries</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Displayed_Gallery</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Displayed_Gallery extends C_DataMapper_Model&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_mapper_interface = 'I_Displayed_Gallery_Mapper';&nbsp;</div></li><li><div>  function define($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($mapper, $properties, $context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Displayed_Gallery_Validation');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Displayed_Gallery_Instance_Methods');&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Displayed_Gallery_Queries');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Displayed_Gallery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initializes a display type with properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param FALSE|C_Displayed_Gallery_Mapper $mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param array|stdClass|C_Displayed_Gallery $properties</span>&nbsp;</div></li><li><div><span class="comment">   * @param FALSE|string|array $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function initialize($properties = array(), $mapper = FALSE, $context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$mapper) {&nbsp;</div></li><li><div>          $mapper = $this-&gt;get_registry()-&gt;get_utility($this-&gt;_mapper_interface);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      parent::initialize($mapper, $properties);&nbsp;</div></li><li><div>      $this-&gt;select_random_variation();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides validation</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Displayed_Gallery_Validation extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function validation()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Valid sources</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('source');&nbsp;</div></li><li><div>      <span class="comment">// Valid display type?</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;validates_presence_of('display_type');&nbsp;</div></li><li><div>      if ($display_type = $this-&gt;object-&gt;get_display_type()) {&nbsp;</div></li><li><div>          foreach ($this-&gt;object-&gt;display_settings as $key =&gt; $val) {&nbsp;</div></li><li><div>              $display_type-&gt;settings[$key] = $val;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;object-&gt;display_settings = $display_type-&gt;settings;&nbsp;</div></li><li><div>          if (!$display_type-&gt;validate()) {&nbsp;</div></li><li><div>              foreach ($display_type-&gt;get_errors() as $property =&gt; $errors) {&nbsp;</div></li><li><div>                  foreach ($errors as $error) {&nbsp;</div></li><li><div>                      $this-&gt;object-&gt;add_error($error, $property);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;object-&gt;display_type = $display_type-&gt;name;&nbsp;</div></li><li><div>          <span class="comment">// Is the display type compatible with the source? E.g., if we're</span>&nbsp;</div></li><li><div>          <span class="comment">// using a display type that expects images, we can't be feeding it</span>&nbsp;</div></li><li><div>          <span class="comment">// galleries and albums</span>&nbsp;</div></li><li><div>          if ($source = $this-&gt;object-&gt;get_source()) {&nbsp;</div></li><li><div>              if (!$display_type-&gt;is_compatible_with_source($source)) {&nbsp;</div></li><li><div>                  $this-&gt;object-&gt;add_error(__('Source not compatible with selected display type', 'nggallery'), 'display_type');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Allow ONLY recent & random galleries to have their own maximum_entity_count</span>&nbsp;</div></li><li><div>          if (!empty($this-&gt;object-&gt;display_settings['maximum_entity_count']) && in_array($this-&gt;object-&gt;source, array('random_images', 'recent_images', 'random', 'recent'))) {&nbsp;</div></li><li><div>              $this-&gt;object-&gt;maximum_entity_count = $this-&gt;object-&gt;display_settings['maximum_entity_count'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// If no maximum_entity_count has been given, then set a maximum</span>&nbsp;</div></li><li><div>          if (!isset($this-&gt;object-&gt;maximum_entity_count)) {&nbsp;</div></li><li><div>              $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>              $this-&gt;object-&gt;maximum_entity_count = $settings-&gt;get('maximum_entity_count', 500);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;add_error('Invalid display type', 'display_type');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;is_valid();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class Mixin_Displayed_Gallery_Queries extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function select_random_variation()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      $source_obj = $this-&gt;object-&gt;get_source();&nbsp;</div></li><li><div>      if ($source_obj && $source_obj-&gt;has_variations) {&nbsp;</div></li><li><div>          $max = 0;&nbsp;</div></li><li><div>          if (!defined('NGG_MAX_VARIATIONS')) {&nbsp;</div></li><li><div>              $settings = C_Photocrati_Global_Settings_Manager::get_instance();&nbsp;</div></li><li><div>              $max = $settings-&gt;get('max_variations', 5);&nbsp;</div></li><li><div>              define('NGG_MAX_VARIATIONS', $max);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $max = NGG_MAX_VARIATIONS;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;object-&gt;variation = floor(rand(1, $max));&nbsp;</div></li><li><div>          $retval = $this-&gt;object-&gt;variation;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_entities($limit = FALSE, $offset = FALSE, $id_only = FALSE, $returns = 'included')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      $source_obj = $this-&gt;object-&gt;get_source();&nbsp;</div></li><li><div>      $max = $this-&gt;object-&gt;get_maximum_entity_count();&nbsp;</div></li><li><div>      if (!$limit || is_numeric($limit) && $limit &gt; $max) {&nbsp;</div></li><li><div>          $limit = $max;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Ensure that all parameters have values that are expected</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;_parse_parameters()) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Is this an image query?</span></span>&nbsp;</div></li><li><div>          if (in_array('image', $source_obj-&gt;returns)) {&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;_get_image_entities($source_obj, $limit, $offset, $id_only, $returns);&nbsp;</div></li><li><div>          } elseif (in_array('gallery', $source_obj-&gt;returns)) {&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;_get_album_and_gallery_entities($source_obj, $limit, $offset, $id_only, $returns);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets all images in the displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass $source_obj</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $limit</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $id_only</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $returns</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_image_entities($source_obj, $limit, $offset, $id_only, $returns)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// TODO: This method is very long, and therefore more difficult to read</span>&nbsp;</div></li><li><div>      <span class="comment">// Find a way to minimalize or segment</span>&nbsp;</div></li><li><div>      $mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>      $image_key = $mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $select = $id_only ? $image_key : $mapper-&gt;get_table_name() . '.*';&nbsp;</div></li><li><div>      $sort_direction = $this-&gt;object-&gt;order_direction;&nbsp;</div></li><li><div>      $sort_by = $this-&gt;object-&gt;order_by;&nbsp;</div></li><li><div>      <span class="comment">// Here's what this method is doing:</span>&nbsp;</div></li><li><div>      <span class="comment">// 1) Determines what results need returned</span>&nbsp;</div></li><li><div>      <span class="comment">// 2) Determines from what container ids the results should come from</span>&nbsp;</div></li><li><div>      <span class="comment">// 3) Applies ORDER BY clause</span>&nbsp;</div></li><li><div>      <span class="comment">// 4) Applies LIMIT/OFFSET clause</span>&nbsp;</div></li><li><div>      <span class="comment">// 5) Executes the query and returns the result</span>&nbsp;</div></li><li><div>      <span class="comment">// We start with the most difficult query. When returns is &quot;both&quot;, we</span>&nbsp;</div></li><li><div>      <span class="comment">// need to return a list of both included and excluded entity ids, and</span>&nbsp;</div></li><li><div>      <span class="comment">// mark specifically which entities are excluded</span>&nbsp;</div></li><li><div>      if ($returns == 'both') {&nbsp;</div></li><li><div>          <span class="comment">// We need to add two dynamic columns, one called &quot;sortorder&quot; and</span>&nbsp;</div></li><li><div>          <span class="comment">// the other called &quot;exclude&quot;.</span>&nbsp;</div></li><li><div>          $if_true = 1;&nbsp;</div></li><li><div>          $if_false = 0;&nbsp;</div></li><li><div>          $excluded_set = $this-&gt;object-&gt;entity_ids;&nbsp;</div></li><li><div>          if (!$excluded_set) {&nbsp;</div></li><li><div>              $if_true = 0;&nbsp;</div></li><li><div>              $if_false = 1;&nbsp;</div></li><li><div>              $excluded_set = $this-&gt;object-&gt;exclusions;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $sortorder_set = $this-&gt;object-&gt;sortorder ? $this-&gt;object-&gt;sortorder : $excluded_set;&nbsp;</div></li><li><div>          <span class="comment">// Add sortorder column</span>&nbsp;</div></li><li><div>          if ($sortorder_set) {&nbsp;</div></li><li><div>              $select = $this-&gt;object-&gt;_add_find_in_set_column($select, $image_key, $sortorder_set, 'new_sortorder', TRUE);&nbsp;</div></li><li><div>              <span class="comment">// A user might want to sort the results by the order of</span>&nbsp;</div></li><li><div>              <span class="comment">// images that they specified to be included. For that, </span>&nbsp;</div></li><li><div>              <span class="comment">// we need some trickery by reversing the order direction</span>&nbsp;</div></li><li><div>              $sort_direction = $this-&gt;object-&gt;order_direction == 'ASC' ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>              $sort_by = 'new_sortorder';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Add exclude column</span>&nbsp;</div></li><li><div>          if ($excluded_set) {&nbsp;</div></li><li><div>              $select = $this-&gt;object-&gt;_add_find_in_set_column($select, $image_key, $excluded_set, 'exclude');&nbsp;</div></li><li><div>              $select .= &quot;, IF (exclude = 0 AND @exclude = 0, {$if_true}, {$if_false}) AS 'exclude'&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Select what we want</span>&nbsp;</div></li><li><div>          $mapper-&gt;select($select);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// When returns is &quot;included&quot;, the query is relatively simple. We</span>&nbsp;</div></li><li><div>      <span class="comment">// just provide a where clause to limit how many images we're returning</span>&nbsp;</div></li><li><div>      <span class="comment">// based on the entity_ids, exclusions, and container_ids parameters</span>&nbsp;</div></li><li><div>      if ($returns == 'included') {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// If the sortorder propery is available, then we need to override</span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// the sortorder</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;sortorder) {&nbsp;</div></li><li><div>              $select = $this-&gt;object-&gt;_add_find_in_set_column($select, $image_key, $this-&gt;object-&gt;sortorder, 'new_sortorder', TRUE);&nbsp;</div></li><li><div>              $sort_direction = $this-&gt;object-&gt;order_direction == 'ASC' ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>              $sort_by = 'new_sortorder';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $mapper-&gt;select($select);&nbsp;</div></li><li><div>          <span class="comment">// Filter based on entity_ids selection</span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;entity_ids) {&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;{$image_key} IN %s&quot;, $this-&gt;object-&gt;entity_ids));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Filter based on exclusions selection</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;exclusions) {&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;{$image_key} NOT IN %s&quot;, $this-&gt;object-&gt;exclusions));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Ensure that no images marked as excluded at the gallery level are returned</span>&nbsp;</div></li><li><div>          if (empty($this-&gt;object-&gt;skip_excluding_globally_excluded_images)) {&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;exclude = %d&quot;, 0));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } elseif ($returns == 'excluded') {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// If the sortorder propery is available, then we need to override</span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// the sortorder</span></span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;sortorder) {&nbsp;</div></li><li><div>              $select = $this-&gt;object-&gt;_add_find_in_set_column($select, $image_key, $this-&gt;object-&gt;sortorder, 'new_sortorder', TRUE);&nbsp;</div></li><li><div>              $sort_direction = $this-&gt;object-&gt;order_direction == 'ASC' ? 'DESC' : 'ASC';&nbsp;</div></li><li><div>              $sort_by = 'new_sortorder';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Mark each result as excluded</span>&nbsp;</div></li><li><div>          $select .= &quot;, 1 AS exclude&quot;;&nbsp;</div></li><li><div>          $mapper-&gt;select($select);&nbsp;</div></li><li><div>          <span class="comment">// Is this case, entity_ids become the exclusions</span>&nbsp;</div></li><li><div>          $exclusions = $this-&gt;object-&gt;entity_ids;&nbsp;</div></li><li><div>          <span class="comment">// Remove the exclusions always takes precedence over entity_ids, so</span>&nbsp;</div></li><li><div>          <span class="comment">// we adjust the list of ids</span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;exclusions) {&nbsp;</div></li><li><div>              foreach ($this-&gt;object-&gt;exclusions as $excluded_entity_id) {&nbsp;</div></li><li><div>                  if (($index = array_search($excluded_entity_id, $exclusions)) !== FALSE) {&nbsp;</div></li><li><div>                      unset($exclusions[$index]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Filter based on exclusions selection</span></span>&nbsp;</div></li><li><div>          if ($exclusions) {&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;{$image_key} NOT IN %s&quot;, $exclusions));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if ($this-&gt;object-&gt;exclusions) {&nbsp;</div></li><li><div>                  $mapper-&gt;where(array(&quot;{$image_key} IN %s&quot;, $this-&gt;object-&gt;exclusions));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Ensure that images marked as excluded are returned as well</span>&nbsp;</div></li><li><div>          $mapper-&gt;where(array(&quot;exclude = 1&quot;));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Filter based on containers_ids. Container ids is a little more</span>&nbsp;</div></li><li><div>      <span class="comment">// complicated as it can contain gallery ids or tags</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;container_ids) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Container ids are tags</span></span>&nbsp;</div></li><li><div>          if ($source_obj-&gt;name == 'tags') {&nbsp;</div></li><li><div>              $term_ids = $this-&gt;object-&gt;get_term_ids_for_tags($this-&gt;object-&gt;container_ids);&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;{$image_key} IN %s&quot;, get_objects_in_term($term_ids, 'ngg_tag')));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;galleryid IN %s&quot;, $this-&gt;object-&gt;container_ids));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Filter based on excluded container ids</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;excluded_container_ids) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Container ids are tags</span></span>&nbsp;</div></li><li><div>          if ($source_obj-&gt;name == 'tags') {&nbsp;</div></li><li><div>              $term_ids = $this-&gt;object-&gt;get_term_ids_for_tags($this-&gt;object-&gt;excluded_container_ids);&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;{$image_key} NOT IN %s&quot;, get_objects_in_term($term_ids, 'ngg_tag')));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mapper-&gt;where(array(&quot;galleryid NOT IN %s&quot;, $this-&gt;object-&gt;excluded_container_ids));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Adjust the query more based on what source was selected</span>&nbsp;</div></li><li><div>      if (in_array($this-&gt;object-&gt;source, array('recent', 'recent_images'))) {&nbsp;</div></li><li><div>          $sort_direction = 'DESC';&nbsp;</div></li><li><div>          $sort_by = 'imagedate';&nbsp;</div></li><li><div>      } elseif ($this-&gt;object-&gt;source == 'random_images' && empty($this-&gt;object-&gt;entity_ids)) {&nbsp;</div></li><li><div>          $table_name = $mapper-&gt;get_table_name();&nbsp;</div></li><li><div>          $where_clauses = array();&nbsp;</div></li><li><div>          $sub_where_sql = '';&nbsp;</div></li><li><div>          foreach ($mapper-&gt;_where_clauses as $where) {&nbsp;</div></li><li><div>              $where_clauses[] = '(' . $where . ')';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ($where_clauses) {&nbsp;</div></li><li><div>              $sub_where_sql = 'WHERE ' . implode(' AND ', $where_clauses);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $mapper-&gt;_where_clauses = array(&quot; <span class="comment"><span class="comment">/*NGG_NO_EXTRAS_TABLE*/</span></span> `{$image_key}` IN (SELECT `{$image_key}` FROM (SELECT `{$image_key}` FROM `{$table_name}` i {$sub_where_sql} ORDER BY RAND() LIMIT {$this-&gt;object-&gt;maximum_entity_count}) o) <span class="comment"><span class="comment">/*NGG_NO_EXTRAS_TABLE*/</span></span>&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Apply a sorting order</span>&nbsp;</div></li><li><div>      if ($sort_by) {&nbsp;</div></li><li><div>          $mapper-&gt;order_by($sort_by, $sort_direction);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Apply a limit</span>&nbsp;</div></li><li><div>      if ($limit) {&nbsp;</div></li><li><div>          if ($offset) {&nbsp;</div></li><li><div>              $mapper-&gt;limit($limit, $offset);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $mapper-&gt;limit($limit);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $results = $mapper-&gt;run_query();&nbsp;</div></li><li><div>      return $results;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets all gallery and album entities from albums specified, if any</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass $source_obj</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $limit</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $id_only</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $returns</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _get_album_and_gallery_entities($source_obj, $limit = FALSE, $offset = FALSE, $id_only = FALSE, $returns = 'included')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Albums</span> queries and difficult and inefficient to perform due to the</span>&nbsp;</div></li><li><div>      <span class="comment">// database schema. To complicate things, we're returning two different</span>&nbsp;</div></li><li><div>      <span class="comment">// types of entities - galleries, and sub-albums.</span>&nbsp;</div></li><li><div>      <span class="comment">// The user prefixes entity_id's with an 'a' to distinguish album ids</span>&nbsp;</div></li><li><div>      <span class="comment">// from gallery ids. E.g. entity_ids=[1, &quot;a2&quot;, 3]</span>&nbsp;</div></li><li><div>      $album_mapper = C_Album_Mapper::get_instance();&nbsp;</div></li><li><div>      $album_key = $album_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $gallery_mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      $gallery_key = $gallery_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $select = $id_only ? $album_key . &quot;, sortorder&quot; : $album_mapper-&gt;get_table_name() . '.*';&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      <span class="comment">// If no exclusions are specified, are entity_ids are specified, </span>&nbsp;</div></li><li><div>      <span class="comment">// and we're to return is &quot;included&quot;, then we have a relatively easy</span>&nbsp;</div></li><li><div>      <span class="comment">// query to perform - we just fetch each entity listed in</span>&nbsp;</div></li><li><div>      <span class="comment">// the entity_ids field</span>&nbsp;</div></li><li><div>      if ($returns == 'included' && $this-&gt;object-&gt;entity_ids && empty($this-&gt;object-&gt;exclusions)) {&nbsp;</div></li><li><div>          $retval = $this-&gt;object-&gt;_entities_to_galleries_and_albums($this-&gt;object-&gt;entity_ids, $id_only, array(), $limit, $offset);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Start the query</span>&nbsp;</div></li><li><div>          $album_mapper-&gt;select($select);&nbsp;</div></li><li><div>          <span class="comment">// Fetch the albums, and find the entity ids of the sub-albums and galleries</span>&nbsp;</div></li><li><div>          $entity_ids = array();&nbsp;</div></li><li><div>          $excluded_ids = array();&nbsp;</div></li><li><div>          <span class="comment">// Filter by container ids. If container_ids === '0' we retrieve all existing gallery_ids and use</span>&nbsp;</div></li><li><div>          <span class="comment">// them as the available entity_ids for comparability with 1.9x</span>&nbsp;</div></li><li><div>          $container_ids = $this-&gt;object-&gt;container_ids;&nbsp;</div></li><li><div>          if ($container_ids) {&nbsp;</div></li><li><div>              if ($container_ids !== array('0') && $container_ids !== array('')) {&nbsp;</div></li><li><div>                  $album_mapper-&gt;where(array(&quot;{$album_key} IN %s&quot;, $container_ids));&nbsp;</div></li><li><div>                  foreach ($album_mapper-&gt;run_query() as $album) {&nbsp;</div></li><li><div>                      $entity_ids = array_merge($entity_ids, (array) $album-&gt;sortorder);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  if ($container_ids === array('0') || $container_ids === array('')) {&nbsp;</div></li><li><div>                      foreach ($gallery_mapper-&gt;select($gallery_key)-&gt;run_query() as $gallery) {&nbsp;</div></li><li><div>                          $entity_ids[] = $gallery-&gt;{$gallery_key};&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Break the list of entities into two groups, included entities</span>&nbsp;</div></li><li><div>          <span class="comment">// and excluded entity ids</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// --</span></span>&nbsp;</div></li><li><div>          <span class="comment">// If a specific list of entity ids have been specified, then</span>&nbsp;</div></li><li><div>          <span class="comment">// we know what entity ids are meant to be included. We can compute</span>&nbsp;</div></li><li><div>          <span class="comment">// the intersect and also determine what entity ids are to be</span>&nbsp;</div></li><li><div>          <span class="comment">// excluded</span>&nbsp;</div></li><li><div>          if ($this-&gt;object-&gt;entity_ids) {&nbsp;</div></li><li><div>              <span class="comment">// Determine the real list of included entity ids. Exclusions</span>&nbsp;</div></li><li><div>              <span class="comment">// always take precedence</span>&nbsp;</div></li><li><div>              $included_ids = $this-&gt;object-&gt;entity_ids;&nbsp;</div></li><li><div>              foreach ($this-&gt;object-&gt;exclusions as $excluded_id) {&nbsp;</div></li><li><div>                  if (($index = array_search($excluded_id, $included_ids)) !== FALSE) {&nbsp;</div></li><li><div>                      unset($included_ids[$index]);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $excluded_ids = array_diff($entity_ids, $included_ids);&nbsp;</div></li><li><div>          } elseif ($this-&gt;object-&gt;exclusions) {&nbsp;</div></li><li><div>              $included_ids = array_diff($entity_ids, $this-&gt;object-&gt;exclusions);&nbsp;</div></li><li><div>              $excluded_ids = array_diff($entity_ids, $included_ids);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $included_ids = $entity_ids;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// We've built our two groups. Let's determine how we'll focus on them</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// --</span></span>&nbsp;</div></li><li><div>          <span class="comment">// We're interested in only the included ids</span>&nbsp;</div></li><li><div>          if ($returns == 'included') {&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;_entities_to_galleries_and_albums($included_ids, $id_only, array(), $limit, $offset);&nbsp;</div></li><li><div>          } elseif ($returns == 'excluded') {&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;_entities_to_galleries_and_albums($excluded_ids, $id_only, $excluded_ids, $limit, $offset);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;_entities_to_galleries_and_albums($entity_ids, $id_only, $excluded_ids, $limit, $offset);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Takes a list of entities, and returns the mapped galleries and sub-albums</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $entity_ids</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $id_only</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $exclusions</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $limit</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _entities_to_galleries_and_albums($entity_ids, $id_only = FALSE, $exclusions = array(), $limit = FALSE, $offset = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      $gallery_ids = array();&nbsp;</div></li><li><div>      $album_ids = array();&nbsp;</div></li><li><div>      $album_mapper = C_Album_Mapper::get_instance();&nbsp;</div></li><li><div>      $album_key = $album_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $gallery_mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      $image_mapper = C_Image_Mapper::get_instance();&nbsp;</div></li><li><div>      $gallery_key = $gallery_mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>      $album_select = ($id_only ? $album_key : $album_mapper-&gt;get_table_name() . '.*') . &quot;, 1 AS is_album, 0 AS is_gallery, name AS title, albumdesc AS galdesc&quot;;&nbsp;</div></li><li><div>      $gallery_select = ($id_only ? $gallery_key : $gallery_mapper-&gt;get_table_name() . '.*') . &quot;, 1 AS is_gallery, 0 AS is_album&quot;;&nbsp;</div></li><li><div>      <span class="comment">// Modify the sort order of the entities</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;sortorder) {&nbsp;</div></li><li><div>          $sortorder = array_intersect($this-&gt;object-&gt;sortorder, $entity_ids);&nbsp;</div></li><li><div>          $entity_ids = array_merge($sortorder, array_diff($entity_ids, $sortorder));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Segment entity ids into two groups - galleries and albums</span>&nbsp;</div></li><li><div>      foreach ($entity_ids as $entity_id) {&nbsp;</div></li><li><div>          if (substr($entity_id, 0, 1) == 'a') {&nbsp;</div></li><li><div>              $album_ids[] = intval(substr($entity_id, 1));&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $gallery_ids[] = intval($entity_id);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Adjust query to include an exclude property</span>&nbsp;</div></li><li><div>      if ($exclusions) {&nbsp;</div></li><li><div>          $album_select = $this-&gt;object-&gt;_add_find_in_set_column($album_select, $album_key, $this-&gt;object-&gt;exclusions, 'exclude');&nbsp;</div></li><li><div>          $album_select = $this-&gt;object-&gt;_add_if_column($album_select, 'exclude', 0, 1);&nbsp;</div></li><li><div>          $gallery_select = $this-&gt;object-&gt;_add_find_in_set_column($gallery_select, $gallery_key, $this-&gt;object-&gt;exclusions, 'exclude');&nbsp;</div></li><li><div>          $gallery_select = $this-&gt;object-&gt;_add_if_column($gallery_select, 'exclude', 0, 1);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Add sorting parameter to the gallery and album queries</span>&nbsp;</div></li><li><div>      if ($gallery_ids) {&nbsp;</div></li><li><div>          $gallery_select = $this-&gt;object-&gt;_add_find_in_set_column($gallery_select, $gallery_key, $gallery_ids, 'ordered_by', TRUE);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $gallery_select .= &quot;, 0 AS ordered_by&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($album_ids) {&nbsp;</div></li><li><div>          $album_select = $this-&gt;object-&gt;_add_find_in_set_column($album_select, $album_key, $album_ids, 'ordered_by', TRUE);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $album_select .= &quot;, 0 AS ordered_by&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Fetch entities</span>&nbsp;</div></li><li><div>      $galleries = $gallery_mapper-&gt;select($gallery_select)-&gt;where(array(&quot;{$gallery_key} IN %s&quot;, $gallery_ids))-&gt;order_by('ordered_by', 'DESC')-&gt;run_query();&nbsp;</div></li><li><div>      $counts = $image_mapper-&gt;select('galleryid, COUNT(*) as counter')-&gt;where(array(array(&quot;galleryid IN %s&quot;, $gallery_ids), array('exclude = %d', 0)))-&gt;group_by('galleryid')-&gt;run_query(FALSE, FALSE, TRUE);&nbsp;</div></li><li><div>      $albums = $album_mapper-&gt;select($album_select)-&gt;where(array(&quot;{$album_key} IN %s&quot;, $album_ids))-&gt;order_by('ordered_by', 'DESC')-&gt;run_query();&nbsp;</div></li><li><div>      <span class="comment">// Reorder entities according to order specified in entity_ids</span>&nbsp;</div></li><li><div>      foreach ($entity_ids as $entity_id) {&nbsp;</div></li><li><div>          if (substr($entity_id, 0, 1) == 'a') {&nbsp;</div></li><li><div>              $album = array_shift($albums);&nbsp;</div></li><li><div>              if ($album) {&nbsp;</div></li><li><div>                  $retval[] = $album;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $gallery = array_shift($galleries);&nbsp;</div></li><li><div>              if ($gallery) {&nbsp;</div></li><li><div>                  foreach ($counts as $id =&gt; $gal_count) {&nbsp;</div></li><li><div>                      if ($gal_count-&gt;galleryid == $gallery-&gt;gid) {&nbsp;</div></li><li><div>                          $gallery-&gt;counter = intval($gal_count-&gt;counter);&nbsp;</div></li><li><div>                          unset($counts[$id]);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  $retval[] = $gallery;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Sort the entities</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;order_by && $this-&gt;object-&gt;order_by != 'sortorder') {&nbsp;</div></li><li><div>          usort($retval, array(&$this, '_sort_album_result'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;order_direction == 'DESC') {&nbsp;</div></li><li><div>          $retval = array_reverse($retval);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Limit the entities</span>&nbsp;</div></li><li><div>      if ($limit) {&nbsp;</div></li><li><div>          $retval = array_slice($retval, $offset, $limit);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the total number of entities in this displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $returns</span>&nbsp;</div></li><li><div><span class="comment">   * @returns int</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_entity_count($returns = 'included')&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = 0;&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Is this an image query?</span></span>&nbsp;</div></li><li><div>      $source_obj = $this-&gt;object-&gt;get_source();&nbsp;</div></li><li><div>      if (in_array('image', $source_obj-&gt;returns)) {&nbsp;</div></li><li><div>          $retval = count($this-&gt;object-&gt;_get_image_entities($source_obj, FALSE, FALSE, TRUE, $returns));&nbsp;</div></li><li><div>      } elseif (in_array('gallery', $source_obj-&gt;returns)) {&nbsp;</div></li><li><div>          $retval = count($this-&gt;object-&gt;_get_album_and_gallery_entities($source_obj, FALSE, FALSE, TRUE, $returns));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $max = $this-&gt;get_maximum_entity_count();&nbsp;</div></li><li><div>      if ($retval &gt; $max) {&nbsp;</div></li><li><div>          $retval = $max;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Honor the gallery 'maximum_entity_count' setting ONLY when dealing with random & recent galleries. All</span>&nbsp;</div></li><li><div>  <span class="comment">// others will always obey the *global* 'maximum_entity_count' setting.</span>&nbsp;</div></li><li><div>  function get_maximum_entity_count()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $max = intval(C_NextGen_Settings::get_instance()-&gt;get('maximum_entity_count', 500));&nbsp;</div></li><li><div>      $sources = C_Displayed_Gallery_Source_Manager::get_instance();&nbsp;</div></li><li><div>      $source_obj = $this-&gt;object-&gt;get_source();&nbsp;</div></li><li><div>      if (in_array($source_obj, array($sources-&gt;get('random'), $sources-&gt;get('random_images'), $sources-&gt;get('recent'), $sources-&gt;get('recent_images')))) {&nbsp;</div></li><li><div>          $max = intval($this-&gt;object-&gt;maximum_entity_count);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $max;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns all included entities for the displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $limit</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $offset</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $id_only</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_included_entities($limit = FALSE, $offset = FALSE, $id_only = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_entities($limit, $offset, $id_only, 'included');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Adds a FIND_IN_SET call to the select portion of the query, and</span>&nbsp;</div></li><li><div><span class="comment">   * optionally defines a dynamic column</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $select</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $key</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $array</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $alias</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $add_column</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _add_find_in_set_column($select, $key, $array, $alias, $add_column = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $array = array_map('intval', $array);&nbsp;</div></li><li><div>      $set = implode(&quot;, &quot;, array_reverse($array));&nbsp;</div></li><li><div>      if (!$select) {&nbsp;</div></li><li><div>          $select = &quot;1&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $select .= &quot;, @{$alias} := FIND_IN_SET({$key}, '{$set}')&quot;;&nbsp;</div></li><li><div>      if ($add_column) {&nbsp;</div></li><li><div>          $select .= &quot; AS {$alias}&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $select;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _add_if_column($select, $alias, $true = 1, $false = 0)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$select) {&nbsp;</div></li><li><div>          $select = &quot;1&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $select .= &quot;, IF(@{$alias} = 0, {$true}, {$false}) AS {$alias}&quot;;&nbsp;</div></li><li><div>      return $select;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Parses the list of parameters provided in the displayed gallery, and</span>&nbsp;</div></li><li><div><span class="comment">   * ensures everything meets expectations</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _parse_parameters()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $valid = FALSE;&nbsp;</div></li><li><div>      <span class="comment">// Ensure that the source is valid</span>&nbsp;</div></li><li><div>      if (C_Displayed_Gallery_Source_Manager::get_instance()-&gt;get($this-&gt;object-&gt;source)) {&nbsp;</div></li><li><div>          $valid = TRUE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Ensure that exclusions, entity_ids, and sortorder have valid elements.</span>&nbsp;</div></li><li><div>      <span class="comment">// IE likes to send empty array as an array with a single element that</span>&nbsp;</div></li><li><div>      <span class="comment">// has no value</span>&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;exclusions && !$this-&gt;object-&gt;exclusions[0]) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;exclusions = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;entity_ids && !$this-&gt;object-&gt;entity_ids[0]) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;entity_ids = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($this-&gt;object-&gt;sortorder && !$this-&gt;object-&gt;sortorder[0]) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;sortorder = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $valid;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a list of term ids for the list of tags</span>&nbsp;</div></li><li><div><span class="comment">   * @global wpdb $wpdb</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $tags</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_term_ids_for_tags($tags = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>      <span class="comment">// If no tags were provided, get them from the container_ids</span>&nbsp;</div></li><li><div>      if (!$tags || !is_array($tags)) {&nbsp;</div></li><li><div>          $tags = $this-&gt;object-&gt;container_ids;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Convert container ids to a string suitable for WHERE IN</span>&nbsp;</div></li><li><div>      $container_ids = array();&nbsp;</div></li><li><div>      if (is_array($tags) && !in_array('all', array_map('strtolower', $tags))) {&nbsp;</div></li><li><div>          foreach ($tags as $ndx =&gt; $container) {&nbsp;</div></li><li><div>              $container = esc_sql(str_replace('%', '%%', $container));&nbsp;</div></li><li><div>              $container_ids[] = &quot;'{$container}'&quot;;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $container_ids = implode(', ', $container_ids);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Construct query</span>&nbsp;</div></li><li><div>      $query = &quot;SELECT {$wpdb-&gt;term_taxonomy}.term_id FROM {$wpdb-&gt;term_taxonomy}\n                  INNER JOIN {$wpdb-&gt;terms} ON {$wpdb-&gt;term_taxonomy}.term_id = {$wpdb-&gt;terms}.term_id\n                  WHERE {$wpdb-&gt;term_taxonomy}.term_id = {$wpdb-&gt;terms}.term_id\n                  AND {$wpdb-&gt;term_taxonomy}.taxonomy = %s&quot;;&nbsp;</div></li><li><div>      if (!empty($container_ids)) {&nbsp;</div></li><li><div>          $query .= &quot; AND ({$wpdb-&gt;terms}.slug IN ({$container_ids}) OR {$wpdb-&gt;terms}.name IN ({$container_ids}))&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $query .= &quot; ORDER BY {$wpdb-&gt;terms}.term_id&quot;;&nbsp;</div></li><li><div>      $query = $wpdb-&gt;prepare($query, 'ngg_tag');&nbsp;</div></li><li><div>      <span class="comment">// Get all term_ids for each image tag slug</span>&nbsp;</div></li><li><div>      $term_ids = array();&nbsp;</div></li><li><div>      $results = $wpdb-&gt;get_results($query);&nbsp;</div></li><li><div>      if (is_array($results) && !empty($results)) {&nbsp;</div></li><li><div>          foreach ($results as $row) {&nbsp;</div></li><li><div>              $term_ids[] = $row-&gt;term_id;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $term_ids;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sorts the results of an album query</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass $a</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass $b</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _sort_album_result($a, $b)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $key = $this-&gt;object-&gt;order_by;&nbsp;</div></li><li><div>      return strcmp($a-&gt;{$key}, $b-&gt;{$key});&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides instance methods useful for working with the C_Displayed_Gallery</span>&nbsp;</div></li><li><div><span class="comment"> * model</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Displayed_Gallery_Instance_Methods extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function get_entity()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $entity = $this-&gt;call_parent('get_entity');&nbsp;</div></li><li><div>      unset($entity-&gt;post_author);&nbsp;</div></li><li><div>      unset($entity-&gt;post_date);&nbsp;</div></li><li><div>      unset($entity-&gt;post_date_gmt);&nbsp;</div></li><li><div>      unset($entity-&gt;post_title);&nbsp;</div></li><li><div>      unset($entity-&gt;post_excerpt);&nbsp;</div></li><li><div>      unset($entity-&gt;post_status);&nbsp;</div></li><li><div>      unset($entity-&gt;comment_status);&nbsp;</div></li><li><div>      unset($entity-&gt;ping_status);&nbsp;</div></li><li><div>      unset($entity-&gt;post_name);&nbsp;</div></li><li><div>      unset($entity-&gt;to_ping);&nbsp;</div></li><li><div>      unset($entity-&gt;pinged);&nbsp;</div></li><li><div>      unset($entity-&gt;post_modified);&nbsp;</div></li><li><div>      unset($entity-&gt;post_modified_gmt);&nbsp;</div></li><li><div>      unset($entity-&gt;post_parent);&nbsp;</div></li><li><div>      unset($entity-&gt;guid);&nbsp;</div></li><li><div>      unset($entity-&gt;post_type);&nbsp;</div></li><li><div>      unset($entity-&gt;post_mime_type);&nbsp;</div></li><li><div>      unset($entity-&gt;comment_count);&nbsp;</div></li><li><div>      unset($entity-&gt;filter);&nbsp;</div></li><li><div>      unset($entity-&gt;post_content_filtered);&nbsp;</div></li><li><div>      return $entity;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the display type object used in this displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Display_Type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_display_type()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return C_Display_Type_Mapper::get_instance()-&gt;find_by_name($this-&gt;object-&gt;display_type, TRUE);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets the corresponding source instance</span>&nbsp;</div></li><li><div><span class="comment">   * @return stdClass</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_source()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return C_Displayed_Gallery_Source_Manager::get_instance()-&gt;get($this-&gt;object-&gt;source);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the galleries queries in this displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_galleries()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      if ($source = $this-&gt;object-&gt;get_source()) {&nbsp;</div></li><li><div>          if (in_array('image', $source-&gt;returns)) {&nbsp;</div></li><li><div>              $mapper = C_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>              $gallery_key = $mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>              $mapper-&gt;select();&nbsp;</div></li><li><div>              if ($this-&gt;object-&gt;container_ids) {&nbsp;</div></li><li><div>                  $mapper-&gt;where(array(&quot;{$gallery_key} IN %s&quot;, $this-&gt;object-&gt;container_ids));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $retval = $mapper-&gt;run_query();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets albums queried in this displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_albums()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      if ($source = $this-&gt;object-&gt;get_source()) {&nbsp;</div></li><li><div>          if (in_array('album', $source-&gt;returns)) {&nbsp;</div></li><li><div>              $mapper = C_Album_Mapper::get_instance();&nbsp;</div></li><li><div>              $album_key = $mapper-&gt;get_primary_key_column();&nbsp;</div></li><li><div>              if ($this-&gt;object-&gt;container_ids) {&nbsp;</div></li><li><div>                  $mapper-&gt;select()-&gt;where(array(&quot;{$album_key} IN %s&quot;, $this-&gt;object-&gt;container_ids));&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $retval = $mapper-&gt;run_query();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns a transient for the displayed gallery</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function to_transient()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $params = $this-&gt;object-&gt;get_entity();&nbsp;</div></li><li><div>      unset($params-&gt;transient_id);&nbsp;</div></li><li><div>      $key = C_Photocrati_Transient_Manager::create_key('displayed_galleries', $params);&nbsp;</div></li><li><div>      if (is_null(C_Photocrati_Transient_Manager::fetch($key, NULL))) {&nbsp;</div></li><li><div>          C_Photocrati_Transient_Manager::update($key, $params, NGG_DISPLAYED_GALLERY_CACHE_TTL);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;object-&gt;transient_id = $key;&nbsp;</div></li><li><div>      if (!$this-&gt;object-&gt;id()) {&nbsp;</div></li><li><div>          $this-&gt;object-&gt;id($key);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $key;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Applies the values of a transient to this object</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $transient_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function apply_transient($transient_id = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if (!$transient_id && isset($this-&gt;object-&gt;transient_id)) {&nbsp;</div></li><li><div>          $transient_id = $this-&gt;object-&gt;transient_id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($transient_id && ($transient = C_Photocrati_Transient_Manager::fetch($transient_id, FALSE))) {&nbsp;</div></li><li><div>          <span class="comment">// Ensure that the transient is an object, not array</span>&nbsp;</div></li><li><div>          if (is_array($transient)) {&nbsp;</div></li><li><div>              $obj = new stdClass();&nbsp;</div></li><li><div>              foreach ($transient as $key =&gt; $value) {&nbsp;</div></li><li><div>                  $obj-&gt;{$key} = $value;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $transient = $obj;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $this-&gt;object-&gt;_stdObject = $transient;&nbsp;</div></li><li><div>          <span class="comment">// Ensure that the display settings are an array</span>&nbsp;</div></li><li><div>          $this-&gt;object-&gt;display_settings = $this-&gt;_object_to_array($this-&gt;object-&gt;display_settings);&nbsp;</div></li><li><div>          <span class="comment">// Ensure that we have the most accurate transient id</span>&nbsp;</div></li><li><div>          $this-&gt;object-&gt;transient_id = $transient_id;&nbsp;</div></li><li><div>          if (!$this-&gt;object-&gt;id()) {&nbsp;</div></li><li><div>              $this-&gt;object-&gt;id($transient_id);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = TRUE;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          unset($this-&gt;object-&gt;transient_id);&nbsp;</div></li><li><div>          unset($this-&gt;object-&gt;_stdObject-&gt;transient_id);&nbsp;</div></li><li><div>          $this-&gt;object-&gt;to_transient();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  public function _object_to_array($object)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = $object;&nbsp;</div></li><li><div>      if (is_object($retval)) {&nbsp;</div></li><li><div>          $retval = get_object_vars($object);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (is_array($retval)) {&nbsp;</div></li><li><div>          foreach ($retval as $key =&gt; $val) {&nbsp;</div></li><li><div>              if (is_object($val)) {&nbsp;</div></li><li><div>                  $retval[$key] = $this-&gt;_object_to_array($val);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Displayed_Gallery_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Displayed_Gallery_Defaults</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Displayed_Gallery_Mapper</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Displayed_Gallery_Mapper extends C_CustomPost_DataMapper_Driver&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  static $_instances = array();&nbsp;</div></li><li><div>  function define($context = FALSE, $not_used = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define('displayed_gallery', array($context, 'displayed_gallery', 'display_gallery'));&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Displayed_Gallery_Defaults');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Displayed_Gallery_Mapper');&nbsp;</div></li><li><div>      $this-&gt;set_model_factory_method('displayed_gallery');&nbsp;</div></li><li><div>      <span class="comment">//        $this-&gt;add_post_hook(</span>&nbsp;</div></li><li><div>      <span class="comment">//            'save', </span>&nbsp;</div></li><li><div>      <span class="comment">//            'Propagate thumbnail dimensions', </span>&nbsp;</div></li><li><div>      <span class="comment">//            'Hook_Propagate_Thumbnail_Dimensions_To_Settings'</span>&nbsp;</div></li><li><div>      <span class="comment">// );</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Initializes the mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array|FALSE $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function initialize()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::initialize('displayed_gallery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets a singleton of the mapper</span>&nbsp;</div></li><li><div><span class="comment">   * @param string|array $context</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Displayed_Gallery_Mapper</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_instance($context = False)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instances[$context])) {&nbsp;</div></li><li><div>          self::$_instances[$context] = new C_Displayed_Gallery_Mapper($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instances[$context];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Adds default values for the displayed gallery</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Displayed_Gallery_Defaults extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets a display type object for a particular entity</span>&nbsp;</div></li><li><div><span class="comment">   * @param stdClass|C_DataMapper_Model $entity</span>&nbsp;</div></li><li><div><span class="comment">   * @return null|stdClass</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_display_type($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $mapper = C_Display_Type_Mapper::get_instance();&nbsp;</div></li><li><div>      return $mapper-&gt;find_by_name($entity-&gt;display_type);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Sets defaults needed for the entity</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $entity</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function set_defaults($entity)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Ensure that we have a settings array</span>&nbsp;</div></li><li><div>      if (!isset($entity-&gt;display_settings)) {&nbsp;</div></li><li><div>          $entity-&gt;display_settings = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If the display type is set, then get it's settings and apply them as</span>&nbsp;</div></li><li><div>      <span class="comment">// defaults to the &quot;display_settings&quot; of the displayed gallery</span>&nbsp;</div></li><li><div>      if (isset($entity-&gt;display_type)) {&nbsp;</div></li><li><div>          <span class="comment">// Get display type mapper</span>&nbsp;</div></li><li><div>          if ($display_type = $this-&gt;object-&gt;get_display_type($entity)) {&nbsp;</div></li><li><div>              $entity-&gt;display_settings = $this-&gt;array_merge_assoc($display_type-&gt;settings, $entity-&gt;display_settings, TRUE);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Default ordering</span>&nbsp;</div></li><li><div>      $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'order_by', $settings-&gt;galSort);&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'order_direction', $settings-&gt;galSortDir);&nbsp;</div></li><li><div>      <span class="comment">// Ensure we have an exclusions array</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'exclusions', array());&nbsp;</div></li><li><div>      <span class="comment">// Ensure other properties exist</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'container_ids', array());&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'excluded_container_ids', array());&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'sortorder', array());&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'entity_ids', array());&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'returns', 'included');&nbsp;</div></li><li><div>      <span class="comment">// Set maximum_entity_count</span>&nbsp;</div></li><li><div>      $this-&gt;object-&gt;_set_default_value($entity, 'maximum_entity_count', $settings-&gt;maximum_entity_count);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Displayed_Gallery_Renderer</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin Mixin_Displayed_Gallery_Renderer</span>&nbsp;</div></li><li><div><span class="comment"> * @implements I_Displayed_Gallery_Renderer</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Displayed_Gallery_Renderer extends C_Component&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  static $_instances = array();&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns an instance of the class</span>&nbsp;</div></li><li><div><span class="comment">   * @param mixed $context</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Displayed_Gallery_Renderer</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_instance($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instances[$context])) {&nbsp;</div></li><li><div>          $klass = __CLASS__;&nbsp;</div></li><li><div>          self::$_instances[$context] = new $klass($context);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instances[$context];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Defines the object</span>&nbsp;</div></li><li><div><span class="comment">   * @param bool $context</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function define($context = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      parent::define($context);&nbsp;</div></li><li><div>      $this-&gt;add_mixin('Mixin_Displayed_Gallery_Renderer');&nbsp;</div></li><li><div>      $this-&gt;implement('I_Displayed_Gallery_Renderer');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Provides the ability to render a display type</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Displayed_Gallery_Renderer extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function params_to_displayed_gallery($params)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $displayed_gallery = NULL;&nbsp;</div></li><li><div>      <span class="comment">// Get the NextGEN settings to provide some defaults</span>&nbsp;</div></li><li><div>      $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>      <span class="comment">// Configure the arguments</span>&nbsp;</div></li><li><div>      $defaults = array('id' =&gt; NULL, 'source' =&gt; '', 'container_ids' =&gt; array(), 'gallery_ids' =&gt; array(), 'album_ids' =&gt; array(), 'tag_ids' =&gt; array(), 'display_type' =&gt; '', 'exclusions' =&gt; array(), 'order_by' =&gt; $settings-&gt;galSort, 'order_direction' =&gt; $settings-&gt;galSortOrder, 'image_ids' =&gt; array(), 'entity_ids' =&gt; array(), 'tagcloud' =&gt; FALSE, 'returns' =&gt; 'included', 'slug' =&gt; NULL, 'sortorder' =&gt; array());&nbsp;</div></li><li><div>      $args = shortcode_atts($defaults, $params);&nbsp;</div></li><li><div>      <span class="comment">// Are we loading a specific displayed gallery that's persisted?</span>&nbsp;</div></li><li><div>      $mapper = C_Displayed_Gallery_Mapper::get_instance();&nbsp;</div></li><li><div>      if (!is_null($args['id'])) {&nbsp;</div></li><li><div>          $displayed_gallery = $mapper-&gt;find($args['id'], TRUE);&nbsp;</div></li><li><div>          unset($mapper);&nbsp;</div></li><li><div>          <span class="comment">// no longer needed</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Perform some conversions...</span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Galleries</span>?</span>&nbsp;</div></li><li><div>          if ($args['gallery_ids']) {&nbsp;</div></li><li><div>              if ($args['source'] != 'albums' and $args['source'] != 'album') {&nbsp;</div></li><li><div>                  $args['source'] = 'galleries';&nbsp;</div></li><li><div>                  $args['container_ids'] = $args['gallery_ids'];&nbsp;</div></li><li><div>                  if ($args['image_ids']) {&nbsp;</div></li><li><div>                      $args['entity_ids'] = $args['image_ids'];&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              } elseif ($args['source'] == 'albums') {&nbsp;</div></li><li><div>                  $args['entity_ids'] = $args['gallery_ids'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              unset($args['gallery_ids']);&nbsp;</div></li><li><div>          } elseif ($args['album_ids'] || $args['album_ids'] === '0') {&nbsp;</div></li><li><div>              $args['source'] = 'albums';&nbsp;</div></li><li><div>              $args['container_ids'] = $args['album_ids'];&nbsp;</div></li><li><div>              unset($args['albums_ids']);&nbsp;</div></li><li><div>          } elseif ($args['tag_ids']) {&nbsp;</div></li><li><div>              $args['source'] = 'tags';&nbsp;</div></li><li><div>              $args['container_ids'] = $args['tag_ids'];&nbsp;</div></li><li><div>              unset($args['tag_ids']);&nbsp;</div></li><li><div>          } elseif ($args['image_ids']) {&nbsp;</div></li><li><div>              $args['source'] = 'galleries';&nbsp;</div></li><li><div>              $args['entity_ids'] = $args['image_ids'];&nbsp;</div></li><li><div>              unset($args['image_ids']);&nbsp;</div></li><li><div>          } elseif ($args['tagcloud']) {&nbsp;</div></li><li><div>              $args['source'] = 'tags';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Convert strings to arrays</span>&nbsp;</div></li><li><div>          if (!is_array($args['container_ids'])) {&nbsp;</div></li><li><div>              $args['container_ids'] = preg_split(&quot;/, |\\|/&quot;, $args['container_ids']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!is_array($args['exclusions'])) {&nbsp;</div></li><li><div>              $args['exclusions'] = preg_split(&quot;/, |\\|/&quot;, $args['exclusions']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!is_array($args['entity_ids'])) {&nbsp;</div></li><li><div>              $args['entity_ids'] = preg_split(&quot;/, |\\|/&quot;, $args['entity_ids']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if (!is_array($args['sortorder'])) {&nbsp;</div></li><li><div>              $args['sortorder'] = preg_split(&quot;/, |\\|/&quot;, $args['sortorder']);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Get the display settings</span>&nbsp;</div></li><li><div>          foreach (array_keys($defaults) as $key) {&nbsp;</div></li><li><div>              unset($params[$key]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $args['display_settings'] = $params;&nbsp;</div></li><li><div>          <span class="comment">// Create the displayed gallery</span>&nbsp;</div></li><li><div>          $factory = C_Component_Factory::get_instance();&nbsp;</div></li><li><div>          $displayed_gallery = $factory-&gt;create('displayed_gallery', $args, $mapper);&nbsp;</div></li><li><div>          unset($factory);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Validate the displayed gallery</span></span>&nbsp;</div></li><li><div>      if ($displayed_gallery) {&nbsp;</div></li><li><div>          $displayed_gallery-&gt;validate();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $displayed_gallery;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Displays a &quot;displayed gallery&quot; instance</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Alias Properties:</span>&nbsp;</div></li><li><div><span class="comment">   * gallery_ids/album_ids/tag_ids == container_ids</span>&nbsp;</div></li><li><div><span class="comment">   * image_ids/gallery_ids == entity_ids</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Default Behavior:</span>&nbsp;</div></li><li><div><span class="comment">   * - if order_by and order_direction are missing, the default settings</span>&nbsp;</div></li><li><div><span class="comment">   *   are used from the &quot;Other Options&quot; page. The exception to this is</span>&nbsp;</div></li><li><div><span class="comment">   *   when entity_ids are selected, in which the order is custom unless</span>&nbsp;</div></li><li><div><span class="comment">   *   specified.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * How to use:</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve images from gallery 1 & 3, but exclude images 4 & 6:</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images gallery_ids=&quot;1, 3&quot; exclusions=&quot;4, 6&quot; display_type=&quot;photocrati-nextgen_basic_thumbnails&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve images 1 & 2 from gallery 1:</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images gallery_ids=&quot;1&quot; image_ids=&quot;1, 2&quot; display_type=&quot;photocrati-nextgen_basic_thumbnails&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve images matching tags &quot;landscapes&quot; and &quot;wedding shoots&quot;:</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images tag_ids=&quot;landscapes, wedding shoots&quot; display_type=&quot;photocrati-nextgen_basic_thumbnails&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve galleries from albums 1 & #, but exclude sub-album 1:</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images album_ids=&quot;1, 2&quot; exclusions=&quot;a1&quot; display_type=&quot;photocrati-nextgen_basic_compact_album&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve galleries from albums 1 & 2, but exclude gallery 1:</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images album_ids=&quot;1, 2&quot; exclusions=&quot;1&quot; display_type=&quot;photocrati-nextgen_basic_compact_album&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve image 2, 3, and 5 - independent of what container is used</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images image_ids=&quot;2, 3, 5&quot; display_type=&quot;photocrati-nextgen_basic_thumbnails&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve galleries 3 & 5, custom sorted, in album view</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images source=&quot;albums&quot; gallery_ids=&quot;3, 5&quot; display_type=&quot;photocrati-nextgen_basic_compact_album&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve recent images, sorted by alt/title text</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images source=&quot;recent&quot; order_by=&quot;alttext&quot; display_type=&quot;photocrati-nextgen_basic_thumbnails&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve random image</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images source=&quot;random&quot; display_type=&quot;photocrati-nextgen_basic_thumbnails&quot;]</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve a single image</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images image_ids='8' display_type='photocrati-nextgen_basic_singlepic']</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * To retrieve a tag cloud</span>&nbsp;</div></li><li><div><span class="comment">   * [ngg_images tagcloud=yes display_type='photocrati-nextgen_basic_tagcloud']</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function display_images($params, $inner_content = NULL, $mode = NULL)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = '';&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Validate the displayed gallery</span></span>&nbsp;</div></li><li><div>      if ($displayed_gallery = $this-&gt;object-&gt;params_to_displayed_gallery($params)) {&nbsp;</div></li><li><div>          if ($displayed_gallery-&gt;validate()) {&nbsp;</div></li><li><div>              <span class="comment">// Display!</span>&nbsp;</div></li><li><div>              $retval = $this-&gt;object-&gt;render($displayed_gallery, TRUE, $mode);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              if (C_NextGEN_Bootstrap::$debug) {&nbsp;</div></li><li><div>                  $retval = __('We cannot display this gallery', 'nggallery') . $this-&gt;debug_msg($displayed_gallery-&gt;get_errors()) . $this-&gt;debug_msg($displayed_gallery-&gt;get_entity());&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $retval = __('We cannot display this gallery', 'nggallery');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $retval = __('We cannot display this gallery', 'nggallery');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function debug_msg($msg, $print_r = FALSE)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = '';&nbsp;</div></li><li><div>      if (C_NextGEN_Bootstrap::$debug) {&nbsp;</div></li><li><div>          ob_start();&nbsp;</div></li><li><div>          if ($print_r) {&nbsp;</div></li><li><div>              echo '&lt;pre&gt;';&nbsp;</div></li><li><div>              print_r($msg);&nbsp;</div></li><li><div>              echo '&lt;/pre&gt;';&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              var_dump($msg);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $retval = ob_get_clean();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Renders a displayed gallery on the frontend</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_Displayed_Gallery|stdClass $displayed_gallery</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function render($displayed_gallery, $return = FALSE, $mode = null)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = '';&nbsp;</div></li><li><div>      $lookup = TRUE;&nbsp;</div></li><li><div>      <span class="comment">// Simply throwing our rendered gallery into a feed will most likely not work correctly.</span>&nbsp;</div></li><li><div>      <span class="comment">// The MediaRSS option in NextGEN is available as an alternative.</span>&nbsp;</div></li><li><div>      if (!C_NextGen_Settings::get_instance()-&gt;galleries_in_feeds && is_feed()) {&nbsp;</div></li><li><div>          return sprintf(__(' [&lt;a href=&quot;%s&quot;&gt;See image gallery at %s&lt;/a&gt;] ', 'nggallery'), esc_url(apply_filters('the_permalink_rss', get_permalink())), $_SERVER['SERVER_NAME']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($mode == null) {&nbsp;</div></li><li><div>          $mode = 'normal';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (apply_filters('ngg_cache_displayed_galleries', FALSE)) {&nbsp;</div></li><li><div>          <span class="comment">// Save the displayed gallery as a transient if it hasn't already. Allows for ajax operations</span>&nbsp;</div></li><li><div>          <span class="comment">// to add or modify the gallery without losing a retrievable ID</span>&nbsp;</div></li><li><div>          if (!$displayed_gallery-&gt;apply_transient()) {&nbsp;</div></li><li><div>              $displayed_gallery-&gt;to_transient();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          if (is_null($displayed_gallery-&gt;id())) {&nbsp;</div></li><li><div>              $displayed_gallery-&gt;id(md5(json_encode($displayed_gallery-&gt;get_entity())));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Get the display type controller</span>&nbsp;</div></li><li><div>      $controller = $this-&gt;get_registry()-&gt;get_utility('I_Display_Type_Controller', $displayed_gallery-&gt;display_type);&nbsp;</div></li><li><div>      <span class="comment">// Get routing info</span>&nbsp;</div></li><li><div>      $router = C_Router::get_instance();&nbsp;</div></li><li><div>      $url = $router-&gt;get_url($router-&gt;get_request_uri(), TRUE);&nbsp;</div></li><li><div>      <span class="comment">// Should we lookup in cache?</span>&nbsp;</div></li><li><div>      if (is_array($displayed_gallery-&gt;container_ids) && in_array('All', $displayed_gallery-&gt;container_ids)) {&nbsp;</div></li><li><div>          $lookup = FALSE;&nbsp;</div></li><li><div>      } elseif ($displayed_gallery-&gt;source == 'albums' && $controller-&gt;param('gallery') or $controller-&gt;param('album')) {&nbsp;</div></li><li><div>          $lookup = FALSE;&nbsp;</div></li><li><div>      } elseif ($controller-&gt;param('show')) {&nbsp;</div></li><li><div>          $lookup = FALSE;&nbsp;</div></li><li><div>      } elseif ($controller-&gt;is_cachable() === FALSE) {&nbsp;</div></li><li><div>          $lookup = FALSE;&nbsp;</div></li><li><div>      } elseif (!NGG_RENDERING_CACHE_ENABLED) {&nbsp;</div></li><li><div>          $lookup = FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Enqueue any necessary static resources</span>&nbsp;</div></li><li><div>      if (!defined('NGG_SKIP_LOAD_SCRIPTS') || !NGG_SKIP_LOAD_SCRIPTS) {&nbsp;</div></li><li><div>          $controller-&gt;enqueue_frontend_resources($displayed_gallery);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Try cache lookup, if we're to do so</span>&nbsp;</div></li><li><div>      $key = NULL;&nbsp;</div></li><li><div>      $html = FALSE;&nbsp;</div></li><li><div>      if ($lookup) {&nbsp;</div></li><li><div>          <span class="comment">// The display type may need to output some things</span>&nbsp;</div></li><li><div>          <span class="comment">// even when serving from the cache</span>&nbsp;</div></li><li><div>          if ($controller-&gt;has_method('cache_action')) {&nbsp;</div></li><li><div>              $retval = $controller-&gt;cache_action($displayed_gallery);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Output debug message</span>&nbsp;</div></li><li><div>          $retval .= $this-&gt;debug_msg(&quot;Lookup!&quot;);&nbsp;</div></li><li><div>          <span class="comment">// Some settings affect display types</span>&nbsp;</div></li><li><div>          $settings = C_NextGen_Settings::get_instance();&nbsp;</div></li><li><div>          $key_params = apply_filters('ngg_displayed_gallery_cache_params', array($displayed_gallery-&gt;get_entity(), $url, $mode, $settings-&gt;activateTags, $settings-&gt;appendType, $settings-&gt;maxImages, $settings-&gt;thumbEffect, $settings-&gt;thumbCode, $settings-&gt;galSort, $settings-&gt;galSortDir));&nbsp;</div></li><li><div>          <span class="comment">// Any displayed gallery links on the home page will need to be regenerated if the permalink structure</span>&nbsp;</div></li><li><div>          <span class="comment">// changes</span>&nbsp;</div></li><li><div>          if (is_home() or is_front_page()) {&nbsp;</div></li><li><div>              $key_params[] = get_option('permalink_structure');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// Try getting the rendered HTML from the cache</span>&nbsp;</div></li><li><div>          $key = C_Photocrati_Transient_Manager::create_key('displayed_gallery_rendering', $key_params);&nbsp;</div></li><li><div>          $html = C_Photocrati_Transient_Manager::fetch($key, FALSE);&nbsp;</div></li><li><div>          <span class="comment">// Output debug message</span>s&nbsp;</div></li><li><div>          if ($html) {&nbsp;</div></li><li><div>              $retval .= $this-&gt;debug_msg(&quot;HIT!&quot;);&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $retval .= $this-&gt;debug_msg(&quot;MISS!&quot;);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">// TODO: This is hack. We need to figure out a more uniform way of detecting dynamic image urls</span>&nbsp;</div></li><li><div>          if (strpos($html, C_Photocrati_Settings_Manager::get_instance()-&gt;dynamic_thumbnail_slug . '/') !== FALSE) {&nbsp;</div></li><li><div>              $html = FALSE;&nbsp;</div></li><li><div>              <span class="comment">// forces the cache to be re-generated</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $retval .= $this-&gt;debug_msg(&quot;Not looking up in cache as per rules&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If we're displaying a variant, I want to know it</span>&nbsp;</div></li><li><div>      if (isset($displayed_gallery-&gt;variation) && is_numeric($displayed_gallery-&gt;variation) && $displayed_gallery-&gt;variation &gt; 0) {&nbsp;</div></li><li><div>          $retval .= $this-&gt;debug_msg(&quot;Using variation #{$displayed_gallery-&gt;variation}!&quot;);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// If a cached version doesn't exist, then create the cache</span>&nbsp;</div></li><li><div>      if (!$html) {&nbsp;</div></li><li><div>          $retval .= $this-&gt;debug_msg(&quot;Rendering displayed gallery&quot;);&nbsp;</div></li><li><div>          $current_mode = $controller-&gt;get_render_mode();&nbsp;</div></li><li><div>          $controller-&gt;set_render_mode($mode);&nbsp;</div></li><li><div>          $html = apply_filters('ngg_displayed_gallery_rendering', $controller-&gt;index_action($displayed_gallery, TRUE), $displayed_gallery);&nbsp;</div></li><li><div>          if ($key != null) {&nbsp;</div></li><li><div>              C_Photocrati_Transient_Manager::update($key, $html, NGG_RENDERING_CACHE_TTL);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval .= $html;&nbsp;</div></li><li><div>      if (!$return) {&nbsp;</div></li><li><div>          echo $retval;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_Displayed_Gallery_Source_Manager&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  private $_sources = array();&nbsp;</div></li><li><div>  private $_entity_types = array();&nbsp;</div></li><li><div>  private $_registered_defaults = array();&nbsp;</div></li><li><div>  <span class="comment">/** @var C_Displayed_Gallery_Source_Manager */</span>&nbsp;</div></li><li><div>  static $_instance = NULL;&nbsp;</div></li><li><div>  static function get_instance()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!isset(self::$_instance)) {&nbsp;</div></li><li><div>          $klass = get_class();&nbsp;</div></li><li><div>          self::$_instance = new $klass();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function register_defaults()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Entity types must be registered first!!!</span>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// --</span></span>--------------------------------------&nbsp;</div></li><li><div>      $this-&gt;register_entity_type('gallery', 'galleries');&nbsp;</div></li><li><div>      $this-&gt;register_entity_type('image', 'images');&nbsp;</div></li><li><div>      $this-&gt;register_entity_type('album', 'albums');&nbsp;</div></li><li><div>      <span class="comment">// Galleries</span>&nbsp;</div></li><li><div>      $galleries = new stdClass();&nbsp;</div></li><li><div>      $galleries-&gt;name = 'galleries';&nbsp;</div></li><li><div>      $galleries-&gt;title = __('Galleries', 'nggallery');&nbsp;</div></li><li><div>      $galleries-&gt;aliases = array('gallery', 'images', 'image');&nbsp;</div></li><li><div>      $galleries-&gt;returns = array('image');&nbsp;</div></li><li><div>      $this-&gt;register($galleries-&gt;name, $galleries);&nbsp;</div></li><li><div>      <span class="comment">// Albums</span>&nbsp;</div></li><li><div>      $albums = new stdClass();&nbsp;</div></li><li><div>      $albums-&gt;name = 'albums';&nbsp;</div></li><li><div>      $albums-&gt;title = __('Albums', 'nggallery');&nbsp;</div></li><li><div>      $albums-&gt;aliases = array('album');&nbsp;</div></li><li><div>      $albums-&gt;returns = array('album', 'gallery');&nbsp;</div></li><li><div>      $this-&gt;register($albums-&gt;name, $albums);&nbsp;</div></li><li><div>      <span class="comment">// Tags</span>&nbsp;</div></li><li><div>      $tags = new stdClass();&nbsp;</div></li><li><div>      $tags-&gt;name = 'tags';&nbsp;</div></li><li><div>      $tags-&gt;title = __('Tags', 'nggallery');&nbsp;</div></li><li><div>      $tags-&gt;aliases = array('tag', 'image_tags', 'image_tag');&nbsp;</div></li><li><div>      $tags-&gt;returns = array('image');&nbsp;</div></li><li><div>      $this-&gt;register($tags-&gt;name, $tags);&nbsp;</div></li><li><div>      <span class="comment">// Random Images;</span>&nbsp;</div></li><li><div>      $random = new stdClass();&nbsp;</div></li><li><div>      $random-&gt;name = 'random_images';&nbsp;</div></li><li><div>      $random-&gt;title = __('Random Images', 'nggallery');&nbsp;</div></li><li><div>      $random-&gt;aliases = array('random', 'random_image');&nbsp;</div></li><li><div>      $random-&gt;returns = array('image');&nbsp;</div></li><li><div>      $random-&gt;has_variations = TRUE;&nbsp;</div></li><li><div>      $this-&gt;register($random-&gt;name, $random);&nbsp;</div></li><li><div>      <span class="comment">// Recent Images</span>&nbsp;</div></li><li><div>      $recent = new stdClass();&nbsp;</div></li><li><div>      $recent-&gt;name = 'recent_images';&nbsp;</div></li><li><div>      $recent-&gt;title = __('Recent Images', 'nggallery');&nbsp;</div></li><li><div>      $recent-&gt;aliases = array('recent', 'recent_image');&nbsp;</div></li><li><div>      $recent-&gt;returns = array('image');&nbsp;</div></li><li><div>      $this-&gt;register($recent-&gt;name, $recent);&nbsp;</div></li><li><div>      $this-&gt;_registered_defaults = TRUE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function register($name, $properties)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// We'll use an object to represent the source</span>&nbsp;</div></li><li><div>      $object = $properties;&nbsp;</div></li><li><div>      if (!is_object($properties)) {&nbsp;</div></li><li><div>          $object = new stdClass();&nbsp;</div></li><li><div>          foreach ($properties as $k =&gt; $v) {&nbsp;</div></li><li><div>              $object-&gt;{$k} = $v;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Set default properties</span>&nbsp;</div></li><li><div>      $object-&gt;name = $name;&nbsp;</div></li><li><div>      if (!isset($object-&gt;title)) {&nbsp;</div></li><li><div>          $object-&gt;title = $name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($object-&gt;returns)) {&nbsp;</div></li><li><div>          $object-&gt;returns = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($object-&gt;aliases)) {&nbsp;</div></li><li><div>          $object-&gt;aliases = array();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if (!isset($object-&gt;has_variations)) {&nbsp;</div></li><li><div>          $object-&gt;has_variations = FALSE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// Add internal reference</span>&nbsp;</div></li><li><div>      $this-&gt;_sources[$name] = $object;&nbsp;</div></li><li><div>      foreach ($object-&gt;aliases as $name) {&nbsp;</div></li><li><div>          $this-&gt;_sources[$name] = $object;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function register_entity_type()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $aliases = func_get_args();&nbsp;</div></li><li><div>      $name = array_shift($aliases);&nbsp;</div></li><li><div>      $this-&gt;_entity_types[] = $name;&nbsp;</div></li><li><div>      foreach ($aliases as $alias) {&nbsp;</div></li><li><div>          $this-&gt;_entity_types[$alias] = $name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function deregister($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($source = $this-&gt;get($name)) {&nbsp;</div></li><li><div>          unset($this-&gt;_sources[$name]);&nbsp;</div></li><li><div>          foreach ($source-&gt;aliases as $alias) {&nbsp;</div></li><li><div>              unset($this-&gt;_sources[$alias]);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function deregister_entity_type($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      unset($this-&gt;_entity_types[$name]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get($name_or_alias)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;_registered_defaults) {&nbsp;</div></li><li><div>          $this-&gt;register_defaults();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = NULL;&nbsp;</div></li><li><div>      if (isset($this-&gt;_sources[$name_or_alias])) {&nbsp;</div></li><li><div>          $retval = $this-&gt;_sources[$name_or_alias];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_entity_type($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;_registered_defaults) {&nbsp;</div></li><li><div>          $this-&gt;register_defaults();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $found = array_search($name, $this-&gt;_entity_types);&nbsp;</div></li><li><div>      if ($found) {&nbsp;</div></li><li><div>          return $this-&gt;_entity_types[$found];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return NULL;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_all()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;_registered_defaults) {&nbsp;</div></li><li><div>          $this-&gt;register_defaults();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $retval = array();&nbsp;</div></li><li><div>      foreach (array_values($this-&gt;_sources) as $source_obj) {&nbsp;</div></li><li><div>          if (!in_array($source_obj, $retval)) {&nbsp;</div></li><li><div>              $retval[] = $source_obj;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      usort($retval, array(&$this, '__sort_by_name'));&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function __sort_by_name($a, $b)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return strcmp($a-&gt;name, $b-&gt;name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_all_entity_types()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!$this-&gt;_registered_defaults) {&nbsp;</div></li><li><div>          $this-&gt;register_defaults();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array_unique(array_values($this-&gt;_entity_types));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_registered($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return !is_null($this-&gt;get($name));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_valid_entity_type($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return !is_null($this-&gt;get_entity_type($name));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function deregister_all()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;_sources = array();&nbsp;</div></li><li><div>      $this-&gt;_entity_types = array();&nbsp;</div></li><li><div>      $this-&gt;_registered_defaults = FALSE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function is_compatible($source, $display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = FALSE;&nbsp;</div></li><li><div>      if ($source = $this-&gt;get($source-&gt;name)) {&nbsp;</div></li><li><div>          <span class="comment">// Get the real entity type names for the display type</span>&nbsp;</div></li><li><div>          $display_type_entity_types = array();&nbsp;</div></li><li><div>          foreach ($display_type-&gt;entity_types as $type) {&nbsp;</div></li><li><div>              $result = $this-&gt;get_entity_type($type);&nbsp;</div></li><li><div>              if ($result) {&nbsp;</div></li><li><div>                  $display_type_entity_types[] = $result;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          foreach ($source-&gt;returns as $entity_type) {&nbsp;</div></li><li><div>              if (in_array($entity_type, $display_type_entity_types, TRUE)) {&nbsp;</div></li><li><div>                  $retval = TRUE;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>abstract class C_Displayed_Gallery_Trigger&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  static function is_renderable($name, $displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return TRUE;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_css_class()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return 'fa fa-circle';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_attributes()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return array('class' =&gt; $this-&gt;get_css_class());&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function render()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $attributes = array();&nbsp;</div></li><li><div>      foreach ($this-&gt;get_attributes() as $k =&gt; $v) {&nbsp;</div></li><li><div>          $k = esc_attr($k);&nbsp;</div></li><li><div>          $v = esc_attr($v);&nbsp;</div></li><li><div>          $attributes[] = &quot;{$k}='{$v}'&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $attributes = implode(&quot; &quot;, $attributes);&nbsp;</div></li><li><div>      return &quot;&lt;i {$attributes}&gt;&lt;/i&gt;&quot;;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * The Trigger Manager displays &quot;trigger buttons&quot; for a displayed gallery.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Each display type can register a &quot;handler&quot;, which is a class with a render method, which is used</span>&nbsp;</div></li><li><div><span class="comment"> * to render the display of the trigger buttons.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Each trigger button is registered with a handler, which is also a class with a render() method.</span>&nbsp;</div></li><li><div><span class="comment"> * Class C_Displayed_Gallery_Trigger_Manager</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class C_Displayed_Gallery_Trigger_Manager&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  static $_instance = NULL;&nbsp;</div></li><li><div>  private $_triggers = array();&nbsp;</div></li><li><div>  private $_trigger_order = array();&nbsp;</div></li><li><div>  private $_display_type_handlers = array();&nbsp;</div></li><li><div>  private $_default_display_type_handler = NULL;&nbsp;</div></li><li><div>  private $css_class = 'ngg-trigger-buttons';&nbsp;</div></li><li><div>  private $_default_image_types = array('photocrati-nextgen_basic_thumbnails', 'photocrati-nextgen_basic_singlepic', 'photocrati-nextgen_pro_thumbnail_grid', 'photocrati-nextgen_pro_blog_gallery', 'photocrati-nextgen_pro_film');&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @return C_Displayed_Gallery_Trigger_Manager</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function get_instance()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (!self::$_instance) {&nbsp;</div></li><li><div>          $klass = get_class();&nbsp;</div></li><li><div>          self::$_instance = new $klass();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return self::$_instance;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function __construct()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;_default_display_type_handler = 'C_Displayed_Gallery_Trigger_Handler';&nbsp;</div></li><li><div>      foreach ($this-&gt;_default_image_types as $display_type) {&nbsp;</div></li><li><div>          $this-&gt;register_display_type_handler($display_type, 'C_Displayed_Gallery_Image_Trigger_Handler');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function register_display_type_handler($display_type, $klass)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;_display_type_handlers[$display_type] = $klass;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function deregister_display_type_handler($display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      unset($this-&gt;_display_type_handlers[$display_type]);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function add($name, $handler)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;_triggers[$name] = $handler;&nbsp;</div></li><li><div>      $this-&gt;_trigger_order[] = $name;&nbsp;</div></li><li><div>      return $this;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function remove($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $order = array();&nbsp;</div></li><li><div>      unset($this-&gt;_triggers[$name]);&nbsp;</div></li><li><div>      foreach ($this-&gt;_trigger_order as $trigger) {&nbsp;</div></li><li><div>          if ($trigger != $name) {&nbsp;</div></li><li><div>              $order[] = $trigger;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;_trigger_order = $order;&nbsp;</div></li><li><div>      return $this;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _rebuild_index()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $order = array();&nbsp;</div></li><li><div>      foreach ($this-&gt;_trigger_order as $name) {&nbsp;</div></li><li><div>          $order[] = $name;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;_trigger_order = $order;&nbsp;</div></li><li><div>      return $this;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function increment_position($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (($current_index = array_search($name, $this-&gt;_trigger_order)) !== FALSE) {&nbsp;</div></li><li><div>          $next_index = $current_index += 1;&nbsp;</div></li><li><div>          <span class="comment">// 1, 2, 3, 4, 5 =&gt; 1, 2, 4, 3, 5</span>&nbsp;</div></li><li><div>          if (isset($this-&gt;_trigger_order[$next_index])) {&nbsp;</div></li><li><div>              $next = $this-&gt;_trigger_order[$next_index];&nbsp;</div></li><li><div>              $this-&gt;_trigger_order[$next_index] = $name;&nbsp;</div></li><li><div>              $this-&gt;_trigger_order[$current_index] = $next;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;position_of($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function decrement_position($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (($current_index = array_search($name, $this-&gt;_trigger_order)) !== FALSE) {&nbsp;</div></li><li><div>          $previous_index = $current_index -= 1;&nbsp;</div></li><li><div>          if (isset($this-&gt;_trigger_order[$previous_index])) {&nbsp;</div></li><li><div>              $previous = $this-&gt;_trigger_order[$previous_index];&nbsp;</div></li><li><div>              $this-&gt;_trigger_order[$previous_index] = $name;&nbsp;</div></li><li><div>              $this-&gt;_trigger_order[$current_index] = $previous;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;position_of($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function position_of($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return array_search($name, $this-&gt;_trigger_order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function move_to_position($name, $position_index)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if (($current_index = $this-&gt;position_of($name)) !== FALSE) {&nbsp;</div></li><li><div>          $func = 'increment_position';&nbsp;</div></li><li><div>          if ($current_index &lt; $position_index) {&nbsp;</div></li><li><div>              $func = 'decrement_position';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          while ($this-&gt;position_of($name) != $position_index) {&nbsp;</div></li><li><div>              $this-&gt;{$func}($name);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;position_of($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function move_to_start($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($index = $this-&gt;position_of($name)) {&nbsp;</div></li><li><div>          unset($this-&gt;_trigger_order[$index]);&nbsp;</div></li><li><div>          array_unshift($this-&gt;_trigger_order, $name);&nbsp;</div></li><li><div>          $this-&gt;_rebuild_index();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;position_of($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function count()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return count($this-&gt;_trigger_order);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function move_to_end($name)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $index = $this-&gt;position_of($name);&nbsp;</div></li><li><div>      if ($index !== FALSE or $index != $this-&gt;count() - 1) {&nbsp;</div></li><li><div>          unset($this-&gt;_trigger_order[$index]);&nbsp;</div></li><li><div>          $this-&gt;_trigger_order[] = $name;&nbsp;</div></li><li><div>          $this-&gt;_rebuild_index();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;position_of($name);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function get_handler_for_displayed_gallery($displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">// Find the trigger handler for the current display type.</span>&nbsp;</div></li><li><div>      <span class="comment">// First, check the display settings for the displayed gallery. Some third-party</span>&nbsp;</div></li><li><div>      <span class="comment">// display types might specify their own handler</span>&nbsp;</div></li><li><div>      $klass = NULL;&nbsp;</div></li><li><div>      if (isset($displayed_gallery-&gt;display_settings['trigger_handler'])) {&nbsp;</div></li><li><div>          $klass = $displayed_gallery-&gt;display_settings['trigger_handler'];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $klass = $this-&gt;_default_display_type_handler;&nbsp;</div></li><li><div>          if (isset($this-&gt;_display_type_handlers[$displayed_gallery-&gt;display_type])) {&nbsp;</div></li><li><div>              $klass = $this-&gt;_display_type_handlers[$displayed_gallery-&gt;display_type];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $klass;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function render($view, $displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($klass = $this-&gt;get_handler_for_displayed_gallery($displayed_gallery)) {&nbsp;</div></li><li><div>          $handler = new $klass();&nbsp;</div></li><li><div>          $handler-&gt;view = $view;&nbsp;</div></li><li><div>          $handler-&gt;displayed_gallery = $displayed_gallery;&nbsp;</div></li><li><div>          $handler-&gt;manager = $this;&nbsp;</div></li><li><div>          if (method_exists($handler, 'render')) {&nbsp;</div></li><li><div>              $handler-&gt;render();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $view;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function render_trigger($name, $view, $displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $retval = '';&nbsp;</div></li><li><div>      if (isset($this-&gt;_triggers[$name])) {&nbsp;</div></li><li><div>          $klass = $this-&gt;_triggers[$name];&nbsp;</div></li><li><div>          if (call_user_func(array($klass, 'is_renderable'), $name, $displayed_gallery)) {&nbsp;</div></li><li><div>              $handler = new $klass();&nbsp;</div></li><li><div>              $handler-&gt;name = $name;&nbsp;</div></li><li><div>              $handler-&gt;view = $this-&gt;view = $view;&nbsp;</div></li><li><div>              $handler-&gt;displayed_gallery = $displayed_gallery;&nbsp;</div></li><li><div>              $retval = $handler-&gt;render();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function render_triggers($view, $displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $output = FALSE;&nbsp;</div></li><li><div>      $css_class = esc_attr($this-&gt;css_class);&nbsp;</div></li><li><div>      $retval = array(&quot;&lt;div class='{$css_class}'&gt;&quot;);&nbsp;</div></li><li><div>      foreach ($this-&gt;_trigger_order as $name) {&nbsp;</div></li><li><div>          if ($markup = $this-&gt;render_trigger($name, $view, $displayed_gallery)) {&nbsp;</div></li><li><div>              $output = TRUE;&nbsp;</div></li><li><div>              $retval[] = $markup;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ($output) {&nbsp;</div></li><li><div>          $retval[] = &quot;&lt;/div&gt;&quot;;&nbsp;</div></li><li><div>          $retval = implode(&quot;\n&quot;, $retval);&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $retval = '';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $retval;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function enqueue_resources($displayed_gallery)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($handler = $this-&gt;get_handler_for_displayed_gallery($displayed_gallery)) {&nbsp;</div></li><li><div>          wp_enqueue_style('fontawesome');&nbsp;</div></li><li><div>          wp_enqueue_style('ngg_trigger_buttons');&nbsp;</div></li><li><div>          if (method_exists($handler, 'enqueue_resources')) {&nbsp;</div></li><li><div>              call_user_func(array($handler, 'enqueue_resources'), $displayed_gallery);&nbsp;</div></li><li><div>              foreach ($this-&gt;_trigger_order as $name) {&nbsp;</div></li><li><div>                  $handler = $this-&gt;_triggers[$name];&nbsp;</div></li><li><div>                  $renderable = TRUE;&nbsp;</div></li><li><div>                  if (method_exists($handler, 'is_renderable')) {&nbsp;</div></li><li><div>                      $renderable = call_user_func($handler, 'is_renderable', $name, $displayed_gallery);&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>                  if ($renderable && method_exists($handler, 'enqueue_resources')) {&nbsp;</div></li><li><div>                      call_user_func(array($handler, 'enqueue_resources', $name, $displayed_gallery));&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_Displayed_Gallery_Image_Trigger_Handler&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function render()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      foreach ($this-&gt;view-&gt;find('nextgen_gallery.image', true) as $image_element) {&nbsp;</div></li><li><div>          $image_element-&gt;append($this-&gt;manager-&gt;render_triggers($image_element, $this-&gt;displayed_gallery));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>class C_Displayed_Gallery_Trigger_Handler&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  function render()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;view-&gt;append($this-&gt;manager-&gt;render_triggers($this-&gt;view, $this-&gt;displayed_gallery));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Class Mixin_Display_Type_Form</span>&nbsp;</div></li><li><div><span class="comment"> * @mixin C_Form</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>class Mixin_Display_Type_Form extends Mixin&nbsp;</div></li><li><div>{&nbsp;</div></li><li><div>  var $_model = null;&nbsp;</div></li><li><div>  function initialize()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $this-&gt;object-&gt;implement('I_Display_Type_Form');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the name of the display type. Sub-class should override</span>&nbsp;</div></li><li><div><span class="comment">   * @throws Exception</span>&nbsp;</div></li><li><div><span class="comment">   * @returns string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_display_type_name()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      throw new Exception(__METHOD__ . &quot; not implemented&quot;);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the model (display type) used in the form</span>&nbsp;</div></li><li><div><span class="comment">   * @return stdClass</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_model()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      if ($this-&gt;_model == null) {&nbsp;</div></li><li><div>          $mapper = C_Display_Type_Mapper::get_instance();&nbsp;</div></li><li><div>          $this-&gt;_model = $mapper-&gt;find_by_name($this-&gt;object-&gt;get_display_type_name(), TRUE);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $this-&gt;_model;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the title of the form, which is the title of the display type</span>&nbsp;</div></li><li><div><span class="comment">   * @returns string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_title()&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return __($this-&gt;object-&gt;get_model()-&gt;title, 'nggallery');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Saves the settings for the display type</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $attributes</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function save_action($attributes = array())&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;get_model()-&gt;save(array('settings' =&gt; $attributes));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Renders the AJAX pagination settings field</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_Display_Type $display_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _render_ajax_pagination_field($display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;_render_radio_field($display_type, 'ajax_pagination', __('Enable AJAX pagination', 'nggallery'), isset($display_type-&gt;settings['ajax_pagination']) ? $display_type-&gt;settings['ajax_pagination'] : FALSE, __('Browse images without reloading the page.', 'nggallery'));&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  function _render_thumbnail_override_settings_field($display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $hidden = !(isset($display_type-&gt;settings['override_thumbnail_settings']) ? $display_type-&gt;settings['override_thumbnail_settings'] : FALSE);&nbsp;</div></li><li><div>      $override_field = $this-&gt;_render_radio_field($display_type, 'override_thumbnail_settings', __('Override thumbnail settings', 'nggallery'), isset($display_type-&gt;settings['override_thumbnail_settings']) ? $display_type-&gt;settings['override_thumbnail_settings'] : FALSE, __(&quot;This does not affect existing thumbnails; overriding the thumbnail settings will create an additional set of thumbnails. To change the size of existing thumbnails please visit 'Manage Galleries' and choose 'Create new thumbnails' for all images in the gallery.&quot;, 'nggallery'));&nbsp;</div></li><li><div>      $dimensions_field = $this-&gt;object-&gt;render_partial('photocrati-nextgen_gallery_display#thumbnail_settings', array('display_type_name' =&gt; $display_type-&gt;name, 'name' =&gt; 'thumbnail_dimensions', 'label' =&gt; __('Thumbnail dimensions', 'nggallery'), 'thumbnail_width' =&gt; isset($display_type-&gt;settings['thumbnail_width']) ? intval($display_type-&gt;settings['thumbnail_width']) : 0, 'thumbnail_height' =&gt; isset($display_type-&gt;settings['thumbnail_height']) ? intval($display_type-&gt;settings['thumbnail_height']) : 0, 'hidden' =&gt; $hidden ? 'hidden' : '', 'text' =&gt; ''), TRUE);&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      $qualities = array();</span>&nbsp;</div></li><li><div><span class="comment">      for ($i = 100; $i &gt; 40; $i -= 5) { $qualities[$i] = &quot;{$i}%&quot;; }</span>&nbsp;</div></li><li><div><span class="comment">      $quality_field = $this-&gt;_render_select_field(</span>&nbsp;</div></li><li><div><span class="comment">          $display_type, </span>&nbsp;</div></li><li><div><span class="comment">          'thumbnail_quality', </span>&nbsp;</div></li><li><div><span class="comment">          __('Thumbnail quality', 'nggallery'), </span>&nbsp;</div></li><li><div><span class="comment">          $qualities, </span>&nbsp;</div></li><li><div><span class="comment">          isset($display_type-&gt;settings['thumbnail_quality']) ? $display_type-&gt;settings['thumbnail_quality'] : 100, </span>&nbsp;</div></li><li><div><span class="comment">          '', </span>&nbsp;</div></li><li><div><span class="comment">          $hidden</span>&nbsp;</div></li><li><div><span class="comment"> );</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>      $crop_field = $this-&gt;_render_radio_field($display_type, 'thumbnail_crop', __('Thumbnail crop', 'nggallery'), isset($display_type-&gt;settings['thumbnail_crop']) ? $display_type-&gt;settings['thumbnail_crop'] : FALSE, '', $hidden);&nbsp;</div></li><li><div>      <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">      $watermark_field = $this-&gt;_render_radio_field(</span>&nbsp;</div></li><li><div><span class="comment">          $display_type, </span>&nbsp;</div></li><li><div><span class="comment">          'thumbnail_watermark', </span>&nbsp;</div></li><li><div><span class="comment">          __('Thumbnail watermark', 'nggallery'), </span>&nbsp;</div></li><li><div><span class="comment">          isset($display_type-&gt;settings['thumbnail_watermark']) ? $display_type-&gt;settings['thumbnail_watermark'] : FALSE, </span>&nbsp;</div></li><li><div><span class="comment">          '', </span>&nbsp;</div></li><li><div><span class="comment">          $hidden</span>&nbsp;</div></li><li><div><span class="comment"> );</span>&nbsp;</div></li><li><div><span class="comment">      */</span>&nbsp;</div></li><li><div>      $everything = $override_field . $dimensions_field . $crop_field;&nbsp;</div></li><li><div>      return $everything;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Renders the thumbnail override settings field(s)</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_Display_Type $display_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _render_image_override_settings_field($display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $hidden = !(isset($display_type-&gt;settings['override_image_settings']) ? $display_type-&gt;settings['override_image_settings'] : FALSE);&nbsp;</div></li><li><div>      $override_field = $this-&gt;_render_radio_field($display_type, 'override_image_settings', __('Override image settings', 'nggallery'), isset($display_type-&gt;settings['override_image_settings']) ? $display_type-&gt;settings['override_image_settings'] : 0, __('Overriding the image settings will create an additional set of images', 'nggallery'));&nbsp;</div></li><li><div>      $qualities = array();&nbsp;</div></li><li><div>      for ($i = 100; $i &gt; 40; $i -= 5) {&nbsp;</div></li><li><div>          $qualities[$i] = &quot;{$i}%&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $quality_field = $this-&gt;_render_select_field($display_type, 'image_quality', __('Image quality', 'nggallery'), $qualities, $display_type-&gt;settings['image_quality'], '', $hidden);&nbsp;</div></li><li><div>      $crop_field = $this-&gt;_render_radio_field($display_type, 'image_crop', __('Image crop', 'nggallery'), $display_type-&gt;settings['image_crop'], '', $hidden);&nbsp;</div></li><li><div>      $watermark_field = $this-&gt;_render_radio_field($display_type, 'image_watermark', __('Image watermark', 'nggallery'), $display_type-&gt;settings['image_watermark'], '', $hidden);&nbsp;</div></li><li><div>      $everything = $override_field . $quality_field . $crop_field . $watermark_field;&nbsp;</div></li><li><div>      return $everything;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Renders a field for selecting a template</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_Display_Type $display_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function _render_display_type_view_field($display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      $display_type_views = $this-&gt;get_available_display_type_views($display_type);&nbsp;</div></li><li><div>      return $this-&gt;object-&gt;_render_select_field($display_type, 'display_type_view', __('Select Template', 'nggallery'), $display_type_views, $display_type-&gt;settings['display_type_view'], '', FALSE);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Gets available templates</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param C_Display_Type $display_type</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function get_available_display_type_views($display_type)&nbsp;</div></li><li><div>  {&nbsp;</div></li><li><div>      <span class="comment">/** Set up templates array */</span>&nbsp;</div></li><li><div>      $views = array('default' =&gt; __('Default Template', 'nggallery'));&nbsp;</div></li><li><div>      <span class="comment">/** Fetch array of directories to scan */</span>&nbsp;</div></li><li><div>      $dirs = M_Gallery_Display::get_display_type_view_dirs($display_type);&nbsp;</div></li><li><div>      <span class="comment">/** Populate the views array by scanning each directory for relevant templates */</span>&nbsp;</div></li><li><div>      foreach ($dirs as $dir_name =&gt; $dir) {&nbsp;</div></li><li><div>          <span class="comment">/** Confirm directory exists */</span>&nbsp;</div></li><li><div>          if (!file_exists($dir) || !is_dir($dir)) {&nbsp;</div></li><li><div>              continue;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          <span class="comment">/** Scan for template files and create array */</span>&nbsp;</div></li><li><div>          $files = scandir($dir);&nbsp;</div></li><li><div>          $template_files = preg_grep('/^.+\\-template.php$/i', $files);&nbsp;</div></li><li><div>          $template_files = $template_files ? array_combine($template_files, $template_files) : array();&nbsp;</div></li><li><div>          <span class="comment">/** For custom templates only, append directory name placeholder */</span>&nbsp;</div></li><li><div>          foreach ($template_files as $key =&gt; $value) {&nbsp;</div></li><li><div>              if ($dir_name !== 'default') {&nbsp;</div></li><li><div>                  $template_files[$dir_name . DIRECTORY_SEPARATOR . $key] = $dir_name . DIRECTORY_SEPARATOR . $value;&nbsp;</div></li><li><div>                  unset($template_files[$key]);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $views = array_merge($views, $template_files);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $views;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>NextGEN Gallery</li><li><span></span>2.2.3</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2021 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>