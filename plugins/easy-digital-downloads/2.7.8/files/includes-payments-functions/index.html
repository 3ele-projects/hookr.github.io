<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.8" data-slug="easy-digital-downloads" data-type="file" data-id="58219"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-payments-functions | file | Easy Digital Downloads | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, easy-digital-downloads, 2.7.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=1150dc30a9eaaebff629653534605bb7' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-payments-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-payments-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-payments-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-easy-digital-downloads-2.7.8-file-includes-payments-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-payments-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to easy-digital-downloads." href="http://hookr.io/plugins/easy-digital-downloads/" class="plugin"><span property="name">easy-digital-downloads</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.8." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/" class="H_VERSION"><span property="name">2.7.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-payments-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2274"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/all/" title="All">All <span class="count badge">2274</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="1195"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/hooks/" title="Hooks">Hooks <span class="count badge">1195</span></a></li><li class="" data-id="action" data-count="469"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/actions/" title="Actions">Actions <span class="count badge">469</span></a></li><li class="" data-id="filter" data-count="726"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/filters/" title="Filters">Filters <span class="count badge">726</span></a></li><li class="" data-id="class" data-count="99"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" title="Classes">Classes <span class="count badge">99</span></a></li><li class="" data-id="constant" data-count="11"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/constants/" title="Constants">Constants <span class="count badge">11</span></a></li><li class="" data-id="function" data-count="955"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/functions/" title="Functions">Functions <span class="count badge">955</span></a></li><li class="" data-id="shortcode" data-count="14"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">14</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/payments/functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Payment Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package     EDD</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage  Payments</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright   Copyright (c) 2015, Pippin Williamson</span>&nbsp;</div></li><li><div><span class="comment"> * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( !defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves an instance of EDD_Payment for a specified ID.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.7</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed int|EDD_Payment|WP_Post $payment Payment ID, EDD_Payment object or WP_Post object.</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool                          $by_txn  Is the ID supplied as the first parameter</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed false|object EDD_Payment if a valid payment ID, false otherwise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment( $payment_or_txn_id = null, $by_txn = false ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_a( $payment_or_txn_id, 'WP_Post' ) || is_a( $payment_or_txn_id, 'EDD_Payment' ) ) {&nbsp;</div></li><li><div>      $payment_id = $payment_or_txn_id-&gt;ID;&nbsp;</div></li><li><div>  } elseif ( $by_txn ) {&nbsp;</div></li><li><div>      if ( empty( $payment_or_txn_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query = $wpdb-&gt;prepare( &quot;SELECT post_id FROM $wpdb-&gt;postmeta WHERE meta_key = '_edd_payment_transaction_id' AND meta_value = '%s'&quot;, $payment_or_txn_id );&nbsp;</div></li><li><div>      $payment_id = $wpdb-&gt;get_var( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $payment_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $payment_id = $payment_or_txn_id;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $payment_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cache_key = md5( 'edd_payment' . $payment_id );&nbsp;</div></li><li><div>  $payment = wp_cache_get( $cache_key, 'payments' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $payment ) {&nbsp;</div></li><li><div>      $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>      if ( empty( $payment-&gt;ID ) || ( ! $by_txn && (int) $payment-&gt;ID !== (int) $payment_id ) ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_cache_set( $cache_key, $payment, 'payments' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $payment;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Payments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve payments from the database.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Since 1.2, this function takes an array of arguments, instead of individual</span>&nbsp;</div></li><li><div><span class="comment"> * parameters. All of the original parameters remain, but can be passed in any</span>&nbsp;</div></li><li><div><span class="comment"> * order via the array.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * $offset = 0, $number = 20, $mode = 'live', $orderby = 'ID', $order = 'DESC', </span>&nbsp;</div></li><li><div><span class="comment"> * $user = null, $status = 'any', $meta_key = null</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * As of EDD 1.8 this simply wraps EDD_Payments_Query</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args Arguments passed to get payments</span>&nbsp;</div></li><li><div><span class="comment"> * @return object $payments Payments retrieved from the database</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payments( $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fallback to post objects to ensure backwards compatibility</span>&nbsp;</div></li><li><div>  if( ! isset( $args['output'] ) ) {&nbsp;</div></li><li><div>      $args['output'] = 'posts';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = apply_filters( 'edd_get_payments_args', $args );&nbsp;</div></li><li><div>  $payments = new EDD_Payments_Query( $args );&nbsp;</div></li><li><div>  return $payments-&gt;get_payments();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve payment by a given field</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since       2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param       string $field The field to retrieve the payment with</span>&nbsp;</div></li><li><div><span class="comment"> * @param       mixed $value The value for $field</span>&nbsp;</div></li><li><div><span class="comment"> * @return      mixed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_by( $field = '', $value = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! empty( $field ) && ! empty( $value ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch( strtolower( $field ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'id':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $payment = edd_get_payment( $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( ! $payment-&gt;ID &gt; 0 ) {&nbsp;</div></li><li><div>                  $payment = false;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'key':&nbsp;</div></li><li><div>          case 'payment_number':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $meta_key = ( 'key' == $field ) ? '_edd_payment_purchase_key' : '_edd_payment_number';&nbsp;</div></li><li><div>              $payment_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                  &quot;SELECT post_ID FROM {$wpdb-&gt;postmeta} WHERE meta_key = %s AND meta_value=%s&quot;, &nbsp;</div></li><li><div>                  $meta_key, $value&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( $payment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $payment = edd_get_payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if( ! $payment-&gt;ID &gt; 0 ) {&nbsp;</div></li><li><div>                      $payment = false;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $payment;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Insert Payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $payment_data Payment data to process</span>&nbsp;</div></li><li><div><span class="comment"> * @return int|bool Payment ID if payment is inserted, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_insert_payment( $payment_data = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $payment_data ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $resume_payment = false;&nbsp;</div></li><li><div>  $existing_payment = EDD()-&gt;session-&gt;get( 'edd_resume_payment' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $existing_payment ) ) {&nbsp;</div></li><li><div>      $payment = new EDD_Payment( $existing_payment );&nbsp;</div></li><li><div>      $resume_payment = $payment-&gt;is_recoverable();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $resume_payment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment-&gt;date = date( 'Y-m-d G:i:s', current_time( 'timestamp' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment-&gt;add_note( __( 'Payment recovery processed', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Since things could have been added/removed since we first crated this...rebuild the cart details.</span>&nbsp;</div></li><li><div>      foreach ( $payment-&gt;fees as $fee_index =&gt; $fee ) {&nbsp;</div></li><li><div>          $payment-&gt;remove_fee_by( 'index', $fee_index, true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $payment-&gt;downloads as $cart_index =&gt; $download ) {&nbsp;</div></li><li><div>          $item_args = array(&nbsp;</div></li><li><div>              'quantity' =&gt; isset( $download['quantity'] ) ? $download['quantity'] : 1, &nbsp;</div></li><li><div>              'cart_index' =&gt; $cart_index, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          $payment-&gt;remove_download( $download['id'], $item_args );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Remove any remainders of possible fees from items.</span>&nbsp;</div></li><li><div>      $payment-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $payment = new EDD_Payment();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( is_array( $payment_data['cart_details'] ) && ! empty( $payment_data['cart_details'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $payment_data['cart_details'] as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = array(&nbsp;</div></li><li><div>              'quantity' =&gt; $item['quantity'], &nbsp;</div></li><li><div>              'price_id' =&gt; isset( $item['item_number']['options']['price_id'] ) ? $item['item_number']['options']['price_id'] : null, &nbsp;</div></li><li><div>              'tax' =&gt; $item['tax'], &nbsp;</div></li><li><div>              'item_price' =&gt; isset( $item['item_price'] ) ? $item['item_price'] : $item['price'], &nbsp;</div></li><li><div>              'fees' =&gt; isset( $item['fees'] ) ? $item['fees'] : array(), &nbsp;</div></li><li><div>              'discount' =&gt; isset( $item['discount'] ) ? $item['discount'] : 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $options = isset( $item['item_number']['options'] ) ? $item['item_number']['options'] : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $payment-&gt;add_download( $item['id'], $args, $options );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment-&gt;increase_tax( edd_get_cart_fee_tax() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $gateway = ! empty( $payment_data['gateway'] ) ? $payment_data['gateway'] : '';&nbsp;</div></li><li><div>  $gateway = empty( $gateway ) && isset( $_POST['edd-gateway'] ) ? $_POST['edd-gateway'] : $gateway;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $country = ! empty( $payment_data['user_info']['address']['country'] ) ? $payment_data['user_info']['address']['country'] : false;&nbsp;</div></li><li><div>  $state = ! empty( $payment_data['user_info']['address']['state'] )   ? $payment_data['user_info']['address']['state']   : false;&nbsp;</div></li><li><div>  $zip = ! empty( $payment_data['user_info']['address']['zip'] )     ? $payment_data['user_info']['address']['zip']     : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment-&gt;status = ! empty( $payment_data['status'] ) ? $payment_data['status'] : 'pending';&nbsp;</div></li><li><div>  $payment-&gt;currency = ! empty( $payment_data['currency'] ) ? $payment_data['currency'] : edd_get_currency();&nbsp;</div></li><li><div>  $payment-&gt;user_info = $payment_data['user_info'];&nbsp;</div></li><li><div>  $payment-&gt;gateway = $gateway;&nbsp;</div></li><li><div>  $payment-&gt;user_id = $payment_data['user_info']['id'];&nbsp;</div></li><li><div>  $payment-&gt;first_name = $payment_data['user_info']['first_name'];&nbsp;</div></li><li><div>  $payment-&gt;last_name = $payment_data['user_info']['last_name'];&nbsp;</div></li><li><div>  $payment-&gt;email = $payment_data['user_info']['email'];&nbsp;</div></li><li><div>  $payment-&gt;ip = edd_get_ip();&nbsp;</div></li><li><div>  $payment-&gt;key = $payment_data['purchase_key'];&nbsp;</div></li><li><div>  $payment-&gt;mode = edd_is_test_mode() ? 'test' : 'live';&nbsp;</div></li><li><div>  $payment-&gt;parent_payment = ! empty( $payment_data['parent'] ) ? absint( $payment_data['parent'] ) : '';&nbsp;</div></li><li><div>  $payment-&gt;discounts = ! empty( $payment_data['user_info']['discount'] ) ? $payment_data['user_info']['discount'] : array();&nbsp;</div></li><li><div>  $payment-&gt;tax_rate = edd_get_cart_tax_rate( $country, $state, $zip );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $payment_data['post_date'] ) ) {&nbsp;</div></li><li><div>      $payment-&gt;date = $payment_data['post_date'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Clear the user's purchased cache</span>&nbsp;</div></li><li><div>  delete_transient( 'edd_user_' . $payment_data['user_info']['id'] . '_purchases' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_insert_payment', $payment-&gt;ID, $payment_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $payment-&gt;ID ) ) {&nbsp;</div></li><li><div>      return $payment-&gt;ID;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return false if no payment was inserted</span>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Updates a payment status.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int    $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $new_status New Payment Status (default: publish)</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool               If the payment was successfully updated</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_update_payment_status( $payment_id = 0, $new_status = 'publish' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $updated = false;&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $payment && $payment-&gt;ID &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment-&gt;status = $new_status;&nbsp;</div></li><li><div>      $updated = $payment-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $updated;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Deletes a Purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @global $edd_logs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @uses EDD_Logging::delete_logs()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID (default: 0)</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $update_customer If we should update the customer stats (default:true)</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $delete_download_logs If we should remove all file download logs associated with the payment (default:false)</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_delete_purchase( $payment_id = 0, $update_customer = true, $delete_download_logs = false ) {&nbsp;</div></li><li><div>  global $edd_logs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update sale counts and earnings for all purchased products</span>&nbsp;</div></li><li><div>  edd_undo_purchase( false, $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $amount = edd_get_payment_amount( $payment_id );&nbsp;</div></li><li><div>  $status = $payment-&gt;post_status;&nbsp;</div></li><li><div>  $customer_id = edd_get_payment_customer_id( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $customer = new EDD_Customer( $customer_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $status == 'revoked' || $status == 'publish' ) {&nbsp;</div></li><li><div>      <span class="comment">// Only decrease earnings if they haven't already been decreased (or were never increased for this payment)</span>&nbsp;</div></li><li><div>      edd_decrease_total_earnings( $amount );&nbsp;</div></li><li><div>      <span class="comment">// Clear the This Month earnings (this_monththis_month is NOT a typo)</span>&nbsp;</div></li><li><div>      delete_transient( md5( 'edd_earnings_this_monththis_month' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $customer-&gt;id && $update_customer ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Decrement the stats for the customer</span>&nbsp;</div></li><li><div>          $customer-&gt;decrease_purchase_count();&nbsp;</div></li><li><div>          $customer-&gt;decrease_value( $amount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_payment_delete', $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $customer-&gt;id && $update_customer ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Remove the payment</span> ID from the customer</span>&nbsp;</div></li><li><div>      $customer-&gt;remove_payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the payment</span>&nbsp;</div></li><li><div>  wp_delete_post( $payment_id, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove related sale log entries</span>&nbsp;</div></li><li><div>  $edd_logs-&gt;delete_logs(&nbsp;</div></li><li><div>      null, &nbsp;</div></li><li><div>      'sale', &nbsp;</div></li><li><div>      array(&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'key' =&gt; '_edd_log_payment_id', &nbsp;</div></li><li><div>              'value' =&gt; $payment_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $delete_download_logs ) {&nbsp;</div></li><li><div>      $edd_logs-&gt;delete_logs(&nbsp;</div></li><li><div>          null, &nbsp;</div></li><li><div>          'file_download', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              array(&nbsp;</div></li><li><div>                  'key' =&gt; '_edd_log_payment_id', &nbsp;</div></li><li><div>                  'value' =&gt; $payment_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_payment_deleted', $payment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Undos a purchase, including the decrease of sale and earning stats. Used for</span>&nbsp;</div></li><li><div><span class="comment"> * when refunding or deleting a purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $download_id Download (Post) ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_undo_purchase( $download_id = false, $payment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * In 2.5.7, a bug was found that $download_id was an incorrect usage. Passing it in</span>&nbsp;</div></li><li><div><span class="comment">   * now does nothing, but we're holding it in place for legacy support of the argument order.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $download_id ) ) {&nbsp;</div></li><li><div>      $download_id = false;&nbsp;</div></li><li><div>      _edd_deprected_argument( 'download_id', 'edd_undo_purchase', '2.5.7' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cart_details = $payment-&gt;cart_details;&nbsp;</div></li><li><div>  $user_info = $payment-&gt;user_info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array( $cart_details ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $cart_details as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// get the item's price</span>&nbsp;</div></li><li><div>          $amount = isset( $item['price'] ) ? $item['price'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Decrease earnings/sales and fire action once per quantity number</span>&nbsp;</div></li><li><div>          for( $i = 0; $i &lt; $item['quantity']; $i++ ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// variable priced downloads</span>&nbsp;</div></li><li><div>              if ( false === $amount && edd_has_variable_prices( $item['id'] ) ) {&nbsp;</div></li><li><div>                  $price_id = isset( $item['item_number']['options']['price_id'] ) ? $item['item_number']['options']['price_id'] : null;&nbsp;</div></li><li><div>                  $amount = ! isset( $item['price'] ) && 0 !== $item['price'] ? edd_get_price_option_amount( $item['id'], $price_id ) : $item['price'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( ! $amount ) {&nbsp;</div></li><li><div>                  <span class="comment">// This function is only used on payments with near 1.0 cart data structure</span>&nbsp;</div></li><li><div>                  $amount = edd_get_download_final_price( $item['id'], $user_info, $amount );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! empty( $item['fees'] ) ) {&nbsp;</div></li><li><div>              foreach ( $item['fees'] as $fee ) {&nbsp;</div></li><li><div>                  <span class="comment">// Only let negative fees affect the earnings</span>&nbsp;</div></li><li><div>                  if ( $fee['amount'] &gt; 0 ) {&nbsp;</div></li><li><div>                      continue;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $amount += $fee['amount'];&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $maybe_decrease_earnings = apply_filters( 'edd_decrease_earnings_on_undo', true, $payment, $item['id'] );&nbsp;</div></li><li><div>          if ( true === $maybe_decrease_earnings ) {&nbsp;</div></li><li><div>              <span class="comment">// decrease earnings</span>&nbsp;</div></li><li><div>              edd_decrease_earnings( $item['id'], $amount );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $maybe_decrease_sales = apply_filters( 'edd_decrease_sales_on_undo', true, $payment, $item['id'] );&nbsp;</div></li><li><div>          if ( true === $maybe_decrease_sales ) {&nbsp;</div></li><li><div>              <span class="comment">// decrease purchase count</span>&nbsp;</div></li><li><div>              edd_decrease_purchase_count( $item['id'], $item['quantity'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Count Payments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the total number of payments recorded.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $args List of arguments to base the payments count on</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $count Number of payments sorted by payment status</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_count_payments( $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'user' =&gt; null, &nbsp;</div></li><li><div>      'customer' =&gt; null, &nbsp;</div></li><li><div>      's' =&gt; null, &nbsp;</div></li><li><div>      'start-date' =&gt; null, &nbsp;</div></li><li><div>      'end-date' =&gt; null, &nbsp;</div></li><li><div>      'download' =&gt; null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $select = &quot;SELECT p.post_status, count( * ) AS num_posts&quot;;&nbsp;</div></li><li><div>  $join = '';&nbsp;</div></li><li><div>  $where = &quot;WHERE p.post_type = 'edd_payment'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Count payments for a specific user</span>&nbsp;</div></li><li><div>  if( ! empty( $args['user'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( is_email( $args['user'] ) )&nbsp;</div></li><li><div>          $field = 'email';&nbsp;</div></li><li><div>      elseif( is_numeric( $args['user'] ) )&nbsp;</div></li><li><div>          $field = 'id';&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $field = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $join = &quot;LEFT JOIN $wpdb-&gt;postmeta m ON (p.ID = m.post_id)&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $field ) ) {&nbsp;</div></li><li><div>          $where .= &quot;&nbsp;</div></li><li><div>              AND m.meta_key = '_edd_payment_user_{$field}'&nbsp;</div></li><li><div>              AND m.meta_value = '{$args['user']}'&quot;;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } elseif ( ! empty( $args['customer'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $join = &quot;LEFT JOIN $wpdb-&gt;postmeta m ON (p.ID = m.post_id)&quot;;&nbsp;</div></li><li><div>      $where .= &quot;&nbsp;</div></li><li><div>          AND m.meta_key = '_edd_payment_customer_id'&nbsp;</div></li><li><div>          AND m.meta_value = '{$args['customer']}'&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Count payments for a search</span>&nbsp;</div></li><li><div>  } elseif( ! empty( $args['s'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_email( $args['s'] ) || strlen( $args['s'] ) == 32 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( is_email( $args['s'] ) )&nbsp;</div></li><li><div>              $field = '_edd_payment_user_email';&nbsp;</div></li><li><div>          else&nbsp;</div></li><li><div>              $field = '_edd_payment_purchase_key';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $join = &quot;LEFT JOIN $wpdb-&gt;postmeta m ON (p.ID = m.post_id)&quot;;&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>              AND m.meta_key = %s&nbsp;</div></li><li><div>              AND m.meta_value = %s&quot;, &nbsp;</div></li><li><div>              $field, &nbsp;</div></li><li><div>              $args['s']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( '#' == substr( $args['s'], 0, 1 ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $search = str_replace( '#:', '', $args['s'] );&nbsp;</div></li><li><div>          $search = str_replace( '#', '', $search );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $select = &quot;SELECT p2.post_status, count( * ) AS num_posts &quot;;&nbsp;</div></li><li><div>          $join = &quot;LEFT JOIN $wpdb-&gt;postmeta m ON m.meta_key = '_edd_log_payment_id' AND m.post_id = p.ID &quot;;&nbsp;</div></li><li><div>          $join  .= &quot;INNER JOIN $wpdb-&gt;posts p2 ON m.meta_value = p2.ID &quot;;&nbsp;</div></li><li><div>          $where = &quot;WHERE p.post_type = 'edd_log' &quot;;&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot;AND p.post_parent = %d} &quot;, $search );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( is_numeric( $args['s'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $join = &quot;LEFT JOIN $wpdb-&gt;postmeta m ON (p.ID = m.post_id)&quot;;&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>              AND m.meta_key = '_edd_payment_user_id'&nbsp;</div></li><li><div>              AND m.meta_value = %d&quot;, &nbsp;</div></li><li><div>              $args['s']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( 0 === strpos( $args['s'], 'discount:' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $search = str_replace( 'discount:', '', $args['s'] );&nbsp;</div></li><li><div>          $search = 'discount.*' . $search;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $join = &quot;LEFT JOIN $wpdb-&gt;postmeta m ON (p.ID = m.post_id)&quot;;&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot;&nbsp;</div></li><li><div>              AND m.meta_key = '_edd_payment_meta'&nbsp;</div></li><li><div>              AND m.meta_value REGEXP %s&quot;, &nbsp;</div></li><li><div>              $search&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $search = $wpdb-&gt;esc_like( $args['s'] );&nbsp;</div></li><li><div>          $search = '%' . $search . '%';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot;AND ((p.post_title LIKE %s) OR (p.post_content LIKE %s))&quot;, $search, $search );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $args['download'] ) && is_numeric( $args['download'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $where .= $wpdb-&gt;prepare( &quot; AND p.post_parent = %d&quot;, $args['download'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Limit payments count by date</span>&nbsp;</div></li><li><div>  if ( ! empty( $args['start-date'] ) && false !== strpos( $args['start-date'], '/' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $date_parts = explode( '/', $args['start-date'] );&nbsp;</div></li><li><div>      $month = ! empty( $date_parts[0] ) && is_numeric( $date_parts[0] ) ? $date_parts[0] : 0;&nbsp;</div></li><li><div>      $day = ! empty( $date_parts[1] ) && is_numeric( $date_parts[1] ) ? $date_parts[1] : 0;&nbsp;</div></li><li><div>      $year = ! empty( $date_parts[2] ) && is_numeric( $date_parts[2] ) ? $date_parts[2] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_date = checkdate( $month, $day, $year );&nbsp;</div></li><li><div>      if ( false !== $is_date ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $date = new DateTime( $args['start-date'] );&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot; AND p.post_date &gt;= '%s'&quot;, $date-&gt;format( 'Y-m-d' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fixes an issue with the payments list table counts when no end date is specified (partly with stats class)</span>&nbsp;</div></li><li><div>      if ( empty( $args['end-date'] ) ) {&nbsp;</div></li><li><div>          $args['end-date'] = $args['start-date'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty ( $args['end-date'] ) && false !== strpos( $args['end-date'], '/' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $date_parts = explode( '/', $args['end-date'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $month = ! empty( $date_parts[0] ) ? $date_parts[0] : 0;&nbsp;</div></li><li><div>      $day = ! empty( $date_parts[1] ) ? $date_parts[1] : 0;&nbsp;</div></li><li><div>      $year = ! empty( $date_parts[2] ) ? $date_parts[2] : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $is_date = checkdate( $month, $day, $year );&nbsp;</div></li><li><div>      if ( false !== $is_date ) {&nbsp;</div></li><li><div>          $date = date( 'Y-m-d', strtotime( '+1 day', mktime( 0, 0, 0, $month, $day, $year ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $where .= $wpdb-&gt;prepare( &quot; AND p.post_date &lt; '%s'&quot;, $date );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $where = apply_filters( 'edd_count_payments_where', $where );&nbsp;</div></li><li><div>  $join = apply_filters( 'edd_count_payments_join', $join );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $query = &quot;$select&nbsp;</div></li><li><div>      FROM $wpdb-&gt;posts p&nbsp;</div></li><li><div>      $join&nbsp;</div></li><li><div>      $where&nbsp;</div></li><li><div>      GROUP BY p.post_status&nbsp;</div></li><li><div>  &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cache_key = md5( $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = wp_cache_get( $cache_key, 'counts');&nbsp;</div></li><li><div>  if ( false !== $count ) {&nbsp;</div></li><li><div>      return $count;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = $wpdb-&gt;get_results( $query, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = array();&nbsp;</div></li><li><div>  $statuses = get_post_stati();&nbsp;</div></li><li><div>  if( isset( $statuses['private'] ) && empty( $args['s'] ) ) {&nbsp;</div></li><li><div>      unset( $statuses['private'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $statuses as $state ) {&nbsp;</div></li><li><div>      $stats[$state] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( (array) $count as $row ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'private' == $row['post_status'] && empty( $args['s'] ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stats[$row['post_status']] = $row['num_posts'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = (object) $stats;&nbsp;</div></li><li><div>  wp_cache_set( $cache_key, $stats, 'counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $stats;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check For Existing Payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool true if payment exists, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_check_for_existing_payment( $payment_id ) {&nbsp;</div></li><li><div>  $exists = false;&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $payment_id === $payment-&gt;ID && 'publish' === $payment-&gt;status ) {&nbsp;</div></li><li><div>      $exists = true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $exists;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Payment Status</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param mixed  WP_Post|EDD_Payment|Payment ID $payment Payment post object, EDD_Payment object, or payment/post ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool   $return_label Whether to return the payment status or not</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|mixed if payment status exists, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_status( $payment, $return_label = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( is_numeric( $payment ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment = new EDD_Payment( $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! $payment-&gt;ID &gt; 0 ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_object( $payment ) || ! isset( $payment-&gt;post_status ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $statuses = edd_get_payment_statuses();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $statuses ) || empty( $statuses ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( array_key_exists( $payment-&gt;status, $statuses ) ) {&nbsp;</div></li><li><div>      if ( true === $return_label ) {&nbsp;</div></li><li><div>          return $statuses[ $payment-&gt;status ];&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Account that our 'publish' status is labeled 'Complete'</span>&nbsp;</div></li><li><div>          $post_status = 'publish' == $payment-&gt;status ? 'Complete' : $payment-&gt;post_status;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Make sure we're matching cases, since they matter</span>&nbsp;</div></li><li><div>          return array_search( strtolower( $post_status ), array_map( 'strtolower', $statuses ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return false;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves all available statuses for payments.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $payment_status All the available payment statuses</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_statuses() {&nbsp;</div></li><li><div>  $payment_statuses = array(&nbsp;</div></li><li><div>      'pending' =&gt; __( 'Pending', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>      'publish' =&gt; __( 'Complete', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>      'refunded' =&gt; __( 'Refunded', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>      'failed' =&gt; __( 'Failed', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>      'abandoned' =&gt; __( 'Abandoned', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>      'revoked' =&gt; __( 'Revoked', 'easy-digital-downloads' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_payment_statuses', $payment_statuses );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves keys for all available statuses for payments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.3</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $payment_status All the available payment statuses</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_status_keys() {&nbsp;</div></li><li><div>  $statuses = array_keys( edd_get_payment_statuses() );&nbsp;</div></li><li><div>  asort( $statuses );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return array_values( $statuses );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Checks whether a payment has been marked as complete.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID to check against</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool true if complete, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_is_payment_complete( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ret = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $payment-&gt;ID &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( (int) $payment_id === (int) $payment-&gt;ID && 'publish' == $payment-&gt;status ) {&nbsp;</div></li><li><div>          $ret = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_is_payment_complete', $ret, $payment_id, $payment-&gt;post_status );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Total Sales</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @return int $count Total sales</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_total_sales() {&nbsp;</div></li><li><div>  $payments = edd_count_payments();&nbsp;</div></li><li><div>  return $payments-&gt;revoked + $payments-&gt;publish;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Total Earnings</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @return float $total Total earnings</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_total_earnings() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $total = get_option( 'edd_earnings_total', false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If no total stored in DB, use old method of calculating total earnings</span>&nbsp;</div></li><li><div>  if( false === $total ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $total = get_transient( 'edd_earnings_total' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( false === $total ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $total = (float) 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $args = apply_filters( 'edd_get_total_earnings_args', array(&nbsp;</div></li><li><div>              'offset' =&gt; 0, &nbsp;</div></li><li><div>              'number' =&gt; -1, &nbsp;</div></li><li><div>              'status' =&gt; array( 'publish', 'revoked' ), &nbsp;</div></li><li><div>              'fields' =&gt; 'ids'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $payments = edd_get_payments( $args );&nbsp;</div></li><li><div>          if ( $payments ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">               * If performing a purchase, we need to skip the very last payment in the database, since it calls</span>&nbsp;</div></li><li><div><span class="comment">               * edd_increase_total_earnings() on completion, which results in duplicated earnings for the very</span>&nbsp;</div></li><li><div><span class="comment">               * first purchase</span>&nbsp;</div></li><li><div><span class="comment">               */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( did_action( 'edd_update_payment_status' ) ) {&nbsp;</div></li><li><div>                  array_pop( $payments );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( ! empty( $payments ) ) {&nbsp;</div></li><li><div>                  $payments = implode( ', ', $payments );&nbsp;</div></li><li><div>                  $total += $wpdb-&gt;get_var( &quot;SELECT SUM(meta_value) FROM $wpdb-&gt;postmeta WHERE meta_key = '_edd_payment_total' AND post_id IN({$payments})&quot; );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Cache results for 1 day. This cache is cleared automatically when a payment is made</span>&nbsp;</div></li><li><div>          set_transient( 'edd_earnings_total', $total, 86400 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Store the total for the first time</span>&nbsp;</div></li><li><div>          update_option( 'edd_earnings_total', $total );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $total &lt; 0 ) {&nbsp;</div></li><li><div>      $total = 0; <span class="comment">// Don't ever show negative earnings</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_total_earnings', round( $total, edd_currency_decimal_filter() ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Increase the Total Earnings</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param $amount int The amount you would like to increase the total earnings by.</span>&nbsp;</div></li><li><div><span class="comment"> * @return float $total Total earnings</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_increase_total_earnings( $amount = 0 ) {&nbsp;</div></li><li><div>  $total = edd_get_total_earnings();&nbsp;</div></li><li><div>  $total += $amount;&nbsp;</div></li><li><div>  update_option( 'edd_earnings_total', $total );&nbsp;</div></li><li><div>  return $total;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Decrease the Total Earnings</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.8.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param $amount int The amount you would like to decrease the total earnings by.</span>&nbsp;</div></li><li><div><span class="comment"> * @return float $total Total earnings</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_decrease_total_earnings( $amount = 0 ) {&nbsp;</div></li><li><div>  $total = edd_get_total_earnings();&nbsp;</div></li><li><div>  $total -= $amount;&nbsp;</div></li><li><div>  if( $total &lt; 0 ) {&nbsp;</div></li><li><div>      $total = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  update_option( 'edd_earnings_total', $total );&nbsp;</div></li><li><div>  return $total;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Payment Meta for a specific Payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $meta_key The meta key to pull</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $single Pull single meta entry or as an object</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed $meta Payment Meta</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_meta( $payment_id = 0, $meta_key = '_edd_payment_meta', $single = true ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;get_meta( $meta_key, $single );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Update the meta for a payment</span>&nbsp;</div></li><li><div><span class="comment"> * @param  integer $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string  $meta_key   Meta key to update</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string  $meta_value Value to update to</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string  $prev_value Previous value</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed               Meta ID if successful, false if unsuccessful</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_update_payment_meta( $payment_id = 0, $meta_key = '', $meta_value = '', $prev_value = '' ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;update_meta( $meta_key, $meta_value, $prev_value );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the user_info Key from Payment Meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $user_info User Info Meta Values</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_meta_user_info( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;user_info;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the downloads Key from Payment Meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $downloads Downloads Meta Values</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_meta_downloads( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;downloads;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the cart_details Key from Payment Meta</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $include_bundle_files Whether to retrieve product IDs associated with a bundled product and return them in the array</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $cart_details Cart Details Meta Values</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_meta_cart_details( $payment_id, $include_bundle_files = false ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  $cart_details = $payment-&gt;cart_details;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment_currency = $payment-&gt;currency;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $cart_details ) && is_array( $cart_details ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $cart_details as $key =&gt; $cart_item ) {&nbsp;</div></li><li><div>          $cart_details[ $key ]['currency'] = $payment_currency;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Ensure subtotal is set, for pre-1.9 orders</span>&nbsp;</div></li><li><div>          if ( ! isset( $cart_item['subtotal'] ) ) {&nbsp;</div></li><li><div>              $cart_details[ $key ]['subtotal'] = $cart_item['price'];&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( $include_bundle_files ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( 'bundle' != edd_get_download_type( $cart_item['id'] ) )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $products = edd_get_bundled_products( $cart_item['id'] );&nbsp;</div></li><li><div>              if ( empty( $products ) )&nbsp;</div></li><li><div>                  continue;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              foreach ( $products as $product_id ) {&nbsp;</div></li><li><div>                  $cart_details[] = array(&nbsp;</div></li><li><div>                      'id' =&gt; $product_id, &nbsp;</div></li><li><div>                      'name' =&gt; get_the_title( $product_id ), &nbsp;</div></li><li><div>                      'item_number' =&gt; array(&nbsp;</div></li><li><div>                          'id' =&gt; $product_id, &nbsp;</div></li><li><div>                          'options' =&gt; array(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                      'price' =&gt; 0, &nbsp;</div></li><li><div>                      'subtotal' =&gt; 0, &nbsp;</div></li><li><div>                      'quantity' =&gt; 1, &nbsp;</div></li><li><div>                      'tax' =&gt; 0, &nbsp;</div></li><li><div>                      'in_bundle' =&gt; 1, &nbsp;</div></li><li><div>                      'parent' =&gt; array(&nbsp;</div></li><li><div>                          'id' =&gt; $cart_item['id'], &nbsp;</div></li><li><div>                          'options' =&gt; isset( $cart_item['item_number']['options'] ) ? $cart_item['item_number']['options'] : array()&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_payment_meta_cart_details', $cart_details, $payment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the user email associated with a payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $email User Email</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_user_email( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;email;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Is the payment provided associated with a user account</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $payment_id The payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool            If the payment is associated with a user (false) or not (true)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_is_guest_payment( $payment_id ) {&nbsp;</div></li><li><div>  $payment_user_id = edd_get_payment_user_id( $payment_id );&nbsp;</div></li><li><div>  $is_guest_payment = ! empty( $payment_user_id ) && $payment_user_id &gt; 0 ? false : true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'edd_is_guest_payment', $is_guest_payment, $payment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the user ID associated with a payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $user_id User ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_user_id( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the customer ID associated with a payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $customer_id Customer ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_customer_id( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;customer_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the status of the unlimited downloads flag</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool $unlimited</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_payment_has_unlimited_downloads( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;has_unlimited_downloads;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the IP address used to make a purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $ip User IP</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_user_ip( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;ip;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the date a payment was completed</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $date The date the payment was completed</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_completed_date( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;completed_date;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the gateway associated with a payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $gateway Gateway</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_gateway( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;gateway;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the currency code a payment was made in</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $currency The currency code</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_currency_code( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;currency;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the currency name a payment was made in</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $currency The currency name</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_currency( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $currency = edd_get_payment_currency_code( $payment_id );&nbsp;</div></li><li><div>  return apply_filters( 'edd_payment_currency', edd_get_currency_name( $currency ), $payment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the purchase key for a purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $key Purchase key</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_key( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;key;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the payment order number</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This will return the payment ID if sequential order numbers are not enabled or the order number does not exist</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $number Payment order number</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_number( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;number;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Formats the payment number with the prefix and postfix</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $number The payment number to format</span>&nbsp;</div></li><li><div><span class="comment"> * @return string      The formatted payment number</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_format_payment_number( $number ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! edd_get_option( 'enable_sequential' ) ) {&nbsp;</div></li><li><div>      return $number;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_numeric( $number ) ) {&nbsp;</div></li><li><div>      return $number;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $prefix = edd_get_option( 'sequential_prefix' );&nbsp;</div></li><li><div>  $number = absint( $number );&nbsp;</div></li><li><div>  $postfix = edd_get_option( 'sequential_postfix' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $formatted_number = $prefix . $number . $postfix;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_format_payment_number', $formatted_number, $prefix, $number, $postfix );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the next available order number</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is used when inserting a new payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $number The next available payment number</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_next_payment_number() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! edd_get_option( 'enable_sequential' ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $number = get_option( 'edd_last_payment_number' );&nbsp;</div></li><li><div>  $start = edd_get_option( 'sequential_start', 1 );&nbsp;</div></li><li><div>  $increment_number = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== $number ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $number ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $number = $start;&nbsp;</div></li><li><div>          $increment_number = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This case handles the first addition of the new option, as well as if it get's deleted for any reason</span>&nbsp;</div></li><li><div>      $payments = new EDD_Payments_Query( array( 'number' =&gt; 1, 'order' =&gt; 'DESC', 'orderby' =&gt; 'ID', 'output' =&gt; 'posts', 'fields' =&gt; 'ids' ) );&nbsp;</div></li><li><div>      $last_payment = $payments-&gt;get_payments();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $last_payment ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $number = edd_get_payment_number( $last_payment[0] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! empty( $number ) && $number !== (int) $last_payment[0] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $number = edd_remove_payment_prefix_postfix( $number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $number = $start;&nbsp;</div></li><li><div>          $increment_number = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $increment_number = apply_filters( 'edd_increment_payment_number', $increment_number, $number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $increment_number ) {&nbsp;</div></li><li><div>      $number++;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_get_next_payment_number', $number );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Given a given a number, remove the pre/postfix</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $number  The formatted Current Number to increment</span>&nbsp;</div></li><li><div><span class="comment"> * @return string          The new Payment number without prefix and postfix</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_remove_payment_prefix_postfix( $number ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $prefix = edd_get_option( 'sequential_prefix' );&nbsp;</div></li><li><div>  $postfix = edd_get_option( 'sequential_postfix' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove prefix</span>&nbsp;</div></li><li><div>  $number = preg_replace( '/' . $prefix . '/', '', $number, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Remove the postfix</span>&nbsp;</div></li><li><div>  $length = strlen( $number );&nbsp;</div></li><li><div>  $postfix_pos = strrpos( $number, $postfix );&nbsp;</div></li><li><div>  if ( false !== $postfix_pos ) {&nbsp;</div></li><li><div>      $number = substr_replace( $number, '', $postfix_pos, $length );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Ensure it's a whole number</span>&nbsp;</div></li><li><div>  $number = intval( $number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_remove_payment_prefix_postfix', $number, $prefix, $postfix );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the fully formatted payment amount. The payment amount is retrieved using</span>&nbsp;</div></li><li><div><span class="comment"> * edd_get_payment_amount() and is then sent through edd_currency_filter() and</span>&nbsp;</div></li><li><div><span class="comment"> * edd_format_amount() to format the amount correctly.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $amount Fully formatted payment amount</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_payment_amount( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $amount = edd_get_payment_amount( $payment_id );&nbsp;</div></li><li><div>  return edd_currency_filter( edd_format_amount( $amount ), edd_get_payment_currency_code( $payment_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get the amount associated with a payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return float Payment amount</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_amount( $payment_id ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_payment_amount', floatval( $payment-&gt;total ), $payment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves subtotal for payment (this is the amount before taxes) and then</span>&nbsp;</div></li><li><div><span class="comment"> * returns a full formatted amount. This function essentially calls</span>&nbsp;</div></li><li><div><span class="comment"> * edd_get_payment_subtotal()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.3</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @see edd_get_payment_subtotal()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Fully formatted payment subtotal</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_payment_subtotal( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $subtotal = edd_get_payment_subtotal( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return edd_currency_filter( edd_format_amount( $subtotal ), edd_get_payment_currency_code( $payment_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves subtotal for payment (this is the amount before taxes) and then</span>&nbsp;</div></li><li><div><span class="comment"> * returns a non formatted amount.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.3</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return float $subtotal Subtotal for payment (non formatted)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_subtotal( $payment_id = 0) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $payment-&gt;subtotal;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves taxed amount for payment and then returns a full formatted amount</span>&nbsp;</div></li><li><div><span class="comment"> * This function essentially calls edd_get_payment_tax()</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.3</span>&nbsp;</div></li><li><div><span class="comment"> * @see edd_get_payment_tax()</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $payment_meta Payment Meta provided? (default: false)</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $subtotal Fully formatted payment subtotal</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_payment_tax( $payment_id = 0, $payment_meta = false ) {&nbsp;</div></li><li><div>  $tax = edd_get_payment_tax( $payment_id, $payment_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return edd_currency_filter( edd_format_amount( $tax ), edd_get_payment_currency_code( $payment_id ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves taxed amount for payment and then returns a non formatted amount</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.3</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool $payment_meta Get payment meta?</span>&nbsp;</div></li><li><div><span class="comment"> * @return float $tax Tax for payment (non formatted)</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_tax( $payment_id = 0, $payment_meta = false ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $payment-&gt;tax;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the tax for a cart item by the cart key</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.5</span>&nbsp;</div></li><li><div><span class="comment"> * @param  integer $payment_id The Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int     $cart_key   The cart key</span>&nbsp;</div></li><li><div><span class="comment"> * @return float               The item tax amount</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_item_tax( $payment_id = 0, $cart_key = false ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  $item_tax = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $cart_details = $payment-&gt;cart_details;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== $cart_key && ! empty( $cart_details ) && array_key_exists( $cart_key, $cart_details ) ) {&nbsp;</div></li><li><div>      $item_tax = ! empty( $cart_details[ $cart_key ]['tax'] ) ? $cart_details[ $cart_key ]['tax'] : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $item_tax;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves arbitrary fees for the payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $type Fee type</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed array if payment fees found, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_fees( $payment_id = 0, $type = 'all' ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;get_fees( $type );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the transaction ID for the given payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The Transaction ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_transaction_id( $payment_id = 0 ) {&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  return $payment-&gt;transaction_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sets a Transaction ID in post meta for the given Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $transaction_id The transaction ID from the gateway</span>&nbsp;</div></li><li><div><span class="comment"> * @return mixed Meta ID if successful, false if unsuccessful</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_set_payment_transaction_id( $payment_id = 0, $transaction_id = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $payment_id ) || empty( $transaction_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $transaction_id = apply_filters( 'edd_set_payment_transaction_id', $transaction_id, $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return edd_update_payment_meta( $payment_id, '_edd_payment_transaction_id', $transaction_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the purchase ID based on the purchase key</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.2</span>&nbsp;</div></li><li><div><span class="comment"> * @global object $wpdb Used to query the database using the WordPress</span>&nbsp;</div></li><li><div><span class="comment"> *   Database API</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key the purchase key to search for</span>&nbsp;</div></li><li><div><span class="comment"> * @return int $purchase Purchase ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_purchase_id_by_key( $key ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $purchase = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT post_id FROM $wpdb-&gt;postmeta WHERE meta_key = '_edd_payment_purchase_key' AND meta_value = %s LIMIT 1&quot;, $key ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $purchase != NULL )&nbsp;</div></li><li><div>      return $purchase;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve the purchase ID based on the transaction ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4</span>&nbsp;</div></li><li><div><span class="comment"> * @global object $wpdb Used to query the database using the WordPress</span>&nbsp;</div></li><li><div><span class="comment"> *   Database API</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $key the transaction ID to search for</span>&nbsp;</div></li><li><div><span class="comment"> * @return int $purchase Purchase ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_purchase_id_by_transaction_id( $key ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $purchase = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT post_id FROM $wpdb-&gt;postmeta WHERE meta_key = '_edd_payment_transaction_id' AND meta_value = %s LIMIT 1&quot;, $key ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $purchase != NULL )&nbsp;</div></li><li><div>      return $purchase;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieve all notes attached to a purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id The payment ID to retrieve notes for</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $search Search for notes that contain a search term</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $notes Payment Notes</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_notes( $payment_id = 0, $search = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $payment_id ) && empty( $search ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  remove_action( 'pre_get_comments', 'edd_hide_payment_notes', 10 );&nbsp;</div></li><li><div>  remove_filter( 'comments_clauses', 'edd_hide_payment_notes_pre_41', 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $notes = get_comments( array( 'post_id' =&gt; $payment_id, 'order' =&gt; 'ASC', 'search' =&gt; $search ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  add_action( 'pre_get_comments', 'edd_hide_payment_notes', 10 );&nbsp;</div></li><li><div>  add_filter( 'comments_clauses', 'edd_hide_payment_notes_pre_41', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $notes;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Add a note to a payment</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id The payment ID to store a note for</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $note The note to store</span>&nbsp;</div></li><li><div><span class="comment"> * @return int The new note ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_insert_payment_note( $payment_id = 0, $note = '' ) {&nbsp;</div></li><li><div>  if ( empty( $payment_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_pre_insert_payment_note', $payment_id, $note );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $note_id = wp_insert_comment( wp_filter_comment( array(&nbsp;</div></li><li><div>      'comment_post_ID' =&gt; $payment_id, &nbsp;</div></li><li><div>      'comment_content' =&gt; $note, &nbsp;</div></li><li><div>      'user_id' =&gt; is_admin() ? get_current_user_id() : 0, &nbsp;</div></li><li><div>      'comment_date' =&gt; current_time( 'mysql' ), &nbsp;</div></li><li><div>      'comment_date_gmt' =&gt; current_time( 'mysql', 1 ), &nbsp;</div></li><li><div>      'comment_approved' =&gt; 1, &nbsp;</div></li><li><div>      'comment_parent' =&gt; 0, &nbsp;</div></li><li><div>      'comment_author' =&gt; '', &nbsp;</div></li><li><div>      'comment_author_IP' =&gt; '', &nbsp;</div></li><li><div>      'comment_author_url' =&gt; '', &nbsp;</div></li><li><div>      'comment_author_email' =&gt; '', &nbsp;</div></li><li><div>      'comment_type' =&gt; 'edd_payment_note'&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_insert_payment_note', $note_id, $payment_id, $note );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $note_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Deletes a payment note</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $comment_id The comment ID to delete</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id The payment ID the note is connected to</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool True on success, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_delete_payment_note( $comment_id = 0, $payment_id = 0 ) {&nbsp;</div></li><li><div>  if( empty( $comment_id ) )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_pre_delete_payment_note', $comment_id, $payment_id );&nbsp;</div></li><li><div>  $ret = wp_delete_comment( $comment_id, true );&nbsp;</div></li><li><div>  do_action( 'edd_post_delete_payment_note', $comment_id, $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $ret;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the payment note HTML</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9</span>&nbsp;</div></li><li><div><span class="comment"> * @param object|int $note The comment object or ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id The payment ID the note is connected to</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_payment_note_html( $note, $payment_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( is_numeric( $note ) ) {&nbsp;</div></li><li><div>      $note = get_comment( $note );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $note-&gt;user_id ) ) {&nbsp;</div></li><li><div>      $user = get_userdata( $note-&gt;user_id );&nbsp;</div></li><li><div>      $user = $user-&gt;display_name;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $user = __( 'EDD Bot', 'easy-digital-downloads' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $date_format = get_option( 'date_format' ) . ', ' . get_option( 'time_format' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $delete_note_url = wp_nonce_url( add_query_arg( array(&nbsp;</div></li><li><div>      'edd-action' =&gt; 'delete_payment_note', &nbsp;</div></li><li><div>      'note_id' =&gt; $note-&gt;comment_ID, &nbsp;</div></li><li><div>      'payment_id' =&gt; $payment_id&nbsp;</div></li><li><div> ) ), 'edd_delete_payment_note_' . $note-&gt;comment_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $note_html = '&lt;div class=&quot;edd-payment-note&quot; id=&quot;edd-payment-note-' . $note-&gt;comment_ID . '&quot;&gt;';&nbsp;</div></li><li><div>      $note_html .='&lt;p&gt;';&nbsp;</div></li><li><div>          $note_html .= '&lt;strong&gt;' . $user . '&lt;/strong&gt;&nbsp;&ndash;&nbsp;' . date_i18n( $date_format, strtotime( $note-&gt;comment_date ) ) . '&lt;br/&gt;';&nbsp;</div></li><li><div>          $note_html .= $note-&gt;comment_content;&nbsp;</div></li><li><div>          $note_html .= '&nbsp;&ndash;&nbsp;&lt;a href=&quot;' . esc_url( $delete_note_url ) . '&quot; class=&quot;edd-delete-payment-note&quot; data-note-id=&quot;' . absint( $note-&gt;comment_ID ) . '&quot; data-payment-id=&quot;' . absint( $payment_id ) . '&quot;&gt;' . __( 'Delete', 'easy-digital-downloads' ) . '&lt;/a&gt;';&nbsp;</div></li><li><div>      $note_html .= '&lt;/p&gt;';&nbsp;</div></li><li><div>  $note_html .= '&lt;/div&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $note_html;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Exclude notes (comments) on edd_payment post type from showing in Recent</span>&nbsp;</div></li><li><div><span class="comment"> * Comments widgets</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.4.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param obj $query WordPress Comment Query Object</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_hide_payment_notes( $query ) {&nbsp;</div></li><li><div>  global $wp_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( version_compare( floatval( $wp_version ), '4.1', '&gt;=' ) ) {&nbsp;</div></li><li><div>      $types = isset( $query-&gt;query_vars['type__not_in'] ) ? $query-&gt;query_vars['type__not_in'] : array();&nbsp;</div></li><li><div>      if( ! is_array( $types ) ) {&nbsp;</div></li><li><div>          $types = array( $types );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $types[] = 'edd_payment_note';&nbsp;</div></li><li><div>      $query-&gt;query_vars['type__not_in'] = $types;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'pre_get_comments', 'edd_hide_payment_notes', 10 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Exclude notes (comments) on edd_payment post type from showing in Recent</span>&nbsp;</div></li><li><div><span class="comment"> * Comments widgets</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $clauses Comment clauses for comment query</span>&nbsp;</div></li><li><div><span class="comment"> * @param obj $wp_comment_query WordPress Comment Query Object</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $clauses Updated comment clauses</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_hide_payment_notes_pre_41( $clauses, $wp_comment_query ) {&nbsp;</div></li><li><div>  global $wpdb, $wp_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( version_compare( floatval( $wp_version ), '4.1', '&lt;' ) ) {&nbsp;</div></li><li><div>      $clauses['where'] .= ' AND comment_type != &quot;edd_payment_note&quot;';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $clauses;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'comments_clauses', 'edd_hide_payment_notes_pre_41', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Exclude notes (comments) on edd_payment post type from showing in comment feeds</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $where</span>&nbsp;</div></li><li><div><span class="comment"> * @param obj $wp_comment_query WordPress Comment Query Object</span>&nbsp;</div></li><li><div><span class="comment"> * @return array $where</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_hide_payment_notes_from_feeds( $where, $wp_comment_query ) {&nbsp;</div></li><li><div>  global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $where .= $wpdb-&gt;prepare( &quot; AND comment_type != %s&quot;, 'edd_payment_note' );&nbsp;</div></li><li><div>  return $where;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'comment_feed_where', 'edd_hide_payment_notes_from_feeds', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Remove EDD Comments from the wp_count_comments function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.5.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $stats (empty from core filter)</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $post_id Post ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return array Array of comment counts</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function edd_remove_payment_notes_in_comment_counts( $stats, $post_id ) {&nbsp;</div></li><li><div>  global $wpdb, $pagenow;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $array_excluded_pages = array( 'index.php', 'edit-comments.php' );&nbsp;</div></li><li><div>  if( ! in_array( $pagenow, $array_excluded_pages ) ) {&nbsp;</div></li><li><div>      return $stats;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $post_id = (int) $post_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( apply_filters( 'edd_count_payment_notes_in_comments', false ) )&nbsp;</div></li><li><div>      return $stats;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = wp_cache_get( &quot;comments-{$post_id}&quot;, 'counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false !== $stats )&nbsp;</div></li><li><div>      return $stats;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $where = 'WHERE comment_type != &quot;edd_payment_note&quot;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $post_id &gt; 0 )&nbsp;</div></li><li><div>      $where .= $wpdb-&gt;prepare( &quot; AND comment_post_ID = %d&quot;, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $count = $wpdb-&gt;get_results( &quot;SELECT comment_approved, COUNT( * ) AS num_comments FROM {$wpdb-&gt;comments} {$where} GROUP BY comment_approved&quot;, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $total = 0;&nbsp;</div></li><li><div>  $approved = array( '0' =&gt; 'moderated', '1' =&gt; 'approved', 'spam' =&gt; 'spam', 'trash' =&gt; 'trash', 'post-trashed' =&gt; 'post-trashed' );&nbsp;</div></li><li><div>  foreach ( (array) $count as $row ) {&nbsp;</div></li><li><div>      <span class="comment">// Don't count post-trashed toward totals</span>&nbsp;</div></li><li><div>      if ( 'post-trashed' != $row['comment_approved'] && 'trash' != $row['comment_approved'] )&nbsp;</div></li><li><div>          $total += $row['num_comments'];&nbsp;</div></li><li><div>      if ( isset( $approved[$row['comment_approved']] ) )&nbsp;</div></li><li><div>          $stats[$approved[$row['comment_approved']]] = $row['num_comments'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats['total_comments'] = $total;&nbsp;</div></li><li><div>  foreach ( $approved as $key ) {&nbsp;</div></li><li><div>      if ( empty($stats[$key]) )&nbsp;</div></li><li><div>          $stats[$key] = 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = (object) $stats;&nbsp;</div></li><li><div>  wp_cache_set( &quot;comments-{$post_id}&quot;, $stats, 'counts' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $stats;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'wp_count_comments', 'edd_remove_payment_notes_in_comment_counts', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Filter where older than one week</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $where Where clause</span>&nbsp;</div></li><li><div><span class="comment"> * @return string $where Modified where clause</span>&nbsp;</div></li><li><div><span class="comment">*/</span>&nbsp;</div></li><li><div>function edd_filter_where_older_than_week( $where = '' ) {&nbsp;</div></li><li><div>  <span class="comment">// Payments older than one week</span>&nbsp;</div></li><li><div>  $start = date( 'Y-m-d', strtotime( '-7 days' ) );&nbsp;</div></li><li><div>  $where .= &quot; AND post_date &lt;= '{$start}'&quot;;&nbsp;</div></li><li><div>  return $where;&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Easy Digital Downloads</li><li><span></span>2.7.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>