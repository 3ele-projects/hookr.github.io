<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.8" data-slug="easy-digital-downloads" data-type="file" data-id="58228"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-user-functions | file | Easy Digital Downloads | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, easy-digital-downloads, 2.7.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=ae8876d15e53a9a41e2a809fdb868c98' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-user-functions/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-user-functions%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-user-functions%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-easy-digital-downloads-2.7.8-file-includes-user-functions","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-user-functions" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to easy-digital-downloads." href="http://hookr.io/plugins/easy-digital-downloads/" class="plugin"><span property="name">easy-digital-downloads</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.8." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/" class="H_VERSION"><span property="name">2.7.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-user-functions</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2274"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/all/" title="All">All <span class="count badge">2274</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="1195"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/hooks/" title="Hooks">Hooks <span class="count badge">1195</span></a></li><li class="" data-id="action" data-count="469"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/actions/" title="Actions">Actions <span class="count badge">469</span></a></li><li class="" data-id="filter" data-count="726"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/filters/" title="Filters">Filters <span class="count badge">726</span></a></li><li class="" data-id="class" data-count="99"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" title="Classes">Classes <span class="count badge">99</span></a></li><li class="" data-id="constant" data-count="11"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/constants/" title="Constants">Constants <span class="count badge">11</span></a></li><li class="" data-id="function" data-count="955"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/functions/" title="Functions">Functions <span class="count badge">955</span></a></li><li class="" data-id="shortcode" data-count="14"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">14</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/user-functions.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * User Functions</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Functions related to users / customers</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package     EDD</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage  Functions</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright   Copyright (c) 2015, Pippin Williamson</span>&nbsp;</div></li><li><div><span class="comment"> * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0.8.6</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Users Purchases</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves a list of all purchases by a specific user.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user User ID or email address</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $number Number of purchases to retrieve</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool pagination</span>&nbsp;</div></li><li><div><span class="comment"> * @param string|array $status Either an array of statuses, a single status as a string literal or a comma separated list of statues</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|object List of all user purchases</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_users_purchases( $user = 0, $number = 20, $pagination = false, $status = 'complete' ) {&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $user = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( 0 === $user ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_string( $status ) ) {&nbsp;</div></li><li><div>      if ( strpos( $status, ', ' ) ) {&nbsp;</div></li><li><div>          $status = explode( ', ', $status );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $status = $status === 'complete' ? 'publish' : $status;&nbsp;</div></li><li><div>          $status = array( $status );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_array( $status ) ) {&nbsp;</div></li><li><div>      $status = array_unique( $status );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $pagination ) {&nbsp;</div></li><li><div>      if ( get_query_var( 'paged' ) )&nbsp;</div></li><li><div>          $paged = get_query_var('paged');&nbsp;</div></li><li><div>      else if ( get_query_var( 'page' ) )&nbsp;</div></li><li><div>          $paged = get_query_var( 'page' );&nbsp;</div></li><li><div>      else&nbsp;</div></li><li><div>          $paged = 1;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'user' =&gt; $user, &nbsp;</div></li><li><div>      'number' =&gt; $number, &nbsp;</div></li><li><div>      'status' =&gt; $status, &nbsp;</div></li><li><div>      'orderby' =&gt; 'date'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $pagination ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['page'] = $paged;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['nopaging'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $by_user_id = is_numeric( $user ) ? true : false;&nbsp;</div></li><li><div>  $customer = new EDD_Customer( $user, $by_user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! empty( $customer-&gt;payment_ids ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      unset( $args['user'] );&nbsp;</div></li><li><div>      $args['post__in'] = array_map( 'absint', explode( ', ', $customer-&gt;payment_ids ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $purchases = edd_get_payments( apply_filters( 'edd_get_users_purchases_args', $args ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No purchases</span>&nbsp;</div></li><li><div>  if ( ! $purchases )&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $purchases;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Users Purchased Products</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns a list of unique products purchased by a specific user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int    $user User ID or email address</span>&nbsp;</div></li><li><div><span class="comment"> * @param string $status</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|object List of unique products purchased by user</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_users_purchased_products( $user = 0, $status = 'complete' ) {&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $user = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $by_user_id = is_numeric( $user ) ? true : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $customer = new EDD_Customer( $user, $by_user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $customer-&gt;payment_ids ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get all the items purchased</span>&nbsp;</div></li><li><div>  $payment_ids = array_reverse( explode( ', ', $customer-&gt;payment_ids ) );&nbsp;</div></li><li><div>  $limit_payments = apply_filters( 'edd_users_purchased_products_payments', 50 );&nbsp;</div></li><li><div>  if ( ! empty( $limit_payments ) ) {&nbsp;</div></li><li><div>      $payment_ids = array_slice( $payment_ids, 0, $limit_payments );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  $purchase_data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $payment_ids as $payment_id ) {&nbsp;</div></li><li><div>      $purchase_data[] = edd_get_payment_meta_downloads( $payment_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $purchase_data ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Grab only the post ids of the products purchased on this order</span>&nbsp;</div></li><li><div>  $purchase_product_ids = array();&nbsp;</div></li><li><div>  foreach ( $purchase_data as $purchase_meta ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $purchase_ids = @wp_list_pluck( $purchase_meta, 'id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_array( $purchase_ids ) || empty( $purchase_ids ) ) {&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $purchase_ids = array_values( $purchase_ids );&nbsp;</div></li><li><div>      $purchase_product_ids[] = $purchase_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Ensure that grabbed products actually HAVE downloads</span>&nbsp;</div></li><li><div>  $purchase_product_ids = array_filter( $purchase_product_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $purchase_product_ids ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Merge all orders into a single array of all items purchased</span>&nbsp;</div></li><li><div>  $purchased_products = array();&nbsp;</div></li><li><div>  foreach ( $purchase_product_ids as $product ) {&nbsp;</div></li><li><div>      $purchased_products = array_merge( $product, $purchased_products );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Only include each product purchased once</span>&nbsp;</div></li><li><div>  $product_ids = array_unique( $purchased_products );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure we still have some products and a first item</span>&nbsp;</div></li><li><div>  if ( empty ( $product_ids ) || ! isset( $product_ids[0] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = apply_filters( 'edd_get_users_purchased_products_args', array(&nbsp;</div></li><li><div>      'include' =&gt; $product_ids, &nbsp;</div></li><li><div>      'post_type' =&gt; 'download', &nbsp;</div></li><li><div>      'posts_per_page' =&gt; -1, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_users_purchased_products_list', get_posts( $args ) );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Has User Purchased</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks to see if a user has purchased a download.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param       int $user_id - the ID of the user to check</span>&nbsp;</div></li><li><div><span class="comment"> * @param       array $downloads - Array of IDs to check if purchased. If an int is passed, it will be converted to an array</span>&nbsp;</div></li><li><div><span class="comment"> * @param       int $variable_price_id - the variable price ID to check for</span>&nbsp;</div></li><li><div><span class="comment"> * @return      boolean - true if has purchased, false otherwise</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_has_user_purchased( $user_id, $downloads, $variable_price_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.7</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Allow 3rd parties to take actions before the history is queried.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  do_action( 'edd_has_user_purchased_before', $user_id, $downloads, $variable_price_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $users_purchases = edd_get_users_purchases( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $return = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! is_array( $downloads ) ) {&nbsp;</div></li><li><div>      $downloads = array( $downloads );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $users_purchases ) {&nbsp;</div></li><li><div>      foreach ( $users_purchases as $purchase ) {&nbsp;</div></li><li><div>          $payment = new EDD_Payment( $purchase-&gt;ID );&nbsp;</div></li><li><div>          $purchased_files = $payment-&gt;cart_details;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( is_array( $purchased_files ) ) {&nbsp;</div></li><li><div>              foreach ( $purchased_files as $download ) {&nbsp;</div></li><li><div>                  if ( in_array( $download['id'], $downloads ) ) {&nbsp;</div></li><li><div>                      $variable_prices = edd_has_variable_prices( $download['id'] );&nbsp;</div></li><li><div>                      if ( $variable_prices && ! is_null( $variable_price_id ) && $variable_price_id !== false ) {&nbsp;</div></li><li><div>                          if ( isset( $download['item_number']['options']['price_id'] ) && $variable_price_id == $download['item_number']['options']['price_id'] ) {&nbsp;</div></li><li><div>                              $return = true;&nbsp;</div></li><li><div>                              break 2; <span class="comment"><span class="comment">// Get out to prevent this value being overwritten if the customer has purchased item twice</span></span>&nbsp;</div></li><li><div>                          } else {&nbsp;</div></li><li><div>                              $return = false;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      } else {&nbsp;</div></li><li><div>                          $return = true;&nbsp;</div></li><li><div>                          break 2;  <span class="comment"><span class="comment">// Get out to prevent this value being overwritten if the customer has purchased item twice</span></span>&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7.7</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Filter has purchased result</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $return = apply_filters( 'edd_has_user_purchased', $return, $user_id, $downloads, $variable_price_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $return;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Has Purchases</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Checks to see if a user has purchased at least one item.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param       int $user_id - the ID of the user to check</span>&nbsp;</div></li><li><div><span class="comment"> * @return      bool - true if has purchased, false other wise.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_has_purchases( $user_id = null ) {&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( edd_get_users_purchases( $user_id, 1 ) ) {&nbsp;</div></li><li><div>      return true; <span class="comment">// User has at least one purchase</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  return false; <span class="comment">// User has never purchased anything</span>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Purchase Status for User</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the purchase count and the total amount spent for a specific user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param       int|string $user - the ID or email of the customer to retrieve stats for</span>&nbsp;</div></li><li><div><span class="comment"> * @param       string $mode - &quot;test&quot; or &quot;live&quot;</span>&nbsp;</div></li><li><div><span class="comment"> * @return      array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_purchase_stats_by_user( $user = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_email( $user ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $field = 'email';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } elseif ( is_numeric( $user ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $field = 'user_id';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = array();&nbsp;</div></li><li><div>  $customer = EDD()-&gt;customers-&gt;get_customer_by( $field, $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $customer ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $customer = new EDD_Customer( $customer-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $stats['purchases'] = absint( $customer-&gt;purchase_count );&nbsp;</div></li><li><div>      $stats['total_spent'] = edd_sanitize_amount( $customer-&gt;purchase_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (array) apply_filters( 'edd_purchase_stats_by_user', $stats, $user );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Count number of purchases of a customer</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Returns total number of purchases a customer has made</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.3</span>&nbsp;</div></li><li><div><span class="comment"> * @param       mixed $user - ID or email</span>&nbsp;</div></li><li><div><span class="comment"> * @return      int - the total number of purchases</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_count_purchases_of_customer( $user = null ) {&nbsp;</div></li><li><div>  if ( empty( $user ) ) {&nbsp;</div></li><li><div>      $user = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = ! empty( $user ) ? edd_get_purchase_stats_by_user( $user ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return isset( $stats['purchases'] ) ? $stats['purchases'] : 0;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Calculates the total amount spent by a user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.3</span>&nbsp;</div></li><li><div><span class="comment"> * @param       mixed $user - ID or email</span>&nbsp;</div></li><li><div><span class="comment"> * @return      float - the total amount the user has spent</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_total_of_user( $user = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $stats = edd_get_purchase_stats_by_user( $user );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $stats['total_spent'];&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Counts the total number of files a customer has downloaded</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.3</span>&nbsp;</div></li><li><div><span class="comment"> * @param       mixed $user - ID or email</span>&nbsp;</div></li><li><div><span class="comment"> * @return      int - The total number of files the user has downloaded</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_count_file_downloads_of_user( $user ) {&nbsp;</div></li><li><div>  global $edd_logs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_email( $user ) ) {&nbsp;</div></li><li><div>      $meta_query = array(&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'key' =&gt; '_edd_log_user_info', &nbsp;</div></li><li><div>              'value' =&gt; $user, &nbsp;</div></li><li><div>              'compare' =&gt; 'LIKE'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $meta_query = array(&nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>              'key' =&gt; '_edd_log_user_id', &nbsp;</div></li><li><div>              'value' =&gt; $user&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $edd_logs-&gt;get_log_count( null, 'file_download', $meta_query );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validate a potential username</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.3.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param       string $username The username to validate</span>&nbsp;</div></li><li><div><span class="comment"> * @return      bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_validate_username( $username ) {&nbsp;</div></li><li><div>  $sanitized = sanitize_user( $username, false );&nbsp;</div></li><li><div>  $valid = ( $sanitized == $username );&nbsp;</div></li><li><div>  return (bool) apply_filters( 'edd_validate_username', $valid, $username );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Attach the newly created user_id to a customer, if one exists</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $user_id The User ID that was created</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_connect_existing_customer_to_new_user( $user_id ) {&nbsp;</div></li><li><div>  $email = get_the_author_meta( 'user_email', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Update the user ID on the customer</span>&nbsp;</div></li><li><div>  $customer = new EDD_Customer( $email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $customer-&gt;id &gt; 0 ) {&nbsp;</div></li><li><div>      $customer-&gt;update( array( 'user_id' =&gt; $user_id ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'user_register', 'edd_connect_existing_customer_to_new_user', 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Looks up purchases by email that match the registering user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This is for users that purchased as a guest and then came</span>&nbsp;</div></li><li><div><span class="comment"> * back and created an account.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      public</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param       int $user_id - the new user's ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return      void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_add_past_purchases_to_new_user( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $email = get_the_author_meta( 'user_email', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payments = edd_get_payments( array( 's' =&gt; $email ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $payments ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set a flag to force the account to be verified before purchase history can be accessed</span>&nbsp;</div></li><li><div>      edd_set_user_to_pending( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      edd_send_user_verification_email( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach( $payments as $payment ) {&nbsp;</div></li><li><div>          if( intval( edd_get_payment_user_id( $payment-&gt;ID ) ) &gt; 0 ) {&nbsp;</div></li><li><div>              continue; <span class="comment">// This payment already associated with an account</span>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $meta = edd_get_payment_meta( $payment-&gt;ID );&nbsp;</div></li><li><div>          $meta['user_info'] = maybe_unserialize( $meta['user_info'] );&nbsp;</div></li><li><div>          $meta['user_info']['id'] = $user_id;&nbsp;</div></li><li><div>          $meta['user_info'] = $meta['user_info'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Store the updated user ID in the payment meta</span>&nbsp;</div></li><li><div>          edd_update_payment_meta( $payment-&gt;ID, '_edd_payment_meta', $meta );&nbsp;</div></li><li><div>          edd_update_payment_meta( $payment-&gt;ID, '_edd_payment_user_id', $user_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'user_register', 'edd_add_past_purchases_to_new_user', 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Counts the total number of customers.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access         public</span>&nbsp;</div></li><li><div><span class="comment"> * @since         1.7</span>&nbsp;</div></li><li><div><span class="comment"> * @return         int - The total number of customers.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_count_total_customers( $args = array() ) {&nbsp;</div></li><li><div>  return EDD()-&gt;customers-&gt;count( $args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Returns the saved address for a customer</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access         public</span>&nbsp;</div></li><li><div><span class="comment"> * @since         1.8</span>&nbsp;</div></li><li><div><span class="comment"> * @return         array - The customer's address, if any</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_customer_address( $user_id = 0 ) {&nbsp;</div></li><li><div>  if( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $address = get_user_meta( $user_id, '_edd_user_address', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $address || ! is_array( $address ) || empty( $address ) ) {&nbsp;</div></li><li><div>      $address = array();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! isset( $address['line1'] ) )&nbsp;</div></li><li><div>      $address['line1'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! isset( $address['line2'] ) )&nbsp;</div></li><li><div>      $address['line2'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! isset( $address['city'] ) )&nbsp;</div></li><li><div>      $address['city'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! isset( $address['zip'] ) )&nbsp;</div></li><li><div>      $address['zip'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! isset( $address['country'] ) )&nbsp;</div></li><li><div>      $address['country'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! isset( $address['state'] ) )&nbsp;</div></li><li><div>      $address['state'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $address;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sends the new user notification email when a user registers during checkout</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access         public</span>&nbsp;</div></li><li><div><span class="comment"> * @since         1.8.8</span>&nbsp;</div></li><li><div><span class="comment"> * @param int   $user_id</span>&nbsp;</div></li><li><div><span class="comment"> * @param array $user_data</span>&nbsp;</div></li><li><div><span class="comment"> * @return         void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_new_user_notification( $user_id = 0, $user_data = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $user_id ) || empty( $user_data ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails = EDD()-&gt;emails;&nbsp;</div></li><li><div>  $from_name = edd_get_option( 'from_name', wp_specialchars_decode( get_bloginfo( 'name' ), ENT_QUOTES ) );&nbsp;</div></li><li><div>  $from_email = edd_get_option( 'from_email', get_bloginfo( 'admin_email' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;__set( 'from_name', $from_name );&nbsp;</div></li><li><div>  $emails-&gt;__set( 'from_email', $from_email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $admin_subject = sprintf( __('[%s] New User Registration', 'easy-digital-downloads' ), $from_name );&nbsp;</div></li><li><div>  $admin_heading = __( 'New user registration', 'easy-digital-downloads' );&nbsp;</div></li><li><div>  $admin_message = sprintf( __( 'Username: %s', 'easy-digital-downloads'), $user_data['user_login'] ) . &quot;\r\n\r\n&quot;;&nbsp;</div></li><li><div>  $admin_message .= sprintf( __( 'E-mail: %s', 'easy-digital-downloads'), $user_data['user_email'] ) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;__set( 'heading', $admin_heading );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;send( get_option( 'admin_email' ), $admin_subject, $admin_message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_subject = sprintf( __( '[%s] Your username and password', 'easy-digital-downloads' ), $from_name );&nbsp;</div></li><li><div>  $user_heading = __( 'Your account info', 'easy-digital-downloads' );&nbsp;</div></li><li><div>  $user_message = sprintf( __( 'Username: %s', 'easy-digital-downloads' ), $user_data['user_login'] ) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( did_action( 'edd_pre_process_purchase' ) ) {&nbsp;</div></li><li><div>      $password_message = __( 'Password entered at checkout', 'easy-digital-downloads' );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      $password_message = __( 'Password entered at registration', 'easy-digital-downloads' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_message .= sprintf( __( 'Password: %s', 'easy-digital-downloads' ), '[' . $password_message . ']' ) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $emails-&gt;html ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_message .= '&lt;a href=&quot;' . wp_login_url() . '&quot;&gt; ' . esc_attr__( 'Click here to log in', 'easy-digital-downloads' ) . ' &raquo;&lt;/a&gt;' . &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user_message .= sprintf( __( 'To log in, visit: %s', 'easy-digital-downloads' ), wp_login_url() ) . &quot;\r\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;__set( 'heading', $user_heading );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;send( $user_data['user_email'], $user_subject, $user_message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_insert_user', 'edd_new_user_notification', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set a user's status to pending</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param  integer $user_id The User ID to set to pending</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool             If the update was successful</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_set_user_to_pending( $user_id = 0 ) {&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_pre_set_user_to_pending', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $update_successful = (bool) update_user_meta( $user_id, '_edd_pending_verification', '1' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_post_set_user_to_pending', $user_id, $update_successful );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $update_successful;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set the user from pending to active</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param  integer $user_id The User ID to activate</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool             If the user was marked as active or not</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_set_user_to_verified( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! edd_user_pending_verification( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_pre_set_user_to_active', $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $update_successful = delete_user_meta( $user_id, '_edd_pending_verification', '1' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_post_set_user_to_active', $user_id, $update_successful );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $update_successful;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Determines if the user account is pending verification. Pending accounts cannot view purchase history</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  public</span>&nbsp;</div></li><li><div><span class="comment"> * @since   2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return  bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_user_pending_verification( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// No need to run a DB lookup on an empty user id</span>&nbsp;</div></li><li><div>  if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $pending = get_user_meta( $user_id, '_edd_pending_verification', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return (bool) apply_filters( 'edd_user_pending_verification', ! empty( $pending ), $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the activation URL for the specified user</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  public</span>&nbsp;</div></li><li><div><span class="comment"> * @since   2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return  string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_user_verification_url( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $base_url = add_query_arg( array(&nbsp;</div></li><li><div>      'edd_action' =&gt; 'verify_user', &nbsp;</div></li><li><div>      'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>      'ttl' =&gt; strtotime( '+24 hours' )&nbsp;</div></li><li><div> ), untrailingslashit( edd_get_user_verification_page() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $token = edd_get_user_verification_token( $base_url );&nbsp;</div></li><li><div>  $url = add_query_arg( 'token', $token, $base_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_get_user_verification_url', $url, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Gets the URL that triggers a new verification email to be sent</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  public</span>&nbsp;</div></li><li><div><span class="comment"> * @since   2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return  string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_user_verification_request_url( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $user_id ) ) {&nbsp;</div></li><li><div>      $user_id = get_current_user_id();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = esc_url( wp_nonce_url( add_query_arg( array(&nbsp;</div></li><li><div>      'edd_action' =&gt; 'send_verification_email'&nbsp;</div></li><li><div> ) ), 'edd-request-verification' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_get_user_verification_request_url', $url, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Sends an email to the specified user with a URL to verify their account</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  public</span>&nbsp;</div></li><li><div><span class="comment"> * @since   2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return  void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_send_user_verification_email( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $user_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! edd_user_pending_verification( $user_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_data = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! $user_data ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $name = $user_data-&gt;display_name;&nbsp;</div></li><li><div>  $url = edd_get_user_verification_url( $user_id );&nbsp;</div></li><li><div>  $from_name = edd_get_option( 'from_name', wp_specialchars_decode( get_bloginfo( 'name' ), ENT_QUOTES ) );&nbsp;</div></li><li><div>  $from_email = edd_get_option( 'from_email', get_bloginfo( 'admin_email' ) );&nbsp;</div></li><li><div>  $subject = apply_filters( 'edd_user_verification_email_subject', __( 'Verify your account', 'easy-digital-downloads' ), $user_id );&nbsp;</div></li><li><div>  $heading = apply_filters( 'edd_user_verification_email_heading', __( 'Verify your account', 'easy-digital-downloads' ), $user_id );&nbsp;</div></li><li><div>  $message = sprintf(&nbsp;</div></li><li><div>      __( &quot;Hello %s, \n\nYour account with %s needs to be verified before you can access your purchase history. &lt;a href='%s'&gt;Click here&lt;/a&gt; to verify your account.\n\nLink missing? Visit the following URL: %s&quot;, 'easy-digital-downloads' ), &nbsp;</div></li><li><div>      $name, &nbsp;</div></li><li><div>      $from_name, &nbsp;</div></li><li><div>      $url, &nbsp;</div></li><li><div>      $url&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $message = apply_filters( 'edd_user_verification_email_message', $message, $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails = new EDD_Emails;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;__set( 'from_name', $from_name );&nbsp;</div></li><li><div>  $emails-&gt;__set( 'from_email', $from_email );&nbsp;</div></li><li><div>  $emails-&gt;__set( 'heading', $heading );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $emails-&gt;send( $user_data-&gt;user_email, $subject, $message );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generates a token for a user verification URL.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * An 'o' query parameter on a URL can include optional variables to test</span>&nbsp;</div></li><li><div><span class="comment"> * against when verifying a token without passing those variables around in</span>&nbsp;</div></li><li><div><span class="comment"> * the URL. For example, downloads can be limited to the IP that the URL was</span>&nbsp;</div></li><li><div><span class="comment"> * generated for by adding 'o=ip' to the query string.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Or suppose when WordPress requested a URL for automatic updates, the user</span>&nbsp;</div></li><li><div><span class="comment"> * agent could be tested to ensure the URL is only valid for requests from</span>&nbsp;</div></li><li><div><span class="comment"> * that user agent.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $url The URL to generate a token for.</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The token for the URL.</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_user_verification_token( $url = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = array();&nbsp;</div></li><li><div>  $hash = apply_filters( 'edd_get_user_verification_token_algorithm', 'sha256' );&nbsp;</div></li><li><div>  $secret = apply_filters( 'edd_get_user_verification_token_secret', hash( $hash, wp_salt() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add additional args to the URL for generating the token.</span>&nbsp;</div></li><li><div><span class="comment">   * Allows for restricting access to IP and/or user agent.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $parts = parse_url( $url );&nbsp;</div></li><li><div>  $options = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $parts['query'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_parse_str( $parts['query'], $query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// o = option checks (ip, user agent).</span>&nbsp;</div></li><li><div>      if ( ! empty( $query_args['o'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Multiple options can be checked by separating them with a colon in the query parameter.</span>&nbsp;</div></li><li><div>          $options = explode( ':', rawurldecode( $query_args['o'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( in_array( 'ip', $options ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $args['ip'] = edd_get_ip();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( in_array( 'ua', $options ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ua = isset( $_SERVER['HTTP_USER_AGENT'] ) ? $_SERVER['HTTP_USER_AGENT'] : '';&nbsp;</div></li><li><div>              $args['user_agent'] = rawurlencode( $ua );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Filter to modify arguments and allow custom options to be tested.</span>&nbsp;</div></li><li><div><span class="comment">   * Be sure to rawurlencode any custom options for consistent results.</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  $args = apply_filters( 'edd_get_user_verification_token_args', $args, $url, $options );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args['secret'] = $secret;&nbsp;</div></li><li><div>  $args['token'] = false; <span class="comment">// Removes a token if present.</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $url = add_query_arg( $args, $url );&nbsp;</div></li><li><div>  $parts = parse_url( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// In the event there isn't a path, set an empty one so we can MD5 the token</span>&nbsp;</div></li><li><div>  if ( ! isset( $parts['path'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $parts['path'] = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $token = md5( $parts['path'] . '?' . $parts['query'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $token;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generate a token for a URL and match it against the existing token to make</span>&nbsp;</div></li><li><div><span class="comment"> * sure the URL hasn't been tampered with.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $url URL to test.</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_validate_user_verification_token( $url = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $ret = false;&nbsp;</div></li><li><div>  $parts = parse_url( $url );&nbsp;</div></li><li><div>  $query_args = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( isset( $parts['query'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_parse_str( $parts['query'], $query_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $query_args['ttl'] ) && current_time( 'timestamp' ) &gt; $query_args['ttl'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          do_action( 'edd_user_verification_token_expired' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $link_text = sprintf(&nbsp;</div></li><li><div>              __( 'Sorry but your account verification link has expired. &lt;a href=&quot;%s&quot;&gt;Click here&lt;/a&gt; to request a new verification URL.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              edd_get_user_verification_request_url()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_die( apply_filters( 'edd_verification_link_expired_text', $link_text ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $query_args['token'] ) && $query_args['token'] == edd_get_user_verification_token( $url ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ret = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_validate_user_verification_token', $ret, $url, $query_args );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Processes an account verification email request</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_user_verification_request() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! wp_verify_nonce( $_GET['_wpnonce'], 'edd-request-verification' ) ) {&nbsp;</div></li><li><div>      wp_die( __( 'Nonce verification failed.', 'easy-digital-downloads' ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>      wp_die( __( 'You must be logged in to verify your account.', 'easy-digital-downloads' ), __( 'Notice', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! edd_user_pending_verification( get_current_user_id() ) ) {&nbsp;</div></li><li><div>      wp_die( __( 'Your account has already been verified.', 'easy-digital-downloads' ), __( 'Notice', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  edd_send_user_verification_email( get_current_user_id() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $redirect = apply_filters(&nbsp;</div></li><li><div>      'edd_user_account_verification_request_redirect', &nbsp;</div></li><li><div>      add_query_arg( 'edd-verify-request', '1', edd_get_user_verification_page() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_safe_redirect( $redirect );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_send_verification_email', 'edd_process_user_verification_request' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Processes an account verification</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.4.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_user_account_verification() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $_GET['token'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $_GET['user_id'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $_GET['ttl'] ) ) {&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $parts = parse_url( add_query_arg( array() ) );&nbsp;</div></li><li><div>  wp_parse_str( $parts['query'], $query_args );&nbsp;</div></li><li><div>  $url = add_query_arg( $query_args, untrailingslashit( edd_get_user_verification_page() ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! edd_validate_user_verification_token( $url ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      do_action( 'edd_invalid_user_verification_token' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_die( __( 'Invalid verification token provided.', 'easy-digital-downloads' ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  edd_set_user_to_verified( absint( $_GET['user_id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_user_verification_token_validated' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $redirect = apply_filters(&nbsp;</div></li><li><div>      'edd_user_account_verified_redirect', &nbsp;</div></li><li><div>      add_query_arg( 'edd-verify-success', '1', edd_get_user_verification_page() )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  wp_safe_redirect( $redirect );&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_verify_user', 'edd_process_user_account_verification' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Retrieves the purchase history page, or main URL for the account verification process</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4.6</span>&nbsp;</div></li><li><div><span class="comment"> * @return string The base URL to use for account verification</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_user_verification_page() {&nbsp;</div></li><li><div>  $url = home_url();&nbsp;</div></li><li><div>  $purchase_history = edd_get_option( 'purchase_history_page', 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $purchase_history ) ) {&nbsp;</div></li><li><div>      $url = get_permalink( $purchase_history );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_user_verification_base_url', $url );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * When a user is deleted, detach that user id from the customer record</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.5</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int $user_id The User ID being deleted</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool         If the detachment was successful</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_detach_deleted_user( $user_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $customer = new EDD_Customer( $user_id, true );&nbsp;</div></li><li><div>  $detached = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $customer-&gt;id &gt; 0 ) {&nbsp;</div></li><li><div>      $detached = $customer-&gt;update( array( 'user_id' =&gt; 0 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_detach_deleted_user', $user_id, $customer, $detached );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $detached;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'delete_user', 'edd_detach_deleted_user', 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Modify User Profile</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Modifies the output of profile.php to add key generation/revocation</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param object $user Current user info</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_show_user_api_key_field( $user ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_current_user_id() !== $user-&gt;ID ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ( edd_get_option( 'api_allow_user_keys', false ) || current_user_can( 'manage_shop_settings' ) ) && current_user_can( 'edit_user', $user-&gt;ID ) ) {&nbsp;</div></li><li><div>      $user = get_userdata( $user-&gt;ID );&nbsp;</div></li><li><div>      $public_key = EDD()-&gt;api-&gt;get_user_public_key( $user-&gt;ID );&nbsp;</div></li><li><div>      $secret_key = EDD()-&gt;api-&gt;get_user_secret_key( $user-&gt;ID );&nbsp;</div></li><li><div>      $token = EDD()-&gt;api-&gt;get_token( $user-&gt;ID );&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>          &lt;tbody&gt;&nbsp;</div></li><li><div>          &lt;tr&gt;&nbsp;</div></li><li><div>              &lt;th&gt;&nbsp;</div></li><li><div>                  &lt;?php _e( 'Easy Digital Downloads API Keys', 'easy-digital-downloads' ); ?&gt;&nbsp;</div></li><li><div>              &lt;/th&gt;&nbsp;</div></li><li><div>              &lt;td&gt;&nbsp;</div></li><li><div>                  &lt;?php if ( empty( $user-&gt;edd_user_public_key ) ) { ?&gt;&nbsp;</div></li><li><div>                      &lt;input name=&quot;edd_set_api_key&quot; type=&quot;checkbox&quot; id=&quot;edd_set_api_key&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;span class=&quot;description&quot;&gt;&lt;?php _e( 'Generate API Key', 'easy-digital-downloads' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;?php } else { ?&gt;&nbsp;</div></li><li><div>                      &lt;strong style=&quot;display:inline-block; width: 125px;&quot;&gt;&lt;?php _e( 'Public key:', 'easy-digital-downloads' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;regular-text&quot; id=&quot;publickey&quot; value=&quot;&lt;?php echo esc_attr( $public_key ); ?&gt;&quot;/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                      &lt;strong style=&quot;display:inline-block; width: 125px;&quot;&gt;&lt;?php _e( 'Secret key:', 'easy-digital-downloads' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;regular-text&quot; id=&quot;privatekey&quot; value=&quot;&lt;?php echo esc_attr( $secret_key ); ?&gt;&quot;/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                      &lt;strong style=&quot;display:inline-block; width: 125px;&quot;&gt;&lt;?php _e( 'Token:', 'easy-digital-downloads' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;regular-text&quot; id=&quot;token&quot; value=&quot;&lt;?php echo esc_attr( EDD()-&gt;api-&gt;get_token( $user-&gt;ID ) ); ?&gt;&quot;/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                      &lt;input name=&quot;edd_set_api_key&quot; type=&quot;checkbox&quot; id=&quot;edd_set_api_key&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>                      &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;edd_set_api_key&quot;&gt;&lt;?php _e( 'Revoke API Keys', 'easy-digital-downloads' ); ?&gt;&lt;/label&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                  &lt;?php } ?&gt;&nbsp;</div></li><li><div>              &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>          &lt;/tbody&gt;&nbsp;</div></li><li><div>      &lt;/table&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php if ( wp_is_mobile() ) : ?&gt;&nbsp;</div></li><li><div>      &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>          &lt;tbody&gt;&nbsp;</div></li><li><div>          &lt;tr&gt;&nbsp;</div></li><li><div>              &lt;th&gt;&nbsp;</div></li><li><div>                  &lt;?php printf( __( 'Easy Digital Downloads &lt;a href=&quot;%s&quot;&gt;iOS App&lt;/a&gt;', 'easy-digital-downloads' ), 'https:<span class="comment">//itunes.apple.com/us/app/easy-digital-downloads-2/id1169488828?ls=1&mt=8' ); ?&gt;</span>&nbsp;</div></li><li><div>              &lt;/th&gt;&nbsp;</div></li><li><div>              &lt;td&gt;&nbsp;</div></li><li><div>                  &lt;?php&nbsp;</div></li><li><div>                  $sitename = get_bloginfo( 'name' );&nbsp;</div></li><li><div>                  $ios_url = 'edd:<span class="comment">//new?sitename=' . $sitename . '&siteurl=' . home_url() . '&key=' . $public_key . '&token=' . $token;</span>&nbsp;</div></li><li><div>                  ?&gt;&nbsp;</div></li><li><div>                  &lt;a class=&quot;button-secondary&quot; href=&quot;&lt;?php echo $ios_url; ?&gt;&quot;&gt;&lt;?php _e( 'Add to iOS App', 'easy-digital-downloads' ); ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>              &lt;/td&gt;&nbsp;</div></li><li><div>          &lt;/tr&gt;&nbsp;</div></li><li><div>          &lt;/tbody&gt;&nbsp;</div></li><li><div>      &lt;/table&gt;&nbsp;</div></li><li><div>      &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  &lt;?php }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'show_user_profile', 'edd_show_user_api_key_field' );&nbsp;</div></li><li><div>add_action( 'edit_user_profile', 'edd_show_user_api_key_field' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Generate and Save API key</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Generates the key requested by user_key_field and stores it in the database</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 2.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $user_id</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_update_user_api_key( $user_id ) {&nbsp;</div></li><li><div>  if ( current_user_can( 'edit_user', $user_id ) && isset( $_POST['edd_set_api_key'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $user = get_userdata( $user_id );&nbsp;</div></li><li><div>      $public_key = EDD()-&gt;api-&gt;get_user_public_key( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $public_key ) ) {&nbsp;</div></li><li><div>          $new_public_key = EDD()-&gt;api-&gt;generate_public_key( $user-&gt;user_email );&nbsp;</div></li><li><div>          $new_secret_key = EDD()-&gt;api-&gt;generate_private_key( $user-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          update_user_meta( $user_id, $new_public_key, 'edd_user_public_key' );&nbsp;</div></li><li><div>          update_user_meta( $user_id, $new_secret_key, 'edd_user_secret_key' );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          EDD()-&gt;api-&gt;revoke_api_key( $user_id );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'personal_options_update', 'edd_update_user_api_key' );&nbsp;</div></li><li><div>add_action( 'edit_user_profile_update', 'edd_update_user_api_key' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Easy Digital Downloads</li><li><span></span>2.7.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>