<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.8" data-slug="easy-digital-downloads" data-type="file" data-id="58165"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-gateways-amazon-payments | file | Easy Digital Downloads | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, easy-digital-downloads, 2.7.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=027f5319d16fc1657a070ec7ee64b15c' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-gateways-amazon-payments/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-gateways-amazon-payments%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-gateways-amazon-payments%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-easy-digital-downloads-2.7.8-file-includes-gateways-amazon-payments","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-gateways-amazon-payments" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to easy-digital-downloads." href="http://hookr.io/plugins/easy-digital-downloads/" class="plugin"><span property="name">easy-digital-downloads</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.8." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/" class="H_VERSION"><span property="name">2.7.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-gateways-amazon-paym&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2274"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/all/" title="All">All <span class="count badge">2274</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="1195"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/hooks/" title="Hooks">Hooks <span class="count badge">1195</span></a></li><li class="" data-id="action" data-count="469"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/actions/" title="Actions">Actions <span class="count badge">469</span></a></li><li class="" data-id="filter" data-count="726"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/filters/" title="Filters">Filters <span class="count badge">726</span></a></li><li class="" data-id="class" data-count="99"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" title="Classes">Classes <span class="count badge">99</span></a></li><li class="" data-id="constant" data-count="11"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/constants/" title="Constants">Constants <span class="count badge">11</span></a></li><li class="" data-id="function" data-count="955"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/functions/" title="Functions">Functions <span class="count badge">955</span></a></li><li class="" data-id="shortcode" data-count="14"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">14</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/gateways/amazon-payments.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div>namespace PayWithAmazon;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Amazon Payments Gateway</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package     EDD</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage  Gateways</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright   Copyright (c) 2015, Pippin's Pages, LLC</span>&nbsp;</div></li><li><div><span class="comment"> * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License</span>&nbsp;</div></li><li><div><span class="comment"> * @since       2.4</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>final class EDD_Amazon_Payments {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  private static $instance;&nbsp;</div></li><li><div>  public $gateway_id = 'amazon';&nbsp;</div></li><li><div>  public $client = null;&nbsp;</div></li><li><div>  public $redirect_uri = null;&nbsp;</div></li><li><div>  public $checkout_uri = null;&nbsp;</div></li><li><div>  public $signin_redirect = null;&nbsp;</div></li><li><div>  public $reference_id = null;&nbsp;</div></li><li><div>  public $doing_ipn = false;&nbsp;</div></li><li><div>  public $is_setup = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Get things going</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( version_compare( phpversion(), 5.3, '&lt;' ) ) {&nbsp;</div></li><li><div>          <span class="comment">// The Amazon Login & Pay libraries require PHP 5.3</span>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;reference_id = ! empty( $_REQUEST['amazon_reference_id'] ) ? sanitize_text_field( $_REQUEST['amazon_reference_id'] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Run this separate so we can ditch as early as possible</span>&nbsp;</div></li><li><div>      $this-&gt;register();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! edd_is_gateway_active( $this-&gt;gateway_id ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;config();&nbsp;</div></li><li><div>      $this-&gt;includes();&nbsp;</div></li><li><div>      $this-&gt;setup_client();&nbsp;</div></li><li><div>      $this-&gt;filters();&nbsp;</div></li><li><div>      $this-&gt;actions();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve current instance</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return EDD_Amazon_Payments instance</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function getInstance() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( self::$instance ) && ! ( self::$instance instanceof EDD_Amazon_Payments ) ) {&nbsp;</div></li><li><div>          self::$instance = new EDD_Amazon_Payments;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return self::$instance;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Register the payment gateway</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function register() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'edd_payment_gateways', array( $this, 'register_gateway' ), 1, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Setup constant configuration for file paths</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function config() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! defined( 'EDD_AMAZON_CLASS_DIR' ) ) {&nbsp;</div></li><li><div>          $path = trailingslashit( plugin_dir_path( EDD_PLUGIN_FILE ) ) . 'includes/gateways/libs/amazon';&nbsp;</div></li><li><div>          define( 'EDD_AMAZON_CLASS_DIR', trailingslashit( $path ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Method to check if all the required settings have been filled out, allowing us to not output information without it.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function is_setup() {&nbsp;</div></li><li><div>      if ( null !== $this-&gt;is_setup ) {&nbsp;</div></li><li><div>          return $this-&gt;is_setup;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $required_items = array( 'merchant_id', 'client_id', 'access_key', 'secret_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $current_values = array(&nbsp;</div></li><li><div>          'merchant_id' =&gt; edd_get_option( 'amazon_seller_id', '' ), &nbsp;</div></li><li><div>          'client_id' =&gt; edd_get_option( 'amazon_client_id', '' ), &nbsp;</div></li><li><div>          'access_key' =&gt; edd_get_option( 'amazon_mws_access_key', '' ), &nbsp;</div></li><li><div>          'secret_key' =&gt; edd_get_option( 'amazon_mws_secret_key', '' ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;is_setup = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $required_items as $key ) {&nbsp;</div></li><li><div>          if ( empty( $current_values[ $key ] ) ) {&nbsp;</div></li><li><div>              $this-&gt;is_setup = false;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;is_setup;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Load additional files</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function includes() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Include the Amazon Library</span>&nbsp;</div></li><li><div>      require_once EDD_AMAZON_CLASS_DIR . 'Client.php'; <span class="comment">// Requires the other files itself</span>&nbsp;</div></li><li><div>      require_once EDD_AMAZON_CLASS_DIR . 'IpnHandler.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add filters</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function filters() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_filter( 'edd_accepted_payment_icons', array( $this, 'register_payment_icon' ), 10, 1 );&nbsp;</div></li><li><div>      add_filter( 'edd_show_gateways', array( $this, 'maybe_hide_gateway_select' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_admin() ) {&nbsp;</div></li><li><div>          add_filter( 'edd_settings_sections_gateways', array( $this, 'register_gateway_section' ), 1, 1 );&nbsp;</div></li><li><div>          add_filter( 'edd_settings_gateways', array( $this, 'register_gateway_settings' ), 1, 1 );&nbsp;</div></li><li><div>          add_filter( 'edd_payment_details_transaction_id-' . $this-&gt;gateway_id, array( $this, 'link_transaction_id' ), 10, 2 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Add actions</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function actions() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'wp_enqueue_scripts', array( $this, 'print_client' ), 10 );&nbsp;</div></li><li><div>      add_action( 'wp_enqueue_scripts', array( $this, 'load_scripts' ), 11 );&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'check_config' ), 1 );&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'capture_oauth' ), 9 );&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'signin_redirect' ) );&nbsp;</div></li><li><div>      add_action( 'edd_purchase_form_before_register_login', array( $this, 'login_form' ) );&nbsp;</div></li><li><div>      add_action( 'edd_checkout_error_check', array( $this, 'checkout_errors' ), 10, 2 );&nbsp;</div></li><li><div>      add_action( 'edd_gateway_amazon', array( $this, 'process_purchase' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_edd_amazon_get_address', array( $this, 'ajax_get_address' ) );&nbsp;</div></li><li><div>      add_action( 'wp_ajax_nopriv_edd_amazon_get_address', array( $this, 'ajax_get_address' ) );&nbsp;</div></li><li><div>      add_action( 'edd_pre_process_purchase', array( $this, 'disable_address_requirement' ), 99999 );&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'process_ipn' ) );&nbsp;</div></li><li><div>      add_action( 'edd_update_payment_status', array( $this, 'process_refund' ), 200, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;reference_id ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'edd_amazon_cc_form', array( $this, 'wallet_form' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Show an error message on checkout if Amazon is enabled but not setup.</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since 2.7</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function check_config() {&nbsp;</div></li><li><div>      $is_enabled = edd_is_gateway_active( $this-&gt;gateway_id );&nbsp;</div></li><li><div>      if ( ! $is_enabled || false === $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          edd_set_error( 'amazon_gateway_not_configured', __( 'There is an error with the Amazon Payments configuration.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the client object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return PayWithAmazon\Client</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_client() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! is_null( $this-&gt;client ) ) {&nbsp;</div></li><li><div>          return $this-&gt;client;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;setup_client();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;client;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Setup the client object</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access private</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function setup_client() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $region = edd_get_shop_country();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'GB' === $region ) {&nbsp;</div></li><li><div>          $region = 'UK';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $config = array(&nbsp;</div></li><li><div>          'merchant_id' =&gt; edd_get_option( 'amazon_seller_id', '' ), &nbsp;</div></li><li><div>          'client_id' =&gt; edd_get_option( 'amazon_client_id', '' ), &nbsp;</div></li><li><div>          'access_key' =&gt; edd_get_option( 'amazon_mws_access_key', '' ), &nbsp;</div></li><li><div>          'secret_key' =&gt; edd_get_option( 'amazon_mws_secret_key', '' ), &nbsp;</div></li><li><div>          'region' =&gt; $region, &nbsp;</div></li><li><div>          'sandbox' =&gt; edd_is_test_mode(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $config = apply_filters( 'edd_amazon_client_config', $config );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;client = new Client( $config );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Register the gateway</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $gateways array</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function register_gateway( $gateways ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_amazon_info = array(&nbsp;</div></li><li><div>          $this-&gt;gateway_id =&gt; array(&nbsp;</div></li><li><div>              'admin_label' =&gt; __( 'Amazon', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'checkout_label' =&gt; __( 'Amazon', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'supports' =&gt; array(), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_amazon_info = apply_filters( 'edd_register_amazon_gateway', $default_amazon_info );&nbsp;</div></li><li><div>      $gateways = array_merge( $gateways, $default_amazon_info );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $gateways;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Register the payment icon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $payment_icons Array of payment icons</span>&nbsp;</div></li><li><div><span class="comment">   * @return array                The array of icons with Amazon Added</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function register_payment_icon( $payment_icons ) {&nbsp;</div></li><li><div>      $payment_icons['amazon'] = 'Amazon';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $payment_icons;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Hides payment gateway select options after return from Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.7.6</span>&nbsp;</div></li><li><div><span class="comment">   * @param  bool $show Should gateway select be shown</span>&nbsp;</div></li><li><div><span class="comment">   * @return bool</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function maybe_hide_gateway_select( $show ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! empty( $_REQUEST['payment-mode'] ) && 'amazon' == $_REQUEST['payment-mode'] && ! empty( $_REQUEST['amazon_reference_id'] ) && ! empty( $_REQUEST['state'] ) && 'authorized' == $_REQUEST['state'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $show = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $show;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Register the payment gateways setting section</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.5</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $gateway_sections Array of sections for the gateways tab</span>&nbsp;</div></li><li><div><span class="comment">   * @return array                   Added Amazon Payments into sub-sections</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function register_gateway_section( $gateway_sections ) {&nbsp;</div></li><li><div>      $gateway_sections['amazon'] = __( 'Amazon Payments', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $gateway_sections;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Register the gateway settings</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $gateway_settings array</span>&nbsp;</div></li><li><div><span class="comment">   * @return array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function register_gateway_settings( $gateway_settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_amazon_settings = array(&nbsp;</div></li><li><div>          'amazon' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon', &nbsp;</div></li><li><div>              'name' =&gt; '&lt;strong&gt;' . __( 'Amazon Payments Settings', 'easy-digital-downloads' ) . '&lt;/strong&gt;', &nbsp;</div></li><li><div>              'type' =&gt; 'header', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_register' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_register', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Register with Amazon', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; '&lt;p&gt;&lt;a href=&quot;' . $this-&gt;get_registration_url() . '&quot; class=&quot;button&quot; target=&quot;_blank&quot;&gt;' .&nbsp;</div></li><li><div>                      __( 'Connect Easy Digital Downloads to Amazon', 'easy-digital-downloads' ) .&nbsp;</div></li><li><div>                      '&lt;/a&gt;&lt;/p&gt;' .&nbsp;</div></li><li><div>                      '&lt;p class=&quot;description&quot;&gt;' .&nbsp;</div></li><li><div>                      __( 'Once registration is complete, enter your API credentials below.', 'easy-digital-downloads' ) .&nbsp;</div></li><li><div>                      '&lt;/p&gt;', &nbsp;</div></li><li><div>              'type' =&gt; 'descriptive_text', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_seller_id' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_seller_id', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Seller ID', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Found in the Integration settings. Also called a Merchant ID', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_mws_access_key' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_mws_access_key', &nbsp;</div></li><li><div>              'name' =&gt; __( 'MWS Access Key', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Found on Seller Central in the MWS Keys section', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_mws_secret_key' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_mws_secret_key', &nbsp;</div></li><li><div>              'name' =&gt; __( 'MWS Secret Key', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Found on Seller Central in the MWS Keys section', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_client_id' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_client_id', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Client ID', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'The Amazon Client ID. Should look like `amzn1.application-oa2...`', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_mws_callback_url' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_callback_url', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Amazon MWS Callback URL', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'The Return URL to provide in your MWS Application. Enter this under your Login and Pay &rarr; Web Settings', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'large', &nbsp;</div></li><li><div>              'std' =&gt; $this-&gt;get_amazon_authenticate_redirect(), &nbsp;</div></li><li><div>              'faux' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'amazon_mws_ipn_url' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'amazon_ipn_url', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Amazon Merchant IPN URL', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; sprintf( __( 'The IPN URL to provide in your MWS account. Enter this under your &lt;a href=&quot;%s&quot;&gt;Integration Settings&lt;/a&gt;', 'easy-digital-downloads' ), 'https:<span class="comment">//sellercentral.amazon.com/gp/pyop/seller/account/settings/user-settings-edit.html' ), </span>&nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'large', &nbsp;</div></li><li><div>              'std' =&gt; $this-&gt;get_amazon_ipn_url(), &nbsp;</div></li><li><div>              'faux' =&gt; true, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_amazon_settings = apply_filters( 'edd_default_amazon_settings', $default_amazon_settings );&nbsp;</div></li><li><div>      $gateway_settings['amazon'] = $default_amazon_settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $gateway_settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Load javascript files and localized variables</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function load_scripts() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! edd_is_checkout() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $test_mode = edd_is_test_mode();&nbsp;</div></li><li><div>      $seller_id = edd_get_option( 'amazon_seller_id', '' );&nbsp;</div></li><li><div>      $client_id = edd_get_option( 'amazon_client_id', '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_amazon_scope = array(&nbsp;</div></li><li><div>          'profile', &nbsp;</div></li><li><div>          'postal_code', &nbsp;</div></li><li><div>          'payments:widget', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( edd_use_taxes() ) {&nbsp;</div></li><li><div>          $default_amazon_scope[] = 'payments:shipping_address';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $default_amazon_button_settings = array(&nbsp;</div></li><li><div>          'type' =&gt; 'PwA', &nbsp;</div></li><li><div>          'color' =&gt; 'Gold', &nbsp;</div></li><li><div>          'size' =&gt; 'medium', &nbsp;</div></li><li><div>          'scope' =&gt; implode( ' ', $default_amazon_scope ), &nbsp;</div></li><li><div>          'popup' =&gt; true, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $amazon_button_settings = apply_filters( 'edd_amazon_button_settings', $default_amazon_button_settings );&nbsp;</div></li><li><div>      $base_url = '';&nbsp;</div></li><li><div>      $sandbox = $test_mode ? 'sandbox/' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( edd_get_shop_country() ) {&nbsp;</div></li><li><div>          case 'GB':&nbsp;</div></li><li><div>              $base_url = 'https:<span class="comment">//static-eu.payments-amazon.com/OffAmazonPayments/uk/' . $sandbox . 'lpa/';</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'DE':&nbsp;</div></li><li><div>              $base_url = 'https:<span class="comment">//static-eu.payments-amazon.com/OffAmazonPayments/de/' . $sandbox. 'lpa/';</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $base_url = 'https:<span class="comment">//static-na.payments-amazon.com/OffAmazonPayments/us/' . $sandbox;</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $base_url ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $url = $base_url . 'js/Widgets.js?sellerId=' . $seller_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_enqueue_script( 'edd-amazon-widgets', $url, array( 'jquery' ), null, false );&nbsp;</div></li><li><div>          wp_localize_script( 'edd-amazon-widgets', 'edd_amazon', apply_filters( 'edd_amazon_checkout_vars', array(&nbsp;</div></li><li><div>              'sellerId' =&gt; $seller_id, &nbsp;</div></li><li><div>              'clientId' =&gt; $client_id, &nbsp;</div></li><li><div>              'referenceID' =&gt; $this-&gt;reference_id, &nbsp;</div></li><li><div>              'buttonType' =&gt; $amazon_button_settings['type'], &nbsp;</div></li><li><div>              'buttonColor' =&gt; $amazon_button_settings['color'], &nbsp;</div></li><li><div>              'buttonSize' =&gt; $amazon_button_settings['size'], &nbsp;</div></li><li><div>              'scope' =&gt; $amazon_button_settings['scope'], &nbsp;</div></li><li><div>              'popup' =&gt; $amazon_button_settings['popup'], &nbsp;</div></li><li><div>              'checkoutUri' =&gt; $this-&gt;get_amazon_checkout_uri(), &nbsp;</div></li><li><div>              'redirectUri' =&gt; $this-&gt;get_amazon_authenticate_redirect(), &nbsp;</div></li><li><div>              'signinUri' =&gt; $this-&gt;get_amazon_signin_redirect(), &nbsp;</div></li><li><div> ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Print client ID in header</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function print_client() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! edd_is_checkout() ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      ?&gt;&nbsp;</div></li><li><div>      &lt;script&gt;&nbsp;</div></li><li><div>          window.onAmazonLoginReady = function() {&nbsp;</div></li><li><div>              amazon.Login.setClientId(&lt;?php echo json_encode( edd_get_option( 'amazon_client_id', '' ) ); ?&gt;);&nbsp;</div></li><li><div>          };&nbsp;</div></li><li><div>      &lt;/script&gt;&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Capture authentication after returning from Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function capture_oauth() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $_GET['edd-listener'] ) || $_GET['edd-listener'] !== 'amazon' ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $_GET['state'] ) || $_GET['state'] !== 'return_auth' ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $_GET['access_token'] ) || false === strpos( $_GET['access_token'], 'Atza' ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $profile = $this-&gt;client-&gt;getUserInfo( $_GET['access_token'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          EDD()-&gt;session-&gt;set( 'amazon_access_token', $_GET['access_token'] );&nbsp;</div></li><li><div>          EDD()-&gt;session-&gt;set( 'amazon_profile', $profile );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_die( print_r( $e, true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Set customer details after authentication</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function signin_redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $_GET['edd-listener'] ) || $_GET['edd-listener'] !== 'amazon' ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $_GET['state'] ) || $_GET['state'] !== 'signed-in' ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $profile = EDD()-&gt;session-&gt;get( 'amazon_profile' );&nbsp;</div></li><li><div>      $reference = $_GET['amazon_reference_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! is_user_logged_in() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $user = get_user_by( 'email', $profile['email'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( $user ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              edd_log_user_in( $user-&gt;ID, $user-&gt;user_login, '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $customer = array(&nbsp;</div></li><li><div>                  'first_name' =&gt; $user-&gt;first_name, &nbsp;</div></li><li><div>                  'last_name' =&gt; $user-&gt;last_name, &nbsp;</div></li><li><div>                  'email' =&gt; $user-&gt;user_email&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $names = explode( ' ', $profile['name'], 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $customer = array(&nbsp;</div></li><li><div>                  'first_name' =&gt; $names[0], &nbsp;</div></li><li><div>                  'last_name' =&gt; isset( $names[1] ) ? $names[1] : '', &nbsp;</div></li><li><div>                  'email' =&gt; $profile['email']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( 'none' !== edd_get_option( 'show_register_form' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// Create a customer account if registration is not disabled</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $args = array(&nbsp;</div></li><li><div>                      'user_email' =&gt; $profile['email'], &nbsp;</div></li><li><div>                      'user_login' =&gt; $profile['email'], &nbsp;</div></li><li><div>                      'display_name' =&gt; $profile['name'], &nbsp;</div></li><li><div>                      'first_name' =&gt; $customer['first_name'], &nbsp;</div></li><li><div>                      'last_name' =&gt; $customer['last_name'], &nbsp;</div></li><li><div>                      'user_pass' =&gt; wp_generate_password( 20 ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $user_id = wp_insert_user( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  edd_log_user_in( $user_id, $args['user_login'], $args['user_pass'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          EDD()-&gt;session-&gt;set( 'customer', $customer );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_redirect( edd_get_checkout_uri( array( 'payment-mode' =&gt; 'amazon', 'state' =&gt; 'authorized', 'amazon_reference_id' =&gt; $reference ) ) ); exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the log in button</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function login_form() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( empty( $this-&gt;reference_id ) && 'amazon' == edd_get_chosen_gateway() ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          remove_all_actions( 'edd_purchase_form_after_cc_form' );&nbsp;</div></li><li><div>          remove_all_actions( 'edd_purchase_form_after_user_info' );&nbsp;</div></li><li><div>          remove_all_actions( 'edd_purchase_form_register_fields' );&nbsp;</div></li><li><div>          remove_all_actions( 'edd_purchase_form_login_fields' );&nbsp;</div></li><li><div>          remove_all_actions( 'edd_register_fields_before' );&nbsp;</div></li><li><div>          remove_all_actions( 'edd_cc_form' );&nbsp;</div></li><li><div>          remove_all_actions( 'edd_checkout_form_top' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          ob_start(); ?&gt;&nbsp;</div></li><li><div>          &lt;fieldset id=&quot;edd-amazon-login-fields&quot; class=&quot;edd-amazon-fields&quot;&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              &lt;div id=&quot;edd-amazon-pay-button&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>              &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>                  var authRequest;&nbsp;</div></li><li><div>                  OffAmazonPayments.Button('edd-amazon-pay-button', edd_amazon.sellerId, {&nbsp;</div></li><li><div>                      type:  edd_amazon.buttonType, &nbsp;</div></li><li><div>                      color: edd_amazon.buttonColor, &nbsp;</div></li><li><div>                      size:  edd_amazon.buttonSize, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      authorization: function() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          loginOptions = {&nbsp;</div></li><li><div>                              scope: edd_amazon.scope, &nbsp;</div></li><li><div>                              popup: edd_amazon.popup&nbsp;</div></li><li><div>                          };&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          authRequest = amazon.Login.authorize( loginOptions, edd_amazon.redirectUri );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onSignIn: function( orderReference ) {&nbsp;</div></li><li><div>                          amazonOrderReferenceId = orderReference.getAmazonOrderReferenceId();&nbsp;</div></li><li><div>                          window.location = edd_amazon.signinUri + '&amazon_reference_id=' + amazonOrderReferenceId;&nbsp;</div></li><li><div>                      }, onError: function(error) {&nbsp;</div></li><li><div>                          jQuery('#edd_purchase_submit').prepend( '&lt;div class=&quot;edd_errors&quot;&gt;&lt;p class=&quot;edd_error&quot; id=&quot;edd_error_&quot;' + error.getErrorCode() + '&gt;' + error.getErrorMessage() + '&lt;/p&gt;&lt;/div&gt;' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  });&nbsp;</div></li><li><div>              &lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;/fieldset&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      endif;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Display the wallet and address forms</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function wallet_form() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $profile = EDD()-&gt;session-&gt;get( 'amazon_profile' );&nbsp;</div></li><li><div>      remove_action( 'edd_purchase_form_after_cc_form', 'edd_checkout_tax_fields', 999 );&nbsp;</div></li><li><div>      ob_start(); ?&gt;&nbsp;</div></li><li><div>      &lt;fieldset id=&quot;edd_cc_fields&quot; class=&quot;edd-amazon-fields&quot;&gt;&nbsp;</div></li><li><div>          &lt;p class=&quot;edd-amazon-profile-wrapper&quot;&gt;&nbsp;</div></li><li><div>              &lt;?php _e( 'Currently logged into Amazon as', 'easy-digital-downloads' ); ?&gt;: &lt;span class=&quot;edd-amazon-profile-name&quot;&gt;&lt;?php echo $profile['name']; ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>              &lt;span class=&quot;edd-amazon-logout&quot;&gt;(&lt;a id=&quot;Logout&quot;&gt;&lt;?php _e( 'Logout', 'easy-digital-downloads' ); ?&gt;&lt;/a&gt;)&lt;/span&gt;&nbsp;</div></li><li><div>          &lt;/p&gt;&nbsp;</div></li><li><div>          &lt;?php if( edd_use_taxes() ) : ?&gt;&nbsp;</div></li><li><div>              &lt;div id=&quot;edd-amazon-address-box&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;?php endif; ?&gt;&nbsp;</div></li><li><div>          &lt;div id=&quot;edd-amazon-wallet-box&quot;&gt;&lt;/div&gt;&nbsp;</div></li><li><div>          &lt;script&gt;&nbsp;</div></li><li><div>              var edd_global_vars;&nbsp;</div></li><li><div>              if( '1' == edd_global_vars.taxes_enabled ) {&nbsp;</div></li><li><div>                  new OffAmazonPayments.Widgets.AddressBook({&nbsp;</div></li><li><div>                      sellerId: edd_amazon.sellerId, &nbsp;</div></li><li><div>                      amazonOrderReferenceId: edd_amazon.referenceID, &nbsp;</div></li><li><div>                      onOrderReferenceCreate: function(orderReference) {&nbsp;</div></li><li><div>                          orderReference.getAmazonOrderReferenceId();&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onAddressSelect: function(orderReference) {&nbsp;</div></li><li><div>                          jQuery.ajax({&nbsp;</div></li><li><div>                              type: &quot;POST&quot;, &nbsp;</div></li><li><div>                              data: {&nbsp;</div></li><li><div>                                  action       : 'edd_amazon_get_address', &nbsp;</div></li><li><div>                                  reference_id : edd_amazon.referenceID&nbsp;</div></li><li><div>                              }, &nbsp;</div></li><li><div>                              dataType: &quot;json&quot;, &nbsp;</div></li><li><div>                              url: edd_global_vars.ajaxurl, &nbsp;</div></li><li><div>                              xhrFields: {&nbsp;</div></li><li><div>                                  withCredentials: true&nbsp;</div></li><li><div>                              }, &nbsp;</div></li><li><div>                              success: function (response) {&nbsp;</div></li><li><div>                                  jQuery('#card_city').val( response.City );&nbsp;</div></li><li><div>                                  jQuery('#card_address').val( response.AddressLine1 );&nbsp;</div></li><li><div>                                  jQuery('#card_address_2').val( response.AddressLine2 );&nbsp;</div></li><li><div>                                  jQuery('#card_zip').val( response.PostalCode );&nbsp;</div></li><li><div>                                  jQuery('#billing_country').val( response.CountryCode );&nbsp;</div></li><li><div>                                  jQuery('#card_state').val( response.StateOrRegion ).trigger( 'change' );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }).fail(function (response) {&nbsp;</div></li><li><div>                              if ( window.console && window.console.log ) {&nbsp;</div></li><li><div>                                  console.log( response );&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }).done(function (response) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          });&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      design: {&nbsp;</div></li><li><div>                          designMode: 'responsive'&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onError: function(error) {&nbsp;</div></li><li><div>                          jQuery('#edd-amazon-address-box').hide();&nbsp;</div></li><li><div>                          jQuery('#edd_purchase_submit').prepend( '&lt;div class=&quot;edd_errors&quot;&gt;&lt;p class=&quot;edd_error&quot; id=&quot;edd_error_&quot;' + error.getErrorCode() + '&gt;' + error.getErrorMessage() + '&lt;/p&gt;&lt;/div&gt;' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }).bind(&quot;edd-amazon-address-box&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  new OffAmazonPayments.Widgets.Wallet({&nbsp;</div></li><li><div>                      sellerId: edd_amazon.sellerId, &nbsp;</div></li><li><div>                      amazonOrderReferenceId: edd_amazon.referenceID, &nbsp;</div></li><li><div>                      design: {&nbsp;</div></li><li><div>                          designMode: 'responsive'&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onPaymentSelect: function(orderReference) {&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment">// Display your custom complete purchase button</span></span>&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onError: function(error) {&nbsp;</div></li><li><div>                          jQuery('#edd_purchase_submit').prepend( '&lt;div class=&quot;edd_errors&quot;&gt;&lt;p class=&quot;edd_error&quot; id=&quot;edd_error_&quot;' + error.getErrorCode() + '&gt;' + error.getErrorMessage() + '&lt;/p&gt;&lt;/div&gt;' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }).bind(&quot;edd-amazon-wallet-box&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  new OffAmazonPayments.Widgets.Wallet({&nbsp;</div></li><li><div>                      sellerId: edd_amazon.sellerId, &nbsp;</div></li><li><div>                      design: {&nbsp;</div></li><li><div>                          designMode: 'responsive'&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onOrderReferenceCreate: function(orderReference) {&nbsp;</div></li><li><div>                          jQuery( '#edd_amazon_reference_id' ).val( orderReference.getAmazonOrderReferenceId() );&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onPaymentSelect: function(orderReference) {&nbsp;</div></li><li><div>                          <span class="comment"><span class="comment">// Display your custom complete purchase button</span></span>&nbsp;</div></li><li><div>                      }, &nbsp;</div></li><li><div>                      onError: function(error) {&nbsp;</div></li><li><div>                          jQuery('#edd_purchase_submit').prepend( '&lt;div class=&quot;edd_errors&quot;&gt;&lt;p class=&quot;edd_error&quot; id=&quot;edd_error_&quot;' + error.getErrorCode() + '&gt;' + error.getErrorMessage() + '&lt;/p&gt;&lt;/div&gt;' );&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }).bind(&quot;edd-amazon-wallet-box&quot;);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          &lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          &lt;div id=&quot;edd_cc_address&quot;&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;edd_amazon_reference_id&quot; id=&quot;edd_amazon_reference_id&quot; value=&quot;&lt;?php echo esc_attr( $this-&gt;reference_id ); ?&gt;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;card_city&quot; class=&quot;card_city&quot; id=&quot;card_city&quot; value=&quot;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;card_address&quot; class=&quot;card_address&quot; id=&quot;card_address&quot; value=&quot;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;card_address_2&quot; class=&quot;card_address_2&quot; id=&quot;card_address_2&quot; value=&quot;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;card_zip&quot; class=&quot;card_zip&quot; id=&quot;card_zip&quot; value=&quot;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;card_state&quot; class=&quot;card_state&quot; id=&quot;card_state&quot; value=&quot;&quot;/&gt;&nbsp;</div></li><li><div>              &lt;input type=&quot;hidden&quot; name=&quot;billing_country&quot; class=&quot;billing_country&quot; id=&quot;billing_country&quot; value=&quot;&quot;/&gt;&nbsp;</div></li><li><div>          &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;/fieldset&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      &lt;?php&nbsp;</div></li><li><div>      $form = ob_get_clean();&nbsp;</div></li><li><div>      echo $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the billing address via ajax</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function ajax_get_address() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! $this-&gt;is_setup() ) {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $_POST['reference_id'] ) ) {&nbsp;</div></li><li><div>          die( '-2' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $request = $this-&gt;client-&gt;getOrderReferenceDetails( array(&nbsp;</div></li><li><div>          'merchant_id' =&gt; edd_get_option( 'amazon_seller_id', '' ), &nbsp;</div></li><li><div>          'amazon_order_reference_id' =&gt; $_POST['reference_id'], &nbsp;</div></li><li><div>          'address_consent_token' =&gt; EDD()-&gt;session-&gt;get( 'amazon_access_token' )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $address = array();&nbsp;</div></li><li><div>      $data = new ResponseParser( $request-&gt;response );&nbsp;</div></li><li><div>      $data = $data-&gt;toArray();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $data['GetOrderReferenceDetailsResult']['OrderReferenceDetails']['Destination']['PhysicalDestination'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $address = $data['GetOrderReferenceDetailsResult']['OrderReferenceDetails']['Destination']['PhysicalDestination'];&nbsp;</div></li><li><div>          $address = wp_parse_args( $address, array( 'City', 'CountryCode', 'StateOrRegion', 'PostalCode', 'AddressLine1', 'AddressLine2' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      echo json_encode( $address ); exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Check for errors during checkout</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $valid_data Customer / product data from checkout</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $post_data $_POST</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function checkout_errors( $valid_data, $post_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// should validate that we have a reference ID here, perhaps even fire the API call here</span>&nbsp;</div></li><li><div>      if( empty( $post_data['edd_amazon_reference_id'] ) ) {&nbsp;</div></li><li><div>          edd_set_error( 'missing_reference_id', __( 'Missing Reference ID, please try again', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process the purchase and create the charge in Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $purchase_data array Cart details</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_purchase( $purchase_data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $purchase_data['post_data']['edd_amazon_reference_id'] ) ) {&nbsp;</div></li><li><div>          edd_set_error( 'missing_reference_id', __( 'Missing Reference ID, please try again', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $errors = edd_get_errors();&nbsp;</div></li><li><div>      if ( $errors ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_send_back_to_checkout( '?payment-mode=amazon' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args = apply_filters( 'edd_amazon_charge_args', array(&nbsp;</div></li><li><div>          'merchant_id' =&gt; edd_get_option( 'amazon_seller_id', '' ), &nbsp;</div></li><li><div>          'amazon_reference_id' =&gt; $purchase_data['post_data']['edd_amazon_reference_id'], &nbsp;</div></li><li><div>          'authorization_reference_id' =&gt; $purchase_data['purchase_key'], &nbsp;</div></li><li><div>          'charge_amount' =&gt; $purchase_data['price'], &nbsp;</div></li><li><div>          'currency_code' =&gt; edd_get_currency(), &nbsp;</div></li><li><div>          'charge_note' =&gt; html_entity_decode( edd_get_purchase_summary( $purchase_data, false ) ), &nbsp;</div></li><li><div>          'charge_order_id' =&gt; $purchase_data['purchase_key'], &nbsp;</div></li><li><div>          'store_name' =&gt; remove_accents( wp_specialchars_decode( get_bloginfo( 'name' ), ENT_QUOTES ) ), &nbsp;</div></li><li><div>          'transaction_timeout' =&gt; 0&nbsp;</div></li><li><div> ), $purchase_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $args['platform_id'] = 'A3JST9YM1SX7LB';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $charge = $this-&gt;client-&gt;charge( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 200 == $charge-&gt;response['Status'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $charge = new ResponseParser( $charge-&gt;response );&nbsp;</div></li><li><div>          $charge = $charge-&gt;toArray();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $status = $charge['AuthorizeResult']['AuthorizationDetails']['AuthorizationStatus']['State'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( 'Declined' === $status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $reason = $charge['AuthorizeResult']['AuthorizationDetails']['AuthorizationStatus']['ReasonCode'];&nbsp;</div></li><li><div>              edd_set_error( 'payment_declined', sprintf( __( 'Your payment could not be authorized, please try a different payment method. Reason: %s', 'easy-digital-downloads' ), $reason ) );&nbsp;</div></li><li><div>              edd_send_back_to_checkout( '?payment-mode=amazon&amazon_reference_id=' . $purchase_data['post_data']['edd_amazon_reference_id'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Setup payment data to be recorded</span>&nbsp;</div></li><li><div>          $payment_data = array(&nbsp;</div></li><li><div>              'price' =&gt; $purchase_data['price'], &nbsp;</div></li><li><div>              'date' =&gt; $purchase_data['date'], &nbsp;</div></li><li><div>              'user_email' =&gt; $purchase_data['user_email'], &nbsp;</div></li><li><div>              'purchase_key' =&gt; $purchase_data['purchase_key'], &nbsp;</div></li><li><div>              'currency' =&gt; edd_get_currency(), &nbsp;</div></li><li><div>              'downloads' =&gt; $purchase_data['downloads'], &nbsp;</div></li><li><div>              'user_info' =&gt; $purchase_data['user_info'], &nbsp;</div></li><li><div>              'cart_details' =&gt; $purchase_data['cart_details'], &nbsp;</div></li><li><div>              'gateway' =&gt; $this-&gt;gateway_id, &nbsp;</div></li><li><div>              'status' =&gt; 'pending', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $payment_id = edd_insert_payment( $payment_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $authorization_id = $charge['AuthorizeResult']['AuthorizationDetails']['AmazonAuthorizationId'];&nbsp;</div></li><li><div>          $capture_id = str_replace( '-A', '-C', $authorization_id );&nbsp;</div></li><li><div>          $reference_id = sanitize_text_field( $_POST['edd_amazon_reference_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Confirm the capture was completed</span>&nbsp;</div></li><li><div>          $capture = $this-&gt;client-&gt;getCaptureDetails( array(&nbsp;</div></li><li><div>              'merchant_id' =&gt; edd_get_option( 'amazon_seller_id', '' ), &nbsp;</div></li><li><div>              'amazon_capture_id' =&gt; $capture_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $capture = new ResponseParser( $capture-&gt;response );&nbsp;</div></li><li><div>          $capture = $capture-&gt;toArray();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_update_payment_meta( $payment_id, '_edd_amazon_authorization_id', $authorization_id );&nbsp;</div></li><li><div>          edd_update_payment_meta( $payment_id, '_edd_amazon_capture_id', $capture_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_set_payment_transaction_id( $payment_id, $reference_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_update_payment_status( $payment_id, 'publish' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Empty the shopping cart</span>&nbsp;</div></li><li><div>          edd_empty_cart();&nbsp;</div></li><li><div>          edd_send_to_success_page();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Set an error</span>&nbsp;</div></li><li><div>          edd_set_error( 'amazon_error', sprintf( __( 'There was an issue processing your payment. Amazon error: %s', 'easy-digital-downloads' ), print_r( $charge, true ) ) );&nbsp;</div></li><li><div>          edd_send_back_to_checkout( '?payment-mode=amazon&amazon_reference_id=' . $purchase_data['post_data']['edd_amazon_reference_id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the checkout URL for Amazon after authentication is complete</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_amazon_checkout_uri() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $this-&gt;checkout_uri ) ) {&nbsp;</div></li><li><div>          $this-&gt;checkout_uri = esc_url_raw( add_query_arg( array( 'payment-mode' =&gt; 'amazon' ), edd_get_checkout_uri() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;checkout_uri;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the return URL for Amazon after authentication on Amazon is complete</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_amazon_authenticate_redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $this-&gt;redirect_uri ) ) {&nbsp;</div></li><li><div>          $this-&gt;redirect_uri = esc_url_raw( add_query_arg( array( 'edd-listener' =&gt; 'amazon', 'state' =&gt; 'return_auth' ), edd_get_checkout_uri() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;redirect_uri;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the URL to send customers too once sign-in is complete</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_amazon_signin_redirect() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_null( $this-&gt;signin_redirect ) ) {&nbsp;</div></li><li><div>          $this-&gt;signin_redirect = esc_url_raw( add_query_arg( array( 'edd-listener' =&gt; 'amazon', 'state' =&gt; 'signed-in' ), home_url() ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $this-&gt;signin_redirect;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the IPN URL for Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_amazon_ipn_url() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return esc_url_raw( add_query_arg( array( 'edd-listener' =&gt; 'amazon' ), home_url( 'index.php' ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Removes the requirement for entering the billing address</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * Address is pulled directly from Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function disable_address_requirement() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( ! empty( $_POST['edd-gateway'] ) && $this-&gt;gateway_id == $_REQUEST['edd-gateway'] ) {&nbsp;</div></li><li><div>          add_filter( 'edd_require_billing_address', '__return_false', 9999 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Given a transaction ID, generate a link to the Amazon transaction ID details</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  string $transaction_id The Transaction ID</span>&nbsp;</div></li><li><div><span class="comment">   * @param  int    $payment_id     The payment ID for this transaction</span>&nbsp;</div></li><li><div><span class="comment">   * @return string                 A link to the PayPal transaction details</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function link_transaction_id( $transaction_id, $payment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $base_url = 'https:<span class="comment">//sellercentral.amazon.com/hz/me/pmd/payment-details?orderReferenceId=';</span>&nbsp;</div></li><li><div>      $transaction_url = '&lt;a href=&quot;' . esc_url( $base_url . $transaction_id ) . '&quot; target=&quot;_blank&quot;&gt;' . $transaction_id . '&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'edd_' . $this-&gt;gateway_id . '_link_payment_details_transaction_id', $transaction_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Process IPN messages from Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_ipn() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! isset( $_GET['edd-listener'] ) || $_GET['edd-listener'] !== 'amazon' ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( isset( $_GET['state'] ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the IPN headers and Message body</span>&nbsp;</div></li><li><div>      $headers = getallheaders();&nbsp;</div></li><li><div>      $body = file_get_contents( 'php:<span class="comment">//input' );</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;doing_ipn = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      try {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $ipn = new IpnHandler( $headers, $body );&nbsp;</div></li><li><div>          $data = $ipn-&gt;toArray();&nbsp;</div></li><li><div>          $seller_id = $data['SellerId'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( $seller_id != edd_get_option( 'amazon_seller_id', '' ) ) {&nbsp;</div></li><li><div>              wp_die( __( 'Invalid Amazon seller ID', 'easy-digital-downloads' ), __( 'IPN Error', 'easy-digital-downloads' ), array( 'response' =&gt; 401 ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch( $data['NotificationType'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'OrderReferenceNotification' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'PaymentAuthorize' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'PaymentCapture' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $key = $data['CaptureDetails']['CaptureReferenceId'];&nbsp;</div></li><li><div>                  $status = $data['CaptureDetails']['CaptureStatus']['State'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if( 'Declined' === $status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $payment_id = edd_get_purchase_id_by_key( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      edd_update_payment_status( $payment_id, 'failed' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      edd_insert_payment_note( $payment_id, __( 'Capture declined in Amazon', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'PaymentRefund' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $trans_id = substr( $data['RefundDetails']['AmazonRefundId'], 0, 19 );&nbsp;</div></li><li><div>                  $status = $data['RefundDetails']['RefundStatus']['State'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  if( 'Completed' === $status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $payment_id = edd_get_purchase_id_by_transaction_id( $trans_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      edd_update_payment_status( $payment_id, 'refunded' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      edd_insert_payment_note( $payment_id, sprintf( __( 'Refund completed in Amazon. Refund ID: %s', 'easy-digital-downloads' ), $data['RefundDetails']['AmazonRefundId'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } catch( Exception $e ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          wp_die( $e-&gt;getErrorMessage(), __( 'IPN Error', 'easy-digital-downloads' ), array( 'response' =&gt; 401 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Detect a refund action from EDD</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $payment_id int The ID number of the payment being refunded</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $new_status string The new status assigned to the payment</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $old_status string The previous status of the payment</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public function process_refund( $payment_id, $new_status, $old_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'publish' != $old_status && 'revoked' != $old_status ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'refunded' != $new_status ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $this-&gt;doing_ipn ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 'amazon' !== edd_get_payment_gateway( $payment_id ) ) {&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $this-&gt;refund( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Refund a charge in Amazon</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @param  $payment_id int The ID number of the payment being refunded</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function refund( $payment_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $refund = $this-&gt;client-&gt;refund( array(&nbsp;</div></li><li><div>          'merchant_id' =&gt; edd_get_option( 'amazon_seller_id', '' ), &nbsp;</div></li><li><div>          'amazon_capture_id' =&gt; edd_get_payment_meta( $payment_id, '_edd_amazon_capture_id', true ), &nbsp;</div></li><li><div>          'refund_reference_id' =&gt; md5( edd_get_payment_key( $payment_id ) . '-refund' ), &nbsp;</div></li><li><div>          'refund_amount' =&gt; edd_get_payment_amount( $payment_id ), &nbsp;</div></li><li><div>          'currency_code' =&gt; edd_get_payment_currency_code( $payment_id ), &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( 200 == $refund-&gt;response['Status'] ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $refund = new ResponseParser( $refund-&gt;response );&nbsp;</div></li><li><div>          $refund = $refund-&gt;toArray();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $reference_id = $refund['RefundResult']['RefundDetails']['RefundReferenceId'];&nbsp;</div></li><li><div>          $status = $refund['RefundResult']['RefundDetails']['RefundStatus']['State'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch( $status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'Declined' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $code = $refund['RefundResult']['RefundDetails']['RefundStatus']['ReasonCode'];&nbsp;</div></li><li><div>                  $note = __( 'Refund declined in Amazon. Refund ID: %s', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'Completed' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $refund_id = $refund['RefundResult']['RefundDetails']['AmazonRefundId'];&nbsp;</div></li><li><div>                  $note = sprintf( __( 'Refund completed in Amazon. Refund ID: %s', 'easy-digital-downloads' ), $refund_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'Pending' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = sprintf( __( 'Refund initiated in Amazon. Reference ID: %s', 'easy-digital-downloads' ), $reference_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_insert_payment_note( $payment_id, $note );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_insert_payment_note( $payment_id, __( 'Refund request failed in Amazon.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Retrieve the URL for connecting Amazon account to EDD</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @access public</span>&nbsp;</div></li><li><div><span class="comment">   * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment">   * @return string</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  private function get_registration_url() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      switch ( edd_get_shop_country() ) {&nbsp;</div></li><li><div>          case 'GB':&nbsp;</div></li><li><div>              $base_url = 'https:<span class="comment">//payments.amazon.co.uk/preregistration/lpa';</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          case 'DE':&nbsp;</div></li><li><div>              $base_url = 'https:<span class="comment">//payments.amazon.de/preregistration/lpa';</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              $base_url = 'https:<span class="comment">//sellercentral.amazon.com/hz/me/sp/signup';</span>&nbsp;</div></li><li><div>          break;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $query_args = array(&nbsp;</div></li><li><div>          'solutionProviderId' =&gt; 'A3JST9YM1SX7LB', &nbsp;</div></li><li><div>          'marketplaceId' =&gt; 'AGWSWK15IEJJ7', &nbsp;</div></li><li><div>          'solutionProviderToken' =&gt; 'AAAAAQAAAAEAAAAQnngerc8vYweGDt8byl2smgAAAHBgMm923quugHaGmPi%2B3sqo93TSL1aKwU85v71Zh7EXVK8De%2FuahjCFHft3cxN3rwAF4Iwg03sDW0jnkLULmFk7M1Fr69IV2XF477m0kU1EM0Z%2FbQssHdLai%2Fzoce1jZVmw8So3F2jhiDyfTHUK2AYP', &nbsp;</div></li><li><div>          'solutionProviderOptions' =&gt; 'lwa%3Bmws-acc%3B', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return add_query_arg( $query_args, $base_url );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Load EDD_Amazon_Payments</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return object EDD_Amazon_Payments</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function EDD_Amazon() {&nbsp;</div></li><li><div>  return EDD_Amazon_Payments::getInstance();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>EDD_Amazon();&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Easy Digital Downloads</li><li><span></span>2.7.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>