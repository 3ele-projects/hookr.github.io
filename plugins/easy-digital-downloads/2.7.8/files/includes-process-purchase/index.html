<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.8" data-slug="easy-digital-downloads" data-type="file" data-id="58222"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-process-purchase | file | Easy Digital Downloads | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, easy-digital-downloads, 2.7.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=5607f64d4c3482bcb8eb1217ba67fe83' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-process-purchase/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-process-purchase%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-process-purchase%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-easy-digital-downloads-2.7.8-file-includes-process-purchase","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-process-purchase" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to easy-digital-downloads." href="http://hookr.io/plugins/easy-digital-downloads/" class="plugin"><span property="name">easy-digital-downloads</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.8." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/" class="H_VERSION"><span property="name">2.7.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-process-purchase</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2274"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/all/" title="All">All <span class="count badge">2274</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="1195"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/hooks/" title="Hooks">Hooks <span class="count badge">1195</span></a></li><li class="" data-id="action" data-count="469"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/actions/" title="Actions">Actions <span class="count badge">469</span></a></li><li class="" data-id="filter" data-count="726"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/filters/" title="Filters">Filters <span class="count badge">726</span></a></li><li class="" data-id="class" data-count="99"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" title="Classes">Classes <span class="count badge">99</span></a></li><li class="" data-id="constant" data-count="11"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/constants/" title="Constants">Constants <span class="count badge">11</span></a></li><li class="" data-id="function" data-count="955"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/functions/" title="Functions">Functions <span class="count badge">955</span></a></li><li class="" data-id="shortcode" data-count="14"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">14</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/process-purchase.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process Purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package     EDD</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage  Functions</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright   Copyright (c) 2015, Pippin Williamson</span>&nbsp;</div></li><li><div><span class="comment"> * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process Purchase Form</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * Handles the purchase form process.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return      void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_purchase_form() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  do_action( 'edd_pre_process_purchase' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure the cart isn't empty</span>&nbsp;</div></li><li><div>  if ( ! edd_get_cart_contents() && ! edd_cart_has_fees() ) {&nbsp;</div></li><li><div>      $valid_data = false;&nbsp;</div></li><li><div>      edd_set_error( 'empty_cart', __( 'Your cart is empty', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Validate the form $_POST data</span>&nbsp;</div></li><li><div>      $valid_data = edd_purchase_form_validate_fields();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Allow themes and plugins to hook</span> to errors</span>&nbsp;</div></li><li><div>      do_action( 'edd_checkout_error_checks', $valid_data, $_POST );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_ajax = isset( $_POST['edd_ajax'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Process the login form</span>&nbsp;</div></li><li><div>  if ( isset( $_POST['edd_login_submit'] ) ) {&nbsp;</div></li><li><div>      edd_process_purchase_login();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate the user</span>&nbsp;</div></li><li><div>  $user = edd_get_purchase_form_user( $valid_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Let extensions validate fields after user is logged in if user has used login/registration form</span>&nbsp;</div></li><li><div>  do_action( 'edd_checkout_user_error_checks', $user, $valid_data, $_POST );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( false === $valid_data || edd_get_errors() || ! $user ) {&nbsp;</div></li><li><div>      if ( $is_ajax ) {&nbsp;</div></li><li><div>          do_action( 'edd_ajax_checkout_errors' );&nbsp;</div></li><li><div>          edd_die();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_ajax ) {&nbsp;</div></li><li><div>      echo 'success';&nbsp;</div></li><li><div>      edd_die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup user information</span>&nbsp;</div></li><li><div>  $user_info = array(&nbsp;</div></li><li><div>      'id' =&gt; $user['user_id'], &nbsp;</div></li><li><div>      'email' =&gt; $user['user_email'], &nbsp;</div></li><li><div>      'first_name' =&gt; $user['user_first'], &nbsp;</div></li><li><div>      'last_name' =&gt; $user['user_last'], &nbsp;</div></li><li><div>      'discount' =&gt; $valid_data['discount'], &nbsp;</div></li><li><div>      'address' =&gt; $user['address']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $auth_key = defined( 'AUTH_KEY' ) ? AUTH_KEY : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $card_country = isset( $valid_data['cc_info']['card_country'] ) ? $valid_data['cc_info']['card_country'] : false;&nbsp;</div></li><li><div>  $card_state = isset( $valid_data['cc_info']['card_state'] )   ? $valid_data['cc_info']['card_state']   : false;&nbsp;</div></li><li><div>  $card_zip = isset( $valid_data['cc_info']['card_zip'] )     ? $valid_data['cc_info']['card_zip']     : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set up the unique purchase key. If we are resuming a payment, we'll overwrite this with the existing key.</span>&nbsp;</div></li><li><div>  $purchase_key = strtolower( md5( $user['user_email'] . date( 'Y-m-d H:i:s' ) . $auth_key . uniqid( 'edd', true ) ) );&nbsp;</div></li><li><div>  $existing_payment = EDD()-&gt;session-&gt;get( 'edd_resume_payment' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $existing_payment ) ) {&nbsp;</div></li><li><div>      $payment = new EDD_Payment( $existing_payment );&nbsp;</div></li><li><div>      if( $payment-&gt;is_recoverable() && ! empty( $payment-&gt;key ) ) {&nbsp;</div></li><li><div>          $purchase_key = $payment-&gt;key;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup purchase information</span>&nbsp;</div></li><li><div>  $purchase_data = array(&nbsp;</div></li><li><div>      'downloads' =&gt; edd_get_cart_contents(), &nbsp;</div></li><li><div>      'fees' =&gt; edd_get_cart_fees(), <span class="comment">// Any arbitrary fees that have been added to the cart</span>&nbsp;</div></li><li><div>      'subtotal' =&gt; edd_get_cart_subtotal(), <span class="comment">// Amount before taxes and discounts</span>&nbsp;</div></li><li><div>      'discount' =&gt; edd_get_cart_discounted_amount(), <span class="comment">// Discounted amount</span>&nbsp;</div></li><li><div>      'tax' =&gt; edd_get_cart_tax(), <span class="comment">// Taxed amount</span>&nbsp;</div></li><li><div>      'tax_rate' =&gt; edd_get_cart_tax_rate( $card_country, $card_state, $card_zip ), <span class="comment">// Tax rate</span>&nbsp;</div></li><li><div>      'price' =&gt; edd_get_cart_total(), <span class="comment">// Amount after taxes</span>&nbsp;</div></li><li><div>      'purchase_key' =&gt; $purchase_key, &nbsp;</div></li><li><div>      'user_email' =&gt; $user['user_email'], &nbsp;</div></li><li><div>      'date' =&gt; date( 'Y-m-d H:i:s', current_time( 'timestamp' ) ), &nbsp;</div></li><li><div>      'user_info' =&gt; stripslashes_deep( $user_info ), &nbsp;</div></li><li><div>      'post_data' =&gt; $_POST, &nbsp;</div></li><li><div>      'cart_details' =&gt; edd_get_cart_content_details(), &nbsp;</div></li><li><div>      'gateway' =&gt; $valid_data['gateway'], &nbsp;</div></li><li><div>      'card_info' =&gt; $valid_data['cc_info']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Add the user data for hooks</span>&nbsp;</div></li><li><div>  $valid_data['user'] = $user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Allow themes and plugins to hook</span> before the gateway</span>&nbsp;</div></li><li><div>  do_action( 'edd_checkout_before_gateway', $_POST, $user_info, $valid_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the total amount in the cart is 0, send to the manual gateway. This emulates a free download purchase</span>&nbsp;</div></li><li><div>  if ( !$purchase_data['price'] ) {&nbsp;</div></li><li><div>      <span class="comment">// Revert to manual</span>&nbsp;</div></li><li><div>      $purchase_data['gateway'] = 'manual';&nbsp;</div></li><li><div>      $_POST['edd-gateway'] = 'manual';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Allow the purchase data to be modified before it is sent to the gateway</span>&nbsp;</div></li><li><div>  $purchase_data = apply_filters(&nbsp;</div></li><li><div>      'edd_purchase_data_before_gateway', &nbsp;</div></li><li><div>      $purchase_data, &nbsp;</div></li><li><div>      $valid_data&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Setup the data we're storing in the purchase session</span>&nbsp;</div></li><li><div>  $session_data = $purchase_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Make sure credit card numbers are never stored in sessions</span>&nbsp;</div></li><li><div>  unset( $session_data['card_info']['card_number'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Used for showing download links to non logged-in users after purchase, and for other plugins needing purchase data.</span>&nbsp;</div></li><li><div>  edd_set_purchase_session( $session_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Send info to the gateway for payment processing</span>&nbsp;</div></li><li><div>  edd_send_to_gateway( $purchase_data['gateway'], $purchase_data );&nbsp;</div></li><li><div>  edd_die();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_purchase', 'edd_process_purchase_form' );&nbsp;</div></li><li><div>add_action( 'wp_ajax_edd_process_checkout', 'edd_process_purchase_form' );&nbsp;</div></li><li><div>add_action( 'wp_ajax_nopriv_edd_process_checkout', 'edd_process_purchase_form' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Verify that when a logged in user makes a purchase that the email address used doesn't belong to a different customer</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $valid_data Validated data submitted for the purchase</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $post       Additional $_POST data submitted</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_checkout_check_existing_email( $valid_data, $post ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify that the email address belongs to this customer</span>&nbsp;</div></li><li><div>  if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $email = strtolower( $valid_data['logged_in_user']['user_email'] );&nbsp;</div></li><li><div>      $customer = new EDD_Customer( get_current_user_id(), true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If this email address is not registered with this customer, see if it belongs to any other customer</span>&nbsp;</div></li><li><div>      if ( $email != strtolower( $customer-&gt;email ) && ( is_array( $customer-&gt;emails ) && ! in_array( $email, array_map( 'strtolower', $customer-&gt;emails ) ) ) ) {&nbsp;</div></li><li><div>          $found_customer = new EDD_Customer( $email );&nbsp;</div></li><li><div>          if ( $found_customer-&gt;id &gt; 0 ) {&nbsp;</div></li><li><div>              edd_set_error( 'edd-customer-email-exists', __( sprintf( 'The email address %s is already in use.', $email ), 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_checkout_error_checks', 'edd_checkout_check_existing_email', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process the checkout login form</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.8</span>&nbsp;</div></li><li><div><span class="comment"> * @return      void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_purchase_login() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $is_ajax = isset( $_POST['edd_ajax'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_data = edd_purchase_form_validate_user_login();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( edd_get_errors() || $user_data['user_id'] &lt; 1 ) {&nbsp;</div></li><li><div>      if ( $is_ajax ) {&nbsp;</div></li><li><div>          do_action( 'edd_ajax_checkout_errors' );&nbsp;</div></li><li><div>          edd_die();&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          wp_redirect( $_SERVER['HTTP_REFERER'] ); exit;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  edd_log_user_in( $user_data['user_id'], $user_data['user_login'], $user_data['user_pass'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_ajax ) {&nbsp;</div></li><li><div>      echo 'success';&nbsp;</div></li><li><div>      edd_die();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      wp_redirect( edd_get_checkout_uri( $_SERVER['QUERY_STRING'] ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'wp_ajax_edd_process_checkout_login', 'edd_process_purchase_login' );&nbsp;</div></li><li><div>add_action( 'wp_ajax_nopriv_edd_process_checkout_login', 'edd_process_purchase_login' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate Fields</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return      bool|array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_fields() {&nbsp;</div></li><li><div>  <span class="comment">// Check if there is $_POST</span>&nbsp;</div></li><li><div>  if ( empty( $_POST ) ) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Start an array to collect valid data</span>&nbsp;</div></li><li><div>  $valid_data = array(&nbsp;</div></li><li><div>      'gateway' =&gt; edd_purchase_form_validate_gateway(), <span class="comment">// Gateway fallback</span>&nbsp;</div></li><li><div>      'discount' =&gt; edd_purchase_form_validate_discounts(), <span class="comment">// Set default discount</span>&nbsp;</div></li><li><div>      'need_new_user' =&gt; false, <span class="comment">// New user flag</span>&nbsp;</div></li><li><div>      'need_user_login' =&gt; false, <span class="comment"><span class="comment">// Login user</span> flag</span>&nbsp;</div></li><li><div>      'logged_user_data' =&gt; array(), <span class="comment">// Logged user collected data</span>&nbsp;</div></li><li><div>      'new_user_data' =&gt; array(), <span class="comment">// New user collected data</span>&nbsp;</div></li><li><div>      'login_user_data' =&gt; array(), <span class="comment"><span class="comment">// Login user</span> collected data</span>&nbsp;</div></li><li><div>      'guest_user_data' =&gt; array(), <span class="comment">// Guest user collected data</span>&nbsp;</div></li><li><div>      'cc_info' =&gt; edd_purchase_form_validate_cc()    <span class="comment">// Credit card info</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Validate agree to terms</span></span>&nbsp;</div></li><li><div>  if ( edd_get_option( 'show_agree_to_terms', false ) )&nbsp;</div></li><li><div>      edd_purchase_form_validate_agree_to_terms();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>      <span class="comment">// Collect logged in user data</span>&nbsp;</div></li><li><div>      $valid_data['logged_in_user'] = edd_purchase_form_validate_logged_in_user();&nbsp;</div></li><li><div>  } else if ( isset( $_POST['edd-purchase-var'] ) && $_POST['edd-purchase-var'] == 'needs-to-register' ) {&nbsp;</div></li><li><div>      <span class="comment">// Set new user registration as required</span>&nbsp;</div></li><li><div>      $valid_data['need_new_user'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Validate new user data</span>&nbsp;</div></li><li><div>      $valid_data['new_user_data'] = edd_purchase_form_validate_new_user();&nbsp;</div></li><li><div>      <span class="comment">// Check if login validation is needed</span>&nbsp;</div></li><li><div>  } else if ( isset( $_POST['edd-purchase-var'] ) && $_POST['edd-purchase-var'] == 'needs-to-login' ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment"><span class="comment">// Set user</span></span></span> login as required</span>&nbsp;</div></li><li><div>      $valid_data['need_user_login'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Validate users login info</span>&nbsp;</div></li><li><div>      $valid_data['login_user_data'] = edd_purchase_form_validate_user_login();&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Not registering or logging in, so setup guest user data</span>&nbsp;</div></li><li><div>      $valid_data['guest_user_data'] = edd_purchase_form_validate_guest_user();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return collected data</span>&nbsp;</div></li><li><div>  return $valid_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate Gateway</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return      string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_gateway() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $gateway = edd_get_default_gateway();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if a gateway value is present</span>&nbsp;</div></li><li><div>  if ( ! empty( $_REQUEST['edd-gateway'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $gateway = sanitize_text_field( $_REQUEST['edd-gateway'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '0.00' == edd_get_cart_total() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $gateway = 'manual';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } elseif ( ! edd_is_gateway_active( $gateway ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_set_error( 'invalid_gateway', __( 'The selected payment gateway is not enabled', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $gateway;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate Discounts</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return      string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_discounts() {&nbsp;</div></li><li><div>  <span class="comment">// Retrieve the discount stored in cookies</span>&nbsp;</div></li><li><div>  $discounts = edd_get_cart_discounts();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user = '';&nbsp;</div></li><li><div>  if ( isset( $_POST['edd_user_login'] ) && ! empty( $_POST['edd_user_login'] ) ) {&nbsp;</div></li><li><div>      $user = sanitize_text_field( $_POST['edd_user_login'] );&nbsp;</div></li><li><div>  } else if ( isset( $_POST['edd_email'] ) && ! empty($_POST['edd_email'] ) ) {&nbsp;</div></li><li><div>      $user = sanitize_text_field( $_POST['edd_email'] );&nbsp;</div></li><li><div>  } else if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>      $user = wp_get_current_user()-&gt;user_email;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $error = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check for valid discount(s) is present</span>&nbsp;</div></li><li><div>  if ( ! empty( $_POST['edd-discount'] ) && __( 'Enter discount', 'easy-digital-downloads' ) != $_POST['edd-discount'] ) {&nbsp;</div></li><li><div>      <span class="comment">// Check for a posted discount</span>&nbsp;</div></li><li><div>      $posted_discount = isset( $_POST['edd-discount'] ) ? trim( $_POST['edd-discount'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add the posted discount to the discounts</span>&nbsp;</div></li><li><div>      if ( $posted_discount && ( empty( $discounts ) || edd_multiple_discounts_allowed() ) && edd_is_discount_valid( $posted_discount, $user ) ) {&nbsp;</div></li><li><div>          edd_set_cart_discount( $posted_discount );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If we have discounts, loop through them</span>&nbsp;</div></li><li><div>  if ( ! empty( $discounts ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      foreach ( $discounts as $discount ) {&nbsp;</div></li><li><div>          <span class="comment">// Check if valid</span>&nbsp;</div></li><li><div>          if (  ! edd_is_discount_valid( $discount, $user ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Discount is not valid</span>&nbsp;</div></li><li><div>              $error = true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// No discounts</span>&nbsp;</div></li><li><div>      return 'none';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $error ) {&nbsp;</div></li><li><div>      edd_set_error( 'invalid_discount', __( 'One or more of the discounts you entered is invalid', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return implode( ', ', $discounts );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate Agree To Terms</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return      void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_agree_to_terms() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Validate agree to terms</span></span>&nbsp;</div></li><li><div>  if ( ! isset( $_POST['edd_agree_to_terms'] ) || $_POST['edd_agree_to_terms'] != 1 ) {&nbsp;</div></li><li><div>      <span class="comment">// User did not agree</span>&nbsp;</div></li><li><div>      edd_set_error( 'agree_to_terms', apply_filters( 'edd_agree_to_terms_text', __( 'You must agree to the terms of use', 'easy-digital-downloads' ) ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Required Fields</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.5</span>&nbsp;</div></li><li><div><span class="comment"> * @return      array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_required_fields() {&nbsp;</div></li><li><div>  $required_fields = array(&nbsp;</div></li><li><div>      'edd_email' =&gt; array(&nbsp;</div></li><li><div>          'error_id' =&gt; 'invalid_email', &nbsp;</div></li><li><div>          'error_message' =&gt; __( 'Please enter a valid email address', 'easy-digital-downloads' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>      'edd_first' =&gt; array(&nbsp;</div></li><li><div>          'error_id' =&gt; 'invalid_first_name', &nbsp;</div></li><li><div>          'error_message' =&gt; __( 'Please enter your first name', 'easy-digital-downloads' )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Let payment gateways and other extensions determine if address fields should be required</span>&nbsp;</div></li><li><div>  $require_address = apply_filters( 'edd_require_billing_address', edd_use_taxes() && edd_get_cart_total() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $require_address ) {&nbsp;</div></li><li><div>      $required_fields['card_zip'] = array(&nbsp;</div></li><li><div>          'error_id' =&gt; 'invalid_zip_code', &nbsp;</div></li><li><div>          'error_message' =&gt; __( 'Please enter your zip / postal code', 'easy-digital-downloads' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $required_fields['card_city'] = array(&nbsp;</div></li><li><div>          'error_id' =&gt; 'invalid_city', &nbsp;</div></li><li><div>          'error_message' =&gt; __( 'Please enter your billing city', 'easy-digital-downloads' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $required_fields['billing_country'] = array(&nbsp;</div></li><li><div>          'error_id' =&gt; 'invalid_country', &nbsp;</div></li><li><div>          'error_message' =&gt; __( 'Please select your billing country', 'easy-digital-downloads' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $required_fields['card_state'] = array(&nbsp;</div></li><li><div>          'error_id' =&gt; 'invalid_state', &nbsp;</div></li><li><div>          'error_message' =&gt; __( 'Please enter billing state / province', 'easy-digital-downloads' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check if the Customer's Country has been passed in and if it has no states.</span>&nbsp;</div></li><li><div>      if ( isset( $_POST['billing_country'] ) && isset( $required_fields['card_state'] ) ) {&nbsp;</div></li><li><div>          $customer_billing_country = sanitize_text_field( $_POST['billing_country'] );&nbsp;</div></li><li><div>          $states = edd_get_shop_states( $customer_billing_country );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// If this country has no states, remove the requirement of a card_state.</span>&nbsp;</div></li><li><div>          if ( empty( $states ) ) {&nbsp;</div></li><li><div>              unset( $required_fields['card_state'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_purchase_form_required_fields', $required_fields );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate Logged In User</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return      array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_logged_in_user() {&nbsp;</div></li><li><div>  global $user_ID;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Start empty array to collect valid user data</span>&nbsp;</div></li><li><div>  $valid_user_data = array(&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Assume there will be errors</span></span></span>&nbsp;</div></li><li><div>      'user_id' =&gt; -1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify there is a user_ID</span>&nbsp;</div></li><li><div>  if ( $user_ID &gt; 0 ) {&nbsp;</div></li><li><div>      <span class="comment">// Get the logged in user data</span>&nbsp;</div></li><li><div>      $user_data = get_userdata( $user_ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Loop through required fields and show error messages</span></span></span>&nbsp;</div></li><li><div>      foreach ( edd_purchase_form_required_fields() as $field_name =&gt; $value ) {&nbsp;</div></li><li><div>          if ( in_array( $value, edd_purchase_form_required_fields() ) && empty( $_POST[ $field_name ] ) ) {&nbsp;</div></li><li><div>              edd_set_error( $value['error_id'], $value['error_message'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Verify data</span>&nbsp;</div></li><li><div>      if ( $user_data ) {&nbsp;</div></li><li><div>          <span class="comment">// Collected logged in user data</span>&nbsp;</div></li><li><div>          $valid_user_data = array(&nbsp;</div></li><li><div>              'user_id' =&gt; $user_ID, &nbsp;</div></li><li><div>              'user_email' =&gt; isset( $_POST['edd_email'] ) ? sanitize_email( $_POST['edd_email'] ) : $user_data-&gt;user_email, &nbsp;</div></li><li><div>              'user_first' =&gt; isset( $_POST['edd_first'] ) && ! empty( $_POST['edd_first'] ) ? sanitize_text_field( $_POST['edd_first'] ) : $user_data-&gt;first_name, &nbsp;</div></li><li><div>              'user_last' =&gt; isset( $_POST['edd_last'] ) && ! empty( $_POST['edd_last'] ) ? sanitize_text_field( $_POST['edd_last'] ) : $user_data-&gt;last_name, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if ( ! is_email( $valid_user_data['user_email'] ) ) {&nbsp;</div></li><li><div>              edd_set_error( 'email_invalid', __( 'Invalid email', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Set invalid user error</span>&nbsp;</div></li><li><div>          edd_set_error( 'invalid_user', __( 'The user information is invalid', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return user data</span>&nbsp;</div></li><li><div>  return $valid_user_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate New User</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return      array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_new_user() {&nbsp;</div></li><li><div>  $registering_new_user = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Start an empty array to collect valid user data</span>&nbsp;</div></li><li><div>  $valid_user_data = array(&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Assume there will be errors</span></span></span>&nbsp;</div></li><li><div>      'user_id' =&gt; -1, &nbsp;</div></li><li><div>      <span class="comment">// Get first name</span>&nbsp;</div></li><li><div>      'user_first' =&gt; isset( $_POST[&quot;edd_first&quot;] ) ? sanitize_text_field( $_POST[&quot;edd_first&quot;] ) : '', &nbsp;</div></li><li><div>      <span class="comment">// Get last name</span>&nbsp;</div></li><li><div>      'user_last' =&gt; isset( $_POST[&quot;edd_last&quot;] ) ? sanitize_text_field( $_POST[&quot;edd_last&quot;] ) : '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the new user's credentials against existing ones</span>&nbsp;</div></li><li><div>  $user_login = isset( $_POST[&quot;edd_user_login&quot;] ) ? trim( $_POST[&quot;edd_user_login&quot;] ) : false;&nbsp;</div></li><li><div>  $user_email = isset( $_POST['edd_email'] ) ? trim( $_POST['edd_email'] ) : false;&nbsp;</div></li><li><div>  $user_pass = isset( $_POST[&quot;edd_user_pass&quot;] ) ? trim( $_POST[&quot;edd_user_pass&quot;] ) : false;&nbsp;</div></li><li><div>  $pass_confirm = isset( $_POST[&quot;edd_user_pass_confirm&quot;] ) ? trim( $_POST[&quot;edd_user_pass_confirm&quot;] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Loop through required fields and show error messages</span></span></span>&nbsp;</div></li><li><div>  foreach ( edd_purchase_form_required_fields() as $field_name =&gt; $value ) {&nbsp;</div></li><li><div>      if ( in_array( $value, edd_purchase_form_required_fields() ) && empty( $_POST[ $field_name ] ) ) {&nbsp;</div></li><li><div>          edd_set_error( $value['error_id'], $value['error_message'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if we have an username to register</span>&nbsp;</div></li><li><div>  if ( $user_login && strlen( $user_login ) &gt; 0 ) {&nbsp;</div></li><li><div>      $registering_new_user = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// We have an user name, check if it already exists</span>&nbsp;</div></li><li><div>      if ( username_exists( $user_login ) ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// Username</span> already registered</span>&nbsp;</div></li><li><div>          edd_set_error( 'username_unavailable', __( 'Username already taken', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          <span class="comment">// Check if it's valid</span>&nbsp;</div></li><li><div>      } else if ( ! edd_validate_username( $user_login ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Invalid username</span>&nbsp;</div></li><li><div>              if ( is_multisite() )&nbsp;</div></li><li><div>                  edd_set_error( 'username_invalid', __( 'Invalid username. Only lowercase letters (a-z) and numbers are allowed', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  edd_set_error( 'username_invalid', __( 'Invalid username', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// All the checks have run and it's good to go</span></span>&nbsp;</div></li><li><div>          $valid_user_data['user_login'] = $user_login;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      if ( edd_no_guest_checkout() ) {&nbsp;</div></li><li><div>          edd_set_error( 'registration_required', __( 'You must register or login to complete your purchase', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if we have an email to verify</span>&nbsp;</div></li><li><div>  if ( $user_email && strlen( $user_email ) &gt; 0 ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Validate email</span></span>&nbsp;</div></li><li><div>      if ( ! is_email( $user_email ) ) {&nbsp;</div></li><li><div>          edd_set_error( 'email_invalid', __( 'Invalid email', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          <span class="comment">// Check if email exists</span>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $customer = new EDD_Customer( $user_email );&nbsp;</div></li><li><div>          if ( $registering_new_user && email_exists( $user_email ) ) {&nbsp;</div></li><li><div>              edd_set_error( 'email_used', __( 'Email already used. Login or use a different email to complete your purchase.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment"><span class="comment">// All the checks have run and it's good to go</span></span>&nbsp;</div></li><li><div>              $valid_user_data['user_email'] = $user_email;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// No email</span></span>&nbsp;</div></li><li><div>      edd_set_error( 'email_empty', __( 'Enter an email', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check password</span>&nbsp;</div></li><li><div>  if ( $user_pass && $pass_confirm ) {&nbsp;</div></li><li><div>      <span class="comment">// Verify confirmation matches</span>&nbsp;</div></li><li><div>      if ( $user_pass != $pass_confirm ) {&nbsp;</div></li><li><div>          <span class="comment">// Passwords do not match</span>&nbsp;</div></li><li><div>          edd_set_error( 'password_mismatch', __( 'Passwords don\'t match', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// All is good to go</span></span>&nbsp;</div></li><li><div>          $valid_user_data['user_pass'] = $user_pass;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Password or confirmation missing</span>&nbsp;</div></li><li><div>      if ( ! $user_pass && $registering_new_user ) {&nbsp;</div></li><li><div>          <span class="comment">// The password is invalid</span>&nbsp;</div></li><li><div>          edd_set_error( 'password_empty', __( 'Enter a password', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      } else if ( ! $pass_confirm && $registering_new_user ) {&nbsp;</div></li><li><div>          <span class="comment">// Confirmation password is invalid</span>&nbsp;</div></li><li><div>          edd_set_error( 'confirmation_empty', __( 'Enter the password confirmation', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $valid_user_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate User Login</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access      private</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return      array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_user_login() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Start an array to collect valid user data</span></span>&nbsp;</div></li><li><div>  $valid_user_data = array(&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Assume there will be errors</span></span></span>&nbsp;</div></li><li><div>      'user_id' =&gt; -1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Username</span>&nbsp;</div></li><li><div>  if ( empty( $_POST['edd_user_login'] ) && edd_no_guest_checkout() ) {&nbsp;</div></li><li><div>      edd_set_error( 'must_log_in', __( 'You must login or register to complete your purchase', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      return $valid_user_data;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $login_or_email = strip_tags( $_POST['edd_user_login'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_email( $login_or_email ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Get the user by email</span>&nbsp;</div></li><li><div>      $user_data = get_user_by( 'email', $login_or_email );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Get the user by login</span>&nbsp;</div></li><li><div>      $user_data = get_user_by( 'login', $login_or_email );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if user exists</span>&nbsp;</div></li><li><div>  if ( $user_data ) {&nbsp;</div></li><li><div>      <span class="comment">// Get password</span>&nbsp;</div></li><li><div>      $user_pass = isset( $_POST[&quot;edd_user_pass&quot;] ) ? $_POST[&quot;edd_user_pass&quot;] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Check user_pass</span>&nbsp;</div></li><li><div>      if ( $user_pass ) {&nbsp;</div></li><li><div>          <span class="comment">// Check if password is valid</span>&nbsp;</div></li><li><div>          if ( ! wp_check_password( $user_pass, $user_data-&gt;user_pass, $user_data-&gt;ID ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Incorrect password</span>&nbsp;</div></li><li><div>              edd_set_error(&nbsp;</div></li><li><div>                  'password_incorrect', &nbsp;</div></li><li><div>                  sprintf(&nbsp;</div></li><li><div>                      __( 'The password you entered is incorrect. %sReset Password%s', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>                      '&lt;a href=&quot;' . wp_lostpassword_url( edd_get_checkout_uri() ) . '&quot;&gt;', &nbsp;</div></li><li><div>                      '&lt;/a&gt;'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>              <span class="comment">// All is correct</span>&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              <span class="comment">// Repopulate the valid user data array</span>&nbsp;</div></li><li><div>              $valid_user_data = array(&nbsp;</div></li><li><div>                  'user_id' =&gt; $user_data-&gt;ID, &nbsp;</div></li><li><div>                  'user_login' =&gt; $user_data-&gt;user_login, &nbsp;</div></li><li><div>                  'user_email' =&gt; $user_data-&gt;user_email, &nbsp;</div></li><li><div>                  'user_first' =&gt; $user_data-&gt;first_name, &nbsp;</div></li><li><div>                  'user_last' =&gt; $user_data-&gt;last_name, &nbsp;</div></li><li><div>                  'user_pass' =&gt; $user_pass, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Empty password</span>&nbsp;</div></li><li><div>          edd_set_error( 'password_empty', __( 'Enter a password', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// no username</span>&nbsp;</div></li><li><div>      edd_set_error( 'username_incorrect', __( 'The username you entered does not exist', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $valid_user_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Purchase Form Validate Guest User</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return  array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_guest_user() {&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Start an array to collect valid user data</span></span>&nbsp;</div></li><li><div>  $valid_user_data = array(&nbsp;</div></li><li><div>      <span class="comment">// Set a default id for guests</span>&nbsp;</div></li><li><div>      'user_id' =&gt; 0, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Show error message if user must be logged in</span>&nbsp;</div></li><li><div>  if ( edd_logged_in_only() ) {&nbsp;</div></li><li><div>      edd_set_error( 'logged_in_only', __( 'You must be logged into an account to purchase', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the guest email</span>&nbsp;</div></li><li><div>  $guest_email = isset( $_POST['edd_email'] ) ? $_POST['edd_email'] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check email</span>&nbsp;</div></li><li><div>  if ( $guest_email && strlen( $guest_email ) &gt; 0 ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Validate email</span></span>&nbsp;</div></li><li><div>      if ( ! is_email( $guest_email ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Invalid email</span>&nbsp;</div></li><li><div>          edd_set_error( 'email_invalid', __( 'Invalid email', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// All is good to go</span></span>&nbsp;</div></li><li><div>          $valid_user_data['user_email'] = $guest_email;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// No email</span></span>&nbsp;</div></li><li><div>      edd_set_error( 'email_empty', __( 'Enter an email', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment"><span class="comment">// Loop through required fields and show error messages</span></span></span>&nbsp;</div></li><li><div>  foreach ( edd_purchase_form_required_fields() as $field_name =&gt; $value ) {&nbsp;</div></li><li><div>      if ( in_array( $value, edd_purchase_form_required_fields() ) && empty( $_POST[ $field_name ] ) ) {&nbsp;</div></li><li><div>          edd_set_error( $value['error_id'], $value['error_message'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $valid_user_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register And Login New User</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $user_data</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return  integer</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_register_and_login_new_user( $user_data = array() ) {&nbsp;</div></li><li><div>  <span class="comment">// Verify the array</span>&nbsp;</div></li><li><div>  if ( empty( $user_data ) )&nbsp;</div></li><li><div>      return -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( edd_get_errors() )&nbsp;</div></li><li><div>      return -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $user_args = apply_filters( 'edd_insert_user_args', array(&nbsp;</div></li><li><div>      'user_login' =&gt; isset( $user_data['user_login'] ) ? $user_data['user_login'] : '', &nbsp;</div></li><li><div>      'user_pass' =&gt; isset( $user_data['user_pass'] )  ? $user_data['user_pass']  : '', &nbsp;</div></li><li><div>      'user_email' =&gt; isset( $user_data['user_email'] ) ? $user_data['user_email'] : '', &nbsp;</div></li><li><div>      'first_name' =&gt; isset( $user_data['user_first'] ) ? $user_data['user_first'] : '', &nbsp;</div></li><li><div>      'last_name' =&gt; isset( $user_data['user_last'] )  ? $user_data['user_last']  : '', &nbsp;</div></li><li><div>      'user_registered' =&gt; date( 'Y-m-d H:i:s' ), &nbsp;</div></li><li><div>      'role' =&gt; get_option( 'default_role' )&nbsp;</div></li><li><div> ), $user_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Insert new user</span>&nbsp;</div></li><li><div>  $user_id = wp_insert_user( $user_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate inserted user</span>&nbsp;</div></li><li><div>  if ( is_wp_error( $user_id ) )&nbsp;</div></li><li><div>      return -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Allow themes and plugins to filter the user data</span>&nbsp;</div></li><li><div>  $user_data = apply_filters( 'edd_insert_user_data', $user_data, $user_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Allow themes and plugins to hook</span>&nbsp;</div></li><li><div>  do_action( 'edd_insert_user', $user_id, $user_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Login new user</span>&nbsp;</div></li><li><div>  edd_log_user_in( $user_id, $user_data['user_login'], $user_data['user_pass'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return user id</span>&nbsp;</div></li><li><div>  return $user_id;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Purchase Form User</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $valid_data</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.0.8.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return  array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_purchase_form_user( $valid_data = array() ) {&nbsp;</div></li><li><div>  <span class="comment">// Initialize user</span>&nbsp;</div></li><li><div>  $user = false;&nbsp;</div></li><li><div>  $is_ajax = defined( 'DOING_AJAX' ) && DOING_AJAX;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $is_ajax ) {&nbsp;</div></li><li><div>      <span class="comment">// Do not create or login the user during the ajax submission (check for errors only)</span>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  } else if ( is_user_logged_in() ) {&nbsp;</div></li><li><div>      <span class="comment">// Set the valid user as the logged in collected data</span>&nbsp;</div></li><li><div>      $user = $valid_data['logged_in_user'];&nbsp;</div></li><li><div>  } else if ( $valid_data['need_new_user'] === true || $valid_data['need_user_login'] === true ) {&nbsp;</div></li><li><div>      <span class="comment">// New user registration</span>&nbsp;</div></li><li><div>      if ( $valid_data['need_new_user'] === true ) {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Set user</span></span></span>&nbsp;</div></li><li><div>          $user = $valid_data['new_user_data'];&nbsp;</div></li><li><div>          <span class="comment">// Register and login new user</span>&nbsp;</div></li><li><div>          $user['user_id'] = edd_register_and_login_new_user( $user );&nbsp;</div></li><li><div>          <span class="comment">// User login</span>&nbsp;</div></li><li><div>      } else if ( $valid_data['need_user_login'] === true  && ! $is_ajax ) {&nbsp;</div></li><li><div>          <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">           * The login form is now processed in the edd_process_purchase_login() function.</span>&nbsp;</div></li><li><div><span class="comment">           * This is still here for backwards compatibility.</span>&nbsp;</div></li><li><div><span class="comment">           * This also allows the old login process to still work if a user removes the</span>&nbsp;</div></li><li><div><span class="comment">           * checkout login submit button.</span>&nbsp;</div></li><li><div><span class="comment">           *</span>&nbsp;</div></li><li><div><span class="comment">           * This also ensures that the customer is logged in correctly if they click &quot;Purchase&quot;</span>&nbsp;</div></li><li><div><span class="comment">           * instead of submitting the login form, meaning the customer is logged in during the purchase process.</span>&nbsp;</div></li><li><div><span class="comment">           */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// Set user</span></span></span>&nbsp;</div></li><li><div>          $user = $valid_data['login_user_data'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Login user</span>&nbsp;</div></li><li><div>          if ( empty( $user ) || $user['user_id'] == -1 ) {&nbsp;</div></li><li><div>              edd_set_error( 'invalid_user', __( 'The user information is invalid', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              edd_log_user_in( $user['user_id'], $user['user_login'], $user['user_pass'] );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check guest checkout</span>&nbsp;</div></li><li><div>  if ( false === $user && false === edd_no_guest_checkout() ) {&nbsp;</div></li><li><div>      <span class="comment"><span class="comment"><span class="comment">// Set user</span></span></span>&nbsp;</div></li><li><div>      $user = $valid_data['guest_user_data'];&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify we have an user</span>&nbsp;</div></li><li><div>  if ( false === $user || empty( $user ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Return false</span>&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get user first name</span>&nbsp;</div></li><li><div>  if ( ! isset( $user['user_first'] ) || strlen( trim( $user['user_first'] ) ) &lt; 1 ) {&nbsp;</div></li><li><div>      $user['user_first'] = isset( $_POST[&quot;edd_first&quot;] ) ? strip_tags( trim( $_POST[&quot;edd_first&quot;] ) ) : '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get user last name</span>&nbsp;</div></li><li><div>  if ( ! isset( $user['user_last'] ) || strlen( trim( $user['user_last'] ) ) &lt; 1 ) {&nbsp;</div></li><li><div>      $user['user_last'] = isset( $_POST[&quot;edd_last&quot;] ) ? strip_tags( trim( $_POST[&quot;edd_last&quot;] ) ) : '';&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get the user's billing address details</span>&nbsp;</div></li><li><div>  $user['address'] = array();&nbsp;</div></li><li><div>  $user['address']['line1'] = ! empty( $_POST['card_address'] ) ? sanitize_text_field( $_POST['card_address'] ) : false;&nbsp;</div></li><li><div>  $user['address']['line2'] = ! empty( $_POST['card_address_2'] ) ? sanitize_text_field( $_POST['card_address_2'] ) : false;&nbsp;</div></li><li><div>  $user['address']['city'] = ! empty( $_POST['card_city'] ) ? sanitize_text_field( $_POST['card_city'] ) : false;&nbsp;</div></li><li><div>  $user['address']['state'] = ! empty( $_POST['card_state'] ) ? sanitize_text_field( $_POST['card_state'] ) : false;&nbsp;</div></li><li><div>  $user['address']['country'] = ! empty( $_POST['billing_country'] ) ? sanitize_text_field( $_POST['billing_country'] ) : false;&nbsp;</div></li><li><div>  $user['address']['zip'] = ! empty( $_POST['card_zip'] ) ? sanitize_text_field( $_POST['card_zip'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $user['address']['country'] ) )&nbsp;</div></li><li><div>      $user['address'] = false; <span class="comment">// Country will always be set if address fields are present</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $user['user_id'] ) && $user['user_id'] &gt; 0 && ! empty( $user['address'] ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Store the address in the user's meta so the cart can be pre-populated with it on return purchases</span>&nbsp;</div></li><li><div>      update_user_meta( $user['user_id'], '_edd_user_address', $user['address'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return valid user</span>&nbsp;</div></li><li><div>  return $user;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validates the credit card info</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return  array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_cc() {&nbsp;</div></li><li><div>  $card_data = edd_get_purchase_cc_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Validate the card zip</span>&nbsp;</div></li><li><div>  if ( ! empty( $card_data['card_zip'] ) ) {&nbsp;</div></li><li><div>      if ( ! edd_purchase_form_validate_cc_zip( $card_data['card_zip'], $card_data['card_country'] ) ) {&nbsp;</div></li><li><div>          edd_set_error( 'invalid_cc_zip', __( 'The zip / postal code you entered for your billing address is invalid', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// This should validate card numbers at some point too</span>&nbsp;</div></li><li><div>  return $card_data;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get Credit Card Info</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access  private</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.4.4</span>&nbsp;</div></li><li><div><span class="comment"> * @return  array</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_purchase_cc_info() {&nbsp;</div></li><li><div>  $cc_info = array();&nbsp;</div></li><li><div>  $cc_info['card_name'] = isset( $_POST['card_name'] )       ? sanitize_text_field( $_POST['card_name'] )       : '';&nbsp;</div></li><li><div>  $cc_info['card_number'] = isset( $_POST['card_number'] )     ? sanitize_text_field( $_POST['card_number'] )     : '';&nbsp;</div></li><li><div>  $cc_info['card_cvc'] = isset( $_POST['card_cvc'] )        ? sanitize_text_field( $_POST['card_cvc'] )        : '';&nbsp;</div></li><li><div>  $cc_info['card_exp_month'] = isset( $_POST['card_exp_month'] )  ? sanitize_text_field( $_POST['card_exp_month'] )  : '';&nbsp;</div></li><li><div>  $cc_info['card_exp_year'] = isset( $_POST['card_exp_year'] )   ? sanitize_text_field( $_POST['card_exp_year'] )   : '';&nbsp;</div></li><li><div>  $cc_info['card_address'] = isset( $_POST['card_address'] )    ? sanitize_text_field( $_POST['card_address'] )    : '';&nbsp;</div></li><li><div>  $cc_info['card_address_2'] = isset( $_POST['card_address_2'] )  ? sanitize_text_field( $_POST['card_address_2'] )  : '';&nbsp;</div></li><li><div>  $cc_info['card_city'] = isset( $_POST['card_city'] )       ? sanitize_text_field( $_POST['card_city'] )       : '';&nbsp;</div></li><li><div>  $cc_info['card_state'] = isset( $_POST['card_state'] )      ? sanitize_text_field( $_POST['card_state'] )      : '';&nbsp;</div></li><li><div>  $cc_info['card_country'] = isset( $_POST['billing_country'] ) ? sanitize_text_field( $_POST['billing_country'] ) : '';&nbsp;</div></li><li><div>  $cc_info['card_zip'] = isset( $_POST['card_zip'] )        ? sanitize_text_field( $_POST['card_zip'] )        : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Return cc info</span>&nbsp;</div></li><li><div>  return $cc_info;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Validate zip code based on country code</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  1.4.4</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int     $zip</span>&nbsp;</div></li><li><div><span class="comment"> * @param string  $country_code</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @return bool|mixed|void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_purchase_form_validate_cc_zip( $zip = 0, $country_code = '' ) {&nbsp;</div></li><li><div>  $ret = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $zip ) || empty( $country_code ) )&nbsp;</div></li><li><div>      return $ret;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $country_code = strtoupper( $country_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $zip_regex = array(&nbsp;</div></li><li><div>      &quot;AD&quot; =&gt; &quot;AD\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;AM&quot; =&gt; &quot;(37)?\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;AR&quot; =&gt; &quot;^([A-Z]{1}\d{4}[A-Z]{3}|[A-Z]{1}\d{4}|\d{4})$&quot;, &nbsp;</div></li><li><div>      &quot;AS&quot; =&gt; &quot;96799&quot;, &nbsp;</div></li><li><div>      &quot;AT&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;AU&quot; =&gt; &quot;^(0[289][0-9]{2})|([1345689][0-9]{3})|(2[0-8][0-9]{2})|(290[0-9])|(291[0-4])|(7[0-4][0-9]{2})|(7[8-9][0-9]{2})$&quot;, &nbsp;</div></li><li><div>      &quot;AX&quot; =&gt; &quot;22\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;AZ&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;BA&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;BB&quot; =&gt; &quot;(BB\d{5})?&quot;, &nbsp;</div></li><li><div>      &quot;BD&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;BE&quot; =&gt; &quot;^[1-9]{1}[0-9]{3}$&quot;, &nbsp;</div></li><li><div>      &quot;BG&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;BH&quot; =&gt; &quot;((1[0-2]|[2-9])\d{2})?&quot;, &nbsp;</div></li><li><div>      &quot;BM&quot; =&gt; &quot;[A-Z]{2}[ ]?[A-Z0-9]{2}&quot;, &nbsp;</div></li><li><div>      &quot;BN&quot; =&gt; &quot;[A-Z]{2}[ ]?\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;BR&quot; =&gt; &quot;\d{5}[\-]?\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;BY&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;CA&quot; =&gt; &quot;^[ABCEGHJKLMNPRSTVXY]{1}\d{1}[A-Z]{1} *\d{1}[A-Z]{1}\d{1}$&quot;, &nbsp;</div></li><li><div>      &quot;CC&quot; =&gt; &quot;6799&quot;, &nbsp;</div></li><li><div>      &quot;CH&quot; =&gt; &quot;^[1-9][0-9][0-9][0-9]$&quot;, &nbsp;</div></li><li><div>      &quot;CK&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;CL&quot; =&gt; &quot;\d{7}&quot;, &nbsp;</div></li><li><div>      &quot;CN&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;CR&quot; =&gt; &quot;\d{4, 5}|\d{3}-\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;CS&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;CV&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;CX&quot; =&gt; &quot;6798&quot;, &nbsp;</div></li><li><div>      &quot;CY&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;CZ&quot; =&gt; &quot;\d{3}[ ]?\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;DE&quot; =&gt; &quot;\b((?:0[1-46-9]\d{3})|(?:[1-357-9]\d{4})|(?:[4][0-24-9]\d{3})|(?:[6][013-9]\d{3}))\b&quot;, &nbsp;</div></li><li><div>      &quot;DK&quot; =&gt; &quot;^([D-d][K-k])?( |-)?[1-9]{1}[0-9]{3}$&quot;, &nbsp;</div></li><li><div>      &quot;DO&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;DZ&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;EC&quot; =&gt; &quot;([A-Z]\d{4}[A-Z]|(?:[A-Z]{2})?\d{6})?&quot;, &nbsp;</div></li><li><div>      &quot;EE&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;EG&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;ES&quot; =&gt; &quot;^([1-9]{2}|[0-9][1-9]|[1-9][0-9])[0-9]{3}$&quot;, &nbsp;</div></li><li><div>      &quot;ET&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;FI&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;FK&quot; =&gt; &quot;FIQQ 1ZZ&quot;, &nbsp;</div></li><li><div>      &quot;FM&quot; =&gt; &quot;(9694[1-4])([ \-]\d{4})?&quot;, &nbsp;</div></li><li><div>      &quot;FO&quot; =&gt; &quot;\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;FR&quot; =&gt; &quot;^(F-)?((2[A|B])|[0-9]{2})[0-9]{3}$&quot;, &nbsp;</div></li><li><div>      &quot;GE&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;GF&quot; =&gt; &quot;9[78]3\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;GL&quot; =&gt; &quot;39\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;GN&quot; =&gt; &quot;\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;GP&quot; =&gt; &quot;9[78][01]\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;GR&quot; =&gt; &quot;\d{3}[ ]?\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;GS&quot; =&gt; &quot;SIQQ 1ZZ&quot;, &nbsp;</div></li><li><div>      &quot;GT&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;GU&quot; =&gt; &quot;969[123]\d([ \-]\d{4})?&quot;, &nbsp;</div></li><li><div>      &quot;GW&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;HM&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;HN&quot; =&gt; &quot;(?:\d{5})?&quot;, &nbsp;</div></li><li><div>      &quot;HR&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;HT&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;HU&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;ID&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;IE&quot; =&gt; &quot;((D|DUBLIN)?([1-9]|6[wW]|1[0-8]|2[024]))?&quot;, &nbsp;</div></li><li><div>      &quot;IL&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;IN&quot;=&gt; &quot;^[1-9][0-9][0-9][0-9][0-9][0-9]$&quot;, <span class="comment">//india</span>&nbsp;</div></li><li><div>      &quot;IO&quot; =&gt; &quot;BBND 1ZZ&quot;, &nbsp;</div></li><li><div>      &quot;IQ&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;IS&quot; =&gt; &quot;\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;IT&quot; =&gt; &quot;^(V-|I-)?[0-9]{5}$&quot;, &nbsp;</div></li><li><div>      &quot;JO&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;JP&quot; =&gt; &quot;\d{3}-\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;KE&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;KG&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;KH&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;KR&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;KW&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;KZ&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;LA&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;LB&quot; =&gt; &quot;(\d{4}([ ]?\d{4})?)?&quot;, &nbsp;</div></li><li><div>      &quot;LI&quot; =&gt; &quot;(948[5-9])|(949[0-7])&quot;, &nbsp;</div></li><li><div>      &quot;LK&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;LR&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;LS&quot; =&gt; &quot;\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;LT&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;LU&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;LV&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;MA&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;MC&quot; =&gt; &quot;980\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;MD&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;ME&quot; =&gt; &quot;8\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;MG&quot; =&gt; &quot;\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;MH&quot; =&gt; &quot;969[67]\d([ \-]\d{4})?&quot;, &nbsp;</div></li><li><div>      &quot;MK&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;MN&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;MP&quot; =&gt; &quot;9695[012]([ \-]\d{4})?&quot;, &nbsp;</div></li><li><div>      &quot;MQ&quot; =&gt; &quot;9[78]2\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;MT&quot; =&gt; &quot;[A-Z]{3}[ ]?\d{2, 4}&quot;, &nbsp;</div></li><li><div>      &quot;MU&quot; =&gt; &quot;(\d{3}[A-Z]{2}\d{3})?&quot;, &nbsp;</div></li><li><div>      &quot;MV&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;MX&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;MY&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;NC&quot; =&gt; &quot;988\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;NE&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;NF&quot; =&gt; &quot;2899&quot;, &nbsp;</div></li><li><div>      &quot;NG&quot; =&gt; &quot;(\d{6})?&quot;, &nbsp;</div></li><li><div>      &quot;NI&quot; =&gt; &quot;((\d{4}-)?\d{3}-\d{3}(-\d{1})?)?&quot;, &nbsp;</div></li><li><div>      &quot;NL&quot; =&gt; &quot;^[1-9][0-9]{3}\s?([a-zA-Z]{2})?$&quot;, &nbsp;</div></li><li><div>      &quot;NO&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;NP&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;NZ&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;OM&quot; =&gt; &quot;(PC )?\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;PF&quot; =&gt; &quot;987\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;PG&quot; =&gt; &quot;\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;PH&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;PK&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;PL&quot; =&gt; &quot;\d{2}-\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;PM&quot; =&gt; &quot;9[78]5\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;PN&quot; =&gt; &quot;PCRN 1ZZ&quot;, &nbsp;</div></li><li><div>      &quot;PR&quot; =&gt; &quot;00[679]\d{2}([ \-]\d{4})?&quot;, &nbsp;</div></li><li><div>      &quot;PT&quot; =&gt; &quot;\d{4}([\-]\d{3})?&quot;, &nbsp;</div></li><li><div>      &quot;PW&quot; =&gt; &quot;96940&quot;, &nbsp;</div></li><li><div>      &quot;PY&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;RE&quot; =&gt; &quot;9[78]4\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;RO&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;RS&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;RU&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;SA&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;SE&quot; =&gt; &quot;^(s-|S-) {0, 1}[0-9]{3}\s?[0-9]{2}$&quot;, &nbsp;</div></li><li><div>      &quot;SG&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;SH&quot; =&gt; &quot;(ASCN|STHL) 1ZZ&quot;, &nbsp;</div></li><li><div>      &quot;SI&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;SJ&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;SK&quot; =&gt; &quot;\d{3}[ ]?\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;SM&quot; =&gt; &quot;4789\d&quot;, &nbsp;</div></li><li><div>      &quot;SN&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;SO&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;SZ&quot; =&gt; &quot;[HLMS]\d{3}&quot;, &nbsp;</div></li><li><div>      &quot;TC&quot; =&gt; &quot;TKCA 1ZZ&quot;, &nbsp;</div></li><li><div>      &quot;TH&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;TJ&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;TM&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;TN&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;TR&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;TW&quot; =&gt; &quot;\d{3}(\d{2})?&quot;, &nbsp;</div></li><li><div>      &quot;UA&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;UK&quot; =&gt; &quot;^(GIR|[A-Z]\d[A-Z\d]??|[A-Z]{2}\d[A-Z\d]??)[ ]??(\d[A-Z]{2})$&quot;, &nbsp;</div></li><li><div>      &quot;US&quot; =&gt; &quot;^\d{5}([\-]?\d{4})?$&quot;, &nbsp;</div></li><li><div>      &quot;UY&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;UZ&quot; =&gt; &quot;\d{6}&quot;, &nbsp;</div></li><li><div>      &quot;VA&quot; =&gt; &quot;00120&quot;, &nbsp;</div></li><li><div>      &quot;VE&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;VI&quot; =&gt; &quot;008(([0-4]\d)|(5[01]))([ \-]\d{4})?&quot;, &nbsp;</div></li><li><div>      &quot;WF&quot; =&gt; &quot;986\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;YT&quot; =&gt; &quot;976\d{2}&quot;, &nbsp;</div></li><li><div>      &quot;YU&quot; =&gt; &quot;\d{5}&quot;, &nbsp;</div></li><li><div>      &quot;ZA&quot; =&gt; &quot;\d{4}&quot;, &nbsp;</div></li><li><div>      &quot;ZM&quot; =&gt; &quot;\d{5}&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset ( $zip_regex[ $country_code ] ) || preg_match( &quot;/&quot; . $zip_regex[ $country_code ] . &quot;/i&quot;, $zip ) )&nbsp;</div></li><li><div>      $ret = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_is_zip_valid', $ret, $zip, $country_code );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Check the purchase to ensure a banned email is not allowed through</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since       2.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return      void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_check_purchase_email( $valid_data, $posted ) {&nbsp;</div></li><li><div>  $is_banned = false;&nbsp;</div></li><li><div>  $banned = edd_get_banned_emails();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $banned ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( is_user_logged_in() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The user is logged in, check that their account email is not banned</span>&nbsp;</div></li><li><div>      $user_data = get_userdata( get_current_user_id() );&nbsp;</div></li><li><div>      if( edd_is_email_banned( $user_data-&gt;user_email ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $is_banned = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( edd_is_email_banned( $posted['edd_email'] ) ) {&nbsp;</div></li><li><div>          $is_banned = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } elseif( isset( $posted['edd-purchase-var'] ) && $posted['edd-purchase-var'] == 'needs-to-login' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// The user is logging in, check that their email is not banned</span>&nbsp;</div></li><li><div>      $user_data = get_user_by( 'login', $posted['edd_user_login'] );&nbsp;</div></li><li><div>      if( $user_data && edd_is_email_banned( $user_data-&gt;user_email ) ) {&nbsp;</div></li><li><div>          $is_banned = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Guest purchase, check that the email is not banned</span>&nbsp;</div></li><li><div>      if( edd_is_email_banned( $posted['edd_email'] ) ) {&nbsp;</div></li><li><div>          $is_banned = true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $is_banned ) {&nbsp;</div></li><li><div>      <span class="comment">// Set an error and give the customer a general error (don't alert them that they were banned)</span>&nbsp;</div></li><li><div>      edd_set_error( 'email_banned', __( 'An internal error has occurred, please try again or contact support.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_checkout_error_checks', 'edd_check_purchase_email', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process a straight-to-gateway purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.7</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_straight_to_gateway( $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $download_id = $data['download_id'];&nbsp;</div></li><li><div>  $options = isset( $data['edd_options'] ) ? $data['edd_options'] : array();&nbsp;</div></li><li><div>  $quantity = isset( $data['edd_download_quantity'] ) ? $data['edd_download_quantity'] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $download_id ) || ! edd_get_download( $download_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $purchase_data = edd_build_straight_to_gateway_data( $download_id, $options, $quantity );&nbsp;</div></li><li><div>  $enabled_gateways = edd_get_enabled_payment_gateways();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! array_key_exists( $purchase_data['gateway'], $enabled_gateways ) ) {&nbsp;</div></li><li><div>      foreach ( $purchase_data['downloads'] as $download ) {&nbsp;</div></li><li><div>          $options = isset( $download['options'] ) ? $download['options'] : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $options['quantity'] = isset( $download['quantity'] ) ? $download['quantity'] : 1;&nbsp;</div></li><li><div>          edd_add_to_cart( $download['id'], $options );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      edd_set_error( 'edd-straight-to-gateway-error', __( 'There was an error completing your purchase. Please try again.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      wp_redirect( edd_get_checkout_uri() );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  edd_set_purchase_session( $purchase_data );&nbsp;</div></li><li><div>  edd_send_to_gateway( $purchase_data['gateway'], $purchase_data );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_straight_to_gateway', 'edd_process_straight_to_gateway' );&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Easy Digital Downloads</li><li><span></span>2.7.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>