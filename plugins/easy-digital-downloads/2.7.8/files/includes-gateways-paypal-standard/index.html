<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.8" data-slug="easy-digital-downloads" data-type="file" data-id="58175"><head xmlns="http://www.w3.org/1999/xhtml"><title> includes-gateways-paypal-standard | file | Easy Digital Downloads | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, easy-digital-downloads, 2.7.8" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=17f4aed9b73525ef5bcc9746cf4b237c' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/includes-gateways-paypal-standard/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-gateways-paypal-standard%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fincludes-gateways-paypal-standard%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-easy-digital-downloads-2.7.8-file-includes-gateways-paypal-standard","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="includes-gateways-paypal-standard" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to easy-digital-downloads." href="http://hookr.io/plugins/easy-digital-downloads/" class="plugin"><span property="name">easy-digital-downloads</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.8." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/" class="H_VERSION"><span property="name">2.7.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">includes-gateways-paypal-stan&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="2274"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/all/" title="All">All <span class="count badge">2274</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="1195"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/hooks/" title="Hooks">Hooks <span class="count badge">1195</span></a></li><li class="" data-id="action" data-count="469"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/actions/" title="Actions">Actions <span class="count badge">469</span></a></li><li class="" data-id="filter" data-count="726"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/filters/" title="Filters">Filters <span class="count badge">726</span></a></li><li class="" data-id="class" data-count="99"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" title="Classes">Classes <span class="count badge">99</span></a></li><li class="" data-id="constant" data-count="11"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/constants/" title="Constants">Constants <span class="count badge">11</span></a></li><li class="" data-id="function" data-count="955"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/functions/" title="Functions">Functions <span class="count badge">955</span></a></li><li class="" data-id="shortcode" data-count="14"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">14</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/includes/gateways/paypal-standard.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * PayPal Standard Gateway</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @package     EDD</span>&nbsp;</div></li><li><div><span class="comment"> * @subpackage  Gateways</span>&nbsp;</div></li><li><div><span class="comment"> * @copyright   Copyright (c) 2015, Pippin Williamson</span>&nbsp;</div></li><li><div><span class="comment"> * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License</span>&nbsp;</div></li><li><div><span class="comment"> * @since       1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Exit if accessed directly</span>&nbsp;</div></li><li><div>if ( ! defined( 'ABSPATH' ) ) exit;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * PayPal Remove CC Form</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * PayPal Standard does not need a CC form, so remove it.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access private</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>add_action( 'edd_paypal_cc_form', '__return_false' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Register the PayPal Standard gateway subsection</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $gateway_sections  Current Gateway Tab subsections</span>&nbsp;</div></li><li><div><span class="comment"> * @return array                    Gateway subsections with PayPal Standard</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_register_paypal_gateway_section( $gateway_sections ) {&nbsp;</div></li><li><div>  $gateway_sections['paypal'] = __( 'PayPal Standard', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $gateway_sections;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'edd_settings_sections_gateways', 'edd_register_paypal_gateway_section', 1, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Registers the PayPal Standard settings for the PayPal Standard subsection</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6</span>&nbsp;</div></li><li><div><span class="comment"> * @param  array $gateway_settings  Gateway tab settings</span>&nbsp;</div></li><li><div><span class="comment"> * @return array                    Gateway tab settings with the PayPal Standard settings</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_register_paypal_gateway_settings( $gateway_settings ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_settings = array (&nbsp;</div></li><li><div>          'paypal_settings' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_settings', &nbsp;</div></li><li><div>              'name' =&gt; '&lt;strong&gt;' . __( 'PayPal Standard Settings', 'easy-digital-downloads' ) . '&lt;/strong&gt;', &nbsp;</div></li><li><div>              'type' =&gt; 'header', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_email' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_email', &nbsp;</div></li><li><div>              'name' =&gt; __( 'PayPal Email', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Enter your PayPal account\'s email', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_page_style' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_page_style', &nbsp;</div></li><li><div>              'name' =&gt; __( 'PayPal Page Style', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Enter the name of the page style to use, or leave blank for default', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $disable_ipn_desc = sprintf(&nbsp;</div></li><li><div>          __( 'If payments are not getting marked as complete, then check this box. This forces the site to use a slightly less secure method of verifying purchases. See our &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;FAQ&lt;/a&gt; for further information.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>          'http:<span class="comment">//docs.easydigitaldownloads.com/article/190-payments-not-marked-as-complete'</span>&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_settings['disable_paypal_verification'] = array(&nbsp;</div></li><li><div>          'id' =&gt; 'disable_paypal_verification', &nbsp;</div></li><li><div>          'name' =&gt; __( 'Disable PayPal IPN Verification', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>          'desc' =&gt; $disable_ipn_desc, &nbsp;</div></li><li><div>          'type' =&gt; 'checkbox', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $api_key_settings = array(&nbsp;</div></li><li><div>          'paypal_api_keys_desc' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_api_keys_desc', &nbsp;</div></li><li><div>              'name' =&gt; __( 'API Credentials', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'descriptive_text', &nbsp;</div></li><li><div>              'desc' =&gt; sprintf(&nbsp;</div></li><li><div>                  __( 'API credentials are necessary to process PayPal refunds from inside WordPress. These can be obtained from &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;your PayPal account&lt;/a&gt;.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>                  'https:<span class="comment">//developer.paypal.com/docs/classic/api/apiCredentials/#creating-an-api-signature'</span>&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_live_api_username' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_live_api_username', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Live API Username', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Your PayPal live API username. ', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_live_api_password' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_live_api_password', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Live API Password', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Your PayPal live API password.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_live_api_signature' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_live_api_signature', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Live API Signature', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Your PayPal live API signature.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_test_api_username' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_test_api_username', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Test API Username', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Your PayPal test API username.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_test_api_password' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_test_api_password', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Test API Password', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Your PayPal test API password.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular'&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'paypal_test_api_signature' =&gt; array(&nbsp;</div></li><li><div>              'id' =&gt; 'paypal_test_api_signature', &nbsp;</div></li><li><div>              'name' =&gt; __( 'Test API Signature', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'desc' =&gt; __( 'Your PayPal test API signature.', 'easy-digital-downloads' ), &nbsp;</div></li><li><div>              'type' =&gt; 'text', &nbsp;</div></li><li><div>              'size' =&gt; 'regular'&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_settings = array_merge( $paypal_settings, $api_key_settings );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_settings = apply_filters( 'edd_paypal_settings', $paypal_settings );&nbsp;</div></li><li><div>      $gateway_settings['paypal'] = $paypal_settings;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return $gateway_settings;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'edd_settings_gateways', 'edd_register_paypal_gateway_settings', 1, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process PayPal Purchase</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $purchase_data Purchase Data</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_paypal_purchase( $purchase_data ) {&nbsp;</div></li><li><div>  if( ! wp_verify_nonce( $purchase_data['gateway_nonce'], 'edd-gateway' ) ) {&nbsp;</div></li><li><div>      wp_die( __( 'Nonce verification has failed', 'easy-digital-downloads' ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Collect payment data</span>&nbsp;</div></li><li><div>  $payment_data = array(&nbsp;</div></li><li><div>      'price' =&gt; $purchase_data['price'], &nbsp;</div></li><li><div>      'date' =&gt; $purchase_data['date'], &nbsp;</div></li><li><div>      'user_email' =&gt; $purchase_data['user_email'], &nbsp;</div></li><li><div>      'purchase_key' =&gt; $purchase_data['purchase_key'], &nbsp;</div></li><li><div>      'currency' =&gt; edd_get_currency(), &nbsp;</div></li><li><div>      'downloads' =&gt; $purchase_data['downloads'], &nbsp;</div></li><li><div>      'user_info' =&gt; $purchase_data['user_info'], &nbsp;</div></li><li><div>      'cart_details' =&gt; $purchase_data['cart_details'], &nbsp;</div></li><li><div>      'gateway' =&gt; 'paypal', &nbsp;</div></li><li><div>      'status' =&gt; ! empty( $purchase_data['buy_now'] ) ? 'private' : 'pending'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Record the pending payment</span>&nbsp;</div></li><li><div>  $payment = edd_insert_payment( $payment_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check payment</span>&nbsp;</div></li><li><div>  if ( ! $payment ) {&nbsp;</div></li><li><div>      <span class="comment">// Record the error</span>&nbsp;</div></li><li><div>      edd_record_gateway_error( __( 'Payment Error', 'easy-digital-downloads' ), sprintf( __( 'Payment creation failed before sending buyer to PayPal. Payment data: %s', 'easy-digital-downloads' ), json_encode( $payment_data ) ), $payment );&nbsp;</div></li><li><div>      <span class="comment">// Problems? send back</span>&nbsp;</div></li><li><div>      edd_send_back_to_checkout( '?payment-mode=' . $purchase_data['post_data']['edd-gateway'] );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Only send to PayPal if the pending payment is created successfully</span>&nbsp;</div></li><li><div>      $listener_url = add_query_arg( 'edd-listener', 'IPN', home_url( 'index.php' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Set the session data to recover this payment in the event of abandonment or error.</span>&nbsp;</div></li><li><div>      EDD()-&gt;session-&gt;set( 'edd_resume_payment', $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the success url</span>&nbsp;</div></li><li><div>      $return_url = add_query_arg( array(&nbsp;</div></li><li><div>              'payment-confirmation' =&gt; 'paypal', &nbsp;</div></li><li><div>              'payment-id' =&gt; $payment&nbsp;</div></li><li><div> ), get_permalink( edd_get_option( 'success_page', false ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get the PayPal redirect uri</span>&nbsp;</div></li><li><div>      $paypal_redirect = trailingslashit( edd_get_paypal_redirect() ) . '?';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Setup PayPal arguments</span>&nbsp;</div></li><li><div>      $paypal_args = array(&nbsp;</div></li><li><div>          'business' =&gt; edd_get_option( 'paypal_email', false ), &nbsp;</div></li><li><div>          'email' =&gt; $purchase_data['user_email'], &nbsp;</div></li><li><div>          'first_name' =&gt; $purchase_data['user_info']['first_name'], &nbsp;</div></li><li><div>          'last_name' =&gt; $purchase_data['user_info']['last_name'], &nbsp;</div></li><li><div>          'invoice' =&gt; $purchase_data['purchase_key'], &nbsp;</div></li><li><div>          'no_shipping' =&gt; '1', &nbsp;</div></li><li><div>          'shipping' =&gt; '0', &nbsp;</div></li><li><div>          'no_note' =&gt; '1', &nbsp;</div></li><li><div>          'currency_code' =&gt; edd_get_currency(), &nbsp;</div></li><li><div>          'charset' =&gt; get_bloginfo( 'charset' ), &nbsp;</div></li><li><div>          'custom' =&gt; $payment, &nbsp;</div></li><li><div>          'rm' =&gt; '2', &nbsp;</div></li><li><div>          'return' =&gt; $return_url, &nbsp;</div></li><li><div>          'cancel_return' =&gt; edd_get_failed_transaction_uri( '?payment-id=' . $payment ), &nbsp;</div></li><li><div>          'notify_url' =&gt; $listener_url, &nbsp;</div></li><li><div>          'page_style' =&gt; edd_get_paypal_page_style(), &nbsp;</div></li><li><div>          'cbt' =&gt; get_bloginfo( 'name' ), &nbsp;</div></li><li><div>          'bn' =&gt; 'EasyDigitalDownloads_SP'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( ! empty( $purchase_data['user_info']['address'] ) ) {&nbsp;</div></li><li><div>          $paypal_args['address1'] = $purchase_data['user_info']['address']['line1'];&nbsp;</div></li><li><div>          $paypal_args['address2'] = $purchase_data['user_info']['address']['line2'];&nbsp;</div></li><li><div>          $paypal_args['city'] = $purchase_data['user_info']['address']['city'];&nbsp;</div></li><li><div>          $paypal_args['country'] = $purchase_data['user_info']['address']['country'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_extra_args = array(&nbsp;</div></li><li><div>          'cmd' =&gt; '_cart', &nbsp;</div></li><li><div>          'upload' =&gt; '1'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_args = array_merge( $paypal_extra_args, $paypal_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add cart items</span>&nbsp;</div></li><li><div>      $i = 1;&nbsp;</div></li><li><div>      if( is_array( $purchase_data['cart_details'] ) && ! empty( $purchase_data['cart_details'] ) ) {&nbsp;</div></li><li><div>          foreach ( $purchase_data['cart_details'] as $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $item_amount = round( ( $item['subtotal'] / $item['quantity'] ) - ( $item['discount'] / $item['quantity'] ), 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( $item_amount &lt;= 0 ) {&nbsp;</div></li><li><div>                  $item_amount = 0;&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $paypal_args['item_name_' . $i ] = stripslashes_deep( html_entity_decode( edd_get_cart_item_name( $item ), ENT_COMPAT, 'UTF-8' ) );&nbsp;</div></li><li><div>              $paypal_args['quantity_' . $i ]  = $item['quantity'];&nbsp;</div></li><li><div>              $paypal_args['amount_' . $i ]    = $item_amount;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if ( edd_use_skus() ) {&nbsp;</div></li><li><div>                  $paypal_args['item_number_' . $i ] = edd_get_download_sku( $item['id'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $i++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Calculate discount</span>&nbsp;</div></li><li><div>      $discounted_amount = 0.00;&nbsp;</div></li><li><div>      if ( ! empty( $purchase_data['fees'] ) ) {&nbsp;</div></li><li><div>          $i = empty( $i ) ? 1 : $i;&nbsp;</div></li><li><div>          foreach ( $purchase_data['fees'] as $fee ) {&nbsp;</div></li><li><div>              if ( empty( $fee['download_id'] ) && floatval( $fee['amount'] ) &gt; '0' ) {&nbsp;</div></li><li><div>                  <span class="comment">// this is a positive fee</span>&nbsp;</div></li><li><div>                  $paypal_args['item_name_' . $i ] = stripslashes_deep( html_entity_decode( wp_strip_all_tags( $fee['label'] ), ENT_COMPAT, 'UTF-8' ) );&nbsp;</div></li><li><div>                  $paypal_args['quantity_' . $i ]  = '1';&nbsp;</div></li><li><div>                  $paypal_args['amount_' . $i ]    = edd_sanitize_amount( $fee['amount'] );&nbsp;</div></li><li><div>                  $i++;&nbsp;</div></li><li><div>              } else if ( empty( $fee['download_id'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">// This is a negative fee (discount) not assigned to a specific Download</span>&nbsp;</div></li><li><div>                  $discounted_amount += abs( $fee['amount'] );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( $discounted_amount &gt; '0' ) {&nbsp;</div></li><li><div>          $paypal_args['discount_amount_cart'] = edd_sanitize_amount( $discounted_amount );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Add taxes to the cart</span>&nbsp;</div></li><li><div>      if ( edd_use_taxes() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $paypal_args['tax_cart'] = edd_sanitize_amount( $purchase_data['tax'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $paypal_args = apply_filters( 'edd_paypal_redirect_args', $paypal_args, $purchase_data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Build query</span>&nbsp;</div></li><li><div>      $paypal_redirect .= http_build_query( $paypal_args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Fix for some sites that encode the entities</span>&nbsp;</div></li><li><div>      $paypal_redirect = str_replace( '&amp;', '&', $paypal_redirect );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Redirect to PayPal</span>&nbsp;</div></li><li><div>      wp_redirect( $paypal_redirect );&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_gateway_paypal', 'edd_process_paypal_purchase' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Listens for a PayPal IPN requests and then sends to the processing function</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_listen_for_paypal_ipn() {&nbsp;</div></li><li><div>  <span class="comment">// Regular PayPal IPN</span>&nbsp;</div></li><li><div>  if ( isset( $_GET['edd-listener'] ) && $_GET['edd-listener'] == 'IPN' ) {&nbsp;</div></li><li><div>      do_action( 'edd_verify_paypal_ipn' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'init', 'edd_listen_for_paypal_ipn' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process PayPal IPN</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_paypal_ipn() {&nbsp;</div></li><li><div>  <span class="comment">// Check the request method is POST</span>&nbsp;</div></li><li><div>  if ( isset( $_SERVER['REQUEST_METHOD'] ) && $_SERVER['REQUEST_METHOD'] != 'POST' ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set initial post data to empty string</span>&nbsp;</div></li><li><div>  $post_data = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Fallback just in case post_max_size is lower than needed</span>&nbsp;</div></li><li><div>  if ( ini_get( 'allow_url_fopen' ) ) {&nbsp;</div></li><li><div>      $post_data = file_get_contents( 'php:<span class="comment">//input' );</span>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// If allow_url_fopen is not enabled, then make sure that post_max_size is large enough</span>&nbsp;</div></li><li><div>      ini_set( 'post_max_size', '12M' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  <span class="comment">// Start the encoded data collection with notification command</span>&nbsp;</div></li><li><div>  $encoded_data = 'cmd=_notify-validate';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Get current arg separator</span>&nbsp;</div></li><li><div>  $arg_separator = edd_get_php_arg_separator_output();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify there is a post_data</span>&nbsp;</div></li><li><div>  if ( $post_data || strlen( $post_data ) &gt; 0 ) {&nbsp;</div></li><li><div>      <span class="comment">// Append the data</span>&nbsp;</div></li><li><div>      $encoded_data .= $arg_separator . $post_data;&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Check if POST is empty</span>&nbsp;</div></li><li><div>      if ( empty( $_POST ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Nothing to do</span>&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          <span class="comment">// Loop through each POST</span>&nbsp;</div></li><li><div>          foreach ( $_POST as $key =&gt; $value ) {&nbsp;</div></li><li><div>              <span class="comment">// Encode the value and append the data</span>&nbsp;</div></li><li><div>              $encoded_data .= $arg_separator . &quot;$key=&quot; . urlencode( $value );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Convert collected post data to an array</span>&nbsp;</div></li><li><div>  parse_str( $encoded_data, $encoded_data_array );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $encoded_data_array as $key =&gt; $value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( false !== strpos( $key, 'amp;' ) ) {&nbsp;</div></li><li><div>          $new_key = str_replace( '&amp;', '&', $key );&nbsp;</div></li><li><div>          $new_key = str_replace( 'amp;', '&', $new_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          unset( $encoded_data_array[ $key ] );&nbsp;</div></li><li><div>          $encoded_data_array[ $new_key ] = $value;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! edd_get_option( 'disable_paypal_verification' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Validate the IPN</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $remote_post_vars = array(&nbsp;</div></li><li><div>          'method' =&gt; 'POST', &nbsp;</div></li><li><div>          'timeout' =&gt; 45, &nbsp;</div></li><li><div>          'redirection' =&gt; 5, &nbsp;</div></li><li><div>          'httpversion' =&gt; '1.1', &nbsp;</div></li><li><div>          'blocking' =&gt; true, &nbsp;</div></li><li><div>          'headers' =&gt; array(&nbsp;</div></li><li><div>              'host' =&gt; 'www.paypal.com', &nbsp;</div></li><li><div>              'connection' =&gt; 'close', &nbsp;</div></li><li><div>              'content-type' =&gt; 'application/x-www-form-urlencoded', &nbsp;</div></li><li><div>              'post' =&gt; '/cgi-bin/webscr HTTP/1.1', &nbsp;</div></li><li><div>              'user-agent' =&gt; 'EDD IPN Verification/' . EDD_VERSION . '; ' . get_bloginfo( 'url' )&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'sslverify' =&gt; false, &nbsp;</div></li><li><div>          'body' =&gt; $encoded_data_array&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Get response</span>&nbsp;</div></li><li><div>      $api_response = wp_remote_post( edd_get_paypal_redirect( true, true ), $remote_post_vars );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( is_wp_error( $api_response ) ) {&nbsp;</div></li><li><div>          edd_record_gateway_error( __( 'IPN Error', 'easy-digital-downloads' ), sprintf( __( 'Invalid IPN verification response. IPN data: %s', 'easy-digital-downloads' ), json_encode( $api_response ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return; <span class="comment">// Something went wrong</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( wp_remote_retrieve_body( $api_response ) !== 'VERIFIED' && edd_get_option( 'disable_paypal_verification', false ) ) {&nbsp;</div></li><li><div>          edd_record_gateway_error( __( 'IPN Error', 'easy-digital-downloads' ), sprintf( __( 'Invalid IPN verification response. IPN data: %s', 'easy-digital-downloads' ), json_encode( $api_response ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return; <span class="comment">// Response not okay</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check if $post_data_array has been populated</span>&nbsp;</div></li><li><div>  if ( ! is_array( $encoded_data_array ) && ! empty( $encoded_data_array ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $defaults = array(&nbsp;</div></li><li><div>      'txn_type' =&gt; '', &nbsp;</div></li><li><div>      'payment_status' =&gt; ''&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $encoded_data_array = wp_parse_args( $encoded_data_array, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! empty( $encoded_data_array[ 'parent_txn_id' ] ) ) {&nbsp;</div></li><li><div>      $payment_id = edd_get_purchase_id_by_transaction_id( $encoded_data_array[ 'parent_txn_id' ] );&nbsp;</div></li><li><div>  } elseif ( ! empty( $encoded_data_array[ 'txn_id' ] ) ) {&nbsp;</div></li><li><div>      $payment_id = edd_get_purchase_id_by_transaction_id( $encoded_data_array[ 'txn_id' ] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $payment_id ) ) {&nbsp;</div></li><li><div>      $payment_id = ! empty( $encoded_data_array[ 'custom' ] ) ? absint( $encoded_data_array[ 'custom' ] ) : 0;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( has_action( 'edd_paypal_' . $encoded_data_array['txn_type'] ) ) {&nbsp;</div></li><li><div>      <span class="comment">// Allow PayPal IPN types to be processed separately</span>&nbsp;</div></li><li><div>      do_action( 'edd_paypal_' . $encoded_data_array['txn_type'], $encoded_data_array, $payment_id );&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>      <span class="comment">// Fallback to web accept just in case the txn_type isn't present</span>&nbsp;</div></li><li><div>      do_action( 'edd_paypal_web_accept', $encoded_data_array, $payment_id );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>  exit;&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_verify_paypal_ipn', 'edd_process_paypal_ipn' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process web accept (one time) payment IPNs</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $data IPN Data</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_paypal_web_accept_and_cart( $data, $payment_id ) {&nbsp;</div></li><li><div>  if ( $data['txn_type'] != 'web_accept' && $data['txn_type'] != 'cart' && $data['payment_status'] != 'Refunded' ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $payment_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Collect payment details</span></span>&nbsp;</div></li><li><div>  $purchase_key = isset( $data['invoice'] ) ? $data['invoice'] : $data['item_number'];&nbsp;</div></li><li><div>  $paypal_amount = $data['mc_gross'];&nbsp;</div></li><li><div>  $payment_status = strtolower( $data['payment_status'] );&nbsp;</div></li><li><div>  $currency_code = strtolower( $data['mc_currency'] );&nbsp;</div></li><li><div>  $business_email = isset( $data['business'] ) && is_email( $data['business'] ) ? trim( $data['business'] ) : trim( $data['receiver_email'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $payment-&gt;gateway != 'paypal' ) {&nbsp;</div></li><li><div>      return; <span class="comment">// this isn't a PayPal standard IPN</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify payment recipient</span>&nbsp;</div></li><li><div>  if ( strcasecmp( $business_email, trim( edd_get_option( 'paypal_email', false ) ) ) != 0 ) {&nbsp;</div></li><li><div>      edd_record_gateway_error( __( 'IPN Error', 'easy-digital-downloads' ), sprintf( __( 'Invalid business email in IPN response. IPN data: %s', 'easy-digital-downloads' ), json_encode( $data ) ), $payment_id );&nbsp;</div></li><li><div>      edd_update_payment_status( $payment_id, 'failed' );&nbsp;</div></li><li><div>      edd_insert_payment_note( $payment_id, __( 'Payment failed due to invalid PayPal business email.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Verify payment currency</span>&nbsp;</div></li><li><div>  if ( $currency_code != strtolower( $payment-&gt;currency ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      edd_record_gateway_error( __( 'IPN Error', 'easy-digital-downloads' ), sprintf( __( 'Invalid currency in IPN response. IPN data: %s', 'easy-digital-downloads' ), json_encode( $data ) ), $payment_id );&nbsp;</div></li><li><div>      edd_update_payment_status( $payment_id, 'failed' );&nbsp;</div></li><li><div>      edd_insert_payment_note( $payment_id, __( 'Payment failed due to invalid currency in PayPal IPN.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $payment-&gt;email ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This runs when a Buy Now purchase was made. It bypasses checkout so no personal info is collected until PayPal</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Setup and store the customers's details</span>&nbsp;</div></li><li><div>      $address = array();&nbsp;</div></li><li><div>      $address['line1'] = ! empty( $data['address_street'] ) ? sanitize_text_field( $data['address_street'] )       : false;&nbsp;</div></li><li><div>      $address['city'] = ! empty( $data['address_city'] ) ? sanitize_text_field( $data['address_city'] )         : false;&nbsp;</div></li><li><div>      $address['state'] = ! empty( $data['address_state'] ) ? sanitize_text_field( $data['address_state'] )        : false;&nbsp;</div></li><li><div>      $address['country'] = ! empty( $data['address_country_code'] ) ? sanitize_text_field( $data['address_country_code'] ) : false;&nbsp;</div></li><li><div>      $address['zip'] = ! empty( $data['address_zip'] ) ? sanitize_text_field( $data['address_zip'] )          : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment-&gt;email = sanitize_text_field( $data['payer_email'] );&nbsp;</div></li><li><div>      $payment-&gt;first_name = sanitize_text_field( $data['first_name'] );&nbsp;</div></li><li><div>      $payment-&gt;last_name = sanitize_text_field( $data['last_name'] );&nbsp;</div></li><li><div>      $payment-&gt;address = $address;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $payment-&gt;customer_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $customer = new EDD_Customer( $payment-&gt;email );&nbsp;</div></li><li><div>          if( ! $customer || $customer-&gt;id &lt; 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $customer-&gt;create( array(&nbsp;</div></li><li><div>                  'email' =&gt; $payment-&gt;email, &nbsp;</div></li><li><div>                  'name' =&gt; $payment-&gt;first_name . ' ' . $payment-&gt;last_name, &nbsp;</div></li><li><div>                  'user_id' =&gt; $payment-&gt;user_id&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $payment-&gt;customer_id = $customer-&gt;id;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment-&gt;save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $payment_status == 'refunded' || $payment_status == 'reversed' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Process a refund</span>&nbsp;</div></li><li><div>      edd_process_paypal_refund( $data, $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( get_post_status( $payment_id ) == 'publish' ) {&nbsp;</div></li><li><div>          return; <span class="comment">// Only complete payments once</span>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Retrieve the total purchase amount (before PayPal)</span>&nbsp;</div></li><li><div>      $payment_amount = edd_get_payment_amount( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( number_format( (float) $paypal_amount, 2 ) &lt; number_format( (float) $payment_amount, 2 ) ) {&nbsp;</div></li><li><div>          <span class="comment">// The prices don't match</span>&nbsp;</div></li><li><div>          edd_record_gateway_error( __( 'IPN Error', 'easy-digital-downloads' ), sprintf( __( 'Invalid payment amount in IPN response. IPN data: %s', 'easy-digital-downloads' ), json_encode( $data ) ), $payment_id );&nbsp;</div></li><li><div>          edd_update_payment_status( $payment_id, 'failed' );&nbsp;</div></li><li><div>          edd_insert_payment_note( $payment_id, __( 'Payment failed due to invalid amount in PayPal IPN.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if ( $purchase_key != edd_get_payment_key( $payment_id ) ) {&nbsp;</div></li><li><div>          <span class="comment">// Purchase keys don't match</span>&nbsp;</div></li><li><div>          edd_record_gateway_error( __( 'IPN Error', 'easy-digital-downloads' ), sprintf( __( 'Invalid purchase key in IPN response. IPN data: %s', 'easy-digital-downloads' ), json_encode( $data ) ), $payment_id );&nbsp;</div></li><li><div>          edd_update_payment_status( $payment_id, 'failed' );&nbsp;</div></li><li><div>          edd_insert_payment_note( $payment_id, __( 'Payment failed due to invalid purchase key in PayPal IPN.', 'easy-digital-downloads' ) );&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( 'completed' == $payment_status || edd_is_test_mode() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          edd_insert_payment_note( $payment_id, sprintf( __( 'PayPal Transaction ID: %s', 'easy-digital-downloads' ) , $data['txn_id'] ) );&nbsp;</div></li><li><div>          edd_set_payment_transaction_id( $payment_id, $data['txn_id'] );&nbsp;</div></li><li><div>          edd_update_payment_status( $payment_id, 'publish' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else if ( 'pending' == $payment_status && isset( $data['pending_reason'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// Look for possible pending reasons, such as an echeck</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $note = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          switch( strtolower( $data['pending_reason'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'echeck' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment made via eCheck and will clear automatically in 5-8 days', 'easy-digital-downloads' );&nbsp;</div></li><li><div>                  $payment-&gt;status = 'processing';&nbsp;</div></li><li><div>                  $payment-&gt;save();&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'address' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment requires a confirmed customer address and must be accepted manually through PayPal', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'intl' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment must be accepted manually through PayPal due to international account regulations', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'multi-currency' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment received in non-shop currency and must be accepted manually through PayPal', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'paymentreview' :&nbsp;</div></li><li><div>              case 'regulatory_review' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment is being reviewed by PayPal staff as high-risk or in possible violation of government regulations', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'unilateral' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment was sent to non-confirmed or non-registered email address.', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'upgrade' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'PayPal account must be upgraded before this payment can be accepted', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'verify' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'PayPal account is not verified. Verify account in order to accept this payment', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              case 'other' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $note = __( 'Payment is pending for unknown reasons. Contact PayPal support for assistance', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if( ! empty( $note ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              edd_insert_payment_note( $payment_id, $note );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_paypal_web_accept', 'edd_process_paypal_web_accept_and_cart', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Process PayPal IPN Refunds</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.3.4</span>&nbsp;</div></li><li><div><span class="comment"> * @param array   $data IPN Data</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_process_paypal_refund( $data, $payment_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment"><span class="comment">// Collect payment details</span></span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $payment_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( get_post_status( $payment_id ) == 'refunded' ) {&nbsp;</div></li><li><div>      return; <span class="comment">// Only refund payments once</span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment_amount = edd_get_payment_amount( $payment_id );&nbsp;</div></li><li><div>  $refund_amount = $data['mc_gross'] * -1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( number_format( (float) $refund_amount, 2 ) &lt; number_format( (float) $payment_amount, 2 ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      edd_insert_payment_note( $payment_id, sprintf( __( 'Partial PayPal refund processed: %s', 'easy-digital-downloads' ), $data['parent_txn_id'] ) );&nbsp;</div></li><li><div>      return; <span class="comment">// This is a partial refund</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  edd_insert_payment_note( $payment_id, sprintf( __( 'PayPal Payment #%s Refunded for reason: %s', 'easy-digital-downloads' ), $data['parent_txn_id'], $data['reason_code'] ) );&nbsp;</div></li><li><div>  edd_insert_payment_note( $payment_id, sprintf( __( 'PayPal Refund Transaction ID: %s', 'easy-digital-downloads' ), $data['txn_id'] ) );&nbsp;</div></li><li><div>  edd_update_payment_status( $payment_id, 'refunded' );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Get PayPal Redirect</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.0.8.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool    $ssl_check Is SSL?</span>&nbsp;</div></li><li><div><span class="comment"> * @param bool    $ipn       Is this an IPN verification check?</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_paypal_redirect( $ssl_check = false, $ipn = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $protocol = 'http:<span class="comment"><span class="comment">//';</span></span>&nbsp;</div></li><li><div>  if ( is_ssl() || ! $ssl_check ) {&nbsp;</div></li><li><div>      $protocol = 'https:<span class="comment"><span class="comment">//';</span></span>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Check the current payment mode</span>&nbsp;</div></li><li><div>  if ( edd_is_test_mode() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Test mode</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $ipn ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $paypal_uri = 'https:<span class="comment">//ipnpb.sandbox.paypal.com/cgi-bin/webscr';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $paypal_uri = $protocol . 'www.sandbox.paypal.com/cgi-bin/webscr';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Live mode</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( $ipn ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $paypal_uri = 'https:<span class="comment">//ipnpb.paypal.com/cgi-bin/webscr';</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $paypal_uri = $protocol . 'www.paypal.com/cgi-bin/webscr';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_paypal_uri', $paypal_uri, $ssl_check, $ipn );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Set the Page Style for PayPal Purchase page</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.4.1</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_get_paypal_page_style() {&nbsp;</div></li><li><div>  $page_style = trim( edd_get_option( 'paypal_page_style', 'PayPal' ) );&nbsp;</div></li><li><div>  return apply_filters( 'edd_paypal_page_style', $page_style );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Shows &quot;Purchase Processing&quot; message for PayPal payments are still pending on site return</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * This helps address the Race Condition, as detailed in issue #1839</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since 1.9</span>&nbsp;</div></li><li><div><span class="comment"> * @return string</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_paypal_success_page_content( $content ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! isset( $_GET['payment-id'] ) && ! edd_get_purchase_session() ) {&nbsp;</div></li><li><div>      return $content;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  edd_empty_cart();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment_id = isset( $_GET['payment-id'] ) ? absint( $_GET['payment-id'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( ! $payment_id ) {&nbsp;</div></li><li><div>      $session = edd_get_purchase_session();&nbsp;</div></li><li><div>      $payment_id = edd_get_purchase_id_by_key( $session['purchase_key'] );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = get_post( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( $payment && 'pending' == $payment-&gt;post_status ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Payment is still pending so show processing indicator to fix the Race Condition, issue #</span>&nbsp;</div></li><li><div>      ob_start();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      edd_get_template_part( 'payment', 'processing' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $content = ob_get_clean();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return $content;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'edd_payment_confirm_paypal', 'edd_paypal_success_page_content' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Given a Payment ID, extract the transaction ID</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.1</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $payment_id       Payment ID</span>&nbsp;</div></li><li><div><span class="comment"> * @return string                   Transaction ID</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_paypal_get_payment_transaction_id( $payment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $transaction_id = '';&nbsp;</div></li><li><div>  $notes = edd_get_payment_notes( $payment_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  foreach ( $notes as $note ) {&nbsp;</div></li><li><div>      if ( preg_match( '/^PayPal Transaction ID: ([^\s]+)/', $note-&gt;comment_content, $match ) ) {&nbsp;</div></li><li><div>          $transaction_id = $match[1];&nbsp;</div></li><li><div>          continue;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_paypal_set_payment_transaction_id', $transaction_id, $payment_id );&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'edd_get_payment_transaction_id-paypal', 'edd_paypal_get_payment_transaction_id', 10, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Given a transaction ID, generate a link to the PayPal transaction ID details</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.2</span>&nbsp;</div></li><li><div><span class="comment"> * @param  string $transaction_id The Transaction ID</span>&nbsp;</div></li><li><div><span class="comment"> * @param  int    $payment_id     The payment ID for this transaction</span>&nbsp;</div></li><li><div><span class="comment"> * @return string                 A link to the PayPal transaction details</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_paypal_link_transaction_id( $transaction_id, $payment_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $payment = new EDD_Payment( $payment_id );&nbsp;</div></li><li><div>  $sandbox = 'test' == $payment-&gt;mode ? 'sandbox.' : '';&nbsp;</div></li><li><div>  $paypal_base_url = 'https:<span class="comment">//www.' . $sandbox . 'paypal.com/webscr?cmd=_history-details-from-hub&id=';</span>&nbsp;</div></li><li><div>  $transaction_url = '&lt;a href=&quot;' . esc_url( $paypal_base_url . $transaction_id ) . '&quot; target=&quot;_blank&quot;&gt;' . $transaction_id . '&lt;/a&gt;';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  return apply_filters( 'edd_paypal_link_payment_details_transaction_id', $transaction_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_filter( 'edd_payment_details_transaction_id-paypal', 'edd_paypal_link_transaction_id', 10, 2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Shows checkbox to automatically refund payments made in PayPal.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id The current payment ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_paypal_refund_admin_js( $payment_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If not the proper gateway, return early.</span>&nbsp;</div></li><li><div>  if ( 'paypal' !== edd_get_payment_gateway( $payment_id ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If our credentials are not set, return early.</span>&nbsp;</div></li><li><div>  $key = edd_get_payment_meta( $payment_id, '_edd_payment_mode', true );&nbsp;</div></li><li><div>  $username = edd_get_option( 'paypal_' . $key . '_api_username' );&nbsp;</div></li><li><div>  $password = edd_get_option( 'paypal_' . $key . '_api_password' );&nbsp;</div></li><li><div>  $signature = edd_get_option( 'paypal_' . $key . '_api_signature' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( empty( $username ) || empty( $password ) || empty( $signature ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Localize the refund checkbox label.</span>&nbsp;</div></li><li><div>  $label = __( 'Refund Payment in PayPal', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  ?&gt;&nbsp;</div></li><li><div>  &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>      jQuery(document).ready(function($) {&nbsp;</div></li><li><div>          $('select[name=edd-payment-status]').change(function() {&nbsp;</div></li><li><div>              if ( 'refunded' == $(this).val() ) {&nbsp;</div></li><li><div>                  $(this).parent().parent().append('&lt;input type=&quot;checkbox&quot; id=&quot;edd-paypal-refund&quot; name=&quot;edd-paypal-refund&quot; value=&quot;1&quot; style=&quot;margin-top:0&quot;&gt;');&nbsp;</div></li><li><div>                  $(this).parent().parent().append('&lt;label for=&quot;edd-paypal-refund&quot;&gt;&lt;?php echo $label; ?&gt;&lt;/label&gt;');&nbsp;</div></li><li><div>              } else {&nbsp;</div></li><li><div>                  $('#edd-paypal-refund').remove();&nbsp;</div></li><li><div>                  $('label[for=&quot;edd-paypal-refund&quot;]').remove();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          });&nbsp;</div></li><li><div>      });&nbsp;</div></li><li><div>  &lt;/script&gt;&nbsp;</div></li><li><div>  &lt;?php&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_view_order_details_before', 'edd_paypal_refund_admin_js', 100 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Possibly refunds a payment made with PayPal Standard or PayPal Express.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param int $payment_id The current payment ID.</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_maybe_refund_paypal_purchase( EDD_Payment $payment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! current_user_can( 'edit_shop_payments', $payment-&gt;ID ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( empty( $_POST['edd-paypal-refund'] ) ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $processed = $payment-&gt;get_meta( '_edd_paypal_refunded', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the status is not set to &quot;refunded&quot;, return early.</span>&nbsp;</div></li><li><div>  if ( 'publish' !== $payment-&gt;old_status && 'revoked' !== $payment-&gt;old_status ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If not PayPal/PayPal Express, return early.</span>&nbsp;</div></li><li><div>  if ( 'paypal' !== $payment-&gt;gateway ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// If the payment has already been refunded in the past, return early.</span>&nbsp;</div></li><li><div>  if ( $processed ) {&nbsp;</div></li><li><div>      return;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Process the refund in PayPal.</span>&nbsp;</div></li><li><div>  edd_refund_paypal_purchase( $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>add_action( 'edd_pre_refund_payment', 'edd_maybe_refund_paypal_purchase', 999 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment"> * Refunds a purchase made via PayPal.</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @access public</span>&nbsp;</div></li><li><div><span class="comment"> * @since  2.6.0</span>&nbsp;</div></li><li><div><span class="comment"> *</span>&nbsp;</div></li><li><div><span class="comment"> * @param object|int $payment The payment ID or object to refund.</span>&nbsp;</div></li><li><div><span class="comment"> * @return void</span>&nbsp;</div></li><li><div><span class="comment"> */</span>&nbsp;</div></li><li><div>function edd_refund_paypal_purchase( $payment ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( ! is_a( $payment, 'EDD_Payment' ) && is_numeric( $payment ) ) {&nbsp;</div></li><li><div>      $payment = new EDD_Payment( $payment );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Set PayPal API key credentials.</span>&nbsp;</div></li><li><div>  $credentials = array(&nbsp;</div></li><li><div>      'api_endpoint' =&gt; 'test' == $payment-&gt;mode ? 'https:<span class="comment">//api-3t.sandbox.paypal.com/nvp' : 'https://api-3t.paypal.com/nvp', </span>&nbsp;</div></li><li><div>      'api_username' =&gt; edd_get_option( 'paypal_' . $payment-&gt;mode . '_api_username' ), &nbsp;</div></li><li><div>      'api_password' =&gt; edd_get_option( 'paypal_' . $payment-&gt;mode . '_api_password' ), &nbsp;</div></li><li><div>      'api_signature' =&gt; edd_get_option( 'paypal_' . $payment-&gt;mode . '_api_signature' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $credentials = apply_filters( 'edd_paypal_refund_api_credentials', $credentials, $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $body = array(&nbsp;</div></li><li><div>      'USER' =&gt; $credentials['api_username'], &nbsp;</div></li><li><div>      'PWD' =&gt; $credentials['api_password'], &nbsp;</div></li><li><div>      'SIGNATURE' =&gt; $credentials['api_signature'], &nbsp;</div></li><li><div>      'VERSION' =&gt; '124', &nbsp;</div></li><li><div>      'METHOD' =&gt; 'RefundTransaction', &nbsp;</div></li><li><div>      'TRANSACTIONID' =&gt; $payment-&gt;transaction_id, &nbsp;</div></li><li><div>      'REFUNDTYPE' =&gt; 'Full'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $body = apply_filters( 'edd_paypal_refund_body_args', $body, $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Prepare the headers of the refund request.</span>&nbsp;</div></li><li><div>  $headers = array(&nbsp;</div></li><li><div>      'Content-Type' =&gt; 'application/x-www-form-urlencoded', &nbsp;</div></li><li><div>      'Cache-Control' =&gt; 'no-cache'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $headers = apply_filters( 'edd_paypal_refund_header_args', $headers, $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Prepare args of the refund request.</span>&nbsp;</div></li><li><div>  $args = array(&nbsp;</div></li><li><div>      'body' =&gt; $body, &nbsp;</div></li><li><div>      'headers' =&gt; $headers, &nbsp;</div></li><li><div>      'httpversion' =&gt; '1.1'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $args = apply_filters( 'edd_paypal_refund_request_args', $args, $payment );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  $error_msg = '';&nbsp;</div></li><li><div>  $request = wp_remote_post( $credentials['api_endpoint'], $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if ( is_wp_error( $request ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $success = false;&nbsp;</div></li><li><div>      $error_msg = $request-&gt;get_error_message();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $body = wp_remote_retrieve_body( $request );&nbsp;</div></li><li><div>      $code = wp_remote_retrieve_response_code( $request );&nbsp;</div></li><li><div>      $message = wp_remote_retrieve_response_message( $request );&nbsp;</div></li><li><div>      if( is_string( $body ) ) {&nbsp;</div></li><li><div>          wp_parse_str( $body, $body );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $code ) || 200 !== (int) $code ) {&nbsp;</div></li><li><div>          $success = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( empty( $message ) || 'OK' !== $message ) {&nbsp;</div></li><li><div>          $success = false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if( isset( $body['ACK'] ) && 'success' === strtolower( $body['ACK'] ) ) {&nbsp;</div></li><li><div>          $success = true;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $success = false;&nbsp;</div></li><li><div>          if( isset( $body['L_LONGMESSAGE0'] ) ) {&nbsp;</div></li><li><div>              $error_msg = $body['L_LONGMESSAGE0'];&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              $error_msg = __( 'PayPal refund failed for unknown reason.', 'easy-digital-downloads' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  if( $success ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// Prevents the PayPal Express one-time gateway from trying to process the refundl</span>&nbsp;</div></li><li><div>      $payment-&gt;update_meta( '_edd_paypal_refunded', true );&nbsp;</div></li><li><div>      $payment-&gt;add_note( sprintf( __( 'PayPal refund transaction ID: %s', 'easy-digital-downloads' ), $body['REFUNDTRANSACTIONID'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $payment-&gt;add_note( sprintf( __( 'PayPal refund failed: %s', 'easy-digital-downloads' ), $error_msg ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Run hook letting people know the payment has been refunded successfully.</span>&nbsp;</div></li><li><div>  do_action( 'edd_paypal_refund_purchase', $payment );&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>Easy Digital Downloads</li><li><span></span>2.7.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>