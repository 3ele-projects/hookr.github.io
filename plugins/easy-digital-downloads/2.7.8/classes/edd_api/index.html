<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.8" data-slug="easy-digital-downloads" data-type="class" data-id="56019"><head xmlns="http://www.w3.org/1999/xhtml"><title> edd_api | class | Easy Digital Downloads | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="EDD_API, class, plugin, easy-digital-downloads, 2.7.8" /><meta name="description" content="EDD_API Class" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=cb57144f96f7d800b989fdb89982f5a5' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/edd_api/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fedd_api%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fedd_api%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-easy-digital-downloads-2.7.8-class-edd_api","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="edd_api" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to easy-digital-downloads." href="http://hookr.io/plugins/easy-digital-downloads/" class="plugin"><span property="name">easy-digital-downloads</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.8." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/" class="H_VERSION"><span property="name">2.7.8</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">edd_api</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="2274"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/all/" title="All">All <span class="count badge">2274</span></a></li><li class="" data-id="new" data-count="5"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/new/" title="New">New <span class="count badge">5</span></a></li><li class="" data-id="hooks" data-count="1195"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/hooks/" title="Hooks">Hooks <span class="count badge">1195</span></a></li><li class="" data-id="action" data-count="469"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/actions/" title="Actions">Actions <span class="count badge">469</span></a></li><li class="" data-id="filter" data-count="726"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/filters/" title="Filters">Filters <span class="count badge">726</span></a></li><li class="active" data-id="class" data-count="99"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/" title="Classes">Classes <span class="count badge">99</span></a></li><li class="" data-id="constant" data-count="11"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/constants/" title="Constants">Constants <span class="count badge">11</span></a></li><li class="" data-id="function" data-count="955"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/functions/" title="Functions">Functions <span class="count badge">955</span></a></li><li class="" data-id="shortcode" data-count="14"><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">14</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>EDD_API</strong></h1><p>EDD_API Class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(2)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/includes-api-class-edd-api/" class="file">/includes/api/class-edd-api.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="28" class="block" start="28"><li><div>class EDD_API {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Latest API Version&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const VERSION = 2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Pretty Print?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $pretty_print = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Log API requests?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $log_requests = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is this a valid request?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $is_valid_request = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * User ID Performing the API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.1&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $user_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Instance of EDD Stats class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var object&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.7&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $stats;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Response data to return&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.2&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.7&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $override = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Version of the API queried&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $queried_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * All versions of the API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected $versions = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Queried endpoint&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var string&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $endpoint;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Endpoints routes&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var object&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $routes;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Setup the EDD API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;versions = array(&nbsp;</div></li><li><div>            'v1' =&gt; 'EDD_API_V1', &nbsp;</div></li><li><div>            'v2' =&gt; 'EDD_API_V2'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach( $this-&gt;get_versions() as $version =&gt; $class ) {&nbsp;</div></li><li><div>            require_once EDD_PLUGIN_DIR . 'includes/api/class-edd-api-' . $version . '.php';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'init', array( $this, 'add_endpoint' ) );&nbsp;</div></li><li><div>        add_action( 'wp', array( $this, 'process_query' ), -1 );&nbsp;</div></li><li><div>        add_filter( 'query_vars', array( $this, 'query_vars' ) );&nbsp;</div></li><li><div>        add_action( 'edd_process_api_key', array( $this, 'process_api_key' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Setup a backwards compatibility check for user API Keys&nbsp;</div></li><li><div>        add_filter( 'get_user_metadata', array( $this, 'api_key_backwards_copmat' ), 10, 4 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine if JSON_PRETTY_PRINT is available&nbsp;</div></li><li><div>        $this-&gt;pretty_print = defined( 'JSON_PRETTY_PRINT' ) ? JSON_PRETTY_PRINT : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Setup EDD_Stats instance&nbsp;</div></li><li><div>        $this-&gt;stats = new EDD_Payment_Stats;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers a new rewrite endpoint for accessing the API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @param array $rewrite_rules WordPress Rewrite Rules&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_endpoint( $rewrite_rules ) {&nbsp;</div></li><li><div>        add_rewrite_endpoint( 'edd-api', EP_ALL );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers query vars for API access&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @param array $vars Query vars&nbsp;</div></li><li><div>     * @return string[] $vars New query vars&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function query_vars( $vars ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $vars[] = 'token';&nbsp;</div></li><li><div>        $vars[] = 'key';&nbsp;</div></li><li><div>        $vars[] = 'query';&nbsp;</div></li><li><div>        $vars[] = 'type';&nbsp;</div></li><li><div>        $vars[] = 'product';&nbsp;</div></li><li><div>        $vars[] = 'category';&nbsp;</div></li><li><div>        $vars[] = 'tag';&nbsp;</div></li><li><div>        $vars[] = 'term_relation';&nbsp;</div></li><li><div>        $vars[] = 'number';&nbsp;</div></li><li><div>        $vars[] = 'date';&nbsp;</div></li><li><div>        $vars[] = 'startdate';&nbsp;</div></li><li><div>        $vars[] = 'enddate';&nbsp;</div></li><li><div>        $vars[] = 'customer';&nbsp;</div></li><li><div>        $vars[] = 'discount';&nbsp;</div></li><li><div>        $vars[] = 'format';&nbsp;</div></li><li><div>        $vars[] = 'id';&nbsp;</div></li><li><div>        $vars[] = 'purchasekey';&nbsp;</div></li><li><div>        $vars[] = 'email';&nbsp;</div></li><li><div>        $vars[] = 'info';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $vars;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the API versions&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_versions() {&nbsp;</div></li><li><div>        return $this-&gt;versions;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the API version that was queried&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_queried_version() {&nbsp;</div></li><li><div>        return $this-&gt;queried_version;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves the default version of the API to use&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_default_version() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version = get_option( 'edd_default_api_version' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( defined( 'EDD_API_VERSION' ) ) {&nbsp;</div></li><li><div>            $version = EDD_API_VERSION;&nbsp;</div></li><li><div>        } elseif( ! $version ) {&nbsp;</div></li><li><div>            $version = 'v1';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $version;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets the version of the API that was queried.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Falls back to the default version if no version is specified&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function set_queried_version() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $version = $wp_query-&gt;query_vars['edd-api'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( strpos( $version, '/' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $version = explode( '/', $version );&nbsp;</div></li><li><div>            $version = strtolower( $version[0] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $wp_query-&gt;query_vars['edd-api'] = str_replace( $version . '/', '', $wp_query-&gt;query_vars['edd-api'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if( array_key_exists( $version, $this-&gt;versions ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;queried_version = $version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;is_valid_request = false;&nbsp;</div></li><li><div>                $this-&gt;invalid_version();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;queried_version = $this-&gt;get_default_version();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate the API request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Checks for the user's public key and token against the secret key&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @global object $wp_query WordPress Query&nbsp;</div></li><li><div>     * @uses EDD_API::get_user()&nbsp;</div></li><li><div>     * @uses EDD_API::invalid_key()&nbsp;</div></li><li><div>     * @uses EDD_API::invalid_auth()&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_request() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;override = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure we have both user and api key&nbsp;</div></li><li><div>        if ( ! empty( $wp_query-&gt;query_vars['edd-api'] ) && ( ! $this-&gt;is_public_query() || ! empty( $wp_query-&gt;query_vars['token'] ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $wp_query-&gt;query_vars['token'] ) || empty( $wp_query-&gt;query_vars['key'] ) ) {&nbsp;</div></li><li><div>                $this-&gt;missing_auth();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Auth was provided, include the upgrade routine so we can use the fallback api checks&nbsp;</div></li><li><div>            require_once EDD_PLUGIN_DIR . 'includes/admin/upgrades/upgrade-functions.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Retrieve the user by public API key and ensure they exist&nbsp;</div></li><li><div>            if ( ! ( $user = $this-&gt;get_user( $wp_query-&gt;query_vars['key'] ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;invalid_key();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $token = urldecode( $wp_query-&gt;query_vars['token'] );&nbsp;</div></li><li><div>                $secret = $this-&gt;get_user_secret_key( $user );&nbsp;</div></li><li><div>                $public = urldecode( $wp_query-&gt;query_vars['key'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( hash_equals( md5( $secret . $public ), $token ) ) {&nbsp;</div></li><li><div>                    $this-&gt;is_valid_request = true;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $this-&gt;invalid_auth();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( ! empty( $wp_query-&gt;query_vars['edd-api'] ) && $this-&gt;is_public_query() ) {&nbsp;</div></li><li><div>            $this-&gt;is_valid_request = true;&nbsp;</div></li><li><div>            $wp_query-&gt;set( 'key', 'public' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return whether this is a public query.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @global object $wp_query WordPress Query&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function is_public_query() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $public_modes = apply_filters( 'edd_api_public_query_modes', array(&nbsp;</div></li><li><div>            'products'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return in_array( $wp_query-&gt;query_vars['edd-api'], $public_modes );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the user ID based on the public key provided&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5.1&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     * Database API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key Public Key&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool if user ID is found, false otherwise&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_user( $key = '' ) {&nbsp;</div></li><li><div>        global $wpdb, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $key ) ) {&nbsp;</div></li><li><div>            $key = urldecode( $wp_query-&gt;query_vars['key'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $key ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_transient( md5( 'edd_api_user_' . $key ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false === $user ) {&nbsp;</div></li><li><div>            if ( edd_has_upgrade_completed( 'upgrade_user_api_keys' ) ) {&nbsp;</div></li><li><div>                $user = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT user_id FROM $wpdb-&gt;usermeta WHERE meta_key = %s LIMIT 1&quot;, $key ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $user = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT user_id FROM $wpdb-&gt;usermeta WHERE meta_key = 'edd_user_public_key' AND meta_value = %s LIMIT 1&quot;, $key ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            set_transient( md5( 'edd_api_user_' . $key ) , $user, DAY_IN_SECONDS );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $user != NULL ) {&nbsp;</div></li><li><div>            $this-&gt;user_id = $user;&nbsp;</div></li><li><div>            return $user;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_user_public_key( $user_id = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_key = md5( 'edd_api_user_public_key' . $user_id );&nbsp;</div></li><li><div>        $user_public_key = get_transient( $cache_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $user_public_key ) ) {&nbsp;</div></li><li><div>            if ( edd_has_upgrade_completed( 'upgrade_user_api_keys' ) ) {&nbsp;</div></li><li><div>                $user_public_key = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT meta_key FROM $wpdb-&gt;usermeta WHERE meta_value = 'edd_user_public_key' AND user_id = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $user_public_key = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT meta_value FROM $wpdb-&gt;usermeta WHERE meta_key = 'edd_user_public_key' AND user_id = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            set_transient( $cache_key, $user_public_key, HOUR_IN_SECONDS );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $user_public_key;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_user_secret_key( $user_id = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $user_id ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_key = md5( 'edd_api_user_secret_key' . $user_id );&nbsp;</div></li><li><div>        $user_secret_key = get_transient( $cache_key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $user_secret_key ) ) {&nbsp;</div></li><li><div>            if ( edd_has_upgrade_completed( 'upgrade_user_api_keys' ) ) {&nbsp;</div></li><li><div>                $user_secret_key = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT meta_key FROM $wpdb-&gt;usermeta WHERE meta_value = 'edd_user_secret_key' AND user_id = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $user_secret_key = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT meta_value FROM $wpdb-&gt;usermeta WHERE meta_key = 'edd_user_secret_key' AND user_id = %d&quot;, $user_id ) );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            set_transient( $cache_key, $user_secret_key, HOUR_IN_SECONDS );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $user_secret_key;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays a missing authentication error if all the parameters aren't&nbsp;</div></li><li><div>     * provided&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function missing_auth() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'You must specify both a token and API key!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 401 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an authentication failed error if the user failed to provide valid&nbsp;</div></li><li><div>     * credentials&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since  1.5&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function invalid_auth() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'Your request could not be authenticated!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 403 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an invalid API key error if the API key provided couldn't be&nbsp;</div></li><li><div>     * validated&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function invalid_key() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'Invalid API key!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 403 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an invalid version error if the version number passed isn't valid&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function invalid_version() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'Invalid API version!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 404 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Listens for the API and then processes the API requests&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function process_query() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Start logging how long the request takes for logging&nbsp;</div></li><li><div>        $before = microtime( true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for edd-api var. Get out if not present&nbsp;</div></li><li><div>        if ( empty( $wp_query-&gt;query_vars['edd-api'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine which version was queried&nbsp;</div></li><li><div>        $this-&gt;set_queried_version();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine the kind of query&nbsp;</div></li><li><div>        $this-&gt;set_query_mode();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for a valid user and set errors if necessary&nbsp;</div></li><li><div>        $this-&gt;validate_request();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only proceed if no errors have been noted&nbsp;</div></li><li><div>        if( ! $this-&gt;is_valid_request ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! defined( 'EDD_DOING_API' ) ) {&nbsp;</div></li><li><div>            define( 'EDD_DOING_API', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>        $this-&gt;routes = new $this-&gt;versions[ $this-&gt;get_queried_version() ];&nbsp;</div></li><li><div>        $this-&gt;routes-&gt;validate_request();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $this-&gt;endpoint ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'stats' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;routes-&gt;get_stats( array(&nbsp;</div></li><li><div>                    'type' =&gt; isset( $wp_query-&gt;query_vars['type'] )      ? $wp_query-&gt;query_vars['type']      : null, &nbsp;</div></li><li><div>                    'product' =&gt; isset( $wp_query-&gt;query_vars['product'] )   ? $wp_query-&gt;query_vars['product']   : null, &nbsp;</div></li><li><div>                    'date' =&gt; isset( $wp_query-&gt;query_vars['date'] )      ? $wp_query-&gt;query_vars['date']      : null, &nbsp;</div></li><li><div>                    'startdate' =&gt; isset( $wp_query-&gt;query_vars['startdate'] ) ? $wp_query-&gt;query_vars['startdate'] : null, &nbsp;</div></li><li><div>                    'enddate' =&gt; isset( $wp_query-&gt;query_vars['enddate'] )   ? $wp_query-&gt;query_vars['enddate']   : null, &nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'products' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $args = array(&nbsp;</div></li><li><div>                    'product' =&gt; isset( $wp_query-&gt;query_vars['product'] )       ? absint( $wp_query-&gt;query_vars['product'] )                             : null, &nbsp;</div></li><li><div>                    'category' =&gt; isset( $wp_query-&gt;query_vars['category'] )      ? $this-&gt;sanitize_request_term( $wp_query-&gt;query_vars['category'] )      : null, &nbsp;</div></li><li><div>                    'tag' =&gt; isset( $wp_query-&gt;query_vars['tag'] )           ? $this-&gt;sanitize_request_term( $wp_query-&gt;query_vars['tag'] )           : null, &nbsp;</div></li><li><div>                    'term_relation' =&gt; isset( $wp_query-&gt;query_vars['term_relation'] ) ? $this-&gt;sanitize_request_term( $wp_query-&gt;query_vars['term_relation'] ) : null, &nbsp;</div></li><li><div>                    's' =&gt; isset( $wp_query-&gt;query_vars['s'] )             ? sanitize_text_field( $wp_query-&gt;query_vars['s'] )                      : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;routes-&gt;get_products( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'customers' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $args = array(&nbsp;</div></li><li><div>                    'customer' =&gt; isset( $wp_query-&gt;query_vars['customer'] )  ? $wp_query-&gt;query_vars['customer']  : null, &nbsp;</div></li><li><div>                    'date' =&gt; isset( $wp_query-&gt;query_vars['date'] )      ? $wp_query-&gt;query_vars['date']      : null, &nbsp;</div></li><li><div>                    'startdate' =&gt; isset( $wp_query-&gt;query_vars['startdate'] ) ? $wp_query-&gt;query_vars['startdate'] : null, &nbsp;</div></li><li><div>                    'enddate' =&gt; isset( $wp_query-&gt;query_vars['enddate'] )   ? $wp_query-&gt;query_vars['enddate']   : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;routes-&gt;get_customers( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'sales' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;routes-&gt;get_recent_sales();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'discounts' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $discount = isset( $wp_query-&gt;query_vars['discount'] ) ? $wp_query-&gt;query_vars['discount']  : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;routes-&gt;get_discounts( $discount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'file-download-logs' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customer = isset( $wp_query-&gt;query_vars['customer'] ) ? $wp_query-&gt;query_vars['customer']  : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;get_download_logs( $customer );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'info' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;routes-&gt;get_info();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        endswitch;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow extensions to setup their own return data&nbsp;</div></li><li><div>        $this-&gt;data = apply_filters( 'edd_api_output_data', $data, $this-&gt;endpoint, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $after = microtime( true );&nbsp;</div></li><li><div>        $request_time = ( $after - $before );&nbsp;</div></li><li><div>        $this-&gt;data['request_speed'] = $request_time;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log this API request, if enabled. We log it here because we have access to errors.&nbsp;</div></li><li><div>        $this-&gt;log_request( $this-&gt;data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Send out data to the output function&nbsp;</div></li><li><div>        $this-&gt;output();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns the API endpoint requested&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @return string $query Query mode&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_query_mode() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $this-&gt;endpoint;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines the kind of query requested and also ensure it is a valid query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 2.4&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_query_mode() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Whitelist our query options&nbsp;</div></li><li><div>        $accepted = apply_filters( 'edd_api_valid_query_modes', array(&nbsp;</div></li><li><div>            'stats', &nbsp;</div></li><li><div>            'products', &nbsp;</div></li><li><div>            'customers', &nbsp;</div></li><li><div>            'sales', &nbsp;</div></li><li><div>            'discounts', &nbsp;</div></li><li><div>            'file-download-logs', &nbsp;</div></li><li><div>            'info'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = isset( $wp_query-&gt;query_vars['edd-api'] ) ? $wp_query-&gt;query_vars['edd-api'] : null;&nbsp;</div></li><li><div>        $query = str_replace( $this-&gt;queried_version . '/', '', $query );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure our query is valid&nbsp;</div></li><li><div>        if ( ! in_array( $query, $accepted ) ) {&nbsp;</div></li><li><div>            $error['error'] = __( 'Invalid query!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;data = $error;&nbsp;</div></li><li><div>            // 400 is Bad Request&nbsp;</div></li><li><div>            $this-&gt;output( 400 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;endpoint = $query;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get page number&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @return int $wp_query-&gt;query_vars['page'] if page number returned (default: 1)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_paged() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return isset( $wp_query-&gt;query_vars['page'] ) ? $wp_query-&gt;query_vars['page'] : 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Number of results to display per page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @return int $per_page Results to display per page (default: 10)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function per_page() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $per_page = isset( $wp_query-&gt;query_vars['number'] ) ? $wp_query-&gt;query_vars['number'] : 10;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $per_page &lt; 0 && $this-&gt;get_query_mode() == 'customers' ) {&nbsp;</div></li><li><div>            $per_page = 99999999; // Customers query doesn't support -1&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_results_per_page', $per_page );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets up the dates used to retrieve earnings/sales&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5.1&nbsp;</div></li><li><div>     * @param array $args Arguments to override defaults&nbsp;</div></li><li><div>     * @return array $dates&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    public function get_dates( $args = array() ) {&nbsp;</div></li><li><div>        $dates = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'type' =&gt; '', &nbsp;</div></li><li><div>            'product' =&gt; null, &nbsp;</div></li><li><div>            'date' =&gt; null, &nbsp;</div></li><li><div>            'startdate' =&gt; null, &nbsp;</div></li><li><div>            'enddate' =&gt; null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_time = current_time( 'timestamp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'range' === $args['date'] ) {&nbsp;</div></li><li><div>            $startdate = strtotime( $args['startdate'] );&nbsp;</div></li><li><div>            $enddate = strtotime( $args['enddate'] );&nbsp;</div></li><li><div>            $dates['day_start'] = date( 'd', $startdate );&nbsp;</div></li><li><div>            $dates['day_end'] = date( 'd', $enddate );&nbsp;</div></li><li><div>            $dates['m_start'] = date( 'n', $startdate );&nbsp;</div></li><li><div>            $dates['m_end'] = date( 'n', $enddate );&nbsp;</div></li><li><div>            $dates['year'] = date( 'Y', $startdate );&nbsp;</div></li><li><div>            $dates['year_end'] = date( 'Y', $enddate );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Modify dates based on predefined ranges&nbsp;</div></li><li><div>            switch ( $args['date'] ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'this_month' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['m_end'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'last_month' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = date( 'n', $current_time ) == 1 ? 12 : date( 'n', $current_time ) - 1;&nbsp;</div></li><li><div>                    $dates['m_end'] = $dates['m_start'];&nbsp;</div></li><li><div>                    $dates['year'] = date( 'n', $current_time ) == 1 ? date( 'Y', $current_time ) - 1 : date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'today' :&nbsp;</div></li><li><div>                    $dates['day'] = date( 'd', $current_time );&nbsp;</div></li><li><div>                    $dates['m_start'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['m_end'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'yesterday' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $year = date( 'Y', $current_time );&nbsp;</div></li><li><div>                    $month = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $day = date( 'd', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $month == 1 && $day == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $year -= 1;&nbsp;</div></li><li><div>                        $month = 12;&nbsp;</div></li><li><div>                        $day = cal_days_in_month( CAL_GREGORIAN, $month, $year );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } elseif ( $month &gt; 1 && $day == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $month -= 1;&nbsp;</div></li><li><div>                        $day = cal_days_in_month( CAL_GREGORIAN, $month, $year );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $day -= 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $dates['day'] = $day;&nbsp;</div></li><li><div>                    $dates['m_start'] = $month;&nbsp;</div></li><li><div>                    $dates['m_end'] = $month;&nbsp;</div></li><li><div>                    $dates['year'] = $year;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'this_quarter' :&nbsp;</div></li><li><div>                    $month_now = date( 'n', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $month_now &lt;= 3 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 1;&nbsp;</div></li><li><div>                        $dates['m_end'] = 3;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 6 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 4;&nbsp;</div></li><li><div>                        $dates['m_end'] = 6;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 9 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 7;&nbsp;</div></li><li><div>                        $dates['m_end'] = 9;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 10;&nbsp;</div></li><li><div>                        $dates['m_end'] = 12;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'last_quarter' :&nbsp;</div></li><li><div>                    $month_now = date( 'n', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $month_now &lt;= 3 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 10;&nbsp;</div></li><li><div>                        $dates['m_end'] = 12;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time ) - 1; // Previous year&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 6 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 1;&nbsp;</div></li><li><div>                        $dates['m_end'] = 3;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 9 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 4;&nbsp;</div></li><li><div>                        $dates['m_end'] = 6;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 7;&nbsp;</div></li><li><div>                        $dates['m_end'] = 9;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'this_year' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = null;&nbsp;</div></li><li><div>                    $dates['m_end'] = null;&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'last_year' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = null;&nbsp;</div></li><li><div>                    $dates['m_end'] = null;&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time ) - 1;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            endswitch;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Returns the filters for the dates used to retreive earnings/sales&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.5.1&nbsp;</div></li><li><div>         * @param object $dates The dates used for retreiving earnings/sales&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_stat_dates', $dates );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Customers API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     *   Database API&nbsp;</div></li><li><div>     * @param int $customer Customer ID&nbsp;</div></li><li><div>     * @return array $customers Multidimensional array of the customers&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_customers( $customer = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $customer = is_array( $customer ) ? $customer['customer'] : $customer;&nbsp;</div></li><li><div>        $customers = array();&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'view_shop_sensitive_data' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $customers;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $paged = $this-&gt;get_paged();&nbsp;</div></li><li><div>        $per_page = $this-&gt;per_page();&nbsp;</div></li><li><div>        $offset = $per_page * ( $paged - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_numeric( $customer ) ) {&nbsp;</div></li><li><div>            $field = 'id';&nbsp;</div></li><li><div>        } elseif ( is_array( $customer ) ) {&nbsp;</div></li><li><div>            // Checking if search is being done by id, email, user_id fields.&nbsp;</div></li><li><div>            if ( array_key_exists( 'id', $customer ) ) {&nbsp;</div></li><li><div>                $field = 'id';&nbsp;</div></li><li><div>            } elseif ( array_key_exists( 'email', $customer ) ) {&nbsp;</div></li><li><div>                $field = 'email';&nbsp;</div></li><li><div>            } elseif ( array_key_exists( 'user_id', $customer ) ) {&nbsp;</div></li><li><div>                $field = 'user_id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $customer = $customer[ $field ];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $field = 'email';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $customer_query = EDD()-&gt;customers-&gt;get_customers( array( 'number' =&gt; $per_page, 'offset' =&gt; $offset, $field =&gt; $customer ) );&nbsp;</div></li><li><div>        $customer_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $customer_query ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $customer_query as $customer_obj ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $names = explode( ' ', $customer_obj-&gt;name );&nbsp;</div></li><li><div>                $first_name = ! empty( $names[0] ) ? $names[0] : '';&nbsp;</div></li><li><div>                $last_name = '';&nbsp;</div></li><li><div>                if( ! empty( $names[1] ) ) {&nbsp;</div></li><li><div>                    unset( $names[0] );&nbsp;</div></li><li><div>                    $last_name = implode( ' ', $names );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['id'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['user_id'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['username'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['display_name'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['customer_id'] = $customer_obj-&gt;id;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['first_name'] = $first_name;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['last_name'] = $last_name;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['email'] = $customer_obj-&gt;email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $customer_obj-&gt;user_id ) && $customer_obj-&gt;user_id &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $user_data = get_userdata( $customer_obj-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Customer with registered account&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // id is going to get deprecated in the future, user user_id or customer_id instead&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['id'] = $customer_obj-&gt;user_id;&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['user_id'] = $customer_obj-&gt;user_id;&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['username'] = $user_data-&gt;user_login;&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['display_name'] = $user_data-&gt;display_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['stats']['total_purchases'] = $customer_obj-&gt;purchase_count;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['stats']['total_spent'] = $customer_obj-&gt;purchase_value;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['stats']['total_downloads'] = edd_count_file_downloads_of_user( $customer_obj-&gt;email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customer_count++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif( $customer ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $error['error'] = sprintf( __( 'Customer %s not found!', 'easy-digital-downloads' ), $customer );&nbsp;</div></li><li><div>            return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $error['error'] = __( 'No customers found!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>            return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_customers', $customers, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Products API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @param int $product Product (Download) ID&nbsp;</div></li><li><div>     * @return array $customers Multidimensional array of the products&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products( $args = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $args['product'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $products['products'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $parameters = array(&nbsp;</div></li><li><div>                'post_type' =&gt; 'download', &nbsp;</div></li><li><div>                'posts_per_page' =&gt; $this-&gt;per_page(), &nbsp;</div></li><li><div>                'suppress_filters' =&gt; true, &nbsp;</div></li><li><div>                'paged' =&gt; $this-&gt;get_paged(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $args['s'] ) && !empty( $args['s'] ) ) {&nbsp;</div></li><li><div>                $parameters['s'] = $args['s'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_list = get_posts( $parameters );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product_list ) {&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $product_list as $product_info ) {&nbsp;</div></li><li><div>                    $products['products'][$i] = $this-&gt;get_product_data( $product_info );&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( get_post_type( $args['product'] ) == 'download' ) {&nbsp;</div></li><li><div>                $product_info = get_post( $args['product'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $products['products'][0] = $this-&gt;get_product_data( $product_info );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $error['error'] = sprintf( __( 'Product %s not found!', 'easy-digital-downloads' ), $args['product'] );&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_products', $products, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Given a download post object, generate the data for the API output&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.3.9&nbsp;</div></li><li><div>     * @param  object $product_info The Download Post Object&nbsp;</div></li><li><div>     * @return array                Array of post data to return back in the API&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_product_data( $product_info ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product['info']['id'] = $product_info-&gt;ID;&nbsp;</div></li><li><div>        $product['info']['slug'] = $product_info-&gt;post_name;&nbsp;</div></li><li><div>        $product['info']['title'] = $product_info-&gt;post_title;&nbsp;</div></li><li><div>        $product['info']['create_date'] = $product_info-&gt;post_date;&nbsp;</div></li><li><div>        $product['info']['modified_date'] = $product_info-&gt;post_modified;&nbsp;</div></li><li><div>        $product['info']['status'] = $product_info-&gt;post_status;&nbsp;</div></li><li><div>        $product['info']['link'] = html_entity_decode( $product_info-&gt;guid );&nbsp;</div></li><li><div>        $product['info']['content'] = $product_info-&gt;post_content;&nbsp;</div></li><li><div>        $product['info']['excerpt'] = $product_info-&gt;post_excerpt;&nbsp;</div></li><li><div>        $product['info']['thumbnail'] = wp_get_attachment_url( get_post_thumbnail_id( $product_info-&gt;ID ) );&nbsp;</div></li><li><div>        $product['info']['category'] = get_the_terms( $product_info, 'download_category' );&nbsp;</div></li><li><div>        $product['info']['tags'] = get_the_terms( $product_info, 'download_tag' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( user_can( $this-&gt;user_id, 'view_shop_reports' ) || $this-&gt;override ) {&nbsp;</div></li><li><div>            $product['stats']['total']['sales'] = edd_get_download_sales_stats( $product_info-&gt;ID );&nbsp;</div></li><li><div>            $product['stats']['total']['earnings'] = edd_get_download_earnings_stats( $product_info-&gt;ID );&nbsp;</div></li><li><div>            $product['stats']['monthly_average']['sales'] = edd_get_average_monthly_download_sales( $product_info-&gt;ID );&nbsp;</div></li><li><div>            $product['stats']['monthly_average']['earnings'] = edd_get_average_monthly_download_earnings( $product_info-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( edd_has_variable_prices( $product_info-&gt;ID ) ) {&nbsp;</div></li><li><div>            foreach ( edd_get_variable_prices( $product_info-&gt;ID ) as $price ) {&nbsp;</div></li><li><div>                $product['pricing'][ sanitize_key( $price['name'] ) ] = $price['amount'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product['pricing']['amount'] = edd_get_download_price( $product_info-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( user_can( $this-&gt;user_id, 'view_shop_sensitive_data' ) || $this-&gt;override ) {&nbsp;</div></li><li><div>            foreach ( edd_get_download_files( $product_info-&gt;ID ) as $file ) {&nbsp;</div></li><li><div>                $product['files'][] = $file;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product['notes'] = edd_get_product_notes( $product_info-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_products_product', $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Stats API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $args Arguments provided by API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_stats( $args = array() ) {&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'type' =&gt; null, &nbsp;</div></li><li><div>            'product' =&gt; null, &nbsp;</div></li><li><div>            'date' =&gt; null, &nbsp;</div></li><li><div>            'startdate' =&gt; null, &nbsp;</div></li><li><div>            'enddate' =&gt; null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $dates = $this-&gt;get_dates( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stats = array();&nbsp;</div></li><li><div>        $earnings = array(&nbsp;</div></li><li><div>            'earnings' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $sales = array(&nbsp;</div></li><li><div>            'sales' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'view_shop_reports' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $stats;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $args['type'] == 'sales' ) {&nbsp;</div></li><li><div>            if ( $args['product'] == null ) {&nbsp;</div></li><li><div>                if ( $args['date'] == null ) {&nbsp;</div></li><li><div>                    $sales = $this-&gt;get_default_sales_stats();&nbsp;</div></li><li><div>                } elseif( $args['date'] === 'range' ) {&nbsp;</div></li><li><div>                    // Return sales for a date range&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure the end date is later than the start date&nbsp;</div></li><li><div>                    if( $args['enddate'] &lt; $args['startdate'] ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'The end date must be later than the start date!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure both the start and end date are specified&nbsp;</div></li><li><div>                    if ( empty( $args['startdate'] ) || empty( $args['enddate'] ) ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'Invalid or no date range specified!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $start_date = $dates['year'] . '-' . $dates['m_start'] . '-' . $dates['day_start'];&nbsp;</div></li><li><div>                    $end_date = $dates['year_end'] . '-' . $dates['m_end'] . '-' . $dates['day_end'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $stats = EDD()-&gt;payment_stats-&gt;get_sales_by_range( 'other', true, $start_date, $end_date );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $stats as $sale ) {&nbsp;</div></li><li><div>                        $key = $sale['y'] . $sale['m'] . $sale['d'];&nbsp;</div></li><li><div>                        $sales['sales'][ $key ] = (int) $sale['count'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $start_date = date( 'Y-m-d', strtotime( $start_date ) );&nbsp;</div></li><li><div>                    $end_date = date( 'Y-m-d', strtotime( $end_date ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    while ( strtotime( $start_date ) &lt;= strtotime( $end_date ) ) {&nbsp;</div></li><li><div>                        $d = date( 'd', strtotime( $start_date ) );&nbsp;</div></li><li><div>                        $m = date( 'm', strtotime( $start_date ) );&nbsp;</div></li><li><div>                        $y = date( 'Y', strtotime( $start_date ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $key = $y . $m . $d;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! isset( $sales['sales'][ $key ] ) ) {&nbsp;</div></li><li><div>                            $sales['sales'][ $key ] = 0;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $start_date = date( 'Y-m-d', strtotime( '+1 day', strtotime( $start_date ) ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    ksort( $sales['sales'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sales['totals'] = array_sum( $sales['sales'] );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if( $args['date'] == 'this_quarter' || $args['date'] == 'last_quarter' ) {&nbsp;</div></li><li><div>                        $start_date = $dates['year'] . '-' . $dates['m_start'] . '-01';&nbsp;</div></li><li><div>                        $end_date = $dates['year'] . '-' . $dates['m_end'] . '-' . cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $start_date = date( 'Y-m-d', strtotime( $start_date ) );&nbsp;</div></li><li><div>                        $end_date = date( 'Y-m-d', strtotime( $end_date ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $stats = EDD()-&gt;payment_stats-&gt;get_sales_by_range( $args['date'], false, $start_date, $end_date );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( empty( $stats ) ) {&nbsp;</div></li><li><div>                            $sales['sales'][ $args['date'] ] = 0;&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $sales['sales'][ $args['date'] ] = $stats[0]['count'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $start_date = $dates['year'] . '-' . $dates['m_start'] . '-' . $dates['day'];&nbsp;</div></li><li><div>                        $start_date = date( 'Y-m-d', strtotime( $start_date ) );&nbsp;</div></li><li><div>                        $end_date = date( 'Y-m-d', strtotime( '+1 day', strtotime( $start_date ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $stats = EDD()-&gt;payment_stats-&gt;get_sales_by_range( 'yesterday', true, $start_date, $end_date );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( empty( $stats ) ) {&nbsp;</div></li><li><div>                            $sales['sales'][ $args['date'] ] = 0;&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $sales['sales'][ $args['date'] ] = (int) $stats[0]['count'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( $args['product'] == 'all' ) {&nbsp;</div></li><li><div>                $products = get_posts( array( 'post_type' =&gt; 'download', 'nopaging' =&gt; true ) );&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $products as $product_info ) {&nbsp;</div></li><li><div>                    $sales['sales'][$i] = array( $product_info-&gt;post_name =&gt; edd_get_download_sales_stats( $product_info-&gt;ID ) );&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( get_post_type( $args['product'] ) == 'download' ) {&nbsp;</div></li><li><div>                    $product_info = get_post( $args['product'] );&nbsp;</div></li><li><div>                    $sales['sales'][0] = array( $product_info-&gt;post_name =&gt; edd_get_download_sales_stats( $args['product'] ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $error['error'] = sprintf( __( 'Product %s not found!', 'easy-digital-downloads' ), $args['product'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $error ) )&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return apply_filters( 'edd_api_stats_sales', $sales, $this );&nbsp;</div></li><li><div>        } elseif ( $args['type'] == 'earnings' ) {&nbsp;</div></li><li><div>            if ( $args['product'] == null ) {&nbsp;</div></li><li><div>                if ( $args['date'] == null ) {&nbsp;</div></li><li><div>                    $earnings = $this-&gt;get_default_earnings_stats();&nbsp;</div></li><li><div>                } elseif ( $args['date'] === 'range' ) {&nbsp;</div></li><li><div>                    // Return sales for a date range&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure the end date is later than the start date&nbsp;</div></li><li><div>                    if ( $args['enddate'] &lt; $args['startdate'] ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'The end date must be later than the start date!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure both the start and end date are specified&nbsp;</div></li><li><div>                    if ( empty( $args['startdate'] ) || empty( $args['enddate'] ) ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'Invalid or no date range specified!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $total = (float) 0.00;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Loop through the years&nbsp;</div></li><li><div>                    if ( ! isset( $earnings['earnings'] ) ) {&nbsp;</div></li><li><div>                        $earnings['earnings'] = array();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( cal_days_in_month( CAL_GREGORIAN, $dates['m_start'], $dates['year'] ) &lt; $dates['day_start'] ) {&nbsp;</div></li><li><div>                        $next_day = mktime( 0, 0, 0, $dates['m_start'] + 1, 1, $dates['year'] );&nbsp;</div></li><li><div>                        $day = date( 'd', $next_day );&nbsp;</div></li><li><div>                        $month = date( 'm', $next_day );&nbsp;</div></li><li><div>                        $year = date( 'Y', $next_day );&nbsp;</div></li><li><div>                        $date_start = $year . '-' . $month . '-' . $day;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $date_start = $dates['year'] . '-' . $dates['m_start'] . '-' . $dates['day_start'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] ) &lt; $dates['day_end'] ) {&nbsp;</div></li><li><div>                        $date_end = $dates['year_end'] . '-' . $dates['m_end'] . '-' . cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $date_end = $dates['year_end'] . '-' . $dates['m_end'] . '-' . $dates['day_end'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $earnings = EDD()-&gt;payment_stats-&gt;get_earnings_by_range( 'other', true, $date_start, $date_end );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    foreach ( $earnings as $earning ) {&nbsp;</div></li><li><div>                        $temp_data['earnings'][ $earning['y'] . $earning['m'] . $earning['d'] ] = (float) $earning['total'];&nbsp;</div></li><li><div>                        $total += (float) $earning['total'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $date_start = date( 'Y-m-d', strtotime( $date_start ) );&nbsp;</div></li><li><div>                    $date_end = date( 'Y-m-d', strtotime( $date_end ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    while ( strtotime( $date_start ) &lt;= strtotime( $date_end ) ) {&nbsp;</div></li><li><div>                        $d = date( 'd', strtotime( $date_start ) );&nbsp;</div></li><li><div>                        $m = date( 'm', strtotime( $date_start ) );&nbsp;</div></li><li><div>                        $y = date( 'Y', strtotime( $date_start ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $key = $y . $m . $d;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( ! isset( $temp_data['earnings'][ $key ] ) ) {&nbsp;</div></li><li><div>                            $temp_data['earnings'][ $key ] = 0;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $date_start = date( 'Y-m-d', strtotime( '+1 day', strtotime( $date_start ) ) );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    ksort($temp_data['earnings']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $earnings = $temp_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $earnings['totals'] = $total;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( $args['date'] == 'this_quarter' || $args['date'] == 'last_quarter' ) {&nbsp;</div></li><li><div>                        $current_time = current_time( 'timestamp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( 'this_quarter' == $args['date'] ) {&nbsp;</div></li><li><div>                            $month_now = date( 'n', $current_time );&nbsp;</div></li><li><div>                            $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                            $dates['year_end'] = $dates['year'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( $month_now &lt;= 3 ) {&nbsp;</div></li><li><div>                                $dates['m_start'] = 1;&nbsp;</div></li><li><div>                                $dates['m_end'] = 3;&nbsp;</div></li><li><div>                            } else if ( $month_now &lt;= 6 ) {&nbsp;</div></li><li><div>                                $dates['m_start'] = 4;&nbsp;</div></li><li><div>                                $dates['m_end'] = 6;&nbsp;</div></li><li><div>                            } else if ( $month_now &lt;= 9 ) {&nbsp;</div></li><li><div>                                $dates['m_start'] = 7;&nbsp;</div></li><li><div>                                $dates['m_end'] = 9;&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $dates['m_start'] = 10;&nbsp;</div></li><li><div>                                $dates['m_end'] = 12;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $dates['day_end'] = cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $month_now = date( 'n' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if ( $month_now &lt;= 3 ) {&nbsp;</div></li><li><div>                                $dates['m_start'] = 10;&nbsp;</div></li><li><div>                                $dates['m_end'] = 12;&nbsp;</div></li><li><div>                                $dates['year'] = date( 'Y', $current_time ) - 1; // Previous year&nbsp;</div></li><li><div>                            } else if ( $month_now &lt;= 6 ) {&nbsp;</div></li><li><div>                                $dates['m_start'] = 1;&nbsp;</div></li><li><div>                                $dates['m_end'] = 3;&nbsp;</div></li><li><div>                                $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                            } else if ( $month_now &lt;= 9 ) {&nbsp;</div></li><li><div>                                $dates['m_start'] = 4;&nbsp;</div></li><li><div>                                $dates['m_end'] = 6;&nbsp;</div></li><li><div>                                $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $dates['m_start'] = 7;&nbsp;</div></li><li><div>                                $dates['m_end'] = 9;&nbsp;</div></li><li><div>                                $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $dates['day_end'] = cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] );&nbsp;</div></li><li><div>                            $dates['year_end'] = $dates['year'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['day_start'] = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( cal_days_in_month( CAL_GREGORIAN, $dates['m_start'], $dates['year'] ) &lt; $dates['day_start'] ) {&nbsp;</div></li><li><div>                            $next_day = mktime( 0, 0, 0, $dates['m_start'] + 1, 1, $dates['year'] );&nbsp;</div></li><li><div>                            $day = date( 'd', $next_day );&nbsp;</div></li><li><div>                            $month = date( 'm', $next_day );&nbsp;</div></li><li><div>                            $year = date( 'Y', $next_day );&nbsp;</div></li><li><div>                            $date_start = $year . '-' . $month . '-' . $day;&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $date_start = $dates['year'] . '-' . $dates['m_start'] . '-' . $dates['day_start'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] ) &lt; $dates['day_end'] ) {&nbsp;</div></li><li><div>                            $date_end = $dates['year_end'] . '-' . $dates['m_end'] . '-' . cal_days_in_month( CAL_GREGORIAN, $dates['m_end'], $dates['year'] );&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $date_end = $dates['year_end'] . '-' . $dates['m_end'] . '-' . $dates['day_end'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $results = EDD()-&gt;payment_stats-&gt;get_earnings_by_range( $args['date'], false, $date_start, $date_end );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $total = (float) 0.00;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        foreach ( $results as $result ) {&nbsp;</div></li><li><div>                            $total += (float) $result['total'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $earnings['earnings'][ $args['date'] ] = (float) $total;&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $date_start = $dates['year'] . '-' . $dates['m_start'] . '-' . $dates['day'];&nbsp;</div></li><li><div>                        $date_end = date( 'Y-m-d', strtotime( '+1 day', strtotime( $date_start ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $results = EDD()-&gt;payment_stats-&gt;get_earnings_by_range( $args['date'], false, $date_start, $date_end );&nbsp;</div></li><li><div>                        if ($args['date'] == 'yesterday' || $args['date'] == 'today') {&nbsp;</div></li><li><div>                            foreach ($results as $result) {&nbsp;</div></li><li><div>                                $earnings['earnings'][ $args['date'] ] += $result['total'];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $earnings['earnings'][ $args['date'] ] = $results[0]['total'];&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( $args['product'] == 'all' ) {&nbsp;</div></li><li><div>                $products = get_posts( array( 'post_type' =&gt; 'download', 'nopaging' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $products as $product_info ) {&nbsp;</div></li><li><div>                    $earnings['earnings'][ $i ] = array( $product_info-&gt;post_name =&gt; edd_get_download_earnings_stats( $product_info-&gt;ID ) );&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( get_post_type( $args['product'] ) == 'download' ) {&nbsp;</div></li><li><div>                    $product_info = get_post( $args['product'] );&nbsp;</div></li><li><div>                    $earnings['earnings'][0] = array( $product_info-&gt;post_name =&gt; edd_get_download_earnings_stats( $args['product'] ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $error['error'] = sprintf( __( 'Product %s not found!', 'easy-digital-downloads' ), $args['product'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $error ) )&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return apply_filters( 'edd_api_stats_earnings', $earnings, $this );&nbsp;</div></li><li><div>        } elseif ( $args['type'] == 'customers' ) {&nbsp;</div></li><li><div>            if ( version_compare( $edd_version, '2.3', '&lt;' ) || ! edd_has_upgrade_completed( 'upgrade_customer_payments_association' ) ) {&nbsp;</div></li><li><div>                global $wpdb;&nbsp;</div></li><li><div>                $stats = array();&nbsp;</div></li><li><div>                $count = $wpdb-&gt;get_col( &quot;SELECT COUNT(DISTINCT meta_value) FROM $wpdb-&gt;postmeta WHERE meta_key = '_edd_payment_user_email'&quot; );&nbsp;</div></li><li><div>                $stats['customers']['total_customers'] = $count[0];&nbsp;</div></li><li><div>                return apply_filters( 'edd_api_stats_customers', $stats, $this );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $customers = new EDD_DB_Customers();&nbsp;</div></li><li><div>                $stats['customers']['total_customers'] = $customers-&gt;count();&nbsp;</div></li><li><div>                return apply_filters( 'edd_api_stats_customers', $stats, $this );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } elseif ( empty( $args['type'] ) ) {&nbsp;</div></li><li><div>            $stats = array_merge( $stats, $this-&gt;get_default_sales_stats() );&nbsp;</div></li><li><div>            $stats = array_merge ( $stats, $this-&gt;get_default_earnings_stats() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return apply_filters( 'edd_api_stats', array( 'stats' =&gt; $stats, $this ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves Recent Sales&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since  1.5&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_recent_sales() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sales = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'view_shop_reports' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $sales;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( isset( $wp_query-&gt;query_vars['id'] ) ) {&nbsp;</div></li><li><div>            $query = array();&nbsp;</div></li><li><div>            $query[] = new EDD_Payment( $wp_query-&gt;query_vars['id'] );&nbsp;</div></li><li><div>        } elseif( isset( $wp_query-&gt;query_vars['purchasekey'] ) ) {&nbsp;</div></li><li><div>            $query = array();&nbsp;</div></li><li><div>            $query[] = edd_get_payment_by( 'key', $wp_query-&gt;query_vars['purchasekey'] );&nbsp;</div></li><li><div>        } elseif( isset( $wp_query-&gt;query_vars['email'] ) ) {&nbsp;</div></li><li><div>            $query = edd_get_payments( array( 'fields' =&gt; 'ids', 'meta_key' =&gt; '_edd_payment_user_email', 'meta_value' =&gt; $wp_query-&gt;query_vars['email'], 'number' =&gt; $this-&gt;per_page(), 'page' =&gt; $this-&gt;get_paged(), 'status' =&gt; 'publish' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $query = edd_get_payments( array( 'fields' =&gt; 'ids', 'number' =&gt; $this-&gt;per_page(), 'page' =&gt; $this-&gt;get_paged(), 'status' =&gt; 'publish' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query ) {&nbsp;</div></li><li><div>            $i = 0;&nbsp;</div></li><li><div>            foreach ( $query as $payment ) {&nbsp;</div></li><li><div>                if ( is_numeric( $payment ) ) {&nbsp;</div></li><li><div>                    $payment = new EDD_Payment( $payment );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $payment_meta = $payment-&gt;get_meta();&nbsp;</div></li><li><div>                $user_info = $payment-&gt;user_info;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['ID'] = $payment-&gt;number;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['transaction_id'] = $payment-&gt;transaction_id;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['key'] = $payment-&gt;key;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['discount'] = ! empty( $payment-&gt;discounts ) ? explode( ', ', $payment-&gt;discounts ) : array();&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['subtotal'] = $payment-&gt;subtotal;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['tax'] = $payment-&gt;tax;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['fees'] = $payment-&gt;fees;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['total'] = $payment-&gt;total;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['gateway'] = $payment-&gt;gateway;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['email'] = $payment-&gt;email;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['user_id'] = $payment-&gt;user_id;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['customer_id'] = $payment-&gt;customer_id;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['date'] = $payment-&gt;date;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['products'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $c = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $payment-&gt;cart_details as $key =&gt; $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $item_id = isset( $item['id'] ) ? $item['id']    : $item;&nbsp;</div></li><li><div>                    $price = isset( $item['price'] ) ? $item['price'] : false;&nbsp;</div></li><li><div>                    $price_id = isset( $item['item_number']['options']['price_id'] ) ? $item['item_number']['options']['price_id'] : null;&nbsp;</div></li><li><div>                    $quantity = isset( $item['quantity'] ) && $item['quantity'] &gt; 0 ? $item['quantity'] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if( ! $price ) {&nbsp;</div></li><li><div>                        // This function is only used on payments with near 1.0 cart data structure&nbsp;</div></li><li><div>                        $price = edd_get_download_final_price( $item_id, $user_info, null );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $price_name = '';&nbsp;</div></li><li><div>                    if ( isset( $item['item_number'] ) && isset( $item['item_number']['options'] ) ) {&nbsp;</div></li><li><div>                        $price_options = $item['item_number']['options'];&nbsp;</div></li><li><div>                        if ( isset( $price_options['price_id'] ) ) {&nbsp;</div></li><li><div>                            $price_name = edd_get_price_option_name( $item_id, $price_options['price_id'], $payment-&gt;ID );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['id'] = $item_id;&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['quantity'] = $quantity;&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['name'] = get_the_title( $item_id );&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['price'] = $price;&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['price_name'] = $price_name;&nbsp;</div></li><li><div>                    $c++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_sales', $sales, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Discounts API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.6&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     *   Database API&nbsp;</div></li><li><div>     * @param int $discount Discount ID&nbsp;</div></li><li><div>     * @return array $discounts Multidimensional array of the discounts&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_discounts( $discount = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $discount_list = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'manage_shop_discounts' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $discount_list;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $discount ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $paged = $this-&gt;get_paged();&nbsp;</div></li><li><div>            $per_page = $this-&gt;per_page();&nbsp;</div></li><li><div>            $discounts = edd_get_discounts( array( 'posts_per_page' =&gt; $per_page, 'paged' =&gt; $paged ) );&nbsp;</div></li><li><div>            $count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $discounts ) ) {&nbsp;</div></li><li><div>                $error['error'] = __( 'No discounts found!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $discounts as $discount ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['ID'] = $discount-&gt;ID;&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['name'] = $discount-&gt;post_title;&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['code'] = edd_get_discount_code( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['amount'] = edd_get_discount_amount( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['min_price'] = edd_get_discount_min_price( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['type'] = edd_get_discount_type( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['uses'] = edd_get_discount_uses( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['max_uses'] = edd_get_discount_max_uses( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['start_date'] = edd_get_discount_start_date( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['exp_date'] = edd_get_discount_expiration( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['status'] = $discount-&gt;post_status;&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['product_requirements'] = edd_get_discount_product_reqs( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['requirement_condition'] = edd_get_discount_product_condition( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['global_discount'] = edd_is_discount_not_global( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['single_use'] = edd_discount_is_single_use( $discount-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $count++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_numeric( $discount ) && get_post( $discount ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['ID'] = $discount;&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['name'] = get_post_field( 'post_title', $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['code'] = edd_get_discount_code( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['amount'] = edd_get_discount_amount( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['min_price'] = edd_get_discount_min_price( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['type'] = edd_get_discount_type( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['uses'] = edd_get_discount_uses( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['max_uses'] = edd_get_discount_max_uses( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['start_date'] = edd_get_discount_start_date( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['exp_date'] = edd_get_discount_expiration( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['status'] = get_post_field( 'post_status', $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['product_requirements'] = edd_get_discount_product_reqs( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['requirement_condition'] = edd_get_discount_product_condition( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['global_discount'] = edd_is_discount_not_global( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['single_use'] = edd_discount_is_single_use( $discount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $error['error'] = sprintf( __( 'Discount %s not found!', 'easy-digital-downloads' ), $discount );&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_discounts', $discount_list, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Downloads API Request to retrieve download logs&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.5&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param  int $customer_id The customer ID you wish to retrieve download logs for&nbsp;</div></li><li><div>     * @return array            Multidimensional array of the download logs&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_download_logs( $customer_id = 0 ) {&nbsp;</div></li><li><div>        global $edd_logs;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $downloads = array();&nbsp;</div></li><li><div>        $errors = array();&nbsp;</div></li><li><div>        $invalid_customer = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $paged = $this-&gt;get_paged();&nbsp;</div></li><li><div>        $per_page = $this-&gt;per_page();&nbsp;</div></li><li><div>        $offset = $per_page * ( $paged - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $meta_query = array();&nbsp;</div></li><li><div>        if ( ! empty( $customer_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $customer = new EDD_Customer( $customer_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $customer-&gt;id &gt; 0 ) {&nbsp;</div></li><li><div>                $meta_query['relation'] = 'OR';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $customer-&gt;id &gt; 0 ) {&nbsp;</div></li><li><div>                    // Based on customer-&gt;user_id&nbsp;</div></li><li><div>                    $meta_query[] = array(&nbsp;</div></li><li><div>                        'key' =&gt; '_edd_log_user_id', &nbsp;</div></li><li><div>                        'value' =&gt; $customer-&gt;user_id, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Based on customer-&gt;email&nbsp;</div></li><li><div>                $meta_query[] = array(&nbsp;</div></li><li><div>                    'key' =&gt; '_edd_log_user_info', &nbsp;</div></li><li><div>                    'value' =&gt; $customer-&gt;email, &nbsp;</div></li><li><div>                    'compare'=&gt; 'LIKE', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $invalid_customer = true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = array(&nbsp;</div></li><li><div>            'log_type' =&gt; 'file_download', &nbsp;</div></li><li><div>            'paged' =&gt; $paged, &nbsp;</div></li><li><div>            'meta_query' =&gt; $meta_query, &nbsp;</div></li><li><div>            'posts_per_page' =&gt; $per_page, &nbsp;</div></li><li><div>            'update_post_meta_cache' =&gt; false, &nbsp;</div></li><li><div>            'update_post_term_cache' =&gt; false, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $logs = array();&nbsp;</div></li><li><div>        if ( ! $invalid_customer ) {&nbsp;</div></li><li><div>            $logs = $edd_logs-&gt;get_connected_logs( $query );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $logs ) ) {&nbsp;</div></li><li><div>            $error['error'] = __( 'No download logs found!', 'easy-digital-downloads' );&nbsp;</div></li><li><div>            return $error;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach( $logs as $log ) {&nbsp;</div></li><li><div>            $item = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $log_meta = get_post_custom( $log-&gt;ID );&nbsp;</div></li><li><div>            $user_info = isset( $log_meta['_edd_log_user_info'] ) ? maybe_unserialize( $log_meta['_edd_log_user_info'][0] ) : array();&nbsp;</div></li><li><div>            $payment_id = isset( $log_meta['_edd_log_payment_id'] ) ? $log_meta['_edd_log_payment_id'][0] : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $payment_customer_id = edd_get_payment_customer_id( $payment_id );&nbsp;</div></li><li><div>            $payment_customer = new EDD_Customer( $payment_customer_id );&nbsp;</div></li><li><div>            $user_id = ( $payment_customer-&gt;user_id &gt; 0 ) ? $payment_customer-&gt;user_id : false;&nbsp;</div></li><li><div>            $ip = $log_meta['_edd_log_ip'][0];&nbsp;</div></li><li><div>            $files = edd_get_payment_meta_downloads( $payment_id );&nbsp;</div></li><li><div>            $files = edd_get_download_files( $files[0]['id'] );&nbsp;</div></li><li><div>            $file_id = (int) $log_meta['_edd_log_file_id'][0];&nbsp;</div></li><li><div>            $file_id = $file_id !== false ? $file_id : 0;&nbsp;</div></li><li><div>            $file_name = isset( $files[ $file_id ]['name'] ) ? $files[ $file_id ]['name'] : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = array(&nbsp;</div></li><li><div>                'ID' =&gt; $log-&gt;ID, &nbsp;</div></li><li><div>                'user_id' =&gt; $user_id, &nbsp;</div></li><li><div>                'product_id' =&gt; $log-&gt;post_parent, &nbsp;</div></li><li><div>                'product_name' =&gt; get_the_title( $log-&gt;post_parent ), &nbsp;</div></li><li><div>                'customer_id' =&gt; $payment_customer_id, &nbsp;</div></li><li><div>                'payment_id' =&gt; $payment_id, &nbsp;</div></li><li><div>                'file' =&gt; $file_name, &nbsp;</div></li><li><div>                'ip' =&gt; $ip, &nbsp;</div></li><li><div>                'date' =&gt; $log-&gt;post_date, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $item = apply_filters( 'edd_api_download_log_item', $item, $log, $log_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $downloads['download_logs'][] = $item;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_download_logs', $downloads, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Info API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $args Arguments provided by API Request&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_info() {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // plugin.php required to use is_plugin_active()&nbsp;</div></li><li><div>        require_once ABSPATH . 'wp-admin/includes/plugin.php';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Integrations&nbsp;</div></li><li><div>        if ( is_plugin_active( 'edd-commissions/edd-commissions.php' ) ) {&nbsp;</div></li><li><div>            $data['info']['integrations']['commissions'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( class_exists( 'EDD_Software_Licensing' ) ) {&nbsp;</div></li><li><div>            $data['info']['integrations']['software_licensing'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( class_exists( 'EDD_Front_End_Submissions' ) ) {&nbsp;</div></li><li><div>            $data['info']['integrations']['fes'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( class_exists( 'EDD_Reviews' ) ) {&nbsp;</div></li><li><div>            $data['info']['integrations']['reviews'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( class_exists( 'EDD_Recurring' ) ) {&nbsp;</div></li><li><div>            $data['info']['integrations']['recurring'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Permissions&nbsp;</div></li><li><div>        if ( user_can( $this-&gt;user_id, 'view_shop_reports' ) ) {&nbsp;</div></li><li><div>            $data['info']['permissions']['view_shop_reports'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( user_can( $this-&gt;user_id, 'view_shop_sensitive_data' ) ) {&nbsp;</div></li><li><div>            $data['info']['permissions']['view_shop_sensitive_data'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( user_can( $this-&gt;user_id, 'manage_shop_discounts' ) ) {&nbsp;</div></li><li><div>            $data['info']['permissions']['manage_shop_discounts'] = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Site Information&nbsp;</div></li><li><div>        if ( user_can( $this-&gt;user_id, 'view_shop_sensitive_data' ) ) {&nbsp;</div></li><li><div>            $data['info']['site']['wp_version'] = get_bloginfo( 'version' );&nbsp;</div></li><li><div>            $data['info']['site']['edd_version'] = EDD_VERSION;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data['info']['site']['currency'] = edd_get_currency();&nbsp;</div></li><li><div>        $data['info']['site']['currency_position'] = edd_get_option( 'currency_position', 'before' );&nbsp;</div></li><li><div>        $data['info']['site']['decimal_separator'] = edd_get_option( 'decimal_separator', '.' );&nbsp;</div></li><li><div>        $data['info']['site']['thousands_separator'] = edd_get_option( 'thousands_separator', ', ' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_info', $data, $this );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the output format&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Determines whether results should be displayed in XML or JSON&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_output_format() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = isset( $wp_query-&gt;query_vars['format'] ) ? $wp_query-&gt;query_vars['format'] : 'json';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_output_format', $format );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Log each API request, if enabled&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since  1.5&nbsp;</div></li><li><div>     * @global $edd_logs&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function log_request( $data = array() ) {&nbsp;</div></li><li><div>        if ( ! $this-&gt;log_requests() ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $edd_logs, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = array(&nbsp;</div></li><li><div>            'edd-api' =&gt; $wp_query-&gt;query_vars['edd-api'], &nbsp;</div></li><li><div>            'key' =&gt; isset( $wp_query-&gt;query_vars['key'] )         ? $wp_query-&gt;query_vars['key']         : null, &nbsp;</div></li><li><div>            'token' =&gt; isset( $wp_query-&gt;query_vars['token'] )       ? $wp_query-&gt;query_vars['token']       : null, &nbsp;</div></li><li><div>            'query' =&gt; isset( $wp_query-&gt;query_vars['query'] )       ? $wp_query-&gt;query_vars['query']       : null, &nbsp;</div></li><li><div>            'type' =&gt; isset( $wp_query-&gt;query_vars['type'] )        ? $wp_query-&gt;query_vars['type']        : null, &nbsp;</div></li><li><div>            'product' =&gt; isset( $wp_query-&gt;query_vars['product'] )     ? $wp_query-&gt;query_vars['product']     : null, &nbsp;</div></li><li><div>            'customer' =&gt; isset( $wp_query-&gt;query_vars['customer'] )    ? $wp_query-&gt;query_vars['customer']    : null, &nbsp;</div></li><li><div>            'date' =&gt; isset( $wp_query-&gt;query_vars['date'] )        ? $wp_query-&gt;query_vars['date']        : null, &nbsp;</div></li><li><div>            'startdate' =&gt; isset( $wp_query-&gt;query_vars['startdate'] )   ? $wp_query-&gt;query_vars['startdate']   : null, &nbsp;</div></li><li><div>            'enddate' =&gt; isset( $wp_query-&gt;query_vars['enddate'] )     ? $wp_query-&gt;query_vars['enddate']     : null, &nbsp;</div></li><li><div>            'id' =&gt; isset( $wp_query-&gt;query_vars['id'] )          ? $wp_query-&gt;query_vars['id']          : null, &nbsp;</div></li><li><div>            'purchasekey' =&gt; isset( $wp_query-&gt;query_vars['purchasekey'] ) ? $wp_query-&gt;query_vars['purchasekey'] : null, &nbsp;</div></li><li><div>            'email' =&gt; isset( $wp_query-&gt;query_vars['email'] )       ? $wp_query-&gt;query_vars['email']       : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $log_data = array(&nbsp;</div></li><li><div>            'log_type' =&gt; 'api_request', &nbsp;</div></li><li><div>            'post_excerpt' =&gt; http_build_query( $query ), &nbsp;</div></li><li><div>            'post_content' =&gt; ! empty( $data['error'] ) ? $data['error'] : '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $log_meta = array(&nbsp;</div></li><li><div>            'request_ip' =&gt; edd_get_ip(), &nbsp;</div></li><li><div>            'user' =&gt; $this-&gt;user_id, &nbsp;</div></li><li><div>            'key' =&gt; isset( $wp_query-&gt;query_vars['key'] ) ? $wp_query-&gt;query_vars['key'] : null, &nbsp;</div></li><li><div>            'token' =&gt; isset( $wp_query-&gt;query_vars['token'] ) ? $wp_query-&gt;query_vars['token'] : null, &nbsp;</div></li><li><div>            'time' =&gt; $data['request_speed'], &nbsp;</div></li><li><div>            'version' =&gt; $this-&gt;get_queried_version()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $edd_logs-&gt;insert_log( $log_data, $log_meta );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the output data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5.2&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_output() {&nbsp;</div></li><li><div>        return $this-&gt;data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Output Query in either JSON/XML. The query data is outputted as JSON&nbsp;</div></li><li><div>     * by default&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $status_code&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function output( $status_code = 200 ) {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = $this-&gt;get_output_format();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        status_header( $status_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'edd_api_output_before', $this-&gt;data, $this, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $format ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'xml' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                require_once EDD_PLUGIN_DIR . 'includes/libraries/array2xml.php';&nbsp;</div></li><li><div>                $xml = Array2XML::createXML( 'edd', $this-&gt;data );&nbsp;</div></li><li><div>                echo $xml-&gt;saveXML();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'json' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                header( 'Content-Type: application/json' );&nbsp;</div></li><li><div>                if ( ! empty( $this-&gt;pretty_print ) )&nbsp;</div></li><li><div>                    echo json_encode( $this-&gt;data, $this-&gt;pretty_print );&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    echo json_encode( $this-&gt;data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Allow other formats to be added via extensions&nbsp;</div></li><li><div>                do_action( 'edd_api_output_' . $format, $this-&gt;data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        endswitch;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'edd_api_output_after', $this-&gt;data, $this, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        edd_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Modify User Profile&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Modifies the output of profile.php to add key generation/revocation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @param object $user Current user info&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function user_key_field( $user ) {&nbsp;</div></li><li><div>        if ( ( edd_get_option( 'api_allow_user_keys', false ) || current_user_can( 'manage_shop_settings' ) ) && current_user_can( 'edit_user', $user-&gt;ID ) ) {&nbsp;</div></li><li><div>            $user = get_userdata( $user-&gt;ID );&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;tr&gt;&nbsp;</div></li><li><div>                        &lt;th&gt;&nbsp;</div></li><li><div>                            &lt;?php _e( 'Easy Digital Downloads API Keys', 'easy-digital-downloads' ); ?&gt;&nbsp;</div></li><li><div>                        &lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;td&gt;&nbsp;</div></li><li><div>                            &lt;?php&nbsp;</div></li><li><div>                                $public_key = $this-&gt;get_user_public_key( $user-&gt;ID );&nbsp;</div></li><li><div>                                $secret_key = $this-&gt;get_user_secret_key( $user-&gt;ID );&nbsp;</div></li><li><div>                            ?&gt;&nbsp;</div></li><li><div>                            &lt;?php if ( empty( $user-&gt;edd_user_public_key ) ) { ?&gt;&nbsp;</div></li><li><div>                                &lt;input name=&quot;edd_set_api_key&quot; type=&quot;checkbox&quot; id=&quot;edd_set_api_key&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>                                &lt;span class=&quot;description&quot;&gt;&lt;?php _e( 'Generate API Key', 'easy-digital-downloads' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                            &lt;?php } else { ?&gt;&nbsp;</div></li><li><div>                                &lt;strong style=&quot;display:inline-block; width: 125px;&quot;&gt;&lt;?php _e( 'Public key:', 'easy-digital-downloads' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;input type=&quot;text&quot; disabled=&quot;disabled&quot; class=&quot;regular-text&quot; id=&quot;publickey&quot; value=&quot;&lt;?php echo esc_attr( $public_key ); ?&gt;&quot;/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;strong style=&quot;display:inline-block; width: 125px;&quot;&gt;&lt;?php _e( 'Secret key:', 'easy-digital-downloads' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;input type=&quot;text&quot; disabled=&quot;disabled&quot; class=&quot;regular-text&quot; id=&quot;privatekey&quot; value=&quot;&lt;?php echo esc_attr( $secret_key ); ?&gt;&quot;/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;strong style=&quot;display:inline-block; width: 125px;&quot;&gt;&lt;?php _e( 'Token:', 'easy-digital-downloads' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;input type=&quot;text&quot; disabled=&quot;disabled&quot; class=&quot;regular-text&quot; id=&quot;token&quot; value=&quot;&lt;?php echo esc_attr( $this-&gt;get_token( $user-&gt;ID ) ); ?&gt;&quot;/&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;input name=&quot;edd_set_api_key&quot; type=&quot;checkbox&quot; id=&quot;edd_set_api_key&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>                                &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;edd_set_api_key&quot;&gt;&lt;?php _e( 'Revoke API Keys', 'easy-digital-downloads' ); ?&gt;&lt;/label&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                            &lt;?php } ?&gt;&nbsp;</div></li><li><div>                        &lt;/td&gt;&nbsp;</div></li><li><div>                    &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>        &lt;?php }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process an API key generation/revocation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.0.0&nbsp;</div></li><li><div>     * @param array $args&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function process_api_key( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! wp_verify_nonce( $_REQUEST['_wpnonce'], 'edd-api-nonce' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_die( __( 'Nonce verification failed', 'easy-digital-downloads' ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $args['user_id'] ) ) {&nbsp;</div></li><li><div>            wp_die( sprintf( __( 'User ID Required', 'easy-digital-downloads' ), $process ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 401 ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_numeric( $args['user_id'] ) ) {&nbsp;</div></li><li><div>            $user_id = isset( $args['user_id'] ) ? absint( $args['user_id'] ) : get_current_user_id();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $userdata = get_user_by( 'login', $args['user_id'] );&nbsp;</div></li><li><div>            $user_id = $userdata-&gt;ID;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $process = isset( $args['edd_api_process'] ) ? strtolower( $args['edd_api_process'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $user_id == get_current_user_id() && ! edd_get_option( 'allow_user_api_keys' ) && ! current_user_can( 'manage_shop_settings' ) ) {&nbsp;</div></li><li><div>            wp_die( sprintf( __( 'You do not have permission to %s API keys for this user', 'easy-digital-downloads' ), $process ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>        } elseif( ! current_user_can( 'manage_shop_settings' ) ) {&nbsp;</div></li><li><div>            wp_die( sprintf( __( 'You do not have permission to %s API keys for this user', 'easy-digital-downloads' ), $process ), __( 'Error', 'easy-digital-downloads' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $process ) {&nbsp;</div></li><li><div>            case 'generate':&nbsp;</div></li><li><div>                if( $this-&gt;generate_api_key( $user_id ) ) {&nbsp;</div></li><li><div>                    delete_transient( 'edd-total-api-keys' );&nbsp;</div></li><li><div>                    wp_redirect( add_query_arg( 'edd-message', 'api-key-generated', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    wp_redirect( add_query_arg( 'edd-message', 'api-key-failed', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'regenerate':&nbsp;</div></li><li><div>                $this-&gt;generate_api_key( $user_id, true );&nbsp;</div></li><li><div>                delete_transient( 'edd-total-api-keys' );&nbsp;</div></li><li><div>                wp_redirect( add_query_arg( 'edd-message', 'api-key-regenerated', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'revoke':&nbsp;</div></li><li><div>                $this-&gt;revoke_api_key( $user_id );&nbsp;</div></li><li><div>                delete_transient( 'edd-total-api-keys' );&nbsp;</div></li><li><div>                wp_redirect( add_query_arg( 'edd-message', 'api-key-revoked', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate new API keys for a user&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.0.0&nbsp;</div></li><li><div>     * @param int $user_id User ID the key is being generated for&nbsp;</div></li><li><div>     * @param boolean $regenerate Regenerate the key for the user&nbsp;</div></li><li><div>     * @return boolean True if (re)generated successfully, false otherwise.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_api_key( $user_id = 0, $regenerate = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $user_id ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! $user ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $public_key = $this-&gt;get_user_public_key( $user_id );&nbsp;</div></li><li><div>        $secret_key = $this-&gt;get_user_secret_key( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $public_key ) || $regenerate == true ) {&nbsp;</div></li><li><div>            $new_public_key = $this-&gt;generate_public_key( $user-&gt;user_email );&nbsp;</div></li><li><div>            $new_secret_key = $this-&gt;generate_private_key( $user-&gt;ID );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $regenerate == true ) {&nbsp;</div></li><li><div>            $this-&gt;revoke_api_key( $user-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_user_meta( $user_id, $new_public_key, 'edd_user_public_key' );&nbsp;</div></li><li><div>        update_user_meta( $user_id, $new_secret_key, 'edd_user_secret_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Revoke a users API keys&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.0.0&nbsp;</div></li><li><div>     * @param int $user_id User ID of user to revoke key for&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function revoke_api_key( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $user_id ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! $user ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $public_key = $this-&gt;get_user_public_key( $user_id );&nbsp;</div></li><li><div>        $secret_key = $this-&gt;get_user_secret_key( $user_id );&nbsp;</div></li><li><div>        if ( ! empty( $public_key ) ) {&nbsp;</div></li><li><div>            delete_transient( md5( 'edd_api_user_' . $public_key ) );&nbsp;</div></li><li><div>            delete_transient( md5('edd_api_user_public_key' . $user_id ) );&nbsp;</div></li><li><div>            delete_transient( md5('edd_api_user_secret_key' . $user_id ) );&nbsp;</div></li><li><div>            delete_user_meta( $user_id, $public_key );&nbsp;</div></li><li><div>            delete_user_meta( $user_id, $secret_key );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_version() {&nbsp;</div></li><li><div>        return self::VERSION;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate and Save API key&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Generates the key requested by user_key_field and stores it in the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_key( $user_id ) {&nbsp;</div></li><li><div>        edd_update_user_api_key( $user_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the public key for a user&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.9.9&nbsp;</div></li><li><div>     * @param string $user_email&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_public_key( $user_email = '' ) {&nbsp;</div></li><li><div>        $auth_key = defined( 'AUTH_KEY' ) ? AUTH_KEY : '';&nbsp;</div></li><li><div>        $public = hash( 'md5', $user_email . $auth_key . date( 'U' ) );&nbsp;</div></li><li><div>        return $public;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the secret key for a user&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.9.9&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_private_key( $user_id = 0 ) {&nbsp;</div></li><li><div>        $auth_key = defined( 'AUTH_KEY' ) ? AUTH_KEY : '';&nbsp;</div></li><li><div>        $secret = hash( 'md5', $user_id . $auth_key . date( 'U' ) );&nbsp;</div></li><li><div>        return $secret;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the user's token&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.9.9&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_token( $user_id = 0 ) {&nbsp;</div></li><li><div>        return hash( 'md5', $this-&gt;get_user_secret_key( $user_id ) . $this-&gt;get_user_public_key( $user_id ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the default sales stats returned by the 'stats' endpoint&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.3&nbsp;</div></li><li><div>     * @return array default sales statistics&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_default_sales_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Default sales return&nbsp;</div></li><li><div>        $sales = array();&nbsp;</div></li><li><div>        $sales['sales']['today'] = $this-&gt;stats-&gt;get_sales( 0, 'today' );&nbsp;</div></li><li><div>        $sales['sales']['current_month'] = $this-&gt;stats-&gt;get_sales( 0, 'this_month' );&nbsp;</div></li><li><div>        $sales['sales']['last_month'] = $this-&gt;stats-&gt;get_sales( 0, 'last_month' );&nbsp;</div></li><li><div>        $sales['sales']['totals'] = edd_get_total_sales();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sales;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the default earnings stats returned by the 'stats' endpoint&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.3&nbsp;</div></li><li><div>     * @return array default earnings statistics&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_default_earnings_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Default earnings return&nbsp;</div></li><li><div>        $earnings = array();&nbsp;</div></li><li><div>        $earnings['earnings']['today'] = $this-&gt;stats-&gt;get_earnings( 0, 'today' );&nbsp;</div></li><li><div>        $earnings['earnings']['current_month'] = $this-&gt;stats-&gt;get_earnings( 0, 'this_month' );&nbsp;</div></li><li><div>        $earnings['earnings']['last_month'] = $this-&gt;stats-&gt;get_earnings( 0, 'last_month' );&nbsp;</div></li><li><div>        $earnings['earnings']['totals'] = edd_get_total_earnings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $earnings;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * A Backwards Compatibility call for the change of meta_key/value for users API Keys&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.4&nbsp;</div></li><li><div>     * @param  string $check     Wether to check the cache or not&nbsp;</div></li><li><div>     * @param  int $object_id    The User ID being passed&nbsp;</div></li><li><div>     * @param  string $meta_key  The user meta key&nbsp;</div></li><li><div>     * @param  bool $single      If it should return a single value or array&nbsp;</div></li><li><div>     * @return string            The API key/secret for the user supplied&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function api_key_backwards_copmat( $check, $object_id, $meta_key, $single ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $meta_key !== 'edd_user_public_key' && $meta_key !== 'edd_user_secret_key' ) {&nbsp;</div></li><li><div>            return $check;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $return = $check;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $meta_key ) {&nbsp;</div></li><li><div>            case 'edd_user_public_key':&nbsp;</div></li><li><div>                $return = EDD()-&gt;api-&gt;get_user_public_key( $object_id );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'edd_user_secret_key':&nbsp;</div></li><li><div>                $return = EDD()-&gt;api-&gt;get_user_secret_key( $object_id );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $single ) {&nbsp;</div></li><li><div>            $return = array( $return );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sanitizes category and tag terms&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 2.6&nbsp;</div></li><li><div>     * @param mixed $term Request variable&nbsp;</div></li><li><div>     * @return mixed Sanitized term/s&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function sanitize_request_term( $term ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_array( $term ) ) {&nbsp;</div></li><li><div>            $term = array_map( 'sanitize_text_field', $term );&nbsp;</div></li><li><div>        } else if( is_int( $term ) ) {&nbsp;</div></li><li><div>            $term = absint( $term );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $term = sanitize_text_field( $term );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $term;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Disable request logging&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since  2.7&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function log_requests() {&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_log_requests', true );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/files/includes-class-edd-api/" class="file">/includes/class-edd-api.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="28" class="block" start="28"><li><div>class EDD_API {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * API Version&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    const VERSION = '1.3';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Pretty Print?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $pretty_print = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Log API requests?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public $log_requests = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Is this a valid request?&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $is_valid_request = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * User ID Performing the API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var int&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.1&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $user_id = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Instance of EDD Stats class&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var object&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.7&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $stats;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Response data to return&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.2&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var bool&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.7&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private $override = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Setup the EDD API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function __construct() {&nbsp;</div></li><li><div>        add_action( 'init', array( $this, 'add_endpoint' ) );&nbsp;</div></li><li><div>        add_action( 'template_redirect', array( $this, 'process_query' ), -1 );&nbsp;</div></li><li><div>        add_filter( 'query_vars', array( $this, 'query_vars' ) );&nbsp;</div></li><li><div>        add_action( 'show_user_profile', array( $this, 'user_key_field' ) );&nbsp;</div></li><li><div>        add_action( 'edit_user_profile', array( $this, 'user_key_field' ) );&nbsp;</div></li><li><div>        add_action( 'personal_options_update', array( $this, 'update_key' ) );&nbsp;</div></li><li><div>        add_action( 'edit_user_profile_update', array( $this, 'update_key' ) );&nbsp;</div></li><li><div>        add_action( 'edd_process_api_key', array( $this, 'process_api_key' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine if JSON_PRETTY_PRINT is available&nbsp;</div></li><li><div>        $this-&gt;pretty_print = defined( 'JSON_PRETTY_PRINT' ) ? JSON_PRETTY_PRINT : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow API request logging to be turned off&nbsp;</div></li><li><div>        $this-&gt;log_requests = apply_filters( 'edd_api_log_requests', $this-&gt;log_requests );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Setup EDD_Stats instance&nbsp;</div></li><li><div>        $this-&gt;stats = new EDD_Payment_Stats;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers a new rewrite endpoint for accessing the API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @param array $rewrite_rules WordPress Rewrite Rules&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_endpoint( $rewrite_rules ) {&nbsp;</div></li><li><div>        add_rewrite_endpoint( 'edd-api', EP_ALL );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Registers query vars for API access&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @param array $vars Query vars&nbsp;</div></li><li><div>     * @return string[] $vars New query vars&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function query_vars( $vars ) {&nbsp;</div></li><li><div>        $vars[] = 'token';&nbsp;</div></li><li><div>        $vars[] = 'key';&nbsp;</div></li><li><div>        $vars[] = 'query';&nbsp;</div></li><li><div>        $vars[] = 'type';&nbsp;</div></li><li><div>        $vars[] = 'product';&nbsp;</div></li><li><div>        $vars[] = 'number';&nbsp;</div></li><li><div>        $vars[] = 'date';&nbsp;</div></li><li><div>        $vars[] = 'startdate';&nbsp;</div></li><li><div>        $vars[] = 'enddate';&nbsp;</div></li><li><div>        $vars[] = 'customer';&nbsp;</div></li><li><div>        $vars[] = 'discount';&nbsp;</div></li><li><div>        $vars[] = 'format';&nbsp;</div></li><li><div>        $vars[] = 'id';&nbsp;</div></li><li><div>        $vars[] = 'purchasekey';&nbsp;</div></li><li><div>        $vars[] = 'email';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $vars;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Validate the API request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Checks for the user's public key and token against the secret key&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @global object $wp_query WordPress Query&nbsp;</div></li><li><div>     * @uses EDD_API::get_user()&nbsp;</div></li><li><div>     * @uses EDD_API::invalid_key()&nbsp;</div></li><li><div>     * @uses EDD_API::invalid_auth()&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function validate_request() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;override = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Make sure we have both user and api key&nbsp;</div></li><li><div>        if ( ! empty( $wp_query-&gt;query_vars['edd-api'] ) && ( $wp_query-&gt;query_vars['edd-api'] != 'products' || ! empty( $wp_query-&gt;query_vars['token'] ) ) ) {&nbsp;</div></li><li><div>            if ( empty( $wp_query-&gt;query_vars['token'] ) || empty( $wp_query-&gt;query_vars['key'] ) )&nbsp;</div></li><li><div>                $this-&gt;missing_auth();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // Retrieve the user by public API key and ensure they exist&nbsp;</div></li><li><div>            if ( ! ( $user = $this-&gt;get_user( $wp_query-&gt;query_vars['key'] ) ) ) :&nbsp;</div></li><li><div>                $this-&gt;invalid_key();&nbsp;</div></li><li><div>            else :&nbsp;</div></li><li><div>                $token = urldecode( $wp_query-&gt;query_vars['token'] );&nbsp;</div></li><li><div>                $secret = get_user_meta( $user, 'edd_user_secret_key', true );&nbsp;</div></li><li><div>                $public = urldecode( $wp_query-&gt;query_vars['key'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( hash_equals( md5( $secret . $public ), $token ) )&nbsp;</div></li><li><div>                    $this-&gt;is_valid_request = true;&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    $this-&gt;invalid_auth();&nbsp;</div></li><li><div>            endif;&nbsp;</div></li><li><div>        } elseif ( !empty( $wp_query-&gt;query_vars['edd-api'] ) && $wp_query-&gt;query_vars['edd-api'] == 'products' ) {&nbsp;</div></li><li><div>            $this-&gt;is_valid_request = true;&nbsp;</div></li><li><div>            $wp_query-&gt;set( 'key', 'public' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the user ID based on the public key provided&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5.1&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     * Database API&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $key Public Key&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool if user ID is found, false otherwise&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_user( $key = '' ) {&nbsp;</div></li><li><div>        global $wpdb, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $key ) )&nbsp;</div></li><li><div>            $key = urldecode( $wp_query-&gt;query_vars['key'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $key ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_transient( md5( 'edd_api_user_' . $key ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false === $user ) {&nbsp;</div></li><li><div>            $user = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT user_id FROM $wpdb-&gt;usermeta WHERE meta_key = 'edd_user_public_key' AND meta_value = %s LIMIT 1&quot;, $key ) );&nbsp;</div></li><li><div>            set_transient( md5( 'edd_api_user_' . $key ) , $user, DAY_IN_SECONDS );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $user != NULL ) {&nbsp;</div></li><li><div>            $this-&gt;user_id = $user;&nbsp;</div></li><li><div>            return $user;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays a missing authentication error if all the parameters aren't&nbsp;</div></li><li><div>     * provided&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function missing_auth() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'You must specify both a token and API key!', 'edd' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 401 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an authentication failed error if the user failed to provide valid&nbsp;</div></li><li><div>     * credentials&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since  1.5&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function invalid_auth() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'Your request could not be authenticated!', 'edd' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 401 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Displays an invalid API key error if the API key provided couldn't be&nbsp;</div></li><li><div>     * validated&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @uses EDD_API::output()&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function invalid_key() {&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        $error['error'] = __( 'Invalid API key!', 'edd' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data = $error;&nbsp;</div></li><li><div>        $this-&gt;output( 401 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Listens for the API and then processes the API requests&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function process_query() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for edd-api var. Get out if not present&nbsp;</div></li><li><div>        if ( ! isset( $wp_query-&gt;query_vars['edd-api'] ) )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Check for a valid user and set errors if necessary&nbsp;</div></li><li><div>        $this-&gt;validate_request();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Only proceed if no errors have been noted&nbsp;</div></li><li><div>        if( ! $this-&gt;is_valid_request )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! defined( 'EDD_DOING_API' ) ) {&nbsp;</div></li><li><div>            define( 'EDD_DOING_API', true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Determine the kind of query&nbsp;</div></li><li><div>        $query_mode = $this-&gt;get_query_mode();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $query_mode ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'stats' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;get_stats( array(&nbsp;</div></li><li><div>                    'type' =&gt; isset( $wp_query-&gt;query_vars['type'] )      ? $wp_query-&gt;query_vars['type']      : null, &nbsp;</div></li><li><div>                    'product' =&gt; isset( $wp_query-&gt;query_vars['product'] )   ? $wp_query-&gt;query_vars['product']   : null, &nbsp;</div></li><li><div>                    'date' =&gt; isset( $wp_query-&gt;query_vars['date'] )      ? $wp_query-&gt;query_vars['date']      : null, &nbsp;</div></li><li><div>                    'startdate' =&gt; isset( $wp_query-&gt;query_vars['startdate'] ) ? $wp_query-&gt;query_vars['startdate'] : null, &nbsp;</div></li><li><div>                    'enddate' =&gt; isset( $wp_query-&gt;query_vars['enddate'] )   ? $wp_query-&gt;query_vars['enddate']   : null&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'products' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $product = isset( $wp_query-&gt;query_vars['product'] )   ? $wp_query-&gt;query_vars['product']   : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;get_products( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'customers' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customer = isset( $wp_query-&gt;query_vars['customer'] ) ? $wp_query-&gt;query_vars['customer']  : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;get_customers( $customer );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'sales' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;get_recent_sales();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'discounts' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $discount = isset( $wp_query-&gt;query_vars['discount'] ) ? $wp_query-&gt;query_vars['discount']  : null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = $this-&gt;get_discounts( $discount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        endswitch;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow extensions to setup their own return data&nbsp;</div></li><li><div>        $this-&gt;data = apply_filters( 'edd_api_output_data', $data, $query_mode, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Log this API request, if enabled. We log it here because we have access to errors.&nbsp;</div></li><li><div>        $this-&gt;log_request( $this-&gt;data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Send out data to the output function&nbsp;</div></li><li><div>        $this-&gt;output();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Determines the kind of query requested and also ensure it is a valid query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @return string $query Query mode&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_query_mode() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Whitelist our query options&nbsp;</div></li><li><div>        $accepted = apply_filters( 'edd_api_valid_query_modes', array(&nbsp;</div></li><li><div>            'stats', &nbsp;</div></li><li><div>            'products', &nbsp;</div></li><li><div>            'customers', &nbsp;</div></li><li><div>            'sales', &nbsp;</div></li><li><div>            'discounts'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = isset( $wp_query-&gt;query_vars['edd-api'] ) ? $wp_query-&gt;query_vars['edd-api'] : null;&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        // Make sure our query is valid&nbsp;</div></li><li><div>        if ( ! in_array( $query, $accepted ) ) {&nbsp;</div></li><li><div>            $error['error'] = __( 'Invalid query!', 'edd' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;data = $error;&nbsp;</div></li><li><div>            $this-&gt;output();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $query;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Get page number&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @return int $wp_query-&gt;query_vars['page'] if page number returned (default: 1)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_paged() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return isset( $wp_query-&gt;query_vars['page'] ) ? $wp_query-&gt;query_vars['page'] : 1;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Number of results to display per page&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @return int $per_page Results to display per page (default: 10)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function per_page() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $per_page = isset( $wp_query-&gt;query_vars['number'] ) ? $wp_query-&gt;query_vars['number'] : 10;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $per_page &lt; 0 && $this-&gt;get_query_mode() == 'customers' )&nbsp;</div></li><li><div>            $per_page = 99999999; // Customers query doesn't support -1&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_results_per_page', $per_page );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the output format&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Determines whether results should be displayed in XML or JSON&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_output_format() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = isset( $wp_query-&gt;query_vars['format'] ) ? $wp_query-&gt;query_vars['format'] : 'json';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_output_format', $format );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Sets up the dates used to retrieve earnings/sales&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5.1&nbsp;</div></li><li><div>     * @param array $args Arguments to override defaults&nbsp;</div></li><li><div>     * @return array $dates&nbsp;</div></li><li><div>    */&nbsp;</div></li><li><div>    public function get_dates( $args = array() ) {&nbsp;</div></li><li><div>        $dates = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'type' =&gt; '', &nbsp;</div></li><li><div>            'product' =&gt; null, &nbsp;</div></li><li><div>            'date' =&gt; null, &nbsp;</div></li><li><div>            'startdate' =&gt; null, &nbsp;</div></li><li><div>            'enddate' =&gt; null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_time = current_time( 'timestamp' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( 'range' === $args['date'] ) {&nbsp;</div></li><li><div>            $startdate = strtotime( $args['startdate'] );&nbsp;</div></li><li><div>            $enddate = strtotime( $args['enddate'] );&nbsp;</div></li><li><div>            $dates['day_start'] = date( 'd', $startdate );&nbsp;</div></li><li><div>            $dates['day_end'] = date( 'd', $enddate );&nbsp;</div></li><li><div>            $dates['m_start'] = date( 'n', $startdate );&nbsp;</div></li><li><div>            $dates['m_end'] = date( 'n', $enddate );&nbsp;</div></li><li><div>            $dates['year'] = date( 'Y', $startdate );&nbsp;</div></li><li><div>            $dates['year_end'] = date( 'Y', $enddate );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // Modify dates based on predefined ranges&nbsp;</div></li><li><div>            switch ( $args['date'] ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'this_month' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['m_end'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'last_month' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = date( 'n', $current_time ) == 1 ? 12 : date( 'n', $current_time ) - 1;&nbsp;</div></li><li><div>                    $dates['m_end'] = $dates['m_start'];&nbsp;</div></li><li><div>                    $dates['year'] = date( 'n', $current_time ) == 1 ? date( 'Y', $current_time ) - 1 : date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'today' :&nbsp;</div></li><li><div>                    $dates['day'] = date( 'd', $current_time );&nbsp;</div></li><li><div>                    $dates['m_start'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['m_end'] = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'yesterday' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $year = date( 'Y', $current_time );&nbsp;</div></li><li><div>                    $month = date( 'n', $current_time );&nbsp;</div></li><li><div>                    $day = date( 'd', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $month == 1 && $day == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $year -= 1;&nbsp;</div></li><li><div>                        $month = 12;&nbsp;</div></li><li><div>                        $day = cal_days_in_month( CAL_GREGORIAN, $month, $year );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } elseif ( $month &gt; 1 && $day == 1 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $month -= 1;&nbsp;</div></li><li><div>                        $day = cal_days_in_month( CAL_GREGORIAN, $month, $year );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $day -= 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $dates['day'] = $day;&nbsp;</div></li><li><div>                    $dates['m_start'] = $month;&nbsp;</div></li><li><div>                    $dates['m_end'] = $month;&nbsp;</div></li><li><div>                    $dates['year'] = $year;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'this_quarter' :&nbsp;</div></li><li><div>                    $month_now = date( 'n', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $month_now &lt;= 3 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 1;&nbsp;</div></li><li><div>                        $dates['m_end'] = 3;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 6 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 4;&nbsp;</div></li><li><div>                        $dates['m_end'] = 6;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 9 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 7;&nbsp;</div></li><li><div>                        $dates['m_end'] = 9;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 10;&nbsp;</div></li><li><div>                        $dates['m_end'] = 12;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'last_quarter' :&nbsp;</div></li><li><div>                    $month_now = date( 'n', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $month_now &lt;= 3 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 10;&nbsp;</div></li><li><div>                        $dates['m_end'] = 12;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time ) - 1; // Previous year&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 6 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 1;&nbsp;</div></li><li><div>                        $dates['m_end'] = 3;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else if ( $month_now &lt;= 9 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 4;&nbsp;</div></li><li><div>                        $dates['m_end'] = 6;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $dates['m_start'] = 7;&nbsp;</div></li><li><div>                        $dates['m_end'] = 9;&nbsp;</div></li><li><div>                        $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'this_year' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = null;&nbsp;</div></li><li><div>                    $dates['m_end'] = null;&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'last_year' :&nbsp;</div></li><li><div>                    $dates['day'] = null;&nbsp;</div></li><li><div>                    $dates['m_start'] = null;&nbsp;</div></li><li><div>                    $dates['m_end'] = null;&nbsp;</div></li><li><div>                    $dates['year'] = date( 'Y', $current_time ) - 1;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            endswitch;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Returns the filters for the dates used to retreive earnings/sales&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @since 1.5.1&nbsp;</div></li><li><div>         * @param object $dates The dates used for retreiving earnings/sales&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_stat_dates', $dates );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Customers API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     *   Database API&nbsp;</div></li><li><div>     * @param int $customer Customer ID&nbsp;</div></li><li><div>     * @return array $customers Multidimensional array of the customers&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_customers( $customer = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $customers = array();&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'view_shop_sensitive_data' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $customers;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $paged = $this-&gt;get_paged();&nbsp;</div></li><li><div>        $per_page = $this-&gt;per_page();&nbsp;</div></li><li><div>        $offset = $per_page * ( $paged - 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_numeric( $customer ) ) {&nbsp;</div></li><li><div>            $field = 'id';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $field = 'email';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $customer_query = EDD()-&gt;customers-&gt;get_customers( array( 'number' =&gt; $per_page, 'offset' =&gt; $offset, $field =&gt; $customer ) );&nbsp;</div></li><li><div>        $customer_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $customer_query ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $customer_query as $customer_obj ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $names = explode( ' ', $customer_obj-&gt;name );&nbsp;</div></li><li><div>                $first_name = ! empty( $names[0] ) ? $names[0] : '';&nbsp;</div></li><li><div>                $last_name = '';&nbsp;</div></li><li><div>                if( ! empty( $names[1] ) ) {&nbsp;</div></li><li><div>                    unset( $names[0] );&nbsp;</div></li><li><div>                    $last_name = implode( ' ', $names );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['id'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['user_id'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['username'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['display_name'] = '';&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['customer_id'] = $customer_obj-&gt;id;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['first_name'] = $first_name;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['last_name'] = $last_name;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['info']['email'] = $customer_obj-&gt;email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( ! empty( $customer_obj-&gt;user_id ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $user_data = get_userdata( $customer_obj-&gt;user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Customer with registered account&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // id is going to get deprecated in the future, user user_id or customer_id instead&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['id'] = $customer_obj-&gt;user_id;&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['user_id'] = $customer_obj-&gt;user_id;&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['username'] = $user_data-&gt;user_login;&nbsp;</div></li><li><div>                    $customers['customers'][$customer_count]['info']['display_name'] = $user_data-&gt;display_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['stats']['total_purchases'] = $customer_obj-&gt;purchase_count;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['stats']['total_spent'] = $customer_obj-&gt;purchase_value;&nbsp;</div></li><li><div>                $customers['customers'][$customer_count]['stats']['total_downloads'] = edd_count_file_downloads_of_user( $customer_obj-&gt;email );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $customer_count++;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } elseif( $customer ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $error['error'] = sprintf( __( 'Customer %s not found!', 'edd' ), $customer );&nbsp;</div></li><li><div>            return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $error['error'] = __( 'No customers found!', 'edd' );&nbsp;</div></li><li><div>            return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $customers;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Products API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @param int $product Product (Download) ID&nbsp;</div></li><li><div>     * @return array $customers Multidimensional array of the products&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_products( $product = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $products = array();&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $product == null ) {&nbsp;</div></li><li><div>            $products['products'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $product_list = get_posts( array(&nbsp;</div></li><li><div>                'post_type' =&gt; 'download', &nbsp;</div></li><li><div>                'posts_per_page' =&gt; $this-&gt;per_page(), &nbsp;</div></li><li><div>                'suppress_filters' =&gt; true, &nbsp;</div></li><li><div>                'paged' =&gt; $this-&gt;get_paged()&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $product_list ) {&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $product_list as $product_info ) {&nbsp;</div></li><li><div>                    $products['products'][$i] = $this-&gt;get_product_data( $product_info );&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( get_post_type( $product ) == 'download' ) {&nbsp;</div></li><li><div>                $product_info = get_post( $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $products['products'][0] = $this-&gt;get_product_data( $product_info );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $error['error'] = sprintf( __( 'Product %s not found!', 'edd' ), $product );&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $products;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Given a download post object, generate the data for the API output&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since  2.3.9&nbsp;</div></li><li><div>     * @param  object $product_info The Download Post Object&nbsp;</div></li><li><div>     * @return array                Array of post data to return back in the API&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_product_data( $product_info ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $product['info']['id'] = $product_info-&gt;ID;&nbsp;</div></li><li><div>        $product['info']['slug'] = $product_info-&gt;post_name;&nbsp;</div></li><li><div>        $product['info']['title'] = $product_info-&gt;post_title;&nbsp;</div></li><li><div>        $product['info']['create_date'] = $product_info-&gt;post_date;&nbsp;</div></li><li><div>        $product['info']['modified_date'] = $product_info-&gt;post_modified;&nbsp;</div></li><li><div>        $product['info']['status'] = $product_info-&gt;post_status;&nbsp;</div></li><li><div>        $product['info']['link'] = html_entity_decode( $product_info-&gt;guid );&nbsp;</div></li><li><div>        $product['info']['content'] = $product_info-&gt;post_content;&nbsp;</div></li><li><div>        $product['info']['thumbnail'] = wp_get_attachment_url( get_post_thumbnail_id( $product_info-&gt;ID ) );&nbsp;</div></li><li><div>        $product['info']['category'] = get_the_terms( $product_info, 'download_category' );&nbsp;</div></li><li><div>        $product['info']['tags'] = get_the_terms( $product_info, 'download_tag' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( user_can( $this-&gt;user_id, 'view_shop_reports' ) || $this-&gt;override ) {&nbsp;</div></li><li><div>            $product['stats']['total']['sales'] = edd_get_download_sales_stats( $product_info-&gt;ID );&nbsp;</div></li><li><div>            $product['stats']['total']['earnings'] = edd_get_download_earnings_stats( $product_info-&gt;ID );&nbsp;</div></li><li><div>            $product['stats']['monthly_average']['sales'] = edd_get_average_monthly_download_sales( $product_info-&gt;ID );&nbsp;</div></li><li><div>            $product['stats']['monthly_average']['earnings'] = edd_get_average_monthly_download_earnings( $product_info-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( edd_has_variable_prices( $product_info-&gt;ID ) ) {&nbsp;</div></li><li><div>            foreach ( edd_get_variable_prices( $product_info-&gt;ID ) as $price ) {&nbsp;</div></li><li><div>                $product['pricing'][ sanitize_key( $price['name'] ) ] = $price['amount'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $product['pricing']['amount'] = edd_get_download_price( $product_info-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( user_can( $this-&gt;user_id, 'view_shop_sensitive_data' ) || $this-&gt;override ) {&nbsp;</div></li><li><div>            foreach ( edd_get_download_files( $product_info-&gt;ID ) as $file ) {&nbsp;</div></li><li><div>                $product['files'][] = $file;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $product['notes'] = edd_get_product_notes( $product_info-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'edd_api_products_product', $product );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Stats API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $args Arguments provided by API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_stats( $args = array() ) {&nbsp;</div></li><li><div>        $defaults = array(&nbsp;</div></li><li><div>            'type' =&gt; null, &nbsp;</div></li><li><div>            'product' =&gt; null, &nbsp;</div></li><li><div>            'date' =&gt; null, &nbsp;</div></li><li><div>            'startdate' =&gt; null, &nbsp;</div></li><li><div>            'enddate' =&gt; null&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = wp_parse_args( $args, $defaults );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $dates = $this-&gt;get_dates( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $stats = array();&nbsp;</div></li><li><div>        $earnings = array(&nbsp;</div></li><li><div>            'earnings' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $sales = array(&nbsp;</div></li><li><div>            'sales' =&gt; array()&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'view_shop_reports' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $stats;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $args['type'] == 'sales' ) {&nbsp;</div></li><li><div>            if ( $args['product'] == null ) {&nbsp;</div></li><li><div>                if ( $args['date'] == null ) {&nbsp;</div></li><li><div>                    $sales = $this-&gt;get_default_sales_stats();&nbsp;</div></li><li><div>                } elseif( $args['date'] === 'range' ) {&nbsp;</div></li><li><div>                    // Return sales for a date range&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure the end date is later than the start date&nbsp;</div></li><li><div>                    if( $args['enddate'] &lt; $args['startdate'] ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'The end date must be later than the start date!', 'edd' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure both the start and end date are specified&nbsp;</div></li><li><div>                    if ( empty( $args['startdate'] ) || empty( $args['enddate'] ) ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'Invalid or no date range specified!', 'edd' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $total = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Loop through the years&nbsp;</div></li><li><div>                    $y = $dates['year'];&nbsp;</div></li><li><div>                    while( $y &lt;= $dates['year_end'] ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if( $dates['year'] == $dates['year_end'] ) {&nbsp;</div></li><li><div>                            $month_start = $dates['m_start'];&nbsp;</div></li><li><div>                            $month_end = $dates['m_end'];&nbsp;</div></li><li><div>                        } elseif( $y == $dates['year'] && $dates['year_end'] &gt; $dates['year'] ) {&nbsp;</div></li><li><div>                            $month_start = $dates['m_start'];&nbsp;</div></li><li><div>                            $month_end = 12;&nbsp;</div></li><li><div>                        } elseif( $y == $dates['year_end'] ) {&nbsp;</div></li><li><div>                            $month_start = 1;&nbsp;</div></li><li><div>                            $month_end = $dates['m_end'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $month_start = 1;&nbsp;</div></li><li><div>                            $month_end = 12;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $i = $month_start;&nbsp;</div></li><li><div>                        while ( $i &lt;= $month_end ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if( $i == $dates['m_start'] ) {&nbsp;</div></li><li><div>                                $d = $dates['day_start'];&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $d = 1;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if( $i == $dates['m_end'] ) {&nbsp;</div></li><li><div>                                $num_of_days = $dates['day_end'];&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $num_of_days = cal_days_in_month( CAL_GREGORIAN, $i, $y );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            while ( $d &lt;= $num_of_days ) :&nbsp;</div></li><li><div>                                $sale_count = edd_get_sales_by_date( $d, $i, $y );&nbsp;</div></li><li><div>                                $date_key = date( 'Ymd', strtotime( $y . '/' . $i . '/' . $d ) );&nbsp;</div></li><li><div>                                if ( ! isset( $sales['sales'][ $date_key ] ) ) {&nbsp;</div></li><li><div>                                    $sales['sales'][ $date_key ] = 0;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $sales['sales'][ $date_key ] += $sale_count;&nbsp;</div></li><li><div>                                $total += $sale_count;&nbsp;</div></li><li><div>                                $d++;&nbsp;</div></li><li><div>                            endwhile;&nbsp;</div></li><li><div>                            $i++;&nbsp;</div></li><li><div>                        endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $y++;&nbsp;</div></li><li><div>                    endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sales['totals'] = $total;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if( $args['date'] == 'this_quarter' || $args['date'] == 'last_quarter' ) {&nbsp;</div></li><li><div>                           $sales_count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Loop through the months&nbsp;</div></li><li><div>                        $month = $dates['m_start'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        while( $month &lt;= $dates['m_end'] ) :&nbsp;</div></li><li><div>                            $sales_count += edd_get_sales_by_date( null, $month, $dates['year'] );&nbsp;</div></li><li><div>                            $month++;&nbsp;</div></li><li><div>                        endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $sales['sales'][ $args['date'] ] = $sales_count;&nbsp;</div></li><li><div>                       } else {&nbsp;</div></li><li><div>                        $sales['sales'][ $args['date'] ] = edd_get_sales_by_date( $dates['day'], $dates['m_start'], $dates['year'] );&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( $args['product'] == 'all' ) {&nbsp;</div></li><li><div>                $products = get_posts( array( 'post_type' =&gt; 'download', 'nopaging' =&gt; true ) );&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $products as $product_info ) {&nbsp;</div></li><li><div>                    $sales['sales'][$i] = array( $product_info-&gt;post_name =&gt; edd_get_download_sales_stats( $product_info-&gt;ID ) );&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( get_post_type( $args['product'] ) == 'download' ) {&nbsp;</div></li><li><div>                    $product_info = get_post( $args['product'] );&nbsp;</div></li><li><div>                    $sales['sales'][0] = array( $product_info-&gt;post_name =&gt; edd_get_download_sales_stats( $args['product'] ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $error['error'] = sprintf( __( 'Product %s not found!', 'edd' ), $args['product'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $error ) )&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $sales;&nbsp;</div></li><li><div>        } elseif ( $args['type'] == 'earnings' ) {&nbsp;</div></li><li><div>            if ( $args['product'] == null ) {&nbsp;</div></li><li><div>                if ( $args['date'] == null ) {&nbsp;</div></li><li><div>                    $earnings = $this-&gt;get_default_earnings_stats();&nbsp;</div></li><li><div>                } elseif ( $args['date'] === 'range' ) {&nbsp;</div></li><li><div>                    // Return sales for a date range&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure the end date is later than the start date&nbsp;</div></li><li><div>                    if ( $args['enddate'] &lt; $args['startdate'] ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'The end date must be later than the start date!', 'edd' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Ensure both the start and end date are specified&nbsp;</div></li><li><div>                    if ( empty( $args['startdate'] ) || empty( $args['enddate'] ) ) {&nbsp;</div></li><li><div>                        $error['error'] = __( 'Invalid or no date range specified!', 'edd' );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $total = (float) 0.00;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // Loop through the years&nbsp;</div></li><li><div>                    $y = $dates['year'];&nbsp;</div></li><li><div>                    if ( ! isset( $earnings['earnings'] ) ) {&nbsp;</div></li><li><div>                        $earnings['earnings'] = array();&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    while( $y &lt;= $dates['year_end'] ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if( $dates['year'] == $dates['year_end'] ) {&nbsp;</div></li><li><div>                            $month_start = $dates['m_start'];&nbsp;</div></li><li><div>                            $month_end = $dates['m_end'];&nbsp;</div></li><li><div>                        } elseif( $y == $dates['year'] && $dates['year_end'] &gt; $dates['year'] ) {&nbsp;</div></li><li><div>                            $month_start = $dates['m_start'];&nbsp;</div></li><li><div>                            $month_end = 12;&nbsp;</div></li><li><div>                        } elseif( $y == $dates['year_end'] ) {&nbsp;</div></li><li><div>                            $month_start = 1;&nbsp;</div></li><li><div>                            $month_end = $dates['m_end'];&nbsp;</div></li><li><div>                        } else {&nbsp;</div></li><li><div>                            $month_start = 1;&nbsp;</div></li><li><div>                            $month_end = 12;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $i = $month_start;&nbsp;</div></li><li><div>                        while ( $i &lt;= $month_end ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if( $i == $dates['m_start'] )&nbsp;</div></li><li><div>                                $d = $dates['day_start'];&nbsp;</div></li><li><div>                            else&nbsp;</div></li><li><div>                                $d = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            if( $i == $dates['m_end'] ) {&nbsp;</div></li><li><div>                                $num_of_days = $dates['day_end'];&nbsp;</div></li><li><div>                            } else {&nbsp;</div></li><li><div>                                $num_of_days = cal_days_in_month( CAL_GREGORIAN, $i, $y );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            while ( $d &lt;= $num_of_days ) :&nbsp;</div></li><li><div>                                $earnings_stat = edd_get_earnings_by_date( $d, $i, $y );&nbsp;</div></li><li><div>                                $date_key = date( 'Ymd', strtotime( $y . '/' . $i . '/' . $d ) );&nbsp;</div></li><li><div>                                if ( ! isset( $earnings['earnings'][ $date_key ] ) ) {&nbsp;</div></li><li><div>                                    $earnings['earnings'][ $date_key ] = 0;&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $earnings['earnings'][ $date_key ] += $earnings_stat;&nbsp;</div></li><li><div>                                $total += $earnings_stat;&nbsp;</div></li><li><div>                                $d++;&nbsp;</div></li><li><div>                            endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $i++;&nbsp;</div></li><li><div>                        endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $y++;&nbsp;</div></li><li><div>                    endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $earnings['totals'] = $total;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    if ( $args['date'] == 'this_quarter' || $args['date'] == 'last_quarter' ) {&nbsp;</div></li><li><div>                           $earnings_count = (float) 0.00;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // Loop through the months&nbsp;</div></li><li><div>                        $month = $dates['m_start'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        while ( $month &lt;= $dates['m_end'] ) :&nbsp;</div></li><li><div>                            $earnings_count += edd_get_earnings_by_date( null, $month, $dates['year'] );&nbsp;</div></li><li><div>                            $month++;&nbsp;</div></li><li><div>                        endwhile;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $earnings['earnings'][ $args['date'] ] = $earnings_count;&nbsp;</div></li><li><div>                       } else {&nbsp;</div></li><li><div>                        $earnings['earnings'][ $args['date'] ] = edd_get_earnings_by_date( $dates['day'], $dates['m_start'], $dates['year'] );&nbsp;</div></li><li><div>                       }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } elseif ( $args['product'] == 'all' ) {&nbsp;</div></li><li><div>                $products = get_posts( array( 'post_type' =&gt; 'download', 'nopaging' =&gt; true ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $products as $product_info ) {&nbsp;</div></li><li><div>                    $earnings['earnings'][ $i ] = array( $product_info-&gt;post_name =&gt; edd_get_download_earnings_stats( $product_info-&gt;ID ) );&nbsp;</div></li><li><div>                    $i++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if ( get_post_type( $args['product'] ) == 'download' ) {&nbsp;</div></li><li><div>                    $product_info = get_post( $args['product'] );&nbsp;</div></li><li><div>                    $earnings['earnings'][0] = array( $product_info-&gt;post_name =&gt; edd_get_download_earnings_stats( $args['product'] ) );&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $error['error'] = sprintf( __( 'Product %s not found!', 'edd' ), $args['product'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $error ) )&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $earnings;&nbsp;</div></li><li><div>        } elseif ( $args['type'] == 'customers' ) {&nbsp;</div></li><li><div>            global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stats = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $count = $wpdb-&gt;get_col( &quot;SELECT COUNT(DISTINCT meta_value) FROM $wpdb-&gt;postmeta WHERE meta_key = '_edd_payment_user_email'&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $stats['customers']['total_customers'] = $count[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $stats;&nbsp;</div></li><li><div>        } elseif ( empty( $args['type'] ) ) {&nbsp;</div></li><li><div>            $stats = array_merge( $stats, $this-&gt;get_default_sales_stats() );&nbsp;</div></li><li><div>            $stats = array_merge ( $stats, $this-&gt;get_default_earnings_stats() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return array( 'stats' =&gt; $stats );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieves Recent Sales&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since  1.5&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_recent_sales() {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sales = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'view_shop_reports' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $sales;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( isset( $wp_query-&gt;query_vars['id'] ) ) {&nbsp;</div></li><li><div>            $query = array();&nbsp;</div></li><li><div>            $query[] = edd_get_payment_by( 'id', $wp_query-&gt;query_vars['id'] );&nbsp;</div></li><li><div>        } elseif( isset( $wp_query-&gt;query_vars['purchasekey'] ) ) {&nbsp;</div></li><li><div>            $query = array();&nbsp;</div></li><li><div>            $query[] = edd_get_payment_by( 'key', $wp_query-&gt;query_vars['purchasekey'] );&nbsp;</div></li><li><div>        } elseif( isset( $wp_query-&gt;query_vars['email'] ) ) {&nbsp;</div></li><li><div>            $query = edd_get_payments( array( 'meta_key' =&gt; '_edd_payment_user_email', 'meta_value' =&gt; $wp_query-&gt;query_vars['email'], 'number' =&gt; $this-&gt;per_page(), 'page' =&gt; $this-&gt;get_paged(), 'status' =&gt; 'publish' ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $query = edd_get_payments( array( 'number' =&gt; $this-&gt;per_page(), 'page' =&gt; $this-&gt;get_paged(), 'status' =&gt; 'publish' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $query ) {&nbsp;</div></li><li><div>            $i = 0;&nbsp;</div></li><li><div>            foreach ( $query as $payment ) {&nbsp;</div></li><li><div>                $payment_meta = edd_get_payment_meta( $payment-&gt;ID );&nbsp;</div></li><li><div>                $user_info = edd_get_payment_meta_user_info( $payment-&gt;ID );&nbsp;</div></li><li><div>                $cart_items = edd_get_payment_meta_cart_details( $payment-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['ID'] = edd_get_payment_number( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['transaction_id'] = edd_get_payment_transaction_id( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['key'] = edd_get_payment_key( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['discount'] = isset( $user_info['discount'] ) && $user_info['discount'] != 'none' ? explode( ', ', $user_info['discount'] ) : array();&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['subtotal'] = edd_get_payment_subtotal( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['tax'] = edd_get_payment_tax( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['fees'] = edd_get_payment_fees( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['total'] = edd_get_payment_amount( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['gateway'] = edd_get_payment_gateway( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['email'] = edd_get_payment_user_email( $payment-&gt;ID );&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['date'] = $payment-&gt;post_date;&nbsp;</div></li><li><div>                $sales['sales'][ $i ]['products'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $c = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $cart_items as $key =&gt; $item ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $item_id = isset( $item['id'] ) ? $item['id']    : $item;&nbsp;</div></li><li><div>                    $price = isset( $item['price'] ) ? $item['price'] : false;&nbsp;</div></li><li><div>                    $price_id = isset( $item['item_number']['options']['price_id'] ) ? $item['item_number']['options']['price_id'] : null;&nbsp;</div></li><li><div>                    $quantity = isset( $item['quantity'] ) && $item['quantity'] &gt; 0 ? $item['quantity'] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if( ! $price ) {&nbsp;</div></li><li><div>                        // This function is only used on payments with near 1.0 cart data structure&nbsp;</div></li><li><div>                        $price = edd_get_download_final_price( $item_id, $user_info, null );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $price_name = '';&nbsp;</div></li><li><div>                    if ( isset( $item['item_number'] ) && isset( $item['item_number']['options'] ) ) {&nbsp;</div></li><li><div>                        $price_options = $item['item_number']['options'];&nbsp;</div></li><li><div>                        if ( isset( $price_options['price_id'] ) ) {&nbsp;</div></li><li><div>                            $price_name = edd_get_price_option_name( $item['id'], $price_options['price_id'], $payment-&gt;ID );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['quantity'] = $quantity;&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['name'] = get_the_title( $item['id'] );&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['price'] = $price;&nbsp;</div></li><li><div>                    $sales['sales'][ $i ]['products'][ $c ]['price_name'] = $price_name;&nbsp;</div></li><li><div>                    $c++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $sales;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process Get Discounts API Request&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.6&nbsp;</div></li><li><div>     * @global object $wpdb Used to query the database using the WordPress&nbsp;</div></li><li><div>     *   Database API&nbsp;</div></li><li><div>     * @param int $discount Discount ID&nbsp;</div></li><li><div>     * @return array $discounts Multidimensional array of the discounts&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_discounts( $discount = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $discount_list = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! user_can( $this-&gt;user_id, 'manage_shop_discounts' ) && ! $this-&gt;override ) {&nbsp;</div></li><li><div>            return $discount_list;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $error = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $discount ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $paged = $this-&gt;get_paged();&nbsp;</div></li><li><div>            $per_page = $this-&gt;per_page();&nbsp;</div></li><li><div>            $discounts = edd_get_discounts( array( 'posts_per_page' =&gt; $per_page, 'paged' =&gt; $paged ) );&nbsp;</div></li><li><div>            $count = 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $discounts ) ) {&nbsp;</div></li><li><div>                $error['error'] = __( 'No discounts found!', 'edd' );&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $discounts as $discount ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['ID'] = $discount-&gt;ID;&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['name'] = $discount-&gt;post_title;&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['code'] = edd_get_discount_code( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['amount'] = edd_get_discount_amount( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['min_price'] = edd_get_discount_min_price( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['type'] = edd_get_discount_type( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['uses'] = edd_get_discount_uses( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['max_uses'] = edd_get_discount_max_uses( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['start_date'] = edd_get_discount_start_date( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['exp_date'] = edd_get_discount_expiration( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['status'] = $discount-&gt;post_status;&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['product_requirements'] = edd_get_discount_product_reqs( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['requirement_condition'] = edd_get_discount_product_condition( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['global_discount'] = edd_is_discount_not_global( $discount-&gt;ID );&nbsp;</div></li><li><div>                $discount_list['discounts'][$count]['single_use'] = edd_discount_is_single_use( $discount-&gt;ID );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $count++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_numeric( $discount ) && get_post( $discount ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['ID'] = $discount;&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['name'] = get_post_field( 'post_title', $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['code'] = edd_get_discount_code( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['amount'] = edd_get_discount_amount( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['min_price'] = edd_get_discount_min_price( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['type'] = edd_get_discount_type( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['uses'] = edd_get_discount_uses( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['max_uses'] = edd_get_discount_max_uses( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['start_date'] = edd_get_discount_start_date( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['exp_date'] = edd_get_discount_expiration( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['status'] = get_post_field( 'post_status', $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['product_requirements'] = edd_get_discount_product_reqs( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['requirement_condition'] = edd_get_discount_product_condition( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['global_discount'] = edd_is_discount_not_global( $discount );&nbsp;</div></li><li><div>                $discount_list['discounts'][0]['single_use'] = edd_discount_is_single_use( $discount );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $error['error'] = sprintf( __( 'Discount %s not found!', 'edd' ), $discount );&nbsp;</div></li><li><div>                return $error;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $discount_list;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Log each API request, if enabled&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since  1.5&nbsp;</div></li><li><div>     * @global $edd_logs&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     * @param array $data&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function log_request( $data = array() ) {&nbsp;</div></li><li><div>        if ( ! $this-&gt;log_requests )&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $edd_logs, $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query = array(&nbsp;</div></li><li><div>            'edd-api' =&gt; $wp_query-&gt;query_vars['edd-api'], &nbsp;</div></li><li><div>            'key' =&gt; $wp_query-&gt;query_vars['key'], &nbsp;</div></li><li><div>            'token' =&gt; $wp_query-&gt;query_vars['token'], &nbsp;</div></li><li><div>            'query' =&gt; isset( $wp_query-&gt;query_vars['query'] )       ? $wp_query-&gt;query_vars['query']       : null, &nbsp;</div></li><li><div>            'type' =&gt; isset( $wp_query-&gt;query_vars['type'] )        ? $wp_query-&gt;query_vars['type']        : null, &nbsp;</div></li><li><div>            'product' =&gt; isset( $wp_query-&gt;query_vars['product'] )     ? $wp_query-&gt;query_vars['product']     : null, &nbsp;</div></li><li><div>            'customer' =&gt; isset( $wp_query-&gt;query_vars['customer'] )    ? $wp_query-&gt;query_vars['customer']    : null, &nbsp;</div></li><li><div>            'date' =&gt; isset( $wp_query-&gt;query_vars['date'] )        ? $wp_query-&gt;query_vars['date']        : null, &nbsp;</div></li><li><div>            'startdate' =&gt; isset( $wp_query-&gt;query_vars['startdate'] )   ? $wp_query-&gt;query_vars['startdate']   : null, &nbsp;</div></li><li><div>            'enddate' =&gt; isset( $wp_query-&gt;query_vars['enddate'] )     ? $wp_query-&gt;query_vars['enddate']     : null, &nbsp;</div></li><li><div>            'id' =&gt; isset( $wp_query-&gt;query_vars['id'] )          ? $wp_query-&gt;query_vars['id']          : null, &nbsp;</div></li><li><div>            'purchasekey' =&gt; isset( $wp_query-&gt;query_vars['purchasekey'] ) ? $wp_query-&gt;query_vars['purchasekey'] : null, &nbsp;</div></li><li><div>            'email' =&gt; isset( $wp_query-&gt;query_vars['email'] )       ? $wp_query-&gt;query_vars['email']       : null, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $log_data = array(&nbsp;</div></li><li><div>            'log_type' =&gt; 'api_request', &nbsp;</div></li><li><div>            'post_excerpt' =&gt; http_build_query( $query ), &nbsp;</div></li><li><div>            'post_content' =&gt; ! empty( $data['error'] ) ? $data['error'] : '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $log_meta = array(&nbsp;</div></li><li><div>            'request_ip' =&gt; edd_get_ip(), &nbsp;</div></li><li><div>            'user' =&gt; $this-&gt;user_id, &nbsp;</div></li><li><div>            'key' =&gt; $wp_query-&gt;query_vars['key'], &nbsp;</div></li><li><div>            'token' =&gt; $wp_query-&gt;query_vars['token']&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $edd_logs-&gt;insert_log( $log_data, $log_meta );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the output data&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 1.5.2&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function get_output() {&nbsp;</div></li><li><div>        return $this-&gt;data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Output Query in either JSON/XML. The query data is outputted as JSON&nbsp;</div></li><li><div>     * by default&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @global $wp_query&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param int $status_code&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function output( $status_code = 200 ) {&nbsp;</div></li><li><div>        global $wp_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = $this-&gt;get_output_format();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        status_header( $status_code );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'edd_api_output_before', $this-&gt;data, $this, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $format ) :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'xml' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                require_once EDD_PLUGIN_DIR . 'includes/libraries/array2xml.php';&nbsp;</div></li><li><div>                $xml = Array2XML::createXML( 'edd', $this-&gt;data );&nbsp;</div></li><li><div>                echo $xml-&gt;saveXML();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'json' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                header( 'Content-Type: application/json' );&nbsp;</div></li><li><div>                if ( ! empty( $this-&gt;pretty_print ) )&nbsp;</div></li><li><div>                    echo json_encode( $this-&gt;data, $this-&gt;pretty_print );&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    echo json_encode( $this-&gt;data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // Allow other formats to be added via extensions&nbsp;</div></li><li><div>                do_action( 'edd_api_output_' . $format, $this-&gt;data, $this );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        endswitch;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'edd_api_output_after', $this-&gt;data, $this, $format );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        edd_die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Modify User Profile&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Modifies the output of profile.php to add key generation/revocation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @param object $user Current user info&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function user_key_field( $user ) {&nbsp;</div></li><li><div>        if ( ( edd_get_option( 'api_allow_user_keys', false ) || current_user_can( 'manage_shop_settings' ) ) && current_user_can( 'edit_user', $user-&gt;ID ) ) {&nbsp;</div></li><li><div>            $user = get_userdata( $user-&gt;ID );&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>            &lt;table class=&quot;form-table&quot;&gt;&nbsp;</div></li><li><div>                &lt;tbody&gt;&nbsp;</div></li><li><div>                    &lt;tr&gt;&nbsp;</div></li><li><div>                        &lt;th&gt;&nbsp;</div></li><li><div>                            &lt;label for=&quot;edd_set_api_key&quot;&gt;&lt;?php _e( 'Easy Digital Downloads API Keys', 'edd' ); ?&gt;&lt;/label&gt;&nbsp;</div></li><li><div>                        &lt;/th&gt;&nbsp;</div></li><li><div>                        &lt;td&gt;&nbsp;</div></li><li><div>                            &lt;?php if ( empty( $user-&gt;edd_user_public_key ) ) { ?&gt;&nbsp;</div></li><li><div>                                &lt;input name=&quot;edd_set_api_key&quot; type=&quot;checkbox&quot; id=&quot;edd_set_api_key&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>                                &lt;span class=&quot;description&quot;&gt;&lt;?php _e( 'Generate API Key', 'edd' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                            &lt;?php } else { ?&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e( 'Public key:', 'edd' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;span id=&quot;publickey&quot;&gt;&lt;?php echo $user-&gt;edd_user_public_key; ?&gt;&lt;/span&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e( 'Secret key:', 'edd' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;span id=&quot;privatekey&quot;&gt;&lt;?php echo $user-&gt;edd_user_secret_key; ?&gt;&lt;/span&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;strong&gt;&lt;?php _e( 'Token:', 'edd' ); ?&gt;&nbsp;&lt;/strong&gt;&lt;span id=&quot;token&quot;&gt;&lt;?php echo $this-&gt;get_token( $user-&gt;ID ); ?&gt;&lt;/span&gt;&lt;br/&gt;&nbsp;</div></li><li><div>                                &lt;input name=&quot;edd_set_api_key&quot; type=&quot;checkbox&quot; id=&quot;edd_set_api_key&quot; value=&quot;0&quot; /&gt;&nbsp;</div></li><li><div>                                &lt;span class=&quot;description&quot;&gt;&lt;?php _e( 'Revoke API Keys', 'edd' ); ?&gt;&lt;/span&gt;&nbsp;</div></li><li><div>                            &lt;?php } ?&gt;&nbsp;</div></li><li><div>                        &lt;/td&gt;&nbsp;</div></li><li><div>                    &lt;/tr&gt;&nbsp;</div></li><li><div>                &lt;/tbody&gt;&nbsp;</div></li><li><div>            &lt;/table&gt;&nbsp;</div></li><li><div>        &lt;?php }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Process an API key generation/revocation&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.0.0&nbsp;</div></li><li><div>     * @param array $args&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function process_api_key( $args ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! wp_verify_nonce( $_REQUEST['_wpnonce'], 'edd-api-nonce' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            wp_die( __( 'Nonce verification failed', 'edd' ), __( 'Error', 'edd' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( is_numeric( $args['user_id'] ) ) {&nbsp;</div></li><li><div>            $user_id = isset( $args['user_id'] ) ? absint( $args['user_id'] ) : get_current_user_id();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $userdata = get_user_by( 'login', $args['user_id'] );&nbsp;</div></li><li><div>            $user_id = $userdata-&gt;ID;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $process = isset( $args['edd_api_process'] ) ? strtolower( $args['edd_api_process'] ) : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( $user_id == get_current_user_id() && ! edd_get_option( 'allow_user_api_keys' ) && ! current_user_can( 'manage_shop_settings' ) ) {&nbsp;</div></li><li><div>            wp_die( sprintf( __( 'You do not have permission to %s API keys for this user', 'edd' ), $process ), __( 'Error', 'edd' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>        } elseif( ! current_user_can( 'manage_shop_settings' ) ) {&nbsp;</div></li><li><div>            wp_die( sprintf( __( 'You do not have permission to %s API keys for this user', 'edd' ), $process ), __( 'Error', 'edd' ), array( 'response' =&gt; 403 ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch( $process ) {&nbsp;</div></li><li><div>            case 'generate':&nbsp;</div></li><li><div>                if( $this-&gt;generate_api_key( $user_id ) ) {&nbsp;</div></li><li><div>                    delete_transient( 'edd-total-api-keys' );&nbsp;</div></li><li><div>                    wp_redirect( add_query_arg( 'edd-message', 'api-key-generated', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    wp_redirect( add_query_arg( 'edd-message', 'api-key-failed', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'regenerate':&nbsp;</div></li><li><div>                $this-&gt;generate_api_key( $user_id, true );&nbsp;</div></li><li><div>                delete_transient( 'edd-total-api-keys' );&nbsp;</div></li><li><div>                wp_redirect( add_query_arg( 'edd-message', 'api-key-regenerated', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'revoke':&nbsp;</div></li><li><div>                $this-&gt;revoke_api_key( $user_id );&nbsp;</div></li><li><div>                delete_transient( 'edd-total-api-keys' );&nbsp;</div></li><li><div>                wp_redirect( add_query_arg( 'edd-message', 'api-key-revoked', 'edit.php?post_type=download&page=edd-tools&tab=api_keys' ) ); exit();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate new API keys for a user&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.0.0&nbsp;</div></li><li><div>     * @param int $user_id User ID the key is being generated for&nbsp;</div></li><li><div>     * @param boolean $regenerate Regenerate the key for the user&nbsp;</div></li><li><div>     * @return boolean True if (re)generated succesfully, false otherwise.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function generate_api_key( $user_id = 0, $regenerate = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $user_id ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! $user ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $user-&gt;edd_user_public_key ) ) {&nbsp;</div></li><li><div>            update_user_meta( $user_id, 'edd_user_public_key', $this-&gt;generate_public_key( $user-&gt;user_email ) );&nbsp;</div></li><li><div>            update_user_meta( $user_id, 'edd_user_secret_key', $this-&gt;generate_private_key( $user-&gt;ID ) );&nbsp;</div></li><li><div>        } elseif( $regenerate == true ) {&nbsp;</div></li><li><div>            $this-&gt;revoke_api_key( $user-&gt;ID );&nbsp;</div></li><li><div>            update_user_meta( $user_id, 'edd_user_public_key', $this-&gt;generate_public_key( $user-&gt;user_email ) );&nbsp;</div></li><li><div>            update_user_meta( $user_id, 'edd_user_secret_key', $this-&gt;generate_private_key( $user-&gt;ID ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Revoke a users API keys&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @since 2.0.0&nbsp;</div></li><li><div>     * @param int $user_id User ID of user to revoke key for&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function revoke_api_key( $user_id = 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( empty( $user_id ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if( ! $user ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $user-&gt;edd_user_public_key ) ) {&nbsp;</div></li><li><div>            delete_transient( md5( 'edd_api_user_' . $user-&gt;edd_user_public_key ) );&nbsp;</div></li><li><div>            delete_user_meta( $user_id, 'edd_user_public_key' );&nbsp;</div></li><li><div>            delete_user_meta( $user_id, 'edd_user_secret_key' );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate and Save API key&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * Generates the key requested by user_key_field and stores it in the database&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access public&nbsp;</div></li><li><div>     * @author Daniel J Griffiths&nbsp;</div></li><li><div>     * @since 1.5&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function update_key( $user_id ) {&nbsp;</div></li><li><div>        if ( current_user_can( 'edit_user', $user_id ) && isset( $_POST['edd_set_api_key'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $user = get_userdata( $user_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $user-&gt;edd_user_public_key ) ) {&nbsp;</div></li><li><div>                update_user_meta( $user_id, 'edd_user_public_key', $this-&gt;generate_public_key( $user-&gt;user_email ) );&nbsp;</div></li><li><div>                update_user_meta( $user_id, 'edd_user_secret_key', $this-&gt;generate_private_key( $user-&gt;ID ) );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;revoke_api_key( $user_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the public key for a user&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.9.9&nbsp;</div></li><li><div>     * @param string $user_email&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function generate_public_key( $user_email = '' ) {&nbsp;</div></li><li><div>        $auth_key = defined( 'AUTH_KEY' ) ? AUTH_KEY : '';&nbsp;</div></li><li><div>        $public = hash( 'md5', $user_email . $auth_key . date( 'U' ) );&nbsp;</div></li><li><div>        return $public;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the secret key for a user&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.9.9&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function generate_private_key( $user_id = 0 ) {&nbsp;</div></li><li><div>        $auth_key = defined( 'AUTH_KEY' ) ? AUTH_KEY : '';&nbsp;</div></li><li><div>        $secret = hash( 'md5', $user_id . $auth_key . date( 'U' ) );&nbsp;</div></li><li><div>        return $secret;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Retrieve the user's token&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.9.9&nbsp;</div></li><li><div>     * @param int $user_id&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_token( $user_id = 0 ) {&nbsp;</div></li><li><div>        $user = get_userdata( $user_id );&nbsp;</div></li><li><div>        return hash( 'md5', $user-&gt;edd_user_secret_key . $user-&gt;edd_user_public_key );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the default sales stats returned by the 'stats' endpoint&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.3&nbsp;</div></li><li><div>     * @return array default sales statistics&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_default_sales_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Default sales return&nbsp;</div></li><li><div>        $sales = array();&nbsp;</div></li><li><div>        $sales['sales']['today'] = $this-&gt;stats-&gt;get_sales( 0, 'today' );&nbsp;</div></li><li><div>        $sales['sales']['current_month'] = $this-&gt;stats-&gt;get_sales( 0, 'this_month' );&nbsp;</div></li><li><div>        $sales['sales']['last_month'] = $this-&gt;stats-&gt;get_sales( 0, 'last_month' );&nbsp;</div></li><li><div>        $sales['sales']['totals'] = edd_get_total_sales();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sales;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate the default earnings stats returned by the 'stats' endpoint&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @access private&nbsp;</div></li><li><div>     * @since 1.5.3&nbsp;</div></li><li><div>     * @return array default earnings statistics&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function get_default_earnings_stats() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Default earnings return&nbsp;</div></li><li><div>        $earnings = array();&nbsp;</div></li><li><div>        $earnings['earnings']['today'] = $this-&gt;stats-&gt;get_earnings( 0, 'today' );&nbsp;</div></li><li><div>        $earnings['earnings']['current_month'] = $this-&gt;stats-&gt;get_earnings( 0, 'this_month' );&nbsp;</div></li><li><div>        $earnings['earnings']['last_month'] = $this-&gt;stats-&gt;get_earnings( 0, 'last_month' );&nbsp;</div></li><li><div>        $earnings['earnings']['totals'] = edd_get_total_earnings();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $earnings;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 1.5</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.8/classes/edd_api/" class="active">2.7.8</a></li><li><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.7/classes/edd_api/" class="">2.7.7</a></li><li><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.6/classes/edd_api/" class="">2.7.6</a></li><li><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.5/classes/edd_api/" class="">2.7.5</a></li><li><a href="http://hookr.io/plugins/easy-digital-downloads/2.7.4/classes/edd_api/" class="">2.7.4</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>EDD_API</li><li><span></span>Easy Digital Downloads</li><li><span></span>2.7.8</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>