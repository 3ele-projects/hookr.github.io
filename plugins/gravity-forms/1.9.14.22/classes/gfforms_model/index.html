<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.9.14.22" data-slug="gravity-forms" data-type="class" data-id="72800"><head xmlns="http://www.w3.org/1999/xhtml"><title> gfformsmodel | class | Gravity Forms | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="GFFormsModel, class, plugin, gravity-forms, 1.9.14.22" /><meta name="description" content="The Gravity Forms GFFormsModel class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=456ce1d54fd7cc0f7188aa43ef5b1b41' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/gfforms_model/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfforms_model%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfforms_model%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-gravity-forms-1.9.14.22-class-gfforms_model","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gfforms_model" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms." href="http://hookr.io/plugins/gravity-forms/" class="plugin"><span property="name">gravity-forms</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.14.22." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/" class="H_VERSION"><span property="name">1.9.14.22</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gfforms_model</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="793"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/all/" title="All">All <span class="count badge">793</span></a></li><li class="" data-id="new" data-count="458"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/new/" title="New">New <span class="count badge">458</span></a></li><li class="" data-id="hooks" data-count="603"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/hooks/" title="Hooks">Hooks <span class="count badge">603</span></a></li><li class="" data-id="action" data-count="198"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/actions/" title="Actions">Actions <span class="count badge">198</span></a></li><li class="" data-id="filter" data-count="405"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/filters/" title="Filters">Filters <span class="count badge">405</span></a></li><li class="active" data-id="class" data-count="107"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/" title="Classes">Classes <span class="count badge">107</span></a></li><li class="" data-id="constant" data-count="48"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/constants/" title="Constants">Constants <span class="count badge">48</span></a></li><li class="" data-id="function" data-count="33"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/functions/" title="Functions">Functions <span class="count badge">33</span></a></li><li class="" data-id="shortcode" data-count="2"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">2</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>GFFormsModel</strong></h1><p>The Gravity Forms <strong>GFFormsModel</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/files/forms-model/" class="file">/forms_model.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="12" class="block" start="12"><li><div>class GFFormsModel {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static $uploaded_files = array();&nbsp;</div></li><li><div>    public static $unique_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static $_confirmations = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * An in-memory cache for the form meta for the current blog.&nbsp;</div></li><li><div>     *  Use &quot;{Blog ID}_{Form ID}&quot; as the key.&nbsp;</div></li><li><div>     *  Example: $_current_forms['1_2']&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @var array $_current_forms&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static $_current_forms = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static $_current_lead = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function flush_current_forms() {&nbsp;</div></li><li><div>        self::$_current_forms = null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function flush_current_lead() {&nbsp;</div></li><li><div>        self::$_current_lead = null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function flush_confirmations() {&nbsp;</div></li><li><div>        self::$_confirmations = null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_form';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_meta_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_form_meta';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_view_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_form_view';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_lead';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_meta_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_lead_meta';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_notes_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_lead_notes';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_details_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_lead_detail';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_details_long_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_lead_detail_long';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_view_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_lead_view';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_incomplete_submissions_table_name() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;prefix . 'rg_incomplete_submissions';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_forms( $is_active = null, $sort_column = 'title', $sort_dir = 'ASC', $is_trash = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>        $view_table_name = self::get_form_view_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where_arr = array();&nbsp;</div></li><li><div>        $where_arr[] = $wpdb-&gt;prepare( 'is_trash=%d', $is_trash );&nbsp;</div></li><li><div>        if ( $is_active !== null ) {&nbsp;</div></li><li><div>            $where_arr[] = $wpdb-&gt;prepare( 'is_active=%d', $is_active );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where_clause = 'WHERE ' . join( ' AND ', $where_arr );&nbsp;</div></li><li><div>        $sort_keyword = $sort_dir == 'ASC' ? 'ASC' : 'DESC';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $db_columns = self::get_form_db_columns();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! in_array( strtolower( $sort_column ), $db_columns ) ) {&nbsp;</div></li><li><div>            $sort_column = 'title';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $order_by = ! empty( $sort_column ) ? &quot;ORDER BY $sort_column $sort_keyword&quot; : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT f.id, f.title, f.date_created, f.is_active, 0 as lead_count, 0 view_count&nbsp;</div></li><li><div>                FROM $form_table_name f&nbsp;</div></li><li><div>                $where_clause&nbsp;</div></li><li><div>                $order_by&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Getting all forms&nbsp;</div></li><li><div>        $forms = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Getting entry count per form&nbsp;</div></li><li><div>        $sql = &quot;SELECT form_id, count(id) as lead_count FROM $lead_table_name l WHERE status='active' GROUP BY form_id&quot;;&nbsp;</div></li><li><div>        $entry_count = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Getting view count per form&nbsp;</div></li><li><div>        $sql = &quot;SELECT form_id, sum(count) as view_count FROM $view_table_name GROUP BY form_id&quot;;&nbsp;</div></li><li><div>        $view_count = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Adding entry counts and to form array&nbsp;</div></li><li><div>        foreach ( $forms as &$form ) {&nbsp;</div></li><li><div>            foreach ( $view_count as $count ) {&nbsp;</div></li><li><div>                if ( $count-&gt;form_id == $form-&gt;id ) {&nbsp;</div></li><li><div>                    $form-&gt;view_count = $count-&gt;view_count;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $entry_count as $count ) {&nbsp;</div></li><li><div>                if ( $count-&gt;form_id == $form-&gt;id ) {&nbsp;</div></li><li><div>                    $form-&gt;lead_count = $count-&gt;lead_count;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $forms;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_db_columns() {&nbsp;</div></li><li><div>        return array( 'id', 'title', 'date_created', 'is_active', 'is_trash' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_forms_by_id( $ids ) {&nbsp;</div></li><li><div>        _deprecated_function( 'get_forms_by_id', '1.7', 'get_form_meta_by_id' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::get_form_meta_by_id( $ids );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_payment_totals( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; SELECT sum(payment_amount) revenue, count(l.id) orders&nbsp;</div></li><li><div>             FROM $lead_table_name l&nbsp;</div></li><li><div>             WHERE form_id=%d AND payment_amount IS NOT null&quot;, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $totals = $wpdb-&gt;get_row( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $active = $wpdb-&gt;get_var(&nbsp;</div></li><li><div>            $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                &quot; SELECT count(id) as active&nbsp;</div></li><li><div>                 FROM $lead_table_name&nbsp;</div></li><li><div>                 WHERE form_id=%d AND payment_status='Active'&quot;, $form_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $active ) ) {&nbsp;</div></li><li><div>            $active = 0;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $totals['active'] = $active;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $totals;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_counts( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot;SELECT&nbsp;</div></li><li><div>                    (SELECT count(DISTINCT(l.id)) FROM $lead_table_name l INNER JOIN $lead_detail_table_name ld ON l.id=ld.lead_id WHERE l.form_id=%d AND l.status='active') as total, &nbsp;</div></li><li><div>                    (SELECT count(DISTINCT(l.id)) FROM $lead_table_name l INNER JOIN $lead_detail_table_name ld ON l.id=ld.lead_id WHERE l.is_read=0 AND l.status='active' AND l.form_id=%d) as unread, &nbsp;</div></li><li><div>                    (SELECT count(DISTINCT(l.id)) FROM $lead_table_name l INNER JOIN $lead_detail_table_name ld ON l.id=ld.lead_id WHERE l.is_starred=1 AND l.status='active' AND l.form_id=%d) as starred, &nbsp;</div></li><li><div>                    (SELECT count(DISTINCT(l.id)) FROM $lead_table_name l INNER JOIN $lead_detail_table_name ld ON l.id=ld.lead_id WHERE l.status='spam' AND l.form_id=%d) as spam, &nbsp;</div></li><li><div>                    (SELECT count(DISTINCT(l.id)) FROM $lead_table_name l INNER JOIN $lead_detail_table_name ld ON l.id=ld.lead_id WHERE l.status='trash' AND l.form_id=%d) as trash&quot;, &nbsp;</div></li><li><div>            $form_id, $form_id, $form_id, $form_id, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $results[0];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_summary() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT l.form_id, count(l.id) as unread_count&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                WHERE is_read=0 AND status='active'&nbsp;</div></li><li><div>                GROUP BY form_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //getting number of unread and total leads for all forms&nbsp;</div></li><li><div>        $unread_results = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT l.form_id, max(l.date_created) as last_lead_date, count(l.id) as total_leads&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                WHERE status='active'&nbsp;</div></li><li><div>                GROUP BY form_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_date_results = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT id, title, '' as last_lead_date, 0 as unread_count&nbsp;</div></li><li><div>                FROM $form_table_name&nbsp;</div></li><li><div>                WHERE is_active=1&nbsp;</div></li><li><div>                ORDER BY title&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $forms = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        for ( $i = 0; $count = sizeof( $forms ), $i &lt; $count; $i ++ ) {&nbsp;</div></li><li><div>            if ( is_array( $unread_results ) ) {&nbsp;</div></li><li><div>                foreach ( $unread_results as $unread_result ) {&nbsp;</div></li><li><div>                    if ( $unread_result['form_id'] == $forms[ $i ]['id'] ) {&nbsp;</div></li><li><div>                        $forms[ $i ]['unread_count'] = $unread_result['unread_count'];&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $lead_date_results ) ) {&nbsp;</div></li><li><div>                foreach ( $lead_date_results as $lead_date_result ) {&nbsp;</div></li><li><div>                    if ( $lead_date_result['form_id'] == $forms[ $i ]['id'] ) {&nbsp;</div></li><li><div>                        $forms[ $i ]['last_lead_date'] = $lead_date_result['last_lead_date'];&nbsp;</div></li><li><div>                        $forms[ $i ]['total_leads'] = $lead_date_result['total_leads'];&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $forms;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_count() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results(&nbsp;</div></li><li><div>            &quot;&nbsp;</div></li><li><div>            SELECT&nbsp;</div></li><li><div>            (SELECT count(0) FROM $form_table_name WHERE is_trash = 0) as total, &nbsp;</div></li><li><div>            (SELECT count(0) FROM $form_table_name WHERE is_active=1 AND is_trash = 0 ) as active, &nbsp;</div></li><li><div>            (SELECT count(0) FROM $form_table_name WHERE is_active=0 AND is_trash = 0 ) as inactive, &nbsp;</div></li><li><div>            (SELECT count(0) FROM $form_table_name WHERE is_trash=1) as trash&nbsp;</div></li><li><div>            &quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            'total' =&gt; intval( $results[0]-&gt;total ), &nbsp;</div></li><li><div>            'active' =&gt; intval( $results[0]-&gt;active ), &nbsp;</div></li><li><div>            'inactive' =&gt; intval( $results[0]-&gt;inactive ), &nbsp;</div></li><li><div>            'trash' =&gt; intval( $results[0]-&gt;trash )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_id( $form_title ) {&nbsp;</div></li><li><div>        $forms = self::get_forms();&nbsp;</div></li><li><div>        foreach ( $forms as $form ) {&nbsp;</div></li><li><div>            $sanitized_name = str_replace( '[', '', str_replace( ']', '', $form-&gt;title ) );&nbsp;</div></li><li><div>            if ( $form-&gt;title == $form_title || $sanitized_name == $form_title ) {&nbsp;</div></li><li><div>                return $form-&gt;id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form( $form_id, $allow_trash = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $trash_clause = $allow_trash ? '' : 'AND is_trash = 0';&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT * FROM $table_name WHERE id=%d {$trash_clause}&quot;, $form_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return isset( $results[0] ) ? $results[0] : false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function unserialize( $string ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_serialized( $string ) ) {&nbsp;</div></li><li><div>            $obj = @unserialize( $string );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $obj = json_decode( $string, true );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $obj;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_meta( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = get_current_blog_id() . '_' . $form_id;&nbsp;</div></li><li><div>        // return cached version if form meta has been previously retrieved for this form&nbsp;</div></li><li><div>        if ( isset( self::$_current_forms[ $key ] ) ) {&nbsp;</div></li><li><div>            return self::$_current_forms[ $key ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table_name = self::get_meta_table_name();&nbsp;</div></li><li><div>        $form_row = $wpdb-&gt;get_row( $wpdb-&gt;prepare( &quot;SELECT display_meta, notifications FROM {$table_name} WHERE form_id=%d&quot;, $form_id ), ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Loading main form object (supports serialized strings as well as JSON strings)&nbsp;</div></li><li><div>        $form = self::unserialize( $form_row['display_meta'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $form ) {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //loading notifications&nbsp;</div></li><li><div>        $form['notifications'] = self::unserialize( $form_row['notifications'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creating field objects and copying some form variables down to fields for easier access&nbsp;</div></li><li><div>        $form = self::convert_field_objects( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // loading confirmations from legacy structure into new structure&nbsp;</div></li><li><div>        $form = self::load_confirmations( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //only migrate legacy notification if there isn't any notification configured in new structure&nbsp;</div></li><li><div>        if ( ! isset( $form['notifications'] ) ) {&nbsp;</div></li><li><div>            $form = self::load_notifications_from_legacy( $form ); //moving notification data from legacy structure into new 'notifications' array&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //load notifications to legacy structure to maintain backward compatibility with legacy hooks and functions&nbsp;</div></li><li><div>        $form = self::load_notifications_to_legacy( $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = gf_apply_filters( array( 'gform_form_post_get_meta', $form_id ), $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // cached form meta for cheaper retrieval on subsequent requests&nbsp;</div></li><li><div>        self::$_current_forms[ $key ] = $form;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function convert_field_objects( $form ) {&nbsp;</div></li><li><div>        $page_number = 1;&nbsp;</div></li><li><div>        if ( is_array( rgar( $form, 'fields' ) ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as &$field ) {&nbsp;</div></li><li><div>                $field = GF_Fields::create( $field );&nbsp;</div></li><li><div>                if ( isset( $form['id'] ) ) {&nbsp;</div></li><li><div>                    $field-&gt;formId = $form['id'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $field-&gt;pageNumber = $page_number;&nbsp;</div></li><li><div>                if ( $field-&gt;type == 'page' ) {&nbsp;</div></li><li><div>                    $page_number ++;&nbsp;</div></li><li><div>                    $field-&gt;pageNumber = $page_number;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_meta_by_id( $ids ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $meta_table_name = self::get_meta_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $ids ) ) {&nbsp;</div></li><li><div>            $ids = implode( ', ', array_map( 'intval', $ids ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $ids = intval( $ids );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results(&nbsp;</div></li><li><div>            &quot; SELECT display_meta, confirmations, notifications FROM {$form_table_name} f&nbsp;</div></li><li><div>                                        INNER JOIN {$meta_table_name} m ON f.id = m.form_id&nbsp;</div></li><li><div>                                        WHERE id in({$ids})&quot;, ARRAY_A&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $results as &$result ) {&nbsp;</div></li><li><div>            $form = self::unserialize( $result['display_meta'] );&nbsp;</div></li><li><div>            $form['confirmations'] = self::unserialize( $result['confirmations'] );&nbsp;</div></li><li><div>            $form['notifications'] = self::unserialize( $result['notifications'] );&nbsp;</div></li><li><div>            //creating field objects and copying some form variables down to fields for easier access&nbsp;</div></li><li><div>            $form = self::convert_field_objects( $form );&nbsp;</div></li><li><div>            $result = $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $results;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function load_notifications_to_legacy( $form ) {&nbsp;</div></li><li><div>        if ( ! is_array( rgar( $form, 'notifications' ) ) ) {&nbsp;</div></li><li><div>            return $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['notifications'] as $notification ) {&nbsp;</div></li><li><div>            if ( ! in_array( rgar( $notification, 'type' ), array( 'user', 'admin' ) ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $legacy_notification = $notification;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $notification['toType'] == 'field' ) {&nbsp;</div></li><li><div>                $legacy_notification['toField'] = $notification['to'];&nbsp;</div></li><li><div>                unset( $legacy_notification['to'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //unsetting new properties&nbsp;</div></li><li><div>            unset( $legacy_notification['toType'] );&nbsp;</div></li><li><div>            unset( $legacy_notification['id'] );&nbsp;</div></li><li><div>            unset( $legacy_notification['event'] );&nbsp;</div></li><li><div>            unset( $legacy_notification['name'] );&nbsp;</div></li><li><div>            if ( isset( $legacy_notification['type'] ) ) {&nbsp;</div></li><li><div>                unset( $legacy_notification['type'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //saving into form object&nbsp;</div></li><li><div>            $property = $notification['type'] == 'user' ? 'autoResponder' : 'notification';&nbsp;</div></li><li><div>            $form[ $property ] = $legacy_notification;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function load_notifications_from_legacy( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['notifications'] = array();&nbsp;</div></li><li><div>        if ( GFCommon::has_admin_notification( $form ) ) {&nbsp;</div></li><li><div>            $admin_notification = $form['notification'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if there is a fromField configured, move it to 'from' as a merge tag&nbsp;</div></li><li><div>            $admin_notification = self::convert_property_to_merge_tag( $form, $admin_notification, 'from', 'fromField' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if there is a fromNameField configured, move it to 'fromName' as a merge tag&nbsp;</div></li><li><div>            $admin_notification = self::convert_property_to_merge_tag( $form, $admin_notification, 'fromName', 'fromNameField' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if there is a replyToField configured, move it to 'replyTo' as a merge tag&nbsp;</div></li><li><div>            $admin_notification = self::convert_property_to_merge_tag( $form, $admin_notification, 'replyTo', 'replyToField' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if routing is configured, set toType to routing, otherwise, set it to email&nbsp;</div></li><li><div>            $admin_notification['toType'] = ! rgempty( 'routing', $admin_notification ) ? 'routing' : 'email';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $notification_id = uniqid();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //assigning this notification to the form_submission action&nbsp;</div></li><li><div>            $admin_notification['event'] = 'form_submission';&nbsp;</div></li><li><div>            $admin_notification['name'] = esc_html__( 'Admin Notification', 'gravityforms' );&nbsp;</div></li><li><div>            $admin_notification['type'] = 'admin';&nbsp;</div></li><li><div>            $admin_notification['id'] = $notification_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //copying admin notification as an item in the new notifications array&nbsp;</div></li><li><div>            $form['notifications'][ $notification_id ] = $admin_notification;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( GFCommon::has_user_notification( $form ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $user_notification = $form['autoResponder'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if there is a toField configured, set toType to field, if not, set it toemail&nbsp;</div></li><li><div>            $to_field = rgar( $user_notification, 'toField' );&nbsp;</div></li><li><div>            if ( ! empty( $to_field ) ) {&nbsp;</div></li><li><div>                $user_notification['toType'] = 'field';&nbsp;</div></li><li><div>                $user_notification['to'] = $to_field;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $user_notification['toType'] = 'email';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $notification_id = uniqid();&nbsp;</div></li><li><div>            //assigning this notification to the form_submission action&nbsp;</div></li><li><div>            $user_notification['event'] = 'form_submission';&nbsp;</div></li><li><div>            $user_notification['name'] = esc_html__( 'User Notification', 'gravityforms' );&nbsp;</div></li><li><div>            $user_notification['type'] = 'user';&nbsp;</div></li><li><div>            $user_notification['id'] = $notification_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //copying user notification as an item in the new notifications array&nbsp;</div></li><li><div>            $form['notifications'][ $notification_id ] = $user_notification;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::save_form_notifications( $form['id'], $form['notifications'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function convert_property_to_merge_tag( $form, $array, $target_property, $source_property ) {&nbsp;</div></li><li><div>        $merge_tag = self::get_field_merge_tag( $form, rgar( $array, $source_property ) );&nbsp;</div></li><li><div>        if ( $merge_tag ) {&nbsp;</div></li><li><div>            $array[ $target_property ] = $merge_tag;&nbsp;</div></li><li><div>            unset( $array[ $source_property ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $array;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_field_merge_tag( $form, $field_id ) {&nbsp;</div></li><li><div>        $field = self::get_field( $form, $field_id );&nbsp;</div></li><li><div>        if ( ! $field ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return '{' . GFCommon::get_label( $field, $field_id ) . ':' . $field_id . '}';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_default_properties( $form ) {&nbsp;</div></li><li><div>        _deprecated_function( 'GFFormsModel::add_default_properties', '1.9' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( rgar( $form, 'fields' ) ) ) {&nbsp;</div></li><li><div>            $all_fields = array(&nbsp;</div></li><li><div>                'adminLabel' =&gt; '', 'adminOnly' =&gt; '', 'allowsPrepopulate' =&gt; '', 'defaultValue' =&gt; '', 'description' =&gt; '', 'content' =&gt; '', 'cssClass' =&gt; '', &nbsp;</div></li><li><div>                'errorMessage' =&gt; '', 'id' =&gt; '', 'inputName' =&gt; '', 'isRequired' =&gt; '', 'label' =&gt; '', 'noDuplicates' =&gt; '', &nbsp;</div></li><li><div>                'size' =&gt; '', 'type' =&gt; '', 'postCustomFieldName' =&gt; '', 'displayAllCategories' =&gt; '', 'displayCaption' =&gt; '', 'displayDescription' =&gt; '', &nbsp;</div></li><li><div>                'displayTitle' =&gt; '', 'inputType' =&gt; '', 'rangeMin' =&gt; '', 'rangeMax' =&gt; '', 'calendarIconType' =&gt; '', &nbsp;</div></li><li><div>                'calendarIconUrl' =&gt; '', 'dateType' =&gt; '', 'dateFormat' =&gt; '', 'phoneFormat' =&gt; '', 'addressType' =&gt; '', 'defaultCountry' =&gt; '', 'defaultProvince' =&gt; '', &nbsp;</div></li><li><div>                'defaultState' =&gt; '', 'hideAddress2' =&gt; '', 'hideCountry' =&gt; '', 'hideState' =&gt; '', 'inputs' =&gt; '', 'nameFormat' =&gt; '', 'allowedExtensions' =&gt; '', &nbsp;</div></li><li><div>                'captchaType' =&gt; '', 'pageNumber' =&gt; '', 'captchaTheme' =&gt; '', 'simpleCaptchaSize' =&gt; '', 'simpleCaptchaFontColor' =&gt; '', 'simpleCaptchaBackgroundColor' =&gt; '', &nbsp;</div></li><li><div>                'failed_validation' =&gt; '', 'productField' =&gt; '', 'enablePasswordInput' =&gt; '', 'maxLength' =&gt; '', 'enablePrice' =&gt; '', 'basePrice' =&gt; '', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $form['fields'] as &$field ) {&nbsp;</div></li><li><div>                if ( is_array( $field ) ) {&nbsp;</div></li><li><div>                    $field = wp_parse_args( $field, $all_fields );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_grid_column_meta( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table_name = self::get_meta_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return maybe_unserialize( $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT entries_grid_meta FROM $table_name WHERE form_id=%d&quot;, $form_id ) ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_grid_column_meta( $form_id, $columns ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table_name = self::get_meta_table_name();&nbsp;</div></li><li><div>        $meta = maybe_serialize( stripslashes_deep( $columns ) );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE $table_name SET entries_grid_meta=%s WHERE form_id=%d&quot;, $meta, $form_id ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_detail_id( $current_fields, $field_number ) {&nbsp;</div></li><li><div>        foreach ( $current_fields as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;field_number == $field_number ) {&nbsp;</div></li><li><div>                return $field-&gt;id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return 0;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_form_active( $form_id, $is_active ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table = self::get_form_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;UPDATE $form_table SET is_active=%d WHERE id=%d&quot;, $is_active, $form_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_active ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires after an inactive form gets marked as active&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param int $form_id The Form ID used to specify which form to activate&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'gform_post_form_activated', $form_id );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            &nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Fires after an active form gets marked as inactive&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param int $form_id The Form ID used to specify which form to activate&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            do_action( 'gform_post_form_deactivated', $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_notification_active( $form_id, $notification_id, $is_active ) {&nbsp;</div></li><li><div>        $form = GFFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $form['notifications'][ $notification_id ] ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'not_found', __( 'Notification not found', 'gravityforms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['notifications'][ $notification_id ]['isActive'] = (bool) $is_active;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( (bool) $is_active ) {&nbsp;</div></li><li><div>            do_action( 'gform_pre_notification_activated', $form['notifications'][ $notification_id ], $form );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            do_action( 'gform_pre_notification_deactivated', $form['notifications'][ $notification_id ], $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = GFFormsModel::update_form_meta( $form_id, $form['notifications'], 'notifications' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_confirmation_active( $form_id, $confirmation_id, $is_active ) {&nbsp;</div></li><li><div>        $form = GFFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $form['confirmations'][ $confirmation_id ] ) ) {&nbsp;</div></li><li><div>            return new WP_Error( 'not_found', __( 'Notification not found', 'gravityforms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['confirmations'][ $confirmation_id ]['isActive'] = (bool) $is_active;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = GFFormsModel::update_form_meta( $form_id, $form['confirmations'], 'confirmations' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_forms_active( $forms, $is_active ) {&nbsp;</div></li><li><div>        foreach ( $forms as $form_id ) {&nbsp;</div></li><li><div>            self::update_form_active( $form_id, $is_active );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_leads_property( $leads, $property_name, $property_value ) {&nbsp;</div></li><li><div>        foreach ( $leads as $lead ) {&nbsp;</div></li><li><div>            self::update_lead_property( $lead, $property_name, $property_value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_lead_property( $lead_id, $property_name, $property_value, $update_akismet = true, $disable_hook = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $lead_table = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead = self::get_lead( $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //marking entry as 'spam' or 'not spam' with Akismet if the plugin is installed&nbsp;</div></li><li><div>        if ( $update_akismet && GFCommon::akismet_enabled( $lead['form_id'] ) && $property_name == 'status' && in_array( $property_value, array( 'active', 'spam' ) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $current_status = $lead['status'];&nbsp;</div></li><li><div>            if ( $current_status == 'spam' && $property_value == 'active' ) {&nbsp;</div></li><li><div>                $form = self::get_form_meta( $lead['form_id'] );&nbsp;</div></li><li><div>                GFCommon::mark_akismet_spam( $form, $lead, false );&nbsp;</div></li><li><div>            } else if ( $current_status == 'active' && $property_value == 'spam' ) {&nbsp;</div></li><li><div>                $form = self::get_form_meta( $lead['form_id'] );&nbsp;</div></li><li><div>                GFCommon::mark_akismet_spam( $form, $lead, true );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //updating lead&nbsp;</div></li><li><div>        $result = $wpdb-&gt;update( $lead_table, array( $property_name =&gt; $property_value ), array( 'id' =&gt; $lead_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $disable_hook ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $previous_value = rgar( $lead, $property_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $previous_value != $property_value ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if property is status, prev value is spam and new value is active&nbsp;</div></li><li><div>                if ( $property_name == 'status' && $previous_value == 'spam' && $property_value == 'active' && ! rgar( $lead, 'post_id' ) ) {&nbsp;</div></li><li><div>                    $lead[ $property_name ] = $property_value;&nbsp;</div></li><li><div>                    $lead['post_id'] = GFCommon::create_post( isset( $form ) ? $form : GFAPI::get_form( $lead['form_id'] ), $lead );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                do_action( &quot;gform_update_{$property_name}&quot;, $lead_id, $property_value, $previous_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_lead( $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        _deprecated_function( 'GFFormsModel::update_lead()', '1.8.8', 'GFAPI::update_entry()' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $lead_table = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $payment_date = strtotime( rgar( $lead, 'payment_date' ) ) ? &quot;'&quot; . gmdate( 'Y-m-d H:i:s', strtotime( &quot;{$lead['payment_date']}&quot; ) ) . &quot;'&quot; : 'NULL';&nbsp;</div></li><li><div>        $payment_amount = ! rgblank( rgar( $lead, 'payment_amount' ) ) ? (float) rgar( $lead, 'payment_amount' ) : 'NULL';&nbsp;</div></li><li><div>        $transaction_type = ! rgempty( 'transaction_type', $lead ) ? intval( $lead['transaction_type'] ) : 'NULL';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $status = ! rgempty( 'status', $lead ) ? $lead['status'] : 'active';&nbsp;</div></li><li><div>        $source_url = self::truncate( rgar( $lead, 'source_url' ), 200 );&nbsp;</div></li><li><div>        $user_agent = self::truncate( rgar( $lead, 'user_agent' ), 250 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot;UPDATE $lead_table SET&nbsp;</div></li><li><div>                form_id=%d, &nbsp;</div></li><li><div>                post_id=%d, &nbsp;</div></li><li><div>                is_starred=%d, &nbsp;</div></li><li><div>                is_read=%d, &nbsp;</div></li><li><div>                ip=%s, &nbsp;</div></li><li><div>                source_url=%s, &nbsp;</div></li><li><div>                user_agent=%s, &nbsp;</div></li><li><div>                currency=%s, &nbsp;</div></li><li><div>                payment_status=%s, &nbsp;</div></li><li><div>                payment_date={$payment_date}, &nbsp;</div></li><li><div>                payment_amount={$payment_amount}, &nbsp;</div></li><li><div>                transaction_id=%s, &nbsp;</div></li><li><div>                is_fulfilled=%d, &nbsp;</div></li><li><div>                transaction_type={$transaction_type}, &nbsp;</div></li><li><div>                payment_method=%s, &nbsp;</div></li><li><div>                status=%s&nbsp;</div></li><li><div>           WHERE id=%d&quot;, rgar( $lead, 'form_id' ), rgar( $lead, 'post_id' ), rgar( $lead, 'is_starred' ), rgar( $lead, 'is_read' ), rgar( $lead, 'ip' ), $source_url, $user_agent, &nbsp;</div></li><li><div>            rgar( $lead, 'currency' ), rgar( $lead, 'payment_status' ), rgar( $lead, 'transaction_id' ), rgar( $lead, 'is_fulfilled' ), rgar( $lead, 'payment_method' ), $status, rgar( $lead, 'id' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::set_current_lead( $lead );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function truncate( $str, $length ) {&nbsp;</div></li><li><div>        if ( strlen( $str ) &gt; $length ) {&nbsp;</div></li><li><div>            $str = substr( $str, 0, $length );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $str;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_leads( $leads ) {&nbsp;</div></li><li><div>        foreach ( $leads as $lead_id ) {&nbsp;</div></li><li><div>            self::delete_lead( $lead_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_forms( $forms ) {&nbsp;</div></li><li><div>        foreach ( $forms as $form_id ) {&nbsp;</div></li><li><div>            self::delete_form( $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function trash_forms( $form_ids ) {&nbsp;</div></li><li><div>        foreach ( $form_ids as $form_id ) {&nbsp;</div></li><li><div>            self::trash_form( $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function restore_forms( $form_ids ) {&nbsp;</div></li><li><div>        foreach ( $form_ids as $form_id ) {&nbsp;</div></li><li><div>            self::restore_form( $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_leads_by_form( $form_id, $status = '' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_table = self::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_notes_table = self::get_lead_notes_table_name();&nbsp;</div></li><li><div>        $lead_detail_table = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_detail_long_table = self::get_lead_details_long_table_name();&nbsp;</div></li><li><div>        $lead_meta_table = self::get_lead_meta_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires when you delete entries for a specific form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form_id The form ID to specify from which form to delete entries&nbsp;</div></li><li><div>         * @param string $status Allows you to set the form entries to a deleted status&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'gform_delete_entries', $form_id, $status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //deleting uploaded files&nbsp;</div></li><li><div>        self::delete_files_by_form( $form_id, $status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $status_filter = empty( $status ) ? '' : $wpdb-&gt;prepare( 'AND status=%s', $status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from detail long&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot;     DELETE $lead_detail_long_table FROM $lead_detail_long_table&nbsp;</div></li><li><div>                JOIN (&nbsp;</div></li><li><div>                    SELECT ld.id FROM $lead_detail_table ld&nbsp;</div></li><li><div>                    INNER JOIN $lead_table l ON l.id = ld.lead_id&nbsp;</div></li><li><div>                    WHERE l.form_id=%d AND ld.form_id=%d {$status_filter}&nbsp;</div></li><li><div> ) tmp&nbsp;</div></li><li><div>                ON tmp.id = $lead_detail_long_table.lead_detail_id&quot;, $form_id, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead details&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; DELETE FROM $lead_detail_table&nbsp;</div></li><li><div>                                WHERE lead_id IN (&nbsp;</div></li><li><div>                                    SELECT id FROM $lead_table WHERE form_id=%d {$status_filter}&nbsp;</div></li><li><div> )&quot;, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead notes&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; DELETE FROM $lead_notes_table&nbsp;</div></li><li><div>                                WHERE lead_id IN (&nbsp;</div></li><li><div>                                    SELECT id FROM $lead_table WHERE form_id=%d {$status_filter}&nbsp;</div></li><li><div> )&quot;, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead meta&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; DELETE FROM $lead_meta_table&nbsp;</div></li><li><div>                                WHERE lead_id IN (&nbsp;</div></li><li><div>                                    SELECT id FROM $lead_table WHERE form_id=%d {$status_filter}&nbsp;</div></li><li><div> )&quot;, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_table WHERE form_id=%d {$status_filter}&quot;, $form_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_views( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_view_table = self::get_form_view_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete form view&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $form_view_table WHERE form_id=%d&quot;, $form_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_post_form_views_deleted', $form_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_form( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_before_delete_form', $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_meta_table = self::get_meta_table_name();&nbsp;</div></li><li><div>        $form_table = self::get_form_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Deleting form Entries&nbsp;</div></li><li><div>        self::delete_leads_by_form( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete form meta&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $form_meta_table WHERE form_id=%d&quot;, $form_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Deleting form Views&nbsp;</div></li><li><div>        self::delete_views( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete form&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $form_table WHERE id=%d&quot;, $form_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_after_delete_form', $form_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function trash_form( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;UPDATE $form_table_name SET is_trash=1 WHERE id=%d&quot;, $form_id );&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = get_current_blog_id() . '_' . $form_id;&nbsp;</div></li><li><div>        self::$_current_forms[ $key ] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $success = $result == false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires after a form is trashed&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form_id The ID of a form you can can check which form was trashed&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'gform_post_form_trashed', $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $success;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function restore_form( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;UPDATE $form_table_name SET is_trash=0 WHERE id=%d&quot;, $form_id );&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = get_current_blog_id() . '_' . $form_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::$_current_forms[ $key ] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $success = $result == false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_post_form_restored', $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $success;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function duplicate_form( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! GFCommon::current_user_can_any( 'gravityforms_create_form' ) ) {&nbsp;</div></li><li><div>            die( esc_html__( &quot;You don't have adequate permission to create forms.&quot;, 'gravityforms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //finding unique title&nbsp;</div></li><li><div>        $form = self::get_form( $form_id );&nbsp;</div></li><li><div>        $count = 2;&nbsp;</div></li><li><div>        $title = $form-&gt;title . ' - ' . esc_html__( 'Copy 1', 'gravityforms' );&nbsp;</div></li><li><div>        while ( ! self::is_unique_title( $title ) ) {&nbsp;</div></li><li><div>            $title = $form-&gt;title . ' - ' . sprintf( esc_html__( 'Copy %d', 'gravityforms' ), $count );&nbsp;</div></li><li><div>            $count ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creating new form&nbsp;</div></li><li><div>        $new_id = self::insert_form( $title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //copying form meta&nbsp;</div></li><li><div>        $meta = self::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $meta['title'] = $title;&nbsp;</div></li><li><div>        $meta['id'] = $new_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $notifications = $meta['notifications'];&nbsp;</div></li><li><div>        $confirmations = $meta['confirmations'];&nbsp;</div></li><li><div>        unset( $meta['notifications'] );&nbsp;</div></li><li><div>        unset( $meta['confirmations'] );&nbsp;</div></li><li><div>        self::update_form_meta( $new_id, $meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //copying notification meta&nbsp;</div></li><li><div>        self::update_form_meta( $new_id, $notifications, 'notifications' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //copying confirmation meta&nbsp;</div></li><li><div>        self::update_form_meta( $new_id, $confirmations, 'confirmations' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The gform_after_duplicate_form action is deprecated since version 1.9. Please use gform_post_form_duplicated instead&nbsp;</div></li><li><div>        do_action( 'gform_after_duplicate_form', $form_id, $new_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires after a form is duplicated&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form_id The original form's ID&nbsp;</div></li><li><div>         * @param int $new_id The ID of the new, duplicated form&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'gform_post_form_duplicated', $form_id, $new_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $new_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_unique_title( $title ) {&nbsp;</div></li><li><div>        $forms = self::get_forms();&nbsp;</div></li><li><div>        foreach ( $forms as $form ) {&nbsp;</div></li><li><div>            if ( strtolower( $form-&gt;title ) == strtolower( $title ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function ensure_tables_exist() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = self::get_form_table_name();&nbsp;</div></li><li><div>        $form_count = $wpdb-&gt;get_var( &quot;SELECT count(0) FROM {$form_table_name}&quot; );&nbsp;</div></li><li><div>        if ( $wpdb-&gt;last_error ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::ensure_tables_exist(): Blog ' . get_current_blog_id() . ' - Form database table does not exist. Forcing database setup.' );&nbsp;</div></li><li><div>            GFForms::setup_database();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function insert_form( $form_title ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form_table_name = $wpdb-&gt;prefix . 'rg_form';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creating new form&nbsp;</div></li><li><div>        $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;INSERT INTO $form_table_name(title, date_created) VALUES(%s, utc_timestamp())&quot;, $form_title ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //returning newly created form id&nbsp;</div></li><li><div>        return $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function update_form_meta( $form_id, $form_meta, $meta_name = 'display_meta' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_meta = gf_apply_filters( array( 'gform_form_update_meta', $form_id ), $form_meta, $form_id, $meta_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $meta_table_name = self::get_meta_table_name();&nbsp;</div></li><li><div>        $form_meta = json_encode( $form_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( intval( $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT count(0) FROM $meta_table_name WHERE form_id=%d&quot;, $form_id ) ) ) &gt; 0 ) {&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE $meta_table_name SET $meta_name=%s WHERE form_id=%d&quot;, $form_meta, $form_id ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;INSERT INTO $meta_table_name(form_id, $meta_name) VALUES(%d, %s)&quot;, $form_id, $form_meta ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = get_current_blog_id() . '_' . $form_id;&nbsp;</div></li><li><div>        self::$_current_forms[ $key ] = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires after form meta has been updated for any form&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param mixed $form_meta The Form Meta object from the database&nbsp;</div></li><li><div>         * @param int $form_id The ID of the form data was updated&nbsp;</div></li><li><div>         * @param string $meta_name The name of the meta updated&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        gf_do_action( array( 'gform_post_update_form_meta', $form_id ), $form_meta, $form_id, $meta_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_files( $lead_id, $form = null ) {&nbsp;</div></li><li><div>        $lead = self::get_lead( $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $form == null ) {&nbsp;</div></li><li><div>            $form = self::get_form_meta( $lead['form_id'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Default field types to delete&nbsp;</div></li><li><div>        $field_types = array( 'fileupload', 'post_image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow adding more file types to delete&nbsp;</div></li><li><div>        $field_types = gf_apply_filters( array( 'gform_field_types_delete_files', $form['id'] ), $field_types, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = self::get_fields_by_type( $form, $field_types );&nbsp;</div></li><li><div>        if ( is_array( $fields ) ) {&nbsp;</div></li><li><div>            foreach ( $fields as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $field-&gt;multipleFiles ) {&nbsp;</div></li><li><div>                    $value_json = self::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>                    if ( ! empty( $value_json ) ) {&nbsp;</div></li><li><div>                        $files = json_decode( $value_json, true );&nbsp;</div></li><li><div>                        if ( false === empty( $files ) && is_array( $files ) ) {&nbsp;</div></li><li><div>                            foreach ( $files as $file ) {&nbsp;</div></li><li><div>                                self::delete_physical_file( $file );&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $value = self::get_lead_field_value( $lead, $field );&nbsp;</div></li><li><div>                    self::delete_physical_file( $value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_files_by_form( $form_id, $status = '' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $form = self::get_form_meta( $form_id );&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        // Default field types to delete&nbsp;</div></li><li><div>        $field_types = array( 'fileupload', 'post_image' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Allow adding more file types to delete&nbsp;</div></li><li><div>        $field_types = gf_apply_filters( array( 'gform_field_types_delete_files', $form_id ), $field_types, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = self::get_fields_by_type( $form, $field_types );&nbsp;</div></li><li><div>        if ( empty( $fields ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $status_filter = empty( $status ) ? '' : $wpdb-&gt;prepare( 'AND status=%s', $status );&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id FROM {$wpdb-&gt;prefix}rg_lead WHERE form_id=%d {$status_filter}&quot;, $form_id ), ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $results as $result ) {&nbsp;</div></li><li><div>            self::delete_files( $result['id'], $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_file( $entry_id, $field_id, $file_index = 0 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $entry_id == 0 || $field_id == 0 ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry = self::get_lead( $entry_id );&nbsp;</div></li><li><div>        $form_id = $entry['form_id'];&nbsp;</div></li><li><div>        $form = self::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $field = self::get_field( $form, $field_id );&nbsp;</div></li><li><div>        $multiple_files = $field-&gt;multipleFiles;&nbsp;</div></li><li><div>        if ( $multiple_files ) {&nbsp;</div></li><li><div>            $file_urls = json_decode( $entry[ $field_id ], true );&nbsp;</div></li><li><div>            $file_url = $file_urls[ $file_index ];&nbsp;</div></li><li><div>            unset( $file_urls[ $file_index ] );&nbsp;</div></li><li><div>            $file_urls = array_values( $file_urls );&nbsp;</div></li><li><div>            $field_value = empty( $file_urls ) ? '' : json_encode( $file_urls );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $file_url = $entry[ $field_id ];&nbsp;</div></li><li><div>            $field_value = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::delete_physical_file( $file_url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update lead field value - simulate form submission&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;SELECT id FROM $lead_detail_table WHERE lead_id=%d AND field_number BETWEEN %s AND %s&quot;, $entry_id, doubleval( $field_id ) - 0.0001, doubleval( $field_id ) + 0.0001 );&nbsp;</div></li><li><div>        $entry_detail_id = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::update_lead_field_value( $form, $entry, $field, $entry_detail_id, $field_id, $field_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function delete_physical_file( $file_url ) {&nbsp;</div></li><li><div>        $ary = explode( '|:|', $file_url );&nbsp;</div></li><li><div>        $url = rgar( $ary, 0 );&nbsp;</div></li><li><div>        if ( empty( $url ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Convert from url to physical path&nbsp;</div></li><li><div>        if ( is_multisite() && get_site_option( 'ms_files_rewriting' ) ) {&nbsp;</div></li><li><div>            $file_path = preg_replace( &quot;|^(.*?)/files/gravity_forms/|&quot;, BLOGUPLOADDIR . 'gravity_forms/', $url );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $file_path = str_replace( WP_CONTENT_URL, WP_CONTENT_DIR, $url );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( file_exists( $file_path ) ) {&nbsp;</div></li><li><div>            unlink( $file_path );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_field( $form_id, $field_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $form_id == 0 ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_before_delete_field', $form_id, $field_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_table = self::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_detail_table = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_detail_long_table = self::get_lead_details_long_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = self::get_form_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_type = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Deleting field from form meta&nbsp;</div></li><li><div>        $count = sizeof( $form['fields'] );&nbsp;</div></li><li><div>        for ( $i = $count - 1; $i &gt;= 0; $i -- ) {&nbsp;</div></li><li><div>            $field = $form['fields'][ $i ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Deleting associated conditional logic rules&nbsp;</div></li><li><div>            if ( ! empty( $field-&gt;conditionalLogic ) ) {&nbsp;</div></li><li><div>                $rule_count = sizeof( $field-&gt;conditionalLogic['rules'] );&nbsp;</div></li><li><div>                for ( $j = $rule_count - 1; $j &gt;= 0; $j -- ) {&nbsp;</div></li><li><div>                    if ( $field-&gt;conditionalLogic['rules'][ $j ]['fieldId'] == $field_id ) {&nbsp;</div></li><li><div>                        unset( $form['fields'][ $i ]-&gt;conditionalLogic['rules'][ $j ] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $form['fields'][ $i ]-&gt;conditionalLogic['rules'] = array_values( $form['fields'][ $i ]-&gt;conditionalLogic['rules'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //If there aren't any rules, remove the conditional logic&nbsp;</div></li><li><div>                if ( sizeof( $form['fields'][ $i ]-&gt;conditionalLogic['rules'] ) == 0 ) {&nbsp;</div></li><li><div>                    $form['fields'][ $i ]-&gt;conditionalLogic = false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Deleting field from form meta&nbsp;</div></li><li><div>            if ( $field-&gt;id == $field_id ) {&nbsp;</div></li><li><div>                $field_type = $field-&gt;type;&nbsp;</div></li><li><div>                unset( $form['fields'][ $i ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //removing post content and title template if the field being deleted is a post content field or post title field&nbsp;</div></li><li><div>        if ( $field_type == 'post_content' ) {&nbsp;</div></li><li><div>            $form['postContentTemplateEnabled'] = false;&nbsp;</div></li><li><div>            $form['postContentTemplate'] = '';&nbsp;</div></li><li><div>        } else if ( $field_type == 'post_title' ) {&nbsp;</div></li><li><div>            $form['postTitleTemplateEnabled'] = false;&nbsp;</div></li><li><div>            $form['postTitleTemplate'] = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Deleting associated routing rules&nbsp;</div></li><li><div>        if ( ! empty( $form['notification']['routing'] ) ) {&nbsp;</div></li><li><div>            $routing_count = sizeof( $form['notification']['routing'] );&nbsp;</div></li><li><div>            for ( $j = $routing_count - 1; $j &gt;= 0; $j -- ) {&nbsp;</div></li><li><div>                if ( intval( $form['notification']['routing'][ $j ]['fieldId'] ) == $field_id ) {&nbsp;</div></li><li><div>                    unset( $form['notification']['routing'][ $j ] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $form['notification']['routing'] = array_values( $form['notification']['routing'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //If there aren't any routing, remove it&nbsp;</div></li><li><div>            if ( sizeof( $form['notification']['routing'] ) == 0 ) {&nbsp;</div></li><li><div>                $form['notification']['routing'] = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['fields'] = array_values( $form['fields'] );&nbsp;</div></li><li><div>        self::update_form_meta( $form_id, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from grid column meta&nbsp;</div></li><li><div>        $columns = self::get_grid_column_meta( $form_id );&nbsp;</div></li><li><div>        $count = sizeof( $columns );&nbsp;</div></li><li><div>        for ( $i = $count - 1; $i &gt;= 0; $i -- ) {&nbsp;</div></li><li><div>            if ( intval( rgar( $columns, $i ) ) == intval( $field_id ) ) {&nbsp;</div></li><li><div>                unset( $columns[ $i ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        self::update_grid_column_meta( $form_id, $columns );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from detail long&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot;DELETE $lead_detail_long_table FROM $lead_detail_long_table&nbsp;</div></li><li><div>                JOIN (&nbsp;</div></li><li><div>                    SELECT ld.id FROM $lead_detail_table ld&nbsp;</div></li><li><div>                    WHERE form_id=%d AND field_number &gt;= %d AND field_number &lt; %d&nbsp;</div></li><li><div> ) tmp&nbsp;</div></li><li><div>                ON tmp.id = $lead_detail_long_table.lead_detail_id&quot;, &nbsp;</div></li><li><div>            $form_id, $field_id, $field_id + 1&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead details&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_detail_table WHERE form_id=%d AND field_number &gt;= %d AND field_number &lt; %d&quot;, $form_id, $field_id, $field_id + 1 );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete leads with no details&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; DELETE FROM $lead_table&nbsp;</div></li><li><div>                                WHERE form_id=%d&nbsp;</div></li><li><div>                                AND id NOT IN(&nbsp;</div></li><li><div>                                    SELECT DISTINCT(lead_id) FROM $lead_detail_table WHERE form_id=%d&nbsp;</div></li><li><div> )&quot;, $form_id, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires after a field is deleted&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form_id The form ID where the form was deleted&nbsp;</div></li><li><div>         * @param int $field_id The ID of the field that was deleted&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'gform_after_delete_field', $form_id, $field_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_lead( $lead_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_delete_lead', $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_table = self::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_notes_table = self::get_lead_notes_table_name();&nbsp;</div></li><li><div>        $lead_detail_table = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_detail_long_table = self::get_lead_details_long_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //deleting uploaded files&nbsp;</div></li><li><div>        self::delete_files( $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from detail long&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot;DELETE $lead_detail_long_table FROM $lead_detail_long_table&nbsp;</div></li><li><div>                JOIN (&nbsp;</div></li><li><div>                    SELECT ld.id FROM $lead_detail_table ld&nbsp;</div></li><li><div>                    WHERE lead_id=%d&nbsp;</div></li><li><div> ) tmp&nbsp;</div></li><li><div>                ON tmp.id = $lead_detail_long_table.lead_detail_id&quot;, &nbsp;</div></li><li><div>            $lead_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead details&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_detail_table WHERE lead_id=%d&quot;, $lead_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead notes&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_notes_table WHERE lead_id=%d&quot;, $lead_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead meta&nbsp;</div></li><li><div>        gform_delete_meta( $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Delete from lead&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_table WHERE id=%d&quot;, $lead_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_note( $lead_id, $user_id, $user_name, $note, $note_type = 'note' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table_name = self::get_lead_notes_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;INSERT INTO $table_name(lead_id, user_id, user_name, value, note_type, date_created) values(%d, %d, %s, %s, %s, utc_timestamp())&quot;, $lead_id, $user_id, $user_name, $note, $note_type );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_post_note_added', $wpdb-&gt;insert_id, $lead_id, $user_id, $user_name, $note, $note_type );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_note( $note_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table_name = self::get_lead_notes_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT lead_id FROM $table_name WHERE id = %d&quot;, $note_id ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires before a note is deleted&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $note_id The Current note ID&nbsp;</div></li><li><div>         * @param int $lead_id The current lead ID&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        do_action( 'gform_pre_note_deleted', $note_id, $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $table_name WHERE id=%d&quot;, $note_id );&nbsp;</div></li><li><div>        $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_notes( $notes ) {&nbsp;</div></li><li><div>        if ( ! is_array( $notes ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $notes as $note_id ) {&nbsp;</div></li><li><div>            self::delete_note( $note_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_ip() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $ip = '';&nbsp;</div></li><li><div>        $headers = array( 'HTTP_CLIENT_IP', 'HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $headers as $header ) {&nbsp;</div></li><li><div>            $ip = rgar( $_SERVER, $header );&nbsp;</div></li><li><div>            if ( $ip ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // HTTP_X_FORWARDED_FOR can return a comma separated list of IPs; using the first one&nbsp;</div></li><li><div>        $ips = explode( ', ', $ip );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $ips[0];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_lead( $form, &$lead ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( __METHOD__ . '(): Saving entry.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_admin && ! GFCommon::current_user_can_any( 'gravityforms_edit_entries' ) ) {&nbsp;</div></li><li><div>            die( esc_html__( &quot;You don't have adequate permission to edit entries.&quot;, 'gravityforms' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $is_new_lead = $lead == null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Inserting lead if null&nbsp;</div></li><li><div>        if ( $is_new_lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            global $current_user;&nbsp;</div></li><li><div>            $user_id = $current_user && $current_user-&gt;ID ? $current_user-&gt;ID : 'NULL';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $lead_table = RGFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>            $user_agent = self::truncate( rgar( $_SERVER, 'HTTP_USER_AGENT' ), 250 );&nbsp;</div></li><li><div>            $user_agent = sanitize_text_field( $user_agent );&nbsp;</div></li><li><div>            $source_url = self::truncate( self::get_current_page_url(), 200 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>             * Allow the currency code to be overridden.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             * @param string $currency The three character ISO currency code to be stored in the entry. Default is value returned by GFCommon::get_currency()&nbsp;</div></li><li><div>             * @param array $form The form currently being processed.&nbsp;</div></li><li><div>             *&nbsp;</div></li><li><div>             */&nbsp;</div></li><li><div>            $currency = gf_apply_filters( array( 'gform_currency_pre_save_entry', $form['id'] ), GFCommon::get_currency(), $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;INSERT INTO $lead_table(form_id, ip, source_url, date_created, user_agent, currency, created_by) VALUES(%d, %s, %s, utc_timestamp(), %s, %s, {$user_id})&quot;, $form['id'], self::get_ip(), $source_url, $user_agent, $currency ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //reading newly created lead id&nbsp;</div></li><li><div>            $lead_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>            $lead = array( 'id' =&gt; $lead_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            GFCommon::log_debug( __METHOD__ . &quot;(): Entry record created in the database. ID: {$lead_id}.&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $current_fields = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT id, field_number FROM $lead_detail_table WHERE lead_id=%d&quot;, $lead['id'] ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $total_fields = array();&nbsp;</div></li><li><div>        /** @var $calculation_fields GF_Field[] */&nbsp;</div></li><li><div>        $calculation_fields = array();&nbsp;</div></li><li><div>        $recalculate_total = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( __METHOD__ . '(): Saving entry fields.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var $field GF_Field */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // ignore the honeypot field&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'honeypot' ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Ignore fields that are marked as display only&nbsp;</div></li><li><div>            if ( $field-&gt;displayOnly && $field-&gt;type != 'password' ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //ignore pricing fields in the entry detail&nbsp;</div></li><li><div>            if ( RG_CURRENT_VIEW == 'entry' && GFCommon::is_pricing_field( $field-&gt;type ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //process total field after all fields have been saved&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'total' ) {&nbsp;</div></li><li><div>                $total_fields[] = $field;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_entry_update = RG_CURRENT_VIEW == 'entry' || ! $is_new_lead;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $read_value_from_post = $is_new_lead || ! isset( $lead[ 'date_created' ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //only save fields that are not hidden (except when updating an entry)&nbsp;</div></li><li><div>            if( $is_entry_update || ! GFFormsModel::is_field_hidden( $form, $field, array(), $read_value_from_post ? null : $lead ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // process calculation fields after all fields have been saved (moved after the is hidden check)&nbsp;</div></li><li><div>                if ( $field-&gt;has_calculation() ) {&nbsp;</div></li><li><div>                    $calculation_fields[] = $field;&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>                    $field = GFCommon::add_categories_as_choices( $field, '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>                if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                        self::save_input( $form, $field, $lead, $current_fields, $input['id'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    self::save_input( $form, $field, $lead, $current_fields, $field-&gt;id );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $calculation_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $calculation_fields as $calculation_field ) {&nbsp;</div></li><li><div>                $inputs = $calculation_field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>                if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                        self::save_input( $form, $calculation_field, $lead, $current_fields, $input['id'] );&nbsp;</div></li><li><div>                        self::refresh_lead_field_value( $lead['id'], $input['id'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    self::save_input( $form, $calculation_field, $lead, $current_fields, $calculation_field-&gt;id );&nbsp;</div></li><li><div>                    self::refresh_lead_field_value( $lead['id'], $calculation_field-&gt;id );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            self::refresh_product_cache( $form, $lead = RGFormsModel::get_lead( $lead['id'] ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //saving total field as the last field of the form.&nbsp;</div></li><li><div>        if ( ! empty( $total_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $total_fields as $total_field ) {&nbsp;</div></li><li><div>                self::save_input( $form, $total_field, $lead, $current_fields, $total_field-&gt;id );&nbsp;</div></li><li><div>                self::refresh_lead_field_value( $lead['id'], $total_field['id'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        GFCommon::log_debug( __METHOD__ . '(): Finished saving entry fields.' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function create_lead( $form ) {&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $total_fields = array();&nbsp;</div></li><li><div>        $calculation_fields = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead = array();&nbsp;</div></li><li><div>        $lead['id'] = null;&nbsp;</div></li><li><div>        $lead['post_id'] = null;&nbsp;</div></li><li><div>        $lead['date_created'] = null;&nbsp;</div></li><li><div>        $lead['form_id'] = $form['id'];&nbsp;</div></li><li><div>        $lead['ip'] = self::get_ip();&nbsp;</div></li><li><div>        $source_url = self::truncate( self::get_current_page_url(), 200 );&nbsp;</div></li><li><div>        $lead['source_url'] = esc_url_raw( $source_url );&nbsp;</div></li><li><div>        $user_agent = strlen( $_SERVER['HTTP_USER_AGENT'] ) &gt; 250 ? substr( $_SERVER['HTTP_USER_AGENT'], 0, 250 ) : $_SERVER['HTTP_USER_AGENT'];&nbsp;</div></li><li><div>        $lead['user_agent'] = sanitize_text_field( $user_agent );&nbsp;</div></li><li><div>        $lead['created_by'] = $current_user && $current_user-&gt;ID ? $current_user-&gt;ID : 'NULL';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allow the currency code to be overridden.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param string $currency The three character ISO currency code to be stored in the entry. Default is value returned by GFCommon::get_currency()&nbsp;</div></li><li><div>         * @param array $form The form currently being processed.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $lead['currency'] = gf_apply_filters( array( 'gform_currency_pre_save_entry', $form['id'] ), GFCommon::get_currency(), $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var $field GF_Field */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // ignore fields that are marked as display only&nbsp;</div></li><li><div>            if ( $field-&gt;displayOnly && $field-&gt;type != 'password' ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // process total field after all fields have been saved&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'total' ) {&nbsp;</div></li><li><div>                $total_fields[] = $field;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // process calculation fields after all fields have been saved&nbsp;</div></li><li><div>            if ( $field-&gt;has_calculation() ) {&nbsp;</div></li><li><div>                $calculation_fields[] = $field;&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // only save fields that are not hidden&nbsp;</div></li><li><div>            if ( ! RGFormsModel::is_field_hidden( $form, $field, array() ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>                    $field = GFCommon::add_categories_as_choices( $field, '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                        $lead[ (string) $input['id'] ] = self::get_prepared_input_value( $form, $field, $lead, $input['id'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $lead[ $field-&gt;id ] = self::get_prepared_input_value( $form, $field, $lead, $field-&gt;id );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $calculation_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $calculation_fields as $field ) {&nbsp;</div></li><li><div>                /** @var $field GF_Field */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // only save fields that are not hidden&nbsp;</div></li><li><div>                if ( RGFormsModel::is_field_hidden( $form, $field, array() ) ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                        $lead[ (string) $input['id'] ] = self::get_prepared_input_value( $form, $field, $lead, $input['id'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $lead[ $field-&gt;id ] = self::get_prepared_input_value( $form, $field, $lead, $field-&gt;id );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            self::refresh_product_cache( $form, $lead );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // saving total field as the last field of the form.&nbsp;</div></li><li><div>        if ( ! empty( $total_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $total_fields as $total_field ) {&nbsp;</div></li><li><div>                $lead[ $total_field-&gt;id ] = self::get_prepared_input_value( $form, $total_field, $lead, $total_field-&gt;id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $lead;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_prepared_input_value( $form, $field, $lead, $input_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $input_name = 'input_' . str_replace( '.', '_', $input_id );&nbsp;</div></li><li><div>        if ( $field-&gt;enableCopyValuesOption && rgpost( 'input_' . $field-&gt;id . '_copy_values_activated' ) ) {&nbsp;</div></li><li><div>            $source_field_id = $field-&gt;copyValuesOptionField;&nbsp;</div></li><li><div>            $source_input_name = str_replace( 'input_' . $field-&gt;id, 'input_' . $source_field_id, $input_name );&nbsp;</div></li><li><div>            $value = rgpost( $source_input_name );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $value = rgpost( $input_name );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $value ) && $field-&gt;adminOnly && ! $is_admin ) {&nbsp;</div></li><li><div>            $value = self::get_default_value( $field, $input_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( self::get_input_type( $field ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'post_image':&nbsp;</div></li><li><div>                $file_info = self::get_temp_filename( $form['id'], $input_name );&nbsp;</div></li><li><div>                if ( ! empty( $file_info ) ) {&nbsp;</div></li><li><div>                    $file_path = self::get_file_upload_path( $form['id'], $file_info['uploaded_filename'] );&nbsp;</div></li><li><div>                    $url = $file_path['url'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $image_title = isset( $_POST[ &quot;{$input_name}_1&quot; ] ) ? strip_tags( $_POST[ &quot;{$input_name}_1&quot; ] ) : '';&nbsp;</div></li><li><div>                    $image_caption = isset( $_POST[ &quot;{$input_name}_4&quot; ] ) ? strip_tags( $_POST[ &quot;{$input_name}_4&quot; ] ) : '';&nbsp;</div></li><li><div>                    $image_description = isset( $_POST[ &quot;{$input_name}_7&quot; ] ) ? strip_tags( $_POST[ &quot;{$input_name}_7&quot; ] ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $value = ! empty( $url ) ? $url . '|:|' . $image_title . '|:|' . $image_caption . '|:|' . $image_description : '';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'fileupload' :&nbsp;</div></li><li><div>                if ( $field-&gt;multipleFiles ) {&nbsp;</div></li><li><div>                    if ( ! empty( $value ) ) {&nbsp;</div></li><li><div>                        $value = json_encode( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $file_info = self::get_temp_filename( $form['id'], $input_name );&nbsp;</div></li><li><div>                    if ( ! empty( $file_info ) ) {&nbsp;</div></li><li><div>                        $file_path = self::get_file_upload_path( $form['id'], $file_info['uploaded_filename'] );&nbsp;</div></li><li><div>                        $value = $file_path['url'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // processing values so that they are in the correct format for each input type&nbsp;</div></li><li><div>                $value = self::prepare_value( $form, $field, $value, $input_name, rgar( $lead, 'id' ), $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return gf_apply_filters( array( 'gform_save_field_value', $form['id'], $field-&gt;id ), $value, $lead, $field, $form, $input_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function refresh_product_cache( $form, $lead, $use_choice_text = false, $use_admin_label = false ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_options = array(&nbsp;</div></li><li><div>            array( false, false ), &nbsp;</div></li><li><div>            array( false, true ), &nbsp;</div></li><li><div>            array( true, false ), &nbsp;</div></li><li><div>            array( true, true ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var $field GF_Field */&nbsp;</div></li><li><div>            if ( $field-&gt;has_calculation() ) {&nbsp;</div></li><li><div>                //deleting field value cache for calculated fields&nbsp;</div></li><li><div>                $cache_key = 'GFFormsModel::get_lead_field_value_' . $lead['id'] . '_' . $field-&gt;id;&nbsp;</div></li><li><div>                GFCache::delete( $cache_key );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $cache_options as $cache_option ) {&nbsp;</div></li><li><div>            list( $use_choice_text, $use_admin_label ) = $cache_option;&nbsp;</div></li><li><div>            if ( gform_get_meta( rgar( $lead, 'id' ), &quot;gform_product_info_{$use_choice_text}_{$use_admin_label}&quot; ) ) {&nbsp;</div></li><li><div>                gform_delete_meta( rgar( $lead, 'id' ), &quot;gform_product_info_{$use_choice_text}_{$use_admin_label}&quot; );&nbsp;</div></li><li><div>                GFCommon::get_product_fields( $form, $lead, $use_choice_text, $use_admin_label );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Check whether a field is hidden via conditional logic.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array    $form         Form object.&nbsp;</div></li><li><div>     * @param GF_Field $field        Field object.&nbsp;</div></li><li><div>     * @param array    $field_values Default field values for this form. Used when form has not yet been submitted. Pass an array if no default field values are available/required.&nbsp;</div></li><li><div>     * @param array    $lead         Optional, default is null. If lead object is available, pass the lead.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_field_hidden( $form, $field, $field_values, $lead = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $field ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_key = 'GFFormsModel::is_field_hidden_' . $form['id'] . '_' . $field-&gt;id;&nbsp;</div></li><li><div>        $display = GFCache::get( $cache_key );&nbsp;</div></li><li><div>        if ( $display !== false ) {&nbsp;</div></li><li><div>            return $display;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $section = self::get_section( $form, $field-&gt;id );&nbsp;</div></li><li><div>        $section_display = self::get_field_display( $form, $section, $field_values, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if section is hidden, hide field no matter what. if section is visible, see if field is supposed to be visible&nbsp;</div></li><li><div>        if ( $section_display == 'hide' ) {&nbsp;</div></li><li><div>            $display = 'hide';&nbsp;</div></li><li><div>        } else if ( self::is_page_hidden( $form, $field-&gt;pageNumber, $field_values, $lead ) ) {&nbsp;</div></li><li><div>            $display = 'hide';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $display = self::get_field_display( $form, $field, $field_values, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $display == 'hide';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCache::set( $cache_key, $display );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $display == 'hide';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_page_hidden( $form, $page_number, $field_values, $lead = null ) {&nbsp;</div></li><li><div>        $page = self::get_page_by_number( $form, $page_number );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $page ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $display = self::get_field_display( $form, $page, $field_values, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $display == 'hide';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_page_by_number( $form, $page_number ) {&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'page' && $field-&gt;pageNumber == $page_number ) {&nbsp;</div></li><li><div>                return $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //gets the section that the specified field belongs to, or null if none&nbsp;</div></li><li><div>    public static function get_section( $form, $field_id ) {&nbsp;</div></li><li><div>        $current_section = null;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'section' ) {&nbsp;</div></li><li><div>                $current_section = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //stop section at a page break (sections don't go cross page)&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'page' ) {&nbsp;</div></li><li><div>                $current_section = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;id == $field_id ) {&nbsp;</div></li><li><div>                return $current_section;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_value_match( $field_value, $target_value, $operation = 'is', $source_field = null, $rule = null, $form = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_match = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $source_field && is_subclass_of( $source_field, 'GF_Field' ) && $source_field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>            $field_value = GFCommon::prepare_post_category_value( $field_value, $source_field, 'conditional_logic' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $field_value ) && ! is_array( $field_value ) && is_subclass_of( $source_field, 'GF_Field' ) && $source_field-&gt;type == 'multiselect' ) {&nbsp;</div></li><li><div>            $field_value = explode( ', ', $field_value );&nbsp;</div></li><li><div>        } // convert the comma-delimited string into an array&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = $source_field instanceof GF_Field ? $source_field-&gt;formId : 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $target_value = GFFormsModel::maybe_trim_input( $target_value, $form_id, $source_field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $field_value ) ) {&nbsp;</div></li><li><div>            $field_value = array_values( $field_value ); //returning array values, ignoring keys if array is associative&nbsp;</div></li><li><div>            $match_count = 0;&nbsp;</div></li><li><div>            foreach ( $field_value as $val ) {&nbsp;</div></li><li><div>                $val = GFFormsModel::maybe_trim_input( GFCommon::get_selection_value( $val ), rgar( $source_field, 'formId' ), $source_field );&nbsp;</div></li><li><div>                if ( self::matches_operation( $val, $target_value, $operation ) ) {&nbsp;</div></li><li><div>                    $match_count ++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            // if operation is Is Not, none of the values in the array can match the target value.&nbsp;</div></li><li><div>            $is_match = $operation == 'isnot' ? $match_count == count( $field_value ) : $match_count &gt; 0;&nbsp;</div></li><li><div>        } else if ( self::matches_operation( GFFormsModel::maybe_trim_input( GFCommon::get_selection_value( $field_value ), $form_id, $source_field ), $target_value, $operation ) ) {&nbsp;</div></li><li><div>            $is_match = true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'gform_is_value_match', $is_match, $field_value, $target_value, $operation, $source_field, $rule );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function try_convert_float( $text ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>        global $wp_locale;&nbsp;</div></li><li><div>        $number_format = $wp_locale-&gt;number_format['decimal_point'] == ', ' ? 'decimal_comma' : 'decimal_dot';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>        if ( is_numeric( $text ) && $number_format == 'decimal_comma' ) {&nbsp;</div></li><li><div>            return GFCommon::format_number( $text, 'decimal_comma' );&nbsp;</div></li><li><div>        } else if ( GFCommon::is_numeric( $text, $number_format ) ) {&nbsp;</div></li><li><div>            return GFCommon::clean_number( $text, $number_format );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        */&nbsp;</div></li><li><div>        &nbsp;</div></li><li><div>        $number_format = 'decimal_dot';&nbsp;</div></li><li><div>        if ( GFCommon::is_numeric( $text, $number_format ) ) {&nbsp;</div></li><li><div>            return GFCommon::clean_number( $text, $number_format );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $text;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function matches_operation( $val1, $val2, $operation ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $val1 = ! rgblank( $val1 ) ? strtolower( $val1 ) : '';&nbsp;</div></li><li><div>        $val2 = ! rgblank( $val2 ) ? strtolower( $val2 ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $operation ) {&nbsp;</div></li><li><div>            case 'is' :&nbsp;</div></li><li><div>                return $val1 == $val2;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'isnot' :&nbsp;</div></li><li><div>                return $val1 != $val2;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'greater_than':&nbsp;</div></li><li><div>            case '&gt;' :&nbsp;</div></li><li><div>                $val1 = self::try_convert_float( $val1 );&nbsp;</div></li><li><div>                $val2 = self::try_convert_float( $val2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $val1 &gt; $val2;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'less_than':&nbsp;</div></li><li><div>            case '&lt;' :&nbsp;</div></li><li><div>                $val1 = self::try_convert_float( $val1 );&nbsp;</div></li><li><div>                $val2 = self::try_convert_float( $val2 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $val1 &lt; $val2;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'contains' :&nbsp;</div></li><li><div>                return ! empty( $val2 ) && strpos( $val1, $val2 ) !== false;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'starts_with' :&nbsp;</div></li><li><div>                return ! rgblank( $val2 ) && strpos( $val1, $val2 ) === 0;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'ends_with' :&nbsp;</div></li><li><div>                $start = strlen( $val1 ) - strlen( $val2 );&nbsp;</div></li><li><div>                if ( $start &lt; 0 ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $tail = substr( $val1, $start );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return $val2 == $tail;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param          $form&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param          $field_values&nbsp;</div></li><li><div>     * @param null     $lead&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private static function get_field_display( $form, $field, $field_values, $lead = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $field ) ) {&nbsp;</div></li><li><div>            return 'show';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $logic = $field-&gt;conditionalLogic;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if this field does not have any conditional logic associated with it, it won't be hidden&nbsp;</div></li><li><div>        if ( empty( $logic ) ) {&nbsp;</div></li><li><div>            return 'show';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $match_count = 0;&nbsp;</div></li><li><div>        foreach ( $logic['rules'] as $rule ) {&nbsp;</div></li><li><div>            $source_field = RGFormsModel::get_field( $form, $rule['fieldId'] );&nbsp;</div></li><li><div>            $field_value = empty( $lead ) ? self::get_field_value( $source_field, $field_values ) : self::get_lead_field_value( $lead, $source_field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_value_match = self::is_value_match( $field_value, $rule['value'], $rule['operator'], $source_field, $rule, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $is_value_match ) {&nbsp;</div></li><li><div>                $match_count ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $do_action = ( $logic['logicType'] == 'all' && $match_count == sizeof( $logic['rules'] ) ) || ( $logic['logicType'] == 'any' && $match_count &gt; 0 );&nbsp;</div></li><li><div>        $is_hidden = ( $do_action && $logic['actionType'] == 'hide' ) || ( ! $do_action && $logic['actionType'] == 'show' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_hidden ? 'hide' : 'show';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_custom_choices() {&nbsp;</div></li><li><div>        $choices = get_option( 'gform_custom_choices' );&nbsp;</div></li><li><div>        if ( ! $choices ) {&nbsp;</div></li><li><div>            $choices = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $choices;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_custom_choice( $name ) {&nbsp;</div></li><li><div>        $choices = self::get_custom_choices();&nbsp;</div></li><li><div>        if ( array_key_exists( $name, $choices ) ) {&nbsp;</div></li><li><div>            unset( $choices[ $name ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_option( 'gform_custom_choices', $choices );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_custom_choice( $previous_name, $new_name, $choices ) {&nbsp;</div></li><li><div>        $all_choices = self::get_custom_choices();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( array_key_exists( $previous_name, $all_choices ) ) {&nbsp;</div></li><li><div>            unset( $all_choices[ $previous_name ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $all_choices[ $new_name ] = $choices;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        update_option( 'gform_custom_choices', $all_choices );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param array    $field_values&nbsp;</div></li><li><div>     * @param bool     $get_from_post Whether to get the value from the $_POST array as opposed to $field_values&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|mixed|string|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_field_value( &$field, $field_values = array(), $get_from_post = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $field instanceof GF_Field ) {&nbsp;</div></li><li><div>            $field = GF_Fields::create( $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>            $field = GFCommon::add_categories_as_choices( $field, '' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = $field-&gt;get_value_submission( $field_values, $get_from_post );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function purge_expired_incomplete_submissions( $expiration_days = 30 ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $expiration_days = apply_filters( 'gform_incomplete_submissions_expiration_days', $expiration_days );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $expiration_date = gmdate( 'Y-m-d H:i:s', time() - ( $expiration_days * 24 * 60 * 60 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = self::get_incomplete_submissions_table_name();&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( &quot;DELETE FROM $table WHERE date_created &lt; '$expiration_date'&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_incomplete_submission( $token ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = self::get_incomplete_submissions_table_name();&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;DELETE FROM $table WHERE uuid = %s&quot;, $token ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_incomplete_submission( $form, $entry, $field_values, $page_number, $files, $form_unique_id, $ip, $source_url, $resume_token = '' ) {&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = self::get_incomplete_submissions_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $submitted_values = array();&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var GF_Field $field */&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'creditcard' ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $submitted_values[ $field-&gt;id ] = RGFormsModel::get_field_value( $field, $field_values );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $submitted_values = apply_filters( 'gform_submission_values_pre_save', $submitted_values, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $submission['submitted_values'] = $submitted_values;&nbsp;</div></li><li><div>        $submission['partial_entry'] = $entry;&nbsp;</div></li><li><div>        $submission['field_values'] = $field_values;&nbsp;</div></li><li><div>        $submission['page_number'] = $page_number;&nbsp;</div></li><li><div>        $submission['files'] = $files;&nbsp;</div></li><li><div>        $submission['gform_unique_id'] = $form_unique_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Issue a new token if no longer valid&nbsp;</div></li><li><div>        if ( ! empty( $resume_token ) ) {&nbsp;</div></li><li><div>            $sql = $wpdb-&gt;prepare(&quot;SELECT COUNT(*) FROM {$table} WHERE uuid = %s&quot;, $resume_token );&nbsp;</div></li><li><div>            $count = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>            if ( $count != 1 ) {&nbsp;</div></li><li><div>                $resume_token = false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $resume_token ) ) {&nbsp;</div></li><li><div>            $resume_token = self::get_uuid();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $wpdb-&gt;insert(&nbsp;</div></li><li><div>                $table, &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'uuid' =&gt; $resume_token, &nbsp;</div></li><li><div>                    'form_id' =&gt; $form['id'], &nbsp;</div></li><li><div>                    'date_created' =&gt; current_time( 'mysql', true ), &nbsp;</div></li><li><div>                    'submission' =&gt; json_encode( $submission ), &nbsp;</div></li><li><div>                    'ip' =&gt; $ip, &nbsp;</div></li><li><div>                    'source_url' =&gt; $source_url, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%d', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $result = $wpdb-&gt;update(&nbsp;</div></li><li><div>                $table, &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'form_id' =&gt; $form['id'], &nbsp;</div></li><li><div>                    'date_created' =&gt; current_time( 'mysql', true ), &nbsp;</div></li><li><div>                    'submission' =&gt; json_encode( $submission ), &nbsp;</div></li><li><div>                    'ip' =&gt; $ip, &nbsp;</div></li><li><div>                    'source_url' =&gt; $source_url, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( 'uuid' =&gt; $resume_token ), &nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    '%d', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div>                    '%s', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                array( '%s' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        do_action( 'gform_incomplete_submission_post_save', $submission, $resume_token, $form, $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result ? $resume_token : $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns a UUID. Uses openssl_random_pseudo_bytes() if available and falls back to mt_rand().&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * source: http://stackoverflow.com/questions/2040240/php-function-to-generate-v4-uuid&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param string $s The separator e.g. '-'&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_uuid( $s = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( function_exists( 'openssl_random_pseudo_bytes' ) ) { // PHP 5 &gt;= 5.3.0&nbsp;</div></li><li><div>            $data = openssl_random_pseudo_bytes( 16 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $data[6] = chr( ord( $data[6] ) & 0x0f | 0x40 ); // set version to 0100&nbsp;</div></li><li><div>            $data[8] = chr( ord( $data[8] ) & 0x3f | 0x80 ); // set bits 6-7 to 10&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return vsprintf( &quot;%s%s{$s}%s{$s}%s{$s}%s{$s}%s%s%s&quot;, str_split( bin2hex( $data ), 4 ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return sprintf(&nbsp;</div></li><li><div>                &quot;%04x%04x{$s}%04x{$s}%04x{$s}%04x{$s}%04x%04x%04x&quot;, &nbsp;</div></li><li><div>                // 32 bits for &quot;time_low&quot;&nbsp;</div></li><li><div>                mt_rand( 0, 0xffff ), mt_rand( 0, 0xffff ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // 16 bits for 'time_mid'&nbsp;</div></li><li><div>                mt_rand( 0, 0xffff ), &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // 16 bits for 'time_hi_and_version', &nbsp;</div></li><li><div>                // four most significant bits holds version number 4&nbsp;</div></li><li><div>                mt_rand( 0, 0x0fff ) | 0x4000, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // 16 bits, 8 bits for 'clk_seq_hi_res', &nbsp;</div></li><li><div>                // 8 bits for 'clk_seq_low', &nbsp;</div></li><li><div>                // two most significant bits holds zero and one for variant DCE1.1&nbsp;</div></li><li><div>                mt_rand( 0, 0x3fff ) | 0x8000, &nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // 48 bits for 'node'&nbsp;</div></li><li><div>                mt_rand( 0, 0xffff ), mt_rand( 0, 0xffff ), mt_rand( 0, 0xffff )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_incomplete_submission_values( $token ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::purge_expired_incomplete_submissions();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $table = self::get_incomplete_submissions_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;SELECT date_created, form_id, submission, source_url FROM {$table} WHERE uuid = %s&quot;, $token );&nbsp;</div></li><li><div>        $row = $wpdb-&gt;get_row( $sql, ARRAY_A );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $row;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function add_email_to_incomplete_sumbmission( $token, $email ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        self::purge_expired_incomplete_submissions();&nbsp;</div></li><li><div>        $table = self::get_incomplete_submissions_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;UPDATE $table SET email = %s WHERE uuid = %s&quot;, $email, $token );&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function maybe_trim_input( $value, $form_id, $field ) {&nbsp;</div></li><li><div>        $trim_value = apply_filters( 'gform_trim_input_value', true, $form_id, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $trim_value ) {&nbsp;</div></li><li><div>            $value = is_array( $value ) ? GFCommon::trim_deep( $value ) : trim( $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_parameter_value( $name, $field_values, $field ) {&nbsp;</div></li><li><div>        $value = stripslashes( rgget( $name ) );&nbsp;</div></li><li><div>        if ( empty( $value ) ) {&nbsp;</div></li><li><div>            $value = rgget( $name, $field_values );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //converting list format&nbsp;</div></li><li><div>        if ( RGFormsModel::get_input_type( $field ) == 'list' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //transforms this: col1|col2, col1b|col2b into this: col1, col2, col1b, col2b&nbsp;</div></li><li><div>            $column_count = count( $field-&gt;choices );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $rows = explode( ', ', $value );&nbsp;</div></li><li><div>            $ary_rows = array();&nbsp;</div></li><li><div>            if ( ! empty( $rows ) ) {&nbsp;</div></li><li><div>                foreach ( $rows as $row ) {&nbsp;</div></li><li><div>                    $ary_rows = array_merge( $ary_rows, rgexplode( '|', $row, $column_count ) );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $value = $ary_rows;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return gf_apply_filters( array( 'gform_field_value', $name ), $value, $field, $name );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_default_value( $field, $input_id ) {&nbsp;</div></li><li><div>        if ( ! is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>            if ( is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>                $input = RGFormsModel::get_input( $field, $input_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                return rgar( $input, 'defaultValue' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                return IS_ADMIN ? $field-&gt;defaultValue : GFCommon::replace_variables_prepopulate( $field-&gt;defaultValue );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else if ( $field-&gt;type == 'checkbox' ) {&nbsp;</div></li><li><div>            for ( $i = 0, $count = sizeof( $field-&gt;inputs ); $i &lt; $count; $i ++ ) {&nbsp;</div></li><li><div>                $input = $field-&gt;inputs[ $i ];&nbsp;</div></li><li><div>                $choice = $field-&gt;choices[ $i ];&nbsp;</div></li><li><div>                if ( $input['id'] == $input_id && rgar( $choice, 'isSelected' ) ) {&nbsp;</div></li><li><div>                    return $choice['value'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                if ( rgar( $choice, 'isSelected' ) || $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>                    return $choice['value'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_input_type( $field ) {&nbsp;</div></li><li><div>        // TODO: Deprecate&nbsp;</div></li><li><div>        if ( ! $field instanceof GF_Field ) {&nbsp;</div></li><li><div>            return empty( $field['inputType'] ) ? $field['type'] : $field['inputType'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field-&gt;get_input_type();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_post_field_value( $field, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $field-&gt;get_entry_inputs() ) ) {&nbsp;</div></li><li><div>            $value = array();&nbsp;</div></li><li><div>            foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                $val = isset( $lead[ strval( $input['id'] ) ] ) ? $lead[ strval( $input['id'] ) ] : '';&nbsp;</div></li><li><div>                if ( ! empty( $val ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // replace commas in individual values to prevent individual value from being split into multiple values (checkboxes, multiselects)&nbsp;</div></li><li><div>                    if ( in_array( $field-&gt;get_input_type(), array( 'checkbox', 'multiselect' ) ) ) {&nbsp;</div></li><li><div>                        $val = str_replace( ', ', '&#44;', $val );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $value[] = $val;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $value = implode( ', ', $value );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $value = isset( $lead[ $field-&gt;id ] ) ? $lead[ $field-&gt;id ] : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_post_fields( $form, $lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_data = array();&nbsp;</div></li><li><div>        $post_data['post_custom_fields'] = array();&nbsp;</div></li><li><div>        $post_data['tags_input'] = array();&nbsp;</div></li><li><div>        $categories = array();&nbsp;</div></li><li><div>        $images = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>                $field = GFCommon::add_categories_as_choices( $field, '' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = self::get_post_field_value( $field, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $field-&gt;type ) {&nbsp;</div></li><li><div>                case 'post_title' :&nbsp;</div></li><li><div>                case 'post_excerpt' :&nbsp;</div></li><li><div>                case 'post_content' :&nbsp;</div></li><li><div>                    $post_data[ $field-&gt;type ] = $value;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'post_tags' :&nbsp;</div></li><li><div>                    $tags = explode( ', ', $value );&nbsp;</div></li><li><div>                    if ( is_array( $tags ) && sizeof( $tags ) &gt; 0 ) {&nbsp;</div></li><li><div>                        $post_data['tags_input'] = array_merge( $post_data['tags_input'], $tags );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'post_custom_field' :&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $type = self::get_input_type( $field );&nbsp;</div></li><li><div>                    if ( 'fileupload' === $type && $field-&gt;multipleFiles ) {&nbsp;</div></li><li><div>                        $value = json_decode( $value, true );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $meta_name = $field-&gt;postCustomFieldName;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! isset( $post_data['post_custom_fields'][ $meta_name ] ) ) {&nbsp;</div></li><li><div>                        $post_data['post_custom_fields'][ $meta_name ] = $value;&nbsp;</div></li><li><div>                    } else if ( ! is_array( $post_data['post_custom_fields'][ $meta_name ] ) ) {&nbsp;</div></li><li><div>                        $post_data['post_custom_fields'][ $meta_name ] = array( $post_data['post_custom_fields'][ $meta_name ], $value );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $post_data['post_custom_fields'][ $meta_name ][] = $value;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'post_category' :&nbsp;</div></li><li><div>                    foreach ( explode( ', ', $value ) as $cat_string ) {&nbsp;</div></li><li><div>                        list( $cat_name, $cat_id ) = rgexplode( ':', $cat_string, 2 );&nbsp;</div></li><li><div>                        array_push( $categories, $cat_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                case 'post_image' :&nbsp;</div></li><li><div>                    $ary = ! empty( $value ) ? explode( '|:|', $value ) : array();&nbsp;</div></li><li><div>                    $url = count( $ary ) &gt; 0 ? $ary[0] : '';&nbsp;</div></li><li><div>                    $title = count( $ary ) &gt; 1 ? $ary[1] : '';&nbsp;</div></li><li><div>                    $caption = count( $ary ) &gt; 2 ? $ary[2] : '';&nbsp;</div></li><li><div>                    $description = count( $ary ) &gt; 3 ? $ary[3] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    array_push( $images, array( 'field_id' =&gt; $field-&gt;id, 'url' =&gt; $url, 'title' =&gt; $title, 'description' =&gt; $description, 'caption' =&gt; $caption ) );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $post_data['post_status'] = rgar( $form, 'postStatus' );&nbsp;</div></li><li><div>        $post_data['post_category'] = ! empty( $categories ) ? $categories : array( rgar( $form, 'postCategory' ) );&nbsp;</div></li><li><div>        $post_data['images'] = $images;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //setting current user as author depending on settings&nbsp;</div></li><li><div>        $post_data['post_author'] = $form['useCurrentUserAsAuthor'] && ! empty( $lead['created_by'] ) ? $lead['created_by'] : $form['postAuthor'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $post_data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_custom_field_names() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $keys = $wpdb-&gt;get_col(&nbsp;</div></li><li><div>            &quot;&nbsp;</div></li><li><div>        SELECT meta_key&nbsp;</div></li><li><div>        FROM $wpdb-&gt;postmeta&nbsp;</div></li><li><div>        WHERE meta_key NOT LIKE '\_%'&nbsp;</div></li><li><div>        GROUP BY meta_key&nbsp;</div></li><li><div>        ORDER BY meta_id DESC&quot;&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $keys ) {&nbsp;</div></li><li><div>            natcasesort( $keys );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $keys;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_input_masks() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $masks = array(&nbsp;</div></li><li><div>            'US Phone' =&gt; '(999) 999-9999', &nbsp;</div></li><li><div>            'US Phone + Ext' =&gt; '(999) 999-9999? x99999', &nbsp;</div></li><li><div>            'Date' =&gt; '99/99/9999', &nbsp;</div></li><li><div>            'Tax ID' =&gt; '99-9999999', &nbsp;</div></li><li><div>            'SSN' =&gt; '999-99-9999', &nbsp;</div></li><li><div>            'Zip Code' =&gt; '99999', &nbsp;</div></li><li><div>            'Full Zip Code' =&gt; '99999?-9999', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return apply_filters( 'gform_input_masks', $masks );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_default_post_title() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $title = 'Untitled';&nbsp;</div></li><li><div>        $count = 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $titles = $wpdb-&gt;get_col( &quot;SELECT post_title FROM $wpdb-&gt;posts WHERE post_title like '%Untitled%'&quot; );&nbsp;</div></li><li><div>        $titles = array_values( $titles );&nbsp;</div></li><li><div>        while ( in_array( $title, $titles ) ) {&nbsp;</div></li><li><div>            $title = &quot;Untitled_$count&quot;;&nbsp;</div></li><li><div>            $count ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $title;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function prepare_date( $date_format, $value ) {&nbsp;</div></li><li><div>        $format = empty( $date_format ) ? 'mdy' : $date_format;&nbsp;</div></li><li><div>        $date_info = GFCommon::parse_date( $value, $format );&nbsp;</div></li><li><div>        if ( ! empty( $date_info ) && ! GFCommon::is_empty_array( $date_info ) ) {&nbsp;</div></li><li><div>            $value = sprintf( '%s-%02d-%02d', $date_info['year'], $date_info['month'], $date_info['day'] );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $value = '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Prepare the value before saving it to the lead.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed    $form&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param mixed    $value&nbsp;</div></li><li><div>     * @param mixed    $input_name&nbsp;</div></li><li><div>     * @param mixed    $lead_id the current lead ID, used for fields that are processed after other fields have been saved (ie Total, Calculations)&nbsp;</div></li><li><div>     * @param mixed    $lead    passed by the RGFormsModel::create_lead() method, lead ID is not available for leads created by this function&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return mixed&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function prepare_value( $form, $field, $value, $input_name, $lead_id, $lead = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = $field-&gt;get_value_save_entry( $value, $form, $input_name, $lead_id, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // special format for Post Category fields&nbsp;</div></li><li><div>        if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $full_values = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_array( $value ) ) {&nbsp;</div></li><li><div>                $value = explode( ', ', $value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            foreach ( $value as $cat_id ) {&nbsp;</div></li><li><div>                $cat = get_term( $cat_id, 'category' );&nbsp;</div></li><li><div>                $full_values[] = ! is_wp_error( $cat ) && is_object( $cat ) ? $cat-&gt;name . ':' . $cat_id : '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = implode( ', ', $full_values );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //do not save price fields with blank price&nbsp;</div></li><li><div>        if ( $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>            $ary = explode( '|', $value );&nbsp;</div></li><li><div>            $label = count( $ary ) &gt; 0 ? $ary[0] : '';&nbsp;</div></li><li><div>            $price = count( $ary ) &gt; 1 ? $ary[1] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $is_empty = ( strlen( trim( $price ) ) &lt;= 0 );&nbsp;</div></li><li><div>            if ( $is_empty ) {&nbsp;</div></li><li><div>                $value = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_checkbox_checked( $field_id, $field_label, $lead, $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //looping through lead detail values trying to find an item identical to the column label. Mark with a tick if found.&nbsp;</div></li><li><div>        $lead_field_keys = array_keys( $lead );&nbsp;</div></li><li><div>        foreach ( $lead_field_keys as $input_id ) {&nbsp;</div></li><li><div>            //mark as a tick if input label (from form meta) is equal to submitted value (from lead)&nbsp;</div></li><li><div>            if ( is_numeric( $input_id ) && absint( $input_id ) == absint( $field_id ) ) {&nbsp;</div></li><li><div>                if ( $lead[ $input_id ] == $field_label ) {&nbsp;</div></li><li><div>                    return $lead[ $input_id ];&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $field = RGFormsModel::get_field( $form, $field_id );&nbsp;</div></li><li><div>                    if ( $field-&gt;enableChoiceValue || $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>                        foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                            if ( $choice['value'] == $lead[ $field_id ] ) {&nbsp;</div></li><li><div>                                return $choice['value'];&nbsp;</div></li><li><div>                            } else if ( $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>                                $ary = explode( '|', $lead[ $field_id ] );&nbsp;</div></li><li><div>                                $val = count( $ary ) &gt; 0 ? $ary[0] : '';&nbsp;</div></li><li><div>                                $price = count( $ary ) &gt; 1 ? $ary[1] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ( $val == $choice['value'] ) {&nbsp;</div></li><li><div>                                    return $choice['value'];&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_fileupload_value( $form_id, $input_name ) {&nbsp;</div></li><li><div>        _deprecated_function( 'GFFormsModel::get_fileupload_value', '1.9', 'GF_Field_Fileupload::get_fileupload_value' );&nbsp;</div></li><li><div>        global $_gf_uploaded_files;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::get_fileupload_value(): Starting.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $_gf_uploaded_files ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::get_fileupload_value(): No files uploaded. Exiting.' );&nbsp;</div></li><li><div>            $_gf_uploaded_files = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $_gf_uploaded_files[ $input_name ] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //check if file has already been uploaded by previous step&nbsp;</div></li><li><div>            $file_info = self::get_temp_filename( $form_id, $input_name );&nbsp;</div></li><li><div>            $temp_filepath = self::get_upload_path( $form_id ) . '/tmp/' . $file_info['temp_filename'];&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::get_fileupload_value(): Temp file path: ' . $temp_filepath );&nbsp;</div></li><li><div>            if ( $file_info && file_exists( $temp_filepath ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormsModel::get_fileupload_value(): Moving temp file: ' . $temp_filepath );&nbsp;</div></li><li><div>                $_gf_uploaded_files[ $input_name ] = self::move_temp_file( $form_id, $file_info );&nbsp;</div></li><li><div>            } else if ( ! empty( $_FILES[ $input_name ]['name'] ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormsModel::get_fileupload_value(): Uploading file: ' . $_FILES[ $input_name ]['name'] );&nbsp;</div></li><li><div>                $_gf_uploaded_files[ $input_name ] = self::upload_file( $form_id, $_FILES[ $input_name ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return rgget( $input_name, $_gf_uploaded_files );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_unique_id( $form_id ) {&nbsp;</div></li><li><div>        $unique_id = '';&nbsp;</div></li><li><div>        if ( rgpost( 'gform_submit' ) == $form_id ) {&nbsp;</div></li><li><div>            $posted_uid = rgpost( 'gform_unique_id' );&nbsp;</div></li><li><div>            if ( false === empty( $posted_uid ) && ctype_alnum( $posted_uid )) {&nbsp;</div></li><li><div>                $unique_id = $posted_uid;&nbsp;</div></li><li><div>                self::$unique_ids[ $form_id ] = $unique_id;&nbsp;</div></li><li><div>            } elseif ( isset( self::$unique_ids[ $form_id ] ) ) {&nbsp;</div></li><li><div>                $unique_id = self::$unique_ids[ $form_id ];&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $unique_id = uniqid();&nbsp;</div></li><li><div>                self::$unique_ids[ $form_id ] = $unique_id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $unique_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_temp_filename( $form_id, $input_name ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $uploaded_filename = ! empty( $_FILES[ $input_name ]['name'] ) && $_FILES[ $input_name ]['error'] === 0 ? $_FILES[ $input_name ]['name'] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $uploaded_filename ) && isset( self::$uploaded_files[ $form_id ] ) ) {&nbsp;</div></li><li><div>            $uploaded_filename = rgget( $input_name, self::$uploaded_files[ $form_id ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $uploaded_filename ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_unique_id = self::get_form_unique_id( $form_id );&nbsp;</div></li><li><div>        $pathinfo = pathinfo( $uploaded_filename );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'uploaded_filename' =&gt; $uploaded_filename, 'temp_filename' =&gt; &quot;{$form_unique_id}_{$input_name}.{$pathinfo['extension']}&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_choice_text( $field, $value, $input_id = 0 ) {&nbsp;</div></li><li><div>        if ( ! is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>            return $value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>            if ( is_array( $value ) && self::choice_value_match( $field, $choice, $value[ $input_id ] ) ) {&nbsp;</div></li><li><div>                return $choice['text'];&nbsp;</div></li><li><div>            } else if ( ! is_array( $value ) && self::choice_value_match( $field, $choice, $value ) ) {&nbsp;</div></li><li><div>                return $choice['text'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return is_array( $value ) ? '' : $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function choice_value_match( $field, $choice, $value ) {&nbsp;</div></li><li><div>        $choice_value = GFFormsModel::maybe_trim_input( $choice['value'], $field-&gt;formId, $field );&nbsp;</div></li><li><div>        $value = GFFormsModel::maybe_trim_input( $value, $field-&gt;formId, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $allowed_html = wp_kses_allowed_html( 'post' );&nbsp;</div></li><li><div>        $sanitized_value = wp_kses( $value, $allowed_html );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $choice_value == $value || $choice_value == $sanitized_value ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        } else if ( $field-&gt;enablePrice ) {&nbsp;</div></li><li><div>            $ary = explode( '|', $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $val = count( $ary ) &gt; 0 ? $ary[0] : '';&nbsp;</div></li><li><div>            $sanitized_val = wp_kses( $val, $allowed_html );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $price = count( $ary ) &gt; 1 ? $ary[1] : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $choice['value'] == $val || $choice['value'] == $sanitized_val ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } // add support for prepopulating multiselects @alex&nbsp;</div></li><li><div>        else if ( RGFormsModel::get_input_type( $field ) == 'multiselect' ) {&nbsp;</div></li><li><div>            $values = explode( ', ', $value );&nbsp;</div></li><li><div>            $sanitized_values = explode( ', ', $sanitized_value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( in_array( $choice_value, $values ) || in_array( $choice_value, $sanitized_values ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function choices_value_match( $field, $choices, $value ) {&nbsp;</div></li><li><div>        foreach ( $choices as $choice ) {&nbsp;</div></li><li><div>            if ( self::choice_value_match( $field, $choice, $value ) ) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function create_post( $form, &$lead ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::create_post(): Starting.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_post_field = false;&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            $is_hidden = self::is_field_hidden( $form, $field, array(), $lead );&nbsp;</div></li><li><div>            if ( ! $is_hidden && in_array( $field-&gt;type, array( 'post_category', 'post_title', 'post_content', 'post_excerpt', 'post_tags', 'post_custom_field', 'post_image' ) ) ) {&nbsp;</div></li><li><div>                $has_post_field = true;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if this form does not have any post fields, don't create a post&nbsp;</div></li><li><div>        if ( ! $has_post_field ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( &quot;GFFormsModel::create_post(): Stopping. The form doesn't have any post fields.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $lead;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //processing post fields&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::create_post(): Getting post fields.' );&nbsp;</div></li><li><div>        $post_data = self::get_post_fields( $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //allowing users to change post fields before post gets created&nbsp;</div></li><li><div>        $post_data = gf_apply_filters( array( 'gform_post_data', $form['id'] ), $post_data, $form, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding default title if none of the required post fields are in the form (will make sure wp_insert_post() inserts the post)&nbsp;</div></li><li><div>        if ( empty( $post_data['post_title'] ) && empty( $post_data['post_content'] ) && empty( $post_data['post_excerpt'] ) ) {&nbsp;</div></li><li><div>            $post_data['post_title'] = self::get_default_post_title();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // remove original post status and save it for later&nbsp;</div></li><li><div>        $post_status = $post_data['post_status'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // replace original post status with 'draft' so other plugins know this post is not fully populated yet&nbsp;</div></li><li><div>        $post_data['post_status'] = 'draft';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // inserting post&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::create_post(): Inserting post via wp_insert_post().' );&nbsp;</div></li><li><div>        $post_id = wp_insert_post( $post_data );&nbsp;</div></li><li><div>        GFCommon::log_debug( &quot;GFFormsModel::create_post(): Result from wp_insert_post(): {$post_id}.&quot; );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding form id and entry id hidden custom fields&nbsp;</div></li><li><div>        add_post_meta( $post_id, '_gform-form-id', $form['id'] );&nbsp;</div></li><li><div>        add_post_meta( $post_id, '_gform-entry-id', $lead['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creating post images&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::create_post(): Creating post images.' );&nbsp;</div></li><li><div>        $post_images = array();&nbsp;</div></li><li><div>        foreach ( $post_data['images'] as $image ) {&nbsp;</div></li><li><div>            $image_meta = array(&nbsp;</div></li><li><div>                'post_excerpt' =&gt; $image['caption'], &nbsp;</div></li><li><div>                'post_content' =&gt; $image['description'], &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //adding title only if it is not empty. It will default to the file name if it is not in the array&nbsp;</div></li><li><div>            if ( ! empty( $image['title'] ) ) {&nbsp;</div></li><li><div>                $image_meta['post_title'] = $image['title'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! empty( $image['url'] ) ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormsModel::create_post(): Adding image: ' . $image['url'] );&nbsp;</div></li><li><div>                $media_id = self::media_handle_upload( $image['url'], $post_id, $image_meta );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $media_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //save media id for post body/title template variable replacement (below)&nbsp;</div></li><li><div>                    $post_images[ $image['field_id'] ] = $media_id;&nbsp;</div></li><li><div>                    $lead[ $image['field_id'] ] .= &quot;|:|$media_id&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // set featured image&nbsp;</div></li><li><div>                    $field = RGFormsModel::get_field( $form, $image['field_id'] );&nbsp;</div></li><li><div>                    if ( $field-&gt;postFeaturedImage ) {&nbsp;</div></li><li><div>                        set_post_thumbnail( $post_id, $media_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding custom fields&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::create_post(): Adding custom fields.' );&nbsp;</div></li><li><div>        foreach ( $post_data['post_custom_fields'] as $meta_name =&gt; $meta_value ) {&nbsp;</div></li><li><div>            if ( ! is_array( $meta_value ) ) {&nbsp;</div></li><li><div>                $meta_value = array( $meta_value );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $meta_index = 0;&nbsp;</div></li><li><div>            foreach ( $meta_value as $value ) {&nbsp;</div></li><li><div>                GFCommon::log_debug( 'GFFormsModel::create_post(): Getting custom field: ' . $meta_name );&nbsp;</div></li><li><div>                $custom_field = self::get_custom_field( $form, $meta_name, $meta_index );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //replacing template variables if template is enabled&nbsp;</div></li><li><div>                if ( $custom_field && rgget( 'customFieldTemplateEnabled', $custom_field ) ) {&nbsp;</div></li><li><div>                    //replacing post image variables&nbsp;</div></li><li><div>                    GFCommon::log_debug( 'GFFormsModel::create_post(): Replacing post image variables.' );&nbsp;</div></li><li><div>                    $value = GFCommon::replace_variables_post_image( $custom_field['customFieldTemplate'], $post_images, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //replacing all other variables&nbsp;</div></li><li><div>                    $value = GFCommon::replace_variables( $value, $form, $lead, false, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // replace conditional shortcodes&nbsp;</div></li><li><div>                    $value = do_shortcode( $value );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                switch ( RGFormsModel::get_input_type( $custom_field ) ) {&nbsp;</div></li><li><div>                    case 'list' :&nbsp;</div></li><li><div>                        $value = maybe_unserialize( $value );&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            foreach ( $value as $item ) {&nbsp;</div></li><li><div>                                if ( is_array( $item ) ) {&nbsp;</div></li><li><div>                                    $item = implode( '|', $item );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                                if ( ! rgblank( $item ) ) {&nbsp;</div></li><li><div>                                    add_post_meta( $post_id, $meta_name, $item );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'multiselect' :&nbsp;</div></li><li><div>                    case 'checkbox' :&nbsp;</div></li><li><div>                        $value = explode( ', ', $value );&nbsp;</div></li><li><div>                        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>                            foreach ( $value as $item ) {&nbsp;</div></li><li><div>                                if ( ! rgblank( $item ) ) {&nbsp;</div></li><li><div>                                    // add post meta and replace HTML symbol in $item with real comma&nbsp;</div></li><li><div>                                    add_post_meta( $post_id, $meta_name, str_replace( '&#44;', ', ', $item ) );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    case 'date' :&nbsp;</div></li><li><div>                        $value = GFCommon::date_display( $value, rgar( $custom_field, 'dateFormat' ) );&nbsp;</div></li><li><div>                        if ( ! rgblank( $value ) ) {&nbsp;</div></li><li><div>                            add_post_meta( $post_id, $meta_name, $value );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    default :&nbsp;</div></li><li><div>                        if ( ! rgblank( $value ) ) {&nbsp;</div></li><li><div>                            add_post_meta( $post_id, $meta_name, $value );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $meta_index ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $has_content_field = sizeof( self::get_fields_by_type( $form, array( 'post_content' ) ) ) &gt; 0;&nbsp;</div></li><li><div>        $has_title_field = sizeof( self::get_fields_by_type( $form, array( 'post_title' ) ) ) &gt; 0;&nbsp;</div></li><li><div>        $post = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if a post field was configured with a content or title template, process template&nbsp;</div></li><li><div>        if ( ( rgar( $form, 'postContentTemplateEnabled' ) && $has_content_field ) || ( rgar( $form, 'postTitleTemplateEnabled' ) && $has_title_field ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::create_post(): Processing template.' );&nbsp;</div></li><li><div>            $post = get_post( $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( rgar( $form, 'postContentTemplateEnabled' ) && $has_content_field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //replacing post image variables&nbsp;</div></li><li><div>                $post_content = GFCommon::replace_variables_post_image( $form['postContentTemplate'], $post_images, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //replacing all other variables&nbsp;</div></li><li><div>                $post_content = GFCommon::replace_variables( $post_content, $form, $lead, false, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //updating post content&nbsp;</div></li><li><div>                $post-&gt;post_content = $post_content;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( rgar( $form, 'postTitleTemplateEnabled' ) && $has_title_field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //replacing post image variables&nbsp;</div></li><li><div>                $post_title = GFCommon::replace_variables_post_image( $form['postTitleTemplate'], $post_images, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //replacing all other variables&nbsp;</div></li><li><div>                $post_title = GFCommon::replace_variables( $post_title, $form, $lead, false, false, false );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // replace conditional shortcodes&nbsp;</div></li><li><div>                $post_title = do_shortcode( $post_title );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //updating post&nbsp;</div></li><li><div>                $post-&gt;post_title = $post_title;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $post-&gt;post_name = $post_title;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update post status back to original status (if not draft)&nbsp;</div></li><li><div>        if ( $post_status != 'draft' ) {&nbsp;</div></li><li><div>            $post = is_object( $post ) ? $post : get_post( $post_id );&nbsp;</div></li><li><div>            $post-&gt;post_status = $post_status;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if post has been modified since creation, save updates&nbsp;</div></li><li><div>        if ( is_object( $post ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::create_post(): Updating post.' );&nbsp;</div></li><li><div>            wp_update_post( $post );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding post format&nbsp;</div></li><li><div>        if ( current_theme_supports( 'post-formats' ) && rgar( $form, 'postFormat' ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $formats = get_theme_support( 'post-formats' );&nbsp;</div></li><li><div>            $post_format = rgar( $form, 'postFormat' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $formats ) ) {&nbsp;</div></li><li><div>                $formats = $formats[0];&nbsp;</div></li><li><div>                if ( in_array( $post_format, $formats ) ) {&nbsp;</div></li><li><div>                    set_post_format( $post_id, $post_format );&nbsp;</div></li><li><div>                } else if ( '0' == $post_format ) {&nbsp;</div></li><li><div>                    set_post_format( $post_id, false );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //update post_id field if a post was created&nbsp;</div></li><li><div>        $lead['post_id'] = $post_id;&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::create_post(): Updating entry with post id.' );&nbsp;</div></li><li><div>        self::update_lead_property( $lead['id'], 'post_id', $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Fires after a post, from a form with post fields, is created&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $form['id'] The ID of the form where the new post was created&nbsp;</div></li><li><div>         * @param int $post_id The new Post ID created after submission&nbsp;</div></li><li><div>         * @param array $lead The Lead Object&nbsp;</div></li><li><div>         * @param array $form The Form Object for the form used to create the post&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        gf_do_action( array( 'gform_after_create_post', $form['id'] ), $post_id, $lead, $form );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $post_id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_custom_field( $form, $meta_name, $meta_index ) {&nbsp;</div></li><li><div>        $custom_fields = self::get_fields_by_type( $form, array( 'post_custom_field' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $index = 0;&nbsp;</div></li><li><div>        foreach ( $custom_fields as $field ) {&nbsp;</div></li><li><div>            if ( $field-&gt;postCustomFieldName == $meta_name ) {&nbsp;</div></li><li><div>                if ( $meta_index == $index ) {&nbsp;</div></li><li><div>                    return $field;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $index ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function copy_post_image( $url, $post_id ) {&nbsp;</div></li><li><div>        $time = current_time( 'mysql' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $post = get_post( $post_id ) ) {&nbsp;</div></li><li><div>            if ( substr( $post-&gt;post_date, 0, 4 ) &gt; 0 ) {&nbsp;</div></li><li><div>                $time = $post-&gt;post_date;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //making sure there is a valid upload folder&nbsp;</div></li><li><div>        if ( ! ( ( $upload_dir = wp_upload_dir( $time ) ) && false === $upload_dir['error'] ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = get_post_meta( $post_id, '_gform-form-id', true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Filter the media upload location.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param array $upload_dir The current upload directory*s path and url.&nbsp;</div></li><li><div>         * @param int $form_id The ID of the form currently being processed.&nbsp;</div></li><li><div>         * @param int $post_id The ID of the post created from the entry currently being processed.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $upload_dir = gf_apply_filters( 'gform_media_upload_path', $form_id, $upload_dir, $form_id, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! file_exists( $upload_dir['path'] ) ) {&nbsp;</div></li><li><div>            if ( ! wp_mkdir_p( $upload_dir['path'] ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $name = basename( $url );&nbsp;</div></li><li><div>        $filename = wp_unique_filename( $upload_dir['path'], $name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // the destination path&nbsp;</div></li><li><div>        $new_file = $upload_dir['path'] . &quot;/$filename&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // the source path&nbsp;</div></li><li><div>        $y = substr( $time, 0, 4 );&nbsp;</div></li><li><div>        $m = substr( $time, 5, 2 );&nbsp;</div></li><li><div>        $target_root = self::get_upload_path( $form_id ) . &quot;/$y/$m/&quot;;&nbsp;</div></li><li><div>        $target_root_url = self::get_upload_url( $form_id ) . &quot;/$y/$m/&quot;;&nbsp;</div></li><li><div>        $upload_root_info = array( 'path' =&gt; $target_root, 'url' =&gt; $target_root_url );&nbsp;</div></li><li><div>        $upload_root_info = gf_apply_filters( 'gform_upload_path', $form_id, $upload_root_info, $form_id );&nbsp;</div></li><li><div>        $path = str_replace( $upload_root_info['url'], $upload_root_info['path'], $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // copy the file to the destination path&nbsp;</div></li><li><div>        if ( ! copy( $path, $new_file ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Set correct file permissions&nbsp;</div></li><li><div>        $stat = stat( dirname( $new_file ) );&nbsp;</div></li><li><div>        $perms = $stat['mode'] & 0000666;&nbsp;</div></li><li><div>        @ chmod( $new_file, $perms );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Compute the URL&nbsp;</div></li><li><div>        $url = $upload_dir['url'] . &quot;/$filename&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_multisite() ) {&nbsp;</div></li><li><div>            delete_transient( 'dirsize_cache' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $type = wp_check_filetype( $new_file );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'file' =&gt; $new_file, 'url' =&gt; $url, 'type' =&gt; $type['type'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function media_handle_upload( $url, $post_id, $post_data = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //WordPress Administration API required for the media_handle_upload() function&nbsp;</div></li><li><div>        require_once( ABSPATH . 'wp-admin/includes/image.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $name = basename( $url );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file = self::copy_post_image( $url, $post_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $file ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $name_parts = pathinfo( $name );&nbsp;</div></li><li><div>        $name = trim( substr( $name, 0, - ( 1 + strlen( $name_parts['extension'] ) ) ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $url = $file['url'];&nbsp;</div></li><li><div>        $type = $file['type'];&nbsp;</div></li><li><div>        $file = $file['file'];&nbsp;</div></li><li><div>        $title = $name;&nbsp;</div></li><li><div>        $content = '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // use image exif/iptc data for title and caption defaults if possible&nbsp;</div></li><li><div>        if ( $image_meta = @wp_read_image_metadata( $file ) ) {&nbsp;</div></li><li><div>            if ( trim( $image_meta['title'] ) && ! is_numeric( sanitize_title( $image_meta['title'] ) ) ) {&nbsp;</div></li><li><div>                $title = $image_meta['title'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( trim( $image_meta['caption'] ) ) {&nbsp;</div></li><li><div>                $content = $image_meta['caption'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Construct the attachment array&nbsp;</div></li><li><div>        $attachment = array_merge(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'post_mime_type' =&gt; $type, &nbsp;</div></li><li><div>                'guid' =&gt; $url, &nbsp;</div></li><li><div>                'post_parent' =&gt; $post_id, &nbsp;</div></li><li><div>                'post_title' =&gt; $title, &nbsp;</div></li><li><div>                'post_content' =&gt; $content, &nbsp;</div></li><li><div> ), $post_data&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save the data&nbsp;</div></li><li><div>        $id = wp_insert_attachment( $attachment, $file, $post_id );&nbsp;</div></li><li><div>        if ( ! is_wp_error( $id ) ) {&nbsp;</div></li><li><div>            wp_update_attachment_metadata( $id, wp_generate_attachment_metadata( $id, $file ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $id;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_input( $form, $field, &$lead, $current_fields, $input_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $input_name = 'input_' . str_replace( '.', '_', $input_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $field-&gt;enableCopyValuesOption && rgpost( 'input_' . $field-&gt;id . '_copy_values_activated' ) ) {&nbsp;</div></li><li><div>            $source_field_id = $field-&gt;copyValuesOptionField;&nbsp;</div></li><li><div>            $source_input_name = str_replace( 'input_' . $field-&gt;id, 'input_' . $source_field_id, $input_name );&nbsp;</div></li><li><div>            $value = rgpost( $source_input_name );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $value = rgpost( $input_name );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $value = self::maybe_trim_input( $value, $form['id'], $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //ignore file upload when nothing was sent in the admin&nbsp;</div></li><li><div>        //ignore post fields in the admin&nbsp;</div></li><li><div>        $type = self::get_input_type( $field );&nbsp;</div></li><li><div>        $multiple_files = $field-&gt;multipleFiles;&nbsp;</div></li><li><div>        $uploaded_files = GFFormsModel::$uploaded_files;&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        if ( RG_CURRENT_VIEW == 'entry' && $type == 'fileupload' && ( ( ! $multiple_files && empty( $_FILES[ $input_name ]['name'] ) ) || ( $multiple_files && ! isset( $uploaded_files[ $form_id ][ $input_name ] ) ) ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        } else if ( RG_CURRENT_VIEW == 'entry' && in_array( $field-&gt;type, array( 'post_category', 'post_title', 'post_content', 'post_excerpt', 'post_tags', 'post_custom_field', 'post_image' ) ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_form_editor = GFCommon::is_form_editor();&nbsp;</div></li><li><div>        $is_entry_detail = GFCommon::is_entry_detail();&nbsp;</div></li><li><div>        $is_admin = $is_form_editor || $is_entry_detail;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $value ) && $field-&gt;adminOnly && ! $is_admin ) {&nbsp;</div></li><li><div>            $value = self::get_default_value( $field, $input_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //processing values so that they are in the correct format for each input type&nbsp;</div></li><li><div>        $value = self::prepare_value( $form, $field, $value, $input_name, rgar( $lead, 'id' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //ignore fields that have not changed&nbsp;</div></li><li><div>        if ( $lead != null && isset( $lead[ $input_id ] ) && $value === rgget( (string) $input_id, $lead ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_id = self::get_lead_detail_id( $current_fields, $input_id );&nbsp;</div></li><li><div>        $result = self::update_lead_field_value( $form, $lead, $field, $lead_detail_id, $input_id, $value );&nbsp;</div></li><li><div>        GFCommon::log_debug( __METHOD__ . &quot;(): Saving: {$field-&gt;label}(#{$input_id} - {$field-&gt;type}). Result: &quot; . var_export( $result, 1 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Updates an existing field value in the database.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form&nbsp;</div></li><li><div>     * @param array $lead&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param int $lead_detail_id&nbsp;</div></li><li><div>     * @param string $input_id&nbsp;</div></li><li><div>     * @param string $value&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return bool&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_lead_field_value( $form, $lead, $field, $lead_detail_id, $input_id, $value ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $value ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( __METHOD__ . '(): bailing. value is an array.' );&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_id = $lead['id'];&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        $lead_detail_table = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_detail_long_table = self::get_lead_details_long_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! rgblank( $value ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = gf_apply_filters( array( 'gform_save_field_value', $form['id'], $field-&gt;id ), $value, $lead, $field, $form, $input_id );&nbsp;</div></li><li><div>            $truncated_value = get_option( 'gform_longtext_ready' ) ? $value : GFCommon::safe_substr( $value, 0, GFORMS_MAX_FIELD_LENGTH );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $lead_detail_id &gt; 0 ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $result = $wpdb-&gt;update( $lead_detail_table, array( 'value' =&gt; $truncated_value ), array( 'id' =&gt; $lead_detail_id ), array( '%s' ), array( '%d' ) );&nbsp;</div></li><li><div>                if ( false === $result ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //insert, update or delete long value&nbsp;</div></li><li><div>                $sql = $wpdb-&gt;prepare( &quot;SELECT count(0) FROM $lead_detail_long_table WHERE lead_detail_id=%d&quot;, $lead_detail_id );&nbsp;</div></li><li><div>                $has_long_field = intval( $wpdb-&gt;get_var( $sql ) ) &gt; 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //delete long field if value has been shortened&nbsp;</div></li><li><div>                if ( $has_long_field && GFCommon::safe_strlen( $value ) &lt;= GFORMS_MAX_FIELD_LENGTH ) {&nbsp;</div></li><li><div>                    $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_detail_long_table WHERE lead_detail_id=%d&quot;, $lead_detail_id );&nbsp;</div></li><li><div>                    $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>                    if ( false === $result ) {&nbsp;</div></li><li><div>                        return false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } //update long field&nbsp;</div></li><li><div>                else if ( $has_long_field ) {&nbsp;</div></li><li><div>                    $result = $wpdb-&gt;update( $lead_detail_long_table, array( 'value' =&gt; $value ), array( 'lead_detail_id' =&gt; $lead_detail_id ), array( '%s' ), array( '%d' ) );&nbsp;</div></li><li><div>                    if ( false === $result ) {&nbsp;</div></li><li><div>                        return false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } //insert long field (value has been increased)&nbsp;</div></li><li><div>                else if ( GFCommon::safe_strlen( $value ) &gt; GFORMS_MAX_FIELD_LENGTH ) {&nbsp;</div></li><li><div>                    $result = $wpdb-&gt;insert( $lead_detail_long_table, array( 'lead_detail_id' =&gt; $lead_detail_id, 'value' =&gt; $value ), array( '%d', '%s' ) );&nbsp;</div></li><li><div>                    if ( false === $result ) {&nbsp;</div></li><li><div>                        return false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $result = $wpdb-&gt;insert( $lead_detail_table, array( 'lead_id' =&gt; $lead_id, 'form_id' =&gt; $form_id, 'field_number' =&gt; $input_id, 'value' =&gt; $truncated_value ), array( '%d', '%d', '%F', '%s' ) );&nbsp;</div></li><li><div>                if ( false === $result ) {&nbsp;</div></li><li><div>                    return false;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( GFCommon::safe_strlen( $value ) &gt; GFORMS_MAX_FIELD_LENGTH ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //read newly created lead detal id&nbsp;</div></li><li><div>                    $lead_detail_id = $wpdb-&gt;insert_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //insert long value&nbsp;</div></li><li><div>                    $result = $wpdb-&gt;insert( $lead_detail_long_table, array( 'lead_detail_id' =&gt; $lead_detail_id, 'value' =&gt; $value ), array( '%d', '%s' ) );&nbsp;</div></li><li><div>                    if ( false === $result ) {&nbsp;</div></li><li><div>                        return false;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Deleting long field if there is one&nbsp;</div></li><li><div>            $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                &quot;DELETE $lead_detail_long_table FROM $lead_detail_long_table&nbsp;</div></li><li><div>                JOIN (&nbsp;</div></li><li><div>                    SELECT ld.id FROM $lead_detail_table ld&nbsp;</div></li><li><div>                    WHERE lead_id=%d AND field_number BETWEEN %s AND %s&nbsp;</div></li><li><div> ) tmp&nbsp;</div></li><li><div>                ON tmp.id = $lead_detail_long_table.lead_detail_id&quot;, &nbsp;</div></li><li><div>                $lead_id, doubleval( $input_id ) - 0.0001, doubleval( $input_id ) + 0.0001&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $result === false ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //Deleting details for this field&nbsp;</div></li><li><div>            $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $lead_detail_table WHERE lead_id=%d AND field_number BETWEEN %s AND %s &quot;, $lead_id, doubleval( $input_id ) - 0.0001, doubleval( $input_id ) + 0.0001 );&nbsp;</div></li><li><div>            $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>            if ( false === $result ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function move_temp_file( $form_id, $tempfile_info ) {&nbsp;</div></li><li><div>        _deprecated_function( 'move_temp_file', '1.9', 'GF_Field_Fileupload::move_temp_file' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $target = self::get_file_upload_path( $form_id, $tempfile_info['uploaded_filename'] );&nbsp;</div></li><li><div>        $source = self::get_upload_path( $form_id ) . '/tmp/' . $tempfile_info['temp_filename'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( rename( $source, $target['path'] ) ) {&nbsp;</div></li><li><div>            self::set_permissions( $target['path'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $target['url'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return 'FAILED (Temporary file could not be moved.)';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function set_permissions( $path ) {&nbsp;</div></li><li><div>        $permission = apply_filters( 'gform_file_permission', 0644, $path );&nbsp;</div></li><li><div>        if ( $permission ) {&nbsp;</div></li><li><div>            chmod( $path, $permission );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function upload_file( $form_id, $file ) {&nbsp;</div></li><li><div>        _deprecated_function( 'upload_file', '1.9', 'GF_Field_Fileupload::upload_file' );&nbsp;</div></li><li><div>        $target = self::get_file_upload_path( $form_id, $file['name'] );&nbsp;</div></li><li><div>        if ( ! $target ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::upload_file(): FAILED (Upload folder could not be created.)' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return 'FAILED (Upload folder could not be created.)';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( move_uploaded_file( $file['tmp_name'], $target['path'] ) ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::upload_file(): Setting permissions on ' . $target['path'] );&nbsp;</div></li><li><div>            self::set_permissions( $target['path'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $target['url'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::upload_file(): FAILED (Temporary file could not be copied.)' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return 'FAILED (Temporary file could not be copied.)';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_upload_root() {&nbsp;</div></li><li><div>        $dir = wp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $dir['error'] ) {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $dir['basedir'] . '/gravity_forms/';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_upload_url_root() {&nbsp;</div></li><li><div>        $dir = wp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $dir['error'] ) {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $dir['baseurl'] . '/gravity_forms/';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_upload_path( $form_id ) {&nbsp;</div></li><li><div>        $form_id = absint( $form_id );&nbsp;</div></li><li><div>        return self::get_upload_root() . $form_id . '-' . wp_hash( $form_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_upload_url( $form_id ) {&nbsp;</div></li><li><div>        $form_id = absint( $form_id );&nbsp;</div></li><li><div>        $dir = wp_upload_dir();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $dir['baseurl'] . &quot;/gravity_forms/$form_id&quot; . '-' . wp_hash( $form_id );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_file_upload_path( $form_id, $file_name ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( get_magic_quotes_gpc() ) {&nbsp;</div></li><li><div>            $file_name = stripslashes( $file_name );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = absint( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Where the file is going to be placed&nbsp;</div></li><li><div>        // Generate the yearly and monthly dirs&nbsp;</div></li><li><div>        $time = current_time( 'mysql' );&nbsp;</div></li><li><div>        $y = substr( $time, 0, 4 );&nbsp;</div></li><li><div>        $m = substr( $time, 5, 2 );&nbsp;</div></li><li><div>        $target_root = self::get_upload_path( $form_id ) . &quot;/$y/$m/&quot;;&nbsp;</div></li><li><div>        $target_root_url = self::get_upload_url( $form_id ) . &quot;/$y/$m/&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding filter to upload root path and url&nbsp;</div></li><li><div>        $upload_root_info = array( 'path' =&gt; $target_root, 'url' =&gt; $target_root_url );&nbsp;</div></li><li><div>        $upload_root_info = gf_apply_filters( array( 'gform_upload_path', $form_id ), $upload_root_info, $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $target_root = $upload_root_info['path'];&nbsp;</div></li><li><div>        $target_root_url = $upload_root_info['url'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_dir( $target_root ) ) {&nbsp;</div></li><li><div>            if ( ! wp_mkdir_p( $target_root ) ) {&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //adding index.html files to all subfolders&nbsp;</div></li><li><div>            if ( ! file_exists( self::get_upload_root() . '/index.html' ) ) {&nbsp;</div></li><li><div>                GFCommon::recursive_add_index_file( self::get_upload_root() );&nbsp;</div></li><li><div>            } else if ( ! file_exists( self::get_upload_path( $form_id ) . '/index.html' ) ) {&nbsp;</div></li><li><div>                GFCommon::recursive_add_index_file( self::get_upload_path( $form_id ) );&nbsp;</div></li><li><div>            } else if ( ! file_exists( self::get_upload_path( $form_id ) . &quot;/$y/index.html&quot; ) ) {&nbsp;</div></li><li><div>                GFCommon::recursive_add_index_file( self::get_upload_path( $form_id ) . &quot;/$y&quot; );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                GFCommon::recursive_add_index_file( self::get_upload_path( $form_id ) . &quot;/$y/$m&quot; );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Add the original filename to our target path.&nbsp;</div></li><li><div>        //Result is &quot;uploads/filename.extension&quot;&nbsp;</div></li><li><div>        $file_info = pathinfo( $file_name );&nbsp;</div></li><li><div>        $extension = rgar( $file_info, 'extension' );&nbsp;</div></li><li><div>        if ( ! empty( $extension ) ) {&nbsp;</div></li><li><div>            $extension = '.' . $extension;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $file_name = basename( $file_info['basename'], $extension );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file_name = sanitize_file_name( $file_name );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $counter = 1;&nbsp;</div></li><li><div>        $target_path = $target_root . $file_name . $extension;&nbsp;</div></li><li><div>        while ( file_exists( $target_path ) ) {&nbsp;</div></li><li><div>            $target_path = $target_root . $file_name . &quot;$counter&quot; . $extension;&nbsp;</div></li><li><div>            $counter ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Remove '.' from the end if file does not have a file extension&nbsp;</div></li><li><div>        $target_path = trim( $target_path, '.' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //creating url&nbsp;</div></li><li><div>        $target_url = str_replace( $target_root, $target_root_url, $target_path );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array( 'path' =&gt; $target_path, 'url' =&gt; $target_url );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_tables() {&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            self::get_lead_details_long_table_name(), &nbsp;</div></li><li><div>            self::get_lead_notes_table_name(), &nbsp;</div></li><li><div>            self::get_lead_details_table_name(), &nbsp;</div></li><li><div>            self::get_lead_table_name(), &nbsp;</div></li><li><div>            self::get_form_view_table_name(), &nbsp;</div></li><li><div>            self::get_meta_table_name(), &nbsp;</div></li><li><div>            self::get_form_table_name(), &nbsp;</div></li><li><div>            self::get_lead_meta_table_name(), &nbsp;</div></li><li><div>            self::get_incomplete_submissions_table_name(), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function drop_tables() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        foreach ( self::get_tables() as $table ) {&nbsp;</div></li><li><div>            $wpdb-&gt;query( &quot;DROP TABLE IF EXISTS $table&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function mu_drop_tables( $drop_tables ) {&nbsp;</div></li><li><div>        return array_merge( $drop_tables, self::get_tables() );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function insert_form_view( $form_id, $ip ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $table_name = self::get_form_view_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; SELECT id FROM $table_name&nbsp;</div></li><li><div>                                WHERE form_id=%d&nbsp;</div></li><li><div>                                AND year(date_created) = year(utc_timestamp())&nbsp;</div></li><li><div>                                AND month(date_created) = month(utc_timestamp())&nbsp;</div></li><li><div>                                AND day(date_created) = day(utc_timestamp())&nbsp;</div></li><li><div>                                AND hour(date_created) = hour(utc_timestamp())&quot;, $form_id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = $wpdb-&gt;get_var( $sql, 0, 0 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $id ) ) {&nbsp;</div></li><li><div>            $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;INSERT INTO $table_name(form_id, date_created, ip) values(%d, utc_timestamp(), %s)&quot;, $form_id, $ip ) );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $wpdb-&gt;query( $wpdb-&gt;prepare( &quot;UPDATE $table_name SET count = count+1 WHERE id=%d&quot;, $id ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_duplicate( $form_id, $field, $value ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_detail_long = self::get_lead_details_long_table_name();&nbsp;</div></li><li><div>        $is_long = ! is_array( $value ) && strlen( $value ) &gt; GFORMS_MAX_FIELD_LENGTH - 10;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql_comparison = $is_long ? '( ld.value = %s OR ldl.value = %s )' : 'ld.value = %s';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( GFFormsModel::get_input_type( $field ) ) {&nbsp;</div></li><li><div>            case 'time':&nbsp;</div></li><li><div>                $value = sprintf( &quot;%02d:%02d %s&quot;, $value[0], $value[1], $value[2] );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'date':&nbsp;</div></li><li><div>                $value = self::prepare_date( $field-&gt;dateFormat, $value );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'number':&nbsp;</div></li><li><div>                $value = GFCommon::clean_number( $value, $field-&gt;numberFormat );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'phone':&nbsp;</div></li><li><div>                $value = str_replace( array( ')', '(', '-', ' ' ), '', $value );&nbsp;</div></li><li><div>                $sql_comparison = 'replace( replace( replace( replace( ld.value, &quot;)&quot;, &quot;&quot; ), &quot;(&quot;, &quot;&quot; ), &quot;-&quot;, &quot;&quot; ), &quot; &quot;, &quot;&quot; ) = %s';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'email':&nbsp;</div></li><li><div>                $value = is_array( $value ) ? rgar( $value, 0 ) : $value;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $inner_sql_template = &quot;SELECT %s as input, ld.lead_id&nbsp;</div></li><li><div>                                FROM {$lead_detail_table_name} ld&nbsp;</div></li><li><div>                                INNER JOIN {$lead_table_name} l ON l.id = ld.lead_id\n&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_long ) {&nbsp;</div></li><li><div>            $inner_sql_template .= &quot;INNER JOIN {$lead_detail_long} ldl ON ldl.lead_detail_id = ld.id\n&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $inner_sql_template .= &quot;WHERE l.form_id=%d AND ld.form_id=%d&nbsp;</div></li><li><div>                                AND ld.field_number between %s AND %s&nbsp;</div></li><li><div>                                AND status='active' AND {$sql_comparison}&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT count(distinct input) as match_count FROM ( &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $input_count = 1;&nbsp;</div></li><li><div>        if ( is_array( $field-&gt;get_entry_inputs() ) ) {&nbsp;</div></li><li><div>            $input_count = sizeof( $field-&gt;inputs );&nbsp;</div></li><li><div>            foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                $union = empty( $inner_sql ) ? '' : ' UNION ALL ';&nbsp;</div></li><li><div>                $inner_sql .= $union . $wpdb-&gt;prepare( $inner_sql_template, $input['id'], $form_id, $form_id, $input['id'] - 0.0001, $input['id'] + 0.0001, $value[ $input['id'] ], $value[ $input['id'] ] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $inner_sql = $wpdb-&gt;prepare( $inner_sql_template, $field-&gt;id, $form_id, $form_id, doubleval( $field-&gt;id ) - 0.0001, doubleval( $field-&gt;id ) + 0.0001, $value, $value );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql .= $inner_sql . &quot;&nbsp;</div></li><li><div> ) as count&nbsp;</div></li><li><div>                GROUP BY lead_id&nbsp;</div></li><li><div>                ORDER BY match_count DESC&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = gf_apply_filters( array( 'gform_is_duplicate', $form_id ), $wpdb-&gt;get_var( $sql ), $form_id, $field, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $count != null && $count &gt;= $input_count;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead( $lead_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $lead_detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results(&nbsp;</div></li><li><div>            $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                &quot;  SELECT l.*, field_number, value&nbsp;</div></li><li><div>                                                        FROM $lead_table_name l&nbsp;</div></li><li><div>                                                        INNER JOIN $lead_detail_table_name ld ON l.id = ld.lead_id&nbsp;</div></li><li><div>                                                        WHERE l.id=%d&quot;, $lead_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $leads = self::build_lead_array( $results, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return sizeof( $leads ) == 1 ? $leads[0] : false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_notes( $lead_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $notes_table = self::get_lead_notes_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_results(&nbsp;</div></li><li><div>            $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                &quot;  SELECT n.id, n.user_id, n.date_created, n.value, n.note_type, ifnull(u.display_name, n.user_name) as user_name, u.user_email&nbsp;</div></li><li><div>                                                    FROM $notes_table n&nbsp;</div></li><li><div>                                                    LEFT OUTER JOIN $wpdb-&gt;users u ON n.user_id = u.id&nbsp;</div></li><li><div>                                                    WHERE lead_id=%d ORDER BY id&quot;, $lead_id&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function refresh_lead_field_value( $lead_id, $field_id ) {&nbsp;</div></li><li><div>        $cache_key = 'GFFormsModel::get_lead_field_value_' . $lead_id . '_' . $field_id;&nbsp;</div></li><li><div>        GFCache::delete( $cache_key );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param $lead&nbsp;</div></li><li><div>     * @param $field GF_Field&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array|bool|mixed|string|void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_lead_field_value( $lead, $field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $lead ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_id = $field instanceof GF_Field ? $field-&gt;id : $field['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //returning cache entry if available&nbsp;</div></li><li><div>        $cache_key = 'GFFormsModel::get_lead_field_value_' . $lead['id'] . '_' . $field_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_value = GFCache::get( $cache_key, $dummy, false );&nbsp;</div></li><li><div>        if ( $cache_value !== false ) {&nbsp;</div></li><li><div>            return $cache_value;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $max_length = GFORMS_MAX_FIELD_LENGTH;&nbsp;</div></li><li><div>        $value = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $inputs = $field instanceof GF_Field ? $field-&gt;get_entry_inputs() : rgar( $field, 'inputs' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>            //making sure values submitted are sent in the value even if&nbsp;</div></li><li><div>            //there isn't an input associated with it&nbsp;</div></li><li><div>            $lead_field_keys = array_keys( $lead );&nbsp;</div></li><li><div>            natsort( $lead_field_keys );&nbsp;</div></li><li><div>            foreach ( $lead_field_keys as $input_id ) {&nbsp;</div></li><li><div>                if ( is_numeric( $input_id ) && absint( $input_id ) == absint( $field_id ) ) {&nbsp;</div></li><li><div>                    $val = $lead[ $input_id ];&nbsp;</div></li><li><div>                    if ( strlen( $val ) &gt;= ( $max_length - 10 ) ) {&nbsp;</div></li><li><div>                        if ( empty( $form ) ) {&nbsp;</div></li><li><div>                            $form = RGFormsModel::get_form_meta( $lead['form_id'] );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $long_choice = self::get_field_value_long( $lead, $input_id, $form );&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $long_choice = $val;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $value[ $input_id ] = ! empty( $long_choice ) ? $long_choice : $val;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $val = rgget( $field_id, $lead );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //To save a database call to get long text, only getting long text if regular field is 'somewhat' large (i.e. max - 50)&nbsp;</div></li><li><div>            if ( strlen( $val ) &gt;= ( $max_length - 50 ) ) {&nbsp;</div></li><li><div>                if ( empty( $form ) ) {&nbsp;</div></li><li><div>                    $form = RGFormsModel::get_form_meta( $lead['form_id'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $long_text = self::get_field_value_long( $lead, $field_id, $form );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = ! empty( $long_text ) ? $long_text : $val;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //filtering lead value&nbsp;</div></li><li><div>        $value = apply_filters( 'gform_get_field_value', $value, $lead, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //saving value in global variable to optimize performance&nbsp;</div></li><li><div>        GFCache::set( $cache_key, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $value;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_field_value_long( $lead, $field_number, $form, $apply_filter = true ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $long_table_name = self::get_lead_details_long_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot; SELECT l.value FROM $detail_table_name d&nbsp;</div></li><li><div>                                INNER JOIN $long_table_name l ON l.lead_detail_id = d.id&nbsp;</div></li><li><div>                                WHERE lead_id=%d AND field_number BETWEEN %s AND %s&quot;, $lead['id'], doubleval( $field_number ) - 0.0001, doubleval( $field_number ) + 0.0001&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $val = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //running aform_get_input_value when needed&nbsp;</div></li><li><div>        if ( $apply_filter ) {&nbsp;</div></li><li><div>            $field = RGFormsModel::get_field( $form, $field_number );&nbsp;</div></li><li><div>            $input_id = (string) $field_number == (string) $field-&gt;id ? '' : $field_number;&nbsp;</div></li><li><div>            $val = gf_apply_filters( array( 'gform_get_input_value', $field-&gt;formId, $field-&gt;id, $input_id ), $val, $lead, $field, $input_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $val;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_leads_by_meta( $meta_key, $meta_value ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>            &quot;   SELECT l.*, d.field_number, d.value&nbsp;</div></li><li><div>                    FROM {$wpdb-&gt;prefix}rg_lead l&nbsp;</div></li><li><div>                    INNER JOIN {$wpdb-&gt;prefix}rg_lead_detail d ON l.id = d.lead_id&nbsp;</div></li><li><div>                    INNER JOIN {$wpdb-&gt;prefix}rg_lead_meta m ON l.id = m.lead_id&nbsp;</div></li><li><div>                    WHERE m.meta_key=%s AND m.meta_value=%s&quot;, $meta_key, $meta_value&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //getting results&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>        $leads = self::build_lead_array( $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $leads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_leads( $form_id, $sort_field_number = 0, $sort_direction = 'DESC', $search = '', $offset = 0, $page_size = 30, $star = null, $read = null, $is_numeric_sort = false, $start_date = null, $end_date = null, $status = 'active', $payment_status = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $sort_field_number ) ) {&nbsp;</div></li><li><div>            $sort_field_number = 'date_created';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_numeric( $sort_field_number ) ) {&nbsp;</div></li><li><div>            $sql = self::sort_by_custom_field_query( $form_id, $sort_field_number, $sort_direction, $search, $offset, $page_size, $star, $read, $is_numeric_sort, $status, $payment_status );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $sql = self::sort_by_default_field_query( $form_id, $sort_field_number, $sort_direction, $search, $offset, $page_size, $star, $read, $is_numeric_sort, $start_date, $end_date, $status, $payment_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //initializing rownum&nbsp;</div></li><li><div>        $wpdb-&gt;query( 'select @rownum:=0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //getting results&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $leads = self::build_lead_array( $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $leads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_leads_count( $form_id ) {&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function sort_by_custom_field_query( $form_id, $sort_field_number = 0, $sort_direction = 'DESC', $search = '', $offset = 0, $page_size = 30, $star = null, $read = null, $is_numeric_sort = false, $status = 'active', $payment_status = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        if ( ! is_numeric( $form_id ) || ! is_numeric( $sort_field_number ) || ! is_numeric( $offset ) || ! is_numeric( $page_size ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sort_direction = strtolower( $sort_direction ) == 'desc' ? 'DESC' : 'ASC' ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orderby = $is_numeric_sort ? &quot;ORDER BY query, (value+0) $sort_direction&quot; : &quot;ORDER BY query, value $sort_direction&quot;;&nbsp;</div></li><li><div>        $is_default = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $search_sql = self::get_leads_where_sql( compact( 'form_id', 'search', 'status', 'star', 'read', 'start_date', 'end_date', 'payment_status', 'is_default' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_number_min = $sort_field_number - 0.0001;&nbsp;</div></li><li><div>        $field_number_max = $sort_field_number + 0.0001;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;&nbsp;</div></li><li><div>            SELECT filtered.sort, l.*, d.field_number, d.value&nbsp;</div></li><li><div>            FROM $lead_table_name l&nbsp;</div></li><li><div>            INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>            INNER JOIN (&nbsp;</div></li><li><div>                SELECT distinct sorted.sort, l.id&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>                INNER JOIN (&nbsp;</div></li><li><div>                    SELECT @rownum:=@rownum+1 as sort, id FROM (&nbsp;</div></li><li><div>                        SELECT 0 as query, lead_id as id, value&nbsp;</div></li><li><div>                        FROM $lead_detail_table_name&nbsp;</div></li><li><div>                        WHERE form_id=$form_id&nbsp;</div></li><li><div>                        AND field_number between $field_number_min AND $field_number_max&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        UNION ALL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        SELECT 1 as query, l.id, d.value&nbsp;</div></li><li><div>                        FROM $lead_table_name l&nbsp;</div></li><li><div>                        LEFT OUTER JOIN $lead_detail_table_name d ON d.lead_id = l.id AND field_number between $field_number_min AND $field_number_max&nbsp;</div></li><li><div>                        WHERE l.form_id=$form_id&nbsp;</div></li><li><div>                        AND d.lead_id IS NULL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) sorted1&nbsp;</div></li><li><div>                   $orderby&nbsp;</div></li><li><div> ) sorted ON d.lead_id = sorted.id&nbsp;</div></li><li><div>                $search_sql&nbsp;</div></li><li><div>                LIMIT $offset, $page_size&nbsp;</div></li><li><div> ) filtered ON filtered.id = l.id&nbsp;</div></li><li><div>            ORDER BY filtered.sort&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function sort_by_default_field_query( $form_id, $sort_field, $sort_direction = 'DESC', $search = '', $offset = 0, $page_size = 30, $star = null, $read = null, $is_numeric_sort = false, $start_date = null, $end_date = null, $status = 'active', $payment_status = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_numeric( $form_id ) || ! is_numeric( $offset ) || ! is_numeric( $page_size ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_meta_table_name = self::get_lead_meta_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_leads_where_sql( compact( 'form_id', 'search', 'status', 'star', 'read', 'start_date', 'end_date', 'payment_status' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry_meta = self::get_entry_meta( $form_id );&nbsp;</div></li><li><div>        $entry_meta_sql_join = '';&nbsp;</div></li><li><div>        if ( false === empty( $entry_meta ) && array_key_exists( $sort_field, $entry_meta ) ) {&nbsp;</div></li><li><div>            $entry_meta_sql_join = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                &quot;INNER JOIN&nbsp;</div></li><li><div>                (&nbsp;</div></li><li><div>                SELECT&nbsp;</div></li><li><div>                     lead_id, meta_value as $sort_field&nbsp;</div></li><li><div>                     from $lead_meta_table_name&nbsp;</div></li><li><div>                     WHERE meta_key = %s&nbsp;</div></li><li><div> ) lead_meta_data ON lead_meta_data.lead_id = l.id&nbsp;</div></li><li><div>                &quot;, $sort_field&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $is_numeric_sort = $entry_meta[ $sort_field ]['is_numeric'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $grid_columns = RGFormsModel::get_grid_columns( $form_id );&nbsp;</div></li><li><div>        if ( $sort_field != 'date_created' && false === array_key_exists( $sort_field, $grid_columns ) ) {&nbsp;</div></li><li><div>            $sort_field = 'date_created';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $orderby = $is_numeric_sort ? &quot;ORDER BY ($sort_field+0) $sort_direction&quot; : &quot;ORDER BY $sort_field $sort_direction&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;&nbsp;</div></li><li><div>            SELECT filtered.sort, l.*, d.field_number, d.value&nbsp;</div></li><li><div>            FROM $lead_table_name l&nbsp;</div></li><li><div>            INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>            INNER JOIN&nbsp;</div></li><li><div>            (&nbsp;</div></li><li><div>                SELECT @rownum:=@rownum + 1 as sort, id&nbsp;</div></li><li><div>                FROM&nbsp;</div></li><li><div>                (&nbsp;</div></li><li><div>                    SELECT distinct l.id&nbsp;</div></li><li><div>                    FROM $lead_table_name l&nbsp;</div></li><li><div>                    INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>                    $entry_meta_sql_join&nbsp;</div></li><li><div>                    $where&nbsp;</div></li><li><div>                    $orderby&nbsp;</div></li><li><div>                    LIMIT $offset, $page_size&nbsp;</div></li><li><div> ) page&nbsp;</div></li><li><div> ) filtered ON filtered.id = l.id&nbsp;</div></li><li><div>            ORDER BY filtered.sort&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_leads_where_sql( $args ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        extract(&nbsp;</div></li><li><div>            wp_parse_args(&nbsp;</div></li><li><div>                $args, array(&nbsp;</div></li><li><div>                    'form_id' =&gt; false, &nbsp;</div></li><li><div>                    'search' =&gt; '', &nbsp;</div></li><li><div>                    'status' =&gt; 'active', &nbsp;</div></li><li><div>                    'star' =&gt; null, &nbsp;</div></li><li><div>                    'read' =&gt; null, &nbsp;</div></li><li><div>                    'start_date' =&gt; null, &nbsp;</div></li><li><div>                    'end_date' =&gt; null, &nbsp;</div></li><li><div>                    'payment_status' =&gt; null, &nbsp;</div></li><li><div>                    'is_default' =&gt; true, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $is_default ) {&nbsp;</div></li><li><div>            $where[] = &quot;l.form_id = $form_id&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $search && $is_default ) {&nbsp;</div></li><li><div>            $where[] = $wpdb-&gt;prepare( 'value LIKE %s', &quot;%$search%&quot; );&nbsp;</div></li><li><div>        } else if ( $search ) {&nbsp;</div></li><li><div>            $where[] = $wpdb-&gt;prepare( 'd.value LIKE %s', &quot;%$search%&quot; );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $star !== null && $status == 'active' ) {&nbsp;</div></li><li><div>            $where[] = $wpdb-&gt;prepare( &quot;is_starred = %d AND status = 'active'&quot;, $star );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $read !== null && $status == 'active' ) {&nbsp;</div></li><li><div>            $where[] = $wpdb-&gt;prepare( &quot;is_read = %d AND status = 'active'&quot;, $read );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $payment_status ) {&nbsp;</div></li><li><div>            $where[] = $wpdb-&gt;prepare( &quot;payment_status = '%s'&quot;, $payment_status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $status !== null ) {&nbsp;</div></li><li><div>            $where[] = $wpdb-&gt;prepare( 'status = %s', $status );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $start_date ) ) {&nbsp;</div></li><li><div>            $where[] = &quot;timestampdiff(SECOND, '$start_date', date_created) &gt;= 0&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $end_date ) ) {&nbsp;</div></li><li><div>            $where[] = &quot;timestampdiff(SECOND, '$end_date', date_created) &lt;= 0&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return 'WHERE ' . implode( ' AND ', $where );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function build_lead_array( $results, $use_long_values = true ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $leads = array();&nbsp;</div></li><li><div>        $lead = array();&nbsp;</div></li><li><div>        $form_id = 0;&nbsp;</div></li><li><div>        if ( is_array( $results ) && sizeof( $results ) &gt; 0 ) {&nbsp;</div></li><li><div>            $form_id = $results[0]-&gt;form_id;&nbsp;</div></li><li><div>            $lead = array( 'id' =&gt; $results[0]-&gt;id, 'form_id' =&gt; $results[0]-&gt;form_id, 'date_created' =&gt; $results[0]-&gt;date_created, 'is_starred' =&gt; intval( $results[0]-&gt;is_starred ), 'is_read' =&gt; intval( $results[0]-&gt;is_read ), 'ip' =&gt; $results[0]-&gt;ip, 'source_url' =&gt; $results[0]-&gt;source_url, 'post_id' =&gt; $results[0]-&gt;post_id, 'currency' =&gt; $results[0]-&gt;currency, 'payment_status' =&gt; $results[0]-&gt;payment_status, 'payment_date' =&gt; $results[0]-&gt;payment_date, 'transaction_id' =&gt; $results[0]-&gt;transaction_id, 'payment_amount' =&gt; $results[0]-&gt;payment_amount, 'payment_method' =&gt; $results[0]-&gt;payment_method, 'is_fulfilled' =&gt; $results[0]-&gt;is_fulfilled, 'created_by' =&gt; $results[0]-&gt;created_by, 'transaction_type' =&gt; $results[0]-&gt;transaction_type, 'user_agent' =&gt; $results[0]-&gt;user_agent, 'status' =&gt; $results[0]-&gt;status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $form = RGFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>            $prev_lead_id = 0;&nbsp;</div></li><li><div>            foreach ( $results as $result ) {&nbsp;</div></li><li><div>                if ( $prev_lead_id &lt;&gt; $result-&gt;id && $prev_lead_id &gt; 0 ) {&nbsp;</div></li><li><div>                    array_push( $leads, $lead );&nbsp;</div></li><li><div>                    $lead = array( 'id' =&gt; $result-&gt;id, 'form_id' =&gt; $result-&gt;form_id, 'date_created' =&gt; $result-&gt;date_created, 'is_starred' =&gt; intval( $result-&gt;is_starred ), 'is_read' =&gt; intval( $result-&gt;is_read ), 'ip' =&gt; $result-&gt;ip, 'source_url' =&gt; $result-&gt;source_url, 'post_id' =&gt; $result-&gt;post_id, 'currency' =&gt; $result-&gt;currency, 'payment_status' =&gt; $result-&gt;payment_status, 'payment_date' =&gt; $result-&gt;payment_date, 'transaction_id' =&gt; $result-&gt;transaction_id, 'payment_amount' =&gt; $result-&gt;payment_amount, 'payment_method' =&gt; $result-&gt;payment_method, 'is_fulfilled' =&gt; $result-&gt;is_fulfilled, 'created_by' =&gt; $result-&gt;created_by, 'transaction_type' =&gt; $result-&gt;transaction_type, 'user_agent' =&gt; $result-&gt;user_agent, 'status' =&gt; $result-&gt;status );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $field_value = $result-&gt;value;&nbsp;</div></li><li><div>                $field_number = (string)$result-&gt;field_number;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //using long values if specified&nbsp;</div></li><li><div>                if ( $use_long_values && strlen( $field_value ) &gt;= ( GFORMS_MAX_FIELD_LENGTH - 10 ) ) {&nbsp;</div></li><li><div>                    $long_text = RGFormsModel::get_field_value_long( $lead, $field_number, $form, false );&nbsp;</div></li><li><div>                    $field_value = ! empty( $long_text ) ? $long_text : $field_value;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $lead[ $field_number ] = $field_value;&nbsp;</div></li><li><div>                $prev_lead_id = $result-&gt;id;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //adding last lead.&nbsp;</div></li><li><div>        if ( sizeof( $lead ) &gt; 0 ) {&nbsp;</div></li><li><div>            array_push( $leads, $lead );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //running entry through gform_get_field_value filter&nbsp;</div></li><li><div>        foreach ( $leads as &$lead ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                /** @var GF_Field $field */&nbsp;</div></li><li><div>                $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>                // skip types html, page and section?&nbsp;</div></li><li><div>                if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    foreach ( $inputs as $input ) {&nbsp;</div></li><li><div>                        $lead[ (string) $input['id'] ] = gf_apply_filters( array( 'gform_get_input_value', $form['id'], $field-&gt;id, $input['id'] ), rgar( $lead, (string) $input['id'] ), $lead, $field, $input['id'] );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $value = rgar( $lead, (string) $field-&gt;id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( self::is_encrypted_field( $lead['id'], $field-&gt;id ) ) {&nbsp;</div></li><li><div>                        $value = GFCommon::decrypt( $value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $lead[ $field-&gt;id ] = gf_apply_filters( array( 'gform_get_input_value', $form['id'], $field-&gt;id ), $value, $lead, $field, '' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //add custom entry properties&nbsp;</div></li><li><div>        $entry_ids = array();&nbsp;</div></li><li><div>        foreach ( $leads as $l ) {&nbsp;</div></li><li><div>            $entry_ids[] = $l['id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $entry_meta = GFFormsModel::get_entry_meta( $form_id );&nbsp;</div></li><li><div>        $meta_keys = array_keys( $entry_meta );&nbsp;</div></li><li><div>        $entry_meta_data_rows = gform_get_meta_values_for_entries( $entry_ids, $meta_keys );&nbsp;</div></li><li><div>        foreach ( $leads as &$lead ) {&nbsp;</div></li><li><div>            foreach ( $entry_meta_data_rows as $entry_meta_data_row ) {&nbsp;</div></li><li><div>                if ( $entry_meta_data_row-&gt;lead_id == $lead['id'] ) {&nbsp;</div></li><li><div>                    foreach ( $meta_keys as $meta_key ) {&nbsp;</div></li><li><div>                        $lead[ $meta_key ] = $entry_meta_data_row-&gt;$meta_key;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $leads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_key( $key ) {&nbsp;</div></li><li><div>        $current_key = get_option( 'rg_gforms_key' );&nbsp;</div></li><li><div>        if ( empty( $key ) ) {&nbsp;</div></li><li><div>            delete_option( 'rg_gforms_key' );&nbsp;</div></li><li><div>        } else if ( $current_key != $key ) {&nbsp;</div></li><li><div>            $key = trim( $key );&nbsp;</div></li><li><div>            update_option( 'rg_gforms_key', md5( $key ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_count( $form_id, $search, $star = null, $read = null, $start_date = null, $end_date = null, $status = null, $payment_status = null ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_numeric( $form_id ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_leads_where_sql( compact( 'form_id', 'search', 'status', 'star', 'read', 'start_date', 'end_date', 'payment_status', 'is_default' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT count(distinct l.id)&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                INNER JOIN $detail_table_name ld ON l.id = ld.lead_id&nbsp;</div></li><li><div>                $where&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_ids( $form_id, $search, $star = null, $read = null, $start_date = null, $end_date = null, $status = null, $payment_status = null ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_numeric( $form_id ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_leads_where_sql( compact( 'form_id', 'search', 'status', 'star', 'read', 'start_date', 'end_date', 'payment_status', 'is_default' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT distinct l.id&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                INNER JOIN $detail_table_name ld ON l.id = ld.lead_id&nbsp;</div></li><li><div>                $where&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $rows = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $rows ) ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $rows as $row ) {&nbsp;</div></li><li><div>            $lead_ids[] = $row-&gt;id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $lead_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_grid_columns( $form_id, $input_label_only = false ) {&nbsp;</div></li><li><div>        $form = self::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $field_ids = self::get_grid_column_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $field_ids ) ) {&nbsp;</div></li><li><div>            $field_ids = array();&nbsp;</div></li><li><div>            for ( $i = 0, $count = sizeof( $form['fields'] ); $i &lt; $count && $i &lt; 5; $i ++ ) {&nbsp;</div></li><li><div>                /** @var GF_Field $field */&nbsp;</div></li><li><div>                $field = $form['fields'][ $i ];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                //loading post category fields with choices and inputs&nbsp;</div></li><li><div>                if ( $field-&gt;type == 'post_category' ) {&nbsp;</div></li><li><div>                    $field = GFCommon::add_categories_as_choices( $field, '' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( RGForms::get( 'displayOnly', $field ) || self::get_input_type( $field ) == 'list' ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $inputs = $field-&gt;get_entry_inputs();&nbsp;</div></li><li><div>                if ( is_array( $inputs ) ) {&nbsp;</div></li><li><div>                    if ( $field-&gt;type == 'name' ) {&nbsp;</div></li><li><div>                        $field_ids[] = $field-&gt;id . '.3'; //adding first name&nbsp;</div></li><li><div>                        $field_ids[] = $field-&gt;id . '.6'; //adding last name&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $field_ids[] = $field-&gt;inputs[0]['id']; //getting first input&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $field_ids[] = $field-&gt;id;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //adding default entry meta columns&nbsp;</div></li><li><div>            $entry_metas = GFFormsModel::get_entry_meta( $form_id );&nbsp;</div></li><li><div>            foreach ( $entry_metas as $key =&gt; $entry_meta ) {&nbsp;</div></li><li><div>                if ( rgar( $entry_meta, 'is_default_column' ) ) {&nbsp;</div></li><li><div>                    $field_ids[] = $key;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $columns = array();&nbsp;</div></li><li><div>        $entry_meta = self::get_entry_meta( $form_id );&nbsp;</div></li><li><div>        foreach ( $field_ids as $field_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $field_id ) {&nbsp;</div></li><li><div>                case 'id' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Entry Id', 'gravityforms' ), 'type' =&gt; 'id' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'ip' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'User IP', 'gravityforms' ), 'type' =&gt; 'ip' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'date_created' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Entry Date', 'gravityforms' ), 'type' =&gt; 'date_created' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'source_url' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Source Url', 'gravityforms' ), 'type' =&gt; 'source_url' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'payment_status' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Payment Status', 'gravityforms' ), 'type' =&gt; 'payment_status' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'transaction_id' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Transaction Id', 'gravityforms' ), 'type' =&gt; 'transaction_id' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'payment_date' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Payment Date', 'gravityforms' ), 'type' =&gt; 'payment_date' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'payment_amount' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'Payment Amount', 'gravityforms' ), 'type' =&gt; 'payment_amount' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'created_by' :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; esc_html__( 'User', 'gravityforms' ), 'type' =&gt; 'created_by' );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case ( ( is_string( $field_id ) || is_int( $field_id ) ) && array_key_exists( $field_id, $entry_meta ) ) :&nbsp;</div></li><li><div>                    $columns[ $field_id ] = array( 'label' =&gt; $entry_meta[ $field_id ]['label'], 'type' =&gt; $field_id );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                default :&nbsp;</div></li><li><div>                    $field = self::get_field( $form, $field_id );&nbsp;</div></li><li><div>                    if ( $field ) {&nbsp;</div></li><li><div>                        $input_label_only = apply_filters( 'gform_entry_list_column_input_label_only', $input_label_only, $form, $field );&nbsp;</div></li><li><div>                        $columns[strval( $field_id )] = array( 'label' =&gt; self::get_label( $field, $field_id, $input_label_only ), 'type' =&gt; $field-&gt;type, 'inputType' =&gt; $field-&gt;inputType );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $columns;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param int $input_id&nbsp;</div></li><li><div>     * @param bool $input_only&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return string&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_label( $field, $input_id = 0, $input_only = false, $allow_admin_label = true ) {&nbsp;</div></li><li><div>        if ( ! $field instanceof GF_Field ) {&nbsp;</div></li><li><div>            $field = GF_Fields::create( $field );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $field_label = ( IS_ADMIN || RG_CURRENT_PAGE == 'select_columns.php' || RG_CURRENT_PAGE == 'print-entry.php' || rgget( 'gf_page', $_GET ) == 'select_columns' || rgget( 'gf_page', $_GET ) == 'print-entry' ) && ! empty( $field-&gt;adminLabel ) && $allow_admin_label ? $field-&gt;adminLabel : $field-&gt;label;&nbsp;</div></li><li><div>        $input = self::get_input( $field, $input_id );&nbsp;</div></li><li><div>        if ( self::get_input_type($field) == 'checkbox' && $input != null ) {&nbsp;</div></li><li><div>            return $input['label'];&nbsp;</div></li><li><div>        } else if ( $input != null ) {&nbsp;</div></li><li><div>            return $input_only ? $input['label'] : $field_label . ' (' . $input['label'] . ')';&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            return $field_label;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param GF_Field $field&nbsp;</div></li><li><div>     * @param          $id&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return null&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_input( $field, $id ) {&nbsp;</div></li><li><div>        if ( is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>            foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                if ( $input['id'] == $id ) {&nbsp;</div></li><li><div>                    return $input;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return null;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function has_input( $field, $input_id ) {&nbsp;</div></li><li><div>        if ( ! is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            foreach ( $field-&gt;inputs as $input ) {&nbsp;</div></li><li><div>                if ( $input['id'] == $input_id ) {&nbsp;</div></li><li><div>                    return true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_current_page_url( $force_ssl = false ) {&nbsp;</div></li><li><div>        $pageURL = 'http';&nbsp;</div></li><li><div>        if ( RGForms::get( 'HTTPS', $_SERVER ) == 'on' || $force_ssl ) {&nbsp;</div></li><li><div>            $pageURL .= 's';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $pageURL .= '://';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $pageURL .= RGForms::get( 'HTTP_HOST', $_SERVER ) . rgget( 'REQUEST_URI', $_SERVER );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $pageURL;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_submitted_fields( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $lead_detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $field_list = '';&nbsp;</div></li><li><div>        $fields = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT DISTINCT field_number FROM $lead_detail_table_name WHERE form_id=%d&quot;, $form_id ) );&nbsp;</div></li><li><div>        foreach ( $fields as $field ) {&nbsp;</div></li><li><div>            $field_list .= intval( $field-&gt;field_number ) . ', ';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $field_list ) ) {&nbsp;</div></li><li><div>            $field_list = substr( $field_list, 0, strlen( $field_list ) - 1 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $field_list;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * @param $form&nbsp;</div></li><li><div>     * @param $field_id&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return GF_Field&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_field( $form, $field_id ) {&nbsp;</div></li><li><div>        if ( is_numeric( $field_id ) ) {&nbsp;</div></li><li><div>            $field_id = intval( $field_id );&nbsp;</div></li><li><div>        } //removing floating part of field (i.e 1.3 -&gt; 1) to return field by input id&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            return null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $_fields;&nbsp;</div></li><li><div>        $key = $form['id'] . '_' . $field_id;&nbsp;</div></li><li><div>        if ( ! isset( $_fields[ $key ] ) ) {&nbsp;</div></li><li><div>            $_fields[ $key ] = null;&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                if ( $field-&gt;id == $field_id ) {&nbsp;</div></li><li><div>                    $_fields[ $key ] = $field;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $_fields[ $key ];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_html5_enabled() {&nbsp;</div></li><li><div>        return get_option( 'rg_gforms_enable_html5' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Return the current lead being processed. Should only be called when a form has been submitted.&nbsp;</div></li><li><div>     * If called before the &quot;real&quot; lead has been saved to the database, uses self::create_lead() to create&nbsp;</div></li><li><div>     * a temporary lead to work with.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_current_lead() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if a GF submission is not in process, always return false&nbsp;</div></li><li><div>        if ( ! rgpost( 'gform_submit' ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! self::$_current_lead ) {&nbsp;</div></li><li><div>            $form_id = absint( rgpost( 'gform_submit' ) );&nbsp;</div></li><li><div>            $form = self::get_form_meta( $form_id );&nbsp;</div></li><li><div>            self::$_current_lead = self::create_lead( $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$_current_lead;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Set RGFormsModel::$lead for use in hooks where $lead is not explicitly passed.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed $lead&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function set_current_lead( $lead ) {&nbsp;</div></li><li><div>        GFCache::flush();&nbsp;</div></li><li><div>        self::$_current_lead = $lead;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * v1.7 introduces conditional confirmations. If the form's &quot;confirmations&quot; key is empty, grab the existing confirmation&nbsp;</div></li><li><div>     * and populate it in the form's &quot;confirmations&quot; property.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param mixed $form&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function convert_confirmation( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = uniqid();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // convert confirmation to new confirmations format&nbsp;</div></li><li><div>        $confirmation = rgar( $form, 'confirmation' );&nbsp;</div></li><li><div>        $confirmation['id'] = $id;&nbsp;</div></li><li><div>        $confirmation['name'] = esc_html__( 'Default Confirmation', 'gravityforms' );&nbsp;</div></li><li><div>        $confirmation['isDefault'] = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['confirmations'] = array( $id =&gt; $confirmation );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::save_form_confirmations( $form['id'], $form['confirmations'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function load_confirmations( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $confirmations = self::get_form_confirmations( $form['id'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if there are no confirmations, convert existing (singular) confirmation (prior to 1.7) to new (plural) confirmations format&nbsp;</div></li><li><div>        if ( empty( $confirmations ) ) {&nbsp;</div></li><li><div>            $form = self::convert_confirmation( $form );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $form['confirmations'] = $confirmations;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_confirmations( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_confirmations[ $form_id ] ) ) {&nbsp;</div></li><li><div>            return $_confirmations[ $form_id ];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tablename = GFFormsModel::get_meta_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;SELECT confirmations FROM $tablename WHERE form_id = %d&quot;, $form_id );&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $sql, ARRAY_A );&nbsp;</div></li><li><div>        $confirmations = rgars( $results, '0/confirmations' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        self::$_confirmations[ $form_id ] = $confirmations ? self::unserialize( $confirmations ) : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return self::$_confirmations[ $form_id ];&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_form_confirmations( $form_id, $confirmations ) {&nbsp;</div></li><li><div>        return self::update_form_meta( $form_id, $confirmations, 'confirmations' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function save_form_notifications( $form_id, $notifications ) {&nbsp;</div></li><li><div>        return self::update_form_meta( $form_id, $notifications, 'notifications' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_ids( $active = true, $trash = false ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $table = self::get_form_table_name();&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;SELECT id from $table where is_active = %d and is_trash = %d&quot;, (bool) $active, (bool) $trash );&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_col( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $results;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_entry_meta( $form_ids ) {&nbsp;</div></li><li><div>        global $_entry_meta;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $form_ids == 0 ) {&nbsp;</div></li><li><div>            $form_ids = self::get_form_ids();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $form_ids ) ) {&nbsp;</div></li><li><div>            $form_ids = array( $form_ids );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $meta = array();&nbsp;</div></li><li><div>        foreach ( $form_ids as $form_id ) {&nbsp;</div></li><li><div>            if ( ! isset( $_entry_meta[ $form_id ] ) ) {&nbsp;</div></li><li><div>                $_entry_meta = array();&nbsp;</div></li><li><div>                $_entry_meta[ $form_id ] = apply_filters( 'gform_entry_meta', array(), $form_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $meta = array_merge( $meta, $_entry_meta[ $form_id ] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $meta;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function set_entry_meta( $lead, $form ) {&nbsp;</div></li><li><div>        $entry_meta = self::get_entry_meta( $form['id'] );&nbsp;</div></li><li><div>        $keys = array_keys( $entry_meta );&nbsp;</div></li><li><div>        foreach ( $keys as $key ) {&nbsp;</div></li><li><div>            if ( isset( $entry_meta[ $key ]['update_entry_meta_callback'] ) ) {&nbsp;</div></li><li><div>                $callback = $entry_meta[ $key ]['update_entry_meta_callback'];&nbsp;</div></li><li><div>                $value = call_user_func_array( $callback, array( $key, $lead, $form ) );&nbsp;</div></li><li><div>                gform_update_meta( $lead['id'], $key, $value );&nbsp;</div></li><li><div>                $lead[ $key ] = $value;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $lead;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function search_leads( $form_id, $search_criteria = array(), $sorting = null, $paging = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $sort_field = isset( $sorting['key'] ) ? $sorting['key'] : 'date_created'; // column, field or entry meta&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_numeric( $sort_field ) ) {&nbsp;</div></li><li><div>            $sql = self::sort_by_field_query( $form_id, $search_criteria, $sorting, $paging );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $sql = self::sort_by_column_query( $form_id, $search_criteria, $sorting, $paging );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //initializing rownum&nbsp;</div></li><li><div>        $wpdb-&gt;query( 'select @rownum:=0' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //getting results&nbsp;</div></li><li><div>        $results = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $leads = GFFormsModel::build_lead_array( $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $leads;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function search_lead_ids( $form_id, $search_criteria = array() ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $detail_table_name = GFFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = GFFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_search_where( $form_id, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT distinct l.id&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                INNER JOIN $detail_table_name ld ON l.id = ld.lead_id&nbsp;</div></li><li><div>                $where&nbsp;</div></li><li><div>                &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $rows = $wpdb-&gt;get_results( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $rows ) ) {&nbsp;</div></li><li><div>            return array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $rows as $row ) {&nbsp;</div></li><li><div>            $lead_ids[] = $row-&gt;id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $lead_ids;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function sort_by_field_query( $form_id, $search_criteria, $sorting, $paging ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $sort_field_number = rgar( $sorting, 'key' );&nbsp;</div></li><li><div>        $sort_direction = isset( $sorting['direction'] ) ? $sorting['direction'] : 'DESC';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_numeric_sort = isset( $sorting['is_numeric'] ) ? $sorting['is_numeric'] : false;&nbsp;</div></li><li><div>        $offset = isset( $paging['offset'] ) ? $paging['offset'] : 0;&nbsp;</div></li><li><div>        $page_size = isset( $paging['page_size'] ) ? $paging['page_size'] : 20;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_numeric( $sort_field_number ) || ! is_numeric( $offset ) || ! is_numeric( $page_size ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table_name = GFFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = GFFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sort_direction = strtolower( $sort_direction ) == 'desc' ? 'DESC' : 'ASC' ;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $orderby = $is_numeric_sort ? &quot;ORDER BY query, (value+0) $sort_direction&quot; : &quot;ORDER BY query, value $sort_direction&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id_where = self::get_form_id_where( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form_id_where ) ) {&nbsp;</div></li><li><div>            $form_id_where = ' AND ' . $form_id_where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_search_where( $form_id, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_number_min = $sort_field_number - 0.0001;&nbsp;</div></li><li><div>        $field_number_max = $sort_field_number + 0.0001;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;&nbsp;</div></li><li><div>            SELECT filtered.sort, l.*, d.field_number, d.value&nbsp;</div></li><li><div>            FROM $lead_table_name l&nbsp;</div></li><li><div>            INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>            INNER JOIN (&nbsp;</div></li><li><div>                SELECT distinct sorted.sort, l.id&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>                INNER JOIN (&nbsp;</div></li><li><div>                    SELECT @rownum:=@rownum+1 as sort, id FROM (&nbsp;</div></li><li><div>                        SELECT 0 as query, lead_id as id, value&nbsp;</div></li><li><div>                        FROM $lead_detail_table_name l&nbsp;</div></li><li><div>                        WHERE field_number between $field_number_min AND $field_number_max&nbsp;</div></li><li><div>                        $form_id_where&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        UNION ALL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        SELECT 1 as query, l.id, d.value&nbsp;</div></li><li><div>                        FROM $lead_table_name l&nbsp;</div></li><li><div>                        LEFT OUTER JOIN $lead_detail_table_name d ON d.lead_id = l.id AND field_number between $field_number_min AND $field_number_max&nbsp;</div></li><li><div>                        WHERE d.lead_id IS NULL&nbsp;</div></li><li><div>                        $form_id_where&nbsp;</div></li><li><div>&nbsp;</div></li><li><div> ) sorted1&nbsp;</div></li><li><div>                   $orderby&nbsp;</div></li><li><div> ) sorted ON d.lead_id = sorted.id&nbsp;</div></li><li><div>                $where&nbsp;</div></li><li><div>                LIMIT $offset, $page_size&nbsp;</div></li><li><div> ) filtered ON filtered.id = l.id&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ORDER BY filtered.sort&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function sort_by_column_query( $form_id, $search_criteria, $sorting, $paging ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        $sort_field = isset( $sorting['key'] ) ? $sorting['key'] : 'date_created';&nbsp;</div></li><li><div>        $sort_direction = isset( $sorting['direction'] ) ? $sorting['direction'] : 'DESC';&nbsp;</div></li><li><div>        $is_numeric_sort = isset( $sorting['is_numeric'] ) ? $sorting['is_numeric'] : false;&nbsp;</div></li><li><div>        $offset = isset( $paging['offset'] ) ? $paging['offset'] : 0;&nbsp;</div></li><li><div>        $page_size = isset( $paging['page_size'] ) ? $paging['page_size'] : 20;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_numeric( $offset ) || ! is_numeric( $page_size ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lead_detail_table_name = GFFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = GFFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>        $lead_meta_table_name = GFFormsModel::get_lead_meta_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entry_meta = GFFormsModel::get_entry_meta( is_array( $form_id ) ? 0 : $form_id );&nbsp;</div></li><li><div>        $entry_meta_sql_join = '';&nbsp;</div></li><li><div>        $sort_field_is_entry_meta = false;&nbsp;</div></li><li><div>        if ( false === empty( $entry_meta ) && array_key_exists( $sort_field, $entry_meta ) ) {&nbsp;</div></li><li><div>            $entry_meta_sql_join = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                &quot;&nbsp;</div></li><li><div>                INNER JOIN&nbsp;</div></li><li><div>                (&nbsp;</div></li><li><div>                SELECT&nbsp;</div></li><li><div>                     lead_id, meta_value as $sort_field&nbsp;</div></li><li><div>                     from $lead_meta_table_name&nbsp;</div></li><li><div>                     WHERE meta_key=%s&nbsp;</div></li><li><div> ) lead_meta_data ON lead_meta_data.lead_id = l.id&nbsp;</div></li><li><div>                &quot;, $sort_field&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            $is_numeric_sort = $entry_meta[ $sort_field ]['is_numeric'];&nbsp;</div></li><li><div>            $sort_field_is_entry_meta = true;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $db_columns = self::get_lead_db_columns();&nbsp;</div></li><li><div>            if ( $sort_field != 'date_created' && false === in_array( $sort_field, $db_columns ) ) {&nbsp;</div></li><li><div>                $sort_field = 'date_created';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $sort_field_is_entry_meta ) {&nbsp;</div></li><li><div>            $orderby = $is_numeric_sort ? &quot;ORDER BY ($sort_field+0) $sort_direction&quot; : &quot;ORDER BY $sort_field $sort_direction&quot;;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $orderby = $is_numeric_sort ? &quot;ORDER BY (l.$sort_field+0) $sort_direction&quot; : &quot;ORDER BY l.$sort_field $sort_direction&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_search_where( $form_id, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;&nbsp;</div></li><li><div>            SELECT filtered.sort, l.*, d.field_number, d.value&nbsp;</div></li><li><div>            FROM $lead_table_name l&nbsp;</div></li><li><div>            INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>            INNER JOIN&nbsp;</div></li><li><div>            (&nbsp;</div></li><li><div>                SELECT @rownum:=@rownum + 1 as sort, id&nbsp;</div></li><li><div>                FROM&nbsp;</div></li><li><div>                (&nbsp;</div></li><li><div>                    SELECT distinct l.id&nbsp;</div></li><li><div>                    FROM $lead_table_name l&nbsp;</div></li><li><div>                    INNER JOIN $lead_detail_table_name d ON d.lead_id = l.id&nbsp;</div></li><li><div>                    $entry_meta_sql_join&nbsp;</div></li><li><div>                    $where&nbsp;</div></li><li><div>                    $orderby&nbsp;</div></li><li><div>                    LIMIT $offset, $page_size&nbsp;</div></li><li><div> ) page&nbsp;</div></li><li><div> ) filtered ON filtered.id = l.id&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            ORDER BY filtered.sort&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_form_id_where( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $form_id ) ) {&nbsp;</div></li><li><div>            $in_str_arr = array_fill( 0, count( $form_id ), '%d' );&nbsp;</div></li><li><div>            $in_str = join( ', ', $in_str_arr );&nbsp;</div></li><li><div>            $form_id_where = $wpdb-&gt;prepare( &quot;l.form_id IN ($in_str)&quot;, $form_id );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $form_id_where = $form_id &gt; 0 ? $wpdb-&gt;prepare( 'l.form_id=%d', $form_id ) : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form_id_where;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_search_where( $form_id, $search_criteria ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where_arr = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_filters_where = self::get_field_filters_where( $form_id, $search_criteria );&nbsp;</div></li><li><div>        if ( ! empty( $field_filters_where ) ) {&nbsp;</div></li><li><div>            $where_arr[] = $field_filters_where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $info_search_where = self::get_info_search_where( $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $info_search_where ) ) {&nbsp;</div></li><li><div>            $where_arr[] = $info_search_where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $search_operator = self::get_search_operator( $search_criteria );&nbsp;</div></li><li><div>        $where = empty( $where_arr ) ? '' : '(' . join( &quot; $search_operator &quot;, $where_arr ) . ')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $date_range_where = self::get_date_range_where( $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where_and_clause_arr = array();&nbsp;</div></li><li><div>        if ( ! empty( $date_range_where ) ) {&nbsp;</div></li><li><div>            $where_and_clause_arr[] = $date_range_where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id_where = self::get_form_id_where( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $form_id_where ) ) {&nbsp;</div></li><li><div>            $where_and_clause_arr[] = $form_id_where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $status_where = isset( $search_criteria['status'] ) ? $wpdb-&gt;prepare( 'l.status = %s', $search_criteria['status'] ) : '';&nbsp;</div></li><li><div>        if ( ! empty( $status_where ) ) {&nbsp;</div></li><li><div>            $where_and_clause_arr[] = $status_where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where_and_clause = join( ' AND ', $where_and_clause_arr );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $where_and_clause ) ) {&nbsp;</div></li><li><div>            $where_and_clause = '(' . $where_and_clause . ')';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where_parts = array();&nbsp;</div></li><li><div>        if ( ! empty( $where ) ) {&nbsp;</div></li><li><div>            $where_parts[] = $where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( ! empty( $where_and_clause ) ) {&nbsp;</div></li><li><div>            $where_parts[] = $where_and_clause;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = join( ' AND ', $where_parts );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $where ) ) {&nbsp;</div></li><li><div>            $where = 'WHERE ' . $where;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $where;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_field_filters_where( $form_id, $search_criteria ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_filters = rgar( $search_criteria, 'field_filters' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $search_operator = self::get_search_operator( $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $field_filters ) ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( $field_filters['mode'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql_array = array();&nbsp;</div></li><li><div>        $lead_details_table_name = GFFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_meta_table_name = GFFormsModel::get_lead_meta_table_name();&nbsp;</div></li><li><div>        if ( is_array( $form_id ) ) {&nbsp;</div></li><li><div>            $in_str_arr = array_fill( 0, count( $form_id ), '%d' );&nbsp;</div></li><li><div>            $in_str = join( ', ', $in_str_arr );&nbsp;</div></li><li><div>            $form_id_where = $wpdb-&gt;prepare( &quot;AND form_id IN ($in_str)&quot;, $form_id );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $form_id_where = $form_id &gt; 0 ? $wpdb-&gt;prepare( 'AND form_id=%d', $form_id ) : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $info_column_keys = self::get_lead_db_columns();&nbsp;</div></li><li><div>        $entry_meta = self::get_entry_meta( is_array( $form_id ) ? 0 : $form_id );&nbsp;</div></li><li><div>        array_push( $info_column_keys, 'id' );&nbsp;</div></li><li><div>        foreach ( $field_filters as $search ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $key = rgar( $search, 'key' );&nbsp;</div></li><li><div>            if ( 'entry_id' === $key ) {&nbsp;</div></li><li><div>                $key = 'id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( in_array( $key, $info_column_keys ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $val = rgar( $search, 'value' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $operator = self::is_valid_operator( rgar( $search, 'operator' ) ) ? strtolower( $search['operator'] ) : '=';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'is' == $operator ) {&nbsp;</div></li><li><div>                $operator = '=';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( 'isnot' == $operator ) {&nbsp;</div></li><li><div>                $operator = '&lt;&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( 'contains' == $operator ) {&nbsp;</div></li><li><div>                $operator = 'like';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $search_term = 'like' == $operator ? &quot;%$val%&quot; : $val;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $search_type = rgar( $search, 'type' );&nbsp;</div></li><li><div>            if ( empty( $search_type ) ) {&nbsp;</div></li><li><div>                if ( empty( $key ) ) {&nbsp;</div></li><li><div>                    $search_type = 'global';&nbsp;</div></li><li><div>                } elseif ( is_numeric( $key ) ) {&nbsp;</div></li><li><div>                    $search_type = 'field';&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $search_type = 'meta';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            switch ( $search_type ) {&nbsp;</div></li><li><div>                case 'field':&nbsp;</div></li><li><div>                    $is_number_field = false;&nbsp;</div></li><li><div>                    if ( $operator != 'like' && ! is_array( $form_id ) && $form_id &gt; 0 ) {&nbsp;</div></li><li><div>                        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>                        $field = self::get_field( $form, $key );&nbsp;</div></li><li><div>                        if (  self::get_input_type( $field ) == 'number' ) {&nbsp;</div></li><li><div>                            $is_number_field = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $search_term_placeholder = rgar( $search, 'is_numeric' ) || $is_number_field ? '%f' : '%s';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_array( $search_term ) ) {&nbsp;</div></li><li><div>                        if ( in_array( $operator, array( '=', 'in' ) ) ) {&nbsp;</div></li><li><div>                            $operator = 'IN'; // Override operator&nbsp;</div></li><li><div>                        } elseif ( in_array( $operator, array( '!=', '&lt;&gt;', 'not in' ) ) ) {&nbsp;</div></li><li><div>                            $operator = 'NOT IN'; // Override operator&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        // Format in SQL and sanitize the strings in the list&nbsp;</div></li><li><div>                        $search_terms = array_fill( 0, count( $search_term ), '%s' );&nbsp;</div></li><li><div>                        $search_term_placeholder = $wpdb-&gt;prepare( '( ' . implode( ', ', $search_terms ) . ' )', $search_term );&nbsp;</div></li><li><div>                        $search_term = ''; // Set to blank, still gets passed to wpdb::prepare below but isn't used&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $upper_field_number_limit = (string) (int) $key === $key ? (float) $key + 0.9999 : (float) $key + 0.0001;&nbsp;</div></li><li><div>                    /** doesn't support &quot;&lt;&gt;&quot; for checkboxes */&nbsp;</div></li><li><div>                    $field_query = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                        &quot;&nbsp;</div></li><li><div>                        l.id IN&nbsp;</div></li><li><div>                        (&nbsp;</div></li><li><div>                        SELECT&nbsp;</div></li><li><div>                        lead_id&nbsp;</div></li><li><div>                        from {$lead_details_table_name}&nbsp;</div></li><li><div>                        WHERE (field_number BETWEEN %s AND %s AND value {$operator} {$search_term_placeholder})&nbsp;</div></li><li><div>                        {$form_id_where}&nbsp;</div></li><li><div> )&quot;, (float) $key - 0.0001, $upper_field_number_limit, $search_term&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ( empty( $val ) && $operator != '&lt;&gt;' ) || $val === '%%' || ( $operator === '&lt;&gt;' && ! empty( $val ) ) ) {&nbsp;</div></li><li><div>                        $skipped_field_query = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                            &quot;&nbsp;</div></li><li><div>                            l.id NOT IN&nbsp;</div></li><li><div>                            (&nbsp;</div></li><li><div>                            SELECT&nbsp;</div></li><li><div>                            lead_id&nbsp;</div></li><li><div>                            from {$lead_details_table_name}&nbsp;</div></li><li><div>                            WHERE (field_number BETWEEN %s AND %s)&nbsp;</div></li><li><div>                            {$form_id_where}&nbsp;</div></li><li><div> )&quot;, (float) $key - 0.0001, $upper_field_number_limit, $search_term&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                        $field_query = '(' . $field_query . ' OR ' . $skipped_field_query . ')';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sql_array[] = $field_query;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    /**&nbsp;</div></li><li><div>                    //supports '&lt;&gt;' for checkboxes but it doesn't scale&nbsp;</div></li><li><div>                    $sql_array[] = $wpdb-&gt;prepare(&quot;l.id IN&nbsp;</div></li><li><div>                                    (SELECT lead_id&nbsp;</div></li><li><div>                                    FROM&nbsp;</div></li><li><div>                                        (&nbsp;</div></li><li><div>                                            SELECT lead_id, value&nbsp;</div></li><li><div>                                            FROM $lead_details_table_name&nbsp;</div></li><li><div>                                            WHERE form_id = %d&nbsp;</div></li><li><div>                                            AND (field_number BETWEEN %s AND %s)&nbsp;</div></li><li><div>                                            GROUP BY lead_id&nbsp;</div></li><li><div>                                            HAVING value $operator %s&nbsp;</div></li><li><div> ) ld&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div>                                    &quot;, $form_id, (float)$key - 0.0001, $upper_field_number_limit, $val );&nbsp;</div></li><li><div>                    */&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'global':&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    // include choice text&nbsp;</div></li><li><div>                    $forms = array();&nbsp;</div></li><li><div>                    if ( $form_id == 0 ) {&nbsp;</div></li><li><div>                        $forms = GFAPI::get_forms();&nbsp;</div></li><li><div>                    } elseif ( is_array( $form_id ) ) {&nbsp;</div></li><li><div>                        foreach ( $form_id as $id ) {&nbsp;</div></li><li><div>                            $forms[] = GFAPI::get_form( $id );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $forms[] = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $choice_texts_clauses = array();&nbsp;</div></li><li><div>                    foreach ( $forms as $form ) {&nbsp;</div></li><li><div>                        if ( isset( $form['fields'] ) ) {&nbsp;</div></li><li><div>                            $choice_texts_clauses_for_form = array();&nbsp;</div></li><li><div>                            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                                /** @var GF_Field $field */&nbsp;</div></li><li><div>                                $choice_texts_clauses_for_field = array();&nbsp;</div></li><li><div>                                if ( is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>                                    foreach ( $field-&gt;choices as $choice ) {&nbsp;</div></li><li><div>                                        if ( ( $operator == '=' && strtolower( $choice['text'] ) == strtolower( $val ) ) || ( $operator == 'like' && ! empty( $val ) && strpos( strtolower( $choice['text'] ), strtolower( $val ) ) !== false ) ) {&nbsp;</div></li><li><div>                                            if ( $field-&gt;gsurveyLikertEnableMultipleRows ) {&nbsp;</div></li><li><div>                                                $choice_value = '%' . $choice['value'] . '%' ;&nbsp;</div></li><li><div>                                                $choice_search_operator = 'like';&nbsp;</div></li><li><div>                                            } else {&nbsp;</div></li><li><div>                                                $choice_value = $choice['value'];&nbsp;</div></li><li><div>                                                $choice_search_operator = '=';&nbsp;</div></li><li><div>                                            }&nbsp;</div></li><li><div>                                            $choice_texts_clauses_for_field[] = $wpdb-&gt;prepare( &quot;(field_number BETWEEN %s AND %s AND value {$choice_search_operator} %s)&quot;, (float) $field-&gt;id - 0.0001, (float) $field-&gt;id + 0.9999, $choice_value );&nbsp;</div></li><li><div>                                        }&nbsp;</div></li><li><div>                                    }&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                if ( ! empty( $choice_texts_clauses_for_field ) ) {&nbsp;</div></li><li><div>                                    $choice_texts_clauses_for_form[] = join( ' OR ', $choice_texts_clauses_for_field );&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if ( ! empty( $choice_texts_clauses_for_form ) ) {&nbsp;</div></li><li><div>                            $choice_texts_clauses[] = '(l.form_id = ' . $form['id'] . ' AND (' . join( ' OR ', $choice_texts_clauses_for_form ) . ' ))';&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $choice_texts_clause = '';&nbsp;</div></li><li><div>                    if ( ! empty( $choice_texts_clauses) ) {&nbsp;</div></li><li><div>                        $choice_texts_clause = join( ' OR ', $choice_texts_clauses );&nbsp;</div></li><li><div>                        $choice_texts_clause = &quot;&nbsp;</div></li><li><div>                        l.id IN (&nbsp;</div></li><li><div>                        SELECT&nbsp;</div></li><li><div>                        lead_id&nbsp;</div></li><li><div>                        FROM {$lead_details_table_name}&nbsp;</div></li><li><div>                        WHERE {$choice_texts_clause} ) OR &quot;;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $choice_value_clause = $wpdb-&gt;prepare( &quot;value {$operator} %s&quot;, $search_term );&nbsp;</div></li><li><div>                    $sql_array[] = '(' . $choice_texts_clause . $choice_value_clause . ')';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'meta':&nbsp;</div></li><li><div>                    /** doesn't support '&lt;&gt;' for multiple values of the same key */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $meta = rgar( $entry_meta, $key );&nbsp;</div></li><li><div>                    $placeholder = rgar( $meta, 'is_numeric' ) ? '%s' : '%s';&nbsp;</div></li><li><div>                    $search_term = 'like' == $operator ? &quot;%$val%&quot; : $val;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( is_array( $search_term ) ) {&nbsp;</div></li><li><div>                        if ( in_array( $operator, array( '=', 'in' ) ) ) {&nbsp;</div></li><li><div>                            $operator = 'IN';&nbsp;</div></li><li><div>                        } elseif ( in_array( $operator, array( '!=', '&lt;&gt;', 'not in' ) ) ) {&nbsp;</div></li><li><div>                            $operator = 'NOT IN';&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $search_terms = array_fill( 0, count( $search_term ), '%s' );&nbsp;</div></li><li><div>                        $placeholder = $wpdb-&gt;prepare( '( ' . implode( ', ', $search_terms ) . ' )', $search_term );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $search_term = '';&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $sql_array[] = $wpdb-&gt;prepare(&nbsp;</div></li><li><div>                        &quot;&nbsp;</div></li><li><div>                        l.id IN&nbsp;</div></li><li><div>                        (&nbsp;</div></li><li><div>                        SELECT&nbsp;</div></li><li><div>                        lead_id&nbsp;</div></li><li><div>                        FROM $lead_meta_table_name&nbsp;</div></li><li><div>                        WHERE meta_key=%s AND meta_value $operator $placeholder&nbsp;</div></li><li><div>                        $form_id_where&nbsp;</div></li><li><div> )&quot;, $search['key'], $search_term&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = empty( $sql_array ) ? '' : join( ' ' . $search_operator . ' ', $sql_array );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_date_range_where( $search_criteria ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $search_criteria['start_date'] ) ) {&nbsp;</div></li><li><div>            $where_array[] = $wpdb-&gt;prepare( 'date_created &gt;= %s', $search_criteria['start_date'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $search_criteria['end_date'] ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $end_date = new DateTime( $search_criteria['end_date'] );&nbsp;</div></li><li><div>            $end_datetime_str = $end_date-&gt;format( 'Y-m-d H:i:s' );&nbsp;</div></li><li><div>            $end_date_str = $end_date-&gt;format( 'Y-m-d' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // extend end date till the end of the day unless a time was specified. 00:00:00 is ignored.&nbsp;</div></li><li><div>            if ( $end_datetime_str == $end_date_str . ' 00:00:00' ) {&nbsp;</div></li><li><div>                $end_date = $end_date-&gt;format( 'Y-m-d' ) . ' 23:59:59';&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $end_date = $end_date-&gt;format( 'Y-m-d H:i:s' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $where_array[] = $wpdb-&gt;prepare( 'date_created &lt;= %s', $end_date );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = empty( $where_array ) ? '' : '(' . join( ' AND ', $where_array ) . ')';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_search_operator( $search_criteria ) {&nbsp;</div></li><li><div>        if ( ! isset( $search_criteria['field_filters'] ) ) {&nbsp;</div></li><li><div>            return '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $field_filters = $search_criteria['field_filters'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $search_mode = isset( $field_filters['mode'] ) ? strtolower( $field_filters['mode'] ) : 'all';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return strtolower( $search_mode ) == 'any' ? 'OR' : 'AND';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_lead_db_columns() {&nbsp;</div></li><li><div>        return array( 'id', 'form_id', 'post_id', 'date_created', 'is_starred', 'is_read', 'ip', 'source_url', 'user_agent', 'currency', 'payment_status', 'payment_date', 'payment_amount', 'transaction_id', 'is_fulfilled', 'created_by', 'transaction_type', 'status', 'payment_method' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private static function get_info_search_where( $search_criteria ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_filters = rgar( $search_criteria, 'field_filters' );&nbsp;</div></li><li><div>        $search_operator = self::get_search_operator( $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $field_filters ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        unset( $field_filters['mode'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $info_column_keys = self::get_lead_db_columns();&nbsp;</div></li><li><div>        array_push( $info_column_keys, 'id' );&nbsp;</div></li><li><div>        $int_columns = array( 'id', 'post_id', 'is_starred', 'is_read', 'is_fulfilled', 'entry_id' );&nbsp;</div></li><li><div>        $where_array = array();&nbsp;</div></li><li><div>        foreach ( $field_filters as $filter ) {&nbsp;</div></li><li><div>            $key = strtolower( rgar( $filter, 'key' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'entry_id' === $key ) {&nbsp;</div></li><li><div>                $key = 'id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! in_array( $key, $info_column_keys ) ) {&nbsp;</div></li><li><div>                continue;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $operator = self::is_valid_operator( rgar( $filter, 'operator' ) ) ? strtolower( $filter['operator'] ) : '=';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $value = rgar( $filter, 'value' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( 'is' == $operator ) {&nbsp;</div></li><li><div>                $operator = '=';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( 'isnot' == $operator ) {&nbsp;</div></li><li><div>                $operator = '&lt;&gt;';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( 'contains' == $operator ) {&nbsp;</div></li><li><div>                $operator = 'like';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $search_term = 'like' == $operator ? '%value%' : $value;&nbsp;</div></li><li><div>            if ( 'date_created' == $key && '=' === $operator ) {&nbsp;</div></li><li><div>                $where_array[] = $wpdb-&gt;prepare( '(datediff(date_created, %s) &gt;= 0 AND datediff(date_created, %s) &lt;= 0)', $search_term, $search_term );&nbsp;</div></li><li><div>            } else if ( in_array( $key, $int_columns ) ) {&nbsp;</div></li><li><div>                $where_array[] = $wpdb-&gt;prepare( &quot;l.{$key} $operator %d&quot;, $search_term );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $where_array[] = $wpdb-&gt;prepare( &quot;l.{$key} $operator %s&quot;, $search_term );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = empty( $where_array ) ? '' : join( &quot; $search_operator &quot;, $where_array );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sql;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function count_search_leads( $form_id, $search_criteria = array() ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $detail_table_name = GFFormsModel::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = GFFormsModel::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $where = self::get_search_where( $form_id, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = &quot;SELECT count(distinct l.id)&nbsp;</div></li><li><div>                FROM $lead_table_name l&nbsp;</div></li><li><div>                INNER JOIN $detail_table_name ld ON l.id = ld.lead_id&nbsp;</div></li><li><div>                $where&nbsp;</div></li><li><div>                &quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_lead_count_all_forms( $status = 'active' ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $detail_table_name = self::get_lead_details_table_name();&nbsp;</div></li><li><div>        $lead_table_name = self::get_lead_table_name();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;SELECT count(id)&nbsp;</div></li><li><div>                                FROM $lead_table_name&nbsp;</div></li><li><div>                                WHERE status=%s&quot;, $status );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function dbDelta( $sql ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        require_once( ABSPATH . '/wp-admin/includes/upgrade.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //Fixes issue with dbDelta lower-casing table names, which cause problems on case sensitive DB servers.&nbsp;</div></li><li><div>        add_filter( 'dbdelta_create_queries', array( 'GFForms', 'dbdelta_fix_case' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        dbDelta( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        remove_filter( 'dbdelta_create_queries', array( 'GFForms', 'dbdelta_fix_case' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_db_charset() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $wpdb-&gt;charset ) ) {&nbsp;</div></li><li><div>            $charset_collate = &quot;DEFAULT CHARACTER SET $wpdb-&gt;charset&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $wpdb-&gt;collate ) ) {&nbsp;</div></li><li><div>            $charset_collate .= &quot; COLLATE $wpdb-&gt;collate&quot;;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $charset_collate;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_valid_table( $table_name ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $tables = array(&nbsp;</div></li><li><div>            GFFormsModel::get_form_table_name(), GFFormsModel::get_form_view_table_name(), GFFormsModel::get_meta_table_name(), &nbsp;</div></li><li><div>            GFFormsModel::get_lead_table_name(), GFFormsModel::get_lead_notes_table_name(), GFFormsModel::get_lead_details_table_name(), &nbsp;</div></li><li><div>            GFFormsModel::get_lead_details_long_table_name(), GFFormsModel::get_lead_meta_table_name(), GFFormsModel::get_incomplete_submissions_table_name(), &nbsp;</div></li><li><div>            &quot;{$wpdb-&gt;prefix}gf_addon_feed&quot;, &quot;{$wpdb-&gt;prefix}gf_addon_payment_transaction&quot;, &quot;{$wpdb-&gt;prefix}gf_addon_payment_callback&quot;, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return in_array( $table_name, $tables );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_valid_index( $index_name ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $indexes = array(&nbsp;</div></li><li><div>            'id', 'form_id', 'status', 'lead_id', 'lead_user_key', 'lead_field_number', 'lead_detail_id', 'lead_detail_key', 'meta_key', &nbsp;</div></li><li><div>            'form_id_meta_key', 'uuid', 'transaction_type', 'type_lead', 'slug_callback_id', 'addon_slug_callback_id', 'addon_form', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return in_array( $index_name, $indexes );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Trims values inside choice texts, choice values, input labels, field labels and field conditionalLogic&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $form         Form object.&nbsp;</div></li><li><div>     * @param bool  $form_updated Output parameter.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array $form&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function trim_form_meta_values( $form, &$form_updated = false ) {&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::trim_form_meta_values(): Starting.' );&nbsp;</div></li><li><div>        if ( isset( $form['fields'] ) && is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as &$field ) {&nbsp;</div></li><li><div>                $trim_value = apply_filters( 'gform_trim_input_value', true, $form_id, $field );&nbsp;</div></li><li><div>                if ( ! $trim_value ) {&nbsp;</div></li><li><div>                    continue;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $field-&gt;label ) && $field-&gt;label != trim( $field-&gt;label ) ) {&nbsp;</div></li><li><div>                    $field-&gt;label = trim( $field-&gt;label );&nbsp;</div></li><li><div>                    $form_updated = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_array( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>                    foreach ( $field-&gt;choices as &$choice ) {&nbsp;</div></li><li><div>                        if ( isset( $choice['text'] ) && $choice['text'] != trim( $choice['text'] ) ) {&nbsp;</div></li><li><div>                            $choice['text'] = trim( $choice['text'] );&nbsp;</div></li><li><div>                            $form_updated = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        if ( isset( $choice['value'] ) && $choice['value'] != trim( $choice['value'] ) ) {&nbsp;</div></li><li><div>                            $choice['value'] = trim( $choice['value'] );&nbsp;</div></li><li><div>                            $form_updated = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( is_array( $field-&gt;inputs ) ) {&nbsp;</div></li><li><div>                    foreach ( $field-&gt;inputs as &$input ) {&nbsp;</div></li><li><div>                        if ( isset( $input['label'] ) && $input['label'] != trim( $input['label'] ) ) {&nbsp;</div></li><li><div>                            $input['label'] = trim( $input['label'] );&nbsp;</div></li><li><div>                            $form_updated = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $form['fields'] = GFFormsModel::trim_conditional_logic_values( $form['fields'], $form, $form_updated );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $form_updated ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::trim_form_meta_values(): Form values trimmed.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Trims values from an array of elements e.g. notifications and confirmations&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $meta_array Form object.&nbsp;</div></li><li><div>     * @param array $form       Form object.&nbsp;</div></li><li><div>     * @param bool  $updated    Output parameter.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array $meta_array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function trim_conditional_logic_values( $meta_array, $form, &$updated = false ) {&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFFormsModel::trim_conditional_logic_values(): Starting.' );&nbsp;</div></li><li><div>        if ( is_array( $meta_array ) ) {&nbsp;</div></li><li><div>            foreach ( $meta_array as &$meta ) {&nbsp;</div></li><li><div>                $meta = self::trim_conditional_logic_values_from_element( $meta, $form, $updated );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( $updated ) {&nbsp;</div></li><li><div>            GFCommon::log_debug( 'GFFormsModel::trim_conditional_logic_values(): Conditional logic values trimmed.' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $meta_array;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Trims values from elements e.g. fields, notifications and confirmations&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $element Form object.&nbsp;</div></li><li><div>     * @param array $form    Form object.&nbsp;</div></li><li><div>     * @param bool  $updated Output parameter.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return array $element&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function trim_conditional_logic_values_from_element( $element, $form = array(), &$updated = false ) {&nbsp;</div></li><li><div>        if ( $element instanceof GF_Field ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** @var GF_Field $element */&nbsp;</div></li><li><div>            if ( is_array( $element-&gt;conditionalLogic ) && isset( $element-&gt;conditionalLogic['rules'] ) && is_array( $element-&gt;conditionalLogic['rules'] ) ) {&nbsp;</div></li><li><div>                foreach ( $element-&gt;conditionalLogic['rules'] as &$rule ) {&nbsp;</div></li><li><div>                    $value = (string) $rule['value'];&nbsp;</div></li><li><div>                    if ( $value !== trim( $value ) ) {&nbsp;</div></li><li><div>                        $field = isset( $form['fields'] ) ? GFFormsModel::get_field( $form, $rule['fieldId'] ) : array();&nbsp;</div></li><li><div>                        $trim_value = apply_filters( 'gform_trim_input_value', true, rgar( $form, 'id' ), $field );&nbsp;</div></li><li><div>                        if ( $trim_value ) {&nbsp;</div></li><li><div>                            $rule['value'] = trim( $rule['value'] );&nbsp;</div></li><li><div>                            $updated = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( isset( $element['conditionalLogic'] ) && is_array( $element['conditionalLogic'] ) && isset( $element['conditionalLogic']['rules'] ) && is_array( $element['conditionalLogic']['rules'] ) ) {&nbsp;</div></li><li><div>                foreach ( $element['conditionalLogic']['rules'] as &$rule ) {&nbsp;</div></li><li><div>                    $value = (string) $rule['value'];&nbsp;</div></li><li><div>                    if ( $value !== trim( $value ) ) {&nbsp;</div></li><li><div>                        $field = isset( $form['fields'] ) ? GFFormsModel::get_field( $form, $rule['fieldId'] ) : array();&nbsp;</div></li><li><div>                        $trim_value = apply_filters( 'gform_trim_input_value', true, rgar( $form, 'id' ), $field );&nbsp;</div></li><li><div>                        if ( $trim_value ) {&nbsp;</div></li><li><div>                            $rule['value'] = trim( $rule['value'] );&nbsp;</div></li><li><div>                            $updated = true;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $element;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_encrypted_fields( $entry_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $encrypted_fields = gform_get_meta( $entry_id, '_encrypted_fields' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $encrypted_fields ) ) {&nbsp;</div></li><li><div>            $encrypted_fields = array();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $encrypted_fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function set_encrypted_fields( $entry_id, $field_ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $field_ids ) ) {&nbsp;</div></li><li><div>            $field_ids = array( $field_ids );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $encrypted_fields = array_merge( self::get_encrypted_fields( $entry_id ), $field_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        gform_update_meta( $entry_id, '_encrypted_fields', $encrypted_fields );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_encrypted_field( $entry_id, $field_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Determines if an entry field is stored encrypted. Use this hook to change the default behavior of decrypting fields that have been encrypted or to completely disable the&nbsp;</div></li><li><div>         * process if checking for encrypted fields.&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param int $entry_id The current Entry ID&nbsp;</div></li><li><div>         * @param int $field_id The current Field ID.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $is_encrypted = apply_filters('gform_is_encrypted_field', '', $entry_id, $field_id );&nbsp;</div></li><li><div>        if (  $is_encrypted !== '' ) {&nbsp;</div></li><li><div>            return $is_encrypted;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $encrypted_fields = self::get_encrypted_fields( $entry_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return in_array( $field_id, $encrypted_fields );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function delete_password( $entry, $form ) {&nbsp;</div></li><li><div>        $password_fields = self::get_fields_by_type( $form, array( 'password' ) );&nbsp;</div></li><li><div>        if ( is_array( $password_fields ) ) {&nbsp;</div></li><li><div>            foreach ( $password_fields as $password_field ) {&nbsp;</div></li><li><div>                $entry[ $password_field-&gt;id ] = '';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        GFAPI::update_entry( $entry );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $entry;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function maybe_sanitize_form_settings( $form ) {&nbsp;</div></li><li><div>        if (  isset( $form['version'] ) && version_compare( $form['version'], '1.9.6.10', '&gt;=' ) ) {&nbsp;</div></li><li><div>            $form = self::sanitize_settings( $form );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function sanitize_settings( $form ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['version'] = GFForms::$version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( apply_filters( 'gform_disable_form_settings_sanitization', false ) ) {&nbsp;</div></li><li><div>            return $form;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // -- standard form settings --&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $allowed_tags = wp_kses_allowed_html( 'post' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form['title'] = sanitize_text_field( rgar( $form, 'title' ) );&nbsp;</div></li><li><div>        if ( isset ( $form['description'] ) ) {&nbsp;</div></li><li><div>            $form['description'] = wp_kses( $form['description'], $allowed_tags );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset ( $form['labelPlacement'] ) ) {&nbsp;</div></li><li><div>            $form['labelPlacement'] = GFCommon::whitelist( $form['labelPlacement'], array( 'top_label', 'left_label', 'right_label' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset ( $form['descriptionPlacement'] ) ) {&nbsp;</div></li><li><div>            $form['descriptionPlacement'] = GFCommon::whitelist( $form['descriptionPlacement'], array( 'below', 'above' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset ( $form['subLabelPlacement'] ) ) {&nbsp;</div></li><li><div>            $form['subLabelPlacement'] = GFCommon::whitelist( $form['subLabelPlacement'], array( 'below', 'above' ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // -- advanced form settings --&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset ( $form['cssClass'] ) ) {&nbsp;</div></li><li><div>            $form['cssClass'] = sanitize_text_field( $form['cssClass'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset ( $form['enableHoneypot'] ) ) {&nbsp;</div></li><li><div>            $form['enableHoneypot'] = (bool) $form['enableHoneypot'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset ( $form['enableAnimation'] ) ) {&nbsp;</div></li><li><div>            $form['enableAnimation'] = (bool) $form['enableAnimation'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // form button settings&nbsp;</div></li><li><div>        if ( isset ( $form['button'] ) ) {&nbsp;</div></li><li><div>            $form['button']['type'] = GFCommon::whitelist( $form['button']['type'], array( 'text', 'image' ) );&nbsp;</div></li><li><div>            $form['button']['text'] = $form['button']['type'] == 'text' ? sanitize_text_field( $form['button']['text'] ) : '';&nbsp;</div></li><li><div>            $form['button']['imageUrl'] = $form['button']['type'] == 'image' ? sanitize_text_field( $form['button']['imageUrl'] ) : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( isset( $form['button']['conditionalLogic'] ) ) {&nbsp;</div></li><li><div>            $form['button']['conditionalLogic'] = self::sanitize_conditional_logic( $form['button']['conditionalLogic'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Save and Continue settings&nbsp;</div></li><li><div>        if ( isset ( $form['save'] ) ) {&nbsp;</div></li><li><div>            $form['save']['enabled'] = (bool) $form['save']['enabled'] ;&nbsp;</div></li><li><div>            $form['save']['button']['type'] = 'link';&nbsp;</div></li><li><div>            $form['save']['button']['text'] = sanitize_text_field( $form['save']['button']['text'] );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // limit entries settings&nbsp;</div></li><li><div>        if ( isset ( $form['limitEntries'] ) ) {&nbsp;</div></li><li><div>            $form['limitEntries'] = (bool) $form['limitEntries'];&nbsp;</div></li><li><div>            $form['limitEntriesCount'] = $form['limitEntries'] ? absint( $form['limitEntriesCount'] ) : '';&nbsp;</div></li><li><div>            $form['limitEntriesPeriod'] = $form['limitEntries'] ? GFCommon::whitelist( $form['limitEntriesPeriod'], array( '', 'day', 'week', 'month', 'year' ) ) : '';&nbsp;</div></li><li><div>            $form['limitEntriesMessage'] = $form['limitEntries'] ? wp_kses( $form['limitEntriesMessage'], $allowed_tags ) : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // form scheduling settings&nbsp;</div></li><li><div>        if ( isset ( $form['scheduleForm'] ) ) {&nbsp;</div></li><li><div>            $form['scheduleForm'] = (bool) $form['scheduleForm'];&nbsp;</div></li><li><div>            $form['scheduleStart'] = $form['scheduleForm'] ? preg_replace( '([^0-9/])', '', $form['scheduleStart'] ) : '';&nbsp;</div></li><li><div>            $form['scheduleStartHour'] = $form['scheduleForm'] ? GFCommon::int_range( $form['scheduleStartHour'], 1, 12 ) : '';&nbsp;</div></li><li><div>            $form['scheduleStartMinute'] = $form['scheduleForm'] ? GFCommon::int_range( $form['scheduleStartMinute'], 1, 60 ) : '';&nbsp;</div></li><li><div>            $form['scheduleStartAmpm'] = $form['scheduleForm'] ? GFCommon::whitelist( $form['scheduleStartAmpm'], array( 'am', 'pm' ) ) : '';&nbsp;</div></li><li><div>            $form['scheduleEnd'] = $form['scheduleForm'] ? preg_replace( '([^0-9/])', '', $form['scheduleEnd'] ) : '';&nbsp;</div></li><li><div>            $form['scheduleEndHour'] = $form['scheduleForm'] ? GFCommon::int_range( $form['scheduleEndHour'], 1, 12 ) : '';&nbsp;</div></li><li><div>            $form['scheduleEndMinute'] = $form['scheduleForm'] ? GFCommon::int_range( $form['scheduleEndMinute'], 1, 60 ) : '';&nbsp;</div></li><li><div>            $form['scheduleEndAmpm'] = $form['scheduleForm'] ? GFCommon::whitelist( $form['scheduleEndAmpm'], array( 'am', 'pm' ) ) : '';&nbsp;</div></li><li><div>            $form['schedulePendingMessage'] = $form['scheduleForm'] ? wp_kses( $form['schedulePendingMessage'], $allowed_tags ) : '';&nbsp;</div></li><li><div>            $form['scheduleMessage'] = $form['scheduleForm'] ? wp_kses( $form['scheduleMessage'], $allowed_tags ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // require login settings&nbsp;</div></li><li><div>        if ( isset ( $form['requireLogin'] ) ) {&nbsp;</div></li><li><div>            $form['requireLogin'] = (bool) $form['requireLogin'];&nbsp;</div></li><li><div>            $form['requireLoginMessage'] = $form['requireLogin'] ? wp_kses( $form['requireLoginMessage'], $allowed_tags ) : '';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset ( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                /** @var GF_Field $field */&nbsp;</div></li><li><div>                $field-&gt;sanitize_settings();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function sanitize_conditional_logic( $logic ) {&nbsp;</div></li><li><div>        if ( ! is_array( $logic ) ) {&nbsp;</div></li><li><div>            return $logic;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( apply_filters( 'gform_disable_form_settings_sanitization', false ) ) {&nbsp;</div></li><li><div>            return $logic;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $logic['actionType'] ) && ! in_array( $logic['actionType'], array( 'show', 'hide' ) ) ) {&nbsp;</div></li><li><div>            $logic['actionType'] = 'show';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if (  isset( $logic['logicType'] ) && ! in_array( $logic['logicType'], array( 'all', 'any' ) ) ) {&nbsp;</div></li><li><div>            $logic['logicType'] = 'all';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $logic['rules'] ) && is_array( $logic['rules'] ) ) {&nbsp;</div></li><li><div>            foreach ( $logic['rules'] as &$rule ) {&nbsp;</div></li><li><div>                if ( isset( $rule['fieldId'] ) ) {&nbsp;</div></li><li><div>                    // Field ID could be meta key&nbsp;</div></li><li><div>                    $rule['fieldId'] = wp_strip_all_tags( $rule['fieldId'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                if ( isset( $rule['operator'] ) ) {&nbsp;</div></li><li><div>                    $is_valid_operator = self::is_valid_operator( $rule['operator'] );&nbsp;</div></li><li><div>                    $rule['operator'] = $is_valid_operator ? $rule['operator'] : 'is';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( isset( $rule['value'] ) ) {&nbsp;</div></li><li><div>                    $rule['value'] = wp_strip_all_tags( $rule['value'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $logic;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Returns an array containing the form fields of the specified type or types.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @since 1.9.9.10&nbsp;</div></li><li><div>     * @param array $form&nbsp;</div></li><li><div>     * @param array|string $types&nbsp;</div></li><li><div>     * @param bool $use_input_type&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @return GF_Field[]&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_fields_by_type( $form, $types, $use_input_type = false ) {&nbsp;</div></li><li><div>        $fields = array();&nbsp;</div></li><li><div>        if ( ! is_array( rgar( $form, 'fields' ) ) ) {&nbsp;</div></li><li><div>            return $fields;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $types ) ) {&nbsp;</div></li><li><div>            $types = array( $types );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>            /** @var GF_Field $field */&nbsp;</div></li><li><div>            $type = $use_input_type ? $field-&gt;get_input_type() : $field-&gt;type;&nbsp;</div></li><li><div>            if ( in_array( $type, $types ) ) {&nbsp;</div></li><li><div>                $fields[] = $field;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function is_valid_operator( $operator ) {&nbsp;</div></li><li><div>        return in_array( strtolower( $operator ) , array('is', 'isnot', '&lt;&gt;', 'not in', 'in', '&gt;', '&lt;', 'contains', 'starts_with', 'ends_with') );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd> <a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/gfforms_model/">1.9.14.22</a></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>GFFormsModel</li><li><span></span>Gravity Forms</li><li><span></span>1.9.14.22</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>