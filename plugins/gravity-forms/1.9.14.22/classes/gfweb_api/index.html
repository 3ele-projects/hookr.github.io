<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="1.9.14.22" data-slug="gravity-forms" data-type="class" data-id="73167"><head xmlns="http://www.w3.org/1999/xhtml"><title> gfwebapi | class | Gravity Forms | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="GFWebAPI, class, plugin, gravity-forms, 1.9.14.22" /><meta name="description" content="The Gravity Forms GFWebAPI class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=f3b813f50e531254cf11de09194e12a7' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/gfweb_api/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfweb_api%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fgfweb_api%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-gravity-forms-1.9.14.22-class-gfweb_api","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="gfweb_api" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to gravity-forms." href="http://hookr.io/plugins/gravity-forms/" class="plugin"><span property="name">gravity-forms</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 1.9.14.22." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/" class="H_VERSION"><span property="name">1.9.14.22</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">gfweb_api</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="793"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/all/" title="All">All <span class="count badge">793</span></a></li><li class="" data-id="new" data-count="458"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/new/" title="New">New <span class="count badge">458</span></a></li><li class="" data-id="hooks" data-count="603"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/hooks/" title="Hooks">Hooks <span class="count badge">603</span></a></li><li class="" data-id="action" data-count="198"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/actions/" title="Actions">Actions <span class="count badge">198</span></a></li><li class="" data-id="filter" data-count="405"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/filters/" title="Filters">Filters <span class="count badge">405</span></a></li><li class="active" data-id="class" data-count="107"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/" title="Classes">Classes <span class="count badge">107</span></a></li><li class="" data-id="constant" data-count="48"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/constants/" title="Constants">Constants <span class="count badge">48</span></a></li><li class="" data-id="function" data-count="33"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/functions/" title="Functions">Functions <span class="count badge">33</span></a></li><li class="" data-id="shortcode" data-count="2"><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">2</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>GFWebAPI</strong></h1><p>The Gravity Forms <strong>GFWebAPI</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/files/includes-webapi-webapi/" class="file">/includes/webapi/webapi.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="27" class="block" start="27"><li><div>class GFWebAPI extends GFAddOn {&nbsp;</div></li><li><div>    protected $_version = '1.0';&nbsp;</div></li><li><div>    protected $_min_gravityforms_version = '1.7.9999';&nbsp;</div></li><li><div>    protected $_slug = 'gravityformswebapi';&nbsp;</div></li><li><div>    protected $_path = 'gravityformswebapi/webapi.php';&nbsp;</div></li><li><div>    protected $_full_path = __FILE__;&nbsp;</div></li><li><div>    protected $_url = 'http://www.gravityforms.com';&nbsp;</div></li><li><div>    protected $_title = 'Gravity Forms API';&nbsp;</div></li><li><div>    protected $_short_title = 'API';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private $_enabled;&nbsp;</div></li><li><div>    private $_private_key;&nbsp;</div></li><li><div>    private $_public_key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Members plugin integration&nbsp;</div></li><li><div>    protected $_capabilities = array( 'gravityforms_api', 'gravityforms_api_settings' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Permissions&nbsp;</div></li><li><div>    protected $_capabilities_settings_page = 'gravityforms_api_settings';&nbsp;</div></li><li><div>    protected $_capabilities_uninstall = 'gravityforms_webapi_uninstall';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function __construct() {&nbsp;</div></li><li><div>        if ( defined( 'DOING_CRON' ) && DOING_CRON ) {&nbsp;</div></li><li><div>            add_action( 'gravityforms_results_cron_' . $this-&gt;_slug, array( $this, 'results_cron' ), 10, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function init_ajax() {&nbsp;</div></li><li><div>        parent::init_ajax();&nbsp;</div></li><li><div>        add_action( 'wp_ajax_gfwebapi_qrcode', array( $this, 'ajax_qrcode' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function init_admin() {&nbsp;</div></li><li><div>        parent::init_admin();&nbsp;</div></li><li><div>        // update the cache meta&nbsp;</div></li><li><div>        add_action( 'gform_after_update_entry', array( $this, 'entry_updated' ), 10, 2 );&nbsp;</div></li><li><div>        add_action( 'gform_update_status', array( $this, 'update_entry_status' ), 10, 2 );&nbsp;</div></li><li><div>        add_action( 'gform_after_save_form', array( $this, 'after_save_form' ), 10, 2 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function init_frontend() {&nbsp;</div></li><li><div>        $settings = $this-&gt;get_plugin_settings();&nbsp;</div></li><li><div>        $this-&gt;_enabled = rgar( $settings, 'enabled' );&nbsp;</div></li><li><div>        $this-&gt;_public_key = rgar( $settings, 'public_key' );&nbsp;</div></li><li><div>        $this-&gt;_private_key = rgar( $settings, 'private_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( false == $this-&gt;_enabled ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'option_rewrite_rules', array( $this, 'rewrite_rules' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_filter( 'query_vars', array( $this, 'query_vars' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        add_action( 'template_redirect', array( $this, 'handle_page_request' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // update the cache&nbsp;</div></li><li><div>        add_action( 'gform_entry_created', array( $this, 'entry_created' ), 10, 2 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Scripts&nbsp;</div></li><li><div>    public function scripts() {&nbsp;</div></li><li><div>        $min = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG || isset( $_GET['gform_debug'] ) ? '' : '.min';&nbsp;</div></li><li><div>        $scripts = array(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'handle' =&gt; 'gfwebapi_hmac_sha1', &nbsp;</div></li><li><div>                'src' =&gt; 'https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/hmac-sha1.js', &nbsp;</div></li><li><div>                'enqueue' =&gt; array(&nbsp;</div></li><li><div>                    array( 'admin_page' =&gt; array( 'plugin_settings' ) ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'handle' =&gt; 'gfwebapi_enc_base64', &nbsp;</div></li><li><div>                'src' =&gt; 'https://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js', &nbsp;</div></li><li><div>                'deps' =&gt; array( 'gfwebapi_hmac_sha1' ), &nbsp;</div></li><li><div>                'callback' =&gt; array( $this, 'localize_form_settings_scripts' ), &nbsp;</div></li><li><div>                'enqueue' =&gt; array(&nbsp;</div></li><li><div>                    array( 'admin_page' =&gt; array( 'plugin_settings' ) ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'handle' =&gt; 'gfwebapi_settings.js', &nbsp;</div></li><li><div>                'src' =&gt; GFCommon::get_base_url() . &quot;/includes/webapi/js/gfwebapi_settings{$min}.js&quot;, &nbsp;</div></li><li><div>                'version' =&gt; $this-&gt;_version, &nbsp;</div></li><li><div>                'deps' =&gt; array( 'jquery', 'thickbox' ), &nbsp;</div></li><li><div>                'enqueue' =&gt; array(&nbsp;</div></li><li><div>                    array( 'admin_page' =&gt; array( 'plugin_settings' ) ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_merge( parent::scripts(), $scripts );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function styles() {&nbsp;</div></li><li><div>        $min = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG || isset( $_GET['gform_debug'] ) ? '' : '.min';&nbsp;</div></li><li><div>        $styles = array(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'handle' =&gt; 'gfwebap_settings', &nbsp;</div></li><li><div>                'src' =&gt; GFCommon::get_base_url() . &quot;/includes/webapi/css/gfwebapi_settings{$min}.css&quot;, &nbsp;</div></li><li><div>                'version' =&gt; $this-&gt;_version, &nbsp;</div></li><li><div>                'deps' =&gt; array( 'thickbox' ), &nbsp;</div></li><li><div>                'enqueue' =&gt; array(&nbsp;</div></li><li><div>                    array( 'admin_page' =&gt; array( 'plugin_settings' ) ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_merge( parent::styles(), $styles );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function render_uninstall() {&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // ------- Plugin settings -------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function plugin_settings_title() {&nbsp;</div></li><li><div>        return esc_html__( 'Gravity Forms API Settings', 'gravityforms' );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function plugin_settings_fields() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = apply_filters( 'gform_webapi_get_users_settings_page', array( 'number' =&gt; 200 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $accounts = get_users( $args );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $account_choices = array();&nbsp;</div></li><li><div>        foreach ( $accounts as $account ) {&nbsp;</div></li><li><div>            $account_choices[] = array( 'label' =&gt; $account-&gt;user_login, 'value' =&gt; $account-&gt;ID );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $permalink_structure = get_option( 'permalink_structure' );&nbsp;</div></li><li><div>        if ( ! $permalink_structure ) {&nbsp;</div></li><li><div>            return array(&nbsp;</div></li><li><div>                array(&nbsp;</div></li><li><div>                    'description' =&gt; esc_html__( 'The Gravity Forms API allows developers to interact with this install via a JSON REST API.', 'gravityforms' ), &nbsp;</div></li><li><div>                    'fields' =&gt; array(&nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'name' =&gt; 'requirements_check', &nbsp;</div></li><li><div>                            'label' =&gt; esc_html__( 'Requirements check', 'gravityforms' ), &nbsp;</div></li><li><div>                            'type' =&gt; 'requirements_check', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                        array(&nbsp;</div></li><li><div>                            'id' =&gt; 'save_button', &nbsp;</div></li><li><div>                            'type' =&gt; 'save', &nbsp;</div></li><li><div>                            'value' =&gt; 'Update', &nbsp;</div></li><li><div>                            'style' =&gt; 'display:none;', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array(&nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'description' =&gt; esc_html__( 'The Gravity Forms API allows developers to interact with this install via a JSON REST API.', 'gravityforms' ), &nbsp;</div></li><li><div>                'fields' =&gt; array(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'type' =&gt; 'checkbox', &nbsp;</div></li><li><div>                        'label' =&gt; esc_html__( 'Enable access to the API', 'gravityforms' ), &nbsp;</div></li><li><div>                        'name' =&gt; 'activate', &nbsp;</div></li><li><div>                        'onclick' =&gt; 'jQuery(this).parents(&quot;form&quot;).submit();', &nbsp;</div></li><li><div>                        'choices' =&gt; array(&nbsp;</div></li><li><div>                            array( 'label' =&gt; esc_html__( 'Enabled', 'gravityforms' ), 'name' =&gt; 'enabled' ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'title' =&gt; esc_html__( 'Authentication', 'gravityforms' ), &nbsp;</div></li><li><div>                'id' =&gt; 'gform_section_authentication', &nbsp;</div></li><li><div>                'description' =&gt; esc_html__( 'The settings below are only required to authenticate external applications. WordPress cookie authentication is supported for logged in users.', 'gravityforms' ), &nbsp;</div></li><li><div>                'dependency' =&gt; array( 'field' =&gt; 'enabled', 'values' =&gt; array( 1 ) ), &nbsp;</div></li><li><div>                'fields' =&gt; array(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'name' =&gt; 'public_key', &nbsp;</div></li><li><div>                        'label' =&gt; esc_html__( 'Public API Key', 'gravityforms' ), &nbsp;</div></li><li><div>                        'type' =&gt; 'text', &nbsp;</div></li><li><div>                        'default_value' =&gt; substr( wp_hash( site_url() ), 0, 10 ), &nbsp;</div></li><li><div>                        'class' =&gt; 'medium', &nbsp;</div></li><li><div>                        'feedback_callback' =&gt; array( $this, 'is_valid_public_key' ), &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'name' =&gt; 'private_key', &nbsp;</div></li><li><div>                        'label' =&gt; esc_html__( 'Private API Key', 'gravityforms' ), &nbsp;</div></li><li><div>                        'type' =&gt; 'text', &nbsp;</div></li><li><div>                        'default_value' =&gt; substr( wp_hash( get_bloginfo( 'admin_email' ) ), 0, 15 ), &nbsp;</div></li><li><div>                        'class' =&gt; 'medium', &nbsp;</div></li><li><div>                        'feedback_callback' =&gt; array( $this, 'is_valid_private_key' )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'name' =&gt; 'qrcode', &nbsp;</div></li><li><div>                        'label' =&gt; esc_html__( 'QR Code', 'gravityforms' ), &nbsp;</div></li><li><div>                        'type' =&gt; 'qrcode', &nbsp;</div></li><li><div>                        'dependency' =&gt; array( 'field' =&gt; 'private_key', 'values' =&gt; array( '_notempty_' ) )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'name' =&gt; 'impersonate_account', &nbsp;</div></li><li><div>                        'label' =&gt; esc_html__( 'Impersonate account', 'gravityforms' ), &nbsp;</div></li><li><div>                        'type' =&gt; 'select', &nbsp;</div></li><li><div>                        'choices' =&gt; $account_choices, &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'name' =&gt; 'developer_tools', &nbsp;</div></li><li><div>                        'label' =&gt; esc_html__( 'Developer tools', 'gravityforms' ), &nbsp;</div></li><li><div>                        'type' =&gt; 'developer_tools', &nbsp;</div></li><li><div>                        'dependency' =&gt; array( 'field' =&gt; 'private_key', 'values' =&gt; array( '_notempty_' ) )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                'fields' =&gt; array(&nbsp;</div></li><li><div>                    array(&nbsp;</div></li><li><div>                        'id' =&gt; 'save_button', &nbsp;</div></li><li><div>                        'type' =&gt; 'save', &nbsp;</div></li><li><div>                        'value' =&gt; 'Update', &nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function settings_requirements_check() {&nbsp;</div></li><li><div>        $permalinks_url = admin_url( 'options-permalink.php' );&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;i class=&quot;fa fa-exclamation-triangle gf_invalid&quot;&gt;&lt;/i&gt;&nbsp;</div></li><li><div>        &lt;span class=&quot;gf_invalid&quot;&gt;&nbsp;</div></li><li><div>                &lt;?php esc_html_e( 'Permalinks are not in the correct format.', 'gravityforms' ); ?&gt;&nbsp;</div></li><li><div>            &lt;/span&gt;&nbsp;</div></li><li><div>        &lt;br/&gt;&nbsp;</div></li><li><div>        &lt;span class='gf_settings_description'&gt;&nbsp;</div></li><li><div>            &lt;?php&nbsp;</div></li><li><div>            printf( esc_html__( 'Change the %sWordPress Permalink Settings%s from default to any of the other options to get started.', 'gravityforms' ), '&lt;a href=&quot;' . esc_url( $permalinks_url ) . '&quot;&gt;', '&lt;/a&gt;' );&nbsp;</div></li><li><div>            ?&gt;&nbsp;</div></li><li><div>        &lt;/span&gt;&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function settings_qrcode() {&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;button class=&quot;button-secondary&quot;&nbsp;</div></li><li><div>                id=&quot;gfwebapi-qrbutton&quot;&gt;&lt;?php esc_html_e( 'Show/hide QR Code', 'gravityforms' ); ?&gt;&lt;/button&gt;&nbsp;</div></li><li><div>        &lt;div id=&quot;gfwebapi-qrcode-container&quot; style=&quot;display:none;&quot;&gt;&nbsp;</div></li><li><div>            &lt;img id=&quot;gfwebapi-qrcode&quot; src=&quot;&lt;?php echo GFCommon::get_base_url() ?&gt;/images/spinner.gif&quot;/&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function settings_developer_tools() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        ?&gt;&nbsp;</div></li><li><div>        &lt;script type=&quot;text/javascript&quot;&gt;&nbsp;</div></li><li><div>            var gfapiBaseUrl = '&lt;?php echo esc_attr( GFWEBAPI_API_BASE_URL ) ?&gt;';&nbsp;</div></li><li><div>        &lt;/script&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;a title=&quot;Gravity Forms API: Developer Tools&quot; class=&quot;thickbox&quot;&nbsp;</div></li><li><div>           href=&quot;#TB_inline?width=300&height=550&inlineId=gfwebapi-dev-tools&quot;&gt;&lt;?php esc_html_e( 'Open developer tools', 'gravityforms' ) ?&gt;&lt;/a&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;div id=&quot;gfwebapi-dev-tools&quot; style=&quot;display:none;&quot;&gt;&nbsp;</div></li><li><div>            &lt;div&gt;&nbsp;</div></li><li><div>                &lt;h4&gt;Documentation&lt;/h4&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div&gt;&nbsp;</div></li><li><div>                    Please read through the &lt;a target=&quot;_blank&quot;&nbsp;</div></li><li><div>                                               href=&quot;http://www.gravityhelp.com/documentation/page/Gravity_Forms_API&quot;&gt;Gravity&nbsp;</div></li><li><div>                        Forms API Documentation&lt;/a&gt; before attempting to use the API.&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;h4&gt;URL Generator&lt;/h4&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div&gt;This tool will generate a secure, expiring URL.&lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div&gt;&nbsp;</div></li><li><div>                    &lt;select id=&quot;gfapi-url-builder-method&quot;&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;GET&quot;&gt;GET&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;POST&quot;&gt;POST&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;PUT&quot;&gt;PUT&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;DELETE&quot;&gt;DELETE&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;/select&gt;&nbsp;</div></li><li><div>                    /&lt;input type=&quot;text&quot; id=&quot;gfapi-url-builder-route&quot; value=&quot;forms/1&quot;&nbsp;</div></li><li><div>                            placeholder=&quot;route e.g. forms/1&quot;/&gt;&nbsp;</div></li><li><div>                    &lt;select id=&quot;gfapi-url-builder-expiration&quot;&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;60&quot;&gt;1 minute&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;3600&quot;&gt;1 hour&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;86400&quot;&gt;1 day&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;604800&quot;&gt;1 week&lt;/option&gt;&nbsp;</div></li><li><div>                        &lt;option value=&quot;2628000&quot;&gt;1 month&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;/select&gt;&nbsp;</div></li><li><div>                    &lt;button class=&quot;button-secondary&quot; id=&quot;gfapi-url-builder-button&quot;&gt;Generate URL&lt;/button&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div&gt;&nbsp;</div></li><li><div>                    &lt;textarea id=&quot;gfapi-url-builder-generated-url&quot; value=&quot;&quot; style=&quot;width:100%&quot;&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;h4&gt;URL tester&lt;/h4&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div&gt;This tool tests the authentication/signature - it does not perform any operations.&lt;/div&gt;&nbsp;</div></li><li><div>                &lt;select id=&quot;gfapi-url-tester-method&quot;&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;GET&quot;&gt;GET&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;POST&quot;&gt;POST&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;PUT&quot;&gt;PUT&lt;/option&gt;&nbsp;</div></li><li><div>                    &lt;option value=&quot;DELETE&quot;&gt;DELETE&lt;/option&gt;&nbsp;</div></li><li><div>                &lt;/select&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                &lt;div&gt;&nbsp;</div></li><li><div>                    &lt;textarea id=&quot;gfapi-url-tester-url&quot; value=&quot;&quot; style=&quot;width:100%&quot;&nbsp;</div></li><li><div>                              placeholder=&quot;paste your url here&quot;&gt;&lt;/textarea&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;button class=&quot;button-secondary&quot; id=&quot;gfapi-url-tester-button&quot;&gt;Test&lt;/button&gt;&nbsp;</div></li><li><div>                &lt;div id=&quot;gfapi-url-tester-loading&quot; style=&quot;display:none&quot;&gt;&nbsp;</div></li><li><div>                    Loading....&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>                &lt;div id=&quot;gfapi-url-tester-results&quot;&gt;&nbsp;</div></li><li><div>                    &lt;!-- placeholder for results --&gt;&nbsp;</div></li><li><div>                &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            &lt;/div&gt;&nbsp;</div></li><li><div>        &lt;/div&gt;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        &lt;?php&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function set_logging_supported( $plugins ) {&nbsp;</div></li><li><div>        return parent::set_logging_supported( $plugins );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function rewrite_rules( $rules ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $gfapi_rules[ GFWEBAPI_SLUG . '/(.*)' ] = 'index.php?' . GFWEBAPI_ROUTE_VAR . '=$matches[1]';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $rules ) ) {&nbsp;</div></li><li><div>            // the array operator instead of array_merge avoids tampering with the keys in the original array&nbsp;</div></li><li><div>            $rules = $gfapi_rules + $rules;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $rules = $gfapi_rules;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $rules;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function query_vars( $query_vars ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query_vars[] = GFWEBAPI_ROUTE_VAR;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $query_vars;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function handle_page_request() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $HTTP_RAW_POST_DATA;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $route = get_query_var( GFWEBAPI_ROUTE_VAR );&nbsp;</div></li><li><div>        if ( false == $route ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        send_origin_headers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $settings = get_option( 'gravityformsaddon_gravityformswebapi_settings' );&nbsp;</div></li><li><div>        if ( empty( $settings ) || ! $settings['enabled'] ) {&nbsp;</div></li><li><div>            $this-&gt;log_debug( 'API not enabled, permission denied.' );&nbsp;</div></li><li><div>            $this-&gt;die_permission_denied();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $route_parts = pathinfo( $route );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $format = rgar( $route_parts, 'extension' );&nbsp;</div></li><li><div>        if ( $format ) {&nbsp;</div></li><li><div>            $route = str_replace( '.' . $format, '', $route );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $path_array = explode( '/', $route );&nbsp;</div></li><li><div>        $collection = strtolower( rgar( $path_array, 0 ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $id = rgar( $path_array, 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strpos( $id, ';' ) !== false ) {&nbsp;</div></li><li><div>            $id = explode( ';', $id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $collection2 = strtolower( rgar( $path_array, 2 ) );&nbsp;</div></li><li><div>        $id2 = rgar( $path_array, 3 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( strpos( $id2, ';' ) !== false ) {&nbsp;</div></li><li><div>            $id2 = explode( ';', $id2 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $format ) ) {&nbsp;</div></li><li><div>            $format = 'json';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $schema = strtolower( ( rgget( 'schema' ) ) );&nbsp;</div></li><li><div>        $offset = isset( $_GET['paging']['offset'] ) ? strtolower( $_GET['paging']['offset'] ) : 0;&nbsp;</div></li><li><div>        $page_size = isset( $_GET['paging']['page_size'] ) ? strtolower( $_GET['paging']['page_size'] ) : 10;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $method = strtoupper( $_SERVER['REQUEST_METHOD'] );&nbsp;</div></li><li><div>        $args = compact( 'offset', 'page_size', 'schema' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $endpoint = empty( $collection2 ) ? strtolower( $method ) . '_' . $collection : strtolower( $method ) . '_' . $collection . '_' . $collection2;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The POST forms/[ID]/submissions endpoint is public and does not require authentication.&nbsp;</div></li><li><div>        $authentication_required = $endpoint !== 'post_forms_submissions';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>         * Allows overriding of authentication for all the endpoints of the Web API.&nbsp;</div></li><li><div>         * gform_webapi_authentication_required_[end point]&nbsp;</div></li><li><div>         * e.g.&nbsp;</div></li><li><div>         * gform_webapi_authentication_required_post_form_submissions&nbsp;</div></li><li><div>         *&nbsp;</div></li><li><div>         * @param bool $authentication_required Whether authentication is required for this endpoint.&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $authentication_required = apply_filters( 'gform_webapi_authentication_required_' . $endpoint, $authentication_required );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $authentication_required ) {&nbsp;</div></li><li><div>            $this-&gt;authenticate();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $test_mode = rgget( 'test' );&nbsp;</div></li><li><div>        if ( $test_mode ) {&nbsp;</div></li><li><div>            die( 'test mode' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $collection2 ) ) {&nbsp;</div></li><li><div>            do_action( 'gform_webapi_' . $endpoint, $id, $format, $args );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            do_action( 'gform_webapi_' . $endpoint, $id, $id2, $format, $args );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! isset( $HTTP_RAW_POST_DATA ) ) {&nbsp;</div></li><li><div>            $HTTP_RAW_POST_DATA = file_get_contents( 'php://input' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        GFCommon::log_debug( 'GFWebAPI::handle_page_request(): HTTP_RAW_POST_DATA = ' . $HTTP_RAW_POST_DATA );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = json_decode( $HTTP_RAW_POST_DATA, true );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        switch ( $collection ) {&nbsp;</div></li><li><div>            case 'forms' :&nbsp;</div></li><li><div>                switch ( $collection2 ) {&nbsp;</div></li><li><div>                    case 'results' :&nbsp;</div></li><li><div>                        switch ( $method ) {&nbsp;</div></li><li><div>                            case 'GET' :&nbsp;</div></li><li><div>                                $this-&gt;get_results( $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'DELETE':&nbsp;</div></li><li><div>                            case 'PUT':&nbsp;</div></li><li><div>                            case 'POST':&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'properties' :&nbsp;</div></li><li><div>                        switch ( $method ) {&nbsp;</div></li><li><div>                            case 'PUT' :&nbsp;</div></li><li><div>                                $this-&gt;put_forms_properties( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'feeds' :&nbsp;</div></li><li><div>                        if ( false == empty( $id2 ) ) {&nbsp;</div></li><li><div>                            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        switch ( $method ) {&nbsp;</div></li><li><div>                            case 'GET' :&nbsp;</div></li><li><div>                                $this-&gt;get_feeds( null, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'DELETE' :&nbsp;</div></li><li><div>                                $this-&gt;delete_feeds( null, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'PUT' :&nbsp;</div></li><li><div>                                $this-&gt;die_not_implemented();&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'POST' :&nbsp;</div></li><li><div>                                $this-&gt;post_feeds( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            default :&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'entries' :&nbsp;</div></li><li><div>                        if ( false == empty( $id2 ) ) {&nbsp;</div></li><li><div>                            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        switch ( $method ) {&nbsp;</div></li><li><div>                            case 'GET' :&nbsp;</div></li><li><div>                                $this-&gt;get_entries( null, $id, $schema );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'POST' :&nbsp;</div></li><li><div>                                $this-&gt;post_entries( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'PUT' :&nbsp;</div></li><li><div>                            case 'DELETE' :&nbsp;</div></li><li><div>                                $this-&gt;die_not_implemented();&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'submissions' :&nbsp;</div></li><li><div>                        if ( false == empty( $id2 ) ) {&nbsp;</div></li><li><div>                            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        switch ( $method ) {&nbsp;</div></li><li><div>                            case 'POST' :&nbsp;</div></li><li><div>                                $this-&gt;submit_form( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'GET' :&nbsp;</div></li><li><div>                            case 'PUT' :&nbsp;</div></li><li><div>                            case 'DELETE' :&nbsp;</div></li><li><div>                                $this-&gt;die_not_implemented();&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case '' :&nbsp;</div></li><li><div>                        switch ( $method ) {&nbsp;</div></li><li><div>                            case 'GET':&nbsp;</div></li><li><div>                                $this-&gt;get_forms( $id, $schema );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'DELETE':&nbsp;</div></li><li><div>                                $this-&gt;delete_forms( $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'PUT':&nbsp;</div></li><li><div>                                $this-&gt;put_forms( $data, $id, $id2 );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case 'POST':&nbsp;</div></li><li><div>                                if ( false === empty( $id ) ) {&nbsp;</div></li><li><div>                                    $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                                $this-&gt;post_forms( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            default:&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default :&nbsp;</div></li><li><div>                        $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'entries' : //  route = /entries/{id}&nbsp;</div></li><li><div>                switch ( $method ) {&nbsp;</div></li><li><div>                    case 'GET':&nbsp;</div></li><li><div>                        switch ( $collection2 ) {&nbsp;</div></li><li><div>                            case 'fields' : // route = /entries/{id}/fields/{id2}&nbsp;</div></li><li><div>                                $this-&gt;get_entries( $id, null, $schema, $id2 );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case '' :&nbsp;</div></li><li><div>                                $this-&gt;get_entries( $id, null, $schema );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            default :&nbsp;</div></li><li><div>                                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'DELETE' :&nbsp;</div></li><li><div>                        $this-&gt;delete_entries( $id );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'PUT' :&nbsp;</div></li><li><div>                        switch ( $collection2 ) {&nbsp;</div></li><li><div>                            case 'properties' : // route = /entries/{id}/properties/{id2}&nbsp;</div></li><li><div>                                $this-&gt;put_entry_properties( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                            case '' :&nbsp;</div></li><li><div>                                $this-&gt;log_debug( __METHOD__ . '(): Putting entries' );&nbsp;</div></li><li><div>                                $this-&gt;put_entries( $data, $id );&nbsp;</div></li><li><div>                                break;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'POST' :&nbsp;</div></li><li><div>                        if ( false === empty( $id ) ) {&nbsp;</div></li><li><div>                            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $this-&gt;post_entries( $data );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'feeds' :&nbsp;</div></li><li><div>                switch ( $method ) {&nbsp;</div></li><li><div>                    case 'GET' :&nbsp;</div></li><li><div>                        $this-&gt;get_feeds( $id );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'DELETE' :&nbsp;</div></li><li><div>                        if ( empty( $id ) ) {&nbsp;</div></li><li><div>                            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $this-&gt;delete_feeds( $id );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'PUT' :&nbsp;</div></li><li><div>                        $this-&gt;put_feeds( $data, $id );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'POST' :&nbsp;</div></li><li><div>                        if ( false === empty( $id ) ) {&nbsp;</div></li><li><div>                            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $this-&gt;post_feeds( $data );&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default :&nbsp;</div></li><li><div>                        $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $this-&gt;die_bad_request();&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;die_bad_request();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function authorize( $caps = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( GFCommon::current_user_can_any( $caps ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            GFCommon::add_api_call();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;die_forbidden();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //----- Feeds ------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_feeds( $feed_ids, $form_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_get_feeds', 'gravityforms_edit_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $addon_slug = rgget( 'addon' );&nbsp;</div></li><li><div>        $output = GFAPI::get_feeds( $feed_ids, $form_id, $addon_slug );&nbsp;</div></li><li><div>        if ( is_wp_error( $output ) ) {&nbsp;</div></li><li><div>            $this-&gt;die_not_found();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $response = false === empty( $feed_ids ) && false === is_array( $feed_ids ) && is_array( $output ) ? array_shift( $output ) : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( 200, $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function delete_feeds( $feed_ids, $form_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_delete_feeds', 'gravityforms_edit_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = 0;&nbsp;</div></li><li><div>        if ( empty( $feed_ids ) ) {&nbsp;</div></li><li><div>            $feeds = GFAPI::get_feeds( null, $form_id );&nbsp;</div></li><li><div>            foreach ( $feeds as $feed ) {&nbsp;</div></li><li><div>                $result = GFAPI::delete_feed( $feed['id'] );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $count ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( is_array( $feed_ids ) ) {&nbsp;</div></li><li><div>                foreach ( $feed_ids as $feed_id ) {&nbsp;</div></li><li><div>                    $result = GFAPI::delete_feed( $feed_id );&nbsp;</div></li><li><div>                    if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $count ++;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $result = GFAPI::delete_feed( $feed_ids );&nbsp;</div></li><li><div>                $count ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $result ) && is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = sprintf( __( 'Feeds deleted successfully: %d', 'gravityforms' ), $count );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function put_feeds( $feed_data, $feed_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_put_feeds', 'gravityforms_edit_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = 0;&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>        if ( empty( $feed_id ) ) {&nbsp;</div></li><li><div>            foreach ( $feed_data as $feed ) {&nbsp;</div></li><li><div>                //todo: validate feed id and form id&nbsp;</div></li><li><div>                $result = GFAPI::update_feed( $feed['id'], $feed['meta'], $feed['form_id'] );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $count ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $result = GFAPI::update_feed( $feed_id, $feed_data['meta'], $feed_data['form_id'] );&nbsp;</div></li><li><div>            $count ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $results ) && is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = sprintf( __( 'Feeds updated: %d', 'gravityforms' ), $count );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function post_feeds( $feeds, $form_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_post_feeds', 'gravityforms_edit_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $feed_ids = array();&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>        foreach ( $feeds as $feed ) {&nbsp;</div></li><li><div>            $addon_slug = isset( $feed['addon_slug'] ) ? $feed['addon_slug'] : rgget( 'addon' );&nbsp;</div></li><li><div>            $f_id = empty( $form_id ) ? $feed['form_id'] : $form_id;&nbsp;</div></li><li><div>            if ( empty( $f_id ) ) {&nbsp;</div></li><li><div>                $result = new WP_Error( 'missing_form_id', __( 'Missing form id', 'gravityforms' ) );&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $result = GFAPI::add_feed( $f_id, $feed['meta'], $addon_slug );&nbsp;</div></li><li><div>            if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $feed_ids[] = $result;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 201;&nbsp;</div></li><li><div>            $response = $feed_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //----- Form Submissions ----&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function submit_form( $data, $id ) {&nbsp;</div></li><li><div>        $form_id = absint( $id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $form_id &lt; 1 ) {&nbsp;</div></li><li><div>            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $data['input_values'] ) ) {&nbsp;</div></li><li><div>            $this-&gt;die_bad_request();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $field_values = isset( $data['field_values'] ) ? $data['field_values'] : array();&nbsp;</div></li><li><div>        $target_page = isset( $data['target_page'] ) ? $data['target_page'] : 0;&nbsp;</div></li><li><div>        $source_page = isset( $data['source_page'] ) ? $data['source_page'] : 1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = GFAPI::submit_form( $form_id, $data['input_values'], $field_values, $target_page, $source_page );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = $result;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    //----- Forms ------&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function delete_forms( $form_ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_delete_forms', 'gravityforms_delete_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = 0;&nbsp;</div></li><li><div>        if ( is_array( $form_ids ) ) {&nbsp;</div></li><li><div>            foreach ( $form_ids as $form_id ) {&nbsp;</div></li><li><div>                $result = GFAPI::delete_form( $form_id );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $count ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $result = GFAPI::delete_form( $form_ids );&nbsp;</div></li><li><div>            $count ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $result ) && is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = sprintf( __( 'Forms deleted successfully: %d', 'gravityforms' ), $count );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function post_entries( $data, $form_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_post_entries', 'gravityforms_edit_entries' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $entries = array();&nbsp;</div></li><li><div>        foreach ( $data as $entry ) {&nbsp;</div></li><li><div>            $entries[] = $this-&gt;maybe_serialize_list_fields( $entry, $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = GFAPI::add_entries( $entries, $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 201;&nbsp;</div></li><li><div>            $response = $result;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function put_entries( $data, $entry_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_put_entries', 'gravityforms_edit_entries' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>        $entries = array();&nbsp;</div></li><li><div>        if ( empty( $entry_id ) ) {&nbsp;</div></li><li><div>            foreach ( $data as $entry ) {&nbsp;</div></li><li><div>                $entries[] = $this-&gt;maybe_serialize_list_fields( $entry );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $result = GFAPI::update_entries( $entries );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $entry = $this-&gt;maybe_serialize_list_fields( $data );&nbsp;</div></li><li><div>            $result = GFAPI::update_entry( $entry, $entry_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = empty( $entry_id ) ? __( 'Entries updated successfully', 'gravityforms' ) : __( 'Entry updated successfully', 'gravityforms' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function put_forms_properties( $property_values, $form_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_put_forms_properties', 'gravityforms_edit_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $property_values as $key =&gt; $property_value ) {&nbsp;</div></li><li><div>            $result = GFAPI::update_form_property( $form_id, $key, $property_value );&nbsp;</div></li><li><div>            if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = __( 'Success', 'gravityforms' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function put_entry_properties( $property_values, $entry_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_put_entries_properties', 'gravityforms_edit_entries' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_array( $property_values ) ) {&nbsp;</div></li><li><div>            foreach ( $property_values as $key =&gt; $property_value ) {&nbsp;</div></li><li><div>                $result = GFAPI::update_entry_property( $entry_id, $key, $property_value );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>                $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $status = 200;&nbsp;</div></li><li><div>                $response = __( 'Success', 'gravityforms' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 400;&nbsp;</div></li><li><div>            if ( empty( $property_values ) ) {&nbsp;</div></li><li><div>                $response = __( 'No property values were found in the request body', 'gravityforms' );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $response = __( 'Property values should be sent as an array', 'gravityforms' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function post_forms( $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_post_forms', 'gravityforms_create_form' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_ids = GFAPI::add_forms( $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $form_ids ) || count( $form_ids ) == 0 ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $form_ids );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $form_ids );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 201;&nbsp;</div></li><li><div>            $response = $form_ids;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function put_forms( $data, $form_id = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_put_forms', 'gravityforms_create_form' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $form_id ) ) {&nbsp;</div></li><li><div>            $result = GFAPI::update_forms( $data );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $result = GFAPI::update_form( $data, $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = empty( $form_id ) ? __( 'Forms updated successfully', 'gravityforms' ) : __( 'Form updated successfully', 'gravityforms' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function delete_entries( $entry_ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_delete_entries', 'gravityforms_delete_entries' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $count = 0;&nbsp;</div></li><li><div>        if ( is_array( $entry_ids ) ) {&nbsp;</div></li><li><div>            foreach ( $entry_ids as $entry_id ) {&nbsp;</div></li><li><div>                $this-&gt;log_debug( __METHOD__ . '(): Deleting entry id ' . $entry_id );&nbsp;</div></li><li><div>                $result = GFAPI::delete_entry( $entry_id );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $count ++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $result = GFAPI::delete_entry( $entry_ids );&nbsp;</div></li><li><div>            $count ++;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $result ) && is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            $response = sprintf( __( 'Entries deleted successfully: %d', 'gravityforms' ), $count );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_entries( $entry_ids, $form_ids = null, $schema = '', $field_ids = array() ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_get_entries', 'gravityforms_view_entries' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $status = 200;&nbsp;</div></li><li><div>        $response = array();&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>        if ( $entry_ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $entry_ids ) ) {&nbsp;</div></li><li><div>                foreach ( $entry_ids as $entry_id ) {&nbsp;</div></li><li><div>                    $result = GFAPI::get_entry( $entry_id );&nbsp;</div></li><li><div>                    if ( ! is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                        $result = $this-&gt;maybe_json_encode_list_fields( $result );&nbsp;</div></li><li><div>                        $response[ $entry_id ] = $result;&nbsp;</div></li><li><div>                        if ( ! empty( $field_ids ) && ( ! empty( $response[ $entry_id ] ) ) ) {&nbsp;</div></li><li><div>                            $response[ $entry_id ] = $this-&gt;filter_entry_object( $response[ $entry_id ], $field_ids );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $result = GFAPI::get_entry( $entry_ids );&nbsp;</div></li><li><div>                if ( ! is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    $result = $this-&gt;maybe_json_encode_list_fields( $result );&nbsp;</div></li><li><div>                    $response = $result;&nbsp;</div></li><li><div>                    if ( ! empty( $field_ids ) && ( ! empty( $response ) ) ) {&nbsp;</div></li><li><div>                        $response = $this-&gt;filter_entry_object( $response, $field_ids );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( $schema == 'mtd' ) {&nbsp;</div></li><li><div>                $response = self::mtd_transform_entry_data( $response );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //sorting parameters&nbsp;</div></li><li><div>            $sort_key = isset( $_GET['sorting']['key'] ) && ! empty( $_GET['sorting']['key'] ) ? $_GET['sorting']['key'] : 'id';&nbsp;</div></li><li><div>            $sort_dir = isset( $_GET['sorting']['direction'] ) && ! empty( $_GET['sorting']['direction'] ) ? $_GET['sorting']['direction'] : 'DESC';&nbsp;</div></li><li><div>            $sorting = array( 'key' =&gt; $sort_key, 'direction' =&gt; $sort_dir );&nbsp;</div></li><li><div>            if ( isset( $_GET['sorting']['is_numeric'] ) ) {&nbsp;</div></li><li><div>                $sorting['is_numeric'] = $_GET['sorting']['is_numeric'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //paging parameters&nbsp;</div></li><li><div>            $page_size = isset( $_GET['paging']['page_size'] ) ? intval( $_GET['paging']['page_size'] ) : 10;&nbsp;</div></li><li><div>            if ( isset( $_GET['paging']['current_page'] ) ) {&nbsp;</div></li><li><div>                $current_page = intval( $_GET['paging']['current_page'] );&nbsp;</div></li><li><div>                $offset = $page_size * ( $current_page - 1 );&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $offset = isset( $_GET['paging']['offset'] ) ? intval( $_GET['paging']['offset'] ) : 0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $paging = array( 'offset' =&gt; $offset, 'page_size' =&gt; $page_size );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( isset( $_GET['search'] ) ) {&nbsp;</div></li><li><div>                $search = $_GET['search'];&nbsp;</div></li><li><div>                if ( ! is_array( $search ) ) {&nbsp;</div></li><li><div>                    $search = urldecode( ( stripslashes( $search ) ) );&nbsp;</div></li><li><div>                    $search = json_decode( $search, true );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $search = array();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $form_ids ) ) {&nbsp;</div></li><li><div>                $form_ids = 0;&nbsp;</div></li><li><div>            } // all forms&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $entry_count = GFAPI::count_entries( $form_ids, $search );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result = $entry_count &gt; 0 ? GFAPI::get_entries( $form_ids, $search, $sorting, $paging ) : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( ! is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                foreach ( $result as &$entry ) {&nbsp;</div></li><li><div>                    $entry = $this-&gt;maybe_json_encode_list_fields( $entry );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $response = array( 'total_count' =&gt; $entry_count, 'entries' =&gt; $result );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( $schema == 'mtd' ) {&nbsp;</div></li><li><div>                    $response = $this-&gt;mtd_transform_entries_data( $response, $form_ids );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>            $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>            $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function filter_entry_object( $entry, $field_ids ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! is_array( $field_ids ) ) {&nbsp;</div></li><li><div>            $field_ids = array( $field_ids );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $new_entry = array();&nbsp;</div></li><li><div>        foreach ( $entry as $key =&gt; $val ) {&nbsp;</div></li><li><div>            if ( in_array( $key, $field_ids ) || ( is_numeric( $key ) && in_array( intval( $key ), $field_ids ) ) ) {&nbsp;</div></li><li><div>                $new_entry[ $key ] = $val;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $new_entry;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_forms( $form_ids = null, $schema = '' ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_get_forms', 'gravityforms_edit_forms' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $status = 200;&nbsp;</div></li><li><div>        $response = array();&nbsp;</div></li><li><div>        if ( empty( $form_ids ) ) {&nbsp;</div></li><li><div>            $forms = RGFormsModel::get_forms( true );&nbsp;</div></li><li><div>            foreach ( $forms as $form ) {&nbsp;</div></li><li><div>                $form_id = $form-&gt;id;&nbsp;</div></li><li><div>                $totals = GFFormsModel::get_form_counts( $form_id );&nbsp;</div></li><li><div>                $form_info = array(&nbsp;</div></li><li><div>                    'id' =&gt; $form_id, &nbsp;</div></li><li><div>                    'title' =&gt; $form-&gt;title, &nbsp;</div></li><li><div>                    'entries' =&gt; rgar( $totals, 'total' )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                $response[ $form_id ] = $form_info;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if ( $schema == 'mtd' ) {&nbsp;</div></li><li><div>                $response = $this-&gt;mtd_transform_forms_data( $response );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            if ( is_array( $form_ids ) ) {&nbsp;</div></li><li><div>                foreach ( $form_ids as $form_id ) {&nbsp;</div></li><li><div>                    $response[ $form_id ] = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $result = GFAPI::get_form( $form_ids );&nbsp;</div></li><li><div>                if ( is_wp_error( $result ) ) {&nbsp;</div></li><li><div>                    $response = $this-&gt;get_error_response( $result );&nbsp;</div></li><li><div>                    $status = $this-&gt;get_error_status( $result );&nbsp;</div></li><li><div>                } elseif ( ! $result ) {&nbsp;</div></li><li><div>                    $this-&gt;die_not_found();&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $response = $result;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $response );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function maybe_json_encode_list_fields( $entry ) {&nbsp;</div></li><li><div>        $form_id = $entry['form_id'];&nbsp;</div></li><li><div>        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>        if ( ! empty ( $form['fields'] ) && is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                /** @var GF_Field $field */&nbsp;</div></li><li><div>                if ( $field-&gt;get_input_type() == 'list' ) {&nbsp;</div></li><li><div>                    $new_value = maybe_unserialize( $entry[ $field-&gt;id ] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( ! $this-&gt;is_json( $new_value ) ) {&nbsp;</div></li><li><div>                        $new_value = json_encode( $new_value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $entry[ $field-&gt;id ] = $new_value;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $entry;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function maybe_serialize_list_fields( $entry, $form_id = null ) {&nbsp;</div></li><li><div>        if ( empty( $form_id ) ) {&nbsp;</div></li><li><div>            $form_id = $entry['form_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>        if ( ! empty ( $form['fields'] ) && is_array( $form['fields'] ) ) {&nbsp;</div></li><li><div>            foreach ( $form['fields'] as $field ) {&nbsp;</div></li><li><div>                /** @var GF_Field $field */&nbsp;</div></li><li><div>                if ( $field-&gt;get_input_type() == 'list' ) {&nbsp;</div></li><li><div>                    $new_list_value = $this-&gt;maybe_decode_json( $entry[ $field-&gt;id ] );&nbsp;</div></li><li><div>                    if ( ! is_serialized( $new_list_value ) ) {&nbsp;</div></li><li><div>                        $new_list_value = serialize( $new_list_value );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $entry[ $field-&gt;id ] = $new_list_value;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $entry;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // RESULTS&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_results_cache_key( $form_id, $fields, $search_criteria ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_key_prefix( $form_id );&nbsp;</div></li><li><div>        $key .= wp_hash( json_encode( $fields ) . json_encode( $search_criteria ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $key;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_results_cache_key_prefix( $form_id ) {&nbsp;</div></li><li><div>        global $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = is_multisite() ? $blog_id . '-' : '';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key .= sprintf( '%s-cache-%s-', $this-&gt;_slug, $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // The option_name column in the options table has a max length of 64 chars.&nbsp;</div></li><li><div>        // Truncate the key if it's too long for column and allow space for the 'tmp' prefix&nbsp;</div></li><li><div>        $key = substr( $key, 0, 60 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $key;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function update_entry_status( $lead_id ) {&nbsp;</div></li><li><div>        $lead = RGFormsModel::get_lead( $lead_id );&nbsp;</div></li><li><div>        $form_id = $lead['form_id'];&nbsp;</div></li><li><div>        $form = GFFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $this-&gt;maybe_update_results_cache_meta( $form );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function entry_updated( $form, $lead_id ) {&nbsp;</div></li><li><div>        $this-&gt;maybe_update_results_cache_meta( $form );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function entry_created( $entry, $form ) {&nbsp;</div></li><li><div>        $this-&gt;maybe_update_results_cache_meta( $form );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function after_save_form( $form, $is_new ) {&nbsp;</div></li><li><div>        if ( $is_new ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // only need cache meta when a cache exists&nbsp;</div></li><li><div>        if ( false === $this-&gt;results_cache_exists( $form_id ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = rgar( $form, 'fields' );&nbsp;</div></li><li><div>        $current_fields_hash = wp_hash( json_encode( $fields ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_meta = $this-&gt;get_results_cache_meta( $form_id );&nbsp;</div></li><li><div>        $cached_fields_hash = rgar( $cache_meta, 'fields_hash' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $current_fields_hash !== $cached_fields_hash ) {&nbsp;</div></li><li><div>            // delete the meta for this form&nbsp;</div></li><li><div>            $this-&gt;delete_results_cache_meta( $form_id );&nbsp;</div></li><li><div>            // delete all cached results for this form&nbsp;</div></li><li><div>            $this-&gt;delete_cached_results( $form_id );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function results_cache_exists( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_key_prefix( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = '%' . GFCommon::esc_like( $key ) . '%';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;SELECT count(option_id) FROM $wpdb-&gt;options WHERE option_name LIKE %s&quot;, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $wpdb-&gt;get_var( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result &gt; 0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function delete_cached_results( $form_id ) {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>        if ( ! ( $form ) || ! is_array( $form ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_key_prefix( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = '%' . GFCommon::esc_like( $key ) . '%';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sql = $wpdb-&gt;prepare( &quot;DELETE FROM $wpdb-&gt;options WHERE option_name LIKE %s&quot;, $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = $wpdb-&gt;query( $sql );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // When entries are added or updated the cache needs to be expired and rebuilt.&nbsp;</div></li><li><div>    // This cache meta records the last updated time for each form and a hash of the fields array.&nbsp;</div></li><li><div>    // Each time results are requested this value is checked to make sure the cache is still valid.&nbsp;</div></li><li><div>    public function maybe_update_results_cache_meta( $form ) {&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // only need to expire the cache when a cache already exists&nbsp;</div></li><li><div>        if ( false === $this-&gt;results_cache_exists( $form_id ) ) {&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;update_results_cache_meta( $form_id, rgar( $form, 'fields' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function update_results_cache_meta( $form_id, $fields, $expiry = null ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( empty( $expiry ) ) {&nbsp;</div></li><li><div>            $expiry = time();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = array(&nbsp;</div></li><li><div>            'fields_hash' =&gt; wp_hash( json_encode( $fields ) ), &nbsp;</div></li><li><div>            'timestamp' =&gt; $expiry, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_meta_key( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;update_results_cache( $key, $data );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function delete_results_cache_meta( $form_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_meta_key( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        delete_option( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_results_cache_meta_key( $form_id ) {&nbsp;</div></li><li><div>        global $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = is_multisite() ? $blog_id . '-' : '';&nbsp;</div></li><li><div>        $key .= 'gfresults-cache-meta-form-' . $form_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $key;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_results_cache_meta( $form_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_meta_key( $form_id );&nbsp;</div></li><li><div>        $cache_meta = get_option( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $cache_meta;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function update_results_cache( $key, $data ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        delete_option( $key );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $result = add_option( $key, $data, '', 'no' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Recursive wp_cron task to continue the calculation of results&nbsp;</div></li><li><div>    public function results_cron( $form, $fields, $search_criteria ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_key( $form_id, $fields, $search_criteria );&nbsp;</div></li><li><div>        $key_tmp = 'tmp' . $key;&nbsp;</div></li><li><div>        $state = get_option( $key_tmp, array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $state ) ) {&nbsp;</div></li><li><div>            if ( ! class_exists( 'GFResults' ) ) {&nbsp;</div></li><li><div>                require_once( GFCommon::get_base_path() . '/includes/addon/class-gf-results.php' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $gf_results = new GFResults( $this-&gt;_slug, array() );&nbsp;</div></li><li><div>            $results = $gf_results-&gt;get_results_data( $form, $fields, $search_criteria, $state );&nbsp;</div></li><li><div>            if ( 'complete' == $results['status'] ) {&nbsp;</div></li><li><div>                if ( isset( $results['progress'] ) ) {&nbsp;</div></li><li><div>                    unset( $results['progress'] );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $this-&gt;update_results_cache( $key, $results );&nbsp;</div></li><li><div>                if ( false == empty( $state ) ) {&nbsp;</div></li><li><div>                    delete_option( $key_tmp );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $this-&gt;update_results_cache( $key_tmp, $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $data = get_option( $key );&nbsp;</div></li><li><div>                if ( $data ) {&nbsp;</div></li><li><div>                    $data['progress'] = $results['progress'];&nbsp;</div></li><li><div>                    $this-&gt;update_results_cache( $key, $data );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $this-&gt;schedule_results_cron( $form, $fields, $search_criteria );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Returns an array with the results for all the fields in the form.&nbsp;</div></li><li><div>    // If the results can be calculated within the time allowed in GFResults then the results are returned and nothing is cached.&nbsp;</div></li><li><div>    // If the calculation has not finished then a single recursive wp_cron task will be scheduled for immediate execution.&nbsp;</div></li><li><div>    // While the cache is being built by the wp_cron task this function will return the expired cache results if available or the latest step in the cache build.&nbsp;</div></li><li><div>    // Add-On-specific results are not included e.g. grade frequencies in the Quiz Add-On.&nbsp;</div></li><li><div>    public function get_results( $form_id ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $capability = apply_filters( 'gform_web_api_capability_get_results', 'gravityforms_view_entries' );&nbsp;</div></li><li><div>        $this-&gt;authorize( $capability );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $s = rgget( 's' ); // search criteria&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $search_criteria = false === empty( $s ) && is_array( $s ) ? $s : array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form = GFAPI::get_form( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $form ) {&nbsp;</div></li><li><div>            self::die_not_found();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // for the Web API return all fields&nbsp;</div></li><li><div>        $fields = rgar( $form, 'fields' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = $form['id'];&nbsp;</div></li><li><div>        $key = $this-&gt;get_results_cache_key( $form_id, $fields, $search_criteria );&nbsp;</div></li><li><div>        $key_tmp = 'tmp' . $key;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data = get_option( $key, array() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_meta = $this-&gt;get_results_cache_meta( $form_id );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add the cache meta early so form editor updates can test for valid field hash&nbsp;</div></li><li><div>        if ( empty( $cache_meta ) ) {&nbsp;</div></li><li><div>            $this-&gt;update_results_cache_meta( $form_id, $fields, 0 );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cache_expiry = rgar( $cache_meta, 'timestamp' );&nbsp;</div></li><li><div>        $cache_timestamp = isset( $data['timestamp'] ) ? $data['timestamp'] : 0;&nbsp;</div></li><li><div>        $cache_expired = $cache_expiry ? $cache_expiry &gt; $cache_timestamp : false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check for valid cached results first&nbsp;</div></li><li><div>        if ( ! empty( $data ) && 'complete' == rgar( $data, 'status' ) && ! $cache_expired ) {&nbsp;</div></li><li><div>            $results = $data;&nbsp;</div></li><li><div>            $status = 200;&nbsp;</div></li><li><div>            if ( isset( $results['progress'] ) ) {&nbsp;</div></li><li><div>                unset( $results['progress'] );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $state = get_option( $key_tmp );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( empty( $state ) || ( 'complete' == rgar( $data, 'status' ) && $cache_expired ) ) {&nbsp;</div></li><li><div>                if ( ! class_exists( 'GFResults' ) ) {&nbsp;</div></li><li><div>                    require_once( GFCommon::get_base_path() . '/includes/addon/class-gf-results.php' );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $gf_results = new GFResults( $this-&gt;_slug, array() );&nbsp;</div></li><li><div>                $max_execution_time = 5;&nbsp;</div></li><li><div>                $results = $gf_results-&gt;get_results_data( $form, $fields, $search_criteria, $state, $max_execution_time );&nbsp;</div></li><li><div>                if ( 'complete' == rgar( $data, 'status' ) ) {&nbsp;</div></li><li><div>                    $status = 200;&nbsp;</div></li><li><div>                    if ( false == empty( $state ) ) {&nbsp;</div></li><li><div>                        delete_option( $key_tmp );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( false === empty( $data ) && 'complete' == rgar( $data, 'status' ) && $cache_expired ) {&nbsp;</div></li><li><div>                        $data['status'] = 'expired';&nbsp;</div></li><li><div>                        $data['progress'] = $results['progress'];&nbsp;</div></li><li><div>                        $this-&gt;update_results_cache( $key, $data );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;update_results_cache( $key_tmp, $results );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $this-&gt;schedule_results_cron( $form, $fields, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    if ( $data ) {&nbsp;</div></li><li><div>                        $results = $data;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $status = 202;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // The cron task is recursive, not periodic, so system restarts, script timeouts and memory issues can prevent the cron from restarting.&nbsp;</div></li><li><div>                // Check timestamp and kick off the cron again if it appears to have stopped&nbsp;</div></li><li><div>                $state_timestamp = rgar( $state, 'timestamp' );&nbsp;</div></li><li><div>                $state_age = time() - $state_timestamp;&nbsp;</div></li><li><div>                if ( $state_age &gt; 180 && ! $this-&gt;results_cron_is_scheduled( $form, $fields, $search_criteria ) ) {&nbsp;</div></li><li><div>                    $this-&gt;schedule_results_cron( $form, $fields, $search_criteria );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if ( false === empty( $data ) && 'expired' == rgar( $data, 'status' ) ) {&nbsp;</div></li><li><div>                    $results = $data;&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    $results = $state;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $status = 202;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $fields = rgar( $results, 'field_data' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! empty( $fields ) ) {&nbsp;</div></li><li><div>            // add choice labels to the results so the client doesn't need to cross-reference with the form object&nbsp;</div></li><li><div>            $results['field_data'] = $this-&gt;results_data_add_labels( $form, $fields );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;end( $status, $results );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function schedule_results_cron( $form, $fields, $search_criteria, $delay_in_seconds = 10 ) {&nbsp;</div></li><li><div>        // reduces problems with concurrency&nbsp;</div></li><li><div>        wp_cache_delete( 'alloptions', 'options' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $args = array( $form, $fields, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_schedule_single_event( time() + $delay_in_seconds, $this-&gt;get_results_cron_hook(), $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function results_cron_is_scheduled( $form, $fields, $search_criteria ) {&nbsp;</div></li><li><div>        $args = array( $form, $fields, $search_criteria );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return wp_next_scheduled( $this-&gt;get_results_cron_hook(), $args );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_results_cron_hook() {&nbsp;</div></li><li><div>        return 'gravityforms_results_cron_' . $this-&gt;_slug;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function results_data_add_labels( $form, $fields ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // replace the values/ids with text labels&nbsp;</div></li><li><div>        foreach ( $fields as $field_id =&gt; $choice_counts ) {&nbsp;</div></li><li><div>            $field = GFFormsModel::get_field( $form, $field_id );&nbsp;</div></li><li><div>            $type = $field-&gt;get_input_type();&nbsp;</div></li><li><div>            if ( is_array( $choice_counts ) ) {&nbsp;</div></li><li><div>                $i = 0;&nbsp;</div></li><li><div>                foreach ( $choice_counts as $choice_value =&gt; $choice_count ) {&nbsp;</div></li><li><div>                    if ( class_exists( 'GFSurvey' ) && 'likert' == $type && rgar( $field, 'gsurveyLikertEnableMultipleRows' ) ) {&nbsp;</div></li><li><div>                        $row_text = GFSurvey::get_likert_row_text( $field, $i ++ );&nbsp;</div></li><li><div>                        $counts_for_row = array();&nbsp;</div></li><li><div>                        foreach ( $choice_count as $col_val =&gt; $col_count ) {&nbsp;</div></li><li><div>                            $text = GFSurvey::get_likert_column_text( $field, $choice_value . ':' . $col_val );&nbsp;</div></li><li><div>                            $counts_for_row[ $col_val ] = array( 'text' =&gt; $text, 'data' =&gt; $col_count );&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $counts_for_row[ $choice_value ]['data'] = $counts_for_row;&nbsp;</div></li><li><div>                        $fields[ $field_id ][ $choice_value ]    = array(&nbsp;</div></li><li><div>                            'text' =&gt; $row_text, &nbsp;</div></li><li><div>                            'value' =&gt; &quot;$choice_value&quot;, &nbsp;</div></li><li><div>                            'count' =&gt; $counts_for_row&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    } else {&nbsp;</div></li><li><div>                        $text = GFFormsModel::get_choice_text( $field, $choice_value );&nbsp;</div></li><li><div>                        $fields[ $field_id ][ $choice_value ] = array(&nbsp;</div></li><li><div>                            'text' =&gt; $text, &nbsp;</div></li><li><div>                            'value' =&gt; &quot;$choice_value&quot;, &nbsp;</div></li><li><div>                            'count' =&gt; $choice_count&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $fields;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // ----- end RESULTS&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function authenticate() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_REQUEST['_gf_json_nonce'] ) && is_user_logged_in() ) {&nbsp;</div></li><li><div>            // WordPress cookie authentication for plugins and themes on this server.&nbsp;</div></li><li><div>            check_admin_referer( 'gf_api', '_gf_json_nonce' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $authenticated = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( isset( $_GET['api_key'] ) ) {&nbsp;</div></li><li><div>            // Signatures required for external requests&nbsp;</div></li><li><div>            if ( rgget( 'api_key' ) == $this-&gt;_public_key ) {&nbsp;</div></li><li><div>                if ( self::check_signature() ) {&nbsp;</div></li><li><div>                    $authenticated = true;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( $authenticated ) {&nbsp;</div></li><li><div>            $settings = get_option( 'gravityformsaddon_gravityformswebapi_settings' );&nbsp;</div></li><li><div>            if ( empty( $settings ) || ! $settings['enabled'] ) {&nbsp;</div></li><li><div>                $authenticated = false;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $account_id = $settings['impersonate_account'];&nbsp;</div></li><li><div>                wp_set_current_user( $account_id );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( ! $authenticated ) {&nbsp;</div></li><li><div>            $this-&gt;log_debug( __METHOD__ . '(): Could not authenticate, permission denied.' );&nbsp;</div></li><li><div>            $this-&gt;die_permission_denied();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function check_signature() {&nbsp;</div></li><li><div>        if ( false === GFWEBAPI_REQUIRE_SIGNATURE ) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $expires = (int) rgget( 'expires' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $api_key = rgget( 'api_key' );&nbsp;</div></li><li><div>        $path = strtolower( get_query_var( GFWEBAPI_ROUTE_VAR ) );&nbsp;</div></li><li><div>        $method = strtoupper( $_SERVER['REQUEST_METHOD'] );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $signature = rgget( 'signature' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $string_to_check = sprintf( '%s:%s:%s:%s', $api_key, $method, $path, $expires );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $calculated_sig = $this-&gt;calculate_signature( $string_to_check );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ( time() &gt;= $expires ) {&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $is_valid = $signature == $calculated_sig || $signature == rawurlencode( $calculated_sig );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $is_valid;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function calculate_signature( $string ) {&nbsp;</div></li><li><div>        $hash = hash_hmac( 'sha1', $string, $this-&gt;_private_key, true );&nbsp;</div></li><li><div>        $sig = base64_encode( $hash );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $sig;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function end( $status, $response ) {&nbsp;</div></li><li><div>        $output['status'] = $status;&nbsp;</div></li><li><div>        $output['response'] = $response;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // PHP &gt; 5.3&nbsp;</div></li><li><div>        if ( function_exists( 'header_remove' ) && ! headers_sent() ) {&nbsp;</div></li><li><div>            header_remove( 'X-Pingback' );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        header( 'Content-Type: application/json; charset=' . get_option( 'blog_charset' ), true );&nbsp;</div></li><li><div>        $output_json = json_encode( $output );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        echo $output_json;&nbsp;</div></li><li><div>        die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_not_authorized() {&nbsp;</div></li><li><div>        $this-&gt;end( 401, __( 'Not authorized', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_permission_denied() {&nbsp;</div></li><li><div>        $this-&gt;end( 401, __( 'Permission denied', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_forbidden() {&nbsp;</div></li><li><div>        $this-&gt;end( 403, __( 'Forbidden', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_bad_request() {&nbsp;</div></li><li><div>        $this-&gt;end( 400, __( 'Bad request', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_not_found() {&nbsp;</div></li><li><div>        $this-&gt;end( 404, __( 'Not found', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_not_implemented() {&nbsp;</div></li><li><div>        $this-&gt;end( 501, __( 'Not implemented', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function die_error() {&nbsp;</div></li><li><div>        $this-&gt;end( 500, __( 'Internal Error', 'gravityforms' ) );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_error_response( $wp_error ) {&nbsp;</div></li><li><div>        $response['code'] = $wp_error-&gt;get_error_code();&nbsp;</div></li><li><div>        $response['message'] = $wp_error-&gt;get_error_message();&nbsp;</div></li><li><div>        $data = $wp_error-&gt;get_error_data();&nbsp;</div></li><li><div>        if ( $data ) {&nbsp;</div></li><li><div>            $response['data'] = $data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $response;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function get_error_status( $wp_error ) {&nbsp;</div></li><li><div>        $error_code = $wp_error-&gt;get_error_code();&nbsp;</div></li><li><div>        $mappings = array(&nbsp;</div></li><li><div>            'not_found' =&gt; 404, &nbsp;</div></li><li><div>            'not_allowed' =&gt; 401, &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $http_code = isset( $mappings[ $error_code ] ) ? $mappings[ $error_code ] : 400;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $http_code;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function get_form_metas() {&nbsp;</div></li><li><div>        $form_ids = array();&nbsp;</div></li><li><div>        $forms = RGFormsModel::get_forms( true );&nbsp;</div></li><li><div>        foreach ( $forms as $form ) {&nbsp;</div></li><li><div>            $form_ids[] = $form-&gt;id;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $form_metas = GFFormsModel::get_form_meta_by_id( $form_ids );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form_metas;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function ajax_qrcode() {&nbsp;</div></li><li><div>        require_once GFCommon::get_base_path() . '/includes/phpqrcode/phpqrcode.php';&nbsp;</div></li><li><div>        $settings = get_option( 'gravityformsaddon_gravityformswebapi_settings' );&nbsp;</div></li><li><div>        if ( empty( $settings ) ) {&nbsp;</div></li><li><div>            die();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data['url'] = site_url();&nbsp;</div></li><li><div>        $data['name'] = get_bloginfo();&nbsp;</div></li><li><div>        $data['public_key'] = rgar( $settings, 'public_key' );&nbsp;</div></li><li><div>        $data['private_key'] = rgar( $settings, 'private_key' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        QRcode::png( json_encode( $data ), false, QR_ECLEVEL_L, 4, 1, false );&nbsp;</div></li><li><div>        die();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Support for MonoTouch.Dialog&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    // todo: support array of form ids&nbsp;</div></li><li><div>    public function mtd_transform_entries_data( $output, $form_id ) {&nbsp;</div></li><li><div>        $form = GFFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $form_element = array();&nbsp;</div></li><li><div>        $form_element['title'] = $form['title'];&nbsp;</div></li><li><div>        $form_element['type'] = 'root';&nbsp;</div></li><li><div>        $form_element['id'] = 'id-form-' . $form_id;&nbsp;</div></li><li><div>        $form_element['count'] = rgar( $output, 'total_count' );&nbsp;</div></li><li><div>        $entries = rgar( $output, 'entries' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $section['header'] = 'Entries';&nbsp;</div></li><li><div>        $entry_elements = array();&nbsp;</div></li><li><div>        if ( is_array( $entries ) ) {&nbsp;</div></li><li><div>            foreach ( $entries as $entry ) {&nbsp;</div></li><li><div>                $entry_element['type'] = 'root';&nbsp;</div></li><li><div>                $entry_element['title'] = $entry['id'] . ': ' . $entry['date_created'];&nbsp;</div></li><li><div>                $entry_element['id'] = $entry['id'];&nbsp;</div></li><li><div>                $entry_element['url'] = GFWEBAPI_API_BASE_URL . '/entries/' . rgar( $entry, 'id' ) . '?schema=mtd';&nbsp;</div></li><li><div>                $entry_elements[] = $entry_element;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $section['elements'] = $entry_elements;&nbsp;</div></li><li><div>        $form_element['sections'][] = $section;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $form_element;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function mtd_transform_forms_data( $forms ) {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>        $data['title'] = 'Forms';&nbsp;</div></li><li><div>        $data['type'] = 'root';&nbsp;</div></li><li><div>        $data['id'] = 'forms';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $forms as $form ) {&nbsp;</div></li><li><div>            $element = array();&nbsp;</div></li><li><div>            $element['title'] = $form['title'];&nbsp;</div></li><li><div>            $element['type'] = 'root';&nbsp;</div></li><li><div>            $element['id'] = 'id-form-' . $form['id'];&nbsp;</div></li><li><div>            $element['url'] = GFWEBAPI_API_BASE_URL . '/forms/' . $form['id'] . '/entries.json?schema=mtd';&nbsp;</div></li><li><div>            $section = array();&nbsp;</div></li><li><div>            $section['elements'][] = $element;&nbsp;</div></li><li><div>            $data['sections'][] = $section;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function mtd_transform_entry_data( $entry ) {&nbsp;</div></li><li><div>        $data = array();&nbsp;</div></li><li><div>        $root_element['type'] = 'root';&nbsp;</div></li><li><div>        $root_element['title'] = $entry['id'] . ': ' . $entry['date_created'];&nbsp;</div></li><li><div>        $root_element['id'] = 'id-entry-' . $entry['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $form_id = rgar( $entry, 'form_id' );&nbsp;</div></li><li><div>        $form = RGFormsModel::get_form_meta( $form_id );&nbsp;</div></li><li><div>        $fields = $form['fields'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ( $fields as $field ) {&nbsp;</div></li><li><div>            $field_data = array();&nbsp;</div></li><li><div>            $field_data['header'] = $field-&gt;label;&nbsp;</div></li><li><div>            $elements = array();&nbsp;</div></li><li><div>            $value = RGFormsModel::get_lead_field_value( $entry, $field );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if ( is_array( $value ) && isset( $field-&gt;choices ) ) {&nbsp;</div></li><li><div>                $choices = $field-&gt;choices;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                foreach ( $choices as $choice ) {&nbsp;</div></li><li><div>                    $found = false;&nbsp;</div></li><li><div>                    foreach ( $value as $item ) {&nbsp;</div></li><li><div>                        if ( $item == rgar( $choice, 'value' ) ) {&nbsp;</div></li><li><div>                            $found = true;&nbsp;</div></li><li><div>                            break;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                    $element = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $element['type'] = 'checkbox';&nbsp;</div></li><li><div>                    $element['caption'] = $choice['text'];&nbsp;</div></li><li><div>                    $element['value'] = $found;&nbsp;</div></li><li><div>                    $elements[] = $element;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $element = array();&nbsp;</div></li><li><div>                $element['type'] = 'string';&nbsp;</div></li><li><div>                $element['caption'] = GFFormsModel::get_choice_text( $field, $value );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $elements[] = $element;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $field_data['elements'] = $elements;&nbsp;</div></li><li><div>            $data[] = $field_data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $root_element['sections'] = $data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $root_element;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd> <a href="http://hookr.io/plugins/gravity-forms/1.9.14.22/classes/gfweb_api/">1.9.14.22</a></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>GFWebAPI</li><li><span></span>Gravity Forms</li><li><span></span>1.9.14.22</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>