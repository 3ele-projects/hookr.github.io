<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.2.6" data-slug="buddypress-first-letter-avatar" data-type="class" data-id="64403"><head xmlns="http://www.w3.org/1999/xhtml"><title> buddypress_first_letter_avatar | class | Buddypress First Letter Avatar | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="BuddyPress_First_Letter_Avatar, class, plugin, buddypress-first-letter-avatar, 2.2.6" /><meta name="description" content="The BuddyPress First Letter Avatar BuddyPress First Letter Avatar class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=d82de3c38735d6a605cfe414c3179299' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/buddy_press_first_letter_avatar/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbuddy_press_first_letter_avatar%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fbuddy_press_first_letter_avatar%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-buddypress-first-letter-avatar-2.2.6-class-buddy_press_first_letter_avatar","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="buddy_press_first_letter_avatar" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to buddypress-first-letter-avatar." href="http://hookr.io/plugins/buddypress-first-letter-avatar/" class="plugin"><span property="name">buddypress-first-letter-avatar</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.2.6." href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/" class="H_VERSION"><span property="name">2.2.6</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">buddy_press_first_letter_avat&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="2"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/all/" title="All">All <span class="count badge">2</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/hooks/" title="Hooks">Hooks <span class="count badge">0</span></a></li><li class="" data-id="action" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/actions/" title="Actions">Actions <span class="count badge">0</span></a></li><li class="" data-id="filter" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/filters/" title="Filters">Filters <span class="count badge">0</span></a></li><li class="active" data-id="class" data-count="2"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/classes/" title="Classes">Classes <span class="count badge">2</span></a></li><li class="" data-id="constant" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/constants/" title="Constants">Constants <span class="count badge">0</span></a></li><li class="" data-id="function" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/functions/" title="Functions">Functions <span class="count badge">0</span></a></li><li class="" data-id="shortcode" data-count="0"><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">0</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>BuddyPress_First_Letter_Avatar</strong></h1><p>The BuddyPress First Letter Avatar <strong>BuddyPress First Letter Avatar</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/files/buddypress-first-letter-avatar/" class="file">/buddypress-first-letter-avatar.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="30" class="block" start="30"><li><div>class BuddyPress_First_Letter_Avatar {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Setup:&nbsp;</div></li><li><div>    const MINIMUM_PHP = '5.4';&nbsp;</div></li><li><div>    const MINIMUM_WP = '4.0';&nbsp;</div></li><li><div>    const IMAGES_PATH = 'images'; // avatars root directory&nbsp;</div></li><li><div>    const GRAVATAR_URL = 'https://secure.gravatar.com/avatar/'; // default url for gravatar&nbsp;</div></li><li><div>    const PLUGIN_NAME = 'BuddyPress First Letter Avatar';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Default configuration (this is the default configuration only for the first plugin use):&nbsp;</div></li><li><div>    const USE_PROFILE_AVATAR = true;  // TRUE: if user has his profile avatar, use it; FALSE: use custom avatars or Gravatars&nbsp;</div></li><li><div>    const USE_GRAVATAR = true;  // TRUE: if user has Gravatar, use it; FALSE: use custom avatars or user's profile avatar&nbsp;</div></li><li><div>    const AVATAR_SET = 'default'; // directory where avatars are stored&nbsp;</div></li><li><div>    const LETTER_INDEX = 0;  // 0: first letter; 1: second letter; -1: last letter, etc.&nbsp;</div></li><li><div>    const IMAGES_FORMAT = 'png';   // file format of the avatars&nbsp;</div></li><li><div>    const ROUND_AVATARS = false;     // TRUE: use rounded avatars; FALSE: dont use round avatars&nbsp;</div></li><li><div>    const IMAGE_UNKNOWN = 'mystery';    // file name (without extension) of the avatar used for users with usernames beginning with symbol other than one from a-z range&nbsp;</div></li><li><div>    const FILTER_PRIORITY = 10;  // plugin filter priority&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // properties duplicating const values (will be changed in constructor after reading config from DB):&nbsp;</div></li><li><div>    private $use_profile_avatar = self::USE_PROFILE_AVATAR;&nbsp;</div></li><li><div>    private $use_gravatar = self::USE_GRAVATAR;&nbsp;</div></li><li><div>    private $avatar_set = self::AVATAR_SET;&nbsp;</div></li><li><div>    private $letter_index = self::LETTER_INDEX;&nbsp;</div></li><li><div>    private $images_format = self::IMAGES_FORMAT;&nbsp;</div></li><li><div>    private $round_avatars = self::ROUND_AVATARS;&nbsp;</div></li><li><div>    private $image_unknown = self::IMAGE_UNKNOWN;&nbsp;</div></li><li><div>    private $filter_priority = self::FILTER_PRIORITY;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function __construct() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** --------------- CONFIGURATION --------------- */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get plugin configuration from database:&nbsp;</div></li><li><div>        $options = get_option('bpfla_settings');&nbsp;</div></li><li><div>        if (empty($options)) {&nbsp;</div></li><li><div>            // no records in DB, use default (const) values to save plugin config:&nbsp;</div></li><li><div>            $initial_settings = array(&nbsp;</div></li><li><div>                'bpfla_use_profile_avatar' =&gt; self::USE_PROFILE_AVATAR, &nbsp;</div></li><li><div>                'bpfla_use_gravatar' =&gt; self::USE_GRAVATAR, &nbsp;</div></li><li><div>                'bpfla_avatar_set' =&gt; self::AVATAR_SET, &nbsp;</div></li><li><div>                'bpfla_letter_index' =&gt; self::LETTER_INDEX, &nbsp;</div></li><li><div>                'bpfla_file_format' =&gt; self::IMAGES_FORMAT, &nbsp;</div></li><li><div>                'bpfla_round_avatars' =&gt; self::ROUND_AVATARS, &nbsp;</div></li><li><div>                'bpfla_unknown_image' =&gt; self::IMAGE_UNKNOWN, &nbsp;</div></li><li><div>                'bpfla_filter_priority' =&gt; self::FILTER_PRIORITY&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            add_option('bpfla_settings', $initial_settings);&nbsp;</div></li><li><div>        } else { // there are records in DB for our plugin&nbsp;</div></li><li><div>            // and then assign them to our class properties (only if exsits in array):&nbsp;</div></li><li><div>            $this-&gt;use_profile_avatar = (array_key_exists('bpfla_use_profile_avatar', $options) ? (bool)$options['bpfla_use_profile_avatar'] : false);&nbsp;</div></li><li><div>            $this-&gt;use_gravatar = (array_key_exists('bpfla_use_gravatar', $options) ? (bool)$options['bpfla_use_gravatar'] : false);&nbsp;</div></li><li><div>            $this-&gt;avatar_set = (array_key_exists('bpfla_avatar_set', $options) ? (string)$options['bpfla_avatar_set'] : self::AVATAR_SET);&nbsp;</div></li><li><div>            $this-&gt;letter_index = (array_key_exists('bpfla_letter_index', $options) ? (int)$options['bpfla_letter_index'] : self::LETTER_INDEX);&nbsp;</div></li><li><div>            $this-&gt;images_format = (array_key_exists('bpfla_file_format', $options) ? (string)$options['bpfla_file_format'] : self::IMAGES_FORMAT);&nbsp;</div></li><li><div>            $this-&gt;round_avatars = (array_key_exists('bpfla_round_avatars', $options) ? (bool)$options['bpfla_round_avatars'] : false);&nbsp;</div></li><li><div>            $this-&gt;image_unknown = (array_key_exists('bpfla_unknown_image', $options) ? (string)$options['bpfla_unknown_image'] : self::IMAGE_UNKNOWN);&nbsp;</div></li><li><div>            $this-&gt;filter_priority = (array_key_exists('bpfla_filter_priority', $options) ? (int)$options['bpfla_filter_priority'] : self::FILTER_PRIORITY);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** --------------- WP HOOKS --------------- */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add plugins_loaded action to load textdomain:&nbsp;</div></li><li><div>        add_action('plugins_loaded', array($this, 'plugins_loaded'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add Settings link to plugins page:&nbsp;</div></li><li><div>        add_filter('plugin_action_links_' . plugin_basename(__FILE__), array($this, 'add_settings_link'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add plugin activation hook:&nbsp;</div></li><li><div>        register_activation_hook(__FILE__, array($this, 'plugin_activate'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add stylesheets/scripts:&nbsp;</div></li><li><div>        add_action('wp_enqueue_scripts', array($this, 'enqueue_scripts'));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add filter to get_avatar:&nbsp;</div></li><li><div>        add_filter('get_avatar', array($this, 'set_comment_avatar'), $this-&gt;filter_priority, 5); // this will only be used for anonymous WordPress comments (from non-users)&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add filter to bp_core_fetch_avatar:&nbsp;</div></li><li><div>        add_filter('bp_core_fetch_avatar', array($this, 'set_buddypress_avatar'), $this-&gt;filter_priority, 2); // this is used for every avatar call except the anonymous comment posters&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add filter for wpDiscuz:&nbsp;</div></li><li><div>        add_filter('wpdiscuz_author_avatar_field', array($this, 'set_wpdiscuz_avatar'), $this-&gt;filter_priority, 4);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // when in admin, make sure first letter avatars are not displayed on discussion settings page:&nbsp;</div></li><li><div>        if (is_admin()) {&nbsp;</div></li><li><div>            global $pagenow;&nbsp;</div></li><li><div>            if ($pagenow == 'options-discussion.php') {&nbsp;</div></li><li><div>                remove_filter('get_avatar', array($this, 'set_comment_avatar'), $this-&gt;filter_priority);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Plugins loaded - load text domain&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function plugins_loaded() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        load_plugin_textdomain('buddypress-first-letter-avatar', FALSE, basename(dirname(__FILE__)) . '/languages/');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add scripts and stylesheets&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function enqueue_scripts() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        wp_enqueue_style('wpfla-style-handle', plugins_url('css/style.css', __FILE__));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * On plugin activation check WP and PHP version and if requirements are not met, disable the plugin and display error&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function plugin_activate() { // plugin activation event&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $php = self::MINIMUM_PHP;&nbsp;</div></li><li><div>        $wp = self::MINIMUM_WP;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check PHP and WP compatibility:&nbsp;</div></li><li><div>        global $wp_version;&nbsp;</div></li><li><div>        if (version_compare(PHP_VERSION, $php, '&lt;'))&nbsp;</div></li><li><div>            $flag = 'PHP';&nbsp;</div></li><li><div>        else if    (version_compare($wp_version, $wp, '&lt;'))&nbsp;</div></li><li><div>            $flag = 'WordPress';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($flag)) {&nbsp;</div></li><li><div>            $version = 'PHP' == $flag ? $php : $wp;&nbsp;</div></li><li><div>            deactivate_plugins(plugin_basename(__FILE__));&nbsp;</div></li><li><div>            $wrong_version_text = sprintf(__('&lt;p&gt;This plugin requires %s version %s or greater.&lt;/p&gt;', 'buddypress-first-letter-avatar'), $flag, $version);&nbsp;</div></li><li><div>            $wrong_version_message_title = __('Plugin Activation Error', 'buddypress-first-letter-avatar');&nbsp;</div></li><li><div>            wp_die($wrong_version_text, $wrong_version_message_title, array('response' =&gt; 200, 'back_link' =&gt; true));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Add Settings link to Plugins section&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function add_settings_link($links) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // add localised Settings link do plugin settings on plugins page:&nbsp;</div></li><li><div>        $settings_link = '&lt;a href=&quot;options-general.php?page=buddypress_first_letter_avatar&quot;&gt;'.__('Settings', 'buddypress-first-letter-avatar').'&lt;/a&gt;';&nbsp;</div></li><li><div>        array_unshift($links, $settings_link);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $links;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This is method is used to filter wpDiscuz parameter - it feeds $comment object to get_avatar() function&nbsp;</div></li><li><div>     * (more on line 102 in wpdiscuz/templates/comment/class.WpdiscuzWalker.php)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_wpdiscuz_avatar($author_avatar_field, $comment, $user, $profile_url) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // that's all we need - instead of user ID or guest email supplied in&nbsp;</div></li><li><div>        // $author_avatar_field, we just need to return the $comment object&nbsp;</div></li><li><div>        return $comment;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method is used only for guest comments (BP filters do not filter guest avatars)&nbsp;</div></li><li><div>     * It returns a full HTML &lt;img /&gt; tag with avatar (first letter or Gravatar)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_comment_avatar($avatar, $id_or_email, $size = '96', $default = '', $alt = '') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create two main variables:&nbsp;</div></li><li><div>        $name = '';&nbsp;</div></li><li><div>        $email = '';&nbsp;</div></li><li><div>        $user = null; // we will try to assign User object to this&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (is_object($id_or_email)) { // id_or_email can actually be also a comment object, so let's check it first&nbsp;</div></li><li><div>            if (!empty($id_or_email-&gt;comment_ID)) {&nbsp;</div></li><li><div>                $comment_id = $id_or_email-&gt;comment_ID; // it is a comment object and we can take the ID&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $comment_id = null;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $comment_id = null;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($comment_id === null) { // if it's not a regular comment, use $id_or_email to get more data&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (is_numeric($id_or_email)) { // if id_or_email represents user id, get user by id&nbsp;</div></li><li><div>                $id = (int) $id_or_email;&nbsp;</div></li><li><div>                $user = get_user_by('id', $id);&nbsp;</div></li><li><div>            } else if (is_object($id_or_email)) { // if id_or_email represents an object&nbsp;</div></li><li><div>                if (!empty($id_or_email-&gt;user_id)) {  // if we can get user_id from the object, get user by id&nbsp;</div></li><li><div>                    $id = (int) $id_or_email-&gt;user_id;&nbsp;</div></li><li><div>                    $user = get_user_by('id', $id);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!empty($user) && is_object($user)) { // if commenter is a registered user... (technically it's not possible, since ...&nbsp;</div></li><li><div>                $name = $user-&gt;data-&gt;display_name; // ... this method is only called when unregistered user writes comments, but it's still worth checking)&nbsp;</div></li><li><div>                $email = $user-&gt;data-&gt;user_email;&nbsp;</div></li><li><div>            } else if (is_string($id_or_email)) { // if string was supplied&nbsp;</div></li><li><div>                if (!filter_var($id_or_email, FILTER_VALIDATE_EMAIL)) { // if it is NOT email, it must be a username&nbsp;</div></li><li><div>                    $name = $id_or_email;&nbsp;</div></li><li><div>                } else { // it must be email&nbsp;</div></li><li><div>                    $email = $id_or_email;&nbsp;</div></li><li><div>                    $user = get_user_by('email', $email);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else { // if commenter is not a registered user, we have to try various fallbacks&nbsp;</div></li><li><div>                $post_id = get_the_ID();&nbsp;</div></li><li><div>                if ($post_id !== null) { // if this actually is a post...&nbsp;</div></li><li><div>                    $post_data = array('name' =&gt; '', 'email' =&gt; '');&nbsp;</div></li><li><div>                    // first we try for bbPress:&nbsp;</div></li><li><div>                    $post_data['name'] = get_post_meta($post_id, '_bbp_anonymous_name', true);&nbsp;</div></li><li><div>                    $post_data['email'] = get_post_meta($post_id, '_bbp_anonymous_email', true);&nbsp;</div></li><li><div>                    if (!empty($post_data)) { // we have some post data...&nbsp;</div></li><li><div>                        $name = $post_data['name'];&nbsp;</div></li><li><div>                        $email = $post_data['email'];&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                } else { // nothing else to do, assign email from id_or_email to email and later use it as name&nbsp;</div></li><li><div>                    if (!empty($id_or_email)) {&nbsp;</div></li><li><div>                        $email = $id_or_email;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else { // if it's a standard comment, use basic comment functions to retrive info&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $comment = $id_or_email;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!empty($comment-&gt;comment_author)) {&nbsp;</div></li><li><div>                $name = $comment-&gt;comment_author;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $name = get_comment_author();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!empty($comment-&gt;comment_author_email)) {&nbsp;</div></li><li><div>                $email = $comment-&gt;comment_author_email;&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                $email = get_comment_author_email();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($name) && !empty($user) && is_object($user)) { // if we do not have the name, but we have user object&nbsp;</div></li><li><div>            $name = $user-&gt;display_name;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($email) && !empty($user) && is_object($user)) { // if we do not have the email, but we have user object&nbsp;</div></li><li><div>            $email = $user-&gt;user_email;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check whether Gravatar should be used at all:&nbsp;</div></li><li><div>        if ($this-&gt;use_gravatar == true) {&nbsp;</div></li><li><div>            $gravatar_uri = $this-&gt;generate_gravatar_uri($email, $size);&nbsp;</div></li><li><div>            $first_letter_uri = $this-&gt;generate_first_letter_uri($name, $size);&nbsp;</div></li><li><div>            $avatar_uri = $gravatar_uri . '&default=' . urlencode($first_letter_uri);&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            // gravatar is not used:&nbsp;</div></li><li><div>            $first_letter_uri = $this-&gt;generate_first_letter_uri($name, $size);&nbsp;</div></li><li><div>            $avatar_uri = $first_letter_uri;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $avatar_img_output = $this-&gt;generate_avatar_img_tag($avatar_uri, $size, $alt); // get final &lt;img /&gt; tag for the avatar/gravatar&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $avatar_img_output;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method is used to filter every avatar, except for anonymous comments.&nbsp;</div></li><li><div>     * It returns full &lt;img /&gt; HTML tag&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public function set_buddypress_avatar($html_data = '', $params = array()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($params)) { // data not supplied&nbsp;</div></li><li><div>            return $html_data; // return original image&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // Create HTML object to get some data out of the image supplied:&nbsp;</div></li><li><div>        $html_doc = new DOMDocument();&nbsp;</div></li><li><div>        $html_doc-&gt;loadHTML($html_data);&nbsp;</div></li><li><div>        $image = $html_doc-&gt;getElementsByTagName('img');&nbsp;</div></li><li><div>        if (empty($image)) { // if there is no image...&nbsp;</div></li><li><div>            return $html_data;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach ($image as $image_data) { // we are using foreach, but in fact there should be only one image&nbsp;</div></li><li><div>            $original_image_url = $image_data-&gt;getAttribute('src'); // url of the original image&nbsp;</div></li><li><div>            break; // this foreach loop should be exectued only once no matter what, since there is only one img tag, but just to be safe we are going to use break here&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // these params are very well documented in BuddyPress' bp-core-avatar.php file:&nbsp;</div></li><li><div>        $id = $params['item_id'];&nbsp;</div></li><li><div>        $object = $params['object'];&nbsp;</div></li><li><div>        $size = $params['width'];&nbsp;</div></li><li><div>        $alt = $params['alt'];&nbsp;</div></li><li><div>        $email = $params['email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($object == 'user') { // if we are filtering user's avatar&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // if there is no gravatar URL, it means that user has set his own profile avatar, &nbsp;</div></li><li><div>            // so we're gonna see if we should be using it (user avatar);&nbsp;</div></li><li><div>            // if we should, just return the input data and leave the avatar as it was:&nbsp;</div></li><li><div>            if ($this-&gt;use_profile_avatar == true) {&nbsp;</div></li><li><div>                if (stripos($original_image_url, 'gravatar.com/avatar') === false) { // we need to specifically check for false (hence '===')&nbsp;</div></li><li><div>                    return $html_data;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($id) && $id !== 0) { // if id not specified (and id not equal 0)&nbsp;</div></li><li><div>                if (is_user_logged_in()) { // if user logged in&nbsp;</div></li><li><div>                    $user = get_user_by('id', get_current_user_id());&nbsp;</div></li><li><div>                    $id = get_current_user_id(); // get current user's id&nbsp;</div></li><li><div>                } else {&nbsp;</div></li><li><div>                    return $html_data; // no id specified and user not logged in - return the original image&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $user = get_user_by('id', $id); // let's get user object from DB&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($size)) { // if for some reason size was not specified...&nbsp;</div></li><li><div>                $size = 48; // just set it to 48&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($alt)) {&nbsp;</div></li><li><div>                $alt = __('Profile Photo', 'buddypress');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($email)) { // if for some reason email was not specified&nbsp;</div></li><li><div>                $email = $user-&gt;data-&gt;user_email; // get it by user id&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $name = $user-&gt;data-&gt;display_name;&nbsp;</div></li><li><div>            if (empty($name)) {&nbsp;</div></li><li><div>                $name = bp_core_get_username($id); // BuddyPress fallback&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if (empty($name)) {&nbsp;</div></li><li><div>                $name = $user-&gt;data-&gt;user_nicename; // another fallback (to WP nicename)&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else if ($object == 'group') { // we're filtering group&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($id) && $id !== 0) { // if for some reason there is no id&nbsp;</div></li><li><div>                return $html_data;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $group = groups_get_group(array('group_id' =&gt; $id)); // get the Group object by ID&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($group)) { // if for some reason group is empty/does not exist/etc.&nbsp;</div></li><li><div>                return $html_data; // return the input data&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // we are using the same way to determine whether group has avatar set as we did with user avatars&nbsp;</div></li><li><div>            // if there is no gravatar URL, it means that group has their own avatar, &nbsp;</div></li><li><div>            // so we're gonna see if we should be using it (user/group avatar);&nbsp;</div></li><li><div>            // if we should, just return the input data and leave the avatar as it was:&nbsp;</div></li><li><div>            if ($this-&gt;use_profile_avatar == true) {&nbsp;</div></li><li><div>                if (stripos($original_image_url, 'gravatar.com/avatar') === false) { // we need to specifically check for false (hence '===')&nbsp;</div></li><li><div>                    return $html_data;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($group-&gt;name)) { // if for some reason there is no name&nbsp;</div></li><li><div>                return $html_data;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $name = $group-&gt;name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($size)) { // if for some reason size was not specified...&nbsp;</div></li><li><div>                $size = 96; // just set it to 96&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (empty($alt)) {&nbsp;</div></li><li><div>                $alt = __('Group logo of %s', 'buddypress');&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else if ($object == 'blog') { // we're filtering blog&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $html_data;    // this feature is not used at all, so just return the input parameter&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else { // not user, not group and not blog - just return the input html image&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $html_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $first_letter_uri = $this-&gt;generate_first_letter_uri($name, $size); // get letter URL&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check whether Gravatar should be used at all:&nbsp;</div></li><li><div>        if ($this-&gt;use_gravatar == true && !empty($email)) { // if we should user gravatar and we have email&nbsp;</div></li><li><div>            $gravatar_uri = $this-&gt;generate_gravatar_uri($email, $size);&nbsp;</div></li><li><div>            $avatar_uri = $gravatar_uri . '&default=' . urlencode($first_letter_uri);&nbsp;</div></li><li><div>        } else { // gravatar not used or we do not have email&nbsp;</div></li><li><div>            $avatar_uri = $first_letter_uri;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $avatar_img_output = $this-&gt;generate_avatar_img_tag($avatar_uri, $size, $alt); // get final &lt;img /&gt; tag for the avatar/gravatar&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $avatar_img_output;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Generate full HTML &lt;img /&gt; tag with avatar URL, size, CSS classes etc.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function generate_avatar_img_tag($avatar_uri, $size, $alt = '') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // prepare extra classes for &lt;img&gt; tag depending on plugin settings:&nbsp;</div></li><li><div>        $extra_img_class = '';&nbsp;</div></li><li><div>        if ($this-&gt;round_avatars == true) {&nbsp;</div></li><li><div>            $extra_img_class .= 'round-avatars';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $output_data = &quot;&lt;img alt='{$alt}' src='{$avatar_uri}' class='avatar avatar-{$size} photo bpfla {$extra_img_class}' width='{$size}' height='{$size}' /&gt;&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // return the complete &lt;img&gt; tag:&nbsp;</div></li><li><div>        return $output_data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method generates full URL for letter avatar (for example http://yourblog.com/wp-content/plugins/buddypress-first-letter-avatar/images/default/96/k.png), &nbsp;</div></li><li><div>     * according to the $name and $size provided&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function generate_first_letter_uri($name, $size) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get picture filename (and lowercase it) from commenter name:&nbsp;</div></li><li><div>        if (empty($name)) {  // if, for some reason, the name is empty, set file_name to default unknown image&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $file_name = $this-&gt;image_unknown;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        } else { // name is not empty, so we can proceed&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $file_name = substr($name, $this-&gt;letter_index, 1); // get one letter counting from letter_index&nbsp;</div></li><li><div>            $file_name = strtolower($file_name); // lowercase it...&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (extension_loaded('mbstring')) { // check if mbstring is loaded to allow multibyte string operations&nbsp;</div></li><li><div>                $file_name_mb = mb_substr($name, $this-&gt;letter_index, 1); // repeat, this time with multibyte functions&nbsp;</div></li><li><div>                $file_name_mb = mb_strtolower($file_name_mb); // and again...&nbsp;</div></li><li><div>            } else { // mbstring is not loaded - we're not going to worry about it, just use the original string&nbsp;</div></li><li><div>                $file_name_mb = $file_name;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // couple of exceptions:&nbsp;</div></li><li><div>            if ($file_name_mb == '*') {&nbsp;</div></li><li><div>                $file_name = 'a';&nbsp;</div></li><li><div>                $file_name_mb = 'a';&nbsp;</div></li><li><div>            } else if ($file_name_mb == '*') {&nbsp;</div></li><li><div>                $file_name = 'c';&nbsp;</div></li><li><div>                $file_name_mb = 'c';&nbsp;</div></li><li><div>            } else if ($file_name_mb == '*') {&nbsp;</div></li><li><div>                $file_name = 'e';&nbsp;</div></li><li><div>                $file_name_mb = 'e';&nbsp;</div></li><li><div>            } else if ($file_name_mb == '*') {&nbsp;</div></li><li><div>                $file_name = 'n';&nbsp;</div></li><li><div>                $file_name_mb = 'n';&nbsp;</div></li><li><div>            } else if ($file_name_mb == '') {&nbsp;</div></li><li><div>                $file_name = 'o';&nbsp;</div></li><li><div>                $file_name_mb = 'o';&nbsp;</div></li><li><div>            } else if ($file_name_mb == '*') {&nbsp;</div></li><li><div>                $file_name = 's';&nbsp;</div></li><li><div>                $file_name_mb = 's';&nbsp;</div></li><li><div>            } else if ($file_name_mb == '*' || $file_name_mb == '*') {&nbsp;</div></li><li><div>                $file_name = 'z';&nbsp;</div></li><li><div>                $file_name_mb = 'z';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // create arrays with allowed character ranges:&nbsp;</div></li><li><div>            $allowed_numbers = range(0, 9);&nbsp;</div></li><li><div>            foreach ($allowed_numbers as $number) { // cast each item to string (strict param of in_array requires same type)&nbsp;</div></li><li><div>                $allowed_numbers[$number] = (string)$number;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $allowed_letters_latin = range('a', 'z');&nbsp;</div></li><li><div>            $allowed_letters_cyrillic = range('*', '*');&nbsp;</div></li><li><div>            $allowed_letters_arabic = range('*', '*');&nbsp;</div></li><li><div>            // check if the file name meets the requirement; if it doesn't - set it to unknown&nbsp;</div></li><li><div>            $charset_flag = ''; // this will be used to determine whether we are using latin chars, cyrillic chars, arabic chars or numbers&nbsp;</div></li><li><div>            // check whther we are using latin/cyrillic/numbers and set the flag, so we can later act appropriately:&nbsp;</div></li><li><div>            if (in_array($file_name, $allowed_numbers, true)) {&nbsp;</div></li><li><div>                $charset_flag = 'number';&nbsp;</div></li><li><div>            } else if (in_array($file_name, $allowed_letters_latin, true)) {&nbsp;</div></li><li><div>                $charset_flag = 'latin';&nbsp;</div></li><li><div>            } else if (in_array($file_name, $allowed_letters_cyrillic, true)) {&nbsp;</div></li><li><div>                $charset_flag = 'cyrillic';&nbsp;</div></li><li><div>            } else if (in_array($file_name, $allowed_letters_arabic, true)) {&nbsp;</div></li><li><div>                $charset_flag = 'arabic';&nbsp;</div></li><li><div>            } else { // for some reason none of the charsets is appropriate&nbsp;</div></li><li><div>                $file_name = $this-&gt;image_unknown; // set it to uknknown&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if (!empty($charset_flag)) { // if charset_flag is not empty, i.e. flag has been set to latin, number or cyrillic...&nbsp;</div></li><li><div>                switch ($charset_flag) { // run through various options to determine the actual filename for the letter avatar&nbsp;</div></li><li><div>                    case 'number':&nbsp;</div></li><li><div>                        $file_name = 'number_' . $file_name;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'latin':&nbsp;</div></li><li><div>                        $file_name = 'latin_' . $file_name;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'cyrillic':&nbsp;</div></li><li><div>                        $temp_array = unpack('V', iconv('UTF-8', 'UCS-4LE', $file_name_mb)); // beautiful one-liner by @bobince from SO - http://stackoverflow.com/a/27444149/4848918&nbsp;</div></li><li><div>                        $unicode_code_point = $temp_array[1];&nbsp;</div></li><li><div>                        $file_name = 'cyrillic_' . $unicode_code_point;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    case 'arabic':&nbsp;</div></li><li><div>                        $temp_array = unpack('V', iconv('UTF-8', 'UCS-4LE', $file_name_mb));&nbsp;</div></li><li><div>                        $unicode_code_point = $temp_array[1];&nbsp;</div></li><li><div>                        $file_name = 'arabic_' . $unicode_code_point;&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                    default:&nbsp;</div></li><li><div>                        $file_name = $this-&gt;image_unknown; // set it to uknknown&nbsp;</div></li><li><div>                        break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // detect most appropriate size based on WP avatar size:&nbsp;</div></li><li><div>        if ($size &lt;= 48) $custom_avatar_size = '48';&nbsp;</div></li><li><div>        else if ($size &gt; 48 && $size &lt;= 96) $custom_avatar_size = '96';&nbsp;</div></li><li><div>        else if ($size &gt; 96 && $size &lt;= 128) $custom_avatar_size = '128';&nbsp;</div></li><li><div>        else if ($size &gt; 128 && $size &lt;= 256) $custom_avatar_size = '256';&nbsp;</div></li><li><div>        else $custom_avatar_size = '512';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // create file path - $avatar_uri variable will look something like this:&nbsp;</div></li><li><div>        // http://yourblog.com/wp-content/plugins/buddypress-first-letter-avatar/images/default/96/k.png):&nbsp;</div></li><li><div>        $avatar_uri =&nbsp;</div></li><li><div>            plugins_url() . '/'&nbsp;</div></li><li><div>            . dirname(plugin_basename(__FILE__)) . '/'&nbsp;</div></li><li><div>            . self::IMAGES_PATH . '/'&nbsp;</div></li><li><div>            . $this-&gt;avatar_set . '/'&nbsp;</div></li><li><div>            . $custom_avatar_size . '/'&nbsp;</div></li><li><div>            . $file_name . '.'&nbsp;</div></li><li><div>            . $this-&gt;images_format;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // return the final first letter image url:&nbsp;</div></li><li><div>        return $avatar_uri;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method generates full URL for Gravatar, according to the $email and $size provided&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function generate_gravatar_uri($email, $size = '96') {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) { // if email not correct&nbsp;</div></li><li><div>            $email = ''; // set it to empty string&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // email to gravatar url:&nbsp;</div></li><li><div>        $avatar_uri = self::GRAVATAR_URL;&nbsp;</div></li><li><div>        $avatar_uri .= md5(strtolower(trim($email)));&nbsp;</div></li><li><div>        $avatar_uri .= &quot;?s={$size}&r=g&quot;;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $avatar_uri;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * This method is not used, but I'm keeping it since it may be useful.&nbsp;</div></li><li><div>     * This method generates a clean gravatar URL from any kind of gravatar URL. It's useful, because it allows to control exactly how the Gravatar URL looks like.&nbsp;</div></li><li><div>     * It basically strips any parameters and makes sure that the gravatar URL always has the same format (for example https://secure.gravatar.com/avatar/)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>    private function generate_gravatar_uri_from_gravatar_url($gravatar_inital_uri) { // this method is needed to make sure we control how the gravatar uri looks like&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    // before we start anything, we need to get the actual size from the displayed gravatar:&nbsp;</div></li><li><div>    $url_parts = parse_url($gravatar_inital_uri);&nbsp;</div></li><li><div>    if (!empty($url_parts['query'])) {&nbsp;</div></li><li><div>    parse_str($url_parts['query'], $url_query);&nbsp;</div></li><li><div>    if (!empty($url_query['s'])) {&nbsp;</div></li><li><div>    $size = $url_query['s'];&nbsp;</div></li><li><div>    } else if (!empty($url_query['size'])) {&nbsp;</div></li><li><div>    $size = $url_query['size'];&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>    $size = '96';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    } else {&nbsp;</div></li><li><div>    $size = '96';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    // first let's strip all get parameters:&nbsp;</div></li><li><div>    $gravatar_uri_array = explode('?', $gravatar_inital_uri);&nbsp;</div></li><li><div>    $gravatar_uri = $gravatar_uri_array[0];&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    $gravatar_uri = strtolower($gravatar_uri); // lowercase the whole url&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    $possible_starts = array( // possible ways of how the url may start&nbsp;</div></li><li><div>    'https://secure.gravatar.com/avatar/', &nbsp;</div></li><li><div>    'https://www.gravatar.com/avatar/', &nbsp;</div></li><li><div>    'https://gravatar.com/avatar/', &nbsp;</div></li><li><div>    'http://secure.gravatar.com/avatar/', &nbsp;</div></li><li><div>    'http://www.gravatar.com/avatar/', &nbsp;</div></li><li><div>    'http://gravatar.com/avatar/', &nbsp;</div></li><li><div>    '//secure.gravatar.com/avatar/', &nbsp;</div></li><li><div>    '//www.gravatar.com/avatar/', &nbsp;</div></li><li><div>    '//gravatar.com/avatar/'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    $gravatar_hash = '';&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    foreach ($possible_starts as $possible_start) {&nbsp;</div></li><li><div>    if (strpos($gravatar_uri, $possible_start) === 0) { // if starts with this string...&nbsp;</div></li><li><div>    $gravatar_hash = str_replace($possible_start, '', $gravatar_uri); // we need to remove the possible url beginning, so that we are left with just the md5 gravatar hash&nbsp;</div></li><li><div>    break; // since we have found what we needed, we can cancel loop execution&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    // now we have the just the md5 hash, so we can construct the gravatar uri exactly the way we want:&nbsp;</div></li><li><div>    $avatar_uri = self::GRAVATAR_URL;&nbsp;</div></li><li><div>    $avatar_uri .= $gravatar_hash;&nbsp;</div></li><li><div>    $avatar_uri .= &quot;?s={$size}&r=g&quot;;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    return $avatar_uri;&nbsp;</div></li><li><div>&nbsp;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.2.5</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.7/classes/buddy_press_first_letter_avatar/" class="">2.2.7</a></li><li><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6.2/classes/buddy_press_first_letter_avatar/" class="">2.2.6.2</a></li><li><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6.1/classes/buddy_press_first_letter_avatar/" class="">2.2.6.1</a></li><li><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.6/classes/buddy_press_first_letter_avatar/" class="active">2.2.6</a></li><li><a href="http://hookr.io/plugins/buddypress-first-letter-avatar/2.2.5/classes/buddy_press_first_letter_avatar/" class="">2.2.5</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>BuddyPress_First_Letter_Avatar</li><li><span></span>BuddyPress First Letter Avatar</li><li><span></span>2.2.7</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>