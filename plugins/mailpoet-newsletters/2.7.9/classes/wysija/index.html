<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.9" data-slug="mailpoet-newsletters" data-type="class" data-id="55717"><head xmlns="http://www.w3.org/1999/xhtml"><title> wysija | class | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WYSIJA, class, plugin, mailpoet-newsletters, 2.7.9" /><meta name="description" content="The MailPoet Newsletters WYSIJA class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=7abe434a50cad0b840ee8aeebdf14b8b' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wysija/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.9-class-wysija","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wysija" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.9." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/" class="H_VERSION"><span property="name">2.7.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wysija</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="298"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/all/" title="All">All <span class="count badge">298</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/hooks/" title="Hooks">Hooks <span class="count badge">104</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="74"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/filters/" title="Filters">Filters <span class="count badge">74</span></a></li><li class="active" data-id="class" data-count="131"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/classes/" title="Classes">Classes <span class="count badge">131</span></a></li><li class="" data-id="constant" data-count="52"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/constants/" title="Constants">Constants <span class="count badge">52</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WYSIJA</strong></h1><p>The MailPoet Newsletters <strong>WYSIJA</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(1)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/files/core-base/" class="file">/core/base.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="51" class="block" start="428"><li><div>class WYSIJA extends WYSIJA_object{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>      parent::__construct();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function created at the beginning to handle particular cases with WP get_permalink it got much smaller recently&nbsp;</div></li><li><div>     * @param int $pageid&nbsp;</div></li><li><div>     * @param array $params&nbsp;</div></li><li><div>     * @param boolean $simple&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_permalink( $pageid, $params = array(), $simple = false ) {&nbsp;</div></li><li><div>        $hWPtools = WYSIJA::get( 'wp_tools', 'helper' );&nbsp;</div></li><li><div>        return $hWPtools-&gt;get_permalink( $pageid, $params, $simple );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * translate the plugin&nbsp;</div></li><li><div>     * @staticvar boolean $extensionloaded&nbsp;</div></li><li><div>     * @param type $extendedplugin&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_lang( $extendedplugin = false ) {&nbsp;</div></li><li><div>        static $extensionloaded = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //we return the entire array of extensions loaded if non is specified&nbsp;</div></li><li><div>        if ( ! $extendedplugin ) {&nbsp;</div></li><li><div>            return $extensionloaded;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //we only need to load this translation loader once on init&nbsp;</div></li><li><div>        if(!$extensionloaded) {&nbsp;</div></li><li><div>            add_action('init', array('WYSIJA', 'load_lang_init'));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        //each plugin has a different name&nbsp;</div></li><li><div>        if ( !$extensionloaded || !isset($extensionloaded[$extendedplugin])) {&nbsp;</div></li><li><div>            $transstring = null;&nbsp;</div></li><li><div>            switch($extendedplugin) {&nbsp;</div></li><li><div>                case 'wysija-newsletters':&nbsp;</div></li><li><div>                    $transstring=WYSIJA;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'wysijashop':&nbsp;</div></li><li><div>                    $transstring=WYSIJASHOP;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'wysijacrons':&nbsp;</div></li><li><div>                    $transstring=WYSIJACRONS;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'wysija-newsletters-premium':&nbsp;</div></li><li><div>                    $transstring=WYSIJANLP;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                case 'get_all':&nbsp;</div></li><li><div>                    return $extensionloaded;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //store all the required translations to be loaded in the static variable&nbsp;</div></li><li><div>            if($transstring !== null) {&nbsp;</div></li><li><div>                $extensionloaded[$extendedplugin] = $transstring;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * check if the user is tech support as this can be used to switch the language back to english when helping our customers&nbsp;</div></li><li><div>     * @global type $current_user&nbsp;</div></li><li><div>     * @param type $debugmode&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_wysija_admin($debugmode=false) {&nbsp;</div></li><li><div>        //to allow wysija team members to work in english mode if debug is activated&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if((int)$debugmode &gt; 0 && empty($current_user)) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($current_user-&gt;data-&gt;user_email) && (strpos($current_user-&gt;data-&gt;user_email, '@mailpoet.com') !== false)) {&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this function exists just to fix the issue with qtranslate :/ (it only fix it partially)&nbsp;</div></li><li><div>     * @param type $extended_plugin&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_lang_init($extended_plugin=false) {&nbsp;</div></li><li><div>        $model_config =  WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $debug_mode = (int)$model_config-&gt;getValue('debug_new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($debug_mode === 0 || ($debug_mode &gt; 0 && WYSIJA::is_wysija_admin($debug_mode) === false)) {&nbsp;</div></li><li><div>            $extensions_loaded = WYSIJA::load_lang('get_all');&nbsp;</div></li><li><div>            foreach($extensions_loaded as $extended_plugin =&gt; $translation_string) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // check for translation file overriding from transstring wp-content/languages/wysija-newsletters/wysija-newsletters-en_US.mo&nbsp;</div></li><li><div>                $filename = WP_CONTENT_DIR.DS.'languages'.DS.$extended_plugin.DS.$translation_string.'-'.get_locale().'.mo';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if( !file_exists($filename) ) {&nbsp;</div></li><li><div>                    // get the translation file in our local file&nbsp;</div></li><li><div>                    $filename = WYSIJA_PLG_DIR.$extended_plugin.DS.'languages'.DS.$translation_string.'-'.get_locale().'.mo';&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // load the translation file with WP's load_textdomain&nbsp;</div></li><li><div>                if( file_exists( $filename ) ) {&nbsp;</div></li><li><div>                    load_textdomain( $translation_string, $filename );&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function to generate objects of different types, managing file requiring in order to be the most efficient&nbsp;</div></li><li><div>     * @staticvar array $arrayOfObjects&nbsp;</div></li><li><div>     * @param string $name&nbsp;</div></li><li><div>     * @param string $type : in which folder do we go and pick the class&nbsp;</div></li><li><div>     * @param boolean $force_side : this parameter is almost never set to true, &nbsp;</div></li><li><div>     *                              it will be useful for instance if you want to get a back controller&nbsp;</div></li><li><div>     *                              from the frontend, it was used maybe in the shop but it can be ignored for wysija-newsletters&nbsp;</div></li><li><div>     * @param type $extended_plugin : used only when calling the url from a different plugin it is used watch those files :&nbsp;</div></li><li><div>     *                              -core/controller.php line 21, 23 , 24&nbsp;</div></li><li><div>     * @param type $load_lang : the load lang is in the get  to be sure we don't forget to load the language file for each plugin at least once&nbsp;</div></li><li><div>     *                          the way I see it it could be moved to the index.php of each plugin. for now only wysija-newsletters is translated anyway&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get($name, $type, $force_side=false, $extended_plugin='wysija-newsletters', $load_lang=true) {&nbsp;</div></li><li><div>        static $array_of_objects;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($load_lang)  WYSIJA::load_lang($extended_plugin);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // store all the objects made so that we can reuse them accross the application if the object is already set we return it immediately&nbsp;</div></li><li><div>        if(isset($array_of_objects[$extended_plugin][$type.$name])) {&nbsp;</div></li><li><div>            return $array_of_objects[$extended_plugin][$type.$name];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // which folder do we pick for controllersand views ? back or front ?&nbsp;</div></li><li><div>        if($force_side) {&nbsp;</div></li><li><div>            $side=$force_side;&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $side=WYSIJA_SIDE;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // for each plugin we will define the $extended_constant variable if it's not defined already&nbsp;</div></li><li><div>        // also we will defined the $extended_plugin_name which corresponds to the folder name and also will be used to build the class to be called&nbsp;</div></li><li><div>        switch($extended_plugin) {&nbsp;</div></li><li><div>            case 'wysija-newsletters-premium':&nbsp;</div></li><li><div>                $extended_constant='WYSIJANLP';&nbsp;</div></li><li><div>                if(!defined($extended_constant)) define($extended_constant, $extended_constant);&nbsp;</div></li><li><div>                $extended_plugin_name='wysijanlp';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'wysija-newsletters':&nbsp;</div></li><li><div>                $extended_constant='WYSIJA';&nbsp;</div></li><li><div>                if(!defined($extended_constant)) define($extended_constant, $extended_constant);&nbsp;</div></li><li><div>                $extended_plugin_name='wysija';&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            default :&nbsp;</div></li><li><div>                $extended_constant=strtoupper($extended_plugin);&nbsp;</div></li><li><div>                if(!defined($extended_constant)) define($extended_constant, $extended_constant);&nbsp;</div></li><li><div>                $extended_plugin_name=$extended_plugin;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // security to protect against dangerous ./../ includes&nbsp;</div></li><li><div>        $name = preg_replace('#[^a-z0-9_]#i', '', $name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // this switch will require_once the file needed and build a the class name depending on the parameters passed to the function&nbsp;</div></li><li><div>        switch($type) {&nbsp;</div></li><li><div>            case 'controller':&nbsp;</div></li><li><div>                // require the parent class necessary&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE.'controller.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $ctrdir=WYSIJA_PLG_DIR.$extended_plugin.DS.'controllers'.DS;&nbsp;</div></li><li><div>                // Require module concept&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE.'module'.DS.'module.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // if we are doing ajax we don't go to one side, ajax is for frontend or backend in the same folder&nbsp;</div></li><li><div>                if(defined('DOING_AJAX')) {&nbsp;</div></li><li><div>                    $class_path=$ctrdir.'ajax'.DS.$name.'.php';&nbsp;</div></li><li><div>                }else {&nbsp;</div></li><li><div>                    // the other controllers are called in a side folder back or front&nbsp;</div></li><li><div>                    $class_path=$ctrdir.$side.DS.$name.'.php';&nbsp;</div></li><li><div>                    // require the side specific controller file&nbsp;</div></li><li><div>                    require_once(WYSIJA_CTRL.$side.'.php');&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>                $class_name = strtoupper($extended_plugin_name).'_control_'.$side.'_'.$name;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'view':&nbsp;</div></li><li><div>                $viewdir=WYSIJA_PLG_DIR.$extended_plugin.DS.'views'.DS;&nbsp;</div></li><li><div>                // let's get the right path for the view front or back and the right class_name&nbsp;</div></li><li><div>                $class_path=$viewdir.$side.DS.$name.'.php';&nbsp;</div></li><li><div>                $class_name = strtoupper($extended_plugin_name).'_view_'.$side.'_'.$name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                // require the common view file and the side view file&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE.'view.php');&nbsp;</div></li><li><div>                require_once(WYSIJA_VIEWS.$side.'.php');&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'helper':&nbsp;</div></li><li><div>                $helpdir=WYSIJA_PLG_DIR.$extended_plugin.DS.'helpers'.DS;&nbsp;</div></li><li><div>                $class_path=$helpdir.$name.'.php';&nbsp;</div></li><li><div>                $class_name = strtoupper($extended_plugin_name).'_help_'.$name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'model':&nbsp;</div></li><li><div>                $modeldir=WYSIJA_PLG_DIR.$extended_plugin.DS.'models'.DS;&nbsp;</div></li><li><div>                $class_path=$modeldir.$name.'.php';&nbsp;</div></li><li><div>                $class_name = strtoupper($extended_plugin_name).'_model_'.$name;&nbsp;</div></li><li><div>                // require the parent class necessary&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE.'model.php');&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>            case 'widget':&nbsp;</div></li><li><div>                $modeldir=WYSIJA_PLG_DIR.$extended_plugin.DS.'widgets'.DS;&nbsp;</div></li><li><div>                $class_path=$modeldir.$name.'.php';&nbsp;</div></li><li><div>                if($name=='wysija_nl') $class_name='WYSIJA_NL_Widget';&nbsp;</div></li><li><div>                else $class_name = strtoupper($extended_plugin_name).'_widget_'.$name;&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            case 'module':&nbsp;</div></li><li><div>                $moduledir = WYSIJA_PLG_DIR . $extended_plugin . DS . 'modules' . DS;&nbsp;</div></li><li><div>                if (file_exists($moduledir . $name . '.php'))&nbsp;</div></li><li><div>                    $class_path = $moduledir . $name . '.php';&nbsp;</div></li><li><div>                elseif (file_exists($moduledir . $name . DS . $name . '.php'))&nbsp;</div></li><li><div>                    $class_path = $moduledir . $name . DS . $name . '.php';&nbsp;</div></li><li><div>                else&nbsp;</div></li><li><div>                    return;&nbsp;</div></li><li><div>                $class_name = strtoupper($extended_plugin_name) . '_module_' . $name;&nbsp;</div></li><li><div>                // require the parent class necessary&nbsp;</div></li><li><div>                //require_once(WYSIJA_CORE.'module'.DS.'module.php');&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE . 'module' . DS . 'statistics_model.php');&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE . 'module' . DS . 'statistics.php');&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE . 'module' . DS . 'statisticschart.php');&nbsp;</div></li><li><div>                require_once(WYSIJA_CORE . 'module' . DS . 'statisticstable.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            default:&nbsp;</div></li><li><div>                WYSIJA::setInfo('error', 'WYSIJA::get does not accept this type of file &quot;'.$type.'&quot; .');&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!file_exists($class_path)) {&nbsp;</div></li><li><div>                        if(is_admin() && WYSIJA::current_user_can('switch_themes')) {&nbsp;</div></li><li><div>                            WYSIJA::setInfo('error', 'file has not been recognised '.$class_path);&nbsp;</div></li><li><div>                            WYSIJA::setInfo('error', $class_name);&nbsp;</div></li><li><div>                            WYSIJA::setInfo('error', $type);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // require the file needed once and store & return the object needed&nbsp;</div></li><li><div>        require_once($class_path);&nbsp;</div></li><li><div>        return $array_of_objects[$extended_plugin][$type.$name]=new $class_name($extended_plugin_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * log function to spot some strange issues when sending emails for instance&nbsp;</div></li><li><div>     * @param type $key&nbsp;</div></li><li><div>     * @param type $data&nbsp;</div></li><li><div>     * @param type $category&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function log($key='default', $data='empty', $category='default') {&nbsp;</div></li><li><div>        $config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if((int)$config-&gt;getValue('debug_new')&gt;1 && $category && $config-&gt;getValue('debug_log_'.$category)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $optionlog=get_option('wysija_log');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $optionlog[$category][(string)microtime(true)][$key]=$data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            WYSIJA::update_option('wysija_log' , $optionlog);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * the filter to add option to the cron frequency instead of being stuck with hourly, daily and twicedaily...&nbsp;</div></li><li><div>     * we can add filters but we cannot delete other values such as the default ones, as this might break other plugins crons&nbsp;</div></li><li><div>     * @param type $param&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function filter_cron_schedules( $param ) {&nbsp;</div></li><li><div>        $frequencies=array(&nbsp;</div></li><li><div>            'one_min' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 60, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every minute', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'two_min' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 120, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every two minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'five_min' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 300, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every five minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'ten_min' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 600, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every ten minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'fifteen_min' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 900, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every fifteen minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'thirty_min' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 1800, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every thirty minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'two_hours' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 7200, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every two hours', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'eachweek' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 604800, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once a week', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'each28days' =&gt; array(&nbsp;</div></li><li><div>                'interval' =&gt; 2419200, &nbsp;</div></li><li><div>                'display' =&gt; __( 'Once every 28 days', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return array_merge($param, $frequencies);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * scheduled task for sending the emails in the queue, the frequency is set in the settings&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function croned_queue( $check_scheduled_newsletter = true) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // check the scheduled tasks only if it's a standard WP scheduled task free only&nbsp;</div></li><li><div>        if($check_scheduled_newsletter) {&nbsp;</div></li><li><div>            WYSIJA::check_scheduled_newsletters();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        // check that the 2000 limit is not passed and process the queue&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if((int)$model_config-&gt;getValue('total_subscribers') &lt; 2000 ) {&nbsp;</div></li><li><div>            $helper_queue = WYSIJA::get('queue', 'helper');&nbsp;</div></li><li><div>            $helper_queue-&gt;report=false;&nbsp;</div></li><li><div>            WYSIJA::log('croned_queue process', true, 'cron');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helper_queue-&gt;process();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function check_scheduled_newsletters() {&nbsp;</div></li><li><div>        $last_scheduled_check = get_option('wysija_last_scheduled_check');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // if the latest post notification check was done more than five minutes ago let's check it again&nbsp;</div></li><li><div>        if(empty($last_scheduled_check) || ( time() &gt; ($last_scheduled_check + 300) ) ) {&nbsp;</div></li><li><div>            // create the scheduled automatic post notifications email if there are any&nbsp;</div></li><li><div>            $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>            $helper_autonews-&gt;checkPostNotif();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // queue the scheduled newsletter also if there are any&nbsp;</div></li><li><div>            $helper_autonews-&gt;checkScheduled();&nbsp;</div></li><li><div>            WYSIJA::update_option('wysija_last_scheduled_check', time());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // send daily report about emails sent&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        if($model_config-&gt;getValue('emails_notified_when_dailysummary')) {&nbsp;</div></li><li><div>            $helper_notification = WYSIJA::get('notifications', 'helper');&nbsp;</div></li><li><div>            $helper_notification-&gt;send_daily_report();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * everyday we make sure not to leave any trash files&nbsp;</div></li><li><div>     * remove temporary files&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function croned_daily() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**user refresh count total*/&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $helper_user-&gt;refreshUsers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**user domain generation*/&nbsp;</div></li><li><div>        $helper_user-&gt;generate_domains();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**clear temporary folders*/&nbsp;</div></li><li><div>        $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>        $helper_file-&gt;clear();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**clear queue from unsubscribed*/&nbsp;</div></li><li><div>        $helper_queue = WYSIJA::get('queue', 'helper');&nbsp;</div></li><li><div>        $helper_queue-&gt;clear();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Weekly cron&nbsp;</div></li><li><div>    public static function croned_weekly() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // If enabled, flag MixPanel sending on next page load.&nbsp;</div></li><li><div>        if ($model_config-&gt;getValue('analytics') == 1) {&nbsp;</div></li><li><div>            $model_config-&gt;save(array('send_analytics_now' =&gt; 1));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // Monthly cron&nbsp;</div></li><li><div>    public static function croned_monthly() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** send daily report about emails sent */&nbsp;</div></li><li><div>        if ($model_config-&gt;getValue('sharedata')) {&nbsp;</div></li><li><div>            $helper_stats = WYSIJA::get('stats', 'helper');&nbsp;</div></li><li><div>            $helper_stats-&gt;share();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * when we deactivate the plugin we clear the WP install from those cron records&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function deactivate() {&nbsp;</div></li><li><div>        wp_clear_scheduled_hook('wysija_cron_queue');&nbsp;</div></li><li><div>        wp_clear_scheduled_hook('wysija_cron_bounce');&nbsp;</div></li><li><div>        wp_clear_scheduled_hook('wysija_cron_daily');&nbsp;</div></li><li><div>        wp_clear_scheduled_hook('wysija_cron_weekly');&nbsp;</div></li><li><div>        wp_clear_scheduled_hook('wysija_cron_monthly');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * wysija's redirect allows to save some variables for the next page load such as notices etc..&nbsp;</div></li><li><div>     * @global type $wysija_msg&nbsp;</div></li><li><div>     * @global type $wysija_queries&nbsp;</div></li><li><div>     * @global type $wysija_queries_errors&nbsp;</div></li><li><div>     * @param type $location&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function redirect($location) {&nbsp;</div></li><li><div>        //save the messages&nbsp;</div></li><li><div>        global $wysija_msg, $wysija_queries, $wysija_queries_errors;&nbsp;</div></li><li><div>        WYSIJA::update_option('wysija_msg', $wysija_msg);&nbsp;</div></li><li><div>        WYSIJA::update_option('wysija_queries', $wysija_queries);&nbsp;</div></li><li><div>        WYSIJA::update_option('wysija_queries_errors', $wysija_queries_errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make sure we encode square brackets as wp_redirect will strip them off&nbsp;</div></li><li><div>        $location = str_replace(array('[', ']'), array('%5B', '%5D'), $location);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // redirect to specified location&nbsp;</div></li><li><div>        wp_redirect($location);&nbsp;</div></li><li><div>        exit;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * custom post type for wysija is call wysijap as in wysija's post&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function create_post_type() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //by default there is url rewriteing on wysijap custom post, though in one client case I had to deactivate it.&nbsp;</div></li><li><div>        //as this is rare we just need to set this setting to activate it&nbsp;</div></li><li><div>        //by default let's deactivate the url rewriting of the wysijap confirmation page because it is breaking in some case.&nbsp;</div></li><li><div>        $show_interface=false;&nbsp;</div></li><li><div>        if(defined('WYSIJA_DBG') && WYSIJA_DBG&gt;1) $show_interface=true;&nbsp;</div></li><li><div>        register_post_type( 'wysijap', &nbsp;</div></li><li><div>            array(&nbsp;</div></li><li><div>                    'labels' =&gt; array(&nbsp;</div></li><li><div>                            'name' =&gt; __('MailPoet page'), &nbsp;</div></li><li><div>                            'singular_name' =&gt; __('MailPoet page')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>            'public' =&gt; true, &nbsp;</div></li><li><div>            'has_archive' =&gt; false, &nbsp;</div></li><li><div>            'show_ui' =&gt;$show_interface, &nbsp;</div></li><li><div>            'show_in_menu' =&gt;$show_interface, &nbsp;</div></li><li><div>            'rewrite' =&gt; false, &nbsp;</div></li><li><div>            'show_in_nav_menus'=&gt;false, &nbsp;</div></li><li><div>            'can_export'=&gt;false, &nbsp;</div></li><li><div>            'publicly_queryable'=&gt;true, &nbsp;</div></li><li><div>            'exclude_from_search'=&gt;true, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!get_option('wysija_post_type_updated')) {&nbsp;</div></li><li><div>            $modelPosts=new WYSIJA_model();&nbsp;</div></li><li><div>            $modelPosts-&gt;tableWP=true;&nbsp;</div></li><li><div>            $modelPosts-&gt;table_prefix='';&nbsp;</div></li><li><div>            $modelPosts-&gt;table_name='posts';&nbsp;</div></li><li><div>            $modelPosts-&gt;noCheck=true;&nbsp;</div></li><li><div>            $modelPosts-&gt;pk='ID';&nbsp;</div></li><li><div>            if($modelPosts-&gt;exists(array('post_type'=&gt;'wysijapage'))) {&nbsp;</div></li><li><div>                $modelPosts-&gt;update(array('post_type'=&gt;'wysijap'), array('post_type'=&gt;'wysijapage'));&nbsp;</div></li><li><div>                flush_rewrite_rules( false );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            WYSIJA::update_option('wysija_post_type_updated', time());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!get_option('wysija_post_type_created')) {&nbsp;</div></li><li><div>            flush_rewrite_rules( false );&nbsp;</div></li><li><div>            WYSIJA::update_option('wysija_post_type_created', time());&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * wysija update_option function is very similar to WordPress' one but it&nbsp;</div></li><li><div>     * can also manage new options not automatically loaded each time&nbsp;</div></li><li><div>     * @param type $option_name&nbsp;</div></li><li><div>     * @param type $newvalue&nbsp;</div></li><li><div>     * @param type $defaultload this parameter is the advantage other Wp's update_option here&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_option($option_name, $newvalue, $defaultload='no') {&nbsp;</div></li><li><div>        if ( get_option( $option_name ) != $newvalue ) {&nbsp;</div></li><li><div>            update_option( $option_name, $newvalue );&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            add_option( $option_name, $newvalue, '', $defaultload );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * When a WordPress user is added we also need to add it to the subscribers list&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function hook_add_WP_subscriber($user_id) {&nbsp;</div></li><li><div>        $data=get_userdata($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //check first if a subscribers exists if it doesn't then let's insert it&nbsp;</div></li><li><div>        $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $model_user=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $model_user-&gt;getFormat=ARRAY_A; // there is one case where we were getting an object instead of an array&nbsp;</div></li><li><div>        $subscriber_exists=$model_user-&gt;getOne(array('user_id'), array('email'=&gt;$data-&gt;user_email));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $first_name=$data-&gt;first_name;&nbsp;</div></li><li><div>        $last_name=$data-&gt;last_name;&nbsp;</div></li><li><div>        if(!$data-&gt;first_name && !$data-&gt;last_name) $first_name=$data-&gt;display_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_user-&gt;reset();&nbsp;</div></li><li><div>        if($subscriber_exists) {&nbsp;</div></li><li><div>            $user_id=$subscriber_exists['user_id'];&nbsp;</div></li><li><div>            // we need to update the current subscriber using it's id&nbsp;</div></li><li><div>            $model_user-&gt;update(array('wpuser_id'=&gt;$data-&gt;ID, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name), array('user_id'=&gt;$user_id));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $model_user-&gt;noCheck=true;&nbsp;</div></li><li><div>            $user_id=$model_user-&gt;insert(array('email'=&gt;$data-&gt;user_email, 'wpuser_id'=&gt;$data-&gt;ID, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name, 'status'=&gt;$model_config-&gt;getValue('confirm_dbleoptin')));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_user_list=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>        $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()), true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $helper_user-&gt;sendAutoNl($user_id, $data, 'new-user');&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * when a WordPress user is updated we also need to update the corresponding subscriber&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function hook_edit_WP_subscriber($user_id) {&nbsp;</div></li><li><div>        $data=get_userdata($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //check first if a subscribers exists if it doesn't then let's insert it&nbsp;</div></li><li><div>        $model_user=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $model_user_list=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>        $model_user-&gt;getFormat = ARRAY_A;&nbsp;</div></li><li><div>        $subscriber_exists=$model_user-&gt;getOne(array('user_id'), array('email'=&gt;$data-&gt;user_email));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_user-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $first_name=$data-&gt;first_name;&nbsp;</div></li><li><div>        $last_name=$data-&gt;last_name;&nbsp;</div></li><li><div>        if(!$data-&gt;first_name && !$data-&gt;last_name) $first_name=$data-&gt;display_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($subscriber_exists) {&nbsp;</div></li><li><div>            $user_id=$subscriber_exists['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_user-&gt;update(array('wpuser_id'=&gt;$data-&gt;ID, 'email'=&gt;$data-&gt;user_email, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name), array('user_id'=&gt;$user_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $result=$model_user_list-&gt;getOne(false, array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id')));&nbsp;</div></li><li><div>            $model_user_list-&gt;reset();&nbsp;</div></li><li><div>            if(!$result)&nbsp;</div></li><li><div>                $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            //chck that we didnt update the email&nbsp;</div></li><li><div>            $subscriber_exists=$model_user-&gt;getOne(false, array('wpuser_id'=&gt;$data-&gt;ID));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($subscriber_exists) {&nbsp;</div></li><li><div>                $user_id=$subscriber_exists['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $model_user-&gt;update(array('email'=&gt;$data-&gt;user_email, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name), array('wpuser_id'=&gt;$data-&gt;ID));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                $result=$model_user_list-&gt;getOne(false, array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id')));&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                if(!$result)&nbsp;</div></li><li><div>                    $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()));&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $model_user-&gt;noCheck=true;&nbsp;</div></li><li><div>                $user_id=$model_user-&gt;insert(array('email'=&gt;$data-&gt;user_email, 'wpuser_id'=&gt;$data-&gt;ID, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name, 'status'=&gt;$model_config-&gt;getValue('confirm_dbleoptin')));&nbsp;</div></li><li><div>                $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * when a wp user is deleted we also delete the subscriber corresponding to it&nbsp;</div></li><li><div>     * @param type $user_id&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function hook_del_WP_subscriber($user_id) {&nbsp;</div></li><li><div>        $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $model_user=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>        $data = $model_user-&gt;getOne(array('email', 'user_id'), array('wpuser_id'=&gt;$user_id));&nbsp;</div></li><li><div>        if(isset($data['email'])) {&nbsp;</div></li><li><div>            $model_user-&gt;delete(array('email'=&gt;$data['email']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(isset($data['user_id'])) {&nbsp;</div></li><li><div>            $model_user = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $model_user-&gt;delete(array('user_id'=&gt;$data['user_id'], 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id')));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public static function hook_auto_newsletter_refresh($post_id) {&nbsp;</div></li><li><div>        $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>        $helper_autonews-&gt;refresh_automatic_content();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * post notification transition hook, know when a post really gets published&nbsp;</div></li><li><div>     * @param type $new_status&nbsp;</div></li><li><div>     * @param type $old_status&nbsp;</div></li><li><div>     * @param type $post&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function hook_postNotification_transition($new_status, $old_status, $post) {&nbsp;</div></li><li><div>        //we run some process only if the status of the post changes from something to publish&nbsp;</div></li><li><div>        if($new_status === 'publish' && $old_status !== $new_status) {&nbsp;</div></li><li><div>            $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>            $emails = $model_email-&gt;get(false, array('type' =&gt; 2, 'status' =&gt; array(1, 3, 99)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(!empty($emails)) {&nbsp;</div></li><li><div>                //we loop through all of the automatic emails&nbsp;</div></li><li><div>                foreach($emails as $key =&gt; $email) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    //we will try to give birth to a child email only if the automatic newsletter is a post notification email and in immediate mode&nbsp;</div></li><li><div>                    if(is_array($email) && $email['params']['autonl']['event'] === 'new-articles' && $email['params']['autonl']['when-article'] === 'immediate') {&nbsp;</div></li><li><div>                        // set default include/exclude categories&nbsp;</div></li><li><div>                        $include_category_ids = array();&nbsp;</div></li><li><div>                        $exclude_category_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // ALC need to check for post_type on each block of the autoposts&nbsp;</div></li><li><div>                        $wj_data = maybe_unserialize( base64_decode( $email['wj_data'] ) );&nbsp;</div></li><li><div>                        $post_types = array();&nbsp;</div></li><li><div>                        $has_alc_blocks = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        foreach ( $wj_data['body'] as $block_key =&gt; $block ) {&nbsp;</div></li><li><div>                            if ( $block['type'] !== 'auto-post' ) {&nbsp;</div></li><li><div>                                continue;&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $has_alc_blocks = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            // get post type and post categories from block parameters&nbsp;</div></li><li><div>                            foreach( $block['params'] as $param_data ) {&nbsp;</div></li><li><div>                                if(in_array($param_data['key'], array('post_type', 'cpt'))  && strlen(trim($param_data['value'])) &gt; 0) {&nbsp;</div></li><li><div>                                    // store post type&nbsp;</div></li><li><div>                                    $post_types[] = trim($param_data['value']);&nbsp;</div></li><li><div>                                } else if($param_data['key'] === 'category_ids' && strlen(trim($param_data['value'])) &gt; 0) {&nbsp;</div></li><li><div>                                    // store post category ids&nbsp;</div></li><li><div>                                    $include_category_ids = array_map('intval', explode(', ', trim($param_data['value'])));&nbsp;</div></li><li><div>                                }&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if ( $has_alc_blocks === true && ! in_array( $post-&gt;post_type, $post_types ) ) {&nbsp;</div></li><li><div>                            continue;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // get post categories&nbsp;</div></li><li><div>                        $helper_wp_tools = WYSIJA::get('wp_tools', 'helper');&nbsp;</div></li><li><div>                        $taxonomies = $helper_wp_tools-&gt;get_post_category_ids($post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // assume the post has to be sent&nbsp;</div></li><li><div>                        $do_send_post = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        // post categories have to match at least one of the email's included categories&nbsp;</div></li><li><div>                        $include_intersection = array_intersect($taxonomies, $include_category_ids);&nbsp;</div></li><li><div>                        if(!empty($include_category_ids) && empty($include_intersection)) {&nbsp;</div></li><li><div>                            $do_send_post = false;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $exclude_intersection = array_intersect($taxonomies, $exclude_category_ids);&nbsp;</div></li><li><div>                        // post categories should not match any one of the email's excluded categories&nbsp;</div></li><li><div>                        if(!empty($exclude_category_ids) && !empty($exclude_intersection)) {&nbsp;</div></li><li><div>                            $do_send_post = false;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if($do_send_post) {&nbsp;</div></li><li><div>                            WYSIJA::log('post_transition_hook_give_birth', array(&nbsp;</div></li><li><div>                                'post_id' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div>                                'post_title' =&gt; $post-&gt;post_title, &nbsp;</div></li><li><div>                                'newsletter' =&gt; $email, &nbsp;</div></li><li><div>                                'old_status' =&gt; $old_status, &nbsp;</div></li><li><div>                                'new_status' =&gt; $new_status&nbsp;</div></li><li><div> ), 'post_notif');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                            $model_email-&gt;reset();&nbsp;</div></li><li><div>                            $model_email-&gt;give_birth($email, $post-&gt;ID);&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // we check for automatic latest content widget in automatic newsletter&nbsp;</div></li><li><div>            $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>            $helper_autonews-&gt;refresh_automatic_content();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * uninstall process not used&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function uninstall() {&nbsp;</div></li><li><div>        $helperUS=WYSIJA::get('uninstall', 'helper');&nbsp;</div></li><li><div>        $helperUS-&gt;uninstall();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this function is run when wysija gets activated&nbsp;</div></li><li><div>     * there is no installation process here, all is about checking the global status of the app&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function activate() {&nbsp;</div></li><li><div>        $encoded_option=get_option('wysija');&nbsp;</div></li><li><div>        $installApp=false;&nbsp;</div></li><li><div>        if($encoded_option) {&nbsp;</div></li><li><div>            $values=unserialize(base64_decode($encoded_option));&nbsp;</div></li><li><div>            if(isset($values['installed'])) $installApp=true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //test again for plugins on reactivation&nbsp;</div></li><li><div>        if($installApp) {&nbsp;</div></li><li><div>            $helper_import=WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>            $helper_import-&gt;testPlugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //resynch wordpress list&nbsp;</div></li><li><div>            $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>            $helper_user-&gt;synchList($values['importwp_list_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * the is_plugin_active functions from WordPress sometimes are not loaded so here is one that works for single and multisites anywhere in the code&nbsp;</div></li><li><div>     * @param type $pluginName&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_plugin_active($pluginName) {&nbsp;</div></li><li><div>        $arrayactiveplugins=get_option('active_plugins');&nbsp;</div></li><li><div>        //we check in the list of the site options if the plugin is activated&nbsp;</div></li><li><div>        if(in_array($pluginName, $arrayactiveplugins)) {&nbsp;</div></li><li><div>            //plugin is activated for that site&nbsp;</div></li><li><div>            return true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if this is a multisite it might not be activated in the site option but network activated though&nbsp;</div></li><li><div>        if(is_multisite()) {&nbsp;</div></li><li><div>            $plugins = get_site_option('active_sitewide_plugins');&nbsp;</div></li><li><div>            //plugin is activated for that multisite&nbsp;</div></li><li><div>            if(isset($plugins[$pluginName])) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * make sure that the current user has the good access rights corresponding to its role&nbsp;</div></li><li><div>     * @global type $current_user&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function update_user_caps() {&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(empty($current_user) && function_exists('wp_get_current_user')) wp_get_current_user();&nbsp;</div></li><li><div>        if(empty($current_user)) return false;&nbsp;</div></li><li><div>        $current_user-&gt;get_role_caps();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>     /**&nbsp;</div></li><li><div>     * test whether the plugin is a beta version or not&nbsp;</div></li><li><div>     * 2.4.4.4  is a beta&nbsp;</div></li><li><div>     * 2.4.4 is a bug fix release&nbsp;</div></li><li><div>     * 2.4 is a feature release&nbsp;</div></li><li><div>     * @param string $plugin_name&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function is_beta($plugin_name=false) {&nbsp;</div></li><li><div>        // exceptions&nbsp;</div></li><li><div>        $not_beta_versions = array('2.5.9.1', '2.5.9.2', '2.5.9.3', &quot;2.5.9.4&quot;);&nbsp;</div></li><li><div>        $mailpoet_version = WYSIJA::get_version($plugin_name);&nbsp;</div></li><li><div>        if(in_array($mailpoet_version, $not_beta_versions)) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // standard way of defining a beta version&nbsp;</div></li><li><div>        if(count(explode('.', $mailpoet_version)) &gt; 3 ) return true;&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * depending where it's used the base function from WordPress doesn't work, so this one will work anywhere&nbsp;</div></li><li><div>     * @param type $capability&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function current_user_can($capability) {&nbsp;</div></li><li><div>        if(!$capability) return false;&nbsp;</div></li><li><div>        WYSIJA::update_user_caps();&nbsp;</div></li><li><div>        if(!current_user_can($capability)) return false;&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * this function get and sets the cron schedules when MailPoet's own cron system is active&nbsp;</div></li><li><div>     * @staticvar type $cron_schedules&nbsp;</div></li><li><div>     * @param type $schedule&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_cron_schedule($schedule='queue') {&nbsp;</div></li><li><div>        static $cron_schedules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if the cron schedules are already loaded statically then we just have to return the right schedule value&nbsp;</div></li><li><div>        if(!empty($cron_schedules)) {&nbsp;</div></li><li><div>            if($schedule=='all') return $cron_schedules;&nbsp;</div></li><li><div>            if(isset($cron_schedules[$schedule])) {&nbsp;</div></li><li><div>                return $cron_schedules[$schedule];&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                WYSIJA::set_cron_schedule($schedule);&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            //this is the first time this function is executed so let's get them from the db and store them statically&nbsp;</div></li><li><div>            $cron_schedules=get_option('wysija_schedules', array());&nbsp;</div></li><li><div>            if(!empty($cron_schedules)) {&nbsp;</div></li><li><div>                if(isset($cron_schedules[$schedule]))   return $cron_schedules[$schedule];&nbsp;</div></li><li><div>                else    return false;&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                WYSIJA::set_cron_schedule();&nbsp;</div></li><li><div>                return false;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * return the frequency for each cron task needed by MailPoet&nbsp;</div></li><li><div>     * @return type an array of frequencies&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function get_cron_frequencies() {&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $helper_forms = WYSIJA::get('forms', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(is_multisite() && $model_config-&gt;getValue('sending_method')=='network') {&nbsp;</div></li><li><div>           $sending_emails_each = $model_config-&gt;getValue('ms_sending_emails_each');&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>           $sending_emails_each = $model_config-&gt;getValue('sending_emails_each');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $queue_frequency = $helper_forms-&gt;eachValuesSec[$sending_emails_each];&nbsp;</div></li><li><div>        $bounce_frequency = 99999999999999;&nbsp;</div></li><li><div>        if(isset($helper_forms-&gt;eachValuesSec[$model_config-&gt;getValue('bouncing_emails_each')])) {&nbsp;</div></li><li><div>            $bounce_frequency = $helper_forms-&gt;eachValuesSec[$model_config-&gt;getValue('bouncing_emails_each')];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return array('queue'=&gt;$queue_frequency, 'bounce'=&gt;$bounce_frequency, 'daily'=&gt;86400, 'weekly'=&gt;604800, 'monthly'=&gt;2419200);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * set the next cron schedule&nbsp;</div></li><li><div>     * TODO : needs probably to make the difference of running process for the next schedule, so that there is no delay(this is only problematic on some slow servers)&nbsp;</div></li><li><div>     * @param string $schedule&nbsp;</div></li><li><div>     * @param int $last_saved&nbsp;</div></li><li><div>     * @param boolean $set_running&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function set_cron_schedule($schedule = false , $last_saved = 0 , $set_running = false) {&nbsp;</div></li><li><div>        $cron_schedules = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $start_time = $last_saved;&nbsp;</div></li><li><div>        if(!$start_time)    $start_time = time();&nbsp;</div></li><li><div>        $processes = WYSIJA::get_cron_frequencies();&nbsp;</div></li><li><div>        if(!$schedule) {&nbsp;</div></li><li><div>            foreach($processes as $process =&gt; $frequency) {&nbsp;</div></li><li><div>                $next_schedule = $start_time + $frequency;&nbsp;</div></li><li><div>                $prev_schedule = 0;&nbsp;</div></li><li><div>                if(isset($cron_schedules[$process]['running']) && $cron_schedules[$process]['running']) $prev_schedule=$cron_schedules[$process]['running'];&nbsp;</div></li><li><div>                $cron_schedules[$process]=array(&nbsp;</div></li><li><div>                    'next_schedule' =&gt; $next_schedule, &nbsp;</div></li><li><div>                    'prev_schedule' =&gt; $prev_schedule, &nbsp;</div></li><li><div>                    'running' =&gt; false);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $cron_schedules = WYSIJA::get_cron_schedule('all');&nbsp;</div></li><li><div>            if($set_running) {&nbsp;</div></li><li><div>                 $cron_schedules[$schedule]['running'] = $set_running;&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                 $running = 0;&nbsp;</div></li><li><div>                if(isset($cron_schedules[$schedule]['running'])) $running = $cron_schedules[$schedule]['running'];&nbsp;</div></li><li><div>                // if the process is not running or has been running for more than 15 minutes then we set the next_schedule date&nbsp;</div></li><li><div>                $process_frequency = $processes[$schedule];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                if(!$running || ( time() &gt; ($running + $process_frequency) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $next_schedule = $start_time + $process_frequency;&nbsp;</div></li><li><div>                    // if the next schedule is already behind, we give it 30 seconds before it can triggers again&nbsp;</div></li><li><div>                    if( $next_schedule &lt; $start_time ) {&nbsp;</div></li><li><div>                        $next_schedule = $start_time + 30;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                    $cron_schedules[$schedule] = array(&nbsp;</div></li><li><div>                            'next_schedule' =&gt; $next_schedule, &nbsp;</div></li><li><div>                            'prev_schedule' =&gt; $running, &nbsp;</div></li><li><div>                            'running' =&gt; false);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        WYSIJA::update_option( 'wysija_schedules' , $cron_schedules , 'yes' );&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * check that there is no passed schedules that need to be executed now&nbsp;</div></li><li><div>     * @return void&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function cron_check() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $cron_schedules = WYSIJA::get_cron_schedule('all');&nbsp;</div></li><li><div>        if(empty($cron_schedules)) return;&nbsp;</div></li><li><div>        else{&nbsp;</div></li><li><div>            $processes = WYSIJA::get_cron_frequencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $updated_sched = false;&nbsp;</div></li><li><div>            foreach($cron_schedules as $schedule =&gt; &$params) {&nbsp;</div></li><li><div>                    $running = 0;&nbsp;</div></li><li><div>                    $time_now = time();&nbsp;</div></li><li><div>                    if(isset($params['running'])) $running = $params['running'];&nbsp;</div></li><li><div>                    //if the process has timedout we reschedule the next execution&nbsp;</div></li><li><div>                    if($running && ( $time_now&gt; ($running + $processes[$schedule]) ) ) {&nbsp;</div></li><li><div>                        //WYSIJA::setInfo('error', 'modifying next schedule for '.$proc);&nbsp;</div></li><li><div>                        $process_frequency = $processes[$schedule];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        $next_schedule = $running + $process_frequency;&nbsp;</div></li><li><div>                        // if the next schedule is already behind, we give it 30 seconds before it can trigger again&nbsp;</div></li><li><div>                        if( $next_schedule &lt; $time_now ) {&nbsp;</div></li><li><div>                            $next_schedule = $time_now + 30;&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                        $params=array(&nbsp;</div></li><li><div>                                'next_schedule' =&gt; $next_schedule, &nbsp;</div></li><li><div>                                'prev_schedule' =&gt; $running, &nbsp;</div></li><li><div>                                'running' =&gt; false);&nbsp;</div></li><li><div>                        $updated_sched=true;&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            if($updated_sched) {&nbsp;</div></li><li><div>                //WYSIJA::setInfo('error', 'updating scheds');&nbsp;</div></li><li><div>                WYSIJA::update_option( 'wysija_schedules' , $cron_schedules , 'yes' );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $time_now = time();&nbsp;</div></li><li><div>        $processesToRun = array();&nbsp;</div></li><li><div>        foreach($cron_schedules as $schedule =&gt; $scheduled_times) {&nbsp;</div></li><li><div>            if(strpos($schedule, '(bounce handling not activated)')!==false) continue;&nbsp;</div></li><li><div>                        if( !isset($processes[$schedule]) ) continue;&nbsp;</div></li><li><div>            $process_frequency = $processes[$schedule];&nbsp;</div></li><li><div>            if( ( !$scheduled_times['running'] || (int)$scheduled_times['running'] + $process_frequency &lt; $time_now ) && $scheduled_times['next_schedule'] &lt; $time_now) {&nbsp;</div></li><li><div>                $processesToRun[] = $schedule;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $page_view_trigger = (int)$model_config-&gt;getValue('cron_page_hit_trigger');&nbsp;</div></li><li><div>        if(!empty($processesToRun) && $page_view_trigger === 1) {&nbsp;</div></li><li><div>            //call the cron url&nbsp;</div></li><li><div>            // do not call that more than once per 5 minutes attempt at reducing the CPU load for some users&nbsp;</div></li><li><div>            // http://wordpress.org/support/topic/wysija-newsletters-slowing-down-my-site-1&nbsp;</div></li><li><div>            $last_cron_time_plus_5min = (int)get_option('wysija_last_php_cron_call') + (5*60);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($last_cron_time_plus_5min &lt; time()) {&nbsp;</div></li><li><div>                $cron_url = site_url( 'wp-cron.php').'?'.WYSIJA_CRON.'&action=wysija_cron&process='.implode(', ', $processesToRun).'&silent=1';&nbsp;</div></li><li><div>                $cron_request = apply_filters( 'cron_request', array(&nbsp;</div></li><li><div>                        'url' =&gt; $cron_url, &nbsp;</div></li><li><div>                        'args' =&gt; array( 'timeout' =&gt; 0.01, 'blocking' =&gt; false, 'sslverify' =&gt; apply_filters( 'https_local_ssl_verify', true ) )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                wp_remote_post( $cron_url, $cron_request['args'] );&nbsp;</div></li><li><div>                WYSIJA::update_option('wysija_last_php_cron_call', time());&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Function somehow necessary to avoid some conflicts in windows server and WordPress autoload of plugins language file&nbsp;</div></li><li><div>     * @param type $boolean&nbsp;</div></li><li><div>     * @param type $domain&nbsp;</div></li><li><div>     * @param type $mofile&nbsp;</div></li><li><div>     * @return boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function override_load_textdomain($boolean, $domain, $mofile) {&nbsp;</div></li><li><div>            $extensionloaded=WYSIJA::load_lang('get_all');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if(isset($extensionloaded[$domain]) && !@file_exists($mofile)) {&nbsp;</div></li><li><div>                return true;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * function to rewrite the path of the file if the file doesn't exist&nbsp;</div></li><li><div>     * @param type $mofile&nbsp;</div></li><li><div>     * @param type $domain&nbsp;</div></li><li><div>     * @return type&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    public static function load_textdomain_mofile($mofile, $domain) {&nbsp;</div></li><li><div>        $extensionloaded=WYSIJA::load_lang('get_all');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($extensionloaded[$domain]) && !file_exists($mofile)) {&nbsp;</div></li><li><div>            return WYSIJA_PLG_DIR.$domain.DS.'languages'.DS.$extensionloaded[$domain].'-'.get_locale().'.mo';&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $mofile;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.4</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/classes/wysija/" class="active">2.7.9</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.8/classes/wysija/" class="">2.7.8</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/classes/wysija/" class="">2.7.6</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/wysija/" class="">2.7.5</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.4/classes/wysija/" class="">2.7.4</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WYSIJA</li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>