<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr file lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr file lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr file lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr file ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr file gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr file" data-site="plugin" data-version="2.7.9" data-slug="mailpoet-newsletters" data-type="file" data-id="55526"><head xmlns="http://www.w3.org/1999/xhtml"><title> core-base | file | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="file, plugin, mailpoet-newsletters, 2.7.9" /><meta name="description" content="The WordPress Hook/API Index" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.10"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=2917822f00af23868a07c33129103843' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.10' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/files/core-base/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcore-base%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Ffiles%2Fcore-base%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.9-file-core-base","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="core-base" class="single single-file"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.9." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/" class="H_VERSION"><span property="name">2.7.9</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to files." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/files/" class=""><span property="name">files</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">core-base</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="file"><ul role="navigation"><li class="" data-id="all" data-count="298"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/all/" title="All">All <span class="count badge">298</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/hooks/" title="Hooks">Hooks <span class="count badge">104</span></a></li><li class="" data-id="action" data-count="30"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/actions/" title="Actions">Actions <span class="count badge">30</span></a></li><li class="" data-id="filter" data-count="74"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/filters/" title="Filters">Filters <span class="count badge">74</span></a></li><li class="" data-id="class" data-count="131"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/classes/" title="Classes">Classes <span class="count badge">131</span></a></li><li class="" data-id="constant" data-count="52"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/constants/" title="Constants">Constants <span class="count badge">52</span></a></li><li class="" data-id="function" data-count="8"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/functions/" title="Functions">Functions <span class="count badge">8</span></a></li><li class="" data-id="shortcode" data-count="3"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">3</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article> <section><h1>/core/base.php</h1><p><pre><ol  class="block" start="1"><li><div>&lt;?php&nbsp;</div></li><li><div><span class="comment">// Require constants.</span>&nbsp;</div></li><li><div>require_once( dirname( __FILE__ ) . DIRECTORY_SEPARATOR . 'constants.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Require global classes autoloader</span>&nbsp;</div></li><li><div>require_once( dirname( __FILE__ ) . DIRECTORY_SEPARATOR . 'autoloader.php' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>defined( 'WYSIJA' ) or die( 'Restricted access' );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>global $wysija_msg, $wysija_wpmsg;&nbsp;</div></li><li><div>if ( ! $wysija_msg ) {&nbsp;</div></li><li><div>  $wysija_msg = array();&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>$wysija_wpmsg = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WYSIJA_object{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Static variable holding core MailPoet's version</span>&nbsp;</div></li><li><div><span class="comment">   * @var array</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static $version = '2.7.9';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Order an array by param name string compare</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $a  Array with the param to compare</span>&nbsp;</div></li><li><div><span class="comment">   * @param  array $b  Array with the param to compare</span>&nbsp;</div></li><li><div><span class="comment">   * @return int    Sorting result from strcmp</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function sort_by_name( $a, $b ) {&nbsp;</div></li><li><div>      return strcmp( strtolower( $a['name'] ), strtolower( $b['name'] ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Returns the version of based on a path</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @filter mailpoet/get_version</span>&nbsp;</div></li><li><div><span class="comment">   * @filter mailpoet/package</span>&nbsp;</div></li><li><div><span class="comment">   *</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $path</span>&nbsp;</div></li><li><div><span class="comment">   * @return string Version of the package</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_version( $path = null ) {&nbsp;</div></li><li><div>      $version = self::$version;&nbsp;</div></li><li><div>      <span class="comment">// Backwards compatibility for Premium Versions</span>&nbsp;</div></li><li><div>      if ( ! has_filter( 'mailpoet/get_version', '_filter_mailpoet_premium_version' ) && in_array( $path, array( 'premium', 'wysija-newsletters-premium', 'wysija-newsletters-premium/index.php' ) ) ) {&nbsp;</div></li><li><div>          if ( ! function_exists( 'get_plugin_data' ) ) {&nbsp;</div></li><li><div>              include_once ABSPATH . 'wp-admin/includes/plugin.php';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $plugin_data = get_plugin_data( dirname( dirname( plugin_dir_path( __FILE__ ) ) ) . '/wysija-newsletters-premium/index.php' );&nbsp;</div></li><li><div>          $version = trim( $plugin_data['Version'] );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return apply_filters( 'mailpoet/get_version', $version, apply_filters( 'mailpoet/package', 'core', $path ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * get the current_user data in a safe manner making sure a field exists before returning it's value</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $current_user</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $field</span>&nbsp;</div></li><li><div><span class="comment">   * @return mixed</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function wp_get_userdata( $field = false ) {&nbsp;</div></li><li><div>      <span class="comment">//WordPress globals be careful there</span>&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>      if ( $field ) {&nbsp;</div></li><li><div>          if ( function_exists( 'wp_get_current_user' ) ) {&nbsp;</div></li><li><div>              <span class="comment">// Here is an exception because of one of the weirdest bug</span>&nbsp;</div></li><li><div>              <span class="comment">// the idea is to make sure we don't call wp_get_current_user() on the wysija_subscribers page when on a multisite</span>&nbsp;</div></li><li><div>              if ( ! ( isset( $_GET['page'] ) && $_GET['page'] === 'wysija_subscribers' && is_multisite() ) ) {&nbsp;</div></li><li><div>                  wp_get_current_user();&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if ( isset( $current_user-&gt;{$field} ) ) {&nbsp;</div></li><li><div>              return $current_user-&gt;{$field};&nbsp;</div></li><li><div>          } elseif ( isset( $current_user-&gt;data-&gt;{$field} ) ) {&nbsp;</div></li><li><div>              return $current_user-&gt;data-&gt;{$field};&nbsp;</div></li><li><div>          } else {&nbsp;</div></li><li><div>              return $current_user;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $current_user;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * set a global notice message</span>&nbsp;</div></li><li><div><span class="comment">   * @global array $wysija_wpmsg</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $msg</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function wp_notice( $msg ) {&nbsp;</div></li><li><div>      global $wysija_wpmsg;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//add the hook only once</span></span>&nbsp;</div></li><li><div>      if ( ! $wysija_wpmsg ) {&nbsp;</div></li><li><div>          add_action( 'admin_notices', array( $this, 'wp_msgs' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//record msgs</span></span>&nbsp;</div></li><li><div>      $wysija_wpmsg['updated'][] = $msg;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * set a global error message</span>&nbsp;</div></li><li><div><span class="comment">   * @global array $wysija_wpmsg</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $msg</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function wp_error( $msg ) {&nbsp;</div></li><li><div>      global $wysija_wpmsg;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//add the hook only once</span></span>&nbsp;</div></li><li><div>      if ( ! $wysija_wpmsg ) {&nbsp;</div></li><li><div>          add_action( 'admin_notices', array( $this, 'wp_msgs' ) );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//record msgs</span></span>&nbsp;</div></li><li><div>      $wysija_wpmsg['error'][] = $msg;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * prints a global message in the WordPress' backend identified as belonging to wysija</span>&nbsp;</div></li><li><div><span class="comment">   * we tend to avoid as much as possible printing messages globally, since this is ugly</span>&nbsp;</div></li><li><div><span class="comment">   * and make the administrators immune to beige-yellowish messages :/</span>&nbsp;</div></li><li><div><span class="comment">   * @global array $wysija_wpmsg</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function wp_msgs() {&nbsp;</div></li><li><div>      global $wysija_wpmsg;&nbsp;</div></li><li><div>      foreach ( $wysija_wpmsg as $keymsg =&gt; $wp2 ) {&nbsp;</div></li><li><div>          $msgs = '&lt;div class=&quot;' . $keymsg . ' fade&quot;&gt;';&nbsp;</div></li><li><div>          foreach ( $wp2 as $mymsg ) {&nbsp;</div></li><li><div>              $msgs .= '&lt;p&gt;&lt;strong&gt;MailPoet&lt;/strong&gt; : ' . $mymsg . '&lt;/p&gt;';&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          $msgs .= '&lt;/div&gt;';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// This is bad, we should be checking for valid HTML here.</span>&nbsp;</div></li><li><div>      echo $msgs;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * returns an error message, it will appear as a red pinkish message in our interfaces</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $msg</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $public if set to true it will appear as a full message, otherwise it will appear behind a &quot;Show more details.&quot; link</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $global if set to true it will appear on all of the backend interfaces, not only wysija's own</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function error( $msg, $public = false, $global = false ) {&nbsp;</div></li><li><div>      $status = 'error';&nbsp;</div></li><li><div>      if ( $global ) {&nbsp;</div></li><li><div>          $status = 'g-' . $status;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;setInfo( $status, $msg, $public );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * returns a success message, it will appear as a beige yellowish message in our interfaces</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $msg</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $public if set to true it will appear as a full message, otherwise it will appear behind a &quot;Show more details.&quot; link</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $global if set to true it will appear on all of the backend interfaces, not only wysija's own</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function notice( $msg, $public = true, $global = false ) {&nbsp;</div></li><li><div>      $status = 'updated';&nbsp;</div></li><li><div>      if ( $global ) {&nbsp;</div></li><li><div>          $status = 'g-' . $status;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      $this-&gt;setInfo( $status, $msg, $public );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * store all of the error and success messages in a global variable</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $wysija_msg</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $status whether this is a success message or an error message</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $msg</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $public if set to true it will appear as a full message, otherwise it will appear behind a &quot;Show more details.&quot; link</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  static function setInfo($status, $msg, $public=false) {&nbsp;</div></li><li><div>      global $wysija_msg;&nbsp;</div></li><li><div>      if(!$public) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!isset($wysija_msg['private'][$status])) {&nbsp;</div></li><li><div>              $wysija_msg['private']=array();&nbsp;</div></li><li><div>              $wysija_msg['private'][$status]=array();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          array_push($wysija_msg['private'][$status], $msg);&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          if(!isset($wysija_msg[$status]))  $wysija_msg[$status]=array();&nbsp;</div></li><li><div>          array_push($wysija_msg[$status], $msg);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * read the global function containing all of the error messages and print them</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $wysija_msg</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function getMsgs() {&nbsp;</div></li><li><div>      global $wysija_msg;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($wysija_msg['private']['error'])) {&nbsp;</div></li><li><div>          $wysija_msg['error'][]=str_replace(array('[link]', '[/link]'), array('&lt;a class=&quot;showerrors&quot; href=&quot;javascript:;&quot;&gt;', '&lt;/a&gt;'), __('An error occurred. [link]Show more details.[/link]', WYSIJA));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($wysija_msg['private']['updated'])) {&nbsp;</div></li><li><div>          $wysija_msg['updated'][]=str_replace(array('[link]', '[/link]'), array('&lt;a class=&quot;shownotices&quot; href=&quot;javascript:;&quot;&gt;', '&lt;/a&gt;'), __('[link]Show more details.[/link]', WYSIJA));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(isset($wysija_msg['private'])) {&nbsp;</div></li><li><div>          $prv=$wysija_msg['private'];&nbsp;</div></li><li><div>          unset($wysija_msg['private']);&nbsp;</div></li><li><div>          if(isset($prv['error']))    $wysija_msg['xdetailed-errors']=$prv['error'];&nbsp;</div></li><li><div>          if(isset($prv['updated']))    $wysija_msg['xdetailed-updated']=$prv['updated'];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $wysija_msg;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * If the current server is Windows-based</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_windows() {&nbsp;</div></li><li><div>      $is_windows = false;&nbsp;</div></li><li><div>      $windows = array(&nbsp;</div></li><li><div>          'windows nt', &nbsp;</div></li><li><div>          'windows', &nbsp;</div></li><li><div>          'winnt', &nbsp;</div></li><li><div>          'win32', &nbsp;</div></li><li><div>          'win'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>      $operating_system = strtolower( php_uname( 's' ) );&nbsp;</div></li><li><div>      foreach ( $windows as $windows_name ) {&nbsp;</div></li><li><div>          if (strpos($operating_system, $windows_name) !== false) {&nbsp;</div></li><li><div>              $is_windows = true;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $is_windows;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WYSIJA_help extends WYSIJA_object{&nbsp;</div></li><li><div>  var $controller = null;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  static $admin_body_class_runner = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>      add_action( 'widgets_init', array( $this, 'widgets_init' ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">// Only load this when ajax is not used</span></span>&nbsp;</div></li><li><div>      if ( !( defined( 'DOING_AJAX' ) && DOING_AJAX ) ) {&nbsp;</div></li><li><div>                      add_action( 'init', array( $this, 'register_scripts' ), 1 );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      add_action( 'admin_enqueue_scripts', array( $this, 'admin_enqueue_scripts' ) );&nbsp;</div></li><li><div>      add_filter( 'admin_body_class', array( $this, 'admin_body_class' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function WYSIJA_help() { <span class="comment">// TODO: remove in next version</span>&nbsp;</div></li><li><div>    add_action( 'widgets_init', array( $this, 'widgets_init' ), 1 );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    <span class="comment"><span class="comment">// Only load this when ajax is not used</span></span>&nbsp;</div></li><li><div>    if ( !( defined( 'DOING_AJAX' ) && DOING_AJAX ) ) {&nbsp;</div></li><li><div>      add_action( 'init', array( $this, 'register_scripts' ), 1 );&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    add_action( 'admin_enqueue_scripts', array( $this, 'admin_enqueue_scripts' ) );&nbsp;</div></li><li><div>    add_filter( 'admin_body_class', array( $this, 'admin_body_class' ) );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function widgets_init() {&nbsp;</div></li><li><div>      <span class="comment">//load the widget file</span>&nbsp;</div></li><li><div>      require_once(WYSIJA_WIDGETS.'wysija_nl.php');&nbsp;</div></li><li><div>      register_widget( 'WYSIJA_NL_Widget' );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function admin_enqueue_scripts() {&nbsp;</div></li><li><div>      if ( WYSIJA_ITF ) {&nbsp;</div></li><li><div>          wp_enqueue_script( 'mailpoet-global' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public function admin_body_class( $body_class_str ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( WYSIJA_help::$admin_body_class_runner === true ) {&nbsp;</div></li><li><div>          return $body_class_str;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      WYSIJA_help::$admin_body_class_runner = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      global $wp_version;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $class = array();&nbsp;</div></li><li><div>      if ( ! empty( $body_class_str ) ) {&nbsp;</div></li><li><div>          $class = explode( ' ', $body_class_str );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( '3.8' === $wp_version ) {&nbsp;</div></li><li><div>          $class[] = 'mp-menu-icon-font';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( version_compare( $wp_version, '3.8', '&lt;' ) ) {&nbsp;</div></li><li><div>          $class[] = 'mp-menu-icon-bg';&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $class[] = 'mpoet-ui';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return implode( ' ', $class );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function register_scripts() {&nbsp;</div></li><li><div>      $helper_toolbox = WYSIJA::get('toolbox', 'helper');&nbsp;</div></li><li><div>      $wp_language_code = $helper_toolbox-&gt;get_language_code();&nbsp;</div></li><li><div>      $valid_language = array(&nbsp;</div></li><li><div>          'ar', &nbsp;</div></li><li><div>          'ca', &nbsp;</div></li><li><div>          'cs', &nbsp;</div></li><li><div>          'cz', &nbsp;</div></li><li><div>          'da', &nbsp;</div></li><li><div>          'de', &nbsp;</div></li><li><div>          'el', &nbsp;</div></li><li><div>          'es', &nbsp;</div></li><li><div>          'et', &nbsp;</div></li><li><div>          'fa', &nbsp;</div></li><li><div>          'fi', &nbsp;</div></li><li><div>          'fr', &nbsp;</div></li><li><div>          'he', &nbsp;</div></li><li><div>          'hr', &nbsp;</div></li><li><div>          'hu', &nbsp;</div></li><li><div>          'id', &nbsp;</div></li><li><div>          'it', &nbsp;</div></li><li><div>          'ja', &nbsp;</div></li><li><div>          'lt', &nbsp;</div></li><li><div>          'nl', &nbsp;</div></li><li><div>          'no', &nbsp;</div></li><li><div>          'pl', &nbsp;</div></li><li><div>          'pt', &nbsp;</div></li><li><div>          'pt_BR', &nbsp;</div></li><li><div>          'ro', &nbsp;</div></li><li><div>          'ru', &nbsp;</div></li><li><div>          'sv', &nbsp;</div></li><li><div>          'tr', &nbsp;</div></li><li><div>          'uk', &nbsp;</div></li><li><div>          'vi', &nbsp;</div></li><li><div>          'zh_CN', &nbsp;</div></li><li><div>          'zh_TW', &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if ( in_array( $wp_language_code, $valid_language ) ) {&nbsp;</div></li><li><div>          wp_register_script('wysija-validator-lang', WYSIJA_URL.'js/validate/languages/jquery.validationEngine-'.$wp_language_code.'.js', array( 'jquery' ), WYSIJA::get_version(), true );&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          wp_register_script('wysija-validator-lang', WYSIJA_URL.'js/validate/languages/jquery.validationEngine-en.js', array( 'jquery' ), WYSIJA::get_version(), true );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      wp_register_script('wysija-validator', WYSIJA_URL.'js/validate/jquery.validationEngine.js', array( 'jquery' ), WYSIJA::get_version(), true );&nbsp;</div></li><li><div>      wp_register_script('wysija-front-subscribers', WYSIJA_URL.'js/front-subscribers.js', array( 'jquery' ), WYSIJA::get_version(), true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      wp_register_script('wysija-form', WYSIJA_URL.'js/forms.js', array( 'jquery' ), WYSIJA::get_version());&nbsp;</div></li><li><div>      wp_register_style('validate-engine-css', WYSIJA_URL.'css/validationEngine.jquery.css', array(), WYSIJA::get_version());&nbsp;</div></li><li><div>      wp_register_script('wysija-admin-ajax', WYSIJA_URL.'js/admin-ajax.js', array(), WYSIJA::get_version());&nbsp;</div></li><li><div>      wp_register_script('wysija-admin-ajax-proto', WYSIJA_URL.'js/admin-ajax-proto.js', array(), WYSIJA::get_version());&nbsp;</div></li><li><div>      wp_register_script( 'mailpoet-global', WYSIJA_URL.'js/admin-global.js', array( 'jquery', 'underscore' ), WYSIJA::get_version() );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(defined('WYSIJA_SIDE') && WYSIJA_SIDE=='front')  wp_enqueue_style('validate-engine-css');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * All the ajax requests are routed through here</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  function ajax() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $result_array = array();&nbsp;</div></li><li><div>      if( !$_REQUEST || !isset( $_REQUEST['controller'] ) || !isset( $_REQUEST['task'] ) ) {&nbsp;</div></li><li><div>          $result_array = array( 'result' =&gt; false );&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $plugin_requesting_ajax = 'wysija-newsletters';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// we override the plugin resquesting ajax if specified in the request</span>&nbsp;</div></li><li><div>          if( !empty( $_REQUEST['wysijaplugin'] ) ) {&nbsp;</div></li><li><div>                          $plugin_requesting_ajax = preg_replace('#[^a-z0-9\-_]#i', '', $_REQUEST['wysijaplugin']);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// fetching the right controller</span>&nbsp;</div></li><li><div>          $this-&gt;controller = WYSIJA::get( $_REQUEST['controller'] , 'controller' , false, $plugin_requesting_ajax );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// let's make sure the requested task exist</span>&nbsp;</div></li><li><div>          if( method_exists( $this-&gt;controller , $_REQUEST['task'] ) ) {&nbsp;</div></li><li><div>              $result_array['result'] = call_user_func(array($this-&gt;controller, $_REQUEST['task']));&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $this-&gt;error( 'Method &quot;' . esc_html($_REQUEST['task']) . '&quot; doesn\'t exist for controller : &quot;'.esc_html($_REQUEST['controller']) );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// get the appended messages triggerred during the task execution</span>&nbsp;</div></li><li><div>      $result_array['msgs'] = $this-&gt;getMsgs();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// this header will allow ajax request from the home domain, this can be a lifesaver when domain mapping is on</span>&nbsp;</div></li><li><div>      if(function_exists('home_url')) {&nbsp;</div></li><li><div>                  header('Access-Control-Allow-Origin: '.home_url());&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// let's encode our response in the json format</span>&nbsp;</div></li><li><div>              $json_data = json_encode($result_array);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// in some case scenarios our client will have jQuery forcing the jsonp so we need to adapt ourselves</span>&nbsp;</div></li><li><div>      if(isset($_REQUEST['callback'])) {&nbsp;</div></li><li><div>                  <span class="comment">// special header for json-p</span>&nbsp;</div></li><li><div>                  header('Content-type: application/javascript');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $helper_jsonp = WYSIJA::get('jsonp', 'helper');&nbsp;</div></li><li><div>                  if($helper_jsonp-&gt;isValidCallback($_REQUEST['callback'])) {&nbsp;</div></li><li><div>                          print $_REQUEST['callback'] . '('.$json_data.');';&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>                  <span class="comment">// standard header for unwrapped classic json response</span>&nbsp;</div></li><li><div>                  header('Content-type: application/json');&nbsp;</div></li><li><div>                  print $json_data;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>              <span class="comment">// our ajax response is printed, no need to let WordPress or 3rd party plugin execute more code</span>&nbsp;</div></li><li><div>      die();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>class WYSIJA extends WYSIJA_object{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  function __construct() {&nbsp;</div></li><li><div>    parent::__construct();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * function created at the beginning to handle particular cases with WP get_permalink it got much smaller recently</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $pageid</span>&nbsp;</div></li><li><div><span class="comment">   * @param array $params</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $simple</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_permalink( $pageid, $params = array(), $simple = false ) {&nbsp;</div></li><li><div>      $hWPtools = WYSIJA::get( 'wp_tools', 'helper' );&nbsp;</div></li><li><div>      return $hWPtools-&gt;get_permalink( $pageid, $params, $simple );&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * translate the plugin</span>&nbsp;</div></li><li><div><span class="comment">   * @staticvar boolean $extensionloaded</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $extendedplugin</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function load_lang( $extendedplugin = false ) {&nbsp;</div></li><li><div>      static $extensionloaded = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//we return the entire array of extensions loaded if non is specified</span>&nbsp;</div></li><li><div>      if ( ! $extendedplugin ) {&nbsp;</div></li><li><div>          return $extensionloaded;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//we only need to load this translation loader once on init</span>&nbsp;</div></li><li><div>      if(!$extensionloaded) {&nbsp;</div></li><li><div>          add_action('init', array('WYSIJA', 'load_lang_init'));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">//each plugin has a different name</span>&nbsp;</div></li><li><div>      if ( !$extensionloaded || !isset($extensionloaded[$extendedplugin])) {&nbsp;</div></li><li><div>          $transstring = null;&nbsp;</div></li><li><div>          switch($extendedplugin) {&nbsp;</div></li><li><div>              case 'wysija-newsletters':&nbsp;</div></li><li><div>                  $transstring=WYSIJA;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'wysijashop':&nbsp;</div></li><li><div>                  $transstring=WYSIJASHOP;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'wysijacrons':&nbsp;</div></li><li><div>                  $transstring=WYSIJACRONS;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'wysija-newsletters-premium':&nbsp;</div></li><li><div>                  $transstring=WYSIJANLP;&nbsp;</div></li><li><div>                  break;&nbsp;</div></li><li><div>              case 'get_all':&nbsp;</div></li><li><div>                  return $extensionloaded;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//store all the required translations to be loaded in the static variable</span>&nbsp;</div></li><li><div>          if($transstring !== null) {&nbsp;</div></li><li><div>              $extensionloaded[$extendedplugin] = $transstring;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * check if the user is tech support as this can be used to switch the language back to english when helping our customers</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $current_user</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $debugmode</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_wysija_admin($debugmode=false) {&nbsp;</div></li><li><div>      <span class="comment">//to allow wysija team members to work in english mode if debug is activated</span>&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if((int)$debugmode &gt; 0 && empty($current_user)) return true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($current_user-&gt;data-&gt;user_email) && (strpos($current_user-&gt;data-&gt;user_email, '@mailpoet.com') !== false)) {&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * this function exists just to fix the issue with qtranslate :/ (it only fix it partially)</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $extended_plugin</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function load_lang_init($extended_plugin=false) {&nbsp;</div></li><li><div>      $model_config =  WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      $debug_mode = (int)$model_config-&gt;getValue('debug_new');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($debug_mode === 0 || ($debug_mode &gt; 0 && WYSIJA::is_wysija_admin($debug_mode) === false)) {&nbsp;</div></li><li><div>          $extensions_loaded = WYSIJA::load_lang('get_all');&nbsp;</div></li><li><div>          foreach($extensions_loaded as $extended_plugin =&gt; $translation_string) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// check for translation file overriding from transstring wp-content/languages/wysija-newsletters/wysija-newsletters-en_US.mo</span>&nbsp;</div></li><li><div>              $filename = WP_CONTENT_DIR.DS.'languages'.DS.$extended_plugin.DS.$translation_string.'-'.get_locale().'.mo';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if( !file_exists($filename) ) {&nbsp;</div></li><li><div>                  <span class="comment">// get the translation file in our local file</span>&nbsp;</div></li><li><div>                  $filename = WYSIJA_PLG_DIR.$extended_plugin.DS.'languages'.DS.$translation_string.'-'.get_locale().'.mo';&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// load the translation file with WP's load_textdomain</span>&nbsp;</div></li><li><div>              if( file_exists( $filename ) ) {&nbsp;</div></li><li><div>                  load_textdomain( $translation_string, $filename );&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * function to generate objects of different types, managing file requiring in order to be the most efficient</span>&nbsp;</div></li><li><div><span class="comment">   * @staticvar array $arrayOfObjects</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $name</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $type : in which folder do we go and pick the class</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $force_side : this parameter is almost never set to true, </span>&nbsp;</div></li><li><div><span class="comment">   *                              it will be useful for instance if you want to get a back controller</span>&nbsp;</div></li><li><div><span class="comment">   *                              from the frontend, it was used maybe in the shop but it can be ignored for wysija-newsletters</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $extended_plugin : used only when calling the url from a different plugin it is used watch those files :</span>&nbsp;</div></li><li><div><span class="comment">   *                              -core/controller.php line 21, 23 , 24</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $load_lang : the load lang is in the get  to be sure we don't forget to load the language file for each plugin at least once</span>&nbsp;</div></li><li><div><span class="comment">   *                          the way I see it it could be moved to the index.php of each plugin. for now only wysija-newsletters is translated anyway</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get($name, $type, $force_side=false, $extended_plugin='wysija-newsletters', $load_lang=true) {&nbsp;</div></li><li><div>      static $array_of_objects;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($load_lang)  WYSIJA::load_lang($extended_plugin);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// store all the objects made so that we can reuse them accross the application if the object is already set we return it immediately</span>&nbsp;</div></li><li><div>      if(isset($array_of_objects[$extended_plugin][$type.$name])) {&nbsp;</div></li><li><div>          return $array_of_objects[$extended_plugin][$type.$name];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// which folder do we pick for controllersand views ? back or front ?</span>&nbsp;</div></li><li><div>      if($force_side) {&nbsp;</div></li><li><div>          $side=$force_side;&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          $side=WYSIJA_SIDE;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// for each plugin we will define the $extended_constant variable if it's not defined already</span>&nbsp;</div></li><li><div>      <span class="comment">// also we will defined the $extended_plugin_name which corresponds to the folder name and also will be used to build the class to be called</span>&nbsp;</div></li><li><div>      switch($extended_plugin) {&nbsp;</div></li><li><div>          case 'wysija-newsletters-premium':&nbsp;</div></li><li><div>              $extended_constant='WYSIJANLP';&nbsp;</div></li><li><div>              if(!defined($extended_constant)) define($extended_constant, $extended_constant);&nbsp;</div></li><li><div>              $extended_plugin_name='wysijanlp';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'wysija-newsletters':&nbsp;</div></li><li><div>              $extended_constant='WYSIJA';&nbsp;</div></li><li><div>              if(!defined($extended_constant)) define($extended_constant, $extended_constant);&nbsp;</div></li><li><div>              $extended_plugin_name='wysija';&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          default :&nbsp;</div></li><li><div>              $extended_constant=strtoupper($extended_plugin);&nbsp;</div></li><li><div>              if(!defined($extended_constant)) define($extended_constant, $extended_constant);&nbsp;</div></li><li><div>              $extended_plugin_name=$extended_plugin;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// security to protect against dangerous ./../ includes</span>&nbsp;</div></li><li><div>      $name = preg_replace('#[^a-z0-9_]#i', '', $name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// this switch will require_once the file needed and build a the class name depending on the parameters passed to the function</span>&nbsp;</div></li><li><div>      switch($type) {&nbsp;</div></li><li><div>          case 'controller':&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// require the parent class necessary</span></span></span>&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE.'controller.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $ctrdir=WYSIJA_PLG_DIR.$extended_plugin.DS.'controllers'.DS;&nbsp;</div></li><li><div>              <span class="comment">// Require module concept</span>&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE.'module'.DS.'module.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// if we are doing ajax we don't go to one side, ajax is for frontend or backend in the same folder</span>&nbsp;</div></li><li><div>              if(defined('DOING_AJAX')) {&nbsp;</div></li><li><div>                  $class_path=$ctrdir.'ajax'.DS.$name.'.php';&nbsp;</div></li><li><div>              }else {&nbsp;</div></li><li><div>                  <span class="comment">// the other controllers are called in a side folder back or front</span>&nbsp;</div></li><li><div>                  $class_path=$ctrdir.$side.DS.$name.'.php';&nbsp;</div></li><li><div>                  <span class="comment">// require the side specific controller file</span>&nbsp;</div></li><li><div>                  require_once(WYSIJA_CTRL.$side.'.php');&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>              $class_name = strtoupper($extended_plugin_name).'_control_'.$side.'_'.$name;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'view':&nbsp;</div></li><li><div>              $viewdir=WYSIJA_PLG_DIR.$extended_plugin.DS.'views'.DS;&nbsp;</div></li><li><div>              <span class="comment">// let's get the right path for the view front or back and the right class_name</span>&nbsp;</div></li><li><div>              $class_path=$viewdir.$side.DS.$name.'.php';&nbsp;</div></li><li><div>              $class_name = strtoupper($extended_plugin_name).'_view_'.$side.'_'.$name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              <span class="comment">// require the common view file and the side view file</span>&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE.'view.php');&nbsp;</div></li><li><div>              require_once(WYSIJA_VIEWS.$side.'.php');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'helper':&nbsp;</div></li><li><div>              $helpdir=WYSIJA_PLG_DIR.$extended_plugin.DS.'helpers'.DS;&nbsp;</div></li><li><div>              $class_path=$helpdir.$name.'.php';&nbsp;</div></li><li><div>              $class_name = strtoupper($extended_plugin_name).'_help_'.$name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'model':&nbsp;</div></li><li><div>              $modeldir=WYSIJA_PLG_DIR.$extended_plugin.DS.'models'.DS;&nbsp;</div></li><li><div>              $class_path=$modeldir.$name.'.php';&nbsp;</div></li><li><div>              $class_name = strtoupper($extended_plugin_name).'_model_'.$name;&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// require the parent class necessary</span></span></span>&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE.'model.php');&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>          case 'widget':&nbsp;</div></li><li><div>              $modeldir=WYSIJA_PLG_DIR.$extended_plugin.DS.'widgets'.DS;&nbsp;</div></li><li><div>              $class_path=$modeldir.$name.'.php';&nbsp;</div></li><li><div>              if($name=='wysija_nl') $class_name='WYSIJA_NL_Widget';&nbsp;</div></li><li><div>              else $class_name = strtoupper($extended_plugin_name).'_widget_'.$name;&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          case 'module':&nbsp;</div></li><li><div>              $moduledir = WYSIJA_PLG_DIR . $extended_plugin . DS . 'modules' . DS;&nbsp;</div></li><li><div>              if (file_exists($moduledir . $name . '.php'))&nbsp;</div></li><li><div>                  $class_path = $moduledir . $name . '.php';&nbsp;</div></li><li><div>              elseif (file_exists($moduledir . $name . DS . $name . '.php'))&nbsp;</div></li><li><div>                  $class_path = $moduledir . $name . DS . $name . '.php';&nbsp;</div></li><li><div>              else&nbsp;</div></li><li><div>                  return;&nbsp;</div></li><li><div>              $class_name = strtoupper($extended_plugin_name) . '_module_' . $name;&nbsp;</div></li><li><div>              <span class="comment"><span class="comment"><span class="comment">// require the parent class necessary</span></span></span>&nbsp;</div></li><li><div>              <span class="comment">//require_once(WYSIJA_CORE.'module'.DS.'module.php');</span>&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE . 'module' . DS . 'statistics_model.php');&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE . 'module' . DS . 'statistics.php');&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE . 'module' . DS . 'statisticschart.php');&nbsp;</div></li><li><div>              require_once(WYSIJA_CORE . 'module' . DS . 'statisticstable.php');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              break;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          default:&nbsp;</div></li><li><div>              WYSIJA::setInfo('error', 'WYSIJA::get does not accept this type of file &quot;'.$type.'&quot; .');&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!file_exists($class_path)) {&nbsp;</div></li><li><div>                      if(is_admin() && WYSIJA::current_user_can('switch_themes')) {&nbsp;</div></li><li><div>                          WYSIJA::setInfo('error', 'file has not been recognised '.$class_path);&nbsp;</div></li><li><div>                          WYSIJA::setInfo('error', $class_name);&nbsp;</div></li><li><div>                          WYSIJA::setInfo('error', $type);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>          return;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// require the file needed once and store & return the object needed</span>&nbsp;</div></li><li><div>      require_once($class_path);&nbsp;</div></li><li><div>      return $array_of_objects[$extended_plugin][$type.$name]=new $class_name($extended_plugin_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * log function to spot some strange issues when sending emails for instance</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $key</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $data</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $category</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function log($key='default', $data='empty', $category='default') {&nbsp;</div></li><li><div>      $config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if((int)$config-&gt;getValue('debug_new')&gt;1 && $category && $config-&gt;getValue('debug_log_'.$category)) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $optionlog=get_option('wysija_log');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $optionlog[$category][(string)microtime(true)][$key]=$data;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          WYSIJA::update_option('wysija_log' , $optionlog);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * the filter to add option to the cron frequency instead of being stuck with hourly, daily and twicedaily...</span>&nbsp;</div></li><li><div><span class="comment">   * we can add filters but we cannot delete other values such as the default ones, as this might break other plugins crons</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $param</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function filter_cron_schedules( $param ) {&nbsp;</div></li><li><div>      $frequencies=array(&nbsp;</div></li><li><div>          'one_min' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 60, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every minute', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'two_min' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 120, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every two minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'five_min' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 300, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every five minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'ten_min' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 600, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every ten minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'fifteen_min' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 900, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every fifteen minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'thirty_min' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 1800, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every thirty minutes', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'two_hours' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 7200, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every two hours', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'eachweek' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 604800, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once a week', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'each28days' =&gt; array(&nbsp;</div></li><li><div>              'interval' =&gt; 2419200, &nbsp;</div></li><li><div>              'display' =&gt; __( 'Once every 28 days', WYSIJA)&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return array_merge($param, $frequencies);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * scheduled task for sending the emails in the queue, the frequency is set in the settings</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function croned_queue( $check_scheduled_newsletter = true) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check the scheduled tasks only if it's a standard WP scheduled task free only</span>&nbsp;</div></li><li><div>      if($check_scheduled_newsletter) {&nbsp;</div></li><li><div>          WYSIJA::check_scheduled_newsletters();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      <span class="comment">// check that the 2000 limit is not passed and process the queue</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if((int)$model_config-&gt;getValue('total_subscribers') &lt; 2000 ) {&nbsp;</div></li><li><div>          $helper_queue = WYSIJA::get('queue', 'helper');&nbsp;</div></li><li><div>          $helper_queue-&gt;report=false;&nbsp;</div></li><li><div>          WYSIJA::log('croned_queue process', true, 'cron');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $helper_queue-&gt;process();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function check_scheduled_newsletters() {&nbsp;</div></li><li><div>      $last_scheduled_check = get_option('wysija_last_scheduled_check');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if the latest post notification check was done more than five minutes ago let's check it again</span>&nbsp;</div></li><li><div>      if(empty($last_scheduled_check) || ( time() &gt; ($last_scheduled_check + 300) ) ) {&nbsp;</div></li><li><div>          <span class="comment">// create the scheduled automatic post notifications email if there are any</span>&nbsp;</div></li><li><div>          $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>          $helper_autonews-&gt;checkPostNotif();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// queue the scheduled newsletter also if there are any</span>&nbsp;</div></li><li><div>          $helper_autonews-&gt;checkScheduled();&nbsp;</div></li><li><div>          WYSIJA::update_option('wysija_last_scheduled_check', time());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// send daily report about emails sent</span>&nbsp;</div></li><li><div>      $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      if($model_config-&gt;getValue('emails_notified_when_dailysummary')) {&nbsp;</div></li><li><div>          $helper_notification = WYSIJA::get('notifications', 'helper');&nbsp;</div></li><li><div>          $helper_notification-&gt;send_daily_report();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * everyday we make sure not to leave any trash files</span>&nbsp;</div></li><li><div><span class="comment">   * remove temporary files</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function croned_daily() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**user refresh count total*/</span>&nbsp;</div></li><li><div>      $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>      $helper_user-&gt;refreshUsers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**user domain generation*/</span>&nbsp;</div></li><li><div>      $helper_user-&gt;generate_domains();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**clear temporary folders*/</span>&nbsp;</div></li><li><div>      $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>      $helper_file-&gt;clear();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/**clear queue from unsubscribed*/</span>&nbsp;</div></li><li><div>      $helper_queue = WYSIJA::get('queue', 'helper');&nbsp;</div></li><li><div>      $helper_queue-&gt;clear();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Weekly cron</span>&nbsp;</div></li><li><div>  public static function croned_weekly() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// If enabled, flag MixPanel sending on next page load.</span>&nbsp;</div></li><li><div>      if ($model_config-&gt;getValue('analytics') == 1) {&nbsp;</div></li><li><div>          $model_config-&gt;save(array('send_analytics_now' =&gt; 1));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// Monthly cron</span>&nbsp;</div></li><li><div>  public static function croned_monthly() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">/** send daily report about emails sent */</span>&nbsp;</div></li><li><div>      if ($model_config-&gt;getValue('sharedata')) {&nbsp;</div></li><li><div>          $helper_stats = WYSIJA::get('stats', 'helper');&nbsp;</div></li><li><div>          $helper_stats-&gt;share();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * when we deactivate the plugin we clear the WP install from those cron records</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function deactivate() {&nbsp;</div></li><li><div>      wp_clear_scheduled_hook('wysija_cron_queue');&nbsp;</div></li><li><div>      wp_clear_scheduled_hook('wysija_cron_bounce');&nbsp;</div></li><li><div>      wp_clear_scheduled_hook('wysija_cron_daily');&nbsp;</div></li><li><div>      wp_clear_scheduled_hook('wysija_cron_weekly');&nbsp;</div></li><li><div>      wp_clear_scheduled_hook('wysija_cron_monthly');&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * wysija's redirect allows to save some variables for the next page load such as notices etc..</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $wysija_msg</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $wysija_queries</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $wysija_queries_errors</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $location</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function redirect($location) {&nbsp;</div></li><li><div>      <span class="comment">//save the messages</span>&nbsp;</div></li><li><div>      global $wysija_msg, $wysija_queries, $wysija_queries_errors;&nbsp;</div></li><li><div>      WYSIJA::update_option('wysija_msg', $wysija_msg);&nbsp;</div></li><li><div>      WYSIJA::update_option('wysija_queries', $wysija_queries);&nbsp;</div></li><li><div>      WYSIJA::update_option('wysija_queries_errors', $wysija_queries_errors);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// make sure we encode square brackets as wp_redirect will strip them off</span>&nbsp;</div></li><li><div>      $location = str_replace(array('[', ']'), array('%5B', '%5D'), $location);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// redirect to specified location</span>&nbsp;</div></li><li><div>      wp_redirect($location);&nbsp;</div></li><li><div>      exit;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * custom post type for wysija is call wysijap as in wysija's post</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function create_post_type() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//by default there is url rewriteing on wysijap custom post, though in one client case I had to deactivate it.</span>&nbsp;</div></li><li><div>      <span class="comment">//as this is rare we just need to set this setting to activate it</span>&nbsp;</div></li><li><div>      <span class="comment">//by default let's deactivate the url rewriting of the wysijap confirmation page because it is breaking in some case.</span>&nbsp;</div></li><li><div>      $show_interface=false;&nbsp;</div></li><li><div>      if(defined('WYSIJA_DBG') && WYSIJA_DBG&gt;1) $show_interface=true;&nbsp;</div></li><li><div>      register_post_type( 'wysijap', &nbsp;</div></li><li><div>          array(&nbsp;</div></li><li><div>                  'labels' =&gt; array(&nbsp;</div></li><li><div>                          'name' =&gt; __('MailPoet page'), &nbsp;</div></li><li><div>                          'singular_name' =&gt; __('MailPoet page')&nbsp;</div></li><li><div> ), &nbsp;</div></li><li><div>          'public' =&gt; true, &nbsp;</div></li><li><div>          'has_archive' =&gt; false, &nbsp;</div></li><li><div>          'show_ui' =&gt;$show_interface, &nbsp;</div></li><li><div>          'show_in_menu' =&gt;$show_interface, &nbsp;</div></li><li><div>          'rewrite' =&gt; false, &nbsp;</div></li><li><div>          'show_in_nav_menus'=&gt;false, &nbsp;</div></li><li><div>          'can_export'=&gt;false, &nbsp;</div></li><li><div>          'publicly_queryable'=&gt;true, &nbsp;</div></li><li><div>          'exclude_from_search'=&gt;true, &nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!get_option('wysija_post_type_updated')) {&nbsp;</div></li><li><div>          $modelPosts=new WYSIJA_model();&nbsp;</div></li><li><div>          $modelPosts-&gt;tableWP=true;&nbsp;</div></li><li><div>          $modelPosts-&gt;table_prefix='';&nbsp;</div></li><li><div>          $modelPosts-&gt;table_name='posts';&nbsp;</div></li><li><div>          $modelPosts-&gt;noCheck=true;&nbsp;</div></li><li><div>          $modelPosts-&gt;pk='ID';&nbsp;</div></li><li><div>          if($modelPosts-&gt;exists(array('post_type'=&gt;'wysijapage'))) {&nbsp;</div></li><li><div>              $modelPosts-&gt;update(array('post_type'=&gt;'wysijap'), array('post_type'=&gt;'wysijapage'));&nbsp;</div></li><li><div>              flush_rewrite_rules( false );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          WYSIJA::update_option('wysija_post_type_updated', time());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(!get_option('wysija_post_type_created')) {&nbsp;</div></li><li><div>          flush_rewrite_rules( false );&nbsp;</div></li><li><div>          WYSIJA::update_option('wysija_post_type_created', time());&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * wysija update_option function is very similar to WordPress' one but it</span>&nbsp;</div></li><li><div><span class="comment">   * can also manage new options not automatically loaded each time</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $option_name</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $newvalue</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $defaultload this parameter is the advantage other Wp's update_option here</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function update_option($option_name, $newvalue, $defaultload='no') {&nbsp;</div></li><li><div>      if ( get_option( $option_name ) != $newvalue ) {&nbsp;</div></li><li><div>          update_option( $option_name, $newvalue );&nbsp;</div></li><li><div>      } else {&nbsp;</div></li><li><div>          add_option( $option_name, $newvalue, '', $defaultload );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * When a WordPress user is added we also need to add it to the subscribers list</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $user_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function hook_add_WP_subscriber($user_id) {&nbsp;</div></li><li><div>      $data=get_userdata($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//check first if a subscribers exists if it doesn't then let's insert it</span></span>&nbsp;</div></li><li><div>      $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      $model_user=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>      $model_user-&gt;getFormat=ARRAY_A; <span class="comment">// there is one case where we were getting an object instead of an array</span>&nbsp;</div></li><li><div>      $subscriber_exists=$model_user-&gt;getOne(array('user_id'), array('email'=&gt;$data-&gt;user_email));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $first_name=$data-&gt;first_name;&nbsp;</div></li><li><div>      $last_name=$data-&gt;last_name;&nbsp;</div></li><li><div>      if(!$data-&gt;first_name && !$data-&gt;last_name) $first_name=$data-&gt;display_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_user-&gt;reset();&nbsp;</div></li><li><div>      if($subscriber_exists) {&nbsp;</div></li><li><div>          $user_id=$subscriber_exists['user_id'];&nbsp;</div></li><li><div>          <span class="comment">// we need to update the current subscriber using it's id</span>&nbsp;</div></li><li><div>          $model_user-&gt;update(array('wpuser_id'=&gt;$data-&gt;ID, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name), array('user_id'=&gt;$user_id));&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $model_user-&gt;noCheck=true;&nbsp;</div></li><li><div>          $user_id=$model_user-&gt;insert(array('email'=&gt;$data-&gt;user_email, 'wpuser_id'=&gt;$data-&gt;ID, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name, 'status'=&gt;$model_config-&gt;getValue('confirm_dbleoptin')));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_user_list=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>      $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()), true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>      $helper_user-&gt;sendAutoNl($user_id, $data, 'new-user');&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * when a WordPress user is updated we also need to update the corresponding subscriber</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $user_id</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function hook_edit_WP_subscriber($user_id) {&nbsp;</div></li><li><div>      $data=get_userdata($user_id);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment"><span class="comment">//check first if a subscribers exists if it doesn't then let's insert it</span></span>&nbsp;</div></li><li><div>      $model_user=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>      $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      $model_user_list=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>      $model_user-&gt;getFormat = ARRAY_A;&nbsp;</div></li><li><div>      $subscriber_exists=$model_user-&gt;getOne(array('user_id'), array('email'=&gt;$data-&gt;user_email));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_user-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $first_name=$data-&gt;first_name;&nbsp;</div></li><li><div>      $last_name=$data-&gt;last_name;&nbsp;</div></li><li><div>      if(!$data-&gt;first_name && !$data-&gt;last_name) $first_name=$data-&gt;display_name;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if($subscriber_exists) {&nbsp;</div></li><li><div>          $user_id=$subscriber_exists['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $model_user-&gt;update(array('wpuser_id'=&gt;$data-&gt;ID, 'email'=&gt;$data-&gt;user_email, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name), array('user_id'=&gt;$user_id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $result=$model_user_list-&gt;getOne(false, array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id')));&nbsp;</div></li><li><div>          $model_user_list-&gt;reset();&nbsp;</div></li><li><div>          if(!$result)&nbsp;</div></li><li><div>              $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()));&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          <span class="comment">//chck that we didnt update the email</span>&nbsp;</div></li><li><div>          $subscriber_exists=$model_user-&gt;getOne(false, array('wpuser_id'=&gt;$data-&gt;ID));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($subscriber_exists) {&nbsp;</div></li><li><div>              $user_id=$subscriber_exists['user_id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $model_user-&gt;update(array('email'=&gt;$data-&gt;user_email, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name), array('wpuser_id'=&gt;$data-&gt;ID));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              $result=$model_user_list-&gt;getOne(false, array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id')));&nbsp;</div></li><li><div>              $model_user_list-&gt;reset();&nbsp;</div></li><li><div>              if(!$result)&nbsp;</div></li><li><div>                  $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()));&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              $model_user-&gt;noCheck=true;&nbsp;</div></li><li><div>              $user_id=$model_user-&gt;insert(array('email'=&gt;$data-&gt;user_email, 'wpuser_id'=&gt;$data-&gt;ID, 'firstname'=&gt;$first_name, 'lastname'=&gt;$last_name, 'status'=&gt;$model_config-&gt;getValue('confirm_dbleoptin')));&nbsp;</div></li><li><div>              $model_user_list-&gt;insert(array('user_id'=&gt;$user_id, 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id'), 'sub_date'=&gt;time()));&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * when a wp user is deleted we also delete the subscriber corresponding to it</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $user_id</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function hook_del_WP_subscriber($user_id) {&nbsp;</div></li><li><div>      $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      $model_user=WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>      $data = $model_user-&gt;getOne(array('email', 'user_id'), array('wpuser_id'=&gt;$user_id));&nbsp;</div></li><li><div>      if(isset($data['email'])) {&nbsp;</div></li><li><div>          $model_user-&gt;delete(array('email'=&gt;$data['email']));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      if(isset($data['user_id'])) {&nbsp;</div></li><li><div>          $model_user = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>          $model_user-&gt;delete(array('user_id'=&gt;$data['user_id'], 'list_id'=&gt;$model_config-&gt;getValue('importwp_list_id')));&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  public static function hook_auto_newsletter_refresh($post_id) {&nbsp;</div></li><li><div>      $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>      $helper_autonews-&gt;refresh_automatic_content();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * post notification transition hook, know when a post really gets published</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $new_status</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $old_status</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $post</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function hook_postNotification_transition($new_status, $old_status, $post) {&nbsp;</div></li><li><div>      <span class="comment">//we run some process only if the status of the post changes from something to publish</span>&nbsp;</div></li><li><div>      if($new_status === 'publish' && $old_status !== $new_status) {&nbsp;</div></li><li><div>          $model_email = WYSIJA::get('email', 'model');&nbsp;</div></li><li><div>          $emails = $model_email-&gt;get(false, array('type' =&gt; 2, 'status' =&gt; array(1, 3, 99)));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(!empty($emails)) {&nbsp;</div></li><li><div>              <span class="comment">//we loop through all of the automatic emails</span>&nbsp;</div></li><li><div>              foreach($emails as $key =&gt; $email) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  <span class="comment">//we will try to give birth to a child email only if the automatic newsletter is a post notification email and in immediate mode</span>&nbsp;</div></li><li><div>                  if(is_array($email) && $email['params']['autonl']['event'] === 'new-articles' && $email['params']['autonl']['when-article'] === 'immediate') {&nbsp;</div></li><li><div>                      <span class="comment">// set default include/exclude categories</span>&nbsp;</div></li><li><div>                      $include_category_ids = array();&nbsp;</div></li><li><div>                      $exclude_category_ids = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// ALC need to check for post_type on each block of the autoposts</span>&nbsp;</div></li><li><div>                      $wj_data = maybe_unserialize( base64_decode( $email['wj_data'] ) );&nbsp;</div></li><li><div>                      $post_types = array();&nbsp;</div></li><li><div>                      $has_alc_blocks = false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      foreach ( $wj_data['body'] as $block_key =&gt; $block ) {&nbsp;</div></li><li><div>                          if ( $block['type'] !== 'auto-post' ) {&nbsp;</div></li><li><div>                              continue;&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $has_alc_blocks = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          <span class="comment">// get post type and post categories from block parameters</span>&nbsp;</div></li><li><div>                          foreach( $block['params'] as $param_data ) {&nbsp;</div></li><li><div>                              if(in_array($param_data['key'], array('post_type', 'cpt'))  && strlen(trim($param_data['value'])) &gt; 0) {&nbsp;</div></li><li><div>                                  <span class="comment">// store post type</span>&nbsp;</div></li><li><div>                                  $post_types[] = trim($param_data['value']);&nbsp;</div></li><li><div>                              } else if($param_data['key'] === 'category_ids' && strlen(trim($param_data['value'])) &gt; 0) {&nbsp;</div></li><li><div>                                  <span class="comment">// store post category ids</span>&nbsp;</div></li><li><div>                                  $include_category_ids = array_map('intval', explode(', ', trim($param_data['value'])));&nbsp;</div></li><li><div>                              }&nbsp;</div></li><li><div>                          }&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if ( $has_alc_blocks === true && ! in_array( $post-&gt;post_type, $post_types ) ) {&nbsp;</div></li><li><div>                          continue;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// get post categories</span>&nbsp;</div></li><li><div>                      $helper_wp_tools = WYSIJA::get('wp_tools', 'helper');&nbsp;</div></li><li><div>                      $taxonomies = $helper_wp_tools-&gt;get_post_category_ids($post);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// assume the post has to be sent</span>&nbsp;</div></li><li><div>                      $do_send_post = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      <span class="comment">// post categories have to match at least one of the email's included categories</span>&nbsp;</div></li><li><div>                      $include_intersection = array_intersect($taxonomies, $include_category_ids);&nbsp;</div></li><li><div>                      if(!empty($include_category_ids) && empty($include_intersection)) {&nbsp;</div></li><li><div>                          $do_send_post = false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $exclude_intersection = array_intersect($taxonomies, $exclude_category_ids);&nbsp;</div></li><li><div>                      <span class="comment">// post categories should not match any one of the email's excluded categories</span>&nbsp;</div></li><li><div>                      if(!empty($exclude_category_ids) && !empty($exclude_intersection)) {&nbsp;</div></li><li><div>                          $do_send_post = false;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      if($do_send_post) {&nbsp;</div></li><li><div>                          WYSIJA::log('post_transition_hook_give_birth', array(&nbsp;</div></li><li><div>                              'post_id' =&gt; $post-&gt;ID, &nbsp;</div></li><li><div>                              'post_title' =&gt; $post-&gt;post_title, &nbsp;</div></li><li><div>                              'newsletter' =&gt; $email, &nbsp;</div></li><li><div>                              'old_status' =&gt; $old_status, &nbsp;</div></li><li><div>                              'new_status' =&gt; $new_status&nbsp;</div></li><li><div> ), 'post_notif');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                          $model_email-&gt;reset();&nbsp;</div></li><li><div>                          $model_email-&gt;give_birth($email, $post-&gt;ID);&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">// we check for automatic latest content widget in automatic newsletter</span>&nbsp;</div></li><li><div>          $helper_autonews = WYSIJA::get('autonews', 'helper');&nbsp;</div></li><li><div>          $helper_autonews-&gt;refresh_automatic_content();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * uninstall process not used</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function uninstall() {&nbsp;</div></li><li><div>      $helperUS=WYSIJA::get('uninstall', 'helper');&nbsp;</div></li><li><div>      $helperUS-&gt;uninstall();&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * this function is run when wysija gets activated</span>&nbsp;</div></li><li><div><span class="comment">   * there is no installation process here, all is about checking the global status of the app</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function activate() {&nbsp;</div></li><li><div>      $encoded_option=get_option('wysija');&nbsp;</div></li><li><div>      $installApp=false;&nbsp;</div></li><li><div>      if($encoded_option) {&nbsp;</div></li><li><div>          $values=unserialize(base64_decode($encoded_option));&nbsp;</div></li><li><div>          if(isset($values['installed'])) $installApp=true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//test again for plugins on reactivation</span>&nbsp;</div></li><li><div>      if($installApp) {&nbsp;</div></li><li><div>          $helper_import=WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>          $helper_import-&gt;testPlugins();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment">//resynch wordpress list</span>&nbsp;</div></li><li><div>          $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>          $helper_user-&gt;synchList($values['importwp_list_id']);&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * the is_plugin_active functions from WordPress sometimes are not loaded so here is one that works for single and multisites anywhere in the code</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $pluginName</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_plugin_active($pluginName) {&nbsp;</div></li><li><div>      $arrayactiveplugins=get_option('active_plugins');&nbsp;</div></li><li><div>      <span class="comment">//we check in the list of the site options if the plugin is activated</span>&nbsp;</div></li><li><div>      if(in_array($pluginName, $arrayactiveplugins)) {&nbsp;</div></li><li><div>          <span class="comment">//plugin is activated for that site</span>&nbsp;</div></li><li><div>          return true;&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//if this is a multisite it might not be activated in the site option but network activated though</span>&nbsp;</div></li><li><div>      if(is_multisite()) {&nbsp;</div></li><li><div>          $plugins = get_site_option('active_sitewide_plugins');&nbsp;</div></li><li><div>          <span class="comment">//plugin is activated for that multisite</span>&nbsp;</div></li><li><div>          if(isset($plugins[$pluginName])) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * make sure that the current user has the good access rights corresponding to its role</span>&nbsp;</div></li><li><div><span class="comment">   * @global type $current_user</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function update_user_caps() {&nbsp;</div></li><li><div>      global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(empty($current_user) && function_exists('wp_get_current_user')) wp_get_current_user();&nbsp;</div></li><li><div>      if(empty($current_user)) return false;&nbsp;</div></li><li><div>      $current_user-&gt;get_role_caps();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>   <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * test whether the plugin is a beta version or not</span>&nbsp;</div></li><li><div><span class="comment">   * 2.4.4.4  is a beta</span>&nbsp;</div></li><li><div><span class="comment">   * 2.4.4 is a bug fix release</span>&nbsp;</div></li><li><div><span class="comment">   * 2.4 is a feature release</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $plugin_name</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function is_beta($plugin_name=false) {&nbsp;</div></li><li><div>      <span class="comment">// exceptions</span>&nbsp;</div></li><li><div>      $not_beta_versions = array('2.5.9.1', '2.5.9.2', '2.5.9.3', &quot;2.5.9.4&quot;);&nbsp;</div></li><li><div>      $mailpoet_version = WYSIJA::get_version($plugin_name);&nbsp;</div></li><li><div>      if(in_array($mailpoet_version, $not_beta_versions)) return false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// standard way of defining a beta version</span>&nbsp;</div></li><li><div>      if(count(explode('.', $mailpoet_version)) &gt; 3 ) return true;&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * depending where it's used the base function from WordPress doesn't work, so this one will work anywhere</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $capability</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function current_user_can($capability) {&nbsp;</div></li><li><div>      if(!$capability) return false;&nbsp;</div></li><li><div>      WYSIJA::update_user_caps();&nbsp;</div></li><li><div>      if(!current_user_can($capability)) return false;&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * this function get and sets the cron schedules when MailPoet's own cron system is active</span>&nbsp;</div></li><li><div><span class="comment">   * @staticvar type $cron_schedules</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $schedule</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_cron_schedule($schedule='queue') {&nbsp;</div></li><li><div>      static $cron_schedules;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">//if the cron schedules are already loaded statically then we just have to return the right schedule value</span>&nbsp;</div></li><li><div>      if(!empty($cron_schedules)) {&nbsp;</div></li><li><div>          if($schedule=='all') return $cron_schedules;&nbsp;</div></li><li><div>          if(isset($cron_schedules[$schedule])) {&nbsp;</div></li><li><div>              return $cron_schedules[$schedule];&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              WYSIJA::set_cron_schedule($schedule);&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          <span class="comment">//this is the first time this function is executed so let's get them from the db and store them statically</span>&nbsp;</div></li><li><div>          $cron_schedules=get_option('wysija_schedules', array());&nbsp;</div></li><li><div>          if(!empty($cron_schedules)) {&nbsp;</div></li><li><div>              if(isset($cron_schedules[$schedule]))   return $cron_schedules[$schedule];&nbsp;</div></li><li><div>              else    return false;&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>              WYSIJA::set_cron_schedule();&nbsp;</div></li><li><div>              return false;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * return the frequency for each cron task needed by MailPoet</span>&nbsp;</div></li><li><div><span class="comment">   * @return type an array of frequencies</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function get_cron_frequencies() {&nbsp;</div></li><li><div>      $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      $helper_forms = WYSIJA::get('forms', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_multisite() && $model_config-&gt;getValue('sending_method')=='network') {&nbsp;</div></li><li><div>         $sending_emails_each = $model_config-&gt;getValue('ms_sending_emails_each');&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>         $sending_emails_each = $model_config-&gt;getValue('sending_emails_each');&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $queue_frequency = $helper_forms-&gt;eachValuesSec[$sending_emails_each];&nbsp;</div></li><li><div>      $bounce_frequency = 99999999999999;&nbsp;</div></li><li><div>      if(isset($helper_forms-&gt;eachValuesSec[$model_config-&gt;getValue('bouncing_emails_each')])) {&nbsp;</div></li><li><div>          $bounce_frequency = $helper_forms-&gt;eachValuesSec[$model_config-&gt;getValue('bouncing_emails_each')];&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return array('queue'=&gt;$queue_frequency, 'bounce'=&gt;$bounce_frequency, 'daily'=&gt;86400, 'weekly'=&gt;604800, 'monthly'=&gt;2419200);&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * set the next cron schedule</span>&nbsp;</div></li><li><div><span class="comment">   * TODO : needs probably to make the difference of running process for the next schedule, so that there is no delay(this is only problematic on some slow servers)</span>&nbsp;</div></li><li><div><span class="comment">   * @param string $schedule</span>&nbsp;</div></li><li><div><span class="comment">   * @param int $last_saved</span>&nbsp;</div></li><li><div><span class="comment">   * @param boolean $set_running</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function set_cron_schedule($schedule = false , $last_saved = 0 , $set_running = false) {&nbsp;</div></li><li><div>      $cron_schedules = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $start_time = $last_saved;&nbsp;</div></li><li><div>      if(!$start_time)    $start_time = time();&nbsp;</div></li><li><div>      $processes = WYSIJA::get_cron_frequencies();&nbsp;</div></li><li><div>      if(!$schedule) {&nbsp;</div></li><li><div>          foreach($processes as $process =&gt; $frequency) {&nbsp;</div></li><li><div>              $next_schedule = $start_time + $frequency;&nbsp;</div></li><li><div>              $prev_schedule = 0;&nbsp;</div></li><li><div>              if(isset($cron_schedules[$process]['running']) && $cron_schedules[$process]['running']) $prev_schedule=$cron_schedules[$process]['running'];&nbsp;</div></li><li><div>              $cron_schedules[$process]=array(&nbsp;</div></li><li><div>                  'next_schedule' =&gt; $next_schedule, &nbsp;</div></li><li><div>                  'prev_schedule' =&gt; $prev_schedule, &nbsp;</div></li><li><div>                  'running' =&gt; false);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }else{&nbsp;</div></li><li><div>          $cron_schedules = WYSIJA::get_cron_schedule('all');&nbsp;</div></li><li><div>          if($set_running) {&nbsp;</div></li><li><div>               $cron_schedules[$schedule]['running'] = $set_running;&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>               $running = 0;&nbsp;</div></li><li><div>              if(isset($cron_schedules[$schedule]['running'])) $running = $cron_schedules[$schedule]['running'];&nbsp;</div></li><li><div>              <span class="comment">// if the process is not running or has been running for more than 15 minutes then we set the next_schedule date</span>&nbsp;</div></li><li><div>              $process_frequency = $processes[$schedule];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              if(!$running || ( time() &gt; ($running + $process_frequency) ) ) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $next_schedule = $start_time + $process_frequency;&nbsp;</div></li><li><div>                  <span class="comment">// if the next schedule is already behind, we give it 30 seconds before it can triggers again</span>&nbsp;</div></li><li><div>                  if( $next_schedule &lt; $start_time ) {&nbsp;</div></li><li><div>                      $next_schedule = $start_time + 30;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                  $cron_schedules[$schedule] = array(&nbsp;</div></li><li><div>                          'next_schedule' =&gt; $next_schedule, &nbsp;</div></li><li><div>                          'prev_schedule' =&gt; $running, &nbsp;</div></li><li><div>                          'running' =&gt; false);&nbsp;</div></li><li><div>              }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      WYSIJA::update_option( 'wysija_schedules' , $cron_schedules , 'yes' );&nbsp;</div></li><li><div>      return true;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * check that there is no passed schedules that need to be executed now</span>&nbsp;</div></li><li><div><span class="comment">   * @return void</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function cron_check() {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $cron_schedules = WYSIJA::get_cron_schedule('all');&nbsp;</div></li><li><div>      if(empty($cron_schedules)) return;&nbsp;</div></li><li><div>      else{&nbsp;</div></li><li><div>          $processes = WYSIJA::get_cron_frequencies();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          $updated_sched = false;&nbsp;</div></li><li><div>          foreach($cron_schedules as $schedule =&gt; &$params) {&nbsp;</div></li><li><div>                  $running = 0;&nbsp;</div></li><li><div>                  $time_now = time();&nbsp;</div></li><li><div>                  if(isset($params['running'])) $running = $params['running'];&nbsp;</div></li><li><div>                  <span class="comment">//if the process has timedout we reschedule the next execution</span>&nbsp;</div></li><li><div>                  if($running && ( $time_now&gt; ($running + $processes[$schedule]) ) ) {&nbsp;</div></li><li><div>                      <span class="comment">//WYSIJA::setInfo('error', 'modifying next schedule for '.$proc);</span>&nbsp;</div></li><li><div>                      $process_frequency = $processes[$schedule];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                      $next_schedule = $running + $process_frequency;&nbsp;</div></li><li><div>                      <span class="comment">// if the next schedule is already behind, we give it 30 seconds before it can trigger again</span>&nbsp;</div></li><li><div>                      if( $next_schedule &lt; $time_now ) {&nbsp;</div></li><li><div>                          $next_schedule = $time_now + 30;&nbsp;</div></li><li><div>                      }&nbsp;</div></li><li><div>                      $params=array(&nbsp;</div></li><li><div>                              'next_schedule' =&gt; $next_schedule, &nbsp;</div></li><li><div>                              'prev_schedule' =&gt; $running, &nbsp;</div></li><li><div>                              'running' =&gt; false);&nbsp;</div></li><li><div>                      $updated_sched=true;&nbsp;</div></li><li><div>                  }&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          if($updated_sched) {&nbsp;</div></li><li><div>              <span class="comment">//WYSIJA::setInfo('error', 'updating scheds');</span>&nbsp;</div></li><li><div>              WYSIJA::update_option( 'wysija_schedules' , $cron_schedules , 'yes' );&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $time_now = time();&nbsp;</div></li><li><div>      $processesToRun = array();&nbsp;</div></li><li><div>      foreach($cron_schedules as $schedule =&gt; $scheduled_times) {&nbsp;</div></li><li><div>          if(strpos($schedule, '(bounce handling not activated)')!==false) continue;&nbsp;</div></li><li><div>                      if( !isset($processes[$schedule]) ) continue;&nbsp;</div></li><li><div>          $process_frequency = $processes[$schedule];&nbsp;</div></li><li><div>          if( ( !$scheduled_times['running'] || (int)$scheduled_times['running'] + $process_frequency &lt; $time_now ) && $scheduled_times['next_schedule'] &lt; $time_now) {&nbsp;</div></li><li><div>              $processesToRun[] = $schedule;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>      $page_view_trigger = (int)$model_config-&gt;getValue('cron_page_hit_trigger');&nbsp;</div></li><li><div>      if(!empty($processesToRun) && $page_view_trigger === 1) {&nbsp;</div></li><li><div>          <span class="comment">//call the cron url</span>&nbsp;</div></li><li><div>          <span class="comment">// do not call that more than once per 5 minutes attempt at reducing the CPU load for some users</span>&nbsp;</div></li><li><div>          <span class="comment">// http://wordpress.org/support/topic/wysija-newsletters-slowing-down-my-site-1</span>&nbsp;</div></li><li><div>          $last_cron_time_plus_5min = (int)get_option('wysija_last_php_cron_call') + (5*60);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if($last_cron_time_plus_5min &lt; time()) {&nbsp;</div></li><li><div>              $cron_url = site_url( 'wp-cron.php').'?'.WYSIJA_CRON.'&action=wysija_cron&process='.implode(', ', $processesToRun).'&silent=1';&nbsp;</div></li><li><div>              $cron_request = apply_filters( 'cron_request', array(&nbsp;</div></li><li><div>                      'url' =&gt; $cron_url, &nbsp;</div></li><li><div>                      'args' =&gt; array( 'timeout' =&gt; 0.01, 'blocking' =&gt; false, 'sslverify' =&gt; apply_filters( 'https_local_ssl_verify', true ) )&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>              wp_remote_post( $cron_url, $cron_request['args'] );&nbsp;</div></li><li><div>              WYSIJA::update_option('wysija_last_php_cron_call', time());&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * Function somehow necessary to avoid some conflicts in windows server and WordPress autoload of plugins language file</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $boolean</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $domain</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $mofile</span>&nbsp;</div></li><li><div><span class="comment">   * @return boolean</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function override_load_textdomain($boolean, $domain, $mofile) {&nbsp;</div></li><li><div>          $extensionloaded=WYSIJA::load_lang('get_all');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          if(isset($extensionloaded[$domain]) && !@file_exists($mofile)) {&nbsp;</div></li><li><div>              return true;&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          return false;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">/**</span>&nbsp;</div></li><li><div><span class="comment">   * function to rewrite the path of the file if the file doesn't exist</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $mofile</span>&nbsp;</div></li><li><div><span class="comment">   * @param type $domain</span>&nbsp;</div></li><li><div><span class="comment">   * @return type</span>&nbsp;</div></li><li><div><span class="comment">   */</span>&nbsp;</div></li><li><div>  public static function load_textdomain_mofile($mofile, $domain) {&nbsp;</div></li><li><div>      $extensionloaded=WYSIJA::load_lang('get_all');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(isset($extensionloaded[$domain]) && !file_exists($mofile)) {&nbsp;</div></li><li><div>          return WYSIJA_PLG_DIR.$domain.DS.'languages'.DS.$extensionloaded[$domain].'-'.get_locale().'.mo';&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      return $mofile;&nbsp;</div></li><li><div>  }&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// subscribers/wp-user synch hooks</span>&nbsp;</div></li><li><div>add_action('user_register', array('WYSIJA', 'hook_add_WP_subscriber'), 1);&nbsp;</div></li><li><div>add_action('added_existing_user', array('WYSIJA', 'hook_add_WP_subscriber'), 1);&nbsp;</div></li><li><div>add_action('profile_update', array('WYSIJA', 'hook_edit_WP_subscriber'), 1);&nbsp;</div></li><li><div><span class="comment">// for standard blog</span>&nbsp;</div></li><li><div>add_action('delete_user', array('WYSIJA', 'hook_del_WP_subscriber'), 1);&nbsp;</div></li><li><div><span class="comment">// for multisite</span>&nbsp;</div></li><li><div>add_action('deleted_user', array('WYSIJA', 'hook_del_WP_subscriber'), 1);&nbsp;</div></li><li><div>add_action('remove_user_from_blog', array('WYSIJA', 'hook_del_WP_subscriber'), 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// Load the Upgrader Class</span>&nbsp;</div></li><li><div>add_action('init', array('WJ_Upgrade', 'hook'), 9);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// post notif trigger</span>&nbsp;</div></li><li><div>add_action('transition_post_status', array('WYSIJA', 'hook_postNotification_transition'), 1, 3);&nbsp;</div></li><li><div><span class="comment">// refresh auto newsletter content when a post is modified</span>&nbsp;</div></li><li><div><span class="comment">//add_action('save_post', array('WYSIJA', 'hook_auto_newsletter_refresh'), 1, 1);</span>&nbsp;</div></li><li><div>add_action('delete_post', array('WYSIJA', 'hook_auto_newsletter_refresh'), 1, 1);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// add image size for emails</span>&nbsp;</div></li><li><div>add_image_size('wysija-newsletters-max', 600, 9999);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$modelConf=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>if($modelConf-&gt;getValue('installed_time')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// START all that concerns the CRON</span>&nbsp;</div></li><li><div>  <span class="comment">// make sure we check when is the schedule due with wysija's cron</span>&nbsp;</div></li><li><div>  if($modelConf-&gt;getValue('cron_manual')) {&nbsp;</div></li><li><div>      <span class="comment">// if WP cron tasks are still set, we clear them</span>&nbsp;</div></li><li><div>      if(wp_get_schedule('wysija_cron_queue'))    WYSIJA::deactivate();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// set the crons schedule for each process</span>&nbsp;</div></li><li><div>      WYSIJA::get_cron_schedule();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// check that there is no late cron schedules if we are using wysija's cron option and that the cron option is triggerred by any page view</span>&nbsp;</div></li><li><div>      if(!isset($_REQUEST['process'])) {&nbsp;</div></li><li><div>          WYSIJA::cron_check();&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// this action is triggerred only by a cron job</span>&nbsp;</div></li><li><div>      <span class="comment">// if we're entering the wysija's cron part, it should end here</span>&nbsp;</div></li><li><div>      if(isset($_REQUEST['action']) && $_REQUEST['action']=='wysija_cron') {&nbsp;</div></li><li><div>          <span class="comment">// priority is hundred so that the messages such as unsubscribe or view in your browser have time to be translated(they get translated around 96, 97)</span>&nbsp;</div></li><li><div>          add_action('init', 'init_wysija_cron', 100);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          function init_wysija_cron() {&nbsp;</div></li><li><div>              $hCron=WYSIJA::get('cron', 'helper');&nbsp;</div></li><li><div>              $hCron-&gt;run();&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// make sure the scheduled tasks are recorded when using WordPress' cron</span>&nbsp;</div></li><li><div>  }else{&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// filter to add new possible frequencies to the cron</span>&nbsp;</div></li><li><div>      add_filter( 'cron_schedules', array( 'WYSIJA', 'filter_cron_schedules' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// action to handle the scheduled tasks in wysija</span>&nbsp;</div></li><li><div>      add_action( 'wysija_cron_queue', array( 'WYSIJA', 'croned_queue' ) );&nbsp;</div></li><li><div>      add_action( 'wysija_cron_daily', array( 'WYSIJA', 'croned_daily' ) );&nbsp;</div></li><li><div>      add_action( 'wysija_cron_weekly', array( 'WYSIJA', 'croned_weekly' ) );&nbsp;</div></li><li><div>      add_action( 'wysija_cron_monthly', array( 'WYSIJA', 'croned_monthly' ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// same with the weekly task</span>&nbsp;</div></li><li><div>      if(!wp_next_scheduled('wysija_cron_weekly')) {&nbsp;</div></li><li><div>          wp_schedule_event( $modelConf-&gt;getValue('last_save') , 'eachweek', 'wysija_cron_weekly' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>      <span class="comment">// the monthly task...</span>&nbsp;</div></li><li><div>      if(!wp_next_scheduled('wysija_cron_monthly')) {&nbsp;</div></li><li><div>          wp_schedule_event( $modelConf-&gt;getValue('last_save') , 'each28days', 'wysija_cron_monthly' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// the daily task...</span>&nbsp;</div></li><li><div>      if(!wp_next_scheduled('wysija_cron_daily')) {&nbsp;</div></li><li><div>          wp_schedule_event( $modelConf-&gt;getValue('last_save') , 'daily', 'wysija_cron_daily' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      if(is_multisite()) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// in the case of multisite and the network's method we schedule with a different frequency</span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// this option contains the list of sites already scheduled</span></span>&nbsp;</div></li><li><div>          $ms_wysija_bounce_cron = get_site_option('ms_wysija_bounce_cron');&nbsp;</div></li><li><div>          global $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// if this blog is not recorded in our wysija_sending_cron option then we clear its scheduled so that we can reinitialize it</span></span>&nbsp;</div></li><li><div>          if(!$ms_wysija_bounce_cron || !isset($ms_wysija_bounce_cron[$blog_id])) {&nbsp;</div></li><li><div>              wp_clear_scheduled_hook('wysija_cron_bounce');&nbsp;</div></li><li><div>              WYSIJA::set_cron_schedule('queue');&nbsp;</div></li><li><div>              $ms_wysija_bounce_cron[$blog_id] = 1;&nbsp;</div></li><li><div>              update_site_option('ms_wysija_bounce_cron', $ms_wysija_bounce_cron);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// if the bounce task is not scheduled then we initialize it</span>&nbsp;</div></li><li><div>      if(!wp_next_scheduled('wysija_cron_bounce')) {&nbsp;</div></li><li><div>          wp_schedule_event( $modelConf-&gt;getValue('last_save') , $modelConf-&gt;getValue('bouncing_emails_each'), 'wysija_cron_bounce' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// and  the queue processing task ...</span>&nbsp;</div></li><li><div>      <span class="comment">// if we are in a multisite case we make sure that the ms frequency hasn't been changed, if it has we reset it</span>&nbsp;</div></li><li><div>      if(is_multisite() && $modelConf-&gt;getValue('sending_method')=='network') {&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// in the case of multisite and the network's method we schedule with a different frequency</span></span></span>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// this option contains the list of sites already scheduled</span></span>&nbsp;</div></li><li><div>          $ms_wysija_sending_cron=get_site_option('ms_wysija_sending_cron');&nbsp;</div></li><li><div>          global $blog_id;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment">// if this blog is not recorded in our wysija_sending_cron option then we clear its scheduled so that we can reinitialize it</span></span>&nbsp;</div></li><li><div>          if(!$ms_wysija_sending_cron || !isset($ms_wysija_sending_cron[$blog_id])) {&nbsp;</div></li><li><div>              wp_clear_scheduled_hook('wysija_cron_queue');&nbsp;</div></li><li><div>              WYSIJA::set_cron_schedule('queue');&nbsp;</div></li><li><div>              $ms_wysija_sending_cron[$blog_id]=1;&nbsp;</div></li><li><div>              update_site_option('ms_wysija_sending_cron', $ms_wysija_sending_cron);&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>      <span class="comment">// simply schedule the queue</span>&nbsp;</div></li><li><div>      if(!wp_next_scheduled('wysija_cron_queue')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>          <span class="comment"><span class="comment"><span class="comment">// in the case of multisite and the network's method we schedule with a different frequency</span></span></span>&nbsp;</div></li><li><div>          if(is_multisite() && $modelConf-&gt;getValue('sending_method')=='network') {&nbsp;</div></li><li><div>              $sending_emails_each=$modelConf-&gt;getValue('ms_sending_emails_each');&nbsp;</div></li><li><div>          }else{&nbsp;</div></li><li><div>             $sending_emails_each=$modelConf-&gt;getValue('sending_emails_each');&nbsp;</div></li><li><div>          }&nbsp;</div></li><li><div>          wp_schedule_event( $modelConf-&gt;getValue('last_save') , $sending_emails_each, 'wysija_cron_queue' );&nbsp;</div></li><li><div>      }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  }<span class="comment">// END all that concerns the CRON</span>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>  <span class="comment">// filter fixing a bug with automatic load_text_domain_from WP didn't understand yet why this was necessary...</span>&nbsp;</div></li><li><div>  <span class="comment">// somehow wp_register_script(which is irrelevant) was triggerring this kind of notice</span>&nbsp;</div></li><li><div>  <span class="comment">// Warning: is_readable() [function.is-readable]: open_basedir restriction in effect. File(C:\Domains\website.com\wwwroot\web/wp-content/plugins/C:\Domains\website.com\wwwroot\web\wp-content\plugins\wysija-newsletters/languages/wysija-newsletters-en_US.mo) is not within the allowed path(s): (.;C:\Domains\;C:\PHP\;C:\Sites\;C:\SitesData\;/) in C:\Domains\website.com\wwwroot\web\wp-includes\l10n.php on line 339</span>&nbsp;</div></li><li><div>  <span class="comment">// the only solution is to make sure on our end that the file exists and rewrite it if necessary</span>&nbsp;</div></li><li><div>  add_filter( 'override_load_textdomain', array( 'WYSIJA', 'override_load_textdomain' ), 10, 3);&nbsp;</div></li><li><div>  add_filter('load_textdomain_mofile', array( 'WYSIJA', 'load_textdomain_mofile' ), 10, 2);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>register_deactivation_hook(WYSIJA_FILE, array( 'WYSIJA', 'deactivate' ));&nbsp;</div></li><li><div>register_activation_hook(WYSIJA_FILE, array( 'WYSIJA', 'activate' ));&nbsp;</div></li><li><div>add_action( 'init', array('WYSIJA', 'create_post_type') );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// check for PHP version and display a warning notice if it's &lt;5.3</span>&nbsp;</div></li><li><div>if ( version_compare( PHP_VERSION , '5.3' , '&lt;' ) &&&nbsp;</div></li><li><div>!get_option(&quot;wysija_dismiss_update_notice&quot;) &&&nbsp;</div></li><li><div>empty($_SERVER['HTTP_X_REQUESTED_WITH'])&nbsp;</div></li><li><div>) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>$a = new WYSIJA_object();&nbsp;</div></li><li><div>$a-&gt;notice(__(&quot;Your version of PHP is outdated. If you don't upgrade soon, new versions of MailPoet won't work.&quot;)&nbsp;</div></li><li><div>           . &quot;&lt;br /&gt;&quot;&nbsp;</div></li><li><div>           . str_replace( array('[link]', '[/link]'), array('&lt;a href=&quot;https:<span class="comment">//support.mailpoet.com/knowledgebase/how-to-prepare-my-site-for-mailpoet-3-0/&quot; target=&quot;_blank&quot; &gt;', '&lt;/a&gt;'), __(&quot;[link]Read how to update your version of PHP.[/link]&quot;)</span>&nbsp;</div></li><li><div>           . &quot;&lt;br /&gt;&lt;br /&gt;&quot;&nbsp;</div></li><li><div>           . str_replace( array('[link]', '[/link]'), array('&lt;a href=&quot;javascript:;&quot; class=&quot;wysija_dismiss_update_notice&quot;&gt;', '&lt;/a&gt;'), __(&quot;[link]Dismiss[/link] this notice.&quot;))&nbsp;</div></li><li><div> ), true, true);&nbsp;</div></li><li><div>}&nbsp;</div></li><li><div>&nbsp;</div></li><li><div><span class="comment">// launch application</span>&nbsp;</div></li><li><div>$helper = WYSIJA::get(WYSIJA_SIDE, 'helper');&nbsp;</div></li></ol></pre>.</p> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>file</li><li><span></span></li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2017 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer> <script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>