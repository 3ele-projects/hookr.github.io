<!DOCTYPE html> <!--[if lt IE 7]><html class="hookr class lt-ie9 lt-ie8 lt-ie7 ie"><![endif]--> <!--[if IE 7]><html class="hookr class lt-ie9 lt-ie8 ie7 ie"><![endif]--> <!--[if IE 8]><html class="hookr class lt-ie9 ie8 ie"><![endif]--> <!--[if IE 9]><html class="hookr class ie9 ie"><![endif]--> <!--[if gt IE 9]><html class="hookr class gt-ie9 ie"><![endif]--><html lang="en-US" id="single" class="hookr class" data-site="plugin" data-version="2.7.6" data-slug="mailpoet-newsletters" data-type="class" data-id="55730"><head xmlns="http://www.w3.org/1999/xhtml"><title> wysija_control_back_subscribers | class | Mailpoet Newsletters | hookr.io</title><meta charset="UTF-8"><meta name="author" content="thepassionofthechris \m/," /><meta name="keywords" content="WYSIJA_control_back_subscribers, class, plugin, mailpoet-newsletters, 2.7.6" /><meta name="description" content="The MailPoet Newsletters WYSIJA control back subscribers class." /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="shortcut icon" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.ico" /><link rel="icon" type="image/png" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.png"><link rel="icon" type="image/gif" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.gif"><link rel="icon" type="image/jpeg" href="http://hookr.io/wp-content/themes/hookr/assets/images/favicon.jpg"><meta name="google-site-verification" content="Q5dnl0YziNqRLCBxFtc2Rd8vUuueYAt6VIUYZItvEL4" /><script type="text/javascript">/*<![CDATA[*/window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/hookr.io\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.16"}};!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);/*]]>*/</script><style type="text/css">img.wp-smiley,img.emoji{display:inline !important;border:none !important;box-shadow:none !important;height:1em !important;width:1em !important;margin:0
.07em !important;vertical-align:-0.1em !important;background:none !important;padding:0
!important}</style><link rel='stylesheet' id='screen-css'  href='http://hookr.io/wp-content/themes/hookr/assets/css/hookr.css?ver=c56ac9ac4d391ed9ba047144b3435c6f' type='text/css' media='screen' /><link rel='stylesheet' id='qtip-css'  href='http://hookr.io/wp-content/themes/hookr/assets/vendor/jquery.qtip.custom/jquery.qtip.min.css?ver=4.4.16' type='text/css' media='screen' /><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fU9dGoIwDLsQW_XbHbyAXmCMAsNBsS2otxcYvqFP_UmaJg66x4T8LtzemD427BVtH4fiBC3RncGLoAp0AqWYRDS2lA4ZMw4VMZREKsp-NM46e14PlShpHJc_UwSsawz6R6CbURX38oNzDUwp3egSX1iZ3osif0PIhinVK3YQI9NsWNYRs6dAnCNt0zNWDW4OPw.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdTPzS8tTtXLzcwDAA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/fZBBDsIwDAQ_RG1Kn8AvuKWJUQ1JHBIXVF5PKOoFKZV8Gc_KK3nAmVHNWCBwPAxfKp4d5ZWPOIncM5pSSAve6jxmygskbyxN4mvwP_Sk6KRSSJ6vS9dDD6eNGkdXbu3hV9nUs7JvSpNqrzXK0uwFKyFJpKg7V3jPwZPp1XjDm7JYz2kUk10XTFHK6LgoXqo5b-YD.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9DPyM_PLtJPLC5OLSnWL0vNS8kv0s8qLE0tqtQrLMks0EsuLS7Jz0URys3MAwA.js"></script><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9YvzdRPTUtLTS7RzchMz8gB4hK93Mw8HQP9jPz87CL9xOLi1JJi_axiCF8vsSBTrzgzLz0nFQA.js"></script><link rel='https://api.w.org/' href='http://hookr.io/wp-json/' /><link rel="canonical" href="http://hookr.io/classes/wysija_control_back_subscribers/" /><link rel="alternate" type="application/json+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_control_back_subscribers%2F" /><link rel="alternate" type="text/xml+oembed" href="http://hookr.io/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhookr.io%2Fclasses%2Fwysija_control_back_subscribers%2F&#038;format=xml" /><script>/*<![CDATA[*/if('undefined'===typeof Hookr)
var Hookr={};if('undefined'===typeof Hookr.Util)
Hookr.Util={};Hookr.Util=jQuery&&jQuery.extend(Hookr.Util,{"adminAjax":"http:\/\/hookr.io\/wp-admin\/admin-ajax.php","themeUrl":"http:\/\/hookr.io\/wp-content\/themes\/hookr\/","apiKey":"plugin-mailpoet-newsletters-2.7.6-class-wysija_control_back_subscribers","actions":{"popover":0,"range":1,"search":2,"stat":3}});/*]]>*/</script><!--[if lt IE 9]><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv.js"></script><script src="http://hookr.io/wp-content/themes/hookr/assets/js/html5shiv-printshiv.js"></script><![endif]--></head><body id="wysija_control_back_subscribers" class="single single-class single-format-standard"><div id="gutter"><div><ul id="nav-breadcrumb" role="navigation" class="pivot clear fix"><li class="home"><a title="Go to hookr.io." href="http://hookr.io" class="home">hookr.io</a></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to plugins." href="http://hookr.io/plugins/" class=""><span property="name">plugins</span></a><meta property="position" content="2"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to mailpoet-newsletters." href="http://hookr.io/plugins/mailpoet-newsletters/" class="plugin"><span property="name">mailpoet-newsletters</span></a><meta property="position" content="3"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to 2.7.6." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/" class="H_VERSION"><span property="name">2.7.6</span></a><meta property="position" content="4"></span></li><li>/</li><li><span property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" title="Go to classes." href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/classes/" class=""><span property="name">classes</span></a><meta property="position" content="5"></span></li><li>/</li><li class="current_item"><span property="itemListElement" typeof="ListItem"><span property="name">wysija_control_back_subscribe&hellip;</span><meta property="position" content="6"></span></li></ul></div></div><header class="jv-fixed"><div> <button class="btn" data-jv-trigger="left"><span></span></button><h1 title="hookr.io"><a href="http://hookr.io" title="hookr.io"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/hookr.svg" title="The WordPress Hook/API Index" alt="The WordPress Hook/API Index"/></a></h1> <nav id="nav-api-types" class="pivot clearfix" data-jv-order="0" data-jv-content="left" data-active="class"><ul role="navigation"><li class="" data-id="all" data-count="598"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/all/" title="All">All <span class="count badge">598</span></a></li><li class="" data-id="new" data-count="0"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/new/" title="New">New <span class="count badge">0</span></a></li><li class="" data-id="hooks" data-count="208"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/hooks/" title="Hooks">Hooks <span class="count badge">208</span></a></li><li class="" data-id="action" data-count="60"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/actions/" title="Actions">Actions <span class="count badge">60</span></a></li><li class="" data-id="filter" data-count="148"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/filters/" title="Filters">Filters <span class="count badge">148</span></a></li><li class="active" data-id="class" data-count="264"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/classes/" title="Classes">Classes <span class="count badge">264</span></a></li><li class="" data-id="constant" data-count="104"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/constants/" title="Constants">Constants <span class="count badge">104</span></a></li><li class="" data-id="function" data-count="16"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/functions/" title="Functions">Functions <span class="count badge">16</span></a></li><li class="" data-id="shortcode" data-count="6"><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/shortcodes/" title="Shortcodes">Shortcodes <span class="count badge">6</span></a></li></ul> </nav> <nav id="nav-main" class="pivot" data-jv-order="1" data-jv-content="left"><ul role="navigation"><li class=""><a href="http://hookr.io/all/" title="Core">Core</a></li><li class="active"><a href="http://hookr.io/plugins/" title="Plugins">Plugins</a></li><li class=""><a href="http://hookr.io/themes/" title="Themes">Themes</a></li><li class=""><a href="http://hookr.io/features/" title="Features">Features</a></li><li class=""><a href="http://hookr.io/plugin/" title="Plugin">Plugin</a></li><li class=""><a href="http://hookr.io/about/" title="About">About</a></li><li class=""><a href="http://hookr.io/contact/" title="Contact">Contact</a></li></ul> </nav></div> </header><div role="main" id="middle"><div><div id="mainbar"> <article><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=hookrio" id="_carbonads_js"></script><noscript>derpy.</noscript> <section><h1><strong>WYSIJA_control_back_subscribers</strong></h1><p>The MailPoet Newsletters <strong>WYSIJA control back subscribers</strong> class.</p> </section> <section id="defined" class="source"><h2>Defined <span class="count">(4)</span></h2><p>The class is defined in the following location(s).</p><dl><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/files/controllers-ajax-subscribers/" class="file">/controllers/ajax/subscribers.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="4" class="block" start="4"><li><div>class WYSIJA_control_back_subscribers extends WYSIJA_control_front{&nbsp;</div></li><li><div>    var $model='user';&nbsp;</div></li><li><div>    var $view='';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>        $data=array();&nbsp;</div></li><li><div>        foreach($_REQUEST['data'] as $vals) {&nbsp;</div></li><li><div>            $data[esc_sql($vals['name'])]=esc_sql($vals['value']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(isset($data['message_success'])) {&nbsp;</div></li><li><div>            $this-&gt;messages['insert'][true]=$data['message_success'];&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;messages['insert'][true]=__('User has been inserted.', WYSIJA);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;messages['insert'][false]=__('User has not been inserted.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][true]=__('User has been updated.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][false]=__('User has not been updated.', WYSIJA);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save() {&nbsp;</div></li><li><div>        $datarequested=array();&nbsp;</div></li><li><div>        $i=0;&nbsp;</div></li><li><div>        foreach($_REQUEST['data'] as $vals) {&nbsp;</div></li><li><div>            if($vals['name']=='wysija[user_list][list_id][]') {&nbsp;</div></li><li><div>                $datarequested[str_replace('wysija[user_list][list_id][]', 'wysija[user_list][list_id]['.$i.']', esc_sql($vals['name']))]=esc_sql($vals['value']);&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            }else   $datarequested[esc_sql($vals['name'])]=esc_sql($vals['value']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data=$this-&gt;convertUserData($datarequested);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helperUser=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!$helperUser-&gt;checkData($data))return false;&nbsp;</div></li><li><div>        $helperUser-&gt;addSubscriber($data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // REFACTOR: Insanely complicated and inefficient&nbsp;</div></li><li><div>    function convertUserData($datarequested) {&nbsp;</div></li><li><div>        $data=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get the lists&nbsp;</div></li><li><div>        if(isset($datarequested['wysija[user_list][list_ids]'])) {&nbsp;</div></li><li><div>            $listids=explode(', ', $datarequested['wysija[user_list][list_ids]']);&nbsp;</div></li><li><div>            $subdate=time();&nbsp;</div></li><li><div>            unset($datarequested['wysija[user_list][list_ids]']);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $i=0;&nbsp;</div></li><li><div>            $listids=array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt;= 25; $i++) {&nbsp;</div></li><li><div>                $testkey='wysija[user_list][list_id]['.$i.']';&nbsp;</div></li><li><div>                if(isset($datarequested[$testkey])) $listids[]=$datarequested[$testkey];&nbsp;</div></li><li><div>                unset($datarequested[$testkey]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data['user_list']['list_ids']=$listids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // define array for custom user fields&nbsp;</div></li><li><div>        $data['user_field'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get the user info and the rest of the data posted&nbsp;</div></li><li><div>        foreach($datarequested as $key =&gt; $val) {&nbsp;</div></li><li><div>            if(strpos($key, 'wysija[user]')!== false) {&nbsp;</div></li><li><div>                $keymodified=str_replace(array('wysija[', '][', ']'), array('', '#', ''), $key);&nbsp;</div></li><li><div>                $keystabcol=explode('#', $keymodified);&nbsp;</div></li><li><div>                switch(count($keystabcol)) {&nbsp;</div></li><li><div>                    case 2:&nbsp;</div></li><li><div>                        $data[$keystabcol[0]][$keystabcol[1]]=$val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    case 3:&nbsp;</div></li><li><div>                        $data[$keystabcol[0]][$keystabcol[1]][$keystabcol[2]]=$val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else if(strpos($key, 'wysija[field]')!== false) {&nbsp;</div></li><li><div>                $keymodified=str_replace(array('wysija[', '][', ']'), array('', '#', ''), $key);&nbsp;</div></li><li><div>                $keystabcol=explode('#', $keymodified);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch(count($keystabcol)) {&nbsp;</div></li><li><div>                    case 2:&nbsp;</div></li><li><div>                        $data['user_field'][$keystabcol[1]] = $val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    case 3:&nbsp;</div></li><li><div>                        $data['user_field'][$keystabcol[1]][$keystabcol[2]] = $val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if(!isset($data[$key])) $data[$key]=$val;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function registerToLists($data, $uid) {&nbsp;</div></li><li><div>        $model=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>        if(isset($data['wysija[user_list][list_ids]'])) {&nbsp;</div></li><li><div>            $listids=explode(', ', $data['wysija[user_list][list_ids]']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subdate=time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $i=0;&nbsp;</div></li><li><div>            $listids=array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt;= 25; $i++) {&nbsp;</div></li><li><div>                $testkey='wysija[user_list][list_id]['.$i.']';&nbsp;</div></li><li><div>                if(isset($data[$testkey])) $listids[]=$data[$testkey];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //$listids=$data['wysija[user_list][list_id]'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach($listids as $listid) {&nbsp;</div></li><li><div>            $model-&gt;replace(array('list_id'=&gt;$listid, 'user_id'=&gt;$uid, 'sub_date'=&gt;$subdate));&nbsp;</div></li><li><div>            $model-&gt;reset();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/files/controllers-back-subscribers/" class="file">/controllers/back/subscribers.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="3" class="block" start="3"><li><div>class WYSIJA_control_back_subscribers extends WYSIJA_control_back{&nbsp;</div></li><li><div>    var $model='user';&nbsp;</div></li><li><div>    var $view='subscribers';&nbsp;</div></li><li><div>    var $list_columns=array('user_id', 'firstname', 'lastname', 'email', 'created_at');&nbsp;</div></li><li><div>    var $searchable=array('email', 'firstname', 'lastname');&nbsp;</div></li><li><div>    var $_separators = array(', ', ';'); // csv separator; comma is for standard csv, semi-colon is good for Excel&nbsp;</div></li><li><div>    var $_default_separator = ';';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Inactive users = users who never opened or clicked&nbsp;</div></li><li><div>     * @todo: disabled on 2.6. Once it's enabled, please double check in term of &quot;inactive users&quot;.&nbsp;</div></li><li><div>     * OR - users who never opened or clicked&nbsp;</div></li><li><div>     * OR - users who never opened or clicked AND received at least 1 newsletter.&nbsp;</div></li><li><div>     * @var boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $_filter_by_inactive_users = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        WYSIJA_control_back::__construct();&nbsp;</div></li><li><div>        if ($this-&gt;_filter_by_inactive_users) {&nbsp;</div></li><li><div>                        // load the inactive subscribers on the listing and when a any bulk action is executed&nbsp;</div></li><li><div>                        if (    empty($_REQUEST['action'])&nbsp;</div></li><li><div>                                ||&nbsp;</div></li><li><div>                                (       !empty($_REQUEST['action'])&nbsp;</div></li><li><div>                                        &&&nbsp;</div></li><li><div>                                        ( in_array($_REQUEST['action'], array('export_get', 'exportlist', 'deleteusers'))&nbsp;</div></li><li><div>                                        ||&nbsp;</div></li><li><div>                                        substr($_REQUEST['action'], 0, 10)=='actionvar_')&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $this-&gt;modelObj-&gt;prepare_inactive_users_table();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;wpdb = $wpdb;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * common task to all the list actions&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _commonlists() {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        $this-&gt;data['list']=$this-&gt;_getLists(10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>     * We are using the same form for different purposes:&nbsp;</div></li><li><div>     * - Bulk actions&nbsp;</div></li><li><div>     * - Filter by list&nbsp;</div></li><li><div>     * We need to remove all un-necessary values from interface&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _cleanup_form() {&nbsp;</div></li><li><div>    if (!empty($_REQUEST['doaction'])) {&nbsp;</div></li><li><div>        $action_type = strtolower(trim($_REQUEST['doaction']));&nbsp;</div></li><li><div>        switch ($action_type)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>        // Filter by list&nbsp;</div></li><li><div>        case 'filter':&nbsp;</div></li><li><div>            if (!empty($_REQUEST['wysija']['user']))&nbsp;</div></li><li><div>            unset($_REQUEST['wysija']['user']);&nbsp;</div></li><li><div>            if (!empty($_REQUEST['action']))&nbsp;</div></li><li><div>            unset($_REQUEST['action']);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        // Bulk action. Nothing to do, because we will invoke _tryAction() directly right after this step&nbsp;</div></li><li><div>        case 'apply':&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _getLists($limit=false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;escapingOn=true;&nbsp;</div></li><li><div>        $model_list-&gt;_limitison=$limit;&nbsp;</div></li><li><div>        return $model_list-&gt;getLists();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _getForm($id=false) {&nbsp;</div></li><li><div>        if($id) {&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $model_list-&gt;get_one_list($id);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $array=array('name'=&gt;'', 'list_id'=&gt;'', 'description'=&gt;'', 'is_public'=&gt;true, 'is_enabled'=&gt;true);&nbsp;</div></li><li><div>            return $array;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>     * Get selected lists&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _get_selected_lists() {&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>        if (isset($_REQUEST['wysija']['filter']['filter_list'])) {&nbsp;</div></li><li><div>            $result[] = $_REQUEST['wysija']['filter']['filter_list'];&nbsp;</div></li><li><div>        } elseif (!empty($_REQUEST['filter-list'])) {&nbsp;</div></li><li><div>            $lists = explode(', ', trim($_REQUEST['filter-list']));// currently, only single list is allowed.&nbsp;</div></li><li><div>            if (!empty($lists)) {&nbsp;</div></li><li><div>                $result = array_merge ($result, $lists);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save() {&nbsp;</div></li><li><div>        $this-&gt;redirectAfterSave=false;&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if( isset( $_REQUEST['id'] ) ) {&nbsp;</div></li><li><div>            $id = $_REQUEST['id'];&nbsp;</div></li><li><div>            parent::save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //run the unsubscribe process if needed&nbsp;</div></li><li><div>            if((int)$_REQUEST['wysija']['user']['status']==-1) {&nbsp;</div></li><li><div>                $helper_user-&gt;unsubscribe($id);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** update subscriptions */&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $model_user_list-&gt;backSave=true;&nbsp;</div></li><li><div>            /** list of core list */&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>            $results = $model_list-&gt;get(array('list_id'), array('is_enabled'=&gt;'0'));&nbsp;</div></li><li><div>            $core_listids = array();&nbsp;</div></li><li><div>            foreach($results as $res) {&nbsp;</div></li><li><div>                $core_listids[]=$res['list_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //0 - get current lists of the user&nbsp;</div></li><li><div>            $userlists = $model_user_list-&gt;get(array('list_id', 'unsub_date'), array('user_id'=&gt;$id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $oldlistids=$newlistids=array();&nbsp;</div></li><li><div>            foreach($userlists as $listdata)    $oldlistids[$listdata['list_id']]=$listdata['unsub_date'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>            $dbloptin = $model_config-&gt;getValue('confirm_dbleoptin');&nbsp;</div></li><li><div>            //1 - insert new user_list&nbsp;</div></li><li><div>            if(isset($_POST['wysija']['user_list']) && $_POST['wysija']['user_list']) {&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('sub_date'=&gt;time()), array('user_id'=&gt;$id));&nbsp;</div></li><li><div>                if(!empty($_POST['wysija']['user_list']['list_id'])) {&nbsp;</div></li><li><div>                    foreach($_POST['wysija']['user_list']['list_id'] as $list_id) {&nbsp;</div></li><li><div>                        //if the list is not already recorded for the user then we will need to insert it&nbsp;</div></li><li><div>                        if(!isset($oldlistids[$list_id])) {&nbsp;</div></li><li><div>                            $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                            $newlistids[]=$list_id;&nbsp;</div></li><li><div>                            $dataul=array('user_id'=&gt;$id, 'list_id'=&gt;$list_id, 'sub_date'=&gt;time());&nbsp;</div></li><li><div>                            //if double optin is on and user is unconfirmed or unsubscribed, then we need to set it as unconfirmed subscription&nbsp;</div></li><li><div>                            if($dbloptin && (int)$_POST['wysija']['user']['status']&lt;1)  unset($dataul['sub_date']);&nbsp;</div></li><li><div>                            $model_user_list-&gt;insert($dataul);&nbsp;</div></li><li><div>                        //if the list is recorded already then let's check the status, if it is an unsubed one then we update it&nbsp;</div></li><li><div>                        }else{&nbsp;</div></li><li><div>                            if($oldlistids[$list_id]&gt;0) {&nbsp;</div></li><li><div>                                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                                $model_user_list-&gt;update(array('unsub_date'=&gt;0, 'sub_date'=&gt;time()), array('user_id'=&gt;$id, 'list_id'=&gt;$list_id));&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                // if no list is selected we unsubscribe them all&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date'=&gt;time(), 'sub_date'=&gt;0), array('user_id'=&gt;$id));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if a confirmation email needs to be sent then we send it&nbsp;</div></li><li><div>            if($dbloptin && (int)$_POST['wysija']['user']['status']==0 && !empty($newlistids)) {&nbsp;</div></li><li><div>                $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>                $helper_user-&gt;sendConfirmationEmail($id, true, $newlistids);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if((int)$_POST['wysija']['user']['status']==0 || (int)$_POST['wysija']['user']['status']==1) {&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date'=&gt;0, 'sub_date'=&gt;time()), array('user_id'=&gt;$id, 'list_id'=&gt;$core_listids));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $arrayLists=array();&nbsp;</div></li><li><div>            if(isset($_POST['wysija']['user_list']['list_id'])) $arrayLists=$_POST['wysija']['user_list']['list_id'];&nbsp;</div></li><li><div>            $notEqual=array_merge($core_listids, $arrayLists);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //unsubscribe from lists which exist in the old list but does not exist in the new list&nbsp;</div></li><li><div>            $unsubsribe_list = array_diff(array_keys($oldlistids), $arrayLists);&nbsp;</div></li><li><div>            if(!empty($unsubsribe_list))&nbsp;</div></li><li><div>            {&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date'=&gt;time()), array('user_id'=&gt;$id, 'list_id'=&gt;$unsubsribe_list));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $model_user_list-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>            Custom Fields.&nbsp;</div></li><li><div>            */&nbsp;</div></li><li><div>            if (isset($_POST['wysija']['field'])) {&nbsp;</div></li><li><div>              WJ_FieldHandler::handle_all(&nbsp;</div></li><li><div>                $_POST['wysija']['field'], $id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            //instead of going through a classic save we should save through the helper&nbsp;</div></li><li><div>            $data=$_REQUEST['wysija'];&nbsp;</div></li><li><div>            $data['user_list']['list_ids'] = !empty($data['user_list']['list_id']) ? $data['user_list']['list_id'] : array();&nbsp;</div></li><li><div>            unset($data['user_list']['list_id']);&nbsp;</div></li><li><div>            $data['message_success']=__('Subscriber has been saved.', WYSIJA);&nbsp;</div></li><li><div>            $id=$helper_user-&gt;addSubscriber($data, true);&nbsp;</div></li><li><div>            if(!$id) {&nbsp;</div></li><li><div>                $this-&gt;viewShow=$this-&gt;action='add';&nbsp;</div></li><li><div>                $data=array('details'=&gt;$_REQUEST['wysija']['user']);&nbsp;</div></li><li><div>                return $this-&gt;add($data);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if(isset($_POST['wysija']['field'])) {&nbsp;</div></li><li><div>                    WJ_FieldHandler::handle_all($_POST['wysija']['field'], $id);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function defaultDisplay() {&nbsp;</div></li><li><div>        $this-&gt;viewShow=$this-&gt;action='main';&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-admin-list';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;msgPerPage = __('Subscribers per page:', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['selecmiss'] = __('Select at least 1 subscriber!', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get the total count for subscribed, unsubscribed and unconfirmed users&nbsp;</div></li><li><div>        $select = array( 'COUNT(`user_id`) AS users' , 'status' , 'MAX(`created_at`) AS `max_create_at`');&nbsp;</div></li><li><div>        $count_group_by = 'status';&nbsp;</div></li><li><div>        $count_by_status = $this-&gt;modelObj-&gt;get_subscribers( $select , array() , $count_group_by );&nbsp;</div></li><li><div>    if ($this-&gt;_filter_by_inactive_users) {&nbsp;</div></li><li><div>        $inactive_users = $this-&gt;modelObj-&gt;count_inactive_users();&nbsp;</div></li><li><div>        if ($inactive_users) {&nbsp;</div></li><li><div>        array_unshift($count_by_status, array(&nbsp;</div></li><li><div>            'users' =&gt; $inactive_users['count'], &nbsp;</div></li><li><div>            'status' =&gt; -99, //-99 = inactive&nbsp;</div></li><li><div>            'max_create_at' =&gt; $inactive_users['max_created_at']&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $counts = $this-&gt;modelObj-&gt;structure_user_status_count_array($count_by_status);&nbsp;</div></li><li><div>        $arr_max_create_at = $this-&gt;modelObj-&gt;get_max_create($count_by_status);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // count the rows based on the filters&nbsp;</div></li><li><div>        $filters = $this-&gt;modelObj-&gt;detect_filters();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $select = array( 'COUNT(DISTINCT([wysija]user.user_id)) as total_users', 'MAX([wysija]user.created_at) as max_create_at');&nbsp;</div></li><li><div>        $count_rows = $this-&gt;modelObj-&gt;get_subscribers( $select, $filters);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // without filter we already have the total number of subscribers&nbsp;</div></li><li><div>        $this-&gt;data['max_create_at'] = null; //max value of create_at field of current list of users&nbsp;</div></li><li><div>        if(!empty($filters)) {&nbsp;</div></li><li><div>            // used for pagination&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;countRows = $count_rows['total_users'];&nbsp;</div></li><li><div>            // used for&nbsp;</div></li><li><div>            $this-&gt;data['max_create_at'] = $count_rows['max_create_at'];&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;data['max_create_at'] = !empty($arr_max_create_at) ? max($arr_max_create_at) : 0;&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;countRows=$counts['all'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $select = array(&nbsp;</div></li><li><div>        '[wysija]user.firstname', &nbsp;</div></li><li><div>        '[wysija]user.lastname', &nbsp;</div></li><li><div>        '[wysija]user.status', &nbsp;</div></li><li><div>        '[wysija]user.email', &nbsp;</div></li><li><div>        '[wysija]user.created_at', &nbsp;</div></li><li><div>        '[wysija]user.last_opened', &nbsp;</div></li><li><div>        '[wysija]user.last_clicked', &nbsp;</div></li><li><div>        '[wysija]user_list.user_id'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['subscribers'] = $this-&gt;modelObj-&gt;get_subscribers($select , $filters, '', false, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['current_counts'] = $this-&gt;modelObj-&gt;countRows;&nbsp;</div></li><li><div>        $this-&gt;data['show_batch_select'] = ($this-&gt;modelObj-&gt;limit &gt;= $this-&gt;modelObj-&gt;countRows) ? false : true;&nbsp;</div></li><li><div>        $this-&gt;data['selected_lists'] = $this-&gt;_get_selected_lists();&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make the data object for the listing view&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $lists_db = $model_list-&gt;getLists();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lists=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($lists_db as $listobj) {&nbsp;</div></li><li><div>            $lists[$listobj['list_id']]=$listobj;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_ids=array();&nbsp;</div></li><li><div>        foreach($this-&gt;data['subscribers'] as $subscriber) {&nbsp;</div></li><li><div>            $user_ids[]=$subscriber['user_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 3 - user_list request&nbsp;</div></li><li><div>        if($user_ids) {&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $userlists=$model_user_list-&gt;get(array('list_id', 'user_id', 'unsub_date'), array('user_id'=&gt;$user_ids));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['lists']=$lists;&nbsp;</div></li><li><div>        $this-&gt;data['counts']=array_reverse($counts);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // regrouping all the data in the same array&nbsp;</div></li><li><div>       foreach($this-&gt;data['subscribers'] as $keysus=&gt;$subscriber) {&nbsp;</div></li><li><div>            // default key while we don't have the data&nbsp;</div></li><li><div>            //TODO add data for stats about emails opened clicked etc&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus]['emails']=0;&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus]['opened']=0;&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus]['clicked']=0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($userlists) {&nbsp;</div></li><li><div>                foreach($userlists as $key=&gt;$userlist) {&nbsp;</div></li><li><div>                    if($subscriber['user_id']==$userlist['user_id'] && isset($lists[$userlist['list_id']])) {&nbsp;</div></li><li><div>                        //what kind of list ist it ? unsubscribed ? or not&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if($userlist['unsub_date']&gt;0) {&nbsp;</div></li><li><div>                            if(!isset($this-&gt;data['subscribers'][$keysus]['unsub_lists']) ) {&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['unsub_lists']=$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }else{&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['unsub_lists'].=', '.$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                       }else{&nbsp;</div></li><li><div>                            if(!isset($this-&gt;data['subscribers'][$keysus]['lists']) ) {&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['lists']=$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }else{&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['lists'].=', '.$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(!$this-&gt;data['subscribers']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('Yikes! Couldn\'t find any subscribers.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function main() {&nbsp;</div></li><li><div>        $this-&gt;messages['insert'][true]=__('Subscriber has been saved.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['insert'][false]=__('Subscriber has not been saved.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][true]=__('Subscriber has been modified. [link]Edit again[/link].', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][false]=__('Subscriber has not been modified.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;_cleanup_form();&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //we change the default model of the controller based on the action&nbsp;</div></li><li><div>        if(isset($_REQUEST['action'])) {&nbsp;</div></li><li><div>            switch($_REQUEST['action']) {&nbsp;</div></li><li><div>                case 'listsedit':&nbsp;</div></li><li><div>                case 'savelist':&nbsp;</div></li><li><div>                case 'lists':&nbsp;</div></li><li><div>                    $this-&gt;model='list';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    $this-&gt;model='user';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        WYSIJA_control::__construct();&nbsp;</div></li><li><div>        if(!isset($_REQUEST['action']) || !$_REQUEST['action']) {&nbsp;</div></li><li><div>            $this-&gt;defaultDisplay();&nbsp;</div></li><li><div>            $this-&gt;checkTotalSubscribers();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;_tryAction($_REQUEST['action']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * bulk action copy to list&nbsp;</div></li><li><div>     * @global type $wpdb&nbsp;</div></li><li><div>     * @param type $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function copytolist($data) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(empty($this-&gt;_batch_select))&nbsp;</div></li><li><div>            $helper_user -&gt;addToList($data['listid'], $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $helper_user -&gt;addToList($data['listid'], $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $result = $model_list-&gt;getOne(array('name'), array('list_id'=&gt;$data['listid']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1)&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been added to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been added to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Moves subscriber to another list.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $data List id to move, $data = array('listid' =&gt; 1);&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function movetolist($data) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;moveToList($data['listid'], $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        } elseif (isset($_POST['wysija']['user']['user_id'])) {&nbsp;</div></li><li><div>            $helper_user-&gt;moveToList($data['listid'], $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $result = $model_list-&gt;getOne(array('name'), array('list_id' =&gt; $data['listid']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been moved to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been moved to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * After performing a bulk action, let's keep the current list filter&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function redirect_after_bulk_action() {&nbsp;</div></li><li><div>        $filter_list = !empty($_REQUEST['wysija']['filter']['filter_list']) ? $_REQUEST['wysija']['filter']['filter_list'] : 0;&nbsp;</div></li><li><div>        if (empty($filter_list)) {// view all lists&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers');&nbsp;</div></li><li><div>        } elseif (is_numeric($filter_list)) {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&filter-list='.$filter_list);&nbsp;</div></li><li><div>        } else {// subscribers in no list&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&filter-list=orphaned');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action remove subscribers from all existing lists&nbsp;</div></li><li><div>     * @param type $data = array('list_id'=&gt;?)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function removefromalllists($data) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select))&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array(), $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array(), $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1)&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been removed from all existing lists.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been removed from all existing lists.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action remove subscribers from all existing lists&nbsp;</div></li><li><div>     * @param type $data = array('list_id'=&gt;?)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function removefromlist($data = array()) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array($data['listid']), $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array($data['listid']), $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $result = $model_list-&gt;getOne(array('name'), array('list_id'=&gt;$data['listid']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been removed from &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been removed from &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk confirm users&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function confirmusers() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;confirmUsers($this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $helper_user-&gt;confirmUsers($_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been confirmed.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>           $this-&gt;notice(sprintf(__('%1$s subscriber have been confirmed.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk resend confirmation emails&nbsp;</div></li><li><div>     * Maximum emails to be sent is 100, and only send to unconfirmed subscribers, of coruse.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function resendconfirmationemail() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $user_ids = array();&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>            $users = $model_user-&gt;get_results($this-&gt;_batch_select['query'] . ' LIMIT 0, 100');&nbsp;</div></li><li><div>            if (!empty($users)) {&nbsp;</div></li><li><div>                foreach ($users as $user) {&nbsp;</div></li><li><div>                    $user_ids[] = $user['user_id'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $user_ids = array_filter($_POST['wysija']['user']['user_id'], 'ctype_digit');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sending_statuses = array();// array(user_id =&gt; 1/0)&nbsp;</div></li><li><div>        if (!empty($user_ids)) {&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $user_lists = $model_user_list-&gt;get_lists($user_ids);&nbsp;</div></li><li><div>            if (!empty($user_lists)) {&nbsp;</div></li><li><div>                foreach ($user_lists as $user_id =&gt; $lists) {&nbsp;</div></li><li><div>                    $sending_statuses[$user_id] = $helper_user-&gt;sendConfirmationEmail($user_id, true, $lists);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $success_sending_number = count(array_values($sending_statuses));&nbsp;</div></li><li><div>        if ($success_sending_number &lt;= 0) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('No email sent.', WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>                        $this-&gt;notice( sprintf(_n( 'One email has been sent.', '%d emails have been sent to unconfirmed subscribers.', (int)$success_sending_number, WYSIJA ), $success_sending_number ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function lists() {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-admin-list';&nbsp;</div></li><li><div>        $this-&gt;_commonlists();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj=WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Edit lists', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;countRows=$this-&gt;modelObj-&gt;count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;model=$this-&gt;modelObj;&nbsp;</div></li><li><div>        $this-&gt;data['form']=$this-&gt;_getForm();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function editlist() {&nbsp;</div></li><li><div>        $this-&gt;_commonlists();&nbsp;</div></li><li><div>        $this-&gt;data['form']=$this-&gt;_getForm($_REQUEST['id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=sprintf(__('Editing list %1$s', WYSIJA), '&lt;b&gt;&lt;i&gt;'.$this-&gt;data['form']['name'].'&lt;/i&gt;&lt;/b&gt;');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function addlist() {&nbsp;</div></li><li><div>        $this-&gt;_commonlists();&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('How about a new list?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;data['form']=$this-&gt;_getForm();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function duplicatelist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        /** get the list's email id&nbsp;</div></li><li><div>         * 0 duplicate the list's welcome email&nbsp;</div></li><li><div>         * 1 duplicate the list&nbsp;</div></li><li><div>         * 2 duplicate the list's subscribers&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $data=$model_list-&gt;getOne(array('name', 'namekey', 'welcome_mail_id', 'unsub_mail_id'), array('list_id'=&gt;(int)$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query='INSERT INTO `[wysija]list` (`created_at`, `name`, `namekey`, `description`, `welcome_mail_id`, `unsub_mail_id`, `is_enabled`, `ordering`)&nbsp;</div></li><li><div>            SELECT '.time().', concat(&quot;' . $this-&gt;wpdb-&gt;_real_escape( __( 'Copy of ', WYSIJA ) ) . '&quot;, `name`) , &quot;copy_'.$data['namekey'].time().'&quot; , `description`, 0, 0 , 1, `ordering` FROM [wysija]list&nbsp;</div></li><li><div>            WHERE list_id='.(int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $list_id = $model_list-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query='INSERT INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`, `unsub_date`)&nbsp;</div></li><li><div>            SELECT '.$list_id .', `user_id`, `sub_date`, `unsub_date` FROM [wysija]user_list&nbsp;</div></li><li><div>            WHERE list_id='.(int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(sprintf(__('List &quot;%1$s&quot; has been duplicated.', WYSIJA), $data['name']));&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add($data=false) {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;add=true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;title=$this-&gt;viewObj-&gt;title=__('Add Subscriber', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        $this-&gt;data['user']=false;&nbsp;</div></li><li><div>        if($data)$this-&gt;data['user']=$data;&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;limitON=false;&nbsp;</div></li><li><div>        $this-&gt;data['list'] = $model_list-&gt;get(false, array('greater'=&gt;array('is_enabled'=&gt;'0') ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function back() {&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function backtolist() {&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function edit($id=false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($_REQUEST['id']) && empty($id)) {&nbsp;</div></li><li><div>            $this-&gt;error('Cannot edit element primary key is missing : '. get_class($this));&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$id) $id=$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get detail info of current user&nbsp;</div></li><li><div>        $this-&gt;data['user']=$this-&gt;modelObj-&gt;getDetails(array('user_id'=&gt;$id));&nbsp;</div></li><li><div>        if(!$this-&gt;data['user']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('No subscriber found, most probably because he was deleted.', WYSIJA));&nbsp;</div></li><li><div>            return $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get list info&nbsp;</div></li><li><div>        $model_list=WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;limitON=false;&nbsp;</div></li><li><div>        $model_list-&gt;orderBy('is_enabled', 'DESC');&nbsp;</div></li><li><div>        $this-&gt;data['list']=$model_list-&gt;get(false, array('greater'=&gt;array('is_enabled'=&gt;'-1') ));&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Edit', WYSIJA).' '.$this-&gt;data['user']['details']['email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // execute hooks&nbsp;</div></li><li><div>        $hook_params = array(&nbsp;</div></li><li><div>            'user_id' =&gt; $id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    $this-&gt;data['hooks']['hook_subscriber_left'] = apply_filters('hook_subscriber_left', WYSIJA_module::execute_hook('hook_subscriber_left', $hook_params), $hook_params);&nbsp;</div></li><li><div>    $this-&gt;data['hooks']['hook_subscriber_right'] = apply_filters('hook_subscriber_right', WYSIJA_module::execute_hook('hook_subscriber_right', $hook_params), $hook_params);&nbsp;</div></li><li><div>    $this-&gt;data['hooks']['hook_subscriber_bottom'] = apply_filters('hook_subscriber_bottom', WYSIJA_module::execute_hook('hook_subscriber_bottom', $hook_params), $hook_params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // prepare js, for rendering&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function deletelist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** get the list's email id&nbsp;</div></li><li><div>         * 0 delete the welcome email corresponding to that list&nbsp;</div></li><li><div>         * 1 delete the list subscribers reference&nbsp;</div></li><li><div>         * 2 delete the list campaigns references&nbsp;</div></li><li><div>         * 4 delete the list&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $model_list=WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $data=$model_list-&gt;getOne(array('name', 'namekey', 'welcome_mail_id'), array('list_id'=&gt;(int)$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($data && isset($data['namekey']) && ($data['namekey']!='users')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //there is no welcome email per list that's old stuff&nbsp;</div></li><li><div>            $model_user_list=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $model_user_list-&gt;delete(array('list_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_campaign_list=WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>            $model_campaign_list-&gt;delete(array('list_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_list-&gt;reset();&nbsp;</div></li><li><div>            $model_list-&gt;delete(array('list_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('List &quot;%1$s&quot; has been deleted.', WYSIJA), $data['name']));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;error(__('The list does not exists or cannot be deleted.', WYSIJA), true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function synchlist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $helper_user-&gt;synchList($_REQUEST['id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function synchlisttotal() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(is_multisite() && is_super_admin( $current_user-&gt;ID )) {&nbsp;</div></li><li><div>            $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>            $helper_user-&gt;synchList($_REQUEST['id'], true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function savelist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;_resetGlobMsg();&nbsp;</div></li><li><div>        $update=false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($_REQUEST['wysija']['list']['list_id']) {&nbsp;</div></li><li><div>            $update=true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        /** save the result */&nbsp;</div></li><li><div>        /** 1-save the welcome email*/&nbsp;</div></li><li><div>        /** 2-save the list*/&nbsp;</div></li><li><div>        if(isset($_REQUEST['wysija']['list']['is_public'])) {&nbsp;</div></li><li><div>            if($_REQUEST['wysija']['list']['is_public']=='on') {&nbsp;</div></li><li><div>                $_REQUEST['wysija']['list']['is_public']=1;&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $_REQUEST['wysija']['list']['is_public']=0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($update) {&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;update($_REQUEST['wysija']['list']);&nbsp;</div></li><li><div>            $this-&gt;notice(__('List has been updated.', WYSIJA));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $_REQUEST['wysija']['list']['created_at']=time();&nbsp;</div></li><li><div>            $_REQUEST['wysija']['list']['is_enabled']=1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;insert($_REQUEST['wysija']['list']);&nbsp;</div></li><li><div>            $this-&gt;notice(__('Your brand-new list awaits its first subscriber.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function importpluginsave($id=false) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;_resetGlobMsg();&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $helper_import = WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>        $plugins_importable=$model_config-&gt;getValue('pluginsImportableEgg');&nbsp;</div></li><li><div>        $plugins_imported=array();&nbsp;</div></li><li><div>        foreach($_REQUEST['wysija']['import'] as $table_name =&gt;$result) {&nbsp;</div></li><li><div>            $connection_info=$helper_import-&gt;getPluginsInfo($table_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($result) {&nbsp;</div></li><li><div>                $plugins_imported[]=$table_name;&nbsp;</div></li><li><div>                if(!$connection_info) $connection_info=$plugins_importable[$table_name];&nbsp;</div></li><li><div>                $helper_import-&gt;import($table_name, $connection_info);&nbsp;</div></li><li><div>                sleep(2);&nbsp;</div></li><li><div>                $this-&gt;notice(sprintf(__('Import from plugin %1$s has been completed.', WYSIJA), &quot;&lt;strong&gt;'&quot;.$connection_info['name'].&quot;'&lt;/strong&gt;&quot;));&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $this-&gt;notice(sprintf(__('Import from plugin %1$s has been cancelled.', WYSIJA), &quot;&lt;strong&gt;'&quot;.$connection_info['name'].&quot;'&lt;/strong&gt;&quot;));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config-&gt;save(array('pluginsImportedEgg'=&gt;$plugins_imported));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function importplugins($id=false) {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Import subscribers from plugins', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        $this-&gt;data['plugins']=$model_config-&gt;getValue('pluginsImportableEgg');&nbsp;</div></li><li><div>        $imported_plugins=$model_config-&gt;getValue('pluginsImportedEgg');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($imported_plugins) {&nbsp;</div></li><li><div>            foreach($imported_plugins as $tablename) {&nbsp;</div></li><li><div>                unset( $this-&gt;data['plugins'][$tablename]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$this-&gt;data['plugins']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('There is no plugin to import from.', WYSIJA));&nbsp;</div></li><li><div>            return $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;viewShow='importplugins';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function import($id=false) {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Import Subscribers', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow='import';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function importmatch() {&nbsp;</div></li><li><div>    $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;jsTrans['subscribers_import_match_confirmation_1'] = __('The selected value is already matched to another column.', WYSIJA);&nbsp;</div></li><li><div>    $this-&gt;jsTrans['subscribers_import_match_confirmation_2'] = __('Can you confirm that this column is corresponding to that field?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-validator';&nbsp;</div></li><li><div>        $helper_numbers = WYSIJA::get('numbers', 'helper');&nbsp;</div></li><li><div>        $bytes = $helper_numbers-&gt;get_max_file_upload();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_SERVER['CONTENT_LENGTH']) && $_SERVER['CONTENT_LENGTH']&gt;$bytes['maxbytes']) {&nbsp;</div></li><li><div>            if(isset($_FILES['importfile']['name']) && $_FILES['importfile']['name']) {&nbsp;</div></li><li><div>                $file_name = $_FILES['importfile']['name'];&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $file_name = __('which you have pasted', WYSIJA);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;error(sprintf(__('Upload error, file %1$s is too large! (MAX:%2$s)', WYSIJA) , $file_name , $bytes['maxmegas']), true);&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&action=import');&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $import = new WJ_Import();&nbsp;</div></li><li><div>        $this-&gt;data = $import-&gt;scan_csv_file();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;data === false) {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&action=import');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $this-&gt;jsTrans['userStatuses'] = array(&nbsp;</div></li><li><div>                -1 =&gt; __('Unsubscribed', WYSIJA), &nbsp;</div></li><li><div>                0 =&gt; $model_config-&gt;getValue('confirm_dbleoptin') ? __('Unconfirmed', WYSIJA) : __('Subscribed', WYSIJA), &nbsp;</div></li><li><div>                1 =&gt; __('Subscribed', WYSIJA)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-import-match';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Import Subscribers', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow='importmatch';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function import_save() {&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;_resetGlobMsg();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //we need to save a new list in that situation&nbsp;</div></li><li><div>        if(!empty($_REQUEST['wysija']['list']['newlistname'])) {&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>            $data_list = array();&nbsp;</div></li><li><div>            $data_list['is_enabled'] = 1;&nbsp;</div></li><li><div>            $data_list['name'] = $_REQUEST['wysija']['list']['newlistname'];&nbsp;</div></li><li><div>            $_REQUEST['wysija']['user_list']['list'][] = $model_list-&gt;insert($data_list);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if there is no list selected, we return to the same form prompting the user to take action&nbsp;</div></li><li><div>        if(!isset($_REQUEST['wysija']['user_list']['list']) || !$_REQUEST['wysija']['user_list']['list']) {&nbsp;</div></li><li><div>            $this-&gt;error(__('You need to select at least one list.', WYSIJA), true);&nbsp;</div></li><li><div>            return $this-&gt;importmatch();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $import = new WJ_Import();&nbsp;</div></li><li><div>        $data_numbers = $import-&gt;import_subscribers();&nbsp;</div></li><li><div>        $duplicate_emails_count = $import-&gt;get_duplicate_emails_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($data_numbers === false) {&nbsp;</div></li><li><div>            return $this-&gt;redirect('admin.php?page=wysija_subscribers&action=import');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get a list of list name&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $results = $model_list-&gt;get(array('name'), array('list_id'=&gt;$_REQUEST['wysija']['user_list']['list']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $list_names=array();&nbsp;</div></li><li><div>        foreach($results as $k =&gt;$v) {&nbsp;</div></li><li><div>            $list_names[]=$v['name'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice( sprintf(__('%1$s subscribers added to %2$s.', WYSIJA), &nbsp;</div></li><li><div>                    $data_numbers['list_user_ids'], &nbsp;</div></li><li><div>                    '&quot;'.implode('&quot;, &quot;', $list_names).'&quot;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(count($duplicate_emails_count)&gt;0) {&nbsp;</div></li><li><div>            $list_emails = '';&nbsp;</div></li><li><div>            $i = 0;&nbsp;</div></li><li><div>            foreach($duplicate_emails_count as $email_address =&gt; $occurences) {&nbsp;</div></li><li><div>                if( $i &gt; 0 )$list_emails.=', ';&nbsp;</div></li><li><div>                $list_emails.= $email_address.' ('.$occurences.')';&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //$emailsalreadyinserted=array_keys($emailsCount);&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s emails appear more than once in your file : %2$s.', WYSIJA), count($duplicate_emails_count), $list_emails), 0);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(count($data_numbers['invalid'])&gt;0) {&nbsp;</div></li><li><div>            $string = sprintf(__('%1$s emails are not valid : %2$s.', WYSIJA), count($data_numbers['invalid']), utf8_encode(implode(', ', $data_numbers['invalid'])));&nbsp;</div></li><li><div>            $this-&gt;notice($string, 0);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function export() {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Export Subscribers', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        //$this-&gt;data['lists']=$this-&gt;_getLists();&nbsp;</div></li><li><div>        $this-&gt;data['lists'] = $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $lists_results = $model_list-&gt;getLists();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lists=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($lists_results as $list_row) {&nbsp;</div></li><li><div>            $lists[$list_row['list_id']]=$list_row;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;data['lists']=$lists;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewShow='export';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function exportcampaign() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['file_name'])) {&nbsp;</div></li><li><div>            $file_name = preg_replace('#[^a-z0-9_\-.]#i', '', base64_decode($_REQUEST['file_name']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>            $exported_file_link = $helper_file-&gt;url($file_name, 'temp');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $content = file_get_contents( $exported_file_link );&nbsp;</div></li><li><div>            $user_ids=explode(&quot;, &quot;, $content);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $_REQUEST['wysija']['user']['user_id']=$user_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;exportlist();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * bulk delete option&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function deleteusers() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;delete($this-&gt;_batch_select, false, true);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $helper_user-&gt;delete($_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__(' %1$s subscribers have been deleted.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__(' %1$s subscriber have been deleted.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make sure the total count of subscribers is updated&nbsp;</div></li><li><div>        $helper_user-&gt;refreshUsers();&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>     /**&nbsp;</div></li><li><div>     * function generating an export file based on an array of user_ids&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function export_get() {&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $export = new WJ_Export();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $export-&gt;batch_select = $this-&gt;_batch_select;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file_path_result = $export-&gt;export_subscribers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(str_replace(&nbsp;</div></li><li><div>                array('[link]', '[/link]'), &nbsp;</div></li><li><div>                array('&lt;a href=&quot;'.$file_path_result['url'].'&quot; target=&quot;_blank&quot; class=&quot;exported-file&quot; &gt;', '&lt;/a&gt;'), &nbsp;</div></li><li><div>                sprintf(__('%1$s subscribers were exported. Get the exported file [link]here[/link].', WYSIJA), $export-&gt;get_user_ids_rows())));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['camp_id'])) {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns&action=viewstats&id='.$_REQUEST['camp_id']);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function exportlist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        if(!empty($_REQUEST['wysija']['user']['force_select_all'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $select = array( 'COUNT(DISTINCT([wysija]user.user_id)) as total_users');&nbsp;</div></li><li><div>            if(!empty($_REQUEST['wysija']['filter']['filter_list'])) {&nbsp;</div></li><li><div>                $select[] =  '[wysija]user_list.list_id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // filters for unsubscribed&nbsp;</div></li><li><div>            $filters = $this-&gt;modelObj-&gt;detect_filters();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $count = $this-&gt;modelObj-&gt;get_subscribers( $select, $filters );&nbsp;</div></li><li><div>            $number = $count['total_users'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $number = count($_REQUEST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title = sprintf(__('Exporting %1$s subscribers', WYSIJA), $number);&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['subscribers'] = $_REQUEST['wysija']['user']['user_id'];&nbsp;</div></li><li><div>        $this-&gt;data['user'] = $_REQUEST['wysija']['user'];//for batch-selecting&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_REQUEST['search'])) {&nbsp;</div></li><li><div>            $_REQUEST['wysija']['filter']['search'] = $_REQUEST['search'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['wysija']['filter'])) {&nbsp;</div></li><li><div>            $this-&gt;data['filter'] = $_REQUEST['wysija']['filter'];//for batch-selecting&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;viewShow = 'export';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/files/controllers-ajax-subscribers/" class="file">/controllers/ajax/subscribers.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="4" class="block" start="4"><li><div>class WYSIJA_control_back_subscribers extends WYSIJA_control_front{&nbsp;</div></li><li><div>    var $model='user';&nbsp;</div></li><li><div>    var $view='';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>        $data=array();&nbsp;</div></li><li><div>        foreach($_REQUEST['data'] as $vals) {&nbsp;</div></li><li><div>            $data[esc_sql($vals['name'])]=esc_sql($vals['value']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(isset($data['message_success'])) {&nbsp;</div></li><li><div>            $this-&gt;messages['insert'][true]=$data['message_success'];&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;messages['insert'][true]=__('User has been inserted.', WYSIJA);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;messages['insert'][false]=__('User has not been inserted.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][true]=__('User has been updated.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][false]=__('User has not been updated.', WYSIJA);&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save() {&nbsp;</div></li><li><div>        $datarequested=array();&nbsp;</div></li><li><div>        $i=0;&nbsp;</div></li><li><div>        foreach($_REQUEST['data'] as $vals) {&nbsp;</div></li><li><div>            if($vals['name']=='wysija[user_list][list_id][]') {&nbsp;</div></li><li><div>                $datarequested[str_replace('wysija[user_list][list_id][]', 'wysija[user_list][list_id]['.$i.']', esc_sql($vals['name']))]=esc_sql($vals['value']);&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            }else   $datarequested[esc_sql($vals['name'])]=esc_sql($vals['value']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $data=$this-&gt;convertUserData($datarequested);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helperUser=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!$helperUser-&gt;checkData($data))return false;&nbsp;</div></li><li><div>        $helperUser-&gt;addSubscriber($data);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    // REFACTOR: Insanely complicated and inefficient&nbsp;</div></li><li><div>    function convertUserData($datarequested) {&nbsp;</div></li><li><div>        $data=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get the lists&nbsp;</div></li><li><div>        if(isset($datarequested['wysija[user_list][list_ids]'])) {&nbsp;</div></li><li><div>            $listids=explode(', ', $datarequested['wysija[user_list][list_ids]']);&nbsp;</div></li><li><div>            $subdate=time();&nbsp;</div></li><li><div>            unset($datarequested['wysija[user_list][list_ids]']);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $i=0;&nbsp;</div></li><li><div>            $listids=array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt;= 25; $i++) {&nbsp;</div></li><li><div>                $testkey='wysija[user_list][list_id]['.$i.']';&nbsp;</div></li><li><div>                if(isset($datarequested[$testkey])) $listids[]=$datarequested[$testkey];&nbsp;</div></li><li><div>                unset($datarequested[$testkey]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $data['user_list']['list_ids']=$listids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // define array for custom user fields&nbsp;</div></li><li><div>        $data['user_field'] = array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get the user info and the rest of the data posted&nbsp;</div></li><li><div>        foreach($datarequested as $key =&gt; $val) {&nbsp;</div></li><li><div>            if(strpos($key, 'wysija[user]')!== false) {&nbsp;</div></li><li><div>                $keymodified=str_replace(array('wysija[', '][', ']'), array('', '#', ''), $key);&nbsp;</div></li><li><div>                $keystabcol=explode('#', $keymodified);&nbsp;</div></li><li><div>                switch(count($keystabcol)) {&nbsp;</div></li><li><div>                    case 2:&nbsp;</div></li><li><div>                        $data[$keystabcol[0]][$keystabcol[1]]=$val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    case 3:&nbsp;</div></li><li><div>                        $data[$keystabcol[0]][$keystabcol[1]][$keystabcol[2]]=$val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else if(strpos($key, 'wysija[field]')!== false) {&nbsp;</div></li><li><div>                $keymodified=str_replace(array('wysija[', '][', ']'), array('', '#', ''), $key);&nbsp;</div></li><li><div>                $keystabcol=explode('#', $keymodified);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                switch(count($keystabcol)) {&nbsp;</div></li><li><div>                    case 2:&nbsp;</div></li><li><div>                        $data['user_field'][$keystabcol[1]] = $val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                    case 3:&nbsp;</div></li><li><div>                        $data['user_field'][$keystabcol[1]][$keystabcol[2]] = $val;&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if(!isset($data[$key])) $data[$key]=$val;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        return $data;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function registerToLists($data, $uid) {&nbsp;</div></li><li><div>        $model=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>        if(isset($data['wysija[user_list][list_ids]'])) {&nbsp;</div></li><li><div>            $listids=explode(', ', $data['wysija[user_list][list_ids]']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $subdate=time();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $i=0;&nbsp;</div></li><li><div>            $listids=array();&nbsp;</div></li><li><div>            for ($i = 0; $i &lt;= 25; $i++) {&nbsp;</div></li><li><div>                $testkey='wysija[user_list][list_id]['.$i.']';&nbsp;</div></li><li><div>                if(isset($data[$testkey])) $listids[]=$data[$testkey];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //$listids=$data['wysija[user_list][list_id]'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        foreach($listids as $listid) {&nbsp;</div></li><li><div>            $model-&gt;replace(array('list_id'=&gt;$listid, 'user_id'=&gt;$uid, 'sub_date'=&gt;$subdate));&nbsp;</div></li><li><div>            $model-&gt;reset();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd><dt><strong><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/files/controllers-back-subscribers/" class="file">/controllers/back/subscribers.php <span>&nbsp;</span></a></strong></dt><dd><pre><ol data-line="3" class="block" start="3"><li><div>class WYSIJA_control_back_subscribers extends WYSIJA_control_back{&nbsp;</div></li><li><div>    var $model='user';&nbsp;</div></li><li><div>    var $view='subscribers';&nbsp;</div></li><li><div>    var $list_columns=array('user_id', 'firstname', 'lastname', 'email', 'created_at');&nbsp;</div></li><li><div>    var $searchable=array('email', 'firstname', 'lastname');&nbsp;</div></li><li><div>    var $_separators = array(', ', ';'); // csv separator; comma is for standard csv, semi-colon is good for Excel&nbsp;</div></li><li><div>    var $_default_separator = ';';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Inactive users = users who never opened or clicked&nbsp;</div></li><li><div>     * @todo: disabled on 2.6. Once it's enabled, please double check in term of &quot;inactive users&quot;.&nbsp;</div></li><li><div>     * OR - users who never opened or clicked&nbsp;</div></li><li><div>     * OR - users who never opened or clicked AND received at least 1 newsletter.&nbsp;</div></li><li><div>     * @var boolean&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    var $_filter_by_inactive_users = true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function __construct() {&nbsp;</div></li><li><div>        global $wpdb;&nbsp;</div></li><li><div>        WYSIJA_control_back::__construct();&nbsp;</div></li><li><div>        if ($this-&gt;_filter_by_inactive_users) {&nbsp;</div></li><li><div>                        // load the inactive subscribers on the listing and when a any bulk action is executed&nbsp;</div></li><li><div>                        if (    empty($_REQUEST['action'])&nbsp;</div></li><li><div>                                ||&nbsp;</div></li><li><div>                                (       !empty($_REQUEST['action'])&nbsp;</div></li><li><div>                                        &&&nbsp;</div></li><li><div>                                        ( in_array($_REQUEST['action'], array('export_get', 'exportlist', 'deleteusers'))&nbsp;</div></li><li><div>                                        ||&nbsp;</div></li><li><div>                                        substr($_REQUEST['action'], 0, 10)=='actionvar_')&nbsp;</div></li><li><div> )&nbsp;</div></li><li><div> ) {&nbsp;</div></li><li><div>                $this-&gt;modelObj-&gt;prepare_inactive_users_table();&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;wpdb = $wpdb;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * common task to all the list actions&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _commonlists() {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        $this-&gt;data['list']=$this-&gt;_getLists(10);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>     * We are using the same form for different purposes:&nbsp;</div></li><li><div>     * - Bulk actions&nbsp;</div></li><li><div>     * - Filter by list&nbsp;</div></li><li><div>     * We need to remove all un-necessary values from interface&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _cleanup_form() {&nbsp;</div></li><li><div>    if (!empty($_REQUEST['doaction'])) {&nbsp;</div></li><li><div>        $action_type = strtolower(trim($_REQUEST['doaction']));&nbsp;</div></li><li><div>        switch ($action_type)&nbsp;</div></li><li><div>        {&nbsp;</div></li><li><div>        // Filter by list&nbsp;</div></li><li><div>        case 'filter':&nbsp;</div></li><li><div>            if (!empty($_REQUEST['wysija']['user']))&nbsp;</div></li><li><div>            unset($_REQUEST['wysija']['user']);&nbsp;</div></li><li><div>            if (!empty($_REQUEST['action']))&nbsp;</div></li><li><div>            unset($_REQUEST['action']);&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        // Bulk action. Nothing to do, because we will invoke _tryAction() directly right after this step&nbsp;</div></li><li><div>        case 'apply':&nbsp;</div></li><li><div>        default:&nbsp;</div></li><li><div>            break;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _getLists($limit=false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;escapingOn=true;&nbsp;</div></li><li><div>        $model_list-&gt;_limitison=$limit;&nbsp;</div></li><li><div>        return $model_list-&gt;getLists();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    private function _getForm($id=false) {&nbsp;</div></li><li><div>        if($id) {&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            return $model_list-&gt;get_one_list($id);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $array=array('name'=&gt;'', 'list_id'=&gt;'', 'description'=&gt;'', 'is_public'=&gt;true, 'is_enabled'=&gt;true);&nbsp;</div></li><li><div>            return $array;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /**&nbsp;</div></li><li><div>     * Get selected lists&nbsp;</div></li><li><div>     * @return array&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    private function _get_selected_lists() {&nbsp;</div></li><li><div>        $result = array();&nbsp;</div></li><li><div>        if (isset($_REQUEST['wysija']['filter']['filter_list'])) {&nbsp;</div></li><li><div>            $result[] = $_REQUEST['wysija']['filter']['filter_list'];&nbsp;</div></li><li><div>        } elseif (!empty($_REQUEST['filter-list'])) {&nbsp;</div></li><li><div>            $lists = explode(', ', trim($_REQUEST['filter-list']));// currently, only single list is allowed.&nbsp;</div></li><li><div>            if (!empty($lists)) {&nbsp;</div></li><li><div>                $result = array_merge ($result, $lists);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        return $result;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function save() {&nbsp;</div></li><li><div>        $this-&gt;redirectAfterSave=false;&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if( isset( $_REQUEST['id'] ) ) {&nbsp;</div></li><li><div>            $id = $_REQUEST['id'];&nbsp;</div></li><li><div>            parent::save();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //run the unsubscribe process if needed&nbsp;</div></li><li><div>            if((int)$_REQUEST['wysija']['user']['status']==-1) {&nbsp;</div></li><li><div>                $helper_user-&gt;unsubscribe($id);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /** update subscriptions */&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $model_user_list-&gt;backSave=true;&nbsp;</div></li><li><div>            /** list of core list */&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>            $results = $model_list-&gt;get(array('list_id'), array('is_enabled'=&gt;'0'));&nbsp;</div></li><li><div>            $core_listids = array();&nbsp;</div></li><li><div>            foreach($results as $res) {&nbsp;</div></li><li><div>                $core_listids[]=$res['list_id'];&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //0 - get current lists of the user&nbsp;</div></li><li><div>            $userlists = $model_user_list-&gt;get(array('list_id', 'unsub_date'), array('user_id'=&gt;$id));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $oldlistids=$newlistids=array();&nbsp;</div></li><li><div>            foreach($userlists as $listdata)    $oldlistids[$listdata['list_id']]=$listdata['unsub_date'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>            $dbloptin = $model_config-&gt;getValue('confirm_dbleoptin');&nbsp;</div></li><li><div>            //1 - insert new user_list&nbsp;</div></li><li><div>            if(isset($_POST['wysija']['user_list']) && $_POST['wysija']['user_list']) {&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('sub_date'=&gt;time()), array('user_id'=&gt;$id));&nbsp;</div></li><li><div>                if(!empty($_POST['wysija']['user_list']['list_id'])) {&nbsp;</div></li><li><div>                    foreach($_POST['wysija']['user_list']['list_id'] as $list_id) {&nbsp;</div></li><li><div>                        //if the list is not already recorded for the user then we will need to insert it&nbsp;</div></li><li><div>                        if(!isset($oldlistids[$list_id])) {&nbsp;</div></li><li><div>                            $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                            $newlistids[]=$list_id;&nbsp;</div></li><li><div>                            $dataul=array('user_id'=&gt;$id, 'list_id'=&gt;$list_id, 'sub_date'=&gt;time());&nbsp;</div></li><li><div>                            //if double optin is on and user is unconfirmed or unsubscribed, then we need to set it as unconfirmed subscription&nbsp;</div></li><li><div>                            if($dbloptin && (int)$_POST['wysija']['user']['status']&lt;1)  unset($dataul['sub_date']);&nbsp;</div></li><li><div>                            $model_user_list-&gt;insert($dataul);&nbsp;</div></li><li><div>                        //if the list is recorded already then let's check the status, if it is an unsubed one then we update it&nbsp;</div></li><li><div>                        }else{&nbsp;</div></li><li><div>                            if($oldlistids[$list_id]&gt;0) {&nbsp;</div></li><li><div>                                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                                $model_user_list-&gt;update(array('unsub_date'=&gt;0, 'sub_date'=&gt;time()), array('user_id'=&gt;$id, 'list_id'=&gt;$list_id));&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                // if no list is selected we unsubscribe them all&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date'=&gt;time(), 'sub_date'=&gt;0), array('user_id'=&gt;$id));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //if a confirmation email needs to be sent then we send it&nbsp;</div></li><li><div>            if($dbloptin && (int)$_POST['wysija']['user']['status']==0 && !empty($newlistids)) {&nbsp;</div></li><li><div>                $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>                $helper_user-&gt;sendConfirmationEmail($id, true, $newlistids);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if((int)$_POST['wysija']['user']['status']==0 || (int)$_POST['wysija']['user']['status']==1) {&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date'=&gt;0, 'sub_date'=&gt;time()), array('user_id'=&gt;$id, 'list_id'=&gt;$core_listids));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $arrayLists=array();&nbsp;</div></li><li><div>            if(isset($_POST['wysija']['user_list']['list_id'])) $arrayLists=$_POST['wysija']['user_list']['list_id'];&nbsp;</div></li><li><div>            $notEqual=array_merge($core_listids, $arrayLists);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //unsubscribe from lists which exist in the old list but does not exist in the new list&nbsp;</div></li><li><div>            $unsubsribe_list = array_diff(array_keys($oldlistids), $arrayLists);&nbsp;</div></li><li><div>            if(!empty($unsubsribe_list))&nbsp;</div></li><li><div>            {&nbsp;</div></li><li><div>                $model_user_list-&gt;reset();&nbsp;</div></li><li><div>                $model_user_list-&gt;update(array('unsub_date'=&gt;time()), array('user_id'=&gt;$id, 'list_id'=&gt;$unsubsribe_list));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            $model_user_list-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            /**&nbsp;</div></li><li><div>            Custom Fields.&nbsp;</div></li><li><div>            */&nbsp;</div></li><li><div>            if (isset($_POST['wysija']['field'])) {&nbsp;</div></li><li><div>              WJ_FieldHandler::handle_all(&nbsp;</div></li><li><div>                $_POST['wysija']['field'], $id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            //instead of going through a classic save we should save through the helper&nbsp;</div></li><li><div>            $data=$_REQUEST['wysija'];&nbsp;</div></li><li><div>            $data['user_list']['list_ids'] = !empty($data['user_list']['list_id']) ? $data['user_list']['list_id'] : array();&nbsp;</div></li><li><div>            unset($data['user_list']['list_id']);&nbsp;</div></li><li><div>            $data['message_success']=__('Subscriber has been saved.', WYSIJA);&nbsp;</div></li><li><div>            $id=$helper_user-&gt;addSubscriber($data, true);&nbsp;</div></li><li><div>            if(!$id) {&nbsp;</div></li><li><div>                $this-&gt;viewShow=$this-&gt;action='add';&nbsp;</div></li><li><div>                $data=array('details'=&gt;$_REQUEST['wysija']['user']);&nbsp;</div></li><li><div>                return $this-&gt;add($data);&nbsp;</div></li><li><div>            } else {&nbsp;</div></li><li><div>                if(isset($_POST['wysija']['field'])) {&nbsp;</div></li><li><div>                    WJ_FieldHandler::handle_all($_POST['wysija']['field'], $id);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>        return true;&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function defaultDisplay() {&nbsp;</div></li><li><div>        $this-&gt;viewShow=$this-&gt;action='main';&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-admin-list';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;msgPerPage = __('Subscribers per page:', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;jsTrans['selecmiss'] = __('Select at least 1 subscriber!', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get the total count for subscribed, unsubscribed and unconfirmed users&nbsp;</div></li><li><div>        $select = array( 'COUNT(`user_id`) AS users' , 'status' , 'MAX(`created_at`) AS `max_create_at`');&nbsp;</div></li><li><div>        $count_group_by = 'status';&nbsp;</div></li><li><div>        $count_by_status = $this-&gt;modelObj-&gt;get_subscribers( $select , array() , $count_group_by );&nbsp;</div></li><li><div>    if ($this-&gt;_filter_by_inactive_users) {&nbsp;</div></li><li><div>        $inactive_users = $this-&gt;modelObj-&gt;count_inactive_users();&nbsp;</div></li><li><div>        if ($inactive_users) {&nbsp;</div></li><li><div>        array_unshift($count_by_status, array(&nbsp;</div></li><li><div>            'users' =&gt; $inactive_users['count'], &nbsp;</div></li><li><div>            'status' =&gt; -99, //-99 = inactive&nbsp;</div></li><li><div>            'max_create_at' =&gt; $inactive_users['max_created_at']&nbsp;</div></li><li><div> ));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $counts = $this-&gt;modelObj-&gt;structure_user_status_count_array($count_by_status);&nbsp;</div></li><li><div>        $arr_max_create_at = $this-&gt;modelObj-&gt;get_max_create($count_by_status);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // count the rows based on the filters&nbsp;</div></li><li><div>        $filters = $this-&gt;modelObj-&gt;detect_filters();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $select = array( 'COUNT(DISTINCT([wysija]user.user_id)) as total_users', 'MAX([wysija]user.created_at) as max_create_at');&nbsp;</div></li><li><div>        $count_rows = $this-&gt;modelObj-&gt;get_subscribers( $select, $filters);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // without filter we already have the total number of subscribers&nbsp;</div></li><li><div>        $this-&gt;data['max_create_at'] = null; //max value of create_at field of current list of users&nbsp;</div></li><li><div>        if(!empty($filters)) {&nbsp;</div></li><li><div>            // used for pagination&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;countRows = $count_rows['total_users'];&nbsp;</div></li><li><div>            // used for&nbsp;</div></li><li><div>            $this-&gt;data['max_create_at'] = $count_rows['max_create_at'];&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;data['max_create_at'] = !empty($arr_max_create_at) ? max($arr_max_create_at) : 0;&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;countRows=$counts['all'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $select = array(&nbsp;</div></li><li><div>        '[wysija]user.firstname', &nbsp;</div></li><li><div>        '[wysija]user.lastname', &nbsp;</div></li><li><div>        '[wysija]user.status', &nbsp;</div></li><li><div>        '[wysija]user.email', &nbsp;</div></li><li><div>        '[wysija]user.created_at', &nbsp;</div></li><li><div>        '[wysija]user.last_opened', &nbsp;</div></li><li><div>        '[wysija]user.last_clicked', &nbsp;</div></li><li><div>        '[wysija]user_list.user_id'&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['subscribers'] = $this-&gt;modelObj-&gt;get_subscribers($select , $filters, '', false, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['current_counts'] = $this-&gt;modelObj-&gt;countRows;&nbsp;</div></li><li><div>        $this-&gt;data['show_batch_select'] = ($this-&gt;modelObj-&gt;limit &gt;= $this-&gt;modelObj-&gt;countRows) ? false : true;&nbsp;</div></li><li><div>        $this-&gt;data['selected_lists'] = $this-&gt;_get_selected_lists();&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;reset();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make the data object for the listing view&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $lists_db = $model_list-&gt;getLists();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lists=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($lists_db as $listobj) {&nbsp;</div></li><li><div>            $lists[$listobj['list_id']]=$listobj;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $user_ids=array();&nbsp;</div></li><li><div>        foreach($this-&gt;data['subscribers'] as $subscriber) {&nbsp;</div></li><li><div>            $user_ids[]=$subscriber['user_id'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // 3 - user_list request&nbsp;</div></li><li><div>        if($user_ids) {&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $userlists=$model_user_list-&gt;get(array('list_id', 'user_id', 'unsub_date'), array('user_id'=&gt;$user_ids));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['lists']=$lists;&nbsp;</div></li><li><div>        $this-&gt;data['counts']=array_reverse($counts);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // regrouping all the data in the same array&nbsp;</div></li><li><div>       foreach($this-&gt;data['subscribers'] as $keysus=&gt;$subscriber) {&nbsp;</div></li><li><div>            // default key while we don't have the data&nbsp;</div></li><li><div>            //TODO add data for stats about emails opened clicked etc&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus]['emails']=0;&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus]['opened']=0;&nbsp;</div></li><li><div>            $this-&gt;data['subscribers'][$keysus]['clicked']=0;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($userlists) {&nbsp;</div></li><li><div>                foreach($userlists as $key=&gt;$userlist) {&nbsp;</div></li><li><div>                    if($subscriber['user_id']==$userlist['user_id'] && isset($lists[$userlist['list_id']])) {&nbsp;</div></li><li><div>                        //what kind of list ist it ? unsubscribed ? or not&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>                        if($userlist['unsub_date']&gt;0) {&nbsp;</div></li><li><div>                            if(!isset($this-&gt;data['subscribers'][$keysus]['unsub_lists']) ) {&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['unsub_lists']=$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }else{&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['unsub_lists'].=', '.$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                       }else{&nbsp;</div></li><li><div>                            if(!isset($this-&gt;data['subscribers'][$keysus]['lists']) ) {&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['lists']=$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }else{&nbsp;</div></li><li><div>                                $this-&gt;data['subscribers'][$keysus]['lists'].=', '.$this-&gt;data['lists'][$userlist['list_id']]['name'];&nbsp;</div></li><li><div>                            }&nbsp;</div></li><li><div>                        }&nbsp;</div></li><li><div>                    }&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        if(!$this-&gt;data['subscribers']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('Yikes! Couldn\'t find any subscribers.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function main() {&nbsp;</div></li><li><div>        $this-&gt;messages['insert'][true]=__('Subscriber has been saved.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['insert'][false]=__('Subscriber has not been saved.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][true]=__('Subscriber has been modified. [link]Edit again[/link].', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;messages['update'][false]=__('Subscriber has not been modified.', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;_cleanup_form();&nbsp;</div></li><li><div>        parent::__construct();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //we change the default model of the controller based on the action&nbsp;</div></li><li><div>        if(isset($_REQUEST['action'])) {&nbsp;</div></li><li><div>            switch($_REQUEST['action']) {&nbsp;</div></li><li><div>                case 'listsedit':&nbsp;</div></li><li><div>                case 'savelist':&nbsp;</div></li><li><div>                case 'lists':&nbsp;</div></li><li><div>                    $this-&gt;model='list';&nbsp;</div></li><li><div>                    break;&nbsp;</div></li><li><div>                default:&nbsp;</div></li><li><div>                    $this-&gt;model='user';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        WYSIJA_control::__construct();&nbsp;</div></li><li><div>        if(!isset($_REQUEST['action']) || !$_REQUEST['action']) {&nbsp;</div></li><li><div>            $this-&gt;defaultDisplay();&nbsp;</div></li><li><div>            $this-&gt;checkTotalSubscribers();&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;_tryAction($_REQUEST['action']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * bulk action copy to list&nbsp;</div></li><li><div>     * @global type $wpdb&nbsp;</div></li><li><div>     * @param type $data&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function copytolist($data) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(empty($this-&gt;_batch_select))&nbsp;</div></li><li><div>            $helper_user -&gt;addToList($data['listid'], $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $helper_user -&gt;addToList($data['listid'], $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $result = $model_list-&gt;getOne(array('name'), array('list_id'=&gt;$data['listid']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1)&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been added to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been added to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Moves subscriber to another list.&nbsp;</div></li><li><div>     *&nbsp;</div></li><li><div>     * @param array $data List id to move, $data = array('listid' =&gt; 1);&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function movetolist($data) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;moveToList($data['listid'], $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        } elseif (isset($_POST['wysija']['user']['user_id'])) {&nbsp;</div></li><li><div>            $helper_user-&gt;moveToList($data['listid'], $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $result = $model_list-&gt;getOne(array('name'), array('list_id' =&gt; $data['listid']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if ($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been moved to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been moved to &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * After performing a bulk action, let's keep the current list filter&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    protected function redirect_after_bulk_action() {&nbsp;</div></li><li><div>        $filter_list = !empty($_REQUEST['wysija']['filter']['filter_list']) ? $_REQUEST['wysija']['filter']['filter_list'] : 0;&nbsp;</div></li><li><div>        if (empty($filter_list)) {// view all lists&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers');&nbsp;</div></li><li><div>        } elseif (is_numeric($filter_list)) {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&filter-list='.$filter_list);&nbsp;</div></li><li><div>        } else {// subscribers in no list&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&filter-list=orphaned');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action remove subscribers from all existing lists&nbsp;</div></li><li><div>     * @param type $data = array('list_id'=&gt;?)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function removefromalllists($data) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select))&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array(), $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array(), $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1)&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been removed from all existing lists.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        else&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been removed from all existing lists.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk action remove subscribers from all existing lists&nbsp;</div></li><li><div>     * @param type $data = array('list_id'=&gt;?)&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function removefromlist($data = array()) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array($data['listid']), $this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $helper_user-&gt;removeFromLists(array($data['listid']), $_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $result = $model_list-&gt;getOne(array('name'), array('list_id'=&gt;$data['listid']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been removed from &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscriber have been removed from &quot;%2$s&quot;.', WYSIJA), $this-&gt;_affected_rows, $result['name']));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk confirm users&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function confirmusers() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;confirmUsers($this-&gt;_batch_select, true);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $helper_user-&gt;confirmUsers($_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s subscribers have been confirmed.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>           $this-&gt;notice(sprintf(__('%1$s subscriber have been confirmed.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * Bulk resend confirmation emails&nbsp;</div></li><li><div>     * Maximum emails to be sent is 100, and only send to unconfirmed subscribers, of coruse.&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function resendconfirmationemail() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user = WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $user_ids = array();&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $model_user = WYSIJA::get('user', 'model');&nbsp;</div></li><li><div>            $users = $model_user-&gt;get_results($this-&gt;_batch_select['query'] . ' LIMIT 0, 100');&nbsp;</div></li><li><div>            if (!empty($users)) {&nbsp;</div></li><li><div>                foreach ($users as $user) {&nbsp;</div></li><li><div>                    $user_ids[] = $user['user_id'];&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $user_ids = array_filter($_POST['wysija']['user']['user_id'], 'ctype_digit');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $sending_statuses = array();// array(user_id =&gt; 1/0)&nbsp;</div></li><li><div>        if (!empty($user_ids)) {&nbsp;</div></li><li><div>            $model_user_list = WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $user_lists = $model_user_list-&gt;get_lists($user_ids);&nbsp;</div></li><li><div>            if (!empty($user_lists)) {&nbsp;</div></li><li><div>                foreach ($user_lists as $user_id =&gt; $lists) {&nbsp;</div></li><li><div>                    $sending_statuses[$user_id] = $helper_user-&gt;sendConfirmationEmail($user_id, true, $lists);&nbsp;</div></li><li><div>                }&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $success_sending_number = count(array_values($sending_statuses));&nbsp;</div></li><li><div>        if ($success_sending_number &lt;= 0) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('No email sent.', WYSIJA));&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>                        $this-&gt;notice( sprintf(_n( 'One email has been sent.', '%d emails have been sent to unconfirmed subscribers.', (int)$success_sending_number, WYSIJA ), $success_sending_number ) );&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function lists() {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-admin-list';&nbsp;</div></li><li><div>        $this-&gt;_commonlists();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;modelObj=WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Edit lists', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;modelObj-&gt;countRows=$this-&gt;modelObj-&gt;count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;model=$this-&gt;modelObj;&nbsp;</div></li><li><div>        $this-&gt;data['form']=$this-&gt;_getForm();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function editlist() {&nbsp;</div></li><li><div>        $this-&gt;_commonlists();&nbsp;</div></li><li><div>        $this-&gt;data['form']=$this-&gt;_getForm($_REQUEST['id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=sprintf(__('Editing list %1$s', WYSIJA), '&lt;b&gt;&lt;i&gt;'.$this-&gt;data['form']['name'].'&lt;/i&gt;&lt;/b&gt;');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function addlist() {&nbsp;</div></li><li><div>        $this-&gt;_commonlists();&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('How about a new list?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;data['form']=$this-&gt;_getForm();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function duplicatelist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        /** get the list's email id&nbsp;</div></li><li><div>         * 0 duplicate the list's welcome email&nbsp;</div></li><li><div>         * 1 duplicate the list&nbsp;</div></li><li><div>         * 2 duplicate the list's subscribers&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $data=$model_list-&gt;getOne(array('name', 'namekey', 'welcome_mail_id', 'unsub_mail_id'), array('list_id'=&gt;(int)$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query='INSERT INTO `[wysija]list` (`created_at`, `name`, `namekey`, `description`, `welcome_mail_id`, `unsub_mail_id`, `is_enabled`, `ordering`)&nbsp;</div></li><li><div>            SELECT '.time().', concat(&quot;' . $this-&gt;wpdb-&gt;_real_escape( __( 'Copy of ', WYSIJA ) ) . '&quot;, `name`) , &quot;copy_'.$data['namekey'].time().'&quot; , `description`, 0, 0 , 1, `ordering` FROM [wysija]list&nbsp;</div></li><li><div>            WHERE list_id='.(int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $list_id = $model_list-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $query='INSERT INTO `[wysija]user_list` (`list_id`, `user_id`, `sub_date`, `unsub_date`)&nbsp;</div></li><li><div>            SELECT '.$list_id .', `user_id`, `sub_date`, `unsub_date` FROM [wysija]user_list&nbsp;</div></li><li><div>            WHERE list_id='.(int)$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_list-&gt;query($query);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(sprintf(__('List &quot;%1$s&quot; has been duplicated.', WYSIJA), $data['name']));&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function add($data=false) {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;add=true;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;title=$this-&gt;viewObj-&gt;title=__('Add Subscriber', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        $this-&gt;data['user']=false;&nbsp;</div></li><li><div>        if($data)$this-&gt;data['user']=$data;&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;limitON=false;&nbsp;</div></li><li><div>        $this-&gt;data['list'] = $model_list-&gt;get(false, array('greater'=&gt;array('is_enabled'=&gt;'0') ));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function back() {&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function backtolist() {&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function edit($id=false) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if (empty($_REQUEST['id']) && empty($id)) {&nbsp;</div></li><li><div>            $this-&gt;error('Cannot edit element primary key is missing : '. get_class($this));&nbsp;</div></li><li><div>            return;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$id) $id=$_REQUEST['id'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get detail info of current user&nbsp;</div></li><li><div>        $this-&gt;data['user']=$this-&gt;modelObj-&gt;getDetails(array('user_id'=&gt;$id));&nbsp;</div></li><li><div>        if(!$this-&gt;data['user']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('No subscriber found, most probably because he was deleted.', WYSIJA));&nbsp;</div></li><li><div>            return $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // get list info&nbsp;</div></li><li><div>        $model_list=WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $model_list-&gt;limitON=false;&nbsp;</div></li><li><div>        $model_list-&gt;orderBy('is_enabled', 'DESC');&nbsp;</div></li><li><div>        $this-&gt;data['list']=$model_list-&gt;get(false, array('greater'=&gt;array('is_enabled'=&gt;'-1') ));&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Edit', WYSIJA).' '.$this-&gt;data['user']['details']['email'];&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // execute hooks&nbsp;</div></li><li><div>        $hook_params = array(&nbsp;</div></li><li><div>            'user_id' =&gt; $id&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>    $this-&gt;data['hooks']['hook_subscriber_left'] = apply_filters('hook_subscriber_left', WYSIJA_module::execute_hook('hook_subscriber_left', $hook_params), $hook_params);&nbsp;</div></li><li><div>    $this-&gt;data['hooks']['hook_subscriber_right'] = apply_filters('hook_subscriber_right', WYSIJA_module::execute_hook('hook_subscriber_right', $hook_params), $hook_params);&nbsp;</div></li><li><div>    $this-&gt;data['hooks']['hook_subscriber_bottom'] = apply_filters('hook_subscriber_bottom', WYSIJA_module::execute_hook('hook_subscriber_bottom', $hook_params), $hook_params);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // prepare js, for rendering&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function deletelist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        /** get the list's email id&nbsp;</div></li><li><div>         * 0 delete the welcome email corresponding to that list&nbsp;</div></li><li><div>         * 1 delete the list subscribers reference&nbsp;</div></li><li><div>         * 2 delete the list campaigns references&nbsp;</div></li><li><div>         * 4 delete the list&nbsp;</div></li><li><div>         */&nbsp;</div></li><li><div>        $model_list=WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $data=$model_list-&gt;getOne(array('name', 'namekey', 'welcome_mail_id'), array('list_id'=&gt;(int)$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($data && isset($data['namekey']) && ($data['namekey']!='users')) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            //there is no welcome email per list that's old stuff&nbsp;</div></li><li><div>            $model_user_list=WYSIJA::get('user_list', 'model');&nbsp;</div></li><li><div>            $model_user_list-&gt;delete(array('list_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_campaign_list=WYSIJA::get('campaign_list', 'model');&nbsp;</div></li><li><div>            $model_campaign_list-&gt;delete(array('list_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $model_list-&gt;reset();&nbsp;</div></li><li><div>            $model_list-&gt;delete(array('list_id'=&gt;$_REQUEST['id']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('List &quot;%1$s&quot; has been deleted.', WYSIJA), $data['name']));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;error(__('The list does not exists or cannot be deleted.', WYSIJA), true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function synchlist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        $helper_user-&gt;synchList($_REQUEST['id']);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function synchlisttotal() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        global $current_user;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(is_multisite() && is_super_admin( $current_user-&gt;ID )) {&nbsp;</div></li><li><div>            $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>            $helper_user-&gt;synchList($_REQUEST['id'], true);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function savelist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;_resetGlobMsg();&nbsp;</div></li><li><div>        $update=false;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($_REQUEST['wysija']['list']['list_id']) {&nbsp;</div></li><li><div>            $update=true;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        /** save the result */&nbsp;</div></li><li><div>        /** 1-save the welcome email*/&nbsp;</div></li><li><div>        /** 2-save the list*/&nbsp;</div></li><li><div>        if(isset($_REQUEST['wysija']['list']['is_public'])) {&nbsp;</div></li><li><div>            if($_REQUEST['wysija']['list']['is_public']=='on') {&nbsp;</div></li><li><div>                $_REQUEST['wysija']['list']['is_public']=1;&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $_REQUEST['wysija']['list']['is_public']=0;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($update) {&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;update($_REQUEST['wysija']['list']);&nbsp;</div></li><li><div>            $this-&gt;notice(__('List has been updated.', WYSIJA));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $_REQUEST['wysija']['list']['created_at']=time();&nbsp;</div></li><li><div>            $_REQUEST['wysija']['list']['is_enabled']=1;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;modelObj-&gt;insert($_REQUEST['wysija']['list']);&nbsp;</div></li><li><div>            $this-&gt;notice(__('Your brand-new list awaits its first subscriber.', WYSIJA));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function importpluginsave($id=false) {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;_resetGlobMsg();&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $helper_import = WYSIJA::get('plugins_import', 'helper');&nbsp;</div></li><li><div>        $plugins_importable=$model_config-&gt;getValue('pluginsImportableEgg');&nbsp;</div></li><li><div>        $plugins_imported=array();&nbsp;</div></li><li><div>        foreach($_REQUEST['wysija']['import'] as $table_name =&gt;$result) {&nbsp;</div></li><li><div>            $connection_info=$helper_import-&gt;getPluginsInfo($table_name);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            if($result) {&nbsp;</div></li><li><div>                $plugins_imported[]=$table_name;&nbsp;</div></li><li><div>                if(!$connection_info) $connection_info=$plugins_importable[$table_name];&nbsp;</div></li><li><div>                $helper_import-&gt;import($table_name, $connection_info);&nbsp;</div></li><li><div>                sleep(2);&nbsp;</div></li><li><div>                $this-&gt;notice(sprintf(__('Import from plugin %1$s has been completed.', WYSIJA), &quot;&lt;strong&gt;'&quot;.$connection_info['name'].&quot;'&lt;/strong&gt;&quot;));&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $this-&gt;notice(sprintf(__('Import from plugin %1$s has been cancelled.', WYSIJA), &quot;&lt;strong&gt;'&quot;.$connection_info['name'].&quot;'&lt;/strong&gt;&quot;));&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config-&gt;save(array('pluginsImportedEgg'=&gt;$plugins_imported));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect('admin.php?page=wysija_subscribers&action=lists');&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function importplugins($id=false) {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Import subscribers from plugins', WYSIJA);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config=WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        $this-&gt;data['plugins']=$model_config-&gt;getValue('pluginsImportableEgg');&nbsp;</div></li><li><div>        $imported_plugins=$model_config-&gt;getValue('pluginsImportedEgg');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($imported_plugins) {&nbsp;</div></li><li><div>            foreach($imported_plugins as $tablename) {&nbsp;</div></li><li><div>                unset( $this-&gt;data['plugins'][$tablename]);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!$this-&gt;data['plugins']) {&nbsp;</div></li><li><div>            $this-&gt;notice(__('There is no plugin to import from.', WYSIJA));&nbsp;</div></li><li><div>            return $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;viewShow='importplugins';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function import($id=false) {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Import Subscribers', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow='import';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function importmatch() {&nbsp;</div></li><li><div>    $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;jsTrans['subscribers_import_match_confirmation_1'] = __('The selected value is already matched to another column.', WYSIJA);&nbsp;</div></li><li><div>    $this-&gt;jsTrans['subscribers_import_match_confirmation_2'] = __('Can you confirm that this column is corresponding to that field?', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-validator';&nbsp;</div></li><li><div>        $helper_numbers = WYSIJA::get('numbers', 'helper');&nbsp;</div></li><li><div>        $bytes = $helper_numbers-&gt;get_max_file_upload();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_SERVER['CONTENT_LENGTH']) && $_SERVER['CONTENT_LENGTH']&gt;$bytes['maxbytes']) {&nbsp;</div></li><li><div>            if(isset($_FILES['importfile']['name']) && $_FILES['importfile']['name']) {&nbsp;</div></li><li><div>                $file_name = $_FILES['importfile']['name'];&nbsp;</div></li><li><div>            }else{&nbsp;</div></li><li><div>                $file_name = __('which you have pasted', WYSIJA);&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $this-&gt;error(sprintf(__('Upload error, file %1$s is too large! (MAX:%2$s)', WYSIJA) , $file_name , $bytes['maxmegas']), true);&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&action=import');&nbsp;</div></li><li><div>            return false;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $import = new WJ_Import();&nbsp;</div></li><li><div>        $this-&gt;data = $import-&gt;scan_csv_file();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;data === false) {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_subscribers&action=import');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $model_config = WYSIJA::get('config', 'model');&nbsp;</div></li><li><div>        $this-&gt;jsTrans['userStatuses'] = array(&nbsp;</div></li><li><div>                -1 =&gt; __('Unsubscribed', WYSIJA), &nbsp;</div></li><li><div>                0 =&gt; $model_config-&gt;getValue('confirm_dbleoptin') ? __('Unconfirmed', WYSIJA) : __('Subscribed', WYSIJA), &nbsp;</div></li><li><div>                1 =&gt; __('Subscribed', WYSIJA)&nbsp;</div></li><li><div> );&nbsp;</div></li><li><div>        $this-&gt;js[] = 'wysija-import-match';&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Import Subscribers', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;viewShow='importmatch';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function import_save() {&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $this-&gt;_resetGlobMsg();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //we need to save a new list in that situation&nbsp;</div></li><li><div>        if(!empty($_REQUEST['wysija']['list']['newlistname'])) {&nbsp;</div></li><li><div>            $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>            $data_list = array();&nbsp;</div></li><li><div>            $data_list['is_enabled'] = 1;&nbsp;</div></li><li><div>            $data_list['name'] = $_REQUEST['wysija']['list']['newlistname'];&nbsp;</div></li><li><div>            $_REQUEST['wysija']['user_list']['list'][] = $model_list-&gt;insert($data_list);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //if there is no list selected, we return to the same form prompting the user to take action&nbsp;</div></li><li><div>        if(!isset($_REQUEST['wysija']['user_list']['list']) || !$_REQUEST['wysija']['user_list']['list']) {&nbsp;</div></li><li><div>            $this-&gt;error(__('You need to select at least one list.', WYSIJA), true);&nbsp;</div></li><li><div>            return $this-&gt;importmatch();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $import = new WJ_Import();&nbsp;</div></li><li><div>        $data_numbers = $import-&gt;import_subscribers();&nbsp;</div></li><li><div>        $duplicate_emails_count = $import-&gt;get_duplicate_emails_count();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($data_numbers === false) {&nbsp;</div></li><li><div>            return $this-&gt;redirect('admin.php?page=wysija_subscribers&action=import');&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        //get a list of list name&nbsp;</div></li><li><div>        $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $results = $model_list-&gt;get(array('name'), array('list_id'=&gt;$_REQUEST['wysija']['user_list']['list']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $list_names=array();&nbsp;</div></li><li><div>        foreach($results as $k =&gt;$v) {&nbsp;</div></li><li><div>            $list_names[]=$v['name'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice( sprintf(__('%1$s subscribers added to %2$s.', WYSIJA), &nbsp;</div></li><li><div>                    $data_numbers['list_user_ids'], &nbsp;</div></li><li><div>                    '&quot;'.implode('&quot;, &quot;', $list_names).'&quot;'&nbsp;</div></li><li><div> ) );&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(count($duplicate_emails_count)&gt;0) {&nbsp;</div></li><li><div>            $list_emails = '';&nbsp;</div></li><li><div>            $i = 0;&nbsp;</div></li><li><div>            foreach($duplicate_emails_count as $email_address =&gt; $occurences) {&nbsp;</div></li><li><div>                if( $i &gt; 0 )$list_emails.=', ';&nbsp;</div></li><li><div>                $list_emails.= $email_address.' ('.$occurences.')';&nbsp;</div></li><li><div>                $i++;&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>            //$emailsalreadyinserted=array_keys($emailsCount);&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__('%1$s emails appear more than once in your file : %2$s.', WYSIJA), count($duplicate_emails_count), $list_emails), 0);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(count($data_numbers['invalid'])&gt;0) {&nbsp;</div></li><li><div>            $string = sprintf(__('%1$s emails are not valid : %2$s.', WYSIJA), count($data_numbers['invalid']), utf8_encode(implode(', ', $data_numbers['invalid'])));&nbsp;</div></li><li><div>            $this-&gt;notice($string, 0);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;redirect();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function export() {&nbsp;</div></li><li><div>        $this-&gt;js[]='wysija-validator';&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title=__('Export Subscribers', WYSIJA);&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>        //$this-&gt;data['lists']=$this-&gt;_getLists();&nbsp;</div></li><li><div>        $this-&gt;data['lists'] = $model_list = WYSIJA::get('list', 'model');&nbsp;</div></li><li><div>        $lists_results = $model_list-&gt;getLists();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $lists=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        foreach($lists_results as $list_row) {&nbsp;</div></li><li><div>            $lists[$list_row['list_id']]=$list_row;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;data['lists']=$lists;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewShow='export';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    function exportcampaign() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['file_name'])) {&nbsp;</div></li><li><div>            $file_name = preg_replace('#[^a-z0-9_\-.]#i', '', base64_decode($_REQUEST['file_name']));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $helper_file = WYSIJA::get('file', 'helper');&nbsp;</div></li><li><div>            $exported_file_link = $helper_file-&gt;url($file_name, 'temp');&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $content = file_get_contents( $exported_file_link );&nbsp;</div></li><li><div>            $user_ids=explode(&quot;, &quot;, $content);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $_REQUEST['wysija']['user']['user_id']=$user_ids;&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;exportlist();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    /**&nbsp;</div></li><li><div>     * bulk delete option&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function deleteusers() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $helper_user=WYSIJA::get('user', 'helper');&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $helper_user-&gt;delete($this-&gt;_batch_select, false, true);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $helper_user-&gt;delete($_POST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if($this-&gt;_affected_rows &gt; 1) {&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__(' %1$s subscribers have been deleted.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;notice(sprintf(__(' %1$s subscriber have been deleted.', WYSIJA), $this-&gt;_affected_rows));&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        // make sure the total count of subscribers is updated&nbsp;</div></li><li><div>        $helper_user-&gt;refreshUsers();&nbsp;</div></li><li><div>        $this-&gt;redirect_after_bulk_action();&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>     /**&nbsp;</div></li><li><div>     * function generating an export file based on an array of user_ids&nbsp;</div></li><li><div>     */&nbsp;</div></li><li><div>    function export_get() {&nbsp;</div></li><li><div>        @ini_set('max_execution_time', 0);&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        $export = new WJ_Export();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($this-&gt;_batch_select)) {&nbsp;</div></li><li><div>            $export-&gt;batch_select = $this-&gt;_batch_select;&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $file_path_result = $export-&gt;export_subscribers();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;notice(str_replace(&nbsp;</div></li><li><div>                array('[link]', '[/link]'), &nbsp;</div></li><li><div>                array('&lt;a href=&quot;'.$file_path_result['url'].'&quot; target=&quot;_blank&quot; class=&quot;exported-file&quot; &gt;', '&lt;/a&gt;'), &nbsp;</div></li><li><div>                sprintf(__('%1$s subscribers were exported. Get the exported file [link]here[/link].', WYSIJA), $export-&gt;get_user_ids_rows())));&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['camp_id'])) {&nbsp;</div></li><li><div>            $this-&gt;redirect('admin.php?page=wysija_campaigns&action=viewstats&id='.$_REQUEST['camp_id']);&nbsp;</div></li><li><div>        }else{&nbsp;</div></li><li><div>            $this-&gt;redirect();&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>    public function exportlist() {&nbsp;</div></li><li><div>        $this-&gt;requireSecurity();&nbsp;</div></li><li><div>        if(!empty($_REQUEST['wysija']['user']['force_select_all'])) {&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $select = array( 'COUNT(DISTINCT([wysija]user.user_id)) as total_users');&nbsp;</div></li><li><div>            if(!empty($_REQUEST['wysija']['filter']['filter_list'])) {&nbsp;</div></li><li><div>                $select[] =  '[wysija]user_list.list_id';&nbsp;</div></li><li><div>            }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            // filters for unsubscribed&nbsp;</div></li><li><div>            $filters = $this-&gt;modelObj-&gt;detect_filters();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>            $count = $this-&gt;modelObj-&gt;get_subscribers( $select, $filters );&nbsp;</div></li><li><div>            $number = $count['total_users'];&nbsp;</div></li><li><div>        } else {&nbsp;</div></li><li><div>            $number = count($_REQUEST['wysija']['user']['user_id']);&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;viewObj-&gt;title = sprintf(__('Exporting %1$s subscribers', WYSIJA), $number);&nbsp;</div></li><li><div>        $this-&gt;data=array();&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        $this-&gt;data['subscribers'] = $_REQUEST['wysija']['user']['user_id'];&nbsp;</div></li><li><div>        $this-&gt;data['user'] = $_REQUEST['wysija']['user'];//for batch-selecting&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(!empty($_REQUEST['search'])) {&nbsp;</div></li><li><div>            $_REQUEST['wysija']['filter']['search'] = $_REQUEST['search'];&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>        if(isset($_REQUEST['wysija']['filter'])) {&nbsp;</div></li><li><div>            $this-&gt;data['filter'] = $_REQUEST['wysija']['filter'];//for batch-selecting&nbsp;</div></li><li><div>        }&nbsp;</div></li><li><div>        $this-&gt;viewShow = 'export';&nbsp;</div></li><li><div>    }&nbsp;</div></li><li><div>&nbsp;</div></li><li><div>}&nbsp;</div></li></ol></pre></dd></dl> </section> </article></div><div id="sidebar"><ul class="widgets"><li> <a href="http://hookr.io/plugin/"><img src="http://hookr.io/wp-content/themes/hookr/assets/images/plugin-download.jpg" /></a></li><li id="versions"><dl><dt>Version(s)</dt><dd><dl><dt>Since</dt><dd> 2.7.4</dd><dt>Others</dt><dd><ul><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.9/classes/wysija_control_back_subscribers/" class="">2.7.9</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.8/classes/wysija_control_back_subscribers/" class="">2.7.8</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.6/classes/wysija_control_back_subscribers/" class="active">2.7.6</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.5/classes/wysija_control_back_subscribers/" class="">2.7.5</a></li><li><a href="http://hookr.io/plugins/mailpoet-newsletters/2.7.4/classes/wysija_control_back_subscribers/" class="">2.7.4</a></li></ul></dd></dl></dd></dl></li><li id="tags"><dl><dt>Tags</dt><dd><ul><li><span></span>plugin</li><li><span></span>class</li><li><span></span>WYSIJA_control_back_subscribers</li><li><span></span>MailPoet Newsletters</li><li><span></span>2.7.9</li></ul></dd></dl></li></ul></div></div></div><script>Hookr.View.init();Hookr.Single.init();</script><footer><div><ul id="nav-social" class="pivot" role="navigation"><li id="twitter"><a href="http://twitter.com/hookr_io" title="Follow me!"></a></li></ul><div> &copy; 2018 hookr.io <strong>(beta)</strong> | <a href="http://hookr.io/privacy/" title="Privacy">Privacy</a> | Proudly Powered by WordPress</div></div> </footer><script type="text/javascript" src="http://hookr.io/wp-content/cache/minify/000000/M9EvL9BNzU1KTdHLzcwDAA.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-49583310-1','hookr.io');ga('send','pageview');</script></body></html>